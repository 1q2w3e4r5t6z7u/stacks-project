\input{preamble}

% OK, start here.
%
\begin{document}

\title{Commutative Algebra}

%\begin{abstract}
%\end{abstract}

\maketitle

\tableofcontents

\section{Introduction}
\label{section-introduction}

\noindent
Basic commutative algebra will be explained in this document.
A reference is \cite{MatCA}.

\section{Conventions}
\label{section-conventions}

\noindent
A ring is commutative with $1$. The zero ring is a ring. In fact it is
the only ring that does not have a prime ideal.

\section{Basic notions}
\label{section-rings-basic}

\noindent
The following notions are considered basic and will not be defined,
and or proved. This does not mean they are all necessarily easy or 
well known.

\begin{enumerate}
\item $R$ is a {\it ring},
\label{ring}
\item $x\in R$ is {\it nilpotent},
\label{ring-element-nilpotent}
\item $x\in R$ is a {\it zero-divisor},
\label{ring-element-zerodivisor}
\item $x\in R$ is a {\it unit},
\label{ring-element-unit}
\item $\varphi : R_1 \to R_2$ is a {\it ring homomorphism},
\label{ring-homomorphism}
\item $\varphi : R_1 \to R_2$ is {\it of finite presentation}, or
{\it $R_2$ is a finitely presented $R_1$-algebra},
\label{ring-homomorphism-finite-presentation}
\item $\varphi : R_1 \to R_2$ is {\it of finite type}, or
{\it $R_2$ is a finitely type $R_1$-algebra},
\label{ring-homomorphism-finite-type}
\item $\varphi : R_1 \to R_2$ is {\it finite}, or
{\it $R_2$ is a finite $R_1$-algebra},
\label{ring-homomorphism-finite}
\item $R$ is a {\it (integral) domain},
\label{ring-domain}
\item $R$ is {\it reduced},
\label{ring-reduced}
\item $R$ is {\it Noetherian},
\label{ring-Noetherian}
\item $K$ is a {\it field},
\label{field}
\item $I \subset R$ is an {\it ideal},
\label{ideal}
\item if $I$ is an ideal then we have its {\it radical} $\sqrt{I}$,
\label{radical-ideal}
\item $\mathfrak p \subset R$ is a {\it prime ideal},
\label{prime-ideal}
\item $\mathfrak m \subset R$ is a {\it maximal ideal},
\label{maximal-ideal}
\item any nonzero ring has a maximal ideal,
\label{exists-maximal-ideal}
\item the ideal $(T)$ {\it generated} by a subset $T \subset R$,
\label{ideal-generated-by}
\item the {\it quotient ring} $R/I$,
\label{quotient-ring}
\item if $\varphi : R_1 \to R_2$ is a ring homomorphism, and if
$I \subset R_2$ is an ideal, then $\varphi^{-1}(I)$ is an
ideal of $R_1$,
\label{inverse-image-ideal}
\item if $\varphi : R_1 \to R_2$ is a ring homomorphism, and if
$I \subset R_1$ is an ideal, then $\varphi(I) \cdot R_2$ (sometimes
denoted $I \cdot R_2$, or $IR_2$) is the ideal of $R_2$ generated
by $\varphi(I)$,
\label{image-ideal}
\item if $\varphi : R_1 \to R_2$ is a ring homomorphism, and if
$\mathfrak p \subset R_2$ is a prime ideal, then
$\varphi^{-1}(\mathfrak p)$ is a prime ideal of $R_1$,
\label{inverse-image-prime}
\item $M$ is an {\it $R$-module},
\label{module}
\item $N \subset M$ is an {\it $R$-submodule},
\label{submodule}
\item $M$ is an {\it Noetherian $R$-module},
\label{Noetherian-module}
\item $M$ is a {\it finite $R$-module},
\label{finite-module}
\item $M$ is a {\it finitely generated $R$-module},
\label{finitely-generated-module}
\item $M$ is a {\it finitely presented $R$-module},
\label{finitely-presented-module}
\item $M$ is a {\it free $R$-module},
\label{free-module}
\item if $N \subset M \subset L$ are $R$-modules,
then $L/M = (L/N)/(M/N)$,
\label{isomorphism-theorem}
\item $S$ is a {\it multiplicative subset of $R$},
\label{multiplicative-subset}
\item the {\it localization} $R \to S^{-1}R$ of $R$,
\label{localization-ring}
\item if $R$ is a ring and $S$ is a multiplicative subset
of $R$ then $S^{-1}R$ is the zero ring if and only if $S$ contains
$0$,
\label{localization-zero}
\item if $R$ is a ring and if the multiplicative subset $S$
consists completely of nonzero divisors, then $R \to S^{-1}R$
is injective,
\label{localize-nonzerodivisors}
\item if $\varphi : R_1 \to R_2$ is a ring homomorphism, and
$S$ is a multiplicative subsets of $R_1$, then $\varphi(S)$ is
a multiplicative subset of $R_2$,
\item if $S$, $S'$ are multiplicative subsets of $R$,
and if $SS'$ denotes the set of products $SS' =
\{r \in R \mid \exists s\in S, \exists s' \in S', r = ss'\}$
then $SS'$ is a multiplicative subset of $R$,
\label{products-multiplicative-subsets}
\item if $S$, $S'$ are multiplicative subsets of $R$,
and if $\overline{S}$ denotes the image of $S$ in $(S')^{-1}R$,
then $(SS')^{-1}R = \overline{S}^{-1}((S')^{-1}R)$,
\label{localization-localization}
\item the {\it localization} $S^{-1}M$ of the $R$-module $M$,
\label{localization-module}
\item the functor $M \mapsto S^{-1}M$ preserves injective maps,
surjective maps, and exactness,
\label{localization-exact}
\item if $S$, $S'$ are multiplicative subsets of $R$,
and $M$ and $R$-module, then $(SS')^{-1}M =
S^{-1}((S')^{-1}M)$,
\label{localization-localization-module}
\item if $R$ is a ring, $I$ and ideal of $R$ and $S$ a multiplicative
subset of $R$, then $S^{-1}I$ is an ideal of $S^{-1}R$, and we have
$S^{-1}R/S^{-1}I = \overline{S}^{-1}(R/I)$, where $\overline{S}$
is the image of $S$ in $R/I$,
\label{localize-ideal}
\item if $R$ is a ring, and $S$ a multiplicative
subset of $R$, then any ideal $I'$ of $S^{-1}R$ is
of the form $S^{-1}I$, where one can take $I$ to be
the inverse image of $I'$ in $R$,
\label{ideal-in-localization}
\item if $R$ is a ring, $M$ an $R$-module, and $S$ a multiplicative
subset of $R$, then any submodule $N'$ of $S^{-1}M$ is of the form
$S^{-1}N$ for some submodule $N \subset M$, where
one can take $N$ to be the inverse image of $N'$ in $M$,
\label{submodule-in-localization}
\item if $S = \{1, f, f^2,\ldots\}$ then $R_f = S^{-1}R$, and
$M_f = S^{-1}M$,
\label{localiza-f}
\item if $S = R \setminus \mathfrak p$, then $R_{\mathfrak p} = S^{-1}R$
and $M_{\mathfrak p} = S^{-1}M$,
\label{localize-p}
\item given $R$ and $M_1$, $M_2$ the {\it tensor product} 
$M_1 \otimes_R M_2$,
\item etc.
\end{enumerate}

\section{The spectrum of a ring}
\label{section-spectrum-ring}

\noindent
We arbitrarily decide that the spectrum of a ring as a topological space
is part of the algebra chapter, whereas an affine scheme is part of the
chapter on schemes.

\begin{definition}
\label{definition-spectrum-ring}
Let $R$ be a ring.
\begin{enumerate}
\item The {\it spectrum} of $R$ is the set of prime ideals of $R$.
It is usually denoted $\text{Spec}(R)$.
\item Given a subset $T \subset R$ we let $V(T) \subset \text{Spec}(R)$
be the set of primes containing $T$, i.e., $V(T) = \{ \mathfrak p \in
\text{Spec}(R) \mid \forall f\in T, f\in \mathfrak p\}$.
\item Given an element $f \in R$ we let $D(f) \subset \text{Spec}(R)$
be the set of primes not containing $f$.
\end{enumerate}
\end{definition}

\begin{lemma}
\label{lemma-Zariski-topology}
Let $R$ be a ring.
\begin{enumerate}
\item The spectrum of a ring $R$ is empty if and only if $R$
is the zero ring.
\item If $T \subset R$, and if $(T)$ is the ideal generated by
$T$ in $R$, then $V((T)) = V(T)$.
\item If $I$ is an ideal and $\sqrt{I}$ is its radical,
see basic notion (\ref{radical-ideal}), then $V(I) = V(\sqrt{I})$.
\item If $I$ is an ideal then $V(I) = \emptyset$ if and only
if $I$ is the unit ideal.
\item If $I$, $J$ are ideals of $R$ then $V(I) \cup V(J) =
V(I \cap J)$.
\item If $(I_a)_{a\in A}$ is a set of ideals of $R$ then
$\cap_{a\in A} V(I_a) = V(\cup_{a\in A} I_a)$.
\item If $f \in R$, then $D(f) \sqcup V(f) = \text{Spec}(R)$.
\item If $f = u f'$ for some unit $u \in R$, then $D(f) = D(f')$.
\item If $I \subset R$ is an ideal, and $\mathfrak p$ is a prime of
$R$ with $\mathfrak p \not\in V(I)$, then there exists an $f \in R$
such that $\mathfrak p \in D(f)$, and $D(f) \cap V(I) = \emptyset$.
\item If $f,g \in R$, then $D(fg) = D(f) \cap D(g)$.
\end{enumerate}
\end{lemma}

\begin{proof}
FIXME.
\end{proof}

\noindent
The lemma implies that the subsets $V(T)$ from
Definition \ref{definition-spectrum-ring} form the closed
subsets of a topology on $\text{Spec}(R)$. And it also shows that
the sets $D(f)$ are open and form a basis for this
topology.

\begin{definition}
\label{definition-Zariski-topology}
Let $R$ be a ring.
The topology on $\text{Spec}(R)$ whose closed sets are the
sets $V(T)$ is called the {\it Zariski} topology. The open
subsets $D(f)$ are called the {\it standard opens} of $\text{Spec}(R)$.
\end{definition}

\noindent
It should be clear from context whether we consider $\text{Spec}(R)$
just as a set or as a topological space.

\begin{lemma}
\label{lemma-spec-functorial}
Suppose that $\varphi : R \to R'$ is a ring homomorphism.
The induced map
$$
\text{Spec}(\varphi) :
\text{Spec}(R')
\longrightarrow
\text{Spec}(R),\ \ 
\mathfrak p'
\longmapsto
\varphi^{-1}(\mathfrak p')
$$
is continuous for the Zariski toplogies. In fact, for
$f \in R$ we have
$\text{Spec}(\varphi)^{-1}(D(f)) = D(\varphi(f))$.
\end{lemma}

\begin{proof}
It is basic notion (\ref{inverse-image-prime}) that
$\mathfrak p := \varphi^{-1}(\mathfrak p')$
is indeed a prime ideal of $R$. The last assertion
of the lemma follows directly from the definitions,
and implies the first.
\end{proof}

\noindent
If $\varphi' : R' \to R''$ is a second ring homomorphism
then the composition
$$
\text{Spec}(R')
\longrightarrow
\text{Spec}(R')
\longrightarrow
\text{Spec}(R'')
$$
equals $\text{Spec}(\varphi' \circ \varphi)$. In other
words, $\text{Spec}$ is a contravariant functor from the
category of rings to the category of topological spaces.


\begin{lemma}
\label{lemma-spec-localization}
Let $R$ be a ring. Let $S \subset R$ be a multiplicative subset.
The map $R \to S^{-1}R$ induces via the functoriality of $\text{Spec}$
a homeomorphism 
$$
\text{Spec}(S^{-1}R)
\longrightarrow 
\{\mathfrak p \in \text{Spec}(R) \mid S \cap \mathfrak p = \emptyset \}
$$
where the topology on the right hand side is that induced from the
Zariski topology on $\text{Spec}(R)$. The inverse map is given
by $\mathfrak p \mapsto S^{-1}\mathfrak p$.
\end{lemma}

\begin{proof}
Denote the left hand side of the arrow of the lemma by $D$.
Choose a prime $\mathfrak p' \subset R_f$ and let $\mathfrak p$
the inverse image of $\mathfrak p'$ in $R$. Since $\mathfrak p'$
does not contain $1$ we see that $\mathfrak p$ does not contain
any element of $S$. Hence $\mathfrak p \in D$ and we see that
the image is contained in $D$. Let $\mathfrak p \in D$. By assumption
the set $S$ maps injectively into $R/\mathfrak p$, in other
words the image $\overline{S}$ does not contain $0$.
By basic notion (\ref{localization-zero})
$\overline{S}^{-1}(R/\mathfrak p)$ is not the zero ring.
By basic notion (\ref{localize-ideal}) we see
$S^{-1}R / S^{-1}\mathfrak p = \overline{S}^{-1}(R/\mathfrak p)$
is a domain, and hence $S^{-1}\mathfrak p$ is a prime.
The equality of rings also shows that the inverse image of
$S^{-1}\mathfrak p$ in $R$ is equal to $\mathfrak p$,
because $R/\mathfrak p \to \overline{S}^{-1}(R/\mathfrak p)$
is injective by basic notion (\ref{localize-nonzerodivisors}).
This proves that the map $\text{Spec}(S^{-1}R) \to \text{Spec}(R)$
is bijective onto $D$ with inverse as given.
It is continuous by Lemma \ref{lemma-spec-functorial}.
Finally, let $D(g) \subset \text{Spec}(S^{-1}R)$ be a standard
open. Write $g = h/s$ for some $h\in R$ and $s\in S$.
Since $g$ and $h/1$ differ by a unit we have $D(g) = 
D(h/1)$ in $\text{Spec}(S^{-1}R)$.
Hence by Lemma \ref{lemma-spec-functorial} and the bijectivity
above the image of $D(g) = D(h/1)$ is $D \cap D(h)$.
This proves the map is open as well.
\end{proof}

\begin{lemma}
\label{lemma-standard-open}
Let $R$ be a ring. Let $f \in R$.
The map $R \to R_f$ induces via the functoriality of
$\text{Spec}$ a homeomorphism
$$
\text{Spec}(R_f) \longrightarrow D(f) \subset \text{Spec}(R).
$$
The inverse is given by $\mathfrak p \mapsto \mathfrak p \cdot R_f$.
\end{lemma}

\begin{proof}
This is a special case of Lemma \ref{lemma-spec-localization}
above.
\end{proof}

\begin{lemma}
\label{lemma-spec-closed}
Let $R$ be a ring. Let $I \subset R$ be an ideal.
The map $R \to R/I$ induces via the functoriality of
$\text{Spec}$ a homeorphism
$$
\text{Spec}(R/I) \longrightarrow V(I) \subset \text{Spec}(R).
$$
The inverse is given by $\mathfrak p \mapsto \mathfrak p / I$.
\end{lemma}

\begin{proof}
It is immediate that the image is contained in $V(I)$.
On the other hand, if $\mathfrak p \in V(I)$
then $\mathfrak p \supset I$ and we may consider
the ideal $\mathfrak p /I \subset R/I$. Using
basic notion (\ref{isomorphism-theorem}) we see that
$(R/I)/(\mathfrak p/I) = R/\mathfrak p$ is a domain
and hence $\mathfrak p/I$ is a prime ideal. From this
it is immediately clear that the image of $D(f + I)$
is $D(f) \cap V(I)$, and hence the map is a homeomorphism.
\end{proof}

\begin{remark}
\label{remark-fundamental-diagram}
A fundamental commutative diagram associated to
$\varphi : R \to S$,
$\mathfrak q \subset S$ and
$\mathfrak p = \varphi^{-1}(\mathfrak q)$ is
the following
$$
\xymatrix{
\kappa(\mathfrak q) = S_{\mathfrak q}/{\mathfrak q}S_{\mathfrak q}
&
S_{\mathfrak q} \ar[l]
&
S \ar[r] \ar[l]
&
S/\mathfrak q \ar[r]
&
\kappa(\mathfrak q) = \text{f.f.}(S/\mathfrak q)
\\
\kappa(\mathfrak p) \otimes_R S = S_{\mathfrak p}/{\mathfrak p}S_{\mathfrak p} \ar[u]
&
S_{\mathfrak p} \ar[u] \ar[l]
&
S \ar[u] \ar[r] \ar[l]
&
S/\mathfrak pS \ar[u] \ar[r]
&
S \otimes_R \kappa(\mathfrak p) = (R \setminus \mathfrak p)^{-1}S \ar[u]
\\
\kappa(\mathfrak p) = R_{\mathfrak p}/{\mathfrak p}R_{\mathfrak p} \ar[u]
&
R_{\mathfrak p} \ar[u] \ar[l]
&
R \ar[u] \ar[r] \ar[l]
&
R/\mathfrak p \ar[u] \ar[r]
&
\kappa(\mathfrak p) = \text{f.f.}(R/\mathfrak p) \ar[u]
}
$$
In this diagram the arrows on the outer left and outer right columns
are identical. The horizontal maps induce on the associated spectrums
always an homeomorphism onto the image. The lower two rows
of the diagram make sense without assuming $\mathfrak q$ exists.
The lower squares induce fibre squares of topological spaces.
This diagram shows that $\mathfrak p$ is in the image
of the map on Spec if and only if $S \otimes_R \kappa(\mathfrak p)$
is not the zero ring.
\end{remark}

\begin{lemma}
\label{lemma-quasicompact}
Let $R$ be a ring. The space $\text{Spec}(R)$ is quasicompact.
\end{lemma}

\begin{proof}
It suffices to prove that any covering of $\text{Spec}(R)$
by standard opens can be refined by a finite covering.
Thus suppose that $\text{Spec}(R) = \cup D(f_i)$
for a set of elements $f_i$ of $R$. This means that
$\cap V(f_i) = \emptyset$. According to Lemma
\ref{lemma-Zariski-topology} this means that
$V(\{f_i \}) = \emptyset$. According to the
same lemma this means that the ideal generated
by the $f_i$ is the unit ideal of $R$. This means
that we can write $1$ as a {\it finite} sum like so
$1 = \sum_{i \in finite\ list} r_i f_i$.
And then it follows that $\text{Spec}(R) 
= \cup_{i \in finite\ list} D(f_i)$.
\end{proof}

\section{Flat modules and flat ring maps}
\label{section-flat}

\noindent
One often used result is that if $M = \text{colim}_{i\in \mathcal{I}} M_i$
is a colimit of $R$-modules and if $N$ is another then
$$
M \otimes N
=
\text{colim}_{i\in \mathcal{I}} M_i \otimes_R N.
$$
This follows almost immediately from the universal 
property of colimits and the universal property of
the tensor product in terms of bilinear maps.
This property is usually expressed by saying
that {\it $\otimes$ commutes with limits}.

\medskip\noindent
Another often used result is that if $0\to N_1 \to N_2 \to N_3\to 0$
is an exact sequence and if $M$ is any $R$-module, then
$$
M\otimes_R N_1
\to
M\otimes_R N_2
\to
M\otimes_R N_3
\to
0
$$
is still exact. Again this follows almost immediately from
the interpretation of the tensor product in terms of
bilinear maps. Of course this property is usually expressed
by saying that {\it $-\otimes_R M$ is right exact}.

\medskip\noindent
Let $M$ be an $R$-module. Let $x_i$, $i=1,\ldots,n$ be elements
of $M$. Let $f_i \in R$ be elements such that $\sum f_i x_i = 0$
in $M$. We say the elements $f_i$ give a {\it relation}
among the elements $x_i$.

\begin{lemma}
\label{lemma-module-colimit-fp}
Let $R$ be a ring and let $M$ be an $R$-module.
Then $M$ is the colimit of a directed system
$(I, \geq)$, $(M_i, f_{ii'})$ of $R$-modules
with all $M_i$ finitely presented $R$-modules.
\end{lemma}

\begin{proof}
Consider any finite subset $S \subset M$ and any finite
collection of relations $E$ among the elements
of $S$. So each $s \in S$ corresponds to $x_s \in M$ and
each $e \in E$ consists of a vector
of elements $f_{e,s} \in R$ such that $\sum f_{e,s} x_s = 0$.
Let $M_{S,E}$ be the cokernel of the map
$$
R^{\#E}
\longrightarrow
R^{\#S},\ \ 
(g_e)_{e\in E}
\longmapsto
(\sum g_e f_{e,s})_{s\in S}.
$$
There are canonical maps $M_{S,E} \to M$.
If $S \subset S'$ and if the elements of
$E$ correspond, via this map, to relations 
in $E'$, then there is an obvious map
$M_{S,E} \to M_{S', E'}$ commuting with the
maps to $M$. Thus $I$ is the set of pairs 
$(S,E)$ with ordering by inclusion as above.
It is clear that the limit of this directed system is $M$.
\end{proof}

\begin{definition}
\label{definition-flat}
Let $R$ be a ring.
\begin{enumerate}
\item An $R$-module $M$ is called {\it flat} if whenever
$N_1 \to N_2 \to N_3$ is an exact sequence of $R$-modules
the sequence $M\otimes_R N_1 \to M\otimes_R N_1\to M\otimes_R N_1$
is exact as well.
\item An $R$-module $M$ is called {\it faithfully flat} if the
complex of $R$-modules
$N_1 \to N_2 \to N_3$ is exact if and only if
the sequence $M\otimes_R N_1\to M\otimes_R N_1\to M\otimes_R N_1$
is exact.
\item A ring map $R \to S$ is called {\it flat} if
$S$ is flat as an $R$-module.
\item A ring map $R \to S$ is called {\it faithfully flat} if
$S$ is faithfully flat as an $R$-module.
\end{enumerate}
\end{definition}

\begin{lemma}
\label{lemma-flat}
Let $M$ be an $R$-module. The following are equivalent:
\begin{enumerate}
\item $M$ is flat over $R$.
\label{flat}
\item for every injection of $R$-modules $N \subset N'$
the map $N\otimes_R M \to N'\otimes_R M$ is injective.
\label{injective}
\item for every ideal $I \subset R$ the map
$I\otimes_R M \to R\otimes_R M = M$ is injective.
\label{ideal}
\item for every finitely generated ideal $I \subset R$
the map $I\otimes_R M \to R\otimes_R M = M$ is injective.
\label{fg-ideal}
\end{enumerate}
\end{lemma}

\begin{proof}
The implications (\ref{flat}) implies (\ref{injective})
implies (\ref{ideal}) implies (\ref{fg-ideal}) are all
trivial. Thus we prove (\ref{fg-ideal}) implies (\ref{flat}).
Suppose that $N_1 \to N_2 \to N_3$ is exact.
Let $K_2 = \text{Ker}(N_2 \to N_3)$. 
It is clear that the surjection $N_1 \to K$
induces a surjection $N_1 \otimes_R M \to K_2\otimes_R M$.
Hence it suffices to show $K_2\otimes_R M \to N_2\otimes_R M$
is injective.

\medskip\noindent
Let $x \in \text{Ker}(K_2\otimes_R M \to N_2\otimes_R M)$.
We have to show that $x$ is zero.
Write $x = \sum_{i=1,\ldots,r} k_i \otimes m_i$. By
Lemma \ref{lemma-module-colimit-fp}
we can find a finitely generated module $N$,
a map $N \to N_2$, and elements $n_i \in N$, $i=1,\ldots,r$ such that
(a) $n_i$ maps to $k_i$, (b) the element $y = \sum_i n_i \otimes m_i$
maps to zero in $N \otimes_R M$. Let $K \subset N$
be the submodule generated by the $n_i$. It suffices to show that
$y$ is zero as an element of $K' \otimes_R M$.

\medskip\noindent
We do this by induction on the minimal number of generators of
$N$. If this number is $>1$ then we can find a short exact
sequence
$0 \to N' \to N \to N''\to 0$
such that $N'$ and $N''$ are finitely generated with a smaller
number of generators. By induction the element $y$ maps
to zero in $K'' \otimes_R M$ with $K''$ the image of $K$
in $N''$. And by the right exactness of $\otimes$ we see
that $y$ comes from some element of $K' \otimes_R M$
where $K'$ is the intersection of $K$ with $N'$. Again
by induction we see that $y' = 0$.

\medskip\noindent
The base case of the induction above is when
$N$ is generated by $1$ element. In other words
$N = R/I$, and then $y = \sum g_i \otimes m_i$,
Let $J = (g_1,\ldots,g_r) \subset R$.
By right exactness, we see that $R/I \otimes_R M
= M/IM$. Our assumption is that $y$ is zero
in $R/I \otimes_R M = M/IM$ in other words
$\sum g_im_i \in IM$, in other words
$\sum g_im_i = \sum h_j m'_j$ for suitable
$h_j \in I$. We may replace $I$ by the finitely
generated ideal $(g_j)$ without modifying the assumptions.
In this case we have $K = J+I/I$
$$
K\otimes_R M
=
(J+I)\otimes_R M /I\otimes_R M
=
(J+I)M / IM
$$
the first equality by right exactness
and the second by assumption on $M$.
Thus $y$ is zero in $K\otimes_RM$ as desired.
\end{proof}

\noindent
We say the relation $\sum f_i x_i$
is {\it trivial} if there exist an integer $m \geq 0$,
elements $y_j$, $j=1,\ldots, m$, and elements $g_{ij} \in R$,
$i=1,\ldots,n$, $j=1,\ldots,m$ such that
$$
x_i = \sum\nolimits_j a_{ij} y_j, \forall j
\text{ and }
0 = \sum\nolimits_i f_ia_{ij}, \forall i
$$

\begin{lemma}
\label{lemma-flat-eq}
(Equational criterion of flatness.)
A module $M$ over $R$ is flat if and only if
every relation in $M$ is trivial.
\end{lemma}

\begin{proof}
Assume $M$ is flat and let $\sum f_i x_i$ be a relation.
Let $I = (f_1,\ldots,f_n)$, and let $K = \text{ker}(R^n \to I)$.
So we have the short exact sequence
$0\to K \to R^n \to I\to 0$. Then $\sum f_i \otimes x_i$
is an element of $I\otimes_R M$ which maps
to zero in $R\otimes_R M = M$. By flatness
$\sum f_i \otimes x_i$ is zero in $I\otimes_R M$.
Thus there exists an element of $K\otimes_R M$ mapping
to $\sum e_i \otimes m_i \in R^n\otimes_R M$.
Write this element as $\sum k_j \otimes y_j$
and then write the image of $k_j$ in $R^n$ as
$\sum a_{ij} e_i$ to get the result.

\medskip\noindent
Assume every relation is trivial, let $I$
be a finitely generated ideal, and let $x = \sum f_i\otimes x_i$
be an element of $I\otimes_R M$ mapping to zero in $R\otimes_R M = M$.
This just means exactly that $\sum h_i x_i$ is a relation in
$M$. And the fact that it is trivial implies easily that
$x$ is zero, because
$$
x
=
\sum f_i \otimes x_i
=
\sum f_i \otimes (\sum a_{ij}y_j)
=
\sum (\sum f_i a_{ij}) \otimes y_j
=
0
$$
\end{proof}

\begin{lemma}
\label{lemma-characterize-zero-local}
An $R$-module $M$ is zero if and only if $M_{\mathfrak p}$ is
zero for all $\mathfrak p \in \text{Spec}(R)$.
\end{lemma}

\begin{proof}
Suppose $M_{\mathfrak p} = 0$ for all primes. 
Let $m \in M$. Let $I = \{f \in R \mid fm = 0\}$.
It is easy to see that $I$ is an ideal (it is the
annihilator of $m$). The condition means that for
all primes $\mathfrak p$ there exists an $f \in R \setminus
\mathfrak p$ such that $fm =0$. In other words,
we have $V(I) = \emptyset$. According to Lemma 
\ref{lemma-Zariski-topology} $I$ is the unit ideal.
Hence $m$ is zero.
\end{proof}

\begin{lemma}
\label{lemma-easy-ff}
An $R$-module $M$ is faithfully flat if and only if $M$ is flat
and for all maps $\alpha : N \to N'$ we have 
$\alpha = 0$ if and only if $\alpha \otimes \text{id}_M = 0$.
\end{lemma}

\begin{proof}
If $M$ is faithfully flat $0 \to \text{Ker}(\alpha)
\to N \to 0$ is exact if and only if the same holds
after tensoring with $M$. This proves one direction.
For the other, let $N_1 \to N_2 \to N_3$
be a complex, and assume the complex
$N_1 \otimes_R M \to N_2 \otimes_R M \to N_3\otimes_R M$
is exact. Take $x \in \text{Ker}(N_2 \to N_3)$,
and consider the map $\alpha : R\to N_2/\text{Im}(N_1)$,
$r \mapsto rx + \text{Im}(N_1)$. By the exactness
of the complex $-\otimes_R M$ we see that $\alpha \otimes 
\text{id}_M$ is zero. By assumption we get that $\alpha$ is
zero. Hence $x $ is in the image of $N_1 \to N_2$.
\end{proof}

\begin{lemma}
\label{lemma-ff}
Let $M$ be a flat $R$-module.
The following are equivalent:
\begin{enumerate}
\item $M$ is faithfully flat,
\item for all $\mathfrak p \in \text{Spec}(R)$
the tensor product $M\otimes_R \kappa(\mathfrak p)$ is nonzero, and
\item for all maximal ideals $\mathfrak m$ of $R$
the tensor product $M\otimes_R \kappa(\mathfrak m) = M/{\mathfrak m}M$
is nonzero.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume $M$ faithfully flat. Since $R \to \kappa({\mathfrak p})$ is not
zero we deduce that $M \to M \otimes_R \kappa({\mathfrak p})$ is not zero,
see Lemma \ref{lemma-easy-ff}.

\medskip\noindent
Conversely assume that $M$ is flat and that
$M/{\mathfrak m}M$ is never zero.
Suppose that $N_1 \to N_2 \to N_3$ is a complex and
suppose that $N_1 \otimes_R M \to N_2\otimes_R M \to
N_3\otimes_R M$ is exact. Let $H$ be the cohomology of the complex,
so $H = \text{Ker}(N_2 \to N_3)/\text{Im}(N_1 \to N_2)$.
By flatness we see that $H \otimes_R M = 0$. 
Take $x \in H$ and let $I = \{f \in R \mid fx = 0 \}$
be its annihilator. Since $R/I \subset H$ we get
$M/IM \subset H\otimes_R M = 0$ by flatness of $M$.
If $I \not=  R$ we may choose
a maximal ideal $I \subset \mathfrak m \subset R$.
This immediately gives a contradiction.
\end{proof}

\begin{lemma}
\label{lemma-ff-rings}
Let $R \to S$ be a flat ring map.
The following are equivalent:
\begin{enumerate}
\item $R \to S$ is faithfully flat,
\item the induced map on $\text{Spec}$ is surjective, and
\item any closed point $x \in \text{Spec}(R)$ is
in the image of the map $\text{Spec}(S) \to \text{Spec}(R)$.
\end{enumerate}
\end{lemma}

\begin{proof}
This follows quickly from Lemma \ref{lemma-ff}, because we
saw in Remark \ref{remark-fundamental-diagram}
that $\mathfrak p$ is in the image
if and only if the ring $S \otimes_R \kappa(\mathfrak p)$
is nonzero.
\end{proof}

\begin{lemma}
\label{lemma-flat-gd}
Let $R\to S$ be flat. Let $\mathfrak p \subset \mathfrak p'$.
If $\mathfrak p'$ is in the image of $\text{Spec}(S)
\to \text{Spec}(R)$ so is $\mathfrak p$.
\end{lemma}

\begin{proof}
Namely, consider $R_{\mathfrak p'} \to S_{\mathfrak p'}$.
By assumption there is a prime ideal $\mathfrak q  \subset  S_{\mathfrak p'}$
lying over $\mathfrak p' R_{\mathfrak p'}$.
By Lemma \ref{lemma-ff-rings} above this implies it is faithfully
flat. By the same lemma again there is a prime mapping to
$\mathfrak p R_{\mathfrak p'}$. The inverse image of this
prime in $S$ does the job.
\end{proof}

\section{Going up, going down, and images}
\label{section-up-down}

\noindent
In this section we prove some results on the 
topology of maps $\text{Spec}(S) \to \text{Spec}(R)$
induced by ring maps $R \to S$. First we discuss Chevalley's Theorem.
In order to do this we will use the notions of constructible sets,
quasi-compact sets, retrocompact sets, and so on
which are defined in Topology, Section \ref{topology-section-quasi-compact}.

\begin{lemma}
\label{lemma-qc-open}
Let $U \subset \text{Spec}(R)$ be open. The following
are equivalent:
\begin{enumerate}
\item $U$ is retrocompact in $\text{Spec}(R)$,
\item $U$ is quasi-compact, and
\item $U$ is a finite union of standard opens.
\end{enumerate}
\end{lemma}

\begin{proof}
The implication (2)$\Rightarrow$(3) is immediate from the fact that standard
opens form a basis for the topology. Each standard open is
homeomorphic to the spectrum of a ring and hence quasi-compact,
by Lemmas \ref{lemma-quasicompact} and \ref{lemma-standard-open}.
To finish it suffices to show that a finite union
$\cup_{i=1\ldots n} D(f_i)$ is retrocompact in $\text{Spec}(R)$.
In order to do this it suffices to show that 
$(\cup_{i=1\ldots n} D(f_i)) \cap (\cup_{j=1\ldots m} D(g_j))$
is quasi-compact, which is clear because it equals
$\cup_{i,j} D(f_i g_j)$.
\end{proof}

\begin{lemma}
\label{lemma-open-fp}
Let $R$ be a ring.
Let $f$ be an element of $R$.
Let $S = R_f$.
Then the image of a constructible of $\text{Spec}(S)$
is constructible in $\text{Spec}(R)$.
\end{lemma}

\begin{proof}
Follows immediately from Lemma \ref{lemma-qc-open} and the
definitions.
\end{proof}

\begin{lemma}
\label{lemma-closed-fp}
Let $R$ be a ring.
Let $I$ be a finitely generated ideal of $R$.
Let $S = R/I$.
Then the image of a constructible of $\text{Spec}(S)$
is constructible in $\text{Spec}(R)$.
\end{lemma}

\begin{proof}
If $I = (f_1,\ldots,f_m)$, then we see that
$V(I)$ is the complement of $\cup D(f_i)$ and
hence constructible, by Lemma \ref{lemma-qc-open}.
Denote the map $R \to S$ by $f \mapsto \overline{f}$.
We have to show that if $\overline{U}, \overline{V}$
are retrocompact opens of $\text{Spec}(S)$, then the
image of $\overline{U} \cap \overline{V}^c$
in $\text{Spec}(R)$ is constructible.
By Lemma \ref{lemma-qc-open} we may write
$\overline{U} = \cup D(\overline{g_i})$.
Setting ${U} = \cup D({g_i})$ we see $\overline{U}$
has image $U \cap V(I)$ which is constructible in
$\text{Spec}(R)$. Similarly the image of $\overline{V}$ equals
$V \cap V(I)$ for some retrocompact open $V$ of $\text{Spec}(R)$.
Hence the image of $\overline{U} \cap \overline{V}^c$
equals $U \cap V(I) \cap V^c$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-affineline-open}
Let $R$ be a ring. The map $\text{Spec}(R[x]) \to \text{Spec}(R)$
is open, and the image of any standard open is a quasi-compact
open.
\end{lemma}

\begin{proof}
It suffices to show that the image of a standard open
$D(f)$, $f\in R$ is quasi-compact open.
Recall that $\mathfrak p\subset R$ is in the image
if and only if $\kappa(\mathfrak p)[x]_f$ is not the
zero ring. This is exactly the condition that $f$ does not map
to zero in $\kappa(\mathfrak p)[x]$, in other words, that
some coefficient of $f$ is not in $\mathfrak p$.
Hence we see: if $f = a_d x^d + \ldots a_0$, then
the image of $D(f)$ is $D(a_d) \cup \ldots \cup D(a_0)$.
\end{proof}

\begin{lemma}
\label{lemma-affineline-special}
Let $R$ be a ring. Let $f, g \in R[x]$ be polynomials.
Assume the leading coefficient of $g$ is a unit of $R$.
There exists elements $r_i\in R$, $i=1\ldots,n$ such that
the image of $D(f) \cap V(g)$ in $\text{Spec}(R)$ is
$\cup D(r_i)$.
\end{lemma}

\begin{proof}
Write $g = ux^d + a_{d-1}x^{d-1} + \ldots a_0$, where
$d$ is the degree of $g$, and hence $u \in R^*$.
Consider the ring $A = R[x]/(g)$.
It is, as an $R$-module, finite free with basis the images
of $1,x,\ldots,x^{d-1}$. Consider multiplication
by (the image of) $f$ on $A$. This is an $R$-module map.
Hence we can let $P(T) \in R[T]$ be the characteristic polynomial
of this map. Write $P(T) = T^d + r_{d-1} T^{d-1} + \ldots r_0$.
We claim that $r_0, \ldots, r_{d-1}$ have the desired property.
We will use below the property of characteristic polynomials 
that
$$
\mathfrak p \in V(r_0, \ldots, r_{d-1})
\Leftrightarrow
\text{multiplication by }g\text{ nilpotent on }
A\otimes_R \kappa(\mathfrak p).
$$

\medskip\noindent
Suppose $\mathfrak q\in D(f) \cap V(g)$, and let
$\mathfrak p = \mathfrak q \cap R$. Then
$A\otimes_R \kappa(\mathfrak p)$ surjects onto $\kappa(\mathfrak q)$
and $g$ acts as a unit on $\kappa(\mathfrak q)$. 
Thus we conclude $\mathfrak p \not \in  V(r_0, \ldots, r_{d-1})$.

\medskip\noindent
On the other hand, suppose that $r_i \not\in \mathfrak p$ for some
prime $\mathfrak p$ of $R$ and some $0 \leq i \leq d-1$.
Then multiplication by $f$ is not nilpotent on the algebra
$A \otimes_R \kappa(\mathfrak p)$.
Hence there exists a maximal ideal $\overline{\mathfrak q} \subset
A \otimes_R \kappa(\mathfrak p)$ not containing the image of $f$.
The inverse image of $\overline{\mathfrak q}$ in $R[x]$ 
is an element of $D(f) \cap V(g)$ mapping to $\mathfrak p$.
\end{proof}

\begin{theorem}
\label{theorem-chevalley}
Suppose that $R \to S$ is of finite presentation.
The image of a constructible subset of
$\text{Spec}(S)$ in $\text{Spec}(R)$ is constructible.
\end{theorem}

\begin{proof}
Write $S = R[x_1,\ldots,x_n]/(f_1,\ldots,f_m)$.
We may factor $R \to S$ as $R \to R[x_1] \to R[x_1,x_2]
\to \ldots \to R[x_1,\ldots,x_{n-1}] \to S$. Hence 
we may assume that $S = R[x]/(f_1,\ldots,f_m)$.
In this case we factor the map as $R \to R[x] \to S$,
and by Lemma \ref{lemma-closed-fp} we reduce to
the case $S = R[x]$. By Lemma \ref{lemma-qc-open} suffices
to show that if
$T = (\cup_{i=1\ldots n} D(f_i)) \cap V(g_1,\ldots,g_m)$ 
for $f_i , g_j \in R[x]$ then the image in $\text{Spec}(R)$ is
constructible. Since finite unions of constructible sets
are constructible, it suffices to deal with the case $n=1$,
i.e., when $T = D(f) \cap V(g_1,\ldots,g_m)$.

\medskip\noindent
Note that if $c \in R$, then we have $\text{Spec}(R) =
V(c) \sqcup D(c) = \text{Spec}(R/(c)) \sqcup 
\text{Spec}(R_c))$, and correspondingly $\text{Spec}(R[x]) =
V(c) \sqcup D(c) = \text{Spec}(R/(c)[x]) \sqcup 
\text{Spec}(R_c[x]))$. The intersection of $T = D(f) \cap V(g_1,\ldots,g_m)$
with each part still has the same shape, with $f$, $g_i$ replaced
by their images in $R/(c)[x]$, respectively $R_c[x]$.
Note that the image of $T$
in $\text{Spec}(R)$ is the union of the image of
$T \cap V(c)$ and $T \cap D(c)$. Using Lemmas \ref{lemma-open-fp}
and \ref{lemma-closed-fp} it suffices to prove the images of both
parts are constructible in $\text{Spec}(R/(c))$, respectively
$\text{Spec}(R_c)$.

\medskip\noindent
Let us assume we have $T = D(f) \cap V(g_1,\ldots,g_m)$
as above, with $\deg(g_1) \leq \deg(g_2) \leq \ldots \leq \deg(g_m)$.
We are going to use descending induction on $m$, and on the 
degrees of the $g_i$. Let $d = \deg(g_1)$, i.e., $g_1 = c x^{d_1} + l.o.t$
with $c \in R$ not zero. Cutting $R$ up into the pieces
$R/(c)$ and $R_c$ we either lower the degree of $g_1$ (and this
is covered by induction)
or we reduce to the case where $c$ is invertible.
If $c$ is invertible, and $m > 1$, then write
$g_2 = c' x^{d_2} + l.o.t$. In this case consider
$g_2' = g_2 - (c'/c) x^{d_2 - d_1} g_1$. Since the ideals
$(g_1, g_2, \ldots, g_m)$ and $(g_1, g_2', g_3, \ldots, g_m)$
are equal we see that $T = D(f) \cap V(g_1,g_2',g_3\ldots,g_m)$.
But here the degree of $g_2'$ is strictly less than the degree
of $g_2$ and hence this case is covered by induction.

\medskip\noindent
The bases case for the induction above are the cases
(a) $T = D(f) \cap V(g)$ where the leading coefficient
of $g$ is invertible, and (b) $T = D(f)$. These two cases
are dealt with in Lemmas \ref{lemma-affineline-special}
and \ref{lemma-affineline-open}.
\end{proof}

\begin{proposition}
\label{proposition-fppf-open}
Let $R \to S$ be flat and of finite presentation.
Then $\text{Spec}(R) \to \text{Spec}(S)$ is open.
\end{proposition}

\begin{proof}
It suffices to prove that the image of a standard open $D(f)$ is open.
After replacing $S$ by $S_f$ we see it suffices to prove the image is
open. Let $\mathfrak p$ be in the image. 




\end{proof}



\input{chapters}

\bibliography{my}
\bibliographystyle{alpha}

\end{document}
