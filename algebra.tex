\input{preamble}

% OK, start here.
%
\begin{document}

\title{Commutative Algebra}


\maketitle

\phantomsection
\label{section-phantom}

\tableofcontents




\section{Introduction}
\label{section-introduction}

\noindent
Basic commutative algebra will be explained in this document.
A reference is \cite{MatCA}.






\section{Conventions}
\label{section-conventions}

\noindent
A ring is commutative with $1$. The zero ring is a ring. In fact it is
the only ring that does not have a prime ideal. The Kronecker
symbol $\delta_{ij}$ will be used. If $R \to S$ is a ring map and
$\mathfrak q$ a prime of $S$, then we use the notation
``$\mathfrak p = R \cap \mathfrak q$''
to indicate the prime which is the inverse image of $\mathfrak q$ under
$R \to S$ even if $R$ is not a subring of $S$ and even if $R \to S$
is not injective.






\section{Basic notions}
\label{section-rings-basic}

\noindent
The following notions are considered basic and will not be defined,
and or proved. This does not mean they are all necessarily easy or
well known.

\begin{enumerate}
\item $R$ is a {\it ring},
\label{item-ring}
\item $x\in R$ is {\it nilpotent},
\label{item-ring-element-nilpotent}
\item $x\in R$ is a {\it zero-divisor},
\label{item-ring-element-zerodivisor}
\item $x\in R$ is a {\it unit},
\label{item-ring-element-unit}
\item $e \in R$ is an {\it idempotent},
\label{item-ring-element-idempotent}
\item an idempotent $e \in R$ is called {\it trivial}
if $e = 1$ or $e = 0$,
\label{item-idempotent-trivial}
\item $\varphi : R_1 \to R_2$ is a {\it ring homomorphism},
\label{item-ring-homomorphism}
\item $\varphi : R_1 \to R_2$ is {\it of finite presentation}, or
{\it $R_2$ is a finitely presented $R_1$-algebra},
see Definition \ref{definition-finite-type},
\label{item-ring-homomorphism-finite-presentation}
\item $\varphi : R_1 \to R_2$ is {\it of finite type}, or
{\it $R_2$ is a finitely type $R_1$-algebra},
see Definition \ref{definition-finite-type},
\label{item-ring-homomorphism-finite-type}
\item $\varphi : R_1 \to R_2$ is {\it finite}, or
{\it $R_2$ is a finite $R_1$-algebra},
\label{item-ring-homomorphism-finite}
\item $R$ is a {\it (integral) domain},
\label{item-ring-domain}
\item $R$ is {\it reduced},
\label{item-ring-reduced}
\item $R$ is {\it Noetherian},
\label{item-ring-Noetherian}
\item $R$ is a {\it principal ideal domain} or a {\it PID},
\label{item-ring-PID}
\item $R$ is a {\it Euclidean domain},
\label{item-ring-Euclidean}
\item $R$ is a {\it unique factorization domain} or a {\it UFD},
\label{item-ring-UFD}
\item $R$ is a {\it discrete valuation ring} or a {\it dvr},
\label{item-ring-dvr}
\item $K$ is a {\it field},
\label{item-field}
\item $K \subset L$ is a {\it field extension},
\label{item-field-extension}
\item $K \subset L$ is an {\it algebraic field extension},
\label{item-field-extension-algebraic}
\item $\{t_i\}_{i\in I}$ is a {\it transcendence basis} for $L$ over $K$,
\label{item-transcendence-basis}
\item the {\it transcendence degree} $\text{trdeg}(L/K)$ of $L$
over $K$,
\label{item-transcendence-degree}
\item the field $k$ is {\it algebraically closed},
\label{item-algebraically-closed}
\item if $K \subset L$ is algebraic, and $K \to k$ a field map,
then there exists a map $L \to k$ extending the map on $K$,
\label{item-extend-into-algebraically-closed}
\item $I \subset R$ is an {\it ideal},
\label{item-ideal}
\item $I \subset R$ is {\it radical},
\label{item-ideal-radical}
\item if $I$ is an ideal then we have its {\it radical} $\sqrt{I}$,
\label{item-radical-ideal}
\item $I \subset R$ is {\it nilpotent} means that $I^n = 0$ for
some $n \in \mathbf{N}$,
\label{item-ideal-nilpotent}
\item $I \subset R$ is {\it locally nilpotent} means that every
element of $I$ is nilpotent,
\label{item-ideal-locally-nilpotent}
\item $\mathfrak p \subset R$ is a {\it prime ideal},
\label{item-prime-ideal}
\item if $\mathfrak p \subset R$ is prime and if $I, J \subset R$
are ideal, and if $IJ\subset \mathfrak p$, then
$I \subset \mathfrak p$ or $J \subset \mathfrak p$.
\label{item-prime-product-ideals}
\item $\mathfrak m \subset R$ is a {\it maximal ideal},
\label{item-maximal-ideal}
\item any nonzero ring has a maximal ideal,
\label{item-exists-maximal-ideal}
\item the {\it Jacobson radical} of $R$ is $\text{rad}(R) =
\bigcap_{\mathfrak m \subset R} \mathfrak m$ the intersection
of all the maximal ideals of $R$,
\label{item-jacobson-radical}
\item the ideal $(T)$ {\it generated} by a subset $T \subset R$,
\label{item-ideal-generated-by}
\item the {\it quotient ring} $R/I$,
\label{item-quotient-ring}
\item an ideal $I$ in the ring $R$ is prime if and only if $R/I$
is a domain,
\label{item-characterize-prime-ideal}
\item an ideal $I$ in the ring $R$ is maximal if and only if the
ring $R/I$ is a field,
\label{item-characterize-maximal-ideal}
\item if $\varphi : R_1 \to R_2$ is a ring homomorphism, and if
$I \subset R_2$ is an ideal, then $\varphi^{-1}(I)$ is an
ideal of $R_1$,
\label{item-inverse-image-ideal}
\item if $\varphi : R_1 \to R_2$ is a ring homomorphism, and if
$I \subset R_1$ is an ideal, then $\varphi(I) \cdot R_2$ (sometimes
denoted $I \cdot R_2$, or $IR_2$) is the ideal of $R_2$ generated
by $\varphi(I)$,
\label{item-image-ideal}
\item if $\varphi : R_1 \to R_2$ is a ring homomorphism, and if
$\mathfrak p \subset R_2$ is a prime ideal, then
$\varphi^{-1}(\mathfrak p)$ is a prime ideal of $R_1$,
\label{item-inverse-image-prime}
\item $M$ is an {\it $R$-module},
\label{item-module}
\item for $m \in M$ the {\it annihilator}
$I = \{f \in R \mid fm = 0\}$ of $m$ in $R$,
\label{item-annihilator}
\item $N \subset M$ is an {\it $R$-submodule},
\label{item-submodule}
\item $M$ is an {\it Noetherian $R$-module},
\label{item-Noetherian-module}
\item $M$ is a {\it finite $R$-module},
\label{item-finite-module}
\item $M$ is a {\it finitely generated $R$-module},
\label{item-finitely-generated-module}
\item $M$ is a {\it finitely presented $R$-module},
\label{item-finitely-presented-module}
\item $M$ is a {\it free $R$-module},
\label{item-free-module}
\item if $0 \to K \to L \to M \to 0$ is a short exact sequence
of $R$-modules and $K$, $M$ are free, then $L$ is free,
\label{item-extension-free}
\item if $N \subset M \subset L$ are $R$-modules,
then $L/M = (L/N)/(M/N)$,
\label{item-isomorphism-theorem}
\item $S$ is a {\it multiplicative subset of $R$},
\label{item-multiplicative-subset}
\item the {\it localization} $R \to S^{-1}R$ of $R$,
\label{item-localization-ring}
\item if $R$ is a ring and $S$ is a multiplicative subset
of $R$ then $S^{-1}R$ is the zero ring if and only if $S$ contains
$0$,
\label{item-localization-zero}
\item if $R$ is a ring and if the multiplicative subset $S$
consists completely of nonzero divisors, then $R \to S^{-1}R$
is injective,
\label{item-localize-nonzerodivisors}
\item if $\varphi : R_1 \to R_2$ is a ring homomorphism, and
$S$ is a multiplicative subsets of $R_1$, then $\varphi(S)$ is
a multiplicative subset of $R_2$,
\item if $S$, $S'$ are multiplicative subsets of $R$,
and if $SS'$ denotes the set of products $SS' =
\{r \in R \mid \exists s\in S, \exists s' \in S', r = ss'\}$
then $SS'$ is a multiplicative subset of $R$,
\label{item-products-multiplicative-subsets}
\item if $S$, $S'$ are multiplicative subsets of $R$,
and if $\overline{S}$ denotes the image of $S$ in $(S')^{-1}R$,
then $(SS')^{-1}R = \overline{S}^{-1}((S')^{-1}R)$,
\label{item-localization-localization}
\item the {\it localization} $S^{-1}M$ of the $R$-module $M$,
\label{item-localization-module}
\item the functor $M \mapsto S^{-1}M$ preserves injective maps,
surjective maps, and exactness,
\label{item-localization-exact}
\item if $S$, $S'$ are multiplicative subsets of $R$,
and if $M$ is an $R$-module, then
$(SS')^{-1}M = S^{-1}((S')^{-1}M)$,
\label{item-localization-localization-module}
\item if $R$ is a ring, $I$ and ideal of $R$ and $S$ a multiplicative
subset of $R$, then $S^{-1}I$ is an ideal of $S^{-1}R$, and we have
$S^{-1}R/S^{-1}I = \overline{S}^{-1}(R/I)$, where $\overline{S}$
is the image of $S$ in $R/I$,
\label{item-localize-ideal}
\item if $R$ is a ring, and $S$ a multiplicative
subset of $R$, then any ideal $I'$ of $S^{-1}R$ is
of the form $S^{-1}I$, where one can take $I$ to be
the inverse image of $I'$ in $R$,
\label{item-ideal-in-localization}
\item if $R$ is a ring, $M$ an $R$-module, and $S$ a multiplicative
subset of $R$, then any submodule $N'$ of $S^{-1}M$ is of the form
$S^{-1}N$ for some submodule $N \subset M$, where
one can take $N$ to be the inverse image of $N'$ in $M$,
\label{item-submodule-in-localization}
\item if $S = \{1, f, f^2, \ldots\}$ then $R_f = S^{-1}R$, and
$M_f = S^{-1}M$,
\label{item-localize-f}
\item if $S = R \setminus \mathfrak p = \{x\in R \mid x\not\in \mathfrak p\}$
for some prime ideal $\mathfrak p$,
then it is customary to denote $R_{\mathfrak p} = S^{-1}R$
and $M_{\mathfrak p} = S^{-1}M$,
\label{item-localize-p}
\item a {\it local ring} is a ring with exactly one maximal ideal,
\label{item-local-ring}
\item a {\it semi-local ring} is a ring with finitely many maximal ideals,
\label{item-semi-local-ring}
\item if $\mathfrak p$ is a prime in $R$, then $R_{\mathfrak p}$ is
a local ring with maximal ideal $\mathfrak p R_{\mathfrak p}$,
\label{item-localize-p-local-ring}
\item the {\it residue field}, denoted $\kappa(\mathfrak p)$,
of the prime $\mathfrak p$ in the
ring $R$ is the quotient $R_{\mathfrak p}/{\mathfrak p}R_{\mathfrak p}
= (R \setminus \mathfrak p)^{-1}R/{\mathfrak p}$,
\label{item-residue-field}
\item given $R$ and $M_1$, $M_2$ the {\it tensor product}
$M_1 \otimes_R M_2$,
\label{item-tensor-product}
\item etc.
\end{enumerate}









\section{Finite modules and finitely presented modules}
\label{section-module-finite-type}

\noindent
Just some basic notation and lemmas.

\begin{definition}
\label{definition-module-finite-type}
Let $R$ be a ring. Let $M$ be an $R$-module
\begin{enumerate}
\item We say $M$ is a {\it finite $R$-module} if there exist
$n \in \mathbf{N}$ and $x_1, \ldots, x_n \in M$ such that
every element of $M$ is a $R$-linear combination of the $x_i$.
Equivalently, this means there exists a surjection
$R^{\oplus n} \to M$ for some $n \in \mathbf{N}$.
\item We say $M$ is a {\it finite presented $R$-module}
if there exist integers $n, m \in \mathbf{N}$ and an exact
sequence
$$
R^{\oplus m} \longrightarrow R^{\oplus n} \longrightarrow M \longrightarrow 0
$$
\end{enumerate}
\end{definition}

\begin{lemma}
\label{lemma-finite-presentation-module-independent}
Let $M$ be an $R$-module of finite presentation.
For any surjection $\alpha : R^{\oplus n} \to M$ the
kernel of $\alpha$ is a finitely generated $R$-module.
\end{lemma}

\begin{proof}
Write $M = R^{\oplus m}/Rf_1 + \ldots + Rf_k$ for some
$f_j \in R^{\oplus m}$. Let $e_i \in R^{\oplus n}$, $i = 1, \ldots, n$,
resp.\ $e'_j \in R^{\oplus m}$, $j = 1, \ldots, m$
denote the standard basis elements. Choose $g_i \in R^{\oplus m}$
which are lifts of $\alpha(e_i)$. Then we see that
$M = R^n \oplus R^{\oplus m}/(f_j, e_i - g_i)$.
Choose $h_j \in R^{\oplus n}$ such that $\alpha(h_j)$
corresponds to $e'_j \bmod Rf_1 + \ldots +Rf_k$. Consider
the map
$\psi : R^{\oplus n} \oplus R^{\oplus m} \to R^{\oplus n}$,
$e_i \mapsto x_i$, $e'_j \mapsto h_j$. Then the kernel of $\alpha$
is the image of $\sum Rf_j + \sum R(e_i - g_i)$ under $\psi$ and we win.
\end{proof}

\begin{lemma}
\label{lemma-extension}
Let $R$ be a ring.
Let
$$
0 \to M_1 \to M_2 \to M_3 \to 0
$$
be a short exact sequence of $R$-modules.
\begin{enumerate}
\item If $M_1$ and $M_3$ are finite $R$-modules, then $M_2$ is a finite
$R$-module.
\item If $M_1$ and $M_3$ are finitely presented $R$-modules, then $M_2$
is a finitely presented $R$-module.
\item If $M_2$ is a finite $R$-module, then $M_3$ is a finite $R$-module.
\item If $M_2$ is a finitely presented $R$-module and $M_1$ is a
finite $R$-module, then $M_3$ is a finitely presented $R$-module.
\item If $M_3$ is a finitely presented $R$-module and $M_2$ is a finite
$R$-module, then $M_1$ is a finite $R$-module.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-trivial-filter-finite-module}
Let $R$ be a ring, and let $M$ be a finite $R$-module.
There exists a filtration by $R$-submodules
$$
0 = M_0 \subset M_1 \subset \ldots \subset M_n = M
$$
such that each quotient $M_i/M_{i-1}$ is isomorphic
to $R/I_i$ for some ideal $I_i$ of $R$.
\end{lemma}

\begin{proof}
By induction on the number of generators of $M$. Let
$x_1, \ldots, x_r \in M$ be a minimal number of generators.
Let $M' = Rx_1 \subset M$. Then $M/M'$ has $r - 1$ generators
and the induction hypothesis applies. And clearly $M' \cong R/I_1$
with $I_1 = \{f \in R \mid fx_1 = 0\}$.
\end{proof}

\begin{lemma}
\label{lemma-finite-over-subring}
Let $R \to S$ be a ring map.
Let $M$ be an $S$-module.
If $M$ is finite as an $R$-module, then $M$ is finite as an $S$-module.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}



\section{Ring maps of finite type and of finite presentation}
\label{section-finite-type}

\begin{definition}
\label{definition-finite-type}
Let $R \to S$ be a ring map.
\begin{enumerate}
\item We say $R \to S$ is of {\it finite type} if there exist
$n \in \mathbf{N}$, an ideal $I \subset R[x_1, \ldots, x_n]$ and
an isomorphism of $R$-algebras $S \cong R[x_1, \ldots, x_n]/I$.
\item We say $R \to S$ is of {\it finite presentation} if there
exist integers $n, m \in \mathbf{N}$ and polynomials
$f_1, \ldots, f_m \in R[x_1, \ldots, x_n]$
and an isomorphism of $R$-algebras
$S \cong R[x_1, \ldots, x_n]/(f_1, \ldots, f_m)$.
\end{enumerate}
\end{definition}

\begin{lemma}
\label{lemma-compose-finite-type}
The notions finite type and finite presentation have the following
permanence properties.
\begin{enumerate}
\item A composition of ring maps of finite type is of finite type.
\item A composition of ring maps of finite presentation is of finite
presentation.
\item Given a ring map of finite type $R \to S$ and a ring map $R \to R'$,
the base change $R' \to R' \otimes_R S$ is of finite type.
\item Given a ring map of finite presentation $R \to S$
and a ring map $R \to R'$, the base change $R' \to R' \otimes_R S$
is of finite presentation.
\item Given $R \to S' \to S$ with $R \to S$ of finite type,
then $S' \to S$ is of finite type.
\item Given $R \to S' \to S$, with $R \to S$ of finite presentation,
and $R \to S'$ of finite type, then $S' \to S$ is of finite presentation.
\end{enumerate}
\end{lemma}

\begin{proof}
We only prove the last assertion.
Write $S = R[x_1, \ldots, x_n]/(f_1, \ldots, f_m)$
and $S' = R[y_1, \ldots, y_a]/I$. Say that the class
$\bar y_i$ of $y_i$ maps
to $h_i \bmod (f_1, \ldots, f_m)$ in $S$.
Then it is clear that
$S' = S[x_1, \ldots, x_n]/(f_1, \ldots, f_m,
h_1 - \bar y_1, \ldots, h_m - \bar y_m)$.
\end{proof}

\begin{lemma}
\label{lemma-finite-presentation-independent}
Let $R \to S$ be a ring map of finite presentation.
For any surjection $\alpha : R[x_1, \ldots, x_n] \to S$ the
kernel of $\alpha$ is a finitely generated ideal in $R[x_1, \ldots, x_n]$.
\end{lemma}

\begin{proof}
Write $S = R[y_1, \ldots, y_m]/(f_1, \ldots, f_k)$.
Choose $g_i \in R[y_1, \ldots, y_m]$ which are lifts
of $\alpha(x_i)$. Then we see that $S = R[x_i, y_j]/(f_j, x_i - g_i)$.
Choose $h_j \in R[x_1, \ldots, x_n]$ such that $\alpha(h_j)$
corresponds to $y_j \bmod (f_1, \ldots, f_k)$. Consider
the map $\psi : R[x_i, y_j] \to R[x_i]$, $x_i \mapsto x_i$,
$y_j \mapsto h_j$. Then the kernel of $\alpha$
is the image of $(f_j, x_i - g_i)$ under $\psi$ and we win.
\end{proof}

\begin{lemma}
\label{lemma-finitely-presented-over-subring}
Let $R \to S$ be a ring map.
Let $M$ be an $S$-module.
Assume $R \to S$ is of finite type and
$M$ is finitely presented as an $R$-module.
Then $M$ is finitely presented as an $S$-module.
\end{lemma}

\begin{proof}
This is similar to the proof of part (6) of
Lemma \ref{lemma-compose-finite-type}.
We may assume $S = R[x_1, \ldots, x_n]/J$.
Choose $y_1, \ldots, y_m \in M$ which generate $M$ as an $R$-module
and choose relations $\sum a_{ij} y_j = 0$, $i = 1, \ldots, t$ which
generate the kernel of $R^{\oplus n} \to M$. For any
$i = 1, \ldots, n$ and $j = 1, \ldots, m$ write
$$
x_i y_j = \sum a_{ijk} y_k
$$
for some $a_{ijk} \in R$. Consider the $S$-module $N$ generated by
$y_1, \ldots, y_m$ subject to the relations
$\sum a_{ij} y_j = 0$, $i = 1, \ldots, t$ and
$x_i y_j = \sum a_{ijk} y_k$, $i = 1, \ldots, n$ and $j = 1, \ldots, m$.
Then $N$ has a presentation
$$
S^{\oplus nm + t} \longrightarrow S^{\oplus m} \longrightarrow M
\longrightarrow 0
$$
By construction there is a surjective map $\varphi : N \to M$.
To finish the proof we show $\varphi$ is injective.
Suppose $z = \sum b_j y_j \in N$ for some $b_j \in S$.
We may think of $b_j$ as a polynomial in $x_1, \ldots, x_n$
with coefficients in $R$.
By applying the relations of the form $x_i y_j = \sum a_{ijk} y_k$
we can inductively lower the degree of the polynomials.
Hence we see that $z = \sum c_j y_j$ for some $c_j \in R$.
Hence if $\varphi(z) = 0$ then the vector $(c_1, \ldots, c_m)$
is an $R$-linear combination of the vectors $(a_{i1}, \ldots, a_{im})$
and we conclude that $z = 0$ as desired.
\end{proof}





\section{Finite ring maps}
\label{section-finite}

\begin{definition}
\label{definition-finite-ring-map}
Let $\varphi : R \to S$ be a ring map.
We say $\varphi : R \to S$ is {\it finite} if
if $S$ is finite as an $R$-module.
\end{definition}

\begin{lemma}
\label{lemma-finite-module-over-finite-extension}
Let $R \to S$ be a finite ring map.
Let $M$ be an $S$-module.
Then $M$ is finite as an $R$-module if and only if $M$ is finite
as an $S$-module.
\end{lemma}

\begin{proof}
One of the implications follows from
Lemma \ref{lemma-finite-over-subring}.
To see the other assume that $M$ is finite as an $S$-module.
Pick $x_1, \ldots, x_n \in S$ which generate $S$ as an $R$-module.
Pick $y_1, \ldots, y_m \in M$ which generate $M$ as an $S$-module.
Then $x_j y_j$ generate $M$ as an $R$-module.
\end{proof}

\begin{lemma}
\label{lemma-finite-transitive}
Suppose that $R \to S$ and $S \to T$ are finite ring maps.
Then $R \to T$ is finite.
\end{lemma}

\begin{proof}
If $t_i$ generate $T$ as an $S$-module and $s_j$ generate $S$ as an
$R$-module, then $t_i s_j$ generate $T$ as an $R$-module.
(Also follows from
Lemma \ref{lemma-finite-module-over-finite-extension}.)
\end{proof}

\begin{lemma}
\label{lemma-finite-finitely-presented-extension}
Let $R \to S$ be a finite and finitely presented ring map.
Let $M$ be an $S$-module.
Then $M$ is finitely presented as an $R$-module if and only if
$M$ is finitely presented as an $S$-module.
\end{lemma}

\begin{proof}
One of the implications follows from
Lemma \ref{lemma-finitely-presented-over-subring}.
To see the other assume that $M$ is finitely presented as an $S$-module.
Pick a presentation
$$
S^{\oplus m} \longrightarrow
S^{\oplus n} \longrightarrow
M \longrightarrow 0
$$
As $S$ is finite as an $R$-module, the kernel of
$S^{\oplus n} \to M$ is a finite $R$-module. Thus from
Lemma \ref{lemma-extension}
we see that it suffices to prove that $S$ is finitely presented as an
$R$-module.

\medskip\noindent
Pick $x_1, \ldots, x_n \in S$ which generate $S$ as
an $R$-module. Write $x_ix_j = \sum a_{ijk}x_k$ for some
$a_{ijk} \in R$. Let $J = \text{Ker}(R[X_1, \ldots, X_n] \to S)$
where $R[X_1, \ldots, X_n] \to S$ is the $R$-algebra map determined by
$X_i \mapsto x_i$. Let $g_{ij} = X_iX_j - \sum a_{ijk} X_k$
which is an element of $J$. Let $I = (g_{ij})$ so that
$I \subset J$. By
Lemma \ref{lemma-finite-presentation-independent}
there exist finitely many $g_1, \ldots, g_N \in J$
such that $J = (g_1, \ldots, g_N)$. For every index
$l \in \{1, \ldots, N\}$ we can write
$g_l = h_l \bmod I$ for some $h_l \in J$ which has
degree $\leq 1$ in $X_1, \ldots, X_n$.
(Details omitted; hint: use the $g_{ij}$ get rid of the monomial
of highest degree in $g_l$ and use induction.)
Write $h_l = a_{l0} + \sum a_{li} X_i$ for some $a_{li} \in R$.
Then $S$ has the following presentation
$$
R^{\oplus N} \longrightarrow
R^{\oplus n + 1} \longrightarrow
M \longrightarrow 0
$$
as an $R$-module
where the first arrow maps the $l$th basis vector to
$(a_{l0}, a_{l1}, \ldots, a_{ln})$ and the second
arrow maps $(a_0, a_1, \ldots, a_n)$ to
$a_0 + \sum a_i x_i$.
\end{proof}





\section{Localization}
\label{section-localization}

\begin{definition}
\label{definition-multiplicative-subset}
Let $R$ be a ring, $S$ a subset of $R$.
We say $S$ is a {\it multiplicative subset of $R$} is
$1\in S$ and $S$ is closed
under multiplication, i.e., $s, s' \in S \Rightarrow ss' \in S$.
\end{definition}

\noindent
Given a ring $A$ and a multiplicative subset $S$, we
define a relation on $A\times S$ as follows:
$$
(x, s)\sim(y, t) \iff \exists u\in S, \ \text{such that}\ (xt-ys)u = 0
$$
It is easily checked that this is an equivalence relation.

\begin{definition}
\label{definition-localization}
Let $x/s$ (or $\frac{x}{s}$) be the equivalence class of $(x, s)$ and
$S^{-1}A$ be the set of all equivalence classes. Define addition
and multiplication in $S^{-1}A$ as follows:
\begin{align}
x/s + y/t& = (xt + ys)/st\\
x/s\cdot y/t& = xy/st
\end{align}
One can check that $S^{-1}A$ becomes a ring under these operations.
This ring is called the {\it localization of $A$ with respect to $S$}.
\end{definition}

\noindent
We have a natural ring map from $A$ to its localization $S^{-1}A$,
$$
\varphi : A \longrightarrow S^{-1}A, \quad x \longmapsto x/1
$$

\medskip\noindent
The localization of a ring has the following universal property.

\begin{proposition}
\label{proposition-universal-property-localization}
Let $f : A \to B$ be a ring map that sends every element in $S$ to a unit
of $B$. Then there is a unique homomorphism $g : S^{-1}A \to B$ such
that the following diagram commutes.
$$
\xymatrix{
    A \ar[rr]^{f} \ar[dr]_{\varphi} & &B\\
    &S^{-1}A \ar[ur]_{g}
    }
$$
\end{proposition}

\begin{proof}
Existence. We define a map $g$ as follows. For $x/s\in
S^{-1}A$, let $g(x/s) = f(x)f(s)^{-1}\in B$. It is easily checked from
the definition that this is a well-defined ring map. And it is also clear that
this makes the diagram commutative.

\medskip\noindent
Uniqueness. We now show that if $g' : S^{-1}A \to B$
satisfies $g'\varphi = f$, then $g = g'$. First of all, to make
the diagram commutative, $g'$ should send
$x/1$ to $f(x)$. Next $f(s) = g'(s/1)$ for $s\in S$ by the
commutativity of the diagram. But then $g'(1/s)f(s) = 1$ in $B$,
which implies that $g'(1/s) = f(s)^{-1}$ and hence
$g'(x/s) = g'(x/1)g'(1/s) = f(x)f(s)^{-1} = g(x/s)$.
\end{proof}

\noindent
In general the localization map is not injective, unless $S$
contains no zero divisors. For, if $x/1 = 0$, then there is a $u\in S$
such that $xu = 0$ in $A$ and hence $x = 0$ since there are no zero
divisors in $S$.

\begin{lemma}
\label{lemma-localization-zero}
The localization $S^{-1}A$ is the zero ring if and only if $0\in S$.
\end{lemma}

\begin{proof}
If $0\in S$, any pair $(a, s)\sim (0, 1)$ by definition.
If $0\not \in S$, then clearly $1/1 \neq 0/1$ in $S^{-1}A$.
\end{proof}

\noindent
The notion of localization of a ring can be generalized to the
localization of a module.

\medskip\noindent
Let $A$ be a ring, $S$ a multiplicative subset of $A$ and $M$ an $A$-module.
We define a relation on
$M\times S$ as follows
$$
(m, s)\sim(n, t) \iff \exists u\in S, \ \text{such that}\ (mt-ns)u = 0
$$
This is clearly an equivalence relation. Denote by $m/s$ (or
$\frac{m}{s}$) be the equivalence class of $(m, s)$ and $S^{-1}M$ be
the set of all equivalence classes. Define the addition and scalar
multiplication as follows
\begin{align}
m/s + n/t& = (mt + ns)/st\\
m/s\cdot n/t& = mn/st
\end{align}
It is clear that this makes $S^{-1}M$ an $S^{-1}A$ module.

\medskip\noindent
The $S^{-1}A$-module $S^{-1}M$ is called the {\it localization} of $M$ at $S$.

\begin{example}
\label{example-localize-at-prime}
Let $A$ be a ring and let $M$ be an $A$-module.
Here are some important examples of localizations.
\begin{enumerate}
\item Given $\mathfrak p$ a prime ideal of $A$ consider
$S = A\setminus\mathfrak p$. It is
immediately checked that $S$ is a multiplicative set. In this case
we denote $A_\mathfrak p$ and $M_\mathfrak p$ the localization of
$A$ and $M$ with respect to $S$ respectively. These are
called the {\it localization of $A$, resp.\ $M$ at $\mathfrak p$}.
\item Let $f\in A$. Consider $S = \{1, f, f^2, \cdots\}$.
This is clearly a multiplicative subset of $A$.
In this case we denote $A_f$
(resp. $M_f$) the localization $S^{-1}A$ (resp. $S^{-1}M$).
This is called the {\it localization of $A$, resp.\ $M$ with
respect to $f$}.
Note that $A_f = 0$ if and only if $f$ is nilpotent in $A$.
\item Let $S = \{f \in A \mid f \text{ is not a zerodivisor in }A\}$.
This is a multiplicative subset of $A$. In this case the
ring $Q(A) = S^{-1}A$ is called either the
{\it total quotient ring}, or the {\it total ring of fractions}
of $A$.
\end{enumerate}
\end{example}

\begin{lemma}
\label{lemma-localization-colimit}
Let $R$ be a ring.
Let $S \subset R$ be a multiplicative subset.
Let $M$ be an $R$-module.
Then
$$
S^{-1}M = \text{colim}_{f \in S}\ M_f
$$
where the partial ordering on $S$ is given by
$f \geq f' \Leftrightarrow f = f'f''$ for some $f' \in R$
in which case the map $M_{f'} \to M_f$ is given
by $m/(f')^e \mapsto m(f'')^e/f^e$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\noindent
In the following paragraph,
let $A$ denote a ring,
and $M, N$ denote modules over $A$.

\medskip\noindent
If $S$ and $S'$ are multiplicative sets of $A$, then it is
clear that
$$
SS' = \{ss' : s\in S, \ s'\in S'\}
$$
is also a multiplicative set of $A$. Then the following holds.

\begin{proposition}
\label{proposition-localize-twice}
Let $\overline{S}$ be the image of $S$ in $S'^{-1}A$, then
$(SS')^{-1}A$ is isomorphic to $\overline{S}^{-1}(S'^{-1}A)$.
\end{proposition}

\begin{proof}
The map sending $x\in A$ to $x/1\in (SS'^{-1})A$ induces a map
sending $x/s\in S'^{-1}A$ to $x/s \in (SS'^{-1})A$, by universal
property. The image of the elements in $\overline{S}$ are invertible
in $(SS'^{-1})A$. By the universal property we get a map
$f : \overline{S}^{-1}(S'^{-1}A) \to (SS'^{-1})A$ which maps
$(x/t')/(s/s')$ to $(x/t')\cdot(s/s')^{-1}$.

\medskip\noindent
On the other hand, the map from $A$ to $\overline{S}^{-1}(S'^{-1}A)$
sending $x\in A$ to $(x/1)/(1/1)$ also induces a map
$g : (SS'^{-1})A \to \overline{S}^{-1}(S'^{-1}A)$ which sends $x/ss'$
to $(x/s')/(s/1)$, by the universal property again. It is
immediately checked that $f$ and $g$ are inverse to each other,
hence they are both isomorphisms.
\end{proof}

\noindent
For the module $M$ we have

\begin{proposition}
\label{proposition-localize-twice-module}
View $S'^{-1}M$ as an $A$-module, then $S^{-1}(S'^{-1}M)$ is
isomorphic to $(SS')^{-1}M$.
\end{proposition}

\begin{proof}
Note that given a $A$-module M, we have not proved any
universal property for $S^{-1}M$. Hence we cannot reason
as in the preceding proof; we have to construct the isomorphism explicitly.

\medskip\noindent
We define the maps as follows
\begin{align*}
&f : S^{-1}(S'^{-1}M) \longrightarrow (SS')^{-1}M, \quad \frac{x/s'}{s}\mapsto
x/ss'\\
&g : (SS')^{-1}M \longrightarrow S^{-1}(S'^{-1}M), \quad x/t\mapsto
\frac{x/s'}{s}\ \text{for some}\ s\in S, s'\in S', \ \text{and}\ 
t = ss'
\end{align*}
We have to check that these homomorphisms are well-defined, that is,
independent the choice of the fraction. This is easily checked and it is also
straightforward to show that they are inverse to each other.
\end{proof}

\noindent
If $u : M \to N$ is an $A$ homomorphism, then the localization indeed
induces a well-defined $S^{-1}A$ homomorphism $S^{-1}u : S^{-1}M \to
S^{-1}N$ which sends $x/s$ to $u(x)/s$. It is immediately checked that
this construction is functorial, so that $S^{-1}$
is actually a functor from the category of $A$-modules to the
category of $S^{-1}A$-modules. Moreover this functor is exact,
as we show in the following proposition.

\begin{proposition}
\label{proposition-localization-exact}
Let $L\xrightarrow{u} M\xrightarrow{v} N$ is an exact sequence
of $R$ modules. Then
$S^{-1}L \to S^{-1}M \to S^{-1}N$ is also exact.
\end{proposition}

\begin{proof}
First it is clear that $S^{-1}v\circ S^{-1}u = 0$ since $S^{-1}$ is a
functor. Next suppose that $S^{-1}v(x/s) = 0$ for some $x/s\in
S^{-1}M$. Then by definition there is a $t\in S$ such that
$v(xt) = v(x)t = 0$ in $M$, which means $xt\in\text{Ker}(v)$.
By the exactness of $L \to M \to
N$ we have $xt = u(y)$ for some $y$ in $L$. Then $x/s = S^{-1}u(y/st)$,
which shows $\text{Ker} S^{-1}v\subset\text{Im} S^{-1}u$. The exactness then
follows.
\end{proof}

\begin{lemma}
\label{lemma-localize-quotient-modules}
Localization respects quotients, i.e. if $N$ is a submodule of
$M$, then $S^{-1}(M/N)\simeq (S^{-1}M)/(S^{-1}N)$.
\end{lemma}

\begin{proof}
From the exact sequence
$$
0 \longrightarrow N \longrightarrow M \longrightarrow M/N \longrightarrow 0
$$
we have
$$
0 \longrightarrow S^{-1}N \longrightarrow S^{-1}M
\longrightarrow S^{-1}(M/N) \longrightarrow 0
$$
The corollary then follows.
\end{proof}

\noindent
If, in the preceding Corollary, we take $N = I$ and $M = A$ for an ideal $I$ of
$A$, we see that $S^{-1}A/S^{-1}I \simeq S^{-1}(A/I)$ as $A$-modules. The next
proposition shows that they are isomorphic as rings.

\begin{proposition}
\label{proposition-localize-quotient}
Let $I$ be an ideal of $A$, $S$ a multiplicative set of $A$. Then
$S^{-1}I$ is an ideal of $S^{-1}A$ and $\overline{S}^{-1}(A/I)$ is
isomorphic to $S^{-1}A/S^{-1}I$, where $\overline{S}$ is
the image of $S$ in $A/I$.
\end{proposition}

\begin{proof}
The fact that $S^{-1}I$ is an ideal is clear since $I$ itself is an
ideal. Define
$$
f : S^{-1}A\longrightarrow \overline{S}^{-1}(A/I), \quad x/s\mapsto
\overline{x}/\overline{s}
$$
where $\overline{x}$ and $\overline{s}$ are the images of $x$ and
$s$ in $A/I$. We shall keep similar notations in this proof.
This map is well-defined by the universal property of
$S^{-1}A$, and $S^{-1}I$ is contained in the kernel of it,
therefore it induces a map
$$
\overline{f} : S^{-1}A/S^{-1}I \longrightarrow \overline{S}^{-1}(A/I), \quad
\overline{x/s}\mapsto \overline{x}/\overline{s}
$$

\medskip\noindent
On the other hand, the map $A \to S^{-1}A/S^{-1}I$ sending $x$ to
$\overline{x/1}$ induces a map $A/I \to S^{-1}A/S^{-1}I$ sending
$\overline{x}$ to $\overline{x/1}$. The image of $\overline{S}$ is
invertible in $S^{-1}A/S^{-1}I$, thus induces a map
$$
g : \overline{S}^{-1}(A/I) \longrightarrow S^{-1}A/S^{-1}I, \quad
\frac{\overline{x}}{\overline{s}}\mapsto \overline{x/s}
$$
by the universal property. It is then clear that $\overline{f}$ and $g$
are inverse to each other, hence are both isomorphisms.
\end{proof}

\noindent
We now consider how submodules behave in localization.

\begin{lemma}
\label{lemma-submodule-localization}
Any submodule $N'$ of $S^{-1}M$ is of the form $S^{-1}N$ for some
$N\subset M$. Indeed one can take $N$ to be the inverse image of
$N'$ in $M$.
\end{lemma}

\begin{proof}
Let $N$ be the inverse image of $N'$ in $M$. Then one can see that
$S^{-1}N\supset N'$. To show they are equal, take $x/s$ in
$S^{-1}N$, where $s\in S$ and $x\in N$. This yields that $x/1\in
N'$. Since $N'$ is an $S^{-1}R$-submodule we have
$x/s = x/1\cdot 1/s\in N'$. This finishes the proof.
\end{proof}

\noindent
Taking $M = A$ and $N = I$ an ideal of $A$, we have the following
corollary, which can be viewed as a converse of the first part of
Proposition \ref{proposition-localize-quotient}.

\begin{lemma}
\label{lemma-ideal-in-localization}
Each ideal $I'$ of $S^{-1}A$ takes the form $S^{-1}I$, where one can
take $I$ to be the inverse image of $I'$ in $A$.
\end{lemma}

\noindent
The next lemma concerns the spectrum and localization.
FIXME: This should be moved later in the manuscript.

\begin{lemma}
\label{lemma-spec-localization-first}
Let $S$ be a multiplicative set of $A$. Then the map
$$
f: \text{Spec}(S^{-1}A)\longrightarrow \text{Spec}(A)
$$
induced by the canonical ring map
$A \to S^{-1}A$ is a homeomorphism onto its image and
$\text{Im}(f)=
\{ \mathfrak p\in \text{Spec}(R): \mathfrak p\cap S = \emptyset \}$.
\end{lemma}

\begin{proof}
Denote the localization map by $\varphi : A \to S^{-1}A$. We first
show that
$\text{Im}(f) = \{ \mathfrak p\in \text{Spec}(R):
\mathfrak p\cap S = \emptyset \}$. For any
ideal
$\mathfrak q$ of $S^{-1}A$, $\varphi^{-1}(\mathfrak q)\cap S = {0}$.
Otherwise if $x\not = 0\in\varphi^{-1}(\mathfrak q)\cap S$, then
$x/1\in \mathfrak q$. But $x\in S$, hence $x/1$ is invertible in
$S^{-1}A$ which is impossible since $\mathfrak q$ is a prime ideal.
For any prime ideal $\mathfrak p$ in
$A$ which does not meet $S$, $S^{-1}\mathfrak p$ is an ideal in $S^{-1}A$.
Moreover it is a prime ideal. This is because $S^{-1}A/S^{-1}\mathfrak p$ is
isomorphic to $\overline{S}^{-1}(A/\mathfrak p)$ and the localization of an
integral domain is again an integral domain.

\medskip\noindent
We still have to show that this map is open, i.e. we have to show
that the image of a standard open set is again open. For any
$x/s\in S^{-1}A$, we claim that the image of $D(x/s)$ is
$D(x)\cap\text{Im}(f)$.
First if $x/s\not\in S^{-1}\mathfrak p$ for some prime
ideal $\mathfrak p$ of $A$, then $x\not\in\mathfrak p$.
Conversely, if $x\not\in\mathfrak p$
and $\mathfrak p$ does not meet $S$, then
$x/s\not\in S^{-1}\mathfrak p$. This is
due to that fact that $\mathfrak p\cap S = \emptyset$.

\medskip\noindent
Thus $f$ is indeed an homeomorphism onto its image.
\end{proof}









\section{Internal Hom}
\label{section-hom}

\noindent
If $R$ is a ring, and $M$, $N$ are $R$-modules, then
$$
\text{Hom}_R(M, N) = \{ \varphi : M \to N\}
$$
is the set of $R$-linear maps from $M$ to $N$. This set comes with
the structure of an abelian group by setting
$(\varphi + \psi)(m) = \varphi(m) + \psi(m)$, as usual.
In fact, $\text{Hom}_R(M, N)$ is also an $R$-module via the rule
$(x \varphi)(m) = x \varphi(m) = \varphi(xm)$.

\medskip\noindent
Given maps $a : M \to M'$ and $b : N \to N'$ of $R$-modules, we can
pre-compose and post-compose homomorphisms by $a$ and $b$. This leads
to the following commutative diagram
$$
\xymatrix{
\text{Hom}_R(M', N) \ar[d]_{- \circ a} \ar[r]_{b \circ -} &
\text{Hom}_R(M', N') \ar[d]^{- \circ a} \\
\text{Hom}_R(M, N') \ar[r]^{b \circ -} &
\text{Hom}_R(M, N)
}
$$
In fact, the maps in this diagram are $R$-module maps.
Thus $\text{Hom}_R$ defines an additive functor
$$
\text{Mod}_R^{opp} \times \text{Mod}_R \longrightarrow \text{Mod}_R,\quad
(M, N) \longmapsto \text{Hom}_R(M, N)
$$

\begin{lemma}
\label{lemma-hom-exact}
Exactness and $\text{Hom}_R$. Let $R$ be a ring.
\begin{enumerate}
\item Let $M_1 \to M_2 \to M_3 \to 0$ be a complex of $R$-modules.
Then $M_1 \to M_2 \to M_3 \to 0$ is exact if and only if
$0 \to \text{Hom}_R(M_3, N) \to \text{Hom}_R(M_2, N) \to \text{Hom}_R(M_1, N)$
is exact for all $R$-modules $N$.
\item  Let $0 \to M_1 \to M_2 \to M_3$ be a complex of $R$-modules.
Then $0 \to M_1 \to M_2 \to M_3$ is exact if and only if
$0 \to \text{Hom}_R(N, M_1) \to \text{Hom}_R(N, M_2) \to \text{Hom}_R(N, M_1)$
is exact for all $R$-modules $N$.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-hom-from-finitely-presented}
Let $R$ be a ring.
Let $M$ be a finitely presented $R$-module.
Let $N$ be an $R$-module.
Let $f \in R$.
Then $\text{Hom}_R(M, N)_f \cong \text{Hom}_{R_f}(M_f, N_f)$.
\end{lemma}

\begin{proof}
Choose a presentation
$$
\bigoplus\nolimits_{j = 1, \ldots, m} R
\longrightarrow
\bigoplus\nolimits_{i = 1, \ldots, n} R
\to M \to 0.
$$
By
Lemma \ref{lemma-hom-exact}
this gives an exact sequence
$$
0 \to
\textit{Hom}_R(M, N) \to
\bigoplus\nolimits_{i = 1, \ldots, n} N
\longrightarrow
\bigoplus\nolimits_{j = 1, \ldots, m} N.
$$
Inverting $f$ we get an exact sequence
$$
0 \to
(\textit{Hom}_R(M, N))_f \to
\bigoplus\nolimits_{i = 1, \ldots, n} N_f
\longrightarrow
\bigoplus\nolimits_{j = 1, \ldots, m} N_f
$$
and the result follows since $M_f$ sits in
an exact sequence
$$
\bigoplus\nolimits_{j = 1, \ldots, m} R_f
\longrightarrow
\bigoplus\nolimits_{i = 1, \ldots, n} R_f \to M_f \to 0
$$
which induces
(by Lemma \ref{lemma-hom-exact})
the exact sequence
$$
0 \to
\text{Hom}_{R_f}(M_f, N_f) \to
\bigoplus\nolimits_{i = 1, \ldots, n} N_f
\longrightarrow
\bigoplus\nolimits_{j = 1, \ldots, m} N_f
$$
which is the same as the one above.
\end{proof}


















\section{Tensor products}
\label{section-tensor-product}

\begin{definition}
\label{definition-bilinear}
Let $R$ be a ring, $M, N, P$ be three $A-$modules.
A mapping $f : M \times N \to P$ (where $M\times N$
is viewed only as Cartesian product of two $R$-modules) is said to be
{\it $R$-bilinear} if for each $x \in M$
the mapping $y\mapsto f(x, y)$ of $N$ into $P$ is $R$-linear, and for each
$y\in N$ the mapping $x\mapsto f(x, y)$ is also $R$-linear.
\end{definition}

\begin{lemma}
\label{lemma-tensor-product}
Let $M, N$ be $R$-modules. Then there exists a pair $(T, g)$
where $T$ is an $R$-module, and
$g : M\times N \to T$ an $R$-bilinear
mapping, with the following universal property:
For any $R$-module $P$ and any $R$-bilinear mapping
$f : M\times N \to P$, there
exists a unique $R$-linear
mapping $\tilde{f} : T \to P$ such that $f = \tilde{f} \circ g$.
In other words, the following diagram commutes:
$$
\xymatrix{
M\times N \ar[rr]^{f} \ar[dr] & &P\\
&T \ar[ur]_{f'}
}
$$
Moreover, if $(T, g)$ and $(T', g')$
are two pairs with this property, then there
exists a unique isomorphism
$j : T \to T'$ such that $j\circ g = g'$.
\end{lemma}

\noindent
The $R$-module $T$ which satisfies the above universal property is called
the  \textit{tensor product} of $R$-modules $M$ and $N$, denoted as
$M\otimes_{R} N$.

\medskip\noindent
We first prove the existence of such $R$-module $T$.
Let $M, N$ be $R$-modules.
Let $T$ be the quotient module
$P/Q$, where $P$ is the free $R$-module $R^{M\times N}$ and $Q$ is the
$R$-module generated by all elements of
the following types: ($x\in M, y\in N$)
\begin{align}
(x + x', y)-(x, y)-(x', y)\\
(x, y + y')-(x, y)-(x, y')\\
(ax, y)-a\cdot(x, y)\\
(x, ay)-a\cdot(x, y)
\end{align}
Let $\pi : M\times N \to T$ denote the natural map.
This map is $R$-bilinear, as
implied by the above relations
when we check the bilinearity conditions. Denote the image
$\pi(x, y) = x\otimes
y$, then these elements generate
$T$. Now let $f : M\times N \to P$ be an $R$-bilinear map,
then we can define
$f' : T \to P$ by extending the mapping
$f'(x\otimes y) = f(x, y)$. Clearly $f = f'\circ \pi$. Moreover, $f'$ is
uniquely determined by the value on the
generating sets $\{x\otimes y : x\in M, y\in N\}$.
Suppose there is another pair $(T', g')$ satisfying the same properties.
Then there is a unique $j : T \to T'$ and
also $j' : T' \to T$ such that $g' = j\circ g$, $g = j'\circ g'$.
But then both the maps $(j\circ j') \circ g$ and $g$
satisfies the universal properties, so by uniqueness they are equal,
and hence $j'\circ j$ is identity on $T$.
Similarly $(j'\circ j) \circ g' = g'$ and $j\circ j'$ is identity on $T'$.
So $j$ is an isomorphism.

\begin{lemma}
\label{lemma-flip-tensor-product}
Let $M, N, P$ be $R$-modules, then the bilinear maps
\begin{align}
(x, y) & \mapsto y\otimes x\\
(x + y, z) &\mapsto x\otimes z + y\otimes z\\
(r, x) &\mapsto rx
\end{align}
induce unique isomorphisms
\begin{align}
M\otimes_R N & \to N\otimes_R M, \\
(M\oplus N)\otimes_R P & \to (M\otimes_R P)\oplus(N\otimes_R P),  \\
R\otimes_R M & \to M
\end{align}
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\noindent
We may generalize the tensor product of two $R$-modules to finitely many
$R$-modules, and set up a
correspondence between the multi-tensor product with multilinear mappings.
Using almost the same construction
one can prove that:

\begin{lemma}
\label{lemma-multilinear}
Let $M_1, \ldots, M_r$ be $R$-modules.
Then there exists a pair $(T, g)$ consisting
of an $R$-module T and an
$R$-multilinear mapping:
$g : M_1\times \ldots\times M_r \to T$ with the universal
property: For any $R$-multilinear
mapping $f : M_1\times \ldots \times M_r \to P$ there exists a unique
$R$-homomorphism $f' : T \to P$ such that
$f'\circ g = f$. \\
Such a module $T$ is unique up to isomorphism, i.e. if $(T, g)$ and $(T', g')$
are two such pairs, then there exists a unique isomorphism
$j : T' \to T$ with $j\circ g = g'$. We denote
$T = M_1\otimes_R \ldots \otimes_R M_r$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-transitive}
The homomorphisms
\begin{align}
(M\otimes_R N)\otimes_R P \to
M\otimes_R N\otimes_R P \to
M\otimes_R (N\otimes_R P)
\end{align}
such that
$f((x\otimes y)\otimes z) = x\otimes y\otimes z$
and $g(x\otimes y\otimes z) = x\otimes (y\otimes z)$,
$x\in M, y\in N, z\in P$ are well-defined and are isomorphisms.
\end{lemma}

\begin{proof}
We shall prove $f$ is well-defined and is an isomorphism, and this proof
carries analogously to $g$. Fix any
$z\in P$, then the mapping $(x, y)\mapsto x\otimes y\otimes z$,
$x\in M, y\in N$, is $R$-bilinear in $x$ and $y$,
and hence induces homomorphism $f_z : M\otimes N \to M\otimes N\otimes P$
$f_z(x\otimes y) = x\otimes y\otimes z$.
Then consider $(M\otimes N)\times P \to M\otimes N\otimes P$ given by
$(w, z)\mapsto f_z(w)$. The map is
$R$-bilinear and thus induces
$f : (M\otimes_R N)\otimes_R P \to M\otimes_R N\otimes_R P$
and $f((x\otimes y)\otimes z) = x\otimes y\otimes z$.
To construct the inverse, we note that the map
$\pi : M\times N\times P \to (M\otimes N)\otimes P$ is
$R$-trilinear.
Therefore, it induces an $R$-linear map
$h : M\otimes N\otimes P \to (M\otimes N)\otimes P$ which
agrees with the universal property. Here we see that
$h(x\otimes y\otimes z) = (x\otimes y)\otimes z$.
From the explicit expression of $f$ and $h$, $f\circ h$ and $h\circ f$ are
identity maps of $M\otimes N\otimes
P$ and $(M\otimes N)\otimes P$ respectively, hence $f$ is our desired
isomorphism.
\end{proof}

\noindent
Doing induction we see that this extends to multi-tensor products. Combined
with Lemma \ref{lemma-flip-tensor-product} we see that
the tensor product operation on the category of $R$-modules is associative,
commutative and distributive.

\begin{definition}
\label{definition-bimodule}
An abelian group $N$ is called an {\it $(A, B)$-bimodule} if it is both an
$A$-module and a $B$-module, and
the actions $A \to End(M)$ and $B \to End(M)$
are compatible in the sense that $(ax)b = a(xb)$ for all
$a\in A, b\in B, x\in N$. Usually we denote it as $_{A}N_{B}$.
\end{definition}

\begin{lemma}
\label{lemma-tensor-with-bimodule}
For $A$-module $M$, $B$-module P and $(A, B)$-bimodule N, the modules
$(M\otimes_{A}N)\otimes_{B}P$ and $M\otimes_{A}(N\otimes_{B}P)$ can both be
given $(A, B)$-bimodule structure,
and moreover
\begin{align}
(M\otimes_{A}N)\otimes_{B}P \cong M\otimes_{A}(N\otimes_{B}P).
\end{align}
\end{lemma}

\begin{proof}
A Priori $M\otimes_A N$ is an $A$-module, but we can give $B$-module structure
by letting
\begin{center}
$(x\otimes y)b = x\otimes yb, x\in M, y\in N, b\in B$
\end{center}
Thus $M\otimes_A N$ becomes an $(A, B)$-bimodule. Similarly for $N\otimes_B P$,
and thus for
$(M\otimes_{A}N)\otimes_{B}P$ and $M\otimes_{A}(N\otimes_{B}P)$. Therefore by
the above lemma, these two
modules are isomorphic as both as $A$-module and $B$-module via the same
mapping.
\end{proof}

\begin{definition}
\label{definition-directed-set}
A {\it partially ordered set} is a set $I$ together with a relation
$\preceq$ such that whenever $i \preceq j$, $j \preceq k$
we have $i \preceq k$ and such that $i \preceq i$ for all $i \in I$.
A {\it directed set} $(I, \preceq)$
is a partially ordered set $(I, \preceq)$ such that
$I$ is not empty and such that $\forall x, y\in I$,
there exists $k\in I$ with $i\preceq k, j\preceq k$.
\end{definition}

\noindent
It is customary to drop the $\preceq$ from the notation when talking
about a partially ordered set.
This is the same as the notion defined in Categories,
Section \ref{categories-section-posets-limits}.

\begin{definition}
\label{definition-directed-system}
Let $(I, \preceq)$ be a partially ordered set.
A {\it system $(M_i, \mu_{ij})$ of $R$-modules over $I$}
consists of a family of $R$-modules $\{M_i\}_{i\in I}$ indexed
by $I$, and $\{\mu_{ij} : M_i \to M_j \mid i\preceq j\}$
a family of homomorphisms of
$R$-modules, such that for all $i \preceq j \preceq k$
\begin{align}
\mu_{ii} &= id_{M_i}\\
\mu_{ik} &= \mu_{jk}\circ \mu_{ij}
\end{align}
We say $(M_i, \mu_{ij})$ is a {\it directed system} if $I$ is a directed set.
\end{definition}

\noindent
This is the same as the notion defined in Categories,
Definition \ref{categories-definition-system-over-poset}
and Section \ref{categories-section-posets-limits}.
We refer to Categories, Definition \ref{categories-definition-colimit}
for the definition of a colimit of a diagram/system in any
category.

\begin{lemma}
\label{lemma-colimit}
Let $(M_i, \mu_{ij})$ be a system of $R$-modules over the
partially ordered set $I$.
The colimit of the system $(M_i, \mu_{ij})$ is the quotient $R$-module
$(\bigoplus_{i\in I} M_i) /Q$ where $Q$ is the
$R$-submodule generated by all elements
\begin{center}
$\iota_{i}(x_i)-\iota_{j}\circ \mu_{ij}(x_i)$
\end{center}
where $\iota_{i} : M_i \to \bigoplus_{i\in I} M_i$
is the natural inclusion. We denote the colimit
$M = \text{colim}_i\ M_i$. We denote
$\pi : \bigoplus_{i\in I} M_i \to M$ the
projection map and
$\phi_{i} = \pi \circ \iota_{i} : M_i \to M$.
\end{lemma}

\begin{proof}
This lemma is a special case of
Categories, Lemma \ref{categories-lemma-colimits-coproducts-coequalizers}
but we will also prove it directly in this case.
Namely, note that $\phi_{i} = \phi_{j}\circ \mu_{ij}$ in the above
construction. To show the pair $(M, \phi_{i})$ is the colimit we have
to show it satisfies the universal property: for any other such pair
$(Y, \psi_{i})$ with $\psi_{i} : M_i \to
Y$, $\psi_{i} = \psi_{j}\circ \mu_{ij}$, there is a unique $R$-module
homomorphism $g : M \to Y$ such that the
following diagram commutes:
$$
\xymatrix{
M_i \ar[rr]^{\mu_{ij}} \ar[dr]^{\phi_{i}} \ar[ddr]_{\psi_{i}} & &
M_j\ar[dl]_{\phi_{j}} \ar[ddl]^{\psi_{j}} \\
& M \ar[d]^{g}\\
& Y
}
$$
And this is clear because we can define $g$ by taking the
map $\psi_i$ on the summand $M_i$ in the direct sum
$\bigoplus M_i$.
\end{proof}

\begin{lemma}
\label{lemma-directed-colimit}
Let $(M_i, \mu_{ij})$ be a system of $R$-modules over the
partially ordered set $I$. Assume that $I$ is directed.
The colimit of the system $(M_i, \mu_{ij})$ is canonically
isomorphic to the module $M$ defined as follows:
\begin{enumerate}
\item as a set let
$$
M = (\coprod\nolimits_{i \in I} M_i)/\sim
$$
where for $m \in M_i$ and $m' \in M_{i'}$ we have
$m \sim m' \Leftrightarrow \exists j, i \preceq j, i' \preceq j,
\mu_{ij}(m) = \mu_{i'j}(m')$,
\item as an abelian group for $m \in M_i$ and $m' \in M_{i'}$
we define the sum of the classes of $m$ and $m'$ in $M$
to be the class of $\mu_{ij}(m) + \mu_{i'j}(m')$ where
$j \in I$ is any index with $i \preceq j$ and $i' \preceq j$, and
\item as an $R$-module define for $m \in M_i$ and $x \in R$
the product of $x$ and the class of $m$ in $M$ to be the
class of $xm$ in $M$.
\end{enumerate}
The canonical maps $\phi_i : M_i \to M$ are induced by the canonical
maps $M_i \to \coprod_{i \in I} M_i$.
\end{lemma}

\begin{proof}
Omitted. Compare with
Categories, Section \ref{categories-section-directed-colimits}.
\end{proof}

\begin{lemma}
\label{lemma-zero-directed-limit}
Let $(M_i, \mu_{ij})$ be a directed system.
Let $M = \text{colim}\ M_i$ with $\mu_i : M_i \to M$,
then $\mu_i(x_i) = 0$ for $x_i\in M_i$ if and only if
there exists $j\succeq i$ such that $\mu_{ij}(x_i) = 0$.
\end{lemma}

\begin{proof}
This is clear from the description of the directed colimit
in Lemma \ref{lemma-directed-colimit}.
\end{proof}

\begin{example}
\label{example-zero-colimit-different}
Consider the partially ordered set $I = \{a, b, c\}$ with
$a \prec b$ and $a \prec c$ and no other strict inequalities.
A system $(M_a, M_b, M_c, \mu_{ab}, \mu_{ac})$
over $I$ consists of three $R$-modules $M_a, M_b, M_c$
and two $R$-module homomorphisms $\mu_{ab} : M_a \to M_b$ and
$\mu_{ac} : M_a \to M_c$.
The colimit of the system is just
$$
M := \text{colim}_{i \in I} M_i = \text{Coker}(M_a \to M_b \oplus M_c)
$$
where the map is the direct sum of $\mu_{ab}$ and $\mu_{ac}$.
Thus the kernel of the canonical map $M_a \to M$ is the image
of $\text{Ker}(\mu_{ac})$ under the map $\mu_{ab}$. Hence clearly
the result of Lemma \ref{lemma-zero-directed-limit} is false for
general systems.
\end{example}

\begin{definition}
\label{definition-homomorphism-directed-systems}
Let $\textbf{M} = (M_i, \mu_{ij}), \textbf{N} = (N_i, \nu_{ij})$ be
systems of $R$-modules over the same partially ordered set.
A {\it homomorphism of systems} $\Phi : \textbf{M} \to \textbf{N}$
is by definition a family of $R$-module homomorphisms
$\phi_i : M_i \to N_{i}$
such that $\phi_j \circ \mu_{ij} = \nu_{ij} \circ \phi_i$
for all $i \preceq j$.
\end{definition}

\noindent
This is the same notion as a transformation of functors
between the associated diagrams $\textbf{M} : I \to \text{Mod}_R$
and $\textbf{N} : I \to \text{Mod}_R$, in the language of
categories.
The following lemma is a special case of
Categories, Lemma \ref{categories-lemma-functorial-colimit}.

\begin{lemma}
\label{lemma-homomorphism-limit}
Let $\textbf{M} = (M_i, \mu_{ij}), \textbf{N} = (N_i, \nu_{ij})$ be
systems of $R$-modules over the same partially ordered set.
A morphism of systems $\Phi : \textbf{M} \to \textbf{N}$
induces a unique homomorphism
$\phi = \text{colim}\ \phi_{i}: M = \text{colim}\ \textbf{M}
\to N = \text{colim}\ \textbf{N}$ such that $\phi \circ
\mu_{i} = \nu_{i} \circ \phi_{i}$ for all $i\in I$.
\end{lemma}

\begin{proof}
From the commutative diagram below:
$$
\xymatrix{
M_i \ar[r]^{\iota_i} \ar[d]^{\phi_i}&\oplus_{i\in I} M_i\ar[r]^{\pi_1}
\ar[d]_{\oplus\phi_i}
& M \ar[d]_{\phi}\\
N_i \ar[r]^{\lambda_i} &\oplus_{i\in I} N_i \ar[r]^{\pi_2} &N
}
$$
where $\mu_{i} = \pi_1 \circ \iota_{i}, \nu_{i} = \pi_2 \circ \lambda_{i}$,
$\pi_1 : \bigoplus_{i\in I}M_i \to M,
\pi_2 : \bigoplus_{i\in I}N_i \to N$ are projection maps,
$\iota_i : M_i \to
\bigoplus_{i\in I}M_i, \lambda_{i} : N_i \to
\bigoplus_{i\in I}N_i$ are inclusions, the existence of such homomorphism is
evident. We check the
well-definedness in the following steps.
First, we need to check that if $i\preceq j$, then
$\pi_2(\phi_i(\iota_i(x_i))) = \pi_2(\phi_j(\iota_j\circ\mu_{ij}(x_i)))$.
Actually, for every $x_i\in M_i$, \\
$\pi_2\circ[(\phi_i\circ\iota_i)(x_i)-(\phi_j\circ\iota_j\circ\mu_{ij})(x_i)] =
\pi_2\circ[\lambda_i\circ\phi_i-\lambda_j\circ\phi_j\circ\mu_{ij}](x_i)
=\pi_2\circ[\lambda_i-\lambda_j\circ\nu_{ij}(y)] = 0$, where $y = \phi_i(x_i)$

\medskip\noindent
Next, we prove that if $i\preceq j$, then
$\phi(\mu_i(x_i)) = \phi(\mu_j\circ\mu_{ij}(x_i))$. We have
\begin{align}
\phi(\mu_i(x_i))&= \nu_i\circ\phi_i(x_i)\\
\phi(\mu_j\circ\mu_{ij}(x_i))&= \nu_j\circ\phi_j(\mu_{ij}(x_i))=
\nu_j(\nu_{ij}\circ\phi_i(x_i))
\end{align}
Then, letting $y = \phi_i(x_i)$,
\begin{center}
$\nu_i\circ\phi_i(x_i)-\nu_j\circ\phi_j(\mu_{ij}(x_i))=
\pi_2(\lambda_i(y)-\lambda_j\circ\nu_{ij}(y)) = 0$
\end{center}
Second, we claim that every element in $M$ is in the form of $\mu_{\beta}(x),
x\in M_{\beta}$. Every element in
$\bigoplus_{i\in I}M_i$ is of the form $\sum_{k = 1}^n \iota_{i_k}(x_{i_k})$. By
induction on $n$, we can find
$\beta\in I$ with $i_k\preceq\beta$ for all $k = 1, \ldots, n$. Then
\begin{center}
$\sum_{k = 1}^n
\iota_{i_k}(x_{i_k}) = \sum_{k = 1}^n
[\iota_{i_k}(x_{i_k}) - \iota_{\beta}\circ\mu_{i_{k}\beta}(x_k)
+ \iota_{\beta} \circ \mu_{i_{k}\beta}(x_k)]$
\end{center}
Then by linearity, we have
\begin{center}
$\pi( \sum_{k = 1}^n \iota_{i_k}(x_{i_k}))
= \pi \circ \iota_{\beta}(\sum_{k = 1}^n  \mu_{i_{k} \beta}(x_k))
= \mu_{\beta}(\sum_{k = 1}^n \mu_{i_{k}\beta}(x_k))$
\end{center}
These two claims together prove that $\phi$ is well defined independent of
equivalent representatives of the
same element in $M$, and such representative can be chosen as inclusion of
$x_i\in M_i$. Linearity then follows,
and the required commutativity is
evident from the definition of the map $\phi$.
Also, the value of $\phi$ is uniquely determined by the values of $\phi_i$.
\end{proof}

\begin{lemma}
\label{lemma-directed-colimit-exact}
Let $I$ be a directed partially ordered set.
Let $(L_i, \lambda_{ij})$, $(M_i, \mu_{ij})$, and
$(N_i, \nu_{ij})$ be systems of $R$-modules over $I$.
Let $\varphi_i : L_i \to M_i$ and $\psi_i : M_i \to N_i$ be
morphisms of systems over $I$. Assume that for all $i \in I$ the
sequence of $R$-modules
$$
\xymatrix{
L_i \ar[r]^{\varphi_i} &
M_i \ar[r]^{\psi_i} &
N_i
}
$$
is a complex with homology $H_i$.
Then the $R$-modules $H_i$ form a system over $I$,
the sequence of $R$-modules
$$
\xymatrix{
\text{colim}_i\ L_i \ar[r]^\varphi &
\text{colim}_i\ M_i \ar[r]^\psi &
\text{colim}_i\ N_i
}
$$
is a complex as well, and denoting $H$ its homology we have
$$
H = \text{colim}_i\ H_i.
$$
\end{lemma}

\begin{proof}
We are going to repeatedly use the description of colimits over $I$
as in Lemma \ref{lemma-directed-colimit} without further mention.
Let $h \in H$.
Since $H = \text{ker}(\varphi)/\text{Im}(\psi)$ we see that
$h$ is the class mod $\text{Im}(\psi)$ of an element $[m]$
in $\text{Ker}(\psi) \subset \text{colim}_i\ M_i$. Choose an
$i$ such that $[m]$ comes from an element $m \in M_i$. Choose
a $j \geq i$ such that $\nu_{ij}(\psi_i(m)) = 0$ which is possible
since $[m] \in \text{Ker}(\psi)$. After replacing $i$ by $j$ and
$m$ by $\mu_{ij}(m)$ we see that we may assume $m \in \text{Ker}(\psi_i)$.
This shows that the map $\text{colim}_i\ H_i \to H$ is surjective.

\medskip\noindent
Suppose that $h_i \in H_i$ has image zero on $H$. Since
$H_i = \text{Ker}(\psi_i)/\text{Im}(\varphi_i)$ we may represent
$h_i$ by an element $m \in \text{Ker}(\psi_i) \subset M_i$.
The assumption on the vanishing of $h_i$ in $H$ means that
the class of $m$ in $\text{colim}_i\ M_i$ lies in the image
of $\varphi$. Hence there exists an $j \geq i$ and a $l \in L_j$
such that $\varphi_j(l) = \mu_{ij}(m)$. Clearly this shows that
the image of $h_i$ in $H_j$ is zero. This proves the
injectivity of $\text{colim}_i\ H_i \to H$.
\end{proof}

\begin{example}
\label{example-colimit-not-exact}
Taking colimits is not exact in general.
Consider the partially ordered set $I = \{a, b, c\}$ with
$a \prec b$ and $a \prec c$ and no other strict inequalities,
as in Example \ref{example-zero-colimit-different}.
Consider the map of systems
$(0, \mathbf{Z}, \mathbf{Z}, 0, 0) \to
(\mathbf{Z}, \mathbf{Z}, \mathbf{Z}, 1, 1)$.
From the description of the colimit in
Example \ref{example-zero-colimit-different}
we see that the associated map of colimits is not injective,
even though the map of systems is injective on each object.
Hence the result of Lemma \ref{lemma-directed-colimit-exact}
is false for general systems.
\end{example}

\begin{lemma}
\label{lemma-almost-directed-colimit-exact}
Let $\mathcal{I}$ be an index category satisfying the assumptions of
Categories, Lemma \ref{categories-lemma-split-into-directed}.
Then taking colimits of diagrams of abelian groups over $\mathcal{I}$
is exact (i.e., the analogue of
Lemma \ref{lemma-directed-colimit-exact}
holds in this situation).
\end{lemma}

\begin{proof}
By
Categories, Lemma \ref{categories-lemma-split-into-directed}
we may write $\mathcal{I} = \coprod_{j \in J} \mathcal{I}_j$ with each
$\mathcal{I}_j$ a filtered category, and $J$ possibly empty. By
Categories, Lemma \ref{categories-lemma-directed-category-system}
taking colimits over the index categories $\mathcal{I}_j$ is
the same as taking the colimit over some directed partially ordered
set. Hence
Lemma \ref{lemma-directed-colimit-exact}
applies to these colimits. This reduces the problem to showing that
coproducts in the category of $R$-modules over the set $J$ are exact.
In other words, exact sequences
$L_j \to M_j \to N_j$ of $R$ modules we have to show that
$$
\bigoplus\nolimits_{j \in J} L_j
\longrightarrow
\bigoplus\nolimits_{j \in J} M_j
\longrightarrow
\bigoplus\nolimits_{j \in J} N_j
$$
is exact. This can be verified by hand, and holds even if $J$ is empty.
\end{proof}


\begin{lemma}
\label{lemma-tensor-products-commute-with-limits}
(Tensor products commute with colimits.)
Let $(M_i, \mu_{ij})$ be a system over the partially ordered set $I$.
Let $N$ be an $R$-module. Then
\begin{align}
\text{colim}\ (M_i\otimes N) \cong (\text{colim}\ M_i)\otimes N.
\end{align}
Moreover, the isomorphism is induced by the homomorphisms
$\mu_i\otimes 1: M_i\otimes N \to M\otimes N$
where $M = \text{colim}_i\ M_i$ with natural maps $\mu_i : M_i \to M$.
\end{lemma}

\begin{proof}
Let $P = \text{colim}\ (M_i\otimes N)$, $M = \text{colim}\ M_i$.
Then for all $i\preceq j$, the
following diagram commutes:
$$
\xymatrix{
    M_i\otimes N \ar[r]^{\mu_{i}\otimes 1} \ar[d]^{\mu_{ij}\otimes 1}&M\otimes
N\ar[d]_{id} \\
    M_j\otimes N \ar[r]^{\mu_{j}\otimes 1} &M\otimes N
}
$$
By Lemma \ref{lemma-homomorphism-limit},
these maps induce a unique homomorphism
$\psi : P \to M\otimes N$, with
$\lambda_{i} : M_i\otimes
N \to P$ given by $\lambda_{i} = \pi \circ (\iota_{i}\otimes 1)$.

\medskip\noindent
To construct the inverse map, for each $i\in I$, there is the canonical
$R$-bilinear mapping $g_i : M_i\times N \to
M_i \otimes N$. This induces a unique mapping
$\widehat{\phi} : M\times N \to P$
such that $\widehat{\phi}\circ
(\mu_i\times 1) = \lambda_i\circ g_i$. and it is well-defined, and also
$R$-bilinear. Thus it induces an
$R$-linear mapping $\phi: M\otimes N \to P$.
From the commutative diagram below:
$$
\xymatrix{
    M_i\times N \ar[r]^{g_i} \ar[d]^{\mu_{i}\times id}&M_i\otimes N\ar[r]_{id}
\ar[d]_{\lambda_i}
    &M_i\otimes N \ar[d]_{\mu_i\otimes id} \ar[rd]^{\lambda_i}\\
    M\times N \ar[r]^{\widehat{\phi}} &P \ar[r]^{\psi} &M\otimes N
\ar[r]^{\phi} &P
    }
$$
we see that $\psi\circ\widehat{\phi} = g$, the canonical $R$-bilinear mapping
$g : M\times N \to M\otimes N$. So
$\psi\circ\phi$ is identity on $M\otimes N$. From the right-hand square and
triangle, $\phi\circ\psi$ is also
identity on $P$.
\end{proof}

\noindent
Exactness Properties.
We first make a basic observation relating tensor products and
the functor $\text{Hom}$:

\begin{lemma}
\label{lemma-hom-from-tensor-product}
For any three $R$-modules $M, N, P$,
\begin{align}
\text{Hom}_R(M\otimes_R N, P) \cong \text{Hom}_R(M, \text{Hom}_R(N, P))
\end{align}
\end{lemma}

\begin{proof}
An $R$-linear map $\hat{f}\in \text{Hom}_R(M\otimes_R N, P)$ corresponds to an
$R$-bilinear map $f : M\times N \to P$. For
each $x\in M$ the mapping $y\mapsto f(x, y)$ is $R$-linear by the universal
property. Thus $f$ corresponds to a
map $\phi_f : M \to \text{Hom}_R(N, P)$. This map is $R$-linear since
$$
\phi_f(ax + y)(z) = f(ax + y, z) = af(x, z)+f(y, z) = (a\phi_f(x)+\phi_f(y))(z),
$$
$\forall y\in N$ and $\forall a\in R, x, z\in M$. Conversely, any
$f\in\text{Hom}_R(M, \text{Hom}_R(N, P))$ defines an $R$-bilinear
map $M\times N \to P$, namely $(x, y)\mapsto f(x)(y)$.
So this is a natural one-to-one correspondence between the
two modules.
\end{proof}

\begin{lemma}
\label{lemma-tensor-product-exact}
Let
\begin{align}
M_1\xrightarrow{f} M_2\xrightarrow{g} M_3 \to 0
\end{align}
be an exact sequence of $R$-modules and homomorphisms, and let $N$ be any
$R$-module. Then the sequence
\begin{align}
\label{equation-2ndex}
M_1\otimes N\xrightarrow{f\otimes 1} M_2\otimes N \xrightarrow{g\otimes 1}
M_3\otimes N \to 0
\end{align}
is exact. In other words, the functor $- \otimes_{R} N$ is \textit{right
exact}, in the sense that tensoring
each term in the original right exact sequence preserves the exactness.
\end{lemma}

\begin{proof}
We apply the functor $\text{Hom}(-, \text{Hom}(N, P))$ to the first exact
sequence. We obtain
\begin{center}
$
0 \to
\text{Hom}(M_3, \text{Hom}(N, P)) \to
\text{Hom}(M_2, \text{Hom}(N, P)) \to
\text{Hom}(M_1, \text{Hom}(N, P))$
\end{center}
By Lemma \ref{lemma-hom-from-tensor-product}, we have
\begin{center}
$0 \to \text{Hom}(M_3 \otimes N, P) \to
\text{Hom}(M_2 \otimes N, P) \to \text{Hom}(M_1 \otimes N, P)$
\end{center}
Using the pullback property again, we arrive at the desired exact sequence.
\end{proof}

\begin{remark}
\label{remark-tensor-product-not-exact}
However, tensor product does NOT preserve exact sequences in general.
In other words, if $M_1 \to M_2 \to M_3$ is
exact, then it is not necessarily true that
$M_1 \otimes N \to M_2 \otimes N \to M_3 \otimes N$
is exact for arbitrary $R$-module $N$.
\end{remark}

\begin{example}
\label{example-tensor-product-not-exact}
Consider the exact sequence
$0 \to \mathbb{Z}\xrightarrow{f} \mathbb{Z}$ where
$f(x) = 2x$ for all $x\in
\mathbb{Z}$. Let $N = \mathbb{Z}/2$, then the sequence
$0 \to 0 \to
\mathbb{Z}\otimes \mathbb{Z}/2 \xrightarrow{f}
\mathbb{Z}\otimes \mathbb{Z}/2$
is NOT exact. This is because
$\forall x\otimes y\in \mathbb{Z}\otimes \mathbb{Z}/2$,
\begin{center}
$(f\otimes 1)(x\otimes y) = 2x\otimes y = x\otimes 2y = x\otimes 0 = 0$.
\end{center}
Therefore $f\otimes 1$ is the zero map while $\mathbb{Z}\otimes N\neq 0$.
\end{example}

\begin{remark}
\label{remark-flat-module}
For $R$-modules $N$, if the
functor $-\otimes_{R} N$ is exact, i.e. tensoring
with $N$ preserves all exact
sequences, then $N$ is said to be \textit{flat} $R$-module.
We will discuss this later.
\end{remark}

\begin{lemma}
\label{lemma-tensor-localization}
Let $M$ be an $R$-module. Then the $S^{-1}R$ modules $S^{-1}M$
and $S^{-1}R\otimes_{R}M$ are canonically isomorphic, and the
unique isomorphism $f : S^{-1}R\otimes_{R}M \to S^{-1}M$
is given by
\begin{align}
f((a/s)\otimes m) = am/s, \forall a\in R, m\in M, s\in S
\end{align}
\end{lemma}

\begin{proof}
Obviously, the map
$f' : S^{-1}R\times M \to S^{-1}M$ given by $f((am, s)) = am/s$ is
bilinear, and thus by the
universal property, this map induces a unique $S^{-1}R$-module homomorphism
$f : S^{-1}R\otimes_{R}M \to S^{-1}M$ given as in the above lemma.
Actually every element in $S^{-1}M$ is of the form $m/s$, $m\in M, s\in S$ and
every element in
$S^{-1}R\otimes_{R}M$ is of the form $1/s \otimes m$. To see the latter fact,
write an element in
$S^{-1}R\otimes_{R}M$ as
\begin{center}
$\sum_{k}\frac{a_k}{s_k}\otimes m_k = \sum_{k}\frac{a_{k}t_k}{s}\otimes
m_k = \frac{1}{s}\otimes\sum_{k}{a_{k}t_k}m_k = \frac{1}{s}\otimes m$
\end{center}
Where $m = \sum_{k}{a_{k}t_k}m_k$. Then it is obvious that $f$ is surjective,
and if $f(\frac{1}{s}\otimes m) = m/s = 0$ then there exists $t'\in S$ with
$tm = 0$ in $M$. Then we have
\begin{center}
$\frac{1}{s} \otimes m = \frac{1}{st} \otimes tm = \frac{1}{st} \otimes 0 = 0$.
\end{center}
Therefore $f$ is injective.
\end{proof}

\begin{lemma}
\label{lemma-tensor-product-localization}
Let $M, N$ be $R$-modules, then there is a canonical
$S^{-1}R$-module isomorphism
$f : S^{-1}M\otimes_{S^{-1}R}S^{-1}N \to S^{-1}(M\otimes_{R} N)$,
given by
\begin{center}
$f((m/s)\otimes(n/t) = (m\otimes n)/st$.
\end{center}
\end{lemma}

\begin{proof}
We may use Lemma \ref{lemma-tensor-with-bimodule}
and Lemma \ref{lemma-tensor-localization} repeatedly to
see that these two
$S^{-1}R$-modules are isomorphic, noting that $S^{-1}R$ is an
$(R, S^{-1}R)$-bimodule:
\begin{align}
S^{-1}(M\otimes_{R} N) &\cong S^{-1}R\otimes_R (M\otimes_R N)\\
 &\cong S^{-1}M\otimes_R N\\
 &\cong (S^{-1}M\otimes_{S^{-1}R}S^{-1}R)\otimes_R N\\
 &\cong S^{-1}M\otimes_{S^{-1}R}(S^{-1}R\otimes_R N)\\
 &\cong S^{-1}M\otimes_{S^{-1}R}S^{-1}N
\end{align}
This isomorphism is easily seen to be the one stated in the lemma.
\end{proof}


















\section{Tensor algebra}
\label{section-tensor-algebra}

\noindent
Let $R$ be a ring. Let $M$ be an $R$-module.
We define the {\it tensor algebra of $M$ over $R$} to
be the noncommutative $R$-algebra
$$
\text{T}(M) = \text{T}_R(M) =
\bigoplus_{n \geq 0} \text{T}^n(M)
$$
with
$\text{T}^0(M) = R$,
$\text{T}^1(M) = M$,
$\text{T}^2(M) = M \otimes_R M$,
$\text{T}^3(M) = M \otimes_R M \otimes_R M$, and so on.
Multiplication is defined by the rule that on pure tensors we have
$$
(x_1 \otimes x_2 \otimes \ldots \otimes x_n)
\cdot
(y_1 \otimes y_2 \otimes \ldots \otimes y_m)
=
x_1 \otimes x_2 \otimes \ldots \otimes x_n \otimes
y_1 \otimes y_2 \otimes \ldots \otimes y_m
$$
and we extend this by linearity.

\medskip\noindent
We define the {\it exterior algebra $\wedge(M)$ of $M$ over $R$}
to be the quotient of $\text{T}(M)$ by the two sided
ideal generated by the elements $x \otimes x \in \text{T}^2(M)$.
The image of a pure tensor $x_1 \otimes \ldots \otimes x_n$
in $\wedge^n(M)$ is denoted $x_1 \wedge \ldots \wedge x_n$.
These elements generate $\wedge^n(M)$, they are $R$-linear
in each $x_i$ and they are zero when two of the $x_i$ are equal
(i.e., alternating). The multiplication on $\wedge(M)$ is
graded commutative, i.e., $x \wedge y = - y \wedge x$.

\medskip\noindent
An example of this is when $M = Rx_1 \oplus \ldots \oplus Rx_n$
is a finite free module. In this case $\wedge(M)$ is free over
$R$ with basis the elements
$$
x_{i_1} \wedge \ldots \wedge x_{i_r}
$$
with $0 \leq r \leq n$ and $1 \leq i_1 < i_2 < \ldots < i_r \leq n$.

\medskip\noindent
We define the {\it symmetric algebra $\text{Sym}(M)$ of $M$ over $R$}
to be the quotient of $\text{T}(M)$ by the two sided
ideal generated by the elements $x \otimes y - y \otimes x \in \text{T}^2(M)$.
The image of a pure tensor $x_1 \otimes \ldots \otimes x_n$
in $\text{Sym}^n(M)$ is denoted just $x_1 \ldots x_n$.
These elements generate $\text{Sym}^n(M)$, these are $R$-linear
in each $x_i$ and $x_1 \ldots x_n = x_1' \ldots x_n'$ if the
sequence of elements $x_1, \ldots, x_n$ is a permutation of the
sequence $x_1', \ldots, x_n'$. Thus we see that $\text{Sym}(M)$
is commutative.

\medskip\noindent
An example of this is when $M = Rx_1 \oplus \ldots \oplus Rx_n$
is a finite free module. In this case
$\text{Sym}(M) = R[x_1, \ldots, x_n]$ is a polynomial algebra.

\begin{lemma}
\label{lemma-free-tensor-algebra}
Let $R$ be a ring. Let $M$ be an $R$-module.
If $M$ is a free $R$-module, so is each symmetric and exterior power.
\end{lemma}

\begin{proof}
Omitted, but see above for the finite free case.
\end{proof}

\begin{lemma}
\label{lemma-presentation-sym-exterior}
Let $R$ be a ring.
Let $M_2 \to M_1 \to M \to 0$ be an exact sequence of $R$-modules.
There are exact sequences
$$
M_2 \otimes_R \text{Sym}^{n - 1}(M_1)
\to
\text{Sym}^n(M_1)
\to
\text{Sym}^n(M)
\to
0
$$
and similarly
$$
M_2 \otimes_R \wedge^{n - 1}(M_1)
\to
\wedge^n(M_1)
\to
\wedge^n(M)
\to
0
$$
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-present-sym-wedge}
Let $R$ be a ring.
Let $M$ be an $R$-module.
Let $x_i$, $i \in I$ be a given system of generators of
$M$ as an $R$-module. Let $n \geq 2$.
There exists a canonical exact sequence
$$
\bigoplus_{1 \leq j_1 < j_2 \leq n}
\bigoplus_{i_1, i_2 \in I}
\text{T}^{n - 2}(M)
\oplus
\bigoplus_{1 \leq j_1 < j_2 \leq n}
\bigoplus_{i \in I}
\text{T}^{n - 2}(M)
\to
\text{T}^n(M)
\to
\wedge^n(M)
\to
0
$$
where the pure tensor $m_1 \otimes \ldots \otimes m_{n - 2}$ in the first
summand maps to
$$
m_1 \otimes \ldots \otimes x_{i_1} \otimes \ldots
\otimes x_{i_2} \otimes \ldots \otimes m_{n - 2}
+
m_1 \otimes \ldots \otimes x_{i_2} \otimes \ldots
\otimes x_{i_1} \otimes \ldots \otimes m_{n - 2}
$$
and $m_1 \otimes \ldots \otimes m_{n - 2}$ in the second
summand maps to
$$
m_1 \otimes \ldots \otimes x_i \otimes \ldots
\otimes x_i \otimes \ldots \otimes m_{n - 2}
$$
There is also a canonical exact sequence
$$
\bigoplus_{1 \leq j_1 < j_2 \leq n}
\bigoplus_{i_1, i_2 \in I}
\text{T}^{n - 2}(M)
\to
\text{T}^n(M)
\to
\text{Sym}^n(M)
\to
0
$$
where the pure tensor $m_1 \otimes \ldots \otimes m_{n - 2}$ maps to
$$
m_1 \otimes \ldots \otimes x_{i_1} \otimes \ldots
\otimes x_{i_2} \otimes \ldots \otimes m_{n - 2}
-
m_1 \otimes \ldots \otimes x_{i_2} \otimes \ldots
\otimes x_{i_1} \otimes \ldots \otimes m_{n - 2}
$$
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-colimit-tensor-algebra}
Let $R$ be a ring. Let $M_i$ be a directed system of
$R$-modules. Then
$\text{colim}_i\ \text{T}(M) = \text{T}(\text{colim}_i\ M_i)$
and similarly for the symmetric and exterior algebras.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}
















\section{Miscellany}
\label{section-miscellany}

\noindent
The proofs in this section should not refer to any results except
those from the section on basic notions, Section \ref{section-rings-basic}.

\begin{lemma}
\label{lemma-locally-nilpotent}
Let $R \to R'$ be a ring map and let $I \subset R$ be a locally nilpotent
ideal. Then $IR'$ is a locally nilpotent ideal of $R'$.
\end{lemma}

\begin{proof}
This follows from the fact that if $x, y \in R'$ are nilpotent, then
$x + y$ is nilpotent too. Namely, if $x^n = 0$ and $y^m = 0$, then
$(x + y)^{n + m - 1} = 0$.
\end{proof}

\begin{lemma}
\label{lemma-silly}
Suppose $R$ is a ring, $\mathfrak p_i$, $i = 1, \ldots, r$ primes
and $I \subset R$ an ideal. Assume $I \not\subset \mathfrak p_i$
for all $i$. Then there exists an $x\in I$, $x\not\in \mathfrak p_i$ for
all $i$.
\end{lemma}

\begin{proof}
We may assume there are no inclusions among the $\mathfrak p_i$.
The result is true for $r = 1$.
Suppose the result holds for $r-1$.
Pick $x \in I$, $x \not \in \mathfrak p_i$ for all $i = 1, \ldots, r-1$.
If $x \not\in \mathfrak p_r$ we are done. So assume $x \in \mathfrak p_r$.
If $I\mathfrak p_1 \ldots \mathfrak p_{r-1} \subset \mathfrak p_r$
then $I \subset \mathfrak p_r$ a contradiction.
Pick $y \in I\mathfrak p_1 \ldots \mathfrak p_{r-1}$,
$y \not \in \mathfrak p_r$. Then $x + y$ works.
\end{proof}

\begin{lemma}
\label{lemma-chinese-remainder}
(Chinese remainder.)
Let $R$ be a ring.
\begin{enumerate}
\item If $I_1, \ldots, I_r$ are ideals such that $I_a + I_b = R$
when $a \not = b$, then $I_1 \cap \ldots \cap I_r =
I_1I_2\ldots I_r$ and $R/(I_1I_2\ldots I_r)
\cong R/I_1 \times \ldots \times R/I_r$.
\item If $\mathfrak m_1, \ldots, \mathfrak m_r$ are pairwise distinct maximal
ideals then $\mathfrak m_a + \mathfrak m_b = R$ for $a \not = b$ and the
above applies.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-localize-colimit}
Let $M$ be an $R$-module, and let $S \subset R$ be
a multiplicative subset. Then $S^{-1}M = M\otimes_R S^{-1}R$
is the directed colimit of the modules $M_f$, $f\in S$ with
transition maps $M_{f'} \to M_f, m/(f')^n \mapsto (f'')^n m/f^n$
whenever $f = f' f''$ with $f, f', f''\in S$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-NAK}
(Nakayama's lemma.)
Let $R$ be a ring, let $M$ be an $R$-module, and let $I \subset R$
be an ideal.
\begin{enumerate}
\item If $M$ is finite, and $IM = M$, then there exists a
$f = 1 + i \in 1 + I$ such that $fM = 0$.
\label{item-nakayama}
\item If $M$ is finite, $IM = M$, and $I \subset \text{rad}(R)$
then $M = 0$.
\item If $IM = M$, $I$ is nilpotent, then $M = 0$.
\end{enumerate}
\end{lemma}

\begin{proof}
Proof of (\ref{item-nakayama}). Write $M = \sum Rx_j$, $j = 1, \ldots, r$.
Write $x_j = \sum i_{jj'} x_{j'}$ with $i_{jj'} \in I$.
In other words $\sum (\delta_{jj'} - i_{jj'})x_{j'} = 0$.
Hence the determinant $f$ of the $r\times r$ matrix
$(\delta_{jj'} - i_{jj'})$ is a solution. The other parts are easy.
\end{proof}


\begin{lemma}
\label{lemma-charpoly}
Let $R$ be a ring. Let $A = (a_{ij})$ be an $n\times n$
matrix with coefficients in $R$. Let $P(x) \in R[x]$
be the characteristic polynomial of $A$ (defined
as $\det(x\text{id}_{n\times n} - A)$).
Then $P(A) = 0$ in $\text{Mat}(n\times n, R)$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

















\section{The spectrum of a ring}
\label{section-spectrum-ring}

\noindent
We arbitrarily decide that the spectrum of a ring as a topological space
is part of the algebra chapter, whereas an affine scheme is part of the
chapter on schemes.

\begin{definition}
\label{definition-spectrum-ring}
Let $R$ be a ring.
\begin{enumerate}
\item The {\it spectrum} of $R$ is the set of prime ideals of $R$.
It is usually denoted $\text{Spec}(R)$.
\item Given a subset $T \subset R$ we let $V(T) \subset \text{Spec}(R)$
be the set of primes containing $T$, i.e., $V(T) = \{ \mathfrak p \in
\text{Spec}(R) \mid \forall f\in T, f\in \mathfrak p\}$.
\item Given an element $f \in R$ we let $D(f) \subset \text{Spec}(R)$
be the set of primes not containing $f$.
\end{enumerate}
\end{definition}

\begin{lemma}
\label{lemma-Zariski-topology}
Let $R$ be a ring.
\begin{enumerate}
\item The spectrum of a ring $R$ is empty if and only if $R$
is the zero ring.
\item Every nonzero ring has a maximal ideal.
\item Every nonzero ring has a minimal prime ideal.
\item Given an ideal $I \subset R$ and a prime ideal
$I \subset \mathfrak p$ there exists a prime
$I \subset \mathfrak q \subset \mathfrak p$ such
that $\mathfrak q$ is minimal over $I$.
\item If $T \subset R$, and if $(T)$ is the ideal generated by
$T$ in $R$, then $V((T)) = V(T)$.
\item If $I$ is an ideal and $\sqrt{I}$ is its radical,
see basic notion (\ref{item-radical-ideal}), then $V(I) = V(\sqrt{I})$.
\item Given an ideal $I$ of $R$ we have $\sqrt{I} =
\bigcap_{I \subset \mathfrak p} \mathfrak p$.
\item If $I$ is an ideal then $V(I) = \emptyset$ if and only
if $I$ is the unit ideal.
\item If $I$, $J$ are ideals of $R$ then $V(I) \cup V(J) =
V(I \cap J)$.
\item If $(I_a)_{a\in A}$ is a set of ideals of $R$ then
$\cap_{a\in A} V(I_a) = V(\cup_{a\in A} I_a)$.
\item If $f \in R$, then $D(f) \coprod V(f) = \text{Spec}(R)$.
\item If $f \in R$ then $D(f) = \emptyset$ if and only if $f$
is nilpotent.
\item If $f = u f'$ for some unit $u \in R$, then $D(f) = D(f')$.
\item If $I \subset R$ is an ideal, and $\mathfrak p$ is a prime of
$R$ with $\mathfrak p \not\in V(I)$, then there exists an $f \in R$
such that $\mathfrak p \in D(f)$, and $D(f) \cap V(I) = \emptyset$.
\item If $f, g \in R$, then $D(fg) = D(f) \cap D(g)$.
\item If $f_i \in R$ for $i \in I$, then
$\bigcup_{i\in I} D(f_i)$ is the complement of $V(\{f_i \}_{i\in I})$
in $\text{Spec}(R)$.
\item If $f \in R$ and $D(f) = \text{Spec}(R)$, then $f$ is a unit.
\end{enumerate}
\end{lemma}

\begin{proof}
\
\begin{enumerate}
\item This is a direct consequence of (2) and (3).
\item Let $\mathfrak{A}$ be the set of all proper ideals of $R$. This set is
ordered by inclusion and is non-empty, since $(0) \in \mathfrak{A}$ is a proper
ideal. Let $A$ be a totally ordered subset of $R$. $\bigcup_{I \in A} I$ is in
fact an ideal. Since 1 $\notin I$ for all $I \in A$, the union does not contain
1 and thus is proper. Hence $\bigcup_{I \in A} I$ is in $\mathfrak{A}$ and is
an upper bound for the set $A$. Thus by Zorn's lemma $\mathfrak{A}$ has a
maximal element, which is the sought-after maximal ideal.
\item Since $R$ is nonzero, it contains a maximal ideal which is a prime ideal.
Thus the set $\mathfrak{A}$ of all prime ideals of $R$ is nonempty.
$\mathfrak{A}$ is ordered by reverse-inclusion. Let $A$ be a totally ordered
subset of $\mathfrak{A}$. It's pretty clear that $J = \bigcap_{I \in A} I$ is
in fact an ideal. Not so clear, however, is that it is prime. Let $xy \in J$.
Then $xy \in I$ for all $I \in A$. Now let $B = \{I \in A | y \in I\}$. Let $K
= \bigcap_{I \in B} I$. Since $A$ is totally ordered, either $K = J$ (and we're
done, since then $y \in J$) or $K \supset J$ and for all $I \in A$ such that
$I$ is properly contained in $K$, we have $y \notin I$. But that means that for
all those $I, x \in I$, since they are prime. Hence $x \in J$. In either case,
$J$ is prime as desired. Hence by Zorn's lemma we get a maximal element which
in this case is a minimal prime ideal.
\item This is the same exact argument as (3) except you only consider prime
ideals contained in $\mathfrak{p}$ and containing $I$.
\item $(T)$ is the smallest ideal containing $T$. Hence if $T \subset I$, some
ideal, then $(T) \subset I$ as well. Hence if $I \in V(T)$, then $I \in V((T))$
as well. The other inclusion is obvious.
\item Since $I \subset \sqrt{I}, V(\sqrt{I}) \subset V(I)$. Now let
$\mathfrak{p} \in V(I)$. Let $x \in \sqrt{I}$. Then $x^n \in I$ for some $n$.
Hence $x^n \in \mathfrak{p}$. But since $\mathfrak{p}$ is prime, a boring
induction argument gets you that $x \in \mathfrak{p}$. Hence $\sqrt{I} \subset
\mathfrak{p}$ and $\mathfrak{p} \in V(\sqrt{I})$.
\item Let $f \in R \setminus \sqrt{I}$. Then $f^n \notin I$ for all $n$. Hence
$S = \{1, f, f^2, \ldots\}$ is a multiplicative subset, not containing $0$.
Take a
prime ideal $\bar{\mathfrak{p}} \subset S^{-1}R$ containing $S^{-1}I$. Then the
pull-back $\mathfrak{p}$ in $R$ of $\bar{\mathfrak{p}}$ is a prime ideal
containing $I$ that does not intersect $S$. This shows that $\bigcap_{I \subset
\mathfrak p} \mathfrak p \subset \sqrt{I}$. Now if $a \in \sqrt{I}$, then $a^n
\in I$ for some $n$. Hence if $I \subset \mathfrak{p}$, then $a^n \in
\mathfrak{p}$. But since $\mathfrak{p}$ is prime, we have $a \in \mathfrak{p}$.
Thus the equality is shown.
\item $I$ is not the unit ideal iff $I$ is contained in some maximal ideal (to
see this, apply (2) to the ring $R/I$) which is therefore prime.
\item If $\mathfrak{p} \in V(I) \cup V(J)$, then $I \subset \mathfrak{p}$ or $J
\subset \mathfrak{p}$ which means that $I \cap J \subset \mathfrak{p}$. Now if
$I \cap J \subset \mathfrak{p}$, then $IJ \subset \mathfrak{p}$ and hence
either $I$ of $J$ is in $\mathfrak{p}$, since $\mathfrak{p}$ is prime.
\item $\mathfrak{p} \in \bigcap_{a \in A} V(I_a) \Leftrightarrow I_a \subset
\mathfrak{p}, \forall a \in A \Leftrightarrow \mathfrak{p} \in V(\cup_{a\in A}
I_a)$
\item If $\mathfrak{p}$ is a prime ideal and $f \in R$, then either $f \in
\mathfrak{p}$ or $f \notin \mathfrak{p}$ (strictly) which is what the disjoint
union says.
\item If $a \in R$ is nilpotent, then $a^n = 0$ for some $n$. Hence $a^n \in
\mathfrak{p}$ for any prime ideal. Thus $a \in \mathfrak{p}$ as can be shown by
induction and $D(f) = \emptyset$. Now, as shown in (7), if $a \in R$ is not
nilpotent, then there is a prime ideal that does not contain it.
\item $f \in \mathfrak{p} \Leftrightarrow uf \in \mathfrak{p}$, since $u$ is
invertible.
\item If $\mathfrak{p} \notin V(I)$, then $\exists f \in I \setminus
\mathfrak{p}$. Then $f \notin \mathfrak{p}$ so $\mathfrak{p} \in D(f)$. Also if
$\mathfrak{q} \in D(f)$, then $f \notin \mathfrak{q}$ and thus $I$ is not
contained in $\mathfrak{q}$. Thus $D(f) \cap V(I) = \emptyset$.
\item If $fg \in \mathfrak{p}$, then $f \in \mathfrak{p}$ or $g \in
\mathfrak{p}$. Hence if $f \notin \mathfrak{p}$ and $g \notin \mathfrak{p}$,
then $fg \notin \mathfrak{p}$. Since $\mathfrak{p}$ is an ideal, if $fg \notin
\mathfrak{p}$, then $f \notin \mathfrak{p}$ and $g \notin \mathfrak{p}$.
\item $\mathfrak{p} \in \bigcup_{i \in I} D(f_i) \Leftrightarrow \exists i \in
I, f_i \notin \mathfrak{p} \Leftrightarrow \mathfrak{p} \in \mathrm{spec}(R)
\setminus V(\{f_i\}_{i \in I})$
\item If $D(f) = \text{Spec}(R)$, then $V(f) = \emptyset$ and
hence $fR = R$, so $f$ is a unit.
\end{enumerate}
\end{proof}

\noindent
The lemma implies that the subsets $V(T)$ from
Definition \ref{definition-spectrum-ring} form the closed
subsets of a topology on $\text{Spec}(R)$. And it also shows that
the sets $D(f)$ are open and form a basis for this
topology.

\begin{definition}
\label{definition-Zariski-topology}
Let $R$ be a ring.
The topology on $\text{Spec}(R)$ whose closed sets are the
sets $V(T)$ is called the {\it Zariski} topology. The open
subsets $D(f)$ are called the {\it standard opens} of $\text{Spec}(R)$.
\end{definition}

\noindent
It should be clear from context whether we consider $\text{Spec}(R)$
just as a set or as a topological space.

\begin{lemma}
\label{lemma-spec-functorial}
Suppose that $\varphi : R \to R'$ is a ring homomorphism.
The induced map
$$
\text{Spec}(\varphi) :
\text{Spec}(R')
\longrightarrow
\text{Spec}(R), \ \ 
\mathfrak p'
\longmapsto
\varphi^{-1}(\mathfrak p')
$$
is continuous for the Zariski topologies. In fact, for any
element $f \in R$ we have
$\text{Spec}(\varphi)^{-1}(D(f)) = D(\varphi(f))$.
\end{lemma}

\begin{proof}
It is basic notion (\ref{item-inverse-image-prime}) that
$\mathfrak p := \varphi^{-1}(\mathfrak p')$
is indeed a prime ideal of $R$. The last assertion
of the lemma follows directly from the definitions,
and implies the first.
\end{proof}

\noindent
If $\varphi' : R' \to R''$ is a second ring homomorphism
then the composition
$$
\text{Spec}(R')
\longrightarrow
\text{Spec}(R')
\longrightarrow
\text{Spec}(R'')
$$
equals $\text{Spec}(\varphi' \circ \varphi)$. In other
words, $\text{Spec}$ is a contravariant functor from the
category of rings to the category of topological spaces.

\begin{lemma}
\label{lemma-spec-localization}
Let $R$ be a ring. Let $S \subset R$ be a multiplicative subset.
The map $R \to S^{-1}R$ induces via the functoriality of $\text{Spec}$
a homeomorphism
$$
\text{Spec}(S^{-1}R)
\longrightarrow
\{\mathfrak p \in \text{Spec}(R) \mid S \cap \mathfrak p = \emptyset \}
$$
where the topology on the right hand side is that induced from the
Zariski topology on $\text{Spec}(R)$. The inverse map is given
by $\mathfrak p \mapsto S^{-1}\mathfrak p$.
\end{lemma}

\begin{proof}
Denote the right hand side of the arrow of the lemma by $D$.
Choose a prime $\mathfrak p' \subset S^{-1}R$ and let $\mathfrak p$
the inverse image of $\mathfrak p'$ in $R$. Since $\mathfrak p'$
does not contain $1$ we see that $\mathfrak p$ does not contain
any element of $S$. Hence $\mathfrak p \in D$ and we see that
the image is contained in $D$. Let $\mathfrak p \in D$.
By assumption the image $\overline{S}$ does not contain $0$.
By basic notion (\ref{item-localization-zero})
$\overline{S}^{-1}(R/\mathfrak p)$ is not the zero ring.
By basic notion (\ref{item-localize-ideal}) we see
$S^{-1}R / S^{-1}\mathfrak p = \overline{S}^{-1}(R/\mathfrak p)$
is a domain, and hence $S^{-1}\mathfrak p$ is a prime.
The equality of rings also shows that the inverse image of
$S^{-1}\mathfrak p$ in $R$ is equal to $\mathfrak p$,
because $R/\mathfrak p \to \overline{S}^{-1}(R/\mathfrak p)$
is injective by basic notion (\ref{item-localize-nonzerodivisors}).
This proves that the map $\text{Spec}(S^{-1}R) \to \text{Spec}(R)$
is bijective onto $D$ with inverse as given.
It is continuous by Lemma \ref{lemma-spec-functorial}.
Finally, let $D(g) \subset \text{Spec}(S^{-1}R)$ be a standard
open. Write $g = h/s$ for some $h\in R$ and $s\in S$.
Since $g$ and $h/1$ differ by a unit we have $D(g) =
D(h/1)$ in $\text{Spec}(S^{-1}R)$.
Hence by Lemma \ref{lemma-spec-functorial} and the bijectivity
above the image of $D(g) = D(h/1)$ is $D \cap D(h)$.
This proves the map is open as well.
\end{proof}

\begin{lemma}
\label{lemma-standard-open}
Let $R$ be a ring. Let $f \in R$.
The map $R \to R_f$ induces via the functoriality of
$\text{Spec}$ a homeomorphism
$$
\text{Spec}(R_f) \longrightarrow D(f) \subset \text{Spec}(R).
$$
The inverse is given by $\mathfrak p \mapsto \mathfrak p \cdot R_f$.
\end{lemma}

\begin{proof}
This is a special case of Lemma \ref{lemma-spec-localization}
above.
\end{proof}

\noindent
It is not the case that every ``affine open'' of a
spectrum is a standard open. See
Example \ref{example-affine-open-not-standard}.

\begin{lemma}
\label{lemma-spec-closed}
Let $R$ be a ring. Let $I \subset R$ be an ideal.
The map $R \to R/I$ induces via the functoriality of
$\text{Spec}$ a homeorphism
$$
\text{Spec}(R/I) \longrightarrow V(I) \subset \text{Spec}(R).
$$
The inverse is given by $\mathfrak p \mapsto \mathfrak p / I$.
\end{lemma}

\begin{proof}
It is immediate that the image is contained in $V(I)$.
On the other hand, if $\mathfrak p \in V(I)$
then $\mathfrak p \supset I$ and we may consider
the ideal $\mathfrak p /I \subset R/I$. Using
basic notion (\ref{item-isomorphism-theorem}) we see that
$(R/I)/(\mathfrak p/I) = R/\mathfrak p$ is a domain
and hence $\mathfrak p/I$ is a prime ideal. From this
it is immediately clear that the image of $D(f + I)$
is $D(f) \cap V(I)$, and hence the map is a homeomorphism.
\end{proof}



\begin{remark}
\label{remark-fundamental-diagram}
A fundamental commutative diagram associated to
$\varphi : R \to S$,
$\mathfrak q \subset S$ and
$\mathfrak p = \varphi^{-1}(\mathfrak q)$ is
the following
$$
\xymatrix{
\kappa(\mathfrak q) = S_{\mathfrak q}/{\mathfrak q}S_{\mathfrak q}
&
S_{\mathfrak q} \ar[l]
&
S \ar[r] \ar[l]
&
S/\mathfrak q \ar[r]
&
\kappa(\mathfrak q) = \text{f.f.}(S/\mathfrak q)
\\
\kappa(\mathfrak p) \otimes_R S =
S_{\mathfrak p}/{\mathfrak p}S_{\mathfrak p} \ar[u]
&
S_{\mathfrak p} \ar[u] \ar[l]
&
S \ar[u] \ar[r] \ar[l]
&
S/\mathfrak pS \ar[u] \ar[r]
&
(R \setminus \mathfrak p)^{-1}S/\mathfrak pS \ar[u]
\\
\kappa(\mathfrak p) =
R_{\mathfrak p}/{\mathfrak p}R_{\mathfrak p} \ar[u]
&
R_{\mathfrak p} \ar[u] \ar[l]
&
R \ar[u] \ar[r] \ar[l]
&
R/\mathfrak p \ar[u] \ar[r]
&
\kappa(\mathfrak p) = \text{f.f.}(R/\mathfrak p) \ar[u]
}
$$
In this diagram the arrows on the outer left and outer right columns
are identical. The horizontal maps induce on the associated spectrums
always a homeomorphism onto the image. The lower two rows
of the diagram make sense without assuming $\mathfrak q$ exists.
The lower squares induce fibre squares of topological spaces.
This diagram shows that $\mathfrak p$ is in the image
of the map on Spec if and only if $S \otimes_R \kappa(\mathfrak p)$
is not the zero ring.
\end{remark}

\begin{lemma}
\label{lemma-in-image}
Let $\varphi : R \to S$ be a ring map. Let $\mathfrak p$
be a prime of $R$. The following are equivalent
\begin{enumerate}
\item $\mathfrak p$ is in the image of
$\text{Spec}(S) \to \text{Spec}(R)$,
\item $S \otimes_R \kappa(\mathfrak p) \not= 0$,
\item $S_{\mathfrak p}/\mathfrak p S_{\mathfrak p} \not = 0$,
\item $(S/\mathfrak pS)_{\mathfrak p} \not = 0$, and
\item $\mathfrak p = \varphi^{-1}(\mathfrak pS)$.
\end{enumerate}
\end{lemma}

\begin{proof}
We have already seen the equivalence of the first two
in Remark \ref{remark-fundamental-diagram}. The others
are just reformulations of this.
\end{proof}

\begin{lemma}
\label{lemma-quasicompact}
Let $R$ be a ring. The space $\text{Spec}(R)$ is quasicompact.
\end{lemma}

\begin{proof}
It suffices to prove that any covering of $\text{Spec}(R)$
by standard opens can be refined by a finite covering.
Thus suppose that $\text{Spec}(R) = \cup D(f_i)$
for a set of elements $\{f_i\}_{i\in I}$ of $R$. This means that
$\cap V(f_i) = \emptyset$. According to Lemma
\ref{lemma-Zariski-topology} this means that
$V(\{f_i \}) = \emptyset$. According to the
same lemma this means that the ideal generated
by the $f_i$ is the unit ideal of $R$. This means
that we can write $1$ as a {\it finite} sum:
$1 = \sum_{i \in J} r_i f_i$ with $J \subset I$ finite.
And then it follows that $\text{Spec}(R)
= \cup_{i \in J} D(f_i)$.
\end{proof}

\begin{lemma}
\label{lemma-topology-spec}
Let $R$ be a ring.
The topology on $X = \text{Spec}(R)$ has the following properties:
\begin{enumerate}
\item $X$ is quasi-compact,
\item $X$ has a basis for the topology consisting of quasi-compact opens, and
\item the intersection of any two quasi-compact opens is quasi-compact.
\end{enumerate}
\end{lemma}

\begin{proof}
The spectrum of a ring is quasi-compact, see
Lemma \ref{lemma-quasicompact}.
It has a basis for the topology consisting of the standard opens
$D(f) = \text{Spec}(R_f)$
(Lemma \ref{lemma-standard-open})
which are quasi-compact by the first remark.
The intersection of two standard opens is quasi-compact
as $D(f) \cap D(g) = D(fg)$. Given any two quasi-compact opens
$U, V \subset X$ we may write $U = D(f_1) \cup \ldots \cup D(f_n)$
and $V = D(g_1) \cup \ldots \cup D(g_m)$. Then
$U \cap V = \bigcup D(f_ig_j)$ which is quasi-compact.
\end{proof}

\begin{lemma}
\label{lemma-characterize-local-ring}
Let $R$ be a ring. The following are equivalent:
\begin{enumerate}
\item $R$ is a local ring,
\item $\text{Spec}(R)$ has exactly one closed point,
\item $R$ has a maximal ideal $\mathfrak m$
and every element of $R \setminus \mathfrak m$
is a unit, and
\item every $x \in R$ is either invertible or $1 - x$ is invertible.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $R$ be a ring, and $\mathfrak m$ a maximal ideal.
If $x \in R \setminus \mathfrak m$, and $x$ is not a unit
then there is a maximal ideal $\mathfrak m'$ containing $x$.
Hence $R$ has at least two maximal ideals. Conversely,
if $\mathfrak m'$ is another maximal ideal, then choose
$x \in \mathfrak m'$, $x \not \in \mathfrak m$. Clearly
$x$ is not a unit. This proves the equivalence of (1) and (3).
The equivalence (1) and (2) is tautological.
If $R$ is local then (4) holds since $x$ is either in $\mathfrak m$
or not. If (4) holds, and $\mathfrak m'$ is another maximal ideal
then choose $x \in $ such that
$x \bmod \mathfrak m' = 0$ and $x \bmod \mathfrak m = 1$
by the Chinese remainder theorem
Lemma \ref{lemma-chinese-remainder}.
This $x$ is not invertible and neither is $1 - x$ which is
a contradiction. Thus (4) and (1) are equivalent.
\end{proof}



\section{Open and closed subsets of spectra}
\label{section-open-and-closed}

\noindent
It turns out that open and closed subsets of a spectrum correspond to
idempotents of the ring.

\begin{lemma}
\label{lemma-idempotent-spec}
Let $R$ be a ring. Let $e \in R$ be an idempotent.
In this case
$$
\text{Spec}(R) = D(e) \coprod D(1-e).
$$
\end{lemma}

\begin{proof}
Note that an idempotent $e$ of a domain is either $1$ or $0$.
Hence we see that
\begin{eqnarray*}
D(e)
& = &
\{ \mathfrak p \in \text{Spec}(R)
\mid
e \not\in \mathfrak p \} \\
& = &
\{ \mathfrak p \in \text{Spec}(R)
\mid
e \not= 0\text{ in }\kappa(\mathfrak p) \} \\
& = &
\{ \mathfrak p \in \text{Spec}(R)
\mid
e = 1\text{ in }\kappa(\mathfrak p) \}
\end{eqnarray*}
Similarly we have
\begin{eqnarray*}
D(1-e)
& = &
\{ \mathfrak p \in \text{Spec}(R)
\mid
1 - e \not\in \mathfrak p \} \\
& = &
\{ \mathfrak p \in \text{Spec}(R)
\mid
e \not= 1\text{ in }\kappa(\mathfrak p) \} \\
& = &
\{ \mathfrak p \in \text{Spec}(R)
\mid
e = 0\text{ in }\kappa(\mathfrak p) \}
\end{eqnarray*}
Since the image of $e$ in any residue field is either $1$ or $0$
we deduce that $D(e)$ and $D(1-e)$ cover all of $\text{Spec}(R)$.
\end{proof}

\begin{lemma}
\label{lemma-spec-product}
Let $R_1$ and $R_2$ be rings.
Let $R = R_1 \times R_2$.
The maps $R \to R_1$, $(x, y) \mapsto x$ and $R \to R_2$,
$(x, y) \mapsto y$
induce continuous maps $\text{Spec}(R_1) \to \text{Spec}(R)$ and
$\text{Spec}(R_2) \to \text{Spec}(R)$.
The induced map
$$
\text{Spec}(R_1) \coprod \text{Spec}(R_2)
\longrightarrow
\text{Spec}(R)
$$
is a homeomorphism. In other words,
the spectrum of $R = R_1\times R_2$ is the
disjoint union of the spectrum of $R_1$ and the
spectrum of $R_2$.
\end{lemma}

\begin{proof}
Write $1 = e_1 + e_2$ with $e_1 = (1, 0)$ and $e_2 = (0, 1)$.
Note that $e_1$ and $e_2 = 1 - e_1$ are idempotents.
We leave it to the reader to show that
$R_1 = R_{e_1}$ is the localization of $R$ at $e_1$.
Similarly for $e_2$.
Thus the statement of the lemma follows from Lemma
\ref{lemma-idempotent-spec} combined with Lemma
\ref{lemma-standard-open}.
\end{proof}

\noindent
We reprove the following lemma later after introducing
a glueing lemma for functions. See Section
\ref{section-tilde-module-sheaf}.

\begin{lemma}
\label{lemma-disjoint-decomposition}
Let $R$ be a ring. For each $U \subset \text{Spec}(R)$
which is open and closed
there exists a unique idempotent $e \in R$ such that
$U = D(e)$. This induces a 1-1 correspondence between
open and closed subsets $U \subset \text{Spec}(R)$ and
idempotents $e \in R$.
\end{lemma}

\begin{proof}[First proof of Lemma \ref{lemma-disjoint-decomposition}]
Let $U \subset \text{Spec}(R)$ be open and closed.
Since $U$ is closed it is quasi-compact by
Lemma \ref{lemma-quasicompact}, and similarly for
its complement.
Write $U = \bigcup_{i = 1}^n D(f_i)$ as a finite union of standard opens.
Similarly, write $\text{Spec}(R) \setminus U = \bigcup_{j = 1}^m D(g_j)$
as a finite union of standard opens. Since $\emptyset =
D(f_i) \cap D(g_j) = D(f_i g_j)$ we see that $f_i g_j$ is
nilpotent by Lemma \ref{lemma-Zariski-topology}.
Let $I = (f_1, \ldots, f_n) \subset R$ and let
$J = (g_1, \ldots, g_m) \subset R$.
Note that $V(J)$ equals $U$, that $V(I)$
equals the complement of $U$, so $\text{Spec}(R) = V(I) \coprod V(J)$.
By the remark on nilpotency above,
we see that $(IJ)^N = (0)$ for some sufficiently large integer $N$.
Since $\bigcup D(f_i) \cup \bigcup D(g_j) = \text{Spec}(R)$
we see that $I + J = R$, see Lemma \ref{lemma-Zariski-topology}.
By raising this equation to the $2N$th power we conclude that
$I^N + J^N = R$. Write $1 = x + y$ with $x \in I^N$ and $y \in J^N$.
Then $1 = (x + y)^2 = x^2 + y^2$ because $I^N J^N = (0)$.
Then $z = x - x^2 \in I^N \cap J^N$. Thus $zx = 0$ and $z^2 = 0$.
Hence $(x - z) - (x - z)^2 = x - x^2 - z = 0$.
In other words, $e = x - z$ is an idempotent contained in
$I^N \subset I$, and the idempotent $e' = 1 - e = y + z$
is contained in $J^N \subset J$. This shows that the
idempotent $e$ maps to $1$ in every residue field
$\kappa(\mathfrak p)$ for $\mathfrak p \in V(J)$ and
that $e$ maps to $0$ in $\kappa(\mathfrak p)$
for every $\mathfrak p \in V(I)$.

\medskip\noindent
To see uniqueness suppose that $e_1, e_2$ are
distinct idempotents in $R$. We have to show there
exists a prime $\mathfrak p$ such that $e_1 \in \mathfrak p$
and $e_2 \not \in \mathfrak p$, or conversely.
Write $e_i' = 1 - e_i$. If $e_1 \not = e_2$, then
$0 \not = e_1 - e_2  = e_1(e_2 + e_2') - (e_1 + e_1')e_2
= e_1 e_2' - e_1' e_2$. Hence either the idempotent
$e_1 e_2' \not = 0$ or $e_1' e_2 \not = 0$. An idempotent
is not nilpotent, and hence we find a prime
$\mathfrak p$ such that either $e_1e_2' \not \in \mathfrak p$
or $e_1'e_2 \not \in \mathfrak p$, by Lemma \ref{lemma-Zariski-topology}.
It is easy to see this gives the desired prime.
\end{proof}

\begin{lemma}
\label{lemma-characterize-spec-connected}
Let $R$ be a ring. Then $\text{Spec}(R)$ is
connected if and only if $R$ has no nontrivial
idempotents.
\end{lemma}

\begin{proof}
Obvious from Lemma \ref{lemma-disjoint-decomposition} above.
\end{proof}


\begin{lemma}
\label{lemma-ideal-is-squared-union-connected}
Let $R$ be a ring.
Let $I$ be a finitely generated ideal.
Assume that $I = I^2$.
Then $V(I)$ is open and closed in $\text{Spec}(R)$,
and $R/I \cong R_e$ for some idempotent $e \in R$.
\end{lemma}

\begin{proof}
By Nakayama's Lemma \ref{lemma-NAK} there exists an element
$f = 1 + i$, $i \in I$ in $R$ such that $fI = 0$.
It follows that $V(I) = D(f)$ by a simple argument.
Also, $0 = fi = i + i^2$, and hence
$f^2 = 1 + i + i + i^2 = 1 + i = f$, so $f$ is an idempotent.
Consider the canonical map $R \to R_f$. It is surjective
since $x/f^n = x/f = xf/f^2 = xf/f = x/1$ in $R_f$.
Any element of $I$ is in the kernel since $fI = 0$.
If $x \mapsto 0$ in $R_f$, then $f^nx = 0$ for some $n > 0$
and hence $(1 + i)x = 0$ hence $x \in I$.
\end{proof}






\section{Connected components of spectra}
\label{section-connected-components}

\noindent
Connected components of spectra are not as easy to understand as one
may think at first. This is because we are used to the topology of
locally connected spaces, but the spectrum of a ring is in general
not locally connected.

\begin{lemma}
\label{lemma-closed-union-connected-components}
Let $R$ be a ring. Let $T \subset \text{Spec}(R)$ be a subset of the spetrum.
The following are equivalent
\begin{enumerate}
\item $T$ is closed and is a union of connected components of
$\text{Spec}(R)$,
\item $T$ is an intersection of open and closed subsets of
$\text{Spec}(R)$, and
\item $T = V(I)$ where $I \subset R$ is an ideal generated by idempotents.
\end{enumerate}
Moreover, the ideal in (3) if it exists is unique.
\end{lemma}

\begin{proof}
By
Lemma \ref{lemma-topology-spec}
and
Topology, Lemma \ref{lemma-closed-union-connected-components}
we see that (1) and (2) are equivalent.
Assume (2) and write $T = \bigcap U_\alpha$ with
$U_\alpha \subset \text{Spec}(R)$ open and closed.
Then $U_\alpha = D(e_\alpha)$ for some idempotent $e_\alpha \in A$ by
Lemma \ref{lemma-disjoint-decomposition}.
Then setting $I = (1 - e_\alpha)$ we see that $T = V(I)$, i.e., (3) holds.
Finally, assume (3). Write $T = V(I)$ and $I = (e_\alpha)$ for some
collection of idempotents $e_\alpha$. Then it is clear that
$T = \bigcap V(e_\alpha) = \bigcap D(1 - e_\alpha)$.

\medskip\noindent
Suppose that $I$ is an ideal generated by idempotents.
Let $e \in R$ be an idempotent such that $V(I) \subset V(e)$. Then by
Lemma \ref{lemma-Zariski-topology}
we see that $e^n \in I$ for some $n \geq 1$. As $e$ is an idempotent
this means that $e \in I$. Hence we see that $I$ is generated by
exactly those idempotents $e$ such that $T \subset V(e)$.
In other words, the ideal $I$ is completely determined by the
closed subset $T$ which proves uniqueness.
\end{proof}

\begin{lemma}
\label{lemma-connected-component}
Let $R$ be a ring.
A connected component of
$\text{Spec}(R)$ is of the form $V(I)$,
where $I$ is an ideal generated by idempotents
such that every idempotent of $R$ either maps to
$0$ or $1$ in $R/I$.
\end{lemma}

\begin{proof}
Let $\mathfrak p$ be a prime of $R$. By
Lemma \ref{lemma-topology-spec}
we have see that the hypotheses of
Topology, Lemma \ref{topology-lemma-connected-component-intersection}
are satisfied for the topological space $\text{Spec}(R)$.
Hence the connected component of $\mathfrak p$ in $\text{Spec}(R)$
is the intersection of open and closed subsets of $\text{Spec}(R)$
containing $\mathfrak p$. Hence it equals $V(I)$ where
$I$ is generated by the idempotents $e \in R$ such that $e$ maps to $0$
in $\kappa(\mathfrak p)$, see
Lemma \ref{lemma-disjoint-decomposition}.
Any idempotent $e$ which is not in this collection clearly maps to $1$
in $R/I$.
\end{proof}











\section{Glueing functions}
\label{section-tilde-module-sheaf}

\noindent
In this section we show that given an open covering
$$
\text{Spec}(R) = \bigcup\nolimits_{i = 1}^n D(f_i)
$$
by standard opens, and given an element $h_i \in R_{f_i}$
for each $i$ such that $h_i = h_j$ as elements of $R_{f_i f_j}$
then there exists a unique $h \in R$ such that the image of
$h$ in $R_{f_i}$ is $h_i$. This result can be interpreted
in two ways:
\begin{enumerate}
\item The rule $D(f) \mapsto R_f$ is a sheaf of rings
on the standard opens, see Sheaves, Section \ref{sheaves-section-bases}.
\item If we think of elements of $R_f$ as the ``algebraic''
or ``regular'' functions on $D(f)$, then these glue
as would continuous, resp.\ differentiable functions
on a topological, resp.\ differentiable manifold.
\end{enumerate}
At the end of this section we use this result to reprove the
lemma describing open and closed subsets in terms of
idempotents.

\begin{lemma}
\label{lemma-standard-covering}
Let $R$ be a ring, and let $f_1, f_2, \ldots f_n\in R$ generate
the unit ideal in $R$.
Then the following sequence is exact:
$$
0 \longrightarrow
R \longrightarrow
\bigoplus\nolimits_i R_{f_i} \longrightarrow
\bigoplus\nolimits_{i, j}R_{f_if_j}
$$
where the maps $\alpha : R \longrightarrow \bigoplus_i R_{f_i}$
and $\beta : \bigoplus_i R_{f_i} \longrightarrow \bigoplus_{i, j} R_{f_if_j}$
are defined as
$$
\alpha(x) = \left(\frac{x}{1}, \ldots, \frac{x}{1}\right)
\text{ and }
\beta\left(\frac{x_1}{f_1}, \ldots, \frac{x_n}{f_n}\right)
=
\left(\frac{x_i}{f_i}-\frac{x_j}{f_j}~\text{in}~R_{f_if_j}\right).
$$
\end{lemma}

\begin{proof}
We first show that $\alpha$ is injective,
and then that the image of $\alpha$ equals the kernel of $\beta$.
Assume there exists $x\in R$ such that $\alpha(x) = (0, \ldots, 0)$.
Then $\frac{x}{1} = 0$ in $R_{f_i}$ for all $i$.
This means, for all $i$, there exists a number $n_i$ such that
$$
f_i^{n_i}x = 0
$$
Since the $f_i$ generate $R$, we can pick $a_i$ so
$$
1 = \sum\nolimits_{i = 1}^n a_if_i
$$
Then for all $M\geq\sum n_i$, we have
$$
1^M = \left(\sum a_if_i\right)^M,
$$
where each term has a factor of at least $f_i^{n_i}$ for some $i$.
Therefore,
$$
x = 1x = 1^Mx = \left(\sum a_if_i\right)^Mx = 0.
$$
Thus, if $\alpha(x) = 0$, $x = 0$ and $\alpha$ is injective.
We check that the image of $\alpha$ equals the kernel of $\beta$.
First, note that for $x\in R$,
$$
\beta(\alpha(x)) =
\beta\left(\frac{x}{1}, \ldots, \frac{x}{1}\right) =
(\frac{x}{1}-\frac{x}{1}~in~R_{f_if_j}) = 0.
$$
Therefore, the image of $\alpha$ is in the kernel of $\beta$,
and it remains only to verify that if
$$
\beta\left(\frac{x_1}{f_1}, \ldots, \frac{x_n}{f_n}\right) = 0,
$$
then there exists $x\in R$ so that for all $i$,
$$
\frac{x}{1} = \frac{x_i}{f_i}
$$
Assume we have $x_1, \ldots, x_n$ such that
$$
\beta\left(\frac{x_1}{f_1}, \ldots, \frac{x_n}{f_n}\right) = 0.
$$
Then, for all pairs $i, j$, there exists an $n_{ij}$ such that
$$
f_i^{n_{ij}}f_j^{n_{ij}}(f_jx_i-f_ix_j) = 0
$$
Choosing $N$ so $N\geq n_{ij}$ for all $i, j$, we see that
$$
f_i^Nf_j^N(f_jx_i - f_ix_j) = 0
$$
Define elements $\widetilde{x_i}$ and $\widetilde{f_i}$ as follows:
$$
\widetilde{f_i} = f_i^{N + 1}, \qquad \widetilde{x_i} = f_i^N x_i.
$$
Notice that
$$
\frac{\widetilde{x_i}}{\widetilde{f_i}} = \frac{x_i}{f_i}.
$$
Also, we can use this to rewrite the above equation to get
the following equality, for all $i, j$,
$$
\widetilde{f_j}\widetilde{x_i} = \widetilde{f_i}\widetilde{x_j}.
$$
Since $f_1, \ldots, f_n$ generate $R$, we clearly have that
$\widetilde{f_1}, \ldots, \widetilde{f_n}$ also generate $R$.
Therefore, there exist $a_1, \ldots, a_n$ in $R$ so that
$$
1 = \sum\nolimits_{i = 1}^n a_i\widetilde{f_i}
$$
Therefore, we finally conclude that for all $i$,
$$
\frac{x_i}{f_i} =
\frac{\widetilde{x_i}}{\widetilde{f_i}} =
\sum\nolimits_{j = 1}^n
\frac{a_j\widetilde{f_j}\widetilde{x_i}}{\widetilde{f_i}} =
\sum\nolimits_{j = 1}^n
\frac{a_j\widetilde{f_i}\widetilde{x_j}}{\widetilde{f_i}} =
\frac{\sum_{j = 1}^na_j\widetilde{x_j}}{1}.
$$
Thus, we have
$$
\alpha\left(\sum\nolimits_{j = 1}^na_j\widetilde{x_j}\right) =
\left(\frac{x_1}{f_1}, \ldots, \frac{x_n}{f_n}\right),
$$
as required.  There the sequence is exact.
\end{proof}

\begin{lemma}
\label{lemma-cover-module}
Let $R$ be a ring. Let $f_1, \ldots, f_n$ be elements of $R$
generating the unit ideal. Let $M$ be an $R$-module.
The sequence
$$
0 \to
M \xrightarrow{\alpha}
\bigoplus\nolimits_{i = 1}^n M_{f_i} \xrightarrow{\beta}
\bigoplus\nolimits_{i, j = 1}^n M_{f_i f_j}
$$
is exact, where $\alpha(m) = (m/1, \ldots, m/1)$
and $\beta(m_1/f_1^{e_1}, \ldots, m_n/f_n^{e_n})
= (m_i/f_i^{e_i} - m_j/f_j^{e_j})_{(i, j)}$.
\end{lemma}

\begin{proof}
The same as the proof of Lemma \ref{lemma-standard-covering}.
\end{proof}

\begin{proof}[Second proof of Lemma \ref{lemma-disjoint-decomposition}]
Having assured ourselves (Lemma \ref{lemma-standard-covering})
that for generators ${f_1, \ldots, f_n}$ for the unit
ideal of a ring $R$ the sequence
$$
0 \to R
\to \bigoplus\nolimits_{i = 1}^ {n} R_{f_{i}}
\to \bigoplus\nolimits_{i, j} R_{f_{i}f_{j}}
$$
is exact, we now provide an alternate proof of the surjectivity of
the map from idempotents $e$ of $R$ to open and closed subsets of
$\text{Spec}(R)$
presented in Lemma \ref{lemma-disjoint-decomposition}.
Let $U \subset \text{Spec}(R)$ be open and closed, and $W$ be its
complement. We can
write $U$ and $V$ as unions of standard opens such that
$U = \bigcup_{i = 1}^{n}  D(f_i)$ and
$W = \bigcup_{j = 1}^{m} D(g_j)$.  Since
$\text{Spec}(R) = \bigcup D(f_i) \cup \bigcup D(g_j)$,
we observe that the collection $\{ f_i;g_j\}$ must
generate the unit ideal in $R$ by Lemma \ref{lemma-Zariski-topology}.
So the following sequence is exact.
\begin{equation}
\label{equation-idempotent-exact-sequence}
0 \to R \stackrel{\alpha}{\to}
\bigoplus\nolimits_{i = 1}^ {n} R_{f_{i}}
\oplus \bigoplus\nolimits_{j = 1}^{m} R_{g_j}
\to
\bigoplus\nolimits_{i_1, i_2} R_{f_{i_1}f_{i_2}}
\oplus \bigoplus\nolimits_{i, j} R_{f_{i}g_{j}}
\oplus \bigoplus\nolimits_{j_1, j_2} R_{g_{j_1}g_{j_2}}
\end{equation}
However, notice that for any pair $i, j$,
$D(f_i) \cap D(g_j) = \emptyset$
since $D(f_i) \subset U$ and $D(g_j) \subset W)$. From part (15)
of Lemma \ref{lemma-Zariski-topology}
we recall that $D(f_i g_j) = D(f_i) \cap D(g_j) = \emptyset$. Therefore by
Lemma \ref{lemma-spec-localization}
$\text{Spec}(R_{f_i g_j}) = D(f_i g_j) = \emptyset$,
implying that $R_{f_i g_j}$ is the
zero ring for each pair $i, j$ by part (3) of
Lemma \ref{lemma-Zariski-topology}.
Consider the element
$(1, \ldots, 1, 0, \ldots, 0) \in \bigoplus_{i = 1}^ {n} R_{f_{i}}
\oplus \bigoplus_{j = 1}^{m} R_{g_j}$
whose coordinates are $1$ in each $R_{f_i}$ and
$0$ in each $R_{g_j}$. This is sent to $0$ under the map
$$
\beta : \bigoplus\nolimits_{i = 1}^ {n} R_{f_{i}} \oplus
\bigoplus\nolimits_{j = 1}^{m} R_{g_j}
\to \bigoplus\nolimits_{i_1, i_2} R_{f_{i_1}f_{i_2}} \oplus
\bigoplus\nolimits_{j_1, j_2}
R_{g_{j_1}g_{j_2}}
$$
so by the exactness of the
sequence (\ref{equation-idempotent-exact-sequence}), there must be some
element of $R$ whose image under $\alpha$ is $(1, \ldots, 1, 0, \ldots, 0)$.
Call it $e$. We see that
$\alpha(e^2) = \alpha(e)^2 = (1, \ldots, 1, 0, \ldots, 0) = \alpha(e)$.
Since $\alpha$ is
injective, $e = e^2$ in $R$ and $e$ is an idempotent of $R$. We claim that
$U = D(e)$.
Notice that for arbitrary $j$, the map $R \to R_{g_j}$ maps $e$
to $0$. Therefore there must be some positive integer $k_j$ such that
$g_j^{k_j}(e-0) = 0$ in $R$. Multiplying by $e$ as necessary,
we see that $(g_j e)^{k_j} = 0$,
so $g_j e$ is nilpotent in $R$. By
Lemma \ref{lemma-Zariski-topology}
$D(g_j) \cap D(e) = D(g_j e) = \emptyset$. So since
$V = \bigcup D(g_j)$, $D(e) \cap V = \emptyset$ and
$D(e) \subset U$. Furthermore, for arbitrary $i$, the
map $R \to R_{f_i}$ maps $e$ to $1$, so there must be some $l_i$ such
that $f_i^{l_i}(e-1) =0$ in $R$. Hence $f_i^{l_i}e = f_i^{l_i}$. Suppose
$\mathfrak{p} \in \text{Spec}(R)$ contains $e$,
then $\mathfrak{p}$ contains
$f_i^{l_i}e = f_i^{l_i}$, and since $\mathfrak{p}$ is prime, $f_i \in
\mathfrak{p}$. So $V(e) \subset V(f_i)$, implying that $D(f_i) \subset D(e)$.
Therefore $U = \bigcup D(f_i) \subset D(e)$, and $U = D(e)$.
Therefore any open
and closed subset of $\text{Spec}(R)$ is the standard open
of an idempotent as
desired.
\end{proof}

\noindent
The following we have already seen above, but we state it explicitly here
for convenience.

\begin{lemma}
\label{lemma-disjoint-implies-product}
Let $R$ be a ring.
If $\text{Spec}(R) = U \amalg V$ with both $U$ and $V$ open
then $R \cong R_1 \times R_2$ with $U \cong \text{Spec}(R_1)$
and $V \cong \text{Spec}(R_2)$ via the maps in Lemma \ref{lemma-spec-product}.
Moreover, both $R_1$ and $R_2$ are localizations as well as quotients
of the ring $R$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-disjoint-decomposition} we have
$U = D(e)$ and $V = D(1-e)$ for some idempotent $e$.
By Lemma \ref{lemma-standard-covering} we see that
$R \cong R_e \times R_{1 - e}$ (since clearly $R_{e(1-e)} = 0$
so the glueing condition is trivial; of course it is
trivial to prove the product decomposition directly in this
case). The lemma follows.
\end{proof}

\begin{lemma}
\label{lemma-when-injective-covering}
Let $R$ be a ring.
Let $f_1, \ldots, f_n \in R$.
Let $M$ be an $R$-module.
Then $M \to \bigoplus M_{f_i}$ is injective if and only if
$$
M \longrightarrow \bigoplus\nolimits_{i = 1, \ldots, n} M,\quad
m \longmapsto (f_1m, \ldots, f_nm)
$$
is injective.
\end{lemma}

\begin{proof}
The map $M \to \bigoplus M_{f_i}$ is injective if and only if
for all $m \in M$ and $e_1, \ldots, e_n \geq 1$ such that
$f_i^{e_i}m = 0$, $i = 1, \ldots, n$ we have $m = 0$.
This clearly implies the displayed map is injective.
Conversely, suppose the displayed map is injective and
$m \in M$ and $e_1, \ldots, e_n \geq 1$ are such that
$f_i^{e_i}m = 0$, $i = 1, \ldots, n$. If $e_i = 1$ for all $i$,
then we immediately conclude that $m = 0$ from the injectivity of
the displayed map. Next, we prove this holds for any such data
by induction on $e = \sum e_i$. The base case is $e = n$, and we have
just dealt with this. If some $e_i > 1$, then set $m' = f_im$.
By induction we see that $m' = 0$. Hence we see that $f_i m = 0$,
i.e., we may take $e_i = 1$ which decreases $e$ and we win.
\end{proof}
















\section{More glueing results}
\label{section-more-glueing}

\noindent
In this section we put a number of standard results of the
form: if something is true for all members of a standard open
covering then it is true.

\begin{lemma}
\label{lemma-cover}
Let $R$ be a ring. Let $M$ be an $R$-module. Let $S$ be an $R$-algebra.
Suppose that $f_1, \ldots, f_n$ is a finite list of
elements of $R$ such that $\bigcup D(f_i) = \text{Spec}(R)$
in other words $(f_1, \ldots, f_n) = R$.
\begin{enumerate}
\item If each $M_{f_i} = 0$ then $M = 0$.
\item If each $M_{f_i}$ is a finite $R_{f_i}$-module,
then $M$ is a finite $R$-module.
\item If each $M_{f_i}$ is a finitely presented $R_{f_i}$-module,
then $M$ is a finitely presented $R$-module.
\item Let $M \to N$ be a map of $R$-modules. If $M_{f_i} \to N_{f_i}$
is an isomorphism for each $i$ then $M \to N$ is an isomorphism.
\item Let $0 \to M'' \to M \to M' \to 0$ be a complex of $R$-module.
If $0 \to M''_{f_i} \to M_{f_i} \to M'_{f_i} \to 0$ is exact for each $i$,
then $0 \to M'' \to M \to M' \to 0$ is exact.
\item If each $R_{f_i}$ is Noetherian, then $R$ is Noetherian.
\item If each $S_{f_i}$ is a finite type $R$-algebra, so is $S$.
\item If each $S_{f_i}$ is of finite presentation over $R$, so is $S$.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-cover-upstairs}
Let $R \to S$ be a ring map.
Suppose that $g_1, \ldots, g_m$ is a finite list of
elements of $S$ such that $\bigcup D(g_j) = \text{Spec}(S)$
in other words $(g_1, \ldots, g_m) = S$.
\begin{enumerate}
\item If each $S_{g_i}$ is of finite type over $R$, then $S$ is
of finite type over $R$.
\item If each $S_{g_i}$ is of finite presentation over $R$,
then $S$ is of finite presentation over $R$.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\noindent
The following lemma is better stated and proved in the more general
context of flat descent. However, it makes sense to state it here
since it fits well with the above.

\begin{lemma}
\label{lemma-glue-modules}
Let $R$ be a ring. Let $f_1, \ldots, f_n \in R$ be elements
which generate the unit ideal in $R$. Suppose we are given
the following data:
\begin{enumerate}
\item For each $i$ an $R_{f_i}$-module $M_i$.
\item For each pair $i, j$ an $R_{f_if_j}$-module isomorphism
$\psi_{ij} : (M_i)_{f_j} \to (M_j)_{f_i}$.
\end{enumerate}
which satisfy the ``cocycle condition'' that all the diagrams
$$
\xymatrix{
(M_i)_{f_jf_k}
\ar[rd]_{\psi_{ij}}
\ar[rr]^{\psi_{ik}}
& &
(M_k)_{f_if_j} \\
&
(M_j)_{f_if_k} \ar[ru]_{\psi_{jk}}
}
$$
commute (for all triples $i, j, k$). Given this data define
$$
M = \text{Ker}\left(
\bigoplus\nolimits_{1 \leq i \leq n} M_i
\longrightarrow
\bigoplus\nolimits_{1 \leq i, j \leq n} (M_i)_{f_i}
\right)
$$
where $(m_1, \ldots, m_n)$ maps to the element whose
$(i, j)$th entry is $m_i/1 - \psi_{ji}(m_j/1)$.
Then the natural map $M \to M_i$ identifies
$M_i$ with $M_{f_i}$. Moreover $\psi_{ij}(m/1) = m/1$
for all $m \in M$ (with obvious notation).
\end{lemma}

\begin{proof}
Omitted.
\end{proof}












\section{Total rings of fractions}
\label{section-total-quotient-ring}

\noindent
We can apply the glueing results above to prove something about
total rings of fractions $Q(R)$. Namely,
Lemma \ref{lemma-total-ring-fractions-no-embedded-points} below.

\begin{lemma}
\label{lemma-total-ring-fractions}
Let $R$ be a ring.
Let $S \subset R$ be a multiplicative subset consisting of nonzero
divisors. Then $Q(R) \cong Q(S^{-1}R)$.
In particular $Q(R) \cong Q(Q(R))$.
\end{lemma}

\begin{proof}
If $x \in S^{-1}R$ is a nonzero divisor, and
$x = r/f$ for some $r \in R$, $f \in S$, then
$r$ is a nonzero divisor in $R$. Whence the lemma.
\end{proof}

\begin{lemma}
\label{lemma-total-ring-fractions-no-embedded-points}
Let $R$ be a ring.
Assume that $R$ has finitely many minimal primes
$\mathfrak q_1, \ldots, \mathfrak q_t$, and that
$\mathfrak q_1 \cup \ldots \cup \mathfrak q_t$ is the set
of zero divisors of $R$.
Then the total ring of fractions $Q(R)$
(Example \ref{example-localize-at-prime}) is equal to
$R_{\mathfrak q_1} \times \ldots \times R_{\mathfrak q_t}$.
\end{lemma}

\begin{proof}
There are natural maps $Q(R) \to R_{\mathfrak q_i}$ since
any nonzero divisor is contained in $R \setminus \mathfrak q_i$.
Hence a natural map
$Q(R) \to R_{\mathfrak q_1} \times \ldots \times R_{\mathfrak q_t}$.
For any nonminimal prime $\mathfrak p \subset R$ we see that
$\mathfrak p \not \subset \mathfrak q_1 \cup \ldots \cup \mathfrak q_t$
by Lemma \ref{lemma-silly}. Hence
$\text{Spec}(Q(R)) = \{\mathfrak q_1, \ldots, \mathfrak q_t\}$
(as subsets of $\text{Spec}(R)$, see Lemma \ref{lemma-spec-localization}).
Therefore $\text{Spec}(Q(R))$ is a finite discrete set and
it follows that $Q(R) = A_1 \times \ldots \times A_t$
with $\text{Spec}(A_i) = \{q_i\}$, see
Lemma \ref{lemma-disjoint-implies-product}.
Moreover $A_i$ is a local ring, which is a localization
of $R$. Hence $A_i \cong R_{\mathfrak q_i}$.
\end{proof}

















\section{Irreducible components of spectra}
\label{section-irreducible}

\noindent
We show that irreducible components of
the spectrum of a ring correspond to the
minimal primes in the ring.

\begin{lemma}
\label{lemma-irreducible}
Let $R$ be a ring.
\begin{enumerate}
\item For a prime $\mathfrak p \subset R$ the closure
of $\{\mathfrak p\}$ in the Zariski topology is $V(\mathfrak p)$.
In a formula $\overline{\{\mathfrak p\}} = V(\mathfrak p)$.
\item The irreducible closed subsets of $\text{Spec}(R)$ are
exactly the subsets $V(\mathfrak p)$, with $\mathfrak p \subset R$
a prime.
\item The irreducible components (see Topology,
Definition \ref{topology-definition-irreducible-components})
of $\text{Spec}(R)$ are  exactly the subsets $V(\mathfrak p)$,
with $\mathfrak p \subset R$ a minimal prime.
\end{enumerate}
\end{lemma}

\begin{proof}
Note that if $ \mathfrak p \in V(I)$, then
$I \subset \mathfrak p$. Hence,
clearly $\overline{\{\mathfrak p\}} = V(\mathfrak p)$.
In particular $V(\mathfrak p)$ is the closure of
a singleton and hence irreducible.
The second assertion implies the third.
To show the second, let
$V(I) \subset \text{Spec}(R)$ with $I$ a radical ideal.
If $I$ is not prime, then choose $a, b\in R$, $a, b\not \in I$
with $ab\in I$. In this case $V(I, a) \cup V(I, b) = V(I)$,
but neither $V(I, b) = V(I)$ nor $V(I, a) = V(I)$, by
Lemma \ref{lemma-Zariski-topology}. Hence $V(I)$ is not
irreducible.
\end{proof}

\noindent
In other words, this lemma shows that every irreducible closed
subset of $\text{Spec}(R)$ is of the form $V(\mathfrak p)$ for
some prime $\mathfrak p$. Since $V(\mathfrak p) = \overline{\{\mathfrak p\}}$
we see that each irreducible closed subset has a unique generic point,
see Topology, Definition \ref{topology-definition-generic-point}.
In particular, $\text{Spec}(R)$ is a sober topological space.

\begin{lemma}
\label{lemma-irreducible-components-containing-x}
Let $R$ be a ring. Let $\mathfrak p \subset R$ be a prime.
\begin{enumerate}
\item the set of irreducible closed subsets of $\text{Spec}(R)$
passing through $\mathfrak p$ is in one-to-one correspondence with
primes $\mathfrak q \subset R_{\mathfrak p}$.
\item The set of irreducible components of $\text{Spec}(R)$ passing through
$\mathfrak p$ is in one-to-one correspondence with minimal
primes $\mathfrak q \subset R_{\mathfrak p}$.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-minimal-prime-reduced-ring}
Let $\mathfrak p$ be a minimal prime of a ring $R$.
Every element of the maximal ideal of $R_{\mathfrak p}$
is nilpotent. If $R$ is reduced then $R_{\mathfrak p}$
is a field.
\end{lemma}

\begin{proof}
If some element $x$ of ${\mathfrak p}R_{\mathfrak p}$
is not nilpotent, then $D(x) \not = \emptyset$, see
Lemma \ref{lemma-Zariski-topology}. This contradicts
the minimality of $\mathfrak p$. If $R$ is reduced,
then ${\mathfrak p}R_{\mathfrak p} = 0$ and
hence it is a field.
\end{proof}

\begin{lemma}
\label{lemma-standard-open-containing-maximal-point}
Let $R$ be a ring.
Let $\mathfrak p$ be a minimal prime of $R$.
Let $W \subset \text{Spec}(R)$ be a quasi-compact open
not containing the point $\mathfrak p$. Then there
exists an $f \in R$, $f \not \in \mathfrak p$ such
that $D(f) \cap W = \emptyset$.
\end{lemma}

\begin{proof}
Since $W$ is quasi-compact we may write it as a finite union
of standard affine opens $D(g_i)$, $i = 1, \ldots, n$.
Since $\mathfrak p \not \in W$ we have $g_i \in \mathfrak p$ for
all $i$. By Lemma \ref{lemma-minimal-prime-reduced-ring} above
each $g_i$ is nilpotent in $R_{\mathfrak p}$. Hence we can find
an $f \in R$, $f \not \in \mathfrak p$ such that for all $i$ we have
$f g_i^{n_i} = 0$ for some $n_i > 0$. Then $D(f)$ works.
\end{proof}

\begin{lemma}
\label{lemma-ring-with-only-minimal-primes}
Let $R$ be a ring.
The following are equivalent
\begin{enumerate}
\item there are no nontrivial inclusions between its prime ideals,
\item every prime ideal is minimal,
\item every prime ideal is a maximal ideal,
\item every quasi-compact open of $\text{Spec}(R)$ is also closed, and
\item $\text{Spec}(R)$ is totally disconnected.
\end{enumerate}
\end{lemma}

\begin{proof}
It is clear that (1), (2), and (3) are equivalent.
The implication (2) $\Rightarrow$ (4) follows from
Lemma \ref{lemma-standard-open-containing-maximal-point}.
Assume (4) holds. Let $\mathfrak p, \mathfrak p'$ be distinct
primes of $R$. Then we can choose an $f \in \mathfrak p'$,
$f \not \in \mathfrak p$. Then $\mathfrak p' \not \in D(f)$ and
$\mathfrak p \in D(f)$. By (4) the open $D(f)$ is also closed.
Hence $\mathfrak p$ and $\mathfrak p'$ cannot be in the same
connected component of $\text{Spec}(R)$ and we see (5) holds.
Finally, if (5) holds then there cannot be any specializations
between points of $\text{Spec}(R)$ and we see that (1) holds.
\end{proof}

\begin{lemma}
\label{lemma-reduced-ring-sub-product-fields}
Let $R$ be a reduced ring.
Then $R$ is a subring of a product of fields.
In fact, $R \subset \prod_{\mathfrak p\text{ minimal}} R_{\mathfrak p}$
is such an embedding.
\end{lemma}

\begin{proof}
This is clear from Lemma \ref{lemma-minimal-prime-reduced-ring} above
and the fact that $\bigcap_{\mathfrak p} \mathfrak p = (0)$
in a reduced ring, see Lemma \ref{lemma-Zariski-topology}.
\end{proof}














\section{Examples of spectra of rings}
\label{section-examples-spectra}

\noindent
In this section we put some examples of spectra.

\begin{example}
\label{example-spec-Zxmodx2minus4}
In this example we describe $X = \text{Spec} (\mathbf{Z}[x]/(x^2 - 4))$.
Let $\mathfrak{p}$ be an arbitrary prime in $X$.
Let $\phi: \mathbf{Z} \to \mathbf{Z}[x]/(x^2 - 4)$ be the natural ring map.
Then, $ \phi^{-1}(\mathfrak p)$ is a prime in $\mathbf{Z}$.
If $ \phi^{-1}(\mathfrak p) = (2)$, then since $\mathfrak p$ contains $2$,
it corresponds to a prime ideal in
$\mathbf{Z}[x]/(x^2 - 4, 2) \cong (\mathbf{Z}/2\mathbf{Z})[x]/(x^2)$
via the map $ \mathbf{Z}[x]/(x^2 - 4) \to  \mathbf{Z}[x]/(x^2 - 4, 2)$.
Any prime in $(\mathbf{Z}/2\mathbf{Z})[x]/(x^2)$ corresponds to a prime
in $(\mathbf{Z}/2\mathbf{Z})[x]$ containing $(x^2)$.  Such primes will
then contain $x$.  Since
$(\mathbf{Z}/2\mathbf{Z}) \cong (\mathbf{Z}/2\mathbf{Z})[x]/(x)$ is a field,
$(x)$ is a maximal ideal.  Since any prime contains $(x)$ and $(x)$ is
maximal, the ring contains only one prime $(x)$.  Thus, in this case,
$\mathfrak p = (2, x)$.  Now, if $ \phi^{-1}(\mathfrak p) = (q)$ for
$q > 2$, then since $\mathfrak p$ contains $q$, it corresponds to a
prime ideal in
$\mathbf{Z}[x]/(x^2 - 4, q) \cong (\mathbf{Z}/q\mathbf{Z})[x]/(x^2 - 4)$
via the map $ \mathbf{Z}[x]/(x^2 - 4) \to  \mathbf{Z}[x]/(x^2 - 4, q)$.
Any prime in $(\mathbf{Z}/q\mathbf{Z})[x]/(x^2 - 4)$ corresponds to a
prime in $(\mathbf{Z}/q\mathbf{Z})[x]$ containing $(x^2 - 4) = (x -2)(x + 2)$.
Hence, these primes must contain either $x -2$ or $x + 2$.  Since
$(\mathbf{Z}/q\mathbf{Z})[x]$ is a PID, all nonzero
primes are maximal, and so there
are precisely 2 primes in $(\mathbf{Z}/q\mathbf{Z})[x]$ containing
$(x-2)(x + 2)$, namely $(x-2)$ and $(x + 2)$.  In conclusion, there exist two
primes $(q, x-2)$ and $(q, x + 2)$ since $2 \neq -2 \in \mathbf{Z}/(q)$.
Finally, we treat the case where $\phi^{-1}(\mathfrak p) = (0)$.  Notice
that $\mathfrak p$ corresponds to a prime ideal in $\mathbf{Z}[x]$ that
contains $(x^2 - 4) = (x -2)(x + 2)$.  Hence, $\mathfrak p$ contains either
$(x-2)$ or $(x + 2)$.  Hence, $\mathfrak p$ corresponds to a prime in
$\mathbf{Z}[x]/(x-2)$ or one in $\mathbf{Z}[x]/(x + 2)$ that intersects
$\mathbf{Z}$ only at $0$, by assumption.  Since
$\mathbf{Z}[x]/(x-2) \cong \mathbf{Z}$ and
$\mathbf{Z}[x]/(x-2) \cong \mathbf{Z}$, this means that $\mathfrak p$
must correspond to $0$ in one of these rings.  Thus,
$\mathfrak p = (x-2)$ or $\mathfrak p = (x + 2)$ in the original ring.
\end{example}

\begin{example}
\label{example-spec-Zx}
In this example we describe $X = \text{Spec} (\mathbf{Z}[x])$.
Fix $\mathfrak p \in X$.
Let $\phi: \mathbf{Z} \to \mathbf{Z}[x]$ and notice
that $\phi^{-1}(\mathfrak p) \in \text{Spec} \mathbf{Z}$.
If $\phi^{-1}(\mathfrak p) = (q)$ for $q$ a prime number $q > 0$,
then it $\mathfrak p$ corresponds to a prime in $(\mathbf{Z}/(q))[x]$,
which must be generated by a polynomial that is irreducible in
$(\mathbf{Z}/(q))[x]$.   If we choose a representative of this polynomial
with minimal degree, then it will also be irreducible in $\mathbf{Z}[x]$.
Hence, in this case $\mathfrak p = (q, f_q)$ where $f_q$ is an irreducible
polynomial in $\mathbf{Z}[x]$ that is irreducible when viewed
in $(\mathbf{Z}/(q) [x])$. Now, assume that $\phi^{-1}(\mathfrak p) = (0)$.
In this case, $\mathfrak p$ must be generated by nonconstant polynomials
which, since $\mathfrak p$ is prime, may be assumed to be irreducible in
$\mathbf{Z}[x]$.  By Gauss' lemma, these polynomials are also irreducible
in $\mathbf{Q}[x]$.  Since $\mathbf{Q}[x]$ is a Euclidean domain, if there
are at least two distinct irreducibles $f, g$ generating $\mathfrak p$,
then $1 = af + bg$ for $a, b \in \mathbf{Q}[x]$.  Multiplying through by
a common denominator, we see that $m = \bar{a}f + \bar{b} g$ for
$\bar{a}, \bar{b} \in \mathbf{Z}[x]$ and nonzero $m \in \mathbf{Z}$.
This is a contradiction.  Hence, $\mathfrak p$ is generated by one
irreducible polynomial in $\mathbf{Z}[x]$.
\end{example}

\begin{example}
\label{example-spec-kxy}
In this example we describe $X = \text{Spec}(k[x, y])$
when $k$ is an arbitrary field.
Clearly $(0)$ is prime, and any principal ideal generated by an
irreducible polynomial will also be a prime since $k[x, y]$ is a
unique factorization domain. Now assume $\mathfrak p$ is an
element of $X$ that is not principal. Since $k[x, y]$ is a
Noetherian UFD, the prime ideal $\mathfrak p$ can be generated
by a finite number of irreducible polynomials $(f_1, \ldots, f_n)$.
Now, I claim that if $f, g$ are irreducible polynomials in $k[x, y]$
that are not associates, then $(f, g) \cap k[x] \neq 0$. To do this,
it is enough to show that $f$ and $g$ are relatively prime when
viewed in $k(x)[y]$. In this case, $k(x)[y]$ is a Euclidean domain,
so by applying the Euclidean algorithm and clearing denominators, we
obtain $p = af + bg$ for $p, a, b \in k[x]$. Thus, assume this is not
the case, that is, that some nonunit $h \in k(x)[y]$ divides both
$f$ and $g$. Then, by Gauss's lemma, for some $a, b \in k(x)$ we
have $ah | f$ and $bh | g$ for $ah, bh \in k[x]$ since
$\textrm{Frac}(k[x]) = k(x)$. By irreducibility, $ah = f$ and
$bh = g$ (since $h \notin k(x)$). So, back in $k(x)[y]$, $f, g $
are associates, as $\frac{a}{b} g = f$. Since
$k(x) = \textrm{Frac}(k[x])$, we can write $g = \frac{r}{s} f $
for elements $r , s \in k[x]$ sharing no common factors. This
implies that $sg = rf$ in $k[x, y]$ and so $s$ must divide $f$
since $k[x, y]$ is a UFD. Hence, $s = 1$ or $s = f$. If $s = f$,
then $r = g$, implying $f, g \in k[x]$ and thus must be units in
$k(x)$ and relatively prime in $k(x)[y]$, contradicting our
hypothesis. If $s = 1$, then $g = rf$, another contradiction.
Thus, we must have $f, g$ relatively prime in $k(x)[y]$, a
Euclidean domain. Thus, we have reduced to the case $\mathfrak p$
contains some irreducible polynomial $p \in k[x] \subseteq k[x, y]$.
By the above, $\mathfrak p$ corresponds to a prime in the ring
$k[x, y]/(p) = k(\alpha)[y]$, where $\alpha$ is an element
algebraic over $k$ with minimum polynomial $p$. This is a
PID, and so any prime ideal corresonds to $(0)$ or an
irreducible polynomial in $k(\alpha)[y]$. Thus, $\mathfrak p$
is of the form $(p)$ or $(p, f)$ where $f$ is a
polynomial in $k[x, y]$ that is irreducible in the quotient
$k[x, y]/(p)$.
\end{example}

\begin{example}
\label{example-affine-open-not-standard}
Consider the ring
$$
R = \{ f \in \mathbf{Q}[z]\text{ with }f(0) = f(1) \}.
$$
Consider the map
$$
\varphi : \mathbf{Q}[A, B] \to R
$$
defined by $\varphi(A) = z^2-z$ and $\varphi(B) = z^3-z^2$.  It is
easily checked that $(A^3-B^2 + AB)\subseteq\ker(\varphi)$ and that
$A^3-B^2 + AB$ is irreducible.  Assume that $\varphi$ is surjective;
then since $R$ is an integral domain (it is a subring of an integral
domain), $\ker(\phi)$ must be a prime ideal of $\mathbf{Q}[A, B]$.
The prime ideals which contain $(A^3-B^2 + AB)$ are $(A^3-B^2 + AB)$
itself and any maximal ideal $(f, g)$ with $f, g\in\mathbf{Q}[A, B]$
such that $f$ is irreducible mod $g$. But $R$ is not a field, so the
kernel must be $(A^3-B^2 + AB)$; hence $\varphi$ gives an isomorphism
$R \to \mathbf{Q}[A, B]/(A^3-B^2 + AB)$.\\
\indent To see that $\varphi$ is surjective, we must express any
$f\in R$ as a $\mathbf{Q}$-coefficient polynomial in $A(z) = z^2-z$
and $B(z) = z^3-z^2$. Note the relation $zA(z) = B(z)$. Let
$a = f(0) = f(1)$. Then $z(z-1)$ must divide $f(z)-a$, so we can write
$f(z) = z(z-1)g(z)+a = A(z)g(z)+a$.  If $\deg(g)<2$, then
$h(z) = c_1z + c_0$ and $f(z) = A(z)(c_1z + c_0)+a = c_1B(z)+c_0A(z)+a$, so we
are done.  If $\deg(g)\geq 2$, then by the polynomial division
algorithm, we can write $g(z) = A(z)h(z)+b_1z + b_0$
($\deg(h)\leq\deg(g)-2$), so $f(z) = A(z)^2h(z)+b_1B(z)+b_0A(z)$.
Applying division to $h(z)$ and iterating, we obtain an expression
for $f(z)$ as a polynomial in $A(z)$ and $B(z)$; hence $\varphi$ is
surjective.

\medskip\noindent Now let $a \in \mathbf{Q}$, $a \neq 0, \frac{1}{2}, 1$ and
consider
$$
R_a = \{ f \in \mathbf{Q}[z, \frac{1}{z-a}]\text{ with }f(0) = f(1)
\}.
$$
This is a finitely generated $\mathbf{Q}$-algebra as well: it is
easy to check that the functions $z^2-z$, $z^3-z$, and
$\frac{a^2-a}{z-a}+z$ generate $R_a$ as an $\mathbf{Q}$-algebra.  We
have the following inclusions:
$$
R\subset R_a\subset\mathbf{Q}[z, \frac{1}{z-a}], \qquad
R\subset\mathbf{Q}[z]\subset\mathbf{Q}[z, \frac{1}{z-a}].
$$
Recall (Lemma \ref{lemma-spec-localization}) that for a ring T and a
multiplicative subset $S\subset T$, the ring map $T \to S^{-1}T$
induces a map on spectra $\text{Spec}(S^{-1}T) \to \text{Spec}(T)$
which is a homeomorphism onto the subset
$$
\{\mathfrak p \in \text{Spec}(T) \mid S \cap \mathfrak p = \emptyset
\}\subseteq\text{Spec}(T).
$$
When $S = \lbrace 1, f, f^2, \ldots\rbrace$ for some $f\in T$, this is
the open set $D(f)\subset T$.  We now verify a corresponding
property for the ring map $R \to R_a$: we will show that the map
$\theta : \text{Spec}(R_a) \to \text{Spec}(R)$ induced by inclusion
$R\subset R_a$ is a homeomorphism onto an open subset of
$\text{Spec}(R)$ by verifying that $\theta$ is an injective local
homeomorphism.  We do so with respect to an open cover of
$\text{Spec}(R_a)$ by two distinguished opens, as we now describe.
For any $r\in\mathbf{Q}$, let $\text{ev}_r : R \to \mathbf{Q}$ be the
homomorphism given by evaluation at $r$.  Note that for $r = 0$ and
$r = 1-a$, this can be extended to a homomorphism
$\text{ev}_r' : R_a \to \mathbf{Q}$ (the latter because $\frac{1}{z-a}$
is well-defined at $z = 1-a$, since $a\neq\frac{1}{2}$).  However,
$\text{ev}_a$ does not extend to $R_a$.  Write
$\mathfrak{m}_r = \ker(\text{ev}_r)$; it is easy to check that
$$
\mathfrak{m}_0 = (z^2-z, z^3-z),
$$
$$
\mathfrak{m}_a = ((z-1 + a)(z-a), (z^2-1 + a)(z-a)), \text{ and}
$$
$$
\mathfrak{m}_{1-a} = ((z-1 + a)(z-a), (z-1 + a)(z^2-a)).
$$
(To do so, note that the right-hand sides are clearly contained in
the left-hand sides.  Then check that the right-hand sides are
maximal ideals by writing the generators in terms of $A$ and $B$,
and viewing $R$ as $\mathbf{Q}[A, B]/(A^3-B^2 + AB)$.) Note that
$\mathfrak{m}_a$ is not in the image of $\theta$: we have
$(z^2-1 + a)(z-a)-(z-1 + a)(z-a) = (z^2-z)(z-a)$ is in $\mathfrak{m}_a$,
so $z^2-z = \frac{(z^2-z)(z-a)}{z-a}$ is in $\mathfrak{m}_aR_a$. Hence
no ideal $I$ of $R_a$ can satisfy $I\cap R = \mathfrak{m_a}$, as such
an $I$ would have to contain $z^2-z$, which is in $R$ but not in
$\mathfrak{m}_a$.  The distinguished open set
$D((z-1 + a)(z-a))\subset\text{Spec}(R)$ is equal to the complement of
the closed set $\lbrace\mathfrak{m}_a, \mathfrak{m}_{1-a}\rbrace$.
Then check that $R_{(z-1 + a)(z-a)} = (R_a)_{(z-1 + a)(z-a)}$; calling
this localized ring $R'$, then, it follows that the map $R \to R'$
factors as $R \to R_a \to R'$.  By Lemma
\ref{lemma-spec-localization}, then, these maps express
$\text{Spec}(R')\subseteq\text{Spec}(R_a)$ and
$\text{Spec}(R')\subseteq\text{Spec}(R)$ as open subsets; hence
$\theta : \text{Spec}(R_a) \to \text{Spec}(R)$, when restricted to
$D((z-1 + a)(z-a))$, is a homeomorphism onto an open subset.
Similarly, $\theta$ restricted to
$D((z^2 + z + 2a-2)(z-a))\subseteq\text{Spec}(R_a)$ is a homeomorphism
onto the open subset $D((z^2 + z + 2a-2)(z-a))\subseteq\text{Spec}(R)$.
Depending on whether $z^2 + z + 2a-2$ is irreducible or not over
$\mathbf{Q}$, this former distinguished open set has complement
equal to one or two closed points along with the closed point
$\mathfrak{m}_a$. Furthermore, the ideal in $R_a$ generated by the
elements $(z^2 + z + 2a-a)(z-a)$ and $(z-1 + a)(z-a)$ is all of $R_a$, so
these two distinguished open sets cover $\text{Spec}(R_a)$. Hence in
order to show that $\theta$ is a homeomorphism onto
$\text{Spec}(R)-\lbrace\mathfrak{m}_a\rbrace$, it suffices to show
that these one or two points can never equal $\mathfrak{m}_{1-a}$.
And this is indeed the case, since $1-a$ is a root of $z^2 + z + 2a-2$
if and only of $a = 0$ or $a = 1$, both of which do not occur.

\medskip\noindent
Despite this homeomorphism which mimics the behavior of a
localization at an element of $R$, while
$\mathbf{Q}[z, \frac{1}{z-a}]$ is the localization of $\mathbf{Q}[z]$
at the maximal ideal $(z-a)$, the ring $R_a$ is \textit{not} a
localization of $R$: Any localization $S^{-1}R$ results in more
units than the original ring $R$.  The units of $R$ are
$\mathbf{Q}^\times$, the units of $\mathbf{Q}$.  If
$\frac{f}{(z-a)^k}$ is a unit in $R_a$ ($f\in R$ and $k\geq0$ an
integer), then we have
$$
\frac{f}{(z-a)^k}\cdot\frac{g}{(z-a)^\ell} = 1
$$
for some $g\in R$ and some integer $\ell\geq0$.  Since $R$ is an
integral domain, this is equivalent to
$$
fg = (z-a)^{k + \ell}.
$$
But $(z-a)^{k + \ell}$ is only an element of $R$ if $k = \ell = 0$; hence
$f, g$ are units in $R$ as well.  Hence $R_a$ has no more units than
$R$ does, and thus cannot be a localization of $R$.

\medskip\noindent
We used the fact that $a\neq 0, 1$ to ensure that
$\frac{1}{z-a}$ makes sense at $z = 0, 1$.  We used the fact that
$a\neq 1/2$ in a few places: (1) In order to be able to talk about
the kernel of $\text{ev}_{1-a}$ on $R_a$, which ensures that
$\mathfrak{m}_{1-a}$ is a point of $R_a$ (i.e., that $R_a$ is
missing just one point of $R$). (2) At the end in order to conclude
that $(z-a)^{k + \ell}$ can only be in $R$ for $k = \ell = 0$; indeed, if
$a = 1/2$, then this is in $R$ as long as $k + \ell$ is even. Hence
there would indeed be more units in $R_a$ than in $R$, and $R_a$
could possibly be a localization of $R$.
\end{example}







\section{Images of ring maps of finite presentation}
\label{section-images-finite-presentation}

\noindent
In this section we prove some results on the
topology of maps $\text{Spec}(S) \to \text{Spec}(R)$
induced by ring maps $R \to S$, mainly Chevalley's Theorem.
In order to do this we will use the notions of constructible sets,
quasi-compact sets, retrocompact sets, and so on
which are defined in Topology, Section \ref{topology-section-quasi-compact}.

\begin{lemma}
\label{lemma-qc-open}
Let $U \subset \text{Spec}(R)$ be open. The following
are equivalent:
\begin{enumerate}
\item $U$ is retrocompact in $\text{Spec}(R)$,
\item $U$ is quasi-compact, and
\item $U$ is a finite union of standard opens.
\end{enumerate}
\end{lemma}

\begin{proof}
The implication (2)$\Rightarrow$(3) is immediate from the fact that standard
opens form a basis for the topology. Each standard open is
homeomorphic to the spectrum of a ring and hence quasi-compact,
by Lemmas \ref{lemma-quasicompact} and \ref{lemma-standard-open}.
Hence a finite union of standard opens is quasi-compact as well.
To finish it suffices to show that a finite union
$\bigcup_{i = 1\ldots n} D(f_i)$ is retrocompact in $\text{Spec}(R)$.
In order to do this it suffices to show that
$(\bigcup_{i = 1\ldots n} D(f_i)) \cap (\bigcup_{j = 1\ldots m} D(g_j))$
is quasi-compact, which is clear because it equals
$\bigcup_{i, j} D(f_i g_j)$.
\end{proof}

\begin{lemma}
\label{lemma-affine-map-quasi-compact}
Let $\varphi : R \to S$ be a ring map.
The induced continuous map $f : \text{Spec}(S) \to \text{Spec}(R)$
is quasi-compact. For any constructible set $E \subset \text{Spec}(R)$
the inverse image $f^{-1}(E)$ is constructible in $\text{Spec}(S)$.
\end{lemma}

\begin{proof}
We first show that the inverse image of any quasi-compact
open $U \subset \text{Spec}(R)$ is quasi-compact. By
Lemma \ref{lemma-qc-open} we may write $U$ as a finite
open of standard opens. Thus by Lemma \ref{lemma-spec-functorial}
we see that $f^{-1}(U)$ is a finite union of standard opens.
Hence $f^{-1}(U)$ is quasi-compact by Lemma \ref{lemma-qc-open} again.
The second assertion now follows from Topology, Lemma
\ref{topology-lemma-inverse-images-constructibles}.
\end{proof}

\begin{lemma}
\label{lemma-constructible-is-image}
Let $R$ be a ring and let $T \subset \text{Spec}(R)$
be constructible. Then there exists a ring map $R \to S$ of
finite presentation such that $T$ is the image of
$\text{Spec}(S)$ in $\text{Spec}(R)$.
\end{lemma}

\begin{proof}
Let $T \subset \text{Spec}(R)$ be constructible.
The spectrum of a finite product of rings
is the disjoint union of the spectra, see
Lemma \ref{lemma-spec-product}. Hence if $T = T_1 \cup T_2$
and the result holds for $T_1$ and $T_2$, then the
result holds for $T$. In particular we may assume
that $T = U \cap V^c$, where $U, V \subset \text{Spec}(R)$
are retrocompact open. By Lemma \ref{lemma-qc-open} we may write
$T = (\bigcup D(f_i)) \cap (\bigcup D(g_j))^c =
\bigcup \big(D(f_i) \cap V(g_1, \ldots, g_m)\big)$.
In fact we may assume that $T = D(f) \cap V(g_1, \ldots, g_m)$
(by the argument on unions above).
In this case $T$ is the image of the map
$R \to (R/(g_1, \ldots, g_m))_f$, see Lemmas
\ref{lemma-standard-open} and \ref{lemma-spec-closed}.
\end{proof}

\begin{lemma}
\label{lemma-open-fp}
Let $R$ be a ring.
Let $f$ be an element of $R$.
Let $S = R_f$.
Then the image of a constructible subset of $\text{Spec}(S)$
is constructible in $\text{Spec}(R)$.
\end{lemma}

\begin{proof}
We repeatedly use Lemma \ref{lemma-qc-open} without mention.
Let $U, V$ be quasi-compact open in $\text{Spec}(S)$.
We will show that the image of $U \cap V^c$ is constructible.
Under the identification
$\text{Spec}(S) = D(f)$ of Lemma \ref{lemma-standard-open}
the sets $U, V$ correspond to quasi-compact opens
$U', V'$ of $\text{Spec}(R)$.
Hence it suffices to show that $U' \cap (V')^c$
is constructible in $\text{Spec}(R)$ which is clear.
\end{proof}

\begin{lemma}
\label{lemma-closed-fp}
Let $R$ be a ring.
Let $I$ be a finitely generated ideal of $R$.
Let $S = R/I$.
Then the image of a constructible of $\text{Spec}(S)$
is constructible in $\text{Spec}(R)$.
\end{lemma}

\begin{proof}
If $I = (f_1, \ldots, f_m)$, then we see that
$V(I)$ is the complement of $\bigcup D(f_i)$,
see Lemma \ref{lemma-Zariski-topology}.
Hence it is constructible, by Lemma \ref{lemma-qc-open}.
Denote the map $R \to S$ by $f \mapsto \overline{f}$.
We have to show that if $\overline{U}, \overline{V}$
are retrocompact opens of $\text{Spec}(S)$, then the
image of $\overline{U} \cap \overline{V}^c$
in $\text{Spec}(R)$ is constructible.
By Lemma \ref{lemma-qc-open} we may write
$\overline{U} = \bigcup D(\overline{g_i})$.
Setting $U = \bigcup D({g_i})$ we see $\overline{U}$
has image $U \cap V(I)$ which is constructible in
$\text{Spec}(R)$. Similarly the image of $\overline{V}$ equals
$V \cap V(I)$ for some retrocompact open $V$ of $\text{Spec}(R)$.
Hence the image of $\overline{U} \cap \overline{V}^c$
equals $U \cap V(I) \cap V^c$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-affineline-open}
Let $R$ be a ring. The map $\text{Spec}(R[x]) \to \text{Spec}(R)$
is open, and the image of any standard open is a quasi-compact
open.
\end{lemma}

\begin{proof}
It suffices to show that the image of a standard open
$D(f)$, $f\in R[x]$ is quasi-compact open.
The image of $D(f)$ is the image of
$\text{Spec}(R[x]_f) \to \text{Spec}(R)$.
Let $\mathfrak p \subset R$ be a prime ideal.
Let $\overline{f}$ be the image of $f$ in
$\kappa(\mathfrak p)[x]$.
Recall, see Lemma \ref{lemma-in-image},
that $\mathfrak p$ is in the image
if and only if $R[x]_f \otimes_R \kappa(\mathfrak p) =
\kappa(\mathfrak p)[x]_{\overline{f}}$ is not the
zero ring. This is exactly the condition that $f$ does not map
to zero in $\kappa(\mathfrak p)[x]$, in other words, that
some coefficient of $f$ is not in $\mathfrak p$.
Hence we see: if $f = a_d x^d + \ldots a_0$, then
the image of $D(f)$ is $D(a_d) \cup \ldots \cup D(a_0)$.
\end{proof}

\noindent
We prove a property of characteristic polynomials which
will be used below.

\begin{lemma}
\label{lemma-characteristic-polynomial-prime}
Let $R \to A$ be a ring homomorphism.
Assume $A \cong R^{\oplus n}$ as an $R$-module.
Let $f \in A$. The multiplication map $m_f: A
\to A$ is $R$-linear and hence
has a characteristic polynomial
$P(T) = T^n + r_{n-1}T^{n-1} + \cdots + r_0 \in R[T]$.
For any prime
$\mathfrak{p} \in \text{Spec} R$, $f$ acts nilpotently on $A
\otimes_R \kappa(\mathfrak{p})$ if and only if $\mathfrak p \in
V(r_0, \ldots, r_{n-1})$.
\end{lemma}

\begin{proof}
This follows quite easily once we prove that the characteristic
polynomial $\bar P(T) \in \kappa(\mathfrak p)[T]$ of the
multiplication map $m_{\bar f}: A \otimes_R \kappa(\mathfrak p) \to
A \otimes_R \kappa(\mathfrak p)$ which multiplies elements of $A
\otimes_R \kappa(\mathfrak p)$ by $\bar f$, the image of $f$ viewed in
$\kappa(\mathfrak p)$, is just the image of $P(T)$ in
$\kappa(\mathfrak p)[T]$. Let $(a_{ij})$ be the matrix of the map
$m_f$ with entries in $R$, using a basis $e_1, \ldots, e_n$
of $A$ as an $R$-module.
Then, $A \otimes_R \kappa(\mathfrak p) \cong (R \otimes_R
\kappa(\mathfrak p))^{\oplus n} = \kappa(\mathfrak p)^n$, which is
an $n$-dimensional vector space over $\kappa(\mathfrak p)$ with
basis $e_1 \otimes 1, \ldots, e_n \otimes 1$. The image $\bar f = f
\otimes 1$, and so the multiplication map $m_{\bar f}$ has matrix
$(a_{ij} \otimes 1)$. Thus, the characteristic polynomial is
precisely the image of $P(T)$.

\medskip\noindent
From linear algebra, we know that a linear transformation acts
nilpotently on an $n$-dimensional vector space if and only if the
characteristic polynomial is $T^n$ (since the characteristic
polynomial divides some power of the minimal polynomial). Hence,
$f$ acts nilpotently on $A \otimes_R \kappa(\mathfrak p)$ if and
only if $\bar P(T) = T^n$. This occurs if and only if $r_i \in
\mathfrak p$ for all $0 \leq i \leq n - 1$, that is when $\mathfrak p \in
V(r_0, \ldots, r_{n - 1}).$
\end{proof}

\begin{lemma}
\label{lemma-affineline-special}
Let $R$ be a ring. Let $f, g \in R[x]$ be polynomials.
Assume the leading coefficient of $g$ is a unit of $R$.
There exists elements $r_i\in R$, $i = 1\ldots, n$ such that
the image of $D(f) \cap V(g)$ in $\text{Spec}(R)$ is
$\bigcup_{i = 1, \ldots, n} D(r_i)$.
\end{lemma}

\begin{proof}
Write $g = ux^d + a_{d-1}x^{d-1} + \ldots a_0$, where
$d$ is the degree of $g$, and hence $u \in R^*$.
Consider the ring $A = R[x]/(g)$.
It is, as an $R$-module, finite free with basis the images
of $1, x, \ldots, x^{d-1}$. Consider multiplication
by (the image of) $f$ on $A$. This is an $R$-module map.
Hence we can let $P(T) \in R[T]$ be the characteristic polynomial
of this map. Write $P(T) = T^d + r_{d-1} T^{d-1} + \ldots r_0$.
We claim that $r_0, \ldots, r_{d-1}$ have the desired property.
We will use below the property of characteristic polynomials
that
$$
\mathfrak p \in V(r_0, \ldots, r_{d-1})
\Leftrightarrow
\text{multiplication by }f\text{ is nilpotent on }
A\otimes_R \kappa(\mathfrak p).
$$
This was proved in Lemma \ref{lemma-characteristic-polynomial-prime} above.

\medskip\noindent
Suppose $\mathfrak q\in D(f) \cap V(g)$, and let
$\mathfrak p = \mathfrak q \cap R$. Then there is a nonzero map
$A\otimes_R \kappa(\mathfrak p) \to \kappa(\mathfrak q)$ which
is compatible with multiplication by $f$.
And $f$ acts as a unit on $\kappa(\mathfrak q)$.
Thus we conclude $\mathfrak p \not \in  V(r_0, \ldots, r_{d-1})$.

\medskip\noindent
On the other hand, suppose that $r_i \not\in \mathfrak p$ for some
prime $\mathfrak p$ of $R$ and some $0 \leq i \leq d - 1$.
Then multiplication by $f$ is not nilpotent on the algebra
$A \otimes_R \kappa(\mathfrak p)$.
Hence there exists a maximal ideal $\overline{\mathfrak q} \subset
A \otimes_R \kappa(\mathfrak p)$ not containing the image of $f$.
The inverse image of $\overline{\mathfrak q}$ in $R[x]$
is an element of $D(f) \cap V(g)$ mapping to $\mathfrak p$.
\end{proof}

\begin{theorem}
\label{theorem-chevalley}
Chevalley's Theorem.
Suppose that $R \to S$ is of finite presentation.
The image of a constructible subset of
$\text{Spec}(S)$ in $\text{Spec}(R)$ is constructible.
\end{theorem}

\begin{proof}
Write $S = R[x_1, \ldots, x_n]/(f_1, \ldots, f_m)$.
We may factor $R \to S$ as $R \to R[x_1] \to R[x_1, x_2]
\to \ldots \to R[x_1, \ldots, x_{n-1}] \to S$. Hence
we may assume that $S = R[x]/(f_1, \ldots, f_m)$.
In this case we factor the map as $R \to R[x] \to S$,
and by Lemma \ref{lemma-closed-fp} we reduce to
the case $S = R[x]$. By Lemma \ref{lemma-qc-open} suffices
to show that if
$T = (\bigcup_{i = 1\ldots n} D(f_i)) \cap V(g_1, \ldots, g_m)$
for $f_i , g_j \in R[x]$ then the image in $\text{Spec}(R)$ is
constructible. Since finite unions of constructible sets
are constructible, it suffices to deal with the case $n = 1$,
i.e., when $T = D(f) \cap V(g_1, \ldots, g_m)$.

\medskip\noindent
Note that if $c \in R$, then we have
$$
\text{Spec}(R) =
V(c) \coprod D(c) =
\text{Spec}(R/(c)) \coprod \text{Spec}(R_c)),
$$
and correspondingly $\text{Spec}(R[x]) =
V(c) \coprod D(c) = \text{Spec}(R/(c)[x]) \coprod
\text{Spec}(R_c[x]))$. The intersection of $T = D(f) \cap V(g_1, \ldots, g_m)$
with each part still has the same shape, with $f$, $g_i$ replaced
by their images in $R/(c)[x]$, respectively $R_c[x]$.
Note that the image of $T$
in $\text{Spec}(R)$ is the union of the image of
$T \cap V(c)$ and $T \cap D(c)$. Using Lemmas \ref{lemma-open-fp}
and \ref{lemma-closed-fp} it suffices to prove the images of both
parts are constructible in $\text{Spec}(R/(c))$, respectively
$\text{Spec}(R_c)$.

\medskip\noindent
Let us assume we have $T = D(f) \cap V(g_1, \ldots, g_m)$
as above, with $\deg(g_1) \leq \deg(g_2) \leq \ldots \leq \deg(g_m)$.
We are going to use descending induction on $m$, and on the
degrees of the $g_i$. Let $d = \deg(g_1)$, i.e., $g_1 = c x^{d_1} + l.o.t$
with $c \in R$ not zero. Cutting $R$ up into the pieces
$R/(c)$ and $R_c$ we either lower the degree of $g_1$ (and this
is covered by induction)
or we reduce to the case where $c$ is invertible.
If $c$ is invertible, and $m > 1$, then write
$g_2 = c' x^{d_2} + l.o.t$. In this case consider
$g_2' = g_2 - (c'/c) x^{d_2 - d_1} g_1$. Since the ideals
$(g_1, g_2, \ldots, g_m)$ and $(g_1, g_2', g_3, \ldots, g_m)$
are equal we see that $T = D(f) \cap V(g_1, g_2', g_3\ldots, g_m)$.
But here the degree of $g_2'$ is strictly less than the degree
of $g_2$ and hence this case is covered by induction.

\medskip\noindent
The bases case for the induction above are the cases
(a) $T = D(f) \cap V(g)$ where the leading coefficient
of $g$ is invertible, and (b) $T = D(f)$. These two cases
are dealt with in Lemmas \ref{lemma-affineline-special}
and \ref{lemma-affineline-open}.
\end{proof}











\section{More on images}
\label{section-more-images}

\noindent
In this section we collect a few additional lemmas concerning the image
on $\text{Spec}$ for ring maps. See also Section \ref{section-going-up}
for example.

\begin{lemma}
\label{lemma-generic-finite-presentation}
Let $R \subset S$ be an inclusion of domains.
Assume that $R \to S$ is of finite type.
There exists a nonzero $f \in R$, and a nonzero $g \in S$
such that $R_f \to S_{fg}$ is of finite presentation.
\end{lemma}

\begin{proof}
By induction on the number of generators of
$S$ over $R$.

\medskip\noindent
Suppose that $S$ is generated by a single element
over $R$. Then $S = R[x]/\mathfrak q$ for some
prime ideal $\mathfrak q \subset R[x]$. If $\mathfrak q = (0)$
there is nothing to prove. If $\mathfrak q \not = (0)$,
then let $g \in \mathfrak q$ be an element with minimal
degree in $x$. Since $K[x] = f.f.(R)[x]$ is a PID we see that
$g$ is irreducible over $K$ and that $f.f.(S) = K[x]/(g)$.
Write $g = a_d x^d + \ldots + a_0$
with $a_i \in R$ and $a_d \not = 0$. After inverting $a_d$
in $R$ we may assume that $g$ is monic. Hence we see that
$R \to R[x]/(g) \to S$ with the last map surjective.
But $R[x]/(g) = R \oplus Rx \oplus \ldots \oplus Rx^{d-1}$
maps injectively into $f.f.(S) = K[x]/(g) = K \oplus Kx \oplus
\ldots \oplus Kx^{d-1}$. Thus $S \cong R[x]/(g)$ is finitely
presented.

\medskip\noindent
Suppose that $S$ is generated by $n > 1$ elements over $R$.
Say $x_1, \ldots, x_n \in S$ generate $S$. Denote $S' \subset S$
the subring generated by $x_1, \ldots, x_{n-1}$. By induction
hypothesis we see that there exist $f\in R$ and $g \in S'$
nonzero such that $R_f \to S'_{fg}$ is of finite presentation.
Next we apply the induction hypothesis to $S'_{fg} \to S_{fg}$
to see that there exist $f' \in S'_{fg}$ and
$g' \in S_{fg}$ such that $S'_{fgf'} \to S_{fgf'g'}$
is of finite presentation. We leave it to the reader to conclude.
\end{proof}

\begin{lemma}
\label{lemma-characterize-image-finite-type}
Let $R \to S$ be a finite type ring map.
Denote $X = \text{Spec}(R)$ and $Y = \text{Spec}(S)$.
Write $f : Y \to X$ the induced
map of spectra. Let $E \subset Y = \text{Spec}(S)$ be a
constructible set.
If a point $\xi \in X$ is in $f(E)$, then
$\overline{\{\xi\}} \cap f(E)$ contains an open
dense subset of $\overline{\{\xi\}}$.
\end{lemma}

\begin{proof}
Let $\xi \in X$ be a point of $f(E)$. Choose a point $\eta \in E$
mapping to $\xi$. Let $\mathfrak p \subset R$ be the prime
corresponding to $\xi$ and let $\mathfrak q \subset S$ be the
prime corresponding to $\eta$. Consider the diagram
$$
\xymatrix{
\eta \ar[r] \ar@{|->}[d] & E \cap Y' \ar[r] \ar[d] &
Y' = \text{Spec}(S/\mathfrak q) \ar[r] \ar[d] &
Y \ar[d] \\
\xi \ar[r] & f(E) \cap X' \ar[r] &
X' = \text{Spec}(R/\mathfrak p) \ar[r] &
X
}
$$
By Lemma \ref{lemma-affine-map-quasi-compact} the set $E \cap Y'$
is constructible in $Y'$.
It follows that we may replace $X$ by $X'$ and
$Y$ by $Y'$. Hence we may assume that $R \subset S$ is an
inclusion of domains, $\xi$ is the generic
point of $X$, and $\eta$ is the generic point of $Y$.
By Lemma \ref{lemma-generic-finite-presentation}
combined with Chevalley's theorem \ref{theorem-chevalley}
we see that there exist dense opens $U \subset X$,
$V \subset Y$ such that $f(V) \subset U$ and
such that $f : V \to U$ maps constructible sets
to constructible sets. Note that $E \cap V$ is
constructible in $V$, see Topology,
Lemma \ref{topology-lemma-open-immersion-constructible-inverse-image}.
Hence $f(E \cap V)$ is constructible in $U$ and contains $\xi$.
By Topology, Lemma \ref{topology-lemma-generic-point-in-constructible}
we see that $f(E \cap V)$ contains a dense open $U' \subset U$.
\end{proof}

\noindent
At the end of this section we present a few more results on
images of maps on Spectra that have nothing to do with constructible
sets.

\begin{lemma}
\label{lemma-surjective-spec-radical-ideal}
Let $\varphi : R \to S$ be a ring map.
The following are equivalent:
\begin{enumerate}
\item The map $\text{Spec}(S) \to \text{Spec}(R)$ is surjective.
\item For any radical ideal $I \subset R$
the inverse image of $IS$ in $R$ is equal to $I$.
\item For every prime $\mathfrak p$ of $R$ the inverse
image of $\mathfrak p S$ in $R$ is $\mathfrak p$.
\end{enumerate}
In this case the same is true after any base change: Given a ring map
$R \to R'$ the ring map $R' \to R' \otimes_R S$ has the equivalent
properties (1), (2), (3) also.
\end{lemma}

\begin{proof}
The implication (2) $\Rightarrow$ (3) is immediate.
If $I \subset R$ is a radical ideal, then
Lemma \ref{lemma-Zariski-topology}
guarantees that $I = \bigcap_{I \subset \mathfrak p} \mathfrak p$.
Hence (3) $\Rightarrow$ (2). By
Lemma \ref{lemma-in-image}
we have $\mathfrak p = \varphi^{-1}(\mathfrak p S)$ if and only if
$\mathfrak p$ is in the image. Hence (1) $\Leftrightarrow$ (3).
Thus (1), (2), and (3) are equivalent.

\medskip\noindent
Assume (1) holds. Let $R \to R'$ be a ring map. Let
$\mathfrak p' \subset R'$ be a prime ideal lying over the prime
$\mathfrak p$ of $R$. To see that $\mathfrak p'$ is in the image
of $\text{Spec}(R' \otimes_R S) \to \text{Spec}(R')$ we have to show
that $(R' \otimes_R S) \otimes_{R'} \kappa(\mathfrak p')$ is not zero, see
Lemma \ref{lemma-in-image}.
But we have
$$
(R' \otimes_R S) \otimes_{R'} \kappa(\mathfrak p') =
S \otimes_R \kappa(\mathfrak p)
\otimes_{\kappa(\mathfrak p)} \kappa(\mathfrak p')
$$
which is not zero as $S \otimes_R \kappa(\mathfrak p)$ is not zero
by assumption and $\kappa(\mathfrak p) \to \kappa(\mathfrak p')$ is
an extension of fields.
\end{proof}

\begin{lemma}
\label{lemma-domain-image-dense-set-points-generic-point}
Let $R$ be a domain. Let $\varphi : R \to S$ be a ring map.
The following are equivalent:
\begin{enumerate}
\item The ring map $R \to S$ is injective.
\item The image $\text{Spec}(S) \to \text{Spec}(R)$
contains a dense set of points.
\item There exists a prime ideal $\mathfrak q \subset S$
whose inverse image in $R$ is $(0)$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $K$ be the field of fractions of the domain $R$.
Assume that $R \to S$ is injective. Since localization
is exact we see that $K \to S \otimes_R K$ is injective.
Hence there is a prime mapping to $(0)$ by
Lemma \ref{lemma-in-image}.

\medskip\noindent
Note that $(0)$ is dense in $\text{Spec}(R)$, so that the
last condition implies the second.

\medskip\noindent
Suppose the second condition holds. Let $f \in R$,
$f \not = 0$. As $R$ is a domain we see that $V(f)$
is a proper closed subset of $R$. By assumption
there exists a prime $\mathfrak q$
of $S$ such that $\varphi(f) \not \in \mathfrak q$.
Hence $\varphi(f) \not = 0$.
Hence $R \to S$ is injective.
\end{proof}

\begin{lemma}
\label{lemma-injective-minimal-primes-in-image}
Let $R \subset S$ be an injective ring map.
Then $\text{Spec}(S) \to \text{Spec}(R)$
hits all the minimal primes of $\text{Spec}(R)$.
\end{lemma}

\begin{proof}
Let $\mathfrak p \subset R$ be a minimal prime.
In this case $R_{\mathfrak p}$ has a unique prime ideal.
Hence it suffices to show that $S_{\mathfrak p}$ is not zero.
And this follows from the fact that localization is exact,
see Proposition \ref{proposition-localization-exact}.
\end{proof}

\begin{lemma}
\label{lemma-image-dense-generic-points}
Let $R \to S$ be a ring map. The following are equivalent:
\begin{enumerate}
\item The kernel of $R \to S$ consists of nilpotent elements.
\item The minimal primes of $R$ are in the image of
$\text{Spec}(S) \to \text{Spec}(R)$.
\item The image of $\text{Spec}(S) \to \text{Spec}(R)$ is dense
in $\text{Spec}(R)$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $I = \text{Ker}(R \to S)$. Note that
$\sqrt{(0)} = \bigcap_{\mathfrak q \subset S} \mathfrak q$, see
Lemma \ref{lemma-Zariski-topology}.
Hence $\sqrt{I} = \bigcap_{\mathfrak q \subset S} R \cap \mathfrak q$.
Thus $V(I) = V(\sqrt{I})$ is the closure of the image of
$\text{Spec}(S) \to \text{Spec}(R)$.
This shows that (1) is equivalent to (3). It is clear that
(2) implies (3). Finally, assume (1). We may replace
$R$ by $R/I$ and $S$ by $S/IS$ without affecting the topology
of the spectra and the map. Hence the implication (1) $\Rightarrow$ (2)
follows from Lemma \ref{lemma-injective-minimal-primes-in-image} above.
\end{proof}








\section{Noetherian rings}
\label{section-Noetherian}

\noindent
A ring $R$ is {\it Noetherian} if any ideal of $R$ is
finitely generated. It is clearly equivalent to the
ascending chain condition for ideals of $R$.

\begin{lemma}
\label{lemma-Noetherian-permanence}
Any finitely generated ring over a Noetherian ring
is Noetherian. Any localization of a Noetherian ring
is Noetherian.
\end{lemma}

\begin{proof}
The statement on localizations follows from the fact
that any ideal $J \subset S^{-1}R$ is of the form
$I \cdot S^{-1}R$. Any quotient $R/I$ of a Noetherian
ring $R$ is Noetherian because any ideal $\overline{J} \subset R/I$
is of the form $J/I$ for some ideal $I \subset J \subset R$.
Thus it suffices to show that if $R$ is Noetherian so
is $R[X]$. Suppose $J_1 \subset J_2 \subset \ldots$ is an
ascending chain of ideals in $R[X]$. Consider the ideals $I_{i, d}$
defined as the ideal of elements of $R$ which occur as leading
coefficients of degree $d$ polynomials in $J_i$.
Clearly $I_{i, d} \subset I_{i', d'}$ whenever
$i \leq i'$ and $d \leq d'$. By the ascending chain condition
in $R$ there are at most finitely many distinct ideals among all of
the $I_{i, d}$.
(Hint: Any infinite set of elements of
$\mathbf{N} \times \mathbf{N}$ contains an increasing
infinite sequence.)
Take $i_0$ so large that $I_{i, d} = I_{i_0, d}$
for all $i \geq i_0$ and all $d$. Suppose $f \in J_i$ for some $i \geq i_0$.
By induction on the degree $d = \deg(f)$ we show that $f \in J_{i_0}$.
Namely, there exists a $g\in J_{i_0}$ whose degree is $d$ and which
has the same leading coefficient as $f$. By induction
$f - g \in J_{i_0}$ and we win.
\end{proof}

\begin{lemma}
\label{lemma-Noetherian-power-series}
If $R$ is a Noetherian ring, then so is the formal power
series ring $R[[x_1, \ldots, x_n]]$.
\end{lemma}

\begin{proof}
Since $R[[x_1, \ldots, x_{n + 1}]] \cong R[[x_1, \ldots, x_n]][[x_{n + 1}]]$
it suffices to prove the statement that $R[[x]]$ is Noetherian if
$R$ is Noetherian. Let $I \subset R[[x]]$ be a ideal.
We have to show that $I$ is a finitely generated ideal.
For each integer
$d$ denote $I_d = \{a \in R \mid ax^d + \text{h.o.t.} \in I\}$.
Then we see that $I_0 \subset I_1 \subset \ldots$ stabilizes as $R$
is Noetherian. Choose $d_0$ such that $I_{d_0} = I_{d_0 + 1} = \ldots$.
For each $d \leq d_0$ choose elements $f_{d, j} \in I \cap (x^d)$,
$j = 1, \ldots, n_d$ such that if we write
$f_{d, j} = a_{d, j}x^d + \text{h.o.t}$ then $I_d = (a_{d, j})$.
Denote $I' = (\{f_{d, j}\}_{d = 0, \ldots, d_0, j = 1, \ldots, n_d})$.
Then it is clear that $I' \subset I$. Pick $f \in I$.
First we may choose $c_{d, i} \in R$ such that
$$
f - \sum c_{d, i} f_{d, i} \in (x^{d_0 + 1}) \cap I.
$$
Next, we can choose $c_{i, 1} \in R$, $i = 1, \ldots, n_{d_0}$ such that
$$
f - \sum c_{d, i} f_{d, i} - \sum c_{i, 1}xf_{d_0, i} \in (x^{d_0 + 2}) \cap I.
$$
Next, we can choose $c_{i, 2} \in R$, $i = 1, \ldots, n_{d_0}$ such that
$$
f - \sum c_{d, i} f_{d, i} - \sum c_{i, 1}xf_{d_0, i}
- \sum c_{i, 2}x^2f_{d_0, i}
\in (x^{d_0 + 3}) \cap I.
$$
And so on. In the end we see that
$$
f = \sum c_{d, i} f_{d, i} +
\sum\nolimits_i (\sum\nolimits_e c_{i, e} x^e)f_{d_0, i}
$$
is contained in $I'$ as desired.
\end{proof}

\noindent
The following lemma, although easy, is useful because
finite type $\mathbf{Z}$-algebras come up quite often in
a technique called ``absolute Noetherian reduction''.

\begin{lemma}
\label{lemma-obvious-Noetherian}
Any finite type algebra over a field is Noetherian.
Any finite type algebra over $\mathbf{Z}$ is Noetherian.
\end{lemma}

\begin{proof}
This is immediate from the above and the fact that
$\mathbf{Z}$ is a Noetherian ring because it is a
principal ideal domain.
\end{proof}

\begin{lemma}
\label{lemma-Noetherian-finite-type-is-finite-presentation}
Let $R$ be a Noetherian ring.
\begin{enumerate}
\item Any finite $R$-module is of finite presentation.
\item Any finite type $R$-algebra is of finite presentation over $R$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $M$ be a finite $R$-module. By
Lemma \ref{lemma-trivial-filter-finite-module}
we can find a finite filtration of $M$ whose succesive quotients are
of the form $R/I$. Since any ideal is finitely generated, each of
the quotients $R/I$ is finitely presented. Hence $M$ is finitely
presented by
Lemma \ref{lemma-extension}.
This proves (1).
To see (2) note that any ideal of
$R[x_1, \ldots, x_n]$ is finitely generated by
Lemma \ref{lemma-Noetherian-permanence}
above.
\end{proof}

\begin{lemma}
\label{lemma-Noetherian-topology}
If $R$ is a Noetherian ring then $\text{Spec}(R)$
is a Noetherian topological space, see Topology,
Definition \ref{topology-definition-noetherian}.
\end{lemma}

\begin{proof}
This is because any closed subset of $\text{Spec}(R)$
is uniquely of the form $V(I)$ with $I$ a radical ideal,
see Lemma \ref{lemma-Zariski-topology}.
And this correspondence is inclusion reversing.
Thus the result follows from the definitions.
\end{proof}

\begin{lemma}
\label{lemma-Noetherian-irreducible-components}
If $R$ is a Noetherian ring then $\text{Spec}(R)$
has finitely many irreducible components. In other words
$R$ has finitely many minimal primes.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-Noetherian-topology} and
Topology, Lemma \ref{topology-lemma-Noetherian}
we see there are finitely many irreducible components.
By Lemma \ref{lemma-irreducible} these correspond to
minimal primes of $R$.
\end{proof}







\section{Curiosity}
\label{section-curiosity}

\noindent
Lemma \ref{lemma-disjoint-implies-product}
explains what happens if $V(I)$ is open for some ideal $I \subset R$.
But what if $\text{Spec}(S^{-1}R)$ is closed in $\text{Spec}(R)$?
The next two lemmas give a partial answer. For more information see
Section \ref{section-pure-ideals}.

\begin{lemma}
\label{lemma-invert-closed-quotient}
Let $R$ be a ring. Let $S \subset R$ be a multiplicative subset.
Assume the image of the map $\text{Spec}(S^{-1}R) \to \text{Spec}(R)$
is closed. Then $S^{-1}R \cong R/I$ for some ideal $I \subset R$.
\end{lemma}

\begin{proof}
Let $I = \text{Ker}(R \to S^{-1}R)$ so that $V(I)$ contains the image.
Say the image is the closed subset $V(I') \subset \text{Spec}(R)$ for
some ideal $I' \subset R$. So $V(I') \subset V(I)$.
For $f \in I'$ we see that $f/1 \in S^{-1}R$
is contained in every prime ideal. Hence $f^n$ maps to zero in $S^{-1}R$
for some $n \geq 1$ (Lemma \ref{lemma-Zariski-topology}).
Hence $V(I') = V(I)$.
Then this implies every $g \in S$ is invertible mod $I$.
Hence we get ring maps $R/I \to S^{-1}R$ and $S^{-1}R \to R/I$.
The first map is injective by choice of $I$.
The second is the map $S^{-1}R \to S^{-1}(R/I) = R/I$ which
has kernel $S^{-1}I$ because localization is exact.
Since $S^{-1}I = 0$ we see also the second map is injective.
Hence $S^{-1}R \cong R/I$.
\end{proof}

\begin{lemma}
\label{lemma-invert-closed-split}
Let $R$ be a ring. Let $S \subset R$ be a multiplicative subset.
Assume the image of the map $\text{Spec}(S^{-1}R) \to \text{Spec}(R)$
is closed. If $R$ is Noetherian, or $\text{Spec}(R)$ is a
Noetherian topological space, or $S$ is finitely generated as a monoid,
then $R \cong S^{-1}R \times R'$ for some ring $R'$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-invert-closed-quotient} we have $S^{-1}R \cong R/I$
for some ideal $I \subset R$. By Lemma \ref{lemma-disjoint-implies-product}
it suffices to show that $V(I)$ is open.
If $R$ is Noetherian then $\text{Spec}(R)$ is a Noetherian
topological space, see Lemma \ref{lemma-Noetherian-topology}.
If $\text{Spec}(R)$ is a Noetherian topological space,
then the complement $\text{Spec}(R) \setminus V(I)$ is quasi-compact, see
Topology, Lemma \ref{topology-lemma-Noetherian-quasi-compact}.
Hence there exist finitely many $f_1, \ldots, f_n \in I$ such
that $V(I) = V(f_1, \ldots, f_n)$.
Since each $f_i$ maps to zero in $S^{-1}R$
there exists a $g \in S$ such that $gf_i = 0$ for
$i = 1, \ldots, n$. Hence $D(g) = V(I)$ as desired.
In case $S$ is finitely generated as a monoid, say $S$ is generated
by $g_1, \ldots, g_m$, then $S^{-1}R \cong R_{g_1 \ldots g_m}$
and we conclude that $V(I) = D(g_1 \ldots g_m)$.
\end{proof}














\section{Hilbert Nullstellensatz}
\label{section-nullstellensatz}

\begin{theorem}
\label{theorem-nullstellensatz}
(Hilbert Nullstellensatz)
Let $k$ be a field.
\begin{enumerate}
\item For any maximal ideal $\mathfrak m \subset k[x_1, \ldots, x_n]$
the field extension $k \subset \kappa(\mathfrak m)$ is finite.
\label{item-finite-kappa}
\item Any radical ideal $I \subset k[x_1, \ldots, x_n]$
is the intersection of maximal ideals containing it.
\label{item-polynomial-ring-Jacobson}
\end{enumerate}
The same is true in any finite type $k$-algebra.
\end{theorem}

\begin{proof}
It is enough to prove part (\ref{item-finite-kappa}) of
the theorem for the case of a polynomial
algebra $k[x_1, \ldots, x_n]$, because any finitely generated
$k$-algebra is a quotient of such a polynomial algebra.
We prove this by induction on $n$. The case $n = 0$ is clear.
Suppose that $\mathfrak m$ is a maximal ideal in $k[x_1, \ldots, x_n]$.
Let $\mathfrak p \subset k[x_n]$ be the intersection
of $\mathfrak m$ with $k[x_n]$.

\medskip\noindent
If $\mathfrak p \not = (0)$,
then $\mathfrak p$ is maximal and generated by an irreducible
monic polynomial $P$ (because of the Euclidean algorithm
in $k[x_n]$). Then
$k' = k[x_n]/\mathfrak p$ is a finite field extension of $k$
and contained in $\kappa(\mathfrak m)$. In this case
we get a surjection
$$
k'[x_1, \ldots, x_{n-1}]
\to
k'[x_1, \ldots, x_n] =
k' \otimes_k k[x_1, \ldots, x_n]
\longrightarrow
\kappa(\mathfrak m)
$$
and hence we see that $\kappa(\mathfrak m)$ is a finite
extension  of $k'$ by induction hypothesis. Thus $\kappa(\mathfrak m)$
is finite over $k$ as well.

\medskip\noindent
If $\mathfrak p = (0)$ we consider the ring
extension $k[x_n] \subset k[x_1, \ldots, x_n]/\mathfrak m$.
This is a finitely generated ring extension, hence
of finite presentation by
Lemmas \ref{lemma-obvious-Noetherian} and
\ref{lemma-Noetherian-finite-type-is-finite-presentation}.
Thus the image of $\text{Spec}(k[x_1, \ldots, x_n]/\mathfrak m)$
in $\text{Spec}(k[x_n])$ is constructible by
Theorem \ref{theorem-chevalley}. Since the image
contains $(0)$ we conclude that it contains a standard
open $D(f)$ for some $f\in k[x_n]$ nonzero. Since clearly
$D(f)$ is infinite we get a contradiction with the
assumption that $k[x_1, \ldots, x_n]/\mathfrak m$ is
a field (and hence has a spectrum consisting of one point).

\medskip\noindent
To prove part (\ref{item-polynomial-ring-Jacobson}) let
$I \subset R$ be radical, with $R$ of finite type over $k$.
Let $f \in R$, $f \not \in I$. Pick a maximal ideal $\mathfrak m'$
in the nonzero ring $R_f/IR_f = (R/I)_f$. Let $\mathfrak m \subset R$
be the inverse image of $\mathfrak m'$ in $R$. We see that
$I \subset \mathfrak m$
and $f \not \in \mathfrak m$. If we show that $\mathfrak m$ is a maximal
ideal of $R$, then we are done. We clearly have
$$
k \subset R/\mathfrak m \subset \kappa(\mathfrak m').
$$
By part (\ref{item-finite-kappa}) the field extension
$k \subset \kappa(\mathfrak m')$
is finite. By elementary field theory we conclude that $R/\mathfrak m$
is a field.
\end{proof}

\begin{lemma}
\label{lemma-field-finite-type-over-domain}
Let $R$ be a ring. Let $K$ be a field.
If $R \subset K$ and $K$ is of finite type over $R$,
then there exists a $f \in R$ such that $R_f$ is a field,
and $R_f \subset K$ is a finite field extension.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-characterize-image-finite-type} there
exist a nonempty open $U \subset \text{Spec}(R)$
contained in the image $\{(0)\}$ of $\text{Spec}(K) \to \text{Spec}(R)$.
Choose $f \in R$, $f \not = 0$ such that $D(f) \subset U$, i.e.,
$D(f) = \{(0)\}$. Then $R_f$ is a domain whose spectrum has exactly one
point and $R_f$ is a field. Then $K$ is a finitely generated algebra
over the field $R_f$ and hence a finite field extension of
$R_f$ by the Hilbert Nullstellensatz above.
\end{proof}





















\section{Jacobson rings}
\label{section-ring-jacobson}

\noindent
Let $R$ be a ring. The closed points of $\text{Spec}(R)$ are the
maximal ideals of $R$. Often rings which occur naturally in algebraic
geometry have lots of maximal ideals. For example finite type algebras
over a field or over $\mathbf{Z}$. We will show that these
are examples of Jacobson rings.

\begin{definition}
\label{definition-ring-jacobson}
Let $R$ be a ring. We say that $R$ is a
{\it Jacobson ring} if every radical
ideal $I$ is the intersection of the
maximal ideals containing it.
\end{definition}

\begin{lemma}
\label{lemma-finite-type-field-Jacobson}
Any algebra of finite type over a field is Jacobson.
\end{lemma}

\begin{proof}
This follows from Theorem \ref{theorem-nullstellensatz}
and Definition \ref{definition-ring-jacobson}.
\end{proof}

\begin{lemma}
\label{lemma-jacobson-prime}
Let $R$ be a ring. If every prime ideal of $R$ is the
intersection of the maximal ideals containing it,
then $R$ is Jacobson.
\end{lemma}

\begin{proof}
This is immediately clear from the fact that
every radical ideal $I \subset R$ is the
intersection of the primes containing it.
See Lemma \ref{lemma-Zariski-topology}.
\end{proof}

\begin{lemma}
\label{lemma-jacobson}
A ring $R$ is Jacobson if and only if $\text{Spec}(R)$
is Jacobson, see Topology,
Definition \ref{topology-definition-space-jacobson}.
\end{lemma}

\begin{proof}
Suppose $R$ is Jacobson. Let $Z \subset \text{Spec}(R)$
be a closed subset. We have to show that the set of closed
points in $Z$ is dense in $Z$. Let $U \subset \text{Spec}(R)$
be an open such that $U \cap Z$ is nonempty.
We have to show $Z \cap U$ contains a closed point
of $\text{Spec}(R)$. We may
assume $U = D(f)$ as standard opens form a basis for the
topology on $\text{Spec}(R)$. According to
Lemma \ref{lemma-Zariski-topology} we may assume that
$Z = V(I)$, where $I$ is a radical ideal. We see also
that $f \not \in I$. By assumption, there exists a
maximal ideal $\mathfrak m \subset R$ such that
$I \subset \mathfrak m$ but $f \not\in \mathfrak m$.
Hence $\mathfrak m \in D(f) \cap V(I) = U \cap Z$ as desired.

\medskip\noindent
Conversely, suppose that $\text{Spec}(R)$ is Jacobson.
Let $I \subset R$ be a radical ideal. Let
$J = \cap_{I \subset \mathfrak m} \mathfrak m$
be the intersection of the maximal ideals containing $I$.
Clearly $J$ is radical, $V(J) \subset V(I)$, and
$V(J)$ is the smallest closed subset of $V(I)$ containing
all the closed points of $V(I)$. By assumption we see that
$V(J) = V(I)$. But Lemma \ref{lemma-Zariski-topology}
shows there is a bijection between Zariski closed
sets and radical ideals, hence $I = J$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-characterize-jacobson}
Let $R$ be a ring. If $R$ is not Jacobson there exist
a prime $\mathfrak p \subset R$, an element $f \in R$
such that the following hold
\begin{enumerate}
\item $\mathfrak p$ is not a maximal ideal,
\item $f \not \in \mathfrak p$,
\item $V(\mathfrak p) \cap D(f) = \{\mathfrak p\}$, and
\item $(R/\mathfrak p)_f$ is a field.
\end{enumerate}
On the other hand, if $R$ is Jacobson, then for any pair $(\mathfrak p, f)$
such that (1) and (2) hold the set $V(\mathfrak p) \cap D(f)$ is
infinite.
\end{lemma}

\begin{proof}
Assume $R$ is not Jacobson.
By Lemma \ref{lemma-jacobson} this means there exists an
closed subset $T \subset \text{Spec}(R)$
whose set $T_0 \subset T$ of closed points is not dense in $T$.
Choose an $f \in R$ such that $T_0 \subset V(f)$ but
$T \not \subset V(f)$. Note that $T \cap D(f)$
is homeomorphic to $\text{Spec}((R/I)_f)$ if $T = V(I)$, see
Lemmas \ref{lemma-spec-closed} and \ref{lemma-standard-open}.
As any ring has a maximal ideal
(Lemma \ref{lemma-Zariski-topology}) we can choose a closed point $t$ of
space $T \cap D(f)$. Then $t$ corresponds to a prime ideal
$\mathfrak p \subset R$ which is not maximal (as $t \not \in T_0$).
Thus (1) holds. By construction $f \not \in \mathfrak p$, hence (2).
As $t$ is a closed point of $T \cap D(f)$ we see that
$V(\mathfrak p) \cap D(f) = \{\mathfrak p\}$, i.e., (3) holds. Hence we
conclude that $(R/\mathfrak p)_f$ is a domain whose
spectrum has one point, hence (4) holds
(for example combine Lemmas \ref{lemma-characterize-local-ring} and
\ref{lemma-minimal-prime-reduced-ring}).

\medskip\noindent
Conversely, suppose that $R$ is Jacobson and $(\mathfrak p, f)$
satisfy (1) and (2). If
$V(\mathfrak p) \cap V(f) =
\{\mathfrak p, \mathfrak q_1, \ldots, \mathfrak q_t\}$
then $\mathfrak p \not = \mathfrak q_i$
implies there exists an element $g \in R$ such that $g \not \in \mathfrak p$
but $g \in \mathfrak q_i$ for all $i$. Hence
$V(\mathfrak p) \cap D(fg) = \{\mathfrak p\}$ which
is impossible since each locally closed subset of $\text{Spec}(R)$
contains at least one closed point as $\text{Spec}(R)$ is
a Jacobson topological space.
\end{proof}

\begin{lemma}
\label{lemma-pid-jacobson}
The ring $\mathbf{Z}$ is a Jacobson ring.
More generally, let $R$ be a ring such that
\begin{enumerate}
\item $R$ is a domain,
\item $R$ is Noetherian,
\item any nonzero prime ideal is a maximal ideal, and
\item $R$ has infinitely many maximal ideals.
\end{enumerate}
Then $R$ is a Jacobson ring.
\end{lemma}

\begin{proof}
Let $R$ satisfy (1), (2), (3) and (4). The statement
means that $(0) = \bigcap_{\mathfrak m \subset R} \mathfrak m$.
Since $R$ has infinitely many maximal ideals it suffices to
show that any nonzero $x \in R$ is contained in at most
finitely many maximal ideals, in other words that $V(x)$ is finite.
By Lemma \ref{lemma-spec-closed}
we see that $V(x)$ is homeomorphic to $\text{Spec}(R/xR)$.
By assumption (3) every prime of $R/xR$ is minimal and hence
corresponds to an irreducible component of $\text{Spec}(R)$
(Lemma \ref{lemma-irreducible}).
As $R/xR$ is Noetherian, the topological space $\text{Spec}(R/xR)$
is Noetherian (Lemma \ref{lemma-Noetherian-topology})
and has finitely many irreducible components
(Topology, Lemma \ref{topology-lemma-Noetherian}).
Thus $V(x)$ is finite as desired.
\end{proof}

\begin{example}
\label{example-infinite-product-fields-jacobson}
Let $A$ be an infinite set.
For each $\alpha \in A$, let $k_\alpha$ be a field.
We claim that $R = \prod_{\alpha\in A} k_\alpha$ is Jacobson.
First, note that any element $f \in R$ has the form
$f = ue$, with $u \in R$ a unit and $e\in R$ an idempotent
(left to the reader).
Hence $D(f) = D(e)$, and $R_f = R_e = R/(1-e)$ is a quotient of $R$.
Actually, any ring with this property is Jacobson.
Namely, say $\mathfrak p \subset R$ is a prime ideal
and $f \in R$, $f \not \in \mathfrak p$. We have to find
a maximal ideal $\mathfrak m$ of $R$ such that
$\mathfrak p \subset \mathfrak m$ and $f \not\in \mathfrak m$.
Because $R_f$ is a quotient of $R$ we see that any maximal
ideal of $R_f$ corresponds to a maximal ideal of $R$
not containing $f$. Hence the result follows
by choosing a maximal ideal of $R_f$ containing $\mathfrak p R_f$.
\end{example}

\begin{example}
\label{example-not-jacobson}
A domain $R$ with finitely many maximal ideals
$\mathfrak m_i$, $i = 1, \ldots, n$ is not a
Jacobson ring, except when it is a field.
Namely, in this case $(0)$ is not the intersection
of the maximal ideals $(0) \not=
\mathfrak m_1 \cap \mathfrak m_2 \cap \ldots \cap \mathfrak m_n
\supset \mathfrak m_1 \cdot \mathfrak m_2 \cdot \ldots
\cdot \mathfrak m_n \not= 0$.
In particular a discrete valuation ring, or any local ring with
at least two prime ideals is not a Jacobson
ring.
\end{example}

\begin{lemma}
\label{lemma-finite-residue-extension-closed}
Let $R \to S$ be a ring map.
Let $\mathfrak m \subset R$ be a maximal ideal.
Let $\mathfrak q \subset S$ be a prime ideal
lying over $\mathfrak m$ such that $\kappa(\mathfrak m)
\subset \kappa(\mathfrak q)$ is an algebraic field extension.
Then $\mathfrak q$ is a maximal ideal of $S$.
\end{lemma}

\begin{proof}
Consider the diagram
$$
\xymatrix{
S \ar[r] & S/\mathfrak q \ar[r] & \kappa(\mathfrak q) \\
R \ar[r] \ar[u] & R/\mathfrak m \ar[u]
}
$$
We see that $\kappa(\mathfrak m) \subset S/\mathfrak q \subset
\kappa(\mathfrak q)$. Because the field extension
$\kappa(\mathfrak m) \subset \kappa(\mathfrak q)$
is algebraic, any ring between $\kappa(\mathfrak m)$
and $\kappa(\mathfrak q)$ is a field (by elementary
field theory). Thus $S/\mathfrak q$ is a field, and a posteriori equal
to $\kappa(\mathfrak q)$.
\end{proof}

\begin{lemma}
\label{lemma-dimension}
Suppose that $k$ is a field and suppose that $V$ is a nonzero vector
space over $k$. Asssume the dimension of $V$ (which is a cardinal number)
is smaller than the cardinality of $k$. Then for any linear operator
$T : V \to V$ there exists some monic polynomial $P(t) \in k[t]$ such that
$P(T)$ is not invertible.
\end{lemma}

\begin{proof}
If not then $V$ inherits the structure of a vector space over
the field $k(t)$. But the dimension of $k(t)$ over $k$ is
at least the cardinality of $k$ for example due to the fact that the elements
$\frac{1}{t - \lambda}$ are $k$-linearly independent.
\end{proof}

\noindent
Here is another version of Hilbert's Nullstellensatz.

\begin{theorem}
\label{theorem-uncountable-nullstellensatz}
Let $k$ be a field. Let $S$ be a $k$-algebra generated over $k$
by the elements $\{x_i\}_{i \in I}$. Assume the cardinality of $I$
is smaller than the cardinality of $k$. Then
\begin{enumerate}
\item for all maximal ideals $\mathfrak m \subset S$ the field
extension $k \subset \kappa(\mathfrak m)$
is algebraic, and
\item $S$ is a Jacobson ring.
\end{enumerate}
\end{theorem}

\begin{proof}
If $I$ is finite then the result follows from the Hilbert Nullstellensatz,
Theorem \ref{theorem-nullstellensatz}. In the rest of the proof we assume
$I$ is infinite. It suffices to prove the result for
$\mathfrak m \subset k[\{x_i\}_{i \in I}]$ maximal in the polynomial
ring on variables $x_i$, since $S$ is a quotient of this.
As $I$ is infinite the set
of monomials $x_{i_1}^{e_1} \ldots x_{i_r}^{e_r}$, $i_1, \ldots, i_r \in I$
and $e_1, \ldots, e_r \geq 0$ has cardinality at most equal to the
cardinality of $I$. Because the cardinality of $I \times \ldots \times I$
is the cardinality of $I$, and also the cardinality of
$\bigcup_{n \geq 0} I^n$ has the same cardinality.
(If $I$ is finite, then this is not true and
in that case this proof only works if $k$ is uncountable.)

\medskip\noindent
To arrive at a contradiction pick $T \in \kappa(\mathfrak m)$ transcendental
over $k$. Note that the $k$-linear map
$T : \kappa(\mathfrak m) \to \kappa(\mathfrak m)$
given by multiplication by $T$ has the property that $P(T)$ is invertible
for all monic polynomials $P(t) \in k[t]$.
Also, $\kappa(\mathfrak m)$ has dimension at most the cardinality of $I$
over $k$ since it is a quotient of the vector space
$k[\{x_i\}_{i \in I}]$ over $k$ (whose dimension is $\#I$ as we saw above).
This is impossible by Lemma \ref{lemma-dimension}.

\medskip\noindent
To show that $S$ is Jacobson we argue as follows. If not then
there exists a prime $\mathfrak q \subset S$ and an element $f \in S$,
$f \not \in \mathfrak q$ such that $\mathfrak q$ is not maximal
and $(S/\mathfrak q)_f$ is a field, see
Lemma \ref{lemma-characterize-jacobson}.
But note that $(S/\mathfrak q)_f$ is generated by at most $\#I + 1$ elements.
Hence the field extension $k \subset (R/\mathfrak q)_f$ is algebraic
(by the first part of the proof).
This implies that $\kappa(\mathfrak q)$ is an algebraic extension of $k$
hence $\mathfrak q$ is maximal by
Lemma \ref{lemma-finite-residue-extension-closed}. This contradiction
finishes the proof.
\end{proof}

\begin{lemma}
\label{lemma-base-change-Jacobson}
Let $k$ be a field. Let $S$ be a $k$-algebra.
For any field extension $k \subset K$ whose cardinality is larger
than the cardinality of $S$ we have
\begin{enumerate}
\item for every maximal ideal $\mathfrak m$ of $S_K$ the field
$\kappa(\mathfrak m)$ is algebraic over $K$, and
\item $S_K$ is a Jacobson ring.
\end{enumerate}
\end{lemma}

\begin{proof}
Choose $k \subset K$ such that the cardinality of $K$ is greater
than the cardinality of $S$. Since the elements of $S$ generate
the $K$-algebra $S_K$ we see that
Theorem \ref{theorem-uncountable-nullstellensatz}
applies.
\end{proof}

\begin{example}
\label{example-countable-trick-does-not-work}
The trick in the proof of
Theorem \ref{theorem-uncountable-nullstellensatz}
really does not work if $k$ is a countable field and $I$ is countable too.
Let $k$ be a countable field. Let $x$ be a variable,
and let $k(x)$ be the field of rational functions in $x$.
Consider the polynomial algebra $R = k[x, \{x_f\}_{f \in k[x]-\{0\}}]$.
Let $I = (\{fx_f - 1\}_{f\in k[x] - \{0\}})$. Note that
$I$ is a proper ideal in $R$.
Choose a maximal ideal $I \subset \mathfrak m$.
Then $k \subset R/\mathfrak m$ is isomorphic to
$k(x)$, and is not algebraic over $k$.
\end{example}

\begin{lemma}
\label{lemma-Jacobson-invert-element}
Let $R$ be a Jacobson ring. Let $f \in R$.
The ring $R_f$ is Jacobson and maximal ideals
of $R_f$ correspond to maximal ideals of $R$.
\end{lemma}

\begin{proof}
By Topology, Lemma \ref{topology-lemma-jacobson-inherited}
we see that $D(f) = \text{Spec}(R_f)$ is Jacobson and
that closed points of $D(f)$
correspond to closed points in $\text{Spec}(R)$
which happen to lie in $D(f)$. Thus we win by
Lemma \ref{lemma-jacobson}.
\end{proof}

\begin{example}
\label{example-localize-not-preserve-closed-points}
Here is a simple example that shows Lemma \ref{lemma-Jacobson-invert-element}
to be false if $R$ is not Jacobson.
Consider the ring $R = \mathbf{Z}_{(2)}$, i.e., the localization
of $\mathbf{Z}$ at the prime $(2)$. The localization of $R$ at
the element $2$ is isomorphic to $\mathbf{Q}$, in a formula:
$R_2 \cong \mathbf{Q}$. Clearly the map $R \to R_2$ maps the
closed point of $\text{Spec}(\mathbf{Q})$ to the generic point
of $\text{Spec}(R)$.
\end{example}

\begin{example}
\label{example-infinite-localize-not-preserve-closed-points}
Here is a simple example that shows
Lemma \ref{lemma-Jacobson-invert-element}
is false if $R$ is Jacobson but we localize at infinitely
many elements.
Namely, let $R = \mathbf{Z}$ and consider the localization
$(R \setminus \{0\})^{-1}R \cong \mathbf{Q}$
of $R$ at the set of all nonzero elements.
Clearly the map $\mathbf{Z} \to \mathbf{Q}$ maps the
closed point of $\text{Spec}(\mathbf{Q})$ to the generic point
of $\text{Spec}(\mathbf{Z})$.
\end{example}

\begin{lemma}
\label{lemma-Jacobson-mod-ideal}
Let $R$ be a Jacobson ring. Let $I \subset R$ be an ideal.
The ring $R/I$ is Jacobson and maximal ideals
of $R/I$ correspond to maximal ideals of $R$.
\end{lemma}

\begin{proof}
The proof is the same as the proof of
Lemma \ref{lemma-Jacobson-invert-element}.
\end{proof}

\begin{proposition}
\label{proposition-Jacobson-permanence}
Let $R$ be a Jacobson ring. Let $R \to S$ be a
ring map of finite type. Then
\begin{enumerate}
\item The ring $S$ is Jacobson.
\item The map $\text{Spec}(S) \to \text{Spec}(R)$ transforms
closed points to closed points.
\item For $\mathfrak m' \subset S$ maximal lying over $\mathfrak m \subset R$
the field extension $\kappa(\mathfrak m) \subset \kappa(\mathfrak m')$
is finite.
\end{enumerate}
\end{proposition}

\begin{proof}
Let $A \to B \to C$ be finite type ring maps.
Suppose $\text{Spec}(C) \to \text{Spec}(B)$ and
$\text{Spec}(B) \to \text{Spec}(A)$ map closed
points to closed points, and induce finite residue
field extensions on residue fields at closed points.
Then so does $\text{Spec}(C) \to \text{Spec}(A)$.
Thus it is clear that if we factor $R \to S$ as
$R \to S' \to S$ for some finite type $R$-algebra
$S'$, then it suffices to prove the lemma
for $R \to S'$ and then $S' \to S$.
Writing $S = R[x_1, \ldots, x_n]/I$ we see that
it suffices to prove the lemma in the cases
$S = R[x]$ and $S = R/I$. The case $S = R/I$
is Lemma \ref{lemma-Jacobson-mod-ideal}.

\medskip\noindent
The case  $S = R[x]$.
Take an irreducible closed subset
$Z \subset \text{Spec}(R[x])$.
In other words $Z = V(\mathfrak q)$ for some
prime $\mathfrak q \subset R[x]$. Set
$\mathfrak p = \mathfrak q \cap R$.
Let $U \subset \text{Spec}(R[x])$ be open
such that $U \cap Z \not = \emptyset$.
We have to find a closed point in $U \cap Z$.
In fact, we will find
\begin{list}{$(*)$}{}
\item
a closed point $y$ of $U \cap Z$
which maps to a closed point $x$ of $\text{Spec}(R)$
such that additionally $\kappa(x) \subset \kappa(y)$
is finite.
\end{list}
To do this we may assume $U = D(f)$ for some $f \in R[x]$.
In this case $U\cap V(\mathfrak q) \not = \emptyset$
means $f \not \in \mathfrak q$. Consider the diagram
$$
\xymatrix{
R[x] \ar[r] & R/\mathfrak p[x]  \\
R \ar[r] \ar[u] & R/\mathfrak p  \ar[u]
}
$$
It suffices to solve the problem on the right hand side
of this diagram. Thus
we see we may assume $R$ is Jacobson, a domain and
$\mathfrak p = (0)$.

\medskip\noindent
In case $\mathfrak q = (0)$, write $f = a_d x^d + \ldots + a_0$.
We see that not all $a_i$ are zero. Take any maximal ideal
$\mathfrak m$ of $R$ such that $a_i \not \in \mathfrak m$
for some $i$ (here we use $R$ is Jacobson). Next, choose
a maximal ideal $\overline{\mathfrak m}' \subset (R/\mathfrak m)[x]$
not containing the image of $f$ (possible because
$\kappa(\mathfrak m)[x]$ is Jacobson). Then the inverse image
$\mathfrak m' \subset R[x]$ defines a closed point of
$U \cap Z$ and maps to $\mathfrak m$. Also, by construction
$\kappa(\mathfrak m) \subset \kappa(\mathfrak m')$ is finite.
Thus we have shown $(*)$ in this case.

\medskip\noindent
In case $\mathfrak q \not = (0)$, let $K$ be the
fraction field of $R$. Write $\mathfrak q K[x]
= (g)$ for some irreducible $g \in K[x]$. Clearing
denominators, we may assume that $g \in R[x]$, and
hence in $\mathfrak q$. Write $g = b_e x^e + \ldots + b_0$,
$b_i \in R$ with $b_e \not= 0$.
The maps $R \to R_{b_e}$ and $R[x] \to R[x]_{b_e}$
satisfies the conclusion of the lemma, by Lemma
\ref{lemma-Jacobson-invert-element} and moreover induce
isomorphisms on residue fields. Hence, in order to prove $(*)$,
we may replace $R$ by $R_{b_e}$ and assume that $g$ is monic.
In this case we see that $R[x]/\mathfrak q$ is a
quotient of the finite free $R$-module
$R[x]/(g) = R \oplus Rx \oplus \ldots \oplus Rx^{e-1}$.
But on the other hand we have $R[x]/(g) \subset K[x]/(g)
= K[x]/\mathfrak q K[x]$. Hence $\mathfrak q = (g)$, and
$Z = V(\mathfrak q) = V(g)$. At this point, by Lemma
\ref{lemma-affineline-special} the image of $D(f) \cap V(g)$
in $\text{Spec}(R)$ is $D(r_1) \cup \ldots \cup D(r_d)$
for some $r_i \in R$ (of course it is nonempty).
Take any maximal ideal $\mathfrak m \subset R$ in this
image (possible because $R$ is Jacobson) and take any
prime $\mathfrak m' \subset R[x]$
corresponding to a point of $D(f) \cap V(g)$
lying over $\mathfrak m$. Note that the residue field
extension $\kappa(\mathfrak m) \subset \kappa(\mathfrak m')$
is finite (because $g \in \mathfrak m'$). By
Lemma \ref{lemma-finite-residue-extension-closed}
we see that $\mathfrak m'$ is a closed point.
This proves $(*)$ in this case.

\medskip\noindent
At this point we are done. Namely, $(*)$ implies
that $\text{Spec}(R[x])$ is Jacobson (via Lemma \ref{lemma-jacobson}).
Also, if $Z$ is a singleton closed set, then $(*)$ implies that
$Z = \{ \mathfrak m' \}$ with $\mathfrak m'$ lying over a maximal
ideal $\mathfrak m \subset R$ such that $\kappa(\mathfrak m)
\subset \kappa(\mathfrak m')$ is finite.
\end{proof}

\begin{lemma}
\label{lemma-corollary-jacobson}
Any finite type algebra over $\mathbf{Z}$ is Jacobson.
\end{lemma}

\begin{proof}
Combine Lemma \ref{lemma-pid-jacobson} and
Proposition \ref{proposition-Jacobson-permanence}.
\end{proof}

\begin{lemma}
\label{lemma-image-finite-type-map-Jacobson-rings}
Let $R \to S$ be a finite type ring map of Jacobson rings.
Denote $X = \text{Spec}(R)$ and $Y = \text{Spec}(S)$.
Write $f : Y \to X$ the induced
map of spectra. Let $E \subset Y = \text{Spec}(S)$ be a
constructible set. Denote with a subscript ${}_0$ the set
of closed points of a topological space.
\begin{enumerate}
\item We have $f(E)_0 = f(E_0) = X_0 \cap f(E)$.
\item A point $\xi \in X$ is in $f(E)$ if and only if
$\overline{\{\xi\}} \cap f(E_0)$ is dense in $\overline{\{\xi\}}$.
\end{enumerate}
\end{lemma}

\begin{proof}
We have a commutative diagram of continuous maps
$$
\xymatrix{
E \ar[r] \ar[d] & Y \ar[d] \\
f(E) \ar[r] & X
}
$$
Suppose $x \in f(E)$ is closed in $f(E)$. Then $f^{-1}(\{x\})\cap E$
is closed in $E$. Hence $f^{-1}(\{x\})\cap E$ is constructible, nonempty
in $Y$. By Topology, Lemma \ref{topology-lemma-jacobson-inherited},
the intersection $Y_0 \cap f^{-1}(\{x\})\cap E$ is not empty.
Thus there exists $y \in Y_0$ mapping to $x$.
Since clearly $y \in E_0$ we see that $x \in f(E_0)$.
This proves that $f(E)_0 \subset f(E_0)$.
Proposition \ref{proposition-Jacobson-permanence} implies that
$f(E_0) \subset X_0 \cap f(E)$. The inclusion
$X_0 \cap f(E) \subset f(E)_0$ is trivial. This proves the
first assertion.

\medskip\noindent
Suppose that $\xi \in f(E)$. According to
Lemma \ref{lemma-characterize-image-finite-type}
the set $f(E) \cap \overline{\{\xi\}}$ contains a dense
open subset of $\overline{\{\xi\}}$. Since $X$ is Jacobson
we conclude that $f(E) \cap \overline{\{\xi\}}$ contains a
dense set of closed points, see Topology,
Lemma \ref{topology-lemma-jacobson-inherited}.
We conclude by part (1) of the lemma.

\medskip\noindent
On the other hand, suppose that $\overline{\{\xi\}} \cap f(E_0)$
is dense in $\overline{\{\xi\}}$. By
Lemma \ref{lemma-constructible-is-image}
there exists a ring map $S \to S'$ of finite presentation
such that $E$ is the image of $Y' := \text{Spec}(S') \to Y$.
Then $E_0$ is the image of $Y'_0$ by the first part of the
lemma applied to the ring map $S \to S'$. Thus we may assume that
$E = Y$ by replacing $S$ by $S'$. Suppose $\xi$ corresponds
to $\mathfrak p \subset R$. Consider the diagram
$$
\xymatrix{
S \ar[r] & S/\mathfrak p S \\
R \ar[r] \ar[u] & R/\mathfrak p \ar[u]
}
$$
This diagram and the density of $f(Y_0) \cap V(\mathfrak p)$
in $V(\mathfrak p)$
shows that the morphism $R/\mathfrak p \to S/\mathfrak p S$
satisfies condition (2) of
Lemma \ref{lemma-domain-image-dense-set-points-generic-point}.
Hence we conclude
there exists a prime $\overline{\mathfrak q} \subset S/\mathfrak pS$
mapping to $(0)$. In other words the inverse image $\mathfrak q$
of $\overline{\mathfrak q}$ in $S$ maps to $\mathfrak p$ as desired.
\end{proof}

\noindent
The conclusion of the lemma above is that we can read off
the image of $f$ from the set of closed points of the image.
This is a little nicer in case the map is of finite presentation
because then we know that images of constructibles are constructible.
Before we state it we introduce some notation.
Denote $\text{Constr}(X)$ the set of constructible
Let $R \to S$ be a ring map.
Denote $X = \text{Spec}(R)$ and $Y = \text{Spec}(S)$.
Write $f : Y \to X$ the induced map of spectra.
Denote with a subscript ${}_0$ the set
of closed points of a topological space.


\begin{lemma}
\label{lemma-conclude-jacobson-Noetherian}
With notation as above. Assume that $R$ is a Noetherian Jacobson ring.
Further assume $R \to S$ is of finite type.
There is a commutative diagram
$$
\xymatrix{
\text{Constr}(Y) \ar[r]^{E \mapsto E_0} \ar[d]^{E \mapsto f(E)} &
\text{Constr}(Y_0) \ar[d]^{E \mapsto f(E)} \\
\text{Constr}(X) \ar[r]^{E \mapsto E_0} &
\text{Constr}(X_0)
}
$$
where the horizontal arrows are the bijections from
Topology, Lemma \ref{topology-lemma-jacobson-equivalent-constructible}.
\end{lemma}

\begin{proof}
Since $R \to S$ is of finite type, it is of finite presentation,
see Lemma \ref{lemma-Noetherian-finite-type-is-finite-presentation}.
Thus the image of a constructible set in $X$ is constructible
in $Y$ by Chevalley's theorem \ref{theorem-chevalley}. Combined with
Lemma \ref{lemma-image-finite-type-map-Jacobson-rings}
above the lemma follows.
\end{proof}

\noindent
To illustrate the use of Jacobson rings, we give the following two examples.

\begin{example}
\label{example-product-matrixes-zero}
Let $k$ be a field. The space $\text{Spec}(k[x, y]/(xy))$
has two irreducible components: namely the $x$-axis and the
$y$-axis. As a generalization, let
$$
R = k[x_{11}, x_{12}, x_{21}, x_{22}, y_{11}, y_{12}, y_{21}, y_{22}]/
\mathfrak a,
$$
where $\mathfrak a$ is the ideal in
$k[x_{11}, x_{12}, x_{21}, x_{22}, y_{11}, y_{12}, y_{21}, y_{22}]$
generated by the entries of the $2 \times 2$ product matrix
$$
\left(
\begin{matrix}
x_{11} & x_{12}\\
x_{21} & x_{22}
\end{matrix}
\right)
 \left(
\begin{matrix}
y_{11} & y_{12}\\
y_{21} & y_{22}
\end{matrix}
\right),
$$
we shall also describe $\text{Spec}(R)$

\medskip\noindent
To prove the statement about $\text{Spec}(k[x, y]/(xy))$ we argue as follows.
If $\mathfrak p \subset k[x, y]$ is any ideal containing $xy$, then either
$x$ or $y$ would be contained in $\mathfrak p$. Hence the minimal such
prime ideals are just $(x)$ and $(y)$. In case $k$ is
algebraically closed, the $\text{max-Spec}$ of these components
can then be visualized as the point sets of $y$ and $x$ axis.

\medskip\noindent
For the generalization, note that we may identify the closed
points of the spectrum of
$k[x_{11}, x_{12}, x_{21}, x_{22}, y_{11}, y_{12}, y_{21}, y_{22}])$
with the space of matrices
$$
\left\{ (X, Y) \in Mat(2, k)\times Mat(2, k) \mid
X = \left(
\begin{matrix}
x_{11} & x_{12}\\
x_{21} & x_{22}
\end{matrix}
\right),
Y= \left(
\begin{matrix}
y_{11} & y_{12}\\
y_{21} & y_{22}
\end{matrix}
\right)
\right\}
$$
at least if $k$ is algebraically closed.
Now define a group action of
$GL(2, k)\times GL(2, k)\times GL(2, k)$ on the space of matrices
$\{(X, Y)\}$ by
$$
(g_1, g_2, g_3) \times (X, Y) \mapsto ((g_1Xg_2^{-1}, g_2Yg_3^{-1})).
$$
Here, also observe that the algebraic set
$$
GL(2, k)\times GL(2, k)\times GL(2, k) \subseteq
Mat(2, k)\times Mat(2, k) \times Mat(2, k)
$$
is irreducible since it is the max spectrum of the domain
$$
k[x_{11}, x_{12}, \ldots, z_{21}, z_{22}, (x_{11}x_{22}-x_{12}x_{21})^{-1}
, (y_{11}y_{22}-y_{12}y_{21})^{-1}, (z_{11}z_{22}-z_{12}z_{21})^{-1}].
$$
Since the image of irreducible an algebraic set is still
irreducible, it suffices to classify the orbits of the set
$\{(X, Y)\in Mat(2, k)\times Mat(2, k)|XY = 0\}$ and take their
closures. From standard linear algebra, we are reduced to the
following three cases:
\begin{enumerate}
\item $\exists (g_1, g_2)$ such that $g_1Xg_2^{-1} = I_{2\times 2}$.
Then $Y$ is necessarily $0$, which as an algebraic set is
invariant under the group action. It follows that this orbit is
contained in the irreducible algebraic set defined by the prime
ideal $(y_{11}, y_{12}, y_{21}, y_{22})$. Taking the closure, we see
that $(y_{11}, y_{12}, y_{21}, y_{22})$ is actually a component.
\item $\exists (g_1, g_2)$ such that
$$
g_1Xg_2^{-1} = \left(
\begin{matrix}
1 & 0 \\
0 & 0
\end{matrix}
\right).
$$
This case occurs if and only if $X$ is a rank 1 matrix,
and furthermore, $Y$ is killed by such an $X$ if and only if
$$
x_{11}y_{11}+x_{12}y_{21} = 0; \quad x_{11}y_{12}+x_{12}y_{22} = 0;
$$
$$
x_{21}y_{11}+x_{22}y_{21} = 0; \quad x_{21}y_{12}+x_{22}y_{22} = 0.
$$
Fix a rank 1 $X$, such non zero $Y$'s satisfying the above
equations form an irreducible algebraic set for the following
reason($Y = 0$ is contained the the previous case):
$0 = g_1Xg_2^{-1}g_2Y$ implies that
$$
g_2Y = \left(
\begin{matrix}
0 & 0 \\
y_{21}' & y_{22}'
\end{matrix}
\right).
$$
With a further $GL(2, k)$-action on the right by $g_3$,
$g_2Y$ can be brought into
$$
g_2Yg_3^{-1} = \left(
\begin{matrix}
0 & 0 \\
0 & 1
\end{matrix}
\right),
$$
and thus such $Y$'s form an irreducible algebraic set
isomorphic to the image of $GL(2, k)$ under this action. Finally,
notice that the ``rank 1" condition for $X$'s forms an open dense
subset of the irreducible algebraic set
$\det X = x_{11}x_{22} - x_{12}x_{21} = 0$.
It now follows that all the five equations define an irreducible component
$(x_{11}y_{11}+x_{12}y_{21}, x_{11}y_{12}+x_{12}y_{22}, x_{21}y_{11}
+x_{22}y_{21}, x_{21}y_{12}+x_{22}y_{22}, x_{11}x_{22}-x_{12}x_{21})$,
in open subset of the space of pairs of nonzero matrices.
It can be shown that the pair of equations
$\det X = 0$, $\det Y = 0$ cuts $\text{Spec}(R)$ in an irreducible component
with the above locus an open dense subset.
\item $\exists (g_1, g_2)$ such that $g_1Xg_2^{-1} = 0$, or
equivalently, $X = 0$. Then $Y$ can be arbitrary and this component
is thus defined by $(x_{11}, x_{12}, x_{21}, x_{22})$.
\end{enumerate}
\end{example}


\begin{example}
\label{example-idempotent-matrices}
For another example, consider
$R = k[\{t_{ij}\}_{i, j = 1}^{n}]/\mathfrak a$, where $\mathfrak a$ is
the ideal generated by the entries of the product matrix $T^2-T$,
$T = (t_{ij})$. From linear algebra, we know that under the
$GL(n, k)$-action defined by $g, T \mapsto gTg^{-1}$, $T$ is
classified by the its rank and each $T$ is conjugate to some
$\text{diag}(1, \ldots, 1, 0, \ldots, 0)$, which has $r$ 1's and $n-r$ 0's.
Thus each orbit of such a $\text{diag}(1, \ldots, 1, 0, \ldots, 0)$ under the
group action forms an irreducible component and every idempotent
matrix is contained in one such orbit. Next we will show that any
two different orbits are necessarily disjoint. For this purpose we
only need to cook up polynomial functions that take different
values on different orbits. In characteristic 0 cases, such a
function can be taken to be
$f(t_{ij}) = trace(T) = \sum_{i = 1}^nt_{ii}$. In positive
characteristic cases, things are slightly more tricky since we
might have $trace(T) = 0$ even if $T \neq 0$. For instance, $char = 3$
$$
trace\left(
\begin{matrix}
1 & &\\
& 1 &\\
& & 1
\end{matrix}
\right) = 3 = 0
$$
Anyway, these components can be separated using other functions.
For instance, in the characteristic 3 case, $tr(\wedge^3T)$ takes
value 1 on the components corresponding to $diag(1, 1, 1)$ and 0 on
other components.
\end{example}





































\section{Finite and integral ring extensions}
\label{section-finite-ring-extensions}

\noindent
Trivial lemmas concerning finite and integral ring maps.
We recall the definition.

\begin{definition}
\label{definition-integral-ring-map}
Let $\varphi : R \to S$ be a ring map.
\begin{enumerate}
\item An element $s \in S$
is {\it integral over $R$} if there exists a monic
polynomial $P(x) \in R[x]$ such that
$P^\varphi(s) = 0$, where $P^\varphi(x) \in S[x]$
is the image of $P$ under $\varphi : R[x] \to S[x]$.
\item  The ring map $\varphi$ is {\it integral}
if every $s \in S$ is integral over $R$.
\end{enumerate}
\end{definition}

\begin{lemma}
\label{lemma-characterize-integral-element}
Let $\varphi : R \to S$ be a ring map. Let $y \in S$. If there exists a
finite $R$-submodule $M$ of $S$ such that $1 \in M$ and $yM \subset M$,
then $y$ is integral over $R$.
\end{lemma}

\begin{proof}
Let $x_1 = 1 \in M$ and $x_i \in M$, $i = 2, \ldots, n$ be a finite set of
elements generating $M$ as an $R$-module.
Write $yx_i = \sum \varphi(a_{ij}) x_j$
for some $a_{ij} \in R$. Let $P(T) \in R[T]$ be
the characteristic polynomial of the $n\times n$ matrix
$A = (a_{ij})$. By
Lemma \ref{lemma-charpoly}
we see $P(A) = 0$. By construction the map $\pi : R^n \to M$,
$(a_1, \ldots, a_n) \mapsto \sum \varphi(a_i) x_i$
commutes with $A : R^n \to R^n$ and multiplication by $y$. In a formula
$\pi(Av) = y\pi(v)$. Thus $P(y) = P(y) \cdot 1
= P(y) \cdot x_1 = P(y) \cdot \pi((1, 0, \ldots, 0))
= \pi(P(A)(1, 0, \ldots, 0)) = 0$.
\end{proof}

\begin{lemma}
\label{lemma-finite-is-integral}
A finite ring extension is integral.
\end{lemma}

\begin{proof}
Let $R \to S$ be finite. Let $y \in S$. Apply
Lemma \ref{lemma-characterize-integral-element}
to $M = S$ to see that $y$ is integral over $R$.
\end{proof}

\begin{lemma}
\label{lemma-characterize-integral}
Let $\varphi : R \to S$ be a ring map. Let $s_1, \ldots, s_n$
be a finite set of elements of $S$.
In this case $s_i$ is integral over $R$ for all $i = 1, \ldots, n$
if and only if
there exists an $R$-subalgebra $S' \subset S$ finite over $R$
containing all of the $s_i$.
\end{lemma}

\begin{proof}
If each $s_i$ is integral, then the subalgebra
generated by $\varphi(R)$ and the $s_i$ is finite
over $R$. Namely, if $s_i$ satisfies a monic equation
of degree $d_i$ over $R$, then this subalgebra is generated as an
$R$-module by the elements $s_1^{e_1} \ldots s_n^{e_n}$
with $0 \leq e_i \leq d_i - 1$.
Conversely, suppose given a finite $R$-subalgebra
$S'$ containing all the $s_i$. Then all of the
$s_i$ are integral by Lemma \ref{lemma-finite-is-integral}.
\end{proof}

\begin{lemma}
\label{lemma-characterize-finite-in-terms-of-integral}
Let $R \to S$ be a ring map. The following are equivalent
\begin{enumerate}
\item $R \to S$ is finite,
\item $R \to S$ is integral and of finite type, and
\item there exist $x_1, \ldots, x_n \in S$ which generate $S$ as an
algebra over $R$ such that each $x_i$ is integral over $R$.
\end{enumerate}
\end{lemma}

\begin{proof}
Clear from Lemma \ref{lemma-characterize-integral}.
\end{proof}

\begin{lemma}
\label{lemma-integral-transitive}
Suppose that $R \to S$ and $S \to T$ are integral
ring maps. Then $R \to T$ is integral.
\end{lemma}

\begin{proof}
Let $t \in T$. Let $P(x) \in S[x]$ be a
monic polynomial such that $P(t) = 0$.
Apply Lemma \ref{lemma-characterize-integral}
to the finite set of coefficients of $P$.
Hence $t$ is integral over some subalgebra
$S' \subset S$ finite over $R$. Apply Lemma
\ref{lemma-characterize-integral} again to find
a subalgebra $T' \subset T$ finite over $S'$ and
containing $t$. Lemma \ref{lemma-finite-transitive}
applied to $R \to S' \to T'$ shows that $T'$ is finite
over $R$. The integrality of $t$ over $R$
now follows from Lemma \ref{lemma-finite-is-integral}.
\end{proof}

\begin{lemma}
\label{lemma-integral-closure-is-ring}
Let $R \to S$ be a ring homomorphism.
The set
$$
S' = \{s \in S \mid s\text{ is integral over }R\}
$$
is an $R$-subalgebra of $S$.
\end{lemma}

\begin{proof}
This is clear from Lemmas \ref{lemma-characterize-integral}
and \ref{lemma-finite-is-integral}.
\end{proof}

\begin{definition}
\label{definition-integral-closure}
Let $R \to S$ be a ring map.
The ring $S' \subset S$ of elements integral over
$R$, see Lemma \ref{lemma-integral-closure-is-ring},
is called the {\it integral closure} of $R$
in $S$. If $R \subset S$ we say that $R$ is
{\it integrally closed} in $S$ if $R = S'$.
\end{definition}

\noindent
In particular, we see that $R \to S$ is integral if and only
if the integral closure of $R$ in $S$ is all of $S$.

\begin{lemma}
\label{lemma-integral-closure-localize}
Integral closure commutes with localization: If $A \to B$ is a ring
map, and $S \subset A$ is a multiplicative subset, then the integral
closure of $S^{-1}A$ in $S^{-1}B$ is $S^{-1}B'$, where $B' \subset B$
is the integral closure of $A$ in $B$.
\end{lemma}

\begin{proof}
Since localization is exact we see that $S^{-1}B' \subset S^{-1}B$.
Suppose $x \in B'$ and $f \in S$. Then
$x^d + \sum_{i = 1, \ldots, d} a_i x^{d - i} = 0$
in $B$ for some $a_i \in A$. Hence also
$$
(x/f)^d + \sum\nolimits_{i = 1, \ldots, d} a_i/f^i (x/f)^{d - i} = 0
$$
in $S^{-1}B$. In this way we see that $S^{-1}B'$ is contained in
the integral closure of $S^{-1}A$ in $S^{-1}B$. Conversely, suppose
that $x/f \in S^{-1}B$ is integral over $S^{-1}A$. Then we have
$$
(x/f)^d + \sum\nolimits_{i = 1, \ldots, d} (a_i/f_i) (x/f)^{d - i} = 0
$$
in $S^{-1}B$ for some $a_i \in A$ and $f_i \in S$. This means that
$$
(f'f_1 \ldots f_d x)^d +
\sum\nolimits_{i = 1, \ldots, d}
f^i(f')^if_1^i \ldots f_i^{i - 1} \ldots f_d^i a_i
(f'f_1 \ldots f_dx)^{d - i} = 0
$$
for a suitable $f' \in S$. Hence $f'f_1\ldots f_dx \in B'$ and thus
$x/f \in S^{-1}B'$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-integral-closure-stalks}
Let $\varphi : R \to S$ be a ring map.
Let $x \in S$. The following are equivalent:
\begin{enumerate}
\item $x$ is integral over $R$, and
\item for every $\mathfrak p \in R$ the element
$x \in S_{\mathfrak p}$ is integral over $R_{\mathfrak p}$.
\end{enumerate}
\end{lemma}

\begin{proof}
It is clear that (1) implies (2). Assume (1). Consider the $R$-algebra
$S' \subset S$ generated by $\varphi(R)$ and $x$. Let $\mathfrak p$ be
a prime ideal of $R$. Then we know that
$x^d + \sum_{i = 1, \ldots, d} \varphi(a_i) x^{d - i} = 0$
in $S_{\mathfrak p}$ for some $a_i \in R_{\mathfrak p}$. Hence we see,
by looking at which denominators occur, that
for some $f \in R$, $f \not \in \mathfrak p$ we have
$a_i \in R_f$ and
$x^d + \sum_{i = 1, \ldots, d} \varphi(a_i) x^{d - i} = 0$
in $S_f$. This implies that $S'_f$ is finite over $R_f$.
Since $\mathfrak p$ was arbitrary and $\text{Spec}(R)$ is quasi-compact
(Lemma \ref{lemma-quasicompact}) we can find finitely many elements
$f_1, \ldots, f_n \in R$
which generate the unit ideal of $R$ such that $S'_{f_i}$ is finite
over $R$. Hence we conclude from Lemma \ref{lemma-cover} that
$S'$ is finite over $R$. Hence $x$ is integral over $R$ by
Lemma \ref{lemma-characterize-integral}.
\end{proof}

\begin{lemma}
\label{lemma-base-change-integral}
Let $R \to S$ and $R \to R'$ be ring maps.
Set $S' = R' \otimes_R S$.
\begin{enumerate}
\item If $R \to S$ is integral so is $R' \to S'$.
\item If $R \to S$ is finite so is $R' \to S'$.
\end{enumerate}
\end{lemma}

\begin{proof}
We prove (1).
Let $s_i \in S$ be generators for $S$ over $R$.
Each of these satisfies a monic polynomial equation $P_i$
over $R$. Hence the elements $1 \otimes s_i \in S'$ generate
$S'$ over $R'$ and satisfy the corresponding polynomial
$P_i'$ over $R'$. Since these elements generate $S'$ over $R'$
we see that $S'$ is integral over $R'$.
Proof of (2) omitted.
\end{proof}

\begin{lemma}
\label{lemma-integral-local}
Let $R \to S$ be a ring map.
Let $f_1, \ldots, f_n \in R$ generate the unit ideal.
\begin{enumerate}
\item If each $R_{f_i} \to S_{f_i}$ is integral, so is $R \to S$.
\item If each $R_{f_i} \to S_{f_i}$ is finite, so is $R \to S$.
\end{enumerate}
\end{lemma}

\begin{proof}
Proof of (1).
Let $s \in S$. Consider the ideal $I \subset R[x]$ of
polynomials $P$ such that $P(s) = 0$. Let $J \subset R$
denote the ideal (!) of leading coefficients of elements of $I$.
By assumption and clearing denominators
we see that $f_i^{n_i} \in J$ for all $i$
and certain $n_i \geq 0$. Hence $J$ contains $1$ and we see
$s$ is integral over $R$. Proof of (2) omitted.
\end{proof}

\begin{lemma}
\label{lemma-integral-permanence}
Let $A \to B \to C$ be ring maps.
\begin{enumerate}
\item If $A \to C$ is integral so is $B \to C$.
\item If $A \to C$ is finite so is $B \to C$.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-integral-closure-transitive}
Let $A \to B \to C$ be ring maps.
Let $B'$ be the integral closure of $A$ in $B$,
let $C'$ be the integral closure of $B'$ in $C$. Then
$C'$ is the integral closure of $A$ in $C$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-integral-overring-surjective}
Suppose that $R \to S$ is an integral
ring extension with $R \subset S$.
Then $\varphi : \text{Spec}(S) \to \text{Spec}(R)$
is surjective.
\end{lemma}

\begin{proof}
Let $\mathfrak p \subset R$ be a prime ideal.
We have to show $\mathfrak pS \not = S$, see Lemma \ref{lemma-in-image}.
Suppose $1 = \sum f_i s_i$ with $f_i \in \mathfrak p$
and $s_i \in S$ in order to get a contradiction.
Let $R \subset S' \subset S$
be such that $R \to S'$ is finite and $s_i \in S$,
see Lemma \ref{lemma-characterize-integral}.
The equation $1 = \sum f_i s_i$ implies that
the finite $R_{\mathfrak p}$-module
$S'_{\mathfrak p}$ satisfies
$S'_{\mathfrak p} = \mathfrak pS'_{\mathfrak p}$
Hence by Nakayama's Lemma \ref{lemma-NAK}
we see $S'_{\mathfrak p} = 0$. On the other hand
$R_{\mathfrak p} \subset S'_{\mathfrak p}$ because localization
is exact. Contradiction.
\end{proof}

\begin{lemma}
\label{lemma-integral-under-field}
Let $R$ be a ring. Let $K$ be a field.
If $R \subset K$ and $K$ is integral over $R$,
then $R$ is a field and $K$ is an algebraic extension.
If $R \subset K$ and $K$ is finite over $R$,
then $R$ is a field and $K$ is a finite algebraic extension.
\end{lemma}

\begin{proof}
Assume that $R \subset K$ is integral.
By Lemma \ref{lemma-integral-overring-surjective} above we see that
$\text{Spec}(R)$ has $1$ point. Since clearly $R$ is a domain we see
that $R = R_{(0)}$ is a field. The other assertions are immediate
from this.
\end{proof}

\begin{lemma}
\label{lemma-integral-over-field}
Let $k$ be a field. Let $S$ be a $k$-algebra over $k$.
\begin{enumerate}
\item If $S$ is a domain and finite dimensional over $k$,
then $S$ is a field.
\item If $S$ is integral over $k$ and a domain,
then $S$ is a field.
\item If $S$ is integral over $k$ then every prime of
$S$ is a maximal ideal (see
Lemma \ref{lemma-ring-with-only-minimal-primes}
for more consequences).
\end{enumerate}
\end{lemma}

\begin{proof}
The statement on primes follows from the statement
``integral $+$ domain $\Rightarrow$ field''.
Let $S$ integral over $k$ and assume $S$ is a domain,
Take $s \in S$. By Lemma
\ref{lemma-characterize-integral} we may find a
finite dimensional $k$-subalgebra $k \subset S' \subset S$.
containing $s$. Hence $S$ is a field if we can prove the
first statement. Assume $S$ finite dimensional
over $k$ and a domain. Pick $s\in S$.
Since $S$ is a domain the multiplication
map $s : S \to S$ is surjective by dimension
reasons. Hence there exists an element $s_1 \in S$
such that $ss_1 = 1$. So $S$ is a field.
\end{proof}

\begin{lemma}
\label{lemma-integral-no-inclusion}
Suppose $R \to S$ is integral.
Let $\mathfrak q, \mathfrak q' \in \text{Spec}(S)$
be distinct primes
having the same image in $\text{Spec}(R)$.
Then neither $\mathfrak q \subset \mathfrak q'$
nor $\mathfrak q' \subset \mathfrak q$.
\end{lemma}

\begin{proof}
Let $\mathfrak p \subset R$ be the image.
By Remark \ref{remark-fundamental-diagram}
the primes $\mathfrak q, \mathfrak q'$
correspond to ideals in
$S \otimes_R \kappa(\mathfrak p)$.
Thus the lemma follows from Lemma \ref{lemma-integral-over-field}.
\end{proof}

\begin{lemma}
\label{lemma-integral-going-up}
Let $R \to S$ be a ring map such that
$S$ is integral over $R$.
Let $\mathfrak p \subset \mathfrak p' \subset R$
be primes. Let $\mathfrak q$ be a prime of $S$ mapping
to $\mathfrak p$. Then there exists a prime $\mathfrak q'$
with $\mathfrak q \subset \mathfrak q'$
mapping to $\mathfrak p'$.
\end{lemma}

\begin{proof}
We may replace $R$ by $R/\mathfrak p$ and $S$ by $S/\mathfrak q$.
This reduces us to the situation of having an integral
extension of domains $R \subset S$ and a prime $\mathfrak p' \subset R$.
By Lemma \ref{lemma-integral-overring-surjective} we win.
\end{proof}

\noindent
The property expressed in the lemma above is called
the ``going up property'' for the ring map $R \to S$,
see Definition \ref{definition-going-up-down}.

\begin{lemma}
\label{lemma-silly-normal}
Let $R$ be a ring. Let $x, y \in R$ be nonzero divisors.
Let $R[x/y] \subset R_{xy}$ be the $R$-subalgebra generated
by $x/y$, and similarly for the subalgebras $R[y/x]$ and $R[x/y, y/x]$.
If $R$ is integrally closed in $R_x$ or $R_y$, then the sequence
$$
0 \to R \xrightarrow{(-1, 1)} R[x/y] \oplus R[y/x] \xrightarrow{(1, 1)}
R[x/y, y/x] \to 0
$$
is a short exact sequence of $R$-modules.
\end{lemma}

\begin{proof}
Since $x/y \cdot y/x = 1$ it is clear that the map
$R[x/y] \oplus R[y/x] \to R[x/y, y/x]$ is surjective.
Let $\alpha \in R[x/y] \cap R[y/x]$. To show exactness in the middle
we have to prove that $\alpha \in R$. By assumption we may write
$$
\alpha = a_0 + a_1 x/y + \ldots + a_n (x/y)^n =
b_0 + b_1 y/x + \ldots + b_m(y/x)^m
$$
for some $n, m \geq 0$ and $a_i, b_j \in R$.
Pick some $N > \max(n, m)$.
Consider the finite $R$-submodule $M$ of $R_{xy}$ generated by the elements
$$
(x/y)^N, (x/y)^{N - 1}, \ldots, x/y, 1, y/x, \ldots, (y/x)^{N - 1}, (y/x)^N
$$
We claim that $\alpha M \subset M$. Namely, it is clear that
$(x/y)^i (b_0 + b_1 y/x + \ldots + b_m(y/x)^m) \in M$ for
$0 \leq i \leq N$ and that
$(y/x)^i (a_0 + a_1 x/y + \ldots + a_n(x/y)^n) \in M$ for
$0 \leq i \leq N$. Hence $\alpha$ is integral over $R$ by
Lemma \ref{lemma-characterize-integral-element}. Note that
$\alpha \in R_x$, so if $R$ is integrally closed in $R_x$
then $\alpha \in R$ as desired.
\end{proof}







\section{Normal rings}
\label{section-normal-rings}

\noindent
We first introduce the notion of a normal domain, and then we
introduce the (very general) notion of a normal ring.

\begin{definition}
\label{definition-domain-normal}
A domain $R$ is called {\it normal} if it is integrally
closed in its field of fractions.
\end{definition}

\begin{lemma}
\label{lemma-integral-closure-in-normal}
Let $R \to S$ be a ring map.
If $S$ is a normal domain, then the integral closure of $R$
in $S$ is a normal domain.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\noindent
The following notion is occasionally useful when
studying normality.

\begin{definition}
\label{definition-almost-integral}
Let $R$ be a domain.
\begin{enumerate}
\item An element $g$ of the fraction
field of $R$ is called {\it almost integral over $R$}
if there exists an element $r \in R$, $r\not = 0$
such that $rg^n \in R$ for all $n \geq 0$.
\item The domain $R$ is called {\it completely normal} if every
almost integral element of the fraction field of $R$ is
contained in $R$.
\end{enumerate}
\end{definition}

\noindent
The following lemma shows that a Noetherian domain is normal
if and only if it is completely normal.

\begin{lemma}
\label{lemma-almost-integral}
Let $R$ be a domain with fraction field $K$.
If $u, v \in K$ are almost integral over $R$, then so are
$u + v$ and $uv$. Any element $g \in K$ which is integral over $R$
is almost integral over $R$. If $R$ is Noetherian
then the converse holds as well.
\end{lemma}

\begin{proof}
If $ru^n \in R$ for all $n \geq 0$ and
$v^nr' \in R$ for all $n \geq 0$, then
$(uv)^nrr'$ and $(u + v)^nrr'$ are in $R$ for
all $n \geq 0$. Hence the first assertion.
Suppose $g \in K$ is integral over $R$.
In this case there exists an $d > 0$ such that
the ring $R[g]$ is generated by $1, g, \ldots, g^d$ as an $R$-module.
Let $r \in R$ be a common denominator of the elements
$1, g, \ldots, g^d \in K$. It is follows that $rR[g] \subset R$,
and hence $g$ is almost integral over $R$.

\medskip\noindent
Suppose $R$ is Noetherian and $g \in K$ is almost integral over $R$.
Let $r \in R$, $r\not= 0$ be as in the definition.
Then $R[g] \subset \frac{1}{r}R$ as an $R$-module.
Since $R$ is Noetherian this implies that $R[g]$ is
finite over $R$. Hence $g$ is integral over $R$, see
Lemma \ref{lemma-finite-is-integral}.
\end{proof}

\begin{lemma}
\label{lemma-localize-normal-domain}
Any localization of a normal domain is normal.
\end{lemma}

\begin{proof}
Let $R$ be a normal domain, and let $S \subset R$ be
a multiplicative subset. Suppose $g$ is an element
of the fraction field of $R$ which is integral over $S^{-1}R$.
Let $P = x^d + \sum_{j < d} a_j x^j$ be a polynomial
with $a_i \in S^{-1}R$ such that $P(g) = 0$.
Choose $s \in S$ such that $sa_i \in R$ for all $i$.
Then $sg$ satisfies the monic polynomial
$x^d + \sum_{j < d} s^{d-j}a_j x^j$ which has coefficients
$s^{d-j}a_j$ in $R$. Hence $sg \in R$ because $R$ is normal.
Hence $g \in S^{-1}R$.
\end{proof}

\begin{lemma}
\label{lemma-PID-normal}
A principal ideal domain is normal.
\end{lemma}

\begin{proof}
Let $R$ be a principal ideal domain.
Let $g = a/b$ be an element of the fraction field
of $R$ integral over $R$. Because $R$ is a principal ideal domain
we may divide out a common factor of $a$ and $b$
and assume $(a, b) = R$. In this case, any equation
$(a/b)^n + r_{n-1} (a/b)^{n-1} + \ldots + r_0 = 0$
with $r_i \in R$ would imply $a^n \in (b)$. This
contradicts $(a, b) = R$ unless $b$ is a unit in $R$.
\end{proof}

\begin{lemma}
\label{lemma-prepare-polynomial-ring-normal}
Let $R$ be a domain with fraction field $K$.
Suppose $f = \sum \alpha_i x^i$ is an
element of $K[x]$.
\begin{enumerate}
\item If $f$ is integral over $R[x]$
then all $\alpha_i$ are integral over $R[x]$, and
\item If $f$ is almost integral over $R[x]$
then all $\alpha_i$ are almost integral over $R[x]$.
\end{enumerate}
\end{lemma}

\begin{proof}
We first prove the second statement.
Write $f = \alpha_d x^d + \ldots + \alpha_r x^r$
with $\alpha_r \not = 0$.
By assumption there exists $h = b_d x^d + \ldots + b_s x^s \in R[x]$,
$b_s \not= 0$ such that $f^n h \in R[x]$ for all
$n \geq 0$. This implies that $b_s \alpha_r^n \in R$
for all $n \geq 0$. Hence $\alpha_r$ is almost
integral over $R$. Since the set of almost integral
elements form a subring we deduce that
$f - \alpha_r x^r = \alpha_d x^d + \ldots + \alpha_{r-1} x^{r-1}$
is almost integral over $R[x]$. By induction on $d-r$ we win.

\medskip\noindent
In order to prove the first statement we will use absolute Noetherian
reduction. Namely, write $\alpha_i = a_i / b_i$ and
let $P(t) = t^d + \sum_{j < d} f_j t^j$ be a polynomial
with coefficients $f_j \in R[x]$ such that $P(g) = 0$.
Let $f_j = \sum f_{ji}x^i$. Consider the subring
$R_0 \subset R$ generated by the finite list of elements
$a_i, b_i, f_{ji}$ of $R$. It is a domain; let
$K_0$ be its field of fractions. Since $R_0$ is a finite type
$\mathbf{Z}$-algebra it is Noetherian, see
Lemma \ref{lemma-obvious-Noetherian}. It is still
the case that $g \in K_0[x]$ is integral over $R_0[x]$,
because all the identities in $R$
among the elements $a_i, b_i, f_{ji}$ also hold in $R_0$.
By Lemma \ref{lemma-almost-integral} the element
$g$ is almost integral over $R_0[x]$. By the first part of
the lemma, the elements $\alpha_i$ are almost integral
over $R_0$. And since $R_0$ is Noetherian, the are
integral over $R_0$, see Lemma \ref{lemma-almost-integral}.
Of course, then they are integral over $R$.
\end{proof}

\begin{lemma}
\label{lemma-polynomial-domain-normal}
Let $R$ be a normal domain.
Then $R[x]$ is a normal domain.
\end{lemma}

\begin{proof}
The result is true if $R$ is a field $K$ because
$K[x]$ is a euclidean domain and hence a principal ideal
domain and hence normal by Lemma \ref{lemma-PID-normal}.
Let $g$ be an element of the fraction field of
$R[x]$ which is integral over $R[x]$. Because $g$
is integral over $K[x]$ where $K$ is the fraction
field of $R$ we may write $g = \alpha_d x^d + \alpha_{d-1}x^{d-1} +
\ldots + \alpha_0$ with $\alpha_i \in K$.
By Lemma \ref{lemma-prepare-polynomial-ring-normal}
the elements $\alpha_i$ are integral over $R$ and
hence are in $R$.
\end{proof}

\begin{lemma}
\label{lemma-normality-is-local}
Let $R$ be a domain. The following are equivalent:
\begin{enumerate}
\item The domain $R$ is a normal domain,
\item for every prime $\mathfrak p \subset R$ the local ring
$R_{\mathfrak p}$ is a normal domain, and
\item for every maximal ideal $\mathfrak m$ the ring $R_{\mathfrak m}$
is a normal domain.
\end{enumerate}
\end{lemma}

\begin{proof}
This follows easily from the fact that for any domain $R$ we have
$$
R = \bigcap\nolimits_{\mathfrak m} R_{\mathfrak m}
$$
inside the fraction field of $R$. Namely, if $g$ is an element of
the right hand side then the ideal $I = \{x \in R \mid xg \in R\}$
is not contained in any maximal ideal $\mathfrak m$, whence $I = R$.
\end{proof}

\noindent
Lemma \ref{lemma-normality-is-local} shows that the following definition
is compatible with Definition \ref{definition-domain-normal}. (It is the
definition from EGA -- see \cite[IV, 5.13.5 and 0, 4.1.4]{EGA}.)

\begin{definition}
\label{definition-ring-normal}
A ring $R$ is called {\it normal} if for every prime
$\mathfrak p \subset R$ the localization $R_{\mathfrak p}$ is
a normal domain (see Definition \ref{definition-domain-normal}).
\end{definition}

\noindent
Note that a normal ring is a reduced ring, as $R$ is a subring of the product
of its localizations at all primes (see for example
Lemma \ref{lemma-characterize-zero-local}).

\begin{lemma}
\label{lemma-normal-ring-integrally-closed}
A normal ring is integrally closed in its total ring of fractions.
\end{lemma}

\begin{proof}
Let $R$ be a normal ring.
Let $R' \subset Q(R)$ be the integral closure of $R$ in its
total ring of fractions. Let $\mathfrak p \subset R$ be a prime.
There is a canonical map $c_{\mathfrak p} : Q(R) \to Q(R_{\mathfrak p})$.
Since $R_{\mathfrak p}$ is a normal domain we see that
$R_{\mathfrak p}$ is equal to its integral closure in $Q(R_{\mathfrak p})$.
Hence $R' \subset \bigcap_{\mathfrak p} c_{\mathfrak p}^{-1}(R_{\mathfrak p})$
intersection in $Q(R)$. This implies $R' = R$ by the argument of
the proof of Lemma \ref{lemma-normality-is-local}.
\end{proof}

\begin{lemma}
\label{lemma-localization-normal-ring}
A localization of a normal ring is a normal ring.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-polynomial-ring-normal}
Let $R$ be a normal ring. Then $R[x]$ is a normal ring.
\end{lemma}

\begin{proof}
Let $\mathfrak q$ be a prime of $R[x]$. Set $\mathfrak p = R \cap \mathfrak q$.
Then we see that $R_{\mathfrak p}[x]$ is a normal domain by
Lemma \ref{lemma-polynomial-domain-normal}.
Hence $(R[x])_{\mathfrak q}$ is a normal domain by
Lemma \ref{lemma-localize-normal-domain}.
\end{proof}

\begin{lemma}
\label{lemma-characterize-reduced-ring-normal}
Let $R$ be a ring. Assume $R$ is reduced and has finitely many
minimal primes. Then the following are equivalent:
\begin{enumerate}
\item $R$ is a normal ring,
\item $R$ is integrally closed in its total ring of fractions, and
\item $R$ is a finite product of normal domains.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $\mathfrak q_1, \ldots, \mathfrak q_t$ be the minimal primes of $R$.
By Lemma \ref{lemma-total-ring-fractions-no-embedded-points} we have
$Q(R) = R_{\mathfrak q_1} \times \ldots \times R_{\mathfrak q_t}$, and
by Lemma \ref{lemma-minimal-prime-reduced-ring} each factor is a field.
Denote $e_i = (0, \ldots, 0, 1, 0, \ldots, 0)$ the $i$th idempotent
of $Q(R)$.

\medskip\noindent
If $R$ is integrally closed in $Q(R)$, then it contains in particular
the idempotents $e_i$, and we see
that $R$ is a product of $t$ domains (see
Sections \ref{section-connected-components} and
\ref{section-tilde-module-sheaf}). Hence it is clear that $R$ is
a finite product of normal domains.

\medskip\noindent
If $R$ is normal, then it is clear that $e_i \in R_{\mathfrak p}$
for every prime ideal $\mathfrak p$ of $R$. Hence we see that $R$
contains the elements $e_i$ (see proof of
Lemma \ref{lemma-normality-is-local}). We conclude
that $R$ is a product of $t$ domains as before. 
Each of these $t$ domains is normal by Lemma \ref{lemma-normality-is-local}
and the assumption that $R$ is a normal ring.
Hence it follows that $R$ is a finite product of normal domains.

\medskip\noindent
We omit the verification that (3) implies (1) and (2).
\end{proof}

\begin{lemma}
\label{lemma-colimit-normal-ring}
Let $(R_i, \varphi_{ii'})$ be a directed system
(Categories, Definition \ref{definition-directed-system})
of rings. If each $R_i$ is a normal ring so is
$R = \text{colim}_i\ R_i$.
\end{lemma}

\begin{proof}
Let $\mathfrak p \subset R$ be a prime ideal.
Set $\mathfrak p_i = R_i \cap \mathfrak p$ (usual abuse of notation).
Then we see that
$R_{\mathfrak p} = \text{colim}_i\ (R_i)_{\mathfrak p_i}$.
Since each $(R_i)_{\mathfrak p_i}$ is a normal domain we
reduce to proving the statement of the lemma for normal
domains. If $a, b \in R$ and $a/b$ satisfies a monic polynomial
$P(T) \in R[T]$, then we can find a (sufficiently large) $i \in I$
such that $a, b, P$ all come from objects $a_i, b_i, P_i$ over $R_i$.
Since $R_i$ is normal we see $a_i/b_i \in R_i$ and hence also
$a/b \in R$.
\end{proof}







\section{Going down for integral over normal}
\label{section-going-down-integral-over-normal}

\noindent
We first play around a little bit with the notion of elements
integral over an ideal, and then we prove the theorem referred
to in the section title.

\begin{definition}
\label{definition-integral-over-ideal}
Let $\varphi : R \to S$ be a ring map.
Let $I \subset R$ be an ideal.
We say an element $g \in S$ is
{\it integral over $I$} if
there exists a monic
polynomial $P = x^d + \sum_{j < d} a_j x^j$
with coefficients $a_j \in I^{d-j}$ such
that $P^\varphi(g) = 0$ in $S$.
\end{definition}

\noindent
This is mostly used when $\varphi = \text{id}_R : R \to R$.
In this case the set $I'$ of elements integral over $I$ is called
the {\it integral closure of $I$}. We will see that $I'$ is
an ideal of $R$ (and of course $I \subset I'$).

\begin{lemma}
\label{lemma-characterize-integral-ideal}
Let $\varphi : R \to S$ be a ring map.
Let $I \subset R$ be an ideal.
Let $A = \sum I^nt^n \subset R[t]$ be the
subring of the polynomial ring
generated by $R \oplus It \subset R[t]$.
An element $s \in S$ is integral over $I$ if
and only if the element $st \in S[t]$
is integral over $A$.
\end{lemma}

\begin{proof}
Suppose $st$ is integral over $A$.
Let $P = x^d + \sum_{j < d} a_j x^j$
be a monic polynomial with coefficients in $A$
such that $P^\varphi(st) = 0$. Let $a_j' \in A$
be the degree $d-j$ part of $a_i$, in other
words $a_j' = a_j'' t^{d-j}$ with $a_j'' \in I^{d-j}$.
For degree reasons we still have
$(st)^d + \sum_{j < d} \varphi(a_j'') t^{d-j} (st)^j = 0$.
Hence we see that $s$ is integral over $I$.

\medskip\noindent
Suppose that $s$ is integral over $I$.
Say $P = x^d + \sum_{j < d} a_j x^j$
with $a_j \in I^{d-j}$. The we immediately find a
polynomial $Q = x^d + \sum_{j < d} (a_j t^{d-j}) x^j$
with coefficients in $A$ which proves that
$st$ is integral over $A$.
\end{proof}

\begin{lemma}
\label{lemma-integral-over-ideal-is-submodule}
Let $\varphi : R \to S$ be a ring map.
Let $I \subset R$ be an ideal.
The set of elements of $S$ which are integral
over $I$ form a $R$-submodule of $S$.
Furthermore, if $s \in S$ is integral over
$R$, and $s'$ is integral over $I$, then
$ss'$ is integral over $I$.
\end{lemma}

\begin{proof}
Closure under addition is clear from the
characterization of Lemma \ref{lemma-characterize-integral-ideal}.
Any element $s \in S$ which is integral over
$R$ corresponds to the degree $0$ element $s$ of $S[x]$
which is integral over $A$ (because $R \subset A$).
Hence we see that multiplication by $s$ on $S[x]$
preserves the property of being integral over $A$,
by Lemma \ref{lemma-integral-closure-is-ring}.
\end{proof}

\begin{lemma}
\label{lemma-integral-integral-over-ideal}
Suppose $\varphi : R \to S$ is integral.
Suppose $I \subset R$ is an ideal.
Then every element of $IS$ is integral over $I$.
\end{lemma}

\begin{proof}
Immediate from Lemma \ref{lemma-integral-over-ideal-is-submodule}.
\end{proof}

\begin{lemma}
\label{lemma-polynomials-divide}
Let $R$ be a domain with field of fractions $K$.
Let $n, m \in \mathbf{N}$ and
$a_0, \ldots, a_{n-1}, b_0, \ldots, b_{m-1} \in R$.
If the polynomial $x^n + a_{n-1}x^{n-1} + \ldots + a_0$
divides the polynomial $x^m + b_{m-1} x^{m-1} + \ldots + b_0$
in $K[x]$ then
\begin{enumerate}
\item $a_0, \ldots, a_{n-1}$ are integral over the subring
of $R$ generated by $b_0, \ldots, b_{m-1}$, and
\item each $a_i$ lies in $\sqrt{(b_0, \ldots, b_m)}$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $K \supset R$ be the fraction field of $R$.
Let $L \supset K$ be a field extension such that
we can write $x^m + b_{m-1} x^{m-1} + \ldots + b_0 =
\prod_{i = 1}^m (x-\beta_i)$ with $\beta_i \in L$.
Each $\beta_i$ is integral over the subring generated
by $b_0, \ldots, b_{m-1}$. Since each $a_i$ is a
homogeneous polynomial in $\beta_1, \ldots, \beta_m$
we deduce the same for the $a_i$.

\medskip\noindent
Choose $c_0, \ldots, c_{m-n-1} \in K$ such that
$$
\begin{matrix}
x^m + b_{m-1} x^{m-1} + \ldots + b_0 =  \\
(x^n + a_{n-1}x^{n-1} + \ldots + a_0)
(x^{m-n} + c_{m-n-1}x^{m-n-1}+ \ldots + c_0).
\end{matrix}
$$
By the first part we see that the elements $c_i$
are integral over $R$. Let $R'$ be the sub $R$-algebra
of $K$ generated by $c_0, \ldots, c_{m-n-1}$.
By Lemmas \ref{lemma-integral-overring-surjective}
and \ref{lemma-surjective-spec-radical-ideal}
we see that $R \cap \sqrt{(b_0, \ldots, b_m)R'}
= \sqrt{(b_0, \ldots, b_m)}$. Thus we may replace
$R$ by $R'$ and assume $c_i \in R$.
Dividing out the radical $\sqrt{(b_0, \ldots, b_m)}$
we get a reduced ring $\overline{R}$.
We have to show that the images $\overline{a_i} \in \overline{R}$
are zero. And in
$\overline{R}[x]$ we have the relation
$$
\begin{matrix}
x^m = x^m + \overline{b_{m-1}} x^{m-1} + \ldots + \overline{b_0} = \\
(x^n + \overline{a_{n-1}}x^{n-1} + \ldots + \overline{a_0})
(x^{m-n} + \overline{c_{m-n-1}}x^{m-n-1}+ \ldots + \overline{c_0}).
\end{matrix}
$$
It is easy to see that this implies $\overline{a_i} = 0$ for all $i$.
For example one can see this by localizing at all the minimal
primes, see Lemma \ref{lemma-reduced-ring-sub-product-fields}.
\end{proof}

\begin{lemma}
\label{lemma-minimal-polynomial-normal-domain}
Let $R \subset S$ be an inclusion of domains.
Assume $R$ is normal. Let $g \in S$ be integral
over $R$. Then the minimal polynomial of $g$
has coefficients in $R$.
\end{lemma}

\begin{proof}
Let $P = x^m + b_{m-1} x^{m-1} + \ldots + b_0$
be a polynomial with coefficients in $R$
such that $P(g) = 0$. Let $Q = x^n + a_{n-1}x^{n-1} + \ldots + a_0$
be the minimal polynomial for $g$ over the fraction field
$K$ of $R$. Then $Q$ divides $P$ in $K[x]$. By Lemma
\ref{lemma-polynomials-divide} we see the $a_i$ are
integral over $R$. Since $R$ is normal this
means they are in $R$.
\end{proof}

\begin{proposition}
\label{proposition-going-down-normal-integral}
Let $R \subset S$ be an inclusion of domains.
Assume $R$ is normal and $S$ integral over $R$.
Let $\mathfrak p \subset \mathfrak p' \subset R$
be primes. Let $\mathfrak q'$ be a prime of $S$
with $\mathfrak p' = R \cap \mathfrak q'$.
Then there exists a prime $\mathfrak q$
with $\mathfrak q \subset \mathfrak q'$
such that $\mathfrak p = R \cap \mathfrak q$. In other words:
the going down property holds for $R \to S$, see
Definition \ref{definition-going-up-down}.
\end{proposition}

\begin{proof}
Let $\mathfrak p$, $\mathfrak p'$ and $\mathfrak q'$
be as in the statement. We have to show there is a prime
$\mathfrak q$, $\mathfrak q \subset \mathfrak q'$ such that
$R \cap \mathfrak q = \mathfrak p$. This is the same
as finding a prime of
$S_{\mathfrak q'}$ mapping to $\mathfrak p$.
According to Lemma \ref{lemma-in-image} we have to show
that $\mathfrak p S_{\mathfrak q'} \cap R
= \mathfrak p$. Pick $z \in \mathfrak p S_{\mathfrak q'} \cap R$.
We may write $z = y/g$ with $y \in \mathfrak pS$ and
$g \in S$, $g \not\in \mathfrak q'$. Written
differently we have $zg = y$.

\medskip\noindent
By Lemma \ref{lemma-integral-integral-over-ideal}
there exists a monic polynomial
$P = x^m + b_{m-1} x^{m-1} + \ldots + b_0$
with $b_i \in \mathfrak p$ such that $P(y) = 0$.

\medskip\noindent
By Lemma \ref{lemma-minimal-polynomial-normal-domain}
the minimal polynomial of $g$ over $K$ has coefficients
in $R$. Write it as $Q = x^n + a_{n-1} x^{n-1} + \ldots
+ a_0$. Note that not all $a_i$, $i = n-1, \ldots, 0$
are in $\mathfrak p$ since that would imply
$g^n = \sum_{j < n} a_j g^j \in \mathfrak pS
\subset \mathfrak p'S
\subset \mathfrak q'$
which is a contradiction.

\medskip\noindent
Since $y = zg$ we see immediately from the above
that $Q' = x^n + za_{n-1} x^{n-1} + \ldots + z^{n}a_0$
is the minimal polynomial for $y$. Hence
$Q'$ divides $P$ and by Lemma \ref{lemma-polynomials-divide}
we see that $z^ja_{n - j} \in \sqrt{(b_0, \ldots, b_{m-1})}
\subset \mathfrak p$, $j =  1, \ldots, n$.
Because not all $a_i$, $i = n-1, \ldots, 0$
are in $\mathfrak p$ we conclude $z \in \mathfrak p$
as desired.
\end{proof}














\section{Flat modules and flat ring maps}
\label{section-flat}

\noindent
One often used result is that if $M = \text{colim}_{i\in \mathcal{I}}\ M_i$
is a colimit of $R$-modules and if $N$ is another then
$$
M \otimes N
=
\text{colim}_{i\in \mathcal{I}}\ M_i \otimes_R N.
$$
This follows almost immediately from the universal
property of colimits and the universal property of
the tensor product in terms of bilinear maps.
This property is usually expressed by saying
that {\it $\otimes$ commutes with colimits}.

\medskip\noindent
Another often used result is that if $0 \to N_1 \to N_2 \to N_3 \to 0$
is an exact sequence and if $M$ is any $R$-module, then
$$
M\otimes_R N_1
\to
M\otimes_R N_2
\to
M\otimes_R N_3
\to
0
$$
is still exact. Again this follows almost immediately from
the interpretation of the tensor product in terms of
bilinear maps. Of course this property is usually expressed
by saying that {\it $-\otimes_R M$ is right exact}.

\medskip\noindent
Let $M$ be an $R$-module. Let $x_i$, $i = 1, \ldots, n$ be elements
of $M$. Let $f_i \in R$ be elements such that $\sum f_i x_i = 0$
in $M$. We say the elements $f_i$ give a {\it relation}
among the elements $x_i$.

\begin{lemma}
\label{lemma-module-colimit-fp}
Let $R$ be a ring and let $M$ be an $R$-module.
Then $M$ is the colimit of a directed system
$(I, \geq)$, $(M_i, f_{ii'})$ of $R$-modules
with all $M_i$ finitely presented $R$-modules.
\end{lemma}

\begin{proof}
Consider any finite subset $S \subset M$ and any finite
collection of relations $E$ among the elements
of $S$. So each $s \in S$ corresponds to $x_s \in M$ and
each $e \in E$ consists of a vector
of elements $f_{e, s} \in R$ such that $\sum f_{e, s} x_s = 0$.
Let $M_{S, E}$ be the cokernel of the map
$$
R^{\# E}
\longrightarrow
R^{\# S}, \ \ 
(g_e)_{e\in E}
\longmapsto
(\sum g_e f_{e, s})_{s\in S}.
$$
There are canonical maps $M_{S, E} \to M$.
If $S \subset S'$ and if the elements of
$E$ correspond, via this map, to relations
in $E'$, then there is an obvious map
$M_{S, E} \to M_{S', E'}$ commuting with the
maps to $M$. Let $I$ be the set of pairs
$(S, E)$ with ordering by inclusion as above.
It is clear that the colimit of this directed system is $M$.
\end{proof}

\begin{definition}
\label{definition-flat}
Let $R$ be a ring.
\begin{enumerate}
\item An $R$-module $M$ is called {\it flat} if whenever
$N_1 \to N_2 \to N_3$ is an exact sequence of $R$-modules
the sequence $M\otimes_R N_1 \to M\otimes_R N_1 \to M\otimes_R N_1$
is exact as well.
\item An $R$-module $M$ is called {\it faithfully flat} if the
complex of $R$-modules
$N_1 \to N_2 \to N_3$ is exact if and only if
the sequence $M\otimes_R N_1 \to M\otimes_R N_1 \to M\otimes_R N_1$
is exact.
\item A ring map $R \to S$ is called {\it flat} if
$S$ is flat as an $R$-module.
\item A ring map $R \to S$ is called {\it faithfully flat} if
$S$ is faithfully flat as an $R$-module.
\end{enumerate}
\end{definition}

\begin{lemma}
\label{lemma-composition-flat}
A composition of (faithfully) flat ring maps is
(faithfully) flat. If $R \to R'$ is flat, and $M'$ is a flat
$R'$-module, then $M'$ is a flat $R$-module.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-flat}
Let $M$ be an $R$-module. The following are equivalent:
\begin{enumerate}
\item $M$ is flat over $R$.
\label{item-flat}
\item for every injection of $R$-modules $N \subset N'$
the map $N\otimes_R M \to N'\otimes_R M$ is injective.
\label{item-injective}
\item for every ideal $I \subset R$ the map
$I\otimes_R M \to R\otimes_R M = M$ is injective.
\label{item-f-ideal}
\item for every finitely generated ideal $I \subset R$
the map $I\otimes_R M \to R\otimes_R M = M$ is injective.
\label{item-ffg-ideal}
\end{enumerate}
\end{lemma}

\begin{proof}
The implications (\ref{item-flat}) implies (\ref{item-injective})
implies (\ref{item-f-ideal}) implies (\ref{item-ffg-ideal}) are all
trivial. Thus we prove (\ref{item-ffg-ideal}) implies (\ref{item-flat}).
Suppose that $N_1 \to N_2 \to N_3$ is exact.
Let $K_2 = \text{Ker}(N_2 \to N_3)$.
It is clear that the surjection $N_1 \to K$
induces a surjection $N_1 \otimes_R M \to K_2\otimes_R M$.
Hence it suffices to show $K_2\otimes_R M \to N_2\otimes_R M$
is injective.

\medskip\noindent
Let $x \in \text{Ker}(K_2\otimes_R M \to N_2\otimes_R M)$.
We have to show that $x$ is zero.
Write $x = \sum_{i = 1, \ldots, r} k_i \otimes m_i$. By
Lemma \ref{lemma-module-colimit-fp}
we can find a finitely generated module $N$,
a map $N \to N_2$, and elements $n_i \in N$, $i = 1, \ldots, r$ such that
(a) $n_i$ maps to $k_i$, (b) the element $y = \sum_i n_i \otimes m_i$
maps to zero in $N \otimes_R M$. Let $K \subset N$
be the submodule generated by the $n_i$. It suffices to show that
$y$ is zero as an element of $K' \otimes_R M$.

\medskip\noindent
We do this by induction on the minimal number of generators of
$N$. If this number is $>1$ then we can find a short exact
sequence
$0 \to N' \to N \to N'' \to 0$
such that $N'$ and $N''$ are finitely generated with a smaller
number of generators. By induction the element $y$ maps
to zero in $K'' \otimes_R M$ with $K''$ the image of $K$
in $N''$. And by the right exactness of $\otimes$ we see
that $y$ comes from some element of $K' \otimes_R M$
where $K'$ is the intersection of $K$ with $N'$. Again
by induction we see that $y' = 0$.

\medskip\noindent
The base case of the induction above is when
$N$ is generated by $1$ element. In other words
$N = R/I$, and then $y = \sum g_i \otimes m_i$,
Let $J = (g_1, \ldots, g_r) \subset R$.
By right exactness, we see that $R/I \otimes_R M
= M/IM$. Our assumption is that $y$ is zero
in $R/I \otimes_R M = M/IM$ in other words
$\sum g_im_i \in IM$, in other words
$\sum g_im_i = \sum h_j m'_j$ for suitable
$h_j \in I$. We may replace $I$ by the finitely
generated ideal $(h_j)$ without modifying the assumptions.
In this case we have $K = J + I/I$
$$
K\otimes_R M
=
(J + I)\otimes_R M /I\otimes_R M
=
(J + I)M / IM
$$
the first equality by right exactness
and the second by assumption on $M$.
Thus $y$ is zero in $K\otimes_RM$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-flat-base-change}
Suppose that $M$ is flat over $R$, and that $R \to R'$
is a ring map. Then $M\otimes_R R'$ is flat over $R'$.
\end{lemma}

\begin{proof}
For any $R'$-module $N$ we have a canonical
isomorphism $N \otimes_{R'} (R'\otimes_R M)
= N \otimes_R M$. Hence the exactness of
$-\otimes_{R'}(R'\otimes_R M)$ follows from
the exactness of $-\otimes_R M$.
\end{proof}

\begin{lemma}
\label{lemma-flatness-descends}
Let $R \to R'$ be a faithfully flat ring map.
Let $M$ be a module over $R$, and set $M' = R' \otimes_R M$.
Then $M$ is flat over $R$ if and only if $M'$ is flat over $R'$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-flat-base-change} we see that if $M$ is flat
then $M'$ is flat. For the converse, suppose that $M'$ is flat.
Let $N_1 \to N_2 \to N_3$ be an exact sequence of $R$-modules.
We want to show that $N_1 \otimes_R M \to N_2 \otimes_R M \to N_3 \otimes_R M$
is exact. We know that
$N_1 \otimes_R R' \to N_2 \otimes_R R' \to N_3 \otimes_R R'$ is
exact, because $R \to R'$ is flat. Flatness of $M'$ implies that
$N_1 \otimes_R R' \otimes_{R'} M'
\to N_2 \otimes_R R' \otimes_{R'} M'
\to N_3 \otimes_R R' \otimes_{R'} M'$ is exact.
We may write this as
$N_1 \otimes_R M \otimes_R R'
\to N_2 \otimes_R M \otimes_R R'
\to N_3 \otimes_R M \otimes_R R'$.
Finally, faithfull flatness implies that
$N_1 \otimes_R M \to N_2 \otimes_R M \to N_3 \otimes_R M$
is exact.
\end{proof}

\begin{lemma}
\label{lemma-flatness-descends-more-general}
Let $R$ be a ring.
Let $S \to S'$ be a faithfully flat map of $R$-algebras.
Let $M$ be a module over $S$, and set $M' = S' \otimes_S M$.
Then $M$ is flat over $R$ if and only if $M'$ is flat over $R$.
\end{lemma}

\begin{proof}
Let $N \to N'$ be an injection of $R$-modules. By the faithful flatness
of $S \to S'$ we have
$$
\text{Ker}(N \otimes_R M \to N' \otimes_R M) \otimes_S S'
=
\text{Ker}(N \otimes_R M' \to N' \otimes_R M')
$$
Hence the equivalence of the lemma follows from the second characterization
of flatness in
Lemma \ref{lemma-flat}.
\end{proof}

\begin{lemma}
\label{lemma-flat-permanence}
Let $R \to S$ be a ring map. Let $M$ be an $S$-module.
If $M$ is flat as an $R$-module and faithfully flat as an $S$-module,
then $R \to S$ is flat.
\end{lemma}

\begin{proof}
Let $N_1 \to N_2 \to N_3$ be an exact sequence of $R$-modules.
By assumption $N_1 \otimes_R M \to N_2 \otimes_R M \to N_3 \otimes_R M$
is exact. We may write this as
$$
N_1 \otimes_R S \otimes_S M
\to
N_2 \otimes_R S \otimes_S M
\to
N_3 \otimes_R S \otimes_S M.
$$
By faithful flatness of $M$ over $S$ we conclude that
$N_1 \otimes_R S \to N_2 \otimes_R S \to N_3 \otimes_R S$ is exact.
Hence $R \to S$ is flat.
\end{proof}

\noindent
Let $R$ be a ring.
Let $M$ be an $R$-module.
Let $\sum f_i x_i = 0$ be a relation in $M$.
We say the relation $\sum f_i x_i$
is {\it trivial} if there exist an integer $m \geq 0$,
elements $y_j \in M$, $j = 1, \ldots, m$, and elements $a_{ij} \in R$,
$i = 1, \ldots, n$, $j = 1, \ldots, m$ such that
$$
x_i = \sum\nolimits_j a_{ij} y_j, \forall i,
\quad\text{and}\quad
0 = \sum\nolimits_i f_ia_{ij}, \forall j.
$$

\begin{lemma}
\label{lemma-flat-eq}
(Equational criterion of flatness.)
A module $M$ over $R$ is flat if and only if
every relation in $M$ is trivial.
\end{lemma}

\begin{proof}
Assume $M$ is flat and let $\sum f_i x_i$ be a relation.
Let $I = (f_1, \ldots, f_n)$, and let $K = \text{ker}(R^n \to I)$.
So we have the short exact sequence
$0 \to K \to R^n \to I \to 0$. Then $\sum f_i \otimes x_i$
is an element of $I\otimes_R M$ which maps
to zero in $R\otimes_R M = M$. By flatness
$\sum f_i \otimes x_i$ is zero in $I\otimes_R M$.
Thus there exists an element of $K\otimes_R M$ mapping
to $\sum e_i \otimes m_i \in R^n\otimes_R M$.
Write this element as $\sum k_j \otimes y_j$
and then write the image of $k_j$ in $R^n$ as
$\sum a_{ij} e_i$ to get the result.

\medskip\noindent
Assume every relation is trivial, let $I$
be a finitely generated ideal, and let $x = \sum f_i\otimes x_i$
be an element of $I\otimes_R M$ mapping to zero in $R\otimes_R M = M$.
This just means exactly that $\sum h_i x_i$ is a relation in
$M$. And the fact that it is trivial implies easily that
$x$ is zero, because
$$
x
=
\sum f_i \otimes x_i
=
\sum f_i \otimes (\sum a_{ij}y_j)
=
\sum (\sum f_i a_{ij}) \otimes y_j
=
0
$$
\end{proof}

\begin{lemma}
\label{lemma-flat-tor-zero}
Suppose that $R$ is a ring, $0 \to M'' \to M' \to M \to 0$
a short exact sequence, and $N$ an $R$-module. If $M$ is flat
then $N \otimes_R M'' \to N \otimes_R M'$ is injective, i.e., the
sequence
$$
0 \to N \otimes_R M'' \to N \otimes_R M' \to N \otimes_R M \to 0
$$
is a short exact sequence.
\end{lemma}

\begin{proof}
Let $R^{(I)} \to N$ be a surjection from a free module
onto $N$ with kernel $K$. The result follows
by a simple diagram chase from the following diagram
$$
\begin{matrix}
 & & 0 & & 0 & & 0 & & \\
 & & \uparrow & & \uparrow & & \uparrow & & \\
 & & M''\otimes_R N & \to & M' \otimes_R N & \to & M\otimes_R N & \to & 0 \\
 & & \uparrow & & \uparrow & & \uparrow & & \\
0 & \to & (M'')^{(I)} & \to & (M')^{(I)} & \to & M^{(I)} & \to & 0 \\
 & & \uparrow & & \uparrow & & \uparrow & & \\
 & & M''\otimes_R N & \to & M' \otimes_R N & \to & M\otimes_R N & \to & 0 \\
 & & & & & & \uparrow & & \\
 & & & & & & 0 & &
\end{matrix}
$$
with exact rows and columns. The middle row is exact because tensoring
with the free module $R^{(I)}$ is exact.
\end{proof}


\begin{lemma}
\label{lemma-flat-ses}
Suppose that $0 \to M' \to M \to M'' \to 0$ is
a short exact sequence of $R$-modules.
If $M'$ and $M''$ are flat so is $M$.
If $M$ and $M''$ are flat so is $M'$.
\end{lemma}

\begin{proof}
We will use the criterion that a module $N$ is $R$ flat if for
every ideal the map $N\otimes_RI \to N$ is injective,
see Lemma \ref{lemma-flat}.
Consider an ideal $I \subset R$.
Consider the diagram
$$
\begin{matrix}
0
&
\to
&
M'
&
\to
&
M
&
\to
&
M''
&
\to
&
0
\\
&
&
\uparrow
&
&
\uparrow
&
&
\uparrow
&
&
\\
&
&
M'\otimes_R I
&
\to
&
M\otimes_R I
&
\to
&
M''\otimes_R I
&
\to
&
0
\end{matrix}
$$
with exact rows. This immediately proves the first assertion.
The second follows because if $M''$ is flat then the lower left
horizontal arrow is injective by Lemma \ref{lemma-flat-tor-zero}.
\end{proof}

\begin{lemma}
\label{lemma-characterize-zero-local}
Let $R$ be a ring.
Let $M$ be an $R$-module. The following are equivalent:
\begin{enumerate}
\item $M$ is zero,
\item $M_{\mathfrak p}$ is zero for all $\mathfrak p \in \text{Spec}(R)$,
\item $M_{\mathfrak m}$ is zero for all maximal ideals $\mathfrak m$ of $R$.
\end{enumerate}
In particular, $M \to \prod_{\mathfrak m} M_{\mathfrak m}$ is injective.
More generally, given a complex
$$
S : M_1 \to M_2 \to M_3
$$
of $R$-modules we have that $S$ is exact if and only if
the localization
$$
S_{\mathfrak m} :
M_{1, \mathfrak m} \to M_{2, \mathfrak m} \to M_{3, \mathfrak m}
$$
is exact for every maximal ideal $\mathfrak m$ of $R$.
\end{lemma}

\begin{proof}
Suppose $M_{\mathfrak m} = 0$ for all maximal ideals $\mathfrak m$.
Let $x \in M$. Let $I = \{f \in R \mid fx = 0\}$.
It is easy to see that $I$ is an ideal (it is the
annihilator of $x$). The condition means that for
all maximal ideals $\mathfrak m$ there exists an
$f \in R \setminus \mathfrak m$ such that $fx =0$.
In other words, $V(I)$ does not contain a closed point.
According to Lemma \ref{lemma-Zariski-topology} $I$ is the unit ideal.
Hence $x$ is zero. The injectivity of $M \to \prod M_{\mathfrak m}$
follows from (1) $\Leftrightarrow$ (3)
and the fact that localization is exact (hint: apply the
lemma to the kernel of the map).
Also, the last statement follows by applying the equivalence of
(1) and (3) the to homology of $S$ and using exactness of localization.
\end{proof}

\begin{lemma}
\label{lemma-easy-ff}
Let $R$ be a ring.
Let $M$ be an $R$-module.
The following are equivalent
\begin{enumerate}
\item $M$ is faithfully flat, and
\item $M$ is flat and for all $R$-module homomorpisms $\alpha : N \to N'$
we have $\alpha = 0$ if and only if $\alpha \otimes \text{id}_M = 0$.
\end{enumerate}
\end{lemma}

\begin{proof}
If $M$ is faithfully flat, then
$0 \to \text{Ker}(\alpha) \to N \to 0$ is exact if and only if the same holds
after tensoring with $M$. This proves (1) implies (2).
For the other, assume (2). Let $N_1 \to N_2 \to N_3$
be a complex, and assume the complex
$N_1 \otimes_R M \to N_2 \otimes_R M \to N_3\otimes_R M$
is exact. Take $x \in \text{Ker}(N_2 \to N_3)$,
and consider the map $\alpha : R \to N_2/\text{Im}(N_1)$,
$r \mapsto rx + \text{Im}(N_1)$. By the exactness
of the complex $-\otimes_R M$ we see that $\alpha \otimes
\text{id}_M$ is zero. By assumption we get that $\alpha$ is
zero. Hence $x $ is in the image of $N_1 \to N_2$.
\end{proof}

\begin{lemma}
\label{lemma-ff}
Let $M$ be a flat $R$-module.
The following are equivalent:
\begin{enumerate}
\item $M$ is faithfully flat,
\item for all $\mathfrak p \in \text{Spec}(R)$
the tensor product $M\otimes_R \kappa(\mathfrak p)$ is nonzero, and
\item for all maximal ideals $\mathfrak m$ of $R$
the tensor product $M\otimes_R \kappa(\mathfrak m) = M/{\mathfrak m}M$
is nonzero.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume $M$ faithfully flat. Since $R \to \kappa({\mathfrak p})$ is not
zero we deduce that $M \to M \otimes_R \kappa({\mathfrak p})$ is not zero,
see Lemma \ref{lemma-easy-ff}.

\medskip\noindent
Conversely assume that $M$ is flat and that
$M/{\mathfrak m}M$ is never zero.
Suppose that $N_1 \to N_2 \to N_3$ is a complex and
suppose that $N_1 \otimes_R M \to N_2\otimes_R M \to
N_3\otimes_R M$ is exact. Let $H$ be the cohomology of the complex,
so $H = \text{Ker}(N_2 \to N_3)/\text{Im}(N_1 \to N_2)$.
By flatness we see that $H \otimes_R M = 0$.
Take $x \in H$ and let $I = \{f \in R \mid fx = 0 \}$
be its annihilator. Since $R/I \subset H$ we get
$M/IM \subset H\otimes_R M = 0$ by flatness of $M$.
If $I \not=  R$ we may choose
a maximal ideal $I \subset \mathfrak m \subset R$.
This immediately gives a contradiction.
\end{proof}

\begin{lemma}
\label{lemma-ff-rings}
Let $R \to S$ be a flat ring map.
The following are equivalent:
\begin{enumerate}
\item $R \to S$ is faithfully flat,
\item the induced map on $\text{Spec}$ is surjective, and
\item any closed point $x \in \text{Spec}(R)$ is
in the image of the map $\text{Spec}(S) \to \text{Spec}(R)$.
\end{enumerate}
\end{lemma}

\begin{proof}
This follows quickly from Lemma \ref{lemma-ff}, because we
saw in Remark \ref{remark-fundamental-diagram}
that $\mathfrak p$ is in the image
if and only if the ring $S \otimes_R \kappa(\mathfrak p)$
is nonzero.
\end{proof}

\begin{lemma}
\label{lemma-local-flat-ff}
A flat local ring homomorphism of local rings is faithfully flat.
\end{lemma}

\begin{proof}
Immediate from Lemma \ref{lemma-ff-rings}.
\end{proof}

\begin{lemma}
\label{lemma-flat-going-down}
Let $R \to S$ be flat. Let $\mathfrak p \subset \mathfrak p'$
be primes of $R$. Let $\mathfrak q' \subset S$ be a prime of $S$
mapping to $\mathfrak p'$. Then there exists a prime
$\mathfrak q \subset \mathfrak q'$ mapping to $\mathfrak p$.
\end{lemma}

\begin{proof}
Namely, consider the flat local ring map
$R_{\mathfrak p'} \to S_{\mathfrak q'}$.
By Lemma \ref{lemma-local-flat-ff} above this is faithfully
flat. By Lemma \ref{lemma-ff-rings} there is a prime mapping to
$\mathfrak p R_{\mathfrak p'}$. The inverse image of this
prime in $S$ does the job.
\end{proof}

\noindent
The property of $R \to S$ described in the lemma is called the
``going down property''. See Definition \ref{definition-going-up-down}.

\begin{lemma}
\label{lemma-faithfully-flat-injective}
If $R \to S$ is a faithfully flat ring map then for every $R$-module
$M$ the map $M \to S \otimes_R M$, $x \mapsto 1 \otimes x$ is injective.
\end{lemma}

\begin{proof}
This is true because the base change
$S \otimes_R M \to S \otimes_R S \otimes_R M$ by the faithfully
flat ring map $R \to S$ is injective: It has a section, namely
$s \otimes s' \otimes m \mapsto ss' \otimes m$.
\end{proof}

\noindent
We finish with some remarks on flatness and localization.

\begin{lemma}
\label{lemma-flat-localization}
Let $R$ be a ring. Let $S \subset R$ be a multiplicative subset.
\begin{enumerate}
\item The localization $S^{-1}R$ is a flat $R$-algebra.
\item If $M$ is a $S^{-1}R$-module, then $M$ is a flat $R$-module
if and only if $M$ is a flat $S^{-1}R$-module.
\item Suppose $M$ is an $R$-module. Then
$M$ is a flat $R$-module if and only if $M_{\mathfrak p}$ is a flat
$R_{\mathfrak p}$-module for all primes $\mathfrak p$ of $R$.
\item Suppose $R \to A$ is a ring map, $M$ is an $A$-module,
and $g_1, \ldots, g_m \in A$ are elements generating the unit
ideal of $A$. Then $M$ is flat over $F$ if and only if each localization
$M_{g_i}$ is flat over $R$.
\item Suppose $R \to A$ is a ring map, and $M$ is an $A$-module.
Then $M$ is a flat $R$-module if and only if the localization
$M_{\mathfrak q}$ is a flat $R_{\mathfrak p}$-module
(with $\mathfrak p$ the prime of $R$ lying under $\mathfrak q$)
for all primes $\mathfrak q$ of $A$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let us prove the last statement of the lemma.
In the proof we will use repeatedly that localization is exact
and commutes with tensor product, see Sections \ref{section-localization}
and \ref{section-tensor-product}.

\medskip\noindent
Suppose $R \to A$ is a ring map, and $M$ is an $A$-module.
Assume that $M_{\mathfrak q}$ is a flat $R_{\mathfrak p}$-module
for all primes $\mathfrak q$ of $A$ (with $\mathfrak p$ the prime of
$R$ lying under $\mathfrak q$). Let $I \subset R$ be an ideal.
We have to show the map $I \otimes_R M \to M$ is injective.
We can think of this as a map of $A$-modules.
By assumption the localization
$(I \otimes_R M)_{\mathfrak q} \to M_{\mathfrak q}$ is injective
because
$(I \otimes_R M)_{\mathfrak q} =
I_{\mathfrak p} \otimes_{R_{\mathfrak p}} M_{\mathfrak q}$.
Hence the kernel of $I \otimes_R M \to M$ is zero by
Lemma \ref{lemma-characterize-zero-local}.

\medskip\noindent
Conversely, assume $M$ is flat over $R$. Pick a prime $\mathfrak q$
of $A$ lying over the prime $\mathfrak p$ of $R$. Suppose that
$I \subset R_{\mathfrak p}$ is an ideal. We have to show that
$I \otimes_{R_{\mathfrak p}} M_{\mathfrak q} \to M_{\mathfrak q}$
is injective. We can write $I = J_{\mathfrak p}$ for some
ideal $J \subset R$. Then the map
$I \otimes_{R_{\mathfrak p}} M_{\mathfrak q} \to M_{\mathfrak q}$
is just the localization (at $\mathfrak q$) of the map
$J \otimes_R M \to M$ which is injective. Since localization is exact
we win.

\medskip\noindent
The other statements follow in a straightforward way from the last statement
(proofs omitted).
\end{proof}








\section{Going up and going down}
\label{section-going-up}

\noindent
Suppose $\mathfrak p$, $\mathfrak p'$ are primes
of the ring $R$. Let $X = \text{Spec}(R)$ with the Zariski
topology. Denote $x \in X$ the point corresponding
to $\mathfrak p$ and $x' \in X$ the point corresponding
to $\mathfrak p'$. Then we have:
$$
x' \leadsto x \Leftrightarrow \mathfrak p' \subset \mathfrak p.
$$
In words: $x$ is a specialization of $x'$ if and
only if $\mathfrak p' \subset \mathfrak p$.
See Topology, Section \ref{topology-section-specialization}
for terminology and notation.

\begin{definition}
\label{definition-going-up-down}
Let $\varphi : R \to S$ be a ring map.
\begin{enumerate}
\item We say a $\varphi : R \to S$ satisfies {\it going up} if
given primes $\mathfrak p \subset \mathfrak p'$ in $R$
and a prime $\mathfrak q$ in $S$ lying over $\mathfrak p$
there exists a prime $\mathfrak q'$ of $S$ such that
(a) $\mathfrak q \subset \mathfrak q'$, and (b)
$\mathfrak q'$ lies over $\mathfrak p'$.
\item We say a $\varphi : R \to S$ satisfies {\it going down} if
given primes $\mathfrak p \subset \mathfrak p'$ in $R$
and a prime $\mathfrak q'$ in $S$ lying over $\mathfrak p'$
there exists a prime $\mathfrak q$ of $S$ such that
(a) $\mathfrak q \subset \mathfrak q'$, and (b)
$\mathfrak q$ lies over $\mathfrak p$.
\end{enumerate}
\end{definition}

\noindent
Sofar we have see the following cases of this:
\begin{enumerate}
\item An integral ring map satisfies going up, see
Lemma \ref{lemma-integral-going-up}.
\item As a special case finite ring maps satisfy going up.
\item As a special case quotient maps $R \to R/I$ satisfy going up.
\item A flat ring map satisfies going down, see
Lemma \ref{lemma-flat-going-down}
\item As a special case any localization satisfies going down.
\item An extension $R \subset S$ of domains, with $R$ normal
and $S$ integral over $R$ satisfies going down, see
Proposition \ref{proposition-going-down-normal-integral}.
\end{enumerate}
Here is another case where going down holds.

\begin{lemma}
\label{lemma-open-going-down}
Let $R \to S$ be a ring map. If the induced map
$\varphi : \text{Spec}(S) \to \text{Spec}(R)$ is open, then
$R \to S$ satisfies going down.
\end{lemma}

\begin{proof}
Suppose that $\mathfrak p \subset \mathfrak p' \subset R$ and
$\mathfrak q' \subset S$ lies over $\mathfrak p'$. As $\varphi$ is open,
for every $g \in S$, $g \not \in \mathfrak q'$ we see that $\mathfrak p$
is in the image of $D(g) \subset \text{Spec}(S)$. In other words
$S_g \otimes_R \kappa(\mathfrak p)$ is not zero. Since $S_{\mathfrak q'}$
is the directed colimit of these $S_g$ this implies
that $S_{\mathfrak q'} \otimes_R \kappa(\mathfrak p)$ is not
zero, see
Lemmas \ref{lemma-localization-colimit} and
\ref{lemma-tensor-products-commute-with-limits}.
Hence $\mathfrak p$ is in the image of
$\text{Spec}(S_{\mathfrak q'}) \to \text{Spec}(R)$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-going-up-down-specialization}
Let $R \to S$ be a ring map.
\begin{enumerate}
\item $R \to S$ satisfies going down if and only if
generalizations lift along the map $\text{Spec}(S) \to \text{Spec}(R)$,
see Topology, Definition \ref{topology-definition-lift-specializations}.
\item $R \to S$ satisfies going up if and only if
specializations lift along the map $\text{Spec}(S) \to \text{Spec}(R)$,
see Topology, Definition \ref{topology-definition-lift-specializations}.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-going-up-down-composition}
Suppose $R \to S$ and $S \to T$ are ring maps satisfying
going down. Then so does $R \to T$. Similarly for going up.
\end{lemma}

\begin{proof}
According to Lemma \ref{lemma-going-up-down-specialization}
this follows from
Topology, Lemma \ref{topology-lemma-lift-specialization-composition}
\end{proof}

\begin{lemma}
\label{lemma-image-stable-specialization-closed}
Let $R \to S$ be a ring map. Let $T \subset \text{Spec}(R)$
be the image of $\text{Spec}(S)$. If $T$ is stable under specialization,
then $T$ is closed.
\end{lemma}

\begin{proof}
We give two proofs.

\medskip\noindent
First proof. Let $\mathfrak p \subset R$ be a prime ideal such that
the corresponding point of $\text{Spec}(R)$ is in the closure
of $T$. This means that for ever $f \in R$, $f \not \in \mathfrak p$
we have $D(f) \cap T \not = \emptyset$. Note that $D(f) \cap T$
is the image of $\text{Spec}(S_f)$ in $\text{Spec}(R)$. Hence
we conclude that $S_f \not = 0$. In other words, $1 \not = 0$ in
the ring $S_f$. Since $S_{\mathfrak p}$ is the directed limit
of the rings $S_f$ we conclude that $1 \not = 0$ in
$S_{\mathfrak p}$. In other words, $S_{\mathfrak p} \not = 0$ and
considering the image of $\text{Spec}(S_{\mathfrak p})
\to \text{Spec}(S) \to \text{Spec}(R)$ we see there exists
a $\mathfrak p' \in T$ with $\mathfrak p' \subset \mathfrak p$.
As we assumed $T$ closed under specialization we conclude $\mathfrak p$
is a point of $T$ as desired.

\medskip\noindent
Second proof. Let $I = \text{Ker}(R \to S)$. We may replace $R$ by $R/I$.
In this case the ring map $R \to S$ is injective.
By Lemma \ref{lemma-injective-minimal-primes-in-image}
all the minimal primes of $R$ are contained in the image $T$. Hence
if $T$ is stable under specialization then it contains all primes.
\end{proof}

\begin{lemma}
\label{lemma-going-up-closed}
Let $R \to S$ be a ring map. The following are equivalent:
\begin{enumerate}
\item Going up holds for $R \to S$, and
\item the map $\text{Spec}(S) \to \text{Spec}(R)$ is closed.
\end{enumerate}
\end{lemma}

\begin{proof}
It is a general fact that specializations lift along a
closed map of topological spaces, see Topology
Lemma \ref{topology-lemma-closed-open-map-specialization}.
Hence the second condition implies the first.

\medskip\noindent
Assume that going up holds for $R \to S$.
Let $V(I) \subset \text{Spec}(S)$ be a closed set.
We want to show that the image of $V(I)$ in $\text{Spec}(R)$ is closed.
The ring map $S \to S/I$ obviously satisfies going up.
Hence $R \to S \to S/I$ satisfies going up,
by Lemma \ref{lemma-going-up-down-composition}.
Replacing $S$ by $S/I$ it suffices to show the image $T$
of $\text{Spec}(S)$ in $\text{Spec}(R)$ is closed.
By Topology, Lemmas \ref{topology-lemma-open-closed-specialization}
and \ref{topology-lemma-lift-specializations-images} this
image is stable under specialization. Thus the result follows
from Lemma \ref{lemma-image-stable-specialization-closed}.
\end{proof}

\begin{lemma}
\label{lemma-constructible-stable-specialization-closed}
Let $R$ be a ring. Let $E \subset \text{Spec}(R)$ be a constructible subset.
\begin{enumerate}
\item If $E$ is stable under specialization, then $E$ is closed.
\item If $E$ is stable under generalization, then $E$ is open.
\end{enumerate}
\end{lemma}

\begin{proof}
The first assertion
follows from Lemma \ref{lemma-image-stable-specialization-closed}
combined with Lemma \ref{lemma-constructible-is-image}.
The second follows because the complement of a constructible
set is constructible
(see Topology, Lemma \ref{topology-lemma-constructible}),
the first part of the lemma and Topology,
Lemma \ref{topology-lemma-open-closed-specialization}.
\end{proof}

\begin{proposition}
\label{proposition-fppf-open}
Let $R \to S$ be flat and of finite presentation.
Then $\text{Spec}(R) \to \text{Spec}(S)$ is open.
More generally this holds for any ring map $R \to S$ of
finite presentation which satisfies going down.
\end{proposition}

\begin{proof}
Assume that $R \to S$ has finite presentation and satisfies
going down.
It suffices to prove that the image of a standard open $D(f)$ is open.
Since $S \to S_f$ satsifies going down as well, we see that
$R \to S_f$ satisfies going down. Thus after replacing
$S$ by $S_f$ we see it suffices to prove the image is
open. By Chevalley's theorem \ref{theorem-chevalley}
the image is a constructible set $E$. And $E$ is stable
under generalization because $R \to S$ satisfies going down,
see Topology, Lemmas \ref{topology-lemma-open-closed-specialization}
and \ref{topology-lemma-lift-specializations-images}.
Hence $E$ is open by
Lemma \ref{lemma-constructible-stable-specialization-closed}.
\end{proof}

\begin{lemma}
\label{lemma-same-image}
Let $k$ be a field, and let $R$, $S$ be $k$-algebras.
Let $S' \subset S$ be a sub $k$-algebra, and let $f \in S' \otimes_k R$.
In the commutative diagram
$$
\xymatrix{
\text{Spec}((S \otimes_k R)_f) \ar[rd] \ar[rr] & &
\text{Spec}((S' \otimes_k R)_f) \ar[ld] \\
& \text{Spec}(R) &
}
$$
the images of the diagonal arrows are the same.
\end{lemma}

\begin{proof}
Let $\mathfrak p \subset R$ be in the image of the south-west
arrow. This means (Lemma \ref{lemma-in-image}) that
$$
(S' \otimes_k R)_f \otimes_R \kappa(\mathfrak p)
=
(S' \otimes_k \kappa(\mathfrak p))_f
$$
is not the zero ring, i.e., $S' \otimes_k \kappa(\mathfrak p)$
is not the zero ring and the image of $f$ in it is not nilpotent.
The ring map
$S' \otimes_k \kappa(\mathfrak p) \to S \otimes_k \kappa(\mathfrak p)$
is injective. Hence also $S \otimes_k \kappa(\mathfrak p)$
is not the zero ring and the image of $f$ in it is not nilpotent.
Hence $(S \otimes_k R)_f \otimes_R \kappa(\mathfrak p)$
is not the zero ring. Thus (Lemma \ref{lemma-in-image})
we see that $\mathfrak p$ is in the image of the south-east arrow
as desired.
\end{proof}

\begin{lemma}
\label{lemma-map-into-tensor-algebra-open}
Let $k$ be a field.
Let $R$ and $S$ be $k$-algebras.
The map $\text{Spec}(S \otimes_k R) \to \text{Spec}(R)$
is open.
\end{lemma}

\begin{proof}
Let $f \in R \otimes_k S$.
It suffices to prove that the image of the standard open $D(f)$ is open.
Let $S' \subset S$ be a finite type $k$-subalgebra such that
$f \in S' \otimes_k R$. The map $R \to S' \otimes_k R$ is flat
and of finite presentation, hence the image $U$ of
$\text{Spec}((S' \otimes_k R)_f) \to \text{Spec}(R)$ is open
by Proposition \ref{proposition-fppf-open}.
By Lemma \ref{lemma-same-image} this is also the image of $D(f)$ and we win.
\end{proof}

\noindent
Here is a tricky lemma that is sometimes useful.

\begin{lemma}
\label{lemma-unique-prime-over-localize-below}
Let $R \to S$ be a ring map.
Let $\mathfrak p \subset R$ be a prime.
Assume that
\begin{enumerate}
\item there exists a unique prime $\mathfrak q \subset S$ lying over
$\mathfrak p$, and
\item either
\begin{enumerate}
\item going up holds for $R \to S$, or
\item going down holds for $R \to S$ and there is at most one prime
of $S$ above every prime of $R$.
\end{enumerate}
\end{enumerate}
Then $S_{\mathfrak p} = S_{\mathfrak q}$.
\end{lemma}

\begin{proof}
Consider any prime $\mathfrak q' \subset S$ which corresponds to
a point of $\text{Spec}(S_{\mathfrak p})$. This means that
$\mathfrak p' = R \cap \mathfrak q'$ is contained in $\mathfrak p$.
Here is a picture
$$
\xymatrix{
\mathfrak q' \ar@{-}[d] \ar@{-}[r] & ? \ar@{-}[r] \ar@{-}[d] & S \ar@{-}[d] \\
\mathfrak p' \ar@{-}[r] & \mathfrak p \ar@{-}[r] & R
}
$$
Assume (1) and (2)(a).
By going up there exists a prime $\mathfrak q'' \subset S$
with $\mathfrak q' \subset \mathfrak q''$ and $\mathfrak q''$
lying over $\mathfrak p$. By the uniqueness of $\mathfrak q$ we
conclude that $\mathfrak q'' = \mathfrak q$. In other words
$\mathfrak q'$ defines a point of $\text{Spec}(S_{\mathfrak q})$.

\medskip\noindent
Assume (1) and (2)(b).
By going down there exists a prime $\mathfrak q'' \subset \mathfrak q$
lying over $\mathfrak p'$. By the uniqueness of primes lying over
$\mathfrak p'$ we see that $\mathfrak q' = \mathfrak q''$.  In other words
$\mathfrak q'$ defines a point of $\text{Spec}(S_{\mathfrak q})$.

\medskip\noindent
In both cases we conclude that the map
$\text{Spec}(S_{\mathfrak q}) \to \text{Spec}(S_{\mathfrak p})$
is bijective. Clearly this means all the elements of $S - \mathfrak q$
are all invertible in $S_{\mathfrak p}$, in other words
$S_{\mathfrak p} = S_{\mathfrak q}$.
\end{proof}





\section{Transcendence}
\label{section-transcendence}

\noindent
We recall the standard definitions.

\begin{definition}
\label{definition-transcendence}
Let $k \subset K$ be a field extension.
\begin{enumerate}
\item A collection of elements $\{x_i\}_{i \in I}$ of $K$ is called
{\it algebraically independent} over $k$ if the map
$$
k[X_i; i\in I] \longrightarrow K
$$
which maps $X_i$ to $x_i$ is injective.
\item The field of fractions of a polynomial ring
$k[x_i; i \in I]$ is denoted $k(x_i; i\in I)$.
\item A {\it purely transcendental extension} of $k$ is any
field extension $k \subset K$ isomorphic to the field of
fractions of a polynomial ring over $k$.
\item A {\it transcendence basis} of $K/k$ is a 
collection of elements $\{x_i\}_{i \in I}$ which are
algebraically independent over $k$ and such that
the extension $k(x_i; i\in I) \subset K$ is algebraic.
\end{enumerate}
\end{definition}

\begin{lemma}
\label{lemma-transcendence-degree}
Let $k \subset K$ be a field extension.
A transcendence basis of $K$ over $k$ exists.
Any two transcendence bases have the same cardinality.
\end{lemma}

\begin{proof}
Omitted. Good exercise.
\end{proof}

\begin{definition}
\label{definition-transcendence-degree}
Let $k \subset K$ be a field extension.
The {\it transcendence degree} of $K$ over $k$ is
the cardinality of a transcendence basis of $K$ over $k$.
It is denoted $\text{trdeg}_k(K)$.
\end{definition}

\begin{lemma}
\label{lemma-transcendence-degree-tower}
Let $k \subset K \subset L$ be field extensions.
Then
$$
\text{trdeg}_k(L) = 
\text{trdeg}_K(L) +
\text{trdeg}_k(K).
$$
\end{lemma}

\begin{proof}
Omitted.
\end{proof}








\section{Algebraic elements of field extensions}
\label{section-algebraic}

\noindent
Let $k \subset K$ be a field extension. Let $\alpha \in K$.
Then we have the following possibilities:
\begin{enumerate}
\item The element $\alpha$ is transcendental over $k$.
\item The element $\alpha$ is algebraic over $k$. Denote
$P(T) \in k[T]$ its {\it minimal polynomial}. This is a monic polynomial
$P(T) = T^d + a_1 T^{d - 1} + \ldots + a_d$ with coefficients in
$k$. It is irreducible and $P(\alpha) = 0$. These properties
uniquely determine $P$, and the integer $d$ is called the
{\it degree of $\alpha$ over $k$}. There are two subcases:
\begin{enumerate}
\item The polynomial ${\rm d}P/{\rm d}T$ is not identically zero.
This is equivalent to the condition that
$P(T) = \prod_{i = 1, \ldots, d} (T - \alpha_i)$ for
pairwise distinct elements $\alpha_1, \ldots, \alpha_d$
in the algebraic closure of $k$.
In this case we say that $\alpha$ is {\it separable} over $k$.
\item The ${\rm d}P/{\rm d}T$ is identically zero. In this case the
characteristic $p$ of $k$ is $ > 0$, and $P$ is actually a polynomial
in $T^p$. Clearly there exists a largest power $q = p^e$ such that $P$ is
a polynomial in $T^q$. Then the element $\alpha^q$ is separable over $k$.
\end{enumerate}
\end{enumerate}

\begin{definition}
\label{definition-separable-algebraic}
Algebraic field extensions.
\begin{enumerate}
\item A field extension $k \subset K$ is called {\it algebraic}
if every element of $K$ is algebraic over $k$.
\item An algebraic extension $k \subset k'$ is called {\it separable}
if every $\alpha \in k'$ is separable over $k$.
\item An algebraic
extension $k \subset k'$ is called {\it purely inseparable} if
the characteristic of $k$ is $p > 0$ and for every element
$\alpha \in k'$ there exists a power $q$ of $p$ such that
$\alpha^q \in k$.
\item An algebraic extension $k \subset k'$ is called {\it normal}
if for every $\alpha$ the minimal polynomial $P(T) \in k[T]$
of $\alpha$ over $k$ splits completely into linear factors over $k$.
\item An algebraic extension $k \subset k'$ is called {\it Galois}
if it is separable and normal.
\end{enumerate}
\end{definition}

\noindent
Here are some well-known lemmas on field extensions.

\begin{lemma}
\label{lemma-separable-first}
Let $k \subset k'$ be an algebraic field extension.
There exists a unique subfield $k \subset (k')_{sep} \subset k'$
such that $k \subset (k')_{sep}$ is separable, and
$(k')_{sep} \subset k'$ is purely inseparable.
\end{lemma}

\begin{proof}
The Lemma only makes sense if the characteristic of $k$ is $p > 0$.
Given an $\alpha$ in $k'$ let $q_\alpha$ be the smallest power of $p$
such that $\alpha^{q_\alpha}$ is separable over $k$ (see discussion
at the beggining of this section). Then let $(k')_{sep}$ be the
subfield of $k'$ generated by these elements. Details omitted.
\end{proof}

\begin{definition}
\label{definition-insep-degree}
Let $k \subset k'$ be a finite field extension.
Let $k \subset (k')_{sep} \subset k'$ be the subfield
found in Lemma \ref{lemma-separable-first}.
\begin{enumerate}
\item The integer $[(k')_{sep} : k]$ is called the {\it separable
degree} of the extension.
\item The integer $[k' : (k')_{sep}]$ is called the {\it inseparable
degree}, or the {\it degree of inseparability} of the extension.
\end{enumerate}
\end{definition}

\begin{lemma}
\label{lemma-normal-case}
Let $k \subset k'$ be a normal algebraic field extension.
There exists a unique subfields $k \subset (k')_{sep} \subset k'$
and $k \subset (k')_{insep} \subset k'$ such that
\begin{enumerate}
\item $k \subset (k')_{sep}$ is separable, and
$(k')_{sep} \subset k'$ is purely inseparable,
\item $k \subset (k')_{insep}$ is purely inseparable, and
$(k')_{sep} \subset k'$ is separable,
\item $k' = (k')_{sep} \otimes_k (k')_{insep}$.
\end{enumerate}
\end{lemma}

\begin{proof}
We found the subfield $(k')_{sep}$ in Lemma \ref{lemma-separable-first}.
The subfield $(k')_{insep} = (k')^{\text{Aut}(k'/k)}$. Details omitted.
\end{proof}

\begin{lemma}
\label{lemma-finite-separable}
Let $k \subset k'$ be a finite separable field extension.
Then there exists an $\alpha \in k'$ such that $k' = k(\alpha)$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{definition}
\label{definition-algebraically-closed-in}
Let $k \subset K$ be a field extension.
\begin{enumerate}
\item The {\it algebraic closure of $k$ in $K$} is the subfield
$k'$ of $K$ consisting of elements of $K$ which are algebraic over $k$.
\item We say $k$ is {\it algebraically closed in $K$} if
every element of $K$ which is algebraic over $k$ is
contained in $k$.
\end{enumerate}
\end{definition}

\begin{lemma}
\label{lemma-algebraic-closure-in-finitely-generated}
Let $k \subset K$ be a finitely generated field extension.
The algebraic closure of $k$ in $K$ is finite over $k$.
\end{lemma}

\begin{proof}
Let $x_1, \ldots, x_r \in K$ be a transcendence basis for $K$
over $k$. Then $n = [K : k(x_1, \ldots, x_r)] < \infty$.
Suppose that $k \subset k' \subset K$ with $k'/k$ finite.
In this case
$[k'(x_1, \ldots, x_r) : k(x_1, \ldots, x_r)] = [k' : k] < \infty$.
Hence
$$
[k' : k] = [k'(x_1, \ldots, x_r) : k(x_1, \ldots, x_r)]
< [K : k(x_1, \ldots, x_r)] = n.
$$
In other words, the degrees of finite subextensions are bounded
and the lemma follows.
\end{proof}

\begin{lemma}
\label{lemma-pth-root}
Let $K$ be a field of characteristic $p > 0$.
Let $K \subset L$ be a separable algebraic extension.
Let $\alpha \in L$.
If the coefficients of the minimal polynomial of $\alpha$
over $K$ are $p$th powers in $K$ then $\alpha$ is a $p$th
power in $L$.
\end{lemma}

\begin{proof}
We may assume that $K \subset L$ is finite Galois.
Let $P(T) = T^d + \sum\nolimits_{i = 1}^d a_i T^{d - i}$
be the minimal polynomial and assume $a_i = b_i^p$.
The polynomial $Q(T) = T^d + \sum\nolimits_{i = 1}^d b_i T^{d - i}$
is a separable irreducible polynomial as well.
Let $L \subset L'$ be the field extension obtained by adjoining
a single root $\beta$ of $Q$ to $L$. This is a separable 
extension on the one hand, and a purely inseparable extension
on the other hand, since clearly $\beta^p$ is equal to a conjugate of
$\alpha$. Hence $L = L'$ which means a conjugate of $\alpha$ is
a $p$th power. Hence $\alpha$ is a $p$th power.
\end{proof}







\section{Separability}
\label{section-separability}

\noindent
In this section we talk about separability for nonalgebraic field extensions.
This is closely related to the concept of geometrically reduced algebras, see
Definition \ref{definition-geometrically-reduced}.

\begin{definition}
\label{definition-separable-field-extension}
Let $k \subset K$ be a field extension.
\begin{enumerate}
\item We say $K$ is {\it separably generated over $k$} if there exists
a transcendence basis $\{x_i; i \in I\}$ of $K/k$ such that the extension
$k(x_i; i\in I) \subset K$ is a separable algebraic extension.
\item We say $K$ is {\it separable over $k$} if for every subextension
$k \subset K' \subset K$ with $K'$ finitely generated
over $k$, the extension $k \subset K'$ is separably generated.
\end{enumerate}
\end{definition}

\noindent
With this awkward definition it is not immediately clear that
a separably generated field extension is itself separable.
It will turn out that this is the case, see
Lemma \ref{lemma-separably-generated-separable}.

\begin{lemma}
\label{lemma-subextensions-are-separable}
Let $k \subset K$ be a separable field extension.
For any subextension $k \subset K' \subset K$ the field
extension $k \subset K'$ is separable.
\end{lemma}

\begin{proof}
This is direct from the definition.
\end{proof}

\begin{lemma}
\label{lemma-generating-finitely-generated-separable-field-extensions}
Let $k \subset K$ be a separably generated, and finitely generated
field extension.
Set $r = \text{trdeg}_k(K)$. Then there exist elements
$x_1, \ldots, x_{r + 1}$ of $K$ such that
\begin{enumerate}
\item $x_1, \ldots, x_r$ is a transcendence basis of $K$ over $k$,
\item $K = k(x_1, \ldots, x_{r + 1})$, and
\item $x_{r + 1}$ is separable over $k(x_1, \ldots, x_r)$.
\end{enumerate}
\end{lemma}

\begin{proof}
Combine the definition with Lemma \ref{lemma-finite-separable}.
\end{proof}

\begin{lemma}
\label{lemma-make-separably-generated}
Let $k \subset K$ be a finitely generated field extension.
There exists a diagram
$$
\xymatrix{
K \ar[r] & K' \\
k \ar[u] \ar[r] & k' \ar[u]
}
$$
where $k \subset k'$, $K \subset K'$ are finite purely inseparable field
extensions such that $k' \subset K'$ is a separably generated field extension.
\end{lemma}

\begin{proof}
This lemma is only interesting when the characteristic of $k$ is $p > 0$.
Choose $x_1, \ldots, x_r$ a transcendence basis of $K$ over $k$.
As $K$ is finitely generated over $k$ the extension
$k(x_1, \ldots, x_r) \subset K$ is finite.
Let $k(x_1, \ldots, x_r) \subset K_{sep} \subset K$ be the subextension
found in
Lemma \ref{lemma-separable-first}.
If $K = K_{sep}$ then we are done.
We will use induction on $d = [K : K_{sep}]$.

\medskip\noindent
Assume that $d > 1$. Choose a $\beta \in K$ with
$\alpha = \beta^p \in K_{sep}$ and $\beta \not \in K_{sep}$.
Let $P = T^d + a_1T^{d - 1} + \ldots + a_d$
be the minimal polynomial of $\alpha$ over $k(x_1, \ldots, x_r)$.
Let $k \subset k'$ be a finite purely inseparable extension
obtained by adjoining $p$th roots such that each $a_i$ is a
$p$th power in $k'(x_1^{1/p}, \ldots, x_r^{1/p})$.
Such an extension exists; details omitted.
Let $L$ be a field fitting into the diagram
$$
\xymatrix{
K \ar[r] & L \\
k(x_1, \ldots, x_r) \ar[u] \ar[r] & k'(x_1^{1/p}, \ldots, x_r^{1/p}) \ar[u]
}
$$
and such that $L$ is the compositum of $K$ and
$k'(x_1^{1/p}, \ldots, x_r^{1/p})$. Let
$$
k'(x_1^{1/p}, \ldots, x_r^{1/p}) \subset L_{sep} \subset L
$$
be the subextesion found in
Lemma \ref{lemma-separable-first}.
Then it is clear that $L_{sep}$ is the compositum of
$K_{sep}$ and $k'(x_1^{1/p}, \ldots, x_r^{1/p})$.
The element $\alpha \in L_{sep}$ has a minimal polynomial
$P$ all of whose coefficients are $p$th powers in
$k'(x_1^{1/p}, \ldots, x_r^{1/p})$. By
Lemma \ref{lemma-pth-root}
we see that $\alpha = (\alpha')^p$ for some $\alpha' \in L_{sep}$.
Clearly, this means that $\beta$ maps to $\alpha' \in L_{sep}$.
In other words, we get the tower of fields
$$
\xymatrix{
K \ar[r] & L \\
K_{sep}(\beta) \ar[r] \ar[u] & L_{sep} \ar[u] \\
K_{sep} \ar[r] \ar[u] & L_{sep} \ar@{=}[u] \\
k(x_1, \ldots, x_r) \ar[u] \ar[r] & k'(x_1^{1/p}, \ldots, x_r^{1/p}) \ar[u] \\
k \ar[r] \ar[u] & k' \ar[u]
}
$$
Thus this construction leads to a new situation with
$[L : L_{sep}] < [K : K_{sep}]$. By induction we can find
$k' \subset k''$ and $L \subset L'$ as in the lemma for the
extension $k' \subset L$. Then the extensions $k \subset k''$ and
$K \subset L''$ work for the extension $k \subset K$.
This proves the lemma.
\end{proof}

\begin{definition}
\label{definition-geometrically-reduced}
Let $k$ be a field. Let $S$ be a $k$-algebra.
We say $S$ is {\it geometrically reduced over $k$}
if for every field extension $k \subset K$ the
$K$-algebra $K \otimes_k S$ is reduced.
\end{definition}

\noindent
Let $k$ be a field and let $S$ be a reduced $k$ algebra.
To check that $S$ is geometrically reduced it will suffice
to check that $\overline{k} \otimes_k S$ is reduced (where
$\overline{k}$ denotes the algebraic closure of $k$).
In fact it is enough to check this for finite purely inseparable
field extensions $k \subset k'$. See
Lemma \ref{lemma-geometrically-reduced-finite-purely-inseparable-extension}.

\begin{lemma}
\label{lemma-subalgebra-separable}
Elementary properties of geometrically reducedness.
Let $k$ be a field. Let $S$ be a $k$-algebra.
\begin{enumerate}
\item If $S$ is geometrically reduced over $k$ so is every
$k$-subalgebra.
\item If all finitely generated $k$-subalgebras of $S$ are
geometrically reduced, then $S$ is geometrically reduced.
\item A directed colimit of geometrically reduced $k$-algebras
is geometrically reduced.
\item If $S$ is geometrically reduced over $k$, then any localization
of $S$ is geometrically reduced over $k$.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted. The second and third property follow from the fact that
tensor product commutes with colimits.
\end{proof}

\begin{lemma}
\label{lemma-geometrically-reduced-permanence}
Let $k$ be a field.
If $R$ is geometrically reduced over $k$, 
and $S \subset R$ is a multiplicative subset, then the localization
$S^{-1}R$ is geometrically reduced over $k$.
If $R$ is geometrically reduced over $k$, then $R[x]$ is geometrically
reduced over $k$.
\end{lemma}

\begin{proof}
Omitted. Hints: A localization of a reduced ring is reduced, and
localization commutes with tensor products.
\end{proof}

\noindent
In the proofs of the following lemmas we will repeatedly use
the following observation: Suppose that $R' \subset R$ and
$S' \subset S$ are inclusions of $k$-algebras.
Then the map $R' \otimes_k S' \to R \otimes_k S$
is injective.

\begin{lemma}
\label{lemma-limit-argument}
Let $k$ be a field. Let $R$, $S$ be $k$-algebras.
\begin{enumerate}
\item If $R \otimes_k S$ is nonreduced, then there exist
finitely generated subalgebras $R' \subset R$,
$S' \subset S$ such that $R' \otimes_k S'$ is not reduced.
\item If $R \otimes_k S$ contains a nonzero zero divisor, then there exist
finitely generated subalgebras $R' \subset R$,
$S' \subset S$ such that $R' \otimes_k S'$ contains a nonzero zero divisor.
\item If $R \otimes_k S$ contains a nontrivial idempotent, then there exist
finitely generated subalgebras $R' \subset R$,
$S' \subset S$ such that $R' \otimes_k S'$ contains a nontrivial idempotent.
\end{enumerate}
\end{lemma}

\begin{proof}
Suppose $z \in R \otimes_k S$ is nilpotent. We may write
$z = \sum_{i = 1, \ldots, n} x_i \otimes y_i$.
Thus we may take $R'$ the $k$-subalgebra generated by
the $x_i$ and $S'$ the $k$-subalgebra generated by the $y_i$.
The second and third statements are proved in the same way.
\end{proof}

\begin{lemma}
\label{lemma-geometrically-reduced-any-reduced-base-change}
Let $k$ be a field.
Let $S$ be a geometrically reduced $k$-algebra.
Let $R$ be any reduced $k$-algebra.
Then $R \otimes_k S$ is reduced.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-limit-argument}
we may assume that $R$ is of finite type over $k$.
Then $R$, as a reduced Noetherian ring, embeds into a finite
product of fields
(see Lemmas \ref{lemma-total-ring-fractions-no-embedded-points},
\ref{lemma-Noetherian-irreducible-components}, and
\ref{lemma-minimal-prime-reduced-ring}).
Hence we may assume $R$ is a finite product of
fields. In this case the reducedness follows from the definition.
\end{proof}

\begin{lemma}
\label{lemma-separable-extension-preserves-reducedness}
Let $k$ be a field.
Let $S$ be a reduced $k$-algebra.
Let $k \subset K$ be either a separable field extension,
or a separably generated field extension.
Then $K \otimes_k S$ is reduced.
\end{lemma}

\begin{proof}
Assume $k \subset K$ is separable.
By Lemma \ref{lemma-limit-argument}
we may assume that $S$ is of finite type over $k$
and $K$ is finitely generated over $k$.
Then $S$ embeds into a finite product of fields,
namely its total ring of fractions (see
Lemmas \ref{lemma-minimal-prime-reduced-ring} and
\ref{lemma-total-ring-fractions-no-embedded-points}).
Hence we may actually assume that $S$ is a domain.
We choose $x_1, \ldots, x_{r + 1} \in K$ as in
Lemma \ref{lemma-generating-finitely-generated-separable-field-extensions}.
Let $P \in k(x_1, \ldots, x_r)[T]$
be the minimal polynomial of $x_{r + 1}$. It is a separable polynomial.
It is easy to see that
$k[x_1, \ldots, x_r] \otimes_k S = S[x_1, \ldots, x_r]$ is a domain.
This implies $k(x_1, \ldots, x_r) \otimes_k S$ is a domain
as it is a localization of $S[x_1, \ldots, x_r]$.
The ring extension $k(x_1, \ldots, x_r) \otimes_k S \subset K \otimes_k S$
is generated by a single element $x_{r + 1}$ with a single
equation, namely $P$. Hence $K \otimes_k S$ embeds into
$f.f.(k(x_1, \ldots, x_n) \otimes_k S)[T]/(P)$.
Since $P$ is separable this is a finite product of fields and we win.

\medskip\noindent
At this point we do not yet know that a separably generated field
extension is separable, so we have to prove the lemma in this case also.
To do this suppose that $\{x_i\}_{i \in I}$ is a separating
transcendence basis for $K$ over $k$. For any finite set of elements
$\lambda_j \in K$ there exists a finite subset $T \subset I$ such
that $k(\{x_i\}_{i\in T}) \subset k(\{x_i\}_{i \in T} \cup \{\lambda_j\})$
is finite separable. Hence we see that $K$ is a directed colimit of
finitely generated and separably generated extensions of $k$. Thus
the argument of the preceding paragraph applies to this case as well.
\end{proof}

\begin{lemma}
\label{lemma-geometrically-reduced-finite-purely-inseparable-extension}
Let $k$ be a field. Let $S$ be a $k$-algebra.
If $k' \otimes_k S$ is reduced for every finite
purely inseparable extension $k'$ of $k$, then
$S$ is geometrically reduced.
\end{lemma}

\begin{proof}
Assume $k' \otimes_k S$ is reduced for every finite
purely inseparable extension $k'$ of $k$. Let $k \subset K$ be
an extension of fields. We have to show that $K \otimes_k S$
is reduced. By Lemma \ref{lemma-limit-argument} we reduce to the case where
$k \subset K$ is a finitely generated field extension. Choose a diagram
$$
\xymatrix{
K \ar[r] & K' \\
k \ar[u] \ar[r] & k' \ar[u]
}
$$
as in Lemma \ref{lemma-make-separably-generated}.
By assumption $k' \otimes_k S$ is reduced.
By Lemma \ref{lemma-separable-extension-preserves-reducedness}
it follows that $K' \otimes_k S$ is reduced.
Hence we conclude that $K \otimes_k S$ is reduced as desired.
\end{proof}

\noindent
Let $p$ be a prime number and let $k$ be a field of characteristic $p$.
In this case we write $k^{1/p}$ for the extension of $k$ gotton by
adjoining $p$th roots of all the elements of $k$ to $k$.
(In other words it is the subfield of an algebraic closure of
$k$ generated by the $p$th roots of elements of $k$.)

\begin{lemma}
\label{lemma-characterize-separable-field-extensions}
Let $k$ be a field of characteristic $p > 0$.
Let $k \subset K$ be a field extension.
The following are equivalent:
\begin{enumerate}
\item $K$ is separable over $k$,
\item the ring $K \otimes_k k^{1/p}$ is reduced, and
\item $K$ is geometrically reduced over $k$.
\end{enumerate}
\end{lemma}

\begin{proof}
The implication (1) $\Rightarrow$ (3) follows from
Lemma \ref{lemma-separable-extension-preserves-reducedness}.
The implication (3) $\Rightarrow$ (2) is immediate.

\medskip\noindent
Assume (2). Let $k \subset L \subset K$ be a subextension such that
$L$ is a finitely generated field extension of $k$.
We have to show that we can find a separating transcendence basis of $L$.
The assumption implies that $L \otimes_k k^{1/p}$ is reduced.
Let $x_1, \ldots, x_r$ be a transcendence basis of $L$ over $k$ such
that the degree of inseparability of the finite extension
$k(x_1, \ldots, x_r) \subset L$ is minimal.
If $L$ is separable over $k(x_1, \ldots, x_r)$ then we win.
Assume this is not the case to get a contradiction.
Then there exists an element $\alpha \in L$ which is not
separable over $k(x_1, \ldots, x_r)$. Let $P(T) \in k(x_1, \ldots, x_r)[T]$
be its minimal polynomial. Because $\alpha$ is not separable
actually $P$ is a polynomial in $T^p$. Clear denominators
to get an irreducible polynomial
$$
G(X_1, \ldots, X_r, T) \in k[X_1, \ldots, X_r, T]
$$
such that $G(x_1, \ldots, x_r, \alpha) = 0$ in $L$.
Note that this means $k[X_1, \ldots, X_r, T]/(G) \subset L$.
We claim that ${\rm d}G/{\rm d}X_i$ is not identically zero
for at least one $i$. Namely, if this was not the case, then
$G$ is actually a polynomial in $X_1^p, \ldots, X_r^p, T^p$ and
hence $G^{1/p} \in k^{1/p}[X_1, \ldots, X_r, T]$ would map
to a nonzero nilpotent element of $k^{1/p}\otimes_k L$! Thus,
after renumbering, we may assume that ${\rm d}G/{\rm d}X_1$ is not zero.
Then we see that $x_1$ is separably algebraic over
$k(x_2, \ldots, x_r, \alpha)$, and that $x_2, \ldots, x_r, \alpha$
is a transcendence basis of $L$ over $k$. This means that
the degree of inseparability of the finite extension
$k(x_2, \ldots, x_r, \alpha) \subset L$ is less than the
degree of inseparability of the finite extension
$k(x_1, \ldots, x_r) \subset L$, which is a contradiction.
\end{proof}

\begin{lemma}
\label{lemma-separably-generated-separable}
A separably generated field extension is separable.
\end{lemma}

\begin{proof}
Combine Lemma \ref{lemma-separable-extension-preserves-reducedness}
with Lemma \ref{lemma-characterize-separable-field-extensions}.
\end{proof}

\begin{definition}
\label{definition-perfect}
Let $k$ be a field. We say $k$ is {\it perfect}
if every field extension of $k$ is separable over $k$.
\end{definition}

\begin{lemma}
\label{lemma-perfect}
A field $k$ is perfect if and only if it is a field of characteristic $0$
or a field of characteristic $p > 0$ such that every element has a $p$th
root.
\end{lemma}

\begin{proof}
The characteristic zero case is clear.
Assume the characteristic of $k$ is $p > 0$.
If $k$ is perfect, then all the field extensions where we adjoin
a $p$th root of an element of $k$ have to be trivial, hence every
element of $k$ has a $p$th root. Conversely if every element has a $p$th
root, then $k = k^{1/p}$ and every field extension of $k$ is
separable by
Lemma \ref{lemma-characterize-separable-field-extensions}.
\end{proof}

\begin{lemma}
\label{lemma-make-separable}
Let $k \subset K$ be a finitely generated field extension.
There exists a diagram
$$
\xymatrix{
K \ar[r] & K' \\
k \ar[u] \ar[r] & k' \ar[u]
}
$$
where $k \subset k'$, $K \subset K'$ are finite purely inseparable field
extensions such that $k' \subset K'$ is a separable field extension.
In this situation we can assume that $K' = k'K$ is the compositum,
and also that $K' = (k' \otimes_k K)_{red}$.
\end{lemma}

\begin{proof}
By
Lemma \ref{lemma-make-separably-generated}
we can find such a diagram with $k' \subset K'$ separably generated.
By
Lemma \ref{lemma-separably-generated-separable}
this implies that $K'$ is separable over $k'$.
The compositum $k'K$ is a subextension of $k' \subset K'$ and hence
$k' \subset k'K$ is separable by
Lemma \ref{lemma-subextensions-are-separable}.
The ring $(k' \otimes_k K)_{red}$ is a domain as for some
$n \gg 0$ the map $x \mapsto x^{p^n}$ maps it into $K$.
Hence it is a field by 
Lemma \ref{lemma-integral-over-field}.
Thus $(k' \otimes_k K)_{red} \to K'$ maps it isomorphically onto $k'K$.
\end{proof}

\begin{lemma}
\label{lemma-perfection}
For every field $k$ there exists a purely inseparable extension
$k \subset k'$ such that $k'$ is perfect. The field extension
$k \subset k'$ is unique up to unique isomorphism.
\end{lemma}

\begin{proof}
If the characteristic of $k$ is zero, then $k' = k$ is the
unique choice. Assume the characteristic of $k$ is $p > 0$.
For every $n > 0$ there exists a unique algebraic extension
$k \subset k^{1/p^n}$ such that (a) every element $\lambda \in k$
has a $p^n$th root in $k^{1/p^n}$ and (b) for every element
$\mu \in k^{1/p^n}$ we have $\mu^{p^n} \in k$.
Namely, consider the ring map $k \to k^{1/p^n} = k$, $x \mapsto x^{p^n}$.
This is injective and satisfies (a) and (b). It is clear that
$k^{1/p^n} \subset k^{1/p^{n + 1}}$ as extensions of $k$ via
the map $y \mapsto y^p$. Then we can take $k' = \bigcup k^{1/p^n}$.
Some details omitted.
\end{proof}

\begin{definition}
\label{definition-perfection}
Let $k$ be a field. The field extension $k \subset k'$ of
Lemma \ref{lemma-perfection}
is called the {\it perfect closure} of $k$. Notation $k \subset k^{perf}$.
\end{definition}

\begin{lemma}
\label{lemma-perfect-reduced}
Let $k$ be a perfect field.
Any reduced $k$ algebra is geometrically reduced over $k$.
Let $R$, $S$ be $k$-algebras.
Assume both $R$ and $S$ are reduced.
Then the $k$-algebra $R \otimes_k S$ is reduced.
\end{lemma}

\begin{proof}
The first statement follows from
Lemma \ref{lemma-geometrically-reduced-finite-purely-inseparable-extension}.
For the second statement use the first statement and
Lemma \ref{lemma-geometrically-reduced-any-reduced-base-change}.
\end{proof}









\section{Algebras over fields and base change}
\label{section-algebras-over-fields}

\begin{lemma}
\label{lemma-Noetherian-field-extension}
Let $k$ be a field and let $R$ be a Noetherian $k$-algebra.
If $k \subset K$ is a finitely generated field extension the
$K \otimes_k R$ is Noetherian.
\end{lemma}

\begin{proof}
Write $K = S^{-1}B$ where $B$ is a finite type $k$-algebra, and
$S \subset B$ is a multiplicative subset. Then we have
$K \otimes_k R = S^{-1}(B \otimes_k R)$.
Hence $K \otimes_k R$ is a localization of the finite type $R$-algebra
$B \otimes_k R$ which is Noetherian by
Lemma \ref{lemma-Noetherian-permanence}.
\end{proof}

\begin{lemma}
\label{lemma-help-with-powers}
Let $n, m > 0$ be two integers. There exist $a, b \geq 0$ such that
setting $N = n^am^b$ we have $(x + y)^N \in \mathbf{Z}[x^n, nx, y^m, my]$.
\end{lemma}

\begin{proof}
Let $k = nm$. Then it suffices to prove that we can find a power $N = k^c$
such that $(x + y)^N \in \mathbf{Z}[x^k, kx, y^k, ky]$. Write
$$
(x + y)^N  = \sum\nolimits_{i, j \geq 0, i + j = N}
{N \choose i, j} x^iy^j
$$
The condition means that
$$
k^{r + r'} \mid {N \choose i, j}
$$
where $i = qk + r$ with $r \in \{0, \ldots, k - 1\}$ and
$j = q'k + r'$ with $r' \in \{0, \ldots, k - 1\}$.
Choose $N = k^{k + 1}$. Then the fact that $i + j = N$ is divisible by $k$
implies that either $r = r' = 0$ if $k$ divides both $i$ and $j$, or
else $r + r' = k$. The choice of $N$ works: If $k$ divides both $i$ and
$j$ then the result is clear. If not then we write
because ${N \choose i, j} = \frac{N}{i} \cdot {N - 1 \choose i - 1}$
and $N/i$ is divisible by $k^k$ because as $r \not = 0$ we see that
$\gcd(N, i)$ divides $k$ in this case.
\end{proof}

\noindent
Let $k \subset k'$ be an algebraic purely inseparable field
extension. Then for any $k$-algebra $R$ the ring map
$R \to k' \otimes_k R$ induces a homeomorphism of spectra.
The reason for this is the following slightly more general lemma.
The second part of this lemma is often applied when $R \subset S$
and there exists a
prime number $p$ such that $pR = 0$ and $S$ is generated over $R$ by 
elements $x$ such that $x^{p^f} \in R$ for some $f \geq 0$.

\begin{lemma}
\label{lemma-p-ring-map}
Let $\varphi : R \to S$ be a ring map. If
\begin{enumerate}
\item for any $x \in S$ there exists $n > 0$ such that
$x^n$ is in the image of $\varphi$, and
\item for any $x \in \text{Ker}(\varphi)$ there exists $n > 0$
such that $x^n = 0$,
\end{enumerate}
then $\varphi$ induces a homeomorphism on spectra. If
\begin{enumerate}
\item[(a)] $S$ is generated as an $R$-algebra by elements $x$ such
that there exists an $n > 0$ with $x^n \in \varphi(R)$ and
$nx \in \varphi(R)$, and
\item[(b)] the kernel of $\varphi$ is generated by nilpotent elements,
\end{enumerate}
then (1) and (2) hold, and for any ring map $R \to R'$
the ring map $R' \to R' \otimes_R S$ also satisfies (a), (b), (1), and (2)
and in particular induces a homeomorphism on spectra.
\end{lemma}

\begin{proof}
Assume (1) and (2). Let $\mathfrak q, \mathfrak q'$ be primes of $S$
lying over the same prime ideal $\mathfrak p$ of $R$. Suppose $x \in S$ with
$x \in \mathfrak q$, $x \not \in \mathfrak q'$. Then $x^n \in \mathfrak q$
and $x^n \not \in \mathfrak q'$ for all $n > 0$. If $x^n = \varphi(y)$ with
$y \in R$ for some $n > 0$ then
$$
x^n \in \mathfrak q \Rightarrow y \in \mathfrak p \Rightarrow
x^n \in \mathfrak q'
$$
which is a contradication. Hence there does not exist an $x$ as above and
we conclude that $\mathfrak q = \mathfrak q'$, i.e., the map on spectra
is injective. By assumption (2) the kernel $I = \text{Ker}(\varphi)$ is
contained in every prime, hence $\text{Spec}(R) = \text{Spec}(R/I)$ as
topological spaces. As the induced map $R/I \to S$ is integral by
assumption (1)
Lemma \ref{lemma-integral-overring-surjective}
shows that $\text{Spec}(S) \to \text{Spec}(R/I)$ is surjective. Combining
the above we see that $\text{Spec}(S) \to \text{Spec}(R)$ is bijective.
If $x \in S$ is arbitrary, and we pick $y \in R$ such that
$\varphi(y) = x^n$ for some $n > 0$, then we see that the open
$D(x) \subset \text{Spec}(S)$ corresponds to the open
$D(y) \subset \text{Spec}(R)$ via the bijection above. Hence we see that
the map $\text{Spec}(S) \to \text{Spec}(R)$ is a homeomorphism.

\medskip\noindent
Assume (a) and (b). Note that (b) is equivalent to (2).
We claim that for any $x \in S$ there exists an
integer $n > 0$ such that $x^n , nx \in \varphi(R)$. By assumption (a) it
suffices to show that the set of elements with this property forms a
$R$-sub algebra. Suppose $x, y \in S$ and $n, m > 0$ such that
$x^n, y^m, nx, my \in \varphi(R)$. Then $(xy)^{nm}, nmxy \in \varphi(R)$
and we see that $xy$ satisfies the condition. Note that
$nm(x + y) \in \varphi(R)$ and that there exists an integer
$N = n^am^b$, $a, b \geq 0$ such that $(x + y)^N \in \varphi(R)$, see
Lemma \ref{lemma-help-with-powers}.
Thus $x + y$ satisfies the condition and the claim is proved.
In particular it follows from the first part of the lemma that
$\text{Spec}(S) \to \text{Spec}(R)$ is a homeomorphism.
In particular it is surjective which is a property preserved under
any base change, see
Lemma \ref{lemma-surjective-spec-radical-ideal}.
Therefore for any $R \to R'$ the kernel of the ring map
$R' \to R' \otimes_R S$ consists of nilpotent elements, see
Lemma \ref{lemma-image-dense-generic-points},
in other words (b) holds for $R' \to R' \otimes_R S$.
Finally, it is clear that (a) is preserved under
base change which finishes the proof.
\end{proof}

\begin{lemma}
\label{lemma-flat-fibres-irreducible}
Let $R \to S$ be a ring map. Assume
\begin{enumerate}
\item[(a)] $\text{Spec}(R)$ is irreducible,
\item[(b)] $R \to S$ is flat,
\item[(c)] $R \to S$ is of finite presentation,
\item[(d)] the fibre rings $S \otimes_R \kappa(\mathfrak p)$
have irreducible spectra for a dense collection of primes $\mathfrak p$ of $R$.
\end{enumerate}
Then $\text{Spec}(S)$ is irreducible.
This is true more generally with (b) $+$ (c)
replaced by ``the map $\text{Spec}(S) \to \text{Spec}(R)$ is open''.
\end{lemma}

\begin{proof}
The assumptions (b) and (c) imply that the map on spectra is open,
see Lemma \ref{proposition-fppf-open}. Hence the lemma follows from
Topology, Lemma \ref{topology-lemma-irreducible-on-top}.
\end{proof}

\begin{lemma}
\label{lemma-separably-closed-irreducible}
Let $k$ be a separably algebraically closed field.
Let $R$, $S$ be $k$-algebras. If $R$, $S$ have a unique
minimal prime, so does $R \otimes_k S$.
\end{lemma}

\begin{proof}
Let $k \subset \overline{k}$ be a perfect closure, see
Definition \ref{definition-perfection}.
By assumption $\overline{k}$ is algebraically closed.
The ring maps $R \to R\otimes_k \overline{k}$ and
$S \to S \otimes_k \overline{k}$ and
$R \otimes_k S \to (R \otimes_k S) \otimes_k \overline{k}
= (R \otimes_k \overline{k}) \otimes_{\overline{k}} (S \otimes_k \overline{k})$
satisfy the assumptions of Lemma \ref{lemma-p-ring-map}.
Hence we may assume $k$ is algebraically closed.

\medskip\noindent
We may replace $R$ and $S$ by their reductions.
Hence we may assume that $R$ and $S$ are domains.
By Lemma \ref{lemma-perfect-reduced} we see that $R \otimes_k S$ is
reduced. Hence its spectrum is reducible if and only if it contains a nonzero
zero divisor. By Lemma \ref{lemma-limit-argument} we reduce to the case where
$R$ and $S$ are domains of finite type over $k$ algebraically closed.

\medskip\noindent
Note that the ring map $R \to R \otimes_k S$ is of finite
presentation and flat. Moreover, for every maximal ideal
$\mathfrak m$ of $R$ we have
$(R \otimes_k S) \otimes_R R/\mathfrak m \cong S$ because
$k \cong R/\mathfrak m$ by the Hilbert Nullstellensatz Theorem
\ref{theorem-nullstellensatz}. Moreover, the set of
maximal ideals is dense in the spectrum of $R$ since
$\text{Spec}(R)$ is Jacobson, see Lemma \ref{lemma-finite-type-field-Jacobson}.
Hence we see that Lemma \ref{lemma-flat-fibres-irreducible} applies
to the ring map $R \to R \otimes_k S$ and we conclude that
the spectrum of $R \otimes_k S$ is irreducible as desired.
\end{proof}

\begin{lemma}
\label{lemma-geometrically-irreducible}
Let $k$ be a field.
Let $R$ be a $k$-algebra.
The following are equivalent
\begin{enumerate}
\item for every field extension $k \subset k'$ the
spectrum of $R \otimes_k k'$ is irreducible, and
\item for every finite separable field extension $k \subset k'$ the
spectrum of $R \otimes_k k'$ is irreducible.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $k \subset k^{perf}$ be a perfect closure of $k$, see
Definition \ref{definition-perfection}.
By Lemma \ref{lemma-p-ring-map} we may replace $R$
by $(R \otimes_k k^{perf})_{reduction}$
and $k$ by $k^{perf}$ (some details omitted). Hence
we may assume that $R$ is geometrically reduced over $k$.

\medskip\noindent
Assume $R$ is geometrically reduced over $k$.
For any extension of fields $k \subset k'$ we see
irreducibility of the spectrum of $R \otimes_k k'$
is equivalent to $R \otimes_k k'$ being a domain. Assume (2).
Let $k \subset \overline{k}$ be a separable algebraic closure of $k$.
Using Lemma \ref{lemma-limit-argument}
we see that (2) is equivalent to $R \otimes_k \overline{k}$ being a domain.
For any field extension $k \subset k'$, there exists a field
extension $\overline{k} \subset \overline{k}'$ with
$k' \subset \overline{k}'$. By Lemma \ref{lemma-separably-closed-irreducible}
we see that $R \otimes_k \overline{k}'$ is a domain.
If $R \otimes_k k'$ is not a domain,
then also $R \otimes_k \overline{k}'$ is not a domain, contradiction.
\end{proof}

\begin{definition}
\label{definition-geometrically-irreducible}
Let $k$ be a field.
Let $S$ be a $k$-algebra.
We say $S$ is {\it geometrically irreducible over $k$}
if for every field extension $k \subset k'$ the spectrum of
$R \otimes_k k'$ is irreducible\footnote{An irreducible space is nonempty.}.
\end{definition}

\noindent
By Lemma \ref{lemma-geometrically-irreducible} it suffices
to check this for finite separable field extensions $k \subset k'$.

\begin{lemma}
\label{lemma-separably-closed-irreducible-implies-geometric}
Let $k$ be a field.
Let $R$ be a $k$-algebra.
If $k$ is separably algebraically closed then $R$ is
geometrically irreducible over $k$ if and only if the
spectrum of $R$ is irreducible.
\end{lemma}

\begin{proof}
Immediate from the remark following
Definition \ref{definition-geometrically-irreducible}.
\end{proof}

\begin{lemma}
\label{lemma-subalgebra-geometrically-irreducible}
Let $k$ be a field. Let $S$ be a $k$-algebra.
\begin{enumerate}
\item If $S$ is geometrically irreducible over $k$ so is every
$k$-subalgebra.
\item If all finitely generated $k$-subalgebras of $S$ are
geometrically irreducible, then $S$ is geometrically irreducible.
\item A directed colimit of geometrically irreducible $k$-algebras
is geometrically irreducible.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $S' \subset S$ be a subalgebra. Then for any extension $k \subset k'$
the ring map $S' \otimes_k k' \to S \otimes_k k'$ is injective also.
Hence (1) follows from Lemma \ref{lemma-injective-minimal-primes-in-image}
(and the fact that the image of an irreducible space under a continuous
map is irreducible). The second and third property follow from the fact
that tensor product commutes with colimits.
\end{proof}

\begin{lemma}
\label{lemma-geometrically-irreducible-any-base-change}
Let $k$ be a field.
Let $S$ be a geometrically irreducible $k$-algebra.
Let $R$ be any $k$-algebra.
The map
$$
\text{Spec}(R \otimes_k S) \longrightarrow \text{Spec}(R)
$$
induces a bijection on irreducible components.
\end{lemma}

\begin{proof}
Recall that irreducible components correspond to minimal primes
(Lemma \ref{lemma-irreducible}).
As $R \to R \otimes_k S$ is flat we see by going down
(Lemma \ref{lemma-flat-going-down}) that
any minimal prime of $R \otimes_k S$ lies over a minimal prime of $R$.
Conversely, if $\mathfrak p \subset R$ is a (minimal) prime then
$$
R \otimes_k S/\mathfrak p(R \otimes_k S)
=
(R/\mathfrak p) \otimes_k S
\subset
f.f.(R/\mathfrak p) \otimes_k S
$$
by flatness of $R \to R \otimes_k S$. The ring
$f.f.(R/\mathfrak p) \otimes_k S$ has irreducible spectrum
by assumption. It follows that
$R \otimes_k S/\mathfrak p(R \otimes_k S)$ has a single minimal
prime (Lemma \ref{lemma-injective-minimal-primes-in-image}).
In other words, the inverse image of the irreducible set
$V(\mathfrak p)$ is irreducible.
Hence the lemma follows.
\end{proof}

\noindent
Let us make some remarks on the notion of geometrically irreducible
field extensions.

\begin{lemma}
\label{lemma-field-extension-geometrically-irreducible}
Let $k \subset K$ be a field extension.
If $k$ is algebraically closed in $K$, then
$K$ is geometrically irreducible over $k$.
\end{lemma}

\begin{proof}
Let $k \subset k'$ be a finite separable extension, say
generated by $\alpha \in k'$ over $k$ (see
Lemma \ref{lemma-finite-separable}). Let
$P = T^d + a_1 T^{d - 1} + \ldots + a_d \in k[T]$ be the minimal
polynomial of $\alpha$. Then $K \otimes_k k' \cong K[T]/(P)$.
The only way the spectrum of $K[T]/(P)$ can be reducible
is if $P$ is reducible in $K[T]$. Say $P = P_1P_2$ is
a nontrivial factorization of $P$ into monic polynomials.
Let $b_1, \ldots, b_t \in K$ be the coefficients of $P_1$.
Then we see that $b_i$ is algebraic over $k$ by
Lemma \ref{lemma-polynomials-divide}. Hence the lemma follows.
\end{proof}

\begin{lemma}
\label{lemma-make-geometrically-irreducible}
Let $k \subset K$ be a field extension.
Consider the subextension $k \subset k' \subset K$
such that $k \subset k'$ is separable algebraic and
$k' \subset K$ maximal with this property.
Then $K$ is geometrically irreducible over $k'$.
If $K/k$ is a finitely generated field extension, then
$[k' : k] < \infty$.
\end{lemma}

\begin{proof}
Let $k'' \subset K$ be the algebraic closure of $k$ in $K$.
By Lemma \ref{lemma-field-extension-geometrically-irreducible}
we see that $K$ is geometrically irreducible over $k''$.
Since $k' \subset k''$ is purely inseparable we see from
Lemma \ref{lemma-p-ring-map} that also the extension $k' \subset K$ is
geometrically irreducible (some details omitted).
If $k \subset K$ is finitely generated, then $k'$ is finite
over $k$ by Lemma \ref{lemma-algebraic-closure-in-finitely-generated}.
\end{proof}

\begin{lemma}
\label{lemma-Galois-orbit}
Let $k \subset K$ be an extension of fields.
Let $k \subset \overline{k}$ be a separable algebraic closure.
Then $\text{Gal}(\overline{k}/k)$ acts transitively on the
primes of $\overline{k} \otimes_k K$.
\end{lemma}

\begin{proof}
Let $k \subset k' \subset K$ be the subextension found in
Lemma \ref{lemma-make-geometrically-irreducible}.
Note that as $k \subset \overline{k}$ is integral all the prime ideals
of $\overline{k} \otimes_k K$ and $\overline{k} \otimes_k k'$ are maximal, see
Lemma \ref{lemma-integral-no-inclusion}.
In particular the residue field of any prime ideal of
$\overline{k} \otimes_k k'$ is isomorphic to $\overline{k}$.
Hence the prime ideals of $\overline{k} \otimes_k k'$ correspond one to
one to elements of $\text{Hom}_k(k' \overline{k})$ with
$\sigma \in \text{Hom}_k(k' \overline{k})$ corresponding to the
kernel $\mathfrak p_\sigma$ of
$1 \otimes \sigma : \overline{k} \otimes_k k' \to \overline{k}$.
In particular $\text{Gal}(\overline{k}/k)$ acts transitively on
this set.
Finally, since $K$ is geometrically irreducible over $k'$ we
see that there is a unique prime of $\overline{k} \otimes_k K$
lying over each $\mathfrak p_\sigma$ since the set of these primes
is the set of primes in the ring
$$
(\overline{k} \otimes_k K)
\otimes_{(\overline{k} \otimes_k k'), 1 \otimes \sigma}
\kappa(\mathfrak p_\sigma)
=
\overline{k} \otimes_{\overline{k}} (K \otimes_{k'} \overline{k})
=
K \otimes_{k', \sigma} \overline{k}
$$
Thus the lemma holds.
\end{proof}

\begin{lemma}
\label{lemma-separably-closed-connected}
Let $k$ be a separably algebraically closed field.
Let $R$, $S$ be $k$-algebras. If $\text{Spec}(R)$, and
$\text{Spec}(S)$ are connected, then so is
$\text{Spec}(R \otimes_k S)$.
\end{lemma}

\begin{proof}
Recall that $\text{Spec}(R)$ is connected if and only if
$R$ has no nontrivial idempotents, see
Lemma \ref{lemma-characterize-spec-connected}.
Hence, by Lemma \ref{lemma-limit-argument} we may assume $R$ and $S$ are of
finite type over $k$.
In this case $R$ and $S$ are Noetherian,
and have finitely many minimal primes, see
Lemma \ref{lemma-Noetherian-irreducible-components}.
Thus we may argue by induction on $n + m$ where $n$, resp.\ $m$
is the number of irreducible components of $\text{Spec}(R)$,
resp.\ $\text{Spec}(S)$. Of course the case where either $n$ or
$m$ is zero is trivial. If $n = m = 1$, i.e.,
$\text{Spec}(R)$ and $\text{Spec}(S)$ both have one irreducible component,
then the result holds by Lemma \ref{lemma-separably-closed-irreducible}.
Suppose that $n > 1$. Let $\mathfrak p \subset R$ be a minimal prime
corresponding to the irreducible closed subset $T \subset \text{Spec}(R)$.
Let $I \subset R$ be such that $T' = V(I) \subset \text{Spec}(R)$
is the closure of the complement of $T$. Note that this means
that $T' = \text{Spec}(R/I)$ (Lemma \ref{lemma-spec-closed}) has $n - 1$
irreducible components. Then $T \cup T' = \text{Spec}(R)$,
and $T \cap T' = V(\mathfrak p + I) = \text{Spec}(R/(\mathfrak p + I))$
is not empty as $\text{Spec}(R)$ is assumed connected.
The inverse image of $T$ in $\text{Spec}(R \otimes_k S)$
is $\text{Spec}(R/\mathfrak p \otimes_k S)$, and the inverse
of $T'$ in $\text{Spec}(R \otimes_k S)$
is $\text{Spec}(R/I \otimes_k S)$. By induction these are both
connected. The inverse image of $T \cap T'$ is
$\text{Spec}(R/(\mathfrak p + I) \otimes_k S)$ which is nonempty.
Hence $\text{Spec}(R \otimes_k S)$ is connected.
\end{proof}

\begin{lemma}
\label{lemma-geometrically-connected}
Let $k$ be a field.
Let $R$ be a $k$-algebra.
The following are equivalent
\begin{enumerate}
\item for every field extension $k \subset k'$ the
spectrum of $R \otimes_k k'$ is connected, and
\item for every finite separable field extension $k \subset k'$ the
spectrum of $R \otimes_k k'$ is connected.
\end{enumerate}
\end{lemma}

\begin{proof}
For any extension of fields $k \subset k'$ the connectivity
of the spectrum of $R \otimes_k k'$ is equivalent to $R \otimes_k k'$
having no nontrivial idempotents, see
Lemma \ref{lemma-characterize-spec-connected}. Assume (2).
Let $k \subset \overline{k}$ be a separable algebraic closure of $k$.
Using Lemma \ref{lemma-limit-argument}
we see that (2) is equivalent to $R \otimes_k \overline{k}$
having no nontrivial idempotents.
For any field extension $k \subset k'$, there exists a field
extension $\overline{k} \subset \overline{k}'$ with
$k' \subset \overline{k}'$. By Lemma \ref{lemma-separably-closed-connected}
we see that $R \otimes_k \overline{k}'$ has no nontrivial idempotents.
If $R \otimes_k k'$ has a nontrivial idempotent,
then also $R \otimes_k \overline{k}'$, contradiction.
\end{proof}

\begin{definition}
\label{definition-geometrically-connected}
Let $k$ be a field.
Let $S$ be a $k$-algebra.
We say $S$ is {\it geometrically connected over $k$}
if for every field extension $k \subset k'$ the spectrum
of $R \otimes_k k'$ is connected.
\end{definition}

\noindent
By Lemma \ref{lemma-geometrically-connected} it suffices
to check this for finite separable field extensions $k \subset k'$.

\begin{lemma}
\label{lemma-separably-closed-connected-implies-geometric}
Let $k$ be a field.
Let $R$ be a $k$-algebra.
If $k$ is separably algebraically closed then $R$ is
geometrically connected over $k$ if and only if the
spectrum of $R$ is connected.
\end{lemma}

\begin{proof}
Immediate from the remark following
Definition \ref{definition-geometrically-connected}.
\end{proof}

\begin{lemma}
\label{lemma-subalgebra-geometrically-connected}
Let $k$ be a field. Let $S$ be a $k$-algebra.
\begin{enumerate}
\item If $S$ is geometrically connected over $k$ so is every
$k$-subalgebra.
\item If all finitely generated $k$-subalgebras of $S$ are
geometrically connected, then $S$ is geometrically connected.
\item A directed colimit of geometrically irreducible $k$-algebras
is geometrically connected.
\end{enumerate}
\end{lemma}

\begin{proof}
This follows from the characterization of connectedness in terms of the
nonexistence of nontrivial idempotents. The second and third property follow
from the fact that tensor product commutes with colimits.
\end{proof}

\noindent
The following lemma will be superceded by the more general
Varieties, Lemma \ref{varieties-lemma-bijection-connected-components}.

\begin{lemma}
\label{lemma-geometrically-connected-any-base-change}
Let $k$ be a field.
Let $S$ be a geometrically connected and nonzero $k$-algebra.
Let $R$ be any $k$-algebra.
The map
$$
R \longrightarrow R \otimes_k S
$$
induces a bijection on idempotents, and the map
$$
\text{Spec}(R \otimes_k S) \longrightarrow \text{Spec}(R)
$$
induces a bijection on connected components.
\end{lemma}

\begin{proof}
The second assertion follows from the first combined with
Lemma \ref{lemma-connected-component}.
By Lemmas \ref{lemma-subalgebra-geometrically-connected}
and \ref{lemma-limit-argument} we may assume that $R$ and $S$
are of finite type over $k$. Then we see that also
$R \otimes_k S$ is of finite type over $k$. Note that in this
case all the rings are Noetherian and hence their spectra
have finitely many connected components (since they have
finitely many irreducible components, see
Lemma \ref{lemma-Noetherian-irreducible-components}).
In particular, all connected components in question are open!
Hence via Lemma \ref{lemma-disjoint-implies-product}
we see that the first statement of the
lemma in this case is equivalent to the second. Let's prove this.
As the algebra $S$ is geometrically connected
and nonzero we see that all fibres of $X = \text{Spec}(R \otimes_k S)
\to \text{Spec}(R) = Y$ are connected and nonempty. Also, as
$R \to R \otimes_k S$ is flat of finite presentation the map
$X \to Y$ is open (Lemma \ref{proposition-fppf-open}).
Topology, Lemma \ref{topology-lemma-connected-fibres-connected-components}
shows that $X \to Y$ induces bijection on connected components.
\end{proof}











\section{Valuation rings}
\label{section-valuation-rings}

\noindent
Here are some definitions.

\begin{definition}
\label{definition-valuation-ring}
Valuation rings.
\begin{enumerate}
\item Let $K$ be a field. Let $A$, $B$ be local rings contained
in $K$. We say that $A$ {\it dominates} $B$ if $A \subset B$
and $\mathfrak m_A = A \cap \mathfrak m_B$.
\item Let $A$ be a ring. We say $A$ is a {\it valuation ring}
if $A$ is a local domain, not a field, and if $A$ is maximal
for the relation of domination among local rings contained in
the fraction field of $A$.
\item Let $A$ be a valuation ring with fraction field $K$.
If $R \subset K$ is a subring of $K$, then we say $A$
is {\it centered} on $R$ if $R \subset A$.
\end{enumerate}
\end{definition}

\begin{lemma}
\label{lemma-dominate}
Let $K$ be a field.
Let $A \subset K$ be a local subring which is not a field.
Then there exists a valuation ring with fraction field $K$
dominating $A$.
\end{lemma}

\begin{proof}
During this proof, and during this proof only, the phrase
``local ring'' will mean ``local ring, not a field''.
We consider the collection of local subrings
of $K$ as a partially ordered set using the relation of domination.
Suppose that $\{A_i\}_{i \in I}$ is a totally ordered
collection of local subrings of $K$. Then $B = \bigcup A_i$
is a local subring which dominates all of the $A_i$.
Hence by Zorn's Lemma, it suffices to show that if $A \subset K$
is a local ring whose fraction field is not $K$, then there
exists a local ring $B \subset K$, $B \not = A$ dominating $A$.

\medskip\noindent
Pick $t \in K$ which is not in the fraction field of $A$.
If $t$ is transcendental over $A$, then $A[t] \subset K$
and hence $A[t]_{(t, \mathfrak m)} \subset K$ is a local ring
dominating $A$.
Suppose $t$ is algebraic over $A$.
Then for some $a \in A$ the element $at$ is integral over $A$.
In this case the subring $A' \subset K$ generated by $A$ and
$ta$ is finite over $A$.
By Lemma \ref{lemma-integral-overring-surjective} there exists
a prime ideal $\mathfrak m' \subset A'$ lying over
$\mathfrak m$. Then $A'_{\mathfrak m'}$ clearly dominates
$A$ and we win.
\end{proof}

\begin{lemma}
\label{lemma-valuation-ring-x-or-x-inverse}
Let $A$ be a valuation ring with maximal ideal $\mathfrak m$ and
fraction field $K$.
Let $x \in K$. Then either $x \in A$ or $x^{-1} \in A$ or both.
\end{lemma}

\begin{proof}
Assume that $x$ is not in $A$.
Let $A'$ denote the subring of $A$ generated by $A$ and $x$.
Since $A$ is a valuation ring we see that there is no prime
of $A'$ lying over $\mathfrak m$. Hence we can write
$1 = \sum_{i = 0}^d t_i x^i$ with $t_i \in \mathfrak m$.
This implies that $(1 - t_0) (x^{-1})^d - \sum t_i (x^{-1})^{d - i} = 0$.
In particular we see that $x^{-1}$ is integral over $A$.
Thus the subring $A''$ of $K$ generated by $A$ and $x^{-1}$ is
finite over $A$ and we see there exists a prime ideal
$\mathfrak m'' \subset A''$ lying over $\mathfrak m$ by
Lemma \ref{lemma-integral-overring-surjective}. Since $A$
is a valuation ring we conclude that $A = (A'')_{\mathfrak m''}$
and hence $x^{-1} \in A$.
\end{proof}

\begin{lemma}
\label{lemma-x-or-x-inverse-valuation-ring}
Let $A \subset K$ be a local domain contained in a field $K$.
Assume that $A$ is not a field, and for every
$x \in K$ either $x \in A$ or $x^{-1} \in A$ or both.
Then $A$ is a valuation ring.
\end{lemma}

\begin{proof}
Suppose that $A'$ is a local ring contained in $K$ which dominates
$A$. Let $x \in A'$. We have to show that $x \in A$. If not, then
$x^{-1} \in A$, and of course $x^{-1} \in \mathfrak m_A$. But then
$x^{-1} \in \mathfrak m_{A'}$ which contradicts $x \in A'$.
\end{proof}

\begin{lemma}
\label{lemma-valuation-ring-cap-field}
Let $K \subset L$ be an extension of fields. If $B \subset L$
is a valuation ring, then $A = K \cap B$ is either a field
or a valuation ring.
\end{lemma}

\begin{proof}
Omitted. Hint: Combine
Lemmas \ref{lemma-valuation-ring-x-or-x-inverse} and
\ref{lemma-x-or-x-inverse-valuation-ring}.
\end{proof}

\begin{lemma}
\label{lemma-valuation-ring-normal}
Let $A$ be a valuation ring.
Then $A$ is a normal domain.
\end{lemma}

\begin{proof}
Suppose $x$ is in the field of fractions of $A$ and integral over $A$,
say $x^d + \sum_{i < d} a_i x^i = 0$. By the previous lemma either
$x \in A$ (and we're done) or $x^{-1} \in A$. In the second case
we see that $x = - \sum a_i x^{i - d} \in A$ as well.
\end{proof}

\noindent
An {\it totally ordered abelian group} is a pair $(\Gamma, \geq)$
consisting of an abelian group $\Gamma$ endowed with a total
ordering $\geq$ such that $\gamma \geq \gamma' \Rightarrow
\gamma + \gamma'' \geq \gamma' + \gamma''$ for all
$\gamma, \gamma', \gamma'' \in \Gamma$.

\begin{lemma}
\label{lemma-valuation-group}
Let $A$ be a valuation ring with field of fractions $K$.
Set $\Gamma = K^*/A^*$ (with group law written additively).
For $\gamma, \gamma' \in \Gamma$
define $\gamma \geq \gamma'$ if and only if
$\gamma - \gamma'$ is in the image of $A - \{0\} \to \Gamma$.
Then $(\Gamma, \geq)$ is a totally ordered abelian group.
\end{lemma}

\begin{proof}
Omitted, but follows easily from
Lemma \ref{lemma-valuation-ring-x-or-x-inverse} above.
\end{proof}

\begin{definition}
\label{definition-value-group}
Let $A$ be a valuation ring.
\begin{enumerate}
\item The totally ordered abelian group $(\Gamma, \geq)$ is called the
{\it value group} of the valuation ring $A$.
\item The map $v : A - \{0\} \to \Gamma$ and also $v : K^* \to \Gamma$ is
called the {\it valuation} associated to $A$.
\item The valuation ring $A$ is called a {\it discrete valuation ring}
if $\Gamma \cong \mathbf{Z}$.
\end{enumerate}
\end{definition}

\noindent
Note that if $\Gamma \cong \mathbf{Z}$ then there is a unique such
isomorphism such that $1 \geq 0$. If the isomorphism is chose in this
way, then the ordering becomes the usual ordering of the integers.

\begin{lemma}
\label{lemma-properties-valuation}
Let $A$ be a valuation ring. The valution $v : A -\{0\} \to \Gamma_{\geq 0}$
has the following properties:
\begin{enumerate}
\item $v(a) = 0 \Leftrightarrow a \in A^*$,
\item $v(ab) = v(a) + v(b)$,
\item $v(a + b) \geq \text{min}(v(a), v(b))$.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-valuation-valuation-ring}
Let $(\Gamma, \geq)$ be a totally ordered abelian group.
Let $K$ be a field. Let $v : K^* \to \Gamma$ be a homomorphism
of abelian groups. Then
$$
A =
\{
x \in K \mid x = 0 \text{ or } v(x) \geq 0
\}
$$
is a valuation ring with value group $\text{Im}(v) \subset \Gamma$,
with maximal ideal
$$
\mathfrak m =
\{
x \in K \mid x = 0 \text{ or } v(x) > 0
\}
$$
and with group of units
$$
A^* =
\{
x \in K^* \mid v(x) = 0
\}.
$$
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\noindent
Let $(\Gamma, \geq)$ be a totally ordered abelian group.
An {\it ideal of $\Gamma$} is a subset $I \subset \Gamma$ such
that all elements of $I$ are $\geq 0$ and $\gamma \in I$,
$\gamma' \geq \gamma$ implies $\gamma' \in I$. We say that such
an ideal is {\it prime} if $\gamma + \gamma' \in I, \gamma, \gamma' \geq 0
\Rightarrow \gamma \in I \text{ or } \gamma' \in I$.

\begin{lemma}
\label{lemma-ideals-valuation-ring}
Let $A$ be a valuation ring.
Ideals in $A$ correspond $1 - 1$ with ideals of $\Gamma$.
This bijection is inclusion preserving, and maps prime
ideals to prime ideals.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-valuation-ring-Noetherian-discrete}
A valuation ring is Noetherian if and only if it is
a discrete valuation ring.
\end{lemma}

\begin{proof}
Suppose $A$ is a discrete valutation ring
with valuation $v : A \setminus \{0\} \to \mathbf{Z}$
normalized so that $\text{Im}(v) \subset \mathbf{Z}_{\geq 0}$.
By Lemma \ref{lemma-ideals-valuation-ring} the ideals of $A$ are the subsets
$I_n = \{0\} \cup v^{-1}(\mathbf{Z}_{\geq n})$. It is clear
that any element $x \in A$ with $v(x) = n$ generates $I_n$.
Hence $A$ is a PID so certainly Noetherian.

\medskip\noindent
Suppose $A$ is a Noetherian valuation ring with value group $\Gamma$.
By Lemma \ref{lemma-ideals-valuation-ring} we see the ascending chain
condition holds for ideals in $\Gamma$. In particular, by considering
the subsets $\gamma + \Gamma_{\geq 0}$ with $\gamma > 0$ we see
there exists a smallest element $\gamma_0$ which is bigger than $0$.
Let $\gamma \in \Gamma$ be an element $\gamma > 0$. Consider the sequence
of elements $\gamma$, $\gamma - \gamma_0$, $\gamma - 2\gamma_0$,
etc. By the ascending chain condition these cannot all be $> 0$.
Let $\gamma - n \gamma_0$ be the last one $\geq 0$. By minimality
of $\gamma_0$ we see that $0 = \gamma - n \gamma_0$. Hence $\Gamma$
is a cyclic group as desired.
\end{proof}

\begin{lemma}
\label{lemma-valuation-ring-colimit-affine-blowups}
Let $(R, \mathfrak m)$ be a local domain with fraction field $K$.
Let $R \subset A \subset K$ be a valuation ring which dominates $R$.
Then
$$
A = \text{colim}\ R[\textstyle\frac{I}{a}]
$$
is a directed colimit of affine blowups $R \to R[\frac{I}{a}]$ with
the following two properties
\begin{enumerate}
\item $a \in I \subset \mathfrak m$,
\item $I$ is finitely generated, and
\item the fibre ring of $R \to R[\frac{I}{a}]$ at $\mathfrak m$
is not zero.
\end{enumerate}
\end{lemma}

\begin{proof}
Consider a finite subset $E \subset A$. Say $E = \{e_1, \ldots, e_n\}$.
Choose a nonzero $a \in R$ such that we can write $e_i = f_i/a$ for
all $i = 1, \ldots, n$. Set $I = (f_1, \ldots, f_n, a)$.
We claim that $R[\frac{I}{a}] \subset A$. This is clear as an element
of $R[\frac{I}{a}]$ can be represented as a polynomial in the elements
$e_i$. The lemma follows immediately from this observation.
\end{proof}























\section{More Noetherian rings}
\label{section-Noetherian-again}


\begin{lemma}
\label{lemma-Noetherian-basic}
Let $R$ be a Noetherian ring.
Any finite $R$-module is of finite presentation.
Any submodule of a finite $R$-module is finite.
The ascending chain condition holds for $R$-submodules
of a finite $R$-module.
\end{lemma}

\begin{proof}
We first show that any submodule $N$ of a finite $R$-module
$M$ is finite. We do this by induction on the number of
generators of $M$. If this number is $1$, then $N = J/I \subset
M = R/I$ for some ideals $I \subset J \subset R$. Thus the definition
of Noetherian implies the result. If the number of generators of
$M$ is greater than $1$, then we can find a short exact sequence
$0 \to M' \to M \to M'' \to 0$ where $M'$ and $M''$ have fewer
generators. Note that setting $N' = M' \cap N$ and $N'' = \text{Im}(N \to
M'')$ gives a similar short exact sequence for $N$. Hence the result
follows from the induction hypothesis
since the number of generators of $N$ is at most the number of
generators of $N'$ plus the number of generators of $N''$.

\medskip\noindent
To show that $M$ is finitely presented just apply the previous result
to the kernel of a presentation $R^n \to M$.

\medskip\noindent
It is well known and easy to prove that the ascending chain condition for
$R$-submodules of $M$ is equivalent to the condition that every submodule
of $M$ is a finite $R$-module. We omit the proof.
\end{proof}

\begin{definition}
\label{definition-locally-nilpotent-ideal}
Let $R$ be a ring. Let $I \subset R$ be an ideal.
We say $I$ is {\it locally nilpotent} if for every
$x \in I$ there exists an $n \in \mathbf{N}$ such
that $x^n = 0$. We say $I$ is {\it nilpotent} if
there exists an $n \in \mathbf{N}$ such that $I^n = 0$.
\end{definition}

\begin{lemma}
\label{lemma-Noetherian-power}
Let $R$ be a Noetherian ring. Let $I, J$ be ideals of $R$.
Suppose $J \subset \sqrt{I}$. Then $J^n \subset I$ for some $n$.
In particular, in a Noetherian ring the notions of
``locally nilpotent ideal''
and ``nilpotent ideal'' coincide.
\end{lemma}

\begin{proof}
Say $J = (f_1, \ldots, f_s)$.
By assumption $f_i^{d_i} \in I$.
Take $n = d_1 + d_2 + \ldots + d_s + 1$.
\end{proof}

\begin{lemma}
\label{lemma-Artin-Rees}
(Artin-Rees lemma)
Suppose that $R$ is Noetherian, $I \subset R$ an ideal.
Let $N \subset M$ be finite $R$-modules.
There exists a constant $c > 0$ such that
$I^n M \cap N  =  I^{n-c}(I^cM \cap N)$.
\end{lemma}

\begin{proof}
Consider the ring $S = R \oplus I \oplus I^2 \oplus \ldots
= \bigoplus_{n \geq 0} I^n$. Convention: $I^0 = R$.
Multiplication maps $I^n \times I^m$
into $I^{n + m}$ by multiplication in $R$.
Note that if $I = (f_1, \ldots, f_t)$
then $S$ is a quotient of the Noetherian ring $R[X_1, \ldots, X_t]$.
The map just sends the monomial $X_1^{e_1}\ldots X_t^{e_t}$
to $f_1^{e_1}\ldots f_t^{e_t}$. Thus $S$ is Noetherian.
Similarly, consider the module $M \oplus IM \oplus I^2M \oplus \ldots
= \bigoplus_{n \geq 0} I^nM$. This is a finitely generated $S$-module.
Namely, if $x_1, \ldots, x_r$ generate $M$ over $R$, then they also generate
$\bigoplus_{n \geq 0} I^nM$ over $S$. Next, consider the
submodule $\bigoplus_{n \geq 0} I^nM \cap N$.
This is an $S$-submodule, as is easily verified. By
Lemma \ref{lemma-Noetherian-basic} it is finitely generated as
an $S$-module,
say by $\xi_j \in \bigoplus_{n \geq 0} I^nM \cap N$, $j = 1, \ldots, s$.
We may assume by decomposing each $\xi_j$ into its homogeneous
pieces that each $\xi_j \in I^{d_j}M \cap N$ for some $d_j$.
Set $c = \max\{d_j\}$. Then for all $n \geq c$ every element
in $I^nM \cap N$ is of the form $\sum h_j \xi_j$ with
$h_j \in I^{n - d_j}$. The lemma now follows from this and the trivial
observation that $I^{n-d_j}(I^{d_j}M \cap N) \subset I^{n-c}(I^cM \cap N)$.
\end{proof}

\begin{lemma}
\label{lemma-map-AR}
Suppose that $0 \to K \to M \xrightarrow{f} N$ is an
exact sequence of finitely generated modules
over a Noetherian ring $R$. Let $I \subset R$ be an ideal.
Then there exists a $c$ such that $f^{-1}(I^nN)
= K + I^{n-c}f^{-1}(I^cN)$ for all $n \geq c$.
\end{lemma}

\begin{proof}
Apply Lemma \ref{lemma-Artin-Rees} to
$\text{Im}(f) \subset N$ and note that
$f : I^{n-c}M \to I^{n-c}f(M)$ is surjective.
\end{proof}

\begin{lemma}
\label{lemma-intersect-powers-ideal-module-zero}
Let $R$ be a Noetherian local ring. Let $I \subset R$ be
a proper ideal. Let $M$ be a finite $R$-module.
Then $\bigcap_{n \geq 0} I^nM = 0$.
\end{lemma}

\begin{proof}
Let $N = \bigcap_{n \geq 0} I^nM$.
Then $N = I^nM \cap N$ for all $n \geq 0$.
By the Artin-Rees Lemma \ref{lemma-Artin-Rees}
we see that $N = I^nM \cap N \subset IN$ for
some suitably large $n$. By Nakayama's Lemma \ref{lemma-NAK}
we see that $N = 0$.
\end{proof}

\begin{lemma}
\label{lemma-intersection-powers-ideal-module}
Let $R$ be a Noetherian ring.
Let $I \subset R$ be an ideal.
Let $M$ be a finite $R$-module.
Let $N = \bigcap_n I^n M$.
For every prime $\mathfrak p$,
$I \subset \mathfrak p$ there
exists a $f \in R$, $f \not \in \mathfrak p$
such that $N_f = 0$.
\end{lemma}

\begin{proof}
Let $x_1, \ldots, x_n$ be generators for the module $N$,
see Lemma \ref{lemma-Noetherian-basic}. For every prime
$\mathfrak p$, $I \subset \mathfrak p$ we see that
the image of $N$ in the localization $M_{\mathfrak p}$
is zero, by Lemma \ref{lemma-intersect-powers-ideal-module-zero}.
Hence we can find $g_i \in R$, $g_i \not \in \mathfrak p$
such that $x_i$ maps to zero in $N_{g_i}$. Thus
$N_{g_1g_2\ldots g_n} = 0$.
\end{proof}

\begin{remark}
\label{remark-intersection-powers-ideal}
Lemma \ref{lemma-intersect-powers-ideal-module-zero}
in particular implies that $\bigcap_n I^n = (0)$
when $I \subset R$ is a non-unit ideal in a Noetherian
local ring $R$. More generally, let $R$ be a Noetherian ring and
$I \subset R$ an ideal. Suppose that $f \in \bigcap_{n \in \mathbf{N}} I^n$.
Then Lemma \ref{lemma-intersection-powers-ideal-module}
says that for every prime ideal $I \subset \mathfrak p$
there exists a $g \in R$, $g \not \in \mathfrak p$
such that $f$ maps to zero in $R_g$. In algebraic geometry we
express this by saying that ``$f$ is zero in an open neighbourhood
of the closed set $V(I)$ of $\text{Spec}(R)$''.
\end{remark}

\begin{lemma}
\label{lemma-Artin-Tate}
(Artin-Tate) Let $R$ be a Noetherian ring. Let $S$ be a finitely
generated $R$-algebra. If $T \subset S$ is an $R$-subalgebra such
that $S$ is finitely generated as a $T$-module, then $T$ is a
finite type over $R$.
\end{lemma}

\begin{proof}
Choose elements $x_1, \ldots, x_n \in S$ which generate $S$ as an $R$-algebra.
Choose $y_1, \ldots, y_m$ in $S$ which generate $S$ as a $T$-module.
Thus there exist $a_{ij} \in T$ such that
$x_i = \sum a_{ij} y_j$. There also exist $b_{ijk} \in T$ such
that $y_i y_j = \sum b_{ijk} y_k$. Let $T' \subset T$ be the
sub $R$-algebra generated by $a_{ij}$ and $b_{ijk}$. This is a finitely
generated $R$-algebra, hence Noetherian. Consider the algebra
$$
S' = T'[Y_1, \ldots, Y_m]/(Y_i Y_j - \sum b_{ijk} Y_k).
$$
Note that $S'$ is finite over $T'$, namely as a $T'$-module it is
generated by the classes of $1, Y_1, \ldots, Y_m$.
Consider the $T'$-algebra homomorphism $S' \to S$ which maps
$Y_i$ to $y_i$. Because $a_{ij} \in T'$ we see that $x_j$ is
in the image of this map. Thus $S' \to S$ is surjective.
Therefore $S$ is finite over $T'$ as well. Since $T'$ is Noetherian
and we conclude that $T \subset S$ is finite over $T'$ and
we win.
\end{proof}

\begin{lemma}
\label{lemma-fibre-product-finite-type}
Let $R$ be a ring.
Let $\alpha : A \to B$ and $\gamma : C \to B$ be $R$-algebra maps.
Assume
\begin{enumerate}
\item $A \to B$ is surjective, and
\item $B$ is finite over $C$.
\end{enumerate}
Then the fibre product ring $T = \{(a, c) \mid \alpha(a) = \gamma(c)\}$
is of finite type over $R$.
\end{lemma}

\begin{proof}
Note that there is a commutative diagram
$$
\xymatrix{
0 \ar[r] &
I \ar[r] &
A \ar[r] &
B \ar[r] &
0 \\
0 \ar[r] &
I \ar[r] \ar[u] &
T \ar[r] \ar[u] &
C \ar[r] \ar[u] &
0
}
$$
with exact rows. Choose $y_1, \ldots, y_n$ which are generators for
$B$ as a $C$-module. Choose $x_1, \ldots, x_n \in A$ mapping to $y_i$.
Then it is clear that $1, x_1, \ldots, x_n$ are generators for
$A$ as a $T$-module. By the diagram the map
$T \to A \times C$ is injective, and by what we just said the
ring $A \times C$ is finite as a $T$-module (because it is the
direct sum of the finite modules $A$ and $C$).
Hence the lemma follows from the Artin-Tate Lemma \ref{lemma-Artin-Tate}.
\end{proof}






















\section{Length}
\label{section-length}

\begin{definition}
\label{definition-length}
Let $R$ be a ring. For any $R$-module $M$
we define the {\it length} of $M$ over $R$ by the
formula
$$
\text{length}_R(M)
=
\sup
\{
n
\mid
\exists\ 0 = M_0 \subset M_1 \subset \ldots \subset M_n = M,
\text{ }M_i \not= M_{i + 1}
\}.
$$
\end{definition}

\noindent
In other words it is the supremum of the lengths of chains
of submodules. There is an obvious notion of when a chain
of submodules is a refinement of another. This gives a partial
ordering on the collection of all chains of submodules,
with the smallest chain having the shape $0 = M_0 \subset M_1 = M$
if $M$ is not zero.
We note the obvious fact that if the length of
$M$ is finite, then every chain can be refined to a
maximal chain. But it is not as obvious that all maximal
chains have the same length (as we will see later).

\begin{lemma}
\label{lemma-finite-length-finite}
Let $R$ be a ring.
Let $M$ be an $R$-module.
If $\text{length}_R(M) < \infty$ then $M$ is a finite $R$-module.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-length-additive}
If $0 \to M' \to M \to M'' \to 0$
is a short exact sequence of modules over $R$ then
the length of $M$ is the sum of the
lengths of $M'$ and $M''$.
\end{lemma}

\begin{proof}
Given filtrations of $M'$ and $M''$ of lengths $n', n''$
it is easy to make a corresponding filtration of $M$
of length $n' + n''$. Thus we see that $\text{length}_R M
\geq \text{length}_R M' + \text{length}_R M''$.
Conversely, given a filtration
$M_0 \subset M_1 \subset \ldots \subset M_n$ of
$M$ consider the induced filtrations
$M_i' = M_i \cap M'$ and $M_i'' = \text{Im}(M_i \to M'')$.
Let $n'$ (resp.\ $n''$) be the number of steps in the filtration
$\{M'_i\}$ (resp.\ $\{M''_i\}$).
If $M_i' = M_{i + 1}'$ and $M_i'' = M_{i + 1}''$ then
$M_i = M_{i + 1}$. Hence we conclude that $n' + n'' \geq n$.
Combined with the earlier result we win.
\end{proof}

\begin{lemma}
\label{lemma-length-infinite}
Let $R$ be a local ring with maximal ideal $\mathfrak m$.
Let $M$ be an $R$-module.
\begin{enumerate}
\item If $M$ is a finite and
$\mathfrak m^n M \not = 0$ for all $n\geq 0$,
then $\text{length}_R(M) = \infty$.
\item If $M$ has finite length then $\mathfrak m^nM = 0$
for some $n$.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume $M$ is finite and $\mathfrak m^n M \not = 0$ for all $n\geq 0$.
By NAK, Lemma \ref{lemma-NAK} all the steps in the filtration
$0 \subset \mathfrak m^n M
\subset \mathfrak m^{n-1} M \subset \ldots \subset
\mathfrak m M \subset M$ are distinct. Hence the length is infinite,
i.e., (1) holds.
Combine (1) and Lemma \ref{lemma-finite-length-finite} to see (2).
\end{proof}

\begin{lemma}
\label{lemma-length-independent}
Let $R \to S$ be a ring map. Let $M$ be an $S$-module.
We always have $\text{length}_R(M) \geq \text{length}_S(M)$.
If $R \to S$ is surjective then equality holds.
\end{lemma}

\begin{proof}
A filtration of $M$ by $S$-submodules gives rise a filtration
of $M$ by $R$-submodules. This proves the inequality.
And if $R \to S$ is surjective, then any $R$-submodule
of $M$ is automatically a $S$-submodule. Hence equality
in this case.
\end{proof}

\begin{lemma}
\label{lemma-dimension-is-length}
Let $R$ be a ring with maximal ideal $\mathfrak m$.
Suppose that $M$ is an $R$-module with
$\mathfrak m M  =  0$. Then the length of $M$ as
an $R$-module agrees with the dimension of $M$ as
a $R/\mathfrak m$ vector space.
The length is finite if and only if $M$ is a finite $R$-module.
\end{lemma}

\begin{proof}
The first part is a special case of Lemma \ref{lemma-length-independent}.
Thus the length is finite if and only if $M$ has a finite basis
as a $R/\mathfrak m$-vector space if and only if $M$ has a finite
set of generators as an $R$-module.
\end{proof}

\begin{lemma}
\label{lemma-length-localize}
Let $R$ be a ring. Let $M$ be an $R$-module. Let $S \subset R$ be
a multiplicative subset. Then
$\text{length}_R(M) \geq \text{length}_{S^{-1}R}(S^{-1}M)$.
\end{lemma}

\begin{proof}
Any submodule $N' \subset S^{-1}M$ is of the form
$S^{-1}N$ for some $R$-submodule $N \subset M$, by Lemma
\ref{lemma-submodule-localization}. The lemma follows.
\end{proof}

\begin{lemma}
\label{lemma-length-finite}
Let $R$ be a ring with finitely generated
maximal ideal $\mathfrak m$. (For example $R$ Noetherian.)
Suppose that $M$ is a finite $R$-module with
$\mathfrak m^n M  =  0$ for some $n$.
Then $\text{length}_R(M) < \infty$.
\end{lemma}

\begin{proof}
Consider the filtration
$0 = \mathfrak m^n M \subset
\mathfrak m^{n-1} M \subset
\ldots \subset \mathfrak m M \subset M$.
All of the subquotients are finitely generated $R$-modules
to which Lemma \ref{lemma-dimension-is-length} applies. We conclude
by additivity, see Lemma \ref{lemma-length-additive}.
\end{proof}

\begin{definition}
\label{definition-simple-module}
Let $R$ be a ring. Let $M$ be an $R$-module.
We say $M$ is {\it simple} if $M \not = 0$ and
every submodule of $M$ is either equal to $M$ or
to $0$.
\end{definition}

\begin{lemma}
\label{lemma-characterize-length-1}
Let $R$ be a ring. Let $M$ be an $R$-module.
The following are equivalent:
\begin{enumerate}
\item $M$ is simple,
\item $\text{length}_R(M) = 1$, and
\item $M \cong R/\mathfrak m$ for some maximal ideal
$\mathfrak m \subset R$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $\mathfrak m$ be a maximal ideal of $R$.
By Lemma \ref{lemma-dimension-is-length} the module
$R/\mathfrak m$ has length $1$. The equivalence of
the first two assertions is tautological.
Suppose that $M$ is simple. Choose $x \in M$, $x \not = 0$.
As $M$ is simple we have $M = R \cdot x$.
Let $I \subset R$ be the annihilator of $x$, i.e.,
$I = \{f \in R \mid fx = 0\}$. The map $R/I \to M$,
$f \bmod I \mapsto fx$ is an isomorphism, hence
$R/I$ is a simple $R$-module. Since $R/I \not = 0$ we see $I \not = R$.
Let $I \subset \mathfrak m$ be a maximal ideal containing $I$.
If $I \not = \mathfrak m$, then $\mathfrak m /I \subset R/I$
is a nontrivial submodule contradicting the simplicity
of $R/I$. Hence we see $I = \mathfrak m$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-simple-pieces}
Let $R$ be a ring. Let $M$ be a finite length $R$-module.
Let $\ell = \text{length}_R(M)$. Choose any maximal chain of
submodules
$$
0 = M_0 \subset M_1 \subset M_2 \subset \ldots \subset M_n = M
$$
with $M_i \not = M_{i-1}$, $i = 1, \ldots, n$. Then
\begin{enumerate}
\item $n = \ell$,
\item each $M_i/M_{i-1}$ is simple,
\item each $M_i/M_{i-1}$ is of the form
$R/\mathfrak m_i$ for some maximal ideal $\mathfrak m_i$,
\item given a maximal ideal $\mathfrak m \subset R$
we have
$$
\# \{i \mid \mathfrak m_i = \mathfrak m\}
=
\text{length}_{R_{\mathfrak m}} (M_{\mathfrak m}).
$$
\end{enumerate}
\end{lemma}

\begin{proof}
If $M_i/M_{i-1}$ is not simple then we can refine the filtration
and the filtration is not maximal. Thus we see that $M_i/M_{i-1}$
is simple. By Lemma \ref{lemma-characterize-length-1} the modules
$M_i/M_{i-1}$ have length $1$ and are of the form $R/\mathfrak m_i$
for some maximal ideals $\mathfrak m_i$. By additivity of length,
Lemma \ref{lemma-length-additive}, we see $n = \ell$. Since localization
is exact, we see that
$$
0 = (M_0)_{\mathfrak m}
\subset (M_1)_{\mathfrak m}
\subset (M_2)_{\mathfrak m}
\subset \ldots
\subset (M_n)_{\mathfrak m} = M_{\mathfrak m}
$$
is a filtration of $M_{\mathfrak m}$ with successive quotients
$(M_i/M_{i-1})_{\mathfrak m}$. Thus the last statement follows
directly from the fact that given maximal ideals $\mathfrak m$,
$\mathfrak m'$ of $R$ we have
$$
(R/\mathfrak m')_{\mathfrak m}
\cong
\left\{
\begin{matrix}
0 &
\text{if } \mathfrak m \not = \mathfrak m', \\
R_{\mathfrak m}/\mathfrak m R_{\mathfrak m} &
\text{if } \mathfrak m  = \mathfrak m'
\end{matrix}
\right.
$$
This we leave to the reader.
\end{proof}

\begin{lemma}
\label{lemma-pushdown-module}
Let $A$ be a local ring with maximal ideal $\mathfrak m$.
Let $B$ be a semi-local ring with maximal ideals $\mathfrak m_i$,
$i = 1, \ldots, n$.
Suppose that $A \to B$ is a homomorphism such that each $\mathfrak m_i$
lies over $\mathfrak m$ and such that
$$
[\kappa(\mathfrak m_i) : \kappa(\mathfrak m)] < \infty.
$$
Let $M$ be a $B$-module of finite length.
Then
$$
\text{length}_A(M) = \sum\nolimits_{i = 1, \ldots, n}
[\kappa(\mathfrak m_i) : \kappa(\mathfrak m)]
\text{length}_{B_{\mathfrak m_i}}(M_{\mathfrak m_i}),
$$
in particular $\text{length}_A(M) < \infty$.
\end{lemma}

\begin{proof}
Choose a maximal chain
$$
0 = M_0
\subset M_1
\subset M_2
\subset \ldots
\subset M_n = M
$$
by $B$-submodules as in Lemma \ref{lemma-simple-pieces}.
Then each quotient $M_i/M_{i - 1}$ is isomorphic to
$\kappa(\mathfrak m_{j(i)})$ for some $j(i) \in \{1, \ldots, n\}$.
Moreover
$\text{length}_A(\kappa(\mathfrak m_i)) =
[\kappa(\mathfrak m_i) : \kappa(\mathfrak m)]$ by
Lemma \ref{lemma-dimension-is-length}. The lemma follows
by additivity of lengths (Lemma \ref{lemma-length-additive}).
\end{proof}

\begin{lemma}
\label{lemma-pullback-module}
Let $A \to B$ be a flat local homomorphism of local rings.
Then for any $A$-module $M$ we have
$$
\text{length}_A(M) \text{length}_B(B/\mathfrak m_AB)
=
\text{length}_B(M \otimes_A B).
$$
In particular, if $\text{length}_B(B/\mathfrak m_AB) < \infty$
then $M$ has finite length if and only if $M \otimes_A B$ has finite length.
\end{lemma}

\begin{proof}
The ring map $A \to B$ is faithfully flat by
Lemma \ref{lemma-local-flat-ff}.
Hence if $0 = M_0 \subset M_1 \subset \ldots \subset M_n = M$
is a chain of length $n$ in $M$, then the corresponding chain
$0 = M_0 \otimes_A B \subset M_1 \otimes_A B \subset
\ldots \subset M_n \otimes_A B = M \otimes_A B$ has length $n$
also. This proves
$\text{length}_A(M) = \infty \Rightarrow
\text{length}_B(M \otimes_A B) = \infty$.
Next, assume $\text{length}_A(M) < \infty$. In this case we see
that $M$ has a filtration of length $\ell = \text{length}_A(M)$
whose quotients are $A/\mathfrak m_A$. Arguing as above
we see that $M \otimes_A B$ has a filtration of length $\ell$
whose quotients are isomorphic to
$B \otimes_A A/\mathfrak m_A =  B/\mathfrak m_AB$.
Thus the lemma follows.
\end{proof}

\begin{lemma}
\label{lemma-pullback-transitive}
Let $A \to B \to C$ be flat local homomorphisms of local rings.
Let $M$ be an $A$-module of finite length. Then
$$
\text{length}_B(B/\mathfrak m_A B)
\text{length}_C(C/\mathfrak m_B C)
=
\text{length}_C(C/\mathfrak m_A C)
$$
\end{lemma}

\begin{proof}
Follows from Lemma \ref{lemma-pullback-module} applied to the ring map
$B \to C$ and the $B$-module $M = B/\mathfrak m_A B$
\end{proof}











\section{Artinian rings}
\label{section-artinian}

\noindent
Artinian rings, and especially local Artinian rings,
play an important role in algebraic geometry, for example
in deformation theory.

\begin{definition}
\label{definition-artinian}
A ring $R$ is {\it Artinian} if it satisfies the
descending chain condition for ideals.
\end{definition}

\begin{lemma}
\label{lemma-finite-dimensional-algebra}
Suppose $R$ is a finite dimensional algebra over a field.
Then $R$ is Artinian.
\end{lemma}

\begin{proof}
The descending chain condition for ideals obviously holds.
\end{proof}

\begin{lemma}
\label{lemma-artinian-finite-nr-max}
If $R$ is Artinian then $R$ has only finitely many maximal ideals.
\end{lemma}

\begin{proof}
Suppose that $\mathfrak m_i$, $i = 1, 2, 3, \ldots$ are maximal ideals.
Then $\mathfrak m_1 \supset \mathfrak m_1\cap \mathfrak m_2
\supset \mathfrak m_1 \cap \mathfrak m_2 \cap \mathfrak m_3 \supset \ldots$
is an infinite descending sequence (because by the Chinese
remainder theorem all the maps $R \to \oplus_{i = 1}^n R/\mathfrak m_i$
are surjective).
\end{proof}

\begin{lemma}
\label{lemma-artinian-radical-nilpotent}
Let $R$ be Artinian. The radical $\text{rad}(R)$ of $R$ is
a nilpotent ideal.
\end{lemma}

\begin{proof}
Denote the radical $I$.
Note that $I \supset I^2 \supset I^3 \supset \ldots$ is a descending
sequence. Thus $I^n = I^{n + 1}$ for some $n$.
Set $J = \{ x\in R \mid xI^n = 0\}$. We have to show $J = R$.
If not, choose an ideal $J' \not= J$, $J \subset J'$ minimal (possible
by the Artinian property). Then $J' = J + Rx$ for some $x \in R$.
By NAK, Lemma \ref{lemma-NAK}, we have $IJ' \subset J$.
Hence $xI^{n + 1} \subset xI \cdot I^n \subset J \cdot I^n = 0$.
Since $I^{n + 1} = I^n$ we conclude $x\in J$. Contradiction.
\end{proof}

\begin{lemma}
\label{lemma-lift-idempotents}
Let $R$ be a ring. Let $I \subset R$ be a locally nilpotent ideal.
Then $R \to R/I$ induces a bijection on idempotents.
\end{lemma}

\begin{proof}[First proof of Lemma \ref{lemma-lift-idempotents}]
As $I$ is locally nilpotent it is contained in every prime ideal.
Hence $\text{Spec}(R/I) = V(I) = \text{Spec}(R)$. Hence the
lemma follows from Lemma \ref{lemma-disjoint-decomposition}.
\end{proof}

\begin{proof}[Second proof of Lemma \ref{lemma-lift-idempotents}]
First assume $I$ is nilpotent.
Suppose $\overline{e} \in R/I$ is an idempotent.
We have to lift $\overline{e}$ to an idempotent of $R$.
Choose a lift $e \in R$ such that $x = e^2 - e \in I^k$ for some
$k\geq 1$. Let $e' = e - (2e-1)x$, which is another lift of $\overline{e}$
and compute $(e')^2 - e' =
e^2 - 2(2e-e)x - e + (2e-1)x \bmod I^{2k} =
x - x \bmod I^{2k} = 0 \bmod I^{2k}$.
By succesively improving the approximation as above we reach a
stage where $I^k = 0$, and we win.

\medskip\noindent
Next, suppose $I$ is locally nilpotent.
Let $\overline{e} \in R/I$ be an idempotent.
Let $f \in R$ be any element lifting $\overline{e}$.
Denote $R' \subset R$ the $\mathbf{Z}$-subalgebra of $R$ generated
by $f$. Denote $I' = R' \cap I$. Since $R'$ is Noetherian,
see Lemma \ref{lemma-obvious-Noetherian} we see that $I'$ is
nilpotent, see Lemma \ref{lemma-Noetherian-power}. On the other
hand we have $R' / I' \subset R/I$ and hence the image
$\overline{f} \in R'/I'$ of $f$ is an idempotent.
Thus by the first part of the proof we see that
we can find an idempotent $e \in R'$ which
is a lift of $\overline{f}$.
Then $e \in R$ is also a lift of $\overline{e}$ in $R/I$.
\end{proof}

\begin{lemma}
\label{lemma-product-local}
Any ring with finitely many maximal ideals and
locally nilpotent radical is the product of its localizations
at its maximal ideals. Also, all primes are maximal.
\end{lemma}

\begin{proof}
Let $R$ be a ring with finitely many maximal ideals
$\mathfrak m_1, \ldots, \mathfrak m_n$.
Let $I = \bigcap_{i = 1}^n \mathfrak m_i$
be the radical of $R$. Assume $I$ is locally nilpotent.
Let $\mathfrak p$ be a prime ideal of $R$.
Since every prime contains every nilpotent
element of $R$ we see
$ \mathfrak p \supset \mathfrak m_1 \cap \ldots \cap \mathfrak m_n$.
Since $\mathfrak m_1 \cap \ldots \cap \mathfrak m_n \supset
\mathfrak m_1 \ldots \mathfrak m_n$
we conclude $\mathfrak p \supset \mathfrak m_1 \ldots \mathfrak m_n$.
Hence $\mathfrak p \supset \mathfrak m_i$ for some $i$, and so
$\mathfrak p = \mathfrak m_i$. By the Chinese remainder
theorem \ref{lemma-chinese-remainder}
we have $R/I \cong \bigoplus R/\mathfrak m_i$
which is a product of fields.
Hence by Lemma \ref{lemma-lift-idempotents}
there are idempotents $e_i$, $i = 1, \ldots, n$
with $e_i \bmod \mathfrak m_j = \delta_{ij}$.
Hence $R = \prod Re_i$, and each $Re_i$ is a
ring with exactly one maximal ideal.
\end{proof}

\begin{lemma}
\label{lemma-artinian-finite-length}
A ring $R$ is Artinian if and only if it has finite length
as a module over itself. Any such ring $R$ is both Artinian and
Noetherian, any prime ideal of $R$ is a maximal ideal, and $R$ is equal
to the product of its localizations at its maximal ideals.
\end{lemma}

\begin{proof}
If $R$ has finite length over itself then it satisfies both
the ascending chain condition and the descending chain
condition for ideals. Hence it is both Noetherian and Artinian.
Any Artinian ring is equal to product of its localizations
at maximal ideals by Lemmas \ref{lemma-artinian-finite-nr-max},
\ref{lemma-artinian-radical-nilpotent}, and \ref{lemma-product-local}.

\medskip\noindent
Suppose that $R$ is Artinian. We will show $R$ has finite
length over itself. It suffices to exhibit a chain of
submodules whose succesive quotients have finite length.
By what we said above
we may assume that $R$ is local, with maximal ideal $\mathfrak m$.
By Lemma \ref{lemma-artinian-radical-nilpotent} we have
$\mathfrak m^n =0$ for some $n$.
Consider the sequence
$0 = \mathfrak m^n \subset \mathfrak m^{n-1} \subset
\ldots \subset \mathfrak m \subset R$. By Lemma
\ref{lemma-dimension-is-length} the length of each subquotient
$\mathfrak m^j/\mathfrak m^{j + 1}$ is the dimension of this
as a vector space over $\kappa(\mathfrak m)$. This has to be
finite since otherwise we would have an infinite descending
chain of subvector spaces which would correspond to an
infinite descending chain of ideals in $R$.
\end{proof}






































\section{K-groups}
\label{section-K-groups}

\noindent
Let $R$ be a ring. We will introduce two abelian groups associated
to $R$. The first of the two is denoted $K'_0(R)$ and has the following
properties:
\begin{enumerate}
\item For every finite $R$-module $M$ there is given an element $[M]$ in
$K'_0(R)$,
\item for every short exact sequence $0 \to M' \to M \to M'' \to 0$
we have the relation $[M] = [M'] + [M'']$,
\item the group $K'_0(R)$ is generated by the elements $[M]$, and
\item all relations in $K_0'(R)$ are $\mathbf{Z}$-linear combinations
of the relations coming from exact sequences as above.
\end{enumerate}
The actual construction is a bit more annoying since one has to take care
that the collection of all finitely generated $R$-modules is a proper class.
However, this problem can be overcome by taking as set of generators
of the group $K_0'(R)$ the elements $[R^n/K]$ where $n$ ranges over
all integers and $K$ ranges over all submodules $K \subset R^n$.
The generators of for the subgroup of relations imposed on these elements
will be the relations coming from short exact sequences whose terms
are of the form $R^n/K$. The element $[M]$ is defined by
choosing $n$ and $K$ such that $M \cong R^n/K$ and putting
$[M] = [R^n/K]$. Details left to the reader.

\begin{lemma}
\label{lemma-length-K0}
If $R$ is an Artinian local ring then the length function
defines a natural abelian group homomorphism
$\text{length}_R : K_0'(R) \to \mathbf{Z}$.
\end{lemma}

\begin{proof}
The length of any finite $R$-module is finite,
because it is the quotient of $R^n$ which has finite length by
Lemma \ref{lemma-artinian-finite-length}. And the length function
is additive, see Lemma \ref{lemma-length-additive}.
\end{proof}

\noindent
The second of the two is denoted $K_0(R)$ and has the following
properties:
\begin{enumerate}
\item For every finite projective $R$-module $M$ there
is given an element $[M]$ in $K_0(R)$,
\item for every short exact sequence $0 \to M' \to M \to M'' \to 0$
of finite projective $R$-modules we have the relation $[M] = [M'] + [M'']$,
\item the group $K_0(R)$ is generated by the elements $[M]$, and
\item all relations in $K_0(R)$ are $\mathbf{Z}$-linear combinations
of the relations coming from exact sequences as above.
\end{enumerate}
The construction of this group is done as above.

\medskip\noindent
We note that there is an obvious map $K_0(R) \to K_0'(R)$
which is not an isomorphism in general.

\begin{example}
\label{example-K0-field}
Note that if $R = k$ is a field then we clearly have
$K_0(k) = K_0'(k) \cong \mathbf{Z}$ with the isomorphism
given by the dimension function (which is also the length function).
\end{example}

\begin{example}
\label{example-K0-polynomial-ring}
Let $k$ be a field. Then $K_0(k[x]) = K_0'(k[x]) = \mathbf{Z}$.

\medskip\noindent
Since $R = k[x]$ is a principal ideal domain, any finite projective
$R$-module is free. In a short exact sequence of modules
$$
0 \to M' \to M \to M'' \to 0
$$
we have $rank(M) = rank(M')+rank(M'')$ , which gives $K_0(k[x]) = Z$.

\medskip\noindent
As for $K_0'$, the structure theorem for modules of a PID says that
any finitely generated $R$-module is of the form
$M = R^r \times R/(d_1) \times \dots \times R/(d_k)$.
Consider the short exact sequence
$$
0 \to (d_i) \to R \to R/(d_i) \to 0
$$
Since the ideal $(d_i)$ is isomorphic to $R$ as a module
(it is free with generator $d_i$), in $K_0'(R)$ we have
$[(d_i)] = [R]$.  Then $[R/(d_i)] = [(d_i)]-[R] = 0$.  From this it
follows that any torsion part ``disappears'' in $K_0'$.
Again the rank of the free part determines that $K_0'(k[x]) = Z$,
and the canonical homomorphism from $K_0$ to $K_0'$ is an isomorphism.
\end{example}

\begin{example}
\label{example-K0-node}
Let $k$ be a field. Let $R = \{f \in k[x] \mid f(0) = f(1)\}$,
compare Example \ref{example-affine-open-not-standard}.
In this case $K_0(R) \cong k^* \oplus \mathbf{Z}$, but
$K_0'(R) = \mathbf{Z}$.
\end{example}

\begin{lemma}
\label{lemma-K0-product}
Let $R = R_1 \times R_2$. Then $K_0(R) = K_0(R_1) \times K_0(R_2)$
and $K_0'(R) = K_0'(R_1) \times K_0'(R_2)$
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-K0prime-Artinian}
Let $R$ be an Artinian local ring.
The map $\text{length}_R : K_0'(R) \to \mathbf{Z}$
of Lemma \ref{lemma-length-K0} is an isomorphism.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-K0-local}
Let $R$ be a local ring. Every finite projective $R$-module
is finite free. The map $\text{rank}_R : K_0(R) \to \mathbf{Z}$
defined by $[M] \to \text{rank}_R(M)$ is well defined
and an isomorphism.
\end{lemma}

\begin{proof}
Let $P$ be a finite projective $R$-module.
The $n$ generators of $P$ give a surjection
$R^n \to P$, and since $P$ is projective it
follows that $R^n \cong P \oplus Q$ for some
projective module $Q$.

\medskip\noindent
If $\mathfrak m \subset R$ is the maximal ideal,
then $P/\mathfrak m$ and $Q/\mathfrak m$ are $R/\mathfrak m$-vector spaces,
with $P/\mathfrak m \oplus Q/\mathfrak m \cong (R/\mathfrak m)^n$.
Say that $\dim P = p$, $\dim Q = q$, so $p + q = n$.

\medskip\noindent
Choose elements $a_1, \ldots, a_p$ in $P$ and $b_1, \ldots, b_q$ in $Q$
lying above bases for $P/\mathfrak m$ and $Q/\mathfrak m$.
The homomorphism $R^n \to P \oplus Q \cong R^n$ given by
$(r_1, \ldots, r_n) \mapsto
r_1a_1 + \ldots + r_pa_p + r_{p + 1} b_1 + \ldots + r_nb_q$
is a matrix $A$ which is invertible over $R/\mathfrak m$. Let $B$
be a matrix over $R$ lying over the inverse of $A$ in $R/\mathfrak m$.
$AB = I + M$, where $M$ is a matrix whose entries all lie in $\mathfrak m$.
Thus $\det AB = 1 + x$, for $x \in \mathfrak m$, so $AB$ is invertible,
so $A$ is invertible.

\medskip\noindent
The homomorphism $R^p \to P$ given by
$(r_1, \ldots, r_p) \mapsto r_1a_1 + \ldots + r_pa_p$ inherits injectivity and
surjectivity from A. Hence, $P \cong R^p$.

\medskip\noindent
Next we show that the rank of a finite projective module over $R$ is
well defined: if $P \cong R^\alpha \cong R^\beta$, then $\alpha = \beta$.
This is immediate in the vector space case, and so it is true in the
general module case as well, by dividing out the maximal ideal on both sides.
If $0 \to R^\alpha \to R^\beta \to R^\gamma \to 0$
is exact, the sequence splits, so $R^\beta \cong R^\alpha \oplus R^\gamma$,
so $\beta = \alpha + \gamma$.

\medskip\noindent
So far we have seen that the map $\text{rank}_R : K_0(R) \to \mathbf{Z}$
is a well-defined homomorphism. It is surjective because
$\text{rank}_R[R] = 1$. It is injective because the element
of $K_0(R)$ with rank $\pm\alpha$ is uniquely $\pm[R^\alpha]$.
\end{proof}

\begin{lemma}
\label{lemma-K0-and-K0prime-Artinian-local}
Let $R$ be a local Artinian ring. There is a commutative
diagram
$$
\xymatrix{
K_0(R) \ar[rr] \ar[d]_{\text{rank}_R} & &
K_0'(R) \ar[d]^{\text{length}_R} \\
\mathbf{Z} \ar[rr]^{\text{length}_R(R)} & &
\mathbf{Z}
}
$$
where the vertical maps are isomorphisms by
Lemmas \ref{lemma-K0prime-Artinian} and \ref{lemma-K0-local}.
\end{lemma}

\begin{proof}
By induction on the rank of $M$.
Suppose $\left[M\right] \in K_0(R)$.
Then $M$ is a finite projective $R$-module
over a local ring, so M is free;
$M \cong R^n$ for some $n$.
The claim is that
$\text{rank} (M) \text{length}_R (R) = \text{length}_R(M)$,
or equivalently that $n\text{length}_R(R) = \text{length}_R (R^n)$
for all $n \geq 1$. When $n = 1$, this is clearly true.
Suppose that $(n-1) \text{length}_R(R) =\text{ length}_R(R^{n-1})$.
Then since there is a split short exact sequence
$$
0 \to R \to R^n \to R^{n-1} \to 0
$$
by Lemma \ref{lemma-length-additive} we have
\begin{eqnarray*}
\text{length}_R(R^n) & = & \text{length}_R(R) + \text{length}_R(R^{n-1}) \\
& = & \text{length}_R(R) + (n-1) \text{length}_R(R) \\
& = & n\text{length}_R(R)
\end{eqnarray*}
as desired.
\end{proof}

















\section{Graded rings}
\label{section-graded}

\noindent
A {\it graded ring} will be for us a ring $S$ endowed
with a direct sum decomposition $S = \bigoplus_{d \geq 0} S_d$
such that $S_d \cdot S_e \subset S_{d + e}$.
Note that we do not allow nonzero elements in negative degrees.
The {\it irrelevant ideal} is the ideal $S_{+} = \bigoplus_{d > 0} S_d$.
A {\it graded module}
will be an $S$-module $M$ endowed with a direct sum decomposition
$M = \bigoplus_{n\in \mathbf{Z}} M_n$ such that $S_d \cdot M_e
\subset M_{d + e}$. Note that for modules we do allow
nonzero elements in negative degrees.
We think of $S$ as a graded $S$-module by setting $S_{-k} = (0)$
for $k > 0$. An element $x$ (resp.\ $f$) of $M$ (resp.\ $S$) is called
{\it homogeneous}
if $x \in M_d$ (resp.\ $f \in S_d$) for some $d$.
A {\it map of graded $S$-modules} is a map of $S$-modules
$\varphi : M \to M'$ such that $\varphi(M_d) \subset M'_d$.
We do not allow maps to shift degrees. Let us denote
$\text{GrHom}_0(M, N)$ the $S_0$-module of homomorphisms
of graded modules from $M$ to $N$.

\medskip\noindent
At this point there are the notions of graded ideal,
graded quotient ring, graded submodule, graded quotient module,
graded tensor product, etc. We leave it to the reader to find the
relevant definitions, and lemmas. For example: A short exact sequence
of graded modules is short exact in every degree.

\medskip\noindent
Given a graded ring $S$, a graded $S$-module $M$ and $n \in \mathbf{Z}$
we denote $M(n)$ the graded $S$-module with $M(n)_d = M_{n + d}$.
This is called the {\it twist of $M$ by $n$}. In particular we get
modules $S(n)$, $n \in \mathbf{Z}$ which will play an important
role in the study of projective schemes. There are some obvious
functorial isomorphisms such as
$(M \oplus N)(n) = M(n) \oplus N(n)$,
$(M \otimes_S N)(n) = M \otimes_S N(n) = M(n) \otimes_S N$.
In addition we can define a graded $S$-module structure on
the $S_0$-module
$$
\text{GrHom}(M, N) =
\bigoplus\nolimits_{n \in \mathbf{Z}} \text{GrHom}_n(M, N), \ \ 
\text{GrHom}_n(M, N) = \text{GrHom}_0(M, N(n)).
$$
We omit the definition of the multiplication.

\medskip\noindent
Let $S$ be a graded ring. Let $d \geq 1$ be an integer.
We set $S^{(d)} = \bigoplus_{n \geq 0} S_{nd}$. We think of
$S^{(d)}$ as a graded ring with degree $n$ summand
$(S^{(d)})_n = S_{nd}$. Given a graded $S$-module $M$ we
can similarly consider $M^{(d)} = \bigoplus_{n \in \mathbf{Z}} M_{nd}$
which is a graded $S^{(d)}$-module.









\section{Proj of a graded ring}
\label{section-proj}

\noindent
Let $S$ be a graded ring.
A {\it homogeneous ideal} is simply an ideal
$I \subset S$ which is also a graded submodule of $S$.
Equivalently, it is an ideal generated by homogeneous elements.
Equivalently, if $f \in I$ and
$$
f = f_0 + f_1 + \ldots + f_n
$$
is the decomposition of $f$ into homogenous parts in $S$ then $f_i \in I$
for each $i$. To check that a homogeneous ideal $\mathfrak p$
is prime it suffices to check that if $ab \in \mathfrak p$
with $a, b$ homogeneous then either $a \in \mathfrak p$ or
$b \in \mathfrak p$.

\begin{definition}
\label{definition-proj}
Let $S$ be a graded ring.
We define $\text{Proj}(S)$ to be the set of homogenous,
prime ideals $\mathfrak p$ of $S$ such that
$S_{+} \not \subset \mathfrak p$.
As $\text{Proj}(S)$ is a subset of $\text{Spec}(S)$
and we endow it with the induced topology.
The topological space $\text{Proj}(S)$ is called the
{\it homogeneous spectrum} of the graded ring $S$.
\end{definition}

\noindent
Note that by construction there is a continuous map
$$
\text{Proj}(S) \longrightarrow \text{Spec}(S_0)
$$

\medskip\noindent
Let $S = \oplus_{d \geq 0} S_d$ be a graded ring.
Let $f\in S_d$ and assume that $d \geq 1$.
We define $S_{(f)}$ to be the subring of $S_f$
consisting of elements of the form $r/f^n$ with $r$ homogenous and
$\deg(r) = nd$. If $M$ is a graded $S$-module,
then we define the $S_{(f)}$-module $M_{(f)}$ as the
sub module of $M_f$ consisting of elements of
the form $x/f^n$ with $x$ homogeneous of degree $nd$.

\begin{lemma}
\label{lemma-Z-graded}
Let $S$ be a $\mathbf{Z}$-graded ring.
Let $f \in S_d$, $d > 0$ and assume $f$ is invertible in $S$.
The set $G \subset \text{Spec}(S)$ of $\mathbf{Z}$-graded primes of $S$
(with induced topology) maps homeomorphically to $\text{Spec}(S_0)$.
\end{lemma}

\begin{proof}
First we show that the map is a bijection by constructing an inverse.
Namely, if $\mathfrak p_0$ is a prime of $S_0$, then $\mathfrak p_0S$
is a $\mathbf{Z}$-graded ideal of $S$ such that
$\mathfrak p_0S \cap S_0 = \mathfrak p_0$. And if $ab \in \mathfrak p_0S$
with $a$, $b$ homogenenous, then
$a^db^d/f^{\deg(a) + \deg(b)} \in \mathfrak p_0$.
Thus either $a^d/f^{\deg(a)} \in \mathfrak p_0$ or
$b^d/f^{\deg(b)} \in \mathfrak p_0$, in other words either
$a^d \in \mathfrak p_0S$ or $b^d \in \mathfrak p_0S$.
It follows that $\sqrt{\mathfrak p_0S}$ is a $\mathbf{Z}$-graded
prime ideal of $S$ whose intersection with $S_0$ is $\mathfrak p_0$.

\medskip\noindent
To show that the map is a homeomorphism we show that
the image of $G \cap D(g)$ is open. If $g = \sum g_i$
with $g_i \in S_i$, then by the above $G \cap D(g)$
maps onto the set $\bigcup D(g_i^d/f^i)$ which is open.
\end{proof}

\noindent
For $f \in S$ homogenenous of degree $> 0$ we define
$$
D_{+}(f) = \{ \mathfrak p \in \text{Proj}(S) \mid f \not\in \mathfrak p \}.
$$
Finally, for a homogenous ideal $I \subset S$ we define
$$
V_{+}(I) = \{ \mathfrak p \in \text{Proj}(S) \mid I \subset \mathfrak p \}.
$$
We will use more generally the notation $V_{+}(E)$ for any
set $E$ of homogeneous elements $E \subset S$.

\begin{lemma}
\label{lemma-topology-proj}
(Topology on $\text{Proj}(S)$.)
Let $S = \oplus_{d \geq 0} S_d$ be a graded ring.
\begin{enumerate}
\item The sets $D_{+}(f)$ are open in $\text{Proj}(S)$.
\item We have $D_{+}(ff') = D_{+}(f) \cap D_{+}(f')$.
\item Let $g = g_0 + \ldots + g_m$ be an element
of $S$ with $g_i \in S_i$. Then
$$
D(g) \cap \text{Proj}(S) =
(D(g_0) \cap \text{Proj}(S))
\cup
\bigcup\nolimits_{i \geq 1} D_{+}(g_i).
$$
\item
Let $g_0\in S_0$ be a homogenous element of degree $0$. Then
$$
D(g_0) \cap \text{Proj}(S)
=
\bigcup\nolimits_{f \in S_d, \ d\geq 1} D_{+}(g_0 f).
$$
\item The open sets $D_{+}(f)$ form a
basis for the topology of $\text{Proj}(S)$.
\item Let $f \in S$ be homogeneous of positive degree.
The ring $S_f$ has a natural $\mathbf{Z}$-grading.
The ring maps $S \to S_f \leftarrow S_{(f)}$ induce
homeomorphisms
$$
D_{+}(f)
\leftarrow
\{\mathbf{Z}\text{-graded primes of }S_f\}
\to
\text{Spec}(S_{(f)}).
$$
\item There exists an $S$ such that $\text{Proj}(S)$ is not
quasi-compact.
\item The sets $V_{+}(I)$ are closed.
\item Any closed subset $T \subset \text{Proj}(S)$ is of
the form $V_{+}(I)$ for some homogeneous ideal $I \subset S$.
\item For any graded ideal $I \subset S$ we have
$V_{+}(I) = \emptyset$ if and only if $S_{+} \subset \sqrt{I}$.
\end{enumerate}
\end{lemma}

\begin{proof}
Since $D_{+}(f) = \text{Proj}(S) \cap D(f)$, these sets are open.
Similarly the sets $V_{+}(I) = \text{Proj}(S) \cap V(E)$ are
closed.

\medskip\noindent
Suppose that $T \subset \text{Proj}(S)$ is closed.
Then we can write $T = \text{Proj}(S) \cap V(J)$ for some
ideal $J \subset S$. By definition of a homogeneous ideal
if $g \in J$, $g = g_0 + \ldots + g_m$
with $g_d \in S_d$ then $g_d \in \mathfrak p$ for all
$\mathfrak p \in T$. Thus, letting $I \subset S$
be the ideal generated by the homogeneous parts of the elements
of $J$ we have $T = V_{+}(I)$.

\medskip\noindent
The formula for $\text{Proj}(S) \cap D(g)$, with $g \in S$ is direct
from the definitions. Consider the formula for $\text{Proj}(S) \cap D(g_0)$.
The inclusion of the right hand side in the left hand side is
obvious. For the other inclusion, suppose $g_0 \not \in \mathfrak p$
with $\mathfrak p \in \text{Proj}(S)$. If all $g_0f \in \mathfrak p$
for all homogeneous $f$ of positive degree, then we see that
$S_{+} \subset \mathfrak p$ which is a contradiction. This gives
the other inclusion.

\medskip\noindent
The collection of opens $D(g) \cap \text{Proj}(S)$
forms a basis for the topology since the standard opens
$D(g) \subset \text{Spec}(S)$ form a basis for the topology on
$\text{Spec}(S)$. By the formulas above we can express
$D(g) \cap \text{proj}(S)$ as a union of opens $D_{+}(f)$.
Hence the collection of opens $D_{+}(f)$ forms a basis for the topology
also.

\medskip\noindent
First we note that $D_{+}(f)$ may be identified
with a subset (with induced topology) of $D(f) = \text{Spec}(S_f)$
via Lemma \ref{lemma-standard-open}. Note that the ring
$S_f$ has a $\mathbf{Z}$-grading. The homogeneous elements are
of the form $r/f^n$ with $r \in S$ homogeneous and have
degree $\deg(r/f^n) = \deg(r) - n\deg(f)$. The subset
$D_{+}(f)$ corresponds exactly to those prime ideals
$\mathfrak p \subset S_f$ which are $\mathbf{Z}$-graded ideals
(i.e., generated by homogeneous elements). Hence we have to show that
the set of $\mathbf{Z}$-graded prime ideals of $S_f$ maps homeomorphically
to $\text{Spec}(S_{(f)})$. This follows from Lemma \ref{lemma-Z-graded}.

\medskip\noindent
Let $S = \mathbf{Z}[X_1, X_2, X_3, \ldots]$ with grading such that
each $X_i$ has degree $1$. Then it is easy to see that
$$
\text{Proj}(S) = \bigcup\nolimits_{i = 1}^\infty D_{+}(X_i)
$$
does not have a finite refinement.

\medskip\noindent
Let $I \subset S$ be a graded ideal.
If $\sqrt{I} \supset S_{+}$ then $V_{+}(I) = \emptyset$ since
every prime $\mathfrak p \in \text{Proj}(S)$ does not contain
$S_{+}$ by definition. Conversely, suppose that
$S_{+} \not \subset \sqrt{I}$. Then we can find an element
$f \in S_{+}$ such that $f$ is not nilpotent modulo $I$.
Clearly this means that one of the homogeneous parts of $f$
is not nilpotent modulo $I$, in other words we may (and do)
assume that $f$ is homogeneous. This implies that
$I S_f \not = 0$, in other words that $(S/I)_f$ is not
zero. Hence $(S/I)_{(f)} \not = 0$ since it is a ring
which maps into $(S/I)_f$. Pick a prime
$\mathfrak q \subset (S/I)_{(f)}$. This corresponds to
a graded prime of $S/I$, not containing the irrelevant ideal
$(S/I)_{+}$. And this in turn corresponds to a graded prime
ideal $\mathfrak p$ of $S$, containing $I$ but not containing $S_{+}$
as desired.
\end{proof}

\begin{example}
\label{example-proj-polynomial-ring-1-variable}
Let $R$ be a ring. If $S = R[X]$ with $\deg(X) = 1$, then the natural map
$\text{Proj}(S) \to \text{Spec}(R)$ is a bijection and in fact a homeomorphism.
Namely, suppose $\mathfrak p \in \text{Proj}(S)$. Since
$S_{+} \not \subset \mathfrak p$ we see that $X \not \in \mathfrak p$.
Thus if $aX^n \in \mathfrak p$ with $a \in R$ and $n > 0$, then
$a \in \mathfrak p$. It follows that $\mathfrak p = \mathfrak p_0S$
with $\mathfrak p_0 = \mathfrak p \cap R$.
\end{example}

\noindent
If $\mathfrak p \in \text{Proj}(S)$, then we
define $S_{(\mathfrak p)}$ to be the ring whose
elements are fractions $r/f$ where $r, f \in S$ are homogeneous
elements of the same degree such that $f \not\in \mathfrak p$.
As usual we say $r/f = r'/f'$ if and only if there exists
some $f'' \in S$ homogeneous, $f'' \not \in \mathfrak p$ such
that $f''(rf' - r'f) = 0$.
Given a graded $S$-module $M$ we let
$M_{(\mathfrak p)}$ be the $S_{(\mathfrak p)}$-module
whose elements are fractions $x/f$ with $x \in M$
and $f \in S$ homogeneous of the same degree such that
$f \not \in \mathfrak p$. We say $x/f = x'/f'$
if and only if there exists some $f'' \in S$ homogeneous,
$f'' \not \in \mathfrak p$ such that $f''(xf' - x'f) = 0$.

\begin{lemma}
\label{lemma-proj-prime}
Let $S$ be a graded ring. Let $M$ be a graded $S$-module.
Let $\mathfrak p$ be an element of $\text{Proj}(S)$.
Let $f \in S$ be a homogeneous element of positive degree
such that $f \not \in \mathfrak p$, i.e., $\mathfrak p \in D_{+}(f)$.
Let $\mathfrak p' \subset S_{(f)}$ be the element of
$\text{Spec}(S_{(f)})$ corresponding to $\mathfrak p$ as in
Lemma \ref{lemma-topology-proj}. Then
$S_{(\mathfrak p)} = (S_{(f)})_{\mathfrak p'}$
and compatibly
$M_{(\mathfrak p)} = (M_{(f)})_{\mathfrak p'}$.
\end{lemma}

\begin{proof}
We define a map $\psi : M_{(\mathfrak p)} \to (M_{(f)})_{\mathfrak p'}$.
Let $x/g \in M_{(\mathfrak p)}$. We set
$\psi(x/g) = (x^{\deg(f)}/f^{\deg(x)})/(g^{\deg(f)}/f^{\deg(g)})$.
This makes sense since $\deg(x) = \deg(g)$, and since
$g^{\deg(f)}/f^{\deg(g)} \not \in \mathfrak p'$.
We omit the verification that $\psi$ is well defined, a module map
and an isomorphism.
\end{proof}

\noindent
Here is a graded variant of Lemma \ref{lemma-silly}.

\begin{lemma}
\label{lemma-graded-silly}
Suppose $S$ is a graded ring, $\mathfrak p_i$, $i = 1, \ldots, r$
homogeneous prime ideals and $I \subset S_{+}$ a graded ideal.
Assume $I \not\subset \mathfrak p_i$ for all $i$. Then there
exists a homogeneous element $x\in I$ of positive degree such
that $x\not\in \mathfrak p_i$ for all $i$.
\end{lemma}

\begin{proof}
We may assume there are no inclusions among the $\mathfrak p_i$.
The result is true for $r = 1$. Suppose the result holds for $r - 1$.
Pick $x \in I$ homogeneous of positive degree such that
$x \not \in \mathfrak p_i$ for all $i = 1, \ldots, r - 1$.
If $x \not\in \mathfrak p_r$ we are done. So assume $x \in \mathfrak p_r$.
If $I \mathfrak p_1 \ldots \mathfrak p_{r-1} \subset \mathfrak p_r$
then $I \subset \mathfrak p_r$ a contradiction.
Pick $y \in I\mathfrak p_1 \ldots \mathfrak p_{r-1}$ homogeneous
and $y \not \in \mathfrak p_r$. Then $x^{\deg(y)} + y^{\deg(x)}$ works.
\end{proof}

\begin{lemma}
\label{lemma-smear-out}
Let $S$ be a graded ring.
Let $\mathfrak p \subset S$ be a prime.
Let $\mathfrak q$ be the homogeneous ideal of $S$ generated by the
homogeneous elements of $\mathfrak p$. Then $\mathfrak q$ is a
prime ideal of $S$.
\end{lemma}

\begin{proof}
Suppose $f, g \in S$ are such that $fg \in \mathfrak q$.
Let $f_d$ (resp.\ $g_e$) be the homogeneous part of
$f$ (resp.\ $g$) of degree $d$ (resp.\ $e$). Assume $d, e$ are
maxima such that $f_d \not = 0$ and $g_e \not = 0$.
By assumption we can write $fg = \sum a_i f_i$ with
$f_i \in \mathfrak p$ homogeneous. Say $\deg(f_i) = d_i$.
Then $f_d g_e = \sum a_i' f_i$ with $a_i'$ to homogeneous
par of degree $d + e - d_i$ of $a_i$ (or $0$ if $d + e -d_i < 0$).
Hence $f_d \in \mathfrak p$ or $g_e \in \mathfrak p$. Hence
$f_d \in \mathfrak q$ or $g_e \in \mathfrak q$. In the first
case replace $f$ by $f - f_d$, in the second case replace
$g$ by $g - g_e$. Then still $fg \in \mathfrak q$ but the discrete
invariant $d + e$ has been decreased. Thus we may continue in this
fashion until either $f$ or $g$ is zero. This clearly shows that
$fg \in \mathfrak q$ implies either $f \in \mathfrak q$ or $g \in \mathfrak q$
as desired.
\end{proof}

\begin{lemma}
\label{lemma-graded-ring-minimal-prime}
Let $S$ be a graded ring.
\begin{enumerate}
\item Any minimal prime of $S$ is a homogeneous ideal of $S$.
\item Given a homogeneous ideal $I \subset S$ any minimal
prime over $I$ is homogeneous.
\end{enumerate}
\end{lemma}

\begin{proof}
The first assertion holds because the prime $\mathfrak q$ constructed in
Lemma \ref{lemma-smear-out} satisfies $\mathfrak q \subset \mathfrak p$.
The second because we may consider $S/I$ and apply the first part.
\end{proof}

\begin{lemma}
\label{lemma-homogenize}
Let $R$ be a ring.
Let $R'$ be a finite type $R$-algebra, and let $M$ be a finite $R'$-module.
There exists a graded $R$-algebra $S$, a graded $S$-module $N$ and
an element $f \in S$ homogeneous of degree $1$ such that
\begin{enumerate}
\item $R' \cong S_{(f)}$ and $M \cong N_{(f)}$ (as modules),
\item $S_0 = R$ and $S$ is generated by finitely many elements
of degree $1$ over $R$, and
\item $N$ is a finite $S$-module.
\end{enumerate}
\end{lemma}

\begin{proof}
We may write $R' = R[x_1, \ldots, x_n]/I$ for some ideal $I$.
For an element $g \in R[x_1, \ldots, x_n]$ denote
$\tilde g \in R[x_0, \ldots, x_n]$ the element homogeneous of minimal
degree such that $g = \tilde g(1, x_1, \ldots, x_n)$.
Let $\tilde I \subset R[X_0, \ldots, X_n]$ generated by all
elements $\tilde g$, $g \in I$.
Set $S = R[X_0, \ldots, X_n]/\tilde I$ and denote $f$ the image
of $X_0$ in $S$. By construction we have an isomorphism
$$
S_{(f)} \longrightarrow R',\quad
X_i/X_0 \longmapsto x_i.
$$
To do the same thing with the module $M$ we choose a presentation
$$
M = (R')^{\oplus r}/\sum\nolimits_{j \in J} R'k_j
$$
with $k_j = (k_{1j}, \ldots, k_{rj})$. Let $d_{ij} = \deg(\tilde k_{ij})$.
Set $d_j = \max\{d_{ij}\}$. Set $K_{ij} = X_0^{d_j - d_{ij}}\tilde k_{ij}$
which is homogeneous of degree $d_j$. With this notation we set
$$
N = \text{Coker}\Big(
\bigoplus\nolimits_{j \in J} S(-d_j) \xrightarrow{(K_{ij})} S^{\oplus r}
\Big)
$$
which works. Some details omitted.
\end{proof}





\section{Blow up algebras}
\label{section-blow-up}

\noindent
In this section we make some elementary observations about blowing up.

\begin{definition}
\label{definition-blow-up}
Let $R$ be a ring.
Let $I \subset R$ be an ideal.
\begin{enumerate}
\item The {\it blowup algebra}, or the {\it Rees algebra}, associated to
the pair $(R, I)$ is the the graded $R$-algebra
$$
\text{Bl}_I(R) =
\bigoplus\nolimits_{n \geq 0} I^n =
R \oplus I \oplus I^2 \oplus \ldots
$$
where the summand $I^n$ is placed in degree $n$.
\item If $a \in I$ is an element, then the {\it affine blowup algebra}
$R[\frac{I}{a}]$ is the algebra $(\text{Bl}_I(R))_{(a)}$ constructed in
Section \ref{section-proj}.
\end{enumerate}
\end{definition}

\noindent
In other words, an element of $R[\frac{I}{a}]$ is represented by
an expression of the form $x/a^n$ with $x \in I^n$. Two representatives
$x/a^n$ and $y/a^m$ define the same element if and only if
$a^k(a^mx - a^ny) = 0$ for some $k \geq 0$.

\begin{lemma}
\label{lemma-blowup-domain}
If $R$ is a domain then every (affine) blowup algebra of $R$ is a domain.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-blowup-reduced}
If $R$ is reduced then every (affine) blowup algebra of $R$ is reduced.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-blowup-dominant}
Let $R$ be a ring. Let $I \subset R$ be an ideal. Let $a \in I$.
If $a$ is not contained in any minimal prime of $R$, then
$\text{Spec}(R[\frac{I}{a}]) \to \text{Spec}(R)$ has dense
image.
\end{lemma}

\begin{proof}
If $a^k x = 0$ for $x \in R$, then $x$ is contained in all the
minimal primes of $R$ and hence nilpotent, see
Lemma \ref{lemma-Zariski-topology}.
Thus the kernel of $R \to R[\frac{I}{a}]$ consists of nilpotent
elements. Hence the result follows from
Lemma \ref{lemma-image-dense-generic-points}.
\end{proof}





\section{Noetherian graded rings}
\label{section-noetherian-graded}

\begin{lemma}
\label{lemma-graded-Noetherian}
A graded ring $S$ is Noetherian if and only if $S_0$ is
Noetherian and $S_{+}$ is finitely generated. Furthermore,
a set of homogenenous elements $f_i \in S_{+}$ generates $S$
as an algebra over $S_0$ if and only if they generate
$S_{+}$ as an ideal.
\end{lemma}

\begin{proof}
It is clear that if $S$ is Noetherian then $S_0 = S/S_{+}$ is Noetherian
and $S_{+}$ is finitely generated. It is also clear that if
$f_i$ generate $S$ over $S_0$ then they generate $S_{+}$ as an
ideal. Conversely, suppose that
$S_{+} = (f_1, \ldots, f_n)$ and $S_0$ Noetherian.
By decomposing the $f_i$ into homogenous pieces we may assume each
$f_i$ is homogeneous. Consider the map
$\Psi : S_0[X_1, \ldots X_n] \to S$ which maps $X_i$ to $f_i$.
We claim this is surjective. Once we have seent his the result
follows from Lemma \ref{lemma-Noetherian-permanence}.
Namely, suppose that $f \in S_d$ for some $d$.
By assumption we may write $f = \sum a_i f_i$.
We may replace $a_i$ by its piece of degree $\deg(f) - \deg(f_i)$
and still obtain a valid relation. Now each $a_i$ is homogenous
of strictly smaller degree than $f_i$, and hence by induction
on the degree we may assume $a_i$ is in the image of $\Psi$.
Of course then $f$ is in the image too.
\end{proof}

\begin{definition}
\label{definition-numerical-polynomial}
Let $A$ be an abelian group.
We say that a function $f : n \mapsto f(n) \in A$
defined for all sufficient large integers $n$ is a
{\it numerical polynomial} if there exists $r \geq 0$,
elements $a_0, \ldots, a_r\in A$ such that
$$
f(n) = \sum\nolimits_{i = 0}^r \binom{n}{i} a_i
$$
for all $n \gg 0$.
\end{definition}

\noindent
The reason for using the binomial coefficients is the
elementary fact that any polynomial $P \in \mathbf{Q}[T]$
all of whose values at integer points are integers, is
equal to a sum $P(T) = \sum a_i \binom{T}{i}$ with
$a_i \in \mathbf{Z}$. Note that in particular the
expressions $\binom{T + 1}{i + 1}$ are of this form.

\begin{lemma}
\label{lemma-numerical-polynomial-functorial}
If $A \to A'$ is a homomorphism of abelian groups and if
$f : n \mapsto f(n) \in A$ is a numerical polynomial,
then so is the composition.
\end{lemma}

\begin{proof}
This is immediate from the definitions.
\end{proof}

\begin{lemma}
\label{lemma-numerical-polynomial}
Suppose that $f: n \mapsto f(n) \in A$
is defined for all $n$ sufficiently large
and suppose that $n \mapsto f(n) - f(n-1)$
is a numerical polynomial. Then $f$ is a
numerical polynomial.
\end{lemma}

\begin{proof}
Let $f(n) - f(n-1) = \sum\nolimits_{i = 0}^r \binom{n}{i} a_i$
for all $n \gg 0$. Set
$g(n) = f(n) - \sum\nolimits_{i = 0}^r \binom{n + 1}{i + 1} a_i$.
Then $g(n) - g(n-1) = 0$ for all $n \gg 0$. Hence $g$ is
eventually constant, say equal to $a_{-1}$. We leave it
to the reader to show that
$a_{-1} + \sum\nolimits_{i = 0}^r \binom{n + 1}{i + 1} a_i$
has the required shape (see remark above the lemma).
\end{proof}

\begin{lemma}
\label{lemma-graded-module-fg}
If $M$ is a finitely generated graded $S$-module,
and if $S$ is finitely generated over $S_0$, then
each $M_n$ is a finite $S_0$-module.
\end{lemma}

\begin{proof}
Suppose the generators of $M$ are $m_i$ and the generators
of $S$ are $f_i$. By taking homogeneous components we may
assume that the $m_i$ and the $f_i$ are homogeneous
and we may assume $f_i \in S_{+}$. In this case it is
clear that each $M_n$ is generated over $S_0$
by the ``monomials'' $\prod f_i^{e_i} m_j$ whose
degree is $n$.
\end{proof}

\begin{proposition}
\label{proposition-graded-hilbert-polynomial}
Suppose that $S$ is a Noetherian graded ring
and $M$ a finite graded $S$-module. Consider the
function
$$
\mathbf{Z} \longrightarrow K_0'(S_0), \ \ 
n \longmapsto [M_n]
$$
see Lemma \ref{lemma-graded-module-fg} above.
If $S_{+}$ is generated by elements of degree $1$,
then this function is a numerical polynomial.
\end{proposition}

\begin{proof}
We prove this by induction on the minimal number of
generators of $S_1$. If this number is $0$, then
$M_n = 0$ for all $n \gg 0$ and the result holds.
To prove the induction step, let $x\in S_1$
be one of a minimal set of generators, such that
the induction hypothesis applies to the
graded ring $S/(x)$.

\medskip\noindent
First we show the result holds if $x$ is nilpotent on $M$.
This we do by induction on the minimal integer $r$ such that
$x^r M  = 0$. If $r = 1$, then $M$ is a module over $S/xS$
and the result holds (by the other induction hypothesis).
If $r > 1$, then we can find a short exact sequence
$0 \to M' \to M \to M'' \to 0$ such that the integers
$r', r''$ are stricly smaller than $r$. Thus we know
the result for $M''$ and $M'$. Hence
we get the result for $M$ because of the relation
$
[M_d]  = [M'_d] + [M''_d]
$
in $K_0'(R)$.

\medskip\noindent
If $x$ is not nilpotent on $M$, let $M' \subset M$ be
the largest submodule on which $x$ is nilpotent.
Consider the exact sequence $0 \to M' \to M \to M/M' \to 0$
we see again it suffices to prove the result for $M/M'$. In other
words we may assume that multiplication by $x$ is injective.

\medskip\noindent
Let $\overline{M} = M/xM$. Note that the map $x : M \to M$
is {\it not} a map of graded $S$-modules, since it does
not map $M_d$ into $M_d$. Namely, for each $d$ we have the
following short exact sequence
$$
0 \to M_d \xrightarrow{x} M_{d + 1} \to \overline{M}_{d + 1} \to 0
$$
This proves that $[M_{d + 1}] - [M_d] = [\overline{M}_{d + 1}]$.
Hence we win by Lemma \ref{lemma-numerical-polynomial}.
\end{proof}

\begin{remark}
\label{remark-period-polynomial}
If $S$ is still Noetherian but $S$ is not generated in degree $1$,
then the function associated to a graded $S$-module is a periodic
polynomial (i.e., it is a numerical polynomial on the
congruence classes of integers modulo $n$ for some $n$).
\end{remark}

\begin{example}
\label{example-hilbert-function}
Suppose that $S = k[X_1, \ldots, X_d]$.
By Example \ref{example-K0-field} we may identify
$K_0(k) = K_0'(k) = \mathbf{Z}$. Hence any finitely
generated graded $k[X_1, \ldots, X_d]$-module
gives rise to a numerical polynomial
$n \mapsto \dim_k(M_n)$.
\end{example}

\begin{lemma}
\label{lemma-quotient-smaller-d}
Let $k$ be a field. Suppose that $I \subset k[X_1, \ldots, X_d]$
is a nonzero graded ideal. Let $M = k[X_1, \ldots, X_d]/I$.
Then the numerical polynomial $n \mapsto \dim_k(M_n)$ (see
Example \ref{example-hilbert-function} above)
has degree $ < d - 1$ (or is zero if $d = 1$).
\end{lemma}

\begin{proof}
The numerical polynomial associated to the graded module
$k[X_1, \ldots, X_n]$ is $n \mapsto \binom{n - 1 + d}{d - 1}$.
For any nonzero homogeneous $f \in I$ of degree $e$
and any degree $n >> e$ we have $I_n \supset f \cdot k[X_1, \ldots, X_d]_{n-e}$
and hence $\dim_k(I_n) \geq \binom{n - e - 1 + d}{d - 1}$. Hence
$\dim_k(M_n) \leq \binom{n - 1 + d}{d - 1} - \binom{n - e - 1 + d}{d - 1}$.
We win because the last expression
has degree $ < d - 1$ (or is zero if $d = 1$).
\end{proof}








\section{Noetherian local rings}
\label{section-Noetherian-local}

\noindent
In all of this section $(R, \mathfrak m, \kappa)$
is a Noetherian local ring.
Let $M$ be a finite $R$-module. We define the {\it Hilbert
function} of $M$ to be the function
$$
\varphi_M : n
\longmapsto
\text{length}_R(\mathfrak m^nM/{\mathfrak m}^{n + 1}M).
$$
Note that we have by Lemma \ref{lemma-length-additive}
that
$$
\text{length}_R(M / \mathfrak m^{n + 1}M)
=
\sum\nolimits_{i = 0}^n
\varphi_M(i).
$$
There is a variant of this construction which uses an
ideal $I \subset R$ such that $\sqrt{I} = \mathfrak m$.
Such an ideal is called {\it an ideal of definition
of $R$}. Because $R$ is Noetherian this means that
$\mathfrak m^r \subset I$ for some $r$, see Lemma
\ref{lemma-Noetherian-power}. Hence any finite $R$-module
annihilated by a power of $I$ has a finite length, see Lemma
\ref{lemma-length-finite}.
Thus in this case we may put
$$
\varphi_{I, M} : n
\longmapsto
\text{length}_R(I^nM/I^{n + 1}M).
$$
Again we have that
$$
\text{length}_R(M / I^{n + 1}M)
=
\sum\nolimits_{i = 0}^n
\varphi_{I, M}(i).
$$

\begin{lemma}
\label{lemma-differ-finite}
Suppose that $M' \subset M$ are finite $R$-modules
with finite length quotient. Then there exists a
constants $c_1, c_2$ such that for all $n \gg c_2$ we have
$$
c_1 + \sum\nolimits_{i = 0}^{n - c_2} \varphi_{I, M'}(i)
\leq
\sum\nolimits_{i = 0}^n \varphi_{I, M}(i)
\leq
c_1 + \sum\nolimits_{i = 0}^n \varphi_{I, M'}(i)
$$
$\varphi_{I, M}(n) \geq \varphi_{I, M'}(n-c_1) - c_2$
and $\varphi_{I, M'}(n) \geq \varphi_{I, M}(n) - c_2$.
\end{lemma}

\begin{proof}
Let $c_1 = \text{length}_R(M/M')$. For $n \geq 1$ we have
\begin{eqnarray*}
\sum\nolimits_{i = 0}^n \varphi_{I, M}(i)
& = &
\text{length}_R(M/I^{n + 1}M) \\
& = &
c_1 + \text{length}_R(M'/I^{n + 1}M) \\
& \leq &
c_1 + \text{length}_R(M'/I^{n + 1}M') \\
& = &
c_1 + \sum\nolimits_{i = 0}^n \varphi_{I, M'}(i)
\end{eqnarray*}
On the other hand, let $c_2$ be such that $I^{c_2}M \subset M'$,
so $I^nM \subset I^{n - c_2}M'$. We have
\begin{eqnarray*}
\sum\nolimits_{i = 0}^n \varphi_{I, M}(i)
& = &
\text{length}_R(M/I^{n + 1}M) \\
& = &
c_1 + \text{length}_R(M'/I^{n + 1}M) \\
& \geq &
c_1 + \text{length}_R(M'/I^{n + 1 - c_2}M') \\
& = &
c_1 + \sum\nolimits_{i = 0}^{n - c_2} \varphi_{I, M'}(i)
\end{eqnarray*}
This works as soon as $n \geq c_2$.
\end{proof}

\begin{lemma}
\label{lemma-hilbert-ses}
Suppose that $0 \to M' \to M \to M'' \to 0$
is a short exact sequence of finite $R$-modules.
Then there exists a submodule $N \subset M'$ with
finite colength and an integer $c$ such that $\varphi_{I, M}(n)
= \varphi_{I, M''}(n) + \varphi_{I, N}(n-c)$ for all $n$ large enough.
\end{lemma}

\begin{proof}
Note that $M/I^nM \to M''/I^nM''$ is surjective
with kernel $M' / M' \cap I^nM$. By the Artin-Rees
Lemma \ref{lemma-Artin-Rees} there exists a
constant $c$ such that $M' \cap I^nM =
I^{n-c}(M' \cap I^cM)$. Denote $N = M' \cap I^cM$.
Note that $I^c M' \subset N \subset M'$.
Hence $\text{length}_R(M' / M' \cap I^nM)
= \text{length}_R(M'/N) + \text{length}_R(N/I^{n-c}N)$.
Then we obtain the equality
$$
\sum_{i = 0}^{n-1} \varphi_{I, M}(i)
=
\sum_{i = 0}^{n-1} \varphi_{I, M''}(i)
+
\sum_{i = 0}^{n-c-1} \varphi_{I, N}(i)
+
\text{length}_R(M'/N)
$$
for $n$ large enough. Thus we get $\varphi_{I, M}(n)
= \varphi_{I, M''}(n) + \varphi_{I, N}(n-c)$ for
$n$ large enough.
\end{proof}

\begin{lemma}
\label{lemma-hilbert-change-I}
Suppose that $I$, $I'$ are two ideals of definition
for the Noetherian local ring $R$. Let $M$ be a
finite $R$-module. There exists a constant $a$ such that
$
\sum_{i = 0}^n \varphi_{I, M}(i) \leq
\sum_{i = 0}^{an}\varphi_{I', M}(i)$.
\end{lemma}

\begin{proof}
There exists an integer $a$ such that $(I')^a \subset I$.
Hence we get a surjection $M/(I')^{a(n + 1)}M \to M/I^{n + 1}M$.
Whence the result (with $a + 1$).
\end{proof}

\begin{proposition}
\label{proposition-hilbert-function-polynomial}
For every Noetherian local ring $R$, any $I \subset R$
such that $\sqrt{I} = \mathfrak m$ and every
finite $R$-module $M$ the Hilbert function $\varphi_{I, M}$
is a numerical polynomial.
\end{proposition}

\begin{proof}
Consider the graded ring $S = R/I \oplus I/I^2 \oplus I^2/I^3 \oplus
\ldots = \bigoplus_{d \geq 0} I^d/I^{d + 1}$. Consider the graded
$S$-module $N = M/IM \oplus IM/I^2M \oplus \ldots =
\bigoplus_{d \geq 0} I^dM/I^{d + 1}M$. This pair $(S, N)$ satisfies
the hypotheses of Proposition \ref{proposition-graded-hilbert-polynomial}.
Hence the result follows from that Proposition, and
Lemma \ref{lemma-length-K0}.
\end{proof}

\begin{lemma}
\label{lemma-d-independent}
Suppose that $M$ is a finite $R$-module.
The degree of the numerical polynomial
$\varphi_{I, M}$ is independent of the
ideal of definition $I$.
\end{lemma}

\begin{proof}
This follows immediately from Lemma \ref{lemma-hilbert-change-I}.
\end{proof}

\begin{definition}
\label{definition-d}
If $R$ is a local Noetherian ring and $M$ a finite $R$-module.
If $\mathfrak m^nM = 0$ we set $d(M) = 0$.
Otherwise we denote {\it $d(M)$} the degree $+1$ of any of the numerical
polynomials
$\varphi_{I, M}$ above.
\end{definition}

\noindent
Thus $d(M)$ is the degree of the numerical polynomial
$n \mapsto \text{length}_R(M/I^nM)$ for any ideal of definition $I$.
We will denote this function
$$
\chi_{I, M}(n) = \text{length}_R(M/I^{n + 1}M).
$$
We will frequently use that $\chi_{I, M}(n)
= \sum_{i = 0}^n \varphi_{I, M}(i)$ without further mention.

\begin{lemma}
\label{lemma-differ-finite-chi}
Suppose $M \subset M'$ with finite length quotient,
but neither finite length.
Then $\chi_{I, M} - \chi_{I, M'}$
is a polynomial of degree $<$ degree of either
polynomial.
\end{lemma}

\begin{proof}
Immediate from Lemma \ref{lemma-differ-finite} by elementary calculus.
\end{proof}

\begin{lemma}
\label{lemma-hilbert-ses-chi}
Suppose that $0 \to M' \to M \to M'' \to 0$
is a short exact sequence of finite $R$-modules.
Then $\max\{ \deg(\chi_{I, M'}), \deg(\chi_{I, M''}) \}
= \deg(\chi_{I, M})$.
Suppose the length of $M'$ is not finite.
Then $\chi_{I, M} - \chi_{I, M''} - \chi_{I, M'}$
is a numerical polynomial of degree $<$ the degree of
$\chi_{I, M'}$.
\end{lemma}

\begin{proof}
Immediate from Lemma \ref{lemma-hilbert-ses}, and
\ref{lemma-differ-finite-chi} by elementary calculus.
\end{proof}



































\section{Dimension}
\label{section-dimension}

\begin{definition}
\label{definition-Krull}
The {\it Krull dimension} of the ring $R$ is the
Krull dimension of the topological space $\text{Spec}(R)$,
see Topology, \ref{topology-definition-Krull}.
In other words it is the supremum of the integers $n\geq 0$
such that there exists a chain of prime ideals of length $n$:
$$
\mathfrak p_0
\subset
\mathfrak p_1
\subset
\ldots
\subset
\mathfrak p_n, \ \ 
\mathfrak p_i \not= \mathfrak p_{i + 1}.
$$
\end{definition}

\begin{definition}
\label{definition-height}
The {\it height} of a prime ideal $\mathfrak p$ of
a ring $R$ is the dimension of the local ring $R_{\mathfrak p}$.
\end{definition}

\begin{lemma}
\label{lemma-dimension-height}
The Krull dimension of $R$ is the supremum of the
heights of its (maximal) primes.
\end{lemma}

\begin{proof}
This is so because we can always add a maximal ideal at the end of a chain
of prime ideals.
\end{proof}

\begin{lemma}
\label{lemma-Noetherian-dimension-0}
A Noetherian ring of dimension $0$ is Artinian.
Conversely, any Artinian ring is Noetherian of dimension zero.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-Noetherian-topology} the space $\text{Spec}(R)$
is Noetherian. By Topology, Lemma \ref{topology-lemma-Noetherian} we see
that $\text{Spec}(R)$ has finitely many irreducible
components, say $\text{Spec}(R) = Z_1 \cup \ldots Z_r$.
According to Lemma \ref{lemma-irreducible}, each $Z_i = V(\mathfrak p_i)$
with $\mathfrak p_i$ a minimal ideal. Since the dimension is $0$
these $\mathfrak p_i$ are also maximal. Thus $\text{Spec}(R)$
is the discrete topological space with elements $\mathfrak p_i$.
All elements $f$ of the radical $I = \cap \mathfrak p_i$
are nilpotent since otherwise $R_f$ would not be the zero ring
and we would have another prime. Since $I$ is finitely generated
we conclude that $I$ is nilpotent, Lemma \ref{lemma-Noetherian-power}.
By Lemma \ref{lemma-product-local} $R$ is the product of its
local rings. By Lemma \ref{lemma-length-finite} each of these
has finite length over $R$. Hence we conclude that $R$
is Artinian by Lemma \ref{lemma-artinian-finite-length}.

\medskip\noindent
If $R$ is Artinian then by Lemma \ref{lemma-artinian-finite-length}
it is Noetherian. All of its primes are maximal by a combination
of Lemmas \ref{lemma-artinian-finite-nr-max},
\ref{lemma-artinian-radical-nilpotent} and \ref{lemma-product-local}.
\end{proof}

\noindent
In the following we will use the invariant $d(-)$ defined
in Definition \ref{definition-d}. Here is a warm up lemma.

\begin{lemma}
\label{lemma-dimension-0-d-0}
Let $R$ be a Noetherian local ring.
Then $\dim(R) = 0 \Leftrightarrow d(R) = 0$.
\end{lemma}

\begin{proof}
This is because $d(R) = 0$ if and only if $R$ has finite
length as an $R$-module. See Lemma \ref{lemma-artinian-finite-length}.
\end{proof}

\begin{proposition}
\label{proposition-dimension-zero-ring}
Let $R$ be a ring. The following are equivalent:
\begin{enumerate}
\item $R$ is Artinian,
\item $R$ is Noetherian and $\dim(R) = 0$,
\item $R$ has finite length as a module over itself,
\item $R$ is a finite product of Artinian local rings,
\item $R$ is Noetherian and $\text{Spec}(R)$ is a
finite discrete topological space,
\item $R$ is a finite product of Noetherian local rings
of dimension $0$,
\item $R$ is a finite product of Noetherian local rings
$R_i$ with $d(R_i) = 0$,
\item $R$ is a finite product of Noetherian local rings
$R_i$ whose maximal ideals are nilpotent,
\item $R$ is Noetherian, has finitely many maximal
ideals and its radical ideal is nilpotent, and
\item $R$ is Noetherian and there are no strict inclusions
among its primes.
\end{enumerate}
\end{proposition}

\begin{proof}
This is a combination of Lemmas
\ref{lemma-product-local},
\ref{lemma-artinian-finite-length},
\ref{lemma-Noetherian-dimension-0}, and
\ref{lemma-dimension-0-d-0}.
\end{proof}

\begin{lemma}
\label{lemma-height-1}
Let $R$ be a local Noetherian ring.
The following are equivalent:
\begin{enumerate}
\item $\dim(R) = 1$,
\label{item-dim-1}
\item $d(R) = 1$,
\label{item-d-1}
\item there exists an $x \in \mathfrak m$, $x$ not nilpotent
such that $V(x) = \{\mathfrak m\}$,
\label{item-Vx}
\item there exists an $x \in \mathfrak m$, $x$ not nilpotent
such that $\mathfrak m = \sqrt{(x)}$, and
\label{item-x}
\item there exists an ideal of definition generated by $1$ element,
and no ideal of definition is generated by $0$ elements.
\label{item-ideal-1}
\end{enumerate}
\end{lemma}

\begin{proof}
First, assume that $\dim(R) = 1$.
Let $\mathfrak p_i$ be the minimal primes of $R$.
Because the dimension is $1$ the only other prime of $R$
is $\mathfrak m$.
According to Lemma \ref{lemma-Noetherian-irreducible-components}
there are finitely many. Hence we can find $x \in \mathfrak m$,
$x \not \in \mathfrak p_i$, see Lemma \ref{lemma-silly}.
Thus the only prime containing $x$ is $\mathfrak m$ and
hence (\ref{item-Vx}).

\medskip\noindent
If (\ref{item-Vx}) then $\mathfrak m = \sqrt{(x)}$ by
Lemma \ref{lemma-Zariski-topology}, and hence (\ref{item-x}).
The converse is clear as well.
The equivalence of (\ref{item-x}) and (\ref{item-ideal-1}) follows
from directly the definitions.

\medskip\noindent
Assume (\ref{item-ideal-1}).
Let $I = (x)$ be an ideal of definition.
Note that $I^n/I^{n + 1}$ is a quotient of $R/I$ via multiplication
by $x^n$ and hence $\text{length}_R(I^n/I^{n + 1})$ is bounded.
Thus $d(R) = 0$ or $d(R) = 1$, but $d(R) = 0$ is excluded
by the assumption that $0$ is not an ideal of definition.

\medskip\noindent
Assume (\ref{item-d-1}). To get a contradiction, assume there
exist primes $\mathfrak p \subset \mathfrak q \subset \mathfrak m$,
with both inclusions strict. Pick some ideal of definition $I \subset R$.
We will repeatedly use
Lemma \ref{lemma-hilbert-ses-chi}. First of all
it implies, via the exact sequence
$0 \to \mathfrak p \to R \to R/\mathfrak p \to 0$,
that $d(R/\mathfrak p) \leq 1$. But it clearly cannot
be zero. Pick $x\in \mathfrak q$, $x\not \in \mathfrak p$.
Consider the short exact sequence
$$
0 \to R/\mathfrak p \to R/\mathfrak p \to R/(xR + \mathfrak p) \to 0.
$$
This implies that $\chi_{I, R/\mathfrak p} - \chi_{I, R/\mathfrak p}
- \chi_{I, R/(xR + \mathfrak p)} = - \chi_{I, R/(xR + \mathfrak p)}$
has degree $ < 1$. In other words, $d(R/(xR + \mathfrak p) = 0$,
and hence $\dim(R/(xR + \mathfrak p)) = 0$, by
Lemma \ref{lemma-dimension-0-d-0}. But $R/(xR + \mathfrak p)$
has the distinct primes $\mathfrak q/(xR + \mathfrak p)$ and
$\mathfrak m/(xR + \mathfrak p)$ which gives the desired contradiction.
\end{proof}

\begin{proposition}
\label{proposition-dimension}
Let $R$ be a local Noetherian ring.
The following are equivalent:
\begin{enumerate}
\item $\dim(R) = d$,
\label{item-dim-d}
\item $d(R) = d$,
\label{item-d-d}
\item there exists an ideal of definition generated by $d$ elements,
and no ideal of definition is generated by fewer than $d$ elements.
\label{item-ideal-d}
\end{enumerate}
\end{proposition}

\begin{proof}
This proof is really just the same as the proof of Lemma
\ref{lemma-height-1}. We will prove the proposition by induction
on $d$. By Lemmas \ref{lemma-dimension-0-d-0} and \ref{lemma-height-1}
we may assume that $d > 1$. Denote the minimal number of
generators for an ideal of definition of $R$ by $d'(R)$.
We will prove that the inequalities
$\dim(R) \geq d'(R) \geq d(R) \geq \dim(R)$,
and hence they are all equal.

\medskip\noindent
First, assume that $\dim(R) = d$.
Let $\mathfrak p_i$ be the minimal primes of $R$.
According to Lemma \ref{lemma-Noetherian-irreducible-components}
there are finitely many. Hence we can find $x \in \mathfrak m$,
$x \not \in \mathfrak p_i$, see Lemma \ref{lemma-silly}.
Note that every maximal chain of primes starts with some $\mathfrak p_i$,
hence the dimension of $R/xR$ is at most $d-1$. By induction
there are $x_2, \ldots, x_d$ which generate an ideal of definition
in $R/xR$. Hence $R$ has an ideal of definition generated
by (at most) $d$ elements.

\medskip\noindent
Assume $d'(R) = d$. Let $I = (x_1, \ldots, x_d)$ be an ideal
of definition. Note that $I^n/I^{n + 1}$ is a quotient of a direct
sum of $\binom{d + n - 1}{d - 1}$ copies $R/I$ via multiplication
by all degree $n$ monomials in $x_1, \ldots, x_n$.
Hence $\text{length}_R(I^n/I^{n + 1})$ is bounded by a polynomial
of degree $d-1$. Thus $d(R) \leq d$.

\medskip\noindent
Assume $d(R) = d$. Consider a chain of primes
$\mathfrak p \subset \mathfrak q \subset
\mathfrak q_2 \subset \ldots \subset \mathfrak p_e = \mathfrak m$,
with all inclusions strict, and $e \geq 2$.
Pick some ideal of definition $I \subset R$.
We will repeatedly use
Lemma \ref{lemma-hilbert-ses-chi}. First of all
it implies, via the exact sequence
$0 \to \mathfrak p \to R \to R/\mathfrak p \to 0$,
that $d(R/\mathfrak p) \leq d$. But it clearly cannot
be zero. Pick $x\in \mathfrak q$, $x\not \in \mathfrak p$.
Consider the short exact sequence
$$
0 \to R/\mathfrak p \to R/\mathfrak p \to R/(xR + \mathfrak p) \to 0.
$$
This implies that $\chi_{I, R/\mathfrak p} - \chi_{I, R/\mathfrak p}
- \chi_{I, R/(xR + \mathfrak p)} = - \chi_{I, R/(xR + \mathfrak p)}$
has degree $ < d$. In other words, $d(R/(xR + \mathfrak p)) \leq d - 1$,
and hence $\dim(R/(xR + \mathfrak p)) \leq d - 1$, by
induction. Now $R/(xR + \mathfrak p)$ has the chain of prime ideals
$\mathfrak q/(xR + \mathfrak p) \subset \mathfrak q_2/(xR + \mathfrak p)
\subset \ldots \subset \mathfrak q_e/(xR + \mathfrak p)$ which gives
$e - 1 \leq d - 1$. Since we started with an arbitrary chain of
primes this proves that $\dim(R) \leq d(R)$.

\medskip\noindent
Reading back the reader will see we proved the circular
inequalities as desired.
\end{proof}

\noindent
Let $(R, \mathfrak m)$ be a Noetherian local ring.
From the above it is clear that $\mathfrak m$ cannot be
generated by fewer than $\dim(R)$ variables.
By Nakayama's Lemma \ref{lemma-NAK} the minimal number
of generators of $\mathfrak m$ equals $\dim_{\kappa(\mathfrak m)}
\mathfrak m/\mathfrak m^2$. Hence we have the following
fundamental inequality
$$
\dim(R) \leq \dim_{\kappa(\mathfrak m)} \mathfrak m/\mathfrak m^2.
$$
It turns out that the rings where equality holds
have a lot of good properties. They are called
regular local rings.

\begin{definition}
\label{definition-regular-local}
A Noetherian local ring is called {\it regular}
if $\mathfrak m$ can be generated by $\dim(R)$
elements of $R$.
\end{definition}


\noindent
The folllowing two lemmas are clear from the proofs of the
lemmas and proposition above, but we spell them out so we have
convenient references.

\begin{lemma}
\label{lemma-minimal-over-1}
Let $R$ be a Noetherian ring.
\begin{enumerate}
\item Let $x\in R$, $\mathfrak p, \mathfrak q\in \text{Spec}(R)$.
Suppose that $\mathfrak p \subset (\mathfrak p, x) \subset
\mathfrak q$ and $\mathfrak q$ minimal over $(\mathfrak p, x)$.
Then there is no prime strictly between $\mathfrak p$ and $\mathfrak q$.
\item If $x\in R$ and $x \in \mathfrak p$ is minimal over $(x)$
then the height of $\mathfrak p$ is $0$ or $1$.
\end{enumerate}
\end{lemma}

\begin{proof}
Consider the situation of the first assertion.
The primes containing $\mathfrak p$ and contained
in $\mathfrak q$ correspond to primes of
$R_{\mathfrak q}/\mathfrak pR_{\mathfrak q}$, and
the primes containing $x$ correspond to the ones containing
the image of $x$. Thus we may assume $R$ is a Noetherian local domain,
$\mathfrak p = (0)$ and $\mathfrak q$ maximal. Now since
$\sqrt{(x)}$ is the intersection of the prime ideals
containing it, and since $\mathfrak q$ is the only prime
containing $x$ by minimality, we see that $\sqrt{(x)} = \mathfrak q$.
Hence Lemma \ref{lemma-height-1} applies.
The second assertion follows from the first.
\end{proof}

\begin{lemma}
\label{lemma-one-equation}
Suppose that $R$ is a Noetherian local ring and $x\in \mathfrak m$ an
element of its maximal ideal. Then $\dim R <= \dim R/xR + 1$.
If $x$ is not contained in any of the minimal primes of $R$
then equality holds. (For example if $x$ is a nonzero divisor.)
\end{lemma}

\begin{proof}
If $x_1, \ldots, x_{\dim R/xR} \in R$ map to elements of $R/xR$ which
generate an ideal of definition for $R/xR$, then $x, x_1, \ldots,
x_{\dim R/xR}$ generate an ideal of definition for $R$. Hence
the inequality by Proposition \ref{proposition-dimension}.
On the other hand, if $x$ is not contained in any minimal
prime of $R$, then the chains of primes in $R/xR$ all give
rise to chains in $R$ which are at least one step away
from being maximal.
\end{proof}

\begin{lemma}
\label{lemma-elements-generate-ideal-definition}
Let $(R, \mathfrak m)$ be a Noetherian local ring.
Suppose $x_1, \ldots, x_d \in \mathfrak m$ generate an
ideal of definition and $d = \dim(R)$. Then
$\dim(R/(x_1, \ldots, x_i)) = d - i$ for all $i = 1, \ldots, d$.
\end{lemma}

\begin{proof}
Clear from the proof of Proposition \ref{proposition-dimension},
or use induction on $d$ and Lemma \ref{lemma-one-equation} above.
\end{proof}







\section{Applications of dimension theory}
\label{section-applications-dimension-theory}

\noindent
We can use the results on dimension to prove certain rings are
Jacobson.

\begin{lemma}
\label{lemma-Noetherian-local-domain-dim-2-infinite-opens}
Let $R$ be a Noetherian local domain of dimension $\geq 2$.
A nonempty open subset $U \subset \text{Spec}(R)$ is
infinite.
\end{lemma}

\begin{proof}
To get a constradiction, assume that $U \subset \text{Spec}(R)$ is finite.
In this case $(0) \in U$ and $\{(0)\}$ is an open subset of $U$ (because
the complement of $\{(0)\}$ is the union of the closures of the other points).
Thus we may assume $U = \{(0)\}$.
Let $\mathfrak m \subset R$ be the maximal ideal.
We can find an $x \in \mathfrak m$, $x \not = 0$ such that
$V(x) \cup U = \text{Spec}(R)$. In other words we see that
$D(x) = \{(0)\}$. In particular we see
that $\dim(R/xR) = \dim(R) - 1 \geq 1$, see Lemma \ref{lemma-one-equation}.
Let $\overline{y}_2, \ldots, \overline{y}_{\dim(R)} \in R/xR$ generate
an ideal of definition of $R/xR$, see Proposition \ref{proposition-dimension}.
Choose lifts $y_2, \ldots, y_{\dim(R)} \in R$, so that
$x, y_2, \ldots, y_{\dim(R)}$ generate an ideal of definition in $R$.
This implies that $\dim(R/(y_2)) = \dim(R) - 1$ and
$\dim(R/(y_2, x)) = \dim(R) - 2$, see
Lemma \ref{lemma-elements-generate-ideal-definition}.
Hence there exists a prime
$\mathfrak p$ containing $y_2$ but not $x$. This constradicts
the fact that $D(x) = \{(0)\}$.
\end{proof}

\begin{lemma}
\label{lemma-noetherian-dim-1-Jacobson}
(Noetherian Jacobson rings.)
\begin{enumerate}
\item Any Noetherian domain $R$ of dimension $1$
with infinitely many primes is Jacobson.
\item Any Noetherian ring such that every prime
$\mathfrak p$ is either maximal or contained in
infinitely many prime ideals is Jacobson.
\end{enumerate}
\end{lemma}

\begin{proof}
Part (1) is a reformulation of Lemma \ref{lemma-pid-jacobson}.

\medskip\noindent
Let $R$ be a Noetherian ring such that
every non-maximal prime $\mathfrak p$ is contained
in infinitely many prime ideals.
Assume $\text{Spec}(R)$ is not Jacobson to get
a contradiction.
By Lemmas \ref{lemma-irreducible}
and \ref{lemma-Noetherian-topology}
we see that $\text{Spec}(R)$ is a sober, Noetherian topological space.
By Topology, Lemma \ref{topology-lemma-non-jacobson-Noetherian-characterize}
we see that there exists a non-maximal ideal $\mathfrak p \subset R$
such that $\{\mathfrak p\}$ is a locally closed subset of
$\text{Spec}(R)$. In other words, $\mathfrak p$ is not maximal
and $\{\mathfrak p\}$ is an open subset of $V(\mathfrak p)$.
Consider a prime $\mathfrak q \subset R$ with
$\mathfrak p \subset \mathfrak q$. Recall that the topology on the spectrum of
$(R/\mathfrak p)_{\mathfrak q} = R_{\mathfrak q}/\mathfrak pR_{\mathfrak q}$
is induced from that of $\text{Spec}(R)$, see Lemmas
\ref{lemma-spec-localization} and \ref{lemma-spec-closed}.
Hence we see that $\{(0)\}$ is a locally closed subset of
$\text{Spec}((R/\mathfrak p)_{\mathfrak q})$. By
Lemma \ref{lemma-Noetherian-local-domain-dim-2-infinite-opens}
we conclude that $\dim((R/\mathfrak p)_{\mathfrak q}) = 1$.
Since this holds for every $\mathfrak q \supset \mathfrak p$
we conclude that $\dim(R/\mathfrak p) = 1$. At this point we use
the assumption that $\mathfrak p$ is contained in infinitely many
primes to see that $\text{Spec}(R/\mathfrak p)$ is infinite.
Hence by part (1) of the lemma we see that
$V(\mathfrak p) \cong \text{Spec}(R/\mathfrak p)$
is the closure of its closed points.
This is the desired contradiction since it means that
$\{\mathfrak p\} \subset V(\mathfrak p)$ cannot be open.
\end{proof}




















\section{Support and dimension of modules}
\label{section-support}

\begin{lemma}
\label{lemma-filter-Noetherian-module}
Let $R$ be a Noetherian ring, and let $M$ be a finite $R$-module.
There exists a filtration by $R$-submodules
$$
0 = M_0 \subset M_1 \subset \ldots \subset M_n = M
$$
such that each quotient $M_i/M_{i-1}$ is isomorphic
to $R/\mathfrak p_i$ for some prime ideal $\mathfrak p_i$
of $R$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-trivial-filter-finite-module}
it suffices to do the case $M = R/I$ for some ideal $I$.
Consider the set $S$ of ideals $J$ such that the lemma
does not hold for the module $R/J$, and order it by
inclusion. To arrive at a
contradiction, assume that $S$ is not empty. Because
$R$ is Noetherian, $S$ has a maximal element $J$.
By definition of $S$, the ideal $J$ cannot be prime.
Pick $a, b\in R$ such that $ab \in J$, but neither
$a \in J$ nor $b\in J$. Consider the filtration
$0 \subset aR/(J \cap aR) \subset R/J$.
Note that $aR/(J \cap aR)$ is a quotient of $R/(J + bR)$
and the second quotient equals $R/(aR + J)$. Hence by
maximality of $J$, each of these has a filtration as
above and hence so does $R/J$. Contradiction.
\end{proof}

\begin{definition}
\label{definition-support-module}
Let $R$ be a ring and let $M$ be an $R$-module.
The {\it support of $M$} is the set
$$
\text{Supp}(M)
=
\{
\mathfrak p \in \text{Spec}(R)
\mid
M_{\mathfrak p} \not= 0
\}
$$
\end{definition}

\begin{lemma}
\label{lemma-support-zero}
Let $R$ be a ring. Let $M$ be an $R$-module. Then
$$
M = (0) \Leftrightarrow \text{Supp}(M) = \emptyset.
$$
\end{lemma}

\begin{proof}
Actually,
Lemma \ref{lemma-characterize-zero-local}
even shows that $\text{Supp}(M)$ always contains a maximal ideal
if $M$ is not zero.
\end{proof}

\begin{lemma}
\label{lemma-support-closed}
Let $R$ be a ring and let $M$ be an $R$-module.
If $M$ is finite, then $\text{Supp}(M)$ is closed.
More precisely, let $I = \{f \in R \mid fM = 0\}$.
Then $V(I) = \text{Supp}(M)$.
\end{lemma}

\begin{proof}
We will show that $V(I) = \text{Supp}(M)$.

\medskip\noindent
Suppose $\mathfrak p \in \text{Supp}(M)$.
Then $M_{\mathfrak p} \not = 0$.
Hence by Nakayam's Lemma \ref{lemma-NAK} we have
$M \otimes_R \kappa(\mathfrak p) \not = 0$.
Hence $I \subset \mathfrak p$.

\medskip\noindent
Conversely, suppose that $\mathfrak p \not \in \text{Supp}(M)$.
Then $M_{\mathfrak p} = 0$.
Let $x_1, \ldots, x_r \in M$ be generators.
By Lemma \ref{lemma-localize-colimit} there exists
an $f \in R$, $f\not\in \mathfrak p$ such that
$x_i/1 = 0$ in $M_f$. Hence $f^{n_i} x_i = 0$ for some $n_i \geq 1$.
Hence $f^nM = 0$ for $n = \max\{n_i\}$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-support-finite-presentation-constructible}
Let $R$ be a ring and let $M$ be an $R$-module.
If $M$ is a finitely presented $R$-module, then $\text{Supp}(M)$ is a
closed subset of $\text{Spec}(R)$ whose complement is quasi-compact.
\end{lemma}

\begin{proof}
Choose a presentation
$$
R^{\oplus m} \longrightarrow R^{\oplus n} \longrightarrow M \to 0
$$
Let $A \in \text{Mat}(n \times m, R)$ be the matrix of the first
map. By Nakayama's Lemma \ref{lemma-NAK} we see that
$$
M_{\mathfrak p} \not = 0 \Leftrightarrow
M \otimes \kappa(\mathfrak p) \not = 0 \Leftrightarrow
\text{rank}(A \bmod \mathfrak p) < n.
$$
Hence, if $I$ is the ideal of $R$ generated by the $n\times n$ minors
of $A$, then $\text{Supp}(M) = V(I)$. Since $I$ 
is finitely generated, say $I = (f_1, \ldots, f_t)$,
we see that $\text{Spec}(R) \setminus V(I)$ is
a finite union of the standard opens $D(f_i)$, hence quasi-compact.
\end{proof}

\begin{lemma}
\label{lemma-support-quotient}
Let $R$ be a ring and let $M$ be an $R$-module.
\begin{enumerate}
\item If $M$ is finite then the support
of $M/IM$ is $\text{Supp}(M) \cap V(I)$.
\item If $N \subset M$, then $\text{Supp}(N) \subset
\text{Supp}(M)$.
\item If $Q$ is a quotient module of $M$ then $\text{Supp}(Q) \subset
\text{Supp}(M)$.
\item If $0 \to N \to M \to Q \to 0$ is a short exact sequence
then $\text{Supp}(M) = \text{Supp}(Q) \cup
\text{Supp}(N)$.
\end{enumerate}
\end{lemma}

\begin{proof}
The functors $M \mapsto M_{\mathfrak p}$ are exact. This immediately
implies all but the first assertion. For the first assertion
we need to show that $M_\mathfrak p \not = 0$ and
$I \subset \mathfrak p$ implies $(M/IM)_{\mathfrak p}
= M_\mathfrak p/IM_\mathfrak p \not = 0$. This follows
from Nakayama's Lemma \ref{lemma-NAK}.
\end{proof}

\begin{lemma}
\label{lemma-filter-primes-in-support}
Let $R$, $M$, $M_i$, $\mathfrak p_i$ as in
Lemma \ref{lemma-filter-Noetherian-module}.
All of the primes $\mathfrak p_i$ are in the support of
$M$.
\end{lemma}

\begin{proof}
Since localization is exact, we see that
$(R/\mathfrak p_i)_{\mathfrak p_i}$ is a
subquotient of $M_{\mathfrak p_i}$.
Hence $M_{\mathfrak p_i}$ is not zero.
\end{proof}

\begin{lemma}
\label{lemma-support-point}
Suppose that $R$ is a Noetherian local ring with
maximal ideal $\mathfrak m$. Let $M$ be a finite
$R$-module. Then $\text{Supp}(M) = \{ \mathfrak m\}$
if and only if $M$ has finite length over $R$.
\end{lemma}

\begin{proof}
Assume that $\text{Supp}(M) = \{ \mathfrak m\}$.
It suffices to show that all the primes $\mathfrak p_i$
in the filtration of Lemma \ref{lemma-filter-Noetherian-module}
are the maximal ideal. This is clear by
Lemma \ref{lemma-filter-primes-in-support}.

\medskip\noindent
Suppose that $M$ has finite length over $R$.
Then $\mathfrak m^n M = 0$ by Lemma \ref{lemma-length-infinite}.
Since some element of $\mathfrak m$ maps to a unit
in $R_{\mathfrak p}$ for any prime
$\mathfrak p \not = \mathfrak m$ in $R$ we see $M_{\mathfrak p} = 0$.
\end{proof}

\begin{lemma}
\label{lemma-Noetherian-power-ideal-kills-module}
Let $R$ be a Noetherian ring.
Let $I \subset R$ be an ideal.
Let $M$ be a finite $R$-module.
Then $I^nM = 0$ for some $n \geq 0$ if and only if
$\text{Supp}(M) \subset V(I)$.
\end{lemma}

\begin{proof}
It is clear that $I^nM = 0$ for some $n \geq 0$ implies
$\text{Supp}(M) \subset V(I)$. Suppose that $\text{Supp}(M) \subset V(I)$.
Choose a filtration $0 = M_0 \subset M_1 \subset \ldots \subset M_n = M$
as in Lemma \ref{lemma-filter-Noetherian-module}. Each of the primes
$\mathfrak p_i$ is contained in $V(I)$ by
Lemma \ref{lemma-filter-primes-in-support}.
Hence $I \subset \mathfrak p_i$ and $I$ annihilates $M_i/M_{i - 1}$.
Hence $I^n$ annihilates $M$.
\end{proof}

\begin{lemma}
\label{lemma-filter-minimal-primes-in-support}
Let $R$, $M$, $M_i$, $\mathfrak p_i$ as in
Lemma \ref{lemma-filter-Noetherian-module}.
The minimal elements of the set $\{\mathfrak p_i\}$
are the minimal elements of $\text{Supp}(M)$, and
the number of times a minimal prime $\mathfrak p$
occurs is
$$
\#\{i \mid \mathfrak p_i = \mathfrak p\}
=
\text{length}_{R_\mathfrak p} M_{\mathfrak p}.
$$
\end{lemma}

\begin{proof}
We have already seen $\{\mathfrak p_i\} \subset \text{Supp}(M)$,
in Lemma \ref{lemma-filter-primes-in-support}.
Let $\mathfrak p \in \text{Supp}(M)$ be minimal.
The support of $M_{\mathfrak p}$ is the set
consisting of the maximal ideal $\mathfrak p R_{\mathfrak p}$.
Hence by Lemma \ref{lemma-support-point} the length
of $M_{\mathfrak p}$ is finite and $>0$. Next we
note that $M_{\mathfrak p}$ has a filtration with subquotients
$
(R/\mathfrak p_i)_{\mathfrak p}
=
R_{\mathfrak p}/{\mathfrak p_i}R_{\mathfrak p}
$
These are zero if $\mathfrak p_i \not \subset \mathfrak p$
and equal to $\kappa(\mathfrak p)$ if $\mathfrak p_i \subset
\mathfrak p$ because by minimality of $\mathfrak p$
we have $\mathfrak p_i = \mathfrak p$ in this case.
The result follows since $\kappa(\mathfrak p)$ has length $1$.
\end{proof}

\begin{lemma}
\label{lemma-support-dimension-d}
Let $R$ be a Noetherian local ring.
Let $M$ be a finite $R$-module.
Then $d(M) = \dim(\text{Supp}(M))$.
\end{lemma}

\begin{proof}
Let $M_i, \mathfrak p_i$ be as in Lemma \ref{lemma-filter-Noetherian-module}.
By Lemma \ref{lemma-hilbert-ses-chi} we obtain the equality
$d(M) = \max \{ d(R/\mathfrak p_i) \}$. By
Proposition \ref{proposition-dimension} we have
$d(R/\mathfrak p_i) = \dim(R/\mathfrak p_i)$.
Trivially $\dim(R/\mathfrak p_i) = \dim V(\mathfrak p_i)$.
Since all minimal primes of $\text{Supp}(M)$ occur among
the $\mathfrak p_i$ we win.
\end{proof}











\section{Associated primes}
\label{section-ass}

\noindent
Here is the standard definition. For non-Noetherian ring and non-finite
modules it may be more appropriate to use the definition in
Section \ref{section-weakly-ass}.

\begin{definition}
\label{definition-associated}
Let $R$ be a ring. Let $M$ be an $R$-module.
A prime $\mathfrak p$ of $R$ is {\it associated} to $M$
if there exists an element $m \in M$ whose annihilator
is $\mathfrak p$.
The set of all such primes is denoted $\text{Ass}_R(M)$
or $\text{Ass}(M)$.
\end{definition}

\begin{lemma}
\label{lemma-ass-support}
Let $R$ be a ring. Let $M$ be an $R$-module.
Then $\text{Ass}(M) \subset \text{Supp}(M)$.
\end{lemma}

\begin{proof}
If $m \in M$ has annihilator $\mathfrak p$, then in particular
no element of $R \setminus \mathfrak p$ annihilates $m$.
Hence $m$ is a nonzero element of $M_{\mathfrak p}$, i.e.,
$\mathfrak p \in \text{Supp}(M)$.
\end{proof}

\begin{lemma}
\label{lemma-ass}
Let $R$ be a ring.
Let $0 \to M' \to M \to M'' \to 0$ be a short exact sequence
of $R$-modules.
Then $\text{Ass}(M') \subset \text{Ass}(M)$ and
$\text{Ass}(M) \subset \text{Ass}(M') \cup \text{Ass}(M'')$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-ass-filter}
Let $R$ be a ring, and $M$ an $R$-module.
Suppose there exists a filtration by $R$-submodules
$$
0 = M_0 \subset M_1 \subset \ldots \subset M_n = M
$$
such that each quotient $M_i/M_{i-1}$ is isomorphic to $R/\mathfrak p_i$
for some prime ideal $\mathfrak p_i$ of $R$.
Then $\text{Ass}(M) \subset \{\mathfrak p_1, \ldots, \mathfrak p_n\}$.
\end{lemma}

\begin{proof}
By induction on the length $n$ of the filtration $\{ M_i \}$.
Pick $m \in M$ whose annihilator is a prime $\mathfrak p$.
If $m \in M_{n-1}$ we are done by induction. If not,
then $m$ maps to a nonzero element of $M/M_{n-1} \cong
R/\mathfrak p_n$. Hence we have $\mathfrak p \subset \mathfrak p_n$.
If equality does not hold, then we can find $f \in \mathfrak p_n$,
$f \not\in \mathfrak p$. In this case the annihilator of $fm$ is still
$\mathfrak p$ and $fm \in M_{n-1}$. Thus we win by induction.
\end{proof}

\begin{lemma}
\label{lemma-finite-ass}
Let $R$ be a Noetherian ring.
Let $M$ be a finite $R$-module.
Then $\text{Ass}(M)$ is finite.
\end{lemma}

\begin{proof}
Immediate from Lemma \ref{lemma-ass-filter} and
Lemma \ref{lemma-filter-Noetherian-module}.
\end{proof}

\begin{proposition}
\label{proposition-minimal-primes-associated-primes}
Let $R$ be a Noetherian ring.
Let $M$ be a finite $R$-module.
The following sets of primes are the same:
\begin{enumerate}
\item The minimal primes in the support of $M$.
\item The minimal primes in $\text{Ass}(M)$.
\item For any filtration $0 = M_0 \subset M_1 \subset \ldots
\subset M_{n-1} \subset M_n = M$ with $M_i/M_{i-1} \cong R/\mathfrak p_i$
the minimal primes of the set $\{\mathfrak p_i\}$.
\end{enumerate}
\end{proposition}

\begin{proof}
Part of this we saw in Lemma \ref{lemma-filter-minimal-primes-in-support}.
It suffices to prove that if $\mathfrak p$ is a minimal element of
the set $\{\mathfrak p_i\}$ then it is the annihilator of
an element of $M$. Let $i$ be minimal such that
$\mathfrak p = \mathfrak p_i$.
Pick $m \in M_i$, $m \not \in M_{i-1}$. The annihilator of $m$
is contained in $\mathfrak p_i = \mathfrak p$ and contains
$\mathfrak p_1 \mathfrak p_2 \ldots \mathfrak p_i$. By our choice of
$i$ we have $\mathfrak p_1 \mathfrak p_2 \ldots \mathfrak p_{i-1}
\not \subset \mathfrak p_i$. Pick
$f \in \mathfrak p_1 \mathfrak p_2 \ldots \mathfrak p_{i-1}$,
$f \not \in \mathfrak p$. Then $fm$ has annihilator $\mathfrak p$.
\end{proof}

\begin{lemma}
\label{lemma-ass-zero}
Let $R$ be a Noetherian ring. Let $M$ be an $R$-module.
Then
$$
M = (0) \Leftrightarrow \text{Ass}(M) = \emptyset.
$$
\end{lemma}

\begin{proof}
If $M = (0)$, then $\text{Ass}(M) = \emptyset$ by definition.
If $M \not = 0$, pick any nonzero finitely generated submodule
$M' \subset M$, for example a submodule generated by a single nonzero
element. By
Lemma \ref{lemma-support-zero}
we see that $\text{Supp}(M')$ is nonempty. By
Proposition \ref{proposition-minimal-primes-associated-primes}
this implies that $\text{Ass}(M')$ is nonempty.
By
Lemma \ref{lemma-ass}
this implies $\text{Ass}(M) \not = \emptyset$.
\end{proof}

\begin{lemma}
\label{lemma-ass-zero-divisors}
Let $R$ be a Noetherian ring.
Let $M$ be a finite $R$-module.
The union $\bigcup_{\mathfrak q \in \text{Ass}(M)} \mathfrak q$
is the set elements of $R$ which are zero divisors on $M$.
\end{lemma}

\begin{proof}
Any element in any associated prime clearly is a zero divisor
on $M$. Conversely, suppose $x \in R$ is a zero divisor on $M$.
Consider the submodule $N = \{m \in M \mid xm = 0\}$.
Since $N$ is not zero it has an associated prime $\mathfrak q$,
and clearly $x \in \mathfrak q$. But just as clearly $\mathfrak q$
is also an associated prime of $M$.
\end{proof}

\begin{lemma}
\label{lemma-associated-primes-localize}
Let $R$ be a ring.
Let $M$ be an $R$-module.
Let $\mathfrak p \subset R$ be a prime.
\begin{enumerate}
\item If $\mathfrak p \in \text{Ass}(M)$ then
$\mathfrak pR_{\mathfrak p} \in \text{Ass}(M_{\mathfrak p})$.
\item If $\mathfrak p$ is finitely generated then the converse holds
as well.
\end{enumerate}
\end{lemma}

\begin{proof}
If $\mathfrak p \in \text{Ass}(M)$ there exists an element $m \in M$
whose annihilator is $\mathfrak p$. As localization is exact
(Proposition \ref{proposition-localization-exact})
we see that the annihilator of $m/1$ in
$M_{\mathfrak p}$ is $\mathfrak pR_{\mathfrak p}$ hence (1) holds.
Assume $\mathfrak pR_{\mathfrak p} \in \text{Ass}(M_{\mathfrak p})$
and $\mathfrak p = (f_1, \ldots, f_n)$. Let $m/g$ be an element of
$M_{\mathfrak p}$ whose annihilator is $\mathfrak pR_{\mathfrak p}$.
This implies that the annihilator of $m$ is contained in $\mathfrak p$.
As $f_i m/g = 0$ in $M_{\mathfrak p}$ we see there exists a
$g_i \in R$, $g_i \not \in \mathfrak p$ such that $g_i f_i m = 0$ in $M$.
Combined we see the annihilator of $g_1\ldots g_nm$ is $\mathfrak p$. Hence
$\mathfrak p \in \text{Ass}(M)$.
\end{proof}

\begin{lemma}
\label{lemma-ideal-nonzerodivisor}
Let $R$ be a Noetherian local ring with
maximal ideal $\mathfrak m$. Let $I \subset \mathfrak m$
be an ideal. Let $M$ be a finite $R$-module.
The following are equivalent:
\begin{enumerate}
\item There exists an $x \in I$ which is not a zero divisor on $M$.
\item We have $I \not \subset \mathfrak q$ for all
$\mathfrak q \in \text{Ass}(M)$.
\end{enumerate}
\end{lemma}

\begin{proof}
If there exists a nonzero divisor $x$ in $I$,
then $x$ clearly cannot be in any associated
prime of $M$. Conversely, suppose $I \not \subset \mathfrak q$
for all $\mathfrak q \in \text{Ass}(M)$. In this case we can
choose $x \in I$, $x \not \in \mathfrak q$ for all
$\mathfrak q \in \text{Ass}(M)$ by Lemmas
\ref{lemma-finite-ass} and \ref{lemma-silly}.
By Lemma \ref{lemma-ass-zero-divisors} the element $x$
is not a zero divisor on $M$.
\end{proof}

\begin{lemma}
\label{lemma-zero-at-ass-zero}
Let $R$ be a ring. Let $M$ be an $R$-module. If $R$ is Noetherian
the map
$$
M
\longrightarrow
\prod\nolimits_{\mathfrak p \in \text{Ass}(M)} M_{\mathfrak p}
$$
is injective.
\end{lemma}

\begin{proof}
Let $x \in M$ be an element of the kernel of the map.
Then if $\mathfrak p$ is an associated prime of $Rx \subset M$
we see on the one hand that $\mathfrak p \in \text{Ass}(M)$
(Lemma \ref{lemma-ass}) and
on the other hand that $(Rx)_{\mathfrak p} \subset M_{\mathfrak p}$
is not zero. This contradiction shows that $\text{Ass}(Rx) = \emptyset$.
Hence $Rx = 0$ by
Lemma \ref{lemma-ass-zero}.
\end{proof}

\begin{lemma}
\label{lemma-bourbaki}
Let $R \to S$ be a ring map.
Let $M$ be an $R$-module, and let $N$ be an $S$-module.
Assume
\begin{enumerate}
\item $N$ is flat as $R$-module, and
\item $R$ and $S$ are Noetherian.
\end{enumerate}
Then we have
$$
\text{Ass}_S(M \otimes_R N) 
=
\bigcup\nolimits_{\mathfrak p \in \text{Ass}_R(M)} \text{Ass}_S(N/\mathfrak pN)
$$
\end{lemma}

\begin{proof}
Write $M = \bigcup M_\lambda$ as the union of its finitely generated
$R$-submodules. Then also $N \otimes_R M = \bigcup N \otimes_R M_\lambda$
(as $N$ is $R$-flat). By definition of associated primes we see that
$\text{Ass}_S(N \otimes_R M) = \bigcup \text{Ass}_S(N \otimes_R M_\lambda)$
and $\text{Ass}_R(M) = \bigcup \text{Ass}(M_\lambda)$. Hence we may assume
$M$ is finitely generated.

\medskip\noindent
Suppose that $\mathfrak q \in \text{Ann}_S(N/\mathfrak pN)$ and
$\mathfrak p \in \text{Ann}_R(M)$. Then there exists an
element $m \in M$ whose annihilator is $\mathfrak p$ and an
element $\overline{n} \in N/\mathfrak pN$ whose annihilator
is $\mathfrak q$. In this case the annihilator
of $m \otimes n$ is $\mathfrak q$. Hence the right hand side is
contained in the left hand side.

\medskip\noindent
Let $\mathfrak q \in \text{Ass}_S(M \otimes_R N)$, and assume $M$
is a finite $R$-module. To finish the proof we have to show that
$\mathfrak q$ is an element of the right hand side. First we observe that
$\mathfrak qS_{\mathfrak q} \in
\text{Ass}_{S_{\mathfrak q}}((M \otimes_R N)_{\mathfrak q})$,
see Lemma \ref{lemma-associated-primes-localize}.
Let $\mathfrak p$ be the corresponding prime of $R$.
Note that
$$
(M \otimes_R N)_{\mathfrak q} = M \otimes_R N_{\mathfrak q}
= M_{\mathfrak p} \otimes_{R_{\mathfrak p}} N_{\mathfrak q}
$$
If
$\mathfrak pR_{\mathfrak p} \not \in
\text{Ass}_{R_{\mathfrak p}}(M_{\mathfrak p})$
then there exists an element $x \in \mathfrak pR_{\mathfrak p}$ which
is a nonzero divisor in $M_{\mathfrak p}$ (see
Lemma \ref{lemma-ideal-nonzerodivisor}). Since
$N_{\mathfrak q}$ is flat over $R_{\mathfrak p}$ we see that
the image of $x$ in $\mathfrak qS_{\mathfrak q}$ is a nonzero divisor on 
$(M \otimes_R N)_{\mathfrak q}$. This is a contradiction
with the assumption that
$\mathfrak qS_{\mathfrak q} \in \text{Ass}_S((M \otimes_R N)_{\mathfrak q})$.
Hence we conclude that $\mathfrak p$ is one of the associated
primes of $M$.

\medskip\noindent
Continuing the argument we choose a filtration
$$
0 = M_0 \subset M_1 \subset \ldots \subset M_n = M
$$
such that each quotient $M_i/M_{i-1}$ is isomorphic
to $R/\mathfrak p_i$ for some prime ideal $\mathfrak p_i$
of $R$, see Lemma \ref{lemma-filter-Noetherian-module}.
(By Lemma \ref{lemma-ass-filter} we have $\mathfrak p_i = \mathfrak p$ for
at least one $i$.) This gives a filtration
$$
0 = M_0 \otimes_R N \subset M_1 \otimes_R N \subset \ldots
\subset M_n \otimes_R N = M \otimes_R N
$$
with subquotients isomorphic to $N/\mathfrak p_iN$. If
$\mathfrak p_i \not = \mathfrak p$ then $\mathfrak q$ cannot be
associated to the module $N/\mathfrak p_iN$ by the result of the
preceding paragraph (as $\text{Ass}_R(R/\mathfrak p_i) = \{\mathfrak p_i\}$).
Hence we conclude that $\mathfrak q$ is associated to
$N/\mathfrak pN$ as desired.
\end{proof}

\begin{definition}
\label{definition-symbolic-power}
Let $R$ be a Noetherian ring.
Let $\mathfrak p$ be a prime ideal.
Let $n \geq 1$. The $n$th {\it symbolic power} of $\mathfrak p$
is the ideal $\mathfrak p^{(n)} = R \cap \mathfrak p^nR_{\mathfrak p}$.
\end{definition}

\noindent
Note that $\mathfrak p^n \subset \mathfrak p^{(n)}$ but equality does
not always hold.

\begin{lemma}
\label{lemma-symbolic-power-associated}
Let $R$ be a Noetherian ring.
Let $\mathfrak p$ be a prime ideal.
Let $n > 0$. Then $\text{Ass}(R/\mathfrak p^{(n)}) = \{\mathfrak p\}$.
\end{lemma}

\begin{proof}
If $\mathfrak q$ is an associated prime of $R/\mathfrak p^{(n)}$
then clearly $\mathfrak p \subset \mathfrak q$.
On the other hand, any element $x \in R$, $x \not \in \mathfrak p$
is a nonzero divisor on $R/\mathfrak p^{(n)}$.
Namely, if $y \in R$ and
$xy \in \mathfrak p^{(n)} = R \cap \mathfrak p^nR_{\mathfrak p}$
then $y \in \mathfrak p^nR_{\mathfrak p}$, hence $y \in \mathfrak p^{(n)}$.
Hence the lemma follows.
\end{proof}





\section{Weakly associated primes}
\label{section-weakly-ass}

\noindent
This is a variant on the notion of an associated prime that is useful
for non-Noetherian ring and non-finite modules.

\begin{definition}
\label{definition-weakly-associated}
Let $R$ be a ring. Let $M$ be an $R$-module.
A prime $\mathfrak p$ of $R$ is {\it weakly associated} to $M$
if there exists an element $m \in M$ such that $\mathfrak p$ is minimal
among the prime ideals containing the annihilator
$\text{Ann}(m) = \{f \in R \mid fm = 0\}$.
The set of all such primes is denoted $\text{WeakAss}_R(M)$
or $\text{WeakAss}(M)$.
\end{definition}

\noindent
Thus an associated prime is a weakly associated prime.
Here is a characterization in terms of the localization at the prime.

\begin{lemma}
\label{lemma-weakly-ass-local}
Let $R$ be a ring. Let $M$ be an $R$-module.
Let $\mathfrak p$ be a prime of $R$.
The following are equivalent:
\begin{enumerate}
\item $\mathfrak p$ is weakly associated to $M$,
\item $\mathfrak pR_{\mathfrak p}$ is weakly associated to $M_{\mathfrak p}$,
and
\item $M_{\mathfrak p}$ contains an element whose
annihilator has radical equal to $\mathfrak pR_{\mathfrak p}$.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume (1). Then there exists an element $m \in M$ such that
$\mathfrak p$ is minimal among the primes containing the annihilator
$I = \{x \in R \mid xm = 0\}$ of $m$. As localization is exact, the
annihilator of $m$ in $M_{\mathfrak p}$ is $I_{\mathfrak p}$.
Hence $\mathfrak pR_{\mathfrak p}$ is a minimal prime of
$R_{\mathfrak p}$ containing the annihilator $I_{\mathfrak p}$
of $m$ in $M_{\mathfrak p}$. This implies (2) holds, and also (3)
as it implies that $\sqrt{I_{\mathfrak p}} = \mathfrak pR_{\mathfrak p}$.

\medskip\noindent
Applying the implication (1) $\Rightarrow$ (3) to $M_{\mathfrak p}$
over $R_{\mathfrak p}$ we see that (2) $\Rightarrow$ (3).

\medskip\noindent
Finally, assume (3). This means there exists an element
$m/f \in M_{\mathfrak p}$ whose annihilator has radical equal
to $\mathfrak pR_{\mathfrak p}$. Then the annihilator
$I = \{x \in R \mid xm = 0\}$ of $m$ in $M$ is such that
$\sqrt{I_{\mathfrak p}} = \mathfrak pR_{\mathfrak p}$. Clearly
this means that $\mathfrak p$ contains $I$ and is minimal among the
primes containing $I$, i.e., (1) holds.
\end{proof}

\begin{lemma}
\label{lemma-weakly-ass}
Let $R$ be a ring.
Let $0 \to M' \to M \to M'' \to 0$ be a short exact sequence
of $R$-modules.
Then $\text{WeakAss}(M') \subset \text{WeakAss}(M)$ and
$\text{WeakAss}(M) \subset \text{WeakAss}(M') \cup \text{WeakAss}(M'')$.
\end{lemma}

\begin{proof}
We will use the characterization of weakly associated primes of
Lemma \ref{lemma-weakly-ass-local}.
Let $\mathfrak p$ be a prime of $R$. As localization is exact we obtain
the short exact sequence
$0 \to M'_{\mathfrak p} \to M_{\mathfrak p} \to M''_{\mathfrak p} \to 0$.
Suppose that $m \in M_{\mathfrak p}$ is an element whose annihilator
has radical $\mathfrak pR_{\mathfrak p}$. Then either the image $\overline{m}$
of $m$ in $M''_{\mathfrak p}$ is zero and $m \in M'_{\mathfrak p}$, or
the annihilator of $\overline{m}$ is $\mathfrak pR_{\mathfrak p}$.
This proves that
$\text{WeakAss}(M) \subset \text{WeakAss}(M') \cup \text{WeakAss}(M'')$.
The inclusion $\text{WeakAss}(M') \subset \text{WeakAss}(M)$ is immediate
from the definitions.
\end{proof}

\begin{lemma}
\label{lemma-weakly-ass-zero}
Let $R$ be a ring. Let $M$ be an $R$-module. Then
$$
M = (0) \Leftrightarrow \text{WeakAss}(M) = \emptyset
$$
\end{lemma}

\begin{proof}
If $M = (0)$ then $\text{WeakAss}(M) = \emptyset$ by definition.
Conversely, suppose that $M \not = 0$. Pick a nonzero element $m \in M$.
Write $I = \{x \in R \mid xm = 0\}$ the annihilator of $m$.
Then $R/I \subset M$. Hence $\text{WeakAss}(R/I) \subset \text{WeakAss}(M)$ by
Lemma \ref{lemma-weakly-ass}.
But as $I \not = R$ we have $V(I) = \text{Spec}(R/I)$ contains a minimal
prime, see
Lemmas \ref{lemma-Zariski-topology} and
\ref{lemma-spec-closed},
and we win.
\end{proof}

\begin{lemma}
\label{lemma-weakly-ass-support}
Let $R$ be a ring. Let $M$ be an $R$-module. Then
$$
\text{Ass}(M) \subset \text{WeakAss}(M) \subset \text{Supp}(M).
$$
\end{lemma}

\begin{proof}
The first inclusion is immediate from the definitions.
If $\mathfrak p \in \text{WeakAss}(M)$, then by
Lemma \ref{lemma-weakly-ass-local}
we have $M_{\mathfrak p} \not = 0$, hence $\mathfrak p \in \text{Supp}(M)$.
\end{proof}

\begin{lemma}
\label{lemma-ass-weakly-ass}
Let $R$ be a ring. Let $M$ be an $R$-module.
Let $\mathfrak p$ be a prime ideal of $R$ which is finitely generated.
Then
$$
\mathfrak p \in \text{Ass}(M) \Leftrightarrow
\mathfrak p \in \text{WeakAss}(M).
$$
In particular, if $R$ is Noetherian, then $\text{Ass}(M) = \text{WeakAss}(M)$.
\end{lemma}

\begin{proof}
Write $\mathfrak p = (g_1, \ldots, g_n)$ for some $g_i \in R$.
It is enough the prove the implication ``$\Leftarrow$'' as the other
implication holds in general, see
Lemma \ref{lemma-weakly-ass-support}.
Assume $\mathfrak p \in \text{WeakAss}(M)$.
By
Lemma \ref{lemma-weakly-ass-local}
there exists an element $m \in M_{\mathfrak p}$ such that
$I = \{x \in R_{\mathfrak p} \mid xm = 0\}$ has radical
$\mathfrak pR_{\mathfrak p}$. Hence for each $i$ there exists
a smallest $e_i > 0$ such that $g_i^{e_i}m = 0$ in $M_{\mathfrak p}$.
If $e_i > 1$ for some $i$, then we can replace $m$ by
$g_i^{e_i - 1} m \not = 0$ and decrease $\sum e_i$.
Hence we may asssume that the annihilator of $m \in M_{\mathfrak p}$ is
$(g_1, \ldots, g_n)R_{\mathfrak p} = \mathfrak p R_{\mathfrak p}$. By
Lemma \ref{lemma-associated-primes-localize}
we see that $\mathfrak p \in \text{Ass}(M)$.
\end{proof}









\section{Embedded primes}
\label{section-embedded-primes}

\noindent
Here is the definition.

\begin{definition}
\label{definition-embedded-primes}
Let $R$ be a ring.
Let $M$ be an $R$-module.
\begin{enumerate}
\item  The associated primes of $M$ which are
not minimal among the associated primes of $M$ are called the
{\it embedded associated primes} of $M$.
\item The {\it embedded primes of $R$}
are the embedded associated primes of $R$ as an $R$-module.
\end{enumerate}
\end{definition}

\noindent
Here is a way to get rid of these.

\begin{lemma}
\label{lemma-remove-embedded-primes}
Let $R$ be a Noetherian ring.
Let $M$ be a finite $R$-module.
Consider the set of $R$-submodules
$$
\{
K \subset M
\mid
\text{Supp}(K)
\text{ nowhere dense in }
\text{Supp}(M)
\}.
$$
This set has a maximal element $K$ and the quotient
$M' = M/K$ has the following properties
\begin{enumerate}
\item $\text{Supp}(M) = \text{Supp}(M')$,
\item $M'$ has no embedded associated primes,
\item for any $f \in R$ which is contained in all
embedded associated primes of $M$ we have $M_f \cong M'_f$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $\mathfrak q_1, \ldots, \mathfrak q_t$ denote the
minimal primes in the support of $M$. Let
$\mathfrak p_1, \ldots, \mathfrak p_s$ denote the
embedded associated primes of $M$. Then
$\text{Ass}(M) = \{\mathfrak q_j, \mathfrak p_i\}$.
There are finitely many of these,
see Lemma \ref{lemma-finite-ass}.
Set $I = \prod_{i = 1, \ldots, s} \mathfrak p_i$.
Then $I \not \subset \mathfrak q_j$ for
any $j$. Hence by Lemma \ref{lemma-silly} we can find an
$f \in I$ such that $f \not \in \mathfrak q_j$ for
all $j = 1, \ldots, t$. Set $M' = \text{Im}(M \to M_f)$.
This implies that $M_f \cong M'_f$. Since
$M' \subset M_f$ we see that
$\text{Ass}(M') \subset \text{Ass}(M_f) = \{\mathfrak q_j\}$.
Thus $M'$ has no embedded associated primes.

\medskip\noindent
Moreover, the support of $K = \text{Ker}(M \to M')$
is contained in $V(\mathfrak p_1) \cup \ldots \cup V(\mathfrak p_s)$,
because $\text{Ass}(K) \subset \text{Ass}(M)$
(see Lemma \ref{lemma-ass}) and $\text{Ass}(K)$ contains none
of the $\mathfrak q_i$ by construction.
Clearly, $K$ is in fact the largest submodule of $M$ whose support is
contained in $V(\mathfrak p_1) \cup \ldots \cup V(\mathfrak p_t)$.
This implies that $K$ is the maximal element of the set displayed
in the lemma.
\end{proof}

\begin{lemma}
\label{lemma-remove-embedded-primes-localize}
Let $R$ be a Noetherian ring.
Let $M$ be a finite $R$-module.
For any $f \in R$ we have $(M')_f = (M_f)'$ where
$M \to M'$ and $M_f \to (M_f)'$ are the quotients
constructed in Lemma \ref{lemma-remove-embedded-primes}.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-no-embedded-primes-endos}
Let $R$ be a Noetherian ring.
Let $M$ be a finite $R$-module without embedded associated primes.
Let $I = \{x \in R \mid xM = 0\}$. Then the ring $R/I$ has no
embedded primes.
\end{lemma}

\begin{proof}
We may replace $R$ by $R/I$.
Hence we may assume every nonzero element
of $R$ acts nontrivially on $M$.
By Lemma \ref{lemma-support-closed} this implies that
$\text{Spec}(R)$ equals the support of $M$.
Suppose that $\mathfrak p$ is an embedded prime of $R$.
Let $x \in R$ be an element whose annihilator is $\mathfrak p$.
Consider the nonzero module $N = xM \subset M$. It is annihilated
by $\mathfrak p$. Hence any associated prime $\mathfrak q$ of $N$
contains $\mathfrak p$ and is also an associated prime of $M$.
Then $\mathfrak q$ would be an embedded associated prime of
$M$ which contradicts the assumption of the lemma.
\end{proof}

















\section{Regular sequences and depth}
\label{section-depth}

\noindent
There is a characterization of depth in terms of Ext-groups
that we will discuss in Section \ref{section-ext}. Here we just do
a minimal amount of work to prove the inequality between
depth and dimension.

\begin{definition}
\label{definition-regular-sequence}
Let $R$ be a ring.
Let $M$ be an $R$-module.
A sequence of elements $f_1, \ldots, f_r$ is called {\it $M$-regular}
if the following conditions hold:
\begin{enumerate}
\item $f_i$ is a nonzero divisor on
$M/(f_1, \ldots, f_{r-1})M$
for each $i = 1, \ldots, r$, and
\item the module $M/(f_1, \ldots, f_r)M$ is not zero.
\end{enumerate}
If $I$ is an ideal of $R$ and $f_1, \ldots, f_r \in I$
then we call $f_1, \ldots, f_r$ a {\it $M$-regular sequence
in $I$}. If $M = R$, we call $f_1, \ldots, f_r$ simply a
{\it regular sequence} (in $I$).
\end{definition}

\noindent
Please pay attention to the fact that the definition depends
on the order of the elements $f_1, \ldots, f_r$. Here are two
examples.

\begin{example}
\label{example-global-regular}
Let $k$ be a field. In the ring $k[x, y, z]$
the sequence $x, y(1-x), z(1-x)$ is regular
but the sequence $y(1-x), z(1-x), x$ is not.
\end{example}

\begin{example}
\label{example-local-regular}
Let $k$ be a field. Consider the ring
$k[x, y, w_0, w_1, w_2, \ldots]/I$
where $I$ is generated by $yw_i$, $i = 0, 1, 2, \ldots$ and
$w_i - xw_{i + 1}$, $i = 0, 1, 2, \ldots$.
The sequence $x, y$ is regular, but $y$ is a zero divisor.
Moreover you can localize at the maximal ideal
$(x, y, w_i)$ and still get an example.
\end{example}

\begin{definition}
\label{definition-depth}
Let $R$ be a ring, and $I \subset R$ an ideal.
Let $M$ be an $R$-module.
The {\it $I$-depth} of $M$ is the supremum of the lengths
of $M$-regular sequences in $I$; we denote it
$\text{depth}_I(M)$. If $(R, \mathfrak m)$ is
local we call $\text{depth}_{\mathfrak m}(M)$ simply
the {\it depth} of $M$.
\end{definition}

\noindent
Example \ref{example-global-regular} shows depth does not
behave well even if the ring is Noetherian, and Example
\ref{example-local-regular} shows that it does not
behave well if the ring is local but non Noetherian.
We will see later depth behaves well if the ring is local
Noetherian. The following two lemmas are an indication of this.

\begin{lemma}
\label{lemma-permute-xi}
Let $R$ be a local Noetherian ring.
Let $M$ be a finite $R$-module.
Let $x_1, \ldots, x_c$ be an $M$-regular sequence.
Then any permutation of the $x_i$ is a regular
sequence as well.
\end{lemma}

\begin{proof}
First we do the case $c = 2$.
Consider $K \subset M$ the kernel of $x_2 : M \to M$.
For any $z \in K$ we know that $z = x_1 z'$
for some $z' \in M$ because
$x_2$ is a nonzero divisor on $M/x_1M$.
Because $x_1$ is a nonzero divsor on $M$ we see that $x_2 z' = 0$
as well. Hence $x_1 : K \to K$ is surjective.
Thus $K = 0$ by Nakayama's Lemma \ref{lemma-NAK}.
Next, consider multiplication by $x_1$ on $M/x_2M$.
If $z \in M$ maps to an element $\overline{z} \in M/x_2M$
in the kernel of this map, then $x_1 z = x_2 y$ for some $y \in M$.
But then since $x_1, x_2$ is a regular sequence we see that
$y = x_1 y'$ for some $y' \in M$. Hence $x_1 ( z - x_2 y' ) =0$
and hence $z = x_2 y'$ and hence $\overline{z} = 0$ as desired.

\medskip\noindent
For the general case, observe that any permutation is
a composition of transpositions of adjacent indices.
Hence it suffices to prove that
$$
x_1, \ldots, x_{i-2}, x_i, x_{i-1}, x_{i + 1}, \ldots, x_c
$$
is an $M$-regular sequence. This follows from the case we
just did applied to the module $M/(x_1, \ldots, x_{i-2})$
and the length $2$ regular sequence $x_{i-1}, x_i$.
\end{proof}

\begin{lemma}
\label{lemma-bound-depth}
Let $R$ be a Noetherian local ring.
Let $M$ be a finite $R$-module.
Then $\dim(\text{Supp}(M)) \geq \text{depth}(M)$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-support-dimension-d} it suffices
to prove that if $f \in \mathfrak m$ is a nonzero
divisor on $M$, then $d(M/fM) \leq d(M) - 1$.
The existence of $f$ shows that $M$ does not have finite length.
Consider the exact sequence
$$
0 \to M \xrightarrow{f} M \to M/fM \to 0
$$
and apply Lemma \ref{lemma-hilbert-ses-chi}.
It shows that $d(M/fM) < d(M)$.
\end{proof}

\noindent
Here are a few more results on depth.

\begin{lemma}
\label{lemma-flat-increases-depth}
Let $R, S$ be local rings.
Let $R \to S$ be a local flat ring map.
Suppose that $x_1, \ldots, x_r$ form
a $M$-regular sequence in $R$.
Then the images of $x_1, \ldots, x_r$ in
$S$ form a $M\otimes_RS$-regular sequence.
\end{lemma}

\begin{proof}
This is so because $R \to S$ is faithfully flat
by Lemma \ref{lemma-local-flat-ff}.
\end{proof}

\begin{lemma}
\label{lemma-regular-quasi-regular}
Let $R$ be a ring.
\begin{enumerate}
\item Suppose that $J = (f_1, \ldots, f_c)$ is an ideal generated
by a regular sequence $f_1, \ldots, f_c$ of $R$. Then the graded
ring $\bigoplus J^n/J^{n + 1}$ is graded isomorphic to
$(R/J)[X_1, \ldots, X_c]$.
\item Suppose that $M$ is an $R$-module and that $J = (f_1, \ldots, f_c)$
is an ideal generated by the $M$-regular sequence
$f_1, \ldots, f_c$. In this case the graded
$\bigoplus J^n/J^{n + 1}$-module $\bigoplus J^nM/J^{n + 1}M$
is graded isomorphic to the module $(M/JM)[X_1, \ldots, X_c]$.
\end{enumerate}
The second statement is elucidated in the proof below.
\end{lemma}

\begin{proof}
We prove the first assertion by induction on $c$.
We have to show that given any relation
$\sum_{|I| = n} a_I f^I \in J^{n + 1}$ with $a_I \in R$ we
actually have $a_I \in J$ for all multi-indices $I$. Since
any element of $J^{n + 1}$ is of the form $\sum_{|I| = n} b_I f^I$
with $b_I \in J$ we may assume, after replacing $a_I$ by $a_I - b_I$,
the relation reads $\sum_{|I| = n} a_I f^I = 0$. We can rewrite
this as
$$
\sum\nolimits_{e = 0}^n
\left(
\sum\nolimits_{|I'| = n - e}
a_{I', e} f^{I'}
\right)
f_c^e
=
0
$$
Here and below the ``primed'' multi-indices $I'$ are required to be of the form
$I' = (i_1, \ldots, i_{d-1}, 0)$. We will show by descending
induction on $l \in \{0, \ldots, n\}$
that if we have a relation
$$
\sum\nolimits_{e = 0}^l
\left(
\sum\nolimits_{|I'| = n - e}
a_{I', e} f^{I'}
\right)
f_c^e
=
0
$$
then $a_{I', e} \in J$ for all $I', e$.
Namely, set $J' = (f_1, \ldots, f_{c-1})$.
We observe that $\sum\nolimits_{|I'| = n - l} a_{I', l} f^{I'}$
is mapped into $J'$ by $f_c^{l}$ and hence
(because $f_c$ is not a zero divisor on $R/J'$) it is in $J'$.
By induction hypotheses (for the induction on $c$),
we see that $a_{I', l} \in J'$.
This allows us to rewrite the term
$(\sum\nolimits_{|I'| = n - l} a_{I', l} f^{I'})f_c^l$
in the form $(\sum\nolimits_{|I'| = n - l + 1} f_c b_{I', l - 1}
f^{I'})f_c^{l-1}$. This gives a new relation of the form
$$
\sum\nolimits_{|I'| = n - l + 1}
(a_{I', l-1} + f_c b_{I', l - 1}) f^{I'})f_c^{l-1}
+
\sum\nolimits_{e = 0}^{l - 2}
\left(
\sum\nolimits_{|I'| = n - e}
a_{I', e} f^{I'}
\right)
f_c^e
=
0
$$
Now by the induction hypothesis (on $l$ this time) we see that
all $a_{I', l-1} + f_c b_{I', l - 1} \in J$ and
all $a_{I', e} \in J$ for $e \leq l - 2$. This, combined with
$a_{I', l} \in J' \subset J$ seen above, finishes the proof of the
induction step.

\medskip\noindent
The second assertion means that given any formal expression
$F = \sum_{|I| = n} m_I X^I$, $m_I \in M$ with $\sum m_I f^I
\in J^{n + 1}M$, then all the coefficients $m_I$ are in $J$.
This is proved in exactly the same way as we prove the corresponding
result for the first assertion above.
\end{proof}











\section{Ext groups and depth}
\label{section-ext}

\noindent
In this section we do a tiny bit of homological algebra,
in order to establish some fundamental properties of
depth over Noetherian local rings.

\begin{lemma}
\label{lemma-resolution-by-finite-free}
Let $R$ be a ring. Let $M$ be an $R$-module.
\begin{enumerate}
\item The exists an exact complex
$$
\ldots \to F_2 \to F_1 \to F_0 \to M \to 0.
$$
with $F_i$ free $R$-modules.
\item If $R$ is Noetherian and $M$ finite $R$, then we
choose the complex such that each $F_i$ is finite free.
In other words, we may find an exact complex
$$
\ldots \to R^{n_2} \to R^{n_1} \to R^{n_0} \to M \to 0.
$$
\end{enumerate}
\end{lemma}

\begin{proof}
Let us explain only the Noetherian case.
As a first step choose a surjection $R^{n_0} \to M$.
Then having constructed an exact complex of length
$e$ we simply choose a surjection $R^{n_{e + 1}} \to
\text{Ker}(R^{n_e} \to R^{n_{e-1}})$ which is possible
because $R$ is Noetherian.
\end{proof}

\begin{definition}
\label{definition-finite-free-resolution}
We call a complex as in (1) of
Lemma \ref{lemma-resolution-by-finite-free}
a {\it resolution of $M$ by free $R$-modules}.
Similarly we call a complex as in (2) of
Lemma \ref{lemma-resolution-by-finite-free}
a {\it resolution of $M$ by finite free $R$-modules}.
\end{definition}

\noindent
We often use the notation $F_{\bullet}$ to denote a complex
of $R$-modules
$$
\ldots \to F_i \to F_{i-1} \to \ldots
$$
In this case we often use $d_i$ or $d_{F, i}$ to denote the map
$F_i \to F_{i-1}$. In this section we are always going to
assume that $F_0$ is the last nonzero term in the complex.
The {\it $i$th homology group of the complex} $F_{\bullet}$
is the group $H_i = \text{Ker}(d_{F, i})/\text{Im}(d_{F, i + 1})$.
A {\it map of complexes $\alpha : F_{\bullet} \to G_{\bullet}$}
is given by maps $\alpha_i : F_i \to G_i$ such that
$\alpha_{i-1} \circ d_{F, i} = d_{G, i-1} \circ \alpha_i$.
Such a map induces a map on homology $H_i(\alpha) :
H_i(F_{\bullet}) \to H_i(G_{\bullet})$. If $\alpha, \beta
:  F_{\bullet} \to G_{\bullet}$ are maps of complexes, then
a {\it homotopy} between $\alpha$ and $\beta$ is given by
a collection of maps $h_i : F_i \to G_{i + 1}$ such that
$\alpha_i - \beta_i = d_{G, i + 1} \circ h_i +
h_{i-1} \circ d_{F, i}$.

\medskip\noindent
We will use a very similar notation regarding complexes
of the form $F^{\bullet}$ which look like
$$
\ldots \to F^i \xrightarrow{d^i} F^{i + 1} \to \ldots
$$
There are maps of complexes, homotopies, etc.
In this case we set $H^i(F^{\bullet}) =
\text{Ker}(d^i)/\text{Im}(d^{i - 1})$ and we call it
the {\it $i$th cohomology group}.

\begin{lemma}
\label{lemma-homotopic-equal-homology}
Any two homotopic maps of complexes induce the same maps on
(co)homology groups.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-compare-resolutions}
Suppose given an exact complex $M_{\bullet}$, a complex
$F_{\bullet}$ of free $R$-modules and a map
of $R$-modules $\text{Coker}(F_1 \to F_0) \to \text{Coker}(M_1 \to M_0)$.
Then
\begin{enumerate}
\item there exists a map of complexes $F_{\bullet}
\to M_{\bullet}$ inducing the given map on cokernels.
\item any two maps $\alpha, \beta : F_{\bullet}
\to M_{\bullet}$ inducing the same map
$\text{Coker}(F_1 \to F_0) \to \text{Coker}(M_1 \to M_0)$
are homotopic.
\end{enumerate}
\end{lemma}

\begin{proof}
Because $F_0$ is free we can find a map $F_0 \to M_0$
lifting the map $F_0 \to \text{Coker}(F_1 \to F_0)
\to \text{Coker}(M_1 \to M_0)$. We obtain an induced
map $F_1 \to F_0 \to M_0$ wich ends up in the image
of $M_1 \to M_0$. Since $F_1$ is free we may lift this
to a map $F_1 \to M_1$. This in turn induces a map
$F_2 \to F_1 \to M_1$ which maps to zero into
$M_0$. Since $M_{\bullet}$ is exact we see that
the image of this map is contained in the image
of $M_2 \to M_1$. Hence we may lift to get a map
$F_2 \to M_2$. Repeat.

\medskip\noindent
To show that $\alpha, \beta$ are homotopic it suffices
to show the difference $\gamma = \alpha - \beta$ is homotopic
to zero. Note that the image of $\gamma_0 : F_0 \to M_0$
is contained in the image of $M_1 \to M_0$. Hence we may lift
$\gamma_0$ to a map $h_0 : F_0 \to M_1$. Consider the map
$\gamma_1' = \gamma_1 - h_0 \circ d_{F, 1}$. By our choice of $h_0$
we see that the image of $\gamma_1'$ is contained in
the kernel of $M_1 \to M_0$. Since $M_{\bullet}$ is exact
we may lift $\gamma_1'$ to a map $h_1 : F_1 \to M_2$.
At this point we have $\gamma_1 = h_0 \circ d_{F, 1}
+ d_{M, 2} \circ h_1$. Repeat.
\end{proof}

\noindent
At this point we are ready to define the groups
$\text{Ext}^i_R(M, N)$. Namely, choose a resolution
$F_{\bullet}$ of $M$ by free $R$-modules, see Lemma
\ref{lemma-resolution-by-finite-free}. Consider
the (cohomological) complex
$$
\text{Hom}_R(F_\bullet, N) :
\text{Hom}_R(F_0, N) \to
\text{Hom}_R(F_1, N) \to
\text{Hom}_R(F_2, N) \to \ldots
$$
We define $\text{Ext}^i_R(M, N)$ to be the $i$th
cohomology group of this complex.\footnote{At this point
it would perhaps be more appropriate to say ``an'' in stead
of ``the'' Ext-group.} The following lemma explains
in what sense this is well defined.

\begin{lemma}
\label{lemma-ext-welldefined}
Let $R$ be a ring. Let $M_1, M_2, N$ be $R$-modules.
Suppose that $F_{\bullet}$ is a free resolution of the module $M_1$,
and $G_{\bullet}$ is a free resolutions of the module $M_2$.
Let $\varphi : M_1 \to M_2$ be a module map.
Let $\alpha : F_{\bullet} \to G_{\bullet}$ be
a map of complexes inducing $\varphi$ on
$M_1 = \text{Coker}(d_{F, 1}) \to M_2 = \text{Coker}(d_{G, 1})$,
see Lemma \ref{lemma-compare-resolutions}.
Then the induced maps
$$
H^i(\alpha) :
H^i(\text{Hom}_R(F_{\bullet}, N))
\longrightarrow
H^i(\text{Hom}_R(G_{\bullet}, N))
$$
are independent of the choice of $\alpha$.
If $\varphi$ is an isomorphism, so are all the maps
$H^i(\alpha)$. If $M_1 = M_2$, $F_\bullet = G_\bullet$, and
$\varphi$ is the identity, so are all the maps $H_i(\alpha)$.
\end{lemma}

\begin{proof}
Another map $\beta : F_{\bullet} \to G_{\bullet}$
inducing $\varphi$ is homotopic to $\alpha$ by
Lemma \ref{lemma-compare-resolutions}. Hence the
maps $\text{Hom}_R(F_\bullet, N) \to
\text{Hom}_R(G_\bullet, N)$ are homotopic.
Hence the independence result follows from
Lemma \ref{lemma-homotopic-equal-homology}.

\medskip\noindent
Suppose that $\varphi$ is an isomorphism.
Let $\psi : M_2 \to M_1$ be an inverse.
Choose $\beta : G_{\bullet} \to F_{\bullet}$
be a map inducing $\psi :
M_2 = \text{Coker}(d_{G, 1}) \to M_1 = \text{Coker}(d_{F, 1})$,
see Lemma \ref{lemma-compare-resolutions}.
Ok, and now consider the map
$H^i(\alpha) \circ H^i(\beta) =
H^i(\alpha \circ \beta)$. By the above the
map $H^i(\alpha \circ \beta)$ is the {\it same}
as the map $H^i(\text{id}_{G_{\bullet}}) = \text{id}$.
Similarly for the composition $H^i(\beta) \circ H^i(\alpha)$.
Hence $H^i(\alpha)$ and $H^i(\beta)$ are inverses of each other.
\end{proof}

\begin{lemma}
\label{lemma-long-exact-seq-ext}
Let $R$ be a ring. Let $M$ be an $R$-module.
Let $0 \to N' \to N \to N'' \to 0$ be a
short exact sequence. Then we get a long exact
sequence
$$
\begin{matrix}
0
\to \text{Hom}_R(M, N')
\to \text{Hom}_R(M, N)
\to \text{Hom}_R(M, N'')
\\
\phantom{0\ }
\to \text{Ext}^1_R(M, N')
\to \text{Ext}^1_R(M, N)
\to \text{Ext}^1_R(M, N'')
\to \ldots
\end{matrix}
$$
\end{lemma}

\begin{proof}
Pick a free resolution $F_{\bullet} \to M$.
Since each of the $F_i$ are free we see that
we get a short exact sequence of complexes
$$
0 \to
\text{Hom}_R(F_{\bullet}, N') \to
\text{Hom}_R(F_{\bullet}, N) \to
\text{Hom}_R(F_{\bullet}, N'') \to
0
$$
Thus we get the long exact sequence from
the snake lemma applied to this.
\end{proof}

\begin{lemma}
\label{lemma-annihilate-ext}
Let $R$ be a ring. Let $M$, $N$ be $R$-modules.
Any $x\in R$ such that either $xN = 0$, or $xM = 0$
annihilates each of the modules $\text{Ext}^i_R(M, N)$.
\end{lemma}

\begin{proof}
Pick a free resolution $F_{\bullet}$ of $M$.
Since $\text{Ext}^i_R(M, N)$
is defined as the cohomology of the complex
$\text{Hom}_R(F_{\bullet}, N)$ the lemma is
clear when $xN = 0$. If $xM = 0$, then
we see that multiplication by $x$ on $F_{\bullet}$
lifts the zero map on $M$. Hence by Lemma
\ref{lemma-ext-welldefined} we see that it
induces the same map on EXt groups as the
zero map.
\end{proof}

\begin{lemma}
\label{lemma-depth-ext}
Let $R$ be a Noetherian local ring with maximal ideal $\mathfrak m$.
Let $M$ be a finite $R$-module. Then $\text{depth}_R(M)$
is equal to the smallest integer $i$ such that
$\text{Ext}^i_R(R/\mathfrak m, M)$ is nonzero.
\end{lemma}

\begin{proof}
Let $\delta(M)$ denote the depth of $M$ and let $i = i(M)$ denote
the smallest integer such that $\text{Ext}^i_R(R/\mathfrak m, M)$
is nonzero. We will see in a moment that $i(M) < \infty$.
By Lemma \ref{lemma-ideal-nonzerodivisor} we have
$\delta(M) = 0$ if and only if $i(M) = 0$, because
$\mathfrak m \in \text{Ass}(M)$ exactly means
that $i(M) = 0$. Hence if $\delta(M)$ or $i(M)$ is $> 0$, then we may
choose $x \in \mathfrak m$ such that (a) $x$ is a nonzero
divisor on $M$, and (b) $\text{depth}(M/xM) = \delta(M) - 1$.
Consider the long exact sequence
of Ext-groups associated to the short exact sequence
$0 \to M \to M \to M/xM \to 0$ by Lemma \ref{lemma-long-exact-seq-ext}:
$$
\begin{matrix}
0
\to \text{Hom}_R(\kappa, M)
\to \text{Hom}_R(\kappa, M)
\to \text{Hom}_R(\kappa, M/xM)
\\
\phantom{0\ }
\to \text{Ext}^1_R(\kappa, M)
\to \text{Ext}^1_R(\kappa, M)
\to \text{Ext}^1_R(\kappa, M/xM)
\to \ldots
\end{matrix}
$$
Since $x \in \mathfrak m$ all the maps $\text{Ext}^i_R(\kappa, M)
\to \text{Ext}^i_R(\kappa, M)$ are zero, see \ref{lemma-annihilate-ext}.
Thus it is clear that $i(M/xM) = i(M) - 1$. Induction, e.g., on
$\dim(\text{Support}(M))$, finishes the proof.
\end{proof}

\begin{lemma}
\label{lemma-depth-in-ses}
Let $R$ be a local Noetherian ring. Let $0 \to N' \to N \to N'' \to 0$
be a short exact sequence of finite $R$-modules.
\begin{enumerate}
\item
$\text{depth}(N'') \geq \min\{\text{depth}(N), \text{depth}(N') - 1\}$
\item
$\text{depth}(N') \geq \min\{\text{depth}(N), \text{depth}(N'') + 1\}$
\end{enumerate}
\end{lemma}

\begin{proof}
This is easy using the results above. Hint:
Use the characterization of depth using the Ext groups
$\text{Ext}^i(\kappa, N)$, see Lemma \ref{lemma-annihilate-ext},
and use the long exact cohomology sequence
$$
\begin{matrix}
0
\to \text{Hom}_R(\kappa, N')
\to \text{Hom}_R(\kappa, N)
\to \text{Hom}_R(\kappa, N'')
\\
\phantom{0\ }
\to \text{Ext}^1_R(\kappa, N')
\to \text{Ext}^1_R(\kappa, N)
\to \text{Ext}^1_R(\kappa, N'')
\to \ldots
\end{matrix}
$$
from Lemma \ref{lemma-long-exact-seq-ext}.
\end{proof}









\section{An application of Ext groups}
\label{section-ext-application}

\noindent
This section should briefly discuss the relationship between
$\text{Ext}^1_R(Q, N)$ and extensions (see
Homology, Section \ref{homology-section-extensions}).
Omitted.

\begin{lemma}
\label{lemma-split-injection-after-completion}
Let $R$ be a Noetherian local ring with maximal ideal $\mathfrak m$.
Let $N \to M$ be a homomorphism of finite $R$-modules.
Suppose that there exists arbitrarily large $n$ such that
$N/\mathfrak m^nN \to M/\mathfrak m^nM$ is a split injection.
Then $N \to M$ is a split injection.
\end{lemma}

\begin{proof}
Assume $\varphi : N \to M$ satisfies the assumptions of the lemma.
Note that this implies that $\text{Ker}(\varphi) \subset \mathfrak m^nN$
for arbitrarily large $n$. Hence by
Lemma \ref{lemma-intersect-powers-ideal-module-zero} we see that $\varphi$
is injection. Let $Q = M/N$ so that we have a short exact sequence
$$
0 \to N \to M \to Q \to 0.
$$
Let
$$
F_2 \xrightarrow{d_2} F_1 \xrightarrow{d_1} F_0 \to Q \to 0
$$
be a finite free resolution of $Q$. We can choose a map
$\alpha : F_0 \to M$ lifting the map $F_0 \to Q$. This induces a map
$\beta : F_1 \to N$ such that $\beta \circ d_2 = 0$. The extension
above is split if and only if there exists a map $\gamma : F_0 \to N$
such that $\beta = \gamma \circ d_1$. In other words, the class of
$\beta$ in $\text{Ext}^1_R(Q, N)$ is the obstruction to splitting
the short exact sequence above.

\medskip\noindent
Suppose $n$ is a large integer such that
$N/\mathfrak m^nN \to M/\mathfrak m^nM$ is a split injection.
This implies
$$
0 \to N/\mathfrak m^nN \to M/\mathfrak m^nM \to Q/\mathfrak m^nQ \to 0.
$$
is still short exact. Also, the sequence
$$
F_1/\mathfrak m^nF_1 \xrightarrow{d_1} F_0/\mathfrak m^nF_0
\to Q/\mathfrak m^nQ \to 0
$$
is still exact. Arguing as above we see that the map
$\overline{\beta} : F_1/\mathfrak m^nF_1 \to N/\mathfrak m^nN$
induced by $\beta$ is equal to $\gamma_n \circ d_1$ for some
map $\overline{\gamma_n} : F_0/\mathfrak m^nF_0 \to N/\mathfrak m^n$.
Since $F_0$ is free we can lift $\overline{\gamma_n}$ to a map
$\gamma_n : F_0 \to N$ and then we see that
$\beta - \gamma_n \circ d_1$ is a map from $F_1$ into $\mathfrak m^nN$.
In other words we conclude that
$$
\beta \in
\text{Im}\Big(\text{Hom}_R(F_0, N) \to \text{Hom}_R(F_1, N)\Big) +
\mathfrak m^n\text{Hom}_R(F_1, N).
$$
for this $n$.

\medskip\noindent
Since we have this property for arbitrarily large $n$ by assumption we
conclude (by Lemma \ref{lemma-Artin-Rees}) that $\beta$ is actually in
the image of the map $\text{Hom}_R(F_0, N) \to \text{Hom}_R(F_1, N)$ as
desired.
\end{proof}











\section{Tor groups and flatness}
\label{section-tor}

\noindent
In this section we use some of the homological algebra
developed in the previous section to explain what
Tor groups are. Namely, suppose that $R$ is a ring
and that $M$, $N$ are two $R$-modules. Choose
a resolution $F_\bullet$ of $M$ by free $R$-modules.
See Lemma \ref{lemma-resolution-by-finite-free}.
Consider the homological complex
$$
F_\bullet \otimes_R N
:
\ldots
\to F_2 \otimes_R N
\to F_1 \otimes_R N
\to F_0 \otimes_R N
$$
We define $\text{Tor}^R_i(M, N)$ to be the $i$th homology
group of this complex. The following lemma explains in
what sense this is well defined.

\begin{lemma}
\label{lemma-tor-welldefined}
Let $R$ be a ring. Let $M_1, M_2, N$ be $R$-modules.
Suppose that $F_\bullet$ is a free resolution of
the module $M_1$ and that $G_\bullet$ is a free
resolution of the module $M_2$. Let $\varphi : M_1 \to M_2$
be a module map. Let $\alpha : F_\bullet \to G_\bullet$
be a map of complexes inducing $\varphi$ on
$M_1 = \text{Coker}(d_{F, 1}) \to M_2 = \text{Coker}(d_{G, 1})$,
see Lemma \ref{lemma-compare-resolutions}.
Then the induced maps
$$
H_i(\alpha) :
H_i(F_\bullet \otimes_R N)
\longrightarrow
H_i(G_\bullet \otimes_R N)
$$
are independent of the choice of $\alpha$. If $\varphi$
is an isomorphism, so are all the maps $H_i(\alpha)$.
If $M_1 = M_2$, $F_\bullet = G_\bullet$, and
$\varphi$ is the identity, so are all the maps $H_i(\alpha)$.
\end{lemma}

\begin{proof}
The proof of this lemma is identical to the proof of Lemma
\ref{lemma-ext-welldefined}.
\end{proof}

\noindent
Not only does this lemma imply that the Tor modules are well defined,
but it also provides for the functoriality of the constructions
$(M, N) \mapsto \text{Tor}_i^R(M, N)$ in the first variable. Of course
the functoriality in the second variable is evident. We leave it to
the reader to see that each of the $\text{Tor}_i^R$ is in fact
a functor
$$
\text{Mod}_R \times \text{Mod}_R \to \text{Mod}_R.
$$
Here $\text{Mod}_R$ denotes the category of $R$-modules, and
for the definition of the product category
see Categories, Definition \ref{categories-definition-product-category}.
Namely, given morphisms of $R$-modules $M_1 \to M_2$
and $N_1 \to N_2$ we get a commutative diagram
$$
\xymatrix{
\text{Tor}_i^R(M_1, N_1) \ar[r] \ar[d] &
\text{Tor}_i^R(M_1, N_2) \ar[d] \\
\text{Tor}_i^R(M_2, N_1) \ar[r] &
\text{Tor}_i^R(M_2, N_2) \\
}
$$

\begin{lemma}
\label{lemma-long-exact-sequence-tor}
Let $R$ be a ring and let $M$ be an $R$-module.
Suppose that $0 \to N' \to N \to N'' \to 0$ is a short
exact sequence of $R$-modules. There exists a long
exact sequence
$$
\begin{matrix}
M \otimes_R N'
\to M\otimes_R N
\to M\otimes_R N''
\to 0
\\
\text{Tor}_1^R(M, N')
\to \text{Tor}_1^R(M, N)
\to \text{Tor}_1^R(M, N'')
\to
\end{matrix}
$$
\end{lemma}

\begin{proof}
The proof of this is the same as the proof of
Lemma \ref{lemma-long-exact-seq-ext}.
\end{proof}

\noindent
Consider a homological double complex of $R$-modules
$$
\xymatrix{
\ldots \ar[r]^d &
A_{2, 0} \ar[r]^d &
A_{1, 0} \ar[r]^d &
A_{0, 0} \\
\ldots \ar[r]^d &
A_{2, 1} \ar[r]^d \ar[u]^\delta &
A_{1, 1} \ar[r]^d \ar[u]^\delta &
A_{0, 1} \ar[u]^\delta \\
\ldots \ar[r]^d &
A_{2, 2} \ar[r]^d \ar[u]^\delta &
A_{1, 2} \ar[r]^d \ar[u]^\delta &
A_{0, 2} \ar[u]^\delta \\
&
\ldots \ar[u]^\delta &
\ldots \ar[u]^\delta &
\ldots \ar[u]^\delta \\
}
$$
This means that $d_{i, j} : A_{i, j} \to A_{i-1, j}$
and $\delta_{i, j} : A_{i, j} \to A_{i, j-1}$ have the following
properties
\begin{enumerate}
\item Any composition of two $d_{i, j}$ is zero. In other words
the rows of the double complex are complexes.
\item Any composition of two $\delta_{i, j}$ is zero. In other words
the columns of the double complex are complexes.
\item For any pair $(i, j)$ we have $\delta_{i-1, j} \circ d_{i, j}
= d_{i, j-1} \circ \delta_{i, j}$. In other words, all the squares
commute.
\end{enumerate}
The correct thing to do is to associate a spectral sequence to
any such double complex. However, for the moment we can get away with
doing something slightly easier.

\medskip\noindent
Namely, for the purposes of this section only, given a double
complex $(A_{\bullet, \bullet}, d, \delta)$ set
$R(A)_j = \text{Coker}(A_{1, j} \to A_{0, j})$ and
$U(A)_i = \text{Coker}(A_{i, 1} \to A_{i, 0})$. (The letters
$R$ and $U$ are meant to suggest Right and Up.)
We endow $R(A)_\bullet$ with the structure of a complex
using the maps $\delta$. Similarly we endow $U(A)_\bullet$
with the structure of a complex using the maps $d$.
In other words we obtain the following huge commutative diagram
$$
\xymatrix{
\ldots \ar[r]^d &
U(A)_2 \ar[r]^d &
U(A)_1 \ar[r]^d &
U(A)_0 &
\\
\ldots \ar[r]^d &
A_{2, 0} \ar[r]^d \ar[u] &
A_{1, 0} \ar[r]^d \ar[u] &
A_{0, 0} \ar[r] \ar[u] &
R(A)_0 \\
\ldots \ar[r]^d &
A_{2, 1} \ar[r]^d \ar[u]^\delta &
A_{1, 1} \ar[r]^d \ar[u]^\delta &
A_{0, 1} \ar[r] \ar[u]^\delta &
R(A)_1 \ar[u]^\delta \\
\ldots \ar[r]^d &
A_{2, 2} \ar[r]^d \ar[u]^\delta &
A_{1, 2} \ar[r]^d \ar[u]^\delta &
A_{0, 2} \ar[r] \ar[u]^\delta &
R(A)_2 \ar[u]^\delta \\
&
\ldots \ar[u]^\delta &
\ldots \ar[u]^\delta &
\ldots \ar[u]^\delta &
\ldots \ar[u]^\delta \\
}
$$
(This is no longer a double complex of course.)
It is clear what a morphism $\Phi : (A_{\bullet, \bullet}, d, \delta)
\to (B_{\bullet, \bullet}, d, \delta)$ of double complexes
is, and it is clear that this induces morphisms of complexes
$R(\Phi) : R(A)_\bullet \to R(B)_\bullet$ and
$U(\Phi) : U(A)_\bullet \to U(B)_\bullet$.

\begin{lemma}
\label{lemma-no-spectral-sequence}
Let $(A_{\bullet, \bullet}, d, \delta)$ be a double complex such
that
\begin{enumerate}
\item Each row $A_{\bullet, j}$ is a resolution of $R(A)_j$.
\item Each column $A_{i, \bullet}$ is a resolution of $U(A)_i$.
\end{enumerate}
Then there are canonical isomorphisms
$$
H_i(R(A)_\bullet)
\cong
H_i(U(A)_\bullet).
$$
The isomorphisms are functorial with respect to morphisms
of double complexes with the properties above.
\end{lemma}

\begin{proof}
We will show that $H_i(R(A)_\bullet))$
and $H_i(U(A)_\bullet)$ are canonically
isomorphic to a third group. Namely
$$
\mathbf{H}_i(A) :=
\frac{
\{
(a_{i, 0}, a_{i-1, 1}, \ldots, a_{0, i})
\mid
d(a_{i, 0}) = \delta(a_{i-1, 1}), \ldots,
d(a_{1, i-1}) = \delta(a_{0, i})
\}}
{
\{
d(a_{i + 1, 0}) - \delta(a_{i, 1}),
d(a_{i, 1}) - \delta(a_{i-1, 2}),
\ldots,
d(a_{1, i}) - \delta(a_{0, i + 1})
\}
}
$$
Here we use the notational convention that $a_{i, j}$ denotes
an element of $A_{i, j}$. In other words, an element of $\mathbf{H}_i$
is represented by a zig-zag, represented as follows for $i = 2$
$$
\xymatrix{
a_{2, 0} \ar@{|->}[r] & d(a_{2, 0}) = \delta(a_{1, 1}) & \\
& a_{1, 1} \ar@{|->}[u] \ar@{|->}[r] & d(a_{1, 1}) = \delta(a_{0, 2}) \\
& & a_{0, 2} \ar@{|->}[u] \\
}
$$
Naturally, we divide out by ``trivial'' zig-zags, namely the submodule
generated by elements of the form $(0, \ldots, 0, -\delta(a_{t + 1, t-i}),
d(a_{t + 1, t-i}), 0, \ldots, 0)$. Note that there are canonical
homomorphisms
$$
\mathbf{H}_i(A) \to H_i(R(A)_\bullet), \ \ 
(a_{i, 0}, a_{i-1, 1}, \ldots, a_{0, i}) \mapsto
\text{class of image of }a_{0, i}
$$
and
$$
\mathbf{H}_i(A) \to H_i(U(A)_\bullet), \ \ 
(a_{i, 0}, a_{i-1, 1}, \ldots, a_{0, i}) \mapsto
\text{class of image of }a_{i, 0}
$$

\medskip\noindent
First we show that these maps are surjective.
Suppose that $\overline{r} \in H_i(R(A)_\bullet)$.
Let $r \in R(A)_i$ be a cocycle representing the
class of $\overline{r}$.
Let $a_{0, i} \in A_{0, i}$ be an element which
maps to $r$. Because $\delta(r) = 0$,
we see that $\delta(a_{0, i})$ is in the
image of $d$. Hence there exists an element
$a_{1, i-1} \in A_{1, i-1}$ such that
$d(a_{1, i-1}) = \delta(a_{0, i})$. This in turn
implies that $\delta(a_{1, i-1})$ is in the kernel
of $d$ (because $d(\delta(a_{1, i-1})) = \delta(d(a_{1, i-1}))
= \delta(\delta(a_{0, i})) = 0$. By exactness of the
rows we find an element $a_{2, i-2}$ such that
$d(a_{2, i-2}) = \delta(a_{1, i-1})$. And so on
until a full zig-zag is found. Of course surjectivity
of $\mathbf{H}_i \to H_i(U(A))$ is shown similarly.

\medskip\noindent
To prove injectivity we argue in exactly the same way.
Namely, suppose we are given a zig-zag
$(a_{i, 0}, a_{i-1, 1}, \ldots, a_{0, i})$
which maps to zero in $H_i(R(A)_\bullet)$.
This means that $a_{0, i}$ maps to an element
of $\text{Coker}(A_{i, 1} \to A_{i, 0})$
which is in the image of
$\delta : \text{Coker}(A_{i + 1, 1} \to A_{i + 1, 0}) \to
\text{Coker}(A_{i, 1} \to A_{i, 0})$.
In other words, $a_{0, i}$ is in the image of
$\delta \oplus d : A_{0, i + 1} \oplus A_{1, i} \to A_{0, i}$.
From the definition of trivial zig-zags we see that
we may modify our zig-zag by a trivial one and
assume that $a_{0, i} = 0$. This immediately
implies that $d(a_{1, i-1}) = 0$. As the rows
are exact this implies that $a_{1, i-1}$ is
in the image of $d : A_{2, i-1} \to A_{1, i-1}$.
Thus we may modify our zig-zag once again by a
trivial zig-zag and assume that our zig-zag looks
like $(a_{i, 0}, a_{i-1, 1}, \ldots, a_{2, i-2}, 0, 0)$.
Continuing like this we obtain the desired injectivity.

\medskip\noindent
If $\Phi : (A_{\bullet, \bullet}, d, \delta)
\to (B_{\bullet, \bullet}, d, \delta)$ is a morphism
of double complexes both of which satisfy the conditions
of the lemma, then we clearly obtain a commutative
diagram
$$
\xymatrix{
H_i(U(A)_\bullet) \ar[d] &
\mathbf{H}_i(A) \ar[r] \ar[l] \ar[d] &
H_i(R(A)_\bullet) \ar[d] \\
H_i(U(B)_\bullet) &
\mathbf{H}_i(B) \ar[r] \ar[l] &
H_i(R(B)_\bullet) \\
}
$$
This proves the functoriality.
\end{proof}

\begin{remark}
\label{remark-signs-double-complex}
The isomorphism constructed above is the ``correct'' one only up to signs.
A good part of homological algebra is concerned with choosing signs for
various maps and showing commutativity of diagrams with intervention
of suitable signs. For the moment we will simply use the isomorphism
as given in the proof above, and worry about signs later.
\end{remark}

\begin{lemma}
\label{lemma-tor-left-right}
Let $R$ be a ring. For any $i \geq 0$ the functors
$\text{Mod}_R \times \text{Mod}_R \to \text{Mod}_R$,
$(M, N) \mapsto \text{Tor}_i^R(M, N)$ and
$(M, N) \mapsto \text{Tor}_i^R(N, M)$ are
canonically isomorphic.
\end{lemma}

\begin{proof}
Let $F_\bullet$ be a free resolution of the module $M$ and
let $G_\bullet$ be a free resolution of the module $N$.
Consider the double complex $(A_{i, j}, d, \delta)$ defined
as follows:
\begin{enumerate}
\item set $A_{i, j} = F_i \otimes_R G_j$,
\item set $d_{i, j} : F_i \otimes_R G_j \to F_{i-1} \otimes G_j$
equal to $d_{F, i} \otimes \text{id}$, and
\item set $\delta_{i, j} : F_i \otimes_R G_j \to F_i \otimes G_{j-1}$
equal to $\text{id} \otimes d_{G, j}$.
\end{enumerate}
This double complex is usually simply denoted $F_\bullet \otimes_R G_\bullet$.

\medskip\noindent
Since each $G_j$ is free, and hence flat we see that each
row of the double complex is exact except in homological
degree $0$. Since each $F_i$ is free and hence flat we see that each
column of the double complex is exact except in homological
degree $0$. Hence the double complex satisfies the conditions
of Lemma \ref{lemma-no-spectral-sequence}.

\medskip\noindent
To see what the lemma says we compute $R(A)_\bullet$ and $U(A)_\bullet$.
Namely,
\begin{eqnarray*}
R(A)_i & = & \text{Coker}(A_{1, i} \to A_{0, i}) \\
& = & \text{Coker}(F_1 \otimes_R G_i \to F_0 \otimes_R G_i) \\
& = & \text{Coker}(F_1 \to F_0) \otimes_R G_i \\
& = & M \otimes_R G_i
\end{eqnarray*}
In fact these isomorphisms are compatible with the differentials
$\delta$ and we see that $R(A)_\bullet = M \otimes_R G_\bullet$
as homological complexes. In exactly the same way we see that
$U(A)_\bullet = F_\bullet \otimes_R N$. We get
\begin{eqnarray*}
\text{Tor}_i^R(M, N)
& = & H_i(F_\bullet \otimes_R N) \\
& = & H_i(U(A)_\bullet) \\
& = & H_i(R(A)_\bullet) \\
& = & H_i(M \otimes_R G_\bullet) \\
& = & H_i(G_\bullet\otimes_R M) \\
& = & \text{Tor}_i^R(N, M)
\end{eqnarray*}
Here the third equality is Lemma \ref{lemma-no-spectral-sequence}, and
the fifth equality uses the isomorphism $V\otimes W = W \otimes V$
of the tensor product.

\medskip\noindent
Functoriality. Suppose that we have $R$-modules $M_\nu$, $N_\nu$,
$\nu = 1, 2$. Let $\varphi : M_1 \to M_2$ and $\psi : N_1 \to N_2$
be morphisms of $R$-modules.
Suppose that we have free resolutions $F_{\nu, \bullet}$
for $M_\nu$ and free resolutions $G_{\nu, \bullet}$ for $N_\nu$.
By Lemma \ref{lemma-compare-resolutions} we may choose
maps of complexes $\alpha : F_{1, \bullet} \to F_{2, \bullet}$
and $\beta : G_{1, \bullet} \to G_{2, \bullet}$ compatible
with $\varphi$ and $\psi$. We claim that
the pair $(\alpha, \beta)$ induces a morphism of double
complexes
$$
\alpha \otimes \beta :
F_{1, \bullet} \otimes_R G_{1, \bullet}
\longrightarrow
F_{2, \bullet} \otimes_R G_{2, \bullet}
$$
This is really a very straightforward check using the rule
that $F_{1, i} \otimes_R G_{1, j} \to F_{2, i} \otimes_R G_{2, j}$
is given by $\alpha_i \otimes \beta_j$ where $\alpha_i$, resp.\ 
$\beta_j$ is the degree $i$, resp.\ $j$ component of $\alpha$,
resp.\ $\beta$. The reader also readily verifies that the
induced maps $R(F_{1, \bullet} \otimes_R G_{1, \bullet})_\bullet
\to R(F_{2, \bullet} \otimes_R G_{2, \bullet})_\bullet$
agrees with the map $M_1 \otimes_R G_{1, \bullet}
\to M_2 \otimes_R G_{2, \bullet}$ induced by $\varphi \otimes \beta$.
Similarly for the map induced on the $U(-)_\bullet$ complexes.
Thus the statement on functoriality follows from the statement
on functoriality in Lemma \ref{lemma-no-spectral-sequence}.
\end{proof}

\begin{remark}
\label{remark-curiosity-signs-swap}
An interesting case occurs when $M = N$ in the above.
In this case we get a canonical map $\text{Tor}_i^R(M, M)
\to \text{Tor}_i^R(M, M)$. Note that this map is not the
identity, because even when $i = 0$ this map is not the
identity! For example, if $V$ is a vector space of dimension
$n$ over a field, then the switch map $V \otimes_k V \to V\otimes_k V$
has $(n^2 + n)/2$ eigenvalues $+1$ and $(n^2-n)/2$ eigenvalues
$-1$. In characteristic $2$ it is not even diagonalizable.
Note that even changing the sign of the map will not get rid
of this.
\end{remark}

\begin{lemma}
\label{lemma-characterize-flat}
Let $R$ be a ring. Let $M$ be an $R$-module.
The following are equivalent:
\begin{enumerate}
\item The module $M$ is flat over $R$.
\item For all $i>0$ the functor $\text{Tor}_i^R(M, -)$ is zero.
\item The functor $\text{Tor}_1^R(M, -)$ is zero.
\item For all ideals $I \subset R$ we have $\text{Tor}_1^R(M, R/I) = 0$.
\item For all finitely generated ideals $I \subset R$ we have
$\text{Tor}_1^R(M, R/I) = 0$.
\end{enumerate}
\end{lemma}

\begin{proof}
Suppose $M$ is flat. Let $N$ be an $R$-module.
Let $F_\bullet$ be a free resolution of $N$.
Then $F_\bullet \otimes_R M$ is a resolution of $N\otimes_R M$,
by flatness of $M$. Hence all higher tor groups vanish.

\medskip\noindent
It now suffices to show that the last condition implies that
$M$ is flat. Let $I \subset R$ be an ideal.
Consider the short exact sequence
$0 \to I \to R \to R/I \to 0$. Apply
Lemma \ref{lemma-long-exact-sequence-tor}. We get an
exact sequence
$$
\text{Tor}_1^R(M, R/I) \to
M \otimes_R I \to
M \otimes_R R \to
M \otimes_R R/I \to
0
$$
Since obviously $M\otimes_R R = M$ we conclude that the
last hypothesis implies that $M \otimes_R I \to M$ is
injective for every finitely generated ideal $I$.
Thus $M$ is flat by Lemma \ref{lemma-flat}.
\end{proof}

\begin{remark}
\label{remark-Tor-ring-mod-ideal}
The proof of Lemma \ref{lemma-characterize-flat} actually shows
that
$$
\text{Tor}_1^R(M, R/I)
=
\text{Ker}(I \otimes_R M \to M).
$$
\end{remark}














\section{Functorialities for Tor}
\label{section-functoriality-tor}

\noindent
In this section we briefly discuss the functoriality
of $\text{Tor}$ with respect to change of ring, etc.
Here is a list of items to work out.
\begin{enumerate}
\item Given a ring map $R \to R'$, an $R$-module
$M$ and an $R'$-module $N'$
the $R$-modules $\text{Tor}_i^R(M, N')$ have
a natural $R'$-module structure.
\item Given a ring map $R \to R'$ and $R$-modules
$M$, $N$ there is a natural $R$-module map
$\text{Tor}_i^R(M, N) \to \text{Tor}_i^{R'}(M \otimes_R R', N\otimes_R R')$.
\item Given a ring map $R \to R'$ an $R$-module $M$ and
an $R'$-module $N'$ there exists a natural
$R'$-module map
$\text{Tor}_i^R(M, N') \to \text{Tor}_i^{R'}(M \otimes_R R', N')$.
\end{enumerate}

\begin{lemma}
\label{lemma-flat-base-change-tor}
Given a flat ring map $R \to R'$ and $R$-modules
$M$, $N$ the natural $R$-module map
$\text{Tor}_i^R(M, N)\otimes_R R'
\to \text{Tor}_i^{R'}(M \otimes_R R', N\otimes_R R')$
is an isomorphism for all $i$.
\end{lemma}

\begin{proof}
Omitted. This is true because a free resolution $F_\bullet$ of $M$ over
$R$ stays exact when tensoring with $R'$ over $R$ and hence
$(F_\bullet \otimes_R N)\otimes_R R'$ computes the tor groups
over $R'$.
\end{proof}






















\section{Finite projective modules}
\label{section-finite-projective-modules}

\begin{definition}
\label{definition-locally-free}
Let $R$ be a ring and $M$ an $R$-module.
We say that $M$ is {\it locally free} if
we can cover $\text{Spec}(R)$ by standard
opens $D(f_i)$, $i \in I$ such that $M_{f_i}$
is a free $R_{f_i}$-module for all $i \in I$.
We say that $M$ is {\it finite locally free} if
each $M_{f_i}$ is finite free.
\end{definition}

\noindent
Note that a finite locally free $R$-module is
automatically finitely presented by
Lemma \ref{lemma-cover}.

\begin{lemma}
\label{lemma-finite-projective}
Let $R$ be a ring and let $M$ be an $R$-module.
The following are equivalent
\begin{enumerate}
\item $M$ is finitely presented and $R$-flat,
\item $M$ is finite projective,
\item $M$ is a direct summand of a finite free $R$-module,
\item $M$ is finitely presented and
for all $\mathfrak p \in \text{Spec}(R)$ the
localization $M_{\mathfrak p}$ is free,
\item $M$ is finitely presented and
for all maximal ideals $\mathfrak m \subset R$ the
localization $M_{\mathfrak m}$ is free,
\item $M$ is finite and locally free, and
\item $M$ is finite locally free.
\end{enumerate}
\end{lemma}

\begin{proof}
First suppose $M$ is finite projective, i.e., (2) holds.
Take a surjection $R^n \to M$ and let $K$ be the kernel.
Since $M$ is projective,
$0 \to K \to R^n \to M \to 0$ splits.
Hence (2) $\Rightarrow$ (3).
The implication (3) $\Rightarrow$ (2) follows from the fact that
a direct summand of a projective object in any abelian category is
projective.

\medskip\noindent
Assume (3), so we can write $K \oplus M \cong R^{\oplus n}$.
So $K$ is a  direct summand of $R^n$ and thus finitely generated.
This shows $M = R^{\oplus n}/K$ is finitely presented.
In other words, (3) $\Rightarrow$ (1).

\medskip\noindent
Assume $M$ is finitely presented and flat, i.e., (1) holds.
We will prove that (7) holds. Pick any prime $\mathfrak p$ and
$x_1, \ldots, x_r \in M$ which map to a basis of
$M \otimes_R \kappa(\mathfrak p)$. By
Nakayama's Lemma \ref{lemma-NAK}
these elements generate $M_g$ for some $g \in R$, $g \not \in \mathfrak p$.
The corresponding surjection $\varphi : R_g^{\oplus r} \to M_g^{\oplus r}$
has the following two properties: (a) $\text{Ker}(\varphi)$ is a finite
$R_g$-module (see
Lemma \ref{lemma-finite-presentation-module-independent})
and (b) $\text{Ker}(\varphi) \otimes \kappa(\mathfrak p) = 0$
by flatness of $M_g$ over $R_g$ (see
Lemma \ref{lemma-flat-tor-zero}).
Hence by Nakayama's lemma again there exists a $g' \in R_g$ such that
$\text{Ker}(\varphi)_{g'} = 0$. In other words, $M_{gg'}$ is free.

\medskip\noindent
A finite locally free module is a finite module, see
Lemma \ref{lemma-cover},
hence (7) $\Rightarrow$ (6).
It is clear that (6) $\Rightarrow$ (7).

\medskip\noindent
A finite locally free module is a finitely presented module, see
Lemma \ref{lemma-cover},
hence (7) $\Rightarrow$ (4).
Of course (4) implies (5).
Since we may check flatness locally (see
Lemma \ref{lemma-flat-localization})
we conclude that (5) implies (1).
At this point we have
$$
\xymatrix{
(2) \ar@{<=>}[r] & (3) \ar@{=>}[r] & (1) \ar@{=>}[r] &
(7)  \ar@{<=>}[r] \ar@{=>}[d] & (6) \\
& & (5) \ar@{=>}[u] & (4) \ar@{=>}[l] &
}
$$
Thus it suffices to prove that (1), (4), (5), (6), and (7) imply (3).

\medskip\noindent
Suppose that $M$ satisfies (1), (4), (5), (6), and (7). It suffices
to show that $M$ is projective. We have to show that $\text{Hom}_R(M, -)$
is exact. Let $0 \to N'' \to N \to N'\to 0$ be a short exact sequence of
$R$-module. We have to show that
$0 \to \text{Hom}_R(M, N'') \to \text{Hom}_R(M, N) \to
\text{Hom}_R(M, N') \to 0$ is exact.
As $M$ is finite locally free there exist a covering
$\text{Spec}(R) = \bigcup D(f_i)$ such that $M_{f_i}$ is finite free.
By
Lemma \ref{lemma-hom-from-finitely-presented}
we see that
$$
0 \to \text{Hom}_R(M, N'')_{f_i} \to \text{Hom}_R(M, N)_{f_i} \to
\text{Hom}_R(M, N')_{f_i} \to 0
$$
is equal to
$0 \to \text{Hom}_{R_{f_i}}(M_{f_i}, N''_{f_i}) \to
\text{Hom}_{R_{f_i}}(M_{f_i}, N_{f_i}) \to
\text{Hom}_{R_{f_i}}(M_{f_i}, N'_{f_i}) \to 0$
which is exact as $M_{f_i}$ is free and as the localization
$0 \to N''_{f_i} \to N_{f_i} \to N'_{f_i} \to 0$
is exact (as localization is exact). Whence we see that
$0 \to \text{Hom}_R(M, N'') \to \text{Hom}_R(M, N) \to
\text{Hom}_R(M, N') \to 0$ is exact by
Lemma \ref{lemma-cover}.
\end{proof}

\begin{remark}
\label{remark-warning}
It is not true that a finite $R$-module which is
$R$-flat is automatically projective. A counter
example is where $R = \mathcal{C}^\infty(\mathbf{R})$
is the ring of infinitely differentiable functions on
$\mathbf{R}$, and $M = R_{\mathfrak m} = R/I$ where
$\mathfrak m = \{f \in R \mid f(0) = 0\}$ and
$I = \{f \in R \mid \exists \epsilon, \epsilon > 0 :
f(x) = 0\ \forall x, |x| < \epsilon\}$.
\end{remark}

\begin{lemma}
\label{lemma-finite-flat-local}
(Warning: see Remark \ref{remark-warning} above.)
Suppose $R$ is a local ring, and $M$ is a finite
flat $R$-module. Then $M$ is finite free.
\end{lemma}

\begin{proof}
Follows from the equational criterion of flatness, see
Lemma \ref{lemma-flat-eq}. Namely, suppose that
$x_1, \ldots, x_r \in M$ map to a basis of
$M/\mathfrak mM$. By Nakayama's Lemma \ref{lemma-NAK}
these elements generate $M$. We want to show there
is no relation among the $x_i$. Instead, we will show
by induction on $n$ that if $x_1, \ldots, x_n \in M$
are linearly independent in the vector space
$M/\mathfrak mM$ then they are independent over $R$.

\medskip\noindent
The base case of the induction is where we have
$x \in M$, $x \not\in \mathfrak mM$ and a relation
$fx = 0$. By the equational criterion there
exist $y_j \in M$ and $a_j \in R$ such that
$x = \sum a_j y_j$ and $fa_j = 0$ for all $j$.
Since $x \not\in \mathfrak mM$ we see that
at least one $a_j$ is a unit and hence $f = 0 $.

\medskip\noindent
Suppose that $\sum f_i x_i$ is a relation among $x_1, \ldots, x_n$.
By our choice of $x_i$ we have $f_i \in \mathfrak m$.
According to the equational criterion of flatness there exist
$a_{ij} \in R$ and $y_j \in M$ such that
$x_i = \sum a_{ij} y_j$ and $\sum f_i a_{ij} = 0$.
Since $x_n \not \in \mathfrak mM$ we see that
$a_{nj}\not\in \mathfrak m$ for at least one $j$.
Since $\sum f_i a_{ij} = 0$ we get
$f_n = \sum_{i = 1}^{n-1} (-a_{ij}/a_{nj}) f_i$.
The relation $\sum f_i x_i = 0$ now can be rewritten
as $\sum_{i = 1}^{n-1} f_i( x_i + (-a_{ij}/a_{nj}) x_n) = 0$.
Note that the elements $x_i + (-a_{ij}/a_{nj}) x_n$ map
to $n-1$ linearly independent elements of $M/\mathfrak mM$.
By induction assumption we get that all the $f_i$, $i \leq n-1$
have to be zero, and also $f_n = \sum_{i = 1}^{n-1} (-a_{ij}/a_{nj}) f_i$.
This proves the induction step.
\end{proof}

\begin{lemma}
\label{lemma-cokernel-flat}
Let $R$ be a ring. Let $\varphi : P_1 \to P_2$ be a map of
finite projective modules. Then
\begin{enumerate}
\item The set $U$ of primes
$\mathfrak p \in \text{Spec}(R)$ such that
$\varphi \otimes \kappa(\mathfrak p)$ is injective is open.
\item For any $f\in R$ such that
$D(f) \subset U$ the module $\text{Coker}(\varphi)_f$
is finite projective over $R_f$.
\item The set $V$ of primes $\mathfrak p \in \text{Spec}(R)$ such that
$\varphi \otimes \kappa(\mathfrak p)$ is an isomorphism
is open.
\item For any $f\in R$ such that
$D(f) \subset V$ the map $\varphi: P_{1, f} \to P_{2, f}$
is an isomorphism of modules over $R_f$.
\end{enumerate}
\end{lemma}

\begin{proof}
To prove the sets $U$ and $V$ are open we may work locally on
$\text{Spec}(R)$. Thus we may replace $R$ by a suitable localization
and assume that $P_1 = R^{n_1}$ and $P_2 = R^{n_2}$, see Lemma
\ref{lemma-finite-projective}. In this case injectivity of
$\varphi \otimes \kappa(\mathfrak p)$ is equivalent to
some $n_1 \times n_1$ minor $f$ of the matrix of $\varphi$ being
invertible in $\kappa(\mathfrak p)$. Thus $D(f) \subset U$.
Similarly for $V$, but in that case with the added assumption
that $m = n$ (and hence $f$ is just the determinant of the map).

\medskip\noindent
Now suppose $D(f) \subset U$. By Lemma \ref{lemma-finite-projective}
it suffices to prove that $\text{Coker}(\varphi)$ is finite projective
locally on $D(f)$. Thus, as we saw above, we may
assume that $P_1 = R^{n_1}$ and $P_2 = R^{n_2}$
and that some minor of the matrix of $\varphi$ is invertible in $R$.
If the minor in question corresponds to the first $n_1$
basis vectors of $R^{n_2}$, then using the last $n_2-n_1$ basis
vectors we get a map $R^{n_2 - n_1} \to
R^{n_2} \to \text{Coker}(\varphi)$ which is easily seen to be
an isomorphism. If $D(f) \subset V$ the argument is even easier.
\end{proof}

\begin{lemma}
\label{lemma-finite-projective-descends}
Let $R \to S$ be a flat local homomorphism of local rings.
Let $M$ be a finite $R$-module. Then $M$ is finite projective
over $R$ if and only if $M \otimes_R S$ is finite projective
over $S$.
\end{lemma}

\begin{proof}
Suppose that $M\otimes_R S$ is finite projective
over $S$. By Lemma \ref{lemma-finite-projective}
it is finite free. Pick $x_1, \ldots, x_r \in M$ whose
residue classes generate $M/\mathfrak m_RM$. Clearly
we see that $x_1 \otimes 1, \ldots, x_r \otimes 1$
are a basis for $M \otimes_R S$. This implies that
the map $R^{\oplus r} \to M, (a_i) \mapsto \sum a_i x_i$
becomes an isomorphism after tensoring with $S$.
By faithful flatness of $R \to S$, see Lemma \ref{lemma-local-flat-ff}
we see that it is an isomorphism.
\end{proof}

\begin{lemma}
\label{lemma-locally-free-semi-local-free}
Let $R$ be a semi-local ring.
Let $M$ be a finite locally free module.
If $M$ has constant rank, then $M$ is free. In particular, if $R$ has
connected spectrum, then $M$ is free.
\end{lemma}

\begin{proof}
Omitted. Hints: First show that $M/\mathfrak m_iM$ has the
same dimension $d$ for all maximal ideal $\mathfrak m_1, \ldots, \mathfrak m_n$
of $R$ using the the spectrum is connected.
Next, show that there exist elements $x_1, \ldots, x_d \in M$
which form a basis for each $M/\mathfrak m_iM$ by the Chinese
remainder theorem. Finally show that $x_1, \ldots, x_d$ is a basis for $M$.
\end{proof}

\noindent
Here is a technical lemma that is used in the chapter on groupoids.

\begin{lemma}
\label{lemma-semi-local-module-basis-in-submodule}
Let $R$ be a local ring with maximal ideal $\mathfrak m$ and
infinite residue field.
Let $R \to S$ be a ring map.
Let $M$ be an $S$-module and let $N \subset M$ be an $R$-submodule.
Assume
\begin{enumerate}
\item $S$ is semi-local and $\mathfrak mS$ is contained in the radical
of $S$,
\item $M$ is a finite free $S$-module, and
\item $N$ generates $M$ as an $S$-module.
\end{enumerate}
Then $N$ contains an $S$-basis of $M$.
\end{lemma}

\begin{proof}
Assume $M$ is free of rank $n$. Let $I = \text{rad}(S)$.
By Nakayama's Lemma \ref{lemma-NAK} a sequence of elements
$m_1, \ldots, m_n$ is a basis for $M$ if and only if
$\overline{m}_i \in M/IM$ generate $M/IM$. Hence we may replace
$M$ by $M/IM$, $N$ by $N/(N \cap IM)$, $R$ by $R/\mathfrak m$,
and $S$ by $S/IS$. In this case we see that $S$ is a finite product
of fields $S = k_1 \times \ldots \times k_r$ and
$M = k_1^{\oplus n} \times \ldots \times k_r^{\oplus n}$.
The fact that $N \subset M$ generates $M$ as an $S$-module
means that there exist $x_j \in N$ such that a linear combination
$\sum a_j x_j$ with $a_j \in S$ has a nonzero component in each
factor $k_i^{\oplus n}$.
Because $R = k$ is an infinite field, this means that also
some linear combination $y = \sum c_j x_j$ with $c_j \in k$ has a
nonzero component in each factor. Hence $y \in N$ generates a
free direct summand $Sy \subset M$. By induction on $n$ the result
holds for $M/Sy$ and the submodule $\overline{N} = N/(N \cap Sy)$.
In other words there exist $\overline{y}_2, \ldots, \overline{y}_n$
in $\overline{N}$ which (freely) generate $M/Sy$. Then
$y, y_2, \ldots, y_n$ (freely) generate $M$ and we win.
\end{proof}



\section{Faithfully flat descent for projectivity of modules}
\label{section-ffdescent-projectivity-introduction}

\medskip\noindent
In the next few sections we prove, following
Raynaud and Gruson \cite{GruRay}, that the
projectivity of modules descends along faithfully flat ring maps.  The idea of 
the proof is to use d\'evissage \`{a} la Kaplansky \cite{Kaplansky} to reduce
to the 
case of countably generated modules.  Given a well-behaved filtration of a 
module $M$, d\'evissage allows us to express $M$ as a direct sum of successive 
quotients of the filtering submodules (see
Section \ref{section-transfinite-devissage}).  
Using this technique, we prove that a projective module is a direct sum of 
countably generated modules (Theorem \ref{theorem-projective-direct-sum}).  To 
prove descent of projectivity for countably generated modules, we introduce a 
``Mittag-Leffler'' condition on modules, prove that a countably generated 
module is projective if and only if it is flat and Mittag-Leffler (Theorem 
\ref{theorem-projectivity-characterization}), and then show that the property 
of being a flat Mittag-Leffler module descends (Lemma 
\ref{lemma-ffdescent-flat-ML}).  Finally, given an arbitrary module $M$ whose 
base change by a faithfully flat ring map is projective, we filter $M$ by 
submodules whose successive quotients are countably generated projective 
modules, and then by d\'evissage conclude $M$ is a direct sum of projectives, 
hence projective itself (Theorem \ref{theorem-ffdescent-projectivity}).

\medskip\noindent
We note that there is an error in the  proof of faithfully flat descent
of projectivity in \cite{GruRay}.  There, descent 
of projectivity along faithfully flat ring maps is deduced from descent of 
projectivity along a more general type of ring map
(\cite[Example 3.1.4(1) of Part II]{GruRay}).
However, the proof of descent along this more general type of 
map is incorrect, as explained in \cite{G}. Patching this hole in the proof of 
faithfully flat descent of projectivity comes down to proving that the property 
of being a flat Mittag-Leffler module descends along faithfully flat ring maps. 
We do this in
Lemma \ref{lemma-ffdescent-flat-ML}.





\section{Characterizing flatness}
\label{section-characterize-flatness}

\noindent
In this section we discuss criteria for flatness. The main result in 
this section is Lazard's theorem (Theorem \ref{theorem-lazard} 
below), which says that a flat module is the colimit of a directed system of 
free finite modules.  
We remind the reader of the ``equational criterion for flatness'', see
Lemma \ref{lemma-flat-eq}.
It turns out that this can be massaged into a seemingly much stronger property.

\begin{lemma}
\label{lemma-flat-factors-free}
Let $M$ be an $R$-module.  The following are equivalent:
\begin{enumerate}
\item $M$ is flat.
\item If $f: R^n \to M$ is a module map and $x \in \ker(f)$, then there 
are module maps $h: R^n \to R^m$ and $g: R^m \to M$ such that 
$f = g \circ h$ and $x \in \ker(h)$.
\item Suppose $f: R^n \to M$ is a module map, $N \subset \ker(f)$ any 
submodule, and $h: R^n \to R^{m}$ a map such that $N \subset \ker(h)$ 
and $f$ factors through $h$.  Then given any $x \in \ker(f)$ we can find a map 
$h': R^n \to R^{m'}$ such that $N + Rx \subset \ker(h')$ and $f$ 
factors through $h'$. 
\item If $f: R^n \to M$ is a module map and $N \subset \ker(f)$ is a 
finitely generated submodule, then there are module maps $h: R^n \to 
R^m$ and $g: R^m \to M$ such that $f = g \circ h$ and $N \subset 
\ker(h)$.
\end{enumerate}
\end{lemma}

\begin{proof}
That (1) is equivalent to (2) is just a reformulation of the equational 
criterion for flatness.   To show (2) implies (3), let $g: R^m \to M$ 
be the map such that $f$ factors as $f = g \circ h$.  By (2) find $h'': R^m 
\to R^{m'}$ such that $h''$ kills $h(x)$ and $g: R^m \to M$ 
factors through $h''$.  Then taking $h' = h'' \circ h$ works.  (3) implies (4) 
by induction on the number of generators of $N \subset \ker(f)$ in (4).  
Clearly (4) implies (2).
\end{proof}

\begin{lemma}
\label{lemma-flat-factors-fp}
Let $M$ be an $R$-module.  Then $M$ is flat if and only if the following 
condition holds: if $P$ is a finitely presented $R$-module and $f: P 
\to M$ a module map, then there is a free finite $R$-module $F$ and 
module maps $h: P \to F$ and $g: F \to M$ such that $f = g 
\circ h$.
\end{lemma}

\begin{proof}
This is just a reformulation of condition (4) from the previous lemma.
\end{proof}

\begin{lemma}
\label{lemma-flat-surjective-hom}
Let $M$ be an $R$-module.  Then $M$ is flat if and only if the following 
condition holds: for every finitely presented $R$-module $P$, if $N \to 
M$ is a surjective $R$-module map, then the induced map $\text{Hom}_R(P,N) 
\to \text{Hom}_R(P,M)$ is surjective.
\end{lemma}

\begin{proof}
First suppose $M$ is flat.  We must show that if $P$ is finitely presented, 
then given a map $f: P \to M$, it factors through the map $N 
\to M$.  By the previous lemma $f$ factors through a map $F \to 
M$ where $F$ is free and finite.  Since $F$ is free, this map factors through 
$N \to M$.  Thus $f$ factors through $N \to M$.

\medskip\noindent
Conversely, suppose the condition of the lemma holds.  Let $f: P \to M$ 
be a map from a finitely presented module $P$.  Choose a free module $N$ with a 
surjection $N \to M$ onto $M$.  Then $f$ factors through $N \to 
M$, and since $P$ is finitely generated, $f$ factors through a free finite 
submodule of $N$.  Thus $M$ satisfies the condition of Lemma 
\ref{lemma-flat-factors-fp}, hence is flat.
\end{proof}

\begin{theorem}[Lazard's theorem]
\label{theorem-lazard}
Let $M$ be an $R$-module.  Then $M$ is flat if and only if it is the colimit of 
a directed system of free finite $R$-modules.
\end{theorem}

\begin{proof}
A colimit of a directed system of flat modules is flat, as taking directed 
colimits is exact and commutes with tensor product. Hence if $M$ is the colimit 
of a directed system of free finite modules then $M$ is flat.

\medskip\noindent
For the converse, first recall that any module $M$ can be written as the 
colimit of a directed system of finitely presented modules, in the following 
way.  Choose a surjection $f: R^I \to M$ for some set $I$, and let $K$ 
be the kernel.  Let $E$ be the set of ordered pairs $(J,N)$ where $J$ is a 
finite subset of $I$ and $N$ is a finitely generated submodule of $R^J \cap K$. 
 Then $E$ is made into a directed partially ordered set by defining $(J,N) \leq 
(J',N')$ if and only if $J \subset J'$ and $N \subset N'$.  Define $M_{e} = 
R^J/N$ for $e = (J,N)$, and define $f_{ee'}: M_{e} \to M_{e'}$ to be 
the natural map for $e \leq e'$.  Then $(M_e,f_{ee'})$ is a directed system and 
the natural maps $f_e: M_{e} \to M$ induce an isomorphism 
$\text{colim}_{e 
\in E} M_{e} \xrightarrow{\cong} M$.

\medskip\noindent
Now suppose $M$ is flat.  Let $I = M \times \mathbf{Z}$, write $(x_{i})$ for 
the canonical basis of $R^{I}$, and take in the above discussion $f: R^I 
\to M$ to be the map sending $x_i$ to the projection of $i$ onto $M$.  
To prove the theorem it suffices to show that the $e \in E$ such that $M_{e}$ 
is free form a cofinal subset of $E$.  So let $e = (J,N) \in E$ be arbitrary.  
By Lemma \ref{lemma-flat-factors-fp} there is a free finite module $F$ and maps 
$h: R^J/N \to F$ and $g: F \to M$ such that the natural map 
$f_{e}: R^J/N \to M$ factors as $R^J/N \xrightarrow{h} F 
\xrightarrow{g} M$.  We are going to realize $F$ as $M_{e'}$ for some $e' \geq 
e$.    

\medskip\noindent
Let $\{ b_1, \dots, b_n \}$ be a finite basis of $F$.  Choose $n$ distinct 
elements $i_1, \dots, i_n \in I$ such that $i_{\ell} \notin J$ for all $\ell$, 
and such that the image of $x_{i_{\ell}}$ under $f: R^I \to M$ equals 
the image of $b_{\ell}$ under $g: F \to M$.  This is possible by our 
choice of $I$.  Now let $J' = J \cup \{i_1, \dots , i_n \}$, and define $R^{J'} 
\to F$ by $x_i \mapsto h(x_i)$ for $i \in J$ and $x_{i_{\ell}} \mapsto 
b_{\ell}$ for $\ell = 1, \dots, n$.  Let $N' = \ker(R^{J'} \to F)$.  
Observe:
\begin{enumerate}
\item $R^{J'} \to F$ factors $f: R^I \to M$, hence $N' \subset 
K = \ker(f)$;
\item $R^{J'} \to F$ is a surjection onto a free finite module, hence 
it splits and so $N'$ is finitely generated;
\item $J \subset J'$ and $N \subset N'$.
\end{enumerate}
By (1) and (2) $e' = (J',N')$ is in $E$, by (3) $e' \geq e$, and by 
construction $M_{e'} = R^{J'}/N' \cong F$ is free.
\end{proof}

\section{Universally injective module maps}
\label{section-universally-injective}

\noindent
Next we discuss universally injective module maps, which 
are in a sense complementary to flat modules (see Lemma 
\ref{lemma-flat-universally-injective}).  We follow Lazard's thesis
\cite{Lazard};  also see \cite{Lam}.

\begin{definition}
\label{definition-universally-injective}
Let $f: M \to N$ be a map of $R$-modules.  Then $f$ is called 
{\it universally injective} if for every $R$-module $Q$, the map $f 
\otimes_{R} \textnormal{id}_{Q}: M \otimes_{R} Q \to N \otimes_{R} Q$ 
is injective.  A sequence $0 \to M_1 \to M_2 \to M_3 
\to 0$ of $R$-modules is called {\it universally exact} if it is exact 
and $M_1 \to M_2$ is universally injective.
\end{definition}

\begin{example}
\label{example-universally-exact}
Examples of universally exact maps.
\begin{enumerate} 
\item A split short exact sequence is universally exact since tensoring 
commutes with taking direct sums.
\item The colimit of a directed system of universally exact sequences is 
universally exact.  This follows from the fact that taking directed colimits is 
exact and that tensoring commutes with taking colimits.  In particular the 
colimit of a directed system of split exact sequences is universally exact.  We 
will see below that, conversely, any universally exact sequence arises in this 
way.
\end{enumerate}
\end{example}

\noindent
Next we give a list of criteria for a short exact sequence to be universally 
exact.  They are analogues of criteria for flatness given above.  Parts (3)-(6) 
below correspond, respectively, to the criteria for flatness given in Lemma 
\ref{lemma-flat-eq}, Lemma \ref{lemma-flat-factors-free}, Lemma 
\ref{lemma-flat-surjective-hom}, and Theorem \ref{theorem-lazard}.

\begin{theorem}
\label{theorem-universally-exact-criteria}
Let 
$$
0 \to M_1 \xrightarrow{f_1} M_2 \xrightarrow{f_2} M_3 \to 0 
$$
be an exact sequence of $R$-modules.  The following are equivalent: 
\begin{enumerate}
\item The sequence $0 \to M_1 \to M_2 \to M_3 
\to 0$ is universally exact.
\item For every finitely presented $R$-module $Q$, the sequence 
$$
0 \to M_1 \otimes_{R} Q \to M_2 \otimes_{R} Q \to 
M_3 \otimes_{R} Q \to 0
$$
is exact.
\item Given elements $x_i \in M_1$ $(i = 1, \dots, n)$, $y_j \in M_2$ $(j = 1, 
\dots, m)$, and $a_{ij} \in R$ $(i = 1, \dots, n, j = 1, \dots, m)$ such that 
for all $i$
$$
f_1(x_i) = \sum\nolimits_j a_{ij} y_j,
$$
there exists $z_j \in M_1$ $(j =1, \dots, m)$ such that for all $i$,
$$
x_i = \sum\nolimits_j a_{ij} z_j .
$$
\item Given a commutative diagram of $R$-module maps
$$
\xymatrix{
R^n \ar[r] \ar[d] &  R^m \ar[d] \\
M_1 \ar[r]^{f_1}        &  M_2 
}
$$
where $m$ and $n$ are integers, there exists a map $R^m \to M_1$ making 
the top triangle commute.
\item For every finitely presented $R$-module $P$, the $R$-module
map $\text{Hom}_R(P,M_2) \to \text{Hom}_R(P,M_3)$ is surjective.
\item The sequence $0 \to M_1 \to M_2 \to M_3 
\to 0$ is the colimit of a directed system of split exact sequences of 
the form
$$
0 \to M_{1} \to M_{2,i} \to M_{3,i} \to 0
$$
where the $M_{3,i}$ are finitely presented.
\end{enumerate}
\end{theorem}

\begin{proof}
Obviously (1) implies (2).

\medskip\noindent
Next we show (2) implies (3).  Let $f_1(x_i) = \sum_j a_{ij} y_j$ be relations 
as in (3).  Let $(f_j)$ be a basis for $R^m$, $(e_i)$ a basis for $R^n$, and 
$R^m \to R^n$ the map given by $f_{j} \mapsto \sum_{i} a_{ij} e_i$.  
Let $Q$ be the cokernel of $R^m \to R^n$.  Then tensoring $R^m 
\to R^n \to Q \to 0$ by the map $f_1: M_1 \to 
M_2$, we get a commutative diagram
$$
\xymatrix{
M_1^{\oplus m} \ar[r] \ar[d] & M_1^{\oplus n} \ar[r] \ar[d] & M_1 \otimes_R Q 
\ar[r] \ar[d] & 0 \\
M_2^{\oplus m} \ar[r] & M_2^{\oplus n} \ar[r] & M_2 \otimes_R Q \ar[r] & 0
}
$$
where $M_1^{\oplus m} \to M_1^{\oplus n}$ is given by 
$$
\textstyle (z_1, \dots, z_m) \mapsto
(\sum_{j} a_{1j} z_j, \dots, \sum_{j} a_{nj} z_j),
$$
and $M_2^{\oplus m} \to M_2^{\oplus n}$ is given similarly.  We want to 
show $x = (x_1, \dots, x_n) \in M_1^{\oplus n}$ is in the image of $M_1^{\oplus 
m} \to M_1^{\oplus n}$.  By (2) the map $M_1 \otimes Q \to M_2 
\otimes Q$ is injective, hence by exactness of the top row it is enough to show 
$x$ maps to $0$ in $M_2 \otimes Q$, and so by exactness of the bottom row it is 
enough to show the image of $x$ in $M_2^{\oplus n}$ is in the image of 
$M_2^{\oplus m} \to M_2^{\oplus n}$.  This is true by assumption.

\medskip\noindent
Condition (4) is just a translation of (3) into diagram form.

\medskip\noindent
Next we show (4) implies (5). Let $\varphi: P \to M_3$ be a map from a 
finitely presented $R$-module $P$.  We must show that $\varphi$ lifts to a map 
$P \to M_2$.  Choose a presentation of $P$, 
$$
R^n \xrightarrow{g_1} R^m \xrightarrow{g_2} P \to 0.
$$
Using freeness of $R^n$ and $R^m$, we can construct $h_2: R^m \to M_2$ 
and then $h_1: R^n \to M_1$ such that the following diagram commutes
$$
\xymatrix{
         & R^n \ar[r]^{g_1} \ar[d]^{h_1} & R^m \ar[r]^{g_2} \ar[d]^{h_2} & P 
\ar[r] \ar[d]^{\varphi} & 0 \\
0 \ar[r] & M_1 \ar[r]^{f_1} & M_2 \ar[r]^{f_2} & M_3 \ar[r] & 0 .
}
$$
By (4) there is a map $k_1: R^m \to M_1$ such that $k_1 \circ g_1 = 
h_1$.  Now define $h'_2: R^m \to M_2$ by $h_2' = h_2 - f_1 \circ k_1$.  
Then
$$
h'_2 \circ g_1 = h_2 \circ g_1 - f_1 \circ k_1 \circ g_1 =
h_2 \circ g_1 - f_1 \circ h_1 = 0 .
$$
Hence by passing to the quotient $h'_2$ defines a map $\varphi': P \to 
M_2$ such that $\varphi' \circ g_2 = h_2'$.  In a diagram, we have
$$
\xymatrix{
R^m \ar[r]^{g_2} \ar[d]_{h'_2} & P \ar[d]^{\varphi} \ar[dl]_{\varphi'} \\
M_2 \ar[r]^{f_2} & M_3.
}
$$
where the top triangle commutes.  We claim that $\varphi'$ is the desired lift, 
i.e.\ that $f_2 \circ \varphi' = \varphi$.  From the definitions we have
$$
f_2 \circ \varphi' \circ g_2 = f_2 \circ h'_2 =
f_2 \circ h_2 - f_2 \circ f_1 \circ k_1 = f_2 \circ h_2 =
\varphi \circ g_2.
$$
Since $g_2$ is surjective, this finishes the proof.

\medskip\noindent
Now we show (5) implies (6).  Write $M_{3}$ as the colimit of a directed system 
of finitely presented modules $M_{3,i}$.  Let $M_{2,i}$ be the fiber product of 
$M_{3,i}$ and $M_{2}$ over $M_{3}$---by definition this is the submodule of 
$M_2 \times M_{3,i}$ consisting of elements whose two projections onto $M_3$ 
are equal.  Let $M_{1,i}$ be the kernel of the projection $M_{2,i} \to 
M_{3,i}$.  Then we have a directed system of exact sequences
$$
0 \to M_{1,i} \to M_{2,i} \to M_{3,i} \to 0, 
$$
and for each $i$ a map of exact sequences
$$
\xymatrix{
0  \ar[r] & M_{1,i} \ar[d] \ar[r]  &  M_{2,i}  \ar[r] \ar[d] & M_{3,i} \ar[d] 
\ar[r] & 0 \\
0  \ar[r] & M_{1} \ar[r]  &  M_{2}  \ar[r] & M_{3} \ar[r] & 0
}
$$ 
compatible with the directed system.  From the definition of the fiber product 
$M_{2,i}$, it follows that the map $M_{1,i} \to M_1$ is an isomorphism. 
 By (5) there is a map $M_{3,i} \to M_{2}$ lifting $M_{3,i} \to 
M_3$, and by the universal property of the fiber product this gives rise to a 
section of $M_{2,i} \to M_{3,i}$.  Hence the sequences
$$
0 \to M_{1,i} \to M_{2,i} \to M_{3,i} \to 0 
$$
split.  Passing to the colimit, we have a commutative diagram
$$
\xymatrix{
0  \ar[r] & \text{colim} M_{1,i} \ar[d]^{\cong} \ar[r]  &  \text{colim} M_{2,i} 
 \ar[r] 
\ar[d] & \text{colim} M_{3,i} \ar[d]^{\cong} \ar[r] & 0 \\
0  \ar[r] & M_{1} \ar[r]  &  M_{2}  \ar[r] & M_{3} \ar[r] & 0
}
$$
with exact rows and outer vertical maps isomorphisms.  Hence $\text{colim} 
M_{2,i} 
\to M_2$ is also an isomorphism and (6) holds.

\medskip\noindent
Condition (6) implies (1) by
Example \ref{example-universally-exact} (2).
\end{proof}

\noindent
The previous theorem shows that a universally exact sequence is always a 
colimit of split short exact sequences.  If the cokernel of a universally 
injective map is finitely presented, then in fact the map itself splits:

\begin{lemma}
\label{lemma-universally-exact-split}
Let
$$
0 \to M_1 \to M_2 \to M_3 \to 0
$$
be an exact sequence of $R$-modules.  Suppose $M_3$ is of finite presentation.  
Then
$$
0 \to M_1 \to M_2 \to M_3 \to 0
$$
is universally exact if and only if it is split.
\end{lemma}

\begin{proof}
A split sequence is always universally exact.  Conversely, if the sequence is 
universally exact, then by Theorem \ref{theorem-universally-exact-criteria} (5) 
applied to $P = M_3$, the map $M_{2} \to M_{3}$ admits a section.
\end{proof}

\noindent
The following lemma shows how universally injective maps are complementary to 
flat modules.

\begin{lemma}
\label{lemma-flat-universally-injective}
Let $M$ be an $R$-module.  Then $M$ is flat if and only if any exact sequence 
of $R$-modules
$$
0 \to M_1 \to M_2 \to M \to 0
$$
is universally exact.
\end{lemma}

\begin{proof}
This follows from Lemma \ref{lemma-flat-surjective-hom} and Theorem 
\ref{theorem-universally-exact-criteria} (5).
\end{proof}

\begin{example}
\label{example-universally-exact-non-split-non-flat}
Non-split and non-flat universally exact sequences.
\begin{enumerate}
\item In spite of
Lemma \ref{lemma-universally-exact-split},
it is possible to  have a short exact sequence of $R$-modules
$$
0 \to M_1 \to M_2 \to M_3 \to 0
$$
that is universally exact but non-split.  For instance, take $R = \mathbf{Z}$, 
let $M_1 = \bigoplus_{n=1}^{\infty} \mathbf{Z}$, let $M_{2} = \prod_{n = 
1}^{\infty} \mathbf{Z}$, and let $M_{3}$ be the cokernel of the inclusion $M_1 
\to M_2$.  Then $M_1,M_2,M_3$ are all flat since they are torsion-free, 
so by Lemma \ref{lemma-flat-universally-injective},
$$
0 \to M_1 \to M_2 \to M_3 \to 0
$$
is universally exact.  However there can be no section $s: M_3 \to 
M_2$.  In fact, if $x$ is the image of $(2,2^2,2^3, \dots) \in M_2$ in $M_3$, 
then any module map $s: M_3 \to M_2$ must kill $x$.  This is because $x 
\in 2^n M_3$ for any $n \geq 1$, hence $s(x)$ is divisible by $2^n$ for all $n 
\geq 1$ and so must be $0$. 
\item In spite of Lemma \ref{lemma-flat-universally-injective}, it is possible 
to have a short exact sequence of $R$-modules
$$
0 \to M_1 \to M_2 \to M_3 \to 0
$$
that is universally exact but with $M_1,M_2,M_3$ all non-flat.  In fact if $M$ 
is any non-flat module, just take the split exact sequence 
$$
0 \to M \to M \oplus M \to M \to 0.
$$
For instance over $R = \mathbf{Z}$, take $M$ to be any torsion module.
\item Taking the direct sum of an exact sequence as in (1) with one as in (2), 
we get a short exact sequence of $R$-modules
$$
0 \to M_1 \to M_2 \to M_3 \to 0
$$
that is universally exact, non-split, and such that
$M_1,M_2,M_3$ are all non-flat.
\end{enumerate}
\end{example}

\noindent
We end this section with a simple observation.

\begin{lemma}
\label{lemma-ui-flat-domain}
Let $f: M_1 \to M_2$ be a universally injective map of $R$-modules, and 
suppose $M_2$ is flat.  Then $M_1$ is flat.
\end{lemma}

\begin{proof}
Let $N \to N'$ be an injection and consider the commutative diagram
$$
\xymatrix{
M_1 \otimes_{R} N \ar[r] \ar[d] & M_1 \otimes_{R} N' \ar[d] \\
M_2 \otimes_{R} N  \ar[r]       & M_2 \otimes_{R} N'.
}
$$
From the assumptions, the vertical arrows and the bottom horizontal arrow are 
all injective, hence so is the top arrow.  We conclude that $M_1$ is flat.
\end{proof}



\section{Descent for finite projective modules}
\label{section-finite-projective}

\noindent
In this section we give an elementary proof of the fact that the property of 
being a {\it finite} projective module descends along faithfully flat ring 
maps.  The proof does not apply when we drop the finiteness condition.
However, the method is indicative of the one we shall use to prove descent
for the property of being a {\it countably generated} projective module---see
the comments at the end of this section.

\begin{lemma}
\label{lemma-finite-projective-again}
Let $M$ be an $R$-module.  Then $M$ is finite projective if and only if $M$ is 
finitely presented and flat.
\end{lemma}

\begin{proof}
This is part of
Lemma \ref{lemma-finite-projective}.
However, at this point we can give a more elegant proof of the implication
(1) $\Rightarrow$ (2) of that lemma as follows.
If $M$ is finitely presented and flat, then take a surjection
$R^n \to M$.  By
Lemma \ref{lemma-flat-surjective-hom}
applied to $P = M$, the map $R^n \to M$ admits a section.
So $M$ is a direct summand of a  free module and hence projective.
\end{proof}

\noindent
Here are some properties of modules that descend.

\begin{lemma}
\label{lemma-descend-properties-modules}
Let $R \to S$ be a faithfully flat ring map.
Let $M$ be an $R$-module. Then
\begin{enumerate}
\item if the $S$-module $M \otimes_R S$ is of finite type, then
$M$ is of finite type,
\item if the $S$-module $M \otimes_R S$ is of finite presentation, then
$M$ is of finite presentation,
\item if the $S$-module $M \otimes_R S$ is flat, then
$M$ is flat, and
\item add more here as needed.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume $M \otimes_R S$ is of finite type. Let $y_1, \ldots, y_m$ be generators
of $M \otimes_R S$ over $S$. Write $y_j = \sum x_i \otimes f_i$ for some
$x_1, \ldots, x_n \in M$. Then we see that the map
$\varphi : R^{\oplus n} \to M$
has the property that
$\varphi \otimes \text{id}_S : S^{\oplus n} \to M \otimes_R S$
is surjective. Since $R \to S$ is faithfully flat we see that
$\varphi$ is surjective, and $M$ is finitely generated.

\medskip\noindent
Assume $M \otimes_R S$ is of finite presentation. By (1) we see that
$M$ is of finite type. Choose a surjection $R^{\oplus n} \to M$ and
denote $K$ the kernel. As $R \to S$ is flat we see that $K \otimes_R S$
is the kernel of the base change $S^{\oplus n} \to M \otimes_R S$.
As $M \otimes_R S$ is of finite presentation we conclude that $K \otimes_R S$
is of finite type. Hence by (1) we see that $K$ is of finite type
and hence $M$ is of finite presentation.

\medskip\noindent
Part (3) is
Lemma \ref{lemma-flatness-descends}.
\end{proof}

\begin{proposition}
\label{proposition-ffdescent-finite-projectivity}
Let $R \to S$ be a faithfully flat ring map.  Let $M$ be an $R$-module. 
If the $S$-module $M \otimes_R S$ is finite projective, then $M$ is finite 
projective. 
\end{proposition}

\begin{proof}
Follows from
Lemmas \ref{lemma-finite-projective-again} and 
\ref{lemma-descend-properties-modules}.
\end{proof}

\noindent
The next few sections are about removing the finiteness assumption by using 
d\'evissage to reduce to the countably generated case.  In the countably 
generated case, the strategy is to find a characterization of countably 
generated projective modules analogous to
Lemma \ref{lemma-finite-projective-again}, 
and then to prove directly that this characterization descends. We do this by 
introducing the notion of a Mittag-Leffer module and proving that if a module 
$M$ is countably generated, then it is projective if and only if it is flat and 
Mittag-Leffler (Theorem \ref{theorem-projectivity-characterization}).  When $M$ 
is finitely generated, this statement reduces to Lemma 
\ref{lemma-finite-projective-again} (since, according to
Example \ref{example-ML} (1),
a finitely generated module is Mittag-Leffler if and only if it is 
finitely presented).

\section{Transfinite d\'evissage of modules}
\label{section-transfinite-devissage}

\noindent
In this section we introduce a d\'evissage technique for decomposing a module 
into a direct sum. The main result is that a projective module is a direct sum 
of countably generated modules (Theorem \ref{theorem-projective-direct-sum} 
below).  We follow \cite{K}.


\begin{definition}
\label{definition-devissage}
Let $M$ be an $R$-module.  A {\it direct sum d\'{e}vissage} of $M$ is a family 
of submodules $(M_{\alpha})_{\alpha \in S}$, indexed by an ordinal $S$ and 
increasing (with respect to inclusion), such that:
\begin{enumerate}
\item[(0)] $M_0 = 0$;
\item[(1)] $M = \bigcup_{\alpha} M_{\alpha}$;
\item[(2)] if $\alpha \in S$ is a limit ordinal, then $M_{\alpha} = 
\bigcup_{\beta < \alpha} M_{\beta}$;
\item[(3)] if $\alpha + 1 \in S$, then $M_{\alpha}$ is a direct summand of 
$M_{\alpha+1}$.
\end{enumerate}
If moreover
\begin{enumerate}
\item[(4)] $M_{\alpha+1}/M_{\alpha}$ is countably generated for $\alpha+1 \in 
S$,
\end{enumerate}
then $(M_{\alpha})_{\alpha \in S}$ is called a {\it Kaplansky d\'{e}vissage} 
of $M$.
\end{definition}

\noindent
The terminology is justified by the following lemma.

\begin{lemma}
\label{lemma-direct-sum-devissage}
Let $M$ be an $R$-module.  If $(M_{\alpha})_{\alpha \in S}$ is a direct sum 
d\'evissage of $M$, then $M \cong \bigoplus_{\alpha +1  \in S} 
M_{\alpha+1}/M_{\alpha}$.
\end{lemma}

\begin{proof}
By property (3) of a direct sum d\'evissage, there is an inclusion 
$M_{\alpha+1}/M_{\alpha} \to M$ for each $\alpha \in S$.  Consider the 
map
$$
f: \bigoplus_{\alpha + 1\in S} M_{\alpha+1}/M_{\alpha} \to M
$$
given by the sum of these inclusions.  Transfinite induction on $S$ shows that 
the image contains $M_{\alpha}$ for every $\alpha \in S$: for $\alpha = 0$ this 
is true by (0); if $\alpha+1$ is a successor ordinal then it is clearly true; 
and if $\alpha$ is a limit ordinal and it is true for $\beta < \alpha$, then it 
is true for $\alpha$ by (2). Hence $f$ is surjective by (1).  

\medskip\noindent
Transfinite induction on $S$ also shows that for every $\beta \in S$ the 
restriction
$$
f_{\beta} :
\bigoplus_{\alpha + 1 \leq \beta} M_{\alpha+1}/M_{\alpha}
\longrightarrow
M
$$ 
of $f$ is injective: For $\beta = 0$ it is true.  If it is true for all $\beta' 
< \beta$, then let $x$ be in the kernel and write $x = (x_{\alpha+1})_{\alpha+1 
\leq \beta}$ in terms of its components $x_{\alpha+1} \in 
M_{\alpha+1}/M_{\alpha}$.  By property (3) both $(x_{\alpha+1})_{\alpha+1 < 
\beta}$ and $x_{\beta+1}$ map to $0$.  Hence $x_{\beta+1} = 0$ and, by the 
assumption that the restriction $f_{\beta'}$ is injective for all $\beta' < 
\beta$, also $x_{\alpha+1} = 0$ for every $\alpha+1 < \beta$.  So $x = 0$ and 
$f_{\beta}$ is injective, which finishes the induction.  We conclude that $f$ 
is injective since $f_{\beta}$ is for each $\beta \in S$.
\end{proof}

\begin{lemma}
\label{lemma-Kaplansky-devissage}
Let $M$ be an $R$-module.  Then $M$ is a direct sum of countably generated 
$R$-modules if and only if it admits a Kaplansky d\'evissage.
\end{lemma}

\begin{proof}
The lemma takes care of the ``if'' direction.  Conversely, suppose $M = 
\bigoplus_{i \in I} N_i$ where each $N_i$ is a countably generated $R$-module.  
Well-order $I$ so that we can think of it as an ordinal.  Then setting $M_{i} = 
\bigoplus_{j < i} N_{j}$ gives a Kaplansky d\'evissage $(M_i)_{i \in I}$ of 
$M$.  
\end{proof}

\begin{theorem}
\label{theorem-kaplansky-direct-sum}
Suppose $M$ is a direct sum of countably generated $R$-modules.  If $P$ is a 
direct summand of $M$, then $P$ is also a direct sum of countably generated 
$R$-modules.
\end{theorem}

\begin{proof}
Write $M = P \oplus Q$.  We are going to construct a Kaplansky d\'evissage 
$(M_{\alpha})_{\alpha \in S}$ of $M$ which, in addition to the defining 
properties (0)-(4), satisfies:
\begin{enumerate}
\item[(5)] Each $M_{\alpha}$ is a direct summand of $M$;
\item[(6)] $M_{\alpha} = P_{\alpha} \oplus Q_{\alpha}$, where $P_{\alpha} =P 
\cap M_{\alpha}$ and $Q = Q \cap M_{\alpha}$.
\end{enumerate}
(Note: if properties (0)-(2) hold, then in fact property (3) is equivalent to 
property (5).)

\medskip\noindent
To see how this implies the theorem, it is enough to show that 
$(P_{\alpha})_{\alpha \in S}$ forms a Kaplansky d\'evissage of $P$.  Properties 
(0), (1), and (2) are clear.  By (5) and (6) for $(M_{\alpha})$, each 
$P_{\alpha}$ is a direct summand of $M$.  Since $P_{\alpha} \subset P_{\alpha + 
1}$, this implies $P_{\alpha}$ is a direct summand of $P_{\alpha + 1}$; hence 
(3) holds for $(P_{\alpha})$.  For (4), note that
$$ 
M_{\alpha +1}/M_{\alpha} \cong P_{\alpha+1}/P_{\alpha} \oplus 
Q_{\alpha+1}/Q_{\alpha},
$$
so $P_{\alpha+1}/P_{\alpha}$ is countably generated because this is true of 
$M_{\alpha+1}/M_{\alpha}$.

\medskip\noindent
It remains to construct the $M_{\alpha}$.  Write $M = \bigoplus_{i \in I} N_i$ 
where each $N_i$ is a countably generated $R$-module.  Choose a well-ordering 
of $I$.  By transfinite induction we are going to define an increasing family 
of submodules $M_{\alpha}$ of $M$, one for each ordinal $\alpha$, such that 
$M_{\alpha}$ is a direct sum of some subset of the $N_i$.

\medskip\noindent
For $\alpha = 0$ let $M_{0} = 0$.  If $\alpha$ is a limit ordinal and 
$M_{\beta}$ has been defined for all $\beta < \alpha$, then define $M_{\alpha} 
= \bigcup_{\beta < \alpha} M_{\beta}$.  Since each $M_{\beta}$ for $\beta < 
\alpha$ is a direct sum of a subset of the $N_i$, the same will be true of 
$M_{\alpha}$.  If $\alpha+1$ is a successor ordinal and $M_{\alpha}$ has been 
defined, then define $M_{\alpha+1}$ as follows.  If $M_{\alpha} = M$, then let 
$M_{\alpha+1} = M$.  If not, choose the smallest $j \in I$ such that $N_{j}$ is 
not contained in $M_{\alpha}$.  We will construct an infinite matrix $(x_{mn}), 
m,n = 1, 2, 3, \dots$ such that: 
\begin{enumerate}
\item $N_j$ is contained in the submodule of $M$ generated by the entries 
$x_{mn}$; 
\item if we write any entry $x_{k\ell}$ in terms of its $P$- and 
$Q$-components, $x_{k\ell} = y_{k\ell} + z_{k\ell}$, then the matrix $(x_{mn})$ 
contains a set of generators for each $N_i$ for which $y_{k\ell}$ or 
$z_{k\ell}$ has nonzero component.
\end{enumerate}
Then we define $M_{\alpha+1}$ to be the submodule of $M$ generated by 
$M_{\alpha}$ and all $x_{mn}$; by property (2) of the matrix $(x_{mn})$, 
$M_{\alpha+1}$ will be a direct sum of some subset of the $N_i$.  To construct 
the matrix $(x_{mn})$, let $x_{11},x_{12},x_{13}, \dots$ be a countable set of 
generators for $N_j$.  Then if $x_{11} = y_{11} + z_{11}$ is the decomposition 
into $P$- and $Q$-components, let $x_{21},x_{22},x_{23}, \dots$ be a countable 
set of generators for the sum of the $N_i$ for which $y_{11}$ or $z_{11}$ have 
nonzero component.  Repeat this process on $x_{12}$ to get elements $x_{31}, 
x_{32}, \dots$, the third row of our matrix.  Repeat on $x_{21}$ to get the 
fourth row, on $x_{13}$ to get the fifth, and so on, going down along 
successive anti-diagonals as indicated below:
$$
\left(
\vcenter{\xymatrix@R=2mm@C=2mm{
x_{11} & x_{12} \ar[dl] & x_{13} \ar[dl] & x_{14} \ar[dl] & \cdots  \\
x_{21} & x_{22} \ar[dl] & x_{23} \ar[dl] & \cdots  \\
x_{31} & x_{32} \ar[dl] & \cdots \\
x_{41} & \cdots \\
\cdots 
}}
\right).
$$

\medskip\noindent
Transfinite induction on $I$ (using the fact that we constructed $M_{\alpha+1}$ 
to contain $N_{j}$ for the smallest $j$ such that $N_{j}$ is not contained in 
$M_{\alpha}$) shows that for each $i \in I$, $N_{i}$ is contained in some 
$M_{\alpha}$.  Thus, there is some large enough ordinal $S$ satisfying: for 
each $i \in I$ there is $\alpha \in S$ such that $N_{i}$ is contained in 
$M_{\alpha}$.  This means $(M_{\alpha})_{\alpha \in S}$ satisfies property (1) 
of a Kaplansky d\'evissage of $M$.  The family $(M_{\alpha})_{\alpha \in S}$ 
moreover satisfies the other defining properties, and also (5) and (6) above: 
properties (0), (2), (4), and (6) are clear by construction;  property (5) is 
true because each $M_{\alpha}$ is by construction a direct sum of some $N_{i}$; 
and (3) is implied by (5) and the fact that $M_{\alpha} \subset M_{\alpha+1}$.
\end{proof}

\noindent
As a corollary we get the result for projective modules stated at the beginning 
of the section.

\begin{theorem}
\label{theorem-projective-direct-sum}
If $P$ is a projective $R$-module, then $P$ is a direct sum of countably 
generated projective $R$-modules.
\end{theorem}

\begin{proof}
A module is projective if and only if it is a direct summand of a free module, 
so this follows from Theorem \ref{theorem-kaplansky-direct-sum}.
\end{proof}



\section{Projective modules over a local ring}
\label{section-projective-local-ring}

\noindent
In this section we prove a very cute result:
a projective module $M$ over a local ring is free 
(Theorem \ref{theorem-projective-free-over-local-ring} below).
Note that with  the additional assumption that $M$ is finite, this result is
Lemma \ref{lemma-finite-flat-local}.
In general, by
Theorem \ref{theorem-projective-direct-sum},
we have:

\begin{lemma}
\label{lemma-projective-free}
Let $R$ be a ring.  Then every projective $R$-module is free if and only if 
every countably generated projective $R$-module is free.
\end{lemma}

\noindent
Here is a criterion for a countably generated module to be free.

\begin{lemma}
\label{lemma-freeness-criteria}
Let $M$ be a countably generated $R$-module.  Suppose any direct summand $N$ of 
$M$ satisfies: any element of $N$ is contained in a free direct summand of $N$. 
 Then $M$ is free.
\end{lemma}

\begin{proof}
Let $x_1, x_2, \dots$ be a countable set of generators for $M$.  By the 
assumption on $M$, we can construct by induction free $R$-modules $F_1,F_2, 
\dots$ such that for every positive integer $n$, $\bigoplus_{i=1}^{n} F_i$ is a 
direct summand of $M$ and contains $x_1, \dots, x_n$.  Then $M = \bigoplus_{i = 
1}^{\infty} F_i$.
\end{proof}

\begin{lemma}
\label{lemma-projective-freeness-criteria}
Let $P$ be a projective module over a local ring $R$.  Then any element of $P$ 
is contained in a free direct summand of $P$.
\end{lemma}

\begin{proof}
Since $P$ is projective it is a direct summand of some free $R$-module $F$, say 
$F = P \oplus Q$.  Let $x \in P$ be the element that we wish to show is 
contained in a free direct summand of $P$.  Let $B$ be a basis of $F$ such that 
the number of basis elements needed in the expression of $x$ is minimal, say $x 
= \sum_{i=1}^n a_i e_i$ for some $e_i \in B$ and $a_i \in R$.  Then no $a_j$ 
can be expressed as a linear combination of the other $a_i$; for if $a_j = 
\sum_{i \neq  j} a_i b_i$ for some $b_i \in R$, then replacing $e_i$ by $e_i + 
b_ie_j$ for $i \neq j$ and leaving unchanged the other elements of $B$, we get 
a new basis for $F$ in terms of which $x$ has a shorter expression.

\medskip\noindent
Let $e_i = y_i + z_i, y_i \in P, z_i \in Q$ be the decomposition of $e_i$ into 
its $P$- and $Q$-components.  Write $y_i = \sum_{j=1}^{n} b_{ij} e_j + t_i$, 
where $t_i$ is a linear combination of elements in $B$ other than $e_1, \dots, 
e_n$.  To finish the proof it suffices to show that the matrix $(b_{ij})$ is 
invertible.  For then the map $F \to F$ sending $e_i \mapsto y_i$ for 
$i=1, \dots, n$ and fixing $B \setminus \{e_1, \dots, e_n\}$ is an isomorphism, 
so that $y_1, \dots, y_n$ together with $B \setminus \{e_1, \dots, e_n\}$ form 
a basis for $F$.  Then the submodule $N$ spanned by $y_1, \dots, y_n$ is a free 
submodule of $P$; $N$ is a direct summand of $P$ since $N \subset P$ and both 
$N$ and $P$ are direct summands of $F$; and $x \in N$ since $x \in P$ implies 
$x = \sum_{i=1}^n a_i e_i = \sum_{i=1}^n a_i y_i$.

\medskip\noindent
Now we prove that $(b_{ij})$ is invertible. Plugging $y_i = \sum_{j=1}^{n} 
b_{ij} e_j + t_i$ into $\sum_{i=1}^n a_i e_i = \sum_{i=1}^n a_i y_i$ and 
equating the coefficients of $e_j$ gives $a_j = \sum_{i=1}^n a_i b_{ij}$.  But 
as noted above, our choice of $B$ guarantees that no $a_j$ can be written as a 
linear combination of the other $a_i$.  Thus $b_{ij}$ is a non-unit for $i \neq 
j$, and $1-b_{ii}$ is a non-unit---so in particular $b_{ii}$ is a unit---for 
all $i$.  But a matrix over a local ring having units along the diagonal and 
non-units elsewhere is invertible, as its determinant is a unit.
\end{proof}

\begin{theorem}
\label{theorem-projective-free-over-local-ring}
If $P$ is a projective module over a local ring $R$, then $P$ is free.
\end{theorem}

\begin{proof}
Follows from Lemmas \ref{lemma-projective-free}, \ref{lemma-freeness-criteria}, 
and \ref{lemma-projective-freeness-criteria}.
\end{proof}



\section{Mittag-Leffler systems}
\label{section-mittag-leffler}

\noindent
The purpose of this section is to define Mittag-Leffler systems
and why it is a useful property.
 
\medskip\noindent
In the following, $I$ will be a directed partially ordered set, see
Categories, Definition \ref{categories-definition-directed-system}.
Let $(A_i, \varphi_{ji}: A_j \to A_{i})$ be an inverse
system of sets or of modules indexed by $I$, see
Categories, Definition \ref{categories-definition-directed-system}.
This is a directed inverse system as we assumed $I$ directed.
For each $i \in I$, the
images $\varphi_{ji}(A_j) \subset A_i$ for $j \geq i$ form a decreasing
family.  Let $A'_i = \bigcap_{j \geq i} \varphi_{ji}(A_j)$.
Then $\varphi_{ji}(A'_j) \subset A'_i$ for $j \geq i$, hence by restricting
we get a directed inverse system $(A'_{i}, \varphi_{ji}|_{A'_j})$.
From the construction of the limit of an inverse system in the category
of sets or modules, we have $\lim A_i = \lim A'_i$.  The Mittag-Leffler
condition on $(A_i, \varphi_{ji})$ is that $A'_i$ equals
$\varphi_{ji}(A_{j})$ for some $j \geq i$ (and hence equals
$\varphi_{ki}(A_k)$ for all $k \geq j$):

\begin{definition}
\label{definition-ML-system}
Let $(A_{i},\varphi_{ji})$ be a directed inverse system of sets over $I$.  Then 
we say  $(A_{i}, \varphi_{ji})$ is {\it Mittag-Leffler inverse system} if for 
each $i \in I$, the decreasing family $\varphi_{ji}(A_{j}) \subset A_i$ for $j 
\geq i$ stabilizes.  Explicitly, this means that for each $i \in I$, there 
exists $j \geq i$ such that for $k \geq j$ we have $\varphi_{ki}(A_{k}) = 
\varphi_{ji}( A_{j})$.  If $(A_{i},\varphi_{ji})$ is a directed inverse system 
of modules over a ring $R$, we say that it is Mittag-Leffler if the underlying 
inverse system of sets is Mittag-Leffler.
\end{definition}

\begin{example}
\label{example-ML-surjective-maps}
If $(A_i, \varphi_{ji})$ is a directed inverse system of sets or of modules and 
the maps $\varphi_{ji}$ are surjective, then clearly the system is 
Mittag-Leffler.  Conversely, suppose $(A_i, \varphi_{ji})$ is Mittag-Leffler.  
Let $A'_{i} \subset A_i$ be the stable image of $\varphi_{ji}(A_j)$ for $j \geq 
i$.  Then $\varphi_{ji}|_{A'_{j}}: A'_{j} \to A'_i$ is surjective for 
$j \geq i$ and $\lim A_i = \lim A'_i$.  Hence the limit of the Mittag-Leffler 
system $(A_i, \varphi_{ji})$ can also be written as the limit of a directed 
inverse system over $I$ with surjective maps.  
\end{example}

\begin{lemma}
\label{lemma-ML-limit-nonempty}
Let $(A_{i}, \varphi_{ji})$ be a directed inverse system over $I$.  Suppose $I$ 
is countable.  If $(A_{i}, \varphi_{ji})$ is Mittag-Leffler and the $A_i$ are 
nonempty, then $\lim A_i$ is nonempty.
\end{lemma}

\begin{proof}
Let $i_1,i_2, i_3, \dots$ be an enumeration of the elements of $I$.  Define 
inductively a sequence of elements $j_n \in I$ for $n = 1,2,3, \dots$ by the 
conditions: $j_1 = i_1$, and $j_n \geq i_n$ and $j_{n} \geq j_{m}$ for $m < n$. 
 Then the sequence $j_n$ is increasing and forms a cofinal subset of $I$.  
Hence we may assume $I =\{1,2,3,\dots \}$.  So by Example 
\ref{example-ML-surjective-maps} we are reduced to showing that the limit of an 
inverse system of nonempty sets with surjective maps indexed by the positive 
integers is nonempty.  This is obvious.  
\end{proof}

\noindent
The Mittag-Leffler condition will be important for us because of the following 
exactness property.

\begin{lemma}
\label{lemma-ML-exact-sequence}
Let
$$
0 \to A_i \xrightarrow{f_i} B_i \xrightarrow{g_i} C_i \to 0 
$$
be an exact sequence of directed inverse systems of abelian groups over $I$.  
Suppose $I$ is countable.  If $(A_i)$ is Mittag-Leffler, then
$$
0 \to \lim A_i \to \lim B_i \to \lim C_i\to 0
$$ 
is exact.
\end{lemma}

\begin{proof}
Taking limits of directed inverse systems is left exact, hence we only need to 
prove surjectivity of $\lim B_i \to \lim C_i$.  So let $(c_i) \in \lim 
C_i$.  For each $i \in I$, let $E_i = g_{i}^{-1}(c_i)$, which is nonempty since 
$g_i: B_i \to C_i$ is surjective. The system of maps $\varphi_{ji}: B_j 
\to B_i$ for $(B_i)$ restrict to maps $E_{j} \to E_{i}$ which 
make $(E_i)$ into an inverse system of nonempty sets.  It is enough to show 
that $(E_i)$ is Mittag-Leffler. For then Lemma \ref{lemma-ML-limit-nonempty} 
would show $\lim E_i$ is nonempty, and taking any element of $\lim E_i$ would 
give an element of $\lim B_i$ mapping to $(c_i)$.

\medskip\noindent
By the injection $f_i: A_i \to B_i$ we will regard $A_i$ as a subset of 
$B_i$.  Since $(A_i)$ is Mittag-Leffler, if $i \in I$ then there exists $j \geq 
i$ such that $\varphi_{ki}(A_k) = \varphi_{ji}(A_j)$ for $k \geq j$.  We claim 
that also $\varphi_{ki}(E_k) = \varphi_{ji}(E_j)$ for $k \geq j$.  Always 
$\varphi_{ki}(E_k) \subset \varphi_{ji}(E_j)$ for $k \geq j$.  For the reverse 
inclusion let $e_j \in E_j$, and we need to find $x_k \in E_k$ such that 
$\varphi_{ki}(x_k) = \varphi_{ji}(e_j)$.  Let $e'_k \in E_k$ be any element, 
and set $e'_j = \varphi_{kj}(e'_k)$.  Then $g_j(e_j - e'_j) = c_j - c_j = 0$, 
hence $e_j - e'_j = a_j \in A_j$.  Since $\varphi_{ki}(A_k) = 
\varphi_{ji}(A_j)$, there exists $a_k \in A_k$ such that $\varphi_{ki}(a_k) = 
\varphi_{ji}(a_j)$.  Hence
$$
\varphi_{ki}(e'_k + a_k) = \varphi_{ji}(e'_j) + \varphi_{ji}(a_j) = 
\varphi_{ji}(e_j),
$$
so we can take $x_k = e'_k + a_k$.
\end{proof}




\section{Inverse systems}
\label{section-inverse-systems}

\noindent
In many papers (and in this section) the term {\it inverse system} is
used to indicate an inverse system over the partially ordered set
$(\mathbf{N}, \geq)$. We briefly discuss such systems in this section.
This material will be discussed more broadly in
Homology, Section \ref{homology-section-inverse-systems}.
Suppose we are given a ring $R$ and a sequence of $R$-modules
$$
M_1 \xleftarrow{\varphi_2} M_2 \xleftarrow{\varphi_3} M_3 \leftarrow \ldots
$$
with maps as indicated. By composing succesive maps we obtain maps
$\varphi_{ii'} : M_i \to M_{i'}$ whenever $i \geq i'$ such that moreover
$\varphi_{ii''} = \varphi_{i'i''} \circ \varphi_{i i'}$ whenever
$i \geq i' \geq i''$. Conversely, given the system of maps $\varphi_{ii'}$
we can set $\varphi_i = \varphi_{i(i-1)}$ and recover the maps displayed
above. In this case
$$
\lim M_i
=
\{(x_i) \in \prod M_i \mid \varphi_i(x_i) = x_{i - 1},\ i = 2, 3, \ldots\}
$$
compare with
Categories, Section \ref{categories-section-limit-sets}.
As explained in
Homology, Section \ref{homology-section-inverse-systems}
this is actually a limit in the category of $R$-modules, as defined in
Categories, Section \ref{categories-section-limits}.

\begin{lemma}
\label{lemma-Mittag-Leffler}
Let $R$ be a ring.
Let $0 \to K_i \to L_i \to M_i \to 0$ be short exact sequences of
$R$-modules, $i \geq 1$ which fit into maps of short exact sequences
$$
\xymatrix{
0 \ar[r] &
K_i \ar[r] &
L_i \ar[r] &
M_i \ar[r] &
0 \\
0 \ar[r] &
K_{i + 1} \ar[r] \ar[u] &
L_{i + 1} \ar[r] \ar[u] &
M_{i + 1} \ar[r] \ar[u] &
0}
$$
If for every $i$ there exists a $c = c(i) \geq i$ such that
$\text{Im}(K_c \to K_i) = \text{Im}(K_j \to K_i)$
for all $j \geq c$, then the sequence
$$
0 \to \lim K_i \to \lim L_i \to \lim M_i \to 0
$$
is exact.
\end{lemma}

\begin{proof}
This is a special case of the more general
Lemma \ref{lemma-ML-exact-sequence}.
\end{proof}



\section{Mittag-Leffler modules}
\label{section-mittag-leffler-modules}

\noindent
A Mittag-Leffler module is (very roughly) a module which can be written
as a directed limit whose dual is a Mittag-Leffler system. To be able
to give a precise definition we need to do a bit of work.

\begin{definition}
\label{definition-ML-inductive-system}
Let $(M_i, f_{ij})$ be a directed system of $R$-modules.  We say that 
$(M_i,f_{ij})$ is a {\it Mittag-Leffler directed system of modules} if each 
$M_i$ is of finite presentation and if for every $R$-module $N$, the inverse 
system $(\text{Hom}_{R}(M_i,N),\text{Hom}_{R}(f_{ij},N))$ is Mittag-Leffler.
\end{definition}

\noindent
We are going to characterize those $R$-modules that are colimits of 
Mittag-Leffler directed systems of modules.  

\begin{definition}
\label{definition-domination}
Let $f: M \to N$ and $g: M \to M'$ be maps of $R$-modules.  
Then we say $g$ {\it dominates} $f$ if for any $R$-module $Q$, we have $\ker(f 
\otimes_{R} \textnormal{id}_Q) \subset \ker(g \otimes_{R} \textnormal{id}_Q)$.
\end{definition}

\begin{lemma}
\label{lemma-domination-fp}
Let $f: M \to N$ and $g: M \to M'$ be maps of $R$-modules.  
Then $g$ dominates $f$ if and only if for any finitely presented $R$-module 
$Q$, we have $\ker(f \otimes_{R} \textnormal{id}_Q) \subset \ker(g \otimes_{R} 
\textnormal{id}_Q)$. 
\end{lemma}

\begin{proof}
Suppose $\ker(f \otimes_{R} \textnormal{id}_Q) \subset \ker(g \otimes_{R} 
\textnormal{id}_Q)$ for all finitely presented modules $Q$.  If $Q$ is an 
arbitrary module, write $Q = \text{colim}_{i \in I} Q_i$ as a colimit of a 
directed 
system of finitely presented modules $Q_i$.  Then $\ker(f \otimes_{R} 
\textnormal{id}_{Q_i}) \subset \ker(g \otimes_{R} \textnormal{id}_{Q_i})$ for 
all $i$.  Since taking directed colimits is exact and commutes with tensor 
product, it follows that $\ker(f \otimes_{R} \textnormal{id}_Q) \subset \ker(g 
\otimes_{R} \textnormal{id}_Q)$.
\end{proof}

\noindent
The above definition of domination is related to the usual notion of domination 
of maps as follows.

\begin{lemma}
\label{lemma-domination}
Let $f: M \to N$ and $g: M \to M'$ be maps of $R$-modules.  
Suppose $\text{Coker}(f)$ is of finite presentation.  Then $g$ dominates $f$ if 
and 
only if $g$ factors through $f$, i.e.\ there exists a module map $h: N 
\to M'$ such that $g = h \circ f$.
\end{lemma}

\begin{proof}
Consider the pushout of $f$ and $g$,
$$ 
\xymatrix{
M  \ar[r]^{f} \ar[d]_{g} & N \ar[d]^{g'} \\
M' \ar[r]^{f'} & N'
}
$$
where $N'$ is $M' \oplus N$ modulo the submodule consisting of elements 
$(g(x),-f(x))$ for $x \in M$.  We are going to show that the two conditions we 
wish to prove equivalent are each equivalent to $f'$ being universally 
injective.

From the definition of $N'$ we have a short exact sequence
$$
0 \to \ker(f) \cap \ker(g) \to \ker(f) \to \ker(f') 
\to 0.
$$
Since tensoring commutes with taking pushouts, we have such a short exact 
sequence
$$
0 \to \ker(f \otimes \textnormal{id}_{Q} ) \cap \ker(g \otimes 
\textnormal{id}_{Q}) \to \ker(f \otimes \textnormal{id}_{Q}) 
\to \ker(f' \otimes \textnormal{id}_{Q}) \to 0
$$
for every $R$-module $Q$.  So $f'$ is universally injective if and only if 
$\ker(f \otimes \textnormal{id}_{Q} ) \subset \ker(g \otimes 
\textnormal{id}_{Q})$ for every $Q$, if and only if $g$ dominates $f$.  

\medskip\noindent
On the other hand, from the definition of the pushout it follows that 
$\text{Coker}(f') = \text{Coker}(f)$, so $\text{Coker}(f')$ is of finite 
presentation.  Then by 
Lemma \ref{lemma-universally-exact-split}, $f'$ is universally injective if and 
only if
$$
0 \to M' \xrightarrow{f'} N' \to \text{Coker}(f') \to 0
$$
splits.  This is the case if and only if there is a map $h' : N' \to 
M'$ such that $h' \circ f' = \textnormal{id}_{M'}$.  From the universal 
property of the pushout, the existence of such an $h'$ is equivalent to $g$ 
factoring through $f$.
\end{proof}


\begin{proposition}
\label{proposition-ML-characterization}
Let $M$ be an $R$-module.  Let $(M_i,f_{ij})$ be a directed system of finitely 
presented $R$-modules, indexed by $I$, such that $M = \text{colim} M_i$.  Let 
$f_i: 
M_i \to M$ be the canonical map.  The following are equivalent:
\begin{enumerate}
\item For every finitely presented $R$-module $P$ and module map $f: P 
\to M$, there exists a finitely presented $R$-module $Q$ and a module 
map $g: P \to Q$ such that $g$ and $f$ dominate each other, i.e.\ 
$\ker(f \otimes_{R} \textnormal{id}_N) = \ker(g \otimes_{R} \textnormal{id}_N)$ 
for every $R$-module $N$.
\item For each $i \in I$, there exists $j \geq i$ such that $f_{ij}: M_i 
\to M_j$ dominates $f_i: M_i \to M$.
\item For each $i \in I$, there exists $j \geq i$ such that $f_{ij}: M_i 
\to M_j$ factors through $f_{ik}: M_i \to M_k$ for all $k \geq 
i$.
\item For every $R$-module $N$, the inverse system 
$(\text{Hom}_{R}(M_i,N),\text{Hom}_{R}(f_{ij},N))$ is Mittag-Leffler.
\item For $N = \prod_{s \in I} M_s$, the inverse system 
$(\text{Hom}_{R}(M_i,N),\text{Hom}_{R}(f_{ij},N))$ is Mittag-Leffler.
\end{enumerate}
\end{proposition}

\begin{proof}
First we prove the equivalence of (1) and (2).  Suppose (1) holds and let $i 
\in I$. Corresponding to the map $f_i: M_i \to M$, we can choose $g: 
M_i \to Q$ as in (1).  Since $M_i$ and $Q$ are of finite presentation, 
so is $\text{Coker}(g)$.  Then by Lemma \ref{lemma-domination}, $f_{i} : M_i 
\to M$ factors through $g: M_i \to Q$, say $f_i = h \circ g$ 
for some $h: Q \to M$.  Then since $Q$ is finitely presented, $h$ 
factors through $M_j \to M$ for some $j \geq i$, say $h = f_j \circ h'$ 
for some $h': Q \to M_j$.  In total we have a commutative diagram
$$
\xymatrix{
  &  M  & \\
M_i \ar[dr]_{g} \ar[ur]^{f_i} \ar[rr]^{f_{ij}} &
& M_j \ar[ul]_{f_j} .\\
  & Q  \ar[ur]_{h'} &
}
$$
Thus $f_{ij}$ dominates $g$.  But $g$ dominates $f_i$, so $f_{ij}$ dominates 
$f_i$.  

\medskip\noindent
Conversely, suppose (2) holds.  Let $P$ be of finite presentation and $f: P 
\to M$ a module map.  Then $f$ factors through $f_i: M_i \to M$ 
for some $i \in I$, say $f = f_i \circ g'$ for some $g': P \to M_i$.  
Choose by (2) a $j \geq i$ such that $f_{ij}$ dominates $f_i$.  We have a 
commutative diagram
$$
\xymatrix{
P \ar[d]_{g'} \ar[r]^{f}           & M  \\
M_i \ar[ur]^{f_i} \ar[r]_{f_{ij}} & M_j \ar[u]_{f_j} ~. 
} 
$$
From the diagram and the fact that $f_{ij}$ dominates $f_{i}$, we find that $f$ 
and $f_{ij} \circ g'$ dominate each other.  Hence taking $g = f_{ij} \circ g' : 
P \to M_j$ works.

\medskip\noindent
Next we prove (2) is equivalent to (3).  Let $i \in I$.  It is always true that 
$f_{i}$ dominates $f_{ik}$ for $k \geq i$, since $f_{i}$ factors through 
$f_{ik}$.  If (2) holds, choose $j \geq i$ such that $f_{ij}$ dominates 
$f_{i}$.  Then since domination is a transitive relation, $f_{ij}$ dominates 
$f_{ik}$ for $k \geq i$. All $M_i$ are of finite presentation, so 
$\text{Coker}(f_{ik})$ is of finite presentation for $k \geq i$.  By Lemma 
\ref{lemma-domination}, $f_{ij}$ factors through $f_{ik}$ for all $k \geq i$.  
Thus (2) implies (3).  On the other hand, if (3) holds then for any $R$-module 
$N$, $f_{ij} \otimes_{R} \textnormal{id}_{N}$ factors through $f_{ik} 
\otimes_{R} \textnormal{id}_N$ for $k \geq i$.  So $\ker(f_{ik} \otimes_{R} 
\textnormal{id}_N) \subset \ker(f_{ij} \otimes_{R} \textnormal{id}_{N})$ for $k 
\geq i$.  But $\ker(f_i \otimes_{R} \textnormal{id}_{N}: M_i \otimes_{R} N 
\to M \otimes_{R} N)$ is the union of $\ker(f_{ik} \otimes_{R} 
\textnormal{id}_N)$ for $k \geq i$.  Thus $\ker(f_i \otimes_{R} 
\textnormal{id}_{N}) \subset \ker(f_{ij} \otimes_{R} \textnormal{id}_{N})$ for 
any $R$-module $N$, which by definition means $f_{ij}$ dominates $f_{i}$.

\medskip\noindent
It is trivial that (3) implies (4) implies (5).  We show (5) implies (3).  Let 
$N = \prod_{s \in I} M_s$. If (5) holds, then given $i \in I$ choose $j \geq i$ 
such that
$$
\text{Im}( \text{Hom}(M_j, N) \to  \text{Hom}(M_i, N)) =
\text{Im}( \text{Hom}(M_k, N) \to  \text{Hom}(M_i, N))
$$
for all $k \geq j$.  Passing the product over $s \in I$ outside of the 
$\text{Hom}$'s 
and looking at the maps on each component of the product, this says
$$  
\text{Im}( \text{Hom}(M_j, M_s) \to  \text{Hom}(M_i, M_s)) =  
\text{Im}( \text{Hom}(M_k, M_s) \to   \text{Hom}(M_i, M_s))
$$
for all $k \geq j$ and $s \in I$.  Taking $s = j$ we have
$$  
\text{Im}( \text{Hom}(M_j, M_j) \to  \text{Hom}(M_i, M_j)) =  
\text{Im}( \text{Hom}(M_k, M_j) \to   \text{Hom}(M_i, M_j))
$$
for all $k \geq j$.  Since $f_{ij}$ is the image of
$\textnormal{id} \in  \text{Hom}(M_j,M_j)$ under
$\text{Hom}(M_j, M_j) \to  \text{Hom}(M_i, M_j)$,
this shows  that for any $k \geq j$ there is $h \in \text{Hom}(M_k,M_j)$
such that $f_{ij} = h \circ f_{ik}$.  If $j \geq k$ then we can take
$h = f_{kj}$. Hence (3) holds.
\end{proof}

\begin{definition}
\label{definition-mittag-leffler-module}
Let $M$ be an $R$-module.  We say that $M$ is {\it Mittag-Leffler} if the 
equivalent conditions of
Proposition \ref{proposition-ML-characterization}
hold.
\end{definition}

\begin{remark}
\label{remark-flat-ML}
Let $M$ be a flat $R$-module. By Lazard's theorem
(Theorem \ref{theorem-lazard})
we can write $M = \text{colim} M_i$ as the colimit of a
directed system $(M_i, f_{ij})$ where the $M_i$ are free 
finite $R$-modules. For $M$ to be Mittag-Leffler, it is enough for the inverse 
system of duals $(\text{Hom}_R(M_i,R),\text{Hom}_R(f_{ij},R))$ to be 
Mittag-Leffler. This follows from criterion (4) of
Proposition \ref{proposition-ML-characterization}
and the fact that for a free finite $R$-module $F$,
there is a functorial isomorphism
$\text{Hom}_{R}(F,R) \otimes_{R} N \cong \text{Hom}_{R}(F,N)$
for any $R$-module $N$.
\end{remark}



\section{Interchanging direct products with tensor}
\label{section-products-tensor}

\noindent
Let $M$ be an $R$-module and let $(Q_{\alpha})_{\alpha \in A}$ be a family of 
$R$-modules.  Then there is a canonical map $M \otimes_{R} \left( \prod_{\alpha 
\in A} Q_{\alpha} \right) \to \prod_{\alpha \in A} ( M \otimes_{R} 
Q_{\alpha})$ given on pure tensors by $x \otimes (q_{\alpha}) \mapsto (x 
\otimes q_{\alpha})$.  This map is not necessarily injective or surjective, as 
the following example shows.

\begin{example}
\label{example-Q-not-ML}
Take $R = \mathbf{Z}$, $M = \mathbf{Q}$, and consider the family $Q_n = 
\mathbf{Z}/n$ for $n \geq 1$.  Then $\prod_{n} (M \otimes Q_n) = 0$.  However 
there is an injection $\mathbf{Q} \to M \otimes (\prod_{n} Q_n)$ 
obtained by tensoring the injection $\mathbf{Z} \to \prod_{n} Q_n$ by 
$M$, so $M \otimes (\prod_{n} Q_n)$ is nonzero.  Thus $M \otimes (\prod_{n} 
Q_n) \to \prod_{n} (M \otimes Q_n)$ is not injective.

\medskip\noindent
On the other hand, take again $R = \mathbf{Z}$, $M = \mathbf{Q}$, and let $Q_n 
= \mathbf{Z}$ for $n \geq 1$.  The image of $M \otimes (\prod_{n} Q_n) 
\to \prod_{n} (M \otimes Q_n) = \prod_{n} M$ consists precisely of 
sequences of the form $(a_n/m)_{n \geq 1}$ with $a_n \in \mathbf{Z}$ and $m$ 
some nonzero integer.  Hence the map is not surjective.
\end{example}

\noindent
We determine below the precise conditions needed on $M$ for the map $M 
\otimes_{R} \left( \prod_{\alpha} Q_{\alpha} \right) \to \prod_{\alpha} 
(M \otimes_{R} Q_{\alpha})$ to be surjective, bijective, or injective for all 
choices of $(Q_{\alpha})_{\alpha \in A}$.  This is relevant because the modules 
for which it is injective turn out to be exactly Mittag-Leffler modules 
(Proposition \ref{proposition-ML-tensor}).  In what follows, if $M$ is an 
$R$-module and $A$ a set, we write $M^A$ for the product $\prod_{\alpha \in A} 
M$.

\begin{proposition}
\label{proposition-fg-tensor}
Let $M$ be an $R$-module.  The following are equivalent:
\begin{enumerate}
\item $M$ is finitely generated.
\item For every family $(Q_{\alpha})_{\alpha \in A}$ of $R$-modules, the 
canonical map $M \otimes_{R} \left( \prod_{\alpha} Q_{\alpha} \right) 
\to \prod_{\alpha} (M \otimes_{R} Q_{\alpha})$ is surjective.
\item For every $R$-module $Q$ and every set $A$, the canonical map $M 
\otimes_{R} Q^{A} \to (M \otimes_{R} Q)^{A}$ is surjective.
\item For every set $A$, the canonical map $M \otimes_{R} R^{A} \to 
M^{A}$ is surjective.
\end{enumerate}
\end{proposition}

\begin{proof}
First we prove (1) implies (2).  Choose a surjection $R^n \to M$ and 
consider the commutative diagram
$$
\xymatrix{
R^n \otimes_{R} (\prod_{\alpha} Q_{\alpha})  \ar[r]^{\cong} \ar[d] & 
\prod_{\alpha} (R^n \otimes_{R} Q_{\alpha}) \ar[d] \\
M \otimes_{R} (\prod_{\alpha} Q_{\alpha})  \ar[r] & \prod_{\alpha} ( M 
\otimes_{R} Q_{\alpha}).
}
$$
The top arrow is an isomorphism and the vertical arrows are surjections.  We 
conclude that the bottom arrow is a surjection.

\medskip\noindent
Obviously (2) implies (3) implies (4), so it remains to prove (4) implies (1).  
In fact for (1) to hold it suffices that the element $d = (x)_{x \in M}$ of 
$M^M$ is in the image of the map $f: M \otimes_{R} R^{M} \to M^M$.  In 
this case $d = \sum_{i = 1}^{n} f(x_i \otimes a_i)$ for some $x_i \in M$ and 
$a_i \in R^M$.  If for $x \in M$ we write $p_x: M^M \to M$ for the 
projection onto the $x$-th factor, then
$$
x = p_x(d) = \sum_{i = 1}^{n} p_x(f(x_i \otimes a_i)) =
\sum_{i=1}^{n} p_x(a_i) x_i.
$$
Thus $x_1, \dots, x_n$ generate $M$.
\end{proof}

\begin{proposition}
\label{proposition-fp-tensor}
Let $M$ be an $R$-module.  The following are equivalent:
\begin{enumerate}
\item $M$ is finitely presented.
\item For every family $(Q_{\alpha})_{\alpha \in A}$ of $R$-modules, the 
canonical map $M \otimes_{R} \left( \prod_{\alpha} Q_{\alpha} \right) 
\to \prod_{\alpha} (M \otimes_{R} Q_{\alpha})$ is bijective.
\item For every $R$-module $Q$ and every set $A$, the canonical map $M 
\otimes_{R} Q^{A} \to (M \otimes_{R} Q)^{A}$ is bijective.
\item For every set $A$, the canonical map $M \otimes_{R} R^{A} \to 
M^{A}$ is bijective.
\end{enumerate}
\end{proposition}

\begin{proof}
First we prove (1) implies (2).  Choose a presentation $R^m \to R^n 
\to M$ and consider the commutative diagram
$$
\xymatrix{
R^m \otimes_{R} (\prod_{\alpha} Q_{\alpha}) \ar[r] \ar[d]^{\cong} & R^m 
\otimes_{R} (\prod_{\alpha} Q_{\alpha}) \ar[r] \ar[d]^{\cong} & M \otimes_{R} 
(\prod_{\alpha} Q_{\alpha}) \ar[r] \ar[d] & 0 \\
\prod_{\alpha} (R^m \otimes_{R} Q_{\alpha}) \ar[r] & \prod_{\alpha} (R^n 
\otimes_{R}Q_{\alpha}) \ar[r] & \prod_{\alpha} (M \otimes_{R} Q_{\alpha}) 
\ar[r] & 0.
}
$$
The first two vertical arrows are isomorphisms and the rows are exact.  This 
implies that the map
$M \otimes_{R} (\prod_{\alpha} Q_{\alpha}) \to
\prod_{\alpha} ( M \otimes_{R} Q_{\alpha})$
is surjective and, by a diagram chase, also injective.  Hence (2) holds.

\medskip\noindent
Obviously (2) implies (3) implies (4), so it remains to prove (4) implies (1).  
From Proposition \ref{proposition-fg-tensor}, if (4) holds we already know that 
$M$ is finitely generated.  So we can choose a surjection $F \to M$ 
where $F$ is free and finite.  Let $K$ be the kernel.  We must show $K$ is 
finitely generated.  For any set $A$, we have a commutative diagram
$$
\xymatrix{
& K \otimes_{R} R^A \ar[r] \ar[d]_{f_3} & F \otimes_{R} R^A \ar[r] 
\ar[d]_{f_2}^{\cong} & M \otimes_{R} R^A \ar[r] \ar[d]_{f_1}^{\cong} & 0 \\
0 \ar[r] & K^A \ar[r] & F^A \ar[r] & M^A \ar[r] & 0 .
}
$$
The map $f_1$ is an isomorphism by assumption, the map $f_2$ is a isomorphism 
since $F$ is free and finite, and the rows are exact.  A diagram chase shows 
that $f_3$ is surjective, hence by Proposition \ref{proposition-fg-tensor} we 
get that $K$ is finitely generated. 
\end{proof}

\noindent
We need the following lemma for the next proposition.

\begin{lemma}
\label{lemma-kernel-tensored-fp}
Let $M$ be an $R$-module, $P$ a finitely presented $R$-module, and $f: P 
\to M$ a map.  Let $Q$ be an $R$-module and suppose $x \in \ker(P 
\otimes Q \to M \otimes Q)$.  Then there exists a finitely presented 
$R$-module $P'$ and a map $f': P \to P'$ such that $f$ factors through 
$f'$ and $x \in \ker(P \otimes Q \to P' \otimes Q)$.  
\end{lemma}

\begin{proof}
Write $M$ as a colimit $M = \text{colim}_{i \in I} M_i$ of a directed system of 
finitely presented modules $M_i$.  Since $P$ is finitely presented, the map $f: 
P \to M$ factors through $M_j \to M$ for some $j \in I$.  Upon 
tensoring by $Q$ we have a commutative diagram
$$ 
\xymatrix{
& M_j \otimes Q \ar[dr] & \\
P \otimes Q \ar[ur] \ar[rr] & & M \otimes Q .
}
$$
The image $y$ of $x$ in $M_j \otimes Q$ is in the kernel of $M_j \otimes Q 
\to M \otimes Q$.  Since $M \otimes Q = \text{colim}_{i \in I} (M_i 
\otimes 
Q)$, this means $y$ maps to $0$ in $M_{j'} \otimes Q$ for some $j' \geq j$.  
Thus we may take $P' = M_{j'}$ and $f'$ to be the composite $P \to M_j 
\to M_{j'}$.
\end{proof}

\begin{proposition}
\label{proposition-ML-tensor}
Let $M$ be an $R$-module.  The following are equivalent:
\begin{enumerate}
\item $M$ is Mittag-Leffler.
\item For every family $(Q_{\alpha})_{\alpha \in A}$ of $R$-modules, the 
canonical map $M \otimes_{R} \left( \prod_{\alpha} Q_{\alpha} \right) 
\to \prod_{\alpha} (M \otimes_{R} Q_{\alpha})$ is injective.
\end{enumerate}
\end{proposition}

\begin{proof}
First we prove (1) implies (2).  Suppose $M$ is Mittag-Leffler and let $x$ be 
in the kernel of $M \otimes_{R} (\prod_{\alpha} Q_{\alpha}) \to 
\prod_{\alpha} (M \otimes_{R} Q_{\alpha})$.  Write $M$ as a colimit $M = 
\text{colim}_{i \in I} M_i$ of a directed system of finitely presented modules 
$M_i$. 
 Then $M \otimes_{R} (\prod_{\alpha} Q_{\alpha})$ is the colimit of $M_i 
\otimes_{R} (\prod_{\alpha} Q_{\alpha})$.  So $x$ is the image of an element 
$x_i \in M_i \otimes_{R} (\prod_{\alpha} Q_{\alpha})$.  We must show that $x_i$ 
maps to $0$ in $M_j \otimes_{R} (\prod_{\alpha} Q_{\alpha})$ for some $j \geq 
i$.  Since $M$ is Mittag-Leffler, we may choose $j \geq i$ such that $M_{i} 
\to M_j$ and $M_i \to M$ dominate each other.  Then consider 
the commutative diagram
$$
\xymatrix{
M \otimes_{R} (\prod_{\alpha} Q_{\alpha}) \ar[r] & \prod_{\alpha} (M 
\otimes_{R} Q_{\alpha}) \\
M_i \otimes_{R} (\prod_{\alpha} Q_{\alpha}) \ar[r]^{\cong} \ar[d] \ar[u] & 
\prod_{\alpha} (M_i \otimes_{R} Q_{\alpha}) \ar[d] \ar[u] \\
M_j \otimes_{R} (\prod_{\alpha} Q_{\alpha}) \ar[r]^{\cong} & \prod_{\alpha} 
(M_j \otimes_{R} Q_{\alpha})
}
$$
whose bottom two horizontal maps are isomorphisms, according to Proposition 
\ref{proposition-fp-tensor}.  Since $x_i$ maps to $0$ in $\prod_{\alpha} (M 
\otimes_{R} Q_{\alpha})$, its image in $\prod_{\alpha} (M_i \otimes_{R} 
Q_{\alpha})$ is in the kernel of the map $\prod_{\alpha} (M_i \otimes_{R} 
Q_{\alpha}) \to \prod_{\alpha} (M \otimes_{R} Q_{\alpha})$.  But this 
kernel equals the kernel of $\prod_{\alpha} (M_i \otimes_{R} Q_{\alpha}) 
\to \prod_{\alpha} (M_j \otimes_{R} Q_{\alpha})$ according to the 
choice of $j$.  Thus $x_i$ maps to $0$ in $\prod_{\alpha} (M_j \otimes_{R} 
Q_{\alpha})$ and hence to $0$ in $M_j \otimes_{R} (\prod_{\alpha} Q_{\alpha})$.

\medskip\noindent
Now suppose (2) holds. We prove $M$ satisfies formulation (1) of being 
Mittag-Leffler from Proposition \ref{proposition-ML-characterization}.  Let $f: 
P \to M$ be a map from a finitely presented module $P$ to $M$.  Choose 
a set $B$ of representatives of the isomorphism classes of finitely presented 
$R$-modules. Let $A$ be the set of pairs $(Q,x)$ where $Q \in B$ and $x \in 
\ker(P \otimes Q \to M \otimes Q)$.  For $\alpha = (Q,x) \in A$, we 
write $Q_{\alpha}$ for $Q$ and $x_{\alpha}$ for $x$.  Consider the commutative 
diagram
$$
\xymatrix{
M \otimes_{R} (\prod_{\alpha} Q_{\alpha}) \ar[r] &
\prod_{\alpha} (M \otimes_{R} Q_{\alpha}) \\
P \otimes_{R} (\prod_{\alpha} Q_{\alpha}) \ar[r]^{\cong} \ar[u] & 
\prod_{\alpha} (P \otimes_{R} Q_{\alpha}) \ar[u] .
}
$$
The top arrow is an injection by assumption, and the bottom arrow is an 
isomorphism by Proposition \ref{proposition-fp-tensor}.  Let $x \in P 
\otimes_{R} (\prod_{\alpha} Q_{\alpha})$ be the element corresponding to 
$(x_{\alpha}) \in \prod_{\alpha} (P \otimes_{R} Q_{\alpha})$ under this 
isomorphism.  Then $x \in \ker( P \otimes_{R} (\prod_{\alpha} Q_{\alpha}) 
\to M \otimes_{R} (\prod_{\alpha} Q_{\alpha}))$ since the top arrow in 
the diagram is injective.  By Lemma \ref{lemma-kernel-tensored-fp}, we get a 
finitely presented module $P'$ and a map $f': P \to P'$ such that $f: P 
\to M$ factors through $f'$ and $x \in \ker(P \otimes_{R} 
(\prod_{\alpha} Q_{\alpha}) \to P' \otimes_{R} (\prod_{\alpha} 
Q_{\alpha}))$.  We have a commutative diagram
$$
\xymatrix{
P' \otimes_{R} (\prod_{\alpha} Q_{\alpha}) \ar[r]^{\cong} &
\prod_{\alpha} (P' \otimes_{R} Q_{\alpha}) \\
P \otimes_{R} (\prod_{\alpha} Q_{\alpha}) \ar[r]^{\cong} \ar[u] & 
\prod_{\alpha} (P \otimes_{R} Q_{\alpha}) \ar[u] .
}
$$
where both the top and bottom arrows are isomorphisms by Proposition 
\ref{proposition-fp-tensor}.  Thus since $x$ is in the kernel of the left 
vertical map, $(x_{\alpha})$ is in the kernel of the right vertical map.  This 
means $x_{\alpha} \in \ker(P \otimes_{R} Q_{\alpha} \to P' \otimes_{R} 
Q_{\alpha})$ for every $\alpha \in A$.  By the definition of $A$ this means 
$\ker(P \otimes_{R} Q \to P' \otimes_{R} Q) \subset \ker(P \otimes_{R} 
Q \to M \otimes_{R} Q)$ for all finitely presented $Q$ and, since $f: P 
\to M$ factors through $f': P \to P'$, actually equality holds. 
 By Lemma \ref{lemma-domination-fp}, $f$ and $f'$ dominate each other.
\end{proof}

\begin{lemma}
\label{lemma-pure-submodule-ML}
Let $0 \to M_1 \to M_2 \to M_3 \to 0$ be a 
universally exact sequence of $R$-modules.  Then:
\begin{enumerate}
\item If $M_2$ is Mittag-Leffler, then $M_1$ is Mittag-Leffler.
\item If $M_1$ and $M_3$ are Mittag-Leffler, then $M_2$ is Mittag-Leffler.
\end{enumerate}
\end{lemma}

\begin{proof}
For any family $(Q_{\alpha})_{\alpha \in A}$ of $R$-modules we have a 
commutative diagram
$$
\xymatrix{
0 \ar[r] & M_1 \otimes_{R} (\prod_{\alpha} Q_{\alpha}) \ar[r] \ar[d] & M_2 
\otimes_{R} (\prod_{\alpha} Q_{\alpha}) \ar[r] \ar[d] & M_3 \otimes_{R} 
(\prod_{\alpha} Q_{\alpha}) \ar[r] \ar[d] & 0 \\
0 \ar[r] & \prod_{\alpha}(M_1 \otimes Q_{\alpha}) \ar[r] & \prod_{\alpha}(M_2 
\otimes Q_{\alpha}) \ar[r] & \prod_{\alpha}(M_3 \otimes Q_{\alpha})\ar[r] & 0
}
$$
with exact rows. Thus (1) and (2) follow from Proposition 
\ref{proposition-ML-tensor}.
\end{proof}

\begin{lemma}
\label{lemma-direct-sum-ML}
If $M = \bigoplus_{i \in I} M_{i}$ is a direct sum of $R$-modules, then $M$ is 
Mittag-Leffler if and only if each $M_i$ is Mittag-Leffler.
\end{lemma}

\begin{proof}
The ``only if'' direction follows from Lemma \ref{lemma-pure-submodule-ML} (1) 
and the fact that a split short exact sequence is universally exact.  For the 
converse, first note that if $I$ is finite then this follows from Lemma 
\ref{lemma-pure-submodule-ML} (2).  For general $I$, if all $M_i$ are 
Mittag-Leffler then we prove the same of $M$ by verifying condition (1) of 
Proposition \ref{proposition-ML-characterization}.  Let $f: P \to M$ be 
a map from a finitely presented module $P$.  Then $f$ factors as $P 
\xrightarrow{f'} \bigoplus_{i' \in I'} M_{i'} \hookrightarrow \bigoplus_{i \in 
I} M_i$ for some finite subset $I'$ of $I$.  By the finite case $\bigoplus_{i' 
\in I'} M_{i'}$ is Mittag-Leffler and hence there exists a finitely presented 
module $Q$ and a map $g: P \to Q$ such that $g$ and $f'$ dominate each 
other.  Then also $g$ and $f$ dominate each other.
\end{proof}


\section{Coherent rings}
\label{section-coherent}

\noindent
We use the discussion on interchanging $\prod$ and $\otimes$ to determine
for which rings products of flat modules are flat. It turns out that these
are the so-called coherent rings. You may be more familiar with the notion
of a coherent $\mathcal{O}_X$-module on a ringed space, see
Modules, Section \ref{section-coherent}.

\begin{definition}
\label{definition-coherent}
Let $R$ be a ring. Let $M$ be an $R$-module.
\begin{enumerate}
\item We say $M$ is a {\it coherent module} if it is finitely generated
and every finitely generated submodule of $M$ is finitely presented over
$R$.
\item We say $R$ is a {\it coherent ring} if it is coherent as a module
over itself.
\end{enumerate}
\end{definition}

\noindent
Thus a ring is coherent if and only if every finitely generated ideal is
finitely presented as a module.
The category of coherent modules is abelian.

\begin{lemma}
\label{lemma-coherent}
Let $R$ be a ring.
\begin{enumerate}
\item A finite type submodule of a coherent module is coherent.
\item Let $\varphi : N \to M$ be a homomorphism from a finite
module to a coherent module. Then $\text{Ker}(\varphi)$ is finite.
\item Let $\varphi : N \to M$ be a homomorphism of coherent modules.
Then $\text{Ker}(\varphi)$ and $\text{Coker}(\varphi)$ are coherent
modules.
\item The category of coherent modules is an abelian subcategory of
$\text{Mod}_R$.
\item Given a short exact sequence of $R$-modules
$0 \to M_1 \to M_2 \to M_3 \to 0$ if two out of three are coherent
so is the third.
\end{enumerate}
\end{lemma}

\begin{proof}
The first statement is immediate from the definition.
During the rest of the proof we will use the results of
Lemma \ref{lemma-extension}
without further mention.

\medskip\noindent
Let $\varphi : N \to M$ satisfy the assumptions of (2).
Suppose that $N$ is generated by $x_1, \ldots, x_n$. By
Definition \ref{definition-coherent}
the kernel $K$ of the induced map $\bigoplus_{i = 1}^n R \to M$,
$e_i \mapsto \varphi(x_i)$ is of finite type.
Hence $\text{Ker}(\varphi)$ which is the image of the
composition $K \to \bigoplus_{i = 1}^n R \to N$
is of finite type. This proves (2).

\medskip\noindent
Let $\varphi : N \to M$ satisfy the assumptions of (3).
By (2) the kernel of $\varphi$ is of finite type and
hence by (1) it is coherent.

\medskip\noindent
With the same hypotheses
let us show that $\text{Coker}(\varphi)$ is coherent.
Since $M$ is finite so is $\text{Coker}(\varphi)$.
Let $\overline{x}_i \in \text{Coker}(\varphi)$.
We have to show that the kernel of the associated morphism
$\overline{\Psi} : \bigoplus_{i = 1}^n R \to \text{Coker}(\varphi)$
is finite. Choose $x_i \in M$ lifting $\overline{x}_i$.
Thus $\overline{\Psi}$ lifts to $\Psi : \bigoplus_{i = 1}^n R \to M$.
Consider the following diagram
$$
\xymatrix{
0 \ar[r] &
\text{Ker}(\Psi) \ar[r] \ar[d] &
\bigoplus_{i = 1}^n R \ar[r] \ar@{=}[d] &
R \ar[r] \ar[d] &
0 \\
0 \ar[r] &
\text{Ker}(\overline{\Psi}) \ar[r] &
\bigoplus_{i = 1}^n R \ar[r] &
\text{Coker}(\varphi) \ar[r] &
0
}
$$
By the snake lemma we get a short exact sequence
$0 \to \text{Ker}(\Psi) \to \text{Ker}(\overline{\Psi})
\to \text{Im}(\varphi) \to 0$. Hence we see that
$\text{Ker}(\overline{\Psi})$ is finite.

\medskip\noindent
Statement (4) follows from (3).

\medskip\noindent
Let $0 \to M_1 \to M_2 \to M_3 \to 0$
be a short exact sequence of $R$-modules. It suffices
to prove that if $M_1$ and $M_3$ are coherent
so is $M_2$. By
Lemma \ref{lemma-extension}
we see that $M_2$ is finite. Let $x_1, \ldots, x_n$ be finitely many
elements of $M_2$.
We have to show that the module of relations $K$
between them is finite.
Consider the following commutative diagram
$$
\xymatrix{
0 \ar[r] &
0 \ar[r] \ar[d] &
\bigoplus_{i = 1}^{n} R \ar[r] \ar[d] &
\bigoplus_{i = 1}^{n} R \ar[r] \ar[d] &
0 \\
0 \ar[r] &
M_1 \ar[r] &
M_2 \ar[r] &
M_3 \ar[r] &
0
}
$$
with obvious notation. By the snake lemma we get an exact sequence
$0 \to K \to K_3 \to M_1$
where $K_3$ is the module of relations among
the images of the $x_i$ in $M_3$.
Since $M_3$ is coherent we see that
$K_3$ is a finite module. Since $M_1$
is coherent we see that the image $I$
of $K_3 \to M_1$
is coherent. Hence $K$
is the kernel of the map $K_3 \to I$
between a finite module and a coherent module and hence
finite by (2).
\end{proof}

\begin{lemma}
\label{lemma-coherent-ring}
Let $R$ be a ring. If $R$ is coherent, then a module is coherent
if and only if it is finitely presented.
\end{lemma}

\begin{proof}
It is clear that a coherent module is finitely presented (over any ring).
Coversely, if $R$ is coherent, then $R^{\oplus n}$ is coherent and so is
the cokernel of any map $R^{\oplus m} \to R^{\oplus n}$, see
Lemma \ref{lemma-coherent}.
\end{proof}

\begin{lemma}
\label{lemma-Noetherian-coherent}
A Noetherian ring is a coherent ring.
\end{lemma}

\begin{proof}
By
Lemma \ref{lemma-Noetherian-finite-type-is-finite-presentation}
any finite $R$-module is finitely presented. In particular any ideal of $R$
is finitely presented.
\end{proof}

\begin{proposition}
\label{proposition-characterize-coherent}
Let $R$ be a ring. The following are equivalent
\begin{enumerate}
\item $R$ is coherent,
\item any product of flat $R$-modules is flat, and
\item for every set $A$ the module $R^A$ is flat.
\end{enumerate}
\end{proposition}

\begin{proof}
Assume $R$ coherent, and let $Q_\alpha$, $\alpha \in A$ be a set of flat
$R$-modules. We have to show that
$I \otimes_R \prod_\alpha Q_\alpha \to \prod Q_\alpha$ is injective
for every finitely generated ideal $I$ of $R$, see
Lemma \ref{lemma-flat}.
Since $R$ is coherent $I$ is an $R$-module of finite presentation.
Hence $I \otimes_R \prod_\alpha Q_\alpha = \prod I \otimes_R Q_\alpha$ by
Proposition \ref{proposition-fp-tensor}.
The desired injectivity follows as $I \otimes_R Q_\alpha \to Q_\alpha$
is injective by flatness of $Q_\alpha$.

\medskip\noindent
The implication (2) $\Rightarrow$ (3) is trivial.

\medskip\noindent
Assume that the $R$-module $R^A$ is flat for every set $A$. Let $I$
be a finitely generated ideal in $R$. Then $I \otimes_R R^A \to R^A$
is injective by assumption. By
Proposition \ref{proposition-fg-tensor}
and the finiteness of $I$ the image is equal to $I^A$. Hence
$I \otimes_R R^A = I^A$ for every set $A$ and we conclude that $I$
is finitely presented by
Proposition \ref{proposition-fp-tensor}.
\end{proof}







\section{Examples and non-example of Mittag-Leffler modules}
\label{section-examples}

\noindent
We end this section with some examples and non-examples of Mittag-Leffler 
modules.

\begin{example}
\label{example-ML}
Mittag-Leffler modules.
\begin{enumerate}
\item Any finitely presented module is Mittag-Leffler.  This follows, for 
instance, from Proposition \ref{proposition-ML-characterization} (1).  In 
general, it is true that a finitely generated module is Mittag-Leffler if and 
only it is finitely presented.  This follows from Propositions 
\ref{proposition-fg-tensor}, \ref{proposition-fp-tensor}, and 
\ref{proposition-ML-tensor}.

\item A free module is Mittag-Leffler since it satisfies condition (1) of 
Proposition \ref{proposition-ML-characterization}.

\item By the previous example together with Lemma \ref{lemma-direct-sum-ML}, 
projective modules are Mittag-Leffler. 
\end{enumerate}
\end{example}

\noindent
We also want to add to our list of examples power series rings over a 
Noetherian ring $R$.  This will be a consequence the following lemma.

\begin{lemma}
\label{lemma-flat-ML-criterion}
Let $M$ be a flat $R$-module.  Suppose the following condition holds: if $F$ is 
a free finite $R$-module and $x \in F \otimes_{R} M$, then there exists a 
smallest submodule $F'$ of $F$ such that $x \in F' \otimes_{R} M$.  Then $M$ is 
Mittag-Leffler.
\end{lemma}

\begin{proof}
By Theorem \ref{theorem-lazard} we can write $M$ as the colimit $M = 
\text{colim}_{i 
\in I} M_i$ of a directed system $(M_i, f_{ij})$ of free finite $R$-modules.  
By Remark \ref{remark-flat-ML}, it suffices to show that the inverse system 
$(\text{Hom}_{R}(M_i, R), \text{Hom}_{R}(f_{ij},R))$ is Mittag-Leffler.  In 
other words, 
fix $i \in I$ and for $j \geq i$ let $Q_j$ be the image of 
$\text{Hom}_{R}(M_j,R) 
\to \text{Hom}_{R}(M_i,R)$; we must show that the $Q_{j}$ stabilize.  

\medskip\noindent
Since $M_i$ is free and finite, we can make the identification 
$\text{Hom}_{R}(M_i,M_j) = \text{Hom}_{R}(M_i,R) \otimes_{R}  M_j$ for all $j$. 
 Using the 
fact that the $M_j$ are free, it follows that for $j \geq i$, $Q_j$ is the 
smallest submodule of $\text{Hom}_{R}(M_i,R)$ such that $f_{ij} \in Q_j 
\otimes_{R} 
M_j$.  Under the identification $\text{Hom}_{R}(M_i,M) = \text{Hom}_{R}(M_i,R) 
\otimes_{R} 
M$, the canonical map $f_i: M_i \to M$ is in $\text{Hom}_{R}(M_i,R) 
\otimes_{R} M$.  By the assumption on $M$, there exists a smallest submodule 
$Q$ of $\text{Hom}_{R}(M_i,R)$ such that $f_i \in Q \otimes_{R} M$.  We are 
going to 
show that the $Q_j$ stabilize to $Q$.

\medskip\noindent
For $j \geq i$ we have a commutative diagram
$$ 
\xymatrix{
Q_j \otimes_{R} M_j \ar[r] \ar[d] & \text{Hom}_{R}(M_i,R) \otimes_{R} M_j 
\ar[d] \\
Q_j \otimes_{R} M \ar[r] & \text{Hom}_{R}(M_i,R) \otimes_{R} M.
}
$$
Since $f_{ij} \in Q_j \otimes_{R} M_j$ maps to $f_i \in \text{Hom}_{R}(M_i,R) 
\otimes_{R} M$, it follows that $f_i \in Q_j \otimes_{R} M$.  Hence, by the 
choice of $Q$, we have $Q \subset Q_j$ for all $j \geq i$.

\medskip\noindent
Since the $Q_j$ are decreasing and $Q \subset Q_j$ for all $j \geq i$, to show 
that the $Q_j$ stabilize to $Q$ it suffices to find a $j \geq i$ such that $Q_j 
\subset Q$.  As an element of
$$ 
\text{Hom}_{R}(M_i,R) \otimes_{R} M = \text{colim}_{j \in J} 
(\text{Hom}_{R}(M_i,R) \otimes_{R} 
M_j),
$$
$f_i$ is the colimit of $f_{ij}$ for $j \geq i$, and $f_i$ also lies in the 
submodule
$$ 
\text{colim}_{j \in J} (Q \otimes_{R} M_j) \subset \text{colim}_{j \in J} 
(\text{Hom}_{R}(M_i,R) 
\otimes_{R} M_j).
$$
It follows that for some $j \geq i$, $f_{ij}$ lies in $Q \otimes_{R} M_j$.  
Since $Q_{j}$ is the smallest submodule of $\text{Hom}_{R}(M_i,R)$ with $f_{ij} 
\in 
Q_j \otimes_{R} M_j$, we conclude $Q_j\subset Q$.
\end{proof}

\begin{lemma}
\label{lemma-power-series-ML}
Let $R$ be a Noetherian ring and $n$ a positive integer.  Then the $R$-module 
$M = R[[t_1, \dots, t_n]]$ is flat and Mittag-Leffler.
\end{lemma}

\begin{proof}
Since $M$ is the completion of the Noetherian ring $R[t_1,\dots,t_n]$ with 
respect to the ideal $(t_1, \dots, t_n)$, $M$ is flat over $R[t_1, \dots, 
t_n]$.  Thus since $R[t_1, \dots, t_n]$ is flat over $R$, so is $M$.  We show 
that $M$ satisfies the condition of Lemma \ref{lemma-flat-ML-criterion}.  Let 
$F$ be a free finite $R$-module.  As an $R$-module, we make the identification 
$M = R^{I}$ for a (countable) set $I$.  If $F'$ is any submodule of $F$ then it 
is finitely presented since $R$ is Noetherian.  So by Proposition 
\ref{proposition-fp-tensor} we have a commutative diagram
$$
\xymatrix{
F' \otimes_{R} M \ar[r] \ar[d]^{\cong} & F \otimes_{R} M \ar[d]^{\cong} \\
(F')^I \ar[r] & F^I
}
$$
by which we can identify the map $F' \otimes_{R} M \to F \otimes_{R} M$ 
with $(F')^I \to F^I$.  Hence if $x \in F \otimes_{R} M$ corresponds to 
$(x_i) \in F^I$, then the submodule of $F'$ of $F$ generated by the $x_i$ is 
the smallest submodule of $F$ such that $x \in F' \otimes_{R} M$.
\end{proof}

\begin{example}
\label{example-not-ML}
Non Mittag-Leffler modules.
\begin{enumerate}
\item By Example \ref{example-Q-not-ML} and Proposition 
\ref{proposition-ML-tensor}, $\mathbf{Q}$ is not a Mittag-Leffler 
$\mathbf{Z}$-module.
\item We prove below (Theorem \ref{theorem-projectivity-characterization}) that 
for a flat and countably generated module, projectivity is equivalent to being 
Mittag-Leffler.  Thus any flat, countably generated, non-projective module $M$ 
is an example of a non-Mittag-Leffler module.  For such an example, see 
Remark \ref{remark-warning}.
\end{enumerate}
\end{example}




\section{Characterizing projective modules}
\label{section-characterize-projective}

\noindent
The goal of this section is to prove that a module is projective if and only if 
it is flat, Mittag-Leffler, and a direct sum of countably generated modules 
(Theorem \ref{theorem-projectivity-characterization} below).

\begin{lemma}
\label{lemma-ML-countable-colimit}
Let $M$ be an $R$-module.  Write $M = \text{colim}_{i \in I} M_i$ where $(M_i, 
f_{ij})$ is a directed system of finitely presented $R$-modules.  If $M$ is 
Mittag-Leffler and countably generated, then there is a directed countable 
subset $I' \subset I$ such that $M \cong \text{colim}_{i \in I'} M_i$.
\end{lemma}

\begin{proof}
Let $x_1,x_2, \dots$ be a countable set of generators for $M$.  For each $x_n$ 
choose $i \in I$ such that $x_n$ is in the image of the canonical map $f_{i}: 
M_{i} \to M$; let $I'_{0} \subset I$ be the set of all these $i$.  Now 
since $M$ is Mittag-Leffler, for each $i \in I'_{0}$ we can choose $j \in I$ 
such that $j \geq i$ and $f_{ij}: M_{i} \to M_{j}$ factors through 
$f_{ik}: M_i \to M_k$ for all $k \geq i$  (condition (3) of Proposition 
\ref{proposition-ML-characterization}); let $I'_1$ be the union of $I'_0$ with 
all of these $j$.  Since $I'_1$ is a countable, we can enlarge it to a 
countable directed set $I'_{2} \subset I$.  Now we can apply the same procedure 
to $I'_{2}$ as we did to $I'_{0}$ to get a new countable set $I'_{3} \subset 
I$.  Then we enlarge $I'_{3}$ to a countable directed set $I'_{4}$.  Continuing 
in this way---adding in a $j$ as in Proposition 
\ref{proposition-ML-characterization} (3) for each $ i \in I'_{\ell}$ if $\ell$ 
is odd and enlarging $I'_{\ell}$ to a directed set if $\ell$ is even---we get a 
sequence of subsets $I'_{\ell} \subset I$ for $\ell \geq 0$.  The union $I' = 
\bigcup I'_{\ell}$ satisfies: 
\begin{enumerate}
\item $I'$ is countable and directed; 
\item each $x_{n}$ is in the image of $f_{i}: M_i \to M$ for some $i 
\in I'$;
\item if $i \in I'$, then there is $j \in I'$ such that $j \geq i$ and $f_{ij}: 
M_{i} \to M_{j}$ factors through $f_{ik}: M_i \to M_k$ for all 
$k \in I$ with $k \geq i$.  In particular $\ker(f_{ik}) \subset \ker(f_{ij})$ 
for $k \geq i$.
\end{enumerate}
We claim that the canonical map $\text{colim}_{i \in I'} M_i \to 
\text{colim}_{i 
\in I} M_i = M$ is an isomorphism.  By (2) it is surjective.  For injectivity, 
suppose $x \in \text{colim}_{i \in I'} M_i$ maps to $0$ in $\text{colim}_{i \in 
I} M_i$.  
Representing $x$ by an element $\tilde{x} \in M_i$ for some $i \in I'$, this 
means that $f_{ik}(\tilde{x}) = 0$ for some $k \in I, k \geq i$.  But then by 
(3) there is $j \in I', j \geq i,$ such that $f_{ij}(\tilde{x}) = 0$.  Hence $x 
= 0$ in $\text{colim}_{i \in I'} M_i$.
\end{proof}

\begin{lemma}
\label{lemma-countgen-projective}
Let $M$ be an $R$-module.  If $M$ is flat, Mittag-Leffler, and countably 
generated, then $M$ is projective.
\end{lemma}

\begin{proof}
By Lazard's theorem (Theorem \ref{theorem-lazard}), we can write $M = 
\text{colim}_{i 
\in I} M_i$ for a directed system of finite free $R$-modules $(M_i, f_{ij})$ 
indexed by a set $I$.  By Lemma \ref{lemma-ML-countable-colimit}, we may assume 
$I$ is countable.  Now let
$$
0 \to N_1 \to N_2 \to N_3 \to 0
$$
be an exact sequence of $R$-modules.  We must show that applying 
$\text{Hom}_R(M,-)$ 
preserves exactness.  Since $M_i$ is finite free,
$$
0 \to \text{Hom}_R(M_i,N_1) \to \text{Hom}_R(M_i,N_2) \to 
\text{Hom}_R(M_i,N_3) \to 0
$$
is exact for each $i$.  Since $M$ is Mittag-Leffler, $(\text{Hom}_R(M_i, 
N_{1}))$ is 
a Mittag-Leffler inverse system.  So by Lemma \ref{lemma-ML-exact-sequence}, 
$$
0 \to \lim_{i \in I} \text{Hom}_R(M_i,N_1) \to
\lim_{i \in I} \text{Hom}_R(M_i,N_2) \to
\lim_{i \in I} \text{Hom}_R(M_i,N_3) \to 0
$$
is exact.  But for any $R$-module $N$ there is a functorial isomorphism 
$\text{Hom}_R(M,N) \cong \lim_{i \in I} \text{Hom}_R(M_i,N)$, so
$$
0 \to \text{Hom}_R(M,N_1) \to \text{Hom}_R(M,N_2) \to 
\text{Hom}_R(M,N_3) \to 0
$$
is exact.
\end{proof}

\begin{remark}
\label{remark-characterize-projective}
Lemma \ref{lemma-countgen-projective} does not hold without the countable 
generation assumption.  For example, the $\mathbf Z$-module $M = 
\mathbf{Z}[[x]]$ is flat and Mittag-Leffler but not projective.  It is 
Mittag-Leffler by Lemma \ref{lemma-power-series-ML}.  Subgroups of free abelian 
groups are free, hence a projective $\mathbf Z$-module is in fact free and so 
are its submodules.  Thus to show $M$ is not projective it suffices to produce 
a non-free submodule.  Fix a prime $p$ and consider the submodule $N$ 
consisting of power series $f(x) = \sum a_i x^i$ such that for every integer $m 
\geq 1$, $p^m$ divides $a_i$ for all but finitely many $i$.  Then $\sum a_i p^i 
x^i$ is in $N$ for all $a_i \in \mathbf{Z}$, so $N$ is uncountable.  Thus if 
$N$ were free it would have uncountable rank and the dimension of $N/pN$ over 
$\mathbf{Z}/p$ would be uncountable.  This is not true as the elements $x^i \in 
N/pN$ for $i \geq 0$ span $N/pN$.
\end{remark}

\begin{theorem}
\label{theorem-projectivity-characterization}
Let $M$ be an $R$-module.  Then $M$ is projective if and only it satisfies:
\begin{enumerate}
\item $M$ is flat,
\item $M$ is Mittag-Leffler, 
\item $M$ is a direct sum of countably generated $R$-modules.
\end{enumerate}
\end{theorem}

\begin{proof}
First suppose $M$ is projective.  Then $M$ is a direct summand of a free 
module, so $M$ is flat and Mittag-Leffler since these properties pass to direct 
summands. By Kaplansky's theorem (Theorem \ref{theorem-projective-direct-sum}), 
$M$ satisfies (3).

\medskip\noindent
Conversely, suppose $M$ satisfies (1)-(3).  Since being flat and Mittag-Leffler 
passes to direct summands, $M$ is a direct sum of flat, Mittag-Leffler, 
countably generated $R$-modules.  Thus by the previous lemma $M$ is a direct 
sum of projective modules.  Hence $M$ is projective.
\end{proof}

\begin{lemma}
\label{lemma-ML-ui-descent}
Let $f: M \to N$ be universally injective map of $R$-modules.  Suppose 
$M$ is a direct sum of countably generated $R$-modules, and suppose $N$ is flat 
and Mittag-Leffler.  Then $M$ is projective. 
\end{lemma}

\begin{proof}
By Lemmas \ref{lemma-ui-flat-domain} and \ref{lemma-pure-submodule-ML}, $M$ is 
flat and Mittag-Leffler, so the conclusion follows from Theorem 
\ref{theorem-projectivity-characterization}.
\end{proof}

\begin{lemma}
\label{lemma-universally-injective-submodule-powerseries}
Let $R$ be a Noetherian ring and let $M$ be a $R$-module.  Suppose $M$ is a 
direct sum of countably generated $R$-modules, and suppose there is a 
universally injective map $M \to R[[t_1, \dots, t_n]]$ for some $n$.  
Then $M$ is projective.  
\end{lemma}

\begin{proof}
Follows from the previous lemma and Lemma \ref{lemma-power-series-ML}.
\end{proof}



\section{Ascending properties of modules}
\label{section-ascent}

\noindent
All of the properties of a module in Theorem 
\ref{theorem-projectivity-characterization} ascend along arbitrary ring maps:

\begin{lemma}
\label{lemma-ascend-properties-modules}
Let $R \to S$ be a ring map.  Let $M$ be an $R$-module.  Then:
\begin{enumerate}
\item If $M$ is flat, then the $S$-module $M \otimes_{R} S$ is flat.
\item If $M$ is Mittag-Leffler, then the $S$-module $M \otimes_{R} S$ is 
Mittag-Leffler.
\item If $M$ is a direct sum of countably generated $R$-modules, then the 
$S$-module $M \otimes_{R} S$ is a direct sum of countably generated $S$-modules.
\item If $M$ is projective, then the $S$-module $M \otimes_{R} S$ is projective.
\end{enumerate}
\end{lemma}

\begin{proof}
All are obvious except (2).  For this, use formulation (3) of being 
Mittag-Leffler from Proposition \ref{proposition-ML-characterization} and the 
fact that tensoring commutes with taking colimits.
\end{proof}



\section{Descending properties of modules}
\label{section-descent}

\noindent
We address the faithfully flat descent of the properties from Theorem 
\ref{theorem-projectivity-characterization} that characterize projectivity.
In the presence of flatness, the property of being a Mittag-Leffler module 
descends:

\begin{lemma}
\label{lemma-ffdescent-flat-ML}
Let $R \to S$ be a faithfully flat ring map.  Let $M$ be an $R$-module. 
 If the $S$-module $M \otimes_{R} S$ is flat and Mittag-Leffler, then $M$ is 
flat and Mittag-Leffler. 
\end{lemma}

\begin{proof}
By
Lemma \ref{lemma-descend-properties-modules},
flatness descends, so $M$ is flat.  Thus by Lazard's 
theorem (Theorem \ref{theorem-lazard}) we can write $M = \text{colim}_{i \in I} 
M_i$ 
where $(M_i,f_{ij})$ is a directed system of free finite $R$-modules.  
According to Remark \ref{remark-flat-ML}, to prove $M$ is Mittag-Leffler it is 
enough to show that $(\text{Hom}_{R}(M_i,R))$ is a Mittag-Leffler inverse 
system.

\medskip\noindent
Since tensoring commutes with colimits, $M \otimes_{R} S = \text{colim} (M_i 
\otimes_{R} S)$.  Since $M \otimes_{R} S$ is Mittag-Leffler this means 
$(\text{Hom}_{S}(M_i \otimes_{R} S, S))$ is a Mittag-Leffler inverse system.  
So for 
every $i \in I$, the family $\text{Im}(\text{Hom}_{S}(M_j \otimes_{R} S, S) 
\to \text{Hom}_{S}(M_i \otimes_{R} S, S))$ for $j \geq i$ stabilizes.  
Because $M_i$ is free and finite there is a functorial isomorphism 
$\text{Hom}_{S}(M_i \otimes_{R} S,S) \cong \text{Hom}_{R}(M_i,R) \otimes_{R} 
S$, and 
because $R \to S$ is faithfully flat, tensoring by $S$ commutes with 
taking the image of a module map.  Thus we find that for every $i \in I$, the 
family $\text{Im}(\text{Hom}_{R}(M_j, R) \to \text{Hom}_{R}(M_i, R)) 
\otimes_{R} S$ 
for $j \geq i$ stabilizes.  But if $N$ is an $R$-module and $N' \subset N$ a 
submodule such that $N' \otimes_{R} S = N \otimes_{R} S$, then $N' = N$ by 
faithful flatness of $S$.  We conclude that for every $i \in I$, the family 
$\text{Im}(\text{Hom}_{R}(M_j, R) \to \text{Hom}_{R}(M_i, R))$ for $j 
\geq i$ 
stabilizes.  So $M$ is Mittag-Leffler.
\end{proof}

\noindent
At this point the faithfully flat descent of countably generated projective 
modules follows easily.

\begin{lemma}
\label{lemma-ffdescent-countable-projectivity}
Let $R \to S$ be a faithfully flat ring map.  Let $M$ be an $R$-module. 
 If the $S$-module $M \otimes_{R} S$ is countably generated and projective, 
then $M$ is countably generated and projective. 
\end{lemma}

\begin{proof}
Follows from Lemma \ref{lemma-ffdescent-flat-ML}, the fact that countable 
generation descends, and Theorem \ref{theorem-projectivity-characterization}.
\end{proof}

\noindent
All that remains is to use d\'evissage to reduce descent of projectivity in the 
general case to the countably generated case.  First, two simple lemmas.

\begin{lemma}
\label{lemma-lift-countably-generated-submodule}
Let $R \to S$ be a ring map, let $M$ be an $R$-module, and let $Q$ be a 
countably generated $S$-submodule of $M \otimes_{R} S$.  Then there exists a 
countably generated $R$-submodule $P$ of $M$ such that $\textnormal{Im}(P 
\otimes_{R} S \to M \otimes_{R} S)$ contains $Q$.
\end{lemma}

\begin{proof}
Let $y_1, y_2, \dots$ be generators for $Q$ and write $y_{j} = \sum_{k} x_{jk} 
\otimes s_{jk}$ for some $x_{jk} \in M$ and $s_{jk} \in S$. Then take $P$ be 
the submodule of $M$ generated by the $x_{jk}$.
\end{proof}

\begin{lemma}
\label{lemma-adapted-submodule}
Let $R \to S$ be a ring map, and let $M$ be an $R$-module.  Suppose $M 
\otimes_{R} S = \bigoplus_{i \in I} Q_i$ is a direct sum of countably generated 
$S$-modules $Q_i$.  If $N$ is a countably generated submodule of $M$, then 
there is a countably generated submodule $N'$ of $M$ such that $N' \supset N$ 
and $\textnormal{Im}(N' \otimes_{R} S \to M \otimes_{R} S) = 
\bigoplus_{i \in I'} Q_i$ for some subset $I' \subset I$.
\end{lemma}

\begin{proof}
Let $N'_0 = N$.  We construct by induction an increasing sequence of countably 
generated submodules $N'_{\ell} \subset M$ for $\ell = 0,1,2, \dots$ such that: 
if $I'_{\ell}$ is the set of $i \in I$ such that the projection of 
$\text{Im}(N'_{\ell} \otimes_{R} S \to M \otimes_{R} S)$ onto $Q_i$ is 
nonzero, then $\text{Im}(N'_{\ell+1} \otimes_{R} S \to M \otimes_{R} 
S)$ contains $Q_i$ for all $i \in I'_{\ell}$.  To construct $N'_{\ell+1}$ from 
$N'_{\ell}$, let $Q$ be the sum of (the countably many) $Q_{i}$ for $i \in 
I'_{\ell}$, choose $P$ as in Lemma 
\ref{lemma-lift-countably-generated-submodule}, and then let $N'_{\ell + 1} = 
N'_{\ell} + P$.  Having constructed the $N'_{\ell}$, just take $N' = 
\bigcup_{\ell} N'_{\ell}$ and $I' = \bigcup_{\ell} I'_{\ell}$.
\end{proof}

\begin{theorem}
\label{theorem-ffdescent-projectivity}
Let $R \to S$ be a faithfully flat ring map.  Let $M$ be an $R$-module. 
 If the $S$-module $M \otimes_{R} S$ is projective, then $M$ is projective. 
\end{theorem}

\begin{proof}
We are going to construct a Kaplansky d\'evissage of $M$ to show that it is a 
direct sum of projective modules and hence projective.  By Theorem 
\ref{theorem-projective-direct-sum} we can write $M \otimes_{R} S = 
\bigoplus_{i \in I} Q_i$ as a direct sum of countably generated $S$-modules 
$Q_i$.  Choose a well-ordering on $M$.  By transfinite induction we are going 
to define an increasing family of submodules $M_{\alpha}$ of $M$, one for each 
ordinal $\alpha$, such that $M_{\alpha} \otimes_{R} S$ is a direct sum of some 
subset of the $Q_i$.

\medskip\noindent
For $\alpha = 0$ let $M_0 = 0$.  If $\alpha$ is a limit ordinal and $M_{\beta}$ 
has been defined for all $\beta < \alpha$, then define $M_{\beta} = 
\bigcup_{\beta < \alpha} M_{\beta}$.  Since each $M_{\beta} \otimes_{R} S$ for 
$\beta < \alpha$ is a direct sum of a subset of the $Q_i$, the same will be 
true of $M_{\alpha} \otimes_{R} S$.  If $\alpha+1$ is a successor ordinal and 
$M_{\alpha}$ has been defined, then define $M_{\alpha+1}$ as follows.  If 
$M_{\alpha} = M$, then let $M_{\alpha +1} = M$.  Otherwise choose the smallest 
$x \in M$ (with respect to the fixed well-ordering) such that $x \notin 
M_{\alpha}$. Since $S$ is flat over $R$, $(M/M_{\alpha}) \otimes_{R} S = M 
\otimes_{R} S/M_{\alpha} \otimes_{R} S$, so since $M_{\alpha} \otimes_{R} S$ is 
a direct sum of some $Q_{i}$, the same is true of $(M/M_{\alpha}) \otimes_{R} 
S$.   By Lemma \ref{lemma-adapted-submodule}, we can find a countably generated 
$R$-submodule $P$ of $M/M_{\alpha}$ containing the image of $x$ in 
$M/M_{\alpha}$ and such that $P \otimes_{R} S$ (which equals $\text{Im}(P 
\otimes_{R} S \to M \otimes_{R} S)$ since $S$ is flat over $R$) is a 
direct sum of some $Q_{i}$. Since $M \otimes_{R} S = \bigoplus_{i \in I} Q_i$ 
is projective and projectivity passes to direct summands, $P \otimes_{R} S$ is 
also projective.  Thus by Lemma \ref{lemma-ffdescent-countable-projectivity}, 
$P$ is projective.  Finally we define $M_{\alpha+1}$ to be the preimage of $P$ 
in $M$, so that $M_{\alpha+1}/M_{\alpha} = P$ is countably generated and 
projective.  In particular $M_{\alpha}$ is a direct summand of $M_{\alpha+1}$ 
since projectivity of $M_{\alpha+1}/M_{\alpha}$ implies the sequence $0 
\to M_{\alpha} \to M_{\alpha+1} \to 
M_{\alpha+1}/M_{\alpha} \to 0$ splits.

\medskip\noindent
Transfinite induction on $M$ (using the fact that we constructed $M_{\alpha+1}$ 
to contain the smallest $x \in M$ not contained in $M_{\alpha}$) shows that 
each $x \in M$ is contained in some $M_{\alpha}$.  Thus, there is some large 
enough ordinal $S$ satisfying: for each $x \in M$ there is $\alpha \in S$ such 
that $x \in M_{\alpha}$.  This means $(M_{\alpha})_{\alpha \in S}$ satisfies 
property (1) of a Kaplansky d\'evissage of $M$.  The other properties are clear 
by construction.  We conclude $M = \bigoplus_{\alpha+1 \in S} 
M_{\alpha+1}/M_{\alpha}$.  Since each $M_{\alpha+1}/M_{\alpha}$ is projective 
by construction, $M$ is projective.  
\end{proof}












\section{Completion}
\label{section-completion}

\noindent
Suppose that $R$ is a ring and $I$ is an ideal.
We define the {\it completion of $R$ with respect to $I$}
to be the limit
$$
R^\wedge = \lim\nolimits_{n} R/I^n.
$$
An element of $R^\wedge$ is simply given by a sequence
of elements $f_n \in R/I^n$ such that $f_n \equiv f_{n + 1} \bmod I^n$
for all $n$. Similarly, if $M$ is an $R$-module then we define the
{\it completion of $M$ with respect to $I$}
to be the limit
$$
M^\wedge = \lim\nolimits_{n} M/I^nM.
$$
An element of $M^\wedge$ is simply given by a sequence of
elements $m_n \in M/I^nM$ such that $m_n \equiv m_{n + 1} \bmod I^nM$
for all $n$. From this description it is clear that there
are always canonical maps
$$
M \longrightarrow M^\wedge, \quad\text{and}\quad
M \otimes_R R^\wedge \longrightarrow M^\wedge.
$$
Moreover, given a map $\varphi : M \to N$ of modules we get an induced
map $\varphi^\wedge : M^\wedge \to N^\wedge$ on completions making the
diagram
$$
\xymatrix{
M \ar[r] \ar[d] & N \ar[d] \\
M^\wedge \ar[r] & N^\wedge
}
$$
commute.

\begin{lemma}
\label{lemma-completion-generalities}
Let $R$ be a ring. Let $I \subset R$ be an ideal.
\begin{enumerate}
\item Let $M \to N$ be a map of $R$-modules such that
$M/IM \to N/IN$ is surjective. Then $M^\wedge \to N^\wedge$ is surjective.
\item Let $M \to N$ be a surjective map of $R$-modules. Then
$M^\wedge \to N^\wedge$ is surjective.
\item The canonical map $M \otimes_R R^\wedge \to M^\wedge$ is
surjective for any finite $R$-module $M$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $\varphi : M \to N$ be a map of $R$-modules such that
$M/IM \to N/IN$ is surjective.
Then the map $M/I^nM \to N/I^nN$ is surjective for each $n \geq 1$ by
Nakayama's lemma (Lemma \ref{lemma-NAK}). Set
$K_n = \{x \in M \mid \varphi(x) \in I^nN\}$.
Thus we get short exact sequences
$$
0 \to K_n/I^nM \to M/I^nM \to N/I^nN \to 0
$$
We claim that the canonical map $K_{n + 1}/I^{n + 1}M \to K_n/I^nM$
is surjective. Namely, if $x \in K_n$ write
$\varphi(x) = \sum z_j n_j$ with $z_j \in I^n$, $n_j \in N$.
By assumption we can write $n_j = \varphi(m_j) + \sum z_{jk}n_{jk}$
with $m_j \in M$, $z_{jk} \in I$ and $n_{jk} \in N$. Hence
$$
\varphi(x - \sum z_j m_j) = \sum z_jz_{jk} n_{jk}.
$$
This means that $x' = x - \sum z_j m_j \in K_{n + 1}$ maps
to $x$ which proves the claim. Now we may apply
Lemma \ref{lemma-Mittag-Leffler}
to the inverse system of short exact sequences above to see (1).
Part (2) is a special case of (1).
To see (3) choose generators $x_i \in M$, $i = 1, \ldots, n$.
Then the map $R^{\oplus n} \to M$, $(a_1, \ldots, a_n) \mapsto \sum a_ix_i$
is surjective. Hence by (2) we see
$(R^\wedge)^{\oplus n} \to M^\wedge$, $(a_1, \ldots, a_n) \mapsto \sum a_ix_i$
is surjective. Part (3) follows from this.
\end{proof}

\begin{lemma}
\label{lemma-completion-tensor}
Suppose $R$ is Noetherian.
\begin{enumerate}
\item If $N \to M$ is an injective map of finite $R$-modules,
then $N^\wedge \to M^\wedge$ is injective.
\item If $M$ is a finite $R$-module, then $M^\wedge = M \otimes_R R^\wedge$.
\end{enumerate}
\end{lemma}

\begin{proof}
For the first statement, by the Artin-Rees Lemma \ref{lemma-Artin-Rees},
we have a constant $c$ such that $I^nM \cap N$
equals $I^{n-c}(I^cM \cap N) \subset I^{n-c}N$.
Thus if $(n_i) \in N^\wedge$ maps to zero in
$M^\wedge$, then each $n_i$ maps to zero in $N/I^{i-c}N$.
And hence $n_{i-c} = 0$. Thus $N^\wedge \to M^\wedge$ is injective.

\medskip\noindent
For the second statement let $0 \to K \to R^t \to M \to 0$
be a presentation of $M$, corresponding the the generators
$x_1, \ldots, x_t$ of $M$. By Lemma \ref{lemma-completion-generalities}
$(R^t)^\wedge \to M^\wedge$ is surjective,
and for any finitely generated $R$-module the
canonical map $M \otimes_R R^\wedge \to M^\wedge$ is surjective.
Hence to prove the second statement it suffices
to prove the kernel of $(R^t)^\wedge \to M^\wedge$ is
exactly $K^\wedge$.

\medskip\noindent
Let $(x_n) \in (R^t)^\wedge$ be in the kernel. Note that
each $x_n$ is in the image of the map $K/I^nK \to (R/I^n)^t$.
Choose $c$ such that $(I^n)^t \cap K \subset I^{n-c} K$,
which is possible by Artin-Rees (Lemma \ref{lemma-Artin-Rees}).
For each $n \geq 0$ choose $y_n \in K/I^{n + c}K$ mapping to $x_{n + c}$,
and set $z_n = y_n \bmod I^nK$. The elements $z_n$ satisfy
$z_{n + 1} - z_n \bmod I^nK = y_{n + 1} - y_{n} \bmod I^nK$,
and $y_{n + 1} - y_n \in I^{n + c}R^t$ by construction. Hence
$z_{n + 1} = z_n \bmod I^nK$ by the choice of $c$ above. In other
words $(z_n) \in K^\wedge$ maps to $(x_n)$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-completion-flat}
Let $R$ be a Noetherian ring.
Let $I \subset R$ be an ideal.
\begin{enumerate}
\item The ring map $R \to R^\wedge$ is flat.
\item The functor $M \mapsto M^\wedge$ is exact on the category of
finitely generated $R$-modules.
\end{enumerate}
\end{lemma}

\begin{proof}
Consider $I \otimes_R R^\wedge \to R\otimes_R R^\wedge = R^\wedge$.
According to Lemma \ref{lemma-completion-tensor} this
is identified with $I^\wedge \to R^\wedge$ and $I^\wedge \to R^\wedge$
is injective. Part (1) follows from Lemma \ref{lemma-flat}.
Part (2) follows from part (1) and
Lemma \ref{lemma-completion-tensor} part (2).
\end{proof}

\begin{lemma}
\label{lemma-completion-faithfully-flat}
Let $R$ be a Noetherian local ring.
Let $\mathfrak m \subset R$ be the maximal ideal.
Let $I \subset \mathfrak m$ be an ideal.
The ring map $R \to R^\wedge$ is faithfully flat.
In particular the completion with respect to $\mathfrak m$,
namely $\lim_n R/\mathfrak m^n$ is faithfully flat.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-completion-flat} it is flat.
The composition $R \to R^\wedge \to R/\mathfrak m$ where
the last map is the projection map $R^\wedge \to R/I$
combined with $R/I \to R/\mathfrak m$ shows that
$\mathfrak m$ is in the image of $\text{Spec}(R^\wedge)
\to \text{Spec}(R)$. Hence the map is faithfully
flat by Lemma \ref{lemma-ff}.
\end{proof}

\begin{lemma}
\label{lemma-completion-Noetherian}
Let $R$ be a Noetherian ring.
Let $I$ be an ideal of $R$.
The completion $R^\wedge$ of $R$ with respect to $I$ is
Noetherian.
\end{lemma}

\begin{proof}
Choose generators $f_1, \ldots, f_n$ of $I$.
Consider the map
$$
R[[x_1, \ldots, x_n]] \longrightarrow R^\wedge,
\quad
x_i \longmapsto f_i.
$$
This is a well defined and surjective ring map
(details omitted).
Since $R[[x_1, \ldots, x_n]]$ is Noetherian (see
Lemma \ref{lemma-Noetherian-power-series}) we win.
\end{proof}

\begin{definition}
\label{definition-complete}
Let $R$ be a ring. Let $I \subset R$ be an ideal.
Let $M$ be an $R$-module. We say $M$ is {\it $I$-adically complete}
if the map
$$
M \longrightarrow M^\wedge = \lim\nolimits_n M/I^nM
$$
is an isomorphism\footnote{This includes the condition that
$\bigcap I^nM = (0)$.}. We say $R$ is {\it $I$-adically complete}
if $R$ is complete as an $R$-module.
\end{definition}

\noindent
It is not true that the completion of an $R$-module $M$ with respect
to $I$ is $I$-adically complete. Here is a lemma from an unpublished note
of Lenstra and de Smit.

\begin{lemma}
\label{lemma-hathat}
Let $R$ be a ring. Let $I \subset R$ be an ideal. Let $M$ be an $R$-module.
Denote $K_n = \text{Ker}(M^\wedge \to M/I^nM)$. Then $M^\wedge$ is $I$-adically
complete if and only if $K_n$ is equal to
$I^nM^\wedge = (I^nM)^\wedge$.
\end{lemma}

\begin{proof}
The module $I^n M^\wedge$ is contained in $K_n$.
Thus for each $n \geq 1$ there is a canonical exact sequence
$$
0 \to K_n/I^nM^\wedge \to M^\wedge/I^nM^\wedge \to M/I^nM \to 0.
$$
As $I^nM^\wedge$ maps onto $I^nM/I^{n + 1}M$ we see that
$K_{n + 1} + I^n M^\wedge = K_n$. Thus the inverse system
$\{K_n/I^n M^\wedge\}_{n \geq 1}$ has surjective transition maps.
By
Lemma \ref{lemma-Mittag-Leffler}
we see that there is a short exact sequence
$$
0 \to
\lim\nolimits_n K_n/I^n M^\wedge \to
(M^\wedge)^\wedge \to
M^\wedge \to 0
$$
Finally, note that $I^nM^\wedge$ is the completion of
the module $I^nM$ with respect to $I$. The reason is that
$I^m I^n M = I^{m + n}M$. Hence the lemma is clear.
\end{proof}

\begin{lemma}
\label{lemma-change-ideal-completion}
Let $R$ be a ring.
Let $I$, $J$ be ideals of $R$.
Assume there exist integers $c, d > 0$ such that
$I^c \subset J$ and $J^d \subset I$.
Then completion with respect to $I$ agrees with completion
with respect to $J$ for any $R$-module.
In particular an $R$-module $M$ is $I$-adically complete
if and only if it is $J$-adically complete.
\end{lemma}

\begin{proof}
Consider the system of maps
$M/I^nM \to M/J^{\lfloor n/d \rfloor}M$ and
the system of maps $M/J^mM \to M/I^{\lfloor m/c \rfloor}M$
to get mutually inverse maps between the completions.
\end{proof}


\begin{lemma}
\label{lemma-quotient-complete}
Let $R$ be a ring. Let $I$ be an ideal of $R$.
Let $M$ be an $I$-adically complete $R$-module,
and let $K \subset M$ be an $R$-submodule.
If $K = \bigcap (K + I^nM)$ then $M/K$ is $I$-adically complete.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-completion-generalities}
the map $M = M^\wedge \to N^\wedge$ is surjective.
Hence $N \to N^\wedge$ is surjective. It is easy to see that the
kernel of $N \to N^\wedge$ is the module $\bigcap (K + I^nM) / K$.
\end{proof}

\begin{lemma}
\label{lemma-when-finite-module-complete-over-complete-ring}
Let $R$ be a ring. Let $I$ be an ideal of $R$.
Let $M$ be an $R$-module.
If (a) $R$ is $I$-adically complete, (b) $M$ is a finite $R$-module,
and (c) $\bigcap I^nM = (0)$, then $M$ is $I$-adically complete.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-completion-generalities}
the map $M = M \otimes_R R \to M^\wedge$ is surjective.
The lemma follows from Lemma \ref{lemma-quotient-complete}.
\end{proof}

\begin{lemma}
\label{lemma-completion-complete}
Let $R$ be a Noetherian ring.
Let $I$ be an ideal of $R$.
Let $M$ be a finite $R$-module.
Then the completion $M^\wedge$
of $M$ with respect to $I$ is $I$-adically complete.
\end{lemma}

\begin{proof}
For each $n$ we have a short exact sequence of $R$-modules
$$
0 \to I^nM \to M \to M/I^nM \to 0
$$
Since completion is exact on the category of finite $R$-modules
(see Lemma \ref{lemma-completion-flat})
we see that the kernel of $M^\wedge \to M/I^nM$ is equal to $(I^nM)^\wedge$.
Hence $M^\wedge$ is complete according to Lemma \ref{lemma-hathat}.
\end{proof}

\begin{lemma}
\label{lemma-finite-over-complete-ring}
Let $R$ be a ring. Let $I \subset R$ be an ideal. Let $M$ be an $R$-module.
Assume
\begin{enumerate}
\item $R$ is $I$-adically complete,
\item $\bigcap_{n \geq 1} I^nM = (0)$, and
\item $M/IM$ is a finite $R/I$-module.
\end{enumerate}
Then $M$ is a finite $R$-module.
\end{lemma}

\begin{proof}
Let $x_1, \ldots, x_n \in M$ be elements whose images in $M/IM$ generate
$M/IM$ as a $R/I$-module. Denote $M' \subset M$ the $R$-submodule
generated by $x_1, \ldots, x_n$. By Lemma \ref{lemma-completion-generalities}
the map $(M')^\wedge \to M^\wedge$ is surjective.
Since $\bigcap I^nM = 0$ we see in particular that $\bigcap I^nM' = (0)$.
Hence by Lemma \ref{lemma-when-finite-module-complete-over-complete-ring}
we see that $M'$ is complete, and we conclude that $M' \to M^\wedge$
is surjective. Finally, the kernel of $M \to M^\wedge$ is
zero since it is equal to $\bigcap I^nM = (0)$.
Hence we conclude that $M \cong M' \cong M^\wedge$
is finitely generated.
\end{proof}

\begin{lemma}
\label{lemma-finite-after-completion}
Let $(R, \mathfrak m)$, $(S, \mathfrak n)$ be local Noetherian rings.
Let $R^\wedge$, resp.\ $S^\wedge$ be the completion of $R$, resp.\ $S$
with respect to $\mathfrak m$, resp.\ $\mathfrak n$.
Let $R \to S$ be a local homomorphism. If $S/\mathfrak mS$ has finite
length as an $R$-module, then $S^\wedge$ is a finite $R^\wedge$-module.
\end{lemma}

\begin{proof}
The assumption means that $\mathfrak n^t \subset \mathfrak mS$ for
some $t$. By Lemma \ref{lemma-change-ideal-completion}
we see that $S^\wedge$ is $\mathfrak m$-adically complete.
In particular $\bigcap (\mathfrak mS)^n = (0)$. Hence the lemma
follows from Lemma \ref{lemma-completion-complete} above.
\end{proof}






















\section{Criteria for flatness}
\label{section-criteria-flatness}

\noindent
In this section we prove some important technical lemmas in the Noetherian
case. We will (partially) generalize these to the non-Noetherian case
in Section \ref{section-more-flatness-criteria}.

\begin{lemma}
\label{lemma-mod-injective}
Suppose that $R \to S$ is a local homomorphism of Noetherian
local rings. Denote $\mathfrak m$ the maximal ideal of $R$.
Let $u : M \to N$ be a map of finite $S$-modules.
Assume $N$ flat over $R$.
If $\overline{u} : M/\mathfrak mM \to N/\mathfrak mN$
is injective then $u$ is injective.
In this case $N/u(M)$ is flat over $R$.
\end{lemma}

\begin{proof}
First we claim that $u_n : M/{\mathfrak m}^nM \to N/{\mathfrak m}^nN$
is injective for all $n \geq 1$. We proceed by induction, the base
case given by assumption. By our assumption that $N$ is flat
over $R$ we have  a short exact sequence
$0 \to N\otimes_R {\mathfrak m}^n/{\mathfrak m}^{n + 1}
\to N/{\mathfrak m}^{n + 1}N \to N/{\mathfrak m}^n N \to 0$.
Also, $N\otimes_R {\mathfrak m}^n/{\mathfrak m}^{n + 1}
= N/{\mathfrak m}N \otimes_{R/{\mathfrak m}}
{\mathfrak m}^n/{\mathfrak m}^{n + 1}$. We have
a similar exact sequence $M\otimes_R {\mathfrak m}^n/{\mathfrak m}^{n + 1}
\to M/{\mathfrak m}^{n + 1}M \to M/{\mathfrak m}^n M \to 0$
for $M$ except we do not have the zero on the left. We also
have $M\otimes_R {\mathfrak m}^n/{\mathfrak m}^{n + 1}
= M/{\mathfrak m}M \otimes_{R/{\mathfrak m}}
{\mathfrak m}^n/{\mathfrak m}^{n + 1}$. Thus the map $u_{n + 1}$ is
injective as both $u_n$ and the map
$\overline{u}\otimes \text{id}_{{\mathfrak m}^n/{\mathfrak m}^{n + 1}}$ are.

\medskip\noindent
Note that $\lim_n M/{\mathfrak m}^nM$ is the completion
of the module $M$ with respect to the ideal $I = {\mathfrak m}S$,
and similarly for $N$. Since $M$ and $N$ are finite $S$-modules
we have $M^\wedge = M \otimes S^\wedge$ and similarly for $N$, see Lemma
\ref{lemma-completion-tensor}.
We conclude that
$u \otimes 1 : M \otimes S^\wedge \to N \otimes S^\wedge$
is injective. Since $S^\wedge$ is faithfully
flat over $S$, see Lemma \ref{lemma-completion-faithfully-flat},
we conclude that $u$ is injective, see Lemma \ref{lemma-flat}.

\medskip\noindent
Finally, we have to prove that $I \otimes_R N/u(M) \to N/u(M)$
is injective for every ideal $I \subset R$. Consider the diagram
$$
\begin{matrix}
&
&
0
&
&
0
&
&
0
&
&
\\
&
&
\uparrow
&
&
\uparrow
&
&
\uparrow
&
&
\\
&
&
M/IM
&
\to
&
N/IN
&
\to
&
N/(IN + u(M))
&
\to
&
0
\\
&
&
\uparrow
&
&
\uparrow
&
&
\uparrow
&
&
\\
0
&
\to
&
M
&
\to
&
N
&
\to
&
N/u(M)
&
\to
&
0
\\
&
&
\uparrow
&
&
\uparrow
&
&
\uparrow
&
&
\\
&
&
M \otimes_R I
&
\to
&
N \otimes_R I
&
\to
&
N/u(M)\otimes_R I
&
\to
&
0
\end{matrix}
$$
The arrow $N\otimes_R I \to N$ is injective.
Chasing through the diagram we see
that it suffices to prove that
$M/IM$ injects into $N/IN$.
Note that $M/IM$ and $N/IN$ are modules
over the Noetherian ring $S/IS$,
$N/IN$ is flat over $R/I$ and
$u \bmod I : M/IM \to N/IN$ is injective
module $\mathfrak m$ we may apply
the result above to $u \bmod I$, and we win.
\end{proof}

\begin{lemma}
\label{lemma-grothendieck}
Suppose that $R \to S$ is a flat and local ring homomorphism of Noetherian
local rings. Denote $\mathfrak m$ the maximal ideal of $R$.
Suppose $f \in S$ is a nonzero divisor in $S/{\mathfrak m}S$.
Then $S/fS$ is flat over $R$, and $f$ is a nonzero divisor in $S$.
\end{lemma}

\begin{proof}
Follows directly from Lemma \ref{lemma-mod-injective}.
\end{proof}

\begin{lemma}
\label{lemma-grothendieck-regular-sequence}
Suppose that $R \to S$ is a flat and local ring homomorphism of Noetherian
local rings. Denote $\mathfrak m$ the maximal ideal of $R$.
Suppose $f_1, \ldots, f_c$ is a sequence of elements of
$S$ such that the images $\overline{f}_1, \ldots, \overline{f}_c$
form a regular sequence in $S/{\mathfrak m}S$.
Then $f_1, \ldots, f_c$ is a regular sequence in $S$ and each
of the quotients $S/(f_1, \ldots, f_i)$ is flat over $R$.
\end{lemma}

\begin{proof}
Induction and Lemma \ref{lemma-grothendieck} above.
\end{proof}

\begin{lemma}
\label{lemma-free-fibre-flat-free}
Let $R \to S$ be a local homomorphism of Noetherian
local rings. Let $\mathfrak m$ be the maximal
ideal of $R$. Let $M$ be a finite $S$-modules.
Suppose that (a) $M/\mathfrak mM$
is a free $S/\mathfrak mS$-module, and (b) $M$ is flat over $R$.
Then $M$ is free and $S$ is flat over $R$.
\end{lemma}

\begin{proof}
Let $\overline{x}_1, \ldots, \overline{x}_n$ be a basis
for the free module $M/\mathfrak mM$. Choose
$x_1, \ldots, x_n \in M$ with $x_i$ mapping to $\overline{x}_i$. Let
$u : S^{\oplus n} \to M$ be the map which maps the $i$th
standard basis vector to $x_i$. By Lemma \ref{lemma-mod-injective}
we see that $u$ is injective. On the other hand, by
Nakayama's Lemma \ref{lemma-NAK} the map is surjective. The
lemma follows.
\end{proof}

\begin{lemma}
\label{lemma-complex-exact-mod}
Let $R \to S$ be a local homomorphism of local Noetherian
rings. Let $\mathfrak m$ be the maximal ideal of $R$.
Let $0 \to F_e \to F_{e-1} \to \ldots \to F_0$
be a finite complex of finite $S$-modules. Assume that
each $F_i$ is $R$-flat, and that the complex
$0 \to F_e/\mathfrak m F_e \to F_{e-1}/\mathfrak m F_{e-1}
\to \ldots \to F_0 / \mathfrak m F_0$ is exact.
Then $0 \to F_e \to F_{e-1} \to \ldots \to F_0$
is exact, and moreover the module
$\text{Coker}(F_1 \to F_0)$ is $R$-flat.
\end{lemma}

\begin{proof}
By induction on $e$. If $e = 1$, then this is exactly
Lemma \ref{lemma-mod-injective}. If $e > 1$, we see
by Lemma \ref{lemma-mod-injective} that $F_e \to F_{e-1}$
is injective and that $C = \text{Coker}(F_e \to F_{e-1})$
is a finite $S$-module flat over $R$. Hence we can
apply the induction hypothesis to the complex
$0 \to C \to F_{e-2} \to \ldots \to F_0$.
We deduce that $C \to F_{e-2}$ is injective
and the exactness of the complex follows, as well
as the flatness of the cokernel of $F_1 \to F_0$.
\end{proof}

\noindent
In the rest of this section we prove two versions of what is called the
``local criterion of flatness''. Note also the interesting
Lemma \ref{lemma-CM-over-regular-flat} below.

\begin{lemma}
\label{lemma-prepare-local-criterion-flatness}
Let $R$ be a local ring with maximal ideal $\mathfrak m$
and residue field $\kappa = R/\mathfrak m$.
Let $M$ be an $R$-module. If $\text{Tor}_1^R(\kappa, M) = 0$,
then for every finite length $R$-module $N$ we have
$\text{Tor}_1^R(N, M) = 0$.
\end{lemma}

\begin{proof}
By descending induction on the length of $N$.
If the length of $N$ is $1$, then $N \cong \kappa$
and we are done. If the length of $N$ is more than
$1$, then we can fit $N$ into a short exact sequence
$0 \to N' \to N \to N'' \to 0$ where $N'$, $N''$ are
finite length $R$-modules of smaller length.
The vanishing of $\text{Tor}_1^R(N, M)$ follows
from the vanishing of $\text{Tor}_1^R(N', M)$
and $\text{Tor}_1^R(N'', M)$ (induction hypothesis)
and the long exact sequence of Tor groups, see Lemma
\ref{lemma-long-exact-sequence-tor}.
\end{proof}

\begin{lemma}
\label{lemma-local-criterion-flatness}
(Local criterion for flatness.)
Let $R \to S$ be a local homomorphism of local Noetherian
rings. Let $\mathfrak m$ be the maximal ideal of $R$,
and let $\kappa = R/\mathfrak m$.
Let $M$ be a finite $S$-module. If $\text{Tor}_1^R(\kappa, M) = 0$,
then $M$ is flat over $R$.
\end{lemma}

\begin{proof}
Let $I \subset R$ be an ideal. By Lemma \ref{lemma-flat} it suffices
to show that $I \otimes_R M \to M$ is injective. By Remark
\ref{remark-Tor-ring-mod-ideal} we see that this kernel is
equal to $\text{Tor}_1^R(M, R/I)$. By
Lemma \ref{lemma-prepare-local-criterion-flatness}
we see that $J \otimes_R M \to M$ is injective for all ideals
of finite colength.

\medskip\noindent
Choose $n >> 0$ and consider the following short exact
sequence
$$
0
\to I \cap \mathfrak m^n
\to I \oplus \mathfrak m^n
\to I + \mathfrak m^n
\to 0
$$
This is a sub sequence of the short exact sequence
$0 \to R \to R^{\oplus 2} \to R \to 0$. Thus we get the diagram
$$
\xymatrix{
(I\cap \mathfrak m^n) \otimes_R M \ar[r] \ar[d] &
I \otimes_R M \oplus \mathfrak m^n \otimes_R M \ar[r] \ar[d] &
(I + \mathfrak m^n) \otimes_R M \ar[d] \\
M \ar[r] &
M \oplus M \ar[r] &
M
}
$$
Note that $I + \mathfrak m^n$ and $\mathfrak m^n$
are ideals of finite colength.
Thus a diagram chase shows that
$\text{Ker}((I \cap \mathfrak m^n)\otimes_R M \to M)
\to \text{Ker}(I\otimes_R M \to M)$
is surjective. We conclude in particular that
$K = \text{Ker}(I\otimes_R M \to M)$ is contained
in the image of $(I \cap \mathfrak m^n) \otimes_R M$
in $I \otimes_R M$. By Artin-Rees, Lemma \ref{lemma-Artin-Rees}
we see that $K$ is contained
in $\mathfrak m^{n-c}(I \otimes_R M)$ for some $c > 0$
and all $n >> 0$. Since $I \otimes_R M$ is a finite
$S$-module (!) and since $S$ is Noetherian, we see
that this implies $K = 0$. Namely, the above implies
$K$ maps to zero in the $\mathfrak mS$-adic completion
of $I\otimes_R M$. But the map from $S$
to its $\mathfrak mS$-adic completion is faithfully flat
by Lemma \ref{lemma-completion-faithfully-flat}.
Hence $K = 0$, as desired.
\end{proof}

\noindent
In the following we often encounter the conditions
``$M/IM$ is flat over $R/I$ and $\text{Tor}_1^R(R/I, M) = 0$''.
The following lemma gives some consequences of these conditions
(it is a generalization of
Lemma \ref{lemma-prepare-local-criterion-flatness}).

\begin{lemma}
\label{lemma-what-does-it-mean}
Let $R$ be a ring.
Let $I \subset R$ be an ideal.
Let $M$ be an $R$-module.
If $M/IM$ is flat over $R/I$ and $\text{Tor}_1^R(R/I, M) = 0$ then
\begin{enumerate}
\item $M/I^nM$ is flat over $R/I^n$ for all $n \geq 1$, and
\item for any module $N$ which is annihilated by $I^m$ for some $m \geq 0$
we have $\text{Tor}_1^R(N, M) = 0$.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume $M/IM$ is flat over $R/I$ and $\text{Tor}_1^R(R/I, M) = 0$.
Let $N$ be an $R/I$-module. Choose a short exact sequence
$$
0 \to K \to \bigoplus\nolimits_{i \in I} R/I \to N \to 0
$$
By the long exact sequence of $\text{Tor}$ and the vanishing of
$\text{Tor}_1^R(R/I, M)$ we get
$$
0 \to \text{Tor}_1^R(N, M) \to K \otimes_R M \to
(\bigoplus\nolimits_{i \in I} R/I) \otimes_R M \to N \otimes_R M \to 0
$$
But since $K$, $\bigoplus_{i \in I} R/I$, and $N$ are all annihilated
by $I$ we see that
\begin{align*}
K \otimes_R M & = K \otimes_{R/I} M/IM,\\
(\bigoplus\nolimits_{i \in I} R/I) \otimes_R M & =
(\bigoplus\nolimits_{i \in I} R/I) \otimes_{R/I} M/IM, \\
N \otimes_R M & = N \otimes_{R/I} M/IM.
\end{align*}
As $M/IM$ is flat over $R/I$ we conclude that
$$
0 \to K \otimes_{R/I} M/IM \to
(\bigoplus\nolimits_{i \in I} R/I) \otimes_{R/I} M/IM \to
N \otimes_{R/} M/IM \to 0
$$
is exact. Combining this with the above we conclude that
$\text{Tor}_1^R(N, M) = 0$ for any $R$-module $N$ annihilated by $I$.

\medskip\noindent
In particular, if we apply this to the
module $I/I^2$, then we conclude that the sequence
$$
0 \to I^2 \otimes_R M \to I \otimes_R M  \to I/I^2 \otimes_R M \to 0
$$
is short exact. This implies that $I^2 \otimes_R M \to M$ is injective
and it implies that $I/I^2 \otimes_{R/I} M/IM = IM/I^2M$.

\medskip\noindent
Let us prove that $M/I^2M$ is flat over $R/I^2$. Let $I^2 \subset J$
be an ideal. We have to show that
$J/I^2 \otimes_{R/I^2} M/I^2M \to M/I^2M$ is injective, see
Lemma \ref{lemma-flat}.
As $M/IM$ is flat over $R/I$ we know that the map
$(I + J)/I \otimes_{R/I} M/IM \to M/IM$ is injective.
The sequence
$$
(I \cap J)/I^2 \otimes_{R/I^2} M/I^2M \to
J/I^2 \otimes_{R/I^2} M/I^2M \to
(I + J)/I \otimes_{R/I} M/IM \to 0
$$
is exact, as you get it by tensoring the exact sequence
$0 \to (I \cap J) \to J \to (I + J)/I \to 0$ by $M/I^2M$.
Hence suffices to prove the injectivity of the map
$(I \cap J)/I^2 \otimes_{R/I} M/IM \to IM/I^2M$. However, the map
$(I \cap J)/I^2 \to I/I^2$ is injective and as $M/IM$
is flat over $R/I$ the map
$(I \cap J)/I^2 \otimes_{R/I} M/IM \to I/I^2 \otimes_{R/I} M/IM$
is injective. Since we have previously seen that
$I/I^2 \otimes_{R/I} M/IM = IM/I^2M$ we obtain the desired injectivity.

\medskip\noindent
Hence we have proven that the assumptions imply:
(a) $\text{Tor}_1^R(N, M) = 0$ for all $N$ annihilated by $I$,
(b) $I^2 \otimes_R M \to M$ is injective, and (c) $M/I^2M$ is flat
over $R/I^2$. Thus we can continue by injective to get the
same results for $I^n$ for all $n \geq 1$.
\end{proof}

\begin{lemma}
\label{lemma-variant-local-criterion-flatness}
(Variant local criterion flatness.)
Let $R \to S$ be a local homomorphism of Noetherian
local rings. Let $I \not = R$ be an ideal in $R$.
Let $M$ be a finite $S$-module. If $\text{Tor}_1^R(M, R/I) = 0$
and $M/IM$ is flat over $R/I$, then $M$ is flat over $R$.
\end{lemma}

\begin{proof}
First proof: By
Lemma \ref{lemma-what-does-it-mean}
we see that $\text{Tor}_1^R(\kappa, M)$ is zero where $\kappa$
is the residue field of $R$. Hence we see that $M$
is flat over $R$ by
Lemma \ref{lemma-local-criterion-flatness}.

\medskip\noindent
Second proof: Let $\mathfrak m$ be the maximal ideal of $R$.
We will show that $\mathfrak m \otimes_R M \to M$ is injective,
and then apply
Lemma \ref{lemma-local-criterion-flatness}.
Suppose that $\sum f_i \otimes x_i \in \mathfrak m \otimes_R M$
and that $\sum f_i x_i = 0$ in $M$. By the equational criterion
for flatness Lemma \ref{lemma-flat-eq} applied to $M/IM$
over $R/I$ we see there exist $\overline{a}_{ij} \in R/I$
and $\overline{y}_j \in M/IM$ such that
$x_i \bmod IM = \sum_j \overline{a}_{ij} \overline{y}_j $
and $0 = \sum_i (f_i \bmod I) \overline{a}_{ij}$.
Let $a_{ij} \in R$ be a lift of $\overline{a}_{ij}$ and
similarly let $y_j \in M$ be a lift of $\overline{y}_j$.
Then we see that
\begin{eqnarray*}
\sum f_i \otimes x_i
& = &
\sum f_i \otimes x_i +
\sum f_ia_{ij} \otimes y_j -
\sum f_i \otimes a_{ij} y_j
\\
& = &
\sum f_i \otimes (x_i - \sum a_{ij} y_j) +
\sum (\sum f_i a_{ij}) \otimes y_j
\end{eqnarray*}
Since $x_i - \sum a_{ij} y_j \in IM$ and
$\sum f_i a_{ij} \in I$ we see that there exists
an element in $I \otimes_R M$ which maps to our given
element $\sum f_i \otimes x_i$ in $\mathfrak m \otimes_R M$.
But $I \otimes_R M \to M$ is injective by assumption (see
Remark \ref{remark-Tor-ring-mod-ideal}) and we win.
\end{proof}

\noindent
In particular, in the situation of the lemma, suppose that
$I = (x)$ is generated by a single element $x$ which is
a nonzero divisor in $R$. Then $\text{Tor}_1^R(M, R/(x)) = (0)$
if and only if $x$ is a nonzero divisor on $M$.

\begin{lemma}
\label{lemma-surjective-on-tor-one}
Let $R \to R' \to R''$ be ring maps.
Let $M$ be an $R$-module. Suppose that $M \otimes_R R'$
is flat over $R'$. Then the natural map
$\text{Tor}_1^R(M, R') \otimes_{R'} R'' \to
\text{Tor}_1^R(M, R'')$ is onto.
\end{lemma}

\begin{proof}
Let $F_\bullet$ be a free resolution of $M$ over $R$.
The complex $F_2 \otimes_R R' \to F_1\otimes_R R' \to F_0 \otimes_R R'$
computes $\text{Tor}_1^R(M, R')$.
The complex $F_2 \otimes_R R'' \to F_1\otimes_R R'' \to F_0 \otimes_R R''$
computes $\text{Tor}_1^R(M, R'')$. Note that
$F_i \otimes_R R' \otimes_{R'} R'' = F_i \otimes_R R''$. Let
$K' = \text{Ker}(F_1\otimes_R R' \to F_0 \otimes_R R')$ and
similarly $K'' = \text{Ker}(F_1\otimes_R R'' \to F_0 \otimes_R R'')$.
Thus we have an exact sequence
$$
0 \to K' \to F_1\otimes_R R' \to F_0 \otimes_R R' \to M\otimes_R R' \to 0.
$$
By the assumption that $M\otimes_R R'$ is flat over $R'$,
the sequence $0 \to K' \otimes_{R'} R''
\to F_1 \otimes_R R'' \to F_0 \otimes_R R'' \to M\otimes_R R'' \to 0$
is still exact. This means that $K'' = K' \otimes_{R'} R''$.
Since $\text{Tor}_1^R(M, R')$ is a quotient of $K'$ and
$\text{Tor}_1^R(M, R'')$ is a quotient of $K''$ we win.
\end{proof}

\begin{lemma}
\label{lemma-surjective-on-tor-one-trivial}
Let $R \to R'$ be a ring map. Let $I \subset R$ be
an ideal and $I' = IR'$. Let $M$ be an $R$-module
and set $M' = M \otimes_R R'$. The natural map
$\text{Tor}_1^R(R'/I', M) \to \text{Tor}_1^{R'}(R'/I', M')$
is surjective.
\end{lemma}

\begin{proof}
Let $F_2 \to F_1 \to F_0 \to M \to 0$ be a free resolution of
$M$ over $R$. Set $F_i' = F_i \otimes_R R'$. The sequence
$F_2' \to F_1' \to F_0' \to M' \to 0$ may no longer be exact
at $F_1'$. A free resolution of $M'$ over $R'$ therefore looks
like
$$
F_2' \oplus F_2'' \to F_1' \to F_0' \to M' \to 0
$$
for a suitable free module $F_2''$ over $R'$. Next, note that
$F_i \otimes_R R'/I' = F_i' / IF_i' = F_i'/I'F_i'$.
So the complex $F_2'/I'F_2' \to F_1'/I'F_1' \to F_0'/I'F_0'$
computes $\text{Tor}_1^R(M, R'/I')$. On the other hand
$F_i' \otimes_{R'} R'/I' = F_i'/I'F_i'$ and similarly
for $F_2''$. Thus the complex
$F_2'/I'F_2' \oplus F_2''/I'F_2'' \to F_1'/I'F_1' \to F_0'/I'F_0'$
computes $\text{Tor}_1^{R'}(M', R'/I')$. Since the vertical
map on complexes
$$
\xymatrix{
F_2'/I'F_2' \ar[r] \ar[d] &
F_1'/I'F_1' \ar[r] \ar[d] &
F_0'/I'F_0' \ar[d] \\
F_2'/I'F_2' \oplus F_2''/I'F_2'' \ar[r] &
F_1'/I'F_1' \ar[r] &
F_0'/I'F_0'
}
$$
clearly induces a surjection on cohomology we win.
\end{proof}

\begin{lemma}
\label{lemma-another-variant-local-criterion-flatness}
Let
$$
\xymatrix{
S \ar[r] & S' \\
R \ar[r] \ar[u] & R' \ar[u]
}
$$
be a commutative diagram of local homomorphisms of local Noetherian rings.
Let $I \subset R$ be an ideal.
Let $M$ be an $S$-module.
Denote $I' = IR'$ and $M' = M\otimes_S S'$.
Assume that
\begin{enumerate}
\item $S'$ is a localization of the tensor product
$S \otimes_R R'$,
\item $M/IM$ is flat over $R/I$,
\item $\text{Tor}_1^R(M, R/I) \to \text{Tor}_1^{R'}(M', R'/I')$
is zero.
\end{enumerate}
Then $M'$ is flat over $R'$.
\end{lemma}

\begin{proof}
Since $S'$ is a localization of $S \otimes_R R'$ we see that
$M'$ is a localization of $M \otimes_R R'$. Note that
by Lemma \ref{lemma-flat-base-change} the module $M/IM \otimes_{R/I} R'/I'
= M \otimes_R R' /I'(M \otimes_R R')$ is flat over $R'/I'$. Hence also
$M'/I'M'$ is flat over $R'/I'$ as the localization of a flat module
is flat. By Lemma \ref{lemma-variant-local-criterion-flatness}
it suffices to show that $\text{Tor}_1^{R'}(M', R'/I')$ is zero.
Since $M'$ is a localization of $M \otimes_R R'$, the last assumption
implies that it suffices to show that
$\text{Tor}_1^R(M, R/I) \otimes_R R'
\to
\text{Tor}_1^{R'}(M \otimes_R R', R'/I')$
is surjective.

\medskip\noindent
By Lemma \ref{lemma-surjective-on-tor-one-trivial} we see that
$\text{Tor}_1^R(M, R'/I') \to \text{Tor}_1^{R'}(M\otimes_R R', R'/I')$
is surjective. So now it suffices to show that
$\text{Tor}_1^R(M, R/I) \otimes_R R'
\to
\text{Tor}_1^R(M, R'/I')$
is surjective. This follows from Lemma \ref{lemma-surjective-on-tor-one}
by looking at the ring maps $R \to R/I \to R'/I'$ and the module $M$.
\end{proof}

\begin{lemma}
\label{lemma-criterion-flatness-fibre-Noetherian}
(Crit\`ere de platitude par fibres; Noetherian case.
See also Lemma \ref{lemma-criterion-flatness-fibre}
for the case of finitely presented algebras.)
Let $R$, $S$, $S'$ be Noetherian local rings and let $R \to S \to S'$
be local ring homomorphisms. Let $\mathfrak m \subset R$ be the
maximal ideal. Let $M$ be an $S'$-module. Assume
\begin{enumerate}
\item The module $M$ is finite over $S'$.
\item The module $M$ is not zero.
\item The module $M/\mathfrak m M$
is a flat $S/\mathfrak m S$-module.
\item The module $M$ is a flat $R$-module.
\end{enumerate}
Then $S$ is flat over $R$ and $M$ is a flat $S$-module.
\end{lemma}

\begin{proof}
Set $I = \mathfrak mS \subset S$. Then we see that $M/IM$ is a flat
$S/I$-module because of (3). Since
$\mathfrak m \otimes_R S' \to I \otimes_S S'$ is surjective we see
that also $\mathfrak m \otimes_R M \to I \otimes_S M$ is surjective.
Consider
$$
\mathfrak m \otimes_R M \to I \otimes_S M \to M.
$$
As $M$ is flat over $R$ the composition is injective
and so both arrows are injective.
In particular $\text{Tor}_1^S(S/I, M) = 0$ see
Remark \ref{remark-Tor-ring-mod-ideal}. By
Lemma \ref{lemma-variant-local-criterion-flatness} we conclude
that $M$ is flat over $S$. Note that since $M/\mathfrak m_{S'}M$
is not zero by Nakayama's Lemma \ref{lemma-NAK}
we see that actually $M$ is faithfully flat over $S$ by
Lemma \ref{lemma-ff} (since it forces $M/\mathfrak m_{S}M \not = 0$).

\medskip\noindent
Consider the exact sequence
$0 \to \mathfrak m \to R \to \kappa \to 0$.
This gives an exact sequence
$0 \to \text{Tor}_1^R(\kappa, S) \to \mathfrak m \otimes_R S \to I \to 0$.
Since $M$ is flat over $S$ this gives an exact sequence
$0 \to \text{Tor}_1^R(\kappa, S)\otimes_S M \to
\mathfrak m \otimes_R M \to I \otimes_S M \to 0$.
By the above this implies that $\text{Tor}_1^R(\kappa, S)\otimes_S M = 0$.
Since $M$ is faithfully flat over $S$ this implies that
$\text{Tor}_1^R(\kappa, S) = 0$ and we conclude that
$S$ is flat over $R$ by Lemma \ref{lemma-local-criterion-flatness}.
\end{proof}






\section{Base change and flatness}
\label{section-base-change-flat}

\noindent
Some lemmas which deal with what happens with flatness when
doing a base change.

\begin{lemma}
\label{lemma-base-change-flat-up-down}
Let
$$
\xymatrix{
S \ar[r] & S' \\
R \ar[r] \ar[u] & R' \ar[u]
}
$$
be a commutative diagram of local homomorphisms of local rings.
Assume that $S'$ is a localization of the tensor product $S \otimes_R R'$.
Let $M$ be an $S$-module and set $M' = S' \otimes_S M$.
\begin{enumerate}
\item If $M$ is flat over $R$ then $M'$ is flat over $R'$.
\item If $M'$ is flat over $R'$ and $R \to R'$ is flat then
$M$ is flat over $R$.
\end{enumerate}
In particular we have
\begin{enumerate}
\item[(3)] If $S$ is flat over $R$ then $S'$ is flat over $R'$.
\item[(4)] If $R' \to S'$ and $R \to R'$ are flat then $S$ is flat over $R$.
\end{enumerate}
\end{lemma}

\begin{proof}
Proof of (1). If $M$ is flat over $R$, then $M \otimes_R R'$
is flat over $R'$ by
Lemma \ref{lemma-flat-base-change}.
If $W \subset S \otimes_R R'$ is the multiplicative subset such that
$W^{-1}(S \otimes_R R') = S'$ then $M' = W^{-1}(M \otimes_R R')$.
Hence $M'$ is flat over $R'$ as the localization of a flat module, see
Lemma \ref{lemma-flat-localization} part (5). This proves (1) and in
particular, we see that (3) holds.

\medskip\noindent
Proof of (2). Suppose that $M'$ is flat over $R'$ and $R \to R'$ is flat.
By (3) applied to the diagram reflected in the northwest diagonal
we see that $S \to S'$ is flat. Thus $S \to S'$ is faithfully flat by
Lemma \ref{lemma-local-flat-ff}.
We are going to use the criterion of
Lemma \ref{lemma-flat} (\ref{item-f-ideal})
to show that $M$ is flat.
Let $I \subset R$ be an ideal. If $I \otimes_R M \to M$ has a kernel,
so does $(I \otimes_R M) \otimes_S S' \to M \otimes_S S' = M'$.
Note that $I \otimes_R R' = IR'$ as $R \to R'$ is flat, and that
$$
(I \otimes_R M) \otimes_S S' =
(I \otimes_R R') \otimes_{R'} (M \otimes_S S') =
IR' \otimes_{R'} M'.
$$
From flatness of $M'$ over $R'$
we conclude that this maps injectively into $M'$.
This concludes the proof of (2), and hence (4) is true as well.
\end{proof}








\section{Flatness criteria over Artinian rings}
\label{section-flatness-artinian}

\noindent
We discuss some flatness criteria for modules over Artinian rings.

\begin{lemma}
\label{lemma-local-artinian-basis-when-flat}
Let $(R, \mathfrak m)$ be a local Artinian ring.
Let $M$ be a flat $R$-module.
If $A$ is a set and $x_\alpha \in M$, $\alpha \in A$ is a collection
of elements of $M$, then the following are equivalent:
\begin{enumerate}
\item $\{\overline{x}_\alpha\}_{\alpha \in A}$ forms a basis
for the vector space $M/\mathfrak mM$ over $R/\mathfrak m$, and
\item $\{x_\alpha\}_{\alpha \in A}$ forms a basis for $M$ over $R$.
\end{enumerate}
\end{lemma}

\begin{proof}
The implication (2) $\Rightarrow$ (1) is immediate.
We will prove the other implication by using induction on $n$ to show that
$\{x_\alpha\}_{\alpha \in A}$ forms a basis for
$M/\mathfrak m^nM$ over $R/\mathfrak m^n$. The case $n = 1$ holds by
assumption (1). Assume the statement holds for some $n \geq 1$. By
Nakayama's Lemma \ref{lemma-NAK}
the elements $x_\alpha$ generate $M$, in particular $M/\mathfrak m^{n + 1}M$.
The exact sequence
$0 \to \mathfrak m^n/\mathfrak m^{n + 1} \to R/\mathfrak m^{n + 1} \to
R/\mathfrak m^n \to 0$
gives on tensoring with $M$ the exact sequence
$$
0 \to \mathfrak m^nM/\mathfrak m^{n + 1}M \to
M/\mathfrak m^{n + 1}M \to
M/\mathfrak m^nM \to 0
$$
Here we are using that $M$ is flat.
Moreover, we have $\mathfrak m^nM/\mathfrak m^{n + 1}M =
M/\mathfrak mM \otimes_{R/\mathfrak m} \mathfrak m^n/\mathfrak m^{n + 1}$
by flatness of $M$ again.
Now suppose that $\sum f_\alpha x_\alpha = 0$ in $M/\mathfrak m^{n + 1}M$.
Then by induction hypothesis $f_\alpha \in \mathfrak m^n$ for each $\alpha$.
By the short exact sequence above we then conclude that
$\sum \overline{f}_\alpha \otimes \overline{x}_\alpha$ is zero in
$\mathfrak m^n/\mathfrak m^{n + 1} \otimes_{R/\mathfrak m} M/\mathfrak mM$.
Since $\overline{x}_\alpha$ forms a basis we conclude that each of the
congruence classes $\overline{f}_\alpha \in \mathfrak m^n/\mathfrak m^{n + 1}$
is zero and we win.
\end{proof}

\begin{lemma}
\label{lemma-local-artinian-characterize-flat}
Let $R$ be an Artinian local ring. Let $M$ be an $R$-module.
The following are equivalent
\begin{enumerate}
\item $M$ is flat over $R$,
\item $M$ is a free $R$-module, and
\item $M$ is a projective $R$-module.
\end{enumerate}
\end{lemma}

\begin{proof}
Since any projective module is flat (as a direct summand of a free module)
and every free module is projective, it suffices to prove that a flat module
is free. Let $M$ be a flat module. Let $A$ be a set and let $x_\alpha \in M$,
$\alpha \in A$ be elements such that
$\overline{x_\alpha} \in M/\mathfrak m M$ forms a basis over the residue
field of $R$. By
Lemma \ref{lemma-local-artinian-basis-when-flat}
the $x_\alpha$ are a basis for $M$ over $R$ and we win.
\end{proof}

\begin{lemma}
\label{lemma-lift-basis}
Let $R$ be a ring.
Let $I \subset R$ be an ideal.
Let $M$ be an $R$-module.
Let $A$ be a set and let $x_\alpha \in M$, $\alpha \in A$ be a collection
of elements of $M$.
Assume
\begin{enumerate}
\item $I$ is nilpotent,
\item $\{\overline{x}_\alpha\}_{\alpha \in A}$ forms a basis for $M/IM$ over
$R/I$, and
\item $\text{Tor}_1^R(R/I, M) = 0$.
\end{enumerate}
Then $M$ is free on $\{x_\alpha\}_{\alpha \in A}$ over $R$.
\end{lemma}

\begin{proof}
Let $R$, $I$, $M$, $\{x_\alpha\}_{\alpha \in A}$ be as in the lemma
and satisfy assumptions (1), (2), and (3). By
Nakayama's Lemma \ref{lemma-NAK}
the elements $x_\alpha$ generate $M$ over $R$.
The assumption $\text{Tor}_1^R(R/I, M) = 0$ implies that we have a short
exact sequence
$$
0 \to I \otimes_R M \to M \to M/IM \to 0.
$$
Let $\sum f_\alpha x_\alpha = 0$ be a relation in $M$.
By choice of $x_\alpha$ we see that $f_\alpha \in I$.
Hence we conclude that $\sum f_\alpha \otimes x_\alpha = 0$ in
$I \otimes_R M$. The map $I \otimes_R M \to I/I^2 \otimes_{R/I} M/IM$
and the fact that $\{x_\alpha\}_{\alpha \in A}$ forms a basis
for $M/IM$ implies that $f_\alpha \in I^2$! Hence we conclude that
there are no relations among the images of the $x_\alpha$ in
$M/I^2M$. In other words, we see that $M/I^2M$ is free with basis
the images of the $x_\alpha$. Using the map
$I \otimes_R M \to I/I^3 \otimes_{R/I^2} M/I^2M$
we then conclude that $f_\alpha \in I^3$!
And so on. Since $I^n = 0$ for some $n$ by assumption (1) we win.
\end{proof}

\begin{lemma}
\label{lemma-prepare-lift-flatness}
Let $\varphi : R \to R'$ be a ring map.
Let $I \subset R$ be an ideal.
Let $M$ be an $R$-module.
Assume
\begin{enumerate}
\item $M/IM$ is flat over $R/I$, and
\item $R' \otimes_R M$ is flat over $R'$.
\end{enumerate}
Set $I_2 = \varphi^{-1}(\varphi(I^2)R')$
Then $M/I_2M$ is flat over $R/I_2$.
\end{lemma}

\begin{proof}
We may replace $R$, $M$, and $R'$ by $R/I_2$, $M/I_2M$, and
$R'/\varphi(I)^2R'$. Then $I^2 = 0$ and $\varphi$ is injective. By
Lemma \ref{lemma-what-does-it-mean}
and the fact that $I^2 = 0$ it suffices to prove that
$\text{Tor}^R_1(R/I, M) = 0$.
Set $M' = M \otimes_R R'$ and $I' = IR'$.
By assumption the map $I' \otimes_{R'} M' \to M'$ is injective.
Hence $K$ maps to zero in
$$
I' \otimes_{R'} M' = I' \otimes_R M = I' \otimes_{R/I} M/IM.
$$
Then $I \to I'$ is an injective map of $R/I$-modules.
Since $M/IM$ is flat over $R/I$ the map
$$
I \otimes_{R/I} M/IM \longrightarrow I' \otimes_{R/I} M/IM
$$
is injective. This implies that $K$ is zero in
$I \otimes_R M = I \otimes_{R/I} M/IM$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-lift-flatness}
Let $\varphi : R \to R'$ be a ring map.
Let $I \subset R$ be an ideal.
Let $M$ be an $R$-module.
Assume
\begin{enumerate}
\item $I$ is nilpotent,
\item $R \to R'$ is injective,
\item $M/IM$ is flat over $R/I$, and
\item $R' \otimes_R M$ is flat over $R'$.
\end{enumerate}
Then $M$ is flat over $R$.
\end{lemma}

\begin{proof}
Define inductively $I_1 = I$ and $I_{n + 1} = \varphi^{-1}(\varphi(I_n)^2R')$
for $n \geq 1$. Note that by
Lemma \ref{lemma-prepare-lift-flatness}
we find that $M/I_nM$ is flat over $R/I_n$ for each $n \geq 1$.
It is clear that $\varphi(I_n) \subset \varphi(I)^{2^n}R'$. Since
$I$ is nilpotent we see that $\varphi(I_n) = 0$ for some $n$. As
$\varphi$ is injective we conclude that $I_n = 0$ for some $n$ and
we win.
\end{proof}

\noindent
Here is the local Artinian version of the local criterion for flatness.

\begin{lemma}
\label{lemma-artinian-variant-local-criterion-flatness}
Let $R$ be an Artinian local ring. Let $M$ be an $R$-module.
Let $I \subset R$ be a proper ideal. The following are
equivalent
\begin{enumerate}
\item $M$ is flat over $R$, and
\item $M/IM$ is flat over $R/I$ and $\text{Tor}_1^R(R/I, M) = 0$.
\end{enumerate}
\end{lemma}

\begin{proof}
The implication (1) $\Rightarrow$ (2) follows immediately from the
definitions. Assume $M/IM$ is flat over $R/I$ and
$\text{Tor}_1^R(R/I, M) = 0$. By
Lemma \ref{lemma-local-artinian-characterize-flat}
this implies that $M/IM$ is free over $R/I$. Pick a set $A$
and elements $x_\alpha \in M$ such that the images in $M/IM$ form
a basis. By
Lemma \ref{lemma-lift-basis}
we conclude that $M$ is free and in particular flat.
\end{proof}

\noindent
It turns out that flatness descends along injective homomorphism
whose source is an Artinian ring.

\begin{lemma}
\label{lemma-descent-flatness-injective-map-artinian-rings}
Let $R \to S$ be a ring map. Let $M$ be an $R$-module.
Assume
\begin{enumerate}
\item $R$ is Artinian
\item $R \to S$ is injective, and
\item $M \otimes_R S$ is a flat $S$-module.
\end{enumerate}
Then $M$ is a flat $R$-module.
\end{lemma}

\begin{proof}
First proof: Let $I \subset R$ be the radical of $R$.
Then $I$ is nilpotent and $M/IM$ is flat over $R/I$ as $R/I$
is a product of fields, see
Section \ref{section-artinian}.
Hence $M$ is flat by an application of
Lemma \ref{lemma-lift-flatness}.

\medskip\noindent
Second proof: By
Lemma \ref{lemma-artinian-finite-length}
we may write $R = \prod R_i$ as a finite product of local Artinian
rings. This induces similar product decompositions for both $R$ and $S$.
Hence we reduce to the case where $R$ is local Artinian (details omitted).

\medskip\noindent
Assume that $R \to S$, $M$ are as in the lemma satisfying (1), (2), and (3)
and in addition that $R$ is local with maximal ideal $\mathfrak m$.
Let $A$ be a set and $x_\alpha \in A$ be elements such that
$\overline{x}_\alpha$ forms a basis for $M/\mathfrak mM$
over $R/\mathfrak m$. By
Nakayama's Lemma \ref{lemma-NAK}
we see that the elements $x_\alpha$ generate $M$ as an $R$-module.
Set $N = S \otimes_R M$ and $I = \mathfrak mS$.
Then $\{1 \otimes x_\alpha\}_{\alpha \in A}$ is a family of elements
of $N$ which form a basis for $N/IN$. Moreover, since $N$ is flat over
$S$ we have $\text{Tor}_1^S(S/I, N) = 0$. Thus we conclude from
Lemma \ref{lemma-lift-basis}
that $N$ is free on $\{1 \otimes x_\alpha\}_{\alpha \in A}$.
The injectivity of $R \to S$ then guarantees that there cannot be a
nontrivial relation among the $x_\alpha$ with coefficients in $R$.
\end{proof}










\section{What makes a complex exact?}
\label{section-complex-exact}

\noindent
Some of this material can be found in the paper \cite{WhatExact}
by Buchsbaum and Eisenbud.

\begin{situation}
\label{situation-complex}
Here $R$ is a ring, and we have a complex
$$
0
\to
R^{n_e}
\xrightarrow{\varphi_e}
R^{n_{e-1}}
\xrightarrow{\varphi_{e-1}}
\ldots
\xrightarrow{\varphi_{i + 1}}
R^{n_i}
\xrightarrow{\varphi_i}
R^{n_{i-1}}
\xrightarrow{\varphi_{i-1}}
\ldots
\xrightarrow{\varphi_1}
R^{n_0}
$$
In other words we require $\varphi_i \circ \varphi_{i + 1} = 0$
for $i = 1, \ldots, e - 1$.
\end{situation}

\begin{lemma}
\label{lemma-add-trivial-complex}
In Situation \ref{situation-complex}.
Suppose $R$ is a local ring with maximal ideal $\mathfrak m$.
Suppose that for some $i$, $e \leq i \leq 1$
some matrix coefficient of the map $\varphi_i$ is invertible.
Then the complex $0 \to R^{n_e} \to R^{n_{e-1}} \to \ldots \to R^{n_0}$
is isomorphic to the direct sum of a complex
$0 \to R^{n_e} \to \ldots \to R^{n_i - 1} \to
R^{n_{i-1} - 1} \to \ldots \to R^{n_0}$
and the complex $0 \to 0 \to \ldots \to R \to R \to 0 \to \ldots \to 0$
where the map $R \to R$ is the identity map.
\end{lemma}

\begin{proof}
The assumption means, after a change of basis of
$R^{n_i}$ and $R^{n_{i-1}}$ that the first basis
vector of $R^{n_i}$ is mapped via $\varphi_i$ to the first basis
vector of $R^{n_{i-1}}$. Let $e_j$ denote the
$j$th basis vector of $R^{n_i}$ and $f_k$ the $k$th
basis vector of $R^{n_{i-1}}$. Write $\varphi_i(e_j)
= \sum a_{jk} f_k$. So $a_{1k} = 0$ unless $k = 1$
and $a_{11} = 1$. Change basis on $R^{n_i}$ again
by setting $e'_j = e_j - a_{j1} e_1$ for $j > 1$.
After this change of coordinates we have $a_{j1} = 0$
for $j > 1$. Note the image
of $R^{n_{i + 1}} \to R^{n_i}$ is contained in the
subspace spanned by $e_j$, $j > 1$. Note also
that $R^{n_{i-1}} \to R^{n_{i-2}}$ has to annihilate
$f_1$ since it is in the image. These conditions
and the shape of the matrix $(a_{jk})$ for $\varphi_i$
imply the lemma.
\end{proof}

\noindent
Let us say that an acyclic complex of the form
$\ldots \to 0 \to R \to R \to 0 \to \ldots $
is {\it trivial}. The lemma above clearly says that
any finite complex of finite free modules over a local ring is up to direct
sums with trivial complexes the same as a complex
all of whose maps have all matrix coefficients in
the maximal ideal.

\begin{lemma}
\label{lemma-exact-artinian-local}
In Situation \ref{situation-complex}.
Let $R$ be a Artinian local ring.
Suppose that $0 \to R^{n_e} \to R^{n_{e-1}}
\to \ldots \to R^{n_0}$ is an exact complex.
Then the complex is isomorphic to a direct sum of
trivial complexes.
\end{lemma}

\begin{proof}
By induction on the integer $\sum n_i$.
Clearly $\text{Ass}(R) = \{\mathfrak m\}$.
Pick $x \in R$, $x \not = 0$, $\mathfrak m x = 0$.
Pick a basis vector $e_i \in R^{n_e}$.
Since $xe_i$ is not be mapped to zero by
exactness of the complex we deduce that some matrix
coefficient of the map $R^{n_e} \to R^{n_{e-1}}$
is not in $\mathfrak m$.
Lemma \ref{lemma-add-trivial-complex} then allows
us to decrease $\sum n_i$.
\end{proof}

\noindent
Below we define the rank of a map of finite free modules.
This is just one possible definition of rank. It
is just the definition that works in this section; there
are others that may be more convenient in other settings.

\begin{definition}
\label{definition-rank}
Let $R$ be a ring. Suppose that $\varphi : R^m \to R^n$ is a map
of finite free modules.
\begin{enumerate}
\item The {\it rank} of $\varphi$ is the maximal $r$ such that
$\wedge^r \varphi : \wedge^r R^m \to \wedge^r R^n$ is nonzero.
\item We let $I(\varphi) \subset R$ be the ideal generated by
the $r\times r$ minors of the matrix of $\varphi$, where $r$
is the rank as defined above.
\end{enumerate}
\end{definition}

\begin{lemma}
\label{lemma-trivial-case-exact}
In Situation \ref{situation-complex}, suppose the complex is
isomorphic to a direct sum of trivial complexes. Then
we have
\begin{enumerate}
\item the maps $\varphi_i$ have rank
$r_i = n_i - n_{i + 1} + \ldots + (-1)^{e-i-1} n_{e-1} + (-1)^{e-i} n_e$,
\item for all $i$, $1 \leq i \leq e$ we have
$\text{rank}(\varphi_{i + 1}) + \text{rank}(\varphi_i) = n_i$,
\item each $I(\varphi_i) = R$.
\end{enumerate}
\end{lemma}

\begin{proof}
We may assume the complex is the direct sum of trivial
complexes. Then for each $i$ we can split the standard basis
elements of $R^{n_i}$ into those that map to a basis element
of $R^{n_{i-1}}$ and those that are mapped to zero (and these
are mapped onto by basis elements of $R^{n_{i + 1}}$).
Using descending
induction starting with $i = e$ it is easy to prove that there
are $r_{i + 1}$-basis elements of $R^{n_i}$ which are mapped
to zero and $r_i$ which are mapped to basis elements of
$R^{n_{i-1}}$. From this the result follows.
\end{proof}

\begin{lemma}
\label{lemma-exact-length-1}
Let $R$ be a local Noetherian ring.
Suppose that $\varphi : R^m \to R^n$ is a map
of finite free modules. The following are equivalent
\begin{enumerate}
\item $\varphi$ is injective.
\item the rank of $\varphi$ is $m$ and
either $I(\varphi) = R$ or it contains a nonzero divisor.
\end{enumerate}
\end{lemma}

\begin{proof}
If any matrix coefficient of $\varphi$ is not in $\mathfrak m$,
then we apply lemma \ref{lemma-add-trivial-complex} to write
$\varphi$ as the sum of $1 : R \to R$ and a map
$\varphi' : R^{m-1} \to R^{n-1}$. It is easy to see that
the lemma for $\varphi'$ implies the lemma for $\varphi$.
Thus we may assume from the outset that all the matrix
coefficients of $\varphi$ are in $\mathfrak m$.

\medskip\noindent
Suppose $\varphi$ is injective. We may assume $m > 0$.
Let $q \in \text{Ass}(R)$. Let $x \in R$ be an element
whose annihilator is $\mathfrak q$. Note that $\varphi$
induces a injective map $xR^m \to xR^n$ which is isomorphic
to the map $\varphi_{\mathfrak q} : (R/\mathfrak q)^m \to (R/\mathfrak q)^n$
induced by $\varphi$. Since $R/\mathfrak q$ is a domain
we deduce immediately by localizing to its fraction field
that the rank of $\varphi_{\mathfrak q}$ is $m$ and that
$I(\varphi_{\mathfrak q})$ is not the zero ideal. Hence we
conclude by Lemma \ref{lemma-ideal-nonzerodivisor}.

\medskip\noindent
Conversely, assume that the rank of $\varphi$ is $m$
and that $I(\varphi)$ contains a non zerodivisor.
The rank being $m$ implies $n \geq m$. Let $I$ be
a subset $I \subset \{1, \ldots, n\}$ of cardinality
$m$ and denote $p_I : R^{n} \to R^m$ the projection
corresponding to the coordinate functions whose indices
are in $I$. Denote $\varphi_I$ the composition
$p_I \circ \varphi$ and $a_I = \det(\varphi_I)$.
our assumption is that there exist $b_I \in R$ such
that $x = \sum b_I a_I$ is a nonzero divisor.
Let $\psi_I : R^m \to R^m$ be the adjoint map, i.e.,
such that $\varphi_I \circ \psi_I = \psi_I \circ \varphi_I =
a_I \text{id}_{R^m}$. Suppose $v \in R^m$ is in the kernel of $\varphi$.
Then $\varphi_I(v) = 0$. Hence $xv = \sum b_I a_I v
= \sum b_I (\psi_I \circ \varphi_I)(v)
= \sum b_I \psi_I(\varphi_I(v)) = 0$. Thus $v = 0$.
\end{proof}

\begin{lemma}
\label{lemma-exact-depth-zero-local}
In Situation \ref{situation-complex}. Suppose $R$ is
a local Noetherian ring with maximal ideal $\mathfrak m$.
Assume $\mathfrak m \in \text{Ass}(R)$, in other words
$R$ has depth $0$. Suppose that the complex is exact.
In this case the complex is isomorphic to a direct sum of trivial
complexes.
\end{lemma}

\begin{proof}
The proof is the same as in \ref{lemma-exact-artinian-local},
except using Lemma \ref{lemma-exact-length-1} to guarantee
that $I(\varphi_e) = R$, and hence some matrix coefficient
of $\varphi_e$ is not in $\mathfrak m$.
\end{proof}

\begin{lemma}
\label{lemma-div-x-exact-one-less}
In Situation \ref{situation-complex}, suppose $R$ is
a local Noetherian ring, and suppose that the complex
is exact. Let $x$ be an element of the maximal ideal
which is a nonzero divisor. The complex
$0 \to (R/xR)^{n_e} \to \ldots \to (R/xR)^{n_1}$
is still exact.
\end{lemma}

\begin{proof}
Follows easily from the snake lemma.
\end{proof}

\begin{lemma}
\label{lemma-acyclic}
(Acyclicity lemma.)
Let $R$ be a local Noetherian ring.
Let $0 \to M_e \to M_{e-1} \to \ldots \to M_0$
be a complex of finite $R$-modules.
Assume $\text{depth}(M_i) \geq i$.
Let $i$ be the largest index such that the complex is
not exact at $M_i$. If $i > 0$ then
$\text{Ker}(M_i \to M_{i-1})/\text{Im}(M_{i + 1} \to M_i)$
has depth $\geq 1$.
\end{lemma}

\begin{proof}
Let $H = \text{Ker}(M_i \to M_{i-1})/\text{Im}(M_{i + 1} \to M_i)$ be the
cohomology group in question.
We may break the complex into short exact sequences
$0 \to M_e \to M_{e-1} \to K_{e-2} \to 0$,
$0 \to K_j \to M_j \to K_{j-1} \to 0$, for $i + 2 \leq j \leq e-2 $,
$0 \to K_{i + 1} \to M_{i + 1} \to B_i \to 0$,
$0 \to K_i \to M_i \to M_{i-1}$, and
$0 \to B_i \to K_i \to H \to 0$.
We proceed up through these complexes to
prove the statements about depths, repeatedly using
Lemma \ref{lemma-depth-in-ses}.
First of all, since $\text{depth}(M_e) \geq e$,
and $\text{depth}(M_{e-1}) \geq e-1$ we deduce
that $\text{depth}(K_{e-2}) \geq e - 1$. At this point the
sequences $0 \to K_j \to M_j \to K_{j-1} \to 0$ for $i + 2 \leq j \leq e-2 $
imply similarly that $\text{depth}(K_{j-1}) \geq j$ for
$i + 2 \leq j \leq e-2$. The sequence
$0 \to K_{i + 1} \to M_{i + 1} \to B_i \to 0$
then shows that $\text{depth}(B_i) \geq i + 1$. The sequence
$0 \to K_i \to M_i \to M_{i-1}$ shows that $\text{depth}(K_i) \geq 1$
since $M_i$ has depth $\geq i \geq 1$ by assumption.
The sequence $0 \to B_i \to K_i \to H \to 0$ then
implies the result.
\end{proof}

\begin{proposition}
\label{proposition-what-exact}
In Situation \ref{situation-complex}, suppose $R$ is
a local Noetherian ring. The complex is exact if and
only if for all $i$, $1 \leq i \leq e$
the following two conditions are satisfied:
\begin{enumerate}
\item we have $\text{rank}(\varphi_{i + 1}) + \text{rank}(\varphi_i)
= n_i$, and
\item $I(\varphi_i) = R$, or $I(\varphi_i)$ contains a
regular sequence of length $i$.
\end{enumerate}
\end{proposition}

\begin{proof}
This proof is very similar to the proof of Lemma
\ref{lemma-exact-length-1}.
As in the proof of Lemma \ref{lemma-exact-length-1} we may assume
that all matrix entries of each $\varphi_i$ are elements of
the maximal ideal. We may also assume that $e \geq 1$.

\medskip\noindent
Assume the complex is exact. Let $q \in \text{Ass}(R)$.
(There is at least one such prime.)
Note that the ring $R_{\mathfrak q}$ has depth $0$.
We apply Lemmas \ref{lemma-exact-depth-zero-local} and
\ref{lemma-trivial-case-exact} to the localized complex
over $R_{\mathfrak q}$. all of the ideals
$I(\varphi_i)_{\mathfrak q}$, $e \geq i \geq 1$
are equal to $R_{\mathfrak q}$. Thus none of the ideals
$I(\varphi_i)$ is contained in $\mathfrak q$.
This implies that $I(\varphi_e)I(\varphi_{e-1})\ldots I(\varphi_1)$
is not contained in any of the associated primes
of $R$. By Lemma \ref{lemma-silly} we may choose
$x \in I(\varphi_e)I(\varphi_{e-1})\ldots I(\varphi_1)$,
$x \not \in \mathfrak q$ for all $q\in \text{Ass}(R)$.
According to Lemma \ref{lemma-div-x-exact-one-less}
the complex $0 \to (R/xR)^{n_e}
\to \ldots \to (R/xR)^{n_1}$ is exact. By induction
on $e$ all the ideals $I(\varphi_i)/xR$ have a regular
sequence of length $i-1$. This proves that $I(\varphi_i)$
contains a regular sequence of length $i$.

\medskip\noindent
Assume the two conditions on the ranks of $\varphi_i$
and the ideals $I(\varphi_i)$ is satisfied. Note that
$I(\varphi_i) \subset \mathfrak m$ for all $i$ because
of what was said in the first paragraph of the proof.
Hence the assumption in particular implies that
$\text{depth}(R) \geq e$. By induction
on the dimension of $R$ we may assume the complex
is exact when localized at any nonmaximal prime of $R$.
Thus $\text{Ker}(\varphi_i)/\text{Im}(\varphi_{i + 1})$
has support $\{\mathfrak m\}$ and hence (if nonzero)
depth $0$. By Lemma \ref{lemma-acyclic} we see
that the complex is exact.
\end{proof}












\section{Cohen-Macaulay modules}
\label{section-CM}

\noindent
Here we just do a minimal amount of work to show that
Cohen-Macaulay modules have good properties. We postpone
using Ext groups to esthablish the connection with duality
and so on.

\begin{definition}
\label{definition-CM}
Let $R$ be a Noetherian local ring.
Let $M$ be a finite $R$-module.
We say $M$ is {\it Cohen-Macaulay}
if $\dim(\text{Support}(M)) = \text{depth}(M)$.
\end{definition}

\noindent
Let $R$ be a local Noetherian ring. Let $M$ be
a Cohen-Macaulay module, and let $f_1, \ldots, f_d$
be an $M$-regular sequence with $d = \dim(\text{Support}(M))$.
We say that $g \in \mathfrak m$ is {\it good with respect to
$(M, f_1, \ldots, f_d)$} if for all $i = 0, 1, \ldots, d-1$
we have $\dim (\text{Support}(M) \cap V(g, f_1, \ldots, f_i))
= d - i - 1$. This is equivalent to the condition that
$\dim((\text{Support}(M/(f_1, \ldots, f_i)M) \cap V(g) =
d - i -1$ for $i = 0, 1, \ldots, d-1$.

\begin{lemma}
\label{lemma-good-element}
Notation and assumptions as above. If $g$ is good with respect to
$(M, f_1, \ldots, f_d)$, then (a) $g$ is a nonzero-divisor on $M$,
and (b) $M/gM$ is Cohen-Macaulay with maximal regular
sequence $f_1, \ldots, f_{d-1}$.
\end{lemma}

\begin{proof}
We prove the lemma by induction on $d$.
If $d = 0$, then $M$ is finite and there is no case
to which the lemma applies.
If $d = 1$, then we have to show that $g : M \to M$ is
injective. The kernel $K$ has support $\{\mathfrak m\}$
because by assumption $\dim \text{Supp}(M) \cap V(g) = 0$.
Hence $K$ has finite length. Hence $f_1 : K \to K$ injective
implies the length of the image is the length of $K$, and hence
$f_1 K = K$, which by Nakayama's Lemma \ref{lemma-NAK} implies $K = 0$.
Also, $\dim \text{Supp}(M/gM) = 0$ and so $M/gM$ is Cohen-Macaulay
of depth $0$.

\medskip\noindent
For $d > 1$ we essentially argue in the same way. Let $K \subset M$
be the kernel of multiplication by $g$. As above $f_1 : K \to K$
cannot be surjective if $K \not= 0$
Consider the commutative diagram
$$
\begin{matrix}
0 & \to & M & \xrightarrow{f_1} & M & \to & M/f_1M & \to & 0 \\
& & \downarrow{g} & & \downarrow{g} & & \downarrow{g} && \\
0 & \to & M & \xrightarrow{f_1} & M & \to & M/f_1M & \to & 0 \\
\end{matrix}
$$
This shows that the kernel $K_1$ of $g : M/f_1M \to M/f_1M$
cannot be zero if $K$ is not zero. But $g$ is good for
$(M/f_1M, f_2, \ldots, f_d)$, as is easy seen from the definition.
We conclude that $K_1 = 0$, and so $K = 0$. From the snake
lemma we see that
$0 \to M/gM \to M/gM \to M/(f_1, g)M \to 0$
is exact. By induction, we have that $M/(g, f_1)M$
is Cohen-Macaulay with regular sequence $f_2, \ldots, f_{d-1}$.
Thus $M/gM$ is Cohen-Macaulay with regular sequence $f_1, \ldots, f_{d-1}$.
\end{proof}

\begin{lemma}
\label{lemma-CM-one-g}
Let $R$ be a Noetherian local ring.
Let $M$ be a Cohen-Macaulay module over $R$.
Suppose $g \in \mathfrak m$ is such that $\dim(\text{Supp}(M) \cap V(g))
= \dim(\text{Supp}(M)) - 1$. Then (a) $g$ is a nonzero divisor on $M$,
and (b) $M/gM$ is Cohen-Macaulay of depth one less.
\end{lemma}

\begin{proof}
Choose a $M$-regular sequence $f_1, \ldots, f_d$ with
$d = \dim(\text{Supp}(M))$. If $g$ is is good with respect to
$(M, f_1, \ldots, f_d)$ we win by Lemma \ref{lemma-good-element}.
In particular the lemma holds if $d = 1$. (The case $d = 0$ does
not occur.) Assume $d > 1$. Choose an element $h \in R$ such that
(a) $h$ is good with respect to $(M, f_1, \ldots, f_d)$,
and (b) $\dim( \text{Supp}(M) \cap V(h, g) = d - 2$.
To see $h$ exists, let $\{\mathfrak q_i\}$ be the (finite) set of
minimal primes of the closed sets $\text{Supp}(M)$,
$\text{Supp}(M)\cap V(f_1, \ldots, f_i)$, $i = 1, \ldots, d-1$,
and $\text{Supp}(M) \cap V(g)$. None of these $\mathfrak q_i$
is equal to $\mathfrak m$ and hence we may find $h \in \mathfrak m$,
$h \not \in \mathfrak q_i$ by Lemma \ref{lemma-silly}. It is clear
that $h$ satisfies (a) and (b). At this point we may
apply Lemma \ref{lemma-good-element} to conclude that
$M/hM$ is Cohen-Macaulay. By (b) we see that the pair
$(M/hM, g)$ satisfies the induction hypothesis. Hence
$M/(h, g)M$ is Cohen-Macaulay, and $g : M/hM \to M/hM$
is injective. From this it follows easily that
$g : M \to M$ is injective, by a snake lemma argument.
This in its turn implies that $h : M/gM \to M/gM$
is injective. Combined with the fact that $M/(g, h)M$
is Cohen-Macaulay this finishes the proof.
\end{proof}

\begin{proposition}
\label{proposition-CM-module}
Let $R$ be a Noetherian local ring, with maximal ideal $\mathfrak m$.
Let $M$ be a Cohen-Macaulay module over $R$ whose support has dimension $d$.
Suppose that $g_1, \ldots, g_c$ are elements of
$\mathfrak m$ such that $\dim(\text{Supp}(M/(g_1, \ldots, g_c)M))
= d - c$. Then $g_1, \ldots, g_c$ is an $M$-regular sequence,
and can be extended to a maximal $M$-regular sequence.
\end{proposition}

\begin{proof}
Let $Z = \text{Supp}(M) \subset \text{Spec}(R)$.
By Lemma \ref{lemma-one-equation} in the chain
$Z \supset Z \cap V(g_1) \supset \ldots \supset Z \cap V(g_1, \ldots, g_c)$
each step decreases the dimension at most by $1$. Hence by assumption
each step decreases the dimension by exactly $1$ each time. Thus we
may succesively apply Lemma \ref{lemma-CM-one-g} above to the modules
$M/(g_1, \ldots, g_i)$ and the element $g_{i + 1}$.

\medskip\noindent
To extend $g_1, \ldots, g_c$ by one element if $c < d$ we simply
choose an element $g_{c + 1} \in \mathfrak m$ which is not
in any of the finitely many minimal primes of $Z \cap V(g_1, \ldots, g_c)$,
using Lemma \ref{lemma-silly}.
\end{proof}












\section{Cohen-Macaulay rings}
\label{section-CM-ring}

\begin{definition}
\label{definition-local-ring-CM}
A Noetherian local ring $R$ is called {\it Cohen-Macaulay}
if it is Cohen-Macaulay as a module over itself.
\end{definition}

\noindent
Note that this is equivalent to requiring the existence
of a $R$-regular sequence $x_1, \ldots, x_d$ of the maximal
ideal such that $R/(x_1, \ldots, x_d)$ has dimension $0$.
We will usually just say ``regular sequence'' and not
``$R$-regular sequence''.

\begin{lemma}
\label{lemma-reformulate-CM}
Let $R$ be a Noetherian local Cohen-Macaulay ring with maximal
ideal $\mathfrak m $. Let $x_1, \ldots, x_c \in \mathfrak m$ be
elements. Then
$$
x_1, \ldots, x_c
\text{ is a regular sequence }
\Leftrightarrow
\dim(R/(x_1, \ldots, x_c)) = \dim(R) - c
$$
If so
$x_1, \ldots, x_c$ can be extended to
a regular sequence of length $\dim(R)$ and each quotient
$R/(x_1, \ldots, x_i)$ is a Cohen-Macaulay ring of dimension
$\dim(R) - i$.
\end{lemma}

\begin{proof}
This is a reformulation of Proposition \ref{proposition-CM-module}
in the case where the module is equal to $R$.
\end{proof}

\begin{lemma}
\label{lemma-maximal-chain-CM}
Let $R$ be Noetherian local.
Suppose $R$ is Cohen-Macaulay of dimension $d$.
Any maximal chain of ideals $\mathfrak p_0 \subset
\mathfrak p_1 \subset \ldots \subset \mathfrak p_n$
has length $n = d$.
\end{lemma}

\begin{proof}
Choose an element $x \in \mathfrak p_1$, with $x$ not in
any of the minimal primes of $R$, and in particular
$x \not \in \mathfrak p_0$. (See Lemma \ref{lemma-silly}.)
Then $\dim (R/xR) < \dim (R)$ and $R/xR$ is Cohen-Macaulay
by Proposition \ref{proposition-CM-module}. By induction
the chain $\mathfrak p_1/xR \subset \ldots \mathfrak p_n/xR$
has length $d - 1$.
\end{proof}

\begin{lemma}
\label{lemma-CM-dim-formula}
Suppose $R$ is a Noetherian local Cohen-Macaulay ring of dimension $d$.
For any prime $\mathfrak p \subset R$ we have
$$
\dim(R) = \dim(R_{\mathfrak p}) + \dim(R/\mathfrak p).
$$
\end{lemma}

\begin{proof}
This is immediate from the result on maximal sequences
above, by looking at maximal sequences which have $\mathfrak p$
in them.
\end{proof}

\begin{lemma}
\label{lemma-localize-CM}
Suppose $R$ is a Cohen-Macaulay local ring.
For any prime $\mathfrak p \subset R$ the
ring $R_{\mathfrak p}$ is Cohen-Macaulay as well.
\end{lemma}

\begin{proof}
Suppose that $\dim(R) = d$ and that $\dim(R/\mathfrak p) = d - c$.
We may choose $f_1, \ldots, f_c \in \mathfrak p$ such that
$\dim V(f_1, \ldots, f_i) = d - i$, using Lemma \ref{lemma-silly}
at each step to avoid minimal primes of $V(f_1, \ldots, f_{i-1})$.
Then $\mathfrak p$ is minimal over $(f_1, \ldots, f_c)$ and hence
the support of $R_{\mathfrak p}/(f_1, \ldots, f_c)R_{\mathfrak p}$ consists
of the maximal ideal of $R_{\mathfrak p}$. In other words
$R_{\mathfrak p}$ has an ideal of definition generated by
$c$ elements, and has dimension $c$ by Lemma \ref{lemma-CM-dim-formula}.
\end{proof}

\begin{definition}
\label{definition-ring-CM}
A Noetherian ring $R$ is called {\it Cohen-Macaulay} if all
its local rings are Cohen-Macaulay.
\end{definition}

\begin{lemma}
\label{lemma-CM-polynomial-algebra}
Suppose $R$ is a Cohen-Macaulay ring.
Any polynomial algebra over $R$ is Cohen-Macaulay.
\end{lemma}

\begin{proof}
By induction on the number of variables it suffices
to prove that $R[x]$ is Cohen-Macaulay if $R$ is.
Let $\mathfrak q \subset R[x]$ be a prime, and
let $\mathfrak p$ be its image.
Let $f_1, \ldots, f_d$ be a regular sequence
in the maximal ideal of $R_{\mathfrak p}$ of length
$d = \dim(R_{\mathfrak p})$. Note that since
$R[x]$ is flat over $R$ the localization
$R[x]_{\mathfrak q}$ is flat over $R_{\mathfrak p}$.
Hence, by Lemma \ref{lemma-flat-increases-depth}, the sequence
$f_1, \ldots, f_d$
is a regular sequence of length $d$ in $R[x]_{\mathfrak q}$.
The quotient $R[x]_{\mathfrak q}/(f_1, \ldots, f_d)$
is a localization of $(R_{\mathfrak p}/(f_1, \ldots, f_d))[x]$
at a prime $\overline{\mathfrak q}$. It is clear that
either $\overline{\mathfrak q}$ contains a monic
polynomial $f$ in $(R_{\mathfrak p}/(f_1, \ldots, f_d))[x]$,
or $\overline{\mathfrak q}$ equals the kernel of
$(R_{\mathfrak p}/(f_1, \ldots, f_d))[x] \to \kappa(\mathfrak p)[x]$.
In the first case the monic polynomial $f$ is a nonzero
divisor in $(R_{\mathfrak p}/(f_1, \ldots, f_d))[x]$ and hence
in $R[x]_{\mathfrak q}/(f_1, \ldots, f_d)$, and $x_1, \ldots, x_d, f$
is a regular sequence in $R[x]_{\mathfrak q}$
such that $\dim(R[x]_{\mathfrak q}/(x_1, \ldots, x_d, f)) = 0$.
In the second case it is already the case that
$\dim R[x]_{\mathfrak q}/(f_1, \ldots, f_d) = 0$.
\end{proof}


\begin{lemma}
\label{lemma-dimension-shift}
Suppose that $R$ is a Noetherian local Cohen-Macaulay ring of dimension $d$.
Suppose that $M$ is a finite $R$-module, and suppose that
$0 \to K \to R^{n} \to M \to 0$ is an exact sequence of $R$-modules.
Then either $\text{depth}(K) > \text{depth}(M)$, or
$\text{depth}(K) = \text{depth}(M) = d$.
\end{lemma}

\begin{proof}
If $\text{depth}(M) = 0$ the lemma is clear.
Let $x \in \mathfrak m$ be a nonzero divisor on $M$ and
on $R$. Then $x$ is a nonzero divisor on $M$ and on $K$
and it follows by an easy diagram chase that
$0 \to K/xK \to (R/xR)^n \to M/xM \to 0$ is exact.
Thus the result follows from the result for $K/xK$
over $R/xR$ which has smaller dimension.
\end{proof}

\begin{definition}
\label{definition-maximal-CM}
Let $R$ be a Noetherian local Cohen-Macaulay ring.
A finite module $M$ over $R$ is called a {\it maximal
Cohen-Macaulay} module if $\text{depth}(M) = \dim(R)$.
\end{definition}

\begin{lemma}
\label{lemma-mcm-resolution}
Let $R$ be a local Noetherian Cohen-Macaulay ring of dimension $d$
Let $M$ be a finite $R$ module of depth $e$.
There exists an exact complex
$$
0 \to K \to F_{d-e-1} \to \ldots \to F_0 \to M \to 0
$$
with each $F_i$ finite free and $K$ maximal Cohen-Macaulay.
\end{lemma}

\begin{proof}
Immediate from the definition and Lemma \ref{lemma-dimension-shift}.
\end{proof}








\section{Catenary rings}
\label{section-catenary}

\begin{definition}
\label{definition-catenary}
A ring $R$ is said to be {\it catenary} if for any pair of prime ideals
$\mathfrak p \subset \mathfrak q$, all maximal chains of primes
$\mathfrak p = \mathfrak p_0 \subset \mathfrak p_1 \subset \ldots \subset
\mathfrak p_e = \mathfrak q$ have the same (finite) length.
\end{definition}

\begin{lemma}
\label{lemma-catenary}
A ring $R$ is catenary if and only if the topological space
$\text{Spec}(R)$ is catenary (see
Topology, Definition \ref{topology-definition-catenary}).
\end{lemma}

\begin{proof}
Immediate from the definition and the characterization of
irreducible closed subsets.
\end{proof}

\begin{lemma}
\label{lemma-localization-catenary}
Any localization of a catenary ring is catenary.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-quotient-catenary}
Any quotient of a catenary ring is catenary.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\noindent
In general it is not the case that a finitely generated
$R$-algebra is catenary if $R$ is. Thus we make the following
definition.

\begin{definition}
\label{definition-universally-catenary}
A ring $R$ is said to be {\it universally catenary}
if $R$ is Noetherian and every $R$ algebra of finite
type is catenary.
\end{definition}

\noindent
By Lemma \ref{lemma-quotient-catenary}
this just means that $R$ is Noetherian
and that each polynomial algebra $R[x_1, \ldots, x_n]$
is catenary.

\begin{lemma}
\label{lemma-CM-ring-catenary}
A Cohen-Macaulay ring is universally catenary.
\end{lemma}

\begin{proof}
Since a polynomial algebra over $R$ is Cohen-Macaulay,
by Lemma \ref{lemma-CM-polynomial-algebra},
it suffices to show that a Cohen-Macaulay ring is
catenary.
Let $R$ be Cohen-Macaulay and $\mathfrak p \subset \mathfrak q$
primes of $R$. By definition $R_{\mathfrak q}$ and
$R_{\mathfrak p}$ are Cohen-Macaulay.
Take a maximal chain of primes
$\mathfrak p = \mathfrak p_0 \subset \mathfrak p_1 \subset
\ldots \subset \mathfrak p_n = \mathfrak q$.
Next choose a maximal chain of primes
$\mathfrak q_0 \subset \mathfrak q_1 \subset \ldots \subset
\mathfrak q_m = \mathfrak p$.
By \ref{lemma-maximal-chain-CM} we have
$n + m = \dim(R_{\mathfrak q})$. And we have
$m = \dim(R_{\mathfrak p})$ by the same lemma.
Hence $n = \dim(R_{\mathfrak q}) - \dim(R_{\mathfrak p})$
is independent of choices.
\end{proof}















\section{Regular rings}
\label{section-regular}

\noindent
It is not that easy to show that all prime localizations of a regular local
are regular. In fact, quite a bit of the material developped sofar is
geared towards a proof of this fact. See
Proposition \ref{proposition-finite-gl-dim-regular}, and
trace back the references.

\begin{lemma}
\label{lemma-regular-graded}
Let $R$ be a regular local ring with maximal ideal $\mathfrak m$.
The graded ring $\bigoplus \mathfrak m^n / \mathfrak m^{n + 1}$
is isomorphic to the graded polynomial algebra
$\kappa(\mathfrak m)[X_1, \ldots, X_d]$.
\end{lemma}

\begin{proof}
Let $x_1, \ldots, x_d$ be a minimal set of generators
for the maximal ideal $\mathfrak m$.
Write $\kappa = \kappa(\mathfrak m)$.
There is a surjection $\kappa[X_1, \ldots, X_d]
\to \bigoplus \mathfrak m^n/\mathfrak m^{n + 1}$,
which maps the class of $x_i$ in $\mathfrak m/\mathfrak m^2$
to $X_i$. Since $d(R) = d$ we know that the numerical
polynomial $n \mapsto \dim_\kappa \mathfrak m^n/\mathfrak m^{n + 1}$
has degree $d$. By Lemma \ref{lemma-quotient-smaller-d} we
conclude that the surjection $\kappa[X_1, \ldots, X_d]
\to \bigoplus \mathfrak m^n/\mathfrak m^{n + 1}$ is an isomorphism.
\end{proof}

\begin{lemma}
\label{lemma-regular-domain}
Any regular local ring is a domain.
\end{lemma}

\begin{proof}
We will use that $\bigcap \mathfrak m^n = 0$
by Lemma \ref{lemma-intersect-powers-ideal-module-zero}.
Let $f, g \in R$ such that $fg = 0$.
Suppose that $f \in \mathfrak m^a$ and
$g \in \mathfrak m^b$, with $a, b$ maximal.
Since $fg = 0 \in \mathfrak m^{a + b + 1}$
we see from the result of Lemma \ref{lemma-regular-graded}
that either $f \in \mathfrak m^{a + 1}$ or
$g \in \mathfrak m^{b + 1}$. Contradiction.
\end{proof}

\begin{lemma}
\label{lemma-regular-ring-CM}
Let $R$ be a regular local ring and let
$x_1, \ldots, x_d$ be a minimal set of generators
for the maximal ideal $\mathfrak m$. Then
$x_1, \ldots, x_d$ is a regular sequence, and
each $R/(x_1, \ldots, x_c)$ is a regular local ring
of dimension $d - c$. In particular $R$ is Cohen-Macaulay.
\end{lemma}

\begin{proof}
Note that $R/x_1R$ is a Noetherian local ring of dimension $\geq d - 1$
by Lemma \ref{lemma-one-equation} with $x_2, \ldots, x_d$
generating the maximal ideal. Hence it is regular by definition.
Since $R$ is a domain by Lemma \ref{lemma-regular-domain}
$x_1$ is a nonzero divisor.
\end{proof}

\begin{lemma}
\label{lemma-regular-quotient-regular}
Let $R$ be a regular local ring. Let $I \subset R$ be an ideal
such that $R/I$ is a regular local ring as well. Then
there exists a minimal set of generators $x_1, \ldots, x_d$
for the maximal $\mathfrak m$ of $R$ such that
$I = (x_1, \ldots, x_c)$ for some $0 \leq c \leq d$.
\end{lemma}

\begin{proof}
Say $\dim(R) = d$ and $\dim(R/I) = d - c$.
Denote $\overline{\mathfrak m} = \mathfrak m/I$ the
maximal ideal of $R/I$. Let $\kappa = R/\mathfrak m$. We have
$\dim_\kappa(I/\mathfrak m^2) = \dim_\kappa(\mathfrak m/\mathfrak m^2)
- \dim(\overline{\mathfrak m}/\overline{\mathfrak m}^2) = d - (d -c) = c$
by the definition of a regular local ring. Hence we can choose
$x_1, \ldots, x_c \in I$ whose images in $\mathfrak m/\mathfrak m^2$
are linearly independent, and supplement with
$x_{c + 1}, \ldots, x_d$ to get a minimal system of generators.
\end{proof}

\begin{lemma}
\label{lemma-free-mod-x}
Let $R$ be a Noetherian local ring.
Let $x \in \mathfrak m$.
Let $M$ be a finite $R$-module such that
$x$ is a nonzero divisor on $M$ and
$M/xM$ is free over $R/xR$.
Then $M$ is free over $R$.
\end{lemma}

\begin{proof}
Let $m_1, \ldots, m_r$ be elements of $M$ which map to
a $R/xR$-basis of $M/xM$. By Nakayama's Lemma \ref{lemma-NAK}
$m_1, \ldots, m_r$ generate $M$. If $\sum a_i m_i = 0$
is a relation, then $a_i \in xR$ for all $i$. Hence
$a_i = b_i x$ for some $b_i \in R$. Hence
the kernel $K$ of $R^r \to M$ satisfies $xK = K$
and hence is zero by Nakayama's lemma.
\end{proof}

\begin{lemma}
\label{lemma-regular-mcm-free}
Let $R$ be a local Noetherian regular ring.
Any maximal Cohen-Macaulay module over $R$ is
free.
\end{lemma}

\begin{proof}
Let $M$ be a maximal Cohen-Macaulay module over $R$.
Let $x \in \mathfrak m$ be part of a regular sequence
generating $\mathfrak m$. Then $x$ is a nonzero divisor
on $M$ by Proposition \ref{proposition-CM-module}, and
$M/xM$ is a maximal Cohen-Macaulay module over $R/xR$.
By induction on $\dim(R)$ we see that $M/xM$ is free.
We win by Lemma \ref{lemma-free-mod-x}.
\end{proof}

\begin{lemma}
\label{lemma-regular-mod-x}
Suppose $R$ is a Noetherian local ring.
Let $x \in \mathfrak m$ be a nonzero divisor
such that $R/xR$ is regular. Then $R$ is regular.
\end{lemma}

\begin{proof}
This is true because $x$ together with the lifts of a system
of minimal generators of the maximal ideal of $R/xR$ will give
$\dim(R)$ generators of $\mathfrak m$.
Use Lemma \ref{lemma-one-equation}.
\end{proof}







\section{Epimorphisms of rings}
\label{section-epimorphism}

\noindent
In any category there is a notion of an {\it epimorphism}.
Some of this material is taken from \cite{Autour} and \cite{Mazet}.

\begin{lemma}
\label{lemma-epimorphism}
Let $R \to S$ be a ring map. The following are equivalent
\begin{enumerate}
\item $R \to S$ is an epimorphism,
\item the two ring maps $S \to S \otimes_R S$ are equal,
\item either of the ring maps $S \to S \otimes_R S$ is an isomorphism, and
\item the ring map $S \otimes_R S \to S$ is an isomorphism.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-composition-epimorphism}
The composition of two epimorphisms of rings is an epimorphism.
\end{lemma}

\begin{proof}
Omitted. Hint: This is true in any category.
\end{proof}

\begin{lemma}
\label{lemma-base-change-epimorphism}
If $R \to S$ is an epimorphism of rings and $R \to R'$ is any ring map,
then $R' \to R' \otimes_R S$ is an epimorphism.
\end{lemma}

\begin{proof}
Omitted. Hint: True in any category with pushouts.
\end{proof}

\begin{lemma}
\label{lemma-permanence-epimorphism}
If $A \to B \to C$ are ring maps and $A \to C$ is an epimorphism, so is
$B \to C$.
\end{lemma}

\begin{proof}
Omitted. Hint: This is true in any category.
\end{proof}

\noindent
This means in particular, that if $R \to S$ is an epimorphism with
image $\overline{R} \subset S$, then $\overline{R} \to S$ is an epimorphism.
Hence while proving results for epimorphisms we may often assume
the map is injective.

\begin{lemma}
\label{lemma-epimorphism-local}
Let $R \to S$ be a ring map. The following are equivalent:
\begin{enumerate}
\item $R \to S$ is an epimorphism, and
\item $R_{\mathfrak p} \to S_{\mathfrak p}$ is an epimorphism for
each prime $\mathfrak p$ of $R$.
\end{enumerate}
\end{lemma}

\begin{proof}
Since $S_{\mathfrak p} = R_{\mathfrak p} \otimes_R S$ (see
Lemma \ref{lemma-tensor-localization})
we see that (1) implies (2) by
Lemma \ref{lemma-base-change-epimorphism}.
Conversely, assume that (2) holds. Let $a, b : S \to A$ be two ring maps
from $S$ to a ring $A$ equalizing the maop $R \to S$. By assumption we see
that for evey prime $\mathfrak p$ of $R$ the induced maps
$a_{\mathfrak p}, b_{\mathfrak p} : S_{\mathfrak p} \to A_{\mathfrak p}$ are
the same. Hence $a = b$ as $A \subset \prod_{\mathfrak p} A_{\mathfrak p}$, see
Lemma \ref{lemma-characterize-zero-local}.
\end{proof}

\begin{lemma}
\label{lemma-finite-epimorphism-surjective}
Let $R \to S$ be a ring map. The following are equivalent
\begin{enumerate}
\item $R \to S$ is an epimorphism and finite, and
\item $R \to S$ is surjective.
\end{enumerate}
\end{lemma}

\begin{proof}
(This lemma seems to have been reproved many times in the literature, and
has many different proofs.)
It is clear that a surjective ring map is an epimorphism.
Suppose that $R \to S$ is a finite ring map such that
$S \otimes_R S \to S$ is an isomorphism. Our goal is to show that
$R \to S$ is surjective. Assume $S/R$ is not zero.
The exact sequence $R \to S \to S/R \to 0$
leads to an exact sequence
$$
R \otimes_R S \to S \otimes_R S \to S/R \otimes_R S \to 0.
$$
Our assumption implies that the first arrow is an isomorphism, hence
we conclude that $S/R \otimes_R S = 0$. Hence also $S/R \otimes_R S/R = 0$. By
Lemma \ref{lemma-trivial-filter-finite-module}
there exists a surjection of $R$-modules $S/R \to R/I$ for some proper
ideal $I \subset R$. Hence there exists a
surjection $S/R \otimes_R S/R \to R/I \otimes_R R/I = R/I \not = 0$,
contradiction.
\end{proof}

\begin{lemma}
\label{lemma-faithfully-flat-epimorphism}
A faithfully flat epimorphism is an isomorphism.
\end{lemma}

\begin{proof}
This is clear from
Lemma \ref{lemma-epimorphism} part (3)
as the map $S \to S \otimes_R S$ is the map $R \to S$ tensored with $S$.
\end{proof}

\begin{lemma}
\label{lemma-epimorphism-over-field}
If $k \to S$ is an epimorphism and $k$ is a field, then $S = k$ or $S = 0$.
\end{lemma}

\begin{proof}
This is clear from the result of
Lemma \ref{lemma-faithfully-flat-epimorphism}
(as any nonzero algebra over $k$ is faithfully flat), or
by argueing directly that $R \to R \otimes_k R$ cannot be
surjective unless $\dim_k(R) \leq 1$.
\end{proof}

\begin{lemma}
\label{lemma-epimorphism-injective-spec}
Let $R \to S$ be an epimorphism of rings.
Then $\text{Spec}(S) \to \text{Spec}(R)$ is injective.
\end{lemma}

\begin{proof}
Let $\mathfrak p$ be a prime of $R$. The fibre of the map is the spectrum
of the fibre ring $S \otimes_R \kappa(\mathfrak p)$. By
Lemma \ref{lemma-base-change-epimorphism}
the map $\kappa(\mathfrak p) \to S \otimes_R \kappa(\mathfrak p)$
is an epimorphism, and hence by
Lemma \ref{lemma-epimorphism-over-field}
there is either one point or no points lying over $\mathfrak p$.
\end{proof}

\begin{lemma}
\label{lemma-relations}
Let $R$ be a ring.
Let $M$, $N$ be $R$-modules.
Let $\{x_i\}_{i \in I}$ be a set of generators of $M$.
Let $\{y_j\}_{j \in J}$ be a set of generators of $N$.
Let $\{m_j\}_{j \in J}$ be a family of elements of $M$ with $m_j = 0$
for all but finitely many $j$.
Then
$$
\sum\nolimits_{j \in J} m_j \otimes y_j = 0 \text{ in } M \otimes_R N
$$
is equivalent to the following:
There exist $a_{i, j} \in R$ with $a_{i, j} = 0$ for all but finitely many
pairs $(i, j)$ such that
\begin{align*}
m_j = \sum a_{i, j} x_i, \quad j \in J \\
0 = \sum a_{i, j} y_j, \quad i \in I
\end{align*}
\end{lemma}

\begin{proof}
The sufficiency is immediate. Suppose that
$\sum_{j \in J} m_j \otimes y_j = 0$.
Consider the short exact sequence
$$
0 \to K \to \bigoplus\nolimits_{j \in J} R \to N \to 0
$$
where the $j$th basis vector of $\bigoplus\nolimits_{j \in J} R$ maps
to $y_j$. Tensor this with $M$ to get the exact sequence
$$
K \otimes_R M \to \bigoplus\nolimits_{j \in J} M \to N \otimes_R M \to 0.
$$
The assumption implies that there exist elements $k_i \in K$ such that
$\sum k_i \otimes x_i$ maps to the element $(m_j)_{j \in J}$ of the middle.
Writing $k_i = (a_{i, j})_{j \in J}$ and we obtain what we want.
\end{proof}

\begin{lemma}
\label{lemma-kernel-difference-projections}
Let $\varphi : R \to S$ be a ring map.
Let $g \in S$. The following are equivalent:
\begin{enumerate}
\item $g \otimes 1 = 1 \otimes g$ in $S \otimes_R S$, and
\item there exist $n \geq 0$ and elements $y_i, z_j \in S$
and $x_{i, j} \in R$ for $1 \leq i, j \leq n$ such that
\begin{enumerate}
\item $g = \sum_{i, j \leq n} x_{i, j} y_i z_j$,
\item for each $j$ we have $\sum x_{i, j}y_i \in \varphi(R)$, and
\item for each $i$ we have $\sum x_{i, j}z_j \in \varphi(R)$.
\end{enumerate}
\end{enumerate}
\end{lemma}

\begin{proof}
It is clear that (2) implies (1). Conversely, suppose that
$g \otimes 1 = 1 \otimes g$. Choose generators $\{s_i\}_{i \in I}$
of $S$ as an $R$-module with $0,1 \in I$ and $s_0 = 1$ and $s_1 = g$.
Apply
Lemma \ref{lemma-relations}
to the relation $g \otimes s_0 + (-1) \otimes s_1 = 0$.
We see that there exist $a_{i, j} \in R$ such that
$g = \sum_i a_{i, 0} s_i$, $-1 = \sum_i a_{i, 1} s_i$, and for
$j \not = 0, 1$ we have $0 = \sum_i a_{i, j} s_i$, and moreover
for all $i$ we have $\sum_j a_{i, j}s_j = 0$.
Then we have
$$
\sum\nolimits_{i, j \not = 0} a_{i, j} s_i s_j = -g + a_{0, 0}
$$
and for each $j \not = 0$ we have
$\sum_{i \not = 0} a_{i, j}s_i \in R$. This proves that $-g + a_{0, 0}$
can be written as in (2). It follows that $g$ can be written as
in (2). Details omitted.
Hint: Show that the set of elements of $S$ which have an
expression as in (2) form an $R$-subalgebra of $S$.
\end{proof}

\begin{remark}
\label{remark-matrices-associated-to-elements-epicenter}
Let $R \to S$ be a ring map. Sometimes the set of elements
$g \in S$ such that $g \otimes 1 = 1 \otimes g$ is called the
{\it epicenter} of $S$. It is an $R$-algebra. By the construction of
Lemma \ref{lemma-kernel-difference-projections}
we get for each $g$ in the epicenter a matrix factorization
$$
(g) = Y X Z
$$
with $X \in \text{Mat}(n \times n, R)$,
$Y \in \text{Mat}(1 \times n, S)$, and
$Z \in \text{Mat}(n \times 1, S)$. Namely, let $x_{i, j}, y_i, z_j$
be as in part (2) of the lemma. Set $X = (x_{i, j})$, let $y$ be the
row vector whose entries are the $y_i$ and let $z$ be the column vector
whose entries are the $z_j$. With this notation conditions (b) and (c) of
Lemma \ref{lemma-kernel-difference-projections}
mean exactly that $Y X \in \text{Mat}(1 \times n, R)$,
$X Z \in \text{Mat}(n \times 1, R)$.
It turns out to be very convenient to consider the triple of
matrices $(X, YX, XZ)$. Given $n \in \mathbf{N}$ and a triple
$(P, U, V)$ we say that $(P, U, V)$ is a {\it $n$-triple associated to $g$}
if there exists a matrix factorization as above such that
$P = X$, $U = YX$ and $V = XZ$.
\end{remark}

\begin{lemma}
\label{lemma-epimorphism-cardinality}
Let $R \to S$ be an epimorphism of rings.
Then the cardinality of $S$ is at most the cardinality of $R$.
In a formula: $|S| \leq |R|$.
\end{lemma}

\begin{proof}
The condition that $R \to S$ is an epimorphism means that each $g \in S$
satisfies $g \otimes 1 = 1 \otimes g$, see
Lemma \ref{lemma-epimorphism}.
We are going to use the notation introduced in
Remark \ref{remark-matrices-associated-to-elements-epicenter}.
Suppose that $g, g' \in S$ and suppose that $(P, U, V)$ is an $n$-triple
which is associated to both $g$ and $g'$. Then we claim that
$g = g'$. Namely, write $(P, U, V) = (X, YX, XZ)$ for a matrix
factorization $(g) = YXZ$ of $g$ and write $(P, U, V) = (X', Y'X', X'Z')$
for a matrix factorization $(g) = Y'X'Z'$ of $g$.
Then we see that
$$
(g) = YXZ = UZ = Y'X'Z = Y'PZ = Y'XZ = Y'V = Y'X'Z' = (g')
$$
and hence $g = g'$. This implies that the cardinality of $S$ is bounded
by the number of possible triples, which has cardinality at most
$\sup_{n \in \mathbf{N}} |R|^n$. If $R$ is infinite then this is
at most $|R|$, see \cite[Ch. I, 10.13]{Kunen}.

\medskip\noindent
If $R$ is a finite ring then the argument above only proves that $S$
is at worst countable. In fact in this case $R$ is Artinian and the
map $R \to S$ is surjective. We omit the proof of this case.
\end{proof}




\section{Pure ideals}
\label{section-pure-ideals}

\noindent
The material in this section is discussed in many papers, see for example
\cite{Lazard}, \cite{Bkouche}, and \cite{DeMarco}.

\begin{definition}
\label{definition-pure-ideal}
Let $R$ be a ring. We say that $I \subset R$ is {\it pure}
if the quotient ring $R/I$ is flat over $R$.
\end{definition}

\begin{lemma}
\label{lemma-pure}
Let $R$ be a ring.
Let $I \subset R$ be an ideal.
The following are equivalent:
\begin{enumerate}
\item $I$ is pure,
\item for every ideal $J \subset R$ we have $J \cap I = IJ$,
\item for every finitely generated ideal $J \subset R$ we have
$J \cap I = JI$,
\item for every $x \in R$ we have $(x) \cap I = xI$,
\item for every $x \in I$ we have $x = yx$ for some $y \in I$,
\item for every $x_1, \ldots, x_n \in I$ there exists a
$y \in I$ such that $x_i = yx_i$ for all $i = 1, \ldots, n$,
\item for every prime $\mathfrak p$ of $R$ we have
$IR_{\mathfrak p} = 0$ or $IR_{\mathfrak p} = R_{\mathfrak p}$,
\item $\text{Supp}(I) = \text{Spec}(R) \setminus V(I)$,
\item $I$ is the kernel of the map $R \to (1 + I)^{-1}R$,
\item $R/I \cong S^{-1}R$ as $R$-algebras for some multiplicative
subset $S$ of $R$, and
\item $R/I \cong (1 + I)^{-1}R$ as $R$-algebras.
\end{enumerate}
\end{lemma}

\begin{proof}
For any ideal $J$ of $R$ we have the short exact sequence
$0 \to J \to R \to R/J \to 0$. Tensoring with $R/I$ we get
an exact sequence $J \otimes_R R/I \to R/I \to R/I + J \to 0$
and $J \otimes_R R/I = R/JI$. Thus the
equivalence of (1), (2), and (3) follows from
Lemma \ref{lemma-flat}. Moreover, these imply (4).

\medskip\noindent
The implication (4) $\Rightarrow$ (5) is trivial.
Assume (5) and let $x_1, \ldots, x_n \in I$.
Choose $y_i \in I$ such that $x_i = y_ix_i$.
Let $y \in I$ be the element such that
$1 - y = \prod_{i = 1, \ldots, n} (1 - y_i)$.
Then $x_i = yx_i$ for all $i = 1, \ldots, n$.
Hence (6) holds, and it follows that (5) $\Leftrightarrow$ (6).

\medskip\noindent
Assume (5). Let $x \in I$. Then $x = yx$ for some $y \in I$.
Hence $x(1 - y) = 0$, which shows that $x$ maps to zero in
$(1 + I)^{-1}R$. Of course the kernel of the map
$R \to (1 + I)^{-1}R$ is always contained in $I$. Hence we
see that (5) implies (9). Assume (9). Then for any $x \in I$
we see that $x(1 - y) = 0$ for some $y \in I$.
In other words, $x = yx$. We conclude that (5) is equivalent to (9).

\medskip\noindent
Assume (5). Let $\mathfrak p$ be a prime of $R$.
If $\mathfrak p \not \in V(I)$, then $IR_{\mathfrak p} = R_{\mathfrak p}$.
If $\mathfrak p \in V(I)$, in other words, if $I \subset \mathfrak p$,
then $x \in I$ implies $x(1 - y) = 0$ for some $y \in I$, implies
$x$ maps to zero in $R_{\mathfrak p}$, i.e., $IR_{\mathfrak p} = 0$.
Thus we see that (7) holds.

\medskip\noindent
Assume (7). Then $(R/I)_{\mathfrak p}$ is either $0$ or $R_{\mathfrak p}$
for any prime $\mathfrak p$ of $R$. Hence by
Lemma \ref{lemma-flat-localization}
we see that (1) holds. At this point we see that all of
(1) -- (7) and (9) are equivalent.

\medskip\noindent
As $IR_{\mathfrak p} = I_{\mathfrak p}$ we see that (7) implies (8).
Finally, if (8) holds, then this means exactly that $I_{\mathfrak p}$
is the zero module if and only if $\mathfrak p \in V(I)$, which
is clearly saying that (7) holds. Now (1) -- (9) are equivalent.

\medskip\noindent
Assume (1) -- (9) hold. Then $R/I \subset (1 + I)^{-1}R$ by (9) and
the map $R/I \to (1 + I)^{-1}R$ is also surjective by the description
of localizations at primes afforded by (7). Hence (11) holds.

\medskip\noindent
The implication (11) $\Rightarrow$ (10) is trivial.
And (10) implies that (1) holds because a localization of
$R$ is flat over $R$, see
Lemmma \ref{lemma-flat-localization}.
\end{proof}

\begin{lemma}
\label{lemma-pure-ideal-determined-by-zero-set}
Let $R$ be a ring.
If $I, J \subset R$ are pure ideals, then $V(I) = V(J)$
implies $I = J$.
\end{lemma}

\begin{proof}
For example, by property (7) of
Lemma \ref{lemma-pure}
we see that
$I = \text{ker}(R \to \prod_{\mathfrak p \in V(I)} R_{\mathfrak p})$
can be recovered from the closed subset associated to it.
\end{proof}

\begin{lemma}
\label{lemma-pure-open-closed-specializations}
Let $R$ be a ring. The rule
$I \mapsto V(I)$
determines a bijection
$$
\{I \subset R \text{ pure}\}
\leftrightarrow
\{Z \subset \text{Spec}(R)\text{ closed and closed under generalizations}\}
$$
\end{lemma}

\begin{proof}
Let $I$ be a pure ideal. Then since $R \to R/I$ is flat, by going up
generalizations lift along the map $\text{Spec}(R/I) \to \text{Spec}(R)$.
Hence $V(I)$ is closed under generalizations. This shows that the map
is well defined. By
Lemma \ref{lemma-pure-ideal-determined-by-zero-set}
the map is injective. Suppose that
$Z \subset \text{Spec}(R)$ is closed and closed under generalizations.
Let $J \subset R$ be the radical ideal such that $Z = V(J)$.
Let $I = \{x \in R : x \in xJ\}$. Note that $I$ is an ideal.
We claim that $I$ is pure and that $V(I) = V(J)$.
If the claim is true then the map of the lemma is surjective and
the lemma holds.

\medskip\noindent
Note that $I \subset J$, so that $V(J) \subset V(I)$.
Let $I \subset \mathfrak p$ be a prime. Consider the multiplicative
subset $S = (R \setminus \mathfrak p)(1 + J)$. By definition of
$I$ and $I \subset \mathfrak p$ we see that $0 \not \in S$.
Hence we can find a prime $\mathfrak q$ of $R$ which is disjoint
from $S$, see
Lemmas \ref{lemma-localization-zero} and
\ref{lemma-spec-localization}.
Hence $\mathfrak q \subset \mathfrak p$ and
$\mathfrak q \cap (1 + J) = \emptyset$.
This implies that $\mathfrak q + J$ is a proper ideal of $R$.
Let $\mathfrak m$ be a maximal ideal containing $\mathfrak q + J$.
Then we get
$\mathfrak m \in V(J)$ and hence $\mathfrak q \in V(J) = Z$
as $Z$ was assumed to be closed under generalization.
This in turn implies $\mathfrak p \in V(J)$ as
$\mathfrak q \subset \mathfrak p$. Thus we see that $V(I) = V(J)$.

\medskip\noindent
Finally, since $V(I) = V(J)$ (and $J$ radical) we see that $J = \sqrt{I}$.
Pick $x \in I$, so that $x = xy$ for some $y \in J$ by definition.
Then $x = xy = xy^2 = \ldots = xy^n$. Since $y^n \in I$ for some $n > 0$
we conclude that property (5) of
Lemma \ref{lemma-pure}
holds and we see that $I$ is indeed pure.
\end{proof}

\noindent
We can use the above to characterize those rings for which every finite
flat module is finitely presented.

\begin{lemma}
\label{lemma-finite-flat-module-finitely-presented}
Let $R$ be a ring. The following are equivalent:
\begin{enumerate}
\item every $Z \subset \text{Spec}(R)$ which is closed and closed under
generalizations is also open, and
\item any finite flat $R$-module is finite locally free.
\end{enumerate}
\end{lemma}

\begin{proof}
If any finite flat $R$-module is finite locally free then the support
of $R/I$ where $I$ is a pure ideal is open. Hence the implication
(2) $\Rightarrow$ (1) follows from
Lemma \ref{lemma-pure-ideal-determined-by-zero-set}.

\medskip\noindent
For the converse assume that $R$ satisfies (1).
Let $M$ be a finite flat $R$-module.
The support $Z = \text{Supp}(M)$ of $M$ is closed, see
Lemma \ref{lemma-support-closed}.
On the other hand, if $\mathfrak p \subset \mathfrak p'$, then by
Lemma \ref{lemma-finite-flat-local}
the module $M_{\mathfrak p'}$ is free, and
$M_{\mathfrak p} = M_{\mathfrak p'} \otimes_{R_{\mathfrak p'}} R_{\mathfrak p}$
Hence
$\mathfrak p' \in \text{Supp}(M) \Rightarrow \mathfrak p \in \text{Supp}(M)$,
in other words, the support is closed under generalization.
As $R$ satisfies (1) we see that the support of $M$ is open and closed.
Suppose that $M$ is generated by $r$ elements $m_1, \ldots, m_r$.
The modules $\wedge^i(M)$, $i = 1, \ldots, r$ are finite flat $R$-modules
also, because $\wedge^i(M)_{\mathfrak p} = \wedge^i(M_{\mathfrak p})$
is free over $R_{\mathfrak p}$. Note that
$\text{Supp}(\wedge^{i + 1}(M)) \subset \text{Supp}(\wedge^i(M))$.
Thus we see that there exists a decomposition
$$
\text{Spec}(R) = U_0 \coprod U_1 \coprod \ldots \coprod U_r
$$
by open and closed subsets such that the support of
$\wedge^i(M)$ is $U_r \cup \ldots \cup U_i$ for all $i = 0, \ldots, r$.
Let $\mathfrak p$ be a prime of $R$, and say $\mathfrak p \in U_i$.
Note that
$\wedge^i(M) \otimes_R \kappa(\mathfrak p) = 
\wedge^i(M \otimes_R \kappa(\mathfrak p))$.
Hence, after possibly renumbering $m_1, \ldots, m_r$ we may assume that
$m_1, \ldots, m_i$ generate $M \otimes_R \kappa(\mathfrak p)$. By
Nakayama's Lemma \ref{lemma-NAK}
we get a surjection
$$
R_f^{\oplus i} \longrightarrow M_f,\quad
(a_1, \ldots, a_i) \longmapsto \sum a_im_i
$$
for some $f \in R$, $f \not \in \mathfrak p$. We may also assume that
$D(f) \subset U_i$. This means that $\wedge^i(M_f) = \wedge^i(M)_f$
is a flat $R_f$ module whose support is all of $\text{Spec}(R_f)$.
By the above it is generated by a single element, namely
$m_1 \wedge \ldots \wedge m_i$. Hence $\wedge^i(M)_f \cong R_f/J$
for some pure ideal $J \subset R_f$ with $V(J) = \text{Spec}(R_f)$.
Clearly this means that $J = (0)$, see
Lemma \ref{lemma-pure-ideal-determined-by-zero-set}.
Thus $m_1 \wedge \ldots \wedge m_i$ is a basis for
$\wedge^i(M_f)$ and it follows that the displayed map is injective
as well as surjective. This proves that $M$ is finite locally free
as desired.
\end{proof}







\section{Rings of finite global dimension}
\label{section-ring-finite-gl-dim}

\noindent
The following lemma is often used to compare different
projective resolutions of a given module.

\begin{lemma}
\label{lemma-Schanuel}
(Schanuel's lemma.)
Let $R$ be a ring. Let $M$ be an $R$-module.
Suppose that $0 \to K \to P_1 \to M \to 0$
and $0 \to L \to P_2 \to M \to 0$ are two short exact
sequences, with $P_i$ projective.
Then $K \oplus P_2 \cong L \oplus P_1$.
\end{lemma}

\begin{proof}
Consider the module
$N$ defined by the short exaxt sequence
$0 \to N \to P_1 \oplus P_2 \to M \to 0$,
where the last map is the sum of the two maps
$P_i \to M$. It is easy to see that the projection
$N \to P_1$ is surjective with kernel $L$, and that
$N \to P_2$ is surjective with kernel $K$.
Since $P_i$ are projective we have $N \cong K \oplus P_2
\cong L \oplus P_1$.
\end{proof}

\begin{definition}
\label{definition-finite-proj-dim}
Let $R$ be a Noetherian ring.
A finite module $M$ over $R$ is said to have {\it finite
projective dimension} if it has a finite length resolution by finite
projective $R$-modules. The minimal length of such a
finite projective resolution is called the {\it projective
dimension} of $M$.
\end{definition}

\noindent
The following lemma explains to what extend the projective
dimension is independent of the choice of a finite projective
resolution.

\begin{lemma}
\label{lemma-independent-resolution}
Let $R$ be a Noetherian ring.
Suppose that $M$ is a finite $R$-module
of projective dimension $d$.
Suppose that $F_e \to F_{e-1} \to \ldots \to F_0 \to M \to 0$
is exact with $F_i$ finite projective and $e \geq d - 1$.
Then the kernel of $F_e \to F_{e-1}$ is finite projective
(or the kernel of $F_0 \to M$ is finite projective in case
$e = 0$).
\end{lemma}

\begin{proof}
We prove this by induction on $d$. If $d = 0$, then
$M$ is projective. In this case there is a splitting
$F_0 = \text{Ker}(F_0 \to M) \oplus M$, and hence
$\text{Ker}(F_0 \to M)$ is finite projective. This finishes
the proof if $e = 0$, and if $e > 0$, then replacing
$M$ by $\text{Ker}(F_0 \to M)$ we decrease $e$.

\medskip\noindent
Next assume $d > 0$.
Let $0 \to P_d \to P_{d-1} \to \ldots \to P_0 \to M \to 0$
be a minimal length finite resolution with $P_i$ finite projective.
According to Schanuel's Lemma \ref{lemma-Schanuel} we have
$P_0 \oplus \text{Ker}(F_0 \to M) \cong F_0 \oplus \text{Ker}(P_0 \to M)$.
This proves the case $d = 1$, $e = 0$, because then the right
hand side is $F_0 \oplus P_1$ which is projective. Hence now we may
assume $e > 0$. The module
$F_0 \oplus \text{Ker}(P_0 \to M)$ has the finite projective resolution
$0 \to P_d \oplus F_0 \to P_{d-1} \oplus F_0 \to \ldots \to P_1 \oplus F_0
\to \text{Ker}(P_0 \to M) \oplus F_0 \to 0$ of length $d - 1$.
By induction on $d$ we see that the kernel of
$F_{e} \oplus P_0 \to F_{e-1} \oplus P_0$ is finite projective.
This implies the lemma.
\end{proof}

\begin{definition}
\label{definition-finite-gl-dim}
Let $R$ be a Noetherian ring. The ring
$R$ is said to have {\it finite global dimension}
if there exists an integer $n$ such that
every finite $R$-module has a resolution by finite
projective $R$-modules of length at most $n$.
The minimal such $n$ is then called the {\it global dimension}
of $R$.
\end{definition}

\begin{proposition}
\label{proposition-regular-finite-gl-dim}
Let $R$ be a regular local ring of dimension $d$.
Every finite $R$-module $M$ of depth $e$ has a finite free
resolution
$$
0 \to F_{d-e} \to \ldots \to F_0 \to M \to 0.
$$
In particular a regular local ring has global dimension $\leq d$.
\end{proposition}

\begin{proof}
This is clear in view of Lemma \ref{lemma-regular-mcm-free}
and Lemma \ref{lemma-mcm-resolution}.
\end{proof}

\begin{lemma}
\label{lemma-localize-finite-gl-dim}
If $R$ is a Noetherian ring which has finite global dimension,
then any localization of $R$ has finite global dimension
at most the global dimension of $R$.
\end{lemma}

\begin{proof}
Let $S \subset R$ be a multiplicative subset.
Let $M'$ be a finite $S^{-1}R$-module.
Because $S^{-1}R$ is Noetherian $M'$ is finitely presented.
Say $M'$ is the cokernel of $A : (S^{-1}R)^m
\to (S^{-1}R)^n$. There exists an element $s$ of $S$ such
that $sA$ is the image of a matrix $B$ with coefficients in $R$.
Thus we see that $M = \text{Coker}(B : R^m \to R^n)$
is a finite $R$-module such that $M' = S^{-1}M$.
Since localization is an exact functor, the fact that
$M$ has a finite length resolution by finite projective
modules implies the same for $M'$.
\end{proof}

\begin{lemma}
\label{lemma-finite-gl-dim-primes}
Let $R$ be a Noetherian ring.
Then $R$ has finite global dimension if and
only if there exists an integer $n$ such that
for all maximal ideals $\mathfrak m$ of $R$
the ring $R_{\mathfrak m}$ has global dimension
$\leq n$.
\end{lemma}

\begin{proof}
We saw, Lemma \ref{lemma-localize-finite-gl-dim}
that if $R$ has finite global dimension $n$,
then all the localizations $R_{\mathfrak m}$
have finite global dimension at most $n$.
Conversely, suppose that all the $R_{\mathfrak m}$
have global dimension $n$. Let $M$ be a finite
$R$-module. Let
$0 \to K_n \to F_{n-1} \to \ldots \to F_0 \to M \to 0$.
be a resolution with $F_i$ finite projective.
According to Lemma \ref{lemma-independent-resolution}
and the assumption all the modules $K_n \otimes_R R_{\mathfrak m}$
are finite free. Hence by Lemma \ref{lemma-finite-projective}
the module $K_n$ is finite projective.
\end{proof}

\begin{lemma}
\label{lemma-length-resolution-residue-field}
Suppose that $R$ is a Noetherian local ring
with maximal ideal $\mathfrak m$ and
residue field $\kappa$. In this case
the projective dimension of $\kappa$ is
$\geq \dim_\kappa \mathfrak m / \mathfrak m^2$.
\end{lemma}

\begin{proof}
Let $x_1 , \ldots x_n$ be elements of $\mathfrak m$
whose images in $\mathfrak m / \mathfrak m^2$ form a basis.
Consider the {\it Koszul complex} on $x_1, \ldots, x_n$.
This is the complex
$$
0 \to \wedge^n R^n \to \wedge^{n-1} R^n \to \wedge^{n-2} R^n \to
\ldots \to \wedge^i R^n \to \ldots \to R^n \to R
$$
with maps given by
$$
e_{j_1} \wedge \ldots \wedge e_{j_i}
\longmapsto
\sum_{a = 1}^i (-1)^{i + 1} x_{j_a} e_{j_1} \wedge \ldots
\wedge \hat e_{j_a} \wedge \ldots \wedge e_{j_i}
$$
It is easy to see that this is a complex $K_{\bullet}(R, x_{\bullet})$.
Note that the cokernel of the last map of $K_{\bullet}(R, x_{\bullet})$
is clearly $\kappa$.

\medskip\noindent
Now, let $F_{\bullet} \to \kappa$ by any finite resolution by
finite free $R$-modules. By Lemma \ref{lemma-add-trivial-complex}
we may assume all the maps in the complex $F_{\bullet}$
have to property that $\text{Im}(F_i \to F_{i-1})
\subset \mathfrak m F_{i-1}$, because removing a trivial
summand from the resolution can at worst shorten the resolution.
By Lemma \ref{lemma-compare-resolutions} we can find a map
of complexes $\alpha : K_{\bullet}(R, x_{\bullet}) \to F_{\bullet}$
inducing the identity on $\kappa$. We will prove by induction
that the maps $\alpha_i : \wedge^i R^n = K_i(R, x_{\bullet}) \to F_i$
have the property that $\alpha_i \otimes \kappa
: \wedge^i \kappa^n \to F_i \otimes \kappa$ are injective.
This will prove the lemma since it clearly shows that
$F_n \not = 0$.

\medskip\noindent
The result is clear for $i = 0$ because the composition
$R \xrightarrow{\alpha_0} F_0 \to \kappa$ is nonzero.
Note that $F_0$ must have rank $1$ since
otherwise the map $F_1 \to F_0$ whose cokernel is a single
copy of $\kappa$ cannot have image contained in $\mathfrak m F_0$.
For $\alpha_1$ we use that $x_1, \ldots, x_n$ is a minimal
set of generators for $\mathfrak m$. Namely, we saw above that
$F_0 = R$ and $F_1 \to F_0 = R$ has image $\mathfrak m$.
We have a commutative diagram
$$
\begin{matrix}
R^n & = & K_1(R, x_{\bullet}) & \to & K_0(R, x_{\bullet}) & = & R \\
& & \downarrow & & \downarrow & & \downarrow \\
& & F_1 & \to & F_0 & = & R
\end{matrix}
$$
where the rightmost vertical arrow is given by multiplication
by a unit. Hence we see that the image of the composition
$R^n \to F_1 \to F_0 = R$ is also equal to $\mathfrak m$.
Thus the map $R^n \otimes \kappa \to F_1 \otimes \kappa$
has to be injective since $\dim_\kappa (\mathfrak m / \mathfrak m^2) = n$.

\medskip\noindent
Suppose the injectivity of $\alpha_j \otimes \kappa$ has been
proved for all $j \leq i - 1$. Consider the commutative diagram
$$
\begin{matrix}
\wedge^i R^n & = & K_i(R, x_{\bullet}) & \to & K_{i-1}(R, x_{\bullet})
& = & \wedge^{i-1} R^n \\
& & \downarrow & & \downarrow & & \\
& & F_i & \to & F_{i-1} & &
\end{matrix}
$$
We know that $\wedge^{i-1} \kappa^n \to F_{i-1} \otimes \kappa$
is injective. This proves that
$\wedge^{i-1} \kappa^n \otimes_{\kappa} \mathfrak m/\mathfrak m^2
\to F_{i-1} \otimes \mathfrak m/\mathfrak m^2$ is injective.
Also, by our choice of the complex, $F_i$ maps into
$\mathfrak mF_{i-1}$, and similarly for the Koszul complex.
Hence we get a commutative diagram
$$
\begin{matrix}
\wedge^i \kappa^n & \to &
\wedge^{i-1} \kappa^n \otimes \mathfrak m/\mathfrak m^n \\
\downarrow & & \downarrow \\
F_i \otimes \kappa & \to & F_{i-1}\otimes \mathfrak m/\mathfrak m^2
\end{matrix}
$$
At this point it suffices to verify the map
$\wedge^i \kappa^n \to
\wedge^{i-1} \kappa^n \otimes \mathfrak m/\mathfrak m^n$
is injective, which can be done by hand.
\end{proof}

\begin{lemma}
\label{lemma-dim-gl-dim}
Let $R$ be a Noetherian local ring.
Suppose that the residue field $\kappa$ has finite
projective dimension $n$ over $R$.
In this case $\dim(R) \geq n$.
\end{lemma}

\begin{proof}
Let $F_{\bullet}$ be a finite resolution of $\kappa$ by finite free
$R$-modules. By Lemma \ref{lemma-add-trivial-complex}
we may assume all the maps in the complex $F_{\bullet}$
have to property that $\text{Im}(F_i \to F_{i-1})
\subset \mathfrak m F_{i-1}$, because removing a trivial
summand from the resolution can at worst shorten the resolution.
Say $F_n \not = 0$ and $F_i = 0$ for $i > n$, so that
the projective dimension of $\kappa$ is $n$.
By Proposition \ref{proposition-what-exact} we see that
$\text{depth}(I(\varphi_n)) \geq n$ since $I(\varphi_n)$
cannot equal $R$ by our choice of the complex.
Thus by Lemma \ref{lemma-bound-depth} also $\dim(R) \geq n$.
\end{proof}

\begin{proposition}
\label{proposition-finite-gl-dim-regular}
A Noetherian local ring whose residue field
has finite projective dimension is regular.
In particular a Noetherian local ring of
finite global dimension is regular.
\end{proposition}

\begin{proof}
By Lemmas \ref{lemma-length-resolution-residue-field}
and \ref{lemma-dim-gl-dim} we see that
$\dim(R) \geq \dim_\kappa(\mathfrak m /\mathfrak m^2)$.
Thus the result follows immediately from Definition
\ref{definition-regular-local}.
\end{proof}

\noindent
In particular, by the proposition and
Proposition \ref{proposition-regular-finite-gl-dim}
we see that
a Noetherian local ring is regular if and only if
it has finite global dimension. Furthermore, any localization
$R_{\mathfrak p}$ has finite global dimension,
see Lemma \ref{lemma-localize-finite-gl-dim},
and hence is regular. Thus it now
makes sense to make the following definition,
because it does not conclict with the earlier
definition of a regular local ring.

\begin{definition}
\label{definition-regular}
A Noetherian ring $R$ is said to be {\it regular}
if all the localizations $R_{\mathfrak p}$ are
regular local rings.
\end{definition}

\noindent
Note that this is not the same as asking $R$ to have finite
global dimension, even assuming $R$ is Noetherian. This is
because there is an example of a regular Noetherian ring
which does not have finite global dimension, namely because
it does not have finite dimension.

\begin{lemma}
\label{lemma-finite-gl-dim-finite-dim-regular}
Let $R$ be a Noetherian ring.
The following are equivalent:
\begin{enumerate}
\item $R$ has finite global dimension $n$,
\item there exists an integer $n$ such that
all the localizations $R_{\mathfrak m}$ at maximal ideals
are regular of dimension $\leq n$ with equality for at least
one $\mathfrak m$, and
\item there exists an integer $n$ such that
all the localizations $R_{\mathfrak p}$ at prime ideals
are regular of dimension $\leq n$ with equality for at least
one $\mathfrak p$.
\end{enumerate}
\end{lemma}

\begin{proof}
This is a reformulation of Lemma \ref{lemma-finite-gl-dim-primes}
in view of the discussion surrouding Definition \ref{definition-regular}.
See especially Propositions
\ref{proposition-regular-finite-gl-dim} and
\ref{proposition-finite-gl-dim-regular}.
\end{proof}

\begin{lemma}
\label{lemma-flat-under-regular}
Let $R \to S$ be a local homomorphism of local Noetherian rings.
Assume that $R \to S$ is flat and that $S$ is regular.
Then $R$ is regular.
\end{lemma}

\begin{proof}
Let $\mathfrak m \subset R$ be the maximal ideal
and let $\kappa = R/\mathfrak m$ be the residue field.
Let $d = \dim S$.
Choose any resolution $F_\bullet \to \kappa$
with each $F_i$ a finite free $R$-module. Set
$K_d = \text{Ker}(F_{d - 1} \to F_{d - 2})$.
By flatness of $R \to S$ the complex
$0 \to K_d \otimes_R S \to F_{d - 1} \otimes_R S \to \ldots
\to F_0 \otimes_R S \to \kappa \otimes_R S \to 0$
is still exact. Because the global dimension of $S$
is $d$, see Proposition \ref{proposition-regular-finite-gl-dim},
we see that $K_d \otimes_R S$ is a finite free $S$-module
(see also Lemma \ref{lemma-independent-resolution}).
By Lemma \ref{lemma-finite-projective-descends} we see
that $K_d$ is a finite free $R$-module.
Hence $\kappa$ has finite projective dimension and $R$ is regular by
Proposition \ref{proposition-finite-gl-dim-regular}.
\end{proof}









\section{Homomorphisms and dimension}
\label{section-homomorphism-dimension}

\noindent
This section contains a collection of easy results relating
dimensions of rings when there are maps between them.

\begin{lemma}
\label{lemma-dimension-going-up}
Suppose $R \to S$ is a ring map satisfying either going up, see
Definition \ref{definition-going-up-down}, or going down
see Definition \ref{definition-going-up-down}.
Assume in addition that $\text{Spec}(S) \to \text{Spec}(R)$
is surjective. Then $\dim(R) \leq \dim(S)$.
\end{lemma}

\begin{proof}
Assume going up.
Take any chain $\mathfrak p_0 \subset \mathfrak p_1 \subset \ldots
\subset \mathfrak p_e$ of prime ideals in $R$.
By surjectivity we may choose a prime $\mathfrak q_0$ mapping
to $\mathfrak p_0$. By going up we may extend this to a chain
of length $e$ of primes $\mathfrak q_i$ lying over
$\mathfrak p_i$. Thus $\dim(S) \geq \dim(R)$.
The case of going down is exactly the same.
See also Topology, Lemma \ref{topology-lemma-dimension-specializations-lift}
for a purely topological version.
\end{proof}

\begin{lemma}
\label{lemma-going-up-maximal-on-top}
Suppose that $R \to S$ is a ring map with the going up property,
see Definition \ref{definition-going-up-down}. If
$\mathfrak q \subset S$ is a maximal ideal.
then the inverse image of $\mathfrak q$ in $R$
is a maximal ideal too.
\end{lemma}

\begin{proof}
Trivial.
\end{proof}

\begin{lemma}
\label{lemma-integral-dim-up}
Suppose that $R \to S$ is a ring map such that $S$ is integral over $R$.
Then $\dim (R) \geq \dim(S)$, and every closed point of $\text{Spec}(S)$
maps to a closed point of $\text{Spec}(R)$.
\end{lemma}

\begin{proof}
Immediate from Lemmas \ref{lemma-integral-no-inclusion} and
\ref{lemma-going-up-maximal-on-top}
and the definitions.
\end{proof}

\begin{lemma}
\label{lemma-integral-sub-dim-equal}
Suppose $R \subset S$ and $S$ integral over $R$.
Then $\dim(R) = \dim(S)$.
\end{lemma}

\begin{proof}
This is a combination of Lemmas
\ref{lemma-integral-going-up},
\ref{lemma-integral-overring-surjective},
\ref{lemma-dimension-going-up}, and
\ref{lemma-integral-dim-up}.
\end{proof}

\begin{definition}
\label{definition-fibre}
Suppose that $R \to S$ is a ring map.
Let $\mathfrak q \subset S$ be a prime lying
over the prime $\mathfrak p$ of $R$.
The {\it local ring of the fibre at $\mathfrak q$}
is the local ring
$$
S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}
=
(S/\mathfrak pS)_{\mathfrak q}
=
(S\otimes_R \kappa(\mathfrak p))_{\mathfrak q}
$$
\end{definition}

\begin{lemma}
\label{lemma-dimension-base-fibre-total}
Let $R \to S$ be a homomorphism of Noetherian rings.
Let $\mathfrak q \subset S$ be a prime lying
over the prime $\mathfrak p$. Then
$$
\dim(S_{\mathfrak q})
\leq
\dim(R_{\mathfrak p})
+
\dim(S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}).
$$
\end{lemma}

\begin{proof}
We use the characterization of dimension of
Proposition \ref{proposition-dimension}.
Let $x_1, \ldots, x_d$ be elements of $\mathfrak p$
generating an ideal of definition of $R_{\mathfrak p}$ with
$d = \dim(R_{\mathfrak p})$.
Let $y_1, \ldots, y_e$ be elements of $\mathfrak q$
generating an ideal of definition of
$S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}$
with $e = \dim(S_{\mathfrak q}/\mathfrak pS_{\mathfrak q})$.
It is clear that $S_{\mathfrak q}/(x_1, \ldots, x_d, y_1, \ldots, y_e)$
has a nilpotent maximal ideal. Hence
$x_1, \ldots, x_d, y_1, \ldots, y_e$ generate an ideal of definition
if $S_{\mathfrak q}$.
\end{proof}

\begin{lemma}
\label{lemma-dimension-base-fibre-equals-total}
Let $R \to S$ be a homomorphism of Noetherian rings.
Let $\mathfrak q \subset S$ be a prime lying
over the prime $\mathfrak p$. Assume the going down property holds
for $R \to S$ (for example if $R \to S$ is flat, see
Lemma \ref{lemma-flat-going-down}). Then
$$
\dim(S_{\mathfrak q})
=
\dim(R_{\mathfrak p})
+
\dim(S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}).
$$
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-dimension-base-fibre-total}
we have an inequality
$\dim(S_{\mathfrak q}) \leq
\dim(R_{\mathfrak p}) + \dim(S_{\mathfrak q}/\mathfrak pS_{\mathfrak q})$.
To get equality, choose a chain of primes
$\mathfrak pS \subset \mathfrak q_0 \subset \mathfrak q_1 \subset \ldots
\subset \mathfrak q_d = \mathfrak q$ with
$d = \dim(S_{\mathfrak q}/\mathfrak pS_{\mathfrak q})$.
On the other hand, choose a chain of primes
$\mathfrak p_0 \subset \mathfrak p_1 \subset \ldots \subset \mathfrak p_e
= \mathfrak p$ with $e = \dim(R_{\mathfrak p})$.
By the going down theorem we may choose
$\mathfrak q_{-1} \subset \mathfrak q_0$ lying over
$\mathfrak p_{e-1}$. And then we may choose
$\mathfrak q_{-2} \subset \mathfrak q_{e-1}$ lying over
$\mathfrak p_{e-2}$. Inductively we keep going until we
get a chain
$\mathfrak q_{-e} \subset \ldots \subset \mathfrak q_d$
of length $e + d$.
\end{proof}

\begin{lemma}
\label{lemma-flat-over-regular-with-regular-fibre}
Let $R \to S$ be a local homomorphism of local Noetherian rings.
Assume
\begin{enumerate}
\item $R$ is regular,
\item $S/\mathfrak m_RS$ is regular, and
\item $R \to S$ is flat.
\end{enumerate}
Then $S$ is regular.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-dimension-base-fibre-equals-total}
we have
$\dim(S) = \dim(R) + \dim(S/\mathfrak m_RS)$.
Pick generators $x_1, \ldots, x_d \in \mathfrak m_R$ with $d = \dim(R)$,
and pick $y_1, \ldots, y_e \in \mathfrak m_S$
which generate the maximal ideal of $S/\mathfrak m_RS$ with
$e = \dim(S/\mathfrak m_RS)$. Then we see that
$x_1, \ldots, x_d, y_1, \ldots, y_e$ are elements which generate
the maximal ideal of $S$ and $e + d = \dim(S)$.
\end{proof}

\noindent
The lemma below will later be used to show that rings of finite type over
a field are Cohen-Macaulay if and only if they are quasi-finite flat over
a polynomial ring. It is a partial converse to
Lemma \ref{lemma-CM-over-regular-flat}.

\begin{lemma}
\label{lemma-finite-flat-over-regular-CM}
Let $R \to S$ be a local homomorphism of Noetherian local rings.
Assume $R$ Cohen-Macaulay.
If $S$ is finite flat over $R$, or if $S$ is flat over $R$ and
$\dim(S) \leq \dim(R)$, then $S$ is Cohen-Macaulay and $\dim(R) = \dim(S)$.
\end{lemma}

\begin{proof}
Let $x_1, \ldots, x_d \in \mathfrak m_R$ be a regular sequence
of length $d = \dim(R)$. By Lemma \ref{lemma-flat-increases-depth}
this maps to a regular sequence in $S$.
Hence $S$ is Cohen-Macaulay if $\dim(S) \leq d$. This is true
if $S$ is finite flat over $R$ by Lemma \ref{lemma-integral-sub-dim-equal}.
And in the second case we assumed it.
\end{proof}








\section{The dimension formula}
\label{section-dimension-formula}

\noindent
Recall the definitions of catenary (Definition \ref{definition-catenary})
and universally catenary (Definition \ref{definition-universally-catenary}).

\begin{lemma}
\label{lemma-dimension-formula}
Let $R \to S$ be a ring map.
Let $\mathfrak q$ be a prime of $S$ lying over the prime $\mathfrak p$ of $R$.
Assume that
\begin{enumerate}
\item $R$ is Noetherian,
\item $R \to S$ is of finite type,
\item $R$, $S$ are domains, and
\item $R \subset S$.
\end{enumerate}
Then we have
$$
\text{height}(\mathfrak q)
\leq
\text{height}(\mathfrak p) + \text{trdeg}_{R}(S)
- \text{trdeg}_{\kappa(\mathfrak p)} \kappa(\mathfrak q)
$$
with equality if $R$ is universally catenary.
\end{lemma}

\begin{proof}
Suppose that $R \subset S' \subset S$ is a finitely generated $R$-subalgebra
of $S$. In this case set $\mathfrak q' = S' \cap \mathfrak q$.
The lemma for the ring maps $R \to S'$ and $S' \to S$ implies the
lemma for $R \to S$ by additivity of transcendence degree in towers
of fields. Hence we can use induction on the number of generators
of $S$ over $R$ and reduce to the case where $S$ is generated by
one element over $R$.

\medskip\noindent
Case I: $S = R[x]$ is a polynomial algebra over $R$.
In this case we have $\text{trdeg}_{R}(S) = 1$.
Also $R \to S$ is flat and hence
$$
\dim(S_{\mathfrak q}) =
\dim(R_{\mathfrak p}) + \dim(S_{\mathfrak q}/\mathfrak pS_{\mathfrak q})
$$
see Lemma \ref{lemma-dimension-base-fibre-equals-total}.
Let $\mathfrak r = \mathfrak mS$. Then
$\text{trdeg}_{\kappa(\mathfrak p)} \kappa(\mathfrak q) = 1$
is equivalent to $\mathfrak q = \mathfrak r$, and implies that
$\dim(S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}) = 0$.
In the same vein $\text{trdeg}_{\kappa(\mathfrak p)} \kappa(\mathfrak q) = 0$
is equivalent to having a strict inclusion
$\mathfrak q \subset \mathfrak r$, which implies that
$\dim(S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}) = 1$.
Thus we are done with case I with equality in every instance.

\medskip\noindent
Case II: $S = R[x]/\mathfrak n$ with $\mathfrak n \not = 0$.
In this case we have $\text{trdeg}_{R}(S) = 0$.
Denote $\mathfrak q' \subset R[x]$ the prime corresponding to $\mathfrak q$.
Thus we have
$$
S_{\mathfrak q} = (R[x])_{\mathfrak q'}/\mathfrak n(R[x])_{\mathfrak q'}
$$
By the previous case we have
$\dim((R[x])_{\mathfrak q'}) =
\dim(R_{\mathfrak p}) + 1
- \text{trdeg}_{\kappa(\mathfrak p)} \kappa(\mathfrak q)$.
Since $\mathfrak n \not = 0$ we see that the dimension of
$S_{\mathfrak q}$ decreases by at least one, see
Lemma \ref{lemma-one-equation},
which proves the inequality of the lemma.
To see the equality in case $R$ is universally catenary note that
$\mathfrak n \subset R[x]$ is a height one prime as it corresponds
to a nonzero prime in $f.f.(R)[x]$. Hence any maximal chain of primes
in $R[x]_{\mathfrak q'}/\mathfrak n$ corresponds to a maximal chain of primes
with length 1 greater between $\mathfrak q'$ and $(0)$ in $R[x]$.
If $R$ is universally catenary these all have the same length equal to
the height of $\mathfrak q'$. This proves that
$\dim(R[x]_{\mathfrak q'}/\mathfrak n) = \dim(R[x]_{\mathfrak q'}) - 1$
as desired.
\end{proof}

\noindent
The following lemma says that generically finite maps
tend to be quasi-finite in codimension $1$.

\begin{lemma}
\label{lemma-finite-in-codim-1}
Let $A \to B$ be a ring map.
Assume
\begin{enumerate}
\item $A \subset B$ is an extension of domains.
\item $A$ is Noetherian,
\item $A \to B$ is of finite type, and
\item the extension $f.f.(A) \subset f.f.(B)$ is finite.
\end{enumerate}
Let $\mathfrak p \subset A$ be a prime such that $\dim(A_\mathfrak p) = 1$.
Then there are at most finitely many primes of $B$ lying over $\mathfrak p$.
\end{lemma}

\begin{proof}
By the dimension formula (Lemma \ref{lemma-dimension-formula})
for any prime $\mathfrak q$ lying over $\mathfrak p$ we have
$$
\dim(B_{\mathfrak q}) \leq
\dim(A_{\mathfrak p}) - \text{trdeg}_{\kappa(\mathfrak p)} \kappa(\mathfrak q).
$$
Since $\dim(B_{\mathfrak q})$ is clearly at least $1$ we conclude that
it is $1$ and that the extension
$\kappa(\mathfrak p) \subset \kappa(\mathfrak q)$ is algebraic.
Hence every such prime $\mathfrak q$ is an isolated point of its fibre.
Since the fibre $\text{Spec}(B \otimes_A \kappa(\mathfrak p))$
is quasi-compact we see that it is finite.
\end{proof}









\section{Dimension of finite type algebras over fields}
\label{section-dimension-finite-type-algebras}

\begin{lemma}
\label{lemma-dim-affine-space}
Let $\mathfrak m$ be a maximal ideal in $k[x_1, \ldots, x_n]$.
The ideal $\mathfrak m$ is generated by $n$ elements.
The dimension of $k[x_1, \ldots, x_n]_{\mathfrak m}$ is $n$.
Hence $k[x_1, \ldots, x_n]_{\mathfrak m}$ is a regular local
ring of dimension $n$.
\end{lemma}

\begin{proof}
By the Hilbert Nullstellensatz \ref{theorem-nullstellensatz},
we know the residue field $\kappa = \kappa(\mathfrak m)$ is
a finite extension of $k$. Denote $\alpha_i \in \kappa$ the
image of $x_i$. Denote $\kappa_i = k(\alpha_1, \ldots, \alpha_i)
\subset \kappa$, $i = 1, \ldots, n$ and $\kappa_0 = k$.
Note that $\kappa_i = k[\alpha_1, \ldots, \alpha_i]$
by field theory. Define inductively elements
$f_i \in \mathfrak m \cap k[x_1, \ldots, x_i]$
as follows: Let $P_i(T) \in \kappa_{i-1}[T]$
be the monic minimal polynomial of $\alpha_i $ over $\kappa_{i-1}$.
Let $Q_i(T) \in k[x_1, \ldots, x_{i-1}][T]$ be a monic lift of $P_i(T)$
(of the same degree). Set $f_i = Q_i(x_i)$.
Note that if $d_i = \deg_T(P_i) = \deg_T(Q_i) = \deg_{x_i}(f_i)$
then $d_1d_2\ldots d_i = [\kappa_i : k]$ by elementary field theory.

\medskip\noindent
We claim that for all $i = 0, 1, \ldots, n$ there is an
isomorphism
$$
\psi_i : k[x_1, \ldots, x_i] /(f_1, \ldots, f_i) \cong \kappa_i.
$$
By construction the composition
$k[x_1, \ldots, x_i] \to k[x_1, \ldots, x_n] \to \kappa$
is surjective onto $\kappa_i$ and $f_1, \ldots, f_i$ are
in the kernel. This gives a surjective homomorphism.
We prove $\psi_i$ is injective by induction. It is clear for $i = 0$.
Given the statement for $i$ we prove it for $i + 1$.
The ring extension $k[x_1, \ldots, x_i]/(f_1, \ldots, f_i) \to
k[x_1, \ldots, x_{i + 1}]/(f_1, \ldots, f_{i + 1})$
is generated by $1$ element over a field and one
irreducible equation. By elementrary field theory
$k[x_1, \ldots, x_{i + 1}]/(f_1, \ldots, f_{i + 1})$
is a field, and hence $\psi_i$ is injective.

\medskip\noindent
This implies that $\mathfrak m = (f_1, \ldots, f_n)$.
Moreover, we also conclude that
$$
k[x_1, \ldots, x_n]/(f_1, \ldots, f_i)
\cong
\kappa_i[x_{i + 1}, \ldots, x_n].
$$
Hence $(f_1, \ldots, f_i)$ is a prime ideal. Thus
$$
(0) \subset (f_1) \subset (f_1, f_2) \subset \ldots \subset
(f_1, \ldots, f_n) = \mathfrak m
$$
is a chain of primes of length $n$. The lemma follows.
\end{proof}

\begin{proposition}
\label{proposition-finite-gl-dim-polynomial-ring}
A polynomial algebra in $n$ variables over a field is a regular ring.
It has global dimension $n$. All localizations at maximal ideals
are regular local rings of dimension $n$.
\end{proposition}

\begin{proof}
By Lemma \ref{lemma-dim-affine-space}
all localizations $k[x_1, \ldots, x_n]_{\mathfrak m}$
at maximal ideals are regular local rings of dimension $n$. Hence
we conclude by Lemma \ref{lemma-finite-gl-dim-finite-dim-regular}.
\end{proof}

\begin{lemma}
\label{lemma-dimension-height-polynomial-ring}
Let $k$ be a field.
Let $\mathfrak p \subset \mathfrak q \subset k[x_1, \ldots, x_n]$
be a pair of primes.
Any maximal chain of primes between $\mathfrak p$ and $\mathfrak q$
has length $\text{height}(\mathfrak q) - \text{height}(\mathfrak p)$.
\end{lemma}

\begin{proof}
By Proposition \ref{proposition-finite-gl-dim-polynomial-ring}:
(a) every maximal chain of primes in $k[x_1, \ldots, x_n]$
has length $n$, and (b) every maximal chain of primes
between $(0)$ and $\mathfrak p$ has length $\text{height}(\mathfrak p)$.
This because any local ring of $k[x_1, \ldots, x_n]$ is regular.
Putting these together leads to the assertion of the lemma.
\end{proof}

\begin{lemma}
\label{lemma-dimension-spell-it-out}
Let $k$ be a field.
Let $S$ be a finite type $k$-algebra which is an integral domain.
Then $\dim(S) = \dim(S_{\mathfrak m})$ for any maximal
ideal $\mathfrak m$ of $S$. In words: every maximal chain
of primes has length equal to the dimension of $S$.
\end{lemma}

\begin{proof}
Write $S = k[x_1, \ldots, x_n]/\mathfrak p$.
By Proposition \ref{proposition-finite-gl-dim-polynomial-ring} and
Lemma \ref{lemma-dimension-height-polynomial-ring} above
all the maximal chains of primes in $S$ (which necessarily end
with a maximal ideal) have length $n - \text{height}(\mathfrak p)$.
Thus this number is the dimension of $S$ and of $S_{\mathfrak m}$
for any maximal ideal $\mathfrak m$ of $S$.
\end{proof}

\noindent
Recall that we defined the
dimension $\dim_x(X)$ of a topological space $X$ at a point $x$
in Topology, Definition \ref{topology-definition-Krull}.

\begin{lemma}
\label{lemma-dimension-at-a-point-finite-type-over-field}
Let $k$ be a field.
Let $S$ be a finite type $k$-algebra.
Let $X = \text{Spec}(S)$.
Let $\mathfrak p \subset S$ be a prime ideal and let
$x \in X$ be the associated point.
The following numbers are equal
\begin{enumerate}
\item $\dim_x(X)$,
\item $\max \dim(Z)$ where the maximum is over those
irreducible components $Z$ of $X$ passing through $x$, and
\item $\min \dim(S_{\mathfrak m})$ where the minimum
is over maximal ideals $\mathfrak m$ with
$\mathfrak p \subset \mathfrak m$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $X = \bigcup_{i \in I} Z_i$ be the decomposition of $X$ into
its irreducible components. There are finitely many of
them (see
Lemmas \ref{lemma-obvious-Noetherian} and \ref{lemma-Noetherian-topology}).
Let $I' = \{i \mid x \in Z_i\}$, and let
$T = \bigcup_{x \not \in I'} Z_i$. Then $U = X \setminus T$
is an open subset of $X$ containing the point $x$.
The number (2) is $\max_{i \in I'} \dim(Z_i)$.
For any open $W \subset U$, with $x \in W$
the irreducible components of $W$ are the irreducible sets
$W_i = Z_i \cap W$ for $i \in I'$.
Note that each $W_i$, $i \in I'$ contains a closed point because
$X$ is Jacobson, see Section \ref{section-ring-jacobson}.
By Lemma \ref{lemma-dimension-spell-it-out} we see that
$\dim(W_i) = \dim(Z_i)$ for any $i \in I'$. Hence $\dim(W)$
is equal to the number (2). This proves that (1) $ = $ (2).

\medskip\noindent
Let $\mathfrak m \supset \mathfrak p$ be any maximal ideal
containing $\mathfrak p$. Let $x_0 \in X$ be the corresponding
point. First of all, $x_0$ is contained in all the
irreducible components $Z_i$, $i \in I'$. Let $\mathfrak q_i$
denote the minimal primes of $S$ corresponding to the
irreducible componenents $Z_i$. For each $i$ such that
$x_0 \in Z_i$ (which is equivalent to $\mathfrak m \supset \mathfrak q_i$)
we have a surjection
$$
S_{\mathfrak m} \longrightarrow
S_\mathfrak m/\mathfrak q_i S_\mathfrak m =(S/\mathfrak q_i)_{\mathfrak m}
$$
Moreover, the primes $\mathfrak q_i S_\mathfrak m$ so obtained
exhaust the minimal
primes of the Noetherian local ring $S_{\mathfrak m}$, see
Lemma \ref{lemma-irreducible-components-containing-x}.
We conclude, using Lemma \ref{lemma-dimension-spell-it-out},
that the dimension of $S_{\mathfrak m}$ is the
maximum of the dimensions of the $Z_i$ passing through $x_0$.
To finish the proof of the lemma it suffices to show that
we can choose $x_0$ such that $x_0 \in Z_i \Rightarrow i \in I'$.
Because $S$ is Jacobson (as we saw above)
it is enough to show that $V(\mathfrak p) \setminus T$
(with $T$ as above) is nonempty. And this is clear since it
contains the point $x$ (i.e. $\mathfrak p$).
\end{proof}

\begin{lemma}
\label{lemma-dimension-closed-point-finite-type-field}
Let $k$ be a field.
Let $S$ be a finite type $k$-algebra.
Let $X = \text{Spec}(S)$.
Let $\mathfrak m \subset S$ be a maximal ideal and let
$x \in X$ be the associated closed point.
Then $\dim_x(X) = \dim(S_{\mathfrak m})$.
\end{lemma}

\begin{proof}
This is a special case of
Lemma \ref{lemma-dimension-at-a-point-finite-type-over-field} above.
\end{proof}

\begin{lemma}
\label{lemma-disjoint-decomposition-CM-algebra}
Let $k$ be a field.
Let $S$ be a finite type $k$ algebra.
Assume that $S$ is Cohen-Macaulay.
Then $\text{Spec}(S) = \coprod T_d$ is a finite disjoint union of
open and closed subsets $T_d$ with $T_d$ equidimensional
(see Topology, Definition \ref{topology-definition-equidimensional})
of dimension $d$. Equivalently, $S$ is a product of rings
$S_d$, $d = 0, \ldots, \dim(S)$ such that every maximal ideal
$\mathfrak m$ of $S_d$ has height $d$.
\end{lemma}

\begin{proof}
The equivalence of the two statements follows from
Lemma \ref{lemma-disjoint-implies-product}.
Let $\mathfrak m \subset S$ be a maximal ideal.
Every maximal chain of primes in $S_{\mathfrak m}$ has
the same length equal to $\dim(S_{\mathfrak m})$, see
Lemma \ref{lemma-maximal-chain-CM}. Hence, the dimension of the irreducible
components passing through the point corresponding to $\mathfrak m$
all have dimension equal to $\dim(S_{\mathfrak m})$, see
Lemma \ref{lemma-dimension-spell-it-out}.
Since $\text{Spec}(S)$ is a Jacobson topological space
the intersection
of any two irreducible components of it contains a closed point if nonempty,
see Lemmas \ref{lemma-finite-type-field-Jacobson}
and
\ref{lemma-jacobson}.
Thus we have shown that any two irreducible components
that meet have the same dimension. The lemma follows
easily from this, and the fact that $\text{Spec}(S)$
has a finite number of irreducible components (see
Lemmas \ref{lemma-obvious-Noetherian} and \ref{lemma-Noetherian-topology}).
\end{proof}
















\section{Noether normalization}
\label{section-Noether-normalization}

\begin{lemma}
\label{lemma-helper}
Let $n \in \mathbf{N}$.
Let $N$ be a finite nonempty
set of multi-indices $\nu = (\nu_1, \ldots, \nu_n)$.
Given $e = (e_1, \ldots, e_n)$ we set $e \cdot \nu = \sum e_i\nu_i$.
Then for $e_1 \gg e_2 \gg \ldots \gg e_{n-1} \gg e_n$ we have:
If $\nu, \nu' \in N$ then
$$
(e \cdot \nu = e \cdot \nu')
\Leftrightarrow
(\nu = \nu')
$$
\end{lemma}

\begin{proof}
Let $A_i = \max_i \nu_i - \min_i \nu_i$. If for each $i$ we have
$e_{i - 1} > A_ie_i + A_{i + 1}e_{i + 1} + \ldots + A_ne_n$ then
the lemma holds. Details omitted.
\end{proof}

\begin{lemma}
\label{lemma-helper-polynomial}
Let $R$ be a ring. Let $g \in R[x_1, \ldots, x_n]$ be an element
which is nonconstant, i.e., $g \not \in R$.
For $e_1 \gg e_2 \gg \ldots \gg e_{n-1} \gg e_n = 1$ the polynomial
$$
g(x_1 + x_n^{e_1}, x_2 + x_n^{e_2}, \ldots, x_{n - 1} + x_n^{e_{n - 1}}, x_n)
=
ax_n^d + \text{lower order terms in }x_n
$$
where $d > 0$ and $a \in R$ is one of the nonzero coefficients of $g$.
\end{lemma}

\begin{proof}
Write $g = \sum_{\nu \in N} a_\nu x^\nu$ with $a_\nu \in R$ not zero.
Here $N$ is a finite set of multi-indices as in
Lemma \ref{lemma-helper}
and $x^\nu = x_1^{\nu_1} \ldots x_n^{\nu_n}$.
Note that the leading term in
$$
(x_1 + x_n^{e_1})^{\nu_1} \ldots (x_{n-1} + x_n^{e_{n-1}})^{\nu_{n-1}}
x_n^{\nu_n}
\text{\ \ is\ \ }x_n^{e_1\nu_1 + \ldots + e_{n-1}\nu_{n-1} + \nu_n}.
$$
Hence the lemma follows from
Lemma \ref{lemma-helper}
which garantees that there is exactly one nonzero term $a_\nu x^\nu$ of $g$
which gives rise to the leading term of
$g(x_1 + x_n^{e_1}, x_2 + x_n^{e_2}, \ldots, x_{n - 1} + x_n^{e_{n - 1}},
x_n)$, i.e., $a = a_\nu$ for the unique $\nu \in N$ such that
$e \cdot \nu$ is maximal.
\end{proof}

\begin{lemma}
\label{lemma-one-relation}
Let $k$ be a field.
Let $S = k[x_1, \ldots, x_n]/I$ for some ideal $I$.
If $I \not= 0$, then there exist $y_1, \ldots, y_{n-1} \in k[x_1, \ldots, x_n]$
such that $S$ is finite over $k[y_1, \ldots, y_{n-1}]$. Moreover we may
choose $y_i$ to be in the $\mathbf{Z}$-subalgebra of $k[x_1, \ldots, x_n]$
generated by $x_1, \ldots, x_n$.
\end{lemma}

\begin{proof}
Pick $f \in I$, $f\not = 0$. It suffices to show the lemma
for $k[x_1, \ldots, x_n]/(f)$ since $S$ is a quotient of that ring.
We will take $y_i = x_i - x_n^{e_i}$, $i = 1, \ldots, n-1$
for suitable integers $e_i$. When does this work? It suffices
to show that $\overline{x_n} \in k[x_1, \ldots, x_n]/(f)$
is integral over the ring $k[y_1, \ldots, y_{n-1}]$. The
equation for $\overline{x_n}$ over this ring is
$$
f(y_1 + x_n^{e_1}, \ldots, y_{n-1} + x_n^{e_{n-1}}, x_n) = 0.
$$
Hence we are done if we can show there exists integers $e_i$ such
that the leading coefficient w.r.t.\ $x_n$ of the equation
above is a nonzero element of $k$. This can be achieved for example
by choosing $e_1 \gg e_2 \gg \ldots \gg e_{n-1}$, see
Lemma \ref{lemma-helper-polynomial}.
\end{proof}

\begin{lemma}
\label{lemma-Noether-normalization}
Let $k$ be a field. Let $S = k[x_1, \ldots, x_n]/I$ for some ideal $I$.
There exist $r\geq 0$, and $y_1, \ldots, y_r \in k[x_1, \ldots, x_n]$
such that (a) the map $k[y_1, \ldots, y_r] \to S$ is injective,
and (b) the map $k[y_1, \ldots, y_r] \to S$ is finite.
In this case the integer $r$ is the dimension of $S$.
Moreover we may choose $y_i$ to be in the
$\mathbf{Z}$-subalgebra of $k[x_1, \ldots, x_n]$
generated by $x_1, \ldots, x_n$.
\end{lemma}

\begin{proof}
By induction on $n$, with $n = 0$ being trivial.
If $I = 0$, then take $r = n$ and $y_i = x_i$.
If $I \not = 0$, then choose $y_1, \ldots, y_{n-1}$
as in Lemma \ref{lemma-one-relation}. Let
$S' \subset S$ be the subring generated by
the images of the $y_i$. By induction we can
choose $r$ and $z_1, \ldots, z_r \in k[y_1, \ldots, y_{n-1}]$
such that (a), (b) hold for $k[z_1, \ldots, z_r]
\to S'$. Since $S' \to S$ is injective and finite
we see (a), (b) hold for $k[z_1, \ldots, z_r]
\to S$. The last assertion follows from Lemma
\ref{lemma-integral-sub-dim-equal}.
\end{proof}

\begin{lemma}
\label{lemma-Noether-normalization-at-point}
Let $k$ be a field.
Let $S$ be a finite type $k$ algebra and denote $X = \text{Spec}(S)$.
Let $\mathfrak q$ be a prime of $S$, and let $x \in X$ be the
corresponding point. There exists a $g \in S$, $g \not \in \mathfrak q$
such that $\dim(S_g) = \dim_x(X) =: d$ and such that
there exists a finite injective map $k[y_1, \ldots, y_d] \to S_g$.
\end{lemma}

\begin{proof}
Note that by definition $\dim_x(X)$ is the minimum
of the dimensions of $S_g$ for $g \in S$, $g \not \in \mathfrak q$, i.e.,
the minimum is attained. Thus the lemma follows from
Lemma \ref{lemma-Noether-normalization}.
\end{proof}

\begin{lemma}
\label{lemma-dimension-prime-polynomial-ring}
Let $k$ be a field.
Let $S$ be a finite type $k$ algebra which is an integral domain.
Let $K = f.f.(S)$ be the field of fractions of $S$.
Let $r = \text{trdeg}(K/k)$ be the transcendence degree of $K$ over $k$.
Then $\dim(S) = r$. Moreover, the local ring of $S$ at every maximal
ideal has dimension $r$.
\end{lemma}

\begin{proof}
We may write $S = k[x_1, \ldots, x_n]/\mathfrak p$.
By Lemma \ref{lemma-dimension-height-polynomial-ring}
all local rings of $S$ at maximal ideals have the same dimension.
Apply Lemma \ref{lemma-Noether-normalization} above.
We get a finite injective ring map
$$
k[y_1, \ldots, y_d] \to S
$$
with $d = \dim(S)$. Clearly, $k(y_1, \ldots, y_d) \subset K$
is a finite extension and we win.
\end{proof}

\noindent
The following lemma generalizes
Lemma \ref{lemma-dimension-closed-point-finite-type-field}.

\begin{lemma}
\label{lemma-dimension-at-a-point-finite-type-field}
Let $k$ be a field.
Let $S$ be a finite type $k$ algebra.
Let $X = \text{Spec}(S)$.
Let $\mathfrak p \subset S$ be a prime ideal,
and let $x \in X$ be the corresponding point.
Then we have
$$
\dim_x(X) = \dim(S_{\mathfrak p}) + \text{trdeg}_k\ \kappa(\mathfrak p).
$$
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-dimension-prime-polynomial-ring} above we know that
$r = \text{trdeg}_k\ \kappa(\mathfrak p)$ is equal to the
dimension of $V(\mathfrak p)$.
Pick any maximal chain of primes
$\mathfrak p \subset \mathfrak p_1 \subset \ldots \subset \mathfrak p_r$
starting with $\mathfrak p$ in $S$.
This has length $r$ by Lemma \ref{lemma-dimension-spell-it-out}.
Let $\mathfrak q_i$, $i \in I'$ be the minimal
primes of $S$ which are contained in $\mathfrak p$.
These correspond $1-1$ to minimal primes in $S_{\mathfrak p}$
via the rule $\mathfrak q_i \mapsto \mathfrak q_iS_{\mathfrak p}$.
By Lemma \ref{lemma-dimension-at-a-point-finite-type-over-field}
we know that $\dim_x(X)$ is equal
to the maximum of the dimensions of the rings $S/\mathfrak q_i$.
For each $i$ pick a maximal chain of primes
$\mathfrak q_i \subset \mathfrak p_1 \subset \ldots \subset \mathfrak p_{s(i)}
= \mathfrak p$.
Then $\dim(S_{\mathfrak p}) = \max_{i \in I'} s(i)$.
Now, each chain
$$
\mathfrak q_i \subset \mathfrak p_1 \subset \ldots \subset
\mathfrak p_{s(i)} = \mathfrak p \subset
\mathfrak p_1 \subset \ldots \subset \mathfrak p_r
$$
is a maximal chain in $S/\mathfrak q_i$, and by what was said
before we have
$\dim_x(X) = \max_{i \in I'} r + s(i)$.
The lemma follows.
\end{proof}

\noindent
The following lemma says that the codimension of one finite type
Spec in another is the difference of heights.

\begin{lemma}
\label{lemma-codimension}
Let $k$ be a field.
Let $S' \to S$ be a surjection of finite type $k$ algebras.
Let $\mathfrak p \subset S$ be a prime ideal,
and let $\mathfrak p'$ be the corresponding prime ideal of $S'$.
Let $X = \text{Spec}(S)$, resp.\ $X' = \text{Spec}(S')$,
and let $x \in X$, resp. $x'\in X'$ be the point corrseponding
to $\mathfrak p$, resp.\ $\mathfrak p'$.
Then
$$
\dim_{x'} X' - \dim_x X =
\text{height}(\mathfrak p') - \text{height}(\mathfrak p).
$$
\end{lemma}

\begin{proof}
Immediate from Lemma \ref{lemma-dimension-at-a-point-finite-type-field} above.
\end{proof}

\begin{lemma}
\label{lemma-refined-Noether-normalization}
Let $k$ be a field. Let $\mathfrak q \subset k[x_1, \ldots, x_n]$
be a prime ideal. Set $r = \text{trdeg}_k\ \kappa(\mathfrak q)$.
Then there exists a finite ring map
$\varphi : k[y_1, \ldots, y_n] \to k[x_1, \ldots, x_n]$ such
that $\varphi^{-1}(\mathfrak q) = (y_{r + 1}, \ldots, y_n)$.
\end{lemma}

\begin{proof}
By induction on $n$. The case $n = 0$ is clear. Assume $n > 0$.
If $r = n$, then $\mathfrak q = (0)$ and the result is clear.
Choose a nonzero $f \in \mathfrak q$. Of course $f$ is nonconstant.
After applying an automorphism of the form
$$
k[x_1, \ldots, x_n] \longrightarrow k[x_1, \ldots, x_n],
\quad
x_n \mapsto x_n,
\quad
x_i \mapsto x_i + x_n^{e_i}\ (i < n)
$$
we may assume that $f$ is monic in $x_n$ over $k[x_1, \ldots, x_n]$, see
Lemma \ref{lemma-helper-polynomial}. Hence the ring map
$$
k[y_1, \ldots, y_n] \longrightarrow k[x_1, \ldots, x_n],
\quad
y_n \mapsto f,
\quad
y_i \mapsto x_i\ (i < n)
$$
is finite. Moreover $y_n \in \mathfrak q \cap k[y_1, \ldots, y_n]$ by
construction. Thus
$\mathfrak q \cap k[y_1, \ldots, y_n] = \mathfrak pk[y_1, \ldots, y_n] + (y_n)$
where $\mathfrak p \subset k[y_1, \ldots, y_{n - 1}]$ is a prime ideal.
Note that $\kappa(\mathfrak p) \subset \kappa(\mathfrak q)$ is finite, and
hence $r = \text{trdeg}_k\ \kappa(\mathfrak p)$.
Apply the induction hypothesis to the pair
$(k[y_1, \ldots, y_{n - 1}], \mathfrak p)$ and we obtain a finite ring map
$k[z_1, \ldots, z_{n - 1}] \to k[y_1, \ldots, y_{n - 1}]$ such that
$\mathfrak p \cap k[z_1, \ldots, z_{n - 1}] = (z_{r + 1}, \ldots, z_{n - 1})$.
We extend the ring map
$k[z_1, \ldots, z_{n - 1}] \to k[y_1, \ldots, y_{n - 1}]$
to a ring map
$k[z_1, \ldots, z_n] \to k[y_1, \ldots, y_n]$
by mapping $z_n$ to $y_n$.
The composition of the ring maps
$$
k[z_1, \ldots, z_n] \to k[y_1, \ldots, y_n] \to k[x_1, \ldots, x_n]
$$
solves the problem.
\end{proof}

\begin{lemma}
\label{lemma-dimension-preserved-field-extension}
Let $k$ be a field.
Let $S$ be a finite type $k$-algebra.
Let $k \subset K$ be a field extension.
Then $\dim(S) = \dim(K \otimes_k S)$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-Noether-normalization}
there exists a finite injective map
$k[y_1, \ldots, y_d] \to S$ with $d = \dim(S)$.
Since $K$ is flat over $k$ we also get a finite injective
map $K[y_1, \ldots, y_d] \to K\otimes_k S$.
The result follows from Lemma \ref{lemma-integral-sub-dim-equal}.
\end{proof}

\begin{lemma}
\label{lemma-dimension-at-a-point-preserved-field-extension}
Let $k$ be a field.
Let $S$ be a finite type $k$-algebra.
Set $X = \text{Spec}(S)$.
Let $k \subset K$ be a field extension.
Set $S_K = K \otimes_k S$, and $X_K = \text{Spec}(S_K)$.
Let $\mathfrak q \subset S$ be a prime corresponding to $x \in X$
and let $\mathfrak q_K \subset S_K$ be a prime corresponding
to $x_K \in X_K$ lying over $\mathfrak q$.
Then $\dim_x X = \dim_{x_K} X_K$.
\end{lemma}

\begin{proof}
Choose a presentation $S = k[x_1, \ldots, x_n]/I$.
This gives a presentation
$K \otimes_k S = K[x_1, \ldots, x_n]/(K\otimes_k I)$.
Let $\mathfrak q_K' \subset K[x_1, \ldots, x_n]$,
resp.\ $\mathfrak q' \subset k[x_1, \ldots, x_n]$ be
the corresponding primes. Consider the following
commutative diagram of Noetherian local rings
$$
\xymatrix{
K[x_1, \ldots, x_n]_{\mathfrak q_K'} \ar[r] &
(K \otimes_k S)_{\mathfrak q_K} \\
k[x_1, \ldots, x_n]_{\mathfrak q'} \ar[r] \ar[u] &
S_{\mathfrak q} \ar[u]
}
$$
Both vertical arrows are flat because they are localizations of
the flat ring maps $S \to S_K$ and
$k[x_1, \ldots, x_n] \to K[x_1, \ldots, x_n]$.
Moreover, the vertical arrows have the same fibre rings.
Hence, we see from
Lemma \ref{lemma-dimension-base-fibre-equals-total} that
$\text{height}(\mathfrak q') - \text{height}(\mathfrak q)
= \text{height}(\mathfrak q_K') - \text{height}(\mathfrak q_K)$.
Denote $x' \in X' = \text{Spec}(k[x_1, \ldots, x_n])$
and $x'_K \in X'_K = \text{Spec}(K[x_1, \ldots, x_n])$
the points corresponding to $\mathfrak q'$ and
$\mathfrak q_K'$. By Lemma \ref{lemma-codimension} and what we showed
above we have
\begin{eqnarray*}
n - \dim_x X & = & \dim_{x'} X' - \dim_x X \\
& = & \text{height}(\mathfrak q') - \text{height}(\mathfrak q) \\
& = & \text{height}(\mathfrak q_K') - \text{height}(\mathfrak q_K) \\
& = & \dim_{x'_K} X'_K - \dim_{x_K} X_K \\
& = & n - \dim_{x_K} X_K
\end{eqnarray*}
and the lemma follows.
\end{proof}








\section{Dimension of graded algebras over a field}
\label{section-dimension-graded}

\noindent
Here is a basic result.

\begin{lemma}
\label{lemma-dimension-graded}
Let $k$ be a field.
Let $S$ be a finitely generated graded algebra over $k$.
Assume $S_0 = k$. Let $P(T) \in \mathbf{Q}[T]$ be the polynomial
such that $\dim(S_d) = P(d)$ for all $d \gg 0$. See
Proposition \ref{proposition-graded-hilbert-polynomial}.
Then
\begin{enumerate}
\item The irrelevant ideal $S_{+}$ is a maximal ideal $\mathfrak m$.
\item Any minimal prime of $S$ is a homogeneous ideal and is contained
in $S_{+} = \mathfrak m$.
\item We have $\dim(S) = \deg(P) + 1 = \dim_{x}\text{Spec}(S)$
(with the convention that $\deg(0) = -1$)
where $x$ is the point corresponding to the maximal ideal
$S_{+} = \mathfrak m$.
\item The Hilbert function of the local ring $R = S_{\mathfrak m}$
is equal to the Hilbert function of $S$.
\end{enumerate}
\end{lemma}

\begin{proof}
The first statement is obvious.
The second follows from Lemma \ref{lemma-graded-ring-minimal-prime}.
The equality $\dim(S) = \dim_{x}\text{Spec}(S)$ follows from the
fact that every irreducible component passes through $x$ according
to (2). Hence we may compute this dimension as the dimension of
the local ring $R = S_{\mathfrak m}$ with $\mathfrak m = S_{+}$ by
Lemma \ref{lemma-dimension-closed-point-finite-type-field}.
Since
$\mathfrak m^d/\mathfrak m^{d + 1} \cong \mathfrak m^dR/\mathfrak m^{d + 1}R$
we see that the Hilbert function of the local ring $R$ is equal to the
Hilbert function of $S$, which is (4). We conclude the last equality
of (3) by Proposition \ref{proposition-dimension}.
\end{proof}













\section{Generic flatness}
\label{section-generic-flatness}

\noindent
Basically this says that a finite type algebra over a domain becomes
flat after inverting a single element of the domain.
There are several versions of this result (in increasing order of
strength).

\begin{lemma}
\label{lemma-generic-flatness-Noetherian}
Let $R \to S$ be a ring map.
Let $M$ be an $S$-module.
Assume
\begin{enumerate}
\item $R$ is Noetherian,
\item $R$ is a domain,
\item $R \to S$ is of finite type, and
\item $M$ is a finite type $S$-module.
\end{enumerate}
Then there exists a nonzero $f \in R$ such that
$M_f$ is a free $R_f$-module.
\end{lemma}

\begin{proof}
Let $K$ be the fraction field of $R$. Set $S_K = K \otimes_R S$. This
is an algebra of finite type over $K$. We will argue by induction on
$d = \dim(S_K)$ (which is finite for example by Noether normalization, see
Section \ref{section-Noether-normalization}).
Fix $d \geq 0$.
Assume we know that the lemma holds in all cases where $\dim(S_K) < d$.

\medskip\noindent
Suppose given $R \to S$ and $M$ as in the lemma with $\dim(S_K) = d$. By
Lemma \ref{lemma-filter-Noetherian-module}
there exists a filtration
$0 \subset M_1 \subset M_2 \subset \ldots \subset M_n = M$
so that $M_i/M_{i - 1}$ is isomorphic to $S/\mathfrak q$
for some prime $\mathfrak q$ of $S$. Note that 
$\dim((S/\mathfrak q)_K) \leq \dim(S_K)$. Also, note that an extension of
free modules is free (see basic notion \ref{item-extension-free}).
Thus we may assume $M = S$ and that $S$ is a domain of finite type over $R$.

\medskip\noindent
If $R \to S$ has a nontrivial kernel, then take a nonzero $f \in R$ in
this kernel. In this case $S_f = 0$ and the lemma holds. (This is really
the case $d = -1$ and the start of the induction.) Hence we
may assume that $R \to S$ is a finite type extension of Noetherian domains.

\medskip\noindent
Pick $x_1, \ldots, x_n \in S$ which generate $S$ over $R$.
By Noether normalization
Lemma \ref{lemma-Noether-normalization}
we can find $y_1, \ldots, y_d \in S$ such that $K[y_1, \ldots, y_d] \to S_K$
is a finite injective map (we have $y_i \in S$ because we may pick the $y_j$
in the $\mathbf{Z}$-algebra generated by $x_1, \ldots, x_n$).
As a finite ring map is integral (see
Lemma \ref{lemma-finite-is-integral})
we can find monic $P_i \in K[y_1, \ldots, y_d][T]$ such that
$P(x_i) = 0$ in $S_K$. After replacing $R$ by $R_f$ for a suitable
$f \in R$ we may assume that $P \in R[y_1, \ldots, y_d]$ and hence
we see that $x_i$ is integral over $R[y_1, \ldots, y_d]$.
Thus we now have
$$
R \subset R[y_1, \ldots, y_d] \subset S
$$
where the second extension is finite, see
Lemma \ref{lemma-characterize-finite-in-terms-of-integral}.

\medskip\noindent
Note that $f.f.(R[y_1, \ldots, y_d]) \subset f.f.(S)$ is a finite
extension of fields. Choose $z_1, \ldots, z_r \in S$ which form
a basis for $f.f.(S)$ over $f.f.(R[y_1, \ldots, y_d])$.
This gives a short exact sequence
$$
0 \to
R[y_1, \ldots, y_d]^{\oplus r} \xrightarrow{(z_1, \ldots, z_r)}
S \to N \to 0
$$
By construction $N$ is a finite $R[y_1, \ldots, y_d]$-module whose
support does not contain the generic point $(0)$ of
$\text{Spec}(R[y_1, \ldots, y_d])$. By
Lemma \ref{lemma-support-closed}
there exists a nonzero $g \in R[y_1, \ldots, y_d]$ such that
$g$ annihilates $N$, so we may view $N$ as a finite module over
$S' = R[y_1, \ldots, y_d]/(g)$. Since $\dim(S'_K) < d$ by induction
there exists a nonzero $f \in R$ such that $N_f$ is a free
$R_f$-module. Since
$(R[y_1, \ldots, y_d])_f \cong R_f[y_1, \ldots, y_d]$ is free
also we conclude by the already mentioned fact that an extension
of free modules is free.
\end{proof}

\begin{lemma}
\label{lemma-generic-flatness-finitely-presented}
Let $R \to S$ be a ring map.
Let $M$ be an $S$-module.
Assume
\begin{enumerate}
\item $R$ is a domain,
\item $R \to S$ is of finite presentation, and
\item $M$ is an $S$-module of finite presentation.
\end{enumerate}
Then there exists a nonzero $f \in R$ such that
$M_f$ is a free $R_f$-module.
\end{lemma}

\begin{proof}
Write $S = R[x_1, \ldots, x_n]/(g_1, \ldots, g_m)$.
For $g \in R[x_1, \ldots, x_n]$ denote $\overline{g}$ its image in $S$.
We may write $M = S^{\oplus t}/\sum Sn_i$ for some $n_i \in S^{\oplus t}$.
Write $n_i = (\overline{g}_{i1}, \ldots, \overline{g}_{it})$ for some
$g_{ij} \in R[x_1, \ldots, x_n]$. Let $R_0 \subset R$ be the subring
generated by all the coefficients of all the elements
$g_i, g_{ij} \in R[x_1, \ldots, x_n]$. Define
$S_0 = R_0[x_1, \ldots, x_n]/(g_1, \ldots, g_m)$.
Define $M_0 = S_0^{\oplus t}/\sum S_0n_i$.
Then $R_0$ is a domain of finite type over $\mathbf{Z}$ and hence
Noetherian (see
Lemma \ref{lemma-Noetherian-permanence}).
Moreover via the injection $R_0 \to R$ we have $S \cong R \otimes_{R_0} S_0$
and $M \cong R \otimes_{R_0} M_0$. Applying
Lemma \ref{lemma-generic-flatness-Noetherian}
we obtain a nonzero $f \in R_0$ such that $(M_0)_f$ is a free
$(R_0)_f$-module. Hence $M_f = R_f \otimes_{(R_0)_f} (M_0)_f$
is a free $R_f$-module.
\end{proof}

\begin{lemma}
\label{lemma-generic-flatness}
Let $R \to S$ be a ring map.
Let $M$ be an $S$-module.
Assume
\begin{enumerate}
\item $R$ is a domain,
\item $R \to S$ is of finite type, and
\item $M$ is a finite type $S$-module.
\end{enumerate}
Then there exists a nonzero $f \in R$ such that
\begin{enumerate}
\item[(a)] $M_f$ and $S_f$ are free as $R_f$-modules, and
\item[(b)] $S_f$ is a finitely presented $R_f$-algebra and $M_f$ is a
finitely presented $S_f$-module.
\end{enumerate}
\end{lemma}

\begin{proof}
We first prove the lemma for $S = R[x_1, \ldots, x_n]$, and then
we deduce the result in general.

\medskip\noindent
Assume $S = R[x_1, \ldots, x_n]$.
Choose elements $m_1, \ldots, m_t$ which generate $M$. This gives
a short exact sequence
$$
0 \to N \to S^{\oplus t} \xrightarrow{(m_1, \ldots, m_t)} M \to 0.
$$
Denote $K$ the fraction field of $R$. Denote
$S_K = K \otimes_R S = K[x_1, \ldots, x_n]$, and similarly
$N_K = K \otimes_R N$, $M_K = K \otimes_R M$.
As $R \to K$ is flat the sequence remains flat after tensoring with $K$.
As $S_K = K[x_1, \ldots, x_n]$ is a Noetherian ring (see
Lemma \ref{lemma-Noetherian-permanence})
we can find finitely many elements $n'_1, \ldots, n'_s \in N_K$
which generate it. Choose $n_1, \ldots, n_r \in N$ such that
$n'_i = \sum a_{ij}n_j$ for some $a_{ij} \in K$. Set
$$
M' = S^{\oplus t}/\sum\nolimits_{i = 1, \ldots, r} Sn_i
$$
By construction $M'$ is a finitely presented $S$-module, and
there is a surjection $M' \to M$ which induces an isomorphism
$M'_K \cong M_K$. We may apply
Lemma \ref{lemma-generic-flatness-finitely-presented}
to $R \to S$ and $M'$ and we find an $f \in R$ such that $M'_f$
is a free $R_f$-module. Thus $M'_f \to M_f$ is a surjection of
modules over the domain $R_f$ where the source is a free module
and which becomes an isomorphism upon tensoring with $K$.
Thus it is injective as $M'_f \subset M'_K$ as it is free over
the domain $R_f$. Hence $M'_f \to M_f$ is an isomorphism and the
result is proved.

\medskip\noindent
For the general case, choose a surjection $R[x_1, \ldots, x_n] \to S$.
Think of both $S$ and $M$ as finite modules over $R[x_1, \ldots, x_n]$.
By the special case proved above there exists a nonzero $f \in R$
such that both $S_f$ and $M_f$ are free as $R_f$-modules and finitely
presented as $R_f[x_1, \ldots, x_n]$-modules. Clearly this implies that
$S_f$ is a finitely presented $R_f$-algebra and that $M_f$ is a
finitely presented $S_f$-module.
\end{proof}

\noindent
Let $R \to S$ be a ring map. Let $M$ be an $S$-module. Consider
the following condition on an element $f \in R$:
\begin{equation}
\label{equation-flat-and-finitely-presented}
\left\{
\begin{matrix}
S_f & \text{is of finite presentation over }R_f\\
M_f & \text{is of finite presentation as }S_f\text{-module}\\
S_f, M_f & \text{are free as }R_f\text{-modules}
\end{matrix}
\right.
\end{equation}
We define
\begin{equation}
\label{equation-good-locus}
U(R \to S, M)
=
\bigcup\nolimits_{f \in
R\text{ with }(\ref{equation-flat-and-finitely-presented})}
D(f)
\end{equation}
which is an open subset of $\text{Spec}(R)$.

\begin{lemma}
\label{lemma-generic-flatness-locus-extension}
Let $R \to S$ be a ring map.
Let $0 \to M_1 \to M_2 \to M_3 \to 0$ be a short exact sequence
of $S$-modules.
Then
$$
U(R \to S, M_1) \cap U(R \to S, M_3) \subset U(R \to S, M_2).
$$
\end{lemma}

\begin{proof}
Let $u \in U(R \to S, M_1) \cap U(R \to S, M_3)$. Choose
$f_1, f_3 \in R$ such that $u \in D(f_1)$, $u \in D(f_3)$ and
such that (\ref{equation-flat-and-finitely-presented}) holds for
$f_1$ and $M_1$ and for $f_3$ and $M_3$. Then set $f = f_1f_3$.
Then $u \in D(f)$ and (\ref{equation-flat-and-finitely-presented})
holds for $f$ and both $M_1$ and $M_3$. An extension of free modules
is free, and an extension of finitely presented modules is finitely presented
(Lemma \ref{lemma-extension}). Hence we see that
(\ref{equation-flat-and-finitely-presented}) holds for $f$ and $M_2$.
Thus $u \in U(R \to S, M_2)$ and we win.
\end{proof}

\begin{lemma}
\label{lemma-generic-flatness-locus-localize}
Let $R \to S$ be a ring map.
Let $M$ be an $S$-module.
Let $f \in R$.
Using the identification $\text{Spec}(R_f) = D(f)$ we have
$U(R_f \to S_f, M_f) = D(f) \cap U(R \to S, M)$.
\end{lemma}

\begin{proof}
Suppose that $u \in U(R_f \to S_f, M_f)$. Then there exists an
element $g \in R_f$ such that $u \in D(g)$ and such that
(\ref{equation-flat-and-finitely-presented})
holds for the pair $((R_f)_g \to (S_f)_g, (M_f)_g)$.
Write $g = a/f^n$ for some $a \in R$. Set $h = af$.
Then $R_h = (R_f)_g$, $S_h = (S_f)_g$, and $M_h = (M_f)_g$.
Moreover $u \in D(h)$. Hence $u \in U(R \to S, M)$.
Conversely, suppose that $u \in D(f) \cap U(R \to S, M)$.
Then there exists an element $g \in R$ such that $u \in D(g)$ and such that
(\ref{equation-flat-and-finitely-presented})
holds for the pair $(R_g \to S_g, M_g)$.
Then it is clear that (\ref{equation-flat-and-finitely-presented})
also holds for the pair
$(R_{fg} \to S_{fg}, M_{fg}) = ((R_f)_g \to (S_f)_g, (M_f)_g)$.
Hence $u \in U(R_f \to S_f, M_f)$ and we win.
\end{proof}

\begin{lemma}
\label{lemma-generic-flatness-locus-reduce}
Let $R \to S$ be a ring map.
Let $M$ be an $S$-module.
Let $U \subset \text{Spec}(R)$ be a dense open.
Assume there is a covering $U = \bigcup_{i \in I} D(f_i)$ of
opens such that $U(R_{f_i} \to S_{f_i}, M_{f_i})$ is dense in
$D(f_i)$ for each $i \in I$. Then $U(R \to S, M)$ is dense in
$\text{Spec}(R)$.
\end{lemma}

\begin{proof}
In view of
Lemma \ref{lemma-generic-flatness-locus-localize}
this is a purely topological statement. Namely, by that lemma
we see that $U(R \to S, M) \cap D(f_i)$ is dense in $D(f_i)$
for each $i \in I$. By
Topology, Lemma \ref{topology-lemma-nowhere-dense-local}
we see that $U(R \to S, M) \cap U$ is dense in $U$.
Since $U$ is dense in $\text{Spec}(R)$ we conclude that $U(R \to S, M)$
is dense in $\text{Spec}(R)$.
\end{proof}

\begin{lemma}
\label{lemma-generic-flatness-reduced}
Let $R \to S$ be a ring map. Let $M$ be an $S$-module.
Assume
\begin{enumerate}
\item $R \to S$ is of finite type,
\item $M$ is a finite $S$-module, and
\item $R$ is reduced.
\end{enumerate}
Then there exists a subset $U \subset \text{Spec}(R)$ such that
\begin{enumerate}
\item $U$ is open and dense in $\text{Spec}(R)$,
\item for every $u \in U$ there exists an $f \in R$ such
that $u \in D(f) \subset U$ and such that we have
\begin{enumerate}
\item $M_f$ and $S_f$ are free over $R_f$,
\item $S_f$ is a finitely presented $R_f$-algebra, and
\item $M_f$ is a finitely presented $S_f$-module.
\end{enumerate}
\end{enumerate}
\end{lemma}

\begin{proof}
Note that the lemma is equivalent to the statement that the open
$U(R \to S, M)$, see Equation (\ref{equation-good-locus}), is dense
in $\text{Spec}(R)$. We first prove the lemma for
$S = R[x_1, \ldots, x_n]$, and then
we deduce the result in general.

\medskip\noindent
Proof of the case $S = R[x_1, \ldots, x_n]$ and $M$ any finite module
over $S$. Note that in this case $S_f = R_f[x_1, \ldots, x_n]$
is free and of finite presentation over $R_f$, so we do not have
to worry about the conditions regarding $S$,
only those that concern $M$. We will use induction on $n$.

\medskip\noindent
There exists a finite filtration
$$
0 \subset M_1 \subset M_2 \subset \ldots \subset M_t = M
$$
such that $M_i/M_{i - 1} \cong S/J_i$ for some ideal $J_i \subset S$, see
Lemma \ref{lemma-trivial-filter-finite-module}. Since
a finite intersection of dense opens is dense open,
we see from
Lemma \ref{lemma-generic-flatness-locus-extension}
that it suffices to prove the lemma for each of the modules $R/J_i$.
Hence we may assume that $M = S/J$ for some ideal $J$ of
$S = R[x_1, \ldots, x_n]$.

\medskip\noindent
Let $I \subset R$ be the ideal generated by the coefficients of
elements of $J$. Let $U_1 = \text{Spec}(R) \setminus V(I)$ and
let
$$
U_2 = \text{Spec}(R) \setminus \overline{U_1}.
$$
Then it is clear that $U = U_1 \cup U_2$ is dense in $\text{Spec}(R)$.
Let $f \in R$ be an element such that either (a) $D(f) \subset U_1$ or
(b) $D(f) \subset U_2$. If for any such $f$
the lemma holds for the pair $(R_f \to R_f[x_1, \ldots, x_n], M_f)$
then by
Lemma \ref{lemma-generic-flatness-locus-reduce}
we see that $U(R \to S, M)$ is dense in $\text{Spec}(R)$.
Hence we may assume either (a) $I = R$, or (b) $V(I) = \text{Spec}(R)$.

\medskip\noindent
In case (b) we actually have $I = 0$ as $R$ is reduced! Hence $J = 0$
and $M = S$ and the lemma holds in this case.

\medskip\noindent
In case (a) we have to do a little bit more work. Note that every element
of $I$ is actually the coefficient of a monomial of an element of $J$, because
the set of coefficients of elements of $J$ forms an ideal (details omitted).
Hence we find an element
$$
g = \sum\nolimits_{K \in E} a_K x^K \in J
$$
where $E$ is a finite set of multi-indices $K = (k_1, \ldots, k_n)$
with at least one coefficient $a_{K_0}$ a unit in $R$. Actually we can
find one which has a coefficient equal to $1$ as $1 \in I$ in case (a).
Let $m = \#\{K \in E \mid a_K \text{ is not a unit}\}$.
Note that $0 \leq m \leq \#E - 1$.
We will argue by induction on $m$.

\medskip\noindent
The case $m = 0$. In this case all the coefficients $a_K$, $K \in E$
of $g$ are units and $E \not = \emptyset$.
If $E = \{K_0\}$ is a singleton and $K_0 = (0, \ldots, 0)$, then $g$
is a unit and $J = S$ so the result holds for sure. (This happens in
particular when $n = 0$ and it provides the base case of the induction
on $n$.) If not $E = \{(0, \ldots, 0)\}$, then at least one $K$ is not
equal to $(0, \ldots, 0)$, i.e., $g \not \in R$. At this point we employ
the usual trick of Noether normalization. Namely, we consider
$$
G(y_1, \ldots, y_n) =
g(y_1 + y_n^{e_1}, y_2 + y_n^{e_2}, \ldots, y_{n - 1} + y_n^{e_{n - 1}}, y_n)
$$
with $0 \ll e_{n -1} \ll e_{n - 2} \ll \ldots \ll e_1$. By
Lemma \ref{lemma-helper-polynomial}
it follows that $G(y_1, \ldots, y_n)$ as a polynomial in $y_n$
looks like
$$
a_K y_n^{k_n + \sum_{i = 1, \ldots, n - 1} e_i k_i} +
\text{lower order terms in }y_n
$$
As $a_K$ is a unit we conclude that $M = R[x_1, \ldots, x_n]/J$ is
finite over $R[y_1, \ldots, y_{n - 1}]$. Hence
$U(R \to R[x_1, \ldots, x_n], M) = U(R \to R[y_1, \ldots, y_{n - 1}], M)$
and we win by induction on $n$.

\medskip\noindent
The case $m > 0$. Pick a multi-index $K \in E$ such that $a_K$ is
not a unit. As before set
$U_1 = \text{Spec}(R_{a_K}) = \text{Spec}(R) \setminus V(a_K)$
and set
$$
U_2 = \text{Spec}(R) \setminus \overline{U_1}.
$$
Then it is clear that $U = U_1 \cup U_2$ is dense in $\text{Spec}(R)$.
Let $f \in R$ be an element such that either (a) $D(f) \subset U_1$ or
(b) $D(f) \subset U_2$. If for any such $f$
the lemma holds for the pair $(R_f \to R_f[x_1, \ldots, x_n], M_f)$
then by
Lemma \ref{lemma-generic-flatness-locus-reduce}
we see that $U(R \to S, M)$ is dense in $\text{Spec}(R)$.
Hence we may assume either (a) $a_KR = R$, or (b) $V(a_K) = \text{Spec}(R)$.
In case (a) the number $m$ drops, as $a_K$ has turned into a unit.
In case (b), since $R$ is reduced, we conclude that $a_K = 0$.
Hence the set $E$ decreases so the number $m$ drops as well.
In both cases we win by induction on $m$.

\medskip\noindent
At this point we have proven the lemma in case $S = R[x_1, \ldots, x_n]$.
Assume that $(R \to S, M)$ is an arbitrary pair satisfying the conditions of
the lemma. Choose a surjection $R[x_1, \ldots, x_n] \to S$. Observe that,
with the notation introduced in (\ref{equation-good-locus}), we have
$$
U(R \to S, M) =
U(R \to R[x_1, \ldots, x_n], S) 
\cap
U(R \to R[x_1, \ldots, x_n], S) 
$$
Hence as we've just finished proving the right two opens are dense also
the open on the left is dense.
\end{proof}






\section{Around Krull-Akizuki}
\label{section-krull-akizuki}

\noindent
One application of Krull-Akizuki is to show that there are plenty
of discrete valuation rings. More generally in this section we
show how to construct discrete valution rings dominating Noetherian
local rings.

\medskip\noindent
First we show how to dominate a Noetherian local domain
by a $1$-dimensional Noetherian local domain by blowing up
the maximal ideal.

\begin{lemma}
\label{lemma-dominate-by-dimension-1}
Let $R$ be a local Noetherian domain with fraction field $K$.
Assume $R$ is not a field.
Then there exist $R \subset R' \subset K$ with
\begin{enumerate}
\item $R'$ local Noetherian of dimension $1$,
\item $R \to R'$ a local ring map, i.e., $R'$ dominates $R$, and
\item $R \to R'$ essentially of finite type.
\end{enumerate}
\end{lemma}

\begin{proof}
Choose any valuation ring $A \subset K$ dominating $R$ (which
exist by Lemma \ref{lemma-dominate}).
Denote $v$ the corresponding valuation.
Let $x_1, \ldots, x_r$ be a minimal set of generators of the
maximal ideal $\mathfrak m$ of $R$. We may and do assume that
$v(x_r) = \min\{v(x_1), \ldots, v(x_r)\}$. Consider the ring
$$
S = R[x_1/x_r, x_2/x_r, \ldots, x_{r - 1}/x_r] \subset K.
$$
Note that $\mathfrak mS = x_rS$ is a principal ideal.
Note that $S \subset A$ and that $v(x_r) > 0$, hence we see
that $x_rS \not = S$. Choose a minimal prime $\mathfrak q$
over $x_rS$. Then $\text{height}(\mathfrak q) = 1$ by
Lemma \ref{lemma-minimal-over-1}
and $\mathfrak q$ lies over $\mathfrak m$. Hence we
see that $R' = S_{\mathfrak q}$ is a solution.
\end{proof}

\noindent
The spectrum of the ring $R'$ in the following lemma is really the
blow up of $\text{Spec}(R)$ in the maximal ideal of $R$ (at least if
case $R$ is reduced).

\begin{lemma}
\label{lemma-nonregular-dimension-one}
Let $R$ be a local ring with maximal ideal $\mathfrak m$.
Assume $R$ is Noetherian, dimension $1$ and that
$\dim(\mathfrak m/\mathfrak m^2) > 1$. Then there exists
a ring map $R \to R'$ such that
\begin{enumerate}
\item $R \to R'$ is finite,
\item $R \to R'$ is not an isomorphism, and
\item for every $f \in \mathfrak m$ the map $R_f \to R'_f$ is an
isomorphism.
\end{enumerate}
\end{lemma}

\begin{proof}
If $\mathfrak m$ is an associated prime of $R$ then we
can take $R' = R/I$ with $I = \{x \in R \mid \mathfrak mx = 0\}$.
Hence we may assume that $\text{depth}(R) = 1$. In other words, we
may assume $R$ is Cohen-Macaulay.

\medskip\noindent
Denote $\kappa = R/\mathfrak m$ the residue field of $R$.
Consider the graded $\kappa$-algebra
$S = \bigoplus_{d \geq 0} \mathfrak m^d/\mathfrak m^{d + 1}$.
This is a Noetherian ring, and hence has finitely many
minimal primes $\mathfrak q_j$.
Since the dimension of $R$ is $1$ we know the Hilbert function
of $R$ is eventually constant, see Proposition \ref{proposition-dimension}.
Hence there exists an integer $d_0 \geq 0$ and an integer
$r > 0$ such that $\dim_\kappa(\mathfrak m^n/\mathfrak m^{n + 1}) = r$ for
all $d \geq d_0$.
By Lemma \ref{lemma-dimension-graded} we have $\dim(S) = 1$
and each $\mathfrak q_i$ is a homogeneous prime ideal.
Note that $\dim(S) = 1$ implies
none of the $\mathfrak q_i$ is equal to $S_{+}$.
Hence by Lemma \ref{lemma-graded-silly} we may choose
$f \in S_{+}$ homogeneous not contained in any $\mathfrak q_j$.
Then $\dim(S/fS) = 0$. This implies that $\dim_\kappa(S/fS) < \infty$,
see for example Lemma \ref{lemma-Noether-normalization}.
Hence we see that $fS_n = S_{n + \deg(f)}$ for all $n \gg 0$.

\medskip\noindent
Set $d = \deg(f)$. Choose $x \in \mathfrak m^d$ which maps
to $f$. Note that since $fS_n = S_{n + d}$ for $n \gg 0$ we have
$x\mathfrak m^n = \mathfrak m^{n + d}$ by Nakayama's Lemma \ref{lemma-NAK}
for $n \gg 0$. Hence $\mathfrak m = \sqrt{(x)}$. Since $R$ is
Cohen-Macaulay this implies that $x$ is a nonzero divisor.
Choose generators $x_1, \ldots, x_t$ of $\mathfrak m^d$
as an ideal of $R$. Set
$$
R' = R[x_1/x, x_2/x, \ldots, x_t/x] \subset R[1/x].
$$
Note that since $x$ is a nonzero divisor we have $R \subset R'$.
Since $\mathfrak m = \sqrt{(x)}$ we see that $x$ is invertible in
$R_g$ for any $g \in \mathfrak m$, whence (3).

\medskip\noindent
We claim that $R'$ is finite over $R$. Namely, choose $n$ such that
$x\mathfrak m^{nd} = \mathfrak m^{(n + 1)d}$. Then we can write
$x_i^{n + 1} = xf_i(x_1, \ldots, x_t)$ with $f_i \in R[X_1, \ldots, X_t]$
homogeneous of degree $n$. Hence we see that
$$
(x_i/x)^{n + 1} = f_i(x_1/x, \ldots, x_t/x)
$$
in $R'$ with the right hand side of degree $\leq n$. Hence any
element in $R'$ can be expressed as a sum of
$(x_1/x)^{i_1} \ldots (x_t/x)^{i_t}$ with $i_j \leq n$. This proves
that $R'$ is finite over $R$.

\medskip\noindent
Finally we show that $R \not = R'$.
We argue by contradiction. Suppose $R' = R$. This means that
$x_1/x, \ldots, x_t/x \in R$ for all $i$. In other words this means
that $\mathfrak m^d = (x)$.
Choose $y_1, \ldots, y_s \in \mathfrak m$ a minimal generating set.
The assumption of the lemma implies $s \geq 2$.
For some $i_1, \ldots, i_s \geq 0$, $\sum i_j = d$ we have
$x = u y_1^{i_1} \ldots y_s^{i_s}$ for some unit $u$ in $R$.
We may assume $i_1 > 0$. Then
$$
y_1^{i_1 - 1} y_2^{i_2 + 1} y_3^{i_3} \ldots y_s^{i_s} \in \mathfrak m^d
$$
is a multiple of $x$ hence a multiple of $y_1^{i_1} \ldots y_s^{i_s}$.
Hence we see that $y_2/y_1 \in R$. This is a contradiction with
the minimality of $y_1, \ldots, y_s$.
\end{proof}

\begin{example}
\label{example-nonreduced}
Consider the Noetherian local ring
$$
R = k[[x, y]]/(y^2)
$$
It has dimension 1 and it is Cohen-Macaulay.
The result of applying the procedure of
Lemma \ref{lemma-nonregular-dimension-one} to $R$
is the extension
$$
k[[x, y]]/(y^2) \subset k[[x, z]]/(z^2), \ \ y \mapsto xz
$$
in other words it is gotten by adjoining $y/x$ to $R$. The
effect of repeating the construction $n > 1$ times is
to adjoin the element $y/x^n$.
\end{example}

\begin{example}
\label{example-bad-dvr-char-p}
Let $k$ be a field of characteristic $p > 0$ such that $k$
has infinite degree over its subfield $k^p$ of $p$th powers.
For example $k = \mathbf{F}_p(t_1, t_2, t_3, \ldots)$.
Consider the ring
$$
A =
\left\{
\sum a_i x^i \in k[[x]] \text{ such that }
[k^p(a_0, a_1, a_2, \ldots) : k^p] < \infty
\right\}
$$
Then $A$ is a discrete valuation ring and its completion is
$A^\wedge = k[[x]]$. Note that the field extension $f.f.(A) \subset
f.f.(k[[x]])$ is infinite purely inseparable.
Choose any $f \in k[[x]]$, $f \not \in A$. Let $R = A[f] \subset k[[x]]$.
Then $R$ is a Noetherian local domain of dimension $1$ whose
completion $R^\wedge$ is nonreduced (think!).
\end{example}

\begin{remark}
\label{remark-resolution-dim-1}
Suppose that $R$ is a $1$-dimensional semi-local Noetherian domain.
If there is a maximal ideal $\mathfrak m \subset R$ such that
$R_{\mathfrak m}$ is not regular, then we may apply the procedure of
(the proof of) Lemma \ref{lemma-nonregular-dimension-one} to $(R, \mathfrak m)$
to get a finite ring extension $R \subset R_1$.
(Note that $\text{Spec}(R_1) \to \text{Spec}(R)$ is the blow up
of $\text{Spec}(R)$ in the ideal $\mathfrak m$.) Of course $R_1$ is
a $1$-dimensional semi-local Noetherian domain with the same fraction
field as $R$. If $R_1$ is not a regular semi-liocal ring, then
we may repeat the construction to get $R_1 \subset R_2$.
Thus we get a sequence
$$
R \subset R_1 \subset R_2 \subset R_3 \subset \ldots
$$
of finite ring extensions which may stop if $R_n$ is regular for
some $n$. Resolution of singularities would be the claim
that eventually $R_n$ is indeed regular. In reality this is not
the case. Namely, there exists a characteristic $0$
Noetherian local domain $A$ of dimension $1$ whose completion is nonreduced,
see \cite[Proposition 3.1]{Ferrand-Raynaud} or our
Examples, Section \ref{examples-section-local-completion-nonreduced}.
For an example in characteristic $p > 0$ see
Example \ref{example-bad-dvr-char-p}.
Since the construction of blowing up commutes with completion it
is easy to see the sequence never stabilizes.
See \cite{Bennett} for a discussion (mostly in positive characteristic).
On the other hand, if the completion of $R$ in all of its maximal
ideals is reduced, then the procedure stops (insert future reference
here).
\end{remark}

\begin{lemma}
\label{lemma-characterize-dvr}
Let $A$ be a ring. The following are equivalent.
\begin{enumerate}
\item The ring $A$ is a discrete valuation ring.
\item The ring $A$ is a valuation ring and Noetherian.
\item The ring $A$ is a regular local ring of dimension $1$.
\item The ring $A$ is a Noetherian local domain with maximal ideal
$\mathfrak m$ generated by a single nonzero element.
\item The ring $A$ is a Noetherian local normal domain of dimension $1$.
\end{enumerate}
In this case if $\pi$ is a generator of the maximal ideal of
$A$, then every element of $A$ can be uniquely written as
$u\pi^n$, where $u \in A$ is a unit.
\end{lemma}

\begin{proof}
The equivalence of (1) and (2) is
Lemma \ref{lemma-valuation-ring-Noetherian-discrete}.
Moreover, in the proof of Lemma \ref{lemma-valuation-ring-Noetherian-discrete}
we saw that if $A$ is a dscrete valuation ring, then $A$ is a PID, hence (3).
Note that a regular local ring is a domain (see
Lemma \ref{lemma-regular-domain}). Using this the equivalence of (3) and (4)
follows from dimension theory, see Section \ref{section-dimension}.

\medskip\noindent
Assume (3) and let $\pi$ be a generator of the maximal ideal $\mathfrak m$.
For all $n \geq 0$ we have
$\dim_{A/\mathfrak m} \mathfrak m^n/\mathfrak m^{n + 1} = 1$
because it is generated by $\pi^n$ (and it cannot be zero).
In particular $\mathfrak m^n = (\pi^n)$ and
the graded ring $\bigoplus \mathfrak m^n/\mathfrak m^{n + 1}$
is isomorphic to the polynomial ring $A/\mathfrak m[T]$.
For $x \in A \setminus \{0\}$ define
$v(x) = \max\{n \mid x \in \mathfrak m^n\}$.
In other words $x = u \pi^{v(x)}$ with $u \in A^*$.
By the remarks above we have $v(xy) = v(x) + v(y)$
for all $x, y \in A \setminus \{0\}$. We extend this to the field of fractions
$K$ of $A$ by setting $v(a/b) = v(a) - v(b)$ (well defined by multiplicativity
shown above). Then it is clear that $A$ is the set of elements of
$K$ which have valuation $\geq 0$. Hence we see that $A$ is a
valuation ring by Lemma \ref{lemma-valuation-valuation-ring}.

\medskip\noindent
A valuation ring is a normal domain by Lemma \ref{lemma-valuation-ring-normal}.
Hence we see that the equivalent conditions (1) -- (3) imply
(5). Assume (5). Suppose that $\mathfrak m$ cannot be generated
by $1$ element to get a contradiction.
Then Lemma \ref{lemma-nonregular-dimension-one} implies there is a finite
ring map $A \to A'$ which is an isomorphism after inverting
any nonzero element of $\mathfrak m$ but not an isomorphism.
In particular $A' \subset f.f.(A)$.
Since $A \to A'$ is finite it is integral (see
Lemma \ref{lemma-finite-is-integral}).
Since $A$ is normal we get $A = A'$ a contradiction.
\end{proof}

\begin{lemma}
\label{lemma-finite-length}
Let $R$ be a domain with fraction field $K$.
Let $M$ be an $R$-submodule of $K^{\oplus r}$.
Assume $R$ is local Noetherian of dimension $1$.
For any nonzero $x \in R$ we have $\text{length}_R(R/xR) < \infty$
and
$$
\text{length}_R(M/xM) \leq r \cdot \text{length}_R(R/xR).
$$
\end{lemma}

\begin{proof}
If $x$ is a unit then the result is true. Hence we may assume
$x \in \mathfrak m$ the maximal ideal of $R$. Since $x$ is not
zero and $R$ is a domain we have $\dim(R/xR) = 0$, and hence
$R/xR$ has finite length. Consider $M \subset K^{\oplus r}$ as
in the lemma. We may assume that the elements of $M$ generate
$K^{\oplus r}$ as a $K$-vector space after replacing $K^{\oplus r}$
by a smaller subspace if necessary.

\medskip\noindent
Suppose first that $M$ is a finite $R$-module. In that case we can clear
denominators and assume $M \subset R^{\oplus r}$. Since
$M$ generates $K^{\oplus r}$ as a vectors space we see that
$R^{\oplus r}/M$ has finite length. In particular there exists
an integer $c \geq 0$ such that $x^cR^{\oplus r} \subset M$.
Note that $M \supset xM \supset x^2M \supset \ldots$ is a sequence of
modules with succesive quotients each isomorphic to $M/xM$. Hence
we see that
$$
n \text{length}_R(M/xM) = \text{length}_R(M/x^nM).
$$
The same argument for $M = R^{\oplus r}$ shows that
$$
n \text{length}_R(R^{\oplus r}/xR^{\oplus r}) =
\text{length}_R(R^{\oplus r}/x^nR^{\oplus r}).
$$
By our choice of $c$ above we see that $x^nM$ is sandwiched between
$x^n R^{\oplus r}$ and $x^{n + c}R^{\oplus r}$. This easily gives that
$$
r(n + c) \text{length}_R(R/xR)
\geq
n \text{length}_R(M/xM)
\geq
r (n - c) \text{length}_R(R/xR)
$$
Hence in the finite case we actually get the result of the lemma with
equality.

\medskip\noindent
Suppose now that $M$ is not finite. Suppose that the length of $M/xM$ is
$\geq k$ for some natural number $k$. Then we can find
$$
0 \subset N_0 \subset N_1 \subset N_2 \subset \ldots N_k \subset M/xM
$$
with $N_i \not = N_{i + 1}$ for $i = 0, \ldots k - 1$.
Choose an element $m_i \in M$ whose congruence class mod $xM$ falls
into $N_i$ but not into $N_{i - 1}$ for $i = 1, \ldots, k$.
Consider the finite $R$-module $M' = Rm_1 + \ldots + Rm_k \subset M$.
Let $N'_i \subset M'/xM'$ be the inverse image of $N_i$.
It is clear that $N'_i \not =N'_{i + 1}$ by our choice of $m_i$.
Hence we see that $\text{length}_R(M'/xM') \geq k$. By the
finite case we conclude $k \leq r\text{length}_R(R/xR)$
as desired.
\end{proof}

\noindent
Here is a first application.

\begin{lemma}
\label{lemma-finite-extension-residue-fields-dimension-1}
Let $(R, \mathfrak m) \to (S, \mathfrak n)$
be a local homomorphism of local domains
with fraction fields $K \subset L$. If
$R$ is Noetherian of dimension $1$, and $[L : K] < \infty$
then $[\kappa(\mathfrak n) : \kappa(\mathfrak m)] < \infty$.
\end{lemma}

\begin{proof}
This is clear on applying Lemma \ref{lemma-finite-length}
to the submodule $S \subset L \cong K^{\oplus n}$ where
$n = [L : K]$.
Namely, this shows that for any nonzero $x \in \mathfrak m$
the ring $S/xS$ has finite length over $R$, which shows
that $\kappa(\mathfrak n)$ has finite length over $R$,
which implies that $\dim_{\kappa(\mathfrak m)} \kappa(\mathfrak n)$
is finite (Lemma \ref{lemma-dimension-is-length}).
\end{proof}


\begin{lemma}
\label{lemma-finite-length-global}
Let $R$ be a domain with fraction field $K$.
Let $M$ be an $R$-submodule of $K^{\oplus r}$.
Assume $R$ is Noetherian of dimension $1$.
For any nonzero $x \in R$ we have
$\text{length}_R(M/xM) < \infty$.
\end{lemma}

\begin{proof}
Since $R$ has dimension $1$ we see that
$x$ is contained in finitely many primes
$\mathfrak m_i$, $i = 1, \ldots, n$, each maximal.
Since $R$ is Noetherian we see that $R/xR$ is Artinian,
see Proprosition \ref{proposition-dimension-zero-ring}.
Hence $R/xR$ is a quotient of
$\prod R/\mathfrak m_i^{e_i}$ for certain $e_i$ because
that $\mathfrak m_1^{e_1} \ldots \mathfrak m_n^{e_n} \subset (x)$
for suitably large $e_i$ as $R/xR$ is Artinian
(see Section \ref{section-artinian}).
Hence $M/xM$ similarly decomposes as a product
$\prod (M/xM)_{\mathfrak m_i} = \prod M/(\mathfrak m_i^{e_i}, x)M$
of its localizations at the $\mathfrak m_i$. By
Lemma \ref{lemma-finite-length} applied to $M_{\mathfrak m_i}$
over $R_{\mathfrak m_i}$ we see each
$M_{\mathfrak m_i}/xM_{\mathfrak m_i} = (M/xM)_{\mathfrak m_i}$
has finite length over $R_{\mathfrak m_i}$. It easily follows that $M/xM$
has finite length over $R$.
\end{proof}

\begin{lemma}
\label{lemma-krull-akizuki}
(Krull-Akizuki)
Let $R$ be a domain with fraction field $K$.
Let $K \subset L$ be a finite extension of fields.
Assume $R$ is Noetherian and $\dim(R) = 1$.
In this case any ring $A$ with $R \subset A \subset L$ is
Noetherian.
\end{lemma}

\begin{proof}
To begin we may assume that $L$ is the fraction field of $A$
by replacing $L$ by the fraction field of $A$ if necessary.
Let $I \subset A$ be an ideal. Clearly $I$ generates $L$ as
a $K$-vectors space. Hence we see that $I \cap R \not = (0)$.
Pick any nonzero $x \in I \cap R$. Then we get
$I/xA \subset A/xA$. By Lemma \ref{lemma-finite-length-global}
the $R$-module $A/xA$ has finite length as an $R$-module. Hence
$I/xA$ has finite length as an $R$-module. Hence $I$ is finitely
generated as an ideal in $A$.
\end{proof}

\begin{lemma}
\label{lemma-exists-dvr}
Let $R$ be a Noetherian local domain with fraction field $K$.
Assume that $R$ is not a field.
Let $K \subset L$ be a finitely generated field extension.
Then there exists discrete valuation ring $A$ with fraction field
$L$ which dominates $R$.
\end{lemma}

\begin{proof}
If $L$ is not finite over $K$ choose a transcendence basis
$x_1, \ldots, x_r$ of $L$ over $K$ and replace $R$ by
$R[x_1, \ldots, x_r]$ localized at the maximal ideal
generated by $\mathfrak m_R$ and $x_1, \ldots, x_r$.
Thus we may assume $K \subset L$ finite.

\medskip\noindent
By Lemma \ref{lemma-dominate-by-dimension-1} we may assume $\dim(R) = 1$.

\medskip\noindent
Let $A \subset L$ be the integral closure of $R$ in $L$.
By Lemma \ref{lemma-krull-akizuki} this is Noetherian.
By Lemma \ref{lemma-integral-overring-surjective} there
is a prime ideal $\mathfrak q \subset A$ lying
over the maximal ideal of $R$.
By Lemma \ref{lemma-characterize-dvr} the ring $A_{\mathfrak q}$ is a discrete
valuation ring dominating $R$ as desired.
\end{proof}








\section{Factorization}
\label{section-factoring}

\noindent
Here are some notions and relations between them that are typically taught
in a first year course on algebra at the undergraduate level.

\begin{definition}
\label{definition-irreducible-prime-element}
Let $R$ be a domain.
\begin{enumerate}
\item Elements $x, y \in R$ are called {\it associates} if
there exists a unit $u \in R^*$ such that $x = uy$.
\item An element $x \in R$ is called {\it irreducible}
if it is nonzero, not a unit and whenever $x = yz$, $y, z \in R$,
then $y$ is either a unit or an associate of $x$.
\item An element $x \in R$ is called {\it prime} if the ideal
generated by $x$ is a prime ideal.
\end{enumerate}
\end{definition}

\begin{lemma}
\label{lemma-easy-divisibility}
Let $R$ be a domain.
Let $x, y \in R$.
Then $x$, $y$ are associates if and only if $(x) = (y)$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-factorization-exists}
Let $R$ be a domain. Consider the following conditions:
\begin{enumerate}
\item The ring $R$ satisfies the ascending chain condition for
principal ideals.
\item Every nonzero, nonunit element $a \in R$
has a factorization $a = b_1 \ldots b_k$
with each $b_i$ an irreducible element of $R$.
\end{enumerate}
Then (1) implies (2).
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{definition}
\label{definition-UFD}
A {\it unique factorization domain}, abbreviated {\it UFD},
is a domain $R$ such that
if $x \in R$ is a nonzero, nonunit, then $x$ has a factorization
into irreducibles, and if
$$
x = a_1 \ldots a_m = b_1 \ldots b_n
$$
are factorizations into irreducibles then $n = m$ and
there exists a permutation $\sigma : \{1, \ldots, n\} \to \{1, \ldots, n\}$
such that $a_i$ and $b_{\sigma(i)}$ are associates.
\end{definition}

\begin{lemma}
\label{lemma-characterize-UFD}
Let $R$ be a domain. Assume every nonzero, nonunit factors into
irreducibles. Then $R$ is a UFD if and only if every irreducible
element is prime.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{definition}
\label{definition-PID}
A {\it principal ideal domain}, abbreviated {\it PID},
is a domain $R$ such that every ideal is a principal ideal.
\end{definition}

\begin{lemma}
\label{lemma-PID-UFD}
A principal ideal domain is a unique factorization domain.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{definition}
\label{definition-dedekind-domain}
A {\it Dedekind domain} is a domain $R$ such that every
nonzero ideal $I \subset R$ can be written
$$
I = \mathfrak p_1 \ldots \mathfrak p_r
$$
uniquely up to permutation of the prime ideals $\mathfrak p_i$.
\end{definition}

\begin{lemma}
\label{lemma-characterize-Dedekind}
Let $R$ be a ring. The following are equivalent
\begin{enumerate}
\item $R$ is a Dedeking domain,
\item $R$ is a Noetherian domain, and for every maximal ideal $\mathfrak m$
the local ring $R_{\mathfrak m}$ is a discrete valuation ring, and
\item $R$ is a Noetherian, normal domain, and $\dim(R) \leq 1$.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted.
\end{proof}






\section{Orders of vanishing}
\label{section-orders-of-vanishing}

\begin{lemma}
\label{lemma-ord-additive}
Let $R$ be a semi-local Noetherian ring of dimension $1$.
If $a, b \in R$ are not zero divisors then
$$
\text{length}_R(R/(ab)) =
\text{length}_R(R/(a)) +
\text{length}_R(R/(b))
$$
and these lengths are finite.
\end{lemma}

\begin{proof}
We saw the finiteness in Lemma \ref{lemma-finite-length-global}.
Additivity holds since there is a short exact sequence
$0 \to R/(a) \to R/(ab) \to R/(b) \to 0$ where the first map
is given by multiplication by $b$. (Use length is additive,
see Lemma \ref{lemma-length-additive}.)
\end{proof}

\begin{definition}
\label{definition-ord}
Suppose that $K$ is a field, and $R \subset K$ is a
local\footnote{We could also define this when $R$ is only
semi-local but this is probably never really what you want!}
Noetherian subring of dimension $1$ with fraction field $K$.
In this case we define the {\it order of vanishing along $R$}
$$
\text{ord}_R : K^* \longrightarrow \mathbf{Z}
$$
by the rule
$$
\text{ord}_R(x) = \text{length}_R(R/(x))
$$
if $x \in R$ and we set
$\text{ord}_R(x/y) = \text{ord}_R(x) - \text{ord}_R(y)$
for $x, y \in R$ both nonzero.
\end{definition}

\noindent
We can use the order of vanishing to compare lattices in a
vector space. Here is the definition.

\begin{definition}
\label{definition-lattice}
Let $R$ be a Noetherian local domain of dimension $1$ with
fraction field $K$. Let $V$ be a finite dimensional $K$-vector space.
A {\it lattice in $V$} is a finite $R$-submodule $M \subset V$ such
that $V = K \otimes_R M$.
\end{definition}

\noindent
The condition $V = K \otimes_R M$ signifies that $M$ contains a
basis for the vector space $K$. We remark that in many places in the
literature the notion of a lattice may be defined only in case the
ring $R$ is a discrete valuation ring. If $R$ is a discrete valuation
ring then any lattice is a free $R$-module, and this may not be the case
in general.

\begin{lemma}
\label{lemma-compare-lattices}
Let $R$ be a Noetherian local domain of dimension $1$ with
fraction field $K$. Let $V$ be a finite dimensional $K$-vector space.
\begin{enumerate}
\item If $M$ is a lattice in $V$ and $M \subset M' \subset V$
is an $R$-submodule of $V$ containing $M$
then the following are equivalent
\begin{enumerate}
\item $M'$ is a lattice,
\item $\text{length}_R(M'/M)$ is finite, and
\item $M'$ is finitely generated.
\end{enumerate}
\item If $M$ is a lattice in $V$ and $M' \subset M$ is an $R$-submodule
of $M$ then $M'$ is a lattice if and only if
$\text{length}_R(M/M')$ is finite.
\item If $M$, $M'$ are lattices in $V$, then so are
$M \cap M'$ and $M + M'$.
\item If $M \subset M' \subset M'' \subset V$ are lattices in $V$
then
$$
\text{length}_R(M''/M) = 
\text{length}_R(M'/M) +
\text{length}_R(M''/M').
$$
\item If $M$, $M'$, $N$, $N'$ are lattices in $V$ and
$N \subset M \cap M'$, $M + M' \subset N'$, then we have
\begin{eqnarray*}
& &\text{length}_R(M/M \cap M') - \text{length}_R(M'/M \cap M')\\
& = &
\text{length}_R(M/N) - \text{length}_R(M'/N) \\
& = &
\text{length}_R(M + M' / M') - \text{length}_R(M + M'/M) \\
& = &
\text{length}_R(N' / M') - \text{length}_R(N'/M)
\end{eqnarray*}
\end{enumerate}
\end{lemma}

\begin{proof}
Proof of (1). Assume (1)(a). Say $y_1, \ldots, y_m$ generate $M'$.
Then each $y_i = x_i/f_i$ for some $x_i \in M$ and
nonzero $f_i \in R$.
Hence we see that $f_1 \ldots f_m M' \subset M$.
Since $R$ is Noetherian local of dimension $1$
we see that $\mathfrak m^n \subset (f_1 \ldots f_m)$
for some $n$ (for example combine
Lemmas \ref{lemma-one-equation} and
Proposition \ref{proposition-dimension-zero-ring} or combine
Lemmas \ref{lemma-finite-length} and \ref{lemma-length-infinite}).
In other words $\mathfrak m^nM' \subset M$ for some $n$
Hence
$\text{length}(M'/M) < \infty$ by Lemma \ref{lemma-length-finite},
in other words (1)(b) holds.
Assume (1)(b). Then $M'/M$ is a finite $R$-module
(see Lemma \ref{lemma-finite-length-finite}).
Hence $M'$ is a finite $R$-module as an extension of finite $R$-modules.
Hence (1)(c). The implication
(1)(c) $\Rightarrow$ (1)(a) follows from the remark following
Definition \ref{definition-lattice}.

\medskip\noindent
Proof of (2). Suppose
$M$ is a lattice in $V$ and $M' \subset M$ is an $R$-submodule.
We have seen in (1) that if $M'$ is a lattice, then
$\text{length}_R(M/M') < \infty$. Conversely, assume that
$\text{length}_R(M/M') < \infty$. Then $M'$ is finitely generated
as $R$ is Noetherian and for some $n$ we have
$\mathfrak m^n M \subset M'$ (Lemma \ref{lemma-length-infinite}).
Hence it follows
that $M'$ contains a basis for $V$, and $M'$ is a lattice.

\medskip\noindent
Proof of (3). Assume $M$, $M'$ are lattices in $V$.
Since $R$ is Noetherian the submodule $M \cap M'$ of $M$ is finite.
As $M$ is a lattice we can find
$x_1, \ldots, x_n \in M$ which form a $K$-basis for
$V$. Because $M'$ is a lattice we can write $x_i = y_i/f_i$ with
$y_i \in M'$ and $f_i \in R$. Hence $f_ix_i \in M \cap M'$. Hence
$M \cap M'$ is a lattice also.
The fact that $M + M'$ is a lattice follows from part (1).

\medskip\noindent
Part (4) follows from additivity of lengths
(Lemma \ref{lemma-length-additive})
and the exact sequence
$$
0 \to M'/M \to M''/M \to M''/M' \to 0
$$
Part (5) follows from repeatedly applying part (4).
\end{proof}

\begin{definition}
\label{definition-distance}
Let $R$ be a Noetherian local domain of dimension $1$ with
fraction field $K$. Let $V$ be a finite dimensional $K$-vector space.
Let $M$, $M'$ be two lattices in $V$. The {\it distance between
$M$ and $M'$} is the integer
$$
d(M, M') = \text{length}_R(M/M \cap M') - \text{length}_R(M'/M \cap M')
$$
of Lemma \ref{lemma-compare-lattices} part (5).
\end{definition}

\noindent
In particular, if $M' \subset M$, then
$d(M, M') = \text{length}_R(M/M')$.

\begin{lemma}
\label{lemma-properties-distance-function}
Let $R$ be a Noetherian local domain of dimension $1$ with
fraction field $K$. Let $V$ be a finite dimensional $K$-vector space.
This distance function has the property that
$$
d(M, M'') = d(M, M') + d(M', M'')
$$
whenever given three lattices $M$, $M'$, $M''$ of $V$.
In particular we have $d(M, M') = - d(M', M)$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-order-vanishing-determinant}
Let $R$ be a Noetherian local domain of dimension $1$ with
fraction field $K$. Let $V$ be a finite dimensional $K$-vector space.
Let $\varphi : V \to V$ be a $K$-linear isomorphism.
For any lattice $M \subset V$ we have
$$
d(M, \varphi(M)) = \text{ord}_R(\det(\varphi))
$$
\end{lemma}

\begin{proof}
We can see that the integer $d(M, \varphi(M))$ does not depend
on the lattice $M$ as follows. Suppose that $M'$ is a second such
lattice. Then we see that
\begin{eqnarray*}
d(M, \varphi(M)) & = & d(M, M') + d(M', \varphi(M)) \\
& = & d(M, M') + d(\varphi(M'), \varphi(M)) + d(M', \varphi(M'))
\end{eqnarray*}
Since $\varphi$ is an isomorphism we see that
$d(\varphi(M'), \varphi(M)) = d(M', M) = -d(M, M')$, and hence
$d(M, \varphi(M)) = d(M', \varphi(M'))$. Moreover, both sides of the
equation (of the lemma) are additive in $\varphi$, i.e.,
$$
\text{ord}_R(\det(\varphi \circ \psi))
=
\text{ord}_R(\det(\varphi))
+
\text{ord}_R(\det(\psi))
$$
and also
\begin{eqnarray*}
d(M, \varphi(\psi((M))) & = &
d(M, \psi(M)) + d(\psi(M), \varphi(\psi(M))) \\
& = & d(M, \psi(M)) + d(M, \varphi(M))
\end{eqnarray*}
by the independence shown above. Hence it suffices to prove the lemma
for generators of $\text{GL}(V)$. Choose an isomorphism
$K^{\oplus n} \cong V$. Then $\text{GL}(V) = \text{GL}_n(K)$ is
generated by elementary matrices $E$.
The result is clear for $E$ equal to the identity matrix.
If $E = E_{ij}(\lambda)$ with $i \not = j$, $\lambda \in K$,
$\lambda \not = 0$, for example
$$
E_{12}(\lambda) =
\left(
\begin{matrix}
1 & \lambda & \ldots \\
0 & 1 & \ldots \\
\ldots & \ldots & \ldots
\end{matrix}
\right)
$$
then with respect to a different basis we get $E_{12}(1)$.
The result is clear for $E = E_{12}(1)$ by taking as lattice
$R^{\oplus n} \subset K^{\oplus n}$. Finally, if $E = E_i(a)$,
with $a \in K^*$ for example
$$
E_1(a) =
\left(
\begin{matrix}
a & 0 & \ldots \\
0 & 1 & \ldots \\
\ldots & \ldots & \ldots
\end{matrix}
\right)
$$
then $E_1(a)(R^{\oplus b}) = aR \oplus R^{\oplus n - 1}$ and
it is clear that $d(R^{\oplus n}, aR \oplus R^{\oplus n - 1})
= \text{ord}_R(a)$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-finite-extension-dim-1}
Let $A \to B$ be a ring map.
Assume
\begin{enumerate}
\item $A \subset B$ is an extension of domains,
\item $A$ is Noetherian,
\item $B$ is finite over $A$,
\item $A$ is a local of dimension $1$.
\end{enumerate}
Let $K = f.f.(A)$ and $L = f.f.(B)$ so that $L$ is a
finite field extension of $K$.
Let $y \in L^*$ and $x = \text{Nm}_{L/K}(y)$.
In this situation $B$ is semi-local.
Let $\mathfrak m_i$, $i = 1, \ldots, n$ be the maximal ideals of $B$.
Then
$$
\text{ord}_A(x) =
\sum\nolimits_i
[\kappa(\mathfrak m_i) : \kappa(\mathfrak m_A)]
\text{ord}_{B_{\mathfrak m_i}}(y)
$$
where $\text{ord}$ is defined as in Definition \ref{definition-ord}.
\end{lemma}

\begin{proof}
The ring $B$ is semi-local by Lemma \ref{lemma-finite-in-codim-1}.
Write $y = b/b'$ for some $b, b' \in B$.
By the additivity of $\text{ord}$ and multiplicativity of
$\text{Nm}$ it suffices to prove the lemma for
$y = b$ or $y = b'$. In other words we may assume $y \in B$.
In this case the left hand side of the formula is
$$
\sum [\kappa(\mathfrak m_i) : \kappa(\mathfrak m_A)]
\text{length}_{B_{\mathfrak m_i}}((B/yB)_{\mathfrak m_i})
$$
By Lemma \ref{lemma-pushdown-module} this is equal to
$\text{length}_A(B/yB)$. By Lemma \ref{lemma-order-vanishing-determinant}
we have
$$
\text{length}_A(B/yB) = d(B, yB) =
\text{ord}_A(\det\nolimits_K(L \xrightarrow{y} L)).
$$
Since $x = \text{Nm}_{L/K}(y) = \det\nolimits_K(L \xrightarrow{y} L)$
by definition the lemma is proved.
\end{proof}















\section{Quasi-finite maps}
\label{section-quasi-finite}

\noindent
Consider a ring map $R \to S$ of finite type.
A map $\text{Spec}(S) \to \text{Spec}(R)$ is quasi-finite
at a point if that point is isolated in its fibre.
This means that the fibre is zero dimensional at that point.
In this section we study the basic properties of this
important but technical notion. More advanced material
can be found in the next section.

\begin{lemma}
\label{lemma-isolated-point}
Let $k$ be a field.
Let $S$ be a finite type $k$ algebra.
Let $\mathfrak q$ be a prime of $S$.
The following are equivalent:
\begin{enumerate}
\item $\mathfrak q$ is an isolated point of $\text{Spec}(S)$,
\item $S_{\mathfrak q}$ is finite over $k$,
\item there exists a $g \in S$, $g \not\in \mathfrak q$ such that
$D(g) = \{ \mathfrak q \}$,
\item $\dim_{\mathfrak q} \text{Spec}(S) = 0$,
\item $\mathfrak q$ is a closed point of $\text{Spec}(S)$ and
$\dim(S_{\mathfrak q}) = 0$, and
\item the field extension $k \subset \kappa(\mathfrak q)$ is finite
and $\dim(S_{\mathfrak q}) = 0$.
\end{enumerate}
In this case $S = S_{\mathfrak q} \times S'$ for some
finite type $k$-algebra $S'$. Also, the element $g$
as in (3) has the property $S_{\mathfrak q} = S_g$.
\end{lemma}

\begin{proof}
Suppose $\mathfrak q$ is an isolated point.
By Lemmas \ref{lemma-disjoint-decomposition} and
\ref{lemma-disjoint-implies-product} we may
write $S = S_1 \times S_2$ with $\mathfrak q$
corresponding to the only point $\text{Spec}(S_1)$.
Hence $S_1 = S_{\mathfrak q}$ is a zero dimensional
ring of finite type over $k$. Hence it is finite over $k$
for example by Lemma \ref{lemma-Noether-normalization}.
We have proved (1) implies (2).

\medskip\noindent
Suppose $S_{\mathfrak q}$ is finite over $k$.
Then $S_{\mathfrak q}$ is Artinian local, see
Lemma \ref{lemma-finite-dimensional-algebra}. So
$\text{Spec}(S_{\mathfrak q}) = \{\mathfrak qS_{\mathfrak q}\}$ by
Lemma \ref{lemma-artinian-finite-length}.
Consider the exact sequence $0 \to K \to S \to S_{\mathfrak q}
\to Q \to 0$. It is clear that $K_{\mathfrak q} = Q_{\mathfrak q} = 0$.
Also, $K$ is a finite $S$-module as $S$ is Noetherian and
$Q$ is a finite $S$-modules since $S_{\mathfrak q}$ is finite over $k$.
Hence there exists $g \in S$, $g \not \in \mathfrak q$ such that
$K_g = Q_g = 0$. Thus $S_{\mathfrak q} = S_g$ and
$D(g) = \{ \mathfrak q \}$. We have proved that (2) implies (3).

\medskip\noindent
Suppose $D(g) =  \{ \mathfrak q \}$.
Then $\mathfrak q$ corresponds to a maximal ideal
of $S_g$. Hence $\kappa(\mathfrak q)$ is a finite
extension of $k$, see Theorem \ref{theorem-nullstellensatz}.
Hence $\mathfrak q$ is a closed point of $\text{Spec}(S)$,
see for example Lemma \ref{lemma-finite-residue-extension-closed}.
Thus $\{ \mathfrak q \}$ is both open and closed and
hence $\mathfrak q$ is an isolated point of
$\text{Spec}(S)$. We have proved that (3) implies (1).
In other words (1), (2) and (3) are equivalent.

\medskip\noindent
Assume $\dim_{\mathfrak q} \text{Spec}(S) = 0$. This means that
there is some open neighbourhood of $\mathfrak q$ in $\text{Spec}(S)$
which has dimension zero. Then there is an open neighbourhood of the
form $D(g)$ which has dimension zero. Since $S_g$ is Noetherian
we conclude that $S_g$ is Artinian and
$D(g) = \text{Spec}(S_g)$ is a finite discrete set, see
Proprosition \ref{proposition-dimension-zero-ring}.
Thus $\mathfrak q$ is an isolated point of $D(g)$ and,
by the equivalence of (1) and (2) above applied to
$\mathfrak qS_g \subset S_g$, we see that
$S_{\mathfrak q} = (S_g)_{\mathfrak qS_g}$ is finite over $k$.
Hence (4) implies (2). It is clear that (1) implies (4).
Thus (1) -- (4) are all equivalent.

\medskip\noindent
The equivalence of (4) and (5) follows from the material in
Section \ref{section-dimension-finite-type-algebras}, in particular
Lemma \ref{lemma-dimension-closed-point-finite-type-field}.
The equivalence of (5) and (6) follows from the Hilbert Nullstellensatz,
Theorem \ref{theorem-nullstellensatz}.

\medskip\noindent
The two statements at the end of the lemma we saw during the
course of the proof of the equivalence of (1), (2) and (3) above.
\end{proof}

\begin{lemma}
\label{lemma-isolated-point-fibre}
Let $R \to S$ be a ring map of finite type.
Let $\mathfrak q \subset S$ be a prime lying over
$\mathfrak p \subset R$. The following are equivalent
\begin{enumerate}
\item $\mathfrak q$ is an isolated point of
its fibre, i.e., of $\text{Spec}(S \otimes_R \kappa(\mathfrak p))$,
\item $S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}$ is finite over
$\kappa(\mathfrak p)$,
\item the field extension $\kappa(\mathfrak p) \subset \kappa(\mathfrak q)$
is finite and $\dim(S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}) = 0$, and
\item there exists a $g \in S$, $g \not \in \mathfrak q$ such that
the only prime of $D(g)$ mapping to $\mathfrak p$
is $\mathfrak q$.
\end{enumerate}
\end{lemma}

\begin{proof}
The equivalence of the conditions immediate from
Lemma \ref{lemma-isolated-point}.
\end{proof}

\begin{definition}
\label{definition-quasi-finite}
Let $R \to S$ be a finite type ring map.
Let $\mathfrak q \subset S$ be a prime.
\begin{enumerate}
\item If the equivalent conditions of Lemma \ref{lemma-isolated-point-fibre}
are satisfied then we say $R \to S$ is {\it quasi-finite at $\mathfrak q$}.
\item We say a ring map $A \to B$ is {\it quasi-finite}
if it is of finite type and quasi-finite at all primes of $B$.
\end{enumerate}
\end{definition}

\begin{lemma}
\label{lemma-quasi-finite}
Let $R \to S$ be a finite type ring map.
Then $R \to S$ is quasi-finite if and only if for all
primes $\mathfrak p \subset R$
the fibre $S \otimes_R \kappa(\mathfrak p)$ is finite
over $\kappa(\mathfrak p)$.
\end{lemma}

\begin{proof}
If the fibres are finite then the map is clearly quasi-finite.
For the converse, note that $S \otimes_R \kappa(\mathfrak p)$
is a $\kappa(\mathfrak p)$-algebra of finite type over
$k$ of dimension $0$. Hence it is finite over $k$ for example
by Lemma \ref{lemma-Noether-normalization}.
\end{proof}

\begin{lemma}
\label{lemma-four-rings}
Let
$$
\xymatrix{
S \ar[r] & S' & &
\mathfrak q \ar@{-}[r] & \mathfrak q' \\
R \ar[u] \ar[r] &  R' \ar[u] & &
\mathfrak p \ar@{-}[r] \ar@{-}[u] & \mathfrak p' \ar@{-}[u]
}
$$
be a commutative diagram of rings with primes as indicated.
Assume $R \to S$ of finite type, and $S \otimes_R R' \to S'$ surjective.
If $R \to S$ is quasi-finite at $\mathfrak q$, then
$R' \to S'$ is quasi-finite at $\mathfrak q'$.
\end{lemma}

\begin{proof}
Write $S \otimes_R \kappa(\mathfrak p) = S_1 \times S_2$
with $S_1$ finite over $\kappa(\mathfrak p)$ and such that
$\mathfrak q$ corresponds to a point of $S_1$ as in
Lemma \ref{lemma-isolated-point}.
Because $S \otimes_R R' \to S'$ surjective the canonical map
$(S \otimes_R \kappa(\mathfrak p)) \otimes_{\kappa(\mathfrak p)}
\kappa(\mathfrak p') \to S' \otimes_{R'} \kappa(\mathfrak p')$
is surjective. Let $S_i'$ be the image of $S_i \otimes_{\kappa(\mathfrak p)}
\kappa(\mathfrak p')$ in $S' \otimes_{R'} \kappa(\mathfrak p')$.
Then $S' \otimes_{R'} \kappa(\mathfrak p') =S'_1 \times
S'_2$ and $S'_1$ is finite over $\kappa(\mathfrak p')$.
The map $S' \otimes_{R'} \kappa(\mathfrak p') \to
\kappa(\mathfrak q')$ factors through $S_1'$
(i.e.\ it annihilates the factor $S_2'$)
because the map $S\otimes_R \kappa(\mathfrak p) \to
\kappa(\mathfrak q)$ factors through $S_1$
(i.e.\ it annihilates the factor $S_2$). Thus
$\mathfrak q'$ corresponds to a point of
$\text{Spec}(S_1')$ in the disjoint union decomposition
of the fibre: $\text{Spec}(S' \otimes_{R'} \kappa(\mathfrak p'))
= \text{Spec}(S_1') \amalg \text{Spec}(S_1')$. (See
Lemma \ref{lemma-spec-product}.)
Since $S_1'$ is finite over a field, it is Artinian ring,
and hence $\text{Spec}(S_1')$ is a finite discrete set.
(See Proposition \ref{proposition-dimension-zero-ring}.)
We conclude $\mathfrak q'$ is isolated in its fibre as
desired.
\end{proof}

\begin{lemma}
\label{lemma-quasi-finite-composition}
A composition of quasi-finite ring maps is quasi-finite.
\end{lemma}

\begin{proof}
Suppose $A \to B$ and $B \to C$ are quasi-finite ring maps. By
Lemma \ref{lemma-compose-finite-type}
we see that $A \to C$ is of finite type.
Let $\mathfrak r \subset C$  be a prime of $C$ lying over
$\mathfrak q \subset B$ and $\mathfrak p \subset A$. Since $A \to B$ and
$B \to C$ are quasi-finite at $\mathfrak q$ and $\mathfrak r$ respectively,
then there exist $b \in B$ and $c \in C$ such that $\mathfrak q$ is
the only prime of $D(b)$ which maps to $\mathfrak p$ and similarly
$\mathfrak r$ is  the only prime of $D(c)$ which maps to $\mathfrak q$.
If $c' \in C$ is the image of $b \in B$, then $\mathfrak r$ is the only
prime of $D(cc')$ which maps to $\mathfrak p$.
Therefore $A \to C$ is quasi-finite at $\mathfrak r$.
\end{proof}

\begin{lemma}
\label{lemma-quasi-finite-base-change}
Let $R \to S$ be a ring map of finite type.
Let $R \to R'$ be any ring map. Set $S' = R' \otimes_R S$.
\begin{enumerate}
\item The set
$\{\mathfrak q' \mid R' \to S' \text{ quasi-finite at }\mathfrak q'\}$
is the inverse image of the corresponding set of $\text{Spec}(S)$
under the canonical map $\text{Spec}(S') \to \text{Spec}(S)$.
\item If $\text{Spec}(R') \to \text{Spec}(R)$ is surjective,
then $R \to S$ is quasi-finite if and only if $R' \to S'$ is quasi-finite.
\item Any base change of a quasi-finite ring map is quasi-finite.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $\mathfrak p' \subset R'$ be a prime lying over $\mathfrak p \subset R$.
Then the fibre ring $S' \otimes_{R'} \kappa(\mathfrak p')$ is the
base change of the fibre ring $S \otimes_R \kappa(\mathfrak p)$
by the field extension $\kappa(\mathfrak p) \to \kappa(\mathfrak p')$.
Hence the first assertion follows from the invariance of dimension
under field extension
(Lemma \ref{lemma-dimension-at-a-point-preserved-field-extension})
and Lemma \ref{lemma-isolated-point}.
The stability of quasi-finite maps under base change follows from
this and the stability of finite type property under base change.
The second assertion follows
since the assumption implies that given a prime $\mathfrak q \subset S$ we can
find a prime $\mathfrak q' \subset S'$ lying over it.
\end{proof}

\noindent
The following lemma is not quite about quasi-finite ring maps, but
it does not seem to fit anywhere else so well.

\begin{lemma}
\label{lemma-generically-finite}
Let $R \to S$ be a ring map of finite type.
Let $\mathfrak p \subset R$ be a minimal prime.
Assume that there are at most finitely many primes of $S$
lying over $\mathfrak p$. Then there exists a
$g \in R$, $g \not \in \mathfrak p$ such that the
ring map $R_g \to S_g$ is finite.
\end{lemma}

\begin{proof}
Let $x_1, \ldots, x_n$ be generators of $S$ over $R$.
Since $\mathfrak p$ is a minimal prime we have that
$\mathfrak pR_{\mathfrak p}$ is a locally nilpotent ideal, see
Lemma \ref{lemma-minimal-prime-reduced-ring}.
Hence $\mathfrak pS_{\mathfrak p}$ is a locally nilpotent ideal, see
Lemma \ref{lemma-locally-nilpotent}.
By assumption the finite type $\kappa(\mathfrak p)$-algebra
$S_{\mathfrak p}/\mathfrak pS_{\mathfrak p}$ has finitely many
primes. Hence (for example by
Lemma \ref{lemma-Noether-normalization})
$\kappa(\mathfrak p) \to S_{\mathfrak p}/\mathfrak pS_{\mathfrak p}$
is a finite ring map. Thus we may find monic polynomials
$P_i \in R_{\mathfrak p}[X]$ such that $P_i(x_i)$ maps to zero
in $S_{\mathfrak p}/\mathfrak pS_{\mathfrak p}$. By what we said
above there exist $e_i \geq 1$ such that $P(x_i)^{e_i} = 0$
in $S_{\mathfrak p}$. Let $g_1 \in R$, $g_1 \not \in \mathfrak p$
be an element such that $P_i \in R[1/g_1]$ for all $i$.
Next, let $g_2 \in R$, $g_2 \not \in \mathfrak p$ be an element
such that $P(x_i) = 0$ in $S_{g_1g_2}$. Setting $g = g_1g_2$
we win.
\end{proof}







\section{Zariski's Main Theorem}
\label{section-Zariski}

\noindent
In this section our aim is to prove the algebraic version of
Zariski's Main theorem. This theorem will be the basis of many
further developments in the theory of schemes and morphisms of
schemes later in the project.

\medskip\noindent
Let $R \to S$ be a ring map of finite type.
Our goal in this section is to show that the set
of points of $\text{Spec}(S)$ where the map is quasi-finite
is {\it open} (Theorem \ref{theorem-main-theorem}).
In fact, it will turn out that there exists
a finite ring map $R \to S'$ such that in some sense the quasi-finite
locus of $S/R$ is open in $\text{Spec}(S')$
(but we will not prove this in the algebra chapter since we do not
develop the language of schemes here -- for the case where $R \to S$
is quasi-finite see Lemma \ref{lemma-quasi-finite-open-integral-closure}).
These statements are somewhat tricky to prove and
we do it by a long list of lemmas concering integral and
finite extensions of rings. This material may be found
in \cite{Henselian}, and \cite{Peskine}. We also found notes
by Thierry Coquand helpful.


\begin{lemma}
\label{lemma-make-integral-trivial}
Let $\varphi : R \to S$ be a ring map.
Suppose $t \in S$ satisfies the
relation $\varphi(a_0) + \varphi(a_1)t + \ldots + \varphi(a_n) t^n = 0$.
Then $\varphi(a_n)t$ is integral over $R$.
\end{lemma}

\begin{proof}
Namely, multiply the equation
$\varphi(a_0) + \varphi(a_1)t + \ldots + \varphi(a_n) t^n = 0$
with $\varphi(a_n)^{n-1}$ and write it as
$\varphi(a_0 a_n^{n-1}) +
\varphi(a_1 a_n^{n-2}) (\varphi(a_n)t) +
\ldots +
(\varphi(a_n) t)^n = 0$.
\end{proof}

\begin{lemma}
\label{lemma-make-integral-less-trivial}
Let $\varphi : R \to S$ be a ring map.
Suppose $t \in S$ satisfies the
relation $\varphi(a_0) + \varphi(a_1)t + \ldots + \varphi(a_n) t^n = 0$.
Set $u_n = \varphi(a_n)$, $u_{n-1} = u_n t + \varphi(a_{n-1})$,
and so on till $u_1 = u_2 t + \varphi(a_1)$.
Then all of $u_n, u_{n-1}, \ldots, u_1$ and
$u_nt, u_{n-1}t, \ldots, u_1t$ are integral over $R$,
and the ideals $(\varphi(a_0), \ldots, \varphi(a_n))$ and
$(u_n, \ldots, u_1)$ of $S$ are equal.
\end{lemma}

\begin{proof}
We first remark that $u_{i} =
\varphi(a_n)t^{n-i} + \varphi(a_{n-1})t^{n-i-1} + \ldots + \varphi(a_{i})$
which is easy to verify by descending induction on $i$. Hence it
is clear that $u_{i}t^{i} + \varphi(a_{i-1})t^{i-1} +
\ldots + \varphi(a_0) = 0$.
By Lemma \ref{lemma-make-integral-trivial}
we see that $u_it$ is integral over $R$.
Also, $u_n \in \text{Im}(\varphi)$ is integral over
$R$, and $u_i = u_{i + 1}t + \varphi(a_i)$ is integral over $R$
because it is the sum of two elements integral over $R$.
The statement on the ideals is immediate from the
shape of the elements and the fact that
$u_0 = u_1t + \varphi(a_0) = 0$ as we saw above.
\end{proof}

\begin{lemma}
\label{lemma-make-integral-not-in-ideal}
Let $\varphi : R \to S$ be a ring map.
Suppose $t \in S$ satisfies the
relation $\varphi(a_0) + \varphi(a_1)t + \ldots + \varphi(a_n) t^n = 0$.
Let $J \subset S$ be an ideal such that for at
least one $i$ we have $\varphi(a_i) \not \in J$.
Then there exists a $u \in S$, $u \not\in J$ such
that both $u$ and $ut$ are integral over $R$.
\end{lemma}

\begin{proof}
This is immediate from Lemma \ref{lemma-make-integral-less-trivial}
since one of the elements $u_i$ will not be in $J$.
\end{proof}

\noindent
The following lemma is in some sense the key lemma in this
section.

\begin{lemma}
\label{lemma-make-integral-trick}
Let $R$ be a ring. Let $\varphi : R[x] \to S$ be
a ring map. Let $t \in S$.
Assume that (a) $t$ is integral over $R[x]$,
and (b) there exists a monic $p \in R[x]$ such that
$t \varphi(p) \in \text{Im}(\varphi)$. Then there
exists a $q \in R[x]$ such that $t - \varphi(q)$
is integral over $R$.
\end{lemma}

\begin{proof}
Write $t \varphi(p) = \varphi(r)$ for some $r \in R[x]$.
Using euclidean division, write $r = qp + r'$ with
$q, r' \in R[x]$ and $\deg(r') < \deg(p)$. We may replace
$t$ by $t - \varphi(q)$ which is still integral over
$R[x]$, so that we obtain $t \varphi(p) = \varphi(r')$.
In the ring $S_t$ we may write this as
$\varphi(p) - (1/t) \varphi(r') = 0$.
This implies that $\varphi(x)$ gives an element of the
localization $S_t$ which is integral over
$\varphi(R)[1/t] \subset S_t$. On the other hand,
$t$ is integral over the subring $\varphi(R)[\varphi(x)] \subset S$.
Combined we conclude that $t$ is integral over
the subring $\varphi(R)[1/t] \subset S_t$, see Lemma
\ref{lemma-integral-transitive}. In other words
there exists an equation of the form
$t^d + \sum_{i<d} (\varphi(r_i)/t^{n_i}) t^i = 0$
in $S_t$ with $r_i \in R$. This means that
$t^{d + N} + \sum_{i < d} \varphi(r_i) t^{i + N - n_i} = 0$ in $S$
for some $N$ large enough. In other words
$t$ is integral over $R$.
\end{proof}

\begin{lemma}
\label{lemma-change-equation-multiply}
Let $R$ be a ring and let $\varphi : R[x] \to S$ be
a ring map. Let $t \in S$. If $t$ is integral over
$R[x]$, then there exists an $\ell \geq 0$ such that
for every $a \in R$ the element $\varphi(a)^\ell t$
is integral over $\varphi_a : R["ax"] \to S$, defined by
$"ax" \mapsto \varphi(ax)$ and $r \mapsto \varphi(r)$
for $r\in R$.
\end{lemma}

\begin{proof}
Say $t^d + \sum_{i<d} \varphi(f_i)t^i = 0$
with $f_i \in R[x]$. Let $\ell$ be the maximum degree
in $x$ of all the $f_i$. Multiply the equation
by $\varphi(a)^\ell$ to get
$\varphi(a)^\ell t^d + \sum_{i<d} \varphi(a^\ell f_i)t^i = 0$.
Note that each $\varphi(a^\ell f_i)$ is in the image of
$\varphi_a$. The result follows from
Lemma \ref{lemma-make-integral-trivial}.
\end{proof}

\begin{lemma}
\label{lemma-combine-lemmas}
Let $R$ be a ring. Let $\varphi : R[x] \to S$ be
a ring map. Let $t \in S$. Assume $t$ is integral
over $R[x]$. Let $p \in R[x]$, $p = a_0 + a_1x + \ldots +
a_k x^k$ such that $t \varphi(p) \in \text{Im}(\varphi)$.
Then there exists a $q \in R[x]$ and $n \geq 0$
such that $\varphi(a_k)^n t - \varphi(q) $ is integral
over $R$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-change-equation-multiply} there exists
an $\ell \geq 0$ such that
the element $\varphi(a_k)^\ell t$ is integral
over the map $\varphi' : R[y] \to S$, $\varphi'(y) =
\varphi(a_k x)$ and $\varphi'(r) = \varphi(r)$, for $r\in R$.
The polynomial $p' = a_k^{k-1} a_0 + a_k^{k-2} a_1 y
+ \ldots + y^k$ is monic and $t \varphi'(p')
= \varphi(a_k^{k-1}) t \varphi(p) \in \text{Im}(\varphi)$.
By definition of $\varphi'$ this implies there exists
a $n \geq k-1$ such that $\varphi(a_k^n)t \varphi'(p')
\in \text{Im}(\varphi')$. If also $n \geq \ell$, then
$\varphi(a_k)^n t$ is still integral over $R[y]$.
By Lemma \ref{lemma-make-integral-trick}
we see that $\varphi(a_k)^n t - \varphi'(q)$ is integral over $R$
for some $q \in R[y]$. Again by the simple relationship between
$\varphi'$ and $\varphi$ this implies the lemma.
\end{proof}

\begin{situation}
\label{situation-one-transcendental-element}
Let $R$ be a ring.
Let $\varphi : R[x] \to S$ be finite.
Let
$$
J = \{ g \in S \mid gS \subset \text{Im}(\varphi)\}
$$
be the ``conductor ideal'' of $\varphi$.
Assume $\varphi(R) \subset S$ integrally closed in $S$.
\end{situation}

\begin{lemma}
\label{lemma-leading-coefficient-in-J}
In Situation \ref{situation-one-transcendental-element}.
Suppose $u \in S$, $a_0, \ldots, a_k \in R$,
$u \varphi(a_0 + a_1x + \ldots + a_k x^k) \in J$.
Then there exists an $m \geq 0$ such that
$u \varphi(a_k)^m \in J$.
\end{lemma}

\begin{proof}
Assume that $S$ is generated by $t_1, \ldots, t_n$
as an $R[x]$-module. In this case
$J = \{ g \in S \mid gt_i \in \text{Im}(\varphi)\text{ for all }i\}$.
Note that each element $u t_i$ is integral over
$R[x]$, see Lemma \ref{lemma-finite-is-integral}.
We have $\varphi(a_0 + a_1x + \ldots + a_k x^k) u t_i \in
\text{Im}(\varphi)$. By Lemma \ref{lemma-combine-lemmas}, for
each $i$ there exists an integer $n_i$ and an element
$q_i \in R[x]$ such that $\varphi(a_k^{n_i}) u t_i - \varphi(q_i)$
is integral over $R$. By assumption this element is in $\varphi(R)$
and hence $\varphi(a_k^{n_i}) u t_i \in \text{Im}(\varphi)$.
It follows that $m = \max\{n_1, \ldots, n_n\}$ works.
\end{proof}

\begin{lemma}
\label{lemma-all-coefficients-in-J}
In Situation \ref{situation-one-transcendental-element}.
Suppose $u \in S$, $a_0, \ldots, a_k \in R$,
$u \varphi(a_0 + a_1x + \ldots + a_k x^k) \in \sqrt{J}$.
Then $u \varphi(a_i) \in \sqrt{J}$ for all $i$.
\end{lemma}

\begin{proof}
Under the assumptions of the lemma we have
$u^n \varphi(a_0 + a_1x + \ldots + a_k x^k)^n \in J$ for
some $n \geq 1$. By Lemma \ref{lemma-leading-coefficient-in-J}
we deduce $u^n \varphi(a_k^{nm}) \in J$ for some $m \geq 1$.
Thus $u \varphi(a_k) \in \sqrt{J}$, and so
$u \varphi(a_0 + a_1x + \ldots + a_k x^k) - u \varphi(a_k) =
u \varphi(a_0 + a_1x + \ldots + a_{k-1} x^{k-1}) \in \sqrt{J}$.
We win by induction on $k$.
\end{proof}

\noindent
This lemma suggests the following definition.

\begin{definition}
\label{definition-strongly-transcendental}
Given an inclusion of rings $R \subset S$ and
an element $x \in S$ we say that $x$ is
{\it strongly transcendental over $R$} if
whenever $u(a_0 + a_1 x + \ldots + a_k x^k) = 0$
with $u \in S$ and $a_i \in R$, then
we have $ua_i = 0$ for all $i$.
\end{definition}

\noindent
Note that if $S$ is a domain then this is the same as
saying that $x$ as an element of the fraction field of
$S$ is transcendental over the fraction field of $R$.

\begin{lemma}
\label{lemma-reduced-strongly-transcendental-minimal-prime}
Suppose $R \subset S$ is an inclusion of reduced rings
and suppose that $x \in S$ is strongly transcendental over $R$.
Let $\mathfrak q \subset S$ be a minimal prime
and let $\mathfrak p = R \cap \mathfrak q$.
Then the image of $x$ in $S/\mathfrak q$ is strongly
transcendental over the subring $R/\mathfrak p$.
\end{lemma}

\begin{proof}
Suppose $u(a_0 + a_1x + \ldots + a_k x^k) \in \mathfrak q$.
By Lemma \ref{lemma-minimal-prime-reduced-ring}
the local ring $S_{\mathfrak q}$ is a field,
and hence $u(a_0 + a_1x + \ldots + a_k x^k) $ is zero
in $S_{\mathfrak q}$. Thus $uu'(a_0 + a_1x + \ldots + a_k x^k) = 0$
for some $u' \in S$, $u' \not\in \mathfrak q$.
Since $x$ is strongly transcendental over $R$ we get
$uu'a_i = 0$ for all $i$. This in turn implies
that $ua_i \in \mathfrak q$.
\end{proof}

\begin{lemma}
\label{lemma-domains-transcendental-not-quasi-finite}
Suppose $R\subset S$ is an inclusion of domains and
let $x \in S$. Assume $x$ is (strongly) transcendental over $R$
and that $S$ is finite over $R[x]$. Then $R \to S$ is not
quasi-finite at any prime of $S$.
\end{lemma}

\begin{proof}
As a first case, assume that $R$ is normal, see
Definition \ref{definition-ring-normal}.
By Lemma \ref{lemma-polynomial-ring-normal}
we see that $R[x]$ is normal.
Take a prime $\mathfrak q \subset S$,
and set $\mathfrak p = R \cap \mathfrak q$.
Assume that the extension $\kappa(\mathfrak p)
\subset \kappa(\mathfrak q)$ is finite.
This would be the case if $R \to S$ is
quasi-finite at $\mathfrak q$.
Let $\mathfrak r = R[x] \cap \mathfrak q$.
Then since $\kappa(\mathfrak p)
\subset \kappa(\mathfrak r) \subset \kappa(\mathfrak q)$
we see that the extension $\kappa(\mathfrak p)
\subset \kappa(\mathfrak r)$ is finite too.
Thus the inclusion $\mathfrak r \supset \mathfrak p R[x]$
is strict. By going down for $R[x] \subset S$,
see Proposition \ref{proposition-going-down-normal-integral},
we find a prime $\mathfrak q' \subset \mathfrak q$,
lying over the prime $\mathfrak pR[x]$. Hence
the fibre $\text{Spec}(S \otimes_R \kappa(\mathfrak p))$
contains a point not equal to $\mathfrak q$,
namely $\mathfrak q'$, whose closure contains $\mathfrak q$ and hence
$\mathfrak q$ is not isolated in its fibre.

\medskip\noindent
If $R$ is not normal, let $R \subset R' \subset K$ be
the integral closure $R'$ of $R$ in its field of fractions
$K$. Let $S \subset S' \subset L$ be the subring $S'$ of
the field of fractions $L$ of $S$ generated by $R'$ and
$S$. Note that by construction the map $S \otimes_R R'
\to S'$ is surjective. This implies that $R'[x] \subset S'$
is finite. Also, the map $S \subset S'$
induces a surjection on $\text{Spec}$, see
Lemma \ref{lemma-integral-overring-surjective}.
We conclude by Lemma \ref{lemma-four-rings} and the normal case
we just discussed.
\end{proof}

\begin{lemma}
\label{lemma-reduced-strongly-transcendental-not-quasi-finite}
Suppose $R \subset S$ is an inclusion of reduced rings.
Assume $x \in S$ be strongly transcendental over $R$,
and $S$ finite over $R[x]$. Then $R \to S$ is not
quasi-finite at any prime of $S$.
\end{lemma}

\begin{proof}
Let $\mathfrak q \subset S$ be any prime.
Choose a minimal prime $\mathfrak q' \subset \mathfrak q$.
According to Lemmas
\ref{lemma-reduced-strongly-transcendental-minimal-prime} and
\ref{lemma-domains-transcendental-not-quasi-finite}
the extension $R/(R \cap \mathfrak q') \subset
S/\mathfrak q'$ is not quasi-finite at the prime corresponding
to $\mathfrak q$. By Lemma \ref{lemma-four-rings}
the extension $R \to S$ is not quasi-finite
at $\mathfrak q$.
\end{proof}

\begin{lemma}
\label{lemma-finite-after-localization}
Let $R$ be a ring, let $f \in R$.
Suppose we have $S$, $S'$ and the solid arrows
forming the following commutative diagram of rings
$$
\xymatrix{
& S'' \ar@{-->}[rd] \ar@{-->}[dd] &
\\
R \ar[rr] \ar@{-->}[ru] \ar[d] &  & S \ar[d]
\\
R_f \ar[r] & S' \ar[r] & S_f
}
$$
Assume that $R_f \to S'$ is finite. Then we can find
a finite ring map $R \to S''$ and dotted arrows as
in the diagram such that $S' = (S'')_f$.
\end{lemma}

\begin{proof}
Namely, suppose that $S'$ is generated by
$x_i$ over $R_f$, $i = 1, \ldots, w$. Let $P_i(t) \in R_f[t]$
be a monic polynomial such that $P_i(x_i) = 0$.
Say $P_i$ has degree $d_i > 0$. Write
$P_i(t) = t^{d_i} + \sum_{j < d_i} (a_{ij}/f^n) t^j$
for some uniform $n$. Also write
the image of $x_i$ in $S_f$ as $g_i / f^n$
for suitable $g_i \in S$. Then we know
that the element
$\xi_i = f^{nd_i} g_i^{d_i} + \sum_{j < d_i} f^{n(d_i - j)} a_{ij} g_i^j$
of $S$ is killed by a power of $f$.
Hence upon increasing $n$ to $n'$, which replaces
$g_i$ by $f^{n' - n}g_i$ we may assume $\xi_i = 0$.
Then $S'$ is generated by the elements
$f^n x_i$, each of which is a zero of the
monic polynomial $Q_i(t) = t^{d_i} +
\sum_{j < d_i} f^{n(d_i - j)} a_{ij} t^j$
with coefficients in $R$. Also, by construction
$Q_i(f^ng_i) = 0$ in $S$. Thus we get a finite $R$-algebra
$S'' = R[z_1, \ldots, z_w]/(Q_1(z_1), \ldots, Q_w(z_w))$
which fits into a commutative diagram as above.
The map $\alpha : S'' \to S$ maps $z_i$ to $f^ng_i$ and
the map $\beta : S'' \to S'$ maps $z_i$ to $f^nx_i$.
It may not yet be the case that $\beta$ induces an
isomorphism $(S'')_f \cong S'$.
For the moment we only know that this map
is surjective. The problem is that there could be
elements $h/f^n \in (S'')_f$ which map to zero
in $S'$ but are not zero. In this case $\beta(h)$
is an element of $S$ such that $f^N \beta(h) = 0$
for some $N$. Thus $f^N h$ is an element ot the ideal
$J = \{h \in S'' \mid \alpha(h) = 0 \text{ and }
\beta(h) = 0\}$ of $S''$. OK, and it is easy to see that
$S''/J$ does the job.
\end{proof}

\noindent
The following two lemmas are a way of describing closed
subschemes of $\mathbf{P}^1_R$ cut out by one (nondegenerate)
equation.

\begin{lemma}
\label{lemma-P1}
Let $R$ be a ring.
Let $F(X, Y) \in R[X, Y]$ be homogenous of degree
$d$. Assume that for every prime $\mathfrak p$ of $R$
at least one coefficient of $F$ is not in $\mathfrak p$.
Let $S = R[X, Y]/(F)$ as a graded ring.
Then for all $n \geq d$ the $R$-module $S_n$
is finite locally free of rank $d$.
\end{lemma}

\begin{proof}
The $R$-module $S_n$ has a presentation
$$
R[X, Y]_{n-d} \to R[X, Y]_n \to S_n \to 0.
$$
Thus by Lemma \ref{lemma-cokernel-flat}
it is enough to show that multiplication
by $F$ induces an injective map
$\kappa(\mathfrak p)[X, Y]
\to \kappa(\mathfrak p)[X, Y]$
for all primes $\mathfrak p$.
This is clear from the assumption that
$F$ does not map to the zero polynomial mod $\mathfrak p$.
The assertion on ranks is clear from this as well.
\end{proof}

\begin{lemma}
\label{lemma-rel-prime-pols}
Let $k$ be a field. Let $F, G \in k[X, Y]$ be homogeneous
of degrees $d, e$. Assume $F, G$ relatively prime.
Then multiplication by $G$ is injective on $S = k[X, Y]/(F)$.
\end{lemma}

\begin{proof}
This is one way to define ``relatively prime''. If you have another
definition, then you can show it is equivalent to this one.
\end{proof}

\begin{lemma}
\label{lemma-P1-localize}
Let $R$ be a ring. Let $F(X, Y) \in R[X, Y]$ be homogenous of degree
$d$. Let $S = R[X, Y]/(F)$ as a graded ring.
Let $\mathfrak p \subset R$ be a prime such that
some coefficient of $F$ is not in $\mathfrak p$.
There exists an $f \in R$ $f \not\in \mathfrak p$,
an integer $e$, and a $G \in R[X, Y]_e$
such that multiplication by $G$ induces isomorphisms
$(S_n)_f \to (S_{n + e})_f$ for all $n \geq d$.
\end{lemma}

\begin{proof}
During the course of the proof we may replace $R$ by $R_f$
for $f\in R$, $f\not\in \mathfrak p$ (finitely often).
As a first step we do such a replacement such that
some coefficient of $F$ is invertible in $R$.
In particular the modules $S_n$ are now locally
free of rank $d$ for $n \geq d$ by Lemma \ref{lemma-P1}.
Pick any $G \in R[X, Y]_e$ such that the image of
$G$ in $\kappa(\mathfrak p)[X, Y]$ is relatively
prime to the image of $F(X, Y)$ (this is possible for some $e$).
Apply Lemma \ref{lemma-cokernel-flat} to the map
induced by multiplication by $G$ from $S_{d} \to S_{d + e}$.
By our choice of $G$ and Lemma \ref{lemma-rel-prime-pols}
we see
$S_{d}\otimes \kappa(\mathfrak p) \to S_{d + e} \otimes \kappa(\mathfrak p)$
is bijective. Thus, after replacing $R$ by $R_f$ for a suitable
$f$ we may assume that $G : S_{d} \to S_{d + e}$
is bijective. This in turn implies that the image
of $G$ in $\kappa(\mathfrak p')[X, Y]$ is relatively
prime to the image of $F$ for all primes $\mathfrak p'$
of $R$. And then by Lemma \ref{lemma-cokernel-flat}
again we see that all the maps
$G : S_{d} \to S_{d + e}$, $n \geq d$ are isomorphisms.
\end{proof}

\begin{remark}
\label{remark-algebra}
Let $R$ be a ring. Suppose that we have $F \in R[X, Y]_d$
and $G \in R[X, Y]_e$ such that, setting $S = R[X, Y]/(F)$
we have (1) $S_n$ is finite locally free of rank $d$ for
all $n \geq d$, and (2) multiplication by $G$ defines
ismorphisms $S_n \to S_{n + e}$ for all $n \geq d$. In this
case we may define a finite, locally free $R$-algebra
$A$ as follows:
\begin{enumerate}
\item as an $R$-module $A = S_{ed}$, and
\item multiplication $A \times A \to A$ is given by
the rule that $H_1 H_2 = H_3$ if and only if $G^d H_3 = H_1 H_2$
in $S_{2ed}$.
\end{enumerate}
This makes sense because multiplication by $G^d$
induces a bijective map $S_{de} \to S_{2de}$.
It is easy to see that this defines a ring structure.
Note the confusing fact that the element $G^d$
defines the unit element of the ring $A$.
\end{remark}

\begin{lemma}
\label{lemma-quasi-finite-monogenic}
Let $R$ be a ring. Let $S = R[x]/I$.
Let $\mathfrak q \subset S$ be a prime.
Assume $R \to S$ is quasi-finite at $\mathfrak q$.
There exists a finite $R$-algebra $S'$ and an
$R$-algebra map $S' \to S$ and an element
$g \in S'$, which does not map to an
element of $\mathfrak q$ such that
$S'_g \cong S_g$.
\end{lemma}

\begin{proof}
Let $\mathfrak p$ be the image of $\mathfrak q$ in $\text{Spec}(R)$.
Suppose that $f \in R$, $f \not \in \mathfrak p$.
Lemma \ref{lemma-finite-after-localization} implies that if
we can prove the lemma for the map
$R_f \to S_f$ and the prime $\mathfrak qS_f$, then
the lemma follows for $R \to S$ and $\mathfrak q$.
Thus, during the course of the proof, we may (finitely often)
replace $R$ by $R_f$ and $S$ by $S_f$ for any
$f \not \in \mathfrak p$.

\medskip\noindent
By assumption there exists a polynomial $f(x) \in I \subset R[x]$
whose image in $\kappa(\mathfrak p)[x]$ is not zero. We may
replace $I$ by the ideal $(f)$. Namely, if we have a solution
$(\varphi : S' \to R[x]/(f), g \in S')$ for the case $R \to R[x]/(f)$
then we obtain a solution
$(S'/\varphi^{-1}(I/(f)) \to R[x]/I, g \bmod \varphi^{-1}(I/(f)))$
for the general case.

\medskip\noindent
Let $F(X, Y) \in R[X, Y]$ be homogeneous of some degree $d$ such that
$F(x, 1) = f(x)$. This gives an $R$-algebra map $R[X, Y]/(F) \to R[x]/(f(x))$,
defined by the rule $E(X, Y) \mapsto E(x, 1)$.
We choose a $G \in R[X, Y]_e$ as in Lemma \ref{lemma-P1-localize}
such that, after replacing $R$ by $R_h$ for some $h \in R$,
$h \not \in \mathfrak p$, multiplication by $G$ induces isomorphisms
$(R[X, Y]/(F))_n \to (R[X, Y]/(F))_{n + e}$ for
all $n \geq d$. We are allowed to make the replacement
$R \mapsto R_h$ by the initial remarks of the proof.
Thus $F$ and $G$ satisfy the assumptions (1) and (2) of Remark
\ref{remark-algebra}. Let $A = (R[X, Y]/(F))_{ed}$
with the $R$-algebra structure constructed
constructed in Remark \ref{remark-algebra}. So $A$ is finite over $R$.
Choose a $H \in R[X, Y]_{ed}$ such that $G^d H = Y^{2de} \bmod (F)$.
Note that this implies that $G(x, 1)^dH(x, 1) = 1 \bmod (f(x))$.
In other words the class of $G(x, 1)$ is a unit of $R[x]/(f)$.
We can then define
$$
A \longrightarrow R[x]/(f), \quad
E \bmod (F) \longmapsto E(x, 1)/G(x, 1)^d \bmod f.
$$
It is straightforward to verify this is well defined, and an
$R$-algebra map. We claim setting $A = S'$ with the given map
is a solution to the lemma.

\medskip\noindent
If $i + j = de$ we will use the notation ``$X^iY^j \in A$'' to mean
the image of $X^iY^j$ in the quotient $A = (R[X, Y]/(F))_{de}$.
Consider the element $g = Y^{de} \in A$.
It maps to the invertible element $1/G(x, 1)^d$ of
$R[x]/(f)$. Thus we obtain a map $A_g \to R[x]/(f(x))$.
We will show this is an isomorphism, thereby concluding the proof.
Consider the element $t \in A_g$ which is the fraction
with numerator $XY^{de - 1} \in A$ and denominator $g$.
A simple calculation shows that $t^i$ is the same
as the quotient $X^i Y^{de-i}/g$ in $A_g$ for
$i = 1, \ldots, de$. For $i = 0$ we have $Y^{de}/g = g/g = t^0$
in $A_g$ also.
The unit element $1_A$ corresponds to $G^d \in A = (R[X, Y]/(F))_{de}$.
Writing $G^d = \sum_{i + j = de} r_{ij}X^iY^j$,
we see that $1/g = 1_A/g = \sum r_{ij}t^i$ in $A_g$.
A general element of $A_g$ is a sum of elements which are
quotients of $X^iY^j \in A$, $i + j = de$ by positive
powers of $g$. By the calculations above
we see that $A_g$ is generated by $t$ over $R$.
Note that the map $A_g \to R[x]/(f)$ maps $t$ to the
class of $x$. Note also that $F(t, 1) = 0$ in $A_g$ by construction
of $A$. Hence $A_g \to R[x]/(f)$ is surjective and injective
and we are done.
\end{proof}

\begin{theorem}
\label{theorem-main-theorem}
(Zariski's Main Theorem.)
Let $R$ be a ring. Let $R \to S$ be a finite type $R$-algebra.
Let $S' \subset S$ be the integral closure of $R$ in $S$.
Let $\mathfrak q \subset S$ be a prime of $S$.
If $R \to S$ is quasi-finite at $\mathfrak q$ then
there exists a $g \in S'$, $g \not \in \mathfrak q$
such that $S'_g \cong S_g$.
\end{theorem}

\begin{proof}
There exist finitely many elements
$x_1, \ldots, x_n \in S$ such that $S$ is finite
over the $R$-sub algebra generated by $x_1, \ldots, x_n$. (For
example generators of $S$ over $R$.) We prove the proposition
by induction on the minimal such number $n$.

\medskip\noindent
The case $n = 0$ is trivial, because in this case $S' = S$,
see Lemma \ref{lemma-finite-is-integral}.

\medskip\noindent
The case $n = 1$. We may and do replace $R$ by its integral
closure in $S$, in particular this means that $R \subset S$.
Consider the map $\varphi : R[x] \to S$, $x \mapsto x_1$.
(We will see that $\varphi$ is not injective below.)
By assumption $\varphi$ is finite. Hence we are in Situation
\ref{situation-one-transcendental-element}.
Let $J \subset S$ be the ``conductor ideal'' defined
in Situation \ref{situation-one-transcendental-element}.
Consider the diagram
$$
\xymatrix{
R[x] \ar[r] & S \ar[r] & S/\sqrt{J} & R/(R \cap \sqrt{J})[x] \ar[l]
\\
& R \ar[lu] \ar[r] \ar[u] & R/(R \cap \sqrt{J}) \ar[u] \ar[ru] &
}
$$
According to Lemma \ref{lemma-all-coefficients-in-J}
the image of $x$ in the quotient $S/\sqrt{J}$
is strongly transcendental over $R/ (R \cap \sqrt{J})$.
Hence by Lemma \ref{lemma-reduced-strongly-transcendental-not-quasi-finite}
the ring map $R/ (R \cap \sqrt{J}) \to S/\sqrt{J}$
is not quasi-finite at any prime of $S/\sqrt{J}$.
By Lemma \ref{lemma-four-rings} we deduce that $\mathfrak q$
does not lie in $V(J) \subset \text{Spec}(S)$.
Thus there exists an element $s \in J$,
$s \not\in \mathfrak q$. By definition of $J$ we may write
$s = \varphi(f)$ for some polynomial $f \in R[x]$.
Now let $I = \text{Ker}(R[x] \to S)$. Since $\varphi(f) \in J$
we get $(R[x]/I)_f \cong S_{\varphi(f)}$, and $s \not \in \mathfrak q$
means that $\mathfrak q$ corresponds to a prime of $(R[x]/I)_f$
at which $R \to R[x]/I$ is quasi-finite. This reduces us
to the case $S = R[x]/I$. In this case
Lemma \ref{lemma-quasi-finite-monogenic} implies the result.

\medskip\noindent
The case $n > 1$. Consider the subring $R' \subset S$
which is the integral closure of $R[x_1, \ldots, x_{n-1}]$
in $S$. By Lemma \ref{lemma-four-rings} the extension
$S/R'$ is quasi-finite at $\mathfrak q$. Also, note
that $S$ is finite over $R'[x_n]$.
By the case $n = 1$ above, there exists a $g' \in R'$,
$g' \not \in \mathfrak q$ such that
$(R')_{g'} \cong S_{g'}$. At this point we cannot
apply induction to $R \to R'$ since $R'$ may not be finite type over $R$.
Since $S$ is finitely generated over $R$ we deduce in particular
that $(R')_{g'}$ is finitely generated over $R$. Say
the elements $g'$, and $y_1/(g')^{n_1}, \ldots, y_N/(g')^{n_N}$
with $y_i \in R'$
generate $(R')_{g'}$ over $R$. Let $R''$ be the $R$-sub algebra
of $R'$ generated by $x_1, \ldots, x_{n-1}, y_1, \ldots, y_N, g'$.
This has the property $(R'')_{g'} \cong S_{g'}$. Surjectivity
because of how we chose $y_i$, injectivity because
$R'' \subset R'$, and localization is exact. Note that
$R''$ is finite over $R[x_1, \ldots, x_{n-1}]$ because
of our choice of $R'$, see Lemma \ref{lemma-characterize-integral}.
Let $\mathfrak q'' = R'' \cap \mathfrak q$. Since
$(R'')_{\mathfrak q''} = S_{\mathfrak q}$ we see that
$R \to R''$ is quasi-finite at $\mathfrak q''$, see
Lemma \ref{lemma-isolated-point-fibre}.
We apply our induction hypothesis to $R \to R''$, $\mathfrak q''$
and $x_1, \ldots, x_{n-1} \in R''$ and we find a subring
$R''' \subset R''$ which is integral over $R$ and an
element $g'' \in R'''$, $g'' \not \in \mathfrak q''$
such that $(R''')_{g''} \cong (R'')_{g''}$. Write the image of $g'$ in
$(R'')_{g''}$ as $g'''/(g'')^n$ for some $g''' \in  R'''$.
Set $g = g''g''' \in R'''$. Then it is clear that $g \not\in
\mathfrak q$ and $(R''')_g \cong S_g$. Since by construction
we have $R''' \subset S'$ we also have $S'_g \cong S_g$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-quasi-finite-open}
Let $R \to S$ be a finite type ring map.
The set of points $\mathfrak q$ of $\text{Spec}(S)$ at which
$S/R$ is quasi-finite is open in $\text{Spec}(S)$.
\end{lemma}

\begin{proof}
Let $\mathfrak q \subset S$ be a point at which the ring map
is quasi-finite. By Theorem \ref{theorem-main-theorem}
there exists an integral ring extension $R \to S'$, $S' \subset S$
and an element $g \in S'$, $g\not \in \mathfrak q$ such that
$S'_g \cong S_g$. Since $S$ and hence $S_g$ are of finite type
over $R$ we may find finitely many elements
$y_1, \ldots, y_N$ of $S'$ such that $S''_g \cong S$
where $S'' \subset S'$ is the sub $R$-algebra generated
by $g, y_1, \ldots, y_N$. Since $S''$ is finite over $R$
(see Lemma \ref{lemma-characterize-integral}) we see that
$S''$ is quasi-finite over $R$ (see Lemma \ref{lemma-quasi-finite}).
It is easy to see that this implies that $S''_g$ is quasi-finite over $R$,
for example because the property of being quasi-finite at a prime depends
only on the local ring at the prime. Thus we see that $S_g$ is quasi-finite
over $R$. By the same token this implies that $R \to S$ is quasi-finite
at every prime of $S$ which lies in $D(g)$.
\end{proof}

\begin{lemma}
\label{lemma-quasi-finite-open-integral-closure}
Let $R \to S$ be a finite type ring map.
Suppose that $S$ is quasi-finite over $R$.
Let $S' \subset S$ be the integral closure of $R$ in $S$. Then
\begin{enumerate}
\item $\text{Spec}(S) \to \text{Spec}(S')$ is a homeomorphism
onto an open subset,
\item if $g \in S'$ and $D(g)$ is contained in the image
of the map, then $S'_g \cong S_g$, and
\item there exists a finite $R$-algebra $S'' \subset S'$
such that (1) and (2) hold for the ring map
$S'' \to S$.
\end{enumerate}
\end{lemma}

\begin{proof}
Because $S/R$ is quasi-finite we may apply
Theorem \ref{theorem-main-theorem} to
each point $\mathfrak q$ of $\text{Spec}(S)$.
Since $\text{Spec}(S)$ is quasi-compact, see
Lemma \ref{lemma-quasicompact}, we may choose
a finite number of $g_i \in S'$, $i = 1, \ldots, n$
such that $S'_{g_i} = S_{g_i}$, and such that
$g_1, \ldots, g_n$ generate the unit ideal in $S$
(in other words the standard opens of $\text{Spec}(S)$ associated
to $g_1, \ldots, g_n$ cover all of $\text{Spec}(S)$).

\medskip\noindent
Suppose that $D(g) \subset \text{Spec}(S')$
is contained in the image. Then $D(g) \subset \bigcup D(g_i)$.
In other words, $g_1, \ldots, g_n$ generate the unit ideal of
$S'_g$. Note that $S'_{gg_i} \cong S_{gg_i}$ by our choice
of $g_i$. Hence $S'_g \cong S_g$ by Lemma \ref{lemma-cover}.

\medskip\noindent
We construct a finite algebra $S'' \subset S'$ as
in (3). To do this note that each $S'_{g_i} \cong S_{g_i}$
is a finite type $R$-algebra. For each $i$ pick
some elements $y_{ij} \in S'$ such that each
$S'_{g_i}$ is generated as $R$-algebra by $1/g_i$
and the elements $y_{ij}$. Then set $S''$
equal to the sub $R$-algebra of $S'$ generated by all $g_i$
and all the $y_{ij}$. Details omitted.
\end{proof}




\section{Applications of Zariski's Main Theorem}
\label{section-apply-main-theorem}

\noindent
Here is an immediate application characterizing the finite
maps of $1$-dimensional semi-local rings among the quasi-finite
onese as those where equality always holds in the
formula of Lemma \ref{lemma-finite-extension-dim-1}.

\begin{lemma}
\label{lemma-quasi-finite-extension-dim-1}
Let $A \subset B$ be an extension of domains. Assume
\begin{enumerate}
\item $A$ is a local Noetherian ring of dimension $1$,
\item $A \to B$ is of finite type, and
\item the extension $K = f.f.(A) \subset L = f.f.(B)$
is a finite field extension.
\end{enumerate}
Then $B$ is semi-local.
Let $x \in \mathfrak m_A$, $x \not = 0$.
Let $\mathfrak m_i$, $i = 1, \ldots, n$
be the maximal ideals of $B$.
Then
$$
[L : K]\text{ord}_A(x)
\geq
\sum\nolimits_i
[\kappa(\mathfrak m_i) : \kappa(\mathfrak m_A)]
\text{ord}_{B_{\mathfrak m_i}}(x)
$$
where $\text{ord}$ is defined as in Definition \ref{definition-ord}.
We have equality if and only if $A \to B$ is finite.
\end{lemma}

\begin{proof}
The ring $B$ is semi-local by Lemma \ref{lemma-finite-in-codim-1}.
Let $B'$ be the integral closure of $A$ in $B$. By
Lemma \ref{lemma-quasi-finite-open-integral-closure}
we can find a finite $A$-subalgebra $C \subset B'$ such that
on setting $\mathfrak n_i = C \cap \mathfrak m_i$ we have
$C_{\mathfrak n_i} \cong B_{\mathfrak m_i}$ and the primes
$\mathfrak n_1, \ldots, \mathfrak n_n$ are pairwise distinct.
The ring $C$ is semi-local by Lemma \ref{lemma-finite-in-codim-1}.
Let $\mathfrak p_j$, $j = 1, \ldots, m$ be the other maximal
ideals of $C$ (the ``missing points''). By
Lemma \ref{lemma-finite-extension-dim-1} we have
$$
\text{ord}_A(x^{[L : K]}) =
\sum\nolimits_i
[\kappa(\mathfrak n_i) : \kappa(\mathfrak m_A)]
\text{ord}_{C_{\mathfrak n_i}}(x)
+
\sum\nolimits_j
[\kappa(\mathfrak p_j) : \kappa(\mathfrak m_A)]
\text{ord}_{C_{\mathfrak p_j}}(x)
$$
hence the inequality follows. In case of equality we conclude that
$m = 0$ (no ``missing points''). Hence $C \subset B$ is an inclusion
of semi-local rings inducing a bijection on maximal ideals and
an isomorphism on all localizations at maximal ideals. So if $b \in B$,
then $I = \{x \in C \mid xb \in C\}$ is an ideal of $C$ which is not
contained in any of the maximal ideals of $C$, and hence $I = C$,
hence $b \in C$. Thus $B = C$ and $B$ is finite over $A$.
\end{proof}

\noindent
Here is a more standard application of Zariski's main theorem to the
structure of local homomorphisms of local rings.

\begin{lemma}
\label{lemma-essentially-finite-type-fibre-dim-zero}
Let $(R, \mathfrak m_R) \to (S, \mathfrak m_S)$ be a local homomorphism
of local rings. Assume
\begin{enumerate}
\item $R \to S$ is essentially of finite type,
\item $\kappa(\mathfrak m_R) \subset \kappa(\mathfrak m_S)$ is finite, and
\item $\dim(S/\mathfrak m_RS) = 0$.
\end{enumerate}
Then $S$ is the localization of a finite $R$-algebra.
\end{lemma}

\begin{proof}
Let $S'$ be a finite type $R$-algebra such that $S = S'_{\mathfrak q'}$
for some prime $\mathfrak q'$ of $S'$. By
Definition \ref{definition-quasi-finite}
we see that $R \to S'$ is quasi-finite at $\mathfrak q'$.
After replacing $S'$ by $S'_{g'}$ for some
$g' \in S'$, $g' \not \in \mathfrak q'$ we may assume that $R \to S'$ is
quasi-finite, see
Lemma \ref{lemma-quasi-finite-open}.
Then by
Lemma \ref{lemma-quasi-finite-open-integral-closure}
there exists a finite $R$-algebra $S''$ and elements
$g' \in S'$, $g' \not \in \mathfrak q'$ and $g'' \in S''$
such that $S'_{g'} \cong S''_{g''}$ as $R$-algebras.
This proves the lemma.
\end{proof}





































\section{Dimension of fibres}
\label{section-dimension-fibres}

\noindent
We study the behaviour of dimensions of fibres, using
Zariski's main theorem. Recall that we defined the
dimension $\dim_x(X)$ of a topological space $X$ at a point $x$
in Topology, Definition \ref{topology-definition-Krull}.

\begin{definition}
\label{definition-relative-dimension}
Suppose that $R \to S$ is of finite type, and let
$\mathfrak q \subset S$ be a prime lying over a prime
$\mathfrak p$ of $R$.
We define the {\it relative dimension
of $S/R$ at $\mathfrak q$}, denoted
$\dim_{\mathfrak q}(S/R)$, to be the dimension
of $\text{Spec}(S \otimes_R \kappa(\mathfrak p))$
at the point corresponding to $\mathfrak q$. We let
$\dim(S/R)$ be the supremum of $\dim_{\mathfrak q}(S/R)$
over all $\mathfrak q$. This is called the
{\it relative dimension of} $S/R$.
\end{definition}

\noindent
In particular, $R \to S$ is quasi-finite at $\mathfrak q$ if
and only if $\dim_{\mathfrak q}(S/R) = 0$. The following lemma
is more or less a reformulation of Zariski's Main Theorem.

\begin{lemma}
\label{lemma-quasi-finite-over-polynomial-algebra}
Let $R \to S$ be a finite type ring map.
Let $\mathfrak q \subset S$ be a prime.
Suppose that $\dim_{\mathfrak q}(S/R) = n$.
There exists a $g \in S$, $g \not\in \mathfrak q$
such that $S_g$ is quasi-finite over a
polynomial algebra $R[t_1, \ldots, t_n]$.
\end{lemma}

\begin{proof}
The ring $\overline{S} = S \otimes_R \kappa(\mathfrak p)$ is
of finite type over $\kappa(\mathfrak p)$.
Let $\overline{\mathfrak q}$ be the prime of $\overline{S}$
corresponding to $\mathfrak q$.
By definition of
the dimension of a topological space at a point there exists
an open $U \subset \text{Spec}(\overline{S})$ with
$\overline{q} \in U$ and $\dim(U) = n$.
Since the topology on $\text{Spec}(\overline{S})$ is
induced from the topology on $\text{Spec}(S)$ (see
Remark \ref{remark-fundamental-diagram}), we can find
a $g \in S$, $g \not \in \mathfrak q$ with image
$\overline{g} \in \overline{S}$ such that
$D(\overline{g}) \subset U$.
Thus after replacing $S$ by $S_g$ we see that
$\dim(\overline{S}) = n$.

\medskip\noindent
Next, choose generators $x_1, \ldots, x_N$ for $S$ as an $R$-algebra. By
Lemma \ref{lemma-Noether-normalization}
there exist elements $y_1, \ldots, y_n$ in the $\mathbf{Z}$-subalgebra of $S$
generated by $x_1, \ldots, x_N$ such that the map
$R[t_1, \ldots, t_n] \to S$, $t_i \mapsto y_i$ has the property
that $\kappa(\mathfrak p)[t_1\ldots, t_n] \to \overline{S}$
is finite. In particular, $S$ is quasi-finite over $R[t_1, \ldots, t_n]$
at $\mathfrak q$. Hence, by Lemma \ref{lemma-quasi-finite-open}
we may replace $S$ by $S_g$ for some $g\in S$, $g \not \in \mathfrak q$
such that $R[t_1, \ldots, t_n] \to S$ is quasi-finite.
\end{proof}

\begin{lemma}
\label{lemma-refined-quasi-finite-over-polynomial-algebra}
Let $R \to S$ be a ring map. Let $\mathfrak q \subset S$
be a prime lying over the prime $\mathfrak p$ of $R$.
Assume
\begin{enumerate}
\item $R \to S$ is of finite type,
\item $\dim_{\mathfrak q}(S/R) = n$, and
\item $\text{trdeg}_{\kappa(\mathfrak p)}\kappa(\mathfrak q) = r$.
\end{enumerate}
Then there exist $f \in R$, $f \not \in \mathfrak p$,
$g \in S$, $g \not\in \mathfrak q$ and a quasi-finite ring map
$$
\varphi : R_f[x_1, \ldots, x_n] \longrightarrow S_g
$$
such that $\varphi^{-1}(\mathfrak qS_g) =
(\mathfrak p, x_{r + 1}, \ldots, x_n)R_f[x_{r + 1}, \ldots, x_n]$
\end{lemma}

\begin{proof}
After replacing $S$ by a principal localization we may assume there
exists a quasi-finite ring map $\varphi : R[t_1, \ldots, t_n] \to S$, see
Lemma \ref{lemma-quasi-finite-over-polynomial-algebra}.
Set $\mathfrak q' = \varphi^{-1}(\mathfrak q)$.
Let $\overline{\mathfrak q}' \subset \kappa(\mathfrak p)[t_1, \ldots, t_n]$
be the prime corresponding to $\mathfrak q'$. By
Lemma \ref{lemma-refined-Noether-normalization}
there exists a finite ring map
$\kappa(\mathfrak p)[x_1, \ldots, x_n] \to
\kappa(\mathfrak p)[t_1, \ldots, t_n]$
such that the inverse image of $\overline{\mathfrak q}'$ is
$(x_{r + 1}, \ldots, x_n)$. Let
$\overline{h}_i \in \kappa(\mathfrak p)[t_1, \ldots, t_n]$
be the image of $x_i$. We can find an element
$f \in R$, $f \not \in \mathfrak p$
and $h_i \in R_f[t_1, \ldots, t_n]$ which map to $\overline{h}_i$
in $\kappa(\mathfrak p)[t_1, \ldots, t_n]$. Then the ring map
$$
R_f[x_1, \ldots, x_n] \longrightarrow R_f[t_1, \ldots, t_n]
$$
becomes finite after tensoring with $\kappa(\mathfrak p)$.
In particular, $R_f[t_1, \ldots, t_n]$ is quasi-finite over
$R_f[x_1, \ldots, x_n]$ at the prime $\mathfrak q'R_f[t_1, \ldots, t_n]$.
Hence, by
Lemma \ref{lemma-quasi-finite-open}
there exists a $g \in R_f[t_1, \ldots, t_n]$, 
$g \not \in \mathfrak q'R_f[t_1, \ldots, t_n]$
such that $R_f[x_1, \ldots, x_n] \to R_f[t_1, \ldots, t_n, 1/g]$
is quasi-finite. Thus we see that the composition
$$
R_f[x_1, \ldots, x_n] \longrightarrow
R_f[t_1, \ldots, t_n, 1/g] \longrightarrow S_{\varphi(g)}
$$
is quasi-finite and we win.
\end{proof}

\begin{lemma}
\label{lemma-dimension-inequality-quasi-finite}
Let $R \to S$ be a finite type ring map.
Let $\mathfrak q \subset S$ be a prime lying over $\mathfrak p \subset R$.
If $R \to S$ is quasi-finite at $\mathfrak q$, then
$\dim(S_{\mathfrak q}) \leq \dim(R_{\mathfrak p})$.
\end{lemma}

\begin{proof}
If $R_{\mathfrak p}$ is Noetherian
(and hence $S_{\mathfrak q}$ Noetherian since it is essentially of
finite type over $R_{\mathfrak p}$)
then this follows immediately from
Lemma \ref{lemma-dimension-base-fibre-total} and the
definitions. In the general case we can use Zariski's Main Theorem
\ref{theorem-main-theorem} to write
$S_{\mathfrak q} = S'_{\mathfrak q'}$ for some
ring $S'$ integral over $R_{\mathfrak p}$.
Thus the result follows from Lemma \ref{lemma-integral-dim-up}.
\end{proof}

\begin{lemma}
\label{lemma-dimension-quasi-finite-over-polynomial-algebra}
Let $k$ be a field. Let $S$ be a finite type $k$-algebra.
Suppose there is a quasi-finite $k$-algebra map
$k[t_1, \ldots, t_n] \subset S$. Then $\dim(S) \leq n$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-dim-affine-space} the dimension of
any local ring of $k[t_1, \ldots, t_n]$ is at most $n$.
Thus the result follows from
Lemma \ref{lemma-dimension-inequality-quasi-finite} above.
\end{proof}

\begin{lemma}
\label{lemma-dimension-fibres-bounded-open-upstairs}
Let $R \to S$ be a finite type ring map.
Let $\mathfrak q \subset S$ be a prime.
Suppose that $\dim_{\mathfrak q}(S/R) = n$.
There exists an open neighbourhood $V$ of $\mathfrak q$
in $\text{Spec}(S)$ such that
$\dim_{\mathfrak q'}(S/R) \leq n$ for all $\mathfrak q' \in V$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-quasi-finite-over-polynomial-algebra}
we see that we may assume that $S$ is quasi-finite over
a polynomial algebra $R[t_1, \ldots, t_n]$. Considering
the fibres, we reduce to
Lemma \ref{lemma-dimension-quasi-finite-over-polynomial-algebra}.
\end{proof}

\noindent
In other words, the lemma says that the set of points where the
fibre has dimension $\leq n$ is open in $\text{Spec}(S)$.
The next lemma says that formation of this open commutes with
base change.
If the ring map is of finite presentation then this set is
quasi-compact open (see below).

\begin{lemma}
\label{lemma-dimension-fibres-bounded-open-upstairs-base-change}
Let $R \to S$ be a finite type ring map.
Let $R \to R'$ be any ring map.
Set $S' = R' \otimes_R S$ and denote $f : \text{Spec}(S') \to \text{Spec}(S)$
the associated map on spectra.
Let $n \geq 0$.
The inverse image
$f^{-1}(\{\mathfrak q \in \text{Spec}(S) \mid
\dim_{\mathfrak q}(S/R) \leq n\})$
is equal to
$\{\mathfrak q' \in \text{Spec}(S') \mid
\dim_{\mathfrak q'}(S'/R') \leq n\}$.
\end{lemma}

\begin{proof}
The condition is formulated in terms of dimensions
of fibre rings which are of finite type over a field.
Combined with
Lemma \ref{lemma-dimension-at-a-point-preserved-field-extension}
this yields the lemma.
\end{proof}

\begin{lemma}
\label{lemma-dimension-fibres-bounded-quasi-compact-open-upstairs}
Let $R \to S$ be a ring homomorphism of finite presentation.
Let $n \geq 0$. The set
$$
V_n = \{\mathfrak q \in \text{Spec}(S) \mid \dim_{\mathfrak q}(S/R) \leq n\}
$$
is a quasi-compact open subset of $\text{Spec}(S)$.
\end{lemma}

\begin{proof}
It is open by Lemma \ref{lemma-dimension-fibres-bounded-open-upstairs} above.
Let $S = R[x_1, \ldots, x_n]/(f_1, \ldots, f_m)$ be a presentation of
$S$. Let $R_0$ be the $\mathbf{Z}$-subalgebra of $R$ generated by the
coefficients of the polynomials $f_i$.
Let $S_0 = R_0[x_1, \ldots, x_n]/(f_1, \ldots, f_m)$.
Then $S = R \otimes_{R_0} S_0$. By
Lemma \ref{lemma-dimension-fibres-bounded-open-upstairs-base-change}
$V_n$ is the inverse image of an open $V_{0, n}$ under the quasi-compact
continuous map $\text{Spec}(S) \to \text{Spec}(S_0)$. Since
$S_0$ is Noetherian we see that $V_{0, n}$ is quasi-compact.
\end{proof}

\begin{lemma}
\label{lemma-finite-type-domain-over-valuation-ring-dim-fibres}
Let $R$ be a valuation ring with residue field $k$ and field
of fractions $K$. Let $S$ be a domain containing $R$ such that
$S$ is of finite type over $R$. If $S \otimes_R k$ is not the
zero ring then
$$
\dim(S \otimes_R k) = \dim(S \otimes_R K)
$$
In fact, $\text{Spec}(S \otimes_R k)$ is equidimensional.
\end{lemma}

\begin{proof}
It suffices to show that $\dim_{\mathfrak q}(S/k)$ is equal
to $\dim(S \otimes_R K)$ for every prime $\mathfrak q$ of
$S$ containing $\mathfrak m_RS$. Pick such a prime. By
Lemma \ref{lemma-dimension-fibres-bounded-open-upstairs}
the inequality $\dim_{\mathfrak q}(S/k) \geq \dim(S\otimes_R K)$
holds. Set $n = \dim_{\mathfrak q}(S/k)$. By
Lemma \ref{lemma-quasi-finite-over-polynomial-algebra}
after replacing $S$ by $S_g$ for some $g \in S$, $g \not \in \mathfrak q$
there exists a quasi-finite ring map
$R[t_1, \ldots, t_n] \to S$. If $\dim(S \otimes_R K) < n$,
then $K[t_1, \ldots, t_n] \to S \otimes_R K$ has a nonzero kernel.
Say $f = \sum a_I t_1^{i_1}\ldots t_n^{i_n}$. After dividing
$f$ by a nonzero coefficient of $f$ with minimal valuation, we may
assume $f\in R[t_1, \ldots, t_n]$ and some $a_I$ does not map
to zero in $k$. Hence the ring map $k[t_1, \ldots, t_n] \to S\otimes_R k$
has a nonzero kernel which implies that $\dim(S\otimes_R k) < n$.
Contradiction.
\end{proof}
























\section{Colimits and maps of finite presentation}
\label{section-colimits-flat}

\noindent
In this section we prove some preliminary lemmas
dealing with absolute Noetherian reduction.

\begin{definition}
\label{definition-essentially-finite-p-t}
Let $R \to S$ be a ring map.
\begin{enumerate}
\item We say that $R \to S$ is {\it essentially of finite type} if
$S$ is the localization of an $R$-algebra of finite type.
\item We say that $R \to S$ is {\it essentially of finite presentation} if
$S$ is the localization of an $R$-algebra of finite presentation.
\end{enumerate}
\end{definition}

\noindent
In the following we will encounter the following types of
objects repeatedly. Let $(\Lambda, \geq)$ a partially
ordered set. A system of rings over $\Lambda$ is given by
a ring $R_\lambda$ for every $\lambda \in \Lambda$,
and a morphism $R_\lambda \to R_\mu$ whenever $\lambda \leq \mu$.
These morphisms have to satisfy the rule that
$R_\lambda \to R_\mu \to R_\nu$ is equal to the map
$R_\lambda \to R_\nu$ for all $\lambda \leq \mu \leq \nu$.
See Categories, Section \ref{categories-section-posets-limits}.
We will often assume that $(I, \leq)$ is {\it directed},
which means that $\Lambda$ is nonempty and
given $\lambda, \mu \in \Lambda$
there exists a $\nu \in \Lambda$ with $\lambda \leq \nu$ and $\mu \leq \nu$.
Recall that the colimit $\text{colim}_\lambda\ R_\lambda$
is sometimes called a ``direct limit'' in this case
(but we will not use this terminology).

\begin{lemma}
\label{lemma-ring-colimit-fp}
Let $R \to A$ be a ring map.
There exists a directed system $A_\lambda$ of
$R$-algebras of finite presentation such that
$A = \text{colim}_\lambda\ A_\lambda$.
If $A$ is of finite type over $R$ we may
arrange it so that all the transition maps
are surjective.
\end{lemma}

\begin{proof}
Compare with the proof of Lemma \ref{lemma-module-colimit-fp}.
Consider any finite subset $S \subset A$, and any finite
collection of polynomial relations $E$ among the elements of $S$.
So each $s \in S$ corresponds to $x_s \in A$ and
each $e \in E$ consists of a polynomial
$f_{e} \in R[X_s; s\in S]$ such that $f_e(x_s) = 0$.
Let $A_{S, E} = R[X_s; s\in S]/(f_e; e\in E)$
which is a finitely presented $R$-algebra.
There are canonical maps $A_{S, E} \to A$.
If $S \subset S'$ and if the elements of
$E$ correspond, via the map $R[X_s; s \in S] \to R[X_s; s\in S']$,
to a subset of $E'$, then there is an obvious map
$A_{S, E} \to A_{S', E'}$ commuting with the
maps to $A$. Thus, setting $\Lambda$ equal the set of pairs
$(S, E)$ with ordering by inclusion as above, we get a
directed partially ordered set.
It is clear that the colimit of this directed system is $A$.

\medskip\noindent
For the last statement, suppose $A = R[x_1, \ldots, x_n]/I$.
In this case, consider the subset $\Lambda' \subset \Lambda$
consisting of those systems $(S, E)$ above
with $S = \{x_1, \ldots, x_n\}$. It is easy to see that
still $A = \text{colim}_{\lambda' \in \Lambda'} A_{\lambda'}$.
Moreover, the transition maps are clearly surjective.
\end{proof}

\noindent
It turns out that we can characterize ring maps of finite
presentation as follows. This in some sense says that the
algebras of finite presentation are the ``compact'' objects
in the category of $R$-algebras.

\begin{lemma}
\label{lemma-characterize-finite-presentation}
Let $\varphi : R \to S$ be a ring map.
Then $\varphi$ is of finite presentation if and only if
for every directed system $A_\lambda$ of $R$-algebras
we have
$$
\text{colim}_\lambda\ \text{Hom}_R(S, A_\lambda)
=
\text{Hom}_R(S, \text{colim}_\lambda\ A_\lambda)
$$
\end{lemma}

\begin{proof}
Suppose $S = R[x_1, \ldots, x_n] / (f_1, \ldots, f_m)$.
If $\chi : S \to \text{colim} A_\lambda$ is a map, then each
$x_i$ maps to some element in the image of some $A_{\lambda_i}$.
We may pick $\mu \geq \lambda_i$, $i = 1, \ldots, n$ and
assume $\chi(x_i)$ is the image of $y_i \in A_\mu$ for
$i = 1, \ldots, n$. Consider $z_j = f_j(y_1, \ldots, y_n) \in A_\mu$.
Since $\chi$ is a homomorphism the image of $z_j$ in
$\text{colim}_\lambda A_\lambda$ is zero. Hence there exists a
$\mu_j \geq \mu$ such that $z_j$ maps to zero in $A_{\mu_j}$.
Pick $\nu \geq \mu_j$, $j = 1, \ldots, m$. Then the
images of $z_1, \ldots, z_m$ are zero in $A_\nu$. This
exactly means that the $y_i$ map to elements
$y'_i \in A_\nu$ which satsify the relations $f_j(y'_1, \ldots, y'_n) = 0$.
Thus we obtain a ring map $S \to A_\nu$ as desired.

\medskip\noindent
Conversely, suppose the displayed formula holds always.
By Lemma \ref{lemma-ring-colimit-fp} we may write
$S = \text{colim}_\lambda S_\lambda$ with $S_\lambda$
of finite presentation over $R$. Then the identity map
factors as
$$
S \to S_\lambda \to S
$$
for some $\lambda$. Hence we see that $S$ is finitely generated
over $R$ (because $S_\lambda$ is). Thus we may choose the system
such that all transition maps are surjective. In this case
a factorization of the identity as above can only exist if
$S = S_\lambda$.
\end{proof}

\begin{lemma}
\label{lemma-finite-type-descends}
Let $R \to S$ be a ring map.
Let $R \to R'$ be a faithfully flat ring map.
Set $S' = R'\otimes_R S$.
Then $R \to S$ is of finite type if and only if $R' \to S'$
is of finite type.
\end{lemma}

\begin{proof}
It is clear that if $R \to S$ is of finite type then $R' \to S'$
is of finite type. Assume that $R' \to S'$ is of finite type.
Say $y_1, \ldots, y_m$ generate $S'$ over $R'$.
Write $y_j = \sum_i a_{ij} \otimes x_{ji}$ for some
$a_{ij} \in R'$ and $x_{ji} \in S$. Let $A \subset S$
be the $R$-subalgebra generated by the $x_{ij}$.
By flatness we have $A' := R' \otimes_R A \subset S'$, and
by construction $y_j \in A'$. Hence $A' = S'$.
By faithful flatness $A = S$.
\end{proof}

\begin{lemma}
\label{lemma-finite-presentation-descends}
Let $R \to S$ be a ring map.
Let $R \to R'$ be a faithfully flat ring map.
Set $S' = R'\otimes_R S$.
Then $R \to S$ is of finite presentation if and only if $R' \to S'$
is of finite presentation.
\end{lemma}

\begin{proof}
It is clear that if $R \to S$ is of finite presentation then $R' \to S'$
is of finite presentation. Assume that $R' \to S'$ is of finite presentation.
By Lemma \ref{lemma-finite-type-descends} above we see
that $R \to S$ is of finite type. Write $S = R[x_1, \ldots, x_n]/I$.
By flatness $S' = R'[x_1, \ldots, x_n]/R'\otimes I$.
Say $g_1, \ldots, g_m$ generate $R'\otimes I$ over $R'[x_1, \ldots, x_n]$.
Write $g_j = \sum_i a_{ij} \otimes f_{ji}$ for some
$a_{ij} \in R'$ and $f_{ji} \in I$. Let $J \subset I$
be the ideal generated by the $f_{ij}$.
By flatness we have $R' \otimes_R J \subset R'\otimes_R I$, and
both are ideals over $R'[x_1, \ldots, x_n]$.
By construction $g_j \in R' \otimes_R J$. Hence
$R' \otimes_R J = R'\otimes_R I$.
By faithful flatness $J = I$.
\end{proof}


\begin{lemma}
\label{lemma-local-isomorphism}
Let $R$ be a ring. Let $\varphi : S' \to S$ be a homomorphism of
$R$-algebras. Assume
\begin{enumerate}
\item $S'$ is of finite type over $R$,
\item $S$ is of finite presentation over $R$, and
\item $\mathfrak q' \subset S'$ and $\mathfrak q \subset S$
are primes such that $\varphi$ induces an
isomorphism $S'_{\mathfrak q'} \cong S_{\mathfrak q}$.
\end{enumerate}
Then there exist $g \in S'$, $g \not \in \mathfrak q'$ and
such that $\varphi$ induces an isomorphism
$S'_{g} \cong S_{\varphi(g)}$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-compose-finite-type}
the map $S' \to S$ is of finite presentation.
Write $S = S'[y_1, \ldots, y_a]/(g_1, \ldots, g_b)$.
We may, after replacing $S'$ by $S'_{g}$ and $S$ by $S_{\varphi(g)}$
for a suitable $g$, assume that the elements $y_j$ are in the
image of $\varphi$. This implies that $S' \to S$ is surjective.
Say $x_j \in S'$ maps to $y_j$. After further replacing
$S'$ by $S'_{g}$ and $S$ by $S_{\varphi(g)}$
for a suitable $g$ we may assume the expressions
$g_i(x_1, \ldots, x_a)$ are zero in $S'$.
This means that $S' \to S$ is an isomorphism.
\end{proof}

\begin{lemma}
\label{lemma-isomorphic-local-rings}
Let $R$ be a ring.
Let $S$, $S'$ be of finite presentation over $R$.
Let $\mathfrak q \subset S$ and $\mathfrak q' \subset S'$
be primes. If $S_{\mathfrak q} \cong S_{\mathfrak q'}$ as
$R$-algebras, then there exist $g \in S$, $g \not \in \mathfrak q$
and $g' \in S'$, $g' \not \in \mathfrak q'$ such that
$S_g \cong S'_{g'}$ as $R$-algebras.
\end{lemma}

\begin{proof}
Let $\psi : S_{\mathfrak q} \to S_{\mathfrak q'}$ be the isomorphism
of the hypothesis of the lemma.
Write $S = R[x_1, \ldots, x_n]/(f_1, \ldots, f_r)$ and
$S' = R[y_1, \ldots, y_m]/J$.
For each $i = 1, \ldots, n$ choose a fraction
$h_i/g_i$ with $h_i, g_i \in R[y_1, \ldots, y_m]$
and $g_i \bmod J$ not in $\mathfrak q'$ which represents
the image of $x_i$ under $\psi$. After replacing
$S'$ by $S'_{g_1 \ldots g_n}$ and
$R[y_1, \ldots, y_m, y_{m + 1}]$ (mapping $y_{m + 1}$ to $1/(g_1\ldots g_n)$)
we may assume that $\psi(x_i)$ is the image of some
$h_i \in R[y_1, \ldots, y_m]$. Consider the elements
$f_j(h_1, \ldots, h_n) \in R[y_1, \ldots, y_m]$.
Since $\psi$ kills each $f_j$ we see that
there exists a $g \in R[y_1, \ldots, y_m]$, $g \bmod J \not \in \mathfrak q'$
such that $g f_j(h_1, \ldots, h_n) \in J$ for each $j = 1, \ldots, r$.
After replacing $S'$ by $S'_{g}$ and
$R[y_1, \ldots, y_m, y_{m + 1}]$ as before we may assume that
$f_j(h_1, \ldots, h_n) \in J$. Thus we obtain a ring map
$S \to S'$, $x_i \mapsto h_i$ which induces $\psi$ on local rings.
We win by Lemma \ref{lemma-local-isomorphism} above.
\end{proof}

\begin{lemma}
\label{lemma-limit-no-condition-local}
Suppose $R \to S$ is a local ring map of local rings.
There exists a directed set $(\Lambda, \leq)$, and
a system of local ring maps $R_\lambda \to S_\lambda$
of local rings such that
\begin{enumerate}
\item The colimit of the system $R_\lambda \to S_\lambda$
is equal to $R \to S$.
\item Each $R_\lambda$ is essentially of finite type
over $\mathbf{Z}$.
\item Each $S_\lambda$ is essentially of finite type
over $R_\lambda$.
\end{enumerate}
\end{lemma}

\begin{proof}
Denote $\varphi : R  \to S$ the ring map.
Let $\mathfrak m \subset R$ be the maximal ideal
of $R$ and let $\mathfrak n \subset S$ be the maximal
ideal of $S$. Let
$$
\Lambda = \{
(A, B)
\mid
A \subset R, \ 
B \subset S, \ 
\# A < \infty, \ 
\# B < \infty, \ 
\varphi(A) \subset B
\}.
$$
As partial ordering we take the inclusion relation. For each
$\lambda = (A, B) \in \Lambda$ we let $R'_\lambda$ be
the sub $\mathbf{Z}$-algebra generated by
$a \in A$, and we let $S'_\lambda$ be the sub
$\mathbf{Z}$-algebra generated by $b$, $b \in B$.
Let $R_\lambda$ be the localization of $R'_\lambda$
at the prime ideal $R'_\lambda \cap \mathfrak m$ and let
$S_\lambda$ be the localization of $S'_\lambda$ at
the prime ideal $S'_\lambda \cap \mathfrak n$.
In a picture
$$
\xymatrix{
B \ar[r] &
S'_\lambda \ar[r] &
S_\lambda \ar[r] &
S \\
A \ar[r] \ar[u] &
R'_\lambda \ar[r] \ar[u] &
R_\lambda \ar[r] \ar[u] &
R \ar[u]
}.
$$
The transition maps are clear. We leave the proofs of the other
assertions to the reader.
\end{proof}

\begin{lemma}
\label{lemma-limit-essentially-finite-type}
Suppose $R \to S$ is a local ring map of local rings.
Assume that $S$ is essentially of finite type over $R$.
Then there exists a directed set $(\Lambda, \leq)$, and
a system of local ring maps $R_\lambda \to S_\lambda$
of local rings such that
\begin{enumerate}
\item The colimit of the system $R_\lambda \to S_\lambda$
is equal to $R \to S$.
\item Each $R_\lambda$ is essentially of finite type
over $\mathbf{Z}$.
\item Each $S_\lambda$ is essentially of finite type
over $R_\lambda$.
\item For each $\lambda \leq \mu$ the map
$S_\lambda \otimes_{R_\lambda} R_\mu \to S_\mu$
presents $S_\mu$ as the localization of a quotient
of $S_\lambda \otimes_{R_\lambda} R_\mu$.
\end{enumerate}
\end{lemma}

\begin{proof}
Denote $\varphi : R  \to S$ the ring map.
Let $\mathfrak m \subset R$ be the maximal ideal
of $R$ and let $\mathfrak n \subset S$ be the maximal
ideal of $S$. Let $x_1, \ldots, x_n \in S$ be elements such that
$S$ is a localization of the sub $R$-algebra of $S$
generated by $x_1, \ldots, x_n$. In other words, $S$
is a quotient of a localization of the polynomial ring
$R[x_1, \ldots, x_n]$.

\medskip\noindent
Let $\Lambda = \{ A \subset R \mid \# A < \infty\}$
be the set of finite subsets of $R$. As partial
ordering we take the inclusion relation. For each
$\lambda = A \in \Lambda$ we let $R'_\lambda$ be
the sub $\mathbf{Z}$-algebra generated by
$a \in A$, and we let $S'_\lambda$ be the sub
$\mathbf{Z}$-algebra generated by $\varphi(a)$, $a \in A$
and the elements $x_1, \ldots, x_n$. Let $R_\lambda$ be
the localization of $R'_\lambda$ at the prime ideal
$R'_\lambda \cap \mathfrak m$ and let
$S_\lambda$ be the localization of $S'_\lambda$ at
the prime ideal $S'_\lambda \cap \mathfrak n$.
In a picture
$$
\xymatrix{
\varphi(A) \coprod \{x_i\} \ar[r] &
S'_\lambda \ar[r] &
S_\lambda \ar[r] &
S \\
A \ar[r] \ar[u] &
R'_\lambda \ar[r] \ar[u] &
R_\lambda \ar[r] \ar[u] &
R \ar[u]
}
$$
It is clear that if $A \subset B$ corresponds to
$\lambda \leq \mu$ in $\Lambda$, then there are
canonical maps $R_\lambda \to R_\mu$, and $S_\lambda \to S_\mu$
and we obtain a system over the directed set $\Lambda$.

\medskip\noindent
The assertion that $R = \text{colim}\ R_\lambda$ is clear
because all the maps $R_\lambda \to R$ are injective and
any element of $R$ eventually is in the image. The same
argument works for $S = \text{colim}\ S_\lambda$.
Assertions (2), (3) are true by construction.
The final assertion holds because clearly
the maps $S'_\lambda \otimes_{R'_\lambda} R'_\mu
\to S'_\mu$ are surjective.
\end{proof}

\begin{lemma}
\label{lemma-limit-essentially-finite-presentation}
Suppose $R \to S$ is a local ring map of local rings.
Assume that $S$ is essentially of finite presentation over $R$.
Then there exists a directed set $(\Lambda, \leq)$, and
a system of local ring maps $R_\lambda \to S_\lambda$
of local rings such that
\begin{enumerate}
\item The colimit of the system $R_\lambda \to S_\lambda$
is equal to $R \to S$.
\item Each $R_\lambda$ is essentially of finite type
over $\mathbf{Z}$.
\item Each $S_\lambda$ is essentially of finite type
over $R_\lambda$.
\item For each $\lambda \leq \mu$ the map
$S_\lambda \otimes_{R_\lambda} R_\mu \to S_\mu$
presents $S_\mu$ as the localization of
$S_\lambda \otimes_{R_\lambda} R_\mu$
at a prime ideal.
\end{enumerate}
\end{lemma}

\begin{proof}
By assumption we may choose an isomorphism
$\Phi : (R[x_1, \ldots, x_n]/I)_{\mathfrak q} \to S$
where $I \subset R[x_1, \ldots, x_n]$ is a finitely generated ideal,
and $\mathfrak q \subset R[x_1, \ldots, x_n]/I$ is a prime.
(Note that the pull back of $\mathfrak q$ to $R$
is equal to the maximal ideal $\mathfrak m$ of $R$.)
We also choose generators $f_1, \ldots, f_m \in I$ for the ideal $I$.
Write $R$ in any way as a colimit $R = \text{colim}\ R_\lambda$
over a directed set $(\Lambda, \leq )$, with each $R_\lambda$
local and essentially of finite type over $\mathbf{Z}$.
There exists some $\lambda_0 \in \Lambda$ such that $f_j$ is the image
of some $f_{j, \lambda_0} \in R_{\lambda_0}[x_1, \ldots, x_n]$.
For all $\lambda \geq \lambda_0$ denote
$f_{j, \lambda} \in R_{\lambda}[x_1, \ldots, x_n]$ the image
of $f_{j, \lambda_0}$. Thus we obtain a system of ring maps
$$
R_\lambda[x_1, \ldots, x_n]/(f_{1, \lambda}, \ldots, f_{n, \lambda})
\to
R[x_1, \ldots, x_n]/(f_1, \ldots, f_n) \to S
$$
Set $\mathfrak q_\lambda$ the inverse image of $\mathfrak q$.
Set $S_\lambda = (R_\lambda[x_1, \ldots, x_n]/
(f_{1, \lambda}, \ldots, f_{n, \lambda}))_{\mathfrak q_\lambda}$.
We leave it to the reader to see that this works.
\end{proof}

\begin{remark}
\label{remark-suitable-systems-limits}
Suppose that $R \to S$ is a local homomorphism
of local rings, which is essentially of finite presentation.
Take any system $(\Lambda, \leq)$, $R_\lambda \to S_\lambda$
with the properties listed in
Lemma \ref{lemma-limit-essentially-finite-type}.
What may happen is that this is the ``wrong'' system, namely,
it may happen that property (4) of
Lemma \ref{lemma-limit-essentially-finite-presentation} is not
satisfied. Here is an example. Let $k$ be a field. Consider the ring
$$
R = k[[z, y_1, y_2, \ldots]]/(y_i^2 - zy_{i + 1}).
$$
Set $S = R/zR$. As system take $\Lambda = \mathbf{N}$ and
$R_n = k[[z, y_1, \ldots, y_n]]/(\{y_i^2 - zy_{i + 1}\}_{i \leq n-1})$
and $S_n = R_n/(z, y_n^2)$. All the maps
$S_n \otimes_{R_n} R_{n + 1} \to S_{n + 1}$
are not localizations (i.e., isomorphisms in this case)
since $1 \otimes y_{n + 1}^2$ maps to zero.
If we take instead $S_n' = R_n/zR_n$ then the
maps $S'_n \otimes_{R_n} R_{n + 1} \to S'_{n + 1}$ are
isomorphisms. The moral of this remark is that we do have to be
a little careful in choosing the systems.
\end{remark}

\begin{lemma}
\label{lemma-limit-module-essentially-finite-presentation}
Suppose $R \to S$ is a local ring map of local rings.
Assume that $S$ is essentially of finite presentation over $R$.
Let $M$ be a finitely presented $S$-module.
Then there exists a directed set $(\Lambda, \leq)$, and
a system of local ring maps $R_\lambda \to S_\lambda$
of local rings together with $S_\lambda$-modules $M_\lambda$,
such that
\begin{enumerate}
\item The colimit of the system $R_\lambda \to S_\lambda$
is equal to $R \to S$. The colimit of the system $M_\lambda$
is $M$.
\item Each $R_\lambda$ is essentially of finite type
over $\mathbf{Z}$.
\item Each $S_\lambda$ is essentially of finite type
over $R_\lambda$.
\item Each $M_\lambda$ is finite over $S_\lambda$.
\item For each $\lambda \leq \mu$ the map
$S_\lambda \otimes_{R_\lambda} R_\mu \to S_\mu$
presents $S_\mu$ as the localization of
$S_\lambda \otimes_{R_\lambda} R_\mu$
at a prime ideal.
\item For each $\lambda \leq \mu$ the map
$M_\lambda \otimes_{S_\lambda} S_\mu \to M_\mu$
is an isomorphism.
\end{enumerate}
\end{lemma}

\begin{proof}
As in the proof of Lemma \ref{lemma-limit-essentially-finite-presentation}
we may first write $R = \text{colim}\ R_\lambda$ as a directed colimit
of local $\mathbf{Z}$-algebras which are essentially of finite type.
Next, we may assume that for some $\lambda_1 \in \Lambda$ there
exist $f_{j, \lambda_1} \in R_{\lambda_1}[x_1, \ldots, x_n]$
such that
$$
S =
\text{colim}_{\lambda \geq \lambda_1}\ S_\lambda, \text{ with }
S_\lambda =
(R_\lambda[x_1, \ldots, x_n]/
(f_{1, \lambda}, \ldots, f_{m, \lambda}))_{\mathfrak q_\lambda}
$$
Choose a presentation
$$
S^{\oplus s} \to S^{\oplus t} \to M \to 0
$$
of $M$ over $S$. Let $A \in \text{Mat}(t\times s, S)$ be
the matrix of the presentation. For some $\lambda_2 \in \Lambda$,
$\lambda_2 \geq \lambda_1$
we can find a matrix $A_{\lambda_2} \in \text{Mat}(t\times s, S_{\lambda_2})$
which maps to $A$. For all $\lambda \geq \lambda_2$ we let
$M_\lambda = \text{Coker}(S_\lambda^{\oplus s} \xrightarrow{A_\lambda}
S_\lambda^{\oplus t})$. We leave it to the reader to see that
this works.
\end{proof}

\begin{lemma}
\label{lemma-limit-no-condition}
Suppose $R \to S$ is a ring map.
Then there exists a directed set $(\Lambda, \leq)$, and
a system of ring maps $R_\lambda \to S_\lambda$
such that
\begin{enumerate}
\item The colimit of the system $R_\lambda \to S_\lambda$
is equal to $R \to S$.
\item Each $R_\lambda$ is of finite type
over $\mathbf{Z}$.
\item Each $S_\lambda$ is of finite type
over $R_\lambda$.
\end{enumerate}
\end{lemma}

\begin{proof}
This is the non-local version of
Lemma \ref{lemma-limit-no-condition-local}.
Proof is similar and left to the reader.
\end{proof}

\begin{lemma}
\label{lemma-limit-finite-type}
Suppose $R \to S$ is a ring map.
Assume that $S$ is of finite type over $R$.
Then there exists a directed set $(\Lambda, \leq)$, and
a system of ring maps $R_\lambda \to S_\lambda$
such that
\begin{enumerate}
\item The colimit of the system $R_\lambda \to S_\lambda$
is equal to $R \to S$.
\item Each $R_\lambda$ is of finite type
over $\mathbf{Z}$.
\item Each $S_\lambda$ is of finite type
over $R_\lambda$.
\item For each $\lambda \leq \mu$ the map
$S_\lambda \otimes_{R_\lambda} R_\mu \to S_\mu$
presents $S_\mu$ as a quotient
of $S_\lambda \otimes_{R_\lambda} R_\mu$.
\end{enumerate}
\end{lemma}

\begin{proof}
This is the non-local version of
Lemma \ref{lemma-limit-essentially-finite-type}.
Proof is similar and left to the reader.
\end{proof}

\begin{lemma}
\label{lemma-limit-finite-presentation}
Suppose $R \to S$ is a ring map.
Assume that $S$ is of finite presentation over $R$.
Then there exists a directed set $(\Lambda, \leq)$, and
a system of ring maps $R_\lambda \to S_\lambda$
such that
\begin{enumerate}
\item The colimit of the system $R_\lambda \to S_\lambda$
is equal to $R \to S$.
\item Each $R_\lambda$ is of finite type
over $\mathbf{Z}$.
\item Each $S_\lambda$ is of finite type
over $R_\lambda$.
\item For each $\lambda \leq \mu$ the map
$S_\lambda \otimes_{R_\lambda} R_\mu \to S_\mu$
is an isomorphism.
\end{enumerate}
\end{lemma}

\begin{proof}
This is the non-local version of
Lemma \ref{lemma-limit-essentially-finite-presentation}.
Proof is similar and left to the reader.
\end{proof}

\begin{lemma}
\label{lemma-limit-module-finite-presentation}
Suppose $R \to S$ is a ring map.
Assume that $S$ is of finite presentation over $R$.
Let $M$ be a finitely presented $S$-module.
Then there exists a directed set $(\Lambda, \leq)$, and
a system of ring maps $R_\lambda \to S_\lambda$
together with $S_\lambda$-modules $M_\lambda$,
such that
\begin{enumerate}
\item The colimit of the system $R_\lambda \to S_\lambda$
is equal to $R \to S$. The colimit of the system $M_\lambda$
is $M$.
\item Each $R_\lambda$ is of finite type
over $\mathbf{Z}$.
\item Each $S_\lambda$ is of finite type
over $R_\lambda$.
\item Each $M_\lambda$ is finite over $S_\lambda$.
\item For each $\lambda \leq \mu$ the map
$S_\lambda \otimes_{R_\lambda} R_\mu \to S_\mu$
is an isomorphism.
\item For each $\lambda \leq \mu$ the map
$M_\lambda \otimes_{S_\lambda} S_\mu \to S_\mu$
is an isomorphism.
\end{enumerate}
In particular, for every $\lambda \in \Lambda$ we have
$$
M = M_\lambda \otimes_{S_\lambda} S
= M_\lambda \otimes_{R_\lambda} R.
$$
\end{lemma}

\begin{proof}
This is the non-local version of
Lemma \ref{lemma-limit-module-essentially-finite-presentation}.
Proof is similar and left to the reader.
\end{proof}














\section{More flatness criteria}
\label{section-more-flatness-criteria}

\noindent
The following lemma is often used in algebraic geometry to show that a finite
morphism from a normal surface to a smooth surface is flat. It is a partial
converse to Lemma \ref{lemma-finite-flat-over-regular-CM}.

\begin{lemma}
\label{lemma-CM-over-regular-flat}
Let $R \to S$ be a local homomorphism of Noetherian local
rings. Assume that $R$ is regular, $S$ Cohen-Macaulay,
$R \to S$ finite, and $\dim(R) = \dim(S)$. Then $R \to S$ is
flat.
\end{lemma}

\begin{proof}
By induction on $\dim(R)$. The case $\dim(R) = 0$ is trivial, because
then $R$ is a field. Assume $\dim(R) > 0$, and pick
$x \in \mathfrak m$, $x \not \in \mathfrak m^2$. Since $S$ is Cohen-Macaulay
for every minimal prime $\mathfrak q$ of $S$ we have
$\dim(S/\mathfrak q) = \dim(R)$, see Lemma \ref{lemma-CM-dim-formula}.
Because $R \to S/\mathfrak q$ is
finite we conclude that $R \to S/\mathfrak q$ is injective,
since otherwise it would be finite over a ring of smaller dimension
and hence have smaller dimension, see Lemma \ref{lemma-integral-sub-dim-equal}.
Hence we see that $x$ is not contained in any of the minimal
primes of $S$. Hence $x$ is a nonzero divisor on $S$, and we conclude
that $S/xS$ is Cohen-Macaulay with $\dim(S/xS) = \dim(S) - 1$.
By induction we see that $R/xR \to S/xS$ is flat. Hence we
conclude by Lemma \ref{lemma-variant-local-criterion-flatness} above
(see also the remarks following it). We could also use
Lemma \ref{lemma-free-mod-x} since a finite flat module over a
Noetherian local ring is finite free.
\end{proof}

\noindent
The following lemma is the key to proving that results for finitely presented
modules over finitely presented rings over a base ring follow from the
corresponding results for finite modules in the Noetherian case.

\begin{lemma}
\label{lemma-colimit-eventually-flat}
Let $R \to S$, $M$, $\Lambda$, $R_\lambda \to S_\lambda$, $M_\lambda$
be as in Lemma \ref{lemma-limit-module-essentially-finite-presentation}.
Assume that $M$ is flat over $R$.
Then for some $\lambda \in \Lambda$ the module
$M_\lambda$ is flat over $R_\lambda$.
\end{lemma}

\begin{proof}
Pick some $\lambda \in \Lambda$ and consider
$$
\text{Tor}_1^{R_\lambda}(M_\lambda, R_\lambda/\mathfrak m_\lambda)
=
\text{Ker}(\mathfrak m_\lambda \otimes_{R_\lambda} M_\lambda
\to M_\lambda).
$$
See Remark \ref{remark-Tor-ring-mod-ideal}. The right hand side
shows that this is a finitely generated $S_\lambda$-module (because
$S_\lambda$ is Noetherian and the modules in question are finite).
Let $\xi_1, \ldots, \xi_n$ be generators.
Because $M$ is flat over $R$ we
have that $0 = \text{Ker}(\mathfrak m_\lambda R \otimes_R M \to M)$.
Since $\otimes$ commutes with colimits we see there exists
a $\lambda' \geq \lambda$ such that each $\xi_i$ maps to
zero in
$\mathfrak m_{\lambda}R_{\lambda'} \otimes_{R_{\lambda'}} M_{\lambda'}$.
Hence we see that
$$
\text{Tor}_1^{R_\lambda}(M_\lambda, R_\lambda/\mathfrak m_\lambda)
\longrightarrow
\text{Tor}_1^{R_{\lambda'}}(M_\lambda,
R_{\lambda'}/\mathfrak m_{\lambda}R_{\lambda'})
$$
is zero. Note that
$M_\lambda \otimes_{R_\lambda} R_\lambda/\mathfrak m_\lambda$
is flat over $R_\lambda/\mathfrak m_\lambda$ because this last
ring is a field. Hence we may apply Lemma
\ref{lemma-another-variant-local-criterion-flatness}
to get that $M_{\lambda'}$ is flat over $R_{\lambda'}$.
\end{proof}

\noindent
Using the lemma above we can start to reprove the results of
Section \ref{section-criteria-flatness}
in the non-Noetherian case.

\begin{lemma}
\label{lemma-mod-injective-general}
Suppose that $R \to S$ is a local homomorphism of local rings.
Denote $\mathfrak m$ the maximal ideal of $R$.
Let $u : M \to N$ be a map of $S$-modules.
Assume
\begin{enumerate}
\item $S$ is essentially of finite presentation over $R$,
\item $M$, $N$ are finitely presented over $S$,
\item $N$ is flat over $R$, and
\item $\overline{u} : M/\mathfrak mM \to N/\mathfrak mN$ is injective.
\end{enumerate}
Then $u$ is injective, and $N/u(M)$ is flat over $R$.
\end{lemma}

\begin{proof}
By
Lemma \ref{lemma-limit-module-essentially-finite-presentation}
and its proof we can find a system $R_\lambda \to S_\lambda$ of
local ring maps together with maps of $S_\lambda$-modules
$u_\lambda : M_\lambda \to N_\lambda$ satisfying the conclusions
(1) -- (6) for both $N$ and $M$ of that lemma and such that the
colimit of the maps $u_\lambda$ is $u$. By
Lemma \ref{lemma-colimit-eventually-flat}
we may assume that $N_\lambda$ is flat over $R_\lambda$ for all
sufficiently large $\lambda$. Denote $\mathfrak m_\lambda \subset R_\lambda$
the maximal ideal and $\kappa_\lambda = R_\lambda / \mathfrak m_\lambda$,
resp.\ $\kappa = R/\mathfrak m$ the residue fields.

\medskip\noindent
Consider the map
$$
\Psi_\lambda :
M_\lambda/\mathfrak m_\lambda M_\lambda \otimes_{\kappa_\lambda} \kappa
\longrightarrow
M/\mathfrak m M.
$$
Since $S_\lambda/\mathfrak m_\lambda S_\lambda$ is essentially of finite type
over the field $\kappa_\lambda$ we see that the tensor product
$S_\lambda/\mathfrak m_\lambda S_\lambda \otimes_{\kappa_\lambda} \kappa$
is essentially of finite type over $\kappa$. Hence it is a Noetherian
ring and we conclude the kernel of $\Psi_\lambda$ is finitely generated.
Since $M/\mathfrak m M$ is the colimit of the system
$M_\lambda/\mathfrak m_\lambda M_\lambda$ and $\kappa$ is the colimit of
the fields $\kappa_\lambda$ there exists a $\lambda' > \lambda$ such that
the kernel of $\Psi_\lambda$ is generated by the kernel of
$$
\Psi_{\lambda, \lambda'} :
M_\lambda/\mathfrak m_\lambda M_\lambda
\otimes_{\kappa_\lambda}
\kappa_{\lambda'}
\longrightarrow
M_{\lambda'}/\mathfrak m_{\lambda'} M_{\lambda'}.
$$
By construction there exists a multiplicative subset
$W \subset S_\lambda \otimes_{R_\lambda} R_{\lambda'}$ such that
$S_{\lambda'} = W^{-1}(S_\lambda \otimes_{R_\lambda} R_{\lambda'})$ and
$$
W^{-1}(M_\lambda/\mathfrak m_\lambda M_\lambda
\otimes_{\kappa_\lambda}
\kappa_{\lambda'})
=
M_{\lambda'}/\mathfrak m_{\lambda'} M_{\lambda'}.
$$
Now suppose that $x$ is an element of the kernel of
$$
\Psi_{\lambda'} :
M_{\lambda'}/\mathfrak m_{\lambda'} M_{\lambda'}
\otimes_{\kappa_{\lambda'}} \kappa
\longrightarrow
M/\mathfrak m M.
$$
Then for some $w \in W$ we have
$wx \in M_\lambda/\mathfrak m_\lambda M_\lambda \otimes \kappa$.
Hence $wx \in \text{Ker}(\Psi_\lambda)$. Hence $wx$ is a linear
combination of elements in the kernel of $\Psi_{\lambda, \lambda'}$.
Hence $wx = 0$ in $M_{\lambda'}/\mathfrak m_{\lambda'} M_{\lambda'}
\otimes_{\kappa_{\lambda'}} \kappa$, hence $x = 0$ because $w$ is invertible
in $S_{\lambda'}$.
We conclude that the kernel of $\Psi_{\lambda'}$ is zero for all sufficiently
large $\lambda'$!

\medskip\noindent
By the result of the preceding paragraph we may assume that
the kernel of $\Psi_\lambda$ is zero for all $\lambda$ sufficiently large,
which implies that the map
$M_\lambda/\mathfrak m_\lambda M_\lambda \to M/\mathfrak m M$
is injective. Combined with $\overline{u}$ being injective this
formally implies that also
$\overline{u_\lambda} : M_\lambda/\mathfrak m_\lambda M_\lambda
\to N_\lambda/\mathfrak m_\lambda N_\lambda$ is injective.
By
Lemma \ref{lemma-mod-injective}
we conclude that (for all sufficiently large $\lambda$) the map
$u_\lambda$ is injective and that $N_\lambda/u_\lambda(M_\lambda)$ is flat
over $R_\lambda$.
The lemma follows.
\end{proof}

\begin{lemma}
\label{lemma-grothendieck-general}
Suppose that $R \to S$ is a local ring homomorphism of local rings.
Denote $\mathfrak m$ the maximal ideal of $R$.
Suppose
\begin{enumerate}
\item $S$ is essentially of finite presentation over $R$,
\item $S$ is flat over $R$, and
\item $f \in S$ is a nonzero divisor in $S/{\mathfrak m}S$.
\end{enumerate}
Then $S/fS$ is flat over $R$, and $f$ is a nonzero divisor in $S$.
\end{lemma}

\begin{proof}
Follows directly from Lemma \ref{lemma-mod-injective-general}.
\end{proof}

\begin{lemma}
\label{lemma-grothendieck-regular-sequence-general}
Suppose that $R \to S$ is a local ring homomorphism of local rings.
Denote $\mathfrak m$ the maximal ideal of $R$.
Suppose
\begin{enumerate}
\item $R \to S$ is essentially of finite presentation,
\item $R \to S$ is flat, and
\item $f_1, \ldots, f_c$ is a sequence of elements of
$S$ such that the images $\overline{f}_1, \ldots, \overline{f}_c$
form a regular sequence in $S/{\mathfrak m}S$.
\end{enumerate}
Then $f_1, \ldots, f_c$ is a regular sequence in $S$ and each
of the quotients $S/(f_1, \ldots, f_i)$ is flat over $R$.
\end{lemma}

\begin{proof}
Induction and Lemma \ref{lemma-grothendieck-general} above.
\end{proof}

\noindent
Here is the version of the local criterion of flatness for the case
of local ring maps which are locally of finite presentation.

\begin{lemma}
\label{lemma-variant-local-criterion-flatness-general}
Let $R \to S$ be a local homomorphism of local rings.
Let $I \not = R$ be an ideal in $R$. Let $M$ be an $S$-module. Assume
\begin{enumerate}
\item $S$ is essentially of finite presentation over $R$,
\item $M$ is of finite presentation over $S$,
\item $\text{Tor}_1^R(M, R/I) = 0$, and
\item $M/IM$ is flat over $R/I$.
\end{enumerate}
Then $M$ is flat over $R$.
\end{lemma}

\begin{proof}
Let $\Lambda$, $R_\lambda \to S_\lambda$, $M_\lambda$ be as in
Lemma \ref{lemma-limit-module-essentially-finite-presentation}.
Denote $I_\lambda \subset R_\lambda$ the inverse image of $I$.
In this case the system
$R/I \to S/IS$, $M/IM$, $R_\lambda \to S_\lambda/I_\lambda S_\lambda$,
and $M_\lambda/I_\lambda M_\lambda$ satisfies the conclusions of
Lemma \ref{lemma-limit-module-essentially-finite-presentation}
as well. Hence by
Lemma \ref{lemma-colimit-eventually-flat}
we may assume (after shrinking the index set $\Lambda$)
that $M_\lambda/I_\lambda M_\lambda$ is flat for all $\lambda$.
Pick some $\lambda$ and consider
$$
\text{Tor}_1^{R_\lambda}(M_\lambda, R_\lambda/I_\lambda)
=
\text{Ker}(I_\lambda \otimes_{R_\lambda} M_\lambda
\to M_\lambda).
$$
See Remark \ref{remark-Tor-ring-mod-ideal}. The right hand side
shows that this is a finitely generated $S_\lambda$-module (because
$S_\lambda$ is Noetherian and the modules in question are finite).
Let $\xi_1, \ldots, \xi_n$ be generators.
Because $\text{Tor}^1_R(M, R/I) = 0$ and since $\otimes$ commutes
with colimits we see there exists
a $\lambda' \geq \lambda$ such that each $\xi_i$ maps to
zero in
$\text{Tor}_1^{R_{\lambda'}}(M_{\lambda'}, R_{\lambda'}/I_{\lambda'})$.
The composition of the maps
$$
\xymatrix{
R_{\lambda'} \otimes_{R_\lambda}
\text{Tor}_1^{R_\lambda}(M_\lambda, R_\lambda/I_\lambda)
\ar[d]^{\text{surjective by Lemma \ref{lemma-surjective-on-tor-one}}} \\
\text{Tor}_1^{R_\lambda}(M_\lambda, R_{\lambda'}/I_\lambda R_{\lambda'})
\ar[d]^{\text{surjective up to localization by
Lemma \ref{lemma-surjective-on-tor-one-trivial}}} \\
\text{Tor}_1^{R_{\lambda'}}(M_{\lambda'}, R_{\lambda'}/I_\lambda R_{\lambda'})
\ar[d]^{\text{surjective by Lemma \ref{lemma-surjective-on-tor-one}}} \\
\text{Tor}_1^{R_{\lambda'}}(M_{\lambda'}, R_{\lambda'}/I_{\lambda'}).
}
$$
is surjective up to a localization by the reasons indicated.
The localization is necessary since $M_{\lambda'}$ is not equal
to $M_\lambda \otimes_{R_\lambda} R_{\lambda'}$. Namely, it is equal
to $M_\lambda \otimes_{S_\lambda} S_{\lambda'}$ and $S_{\lambda'}$
is the localization of $S_{\lambda} \otimes_{R_\lambda} R_{\lambda'}$ whence
the statement up to a localization (or tensoring with $S_{\lambda'}$).
Note that
Lemma \ref{lemma-surjective-on-tor-one}
applies to the first and third arrows because
$M_\lambda/I_\lambda M_\lambda$ is flat over
$R_\lambda/I_\lambda$ and because $M_{\lambda'}/I_\lambda M_{\lambda'}$
is flat over $R_{\lambda'}/I_\lambda R_{\lambda'}$ as it is a base
change of the flat module $M_\lambda/I_\lambda M_\lambda$.
The composition maps the generators $\xi_i$ to zero as we explained above.
We finally conclude that
$\text{Tor}_1^{R_{\lambda'}}(M_{\lambda'}, R_{\lambda'}/I_{\lambda'})$
is zero. This implies that $M_{\lambda'}$ is flat over $R_{\lambda'}$ by
Lemma \ref{lemma-variant-local-criterion-flatness}.
\end{proof}

\begin{lemma}
\label{lemma-criterion-flatness-fibre}
(Crit\`ere de platitude par fibres; essentially finite presentation case.)
Let $R$, $S$, $S'$ be local rings and let $R \to S \to S'$ be local ring
homomorphisms. Let $M$ be an $S'$-module. Let $\mathfrak m \subset R$
be the maximal ideal. Assume
\begin{enumerate}
\item The ring maps $R \to S$ and $R \to S'$ are essentially
of finite presentation.
\item The module $M$ is of finite presentation over $S'$.
\item The module $M$ is not zero.
\item The module $M/\mathfrak mM$ is a flat $S/\mathfrak mS$-module.
\item The module $M$ is a flat $R$-module.
\end{enumerate}
Then $S$ is flat over $R$ and $M$ is a flat $S$-module.
\end{lemma}

\begin{proof}
As in the proof of Lemma \ref{lemma-limit-essentially-finite-presentation}
we may first write $R = \text{colim}\ R_\lambda$ as a directed colimit
of local $\mathbf{Z}$-algebras which are essentially of finite type.
Denote $\mathfrak p_\lambda$ the maximal ideal of $R$.
Next, we may assume that for some $\lambda_1 \in \Lambda$ there
exist $f_{j, \lambda_1} \in R_{\lambda_1}[x_1, \ldots, x_n]$
such that
$$
S =
\text{colim}_{\lambda \geq \lambda_1}\ S_\lambda, \text{ with }
S_\lambda =
(R_\lambda[x_1, \ldots, x_n]/
(f_{1, \lambda}, \ldots, f_{u, \lambda}))_{\mathfrak q_\lambda}
$$
For some $\lambda_2 \in \Lambda$,
$\lambda_2 \geq \lambda_1$ there exist
$g_{j, \lambda_2} \in R_{\lambda_2}[x_1, \ldots, x_n, y_1, \ldots, y_m]$
with images
$\overline{g}_{j, \lambda_2} \in S_{\lambda_2}[y_1, \ldots, y_m]$
such that
$$
S' =
\text{colim}_{\lambda \geq \lambda_2}\ S'_\lambda, \text{ with }
S'_\lambda =
(S_\lambda[y_1, \ldots, y_m]/
(\overline{g}_{1, \lambda}, \ldots,
\overline{g}_{v, \lambda}))_{\overline{\mathfrak q}'_\lambda}
$$
Note that this also implies that
$$
S'_\lambda =
(R_\lambda[x_1, \ldots, x_n, y_1, \ldots, y_m]/
(g_{1, \lambda}, \ldots, g_{v, \lambda}))_{\mathfrak q'_\lambda}
$$
Choose a presentation
$$
(S')^{\oplus s} \to (S')^{\oplus t} \to M \to 0
$$
of $M$ over $S'$. Let $A \in \text{Mat}(t\times s, S')$ be
the matrix of the presentation. For some $\lambda_3 \in \Lambda$,
$\lambda_3 \geq \lambda_2$
we can find a matrix $A_{\lambda_3} \in \text{Mat}(t\times s, S_{\lambda_3})$
which maps to $A$. For all $\lambda \geq \lambda_3$ we let
$M_\lambda = \text{Coker}((S'_\lambda)^{\oplus s} \xrightarrow{A_\lambda}
(S'_\lambda)^{\oplus t})$.

\medskip\noindent
With these choices, we have for each $\lambda_3 \leq \lambda \leq \mu$
that $S_\lambda \otimes_{R_{\lambda}} R_\mu \to S_\mu$ is a localization,
$S'_\lambda \otimes_{S_{\lambda}} S_\mu \to S'_\mu$ is a localization, and
the map $M_\lambda \otimes_{S'_\lambda} S_\mu \to M_\mu$ is an
isomorphism. This also implies that
$S'_\lambda \otimes_{R_{\lambda}} R_\mu \to S'_\mu$ is a localization.
Thus, since $M$ is flat over $R$ we see by
Lemma \ref{lemma-colimit-eventually-flat} that
for all $\lambda$ big enough the module $M_\lambda$ is
flat over $R_\lambda$.
Moreover, note that
$
\mathfrak m = \text{colim}\ \mathfrak p_\lambda
$,
$
S/\mathfrak mS = \text{colim}\ S_\lambda/\mathfrak p_\lambda S_\lambda
$,
$
S'/\mathfrak mS' = \text{colim}\ S'_\lambda/\mathfrak p_\lambda S'_\lambda
$,
and
$
M/\mathfrak mM = \text{colim}\ M_\lambda/\mathfrak p_\lambda M_\lambda
$. Also, for each $\lambda_3 \leq \lambda \leq \mu$ we see (from the
properties listed above) that
$$
S'_\lambda/\mathfrak p_\lambda S'_\lambda
\otimes_{S_{\lambda}/\mathfrak p_\lambda S_\lambda}
S_\mu/\mathfrak p_\mu S_\mu
\longrightarrow
S'_\mu/\mathfrak p_\mu S'_\mu
$$
is a localization, and the map
$$
M_\lambda / \mathfrak p_\lambda M_\lambda
\otimes_{S'_\lambda/\mathfrak p_\lambda S'_\lambda}
S_\mu /\mathfrak p_\mu S'_\mu
\longrightarrow
M_\mu/\mathfrak p_\mu M_\mu
$$
is an isomorphism. Hence the system
$(S_\lambda/\mathfrak p_\lambda S_\lambda \to
S'_\lambda/\mathfrak p_\lambda S'_\lambda,
M_\lambda/\mathfrak p_\lambda M_\lambda)$
is a system as in
Lemma \ref{lemma-limit-module-essentially-finite-presentation} as well.
We may apply Lemma \ref{lemma-colimit-eventually-flat} again because
$M/\mathfrak m M$ is assumed flat over $S/\mathfrak mS$ and we see that
$M_\lambda/\mathfrak p_\lambda M_\lambda$ is flat over
$S_\lambda/\mathfrak p_\lambda S_\lambda$ for all $\lambda$ big enough.
Thus for $\lambda$ big enough the data
$R_\lambda \to S_\lambda \to S'_\lambda, M_\lambda$ satisfies
the hypotheses of Lemma \ref{lemma-criterion-flatness-fibre-Noetherian}.
Pick such a $\lambda$. Then $S = S_\lambda\otimes_{R_\lambda} R$
is flat over $R$, and $M = M_\lambda \otimes_{S_\lambda} S'_{\lambda}$
is flat over $S$ (since the base change of a flat module is flat).
\end{proof}

















\section{Openness of the flat locus}
\label{section-open-flat}


\begin{lemma}
\label{lemma-CM-dim-finite-type}
Let $k$ be a field. Let $S$ be a finite type
$k$-algebra. Let $f_1, \ldots, f_i$ be elements
of $S$. Assume that $S$ is Cohen-Macaulay and
equidimensional of dimension $d$, and that
$\dim V(f_1, \ldots, f_i) \leq d - i$. Then equality
holds and $f_1, \ldots, f_i$ forms a regular
sequence in $S_{\mathfrak q}$ for every prime $\mathfrak q$
of $V(f_1, \ldots, f_i)$.
\end{lemma}

\begin{proof}
If $S$ is Cohen-Macaulay and equidimensional of dimension
$d$, then we have $\dim(S_{\mathfrak m}) = d$ for all maximal
ideals $\mathfrak m$ of $S$, see
Lemma \ref{lemma-disjoint-decomposition-CM-algebra}.
By Proposition \ref{proposition-CM-module} we see that
for all maximal ideals $\mathfrak m \in V(f_1, \ldots, f_i)$
the sequence is a regular sequence in $S_{\mathfrak m}$ and
the local ring $S_{\mathfrak m}/(f_1, \ldots, f_i)$ is
Cohen-Macaulay of dimension $d - i$. This actually
means that $S/(f_1, \ldots, f_i)$ is Cohen-Macaulay
and equidimensional of dimension $d - i$.
\end{proof}

\begin{lemma}
\label{lemma-open-regular-sequence}
Suppose that $R \to S$ is a ring map which is
finite type, flat. Let $d$ be an integer
such that all fibres
$S \otimes_R \kappa(\mathfrak p)$ are
Cohen-Macaulay and equidimensional
of dimension $d$. Let $f_1, \ldots, f_i$
be elements of $S$. The set
$$
\{ \mathfrak q \in V(f_1, \ldots, f_i)
\mid f_1, \ldots, f_i
\text{ are a regular sequence in }
S_{\mathfrak q}/\mathfrak p S_{\mathfrak q}
\text{ where }\mathfrak p = R \cap \mathfrak q
\}
$$
is open in $V(f_1, \ldots, f_i)$.
\end{lemma}

\begin{proof}
Write $\overline{S} = S/(f_1, \ldots, f_i)$.
Suppose $\mathfrak q$ is an element of the set defined in the
lemma, and $\mathfrak p$ is the corresponding prime of $R$.
We will use relative dimension as defined in
Definition \ref{definition-relative-dimension}.
First, note that $d = \dim_{\mathfrak q}(S/R) =
\dim(S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}) +
\text{trdeg}_{\kappa(\mathfrak p)}\ \kappa(\mathfrak q)$
by Lemma \ref{lemma-dimension-at-a-point-finite-type-field}.
Since $f_1, \ldots, f_i$ form a regular sequence in the
Noetherian local ring $S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}$
general dimension theory tells us that
$\dim(\overline{S}_{\mathfrak q}/\mathfrak p\overline{S}_{\mathfrak q})
= \dim(S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}) - i$.
By the same Lemma \ref{lemma-dimension-at-a-point-finite-type-field}
we then conclude that $\dim_{\mathfrak q}(\overline{S}/R)
= \dim(\overline{S}_{\mathfrak q}/\mathfrak p\overline{S}_{\mathfrak q}) +
\text{trdeg}_{\kappa(\mathfrak p)}\ \kappa(\mathfrak q)
= d - i$. By Lemma
\ref{lemma-dimension-fibres-bounded-open-upstairs}
we have $\dim_{\mathfrak q'}(\overline{S}/R) \leq d - i$
for all $\mathfrak q' \in V(f_1, \ldots, f_i) = \text{Spec}(\overline{S})$
in a neighbourhood of $\mathfrak q$. Thus after replacing
$S$ by $S_g$ for some $g \in S$, $g \not \in \mathfrak q$
we may assume that the inequality holds for all
$\mathfrak q'$. The result follows from Lemma
\ref{lemma-CM-dim-finite-type}.
\end{proof}

\begin{lemma}
\label{lemma-exact-on-fibres-open}
Let $R \to S$ is a ring map.
Consider a finite homological complex of
finite free $S$-modules:
$$
F_{\bullet} :
0
\to
S^{n_e}
\xrightarrow{\varphi_e}
S^{n_{e-1}}
\xrightarrow{\varphi_{e-1}}
\ldots
\xrightarrow{\varphi_{i + 1}}
S^{n_i}
\xrightarrow{\varphi_i}
S^{n_{i-1}}
\xrightarrow{\varphi_{i-1}}
\ldots
\xrightarrow{\varphi_1}
S^{n_0}
$$
For every prime $\mathfrak q$ of $S$ consider the
complex $\overline{F}_{\bullet, \mathfrak q} =
F_{\bullet, \mathfrak q} \otimes_R \kappa(\mathfrak p)$
where $\mathfrak p$ is inverse image of $\mathfrak q$ in $R$.
Assume there exists an integer $d$ such
that $R \to S$ is finite type, flat
with fibres $S \otimes_R \kappa(\mathfrak p)$
Cohen-Macaulay of dimension $d$.
The set
$$
\{\mathfrak q \in \text{Spec}(S) \mid
\overline{F}_{\bullet, \mathfrak q}\text{ is exact}\}
$$
is open in $\text{Spec}(S)$.
\end{lemma}

\begin{proof}
Let $\mathfrak q$ be an element of the set defined in the lemma.
We are going to use Proposition \ref{proposition-what-exact}
to show there exists a $g \in S$, $g \not \in \mathfrak q$
such that $D(g)$ is contained in the set defined in the lemma.
In other words, we are going to show that after replacing $S$
by $S_g$, the set of the lemma is all of $\text{Spec}(S)$.
Thus during the proof we will, finitely often, replace
$S$ by such a localization.
Recall that Proposition \ref{proposition-what-exact}
characterizes exactness of complexes
in terms of ranks of the maps $\varphi_i$ and the ideals
$I(\varphi_i)$, in case the ring is local. We first address
the rank condition. Set
$r_i = n_i - n_{i + 1} + \ldots + (-1)^{e - i} n_e$.
Note that $r_i + r_{i + 1} = n_i$ and note that
$r_i$ is the expected rank of $\varphi_i$ (in the
exact case).

\medskip\noindent
By Lemma \ref{lemma-complex-exact-mod} we see that if
$\overline{F}_{\bullet, \mathfrak q}$ is exact, then
the localization $F_{\bullet, \mathfrak q}$ is exact.
In particular the complex $F_\bullet$ becomes
exact after localizing by an element
$g \in S$, $g \not \in \mathfrak q$. In this case
Proposition \ref{proposition-what-exact} applied
to all localizations of $S$ at prime ideals
implies that all $(r_i + 1) \times (r_i + 1)$-minors
of $\varphi_i$ are zero. Thus we see that the rank of
of $\varphi_i$ is at most $r_i$.

\medskip\noindent
Let $I_i \subset S$ denote the ideal generated
by the $r_i \times r_i$-minors of the matrix
of $\varphi_i$. By Proposition \ref{proposition-what-exact}
the complex $\overline{F}_{\bullet, \mathfrak q}$ is exact
if and only if for every $1 \leq i \leq e$ we have
either $(I_i)_{\mathfrak q} = S_{\mathfrak q}$ or
$(I_i)_{\mathfrak q}$ contains a $S_{\mathfrak q}/\mathfrak p
S_{\mathfrak q}$-regular sequence of length $i$.
Namely, by our choice of $r_i$ above and by the
bound on the ranks of the $\varphi_i$ this is the
only way the conditions of Proposition \ref{proposition-what-exact}
can be satisfied.

\medskip\noindent
If $(I_i)_{\mathfrak q} = S_{\mathfrak q}$, then after localizing $S$ at
some element $g \not\in \mathfrak q$ we may assume that
$I_i = S$. Clearly, this is an open condition.

\medskip\noindent
If $(I_i)_{\mathfrak q} \not = S_{\mathfrak q}$, then we have
a sequence $f_1, \ldots, f_i \in (I_i)_{\mathfrak q}$ which
form a regular sequence in $S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}$.
Note that for any prime $\mathfrak q' \subset S$ such that
$(f_1, \ldots, f_i) \not \subset \mathfrak q'$ we have
$(I_i)_{\mathfrak q'} = S_{\mathfrak q'}$.
Thus the result follows from Lemma \ref{lemma-open-regular-sequence}.
\end{proof}


\begin{theorem}
\label{theorem-openess-flatness}
Let $R$ be a ring. Let $R \to S$ be a ring map of finite
presentation. Let $M$ be a finitely presented $S$-module.
The set
$$
\{ \mathfrak q \in \text{Spec}(S) \mid
M_{\mathfrak q}\text{ is flat over }R\}
$$
is open in $\text{Spec}(S)$.
\end{theorem}

\begin{proof}
Let $\mathfrak q \in \text{Spec}(S)$ be a prime.
Let $\mathfrak p \subset R$ be the inverse image of $\mathfrak q$ in $R$.
Note that $M_{\mathfrak q}$ is flat over $R$ if and only if
it is flat over $R_{\mathfrak p}$.
Let us assume that $M_{\mathfrak q}$ is flat over $R$.
We claim that there exists a $g \in S$, $g \not \in \mathfrak q$
such that $M_g$ is flat over $R$.

\medskip\noindent
We first reduce to the case where $R$ and $S$ are
of finite type over $\mathbf{Z}$.
Choose a directed partially ordered set $\Lambda$ and
a system $(R_\lambda \to S_\Lambda, M_\lambda)$
as in Lemma \ref{lemma-limit-module-finite-presentation}.
Set $\mathfrak p_\lambda$ equal to the inverse image of
$\mathfrak p$ in $R_\lambda$.
Set $\mathfrak q_\lambda$ equal to the inverse image of
$\mathfrak q$ in $S_\lambda$.
Then the system
$$
((R_\lambda)_{\mathfrak p_\lambda},
(S_\lambda)_{\mathfrak q_\lambda},
(M_\lambda)_{\mathfrak q_{\lambda}})
$$
is a system as in
Lemma \ref{lemma-limit-module-essentially-finite-presentation}.
Hence by Lemma \ref{lemma-colimit-eventually-flat}
we see that for some $\lambda$ the module
$M_\lambda$ is flat over $R_\lambda$ at the prime
$\mathfrak q_{\lambda}$. Suppose we
can prove our claim for the system
$(R_\lambda \to S_\lambda, M_\lambda, \mathfrak q_{\lambda})$.
In other words, suppose that we can find a $g \in S_\lambda$,
$g \not\in \mathfrak q_\lambda$ such that $(M_\lambda)_g$
is flat over $R_\lambda$. By Lemma \ref{lemma-limit-module-finite-presentation}
we have $M = M_\lambda \otimes_{R_\lambda} R$ and hence
also $M_g = (M_\lambda)_g \otimes_{R_\lambda} R$. Thus by
Lemma \ref{lemma-flat-base-change} we deduce the claim
for the system $(R \to S, M, \mathfrak q)$.

\medskip\noindent
At this point we may assume that $R$ and $S$ are of finite type
over $\mathbf{Z}$. We may write $S$ as a quotient of a
polynomial ring $R[x_1, \ldots, x_n]$. Of course, we may replace
$S$ by $R[x_1, \ldots, x_n]$ and assume that $S$ is a polynomial
ring over $R$. In particular we see that $R \to S$ is flat
and all fibres rings $S \otimes_R \kappa(\mathfrak p)$
have global dimension $n$.

\medskip\noindent
Choose a resolution $F_\bullet$ of $M$ over $S$ with each
$F_i$ finite free, see Lemma \ref{lemma-resolution-by-finite-free}.
Let $K_n = \text{Ker}(F_{n-1} \to F_{n-2})$. Note that
$(K_n)_{\mathfrak q}$ is flat over $R$, since each $F_i$
is flat over $R$ and by assumption on $M$, see Lemma
\ref{lemma-flat-ses}. In addition, the sequence
$$
0 \to
K_n/\mathfrak p K_n \to
F_{n-1}/ \mathfrak p F_{n-1} \to
\ldots \to
F_0 / \mathfrak p F_0 \to
M/\mathfrak p M \to
0
$$
is exact upon localizing at $\mathfrak q$, because of vanishing
of $\text{Tor}_i^{R_\mathfrak p}(\kappa(\mathfrak p), M_{\mathfrak q})$.
Since the global dimension of $S_\mathfrak q/\mathfrak p S_{\mathfrak q}$
is $n$ we conclude that $K_n / \mathfrak p K_n$ localized
at $\mathfrak q$ is a finite free module over
$S_\mathfrak q/\mathfrak p S_{\mathfrak q}$. By
Lemma \ref{lemma-free-fibre-flat-free} $(K_n)_{\mathfrak q}$
is free over $S_{\mathfrak q}$. In particular, there exists a
$g \in S$, $g \not \in \mathfrak q$ such that $(K_n)_g$
is finite free over $S_g$.

\medskip\noindent
By Lemma \ref{lemma-exact-on-fibres-open}
there exists a further localization $S_g$ such that
the complex
$$
0 \to K_n \to F_{n-1} \to \ldots \to F_0
$$
is exact on {\it all fibres} of $R \to S$. By
Lemma \ref{lemma-complex-exact-mod}
this implies that the cokernel of $F_1 \to F_0$ is
flat. This proves the theorem in the Noetherian case.
\end{proof}

\noindent
Here is a technical application of the openness of flatness.
It says that we can approximate flat modules by flat modules
which is sometimes useful. Please skip on a first reading.

\begin{lemma}
\label{lemma-flat-finite-presentation-limit-flat}
Let $R \to S$ be a ring map.
Let $M$ be an $S$-module.
Assume that
\begin{enumerate}
\item $R \to S$ is of finite presentation,
\item $M$ is a finitely presented $S$-module, and
\item $M$ is flat over $R$.
\end{enumerate}
In this case we have the following:
\begin{enumerate}
\item There exists a finite type $\mathbf{Z}$-algebra $R_0$ and
a finite type ring map $R_0 \to S_0$ and a finite $S_0$-module $M_0$
such that $M_0$ is flat over $R_0$, together with a ring maps
$R_0 \to R$ and $S_0 \to S$ and an $S_0$-module map $M_0 \to M$
such that $S \cong R \otimes_{R_0} S_0$ and $M = S \otimes_{S_0} M_0$.
\item If $R = \text{colim}_{\lambda \in \Lambda} R_\lambda$ is written
as a directed colimit, then there exists a $\lambda$ and a ring map
$R_\lambda \to S_\lambda$ of finite presentation, and an $S_\lambda$-module
$M_\lambda$ of finite presentation such that $M_\lambda$ is flat over
$R_\lambda$ and such that $S = R \otimes_{R_\lambda} S_\lambda$ and
$M = S \otimes_{S_{\lambda}} M_\lambda$.
\item If
$$
(R \to S, M) =
\text{colim}_{\lambda \in \Lambda}
(R_\lambda \to S_\lambda, M_\lambda)
$$
is written as a directed colimit such that for $\mu \geq \lambda$ the
maps $R_\mu \otimes_{R_\lambda} S_\lambda \to S_\mu$ and
$S_\mu \otimes_{S_\lambda} M_\lambda \to M_\mu$ are isomorphisms
then for all sufficiently large $\lambda$ the module $M_\lambda$
is flat over $R_\lambda$.
\end{enumerate}
\end{lemma}

\begin{proof}
We first write $(R \to S, M)$ as the directed colimit of a system
$(R_\lambda \to S_\lambda, M_\lambda)$ as in
as in Lemma \ref{lemma-limit-module-finite-presentation}.
Let $\mathfrak q \subset S$ be a prime.
Let $\mathfrak p \subset R$, $\mathfrak q_\lambda \subset S_\lambda$,
and $\mathfrak p_\lambda \subset R_\lambda$ the corresponding primes.
As seen in the proof of Theorem \ref{theorem-openess-flatness}
$$
((R_\lambda)_{\mathfrak p_\lambda},
(S_\lambda)_{\mathfrak q_\lambda},
(M_\lambda)_{\mathfrak q_{\lambda}})
$$
is a system as in
Lemma \ref{lemma-limit-module-essentially-finite-presentation}, and
hence by Lemma \ref{lemma-colimit-eventually-flat}
we see that for some $\lambda_{\mathfrak q} \in \Lambda$
for all $\lambda \geq \lambda_{\mathfrak q}$
the module $M_\lambda$ is flat over
$R_\lambda$ at the prime $\mathfrak q_{\lambda}$.

\medskip\noindent
By Theorem \ref{theorem-openess-flatness} we get an open subset
$U_\lambda \subset \text{Spec}(S_\lambda)$ such that $M_\lambda$
flat over $R_\lambda$ at all the primes of $U_\lambda$.
Denote $V_\lambda \subset \text{Spec}(S)$ the inverse image of
$U_\lambda$ under the map $\text{Spec}(S) \to \text{Spec}(S_\lambda)$.
The argument above shows that for every $\mathfrak q \in \text{Spec}(S)$
there exists a $\lambda_{\mathfrak q}$ such that
$\mathfrak q \in V_\lambda$ for all $\lambda \geq \lambda_{\mathfrak q}$.
Since $\text{Spec}(S)$ is quasi-compact we see this implies there
exists a single $\lambda_0 \in \Lambda$ such that
$V_{\lambda_0} = \text{Spec}(S)$.

\medskip\noindent
The complement $\text{Spec}(S_{\lambda_0}) \setminus U_{\lambda_0}$
is $V(I)$ for some ideal $I \subset S_{\lambda_0}$. As
$V_{\lambda_0} = \text{Spec}(S)$ we see that $IS = S$.
Choose $f_1, \ldots, f_r \in I$ and $s_1, \ldots, s_n \in S$ such
that $\sum f_i s_i = 1$. Since $\text{colim} S_\lambda = S$, after
increasing $\lambda_0$ we may assume there exist
$s_{i, \lambda_0} \in S_{\lambda_0}$ such that
$\sum f_i s_{i, \lambda_0} = 1$.
Hence for this $\lambda_0$ we have
$U_{\lambda_0} = \text{Spec}(S_{\lambda_0})$.
This proves (1).

\medskip\noindent
It turns out that (2) and (3) follow in a mechanical way from part (1).
Namely, let $(R_0 \to S_0, M_0)$ be as in (1) and suppose that
$R = \text{colim} R_\lambda$. Since $R_0$ is a finite type $\mathbf{Z}$
algebra, there exists a lambda and a map $R_0 \to R_\lambda$ such
that $R_0 \to R_\lambda \to R$ is the given map $R_0 \to R$.
Then, part (2) follows by taking $S_\lambda = R_\lambda \otimes_{R_0} S_0$
and $M_\lambda = S_\lambda \otimes_{S_0} M_0$.

\medskip\noindent
Finally, we come to the proof of (3). We stronly suggest not reading
this proof ever!
Assume the directed system $(R_\lambda \to S_\lambda, M_\lambda)$
satisfies the hypotheses of (3) and that
$(R_0 \to S_0, M_0)$, $R_0 \to R$ satisfies the conclusion of (1).
As above, there exits a $\lambda_0$ and a ring map
$R_0 \to R_{\lambda_0}$ such that $R_0 \to R_{\lambda_0} \to R$ is the
given map $R_0 \to R$. Then for all $\lambda \geq \lambda_0$
we get an induced ring map $R_0 \to R_\lambda$ with the same property.
Then, since $S_0$ is of finite type over $\mathbf{Z}$
too, and as $S = \text{colim} S_\lambda$ we see that for some
$\lambda_1 \geq \lambda_0$ we also get an $R_0$-algebra map
$S_0 \to S_{\lambda_1}$
such that the composition $S_0 \to S_{\lambda_1} \to S$ is the given
map $S_0 \to S$. For all $\lambda \geq \lambda_1$ this gives
maps
$$
\Psi_{\lambda} :
R_\lambda \otimes_{R_0} S_0
\longrightarrow
R_\lambda \otimes_{R_{\lambda_1}} S_{\lambda_1}
\cong
S_\lambda
$$
the last isomorphism by assumption. Let us argue that this map is an
isomorphism for all $\lambda$ large enough. First, pick generators
$x_1, \ldots, x_n$ of the finitely presented algebra $S_{\lambda_1}$
over $R_{\lambda_1}$. Since $S = R \otimes_{R_0} S_0$ and since
$R = \text{colim} R_\lambda$ hence
$S = \text{colim} R_\lambda \otimes_{R_0} S_0$
there exists a $\lambda_2 \geq \lambda_1$ such
that $x_i \in S_{\lambda_2}$ is in the image of $\Psi_{\lambda_2}$.
Hence for $\lambda \geq \lambda_2$ the map $\Psi_{\lambda_2}$ is surjective.
Write $S_0 = R_0[y_1, \ldots, y_m]/I_0$. Write
$$
S_{\lambda_2} = R_{\lambda_2}[y_1, \ldots, y_m]/(g_1, \ldots, g_k).
$$
We know that $g_1, \ldots, g_k \in I_0R[y_1, \ldots, y_m]$
as $S = R[y_1, \ldots, y_m]/(g_1, \ldots, g_m)$ and also
$S = R[y_1, \ldots, y_m]/I_0R[y_1, \ldots, y_m]$ by all our assumptions.
Hence for some $\lambda_3 \geq \lambda_2$ we see that
$g_1, \ldots, g_m \in I_0R_{\lambda_3}[y_1, \ldots, y_m]$.
Then it is clear that $\Psi_{\lambda}$ is an isomorphism for
all $\lambda \geq \lambda_3$. Phew!

\medskip\noindent
In the same vein, there exists a $\lambda_4$ and an $S_0$-module map
$M_0 \to M_{\lambda_4}$ such that $M_0 \to M_{\lambda_4} \to M$ is the given
map $M_0 \to M$. We claim that for all $\lambda$ large enough
the induced maps $S_\lambda \otimes_{S_0} M_0 \to M_\lambda$ are isomorphisms.
This is proved in exactly the same way as above and we omit it.
Of course this implies (3), because $M_0$ is flat over $R_0$.
\end{proof}

\begin{lemma}
\label{lemma-descend-faithfully-flat-finite-presentation}
Let $R \to A \to B$ be ring maps.
Assume $A \to B$ faithfully flat of finite presentation.
Then there exists a commutative diagram
$$
\xymatrix{
R \ar[r] \ar@{=}[d] &
A_0 \ar[d] \ar[r] &
B_0 \ar[d] \\
R \ar[r] & A \ar[r] & B
}
$$
with $R \to A_0$ of finite presentation,
$A_0 \to B_0$ faithfully flat of finite presentation
and $B = A \otimes_{A_0} B_0$.
\end{lemma}

\begin{proof}
We first prove the lemma with $R$ replaced $\mathbf{Z}$.
By Lemma \ref{lemma-flat-finite-presentation-limit-flat}
there exists a diagram
$$
\xymatrix{
A_0 \ar[r] & A \\
B_0 \ar[u] \ar[r] & B \ar[u]
}
$$
where $A_0$ is of finite type over $\mathbf{Z}$, $B_0$ is flat of finite
presentation over $A_0$ such that $B = A \otimes_{A_0} B_0$.
As $A_0 \to B_0$ is flat of finite presentation we see that the image of
$\text{Spec}(B_0) \to \text{Spec}(A_0)$ is open, see
Proposition \ref{proposition-fppf-open}. Hence the complement of the image
is $V(I_0)$ for some ideal $I_0 \subset A_0$.
As $A \to B$ is faithfully
flat the map $\text{Spec}(B) \to \text{Spec}(A)$ is surjective, see
Lemma \ref{lemma-ff-rings}.
Now we use that
the base change of the image is the image of the base change.
Hence $I_0A = A$. Pick a relation
$\sum f_i r_i = 1$, with $r_i \in A$, $f_i \in I_0$. Then after
enlarging $A_0$ to contain the elements $r_i$ (and correspondingly
enlarging $B_0$) we see that $A_0 \to B_0$ is surjective on spectra
also, i.e., faithfully flat.

\medskip\noindent
Thus the lemma holds in case $R = \mathbf{Z}$.
In the general case, take the solution $A_0' \to B_0'$
just obtained and set $A_0 = A_0' \otimes_{\mathbf{Z}} R$,
$B_0 = B_0' \otimes_{\mathbf{Z}} R$.
\end{proof}







\section{Flattening stratification}
\label{section-flattening}

\noindent
We will discuss flattening stratifications for morphisms of schemes in
More on Flatness, Section \ref{flat-section-flattening}.
In this section we prove some basic algebra facts related to this.

\begin{lemma}
\label{lemma-intersection-flat}
Let $R$ be a ring. Let $M$ be an $R$-module. Let $I_1$, $I_2$ be ideals of $R$.
If $M/I_1M$ is flat over $R/I_1$ and $M/I_2M$ is flat over $R/I_2$,
then $M/(I_1 \cap I_2)M$ is flat over $R/(I_1 \cap I_2)$.
\end{lemma}

\begin{proof}
By replacing $R$ with $R/(I_1 \cap I_2)$ and $M$ by $M/(I_1 \cap I_2)M$
we may assume that $I_1 \cap I_2 = 0$. Let $J \subset R$ be an ideal.
To prove that $M$ is flat over $R$ we have to show that
$J \otimes_R M \to M$ is injective, see
Lemma \ref{lemma-flat}.
By flatness of $M/I_1M$ over $R/I_1$ the map
$$
J/(J \cap I_1) \otimes_R M =
(J + I_1)/I_1 \otimes_{R/I_1} M/I_1M
\longrightarrow M/I_1M
$$
is injective. As $0 \to (J \cap I_1) \to J \to J/(J \cap I_1) \to 0$
is exact we obtain a diagram
$$
\xymatrix{
(J \cap I_1) \otimes_R M \ar[r] \ar[d] &
J \otimes_R M \ar[r] \ar[d] &
J/(J \cap I_1) \otimes_R M \ar[r] \ar[d] & 0 \\
M \ar@{=}[r] &
M \ar[r] &
M/I_1M
}
$$
hence it suffices to show that $(J \cap I_1) \otimes_R M \to M$ is
injective. Since $I_1 \cap I_2 = 0$ the ideal $J \cap I_1$
maps isomorphically to an ideal $J' \subset R/I_2$ and we see that
$(J \cap I_1) \otimes_R M = J' \otimes_{R/I_2} M/I_2M$. By flatness
of $M/I_2M$ over $R/I_2$ the map $J' \otimes_{R/I_2} M/I_2M \to M/I_2M$
is injective, which clearly implies that $(J \cap I_1) \otimes_R M \to M$ is
injective.
\end{proof}

\medskip\noindent
Let $R \to S$ be a ring map.
Let $I \subset R$ be an ideal.
Let $M$ be an $S$-module.
In the following we will consider the following condition
\begin{equation}
\label{equation-flat-at-primes-over}
\text{for every prime }\mathfrak q\text{ of }S\text{ containing }IS
\text{ the localization }M_{\mathfrak q}\text{ is flat over }R.
\end{equation}

\begin{lemma}
\label{lemma-base-change-flat-at-primes-over}
Let $R \to S$ be a ring map.
Let $I \subset R$ be an ideal.
Let $M$ be an $S$-module.
Let $R \to R'$ be a ring map.
If (\ref{equation-flat-at-primes-over}) holds for
$(R \to S, I, M)$, then (\ref{equation-flat-at-primes-over})
holds for $(R' \to S \otimes_R R', IR', M \otimes_R R')$.
\end{lemma}

\begin{proof}
Assume (\ref{equation-flat-at-primes-over}) holds for
$(R \to S, I \subset R, M)$.
Let $\mathfrak q'$ be a prime of $S \otimes_R R'$ lying over $IR'$.
Let $\mathfrak q \subset S$ be the corresponding prime of $S$.
Then $IS \subset \mathfrak q$. Note that $(M \otimes_R R')_{\mathfrak q'}$
is a localization of the base change $M_{\mathfrak q} \otimes_R R'$.
Hence $(M \otimes_R R')_{\mathfrak q'}$ is flat over $R'$ as a localization
of a flat module, see
Lemmas \ref{lemma-flat-base-change} and \ref{lemma-flat-localization}.
\end{proof}

\begin{lemma}
\label{lemma-flat-module-powers}
Let $R \to S$ be a ring map. Let $I \subset R$ be an ideal.
Let $M$ be an $S$-module. Assume
\begin{enumerate}
\item $R$ is a Noetherian ring,
\item $S$ is a Noetherian ring,
\item $M$ is a finite $S$-module, and
\item for each $n \geq 1$ the module $M/I^n M$ is flat over
$R/I^n$.
\end{enumerate}
Then (\ref{equation-flat-at-primes-over}) holds, i.e.,
for every prime $\mathfrak q$ of $S$ lying over $IS$
the localization $M_{\mathfrak q}$ is flat over $R$.
\end{lemma}

\begin{proof}
We are going to use
Lemma \ref{lemma-variant-local-criterion-flatness}.
By assumption $M/IM$ is flat over $R/I$. Hence it suffices to check
that $\text{Tor}_1^R(M, R/I)$ is zero on localization at $\mathfrak q$. By
Remark \ref{remark-Tor-ring-mod-ideal}
this Tor group is equal to $K = \text{Ker}(I \otimes_R M \to M)$.
We know for each $n \geq 1$ that the kernel
$\text{Ker}(I/I^n \otimes_{R/I^n} M/I^nM \to M/I^nM)$ is zero.
Since there is a module map
$I/I^n \otimes_{R/I^n} M/I^nM \to (I \otimes_R M)/I^{n - 1}(I \otimes_R M)$
we conclude that $K \subset I^{n - 1}(I \otimes_R M)$ for each $n$.
By the Artin-Rees lemma, and more precisely
Lemma \ref{lemma-intersection-powers-ideal-module}
we conclude that $K_{\mathfrak q} = 0$, as desired.
\end{proof}

\begin{lemma}
\label{lemma-flattening-artinian}
Let $R$ be an Artinian ring.
Let $M$ be an $R$-module.
Then there exists a smallest ideal $I \subset R$ such that
$M/IM$ is flat over $R/I$.
\end{lemma}

\begin{proof}
This follows directly from
Lemma \ref{lemma-intersection-flat}
and the Artinian property.
\end{proof}

\noindent
This ideal has the following universal property.

\begin{lemma}
\label{lemma-flattening-artinian-universal-property}
Let $R$ be an Artinian ring. Let $M$ be an $R$-module.
Let $I \subset R$ be the smallest ideal $I \subset R$ such that
$M/IM$ is flat over $R/I$.
Then $I$ has the following universal property:
For every ring map $\varphi : R \to R'$ we have
$$
R' \otimes_R M\text{ is flat over }R'
\Leftrightarrow
\text{we have }\varphi(I) = 0.
$$
\end{lemma}

\begin{proof}
Note that $I$ exists by
Lemma \ref{lemma-flattening-artinian}.
The implication $\Rightarrow$ follows from
Lemma \ref{lemma-flat-base-change}.
Let $\varphi : R \to R'$ be such that $M \otimes_R R'$ is flat over $R'$.
Let $J = \text{Ker}(\varphi)$. By
Lemma \ref{lemma-descent-flatness-injective-map-artinian-rings}
and as $R' \otimes_R M = R' \otimes_{R/J} M/JM$ is
flat over $R'$ we conclude that $M/JM$ is flat over $R/J$.
Hence $I \subset J$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-flattening-complete-local-noetherian}
Let $R \to S$ be a ring map.
Let $M$ be an $S$-module.
Assume
\begin{enumerate}
\item $(R, \mathfrak m)$ is a complete local Noetherian ring,
\item $S$ is a Noetherian ring, and
\item $M$ is finite over $S$.
\end{enumerate}
Then there exists an ideal $I \subset \mathfrak m$ such that
\begin{enumerate}
\item $(M/IM)_{\mathfrak q}$ is flat over $R/I$ for all
primes $\mathfrak q$ of $S/IS$ lying over $\mathfrak m$, and
\item if $J \subset R$ is an ideal such that $(M/JM)_{\mathfrak q}$
is flat over $R/J$ for all primes $\mathfrak q$ lying over
$\mathfrak m$, then $I \subset J$.
\end{enumerate}
In other words, $I$ is the smallest ideal of $R$ such that
(\ref{equation-flat-at-primes-over}) holds for
$(\overline{R} \to \overline{S}, \overline{\mathfrak m}, \overline{M})$
where $\overline{R} = R/I$, $\overline{S} = S/IS$,
$\overline{\mathfrak m} = \mathfrak m/I$ and $\overline{M} = M/IM$.
\end{lemma}

\begin{proof}
Let $J \subset R$ be an ideal. Apply
Lemma \ref{lemma-flat-module-powers}
to the module $M/JM$ over the ring $R/J$.
Then we see that $(M/JM)_{\mathfrak q}$
is flat over $R/J$ for all primes $\mathfrak q$ of $S/JS$
if and only if $M/(J + \mathfrak m^n)M$ is flat over
$R/(J + \mathfrak m^n)$ for all $n \geq 1$.
We will use this remark below.

\medskip\noindent
For every $n \geq 1$ the local ring $R/\mathfrak m^n$ is Artinian.
Hence, by
Lemma \ref{lemma-flattening-artinian}
there exists a smallest ideal $I_n \supset \mathfrak m^n$ such that
$M/I_nM$ is flat over $R/I_n$. It is clear that $I_{n + 1} + \mathfrak m^n$
is contains $I_n$ and applying
Lemma \ref{lemma-intersection-flat}
we see that $I_n = I_{n + 1} + \mathfrak m^n$. Since
$R = \lim_n\ R/\mathfrak m^n$ we see that $I = \lim_n\ I_n/\mathfrak m^n$
is an ideal in $R$ such that $I_n = I + \mathfrak m^n$ for all $n \geq 1$.
By the initial remarks of the proof we see that $I$ verifies (1)
and (2). Some details omitted.
\end{proof}

\begin{lemma}
\label{lemma-flattening-complete-local-noetherian-property-by-finite-type}
With notation $R \to S$, $M$, and $I$ and assumptions as in
Lemma \ref{lemma-flattening-complete-local-noetherian}.
Consider a local homomorphism of local rings
$\varphi : (R, \mathfrak m) \to (R', \mathfrak m')$
such that $R'$ is Noetherian. Then the following are equivalent
\begin{enumerate}
\item condition (\ref{equation-flat-at-primes-over}) holds
for $(R' \to S \otimes_R R', \mathfrak m', M \otimes_R R')$, and
\item $\varphi(I) = 0$.
\end{enumerate}
\end{lemma}

\begin{proof}
The implication (2) $\Rightarrow$ (1) follows from
Lemma \ref{lemma-base-change-flat-at-primes-over}.
Let $\varphi : R \to R'$ be as in the lemma satisfying (1).
We have to show that $\varphi(I) = 0$.
This is equivalent to the condition that $\varphi(I)R' = 0$.
By Artin-Rees in the Noetherian local ring $R'$ (see
Lemma \ref{lemma-intersect-powers-ideal-module-zero})
this is equivalent to the condition that
$\varphi(I)R' + (\mathfrak m')^n = (\mathfrak m')^n$ for all $n > 0$.
Hence this is equivalent to the condition that the composition
$\varphi_n : R \to R' \to R'/(\mathfrak m')^n$ annihilates $I$ for each $n$.
Now assumption (1) for $\varphi$ implies assumption (1) for
$\varphi_n$ by
Lemma \ref{lemma-base-change-flat-at-primes-over}.
This reduces us to the case where $R'$ is Artininian.

\medskip\noindent
Assume $R'$ Artinian. Let $J = \text{Ker}(\varphi)$. We have to show that
$I \subset J$. By the construction of $I$ in
Lemma \ref{lemma-flattening-complete-local-noetherian}
it suffices to show that $(M/JM)_{\mathfrak q}$ is flat over $R/J$
for every prime $\mathfrak q$ of $S/JS$ lying over $\mathfrak m$.
As $R'$ is Artinian, condition (1) signifies that $M \otimes_R R'$
is flat over $R'$. As $R'$ is Artinian, it follows that $R/J$ is Artinian
too. Hence the flatness of $M \otimes_R R' = M/JM \otimes_{R/J} R'$ over
$R'$ implies that $M/JM$ is flat over $R/J$ by
Lemma \ref{lemma-descent-flatness-injective-map-artinian-rings}.
This concludes the proof.
\end{proof}

\begin{lemma}
\label{lemma-flattening-complete-local-universal-property}
With notation $R \to S$, $M$, and $I$ and assumptions as in
Lemma \ref{lemma-flattening-complete-local-noetherian}.
In addition assume that $R \to S$ is of finite type.
Then for any local homomorphism of local rings
$\varphi : (R, \mathfrak m) \to (R', \mathfrak m')$
the following are equivalent
\begin{enumerate}
\item condition (\ref{equation-flat-at-primes-over}) holds
for $(R' \to S \otimes_R R', \mathfrak m', M \otimes_R R')$, and
\item $\varphi(I) = 0$.
\end{enumerate}
\end{lemma}

\begin{proof}
The implication (2) $\Rightarrow$ (1) follows from
Lemma \ref{lemma-base-change-flat-at-primes-over}.
Let $\varphi : R \to R'$ be as in the lemma satisfying (1).
Let $J = \text{Ker}(\varphi)$. By the construction of $I$ in
Lemma \ref{lemma-flattening-complete-local-noetherian}
it suffices to show that $(M/JM)_{\mathfrak q}$ is flat over $R/J$
for every prime $\mathfrak q$ of $S/JS$ lying over $\mathfrak m$.
Hence we may replace $R$, $S$, $M$ by $R/J$, $S/JS$, $M/JM$.
In other words, we are given an injective homomorphism
$\varphi : R \to R'$ as in the lemma satisfying (1)
and our goal is to show that $M_{\mathfrak q}$ is flat over $R$
for all primes $\mathfrak q$ of $S$ lying over $\mathfrak m$.

\medskip\noindent
As $R$ is Noetherian we see that $R \to S$ is of finite presentation
and $M$ is an $S$-module of finite presentation. Hence the base change
$S' = S \otimes_R R'$ is of finite presentation over $R'$ and
$M' = M \otimes_R R' = M \otimes_S S'$ is of finite presentation over $S'$. By
Theorem \ref{theorem-openess-flatness}
the set
$$
U' = \{\mathfrak q' \in \text{Spec}(S') \mid
M'_{\mathfrak q'}\text{ is flat over }R'\}
$$
is open in $\text{Spec}(S')$. Note that
$$
F' = \{\mathfrak q' \in \text{Spec}(S') \mid
\mathfrak q'\text{ lies over }\mathfrak m'\} =
\text{Spec}(S' \otimes_{R'} \kappa(\mathfrak m'))
$$
is a quasi-compact space which is contained in $U'$ by assumption.
Hence there exist finitely many $g'_i \in S'$, $i = 1, \ldots, n$
such that $D(g'_i) \subset U'$ and such that $F' \subset \bigcup D(g'_i)$.
Note that in particular $M'_{g'_i}$ is a flat module over $R'$.

\medskip\noindent
Choose $R_0$ with $R \subset R_0 \subset R'$ such that
$R_0$ is essentially of finite type over $R$, local with maximal
ideal $\mathfrak m_0 = R_0 \cap \mathfrak m'$, and such that there exist
$g_{0, i} \in S \otimes_R R_0$ mapping to the elements $g_i$ in
$S' = S \otimes_R R'$. After possibly increasing $R_0$ a bit we
may assume that $F_0 = \text{Spec}(S \otimes_R \kappa(\mathfrak m_0))$
is contained in $\bigcup D(g_{0, i})$.
Now we can write $R' = \text{colim}_\lambda\ R_\lambda$
as a directed colimit of $R_0$-subalgebras $R_\lambda$ of $R'$,
local with maximal ideal $\mathfrak m_\lambda = R_\lambda \cap \mathfrak m'$
which are essentially of finite type over $R$.
Write $S_\lambda = S \otimes_R R_\lambda$,
$M_\lambda = M \otimes_R R_\lambda$, and
$g_{\lambda, i}$ the image of $g_{0, i}$ in $S_\lambda$.
By
Lemma \ref{lemma-flat-finite-presentation-limit-flat}
we see that for some sufficiently large $\lambda$ the modules
$(M_\lambda)_{g_{\lambda, i}}$ are flat over $R_\lambda$.
In particular the module $M_\lambda$ is flat over $R_\lambda$
at all the primes lying over the maximal ideal $\mathfrak m_\lambda$.
Hence
Lemma \ref{lemma-flattening-complete-local-noetherian-property-by-finite-type}
applies to the ring map $R \to R_\lambda$ and we see that
$I$ maps to zero in $R_\lambda$, a fortiori it maps to zero in $R'$.
\end{proof}




\section{Descent flatness along integral maps}
\label{section-descent-flatness-integral}

\noindent
First a few simple lemmas.

\begin{lemma}
\label{lemma-have-one-root}
Let $R$ be a ring. Let $P(T)$ be a monic polynomial with coefficients
in $R$. If there exists an $\alpha \in R$ such that $P(\alpha) = 0$, then
$P(T) = (T - \alpha)Q(T)$ for some monic polynomial $Q(T) \in R[T]$.
\end{lemma}

\begin{proof}
By induction on the degree of $P$. If $\deg(P) = 1$, then
$P(T) = T - \alpha$ and the result is true. If $\deg(P) > 1$, then
we can write $P(T) = (T - \alpha)Q(T) + r$ for some polynomial
$Q \in R[T]$ of degree $< \deg(P)$ and some $r \in R$ by long
division. By assumption $0 = P(\alpha) = (\alpha - \alpha)Q(\alpha) + r = r$
and we conclude that $r = 0$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-adjoin-one-root}
Let $R$ be a ring. Let $P(T)$ be a monic polynomial with coefficients
in $R$. There exists a finite free ring map $R \to R'$ such that
$P(T) = (T - \alpha)Q(T)$ for some $\alpha \in R'$ and some
monic polynomial $Q(T) \in R'[T]$.
\end{lemma}

\begin{proof}
Write $P(T) = T^d + a_1T^{d - 1} + \ldots + a_0$.
Set $R' = R[x]/(x^d + a_1x^{d - 1} + \ldots + a_0)$.
Set $\alpha$ equal to the congruence class of $x$.
Then it is clear that $P(\alpha) = 0$. Thus we win by
Lemma \ref{lemma-have-one-root}.
\end{proof}

\begin{lemma}
\label{lemma-finite-split}
Let $R \to S$ be a finite ring map.
There exists a finite free ring extension $R \subset R'$ such
that $S \otimes_R R'$ is a quotient of a ring of the form
$$
R'[T_1, \ldots, T_n]/(P_1(T_1), \ldots, P_n(T_n))
$$
with $P_i(T) = \prod_{j = 1, \ldots, d_i} (T - \alpha_{ij})$ for some
$\alpha_{ij} \in R'$.
\end{lemma}

\begin{proof}
Let $x_1, \ldots, x_n \in S$ be generators of $S$ over $R$.
For each $i$ we can choose a monic polynomial $P_i(T) \in R[T]$
such that $P(x_i) = 0$ in $S$, see
Lemma \ref{lemma-finite-is-integral}.
Say $\deg(P_i) = d_i$. By
Lemma \ref{lemma-adjoin-one-root}
(applied $\sum d_i$ times) there exists a finite free ring
extension $R \subset R'$ such that each $P_i$ splits completely:
$$
P_i(T) = \prod\nolimits_{j = 1, \ldots, d_i} (T - \alpha_{ij})
$$
for certain $\alpha_{ik} \in R'$. Let
$R'[T_1, \ldots, T_n] \to S \otimes_R R'$ be the $R'$-algebra map
which maps $T_i$ to $x_i \otimes 1$. As this maps $P_i(T_i)$ to zero,
this induces the desired surjection.
\end{proof}

\begin{lemma}
\label{lemma-split-image}
Let $R$ be a ring.
Let $S = R[T_1, \ldots, T_n]/J$.
Assume $J$ contains elements of the form $P_i(T_i)$
with $P_i(T) = \prod_{j = 1, \ldots, d_i} (T - \alpha_{ij})$ for some
$\alpha_{ij} \in R$. For $\underline{k} = (k_1, \ldots, k_n)$
with $1 \leq k_i \leq d_i$ consider the ring map
$$
\Phi_{\underline{k}} : R[T_1, \ldots, T_n] \to R,
\quad
T_i \longmapsto \alpha_{ik_i}
$$
Set $J_{\underline{k}} = \Phi_{\underline{k}}(J)$.
Then the image of $\text{Spec}(S) \to \text{Spec}(R)$ is equal to
$V(\bigcap J_{\underline{k}})$.
\end{lemma}

\begin{proof}
This lemma proves itself. Hint:
$V(\bigcap J_{\underline{k}}) = \bigcup V(J_{\underline{k}})$.
\end{proof}

\noindent
The following result is due to Ferrand, see \cite{Ferrand}.

\begin{lemma}
\label{lemma-descent-flatness-injective-finite-Noetherian-rings}
Let $R \to S$ be a finite injective homomorphism of Noetherian rings.
Let $M$ be an $R$-module. If $M \otimes_R S$ is a flat $S$-module,
then $M$ is a flat $R$-module.
\end{lemma}

\begin{proof}
Let $M$ be an $R$-module such that $M \otimes_R S$ is flat over $S$. By
Lemma \ref{lemma-flatness-descends}
in order to prove that $M$ is flat we may replace $R$ by any faithfully flat
ring extension. By
Lemma \ref{lemma-finite-split}
we can find a finite locally free ring extension $R \subset R'$ such
that $S' = S \otimes_R R' = R'[T_1, \ldots, T_n]/J$ for some ideal
$J \subset R'[T_1, \ldots, T_n]$ which contains the  elements of the form
$P_i(T_i)$ with $P_i(T) = \prod_{j = 1, \ldots, d_i} (T - \alpha_{ij})$
for some $\alpha_{ij} \in R'$. Note that $R'$ is Noetherian
and that $R' \subset S'$ is a finite extension of rings. Hence we may
replace $R$ by $R'$ and assume that $S$ has a presentation as in
Lemma \ref{lemma-split-image}.
Note that $\text{Spec}(S) \to \text{Spec}(R)$ is surjective, see
Lemma \ref{lemma-integral-overring-surjective}.
Thus, using
Lemma \ref{lemma-split-image}
we conclude that $I = \bigcap J_{\underline{k}}$ is an ideal
such that $V(I) = \text{Spec}(R)$. This means that
$I \subset \sqrt{(0)}$, and since $R$ is Noetherian that $I$
is nilpotent. The maps $\Phi_{\underline{k}}$ induce commutative
diagrams
$$
\xymatrix{
S \ar[rr] & & R/J_{\underline{k}} \\
& R \ar[lu] \ar[ru]
}
$$
from which we conclude that $M/J_{\underline{k}}M$ is flat over
$R/J_{\underline{k}}$. By
Lemma \ref{lemma-intersection-flat}
we see that $M/IM$ is flat over $R/I$. Finally, applying
Lemma \ref{lemma-lift-flatness}
we conclude that $M$ is flat over $R$.
\end{proof}

\begin{lemma}
\label{lemma-descent-flatness-injective-integral}
Let $R \to S$ be an injective integral ring map.
Let $M$ be a finitely presented module over $R[x_1, \ldots, x_n]$.
If $M \otimes_R S$ is flat over $S$, then $M$ is flat over $R$.
\end{lemma}

\begin{proof}
Choose a presentation
$$
R[x_1, \ldots, x_n]^{\oplus t} \to R[x_1, \ldots, x_n]^{\oplus r} \to M \to 0.
$$
Let's say that the first map is given by the $r \times t$-matrix
$T = (f_{ij})$ with $f_{ij} \in R[x_1, \ldots, x_n]$. Write
$f_{ij} = \sum f_{ij, I} x^I$ with $f_{ij, I} \in R$ (multi-index notation).
Consider diagrams
$$
\xymatrix{
R \ar[r] & S \\
R_\lambda \ar[u] \ar[r] & S_\lambda \ar[u]
}
$$
where $R_\lambda$ is a finitely generated $\mathbf{Z}$-subalgebra of
$R$ containing all $f_{ij, I}$ and $S_\lambda$ is a finite
$R_\lambda$-subalgebra of $S$. Let $M_\lambda$ be the finite
$R_\lambda[x_1, \ldots, x_n]$-module defined by a presentation
as above, using the same matrix $T$ but now viewed as a matrix
over $R_\lambda[x_1, \ldots, x_n]$. Note that $S$ is the directed colimit
of the $S_\lambda$ (details omitted). By
Lemma \ref{lemma-flat-finite-presentation-limit-flat}
we see that for some $\lambda$ the module
$M_\lambda \otimes_{R_\lambda} S_\lambda$ is flat over $S_\lambda$. By
Lemma \ref{lemma-descent-flatness-injective-finite-Noetherian-rings}
we conclude that $M_\lambda$ is flat over $R_\lambda$. Since
$M = M_\lambda \otimes_{R_\lambda} R$ we win by
Lemma \ref{lemma-flat-base-change}.
\end{proof}




\section{Torsion and flatness}
\label{section-torsion-flat}

\noindent
In this section we discuss the relationship between torsion and flatness.

\begin{definition}
\label{definition-torsion}
Let $R$ be a domain. Let $M$ be an $R$-module.
\begin{enumerate}
\item We say an element $x \in M$ is {\it torsion} if there exists
a nonzero $f \in R$ such that $fx = 0$.
\item We say $M$ is {\it torsion free} if the only torsion element of $M$
is $0$.
\end{enumerate}
\end{definition}

\begin{lemma}
\label{lemma-torsion}
Let $R$ be a domain. Let $M$ be an $R$-module.
The set of torsion elements of $M$ forms a submodule $M_{tors} \subset M$.
The quotient module $M/M_{tors}$ is torsion free.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-flat-torsion-free}
Let $R$ be a domain. Any flat $R$-module is torsion free.
\end{lemma}

\begin{proof}
If $x \in R$ is nonzero, then $x : R \to R$ is injective, and hence if $M$
is flat over $R$, then $x : M \to M$ is injective. Thus if $M$ is flat over
$R$, then $M$ is torsion free.
\end{proof}

\begin{lemma}
\label{lemma-valuation-ring-torsion-free-flat}
Let $A$ be a valuation ring.
An $A$-module $M$ is flat over $A$ if and only if $M$ is torsion free.
\end{lemma}

\begin{proof}
The implication ``flat $\Rightarrow$ torsion free'' is
Lemma \ref{lemma-flat-torsion-free}.
For the converse, assume $M$ is torsion free.
By the equational criterion of flatness (see
Lemma \ref{lemma-flat-eq})
we have to show that every relation in $M$ is trivial. To do this assume that
$\sum_{i = 1, \ldots, n} a_i x_i = 0$ with $x_i \in M$ and $f_i \in A$.
After renumbering we may assume that $v(a_1) \leq v(a_i)$ for all $i$.
Hence we can write $a_i = a'_i a_1$ for some $a'_i \in A$. Note that
$a'_1 = 1$. As $A$ is torsion free we see that
$x_1 = - \sum_{i \geq 2} a'_i x_i$. Thus, if we choose
$y_i = x_i$, $i = 2, \ldots, n$ then
$$
x_1 = \sum\nolimits_{j \geq 2} -a'_j y_j,\quad
x_i = y_i, (i \geq 2)\quad
0 = a_1 \cdot (-a'_j) + a_j \cdot 1 (j \geq 2)
$$
shows that the relation was trivial (to be explicit the elements
$a_{ij}$ are defined by setting $a_{1j} = -a'_j$ and $a_{ij} = \delta_{ij}$
for $i, j \geq 2$).
\end{proof}






\section{Flatness and finiteness conditions}
\label{section-flat-finite}

\noindent
In this section we discuss implications of the type
``flat $+$ finite type $\Rightarrow$ finite presentation''.
A first result of this type was proved in
Lemma \ref{lemma-finite-flat-module-finitely-presented}.

\begin{lemma}
\label{lemma-flat-finite-type-finite-presentation-local-module}
Let $R$ be a ring. Let $S = R[x_1, \ldots, x_n]$ be a polynomial\
ring over $R$. Let $M$ be an $S$-module.
Assume
\begin{enumerate}
\item there exist finitely many minimal primes
$\mathfrak p_1, \ldots, \mathfrak p_m$ of $R$ such that
the map $R \to \prod R_{\mathfrak p_j}$ is injective,
\item $M$ is a finite $S$-module,
\item $M$ flat over $R$, and
\item for every prime $\mathfrak p$ of $R$ the module $M_{\mathfrak p}$
is of finite presentation over $S_{\mathfrak p}$.
\end{enumerate}
Then $M$ is of finite presentation over $S$.
\end{lemma}

\begin{proof}
Choose a presentation
$$
0 \to K \to S^{\oplus r} \to M \to 0
$$
of $M$ as an $S$-module. Let $\mathfrak q$ be a prime ideal of $S$
lying over the prime $\mathfrak p$ of $R$. By assumption there exist
finitely many elements $k_1, \ldots, k_t \in K$ such that if we set
$K' = \sum Sk_j \subset K$ then
$K'_{\mathfrak p} = K_{\mathfrak p}$ and
$K'_{\mathfrak p_j} = K_{\mathfrak p_j}$ for $j = 1, \ldots, m$.
Setting $M' = S^{\oplus r}/K'$ we deduce that in particular
$M'_{\mathfrak q} = M_{\mathfrak q}$. By openness of flatness, see
Theorem \ref{theorem-openess-flatness}
we conclude that there exists a $g \in S$, $g \not \in \mathfrak q$
such that $M'_g$ is flat over $R$. Thus now $M'_g \to M_g$ is a surjective
map of flat $R$-modules. Consider the commutative diagram
$$
\xymatrix{
M'_g \ar[r] \ar[d] & M_g \ar[d] \\
\prod (M'_g)_{\mathfrak p_j} \ar[r] & \prod (M_g)_{\mathfrak p_j}
}
$$
The bottom arrow is an isomorphism by choice of $k_1, \ldots, k_t$.
The left vertical arrow is an injective map as
$R \to \prod R_{\mathfrak p_j}$ is injective and $M'_g$ is flat over $R$.
Hence the top horizontal arrow is injective, hence an isomorphism.
This proves that $M_g$ is of finite presentation over $S_g$.
We conclude by applying
Lemma \ref{lemma-cover}.
\end{proof}

\begin{lemma}
\label{lemma-flat-finite-type-finite-presentation-local}
Let $R \to S$ be a ring homomorphism.
Assume
\begin{enumerate}
\item there exist finitely many minimal primes
$\mathfrak p_1, \ldots, \mathfrak p_m$ of $R$ such that
the map $R \to \prod R_{\mathfrak p_j}$ is injective,
\item $R \to S$ is of finite type,
\item $S$ flat over $R$, and
\item for every prime $\mathfrak p$ of $R$ the ring $S_{\mathfrak p}$
is of finite presentation over $R_{\mathfrak p}$.
\end{enumerate}
Then $S$ is of finite presentation over $R$.
\end{lemma}

\begin{proof}
By assumption $S$ is a quotient of a polynomial ring over $R$.
Thus the result follows directly from
Lemma \ref{lemma-flat-finite-type-finite-presentation-local-module}.
\end{proof}

\begin{lemma}
\label{lemma-flat-graded-finite-type-finite-presentation-module}
Let $R$ be a ring.
Let $S = R[x_1, \ldots, x_n]$ be a graded polynomial algebra over $R$,
i.e., $\deg(x_i) > 0$ but not necessarily equal to $1$.
Let $M$ be a graded $S$-module.
Assume
\begin{enumerate}
\item $R$ is a local ring,
\item $M$ is a finite $S$-module, and
\item $M$ is flat over $R$.
\end{enumerate}
Then $M$ is finitely presented as an $S$-module.
\end{lemma}

\begin{proof}
Let $M = \bigoplus M_d$ be the grading on $M$.
Pick homogeneous generators $m_1, \ldots, m_r \in M$ of $M$.
Say $\deg(m_i) = d_i \in \mathbf{Z}$. This gives us a presentation
$$
0 \to K \to \bigoplus\nolimits_{i = 1, \ldots, r} S(-d_i) \to M \to 0
$$
which in each degree $d$ leads to the short exact sequence
$$
0 \to K_d \to \bigoplus\nolimits_{i = 1, \ldots, r} S_{d - d_i} \to
M_d \to 0.
$$
By assumption each $M_d$ is a finite flat $R$-module. By
Lemma \ref{lemma-finite-flat-local}
this implies each $M_d$ is a finite free $R$-module. Hence
we see each $K_d$ is a finite $R$-module. Also each $K_d$ is flat
over $R$ by
Lemma \ref{lemma-flat-ses}.
Hence we conclude that each $K_d$ is finite free by 
Lemma \ref{lemma-finite-flat-local}
again.

\medskip\noindent
Let $\mathfrak m$ be the maximal ideal of $R$. By the flatness of $M$
over $R$ the short exact sequences above remain short exact after tensoring
with $\kappa = \kappa(\mathfrak m)$. As the ring $S \otimes_R \kappa$ is
Noetherian we see that there exist homogeneous elements
$k_1, \ldots, k_t \in K$ such that the images $\overline{k}_j$
generate $K \otimes_R \kappa$ over $S \otimes_R \kappa$. Say $\deg(k_j) = e_j$.
Thus for any $d$ the map
$$
\bigoplus\nolimits_{j = 1, \ldots, t} S_{d - e_j}
\longrightarrow
K_d
$$
becomes surjective after tensoring with $\kappa$. By
Nakayama's Lemma \ref{lemma-NAK}
this implies the map is surjective over $R$. Hence $K$ is generated
by $k_1, \ldots, k_t$ over $S$ and we win.
\end{proof}

\begin{lemma}
\label{lemma-flat-graded-finite-type-finite-presentation}
Let $R$ be a ring.
Let $S = \bigoplus S_n$ be a graded $R$-algebra.
Assume
\begin{enumerate}
\item $R$ is a local ring,
\item $S_0 = R$,
\item $S$ is finitely generated over $R$, and
\item $S$ is flat over $R$.
\end{enumerate}
Then $S$ is finitely presented as an $R$-algebra.
\end{lemma}

\begin{proof}
The assumptions imply that $S$ is a quotient of a graded polynomial
ring $R[x_1, \ldots, x_n]$ with $\deg(x_i) = d_i \in \mathbf{N}$.
Thus the result follows on applying
Lemma \ref{lemma-flat-graded-finite-type-finite-presentation-module}
with $M = S$.
\end{proof}

\noindent
The following lemma wil be improved below, see
Proposition \ref{proposition-flat-finite-type-finite-presentation-domain}.

\begin{lemma}
\label{lemma-flat-finite-type-valuation-ring-finite-presentation}
Let $A$ be a valuation ring. Let $A \to B$ be a ring map of finite type.
Let $M$ be a finite $B$-module.
\begin{enumerate}
\item If $B$ is flat over $A$, then $B$ is a finitely presented $A$-algebra.
\item If $M$ is flat as an $A$-module, then $M$ is finitely presented
as a $B$-module.
\end{enumerate}
\end{lemma}

\begin{proof}
We are going to use that an $A$-module is flat if and only if it is
torsion free, see
Lemma \ref{lemma-valuation-ring-torsion-free-flat}.
By
Lemma \ref{lemma-homogenize}
we can find a graded $A$-algebra $S$ with $S_0 = A$ and generated
by finitely many elements in degree $1$, an element $f \in S_1$ and a
finite graded $S$-module $N$ such that $B \cong S_{(f)}$ and
$M \cong N_{(f)}$. If $M$ is torsion free, then we can take $N$ torsion
free by replacing it by $N/N_{tors}$, see
Lemma \ref{lemma-torsion}.
Similarly, if $B$ is torsion free, then we can take
$S$ torsion free by replacing it by $S/S_{tors}$.
Hence in case (1), we may apply
Lemma \ref{lemma-flat-graded-finite-type-finite-presentation}
to see that $S$ is a finitely presented
$A$-algebra, which implies that $B = S_{(f)}$ is a finitely
presented $A$-algebra. To see (2) we may first replace $S$ by
a graded polynomial ring, and then we may apply
Lemma \ref{lemma-flat-graded-finite-type-finite-presentation-module}
to conclude.
\end{proof}

\begin{lemma}
\label{lemma-helper-finite-type-flat-finite-presentation}
Let $R$ be a domain with fraction field $K$.
Let $S = R[x_1, \ldots, x_n]$ be a polynomial ring over $R$.
Let $M$ be a finite $S$-module. Assume that $M$ is flat over $R$.
If for every subring $R \subset R' \subset K$, $R \not = R'$
the module $M \otimes_R R'$ is finitely presented
over $S \otimes_R R'$, then $M$ is finitely presented over $S$.
\end{lemma}

\begin{proof}
Suppose that $f_1, \ldots, f_n \in R$ are elements which generate the
unit ideal. If $R \not = R_{f_i}$ for each $i = 1, \ldots, n$, then
we conclude that $M_{f_i}$ is finitely presented over
$S_{f_i}$ for each $i$, and hence $M$ is finitely presented over $S$ by
Lemma \ref{lemma-cover}.
Thus we are done if such a sequence of elements exists.
Assume this is not the case. In particular, for every $x \in R$ we
have either $x \in R^*$, or $1 - x \in R^*$. This implies that $R$ is
local, see
Lemma \ref{lemma-characterize-local-ring}.

\medskip\noindent
Choose a presentation
$$
0 \to K \to R[x_1, \ldots, x_n]^{\oplus r} \to M \to 0.
$$
Throughout the rest of the proof we will use that this sequence stays exact
after tensoring with any $R$-algebra, see
Lemma \ref{lemma-flat-tor-zero}.
Let $R'$ be the integral closure of $R$ in its fraction field.
If $R \not = R'$, then we see that $M \otimes_R R'$ is finitely presented over
$R'[x_1, \ldots, x_n]$. In particular, the module $K \otimes_R R'$
is finitely generated. Thus we may pick $k_1, \ldots, k_t \in K$ such that
$k_1 \otimes 1, \ldots, k_t \otimes 1$ generate $K \otimes_R R'$.
Set $K' = \sum R[x_1, \ldots, x_n]k_i \subset K$. Set
$M' = R[x_1, \ldots, x_n]^{\oplus t}/K'$. Then $M'$ is a finitely presented
module over $R[x_1, \ldots, x_n]$ such that
$M' \otimes_R R' \cong M \otimes_R R'$ is flat over $R'$. By
Lemma \ref{lemma-descent-flatness-injective-integral}
we conclude that $M'$ is flat over $R$. Hence the surjective
map $M' \to M$ is also injective as $M'$ is torsion free, see
Lemma \ref{lemma-flat-torsion-free}.
In other words, $M' \cong M$ and we conclude that $M$ is finitely presented.
Thus we are done if $R$ is not a normal domain.
Assume this is not the case. This reduces us to the case where $R$ is
a normal local domain.

\medskip\noindent
Pick any pair of nonzero elements $x, y \in R$. Consider the inclusions
$R \subset R[x/y]$ and $R[y/x]$. As $R$ is a normal domain we get a short
exact sequence
$$
0 \to R \xrightarrow{(-1, 1)} R[x/y] \oplus R[y/x] \xrightarrow{(1, 1)}
R[x/y, y/x] \to 0
$$
see
Lemma \ref{lemma-silly-normal}.
If $R \not = R[x/y]$ and $R \not = R[y/x]$ then we see that
$K \otimes_R R[x/y]$ and $K \otimes_R R[y/x]$ are finitely generated
as $R[x/y][x_1, \ldots, x_n]$ and $R[y/x][x_1, \ldots, x_n]$ modules.
Thus we can find $k_1, \ldots, k_t \in K$ such that the elements
$k_i \otimes 1$ generate
$K \otimes_R R[x/y]$ and $K \otimes_R R[y/x]$ as $R[x/y][x_1, \ldots, x_n]$
and $R[y/x][x_1, \ldots, x_n]$ modules.
Set $K' = \sum R[x_1, \ldots, x_n]k_i \subset K$. Tensoring the sequence
above with $K' \subset K$ we get the diagram
$$
\xymatrix{
 &
K' \ar[d] \ar[r] &
K' \otimes_R R[x/y] \oplus K' \otimes_R R[y/x] \ar[d] \ar[r] &
K' \otimes_R R[x/y, y/x] \ar[d] \ar[r] &
0 \\
0 \ar[r] &
K \ar[r] &
K \otimes_R R[x/y] \oplus K \otimes_R R[y/x] \ar[r] &
K \otimes_R R[x/y, y/x] \ar[r] &
0
}
$$
Now we know that the vertical arrows in the middle and on the right
are isomorphisms. The lower row is exact as $K$ is flat over $R$.
Hence the left vertical arrow is surjective, i.e., an isomorphism.
Thus we win if there exists a pair of nonzero elements such that
neither $x/y$ nor $y/x$ is an element of $R$. Assume this is not the case.
Then we know that $R \subset f.f.(R)$ is a normal local domain such
that for every $x \in f.f.(R)$ either $x \in R$, or $x^{-1} \in R$.
In other words, $R$ is a valuation ring, see
Lemma \ref{lemma-x-or-x-inverse-valuation-ring}.
In this case $M$ is finitely presented by
Lemma \ref{lemma-flat-finite-type-valuation-ring-finite-presentation}
and we win.
\end{proof}

\noindent
The following result can be found in \cite{GruRay}.

\begin{proposition}
\label{proposition-flat-finite-type-finite-presentation-domain}
Let $R$ be a domain.
Let $R \to S$ be a ring map of finite type.
Let $M$ be a finite $S$-module.
\begin{enumerate}
\item If $S$ is flat over $R$, then $S$ is a finitely presented $R$-algebra.
\item If $M$ is flat as an $R$-module, then $M$ is finitely presented
as a $S$-module.
\end{enumerate}
\end{proposition}

\begin{proof}
It suffices to prove part (2) in case $S = R[x_1, \ldots, x_n]$.
Choose a presentation
$$
0 \to K \to R[x_1, \ldots, x_n]^{\oplus r} \to M \to 0.
$$
Throughout the rest of the proof we will use that this sequence stays exact
after tensoring with any $R$-algebra, see
Lemma \ref{lemma-flat-tor-zero}.
Let $L$ be the fraction field of $R$.
Consider the set
$$
\mathcal{R} = \{R' \mid
R \subset R' \subset L
\text{ and }
M \otimes_R R'
\text{ not of finite presentation over }
S \otimes_R R'\}
$$
We order $\mathcal{R}$ by inclusion. Suppose that
$\{R_i\}_{i \in I}$ is a totally ordered subset of $\mathcal{R}$.
Set $R_{\infty} = \bigcup_{i \in I} R_i$.
We claim that $R_\infty \in \mathcal{R}$.
Namely, if $M \otimes_R R_{\infty}$ is finitely presented over
$S \otimes_R R_\infty$, then $K \otimes_R R_\infty$ is finitely
generated, say by $k_1, \ldots, k_t$. Then for some $i\in I$
we have $k_1, \ldots, k_t \in K \otimes_R R_i$. For any
$i' \geq i$ set
$M_{i'} = R_i[x_1, \ldots, x_n]^{\oplus r}/\sum R_i[x_1, \ldots, x_n]k_i$.
By
Lemma \ref{lemma-flat-finite-presentation-limit-flat}
we see that $M_{i'}$ is flat over $R_i$ for some sufficiently large
$i' \in I$. For such an $i'$ the surjective map
$M_{i'} \to M \otimes_R R_i$ is also injective as
$M_{i'}$ is torsion free. Hence we conclude that
$M \otimes_R R_i$ is finitely presented which is a contradiction.
In other words $R_\infty \in \mathcal{R}$.
This shows that Zorn's lemma applies to $\mathcal{R}$ if $\mathcal{R}$
is not empty. But
Lemma \ref{lemma-helper-finite-type-flat-finite-presentation}
shows that $\mathcal{R}$ does not have any maximal elements and the
proposition is proved.
\end{proof}




\section{Blowing up and flatness}
\label{section-blowup-flat}

\noindent
In this section we begin our discussion of results of the form: ``After a
blow up the strict transform becomes flat''.

\begin{definition}
\label{definition-strict-transform}
Let $R$ be a domain.
Let $M$ be an $R$-module.
Let $R \subset R'$ be an extension of domains.
The {\it strict transform of $M$ along $R \to R'$} is
the torsion free $R'$-module
$$
M' = (M \otimes_R R')/(M \otimes_R R')_{tors}.
$$
\end{definition}

\noindent
The following is a very weak version of flattening by blowing up, but
it is already sometimes a useful result.

\begin{lemma}
\label{lemma-flatten-on-affine-blowup}
Let $(R, \mathfrak m)$ be a local domain with fraction field $K$.
Let $S$ be a finite type $R$-algebra.
Let $M$ be a finite $S$-module.
For every valuation ring $A \subset K$ dominating $R$
there exists an ideal $I \subset \mathfrak m$ and a nonzero
element $a \in I$ such that
\begin{enumerate}
\item $I$ is finitely generated,
\item $A$ has center on $R[\frac{I}{a}]$,
\item the fibre ring of $R \to R[\frac{I}{a}]$ at $\mathfrak m$
is not zero, and
\item the strict transform $S_{I, a}$ of $S$ along $R \to R[\frac{I}{a}]$
is flat and of finite presentation over $R$, and the strict transform
$M_{I, a}$ of $M$ along $R \to R[\frac{I}{a}]$ is flat over $R$ and
finitely presented over $S_{I, a}$.
\end{enumerate}
\end{lemma}

\begin{proof}
Note that the assertion makes sense as $R[\frac{I}{a}]$
is a domain, and $R \to R[\frac{I}{a}]$ is injective, see
Lemmas \ref{lemma-blowup-domain} and \ref{lemma-blowup-dominant}.
Before we start the proof of the Lemma, note that there is
no loss in generality assuming that $S = R[x_1, \ldots, x_n]$
is a polynomial ring over $R$. We also fix a presentation
$$
0 \to K \to S^{\oplus r} \to M \to 0.
$$
Let $M_A$ be the strict transform of $M$ along $R \to A$. It is a finite
module over $S_A = A[x_1, \ldots, x_n]$. By
Lemma \ref{lemma-valuation-ring-torsion-free-flat}
we see that $M_A$ is flat over $A$. By
Lemma \ref{lemma-flat-finite-type-valuation-ring-finite-presentation}
we see that $M_A$ is finitely presented. Hence there exist finitely many
elements $k_1, \ldots, k_t \in S_A^{\oplus r}$ which generate the
kernel of the presentation $S_A^{\oplus r} \to M_A$ as
an $S_A$-module. For any choice of $a \in I \subset \mathfrak m$
satisfying (1), (2), and (3) we denote $M_{I, a}$ the strict transform of
$M$ along $R \to R[\frac{I}{a}]$. It is a finite module over
$S_{I, a} = R[\frac{I}{a}][x_1, \ldots, x_n]$. By
Lemma \ref{lemma-valuation-ring-colimit-affine-blowups}
we have $A = \text{colim}_{I, a}\ R[\frac{I}{a}]$.
This implies that $S_A = \text{colim}\ S_{I, a}$ and
$M_A = \text{colim}_{I, a}\ M_{I, a}$.
Thus we may choose $a \in I \subset R$ such that
$k_1, \ldots, k_t$ are elements of $S_{I, a}^{\oplus r}$ and
map to zero in $M_{I, a}$. For any such pair $(I, a)$ we set
$$
M'_{I, a} = S_{I, a}^{\oplus r}/ \sum S_{I, a}k_j.
$$
Since $M_A = S_A^{\oplus r}/ \sum S_Ak_j$ we see that also
$M_A = \text{colim}_{I, a}\ M'_{I, a}$.
At this point we may apply
Lemma \ref{lemma-flat-finite-presentation-limit-flat} (3)
to conclude that $M'_{I, a}$ is flat for some pair $(I, a)$.
(This lemma does not apply a priori to the system $M_{I, a}$
as the transition maps may not satisfy the assumptions of the lemma.)
Since flatness implies torsion free (
Lemma \ref{lemma-flat-torsion-free}),
we also conclude that $M'_{I, a} = M_{I, a}$ for such a pair and we win.
\end{proof}









\section{Openness of Cohen-Macaulay loci}
\label{section-CM-open}

\noindent
In this section we characterize the Cohen-Macaulay property
of finite type algebras in terms of flatness. We then use this
to prove the set of points where such an algebra is Cohen-Macaulay
is open.

\begin{lemma}
\label{lemma-where-CM}
Let $S$ be a finite type algebra over a field $k$.
Let $\varphi : k[y_1, \ldots, y_d] \to S$ be a finite ring map.
As subsets of $\text{Spec}(S)$ we have
$$
\{ \mathfrak q \mid
S_{\mathfrak q} \text{ flat over }k[y_1, \ldots, y_d]\}
=
\{ \mathfrak q \mid
S_{\mathfrak q} \text{ CM and }\dim_{\mathfrak q}(S/k) = d\}
$$
For notation see Definition \ref{definition-relative-dimension}.
\end{lemma}

\begin{proof}
Let $\mathfrak q \subset S$ be a prime. Denote
$\mathfrak p = k[y_1, \ldots, y_d] \cap \mathfrak q$.
Note that always
$\dim(S_{\mathfrak q}) \leq \dim(k[y_1, \ldots, y_d]_{\mathfrak p})$
by Lemma \ref{lemma-dimension-inequality-quasi-finite} for example.
Moreover, the field extension $\kappa(\mathfrak p) \subset \kappa(\mathfrak q)$
is finite and hence
$\text{trdeg}_k(\kappa(\mathfrak p)) = \text{trdeg}_k(\kappa(\mathfrak q))$.

\medskip\noindent
Let $\mathfrak q$ be an element of the left hand side.
Then Lemma \ref{lemma-finite-flat-over-regular-CM} applies
and we conclude that $S_{\mathfrak q}$ is Cohen-Macaulay
and $\dim(S_{\mathfrak q}) = \dim(k[y_1, \ldots, y_d]_{\mathfrak p})$.
Combined with the equality of transcendence degrees above and
Lemma \ref{lemma-dimension-at-a-point-finite-type-field} this
implies that $\dim_{\mathfrak q}(S/k) = d$. Hence $\mathfrak q$
is an element of the right hand side.

\medskip\noindent
Let $\mathfrak q$ be an element of the right hand side.
By the equality of transcendence degrees above, the assumption
that $\dim_{\mathfrak q}(S/k) = d$ and
Lemma \ref{lemma-dimension-at-a-point-finite-type-field}
we conclude that
$\dim(S_{\mathfrak q}) = \dim(k[y_1, \ldots, y_d]_{\mathfrak p})$.
Hence Lemma \ref{lemma-CM-over-regular-flat}
applies and we see that $\mathfrak q$ is an
element of the left hand side.
\end{proof}

\begin{lemma}
\label{lemma-finite-type-over-field-CM-open}
Let $S$ be a finite type algebra over a field $k$.
The set of primes $\mathfrak q$ such that $S_{\mathfrak q}$ is
Cohen-Macaulay is open in $S$.
\end{lemma}

\noindent
This lemma is a special case of
Lemma \ref{lemma-finite-presentation-flat-CM-locus-open} below,
so you can skip straight to the proof of that lemma if you like.

\begin{proof}
Let $\mathfrak q \subset S$ be a prime such that $S_{\mathfrak q}$ is
Cohen-Macaulay. We have to show there exists a
$g \in S$, $g \not \in \mathfrak q$ such that the ring
$S_g$ is Cohen-Macaulay. For any $g \in S$, $g \not \in \mathfrak q$
we may replace $S$ by $S_g$ and $\mathfrak q$ by $\mathfrak qS_g$.
Combining this with
Lemmas \ref{lemma-Noether-normalization-at-point} and
\ref{lemma-dimension-at-a-point-finite-type-field}
we may assume that there exists a finite injective
ring map $k[y_1, \ldots, y_d] \to S$ with
$d = \dim(S_{\mathfrak q}) + \text{trdeg}_k(\kappa(\mathfrak q))$.
Set $\mathfrak p = k[y_1, \ldots, y_d] \cap \mathfrak q$.
By construction we see that $\mathfrak q$ is an element of
the right hand side of the displayed equality of
Lemma \ref{lemma-where-CM}. Hence it is also an element of
the left hand side.

\medskip\noindent
By Theorem \ref{theorem-openess-flatness} we see that for some $g \in S$,
$g \not \in \mathfrak q$ the ring $S_g$ is flat over $k[y_1, \ldots, y_d]$.
Hence by the equality of Lemma \ref{lemma-where-CM} again we conclude that
all local rings of $S_g$ are Cohen-Macaulay as desired.
\end{proof}

\begin{lemma}
\label{lemma-generic-CM}
Let $k$ be a field. Let $S$ be a finite type $k$ algebra.
The set of Cohen-Macaulay primes forms a dense open
$U \subset \text{Spec}(S)$.
\end{lemma}

\begin{proof}
The set is open by Lemma \ref{lemma-finite-type-over-field-CM-open} above.
It contains all minimal primes $\mathfrak q \subset S$
since the local ring at a minimal prime $S_{\mathfrak q}$
has dimension zero and hence is Cohen-Macaulay.
\end{proof}

\begin{lemma}
\label{lemma-finite-presentation-flat-CM-locus-open}
Let $R$ be a ring. Let $R \to S$ be of finite presentation
and flat. For any $d \geq 0$ the set
$$
\left\{
\begin{matrix}
\mathfrak q \in \text{Spec}(S)
\text{ such that setting }\mathfrak p = R \cap \mathfrak q
\text{ the fibre ring}\\
S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}
\text{ is Cohen-Macaulay}
\text{ and } \dim_{\mathfrak q}(S/R) = d
\end{matrix}
\right\}
$$
is open in $\text{Spec}(S)$.
\end{lemma}

\begin{proof}
Let $\mathfrak q$ be an element of the set indicated, with
$\mathfrak p$ the corresponding prime of $R$.
We have to find a $g \in S$, $g \not \in \mathfrak q$ such that
all fibre rings of $R \to S_g$ are Cohen-Macaulay.
During the course of the proof we may (finitely many times)
replace $S$ by $S_g$ for a $g \in S$, $g \not \in \mathfrak q$.
Thus by Lemma \ref{lemma-quasi-finite-over-polynomial-algebra}
we may assume there is a quasi-finite ring map
$R[t_1, \ldots, t_d] \to S$ with $d = \dim_{\mathfrak q}(S/R)$.
Let $\mathfrak q' = R[t_1, \ldots, t_d] \cap \mathfrak q$.
By Lemma \ref{lemma-where-CM} we see that the ring map
$$
R[t_1, \ldots, t_d]_{\mathfrak q'} /
\mathfrak p R[t_1, \ldots, t_d]_{\mathfrak q'}
\longrightarrow
S_{\mathfrak q}/\mathfrak p S_{\mathfrak q}
$$
is flat. Hence by the crit\`ere de platitude par fibres
Lemma \ref{lemma-criterion-flatness-fibre} we see that
$R[t_1, \ldots, t_d]_{\mathfrak q'} \to S_{\mathfrak q}$ is flat.
Hence by Theorem \ref{theorem-openess-flatness} we see that
for some $g \in S$, $g \not \in \mathfrak q$ the ring map
$R[t_1, \ldots, t_d] \to S_g$ is flat. Replacing $S$ by $S_g$
we see that for every prime $\mathfrak r \subset S$,
setting $\mathfrak r' = R[t_1, \ldots, t_d] \cap \mathfrak r$
and $\mathfrak p' = R \cap \mathfrak r$
the local ring map
$R[t_1, \ldots, t_d]_{\mathfrak r'} \to S_{\mathfrak r}$ is flat.
Hence also the base change
$$
R[t_1, \ldots, t_d]_{\mathfrak r'} /
\mathfrak p' R[t_1, \ldots, t_d]_{\mathfrak r'}
\longrightarrow
S_{\mathfrak r}/\mathfrak p' S_{\mathfrak r}
$$
is flat. Hence by Lemma \ref{lemma-where-CM} applied with
$k = \kappa(\mathfrak p')$ we see
$\mathfrak r$ is in the set of the lemma
as desired.
\end{proof}

\begin{lemma}
\label{lemma-generic-CM-flat-finite-presentation}
Let $R$ be a ring. Let $R \to S$ be flat of finite presentation.
The set of primes $\mathfrak q$ such that the fibre ring
$S_{\mathfrak q} \otimes_R \kappa(\mathfrak p)$,
with $\mathfrak p = R \cap \mathfrak q$ is Cohen-Macaulay
is open and dense in every fibre of $\text{Spec}(S) \to \text{Spec}(R)$.
\end{lemma}

\begin{proof}
The set, call it $W$, is open by
Lemma \ref{lemma-finite-presentation-flat-CM-locus-open} above.
It is dense in the fibres because the intersection of $W$
with a fibre is the corresponding set of the fibre
to which Lemma \ref{lemma-generic-CM} applies.
\end{proof}

\begin{lemma}
\label{lemma-extend-field-CM-locus}
Let $k$ be a field. Let $S$ be a finite type $k$-algebra.
Let $k \subset K$ be a field extension, and set $S_K = K\otimes_k S$.
Let $\mathfrak q \subset S$ be a prime of $S$.
Let $\mathfrak q_K \subset S_K$ be a prime of $S_K$ lying
over $\mathfrak q$. Then $S_{\mathfrak q}$ is Cohen-Macaulay
if and only if $(S_K)_{\mathfrak q_K}$ is Cohen-Macaulay.
\end{lemma}

\begin{proof}
During the course of the proof we may (finitely many times) replace
$S$ by $S_g$ for any $g \in S$, $g \not \in \mathfrak q$. Hence
using Lemma \ref{lemma-Noether-normalization-at-point} we may
assume that $\dim(S) = \dim_{\mathfrak q}(S/k) =: d$ and
find a finite injective map $k[x_1, \ldots, x_d] \to S$.
Note that this also induces a finite injective map
$K[x_1, \ldots, x_d] \to S_K$ by base change.
By Lemma \ref{lemma-dimension-at-a-point-preserved-field-extension}
we have $\dim_{\mathfrak q_K}(S_K/K) = d$.
Set $\mathfrak p = k[x_1, \ldots, x_d] \cap \mathfrak q$
and $\mathfrak p_K = K[x_1, \ldots, x_d] \cap \mathfrak q_K$.
Consider the following commutative diagram of Noetherian local
rings
$$
\xymatrix{
S_{\mathfrak q} \ar[r] &
(S_K)_{\mathfrak q_K} \\
k[x_1, \ldots, x_d]_{\mathfrak p} \ar[r] \ar[u] &
K[x_1, \ldots, x_d]_{\mathfrak p_K} \ar[u]
}
$$
By Lemma \ref{lemma-where-CM} above we have to show that
the left vertical arrow is flat if and only if the right
vertical arrow is flat. Because the bottom arrow is flat
this equivalence holds by Lemma \ref{lemma-base-change-flat-up-down}.
\end{proof}

\begin{lemma}
\label{lemma-CM-locus-commutes-base-change}
Let $R$ be a ring. Let $R \to S$ be of finite type.
Let $R \to R'$ be any ring map. Set $S' = R' \otimes_R S$.
Denote $f : \text{Spec}(S') \to \text{Spec}(S)$ the map
associated to the ring map $S \to S'$.
Set $W$ equal to the
set of primes $\mathfrak q$ such that the fibre ring
$S_{\mathfrak q} \otimes_R \kappa(\mathfrak p)$,
$\mathfrak p = R \cap \mathfrak q$ is Cohen-Macaulay,
and let $W'$ denote the analogue for $S'/R'$. Then
$W' = f^{-1}(W)$.
\end{lemma}

\begin{proof}
Trivial from Lemma \ref{lemma-extend-field-CM-locus} and the definitions.
\end{proof}

\begin{lemma}
\label{lemma-relative-dimension-CM}
Let $R$ be a ring. Let $R \to S$ be a ring map
which is (a) flat, (b) of finite presentation, (c) has
Cohen-Macaulay fibres. Then $S = S_0 \times \ldots \times S_n$
is a product of rings $S_d$ such that each $S_d$ satisfies
(a), (b), (c) and has all fibres equidimensional of dimension $d$.
\end{lemma}

\begin{proof}
For each integer $d$ denote $W_d \subset \text{Spec}(S)$ the set
defined in Lemma \ref{lemma-finite-presentation-flat-CM-locus-open}.
Clearly we have $\text{Spec}(S) = \coprod W_d$, and each $W_d$
is open by the lemma we just quoted. Hence the result follows
from Lemma \ref{lemma-disjoint-implies-product}.
\end{proof}

\begin{lemma}
\label{lemma-fppf-fpqf}
Let $R \to S$ be a faithfully flat ring map of finite presentation.
Then there exists a commutative diagram
$$
\xymatrix{
S \ar[rr] & & S' \\
& R \ar[lu] \ar[ru]
}
$$
where $R \to S'$ is quasi-finite, faithfully flat and of finite presentation.
\end{lemma}

\begin{proof}
As a first step we reduce this lemma to the case where $R$ is of finite
type over $\mathbf{Z}$.
By Lemma \ref{lemma-descend-faithfully-flat-finite-presentation}
there exists a diagram
$$
\xymatrix{
S_0 \ar[r] & S \\
R_0 \ar[u] \ar[r] & R \ar[u]
}
$$
where $R_0$ is of finite type over $\mathbf{Z}$,
and $S_0$ is faithfully flat of finite presentation over $R_0$
such that $S = R \otimes_{R_0} S_0$.
If we prove the lemma for the ring map $R_0 \to S_0$, then the lemma
follows for $R \to S$ by base change, as the base change of
a quasi-finite ring map is quasi-finite, see
Lemma \ref{lemma-quasi-finite-base-change}. (Of course we
also use that base changes of flat maps are flat and
base changes of maps of finite presentation are of finite presentation.)

\medskip\noindent
Assume $R \to S$ is a faithfully flat ring map of finite presentation
and that $R$ is Noetherian (which we may assume by the preceding
paragraph). Let $W \subset \text{Spec}(S)$ be the open set of
Lemma \ref{lemma-finite-presentation-flat-CM-locus-open}.
As $R \to S$ is faithfully flat the map $\text{Spec}(S) \to \text{Spec}(R)$
is surjective, see Lemma \ref{lemma-ff-rings}.
By Lemma \ref{lemma-generic-CM-flat-finite-presentation}
the map $W \to \text{Spec}(R)$ is also surjective.
Hence by replacing $S$ with a product $S_{g_1} \times \ldots \times S_{g_m}$
we may assume $W = \text{Spec}(S)$; here we use that $\text{Spec}(R)$
is quasi-compact (Lemma \ref{lemma-quasicompact}), and that the map
$\text{Spec}(S) \to \text{Spec}(R)$ is open
(Proposition \ref{proposition-fppf-open}).
Suppose that $\mathfrak p \subset R$ is a prime. Choose a prime
$\mathfrak q \subset S$ lying over $\mathfrak p$ which corresponds
to a maximal ideal of the fibre ring $S \otimes_R \kappa(\mathfrak p)$.
The Noetherian local ring
$\overline{S}_{\mathfrak q} = S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}$
is Cohen-Macaulay, say of dimension $d$. We may choose $f_1, \ldots, f_d$
in the maximal ideal of $S_{\mathfrak q}$ which map to a regular sequence
in $\overline{S}_{\mathfrak q}$. Choose a common denominator
$g \in S$, $g \not \in \mathfrak q$ of $f_1, \ldots, f_d$, and consider
the $R$-algebra
$$
S' = S_g/(f_1, \ldots, f_d).
$$
By construction there is a prime ideal $\mathfrak q' \subset S'$
lying over $\mathfrak p$ and corresponding to $\mathfrak q$ (via
$S_g \to S'_g$). Also by construction the ring map $R \to S'$ is
quasi-finite at $\mathfrak q$ as the local ring
$$
S'_{\mathfrak q'}/\mathfrak pS'_{\mathfrak q'} =
S_{\mathfrak q}/(f_1, \ldots, f_d) + \mathfrak pS_{\mathfrak q} =
\overline{S}_{\mathfrak q}/(\overline{f}_1, \ldots, \overline{f}_d)
$$
has dimension zero, see Lemma \ref{lemma-isolated-point-fibre}.
Also by construction $R \to S'$ is of finite presentation.
Finally, by Lemma \ref{lemma-grothendieck-regular-sequence} the local ring map
$R_{\mathfrak p} \to S'_{\mathfrak q'}$ is flat (this is where we
use that $R$ is Noetherian). Hence, by openness of flatness
(Theorem \ref{theorem-openess-flatness}), and openness of quasi-finiteness
(Lemma \ref{lemma-quasi-finite-open})
we may after replacing
$g$ by $gg'$ for a suitable $g' \in S$, $g' \not \in \mathfrak q$
assume that $R \to S'$ is flat and quasi-finite.
The image $\text{Spec}(S') \to \text{Spec}(R)$ is open and
contains $\mathfrak p$. In other words we have shown
a ring $S'$ as in the statement of the lemma exists (except possibly
the faithfulness part) whose image contains any given prime.
Using one more time the quasi-compactness of $\text{Spec}(R)$
we see that a finite product of such rings does the job.
\end{proof}















\section{Differentials}
\label{section-differentials}

\begin{definition}
\label{definition-derivation}
Let $\varphi : R \to S$ be a ring map and let $M$ be an $S$-module.
A {\it derivation}, or more precisely an
{\it $R$-derivation} into $M$ is a map $D : S \to M$
which is additive, annihilates elements of $\varphi(R)$,
and satisfies the {\it Leibniz rule}:
$D(ab) = aD(b) + D(a)b$.
\end{definition}

\noindent
Note that $D(ra) = rD(a)$ if $r\in R$ and $a\in S$.
The set of all $R$-derivations forms an
$S$-module: Given two $R$-derivations $D, D'$
the sum $D + D' : S \to M$, $a \mapsto D(a)+D'(a)$
is an $R$-derivation, and given an $R$-derivation $D$
and an element $c\in S$ the scalar multiple $cD : S \to M$,
$a \mapsto cD(a)$ is an $R$-derivation. We denote this
$S$-module
$$
\text{Der}_R(S, M).
$$
Also, if $\alpha : M \to N$ is an $S$-module map, then the
composition $\alpha \circ D$ is an $R$-derivation into
$N$. In this way the assignment $M \mapsto \text{Der}_R(S, M)$
is a covariant functor.

\medskip\noindent
Consider the following map of $S$-modules:
\begin{align*}
\bigoplus_{(a, b)\in S^2} S[(a, b)] & \oplus &
\bigoplus_{(f, g)\in S^2} S[(f, g)] & \oplus &
\bigoplus_{r\in R} S[r] &
\longrightarrow &
\bigoplus_{a\in S} S[a] \\
[(a, b)] & & & & & \longmapsto & [a + b] - [a] - [b] \\
& & [(f, g)] & & & \longmapsto & [fg] -f[g] - g[f] \\
& & & & [r] & \longmapsto & [\varphi(r)]
\end{align*}
with obvious notation. Let $\Omega_{S/R}$ be the cokernel of this map.
There is a map $\text{d} : S \to \Omega_{S/R}$
which maps $a$ to the class $\text{d}a$ of $[a]$ in the cokernel.
This is an $R$-derivation by the relations imposed on $\Omega_{S/R}$.
The pair $(\Omega_{S/R}, \text{d})$ is called the module
of K\"ahler diffentials of $S$ over $R$.

\begin{lemma}
\label{lemma-universal-omega}
The module of differentials of $S$ over $R$ has the following
universal property. The map
$$
\text{Hom}_S(\Omega_{S/R}, M)
\longrightarrow
\text{Der}_R(S, M), \ \ 
\alpha
\longmapsto
\alpha \circ \text{d}
$$
is an isomorphism of functors.
\end{lemma}

\begin{proof}
By definition an $R$-derivation is a rule which associates
to each $a \in S$ an element $D(a) \in M$. Thus $D$ gives
rise to a map $[D] : \bigoplus S[a] \to M$. However, the conditions
of being an $R$-derivation exactly mean that $[D]$ annihilates
the image of the map in the displayed presentation of
$\Omega_{S/R}$ above.
\end{proof}

\begin{lemma}
\label{lemma-colimit-differentials}
Let $I$ be a directed partially ordered set.
Let $(R_i \to S_i, \varphi_{ii'})$ be a system of
ring maps over $I$, see
Categories, Section \ref{categories-section-posets-limits}.
Then we have
$$
\Omega_{S/R} =
\text{colim}_i\ \Omega_{S_i/R_i}.
$$
\end{lemma}

\begin{proof}
This is clear from the presentation of $\Omega_{S/R}$ given above.
\end{proof}


\begin{lemma}
\label{lemma-trivial-differential-surjective}
Suppose that $R \to S$ is surjective.
Then $\Omega_{S/R} = 0$.
\end{lemma}

\begin{proof}
You can see this either because all $R$-derivations
clearly have to be zero, or because
the map in the presentation of $\Omega_{S/R}$ is surjective.
\end{proof}

\noindent
Suppose that
\begin{equation}
\label{equation-functorial-omega}
\xymatrix{
S \ar[r]_\varphi
&
S'
\\
R \ar[r]^\psi \ar[u]^\alpha
&
R' \ar[u]_\beta
}
\end{equation}
is a commutative diagram of rings. In this case there is a
natural map of modules of differentials fitting into the
commutative diagram
$$
\xymatrix{
\Omega_{S/R} \ar[r] &
\Omega_{S'/R'}
\\
S \ar[u]^{\text{d}} \ar[r]
&
S' \ar[u]_{\text{d}}
}
$$
To construct the map just use the obvious map
between the presentations for $\Omega_{S/R}$ and $\Omega_{S'/R'}$.
Namely,
$$
\xymatrix{
\bigoplus S'[(a', b')]
\oplus
\bigoplus S'[(f', g')]
\oplus
\bigoplus S'[r'] \ar[r]
&
\bigoplus S' [a'] \\
 \\
\bigoplus S[(a, b)]
\oplus
\bigoplus S[(f, g)]
\oplus
\bigoplus S[r] \ar[r]
\ar[uu]^{
\begin{matrix}
[(a, b)] \mapsto [(\varphi(a), \varphi(b)] \\
[(f, g)] \mapsto [(\varphi(f), \varphi(g)] \\
[r]\mapsto [\psi(r)]
\end{matrix}
} &
\bigoplus S[a] \ar[uu]_{[a] \mapsto [\varphi(a)]}
}
$$
The result is simply that $f\text{d}g \in \Omega_{S/R}$ is
mapped to $\varphi(f)\text{d}\varphi(g)$.

\begin{lemma}
\label{lemma-differential-surjective}
In diagram (\ref{equation-functorial-omega}), suppose
that $S \to S'$ is surjective with kernel $I \subset S$.
Then $\Omega_{S/R} \to \Omega_{S'/R'}$ is surjective with
kernel generated as an $S$-module by the elements the elements
$\text{d}a$, where $a \in S$ is such that $\varphi(a) \in \beta(R')$.
(This includes in particular the elements $\text{d}(i)$, $i \in I$.)
\end{lemma}

\begin{proof}
Consider the map of presentations above. Clearly the right vertical
map of free modules is surjective. Thus the map is surjective.
A diagram chase shows that the following elements generate
the kernel as an $S$-module for sure: $i\text{d}a, i\in I, a \in S$,
and $\text{d}a$, with $a \in S$ such that
$\varphi(a) = \beta(r')$ for some $r' \in R'$.
Note that $\varphi(i) = \varphi(ia) = 0 = \beta(0)$, and that
$\text{d}(ia) = i\text{d}a + a \text{d}i$.
Hence $i\text{d}a = \text{d}(ia) - a \text{d}i$ is
an $S$-linear combination of elements of the second kind.
\end{proof}

\begin{lemma}
\label{lemma-exact-sequence-differentials}
Let $A \to B \to C$ be ring maps.
Then there is a canonical exact sequence
$$
C \otimes_B \Omega_{B/A} \to
\Omega_{C/A} \to
\Omega_{C/B} \to 0
$$
of $C$-modules.
\end{lemma}

\begin{proof}
We get a diagram (\ref{equation-functorial-omega}) by putting
$R = A$, $S = C$, $R' = B$, and $S' = C$.
By Lemma \ref{lemma-differential-surjective} the map
$\Omega_{C/A} \to \Omega_{C/B}$ is surjective, and the kernel
is generated by the elements $\text{d}(c)$, where $c \in C$
is in the image of $B \to C$. The lemma follows.
\end{proof}

\begin{lemma}
\label{lemma-differentials-localize}
Let $\varphi : A \to B$ be a ring map.
\begin{enumerate}
\item If $S \subset A$ is a multiplicative subset mapping to
invertible elements of $B$, then $\Omega_{B/A} = \Omega_{B/S^{-1}A}$.
\item If $S \subset B$ is a multiplicative subset then
$S^{-1}\Omega_{B/A} = \Omega_{S^{-1}B/A}$.
\end{enumerate}
\end{lemma}

\begin{proof}
To show the equality of (1) it is enough to show that any
$A$-derivation $D : B \to M$ annihilates the elements $\varphi(s)^{-1}$.
This is clear from the Leibniz rule applied to
$1 = \varphi(s) \varphi(s)^{-1}$.
To show (2) note that there is an obvious map
$S^{-1}\Omega_{B/A} \to \Omega_{S^{-1}B/A}$.
To show it is an isomorphism it is enough to show that
there is a $A$-derivation $\text{d}'$ of $S^{-1}B$ into $S^{-1}\Omega_{B/A}$.
To define it we simply set
$\text{d}'(b/s) = (1/s)\text{d}b - (1/s^2)b\text{d}s$.
Details omitted.
\end{proof}

\begin{lemma}
\label{lemma-differential-seq}
In diagram (\ref{equation-functorial-omega}),
suppose that $S \to S'$ is surjective with kernel $I \subset S$,
and assume that $R' = R$.
Then there is a canonical exact sequence of $S'$-modules
$$
I/I^2
\longrightarrow
\Omega_{S/R}\otimes_S S'
\longrightarrow
\Omega_{S'/R}
\longrightarrow
0
$$
The leftmost map is characterized by the rule that
$f \in I$ maps to $\text{d}f \otimes 1$.
\end{lemma}

\begin{proof}
The middle term is $\Omega_{S/R} \otimes_S S/I$.
For $f \in I$ denote $\overline{f}$ the image of $f$ in $I/I^2$.
To show that the map $\overline{f} \mapsto \text{d}f \otimes 1$
is well defined we just have to check that
$\text{d} f_1f_2 \otimes 1 = 0$ if $f_1, f_2 \in I$.
And this is clear from the Leibniz rule
$\text{d} f_1f_2 \otimes 1
=
(f_1 \text{d}f_2 + f_2 \text{d} f_1 )\otimes 1
=
\text{d}f_2 \otimes f_1 + \text{d}f_2 \otimes f_1
=
0$. A similar computation show this map is $S' = S/I$-linear.

\medskip\noindent
The map $\Omega_{S/R}\otimes_S S' \to \Omega_{S'/R}$
is the canonical $S'$-linear map associated to the
$S$-linear map $\Omega_{S/R} \to \Omega_{S'/R}$.
It is surjective because $\Omega_{S/R} \to \Omega_{S'/R}$
is surjective by Lemma \ref{lemma-differential-surjective}.

\medskip\noindent
The composite of the two maps is zero because
$\text{d}f$ maps to zero in $\Omega_{S'/R}$
for $f \in I$. Note that exactness just says that
the kernel of $\Omega_{S/R} \to \Omega_{S'/R}$
is generated as an $S$-submodule by the submodule $I\Omega_{S/R}$ together
with the elements $\text{d}f$, with $f \in I$. We know by
Lemma \ref{lemma-differential-surjective}
that this kernel is generated by the elements $\text{d}(a)$
where $\varphi(a) = \beta(r)$ for some $r \in R$.
But then $a = \alpha(r) + a - \alpha(r)$, so
$\text{d}(a) = \text{d}(a - \alpha(r))$. And
$a - \alpha(r) \in I$ since $\varphi(a - \alpha(r)) =
\varphi(a) - \varphi(\alpha(r)) = \beta(r) - \beta(r) = 0$.
We conclude the elements $\text{d}f$ with $f \in I$ already
generate the kernel as an $S$-module, as desired.
\end{proof}

\begin{lemma}
\label{lemma-differential-seq-split}
In diagram (\ref{equation-functorial-omega}),
suppose that $S \to S'$ is surjective with kernel $I \subset S$,
and assume that $R' = R$. Moreover, assume that there exists
an $R$-algebra map $S' \to S$ which is a right inverse to
$S' \to S$. Then the exact sequence of $S'$-modules
of Lemma \ref{lemma-differential-seq} turns into a short exact sequence
$$
0 \longrightarrow
I/I^2
\longrightarrow
\Omega_{S/R}\otimes_S S'
\longrightarrow
\Omega_{S'/R}
\longrightarrow
0
$$
which is even a split short exact sequence.
\end{lemma}

\begin{proof}
Let $\beta : S' \to S$ be the right inverse to the surjection
$\alpha : S \to S'$, so $S = I \oplus \beta(S')$.
Clearly we can use $\beta : \Omega_{S'/R} \to \Omega_{S/R}$,
to get a right inverse to the map $\Omega_{S/R}\otimes_S S' \to \Omega_{S'/R}$.
On the other hand, consider the map
$$
D : S \longrightarrow I/I^2,
\quad
x \longmapsto x - \beta(\alpha(x))
$$
It is easy to show that $D$ is an $R$-derivation (omitted).
Moreover $x D(s) = 0$ if $x \in I, s \in S$. Hence, by the universal property
$D$ induces a map $\tau : \Omega_{S/R} \otimes_R S' \to I/I^2$.
We omit the verification that it is a left inverse to
$\text{d} : I/I^2  \to \Omega_{S/R}\otimes_S S'$. Hence we win.
\end{proof}

\begin{lemma}
\label{lemma-differential-mod-power-ideal}
Let $R \to S$ be a ring map. Let $I \subset S$ be an ideal.
Let $n \geq 1$ be an integer. Set $S' = S/I^{n + 1}$.
The map $\Omega_{S/R} \to \Omega_{S'/R}$ induces an
isomorphism
$$
\Omega_{S/R} \otimes_S S/I^n
\longrightarrow
\Omega_{S'/R} \otimes_{S'} S/I^n.
$$
\end{lemma}

\begin{proof}
This follows from Lemma \ref{lemma-differential-seq} and the fact that
$\text{d}(I^{n + 1}) \subset I^n\Omega_{S/R}$ by the
Leibniz rule for $\text{d}$.
\end{proof}

\begin{lemma}
\label{lemma-differentials-base-change}
Suppose that we have ring maps $R \to R'$ and $R \to S$.
Set $S' = S\otimes_R R'$, so that we obtain a diagram
(\ref{equation-functorial-omega}). Then the canonical map defined above
induces an isomorphism $\Omega_{S/R} \otimes_R R' = \Omega_{S'/R'}$.
\end{lemma}

\begin{proof}
Let $\text{d}' : S' = S\otimes_R R' \to \Omega_{S/R} \otimes_R R'$ denote the
map $\text{d}'( \sum a_i \otimes x_i ) = \text{d}(a_i) \otimes x_i$.
It exists because the map $S \times R' \to \Omega_{S/R} \otimes_R R'$,
$(a, x)\mapsto \text{d}a\otimes_R x$ is $R$-bilinear.
This is an $R'$-derivation, as can be verified by a simple computation.
We will show that $(\Omega_{S/R} \otimes_R R', \text{d}')$ satisfies
the universal property. Let $D : S' \to M'$ be an $R'$ derivation
into an $S'$-module. The composition $S \to S' \to M'$ is an $R$-derivation,
hence we get an $S$-linear map $\varphi_D : \Omega_{S/R} \to M'$. We may
tensor this with $R'$ and get the map $\varphi'_D :
\Omega_{S/R} \otimes_R R' \to M'$, $\varphi'_D(\eta \otimes x) =
x\varphi_D(\eta)$. It is clear that $D = \varphi'_D \circ \text{d}'$.
\end{proof}

\noindent
The multiplication map $S\otimes_R S \to S$ is the $R$-algebra
map which maps $a \otimes b$ to $ab$ in $S$. It is also an
$S$-algebra map, if we think of $S\otimes_R S$ as an $S$-algebra
via either of the maps $S \to S\otimes_R S$.

\begin{lemma}
\label{lemma-differentials-diagonal}
Let $R \to S$ be a ring map. Let $J = \text{Ker}(S\otimes_R S \to S)$
be the kernel of the multiplication map. There is a canonical
isomorphism of $S$-modules $\Omega_{S/R} \to J/J^2$,
$a \text{d} b \mapsto a\otimes b - ab\otimes 1$.
\end{lemma}

\begin{proof}
First we show that the rule $a \text{d} b \mapsto a\otimes b - ab\otimes 1$
is well defined. In order to do this we have to show
that $\text{d}r$ and $a\text{d}b + b \text{d}a - d(ab)$ map to zero.
The first because $r\otimes 1 - 1 \otimes r = 0$ by definition
of the tensor product. The second because
$a\otimes b - ab\otimes 1 + b\otimes a - ba\otimes 1
=
(a\otimes 1 - 1\otimes a)(1\otimes b - b\otimes 1)
$
is in $J^2$.

\medskip\noindent
We construct a map in the other direction.
We may think of $S \to S\otimes_R S$, $a \mapsto a\otimes 1$
as the base change of $R \to S$. Hence we have
$\Omega_{S\otimes_R S/S} = \Omega_{S/R} \otimes_S (S\otimes_R S)$,
by Lemma \ref{lemma-differentials-base-change}.
At this point the sequence of Lemma \ref{lemma-differential-seq} gives a map
$$
J/J^2  \to \Omega_{S\otimes_RS/ S} \otimes_{S\otimes_R S} S
= (\Omega_{S/R} \otimes_S (S\otimes_R S))\otimes_{S\otimes_R S} S
= \Omega_{S/R}.
$$
We leave it to the reader to see it is the inverse of the map
above.
\end{proof}




\begin{lemma}
\label{lemma-differentials-polynomial-ring}
If $S = R[x_1, \ldots, x_n]$, then
$\Omega_{S/R}$ is a finite free $S$-module with
basis $\text{d}x_1, \ldots, \text{d}x_n$.
\end{lemma}

\begin{proof}
We first show that $\text{d}x_1, \ldots, \text{d}x_n$
generate $\Omega_{S/R}$ as an $S$-module. To prove this
we show that $\text{d}g$ can be expressed as a
sum $\sum g_i \text{d}x_i$ for any $g \in R[x_1, \ldots, x_n]$.
We do this by induction on the (total) degree of $g$.
It is clear if the degree of $g$ is $0$, because then
$\text{d}g = 0$. If the degree of $g$ is $>0$, then
we may write $g$ as $c + \sum g_i x_i$ with $c\in R$
and $\deg(g_i) < \deg(g)$. By the Leibnize rule we have
$\text{d}g = \sum g_i \text{d} x_i + \sum x_i \text{d}g_i$,
and hence we win by induction.

\medskip\noindent
Consider the $R$-derivation $\partial / \partial x_i :
R[x_1, \ldots, x_n] \to R[x_1, \ldots, x_n]$. (We leave it to
the reader to define this; the defining property
being that $\partial / \partial x_i (x_j) = \delta_{ij}$.)
By the universal property this corresponds to an $S$-module map $l_i :
\Omega_{S/R} \to R[x_1, \ldots, x_n]$ which maps $\text{d}x_i$
to $1$ and $\text{d}x_j$ to $0$ for $j \not= i$.
Thus it is clear that there are no $S$-linear relations
among the elements $\text{d}x_1, \ldots, \text{d}x_n$.
\end{proof}

\begin{lemma}
\label{lemma-differentials-finitely-presented}
Suppose $R \to S$ is of finite presentation.
Then $\Omega_{S/R}$ is a finitely presented
$S$-module.
\end{lemma}

\begin{proof}
Write $S = R[x_1, \ldots, x_n]/(f_1, \ldots, f_m)$.
Write $I = (f_1, \ldots, f_m)$. According
to Lemma \ref{lemma-differential-seq} there is an exact sequence
of $S$-modules
$$
I/I^2
\to
\Omega_{R[x_1, \ldots, x_n]/R}\otimes_{R[x_1, \ldots, x_n]} S
\to
\Omega_{S/R}
\to
0
$$
The result follows from the fact that $I/I^2$ is a finite
$S$-module (generated by the images of the $f_i$), and that
the middle term is finite free by
Lemma \ref{lemma-differentials-polynomial-ring}.
\end{proof}

\begin{lemma}
\label{lemma-differentials-finitely-generated}
Suppose $R \to S$ is of finite type.
Then $\Omega_{S/R}$ is finitely generated
$S$-module.
\end{lemma}

\begin{proof}
This is very similar to, but easier than the proof
of Lemma \ref{lemma-differentials-finitely-presented}.
\end{proof}









\section{The Netherlander Complex}
\label{section-netherlander}

\noindent
Suppose that $R \to S$ is of finite type.
We say that a {\it presentation} of $S$ over $R$ is
given by the choice of an integer $n \geq 0$, and
a surjection $\alpha : R[x_1, \ldots, x_n] \to S$
of $R$-algebras. We will usually just indicate
this by saying: ``Let $R[x_1, \ldots, x_n] \to S$ be a presentation of
$S/R$'', or ``Let $0 \to I \to R[x_1, \ldots, x_n] \to S \to 0$
be a presentation of $S/R$'' if we want to indicate that $I$
is the kernel of the presentation.

\medskip\noindent
Note that for every presentation $\alpha$ we obtain a two term
cochain complex (or cohomological complex) of $S$-modules
$$
NL(\alpha) :
I/I^2 \longrightarrow \Omega_{R[x_1, \ldots, x_n]/R}\otimes S.
$$
Here the term $I/I^2$ is placed in degree $-1$ and
the term $\Omega_{R[x_1, \ldots, x_n]/R}\otimes S$ is
placed in degree $0$.
The cokernel of this complex is canonically $\Omega_{S/R}$,
see Lemma \ref{lemma-differential-seq}. We call the complex
$NL(\alpha)$
the {\it naive cotangent complex}\footnote{This is better know as the {\it
Netherlander complex} in some localities.} associated to the
presentation $\alpha : R[x_1, \ldots, x_n] \to S$ of $S/R$. We will
sometimes use the notation
$I/I^2 \to \bigoplus_{i = 1, \ldots, n} S\text{d}x_i$
to denote this complex.

\medskip\noindent
A {\it morphism of presentations of $S/R$} from the presentation
$\alpha : R[x_1, \ldots, x_n] \to S$ to the presentation
$\beta : R[y_1, \ldots, y_m] \to S$ is defined to be a
map $\varphi : R[x_1, \ldots, x_n] \to R[y_1, \ldots, y_m]$
such that $\alpha = \beta \circ \varphi$. Note that
in this case $\varphi(I) \subset J$, where $I = \text{ker}(\alpha)$
and $J = \text{ker}(\beta)$. Thus $\varphi$ induces a map
of $S$-modules $I/I^2 \to J/J^2$ and by functoriality of
differentials also a $S$-module map
$\Omega_{R[x_1, \ldots, x_n]/R}\otimes S
\to \Omega_{R[y_1, \ldots, y_m]/R}\otimes S$.
These maps are compatible and we obtain a map
of naive cotangent complexes
$$
NL(\alpha) \longrightarrow NL(\beta).
$$
We leave it to the reader to see that if $\psi$ is a morphism
of presentations from $\beta$ to $\gamma$, then $\psi \circ \varphi$
is a morphism from $\alpha$ to $\gamma$ and furthermore
the composition $NL(\alpha) \to NL(\beta) \to NL(\gamma)$
is the map associated to $\psi \circ \varphi$.

\begin{lemma}
\label{lemma-NL-homotopy}
Let $S$ be a finite type $R$-algebra.
Let $\alpha : R[x_1, \ldots, x_n] \to S$, and
$\beta : R[y_1, \ldots, y_m] \to S$ be presentations.
\begin{enumerate}
\item There exist a morphism of presentations from $\alpha$
to $\beta$ (and backwards too).
\item For any map $\varphi$ of presentations from
$\alpha$ to $\beta$ the induced map $NL(\alpha) \to NL(\beta)$
is a quasi-isomorphism.
\item For any pair of maps $\varphi, \varphi'$ the induced maps
$NL(\alpha) \to NL(\beta)$ are homotopic.
\end{enumerate}
See the proof of the lemma for a simple explanation
of the assertions.
\end{lemma}

\begin{proof}
To construct a morphism $\varphi$ from $\alpha$ to $\beta$, choose
for every $i$ an element $f_i \in R[y_1, \ldots, y_m]$
such that $\beta(f_i) = \alpha(x_i)$. Let
$\varphi : R[x_1, \ldots, x_n] \to R[y_1, \ldots, y_m]$ be the
unique $R$-algebra map such tat $\varphi(x_i) = f_i$.
This gives the morphism.

\medskip\noindent
In the simple case of complexes with two terms a quasi-isomorphism
is just a map that induces an isomorphism on both the cokernel
and the kernel of the maps between the terms. In this case the
fact that $\varphi$ induces an isomorphism on cokernels is by
the choice of $NL(\alpha)$ having cokernel equal to $\Omega_{S/R}$.

\medskip\noindent
Note that the second assertion of the lemma follows from the third.
NAmely, by (1) may choose a morphism of presentations
$\varphi'$ from $\beta$ to $\alpha$. The compositions
$\varphi' \circ \varphi$ and $\varphi \circ \varphi'$
will by (3) induce self maps of $NL(\alpha)$ and $NL(\beta)$
which are homotopic to the identity and hence quasi-isomorphisms.
Hence both compositions $NL(\alpha) \to NL(\beta) \to NL(\alpha)$
and $NL(\beta) \to NL(\alpha) \to NL(\beta)$ are quasi-isomorphisms
(inducing the indentity on cohomology) and hence so are the maps induced
by $\varphi$ and $\varphi'$.

\medskip\noindent
For the third assertion, let $\varphi$ and $\varphi'$ as stated.
Let $I = \text{Ker}(\alpha)$ and $J = \text{Ker}(\beta)$.
We have to construct the diagonal map in the diagram
$$
\xymatrix{
I/I^2 \ar[r]^{\text{d}} \ar@<1ex>[d] \ar@<-1ex>[d]
&
\bigoplus S\text{d}x_i \ar@<1ex>[d] \ar@<-1ex>[d] \ar[ld]_h
\\
J/J^2 \ar[r]^{\text{d}}
&
\bigoplus S\text{d}y_j
}
$$
where the vertical maps are induced by $\varphi$, $\varphi'$.
The condition is that $\text{d} \circ h + h \circ \text{d}$ should be
the difference of the vertical arrows. It is immediate in this
very simple case of complexes with two terms that this implies
the vertical maps induce the {\it same} maps on kernel and cokernel
of the horizontal maps.

\medskip\noindent
Write $\varphi(x_i) - \varphi'(x_i) = h_i$ for some
$h_i \in R[y_j]$. Of course $h_i \in J$. For all $i$ we have
$\varphi(\text{d}x_i) = \text{d}\varphi(x_i)
=\text{d}(\varphi'(x_i) + h_i) =
\text{d}(\varphi'(x_i)) + \text{d}h_i$. On the other hand,
for every $f = f(x_1, \ldots, x_n) \in I$ we have $\varphi(f) =
f(\varphi(x_1), \ldots, \varphi(x_n)) =
f(\varphi'(x_1) + h_1, \ldots, \varphi'(x_n) + h_n) =
f(\varphi'(x_1), \ldots, \varphi'(x_n)) +
\sum_i h_i \partial f/\partial x_i + $ terms in
$J^2$. Hence the map $h : \bigoplus S\text{d}x_i \to J/J^2$,
$x_i \to h_i$ gives the desired homotopy.
\end{proof}

\noindent
The following lemma is part of the motivation for introducing the
naive cotangent complex. The actual cotangent complex extends this
to a genuine long exact cohomology sequence.

\begin{lemma}
\label{lemma-exact-sequence-NL}
Let $A \to B \to C$ be ring maps.
Assume that $A \to B$, $B \to C$ are of finite type.
Choose a presentation $\alpha : A[x_1, \ldots, x_n] \to B$
with kernel $I$.
Choose a presentation $\beta : B[y_1, \ldots, y_m] \to C$ with kernel $J$.
Let $\gamma : A[x_1, \ldots, x_n, y_1, \ldots, y_m] \to C$ be
the corresponding presentation of $C$ with kernel $K$. Then we get a
canonical commutative diagram
$$
\xymatrix{
0 \ar[r] &
\Omega_{A[x_i]/A} \otimes C \ar[r] &
\Omega_{A[x_i, y_j]/A} \otimes C \ar[r] &
\Omega_{B[y_j]/B} \otimes C \ar[r] &
0 \\
&
I/I^2 \otimes C \ar[r] \ar[u] &
K/K^2 \ar[r] \ar[u] &
J/J^2 \ar[r] \ar[u] &
0
}
$$
with exact rows. In particular we get the following exact sequence
of cohomology groups
$$
\xymatrix{
C \otimes_B \Omega_{B/A} \ar[r] &
\Omega_{C/A} \ar[r] &
\Omega_{C/B} \ar[r] & 0 \\
H^{-1}(NL(\alpha) \otimes_B C) \ar[r] &
H^{-1}(NL(\gamma)) \ar[r] &
H^{-1}(NL(\beta)) \ar[ull]
}
$$
of $C$-modules extending the sequence of
Lemma \ref{lemma-exact-sequence-differentials}.
\end{lemma}

\begin{proof}
The precise definition of the maps is omitted.
The exactness of the top row follows as the $\text{d}x_i$,
$\text{d}y_j$ form a basis for the middle module.
The map $\gamma$ factors
$$
A[x_1, \ldots, x_n, y_1, \ldots, y_m] \to
B[y_1, \ldots, y_m] \to C
$$
with surjective first arrow and second arrow equal to $\beta$.
Thus we see that $K \to J$ is surjective.
Moreover, the kernel of the first displayed arrow is
$IA[x_i, y_j]$. Hence $I/I^2 \otimes C$ surjects onto the
kernel of $J/J^2 \to K/K^2$.
\end{proof}

\begin{lemma}
\label{lemma-sum-two-terms}
Let $R$ be a ring.
Let $A_{-1} \to A_0$, and $B_{-1} \to B_0$ be
two two term complexes. Suppose that there exist
morphisms of complexes $\varphi : A_\bullet \to B_\bullet$
and $\psi : B_\bullet \to A_\bullet$ such that
$\varphi \circ \psi$ and $\psi \circ \varphi$ are
homotopic to the identity maps.
Then $A_{-1} \oplus B_0 \cong B_{-1} \oplus A_0$ as
$R$-modules.
\end{lemma}

\begin{proof}
Choose a map $h : A_0 \to B_{-1}$ such that
$$
\text{id}_{A_{-1}} - \psi_{-1} \circ \varphi_{-1} = h \circ d_A
\text{ and }
\text{id}_{A_0} - \psi_0 \circ \varphi_0 = d_A \circ h.
$$
Similarly, choose a map $h' : B_0 \to A_{-1}$ such that
$$
\text{id}_{B_{-1}} - \varphi_{-1} \circ \psi_{-1} = h \circ d_B
\text{ and }
\text{id}_{B_0} - \varphi_0 \circ \psi_0 = d_B \circ h.
$$
A trivial computation shows that
$$
\left(
\begin{matrix}
\text{id}_{A_{-1}} & -h' \circ \psi_{-1} + h \circ \psi_0 \\
0 & \text{id}_{B_0}
\end{matrix}
\right)
=
\left(
\begin{matrix}
\psi_{-1} & h \\
-d_B & \varphi_0
\end{matrix}
\right)
\left(
\begin{matrix}
\varphi_{-1} & - h' \\
d_A & \psi_0
\end{matrix}
\right)
$$
This shows that both matrices on the right hand side
are invertible and proves the lemma.
\end{proof}

\begin{lemma}
\label{lemma-change-base-NL}
Let $S$ be a finite type $R$ algebra.
Let $\alpha : R[x_1, \ldots, x_n] \to S$ be a presentation.
Let $R \to R'$ be a flat ring map.
Let $\alpha' : R'[x_1, \ldots, x_n] \to S' = R'\otimes_R S$
be the induced presentation.
Then $R' \otimes_R NL(\alpha) = S'\otimes_S NL(\alpha) = NL(\alpha')$.
\end{lemma}

\begin{proof}
This is true because
$\text{Ker}(\alpha') = R' \otimes_R \text{Ker}(\alpha)$
since $R \to R'$ is flat.
\end{proof}


\begin{lemma}
\label{lemma-conormal-module}
Let $R \to S$ be a ring map of finite type.
For any presentations $\alpha : R[x_1, \ldots, x_n] \to S$, and
$\beta : R[y_1, \ldots, y_m] \to S$ we have
$$
I/I^2 \oplus S^{\oplus m} \cong J/J^2 \oplus S^{\oplus n}
$$
as $S$-modules where $I = \text{Ker}(\alpha)$ and $J = \text{ker}(\beta)$.
\end{lemma}

\begin{proof}
See Lemmas \ref{lemma-NL-homotopy} and \ref{lemma-sum-two-terms}.
\end{proof}

\begin{lemma}
\label{lemma-conormal-module-localize}
Let $R \to S$ be a ring map of finite type.
Let $g \in S$. For any presentations
$\alpha : R[x_1, \ldots, x_n] \to S$, and
$\beta : R[y_1, \ldots, y_m] \to S_g$ we have
$$
(I/I^2)_g \oplus S^{\oplus m}_g \cong J/J^2 \oplus S_g^{\oplus n}
$$
as $S_g$-modules where
$I = \text{Ker}(\alpha)$ and $J = \text{ker}(\beta)$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-conormal-module} above, we see that
it suffices to prove this for a single choice of $\alpha$
and $\beta$. Thus take $\beta$ to be the presentation
$$
\beta : k[x_1, \ldots, x_n , x_{n + 1}] \longrightarrow S_g
$$
which maps $x_i$ to $\alpha(x_i)$ and $x_{n + 1}$ to $1/g$.
Clearly $J = Ik[x_1, \ldots, x_n , x_{n + 1}] +
(x_{n + 1}g - 1)$. Hence $J/J^2 \cong (I/I^2)_g \oplus S_g$
and we win.
\end{proof}

\begin{lemma}
\label{lemma-localize-NL}
Let $R \to S$ be a finite type ring map.
Let $\alpha$ be any presentation of $S$ over $R$.
Let $g \in S$ and let $\beta$ be any presentation of $S_g$ over $R$.
Then there exists a quasi-isomorphism
$NL(\alpha)\otimes_S S_g \to NL(\beta)$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-NL-homotopy} it suffices to prove this
for one choice of $\beta$. Suppose $\alpha$ is the
presentation $S = R[x_1, \ldots, x_n]/I$.
A presentation of $S_g$ over $R$ is
$\beta : S_g = R[x_1, \ldots, x_n, x_{n + 1}]/J$ with
$J = (I, h x_{n + 1} - 1)$. Here $h$ is a polynomial
that maps to $g$ in $S$. In this case $J/J^2
\cong (I/I^2)_g \oplus S_g \cdot (h x_{n + 1} - 1)$.
Moreover, the term of degree zero of the naive cotangent complex
for the presentation of $S_g$ has one more summand,
namely $S_g \text{d}x_{n + 1}$. Thus we see that
there is a short exact sequence of complexes
$$
0 \to NL(\alpha) \otimes_S S_g \to NL(\beta) \to
(S_g \xrightarrow{g} S_g) \to 0
$$
which proves that $NL(\beta)$ is quasi-isomorphic to
$NL(\alpha) \otimes_S S_g$.
\end{proof}







\section{Local complete intersections}
\label{section-lci}

\noindent
The property of being a local complete intersection is
somehow an intrinsic property of a Noetherian local ring.
However, for the moment we just define this property for
finite type algebras over a field.

\begin{definition}
\label{definition-lci-field}
Let $k$ be a field.
Let $S$ be a finite type $k$-algebra.
\begin{enumerate}
\item We say that $S$ is a {\it global complete intersection over $k$}
if there exists a presentation $S = k[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$
such that $\dim(S) = n - c$.
\item We say that $S$ is a {\it local complete intersection over $k$}
if there exists a covering $\text{Spec}(S) = \bigcup D(g_i)$ such
that each of the rings $S_{g_i}$ is a global complete intersection
over $k$.
\end{enumerate}
We will also use the convention that the zero ring is a global
complete intersection over $k$.
\end{definition}

\noindent
Suppose $S$ is a global complete intersection
$S = k[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$
as in the definition.
Recall that $\dim(S) = n - c$ means that all irreducible
components of $\text{Spec}(S)$ have dimension $\leq n - c$.
Since all maximal ideals of the polynomial ring have local
rings of dimension $n$ we conclude that all irreducible
components of $\text{Spec}(S)$ have dimension $\geq n - c$.
See Section \ref{section-dimension}.
In other words, $\text{Spec}(S)$ is equidimensional
of dimension $n - c$.

\begin{lemma}
\label{lemma-localize-lci}
Let $k$ be a field.
Let $S$ be a finite type $k$-algebra.
Let $g \in S$.
\begin{enumerate}
\item If $S$ is a global complete intersection so is $S_g$.
\item If $S$ is a local complete intersection so is $S_g$.
\end{enumerate}
\end{lemma}

\begin{proof}
The second statement follows immediately from the first.
For the first, say that $S = k[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$
with $n - c = \dim(S)$. By the remarks above $S$ is equidimensional
of dimension $n - c$, so $\dim(S_g) = n - c$ as well (or it is
the zero ring in which case the lemma is true by convention).
Let $g' \in k[x_1, \ldots, x_n]$
be an element whose residue class corresponds to $g$.
Then
$S_g =  k[x_1, \ldots, x_n, x_{n + 1}]/(f_1, \ldots, f_c, x_{n + 1}g' - 1)$
as desired.
\end{proof}

\begin{lemma}
\label{lemma-lci-CM}
Let $k$ be a field. Let $S$ be a finite type $k$-algebra.
If $S$ is a local complete intersection, then
$S$ is a Cohen-Macaulay ring.
\end{lemma}

\begin{proof}
Choose a maximal prime $\mathfrak m$ of $S$.
We have to show that $S_\mathfrak m$ is Cohen-Macaulay.
By assumption we may assume $S = k[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$
with $\dim(S) = n - c$. Let $\mathfrak m' \subset k[x_1, \ldots, x_n]$
be the maximal ideal corresponding to $\mathfrak m$.
According to Proposition \ref{proposition-finite-gl-dim-polynomial-ring}
the local ring
$k[x_1, \ldots, x_n]_{\mathfrak m'}$ is regular local of
dimension $n$. Hence, by dimension theory
(see Section \ref{section-dimension})
the ring
$S_{\mathfrak m} = k[x_1, \ldots, x_n]_{\mathfrak m'}/(f_1, \ldots, f_c)$
has dimension $\geq n - c$. By assumption $\dim(S_{\mathfrak m}) \leq n - c$.
Thus we get equality. This implies that $f_1, \ldots, f_c$ is a regular
sequence in $k[x_1, \ldots, x_n]_{\mathfrak m'}$ and that
$S_{\mathfrak m}$ is Cohen-Macaulay, see Proposition
\ref{proposition-CM-module}.
\end{proof}

\noindent
The following is the technical key to the rest of the material in this
section. An important feature of this lemma is that we may choose any
presentation for the ring $S$, but that condition (1) does not depend
on this choice.

\begin{lemma}
\label{lemma-lci}
Let $k$ be a field.
Let $S$ be a finite type $k$-algebra.
Let $\mathfrak q$ be a prime of $S$.
Choose any presentation $S = k[x_1, \ldots, x_n]/I$.
Let $\mathfrak q'$ be the prime of $k[x_1, \ldots, x_n]$ corresponding
to $\mathfrak q$. Set
$c = \text{height}(\mathfrak q') - \text{height}(\mathfrak q)$,
in other words $\dim_{\mathfrak q}(S) = n - c$
(see Lemma \ref{lemma-codimension}). The following are equivalent
\begin{enumerate}
\item There exists a $g \in S$, $g \not \in \mathfrak q$
such that $S_g$ is a global complete intersection over $k$.
\item The ideal $I_{\mathfrak q'} \subset k[x_1, \ldots, x_n]_{\mathfrak q'}$
can be generated by $c$ elements.
\item The conormal module $(I/I^2)_{\mathfrak q}$ can be generated by
$c$ elements over $S_{\mathfrak q}$.
\item The conormal module $(I/I^2)_{\mathfrak q}$ is a free
$S_{\mathfrak q}$-module of rank $c$.
\item The ideal $I_{\mathfrak q'}$ can be generated by a regular sequence
in the regular local ring $k[x_1, \ldots, x_n]_{\mathfrak q'}$.
\end{enumerate}
In this case any $c$ elements of $I_{\mathfrak q'}$
which generate $I_{\mathfrak q'}/\mathfrak q'I_{\mathfrak q'}$
form a regular sequence in the local
ring $k[x_1, \ldots, x_n]_{\mathfrak q'}$.
\end{lemma}

\begin{proof}
Set $R = k[x_1, \ldots, x_n]_{\mathfrak q'}$. This is a regular local
ring of dimension $\text{height}(\mathfrak q')$. Moreover,
$\overline{R} = R/IR = R/I_{\mathfrak q'} = S_{\mathfrak q}$
is a quotient of dimension $\text{height}(\mathfrak q)$.
Let $f_1, \ldots, f_c \in I_{\mathfrak q'}$ be elements
which generate $(I/I^2)_{\mathfrak q}$. By Lemma \ref{lemma-NAK}
we see that $f_1, \ldots, f_c$ generate $I_{\mathfrak q'}$.
Since the dimensions work out, we conclude
by Proposition \ref{proposition-CM-module} that
$f_1, \ldots, f_c$ is a regular sequence in $R$.
By Lemma \ref{lemma-regular-quasi-regular} we see that
$(I/I^2)_{\mathfrak q}$ is free.
These arguments show that (2), (3), (4) are equivalent and
that they imply the last statement of the lemma, and therefore
they imply (5).

\medskip\noindent
If (5) holds, say $I_{\mathfrak q'}$ is generated by a regular
sequence of length $e$, then
$\text{height}(\mathfrak q) = \dim(S_{\mathfrak q}) =
\dim(k[x_1, \ldots, x_n]_{\mathfrak q'}) - e =
\text{height}(\mathfrak q') - e$ by dimension theory,
see Section \ref{section-dimension}. We conclude that $e = c$.
Thus (5) implies (2).

\medskip\noindent
We continue with the notation introduced in the first paragraph.
For each $f_i$ we may find $d_i \in k[x_1, \ldots, x_n]$,
$d_i \not \in \mathfrak q'$ such that
$f_i' = d_i f_i \in k[x_1, \ldots, x_n]$.
Then it is still true that $I_{\mathfrak q'} = (f_1', \ldots, f_c')R$.
Hence there exists a $g' \in k[x_1, \ldots, x_n]$, $g' \not \in \mathfrak q'$
such that $I_{g'} = (f_1', \ldots, f_c')$.
Moreover, pick $g'' \in k[x_1, \ldots, x_n]$, $g'' \not \in \mathfrak q'$
such that $\dim(S_{g''}) = \dim_{\mathfrak q} \text{Spec}(S)$.
By Lemma \ref{lemma-codimension} this dimension is equal to $n - c$.
Finally, set $g$ equal to the image of $g'g''$ in $S$.
Then we see that
$$
S_g \cong k[x_1, \ldots, x_n, x_{n + 1}]
/
(f_1', \ldots, f_c', x_{n + 1}g'g'' - 1)
$$
and by our choice of $g''$ this ring has dimension $n - c$.
Therefore it is a global complete intersection.
Thus each of (2), (3), and (4) implies (1).

\medskip\noindent
Assume (1). Let $S_g \cong k[y_1, \ldots, y_m]/(f_1, \ldots, f_t)$
be a presentation of $S_g$ as a global complete intersection.
Write $J = (f_1, \ldots, f_t)$. Let $\mathfrak q'' \subset k[y_1, \ldots, y_m]$
be the prime corresponding to $\mathfrak qS_g$. Note that
$t = m - \dim(S_g) =
\text{height}(\mathfrak q) - \text{height}(\mathfrak q'')$,
see Lemma \ref{lemma-codimension} for the last equality.
As seen in the proof of Lemma \ref{lemma-lci-CM} (and also above) the elements
$f_1, \ldots, f_t$ form a regular sequence in the local ring
$k[y_1, \ldots, y_m]_{\mathfrak q''}$.
By Lemma \ref{lemma-regular-quasi-regular} we see that
$(J/J^2)_{\mathfrak q}$ is free of rank $t$.
By Lemma \ref{lemma-conormal-module-localize} we have
$$
J/J^2 \oplus S_g^n \cong (I/I^2)_g \oplus S_g^m
$$
Thus $(I/I^2)_{\mathfrak q}$ is free of rank
$t + n - m = m - \dim(S_g) + n - m = n - \dim(S_g) =
\text{height}(\mathfrak q) - \text{height}(\mathfrak q') = c$.
Thus we obtain (4).
\end{proof}

\noindent
The result of Lemma \ref{lemma-lci} suggests the following definition.

\begin{definition}
\label{definition-lci-local-ring}
Let $k$ be a field. Let $S$ be a local $k$-algebra essentially of finite type
over $k$. We say $S$ is a {\it complete intersection (over $k$)}
if there exists a local $k$-algebra $R$ and elements
$f_1, \ldots, f_c \in \mathfrak m_R$ such that
\begin{enumerate}
\item $R$ is essentially of finite type over $k$,
\item $R$ is a regular local ring,
\item $f_1, \ldots, f_c$ form a regular sequence in $R$, and
\item $S \cong R/(f_1, \ldots, f_c)$ as $k$-algebras.
\end{enumerate}
\end{definition}

\noindent
By the Cohen structure theorem (see
Theorem \ref{theorem-cohen-structure-theorem}) any complete
Noetherian local ring may be written as the quotient of some regular complete
local ring. Hence we may use the definition above to define the notion of
a complete intersection ring for any complete Noetherian local ring.
We will discuss this later, see (insert future reference here). In the meantime
the following lemma shows that such a definition makes sense.

\begin{lemma}
\label{lemma-ci-well-defined}
Let $A \to B \to C$ be surjective local ring homomorphisms.
Assume $A$ and $B$ are regular local rings. The following are equivalent
\begin{enumerate}
\item $\text{Ker}(A \to C)$ is generated by a regular sequence,
\item $\text{Ker}(A \to C)$ is generated by $\dim(A) - \dim(C)$ elements,
\item $\text{Ker}(B \to C)$ is generated by a regular sequence, and
\item $\text{Ker}(B \to C)$ is generated by $\dim(B) - \dim(C)$ elements.
\end{enumerate}
\end{lemma}

\begin{proof}
A regular local ring is Cohen-Macaulay, see Lemma \ref{lemma-regular-ring-CM}.
Hence the equivalences (1) $\Leftrightarrow$ (2) and
(3) $\Leftrightarrow$ (4), see Proposition \ref{proposition-CM-module}.
By Lemma \ref{lemma-regular-quotient-regular}
the ideal $\text{Ker}(A \to B)$ can be generated
by $\dim(A) - \dim(B)$ elements.
Hence we see that (4) implies (2).

\medskip\noindent
It remains to show that (1) implies (4). We do this by induction on
$\dim(A) - \dim(B)$. The case $\dim(A) - \dim(B) = 0$ is trivial.
Assume $\dim(A) > \dim (B)$.
Write $I = \text{Ker}(A \to C)$ and $J = \text{Ker}(A \to B)$.
Note that $J \subset I$. Our assumption is that the minimal number
of generators of $I$ is $\dim(A) - \dim(C)$.
Let $\mathfrak m \subset A$ be the maximal
ideal. Consider the maps
$$
J/ \mathfrak m J \to  I / \mathfrak m I \to \mathfrak m /\mathfrak m^2
$$
By Lemma \ref{lemma-regular-quotient-regular} and its proof the
composition is injective. Take any element $x \in J$ which is
not zero in $J /\mathfrak mJ$. By the above and Nakayama's lemma
$x$ is an element of a minimal set of generators of $I$.
Hence we may replace $A$ by $A/xA$ and $I$ by $I/xA$ which
drops bot $\dim(A)$ and the minimal number of generators of $I$
by $1$. Thus we win.
\end{proof}

\begin{lemma}
\label{lemma-lci-local}
Let $k$ be a field. Let $S$ be a local $k$-algebra essentially of finite
type over $k$. The following are equivalent:
\begin{enumerate}
\item $S$ is a complete intersection over $k$,
\item for any surjection $R \to S$ with $R$ a regular local ring
essentially of finite presentation over $k$ the ideal
$\text{Ker}(R \to S)$ can be generated by a regular sequence,
\item for some surjection $R \to S$ with $R$ a regular local ring
essentially of finite presentation over $k$ the ideal
$\text{Ker}(R \to S)$ can be generated by
$\dim(R) - \dim(S)$ elements,
\item there exists a global complete intersection
$A$ over $k$ and a prime $\mathfrak a$ of $A$ such
that $S \cong A_{\mathfrak a}$, and
\item there exists a local complete intersection
$A$ over $k$ and a prime $\mathfrak a$ of $A$ such
that $S \cong A_{\mathfrak a}$.
\end{enumerate}
\end{lemma}

\begin{proof}
It is clear that (2) implies (1) and (1) implies (3).
It is also clear that (4) implies (5). Let us show that (3) implies
(4). Thus we assume there exists a surjection
$R \to S$ with $R$ a regular local ring
essentially of finite presentation over $k$ such that the ideal
$\text{Ker}(R \to S)$ can be generated by $\dim(R) - \dim(S)$ elements.
We may write $R = (k[x_1, \ldots, x_n]/J)_{\mathfrak q}$
for some $J \subset k[x_1, \ldots, x_n]$ and
some prime $\mathfrak q \subset k[x_1, \ldots, x_n]$ with
$J \subset \mathfrak q$. Let $I \subset k[x_1, \ldots, x_n]$
be the kernel of the map $k[x_1, \ldots, x_n] \to S$ so that
$S \cong (k[x_1, \ldots, x_n]/I)_{\mathfrak q}$.
By assumption $(I/J)_{\mathfrak q}$ is generated by
$\dim(R) - \dim(S)$ elements. We conclude that
$I_{\mathfrak q}$ can be generated by
$\dim(k[x_1, \ldots, x_n]_{\mathfrak q}) - \dim(S)$ elements
by Lemma \ref{lemma-ci-well-defined}.
From Lemma \ref{lemma-lci} we see that for some
$g \in k[x_1, \ldots, x_n]$, $g \not \in \mathfrak q$
the algebra $(k[x_1, \ldots, x_n]/I)_g$ is a global
complete intersection and $S$ is isomorphic to
a local ring of it.

\medskip\noindent
To finish the proof of the lemma we have to show that (5) implies (2).
Assume (5) and let $\pi : R \to S$ be a surjection with $R$ a regular local
$k$-algebra essentially of finite type over $k$.
By assumption we have $S = A_{\mathfrak a}$ for some local
complete intersection $A$ over $k$.
Choose a presentation $R = (k[y_1, \ldots, y_m]/J)_{\mathfrak q}$
with $J \subset \mathfrak q \subset k[y_1, \ldots, y_m]$.
We may and do assume that $J$ is the kernel of the map
$k[y_1, \ldots, y_m] \to R$. Let $I \subset k[y_1, \ldots, y_m]$
be the kernel of the map $k[y_1, \ldots, y_m] \to S = A_{\mathfrak a}$.
Then $J \subset I$ and $(I/J)_{\mathfrak q}$ is the kernel of
the surjection $\pi : R \to S$. So
$S = (k[y_1, \ldots, y_m]/I)_{\mathfrak q}$.

\medskip\noindent
By Lemma \ref{lemma-isomorphic-local-rings} we see that there exist
$g \in A$, $g \not \in \mathfrak a$ and
$g' \in k[y_1, \ldots, y_m]$, $g' \not \in \mathfrak q$
such that $A_g \cong (k[y_1, \ldots, y_m]/I)_{g'}$.
After replacing $A$ by $A_g$ and $k[y_1, \ldots, y_m]$ by
$k[y_1, \ldots, y_{m + 1}]$ we may assume that
$A \cong k[y_1, \ldots, y_m]/I$. Consider the surjective
maps of local rings
$$
k[y_1, \ldots, y_m]_{\mathfrak q} \to R \to S.
$$
We have to show that the kernel of $R \to S$ is generated by
a regular sequence. By Lemma \ref{lemma-lci} we know that
$k[y_1, \ldots, y_m]_{\mathfrak q} \to A_{\mathfrak a} = S$
has this property (as $A$ is a local complete intersection over $k$).
We win by Lemma \ref{lemma-ci-well-defined}.
\end{proof}

\begin{lemma}
\label{lemma-lci-at-prime}
Let $k$ be a field. Let $S$ be a finite type $k$-algebra.
Let $\mathfrak q$ be a prime of $S$. The following are
equivalent:
\begin{enumerate}
\item The local ring $S_{\mathfrak q}$ is a complete intersection
ring (Definition \ref{definition-lci-local-ring}).
\item There exists a $g \in S$, $g \not \in \mathfrak q$
such that $S_g$ is a local complete intersection over $k$.
\item There exists a $g \in S$, $g \not \in \mathfrak q$
such that $S_g$ is a global complete intersection over $k$.
\item For any presentation $S = k[x_1, \ldots, x_n]/I$ with
$\mathfrak q' \subset k[x_1, \ldots, x_n]$ corresponding to $\mathfrak q$
any of the equivalent conditions (1) -- (5) of Lemma \ref{lemma-lci} hold.
\end{enumerate}
\end{lemma}

\begin{proof}
This is a combination of Lemmas \ref{lemma-lci} and \ref{lemma-lci-local}
and the definitions.
\end{proof}

\begin{lemma}
\label{lemma-lci-global}
Let $k$ be a field. Let $S$ be a finite type $k$-algebra.
The following are equivalent:
\begin{enumerate}
\item The ring $S$ is a local complete intersection over $k$.
\item All local rings of $S$ are complete intersection rings over $k$.
\item All localizations of $S$
at maximal ideals are complete intersection rings over $k$.
\end{enumerate}
\end{lemma}

\begin{proof}
This follows from Lemma \ref{lemma-lci-at-prime},
the fact that $\text{Spec}(S)$ is quasi-compact and the definitions.
\end{proof}

\noindent
The following lemma says that being a complete intersection is
preserved under change of base field (in a strong sense).

\begin{lemma}
\label{lemma-lci-field-change-local}
Let $k \subset K$ be a field extension.
Let $S$ be a finite type algebra over $k$.
Let $\mathfrak q_K$ be a prime of $S_K = K \otimes_k S$
and let $\mathfrak q$ be the corresponding prime of $S$.
Then $S_{\mathfrak q}$ is a complete intersection
over $k$ (Definition \ref{definition-lci-local-ring})
if and only if $(S_K)_{\mathfrak q_K}$ is a complete
intersection over $K$.
\end{lemma}

\begin{proof}
Choose a presentation $S = k[x_1, \ldots, x_n]/I$.
This gives a presentation
$S_K = K[x_1, \ldots, x_n]/I_K$ where $I_K = K\otimes_k I$.
Let $\mathfrak q_K' \subset K[x_1, \ldots, x_n]$,
resp.\ $\mathfrak q' \subset k[x_1, \ldots, x_n]$ be
the corresponding prime. We will show that the equivalent conditions
of Lemma \ref{lemma-lci}
hold for the pair $(S = k[x_1, \ldots, x_n]/I, \mathfrak q)$
if and only if they hold for the pair
$(S_K = K[x_1, \ldots, x_n]/I_K, \mathfrak q_K)$.
The lemma will follow from this (see Lemma \ref{lemma-lci-at-prime}).

\medskip\noindent
By Lemma \ref{lemma-dimension-at-a-point-preserved-field-extension} we have
$\dim_{\mathfrak q} S = \dim_{\mathfrak q_K} S_K$.
Hence the integer $c$ occuring in Lemma \ref{lemma-lci}
is the same for the pair $(S = k[x_1, \ldots, x_n]/I, \mathfrak q)$
as for the pair $(S_K = K[x_1, \ldots, x_n]/I_K, \mathfrak q_K)$.
On the other hand we have
\begin{eqnarray*}
I \otimes_{k[x_1, \ldots, x_n]} \kappa(\mathfrak q')
\otimes_{\kappa(\mathfrak q')} \kappa(\mathfrak q_K')
& = &
I \otimes_{k[x_1, \ldots, x_n]} \kappa(\mathfrak q_K') \\
& = &
I \otimes_{k[x_1, \ldots, x_n]} K[x_1, \ldots, x_n]
\otimes_{K[x_1, \ldots, x_n]} \kappa(\mathfrak q_K') \\
& = &
(K \otimes_k I) \otimes_{K[x_1, \ldots, x_n]} \kappa(\mathfrak q_K') \\
& = &
I_K \otimes_{K[x_1, \ldots, x_n]} \kappa(\mathfrak q'_K).
\end{eqnarray*}
Therefore,
$\dim_{\kappa(\mathfrak q')}
I \otimes_{k[x_1, \ldots, x_n]} \kappa(\mathfrak q')
=
\dim_{\kappa(\mathfrak q'_K)}
I_K \otimes_{K[x_1, \ldots, x_n]} \kappa(\mathfrak q_K')$.
Thus it follows from
Nakayama's Lemma \ref{lemma-NAK} that the minimal number
of generators of $I_{\mathfrak q'}$ is the same as the minimal
number of generators of $(I_K)_{\mathfrak q'_K}$.
Thus the lemma follows from characterization (2) of Lemma \ref{lemma-lci}.
\end{proof}

\begin{lemma}
\label{lemma-lci-field-change}
Let $k \to K$ be a field extension.
Let $S$ be a finite type $k$-algebra.
Then $S$ is a local complete intersection over $k$ if and
only if $S\otimes_k K$ is a local complete intersection over $K$.
\end{lemma}

\begin{proof}
This follows from a combination of Lemmas
\ref{lemma-lci-global} and \ref{lemma-lci-field-change-local}.
But we also give a different
proof here (based on the same principles).

\medskip\noindent
Let $\alpha : k[x_1, \ldots, x_n] \to S$ be a presentation
with kernel $I$. Let $\alpha' : K[x_1, \ldots, x_n] \to S'$
be the induced presentation with kernel $I'$.

\medskip\noindent
Suppose that $S$ is a local complete intersection.
Pick a prime $\mathfrak q \subset S'$. Denote
$\mathfrak q'$ the corresponding prime of $K[x_1, \ldots, x_n]$,
$\mathfrak p$ the corresponding prime of $S$, and
$\mathfrak p'$ the corresponding prime of $k[x_1, \ldots, x_n]$.
Consider the following diagram of Noetherian local rings
$$
\xymatrix{
S'_{\mathfrak q} &  K[x_1, \ldots, x_n]_{\mathfrak q'} \ar[l] \\
S_{\mathfrak p}\ar[u] &  k[x_1, \ldots, x_n]_{\mathfrak p'} \ar[u] \ar[l]
}
$$
By Lemma \ref{lemma-lci} we know that $S_{\mathfrak p}$
is cut out by some regular sequence $f_1, \ldots, f_e$ in
$k[x_1, \ldots, x_n]_{\mathfrak p'}$. Since the right vertical
arrow is flat we see that the images of $f_1, \ldots, f_c$
form a regular sequence in $K[x_1, \ldots, x_n]_{\mathfrak q'}$.
Because tensoring with $K$ over $k$ is an exact functor we have
$S'_{\mathfrak q} = K[x_1, \ldots, x_n]_{\mathfrak q'}/(f_1, \ldots, f_e)$.
Hence by Lemma \ref{lemma-lci} again we see that $S'$ is a local
complete intersection in a neighbourhood of $\mathfrak q$. Since
$\mathfrak q$ was arbitrary we see that $S'$ is a local complete
intersection over $K$.

\medskip\noindent
Suppose that $S'$ is a local complete intersection.
Pick a maximal ideal $\mathfrak m$ of $S$. Let $\mathfrak m'$
denote the corresponding maximal ideal of $k[x_1, \ldots, x_n]$.
Denote $\kappa = \kappa(\mathfrak m)$ the residue field.
By Remark \ref{remark-fundamental-diagram} the primes of
$S'$ lying over $\mathfrak m$ correspond to primes
in $K \otimes_k \kappa$. By the Hilbert-Nullstellensatz
Theorem \ref{theorem-nullstellensatz} we have $[\kappa : k] < \infty$.
Hence $K \otimes_k \kappa$ is finite nonzero over $K$.
Hence $K \otimes_k \kappa$ has a finite number $> 0$ of primes
which are all maximal, each of which has a residue field
finite over $K$ (see Section \ref{section-artinian}).
Hence there are finitely many $> 0$ prime ideals
$\mathfrak n \subset S'$ lying over $\mathfrak m$,
each of which is maximal and  has a residue field
which is finite over $K$. Pick one, say $\mathfrak n \subset S'$,
and let $\mathfrak n' \subset K[x_1, \ldots, x_n]$ denote the corresponding
prime ideal of $K[x_1, \ldots, x_n]$.
Note that since $V(\mathfrak mS')$ is finite, we see that
$\mathfrak n$ is an isolated point of it, and we
deduce that $\mathfrak mS'_{\mathfrak n}$ is an ideal of definition
of $S'_{\mathfrak n}$. This implies that $\dim(S_{\mathfrak m})
\geq \dim(S'_{\mathfrak n})$, for example by
Lemma \ref{lemma-dimension-base-fibre-total}
or by the characterization of dimension
in terms of minimal number of generators of ideal of definition,
see Section \ref{section-dimension}. (In reality the dimensions
are equal but we do not need this.)
Consider the corresponding diagram of Noetherian local rings
$$
\xymatrix{
S'_{\mathfrak n} &  K[x_1, \ldots, x_n]_{\mathfrak n'} \ar[l] \\
S_{\mathfrak m}\ar[u] &  k[x_1, \ldots, x_n]_{\mathfrak m'} \ar[u] \ar[l]
}
$$
According to Lemma \ref{lemma-change-base-NL} we have
$NL(\alpha) \otimes_S S' = NL(\alpha')$, in particular
$I'/(I')^2 = I/I^2 \otimes_S S'$. Thus
$(I/I^2)_{\mathfrak m} \otimes_{S_{\mathfrak m}} \kappa$
and
$(I'/(I')^2)_{\mathfrak n} \otimes_{S'_{\mathfrak n}} \kappa(\mathfrak n)$
have the same dimension. Since $(I'/(I')^2)_{\mathfrak n}$
is free of rank $n - \dim S'_{\mathfrak n}$ we deduce that
$(I/I^2)_{\mathfrak m}$ can be generated by
$n - \dim S'_{\mathfrak n} \leq n - \dim S_{\mathfrak m}$ elements.
By Lemma \ref{lemma-lci} we see that $S$ is a local
complete intersection in a neighbourhood of $\mathfrak m$.
Since $\mathfrak m$ was any maximal ideal we conclude that
$S$ is a local complete intersection.
\end{proof}

\noindent
We end with a lemma which we will later use to prove that
given ring maps $T \to A \to B$ where $B$ is syntomic over $T$,
and $B$ is syntomic over $A$, then $A$ is syntomic over $T$.

\begin{lemma}
\label{lemma-lci-permanence-initial}
Let
$$
\xymatrix{
B & S \ar[l] \\
A \ar[u] & R \ar[l] \ar[u]
}
$$
be a commutative square of local rings. Assume
\begin{enumerate}
\item $R$ and $\overline{S} = S/\mathfrak m_R S$ are regular local rings,
\item $A = R/I$ and $B = S/J$ for some ideals $I$, $J$,
\item $J \subset S$ and
$\overline{J} = J/\mathfrak m_R \cap J \subset \overline{S}$
are generated by regular sequences, and
\item $A \to B$ and $R \to S$ are flat.
\end{enumerate}
Then $I$ is generated by a regular sequence.
\end{lemma}

\begin{proof}
Set $\overline{B} = B/\mathfrak m_RB = B/\mathfrak m_AB$ so that
$\overline{B} = \overline{S}/\overline{J}$.
Let $f_1, \ldots, f_{\overline{c}} \in J$ be elements such that
$\overline{f}_1, \ldots, \overline{f}_{\overline{c}} \in \overline{J}$
form a regular sequence generating $\overline{J}$.
Note that $\overline{c} = \dim(\overline{S}) - \dim(\overline{B})$,
see Lemma \ref{lemma-ci-well-defined}.
By Lemma \ref{lemma-grothendieck-regular-sequence}
the ring $S/(f_1, \ldots, f_{\overline{c}})$ is flat
over $R$. Hence $S/(f_1, \ldots, f_{\overline{c}}) + IS$ is flat over $A$.
The map $S/(f_1, \ldots, f_{\overline{c}}) + IS \to B$ is therefore a
surjection of finite $S/IS$-modules flat over $A$ which
is an isomorphism modulo $\mathfrak m_A$, and hence an
isomorphism by Lemma \ref{lemma-mod-injective}. In other words,
$J = (f_1, \ldots, f_{\overline{c}}) + IS$.

\medskip\noindent
By Lemma \ref{lemma-ci-well-defined} again the ideal $J$ is
generated by a regular sequence of $c = \dim(S) - \dim(B)$ elements. Hence
$J/\mathfrak m_SJ$ is a vector space of dimension $c$.
By the description of $J$ above there exist
$g_1, \ldots, g_{c - \overline{c}} \in I$ such that
$J$ is generated by
$f_1, \ldots, f_{\overline{c}}, g_1, \ldots, g_{c - \overline{c}}$
(use Nakayama's Lemma \ref{lemma-NAK}). Consider the ring
$A' = R/(g_1, \ldots, g_{c - \overline{c}})$ and the surjection
$A' \to A$. We see from the above that
$B = S/(f_1, \ldots, f_{\overline{c}}, g_1, \ldots, g_{c - \overline{c}})$
is flat over $A'$ (as $S/(f_1, \ldots, f_{\overline{c}})$ is flat
over $R$). Hence $A' \to B$ is injective (as it is faithfully flat,
see Lemma \ref{lemma-local-flat-ff}).
Since this map factors through $A$ we get $A' = A$.
Note that $\dim(B) = \dim(A) + \dim(\overline{B})$, and
$\dim(S) = \dim(R) + \dim(\overline{S})$, see
Lemma \ref{lemma-dimension-base-fibre-equals-total}.
Hence $c - \overline{c} = \dim(R) -\dim(A)$ by elementary algebra.
Thus $I = (g_1, \ldots, g_{c - \overline{c}})$ is generated
by a regular sequence according to Lemma \ref{lemma-ci-well-defined}.
\end{proof}






\section{Syntomic morphisms}
\label{section-syntomic}

\begin{definition}
\label{definition-lci}
A ring map $R \to S$ is called {\it syntomic}, or we say $S$ is a
{\it flat local complete intersection over $R$}
if it is flat, of finite presentation, and if all of its fibre rings
$S \otimes_R \kappa(\mathfrak p)$ are local complete intersections,
see Definition \ref{definition-lci-field}.
\end{definition}

\noindent
Clearly, an algebra over a field is syntomic over the field
if and only if it is a local complete intersection. Here is
a pleasing feature of this definition.

\begin{lemma}
\label{lemma-syntomic-descends}
Let $R \to S$ be a ring map.
Let $R \to R'$ be a faithfully flat ring map.
Set $S' = R'\otimes_R S$.
Then $R \to S$ is syntomic if and only if $R' \to S'$ is syntomic.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-finite-presentation-descends} and
Lemma \ref{lemma-flatness-descends} this holds for the property
of being flat and for the property of being of finite presentation.
The map $\text{Spec}(R') \to \text{Spec}(R)$ is surjective,
see Lemma \ref{lemma-ff-rings}. Thus it suffices to show
given primes $\mathfrak p' \subset R'$ lying over $\mathfrak p \subset R$
that $S \otimes_R \kappa(\mathfrak p)$ is a local complete
intersection if and only if $S' \otimes_{R'} \kappa(\mathfrak p')$
is a local complete intersection. Note that
$S' \otimes_{R'} \kappa(\mathfrak p') =
S \otimes_R \kappa(\mathfrak p)
\otimes_{\kappa(\mathfrak p)} \kappa(\mathfrak p')$.
Thus Lemma \ref{lemma-lci-field-change} applies.
\end{proof}

\begin{lemma}
\label{lemma-base-change-syntomic}
Any base change of a syntomic map is syntomic.
\end{lemma}

\begin{proof}
This is true for being flat, for being of finite presentation,
and for having local complete intersections as fibres by
Lemmas \ref{lemma-flat-base-change}, \ref{lemma-compose-finite-type} and
\ref{lemma-lci-field-change}.
\end{proof}

\begin{lemma}
\label{lemma-local-syntomic}
Let $R \to S$ be a ring map.
Suppose we have $g_1, \ldots g_m \in S$ which generate the
unit ideal such that each $R \to S_{g_i}$ is syntomic.
Then $R \to S$ is syntomic.
\end{lemma}

\begin{proof}
This is true for being flat and for being of finite presentation by
Lemmas \ref{lemma-flat-localization} and \ref{lemma-cover-upstairs}.
The property of having fibre rings which are local complete intersections
is local on $S$ by its very definition, see
Definition \ref{definition-lci-field}.
\end{proof}

\begin{definition}
\label{definition-relative-global-complete-intersection}
Let $R \to S$ be a ring map. We say that $R \to S$ is
a {\it relative global complete intersection} if we are
given a presentation $S = R[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$ such that
every nonempty fibre has dimension $n - c$.
\end{definition}

\begin{example}
\label{example-factor-polynomials}
Let $n , m \geq 1$ be integers. Consider the ring map
\begin{eqnarray*}
R = \mathbf{Z}[a_1, \ldots, a_{n + m}]
& \longrightarrow &
S = \mathbf{Z}[b_1, \ldots, b_n, c_1, \ldots, c_m] \\
a_1 & \longmapsto & b_1 + c_1 \\
a_2 & \longmapsto & b_2 + b_1 c_1 + c_2 \\
\ldots & \ldots & \ldots \\
a_{n + m} & \longmapsto & b_n c_m
\end{eqnarray*}
In other words, this is the unique ring map of polynomial rings
as indicated such that the polynomial factorization
$$
x^n + a_1 x^{n - 1} + \ldots + a_{n + m}
=
(x^n + b_1 x^{n - 1} + \ldots + b_n)
(x^m + c_1 x^{m - 1} + \ldots + c_m)
$$
holds. Note that $S$ is generated by $n + m$ elements over $R$
(namely, $b_i, c_j$) and that there are $n + m$ equations
(namely $a_k = a_k(b_i, c_j)$). In order to show that
$S$ is a relative global complete intersection over $R$ it suffices
to prove that all fibres have dimension $0$.

\medskip\noindent
To prove this, let $R \to k$ be a
ring map into a field $k$. Say $a_i$ maps to $\alpha_i \in k$.
Consider the fibre ring $S_k = k \otimes_R S$. Let $k \to K$ be
a field extension. A $k$-algebra map of $S_k \to K$ is the same thing as
finding $\beta_1, \ldots, \beta_n, \gamma_1, \ldots, \gamma_m \in K$
such that
$$
x^n + \alpha_1 x^{n - 1} + \ldots + \alpha_{n + m}
=
(x^n + \beta_1 x^{n - 1} + \ldots + \beta_n)
(x^m + \gamma_1 x^{m - 1} + \ldots + \gamma_m).
$$
Hence we see there are at most finitely many choices of
such $n + m$-tuples in $K$. This proves that all fibres
have finitely many closed points (use Hilbert's Nullstellensatz
to see they all correspond to solutions in $\overline{k}$ for example)
and hence that $R \to S$ is a relative global complete intersection.

\medskip\noindent
Another way to argue this is to show
$\mathbf{Z}[a_1, \ldots, a_{n + m}] \to
\mathbf{Z}[b_1, \ldots, b_n, c_1, \ldots, c_m]$ is actually
also a {\it finite} ring map. Namely, by Lemma \ref{lemma-polynomials-divide}
each of $b_i, c_j$ is integral over $R$, and hence $R \to S$ is
finite by Lemma \ref{lemma-characterize-integral}.
\end{example}

\begin{example}
\label{example-roots-universal-polynomial}
Consider the ring map
\begin{eqnarray*}
R = \mathbf{Z}[a_1, \ldots, a_n]
& \longrightarrow &
S = \mathbf{Z}[\alpha_1, \ldots, \alpha_n] \\
a_1 & \longmapsto &
\alpha_1 + \ldots + \alpha_n \\
\ldots & \ldots & \ldots \\
a_n & \longmapsto & \alpha_1 \ldots \alpha_n
\end{eqnarray*}
In other words this is the unique ring map of polynomial
rings as indicated
such that
$$
x^n + a_1 x^{n - 1} + \ldots + a_n
=
\prod\nolimits_{i = 1}^n (x + \alpha_i)
$$
holds in $\mathbf{Z}[\alpha_i, x]$. Another way to say this
is that $a_i$ maps to the $i$th elementary symmetric function
in $\alpha_1, \ldots, \alpha_n$. Note that $S$ is generated by
$n$ elements over $R$ subject to $n$ equations. Hence to show
that $S$ is a global relative complete intersection over
$R$ we have to show that the fibre rings $S \otimes_R \kappa(\mathfrak p)$
have dimension $0$. This follows as in
Example \ref{example-factor-polynomials} above because the ring map
$\mathbf{Z}[a_1, \ldots, a_n] \to
\mathbf{Z}[\alpha_1, \ldots, \alpha_n]$ is actually {\it finite}
since each $\alpha_i \in S$
satisfies the monic equation $x^n - a_1 x^{n - 1} + \ldots + (-1)^n a_n$
over $R$.
\end{example}

\begin{lemma}
\label{lemma-adjoin-roots}
Suppose that $A$ is a ring, and
$P(x) = x^n + b_1 x^{n-1} + \ldots + b_n \in A[x]$ is
a monic polynomial over $A$. Then there exists a
syntomic, finite locally free, faithfully flat ring extension
$A \subset A'$ such that $P(x) = \prod_{i = 1, \ldots, n} (x - \beta_i)$
for certain $\beta_i \in A'$.
\end{lemma}

\begin{proof}
Take $A' = A \otimes_R S$, where $R$ and $S$ are as in
Example \ref{example-roots-universal-polynomial}
above, where $R \to A$ maps $a_i$ to $b_i$, and let
$\beta_i = -1 \otimes \alpha_i$. One can also prove this by
applying
Lemma \ref{lemma-adjoin-one-root}
several times.
\end{proof}

\begin{lemma}
\label{lemma-base-change-relative-global-complete-intersection}
Let $S = R[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$ be a
relative global complete intersection over $R$.
\begin{enumerate}
\item For any $R \to R'$ the base change
$R' \otimes_R S = R'[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$ is a relative
global complete intersection.
\item For any $g \in S$ which is the image of $h \in R[x_1, \ldots, x_n]$
the ring
$S_g = R[x_1, \ldots, x_n, x_{n + 1}]/(f_1, \ldots, f_c, hx_{n + 1} - 1)$
is a relative global complete intersection.
\item If $R \to S$ factors as $R \to R_f \to S$ for some $f \in R$.
Then the ring $S = R_f[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$
is a relative global complete intersection over $R_f$.
\end{enumerate}
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-dimension-preserved-field-extension}
the fibres of a base change have the same dimension as the
fibres of the original map. Moreover
$R' \otimes_R R[x_1, \ldots, x_n]/(f_1, \ldots, f_c)
= R'[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$. Thus (1) follows.
The proof of (2) is that
the localization at one element can be described as
$S_g \cong S[x_{n + 1}]/(gx_{n + 1} - 1)$.
Assertion (3) follows from (1) since under the assumptions of (3) we have
$R_f \otimes_R S \cong S$.
\end{proof}

\begin{lemma}
\label{lemma-localize-relative-complete-intersection}
Let $R$ be a ring.
Let $S = R[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$.
Let $\mathfrak q \subset S$ be a prime lying over $\mathfrak p \subset R$.
If $\dim_{\mathfrak q}(S/R) = n - c$, then there
exists a $h \in R[x_1, \ldots, x_n]$ which maps to $g \in S$,
$g \not \in \mathfrak q$ such that
$$
S_g = R[x_1, \ldots, x_n, x_{n + 1}]/(f_1, \ldots, f_c, hx_{n + 1} - 1)
$$
is a relative global complete intersection over $R$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-dimension-fibres-bounded-open-upstairs}
there exists a $g \in S$, $g \not \in \mathfrak q$
such that all nonempty fibres of $R \to S_g$
have dimension $\leq n - c$. Let $h \in R[x_1, \ldots, x_n]$
be an element that maps to $g$.
Then $S_g \cong R[x_1, \ldots, x_n, x_{n + 1}]/(f_1, \ldots, f_c, f_{c + 1})$
with $f_{c + 1} = h x_{n + 1} - 1$. Thus $S_g$ is a
relative global complete intersection.
\end{proof}

\begin{lemma}
\label{lemma-relative-global-complete-intersection-Noetherian}
Let $R$ be a ring. Let $S$ be a relative global complete intersection
with presentation $S = R[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$.
Let $\mathfrak q \subset S$ be a prime. There exist
\begin{enumerate}
\item  a finite type $\mathbf{Z}$-subalgebra $R_0 \subset R$
such that $f_i \in R_0[x_1, \ldots, x_n]$, and
\item an element $h \in R_0[x_1, \ldots, x_n]$
\end{enumerate}
such that with $f_{c + 1} = h x_{n + 1} - 1$ we have
\begin{enumerate}
\item $h$ maps to an element $g$ of $S$ which is not in $\mathfrak q$, and
\item $R_0[x_1, \ldots, x_n, x_{n + 1}]/(f_1, \ldots, f_c, f_{c + 1})$
is a relative global complete intersection over $R_0$.
\end{enumerate}
In particular $S_g$ is isomorphic to the base change of a
relative global complete intersection over $R_0$.
\end{lemma}

\begin{proof}
Let $R_0 \subset R$ be the $\mathbf{Z}$-algebra of $R$
generated by all the coefficients of the polynomials
$f_1, \ldots, f_c$. Let $S_0 = R_0[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$.
Clearly, $S = R \otimes_{R_0} S_0$.
Suppose our $\mathfrak q \subset S$ lies over
the prime  $\mathfrak p \subset R$, and
let $\mathfrak q_0 \subset S_0$ be the corresponding prime
lying over the prime $\mathfrak p_0$ of $R_0$.
Because $\dim (S \otimes_R \kappa(\mathfrak p) ) = n - c$
we also have $\dim (S_0 \otimes_{R_0} \kappa(\mathfrak p_0)) = n - c$,
see Lemma \ref{lemma-dimension-preserved-field-extension} for example.
By Lemma \ref{lemma-localize-relative-complete-intersection} we
conclude that there exists a $g \in S_0$, $g \not \in \mathfrak q_0$
such that $R_0 \to (S_0)_g$ is a relative global complete
intersection. Let $h \in R_0[x_1, \ldots, x_n]$ be any element
mapping to $g$.
\end{proof}

\begin{lemma}
\label{lemma-relative-global-complete-intersection-conormal}
Let $R$ be a ring. Let $S = R[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$
be a relative global complete intersection. For every prime
$\mathfrak q$ of $S$, let $\mathfrak q'$ denote the corresponding
prime of $R[x_1, \ldots, x_n]$. Then
\begin{enumerate}
\item $f_1, \ldots, f_c$ is a regular sequence in the local ring
$R[x_1, \ldots, x_n]_{\mathfrak q'}$,
\item each of the rings
$R[x_1, \ldots, x_n]_{\mathfrak q'}/(f_1, \ldots, f_i)$ is flat over $R$, and
\item the $S$-module $(f_1, \ldots, f_c)/(f_1, \ldots, f_c)^2$
is free with basis given by the elements $f_i \bmod (f_1, \ldots, f_c)^2$.
\end{enumerate}
\end{lemma}

\begin{proof}
First, by Lemma \ref{lemma-regular-quasi-regular}, the last statement
follows from the first.

\medskip\noindent
We first reduce (1) and (2) to the Noetherian case.
Namely, assume the lemma holds in the Noetherian case.
For every $\mathfrak q$ we may choose $R_0$, $h$,
$f_{c + 1} = hx_{n + 1} - 1$ and $g$
as in Lemma \ref{lemma-relative-global-complete-intersection-Noetherian}.
Denote $\mathfrak q'' \subset R[x_1, \ldots, x_{n + 1}]$ the unique
prime containing $\mathfrak q$ and $f_{c + 1}$, i.e., the one that
corresponds to the prime $\mathfrak qS_g$ via the isomorphism
$S_g = R[x_1, \ldots, x_n, x_{n + 1}]/(f_1, \ldots, f_c, f_{c + 1})$.
Denote $\mathfrak q_0'' \subset R_0[x_1, \ldots, x_n, x_{n + 1}]$
the prime corresponding to $q''$. Because
$S_0 = R_0[x_1, \ldots, x_n, x_{n + 1}]/(f_1, \ldots, f_c, f_{c + 1})$
is a relative global complete intersection over a Noetherian ring
we see that $f_{c + 1}, f_1, \ldots, f_c$ is a regular sequence
in $R_0[x_1, \ldots, x_{n + 1}]_{\mathfrak q_0''}$. Since after all
we may reorder the elements at will without destroying the
property of being a relative global complete intersection.
Similarly each ring
$R_0[x_1, \ldots, x_{n + 1}]_{\mathfrak q_0''}/(f_{c + 1}, f_1, \ldots, f_i)$
is flat over $R_0$. Thus each short exact sequence
$$
0 \to
\frac{(P_0)_{\mathfrak q_0''}}{(f_{c + 1}, f_1, \ldots, f_{i - 1})}
\to
\frac{(P_0)_{\mathfrak q_0''}}{(f_{c + 1}, f_1, \ldots, f_{i - 1})}
\to
\frac{(P_0)_{\mathfrak q_0''}}{(f_{c + 1}, f_1, \ldots, f_i)}
\to
0
$$
and the short exact sequence
$$
0 \to
(P_0)_{\mathfrak q_0''}
\to
(P_0)_{\mathfrak q_0''}
\to
(P_0)_{\mathfrak q_0''}/(f_{c + 1})
\to
0
$$
with $P_0 = R_0[x_1, \ldots, x_n, x_{n + 1}]$ remain exact upon tensoring
over $R_0$ with $R$, see Lemma \ref{lemma-flat-tor-zero}.
Since $R[x_1, \ldots, x_n, x_{n + 1}]_{\mathfrak q''}$ is a
localization of $R \otimes_{R_0} P_0$ we conclude that
$f_{c + 1}, f_1, \ldots, f_c$ form a regular sequence in the local ring
$R[x_1, \ldots, x_n, x_{n + 1}]_{\mathfrak q''}$.
Finally we use the obvious isomorphism
$R[x_1, \ldots, x_{n + 1}]_{\mathfrak q''}/(f_{c + 1})
\cong R[x_1, \ldots, x_n]_{\mathfrak q'}$, to conclude that
$f_1, \ldots, f_c$ form a regular sequence in the local ring
$R[x_1, \ldots, x_n]_{\mathfrak q'}$. Similarly
the quotients
$$
R[x_1, \ldots, x_n, x_{n + 1}]_{\mathfrak q''}/(f_{c + 1}, f_1, \ldots, f_i)
\cong R[x_1, \ldots, x_n]_{\mathfrak q'}/(f_1, \ldots, f_i)
$$
are flat over $R$ as desired.

\medskip\noindent
It remains to show (1) and (2) in case $R$ is Noetherian.
By Lemma \ref{lemma-lci} for example we see that $f_1, \ldots, f_c$
form a regular sequence in the local ring
$R[x_1, \ldots, x_n]_{\mathfrak q'}\otimes_R \kappa(\mathfrak p)$.
Moreover, the local ring $R[x_1, \ldots, x_n]_{\mathfrak q'}$
is flat over $R_{\mathfrak p}$. Since $R$, and hence
$R[x_1, \ldots, x_n]_{\mathfrak q'}$ is Noetherian we
may apply Lemma \ref{lemma-grothendieck-regular-sequence}
to conclude.
\end{proof}

\begin{lemma}
\label{lemma-relative-global-complete-intersection}
A relative global complete intersection is syntomic.
\end{lemma}

\begin{proof}
Let $R \to S$ be a relative global complete intersection.
The fibres are global complete intersections, and
$S$ is of finite presentation over $R$.
Thus the only thing to prove is that $R \to S$ is flat.
This is true by (2) of
Lemma \ref{lemma-relative-global-complete-intersection-conormal} above.
\end{proof}


\noindent
The following technical lemma says that you can lift any sequence
of relations from a fibre to the whole space of a ring
map which is essentially of finite type, in a suitable sense.

\begin{lemma}
\label{lemma-lift-elements-ideal}
Let $R \to S$ be a ring map.
Let $\mathfrak p \subset R$ be a prime.
Let $\mathfrak q \subset S$ be a prime lying over $\mathfrak p$.
Assume $S_{\mathfrak q}$ is essentially of finite type over $R_\mathfrak p$.
Assume given
\begin{enumerate}
\item an integer $n \geq 0$,
\item a prime $\mathfrak a \subset \kappa(\mathfrak p)[x_1, \ldots, x_n]$,
\item a surjective $\kappa(\mathfrak p)$-homomorphism
$$
\psi : (\kappa(\mathfrak p)[x_1, \ldots, x_n])_{\mathfrak a}
\longrightarrow
S_{\mathfrak q}/\mathfrak p S_{\mathfrak q},
$$
and
\item elements $\overline{f}_1, \ldots, \overline{f}_e$ in $\text{Ker}(\psi)$.
\end{enumerate}
Then there exist
\begin{enumerate}
\item an integer $m \geq 0$,
\item and element $g \in S$, $g \not\in \mathfrak q$,
\item a map
$$
\Psi :
R[x_1, \ldots, x_n, x_{n + 1}, \ldots, x_{n + m}]
\longrightarrow
S_g,
$$
and
\item elements $f_1, \ldots, f_e, f_{e + 1}, \ldots, f_{e + m}$
of $\text{Ker}(\Psi)$
\end{enumerate}
such that
\begin{enumerate}
\item the following diagram commutes
$$
\xymatrix{
R[x_1, \ldots, x_{n + m}] \ar[d]_\Psi
\ar[rr]_-{x_{n + j} \mapsto 0} & &
(\kappa(\mathfrak p)[x_1, \ldots, x_n])_{\mathfrak a} \ar[d]^\psi \\
S_g \ar[rr] & &
S_{\mathfrak q}/\mathfrak p S_{\mathfrak q}
},
$$
\item the element $f_i$, $i \leq n$ maps to a unit times
$\overline{f}_i$ in the local ring
$$
(\kappa(\mathfrak p)[x_1, \ldots, x_{n + m}])_{
(\mathfrak a, x_{n + 1}, \ldots, x_{n + m})},
$$
\item the element $f_{e + j}$ maps to
a unit times $x_{n + j}$ in the same local ring, and
\item the induced map $R[x_1, \ldots, x_{n + m}]_{\mathfrak b}
\to S_{\mathfrak q}$ is surjective, where
$\mathfrak b = \Psi^{-1}(\mathfrak qS_g)$.
\end{enumerate}
\end{lemma}

\begin{proof}
We claim that it suffices to prove the lemma in case $R$
and $S$ are local with maximal ideals $\mathfrak p$ and $\mathfrak q$.
Namely, suppose we have constructed
$$
\Psi' : R_{\mathfrak p}[x_1, \ldots, x_{n + m}]
\longrightarrow
S_{\mathfrak q}
$$
and $f_1', \ldots, f_{e + m}' \in R_{\mathfrak p}[x_1, \ldots, x_{n + m}]$
with all the required properties. Then there exists an element
$f \in R$, $f \not \in \mathfrak p$ such that each
$ff_k'$ comes from an element $f_k \in R[x_1, \ldots, x_{n + m}]$.
Moreover, for a suitable $g \in S$, $g \not \in \mathfrak q$
the elements $\Psi'(x_i)$ are the image of elements
$y_i \in S_g$. Let $\Psi$ be the $R$-algebra map defined
by the rule $\Psi(x_i) = y_i$. Since $\Psi(f_i)$ is zero
in the localization $S_{\mathfrak q}$ we may after possibly
replacing $g$ assume that $\Psi(f_i) = 0$. This proves the claim.

\medskip\noindent
Thus we may assume $R$ and $S$ are local
with maximal ideals $\mathfrak p$ and $\mathfrak q$.
Pick $y_1, \ldots, y_n \in S$ such that
$y_i \bmod \mathfrak pS = \psi(x_i)$.
Let $y_{n + 1}, \ldots, y_{n + m} \in S$ be elements which generate
an $R$-subalgebra of which $S$ is the localization.
These exist by the assumption that $S$ is essentially of
finite type over $R$. Since $\psi$ is surjective we
may write $y_{n + j} \bmod \mathfrak pS = \psi(h_j)$ for
some $h_j \in \kappa(\mathfrak p)[x_1, \ldots, x_n]_{\mathfrak a}$.
Write $h_j = g_j/d$, $g_j \in \kappa(\mathfrak p)[x_1, \ldots, x_n]$
for some common denominator $d \in \kappa(\mathfrak p)[x_1, \ldots, x_n]$,
$d \not \in \mathfrak a$. Choose lifts $G_j, D \in R[x_1, \ldots, x_n]$
of $g_j$ and $d$. Set
$y_{n + j}' = D(y_1, \ldots, y_n) y_{n + j} - G_j(y_1, \ldots, y_n)$.
By construction $y_{n + j}' \in \mathfrak p S$.
It is clear that $y_1, \ldots, y_n, y_n', \ldots, y_{n + m}'$
generate an $R$-subalgebra of $S$ whose localization is $S$.
We define
$$
\Psi : R[x_1, \ldots, x_{n + m}] \to S
$$
to be the map that sends $x_i$ to $y_i$ for $i = 1, \ldots, n$
and $x_{n + j}$ to $y'_{n + j}$ for $j = 1, \ldots, m$. Properties
(1) and (4) are clear by construction. Moreover the ideal
$\mathfrak b$ maps onto the ideal
$(\mathfrak a, x_{n + 1}, \ldots, x_{n + m})$
in the polynomial ring $\kappa(\mathfrak p)[x_1, \ldots, x_{n + m}]$.

\medskip\noindent
Denote $J = \text{Ker}(\Psi)$. We have a short exact sequence
$$
0 \to J_{\mathfrak b}
\to R[x_1, \ldots, x_{n + m}]_{\mathfrak b}
\to S_{\mathfrak q}
\to 0.
$$
The surjectivity comes from our choice of
$y_1, \ldots, y_n, y_n', \ldots, y_{n + m}'$ above.
This implies that
$$
J_{\mathfrak b}/ \mathfrak pJ_{\mathfrak b}
\to \kappa(\mathfrak p)[x_1, \ldots, x_{n + m}]_{
(\mathfrak a, x_{n + 1}, \ldots, x_{n + m})}
\to S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}
\to 0
$$
is exact. By construction $x_i$ maps to $\psi(x_i)$ and
$x_{n + j}$ maps to zero under the last map.
Thus it is easy to choose $f_i$ as in
(2) and (3) of the lemma.
\end{proof}

\begin{lemma}
\label{lemma-syntomic}
Let $R \to S$ be a ring map.
Let $\mathfrak q \subset S$ be a prime lying over
the prime $\mathfrak p$ of $R$.
The following are equivalent:
\begin{enumerate}
\item There exists an element $g \in S$, $g \not \in \mathfrak q$ such that
$R \to S_g$ is syntomic.
\item There exists an element $g \in S$, $g \not \in \mathfrak q$
such that $S_g$ is a relative global complete intersection over $R$.
\item There exists an element $g \in S$, $g \not \in \mathfrak q$,
such that $R \to S_g$ is of finite presentation,
the local ring map $R_{\mathfrak p} \to S_{\mathfrak q}$ is flat, and
the local ring $S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}$ is
a complete intersection ring over $\kappa(\mathfrak p)$ (see
Definition \ref{definition-lci-local-ring}).
\end{enumerate}
\end{lemma}

\begin{proof}
The implication (1) $\Rightarrow$ (3) is clear (see
Lemma \ref{lemma-lci-at-prime}).
The implication (2) $\Rightarrow$ (1) follows from
Lemma \ref{lemma-relative-global-complete-intersection}.
Assume (3). After replacing $S$ by $S_g$ for some
$g \in S$, $g\not\in \mathfrak q$ we may assume $S$
is finitely presented over $R$.

\medskip\noindent
We use this to reduce to the case where $R$ is Noetherian.
Namely, write $R \to S$ as a directed colimit
of map $R_\lambda \to S_\lambda$ as in
Lemma \ref{lemma-limit-finite-presentation}.
Denote $\mathfrak q_\lambda \subset S_\lambda$ and
$\mathfrak p_\lambda \subset R_\lambda$ the corresponding
prime ideals. Note that
$$
S_\lambda \otimes_{R_\lambda} \kappa(\mathfrak p_\lambda)
\otimes_{\kappa(\mathfrak p_\lambda)} \kappa(\mathfrak p)
\cong
S\otimes_R \kappa(\mathfrak p).
$$
Our assumption implies that $S \otimes_R \kappa(\mathfrak p)$
satisfies any of the conditions (1) - (5) of
Lemma \ref{lemma-lci} at the prime corresponding to
$\mathfrak q$, see Lemma \ref{lemma-lci-at-prime}.
By Lemma \ref{lemma-lci-field-change-local}
we see that the same holds for
$S_\lambda \otimes_{R_\lambda} \kappa(\mathfrak p_\lambda)$
at the prime corresponding to $\mathfrak q_\lambda$.
Moreover, for some sufficiently large $\lambda$
the local ring map $(R_\lambda)_{\mathfrak p_\lambda}
\to (S_\lambda)_{\mathfrak q_\lambda}$ is flat,
by Lemma \ref{lemma-colimit-eventually-flat}.
In other words, all the conditions of (3) hold
for $(R_\lambda \to S_\lambda, \mathfrak q_\lambda)$.
If we can show that (2) holds for
$(R_\lambda \to S_\lambda, \mathfrak q_\lambda)$
then it follows for $(R \to S, \mathfrak q)$.
Thus we have reduced to the case where $R$ is Noetherian.

\medskip\noindent
By the last statement of Lemma \ref{lemma-lci}
we may find a surjective $\kappa(\mathfrak p)$-algebra map
$\psi : \kappa(\mathfrak p)[x_1, \ldots, x_n]_{\mathfrak a}
\to S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}$ whose
kernel is generated by a regular sequence
$\overline{f}_1, \ldots, \overline{f}_c$ of
$\kappa(\mathfrak p)[x_1, \ldots, x_n]_{\mathfrak a}$.
We apply Lemma \ref{lemma-lift-elements-ideal}.
Thus we find a $g \in S$, $g \not \in \mathfrak q$,
a map $\Psi : R[x_1, \ldots, x_{n + m}] \to S_g$
and elements $f_1, \ldots, f_{c + m}$ in the kernel
of $\Psi$ which (up to units) give the elements
$\overline{f}_1, \ldots, \overline{f}_c, x_{n + 1}, \ldots, x_{n + m}$
in the local ring
$\kappa(\mathfrak p)[x_1, \ldots, x_{n + m}]_{
(\mathfrak a, x_{n + 1}, \ldots, x_{n + m})}$.
Moreover, the referenced lemma shows the induced map
$R[x_1, \ldots, x_{n + m}]_{\mathfrak b} \to S_{\mathfrak q}$
is surjective, where $\mathfrak b \subset R[x_1, \ldots, x_{n + m}]$
is a suitable prime ideal. Consider the induced map
$$
\overline{\Psi} :
S' := R[x_1, \ldots, x_{n + m}]/(f_1, \ldots, f_{c + m})
\longrightarrow
S_g.
$$
We now know it has the following properties:
\begin{enumerate}
\item it induces an surjection between the localizations
at the primes $\mathfrak q' = \mathfrak b/(f_i)$ and $\mathfrak qS_g$
\item it induces an isomorphism
$S'_{\mathfrak q'}/\mathfrak pS'_{\mathfrak q'} \to
S_{\mathfrak q}/\mathfrak p S_{\mathfrak q}$,
\item the local ring $S_{\mathfrak q}$ is flat over $R_{\mathfrak p}$.
\end{enumerate}
Denoting $J = \text{Ker}(\overline{\Psi})$, we see that
$0 \to J_{\mathfrak q'} \to S'_{\mathfrak q'} \to S_{\mathfrak q} \to 0$
is exact. By flatness of $S_{\mathfrak q}$ over $R_{\mathfrak p}$
we see that
$0 \to
J_{\mathfrak q'}/\mathfrak pJ_{\mathfrak q'} \to
S'_{\mathfrak q'}/\mathfrak p S_{\mathfrak q} \to
S_{\mathfrak q}/\mathfrak pS_{\mathfrak q} \to 0$
is exact. By the second property above we conclude that
$J_{\mathfrak q'}/\mathfrak pJ_{\mathfrak q'} = 0$.
Because $R$ and hence $S'$ is Noetherian, we conclude
that $J_{\mathfrak q'} = 0$, in other words
$S'_{\mathfrak q'} \cong S_{\mathfrak q}$.
By Lemma \ref{lemma-local-isomorphism}, we conclude there exists
a $g' \in S'$, $g' \not \in \mathfrak q'$
such that $S'_{g'} \cong S_{g\overline{\Psi}(g')}$.
By Lemma \ref{lemma-localize-relative-complete-intersection}
applied to $S'$ and the prime $\mathfrak q'$ (note that
$\dim_{\mathfrak q'}(S'/R) = n + m - (c + m)$ by the
explicit description of the sequence $f_j$) there exists
a further element $g'' \in S'$, $g'' \not \in \mathfrak q'$
such that $S'_{g''}$ is a relative global complete intersection
over $R$. By
Lemma \ref{lemma-base-change-relative-global-complete-intersection}
we conclude that $S'_{g'g''} \cong S_{g\overline{\Psi}(g'g'')}$
is a relative global complete intersection over $R$, as desired.
\end{proof}

\begin{lemma}
\label{lemma-composition-syntomic}
Let $R \to S$, $S \to S'$ be ring maps.
\begin{enumerate}
\item If $R \to S$ and $S \to S'$ are syntomic, then $R \to S'$
is syntomic.
\item If $R \to S$ and $S \to S'$ are relative global complete intersections
so is $R \to S'$.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume $R \to S$ and $S \to S'$ are syntomic.
This implies that $R \to S'$ is flat by
Lemma \ref{lemma-composition-flat}.
It also implies that $R \to S'$ is of finite presentation by
Lemma \ref{lemma-compose-finite-type}.
Thus it suffices to show that the fibres of $R \to S'$ are
local complete intersections.
Choose a prime $\mathfrak p \subset R$.
We have a factorization
$$
\kappa(\mathfrak p) \to
S \otimes_R \kappa(\mathfrak p) \to
S' \otimes_R \kappa(\mathfrak p).
$$
By assumption $S \otimes_R \kappa(\mathfrak p)$ is
a local complete intersection, and by Lemma \ref{lemma-base-change-syntomic}
we see that $S\otimes_R \kappa(\mathfrak p)$ is syntomic over
$S \otimes_R \kappa(\mathfrak p)$.
After replacing $S$ by $S \otimes_R \kappa(\mathfrak p)$
and $S'$ by $S' \otimes_R \kappa(\mathfrak p)$ we may assume
that $R$ is a field. Say $R = k$.

\medskip\noindent
Choose a prime $\mathfrak q' \subset S'$ lying over the prime
$\mathfrak q$ of $S$. Our goal is to find a $g' \in S'$,
$g' \not \in \mathfrak q'$ such that $S'_{g'}$ is a global complete
intersection over $k$. Choose a $g \in S$, $g \not \in \mathfrak q$
such that $S_g = k[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$ is
a global complete intersection over $k$.
Since $S_g \to S'_g$ is still syntomic also, and $g \not \in \mathfrak q'$
we may replace $S$ by $S_g$ and $S'$ by $S'_g$ and assume that
$S =  k[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$ is
a global complete intersection over $k$. Next we choose a $g' \in S'$,
$g' \not \in \mathfrak q'$ such that
$S' = S[y_1, \ldots, y_m]/(h_1, \ldots, h_d)$
is a relative global complete intersection over $S$.
Hence we have reduced to part (2) of the lemma.

\medskip\noindent
Suppose that $R \to S$ and $S \to S'$ are
relative global complete intersections. Say
$S =  R[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$
and
$S' = S[y_1, \ldots, y_m]/(h_1, \ldots, h_d)$.
Then
$$
S' \cong
R[x_1, \ldots, x_n, y_1, \ldots, y_m]/(f_1, \ldots, f_c, h'_1, \ldots, h'_d)
$$
for some lifts $h_j' \in R[x_1, \ldots, x_n, y_1, \ldots, y_m]$ of the $h_j$.
Hence it suffices to bound the dimensions of the fibres.
Thus we may yet again assume $R = k$ is a field.
In this case we see that we have a ring, namely $S$, which is of finite
type over $k$ and equidimensional of dimension $n - c$, and a
finite type ring map $S \to S'$ all of whose nonempty fibre
rings are equidimensional of dimension $m - d$. Then, by
Lemma \ref{lemma-dimension-base-fibre-total} for example applied
to localizations at maximal ideals of $S'$, we see that
$\dim(S') \leq n - c + m - d$ as desired.
\end{proof}


\begin{lemma}
\label{lemma-lift-syntomic}
Let $R$ be a ring and let $I \subset R$ be an ideal.
Let $R/I \to \overline{S}$ be a syntomic map.
Then there exists elements $\overline{g}_i \in \overline{S}$
which generate the unit ideal of $\overline{S}$
such that each $\overline{S}_{g_i} \cong S_i/IS_i$
for some relative global complete intersection $S_i$
over $R$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-syntomic} we find a collection of elements
$\overline{g}_i \in \overline{S}$
which generate the unit ideal of $\overline{S}$
such that each $\overline{S}_{g_i}$ is a relative
global complete intersection over $R/I$.
Hence we may assume that $\overline{S}$ is a
relative global complete intersection.
Write
$\overline{S} =
(R/I)[x_1, \ldots, x_n]/(\overline{f}_1, \ldots, \overline{f}_c)$
as in Definition \ref{definition-relative-global-complete-intersection}.
Choose $f_1, \ldots, f_c \in R[x_1, \ldots, x_n]$
lifting $\overline{f}_1, \ldots, \overline{f}_c$.
Set $S = R[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$.
Note that $S/IS \cong \overline{S}$.
Choose a prime $\overline{\mathfrak q}$ of $\overline{S}$,
and let $\mathfrak q \subset S$ be the corresponding prime of $S$.
By Lemma \ref{lemma-localize-relative-complete-intersection}
there exists an element $g \in S$, $g \not\in \mathfrak q$
such that $S_g$ is a relative global complete intersection over $R$.
And $\overline{S}_{\overline{g}} \cong S_g/IS_g$. This
proves the lemma.
\end{proof}


\section{Smooth ring maps}
\label{section-smooth}

\noindent
We use the following definition for smooth ring maps.
You may be more used to the definition comparing the
rank of $\Omega_{S/R}$ to the relative dimension of $S/R$;
we will see later (insert future reference here) that this
is equivalent.

\begin{definition}
\label{definition-smooth}
A ring map $R \to S$ is {\it smooth} if it is of finite presentation
and for any presentation $\alpha$ the naive cotangent complex $NL(\alpha)$
is quasi-isomorphic to a finite projective $S$-module placed in degree $0$.
\end{definition}

\noindent
In particular the module $\Omega_{S/R}$ is a finite projective
$S$-module. Moreover, for any presentation
$\alpha : R[x_1, \ldots, x_n] \to S$ with kernel $I$
the map
$$
I/I^2
\longrightarrow
\Omega_{R[x_1, \ldots, x_n]/R} \otimes_{R[x_1, \ldots, x_n]} S
$$
is a split injection. In other words
$\bigoplus_{i = 1}^n S \text{d}x_i \cong I/I^2 \oplus \Omega_{S/R}$
as $S$-modules. This implies that $I/I^2$ is a finite projective
$S$-module too!

\begin{lemma}
\label{lemma-localize-smooth}
Let $R \to S$ be a smooth ring map.
Any localization $S_g$ is smooth over $R$.
If $f \in R$ maps to an invertible element of $S$,
then $R_f \to S$ is smooth.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-localize-NL} we see that the naive cotangent
complex for $S_g$ over $R$ is the base change of the naive cotangent
complex of $S$ over $R$. The assumption is that the naive cotangent
complex of $S/R$ is $\Omega_{S/R}$ and that this is a finite projective
$S$-module. Hence so is its base change. Thus $S_g$ is smooth over $R$.

\medskip\noindent
For the last assertion: A presentation of $S$ over
$R_f$ is $R_f[x_1, \ldots, x_n]/I_f$. Since $I_f/I_f^2
= (I/I^2)_f = I/I^2$ we see that this presentation
has isomorphic naive cotangent complex to the presentation
of $S$ over $R$. The result follows.
\end{proof}

\begin{lemma}
\label{lemma-base-change-smooth}
Let $R \to S$ be a smooth ring map.
Let $R \to R'$ be any ring map.
Then the base change $R' \to S' = R' \otimes_R S$ is smooth.
\end{lemma}

\begin{proof}
Let $\alpha : R[x_1, \ldots, x_n] \to S$ be a presentation
with kernel $I$. Let $\alpha' : R'[x_1, \ldots, x_n] \to R' \otimes_R S$
be the induced presentation. Let $I' = \text{Ker}(\alpha')$.
Since $0 \to I \to R[x_1, \ldots, x_n] \to S \to 0$
is exact, the sequence
$R' \otimes_R I \to R'[x_1, \ldots, x_n] \to R' \otimes_r S \to 0$
is exact. Thus $R' \otimes_R I \to I'$ is surjective.
By Definition \ref{definition-smooth} there is a short exact sequence
$$
0 \to I/I^2 \to
\Omega_{R[x_1, \ldots, x_n]/R} \otimes_{R[x_1, \ldots, x_n]} S \to
\Omega_{S/R} \to
0
$$
and the $S$-module $\Omega_{S/R}$ is finite projective.
In particular $I/I^2$ is a direct summand of
$\Omega_{R[x_1, \ldots, x_n]/R} \otimes_{R[x_1, \ldots, x_n]} S$.
Consider the commutative diagram
$$
\xymatrix{
R' \otimes_R (I/I^2) \ar[r] \ar[d] &
R' \otimes_R (\Omega_{R[x_1, \ldots, x_n]/R} \otimes_{R[x_1, \ldots, x_n]} S)
\ar[d] \\
I'/(I')^2 \ar[r] &
\Omega_{R'[x_1, \ldots, x_n]/R'}
\otimes_{R'[x_1, \ldots, x_n]} (R' \otimes_R S)
}
$$
Since the right vertical map is an isomorphism we see that
the left vertical map is injective and surjective by what was
said above. Thus we conclude that $NL(\alpha')$ is quasi-isomorphic
to $\Omega_{S'/R'} \cong S' \otimes_S \Omega_{S/R}$.
And this is finite projective since it is the base change
of a finite projective module.
\end{proof}

\begin{lemma}
\label{lemma-smooth-over-field}
Let $k$ be a field.
Let $S$ be a smooth $k$-algebra.
Then $S$ is a local complete intersection.
\end{lemma}

\begin{proof}
By Lemmas \ref{lemma-base-change-smooth} and
\ref{lemma-lci-field-change} it suffices to prove this when
$k$ is algebraically closed. Choose a presentation
$\alpha : k[x_1, \ldots, x_n] \to S$ with kernel $I$. Let $\mathfrak m$
be a maximal ideal of $S$, and let $\mathfrak m' \subset I$ be the
corresponding maximal ideal of $k[x_1, \ldots, x_n]$.
It suffices to prove that condition (5) of Lemma
\ref{lemma-lci} holds (with $\mathfrak m$ instead of $\mathfrak q$).
We may write $\mathfrak m' = (x_1 - a_1, \ldots, x_n - a_n)$
for some $a_i \in k$, because $k$ is algebraically closed.
Since $I/I^2 \to \bigoplus_{i = 1}^n S \text{d}x_i$
is a split injection the corresponding map
$I/\mathfrak m' I \to \bigoplus \kappa(\mathfrak m') \text{d}x_i$
is injective. We leave it to the reader to check that the diagram
$$
\xymatrix{
I \ar[r] \ar[d] & I/I^2 \ar[rr] \ar[d] & &
I/\mathfrak m'I \ar[d] \\
\Omega_{k[x_1, \ldots, x_n]/k} \ar[r] &
\bigoplus S\text{d}x_i \ar[rr]^{\text{d}x_i \mapsto x_i - a_i} & &
\mathfrak m'/(\mathfrak m')^2
}
$$
is commutative. Here the middle vertical map is the one defining the
naive cotangent complex of $\alpha$.
We conclude, using Nakayama's lemma,
that a minimal set of generators $f_1, \ldots, f_c$
of $I_{\mathfrak m'}$ map to a collection of elements
in $k[x_1, \ldots, x_n]_{\mathfrak m'}$ whose classes in
$\mathfrak m'/(\mathfrak m')^2$ are linearly independent.
Therefore they form a regular sequence (see Lemma \ref{lemma-regular-ring-CM})
as desired.
\end{proof}

\begin{definition}
\label{definition-standard-smooth}
Let $R$ be a ring.
A {\it standard smooth algebra over $R$} is a an algebra
$S$ with a (given) presentation
$$
S = R[x_1, \ldots, x_n]/(f_1, \ldots, f_c)
$$
such that the polynomial
$$
g =
\det
\left(
\begin{matrix}
\partial f_1/\partial x_1 &
\partial f_2/\partial x_1 &
\ldots &
\partial f_c/\partial x_1 \\
\partial f_1/\partial x_2 &
\partial f_2/\partial x_2 &
\ldots &
\partial f_c/\partial x_2 \\
\ldots & \ldots & \ldots & \ldots \\
\partial f_1/\partial x_c &
\partial f_2/\partial x_c &
\ldots &
\partial f_c/\partial x_c
\end{matrix}
\right)
$$
maps to an invertible element in $S$.
\end{definition}

\begin{lemma}
\label{lemma-standard-smooth}
Let
$S = R[x_1, \ldots, x_n]/(f_1, \ldots, f_c) = R[x_1, \ldots, x_n]/I$
be a standard smooth algebra. Then
\begin{enumerate}
\item the ring map $R \to S$ is smooth,
\item the $S$-module $\Omega_{S/R}$ is free on
$\text{d}x_{c + 1}, \ldots, \text{d}x_n$,
\item the $S$-module $I/I^2$ is free on the classes of $f_1, \ldots, f_c$,
\item for any $g \in S$ the ring map $R \to S_g$ is standard smooth,
\item for any ring map $R \to R'$ the base change
$R' \to R'\otimes_R S$ is standard smooth,
\item if $f \in R$ maps to an invertible element in $S$, then
$R_f \to S$ is standard smooth, and
\item the ring $S$ is a relative global complete intersection over $R$.
\end{enumerate}
\end{lemma}

\begin{proof}
Consider the naive cotangent complex of the given presentation
$$
(f_1, \ldots, f_c)/(f_1, \ldots, f_c)^2
\longrightarrow
\bigoplus\nolimits_{i = 1}^n S \text{d}x_i
$$
Let us compose this map with the projection onto the first $c$ direct summands
of the direct sum. According to the definition this maps the classes
$f_i \bmod (f_1, \ldots, f_c)^2$ to a basis of
$\bigoplus_{i = 1}^c S\text{d}x_i$. This proves on the one hand that
$(f_1, \ldots, f_c)/(f_1, \ldots, f_c)^2$ free of rank $c$, and
that $H^0$ (i.e., $\Omega_{S/R}$) of the cotangent complex is free
on the images of $\text{d}x_{c + j}$, $j = 1, \ldots, n - c$.
Moreover this proves $R \to S$ is smooth.

\medskip\noindent
The proofs of (4) and (6) are omitted. But see the example below and
the proof of
Lemma \ref{lemma-base-change-relative-global-complete-intersection}.

\medskip\noindent
Let $\varphi : R \to R'$ be any ring map.
Denote $S' = R'[x_1, \ldots, x_n]/(f_1^\varphi, \ldots, f_c^\varphi)$
where $f^\varphi$ is the polynomial obtained from $f \in R[x_1, \ldots, x_n]$
by applying $\varphi$ to all the coefficients. Then $S' \cong R' \otimes_R S$.
Moreover, the determinant of Definition \ref{definition-standard-smooth}
for $S'/R'$ is equal to $g^\varphi$. Its image in $S'$ is therefore
the image of $g$ via $R[x_1, \ldots, x_n] \to S \to S'$
and hence invertible. This proves (5).

\medskip\noindent
To prove (7) it suffices to show that
$S \otimes_R \kappa(\mathfrak p)$ has dimension $n - c$.
By (5) it suffices to prove that any standard smooth
algebra $k[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$
over a field $k$ has dimension $n - c$. We already
know that $k[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$ is a local
complete intersection by Lemma \ref{lemma-smooth-over-field} above.
Hence, since $I/I^2$ is free of rank $c$ we see that it dimension
$n - c$, by Lemma \ref{lemma-lci} for example.
\end{proof}

\begin{example}
\label{example-make-standard-smooth}
Let $R$ be a ring.
Let $f_1, \ldots, f_c \in R[x_1, \ldots, x_n]$.
Let
$$
h =
\det
\left(
\begin{matrix}
\partial f_1/\partial x_1 &
\partial f_2/\partial x_1 &
\ldots &
\partial f_c/\partial x_1 \\
\partial f_1/\partial x_2 &
\partial f_2/\partial x_2 &
\ldots &
\partial f_c/\partial x_2 \\
\ldots & \ldots & \ldots & \ldots \\
\partial f_1/\partial x_c &
\partial f_2/\partial x_c &
\ldots &
\partial f_c/\partial x_c
\end{matrix}
\right).
$$
Set $S = R[x_1, \ldots, x_{n + 1}]/(f_1, \ldots, f_c, x_{n + 1}h - 1)$.
This is an example of a standard smooth algebra, except that the
presentation is wrong and the variables should be in the
following order:
$x_1, \ldots, x_c, x_{n + 1}, x_{c + 1}, \ldots, x_n$.
\end{example}

\begin{lemma}
\label{lemma-compose-standard-smooth}
A composition of standard smooth ring maps is standard smooth.
\end{lemma}

\begin{proof}
Suppose that $R \to S$ and $S \to S'$ are standard smooth. We choose
presentations
$S =  R[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$
and
$S' = S[y_1, \ldots, y_m]/(g_1, \ldots, g_d)$.
Choose elements $g_j' \in R[x_1, \ldots, x_n, y_1, \ldots, y_m]$ mapping
to the $g_j$. In this way we see
$S' = R[x_1, \ldots, x_n, y_1, \ldots, y_m]/
(f_1, \ldots, f_c, g'_1, \ldots, g'_d)$.
To show that $S'$ is standard smooth it suffices to verify
that the determinant
$$
\det
\left(
\begin{matrix}
\partial f_1/\partial x_1 &
\ldots &
\partial f_c/\partial x_1 &
\partial g_1/\partial x_1 &
\ldots &
\partial g_d/\partial x_1 \\
\ldots &
\ldots &
\ldots &
\ldots &
\ldots &
\ldots  \\
\partial f_1/\partial x_c &
\ldots &
\partial f_c/\partial x_c &
\partial g_1/\partial x_c &
\ldots &
\partial g_d/\partial x_c \\
0 &
\ldots &
0 &
\partial g_1/\partial y_1 &
\ldots &
\partial g_d/\partial y_1 \\
\ldots &
\ldots &
\ldots &
\ldots &
\ldots &
\ldots  \\
0 &
\ldots &
0 &
\partial g_1/\partial y_d &
\ldots &
\partial g_d/\partial y_d
\end{matrix}
\right)
$$
is invertible in $S'$. This is clear since it is the product
of the two determinants which were assumed to be invertible
by hypothesis.
\end{proof}

\begin{lemma}
\label{lemma-smooth-syntomic}
Let $R \to S$ be a smooth ring map.
There exists an open covering of $\text{Spec}(S)$ by
standard opens $D(g)$ such that each $S_g$ is standard smooth
over $R$. In particular $R \to S$ is syntomic.
\end{lemma}

\begin{proof}
Choose a presentation $S = R[x_1, \ldots, x_n]/I$
with $I = (f_1, \ldots, f_m)$. For every subset
$E \subset \{1, \ldots, m\}$ consider the open
subset $U_E$ where the classes $f_e, e\in E$ freely generate
the finite projective $S$-module $I/I^2$, see Lemma \ref{lemma-cokernel-flat}.
We may cover $\text{Spec}(S)$ by standard opens $D(g)$ each
completely contained in one of the opens $U_E$. For such a $g$
we look at the presentation
$$
S_g =
R[x_1, \ldots, x_n, x_{n + 1}]/(f_1, \ldots, f_n, f_{n + 1}) =
R[x_1, \ldots, x_n, x_{n + 1}]/J
$$
with $f_{n + 1} = g x_{n + 1} - 1$. Since
$J/J^2 = (I/I^2)_g \oplus S_g \cdot f_{n + 1}$
we see that $J/J^2$ is freely generated by $f_e, e \in E$ and $f_{n + 1}$.
This reduces us to the case where $S$ has a presentation
$S = R[x_1, \ldots, x_n]/I$ with $I = (f_1, \ldots, f_m)$ and
with $I/I^2$ free on the classes of $f_1, \ldots, f_c$.

\medskip\noindent
Next, we more or less repeat this argument with
the basis elements $\text{d}x_1, \ldots, \text{d}x_n$
of $\Omega_{R[x_1, \ldots, x_n]/R} \otimes_R S$.
Namely, for any subset $E \subset \{1, \ldots, n\}$ we may
consider the open subset $U_E$ of $\text{Spec}(S)$, where
the differential of $NL(\alpha)$ composed with the projection
$$
S^{\oplus c} \cong I/I^2
\longrightarrow
\Omega_{R[x_1, \ldots, x_n]/R} \otimes_R S
\longrightarrow
\bigoplus\nolimits_{e \in E} S\text{d}x_i
$$
is an isomorphism. Again we may find a covering of $\text{Spec}(S)$
by (finitely many) standard opens $D(g)$ such that each $D(g)$
is completely contained in one of the opens $U_E$.
For a $g$ with $D(g) \subset U_E$ we look at the presentation
$$
S_g =
R[x_1, \ldots, x_n, x_{n + 1}]/(f_1, \ldots, f_n, f_{n + 1}) =
R[x_1, \ldots, x_n, x_{n + 1}]/J
$$
with $f_{n + 1} = g x_{n + 1} - 1$. Ok, and now we have
$J/J^2 = (I/I^2)_g \oplus S_g \cdot f_{n + 1}$, and
$\Omega_{R[x_1, \ldots, x_{n + 1}]/R} \otimes_R S_g =
\bigoplus_{i = 1}^{n + 1} S_g \text{d}x_i$, and
$\text{d}(f_{n + 1}) = g \text{d}x_{n + 1} + x_{n + 1} \text{d} g$.
From this  we see that
$J/J^2 \to (\bigoplus_{e \in E} S_g \text{d}x_e) \oplus S_g \text{d}x_{n + 1}$
is an isomorphism.
This reduces us to the case where $S$ has a presentation
$S = R[x_1, \ldots, x_n]/I$ with $I = (f_1, \ldots, f_m)$ and
with $I/I^2$ free on the classes of $f_1, \ldots, f_c$,
and furthermore the composition
$$
I/I^2
\longrightarrow
\Omega_{R[x_1, \ldots, x_n]/R} \otimes_R S
\longrightarrow
\bigoplus\nolimits_{i = 1}^c S\text{d}x_i
$$
is an isomorphism.

\medskip\noindent
At this point we consider the surjective map of $R$-algebras
$$
S' := R[x_1, \ldots, x_n]/(f_1, \ldots, f_c)
\longrightarrow
S = R[x_1, \ldots, x_n]/(f_1, \ldots, f_m).
$$
This is surjective. Let $J$ be the kernel. Note that
$J$ is finitely generated (by the images of $f_{c + 1}, \ldots, f_m$
in $S'$). Since $(f_1, \ldots, f_m)/(f_1, \ldots, f_m)^2$ is freely
generated by $f_1, \ldots, f_c$ we see that $J/J^2 = 0$.
By Lemma \ref{lemma-ideal-is-squared-union-connected}
we see that $\text{Spec}(S')$ contains $\text{Spec}(S)$
as an open and closed subset, and moreover that $S$ is a localization
$S = S'_{g'}$ for some element $g' \in S'$. Note that the determinant
$$
g =
\det
\left(
\begin{matrix}
\partial f_1/\partial x_1 &
\partial f_2/\partial x_1 &
\ldots &
\partial f_c/\partial x_1 \\
\partial f_1/\partial x_2 &
\partial f_2/\partial x_2 &
\ldots &
\partial f_c/\partial x_2 \\
\ldots & \ldots & \ldots & \ldots \\
\partial f_1/\partial x_c &
\partial f_2/\partial x_c &
\ldots &
\partial f_c/\partial x_c
\end{matrix}
\right)
$$
maps to an invertible element in $S$ (by the conclusion of the
previous paragraph). Hence
we actually have $S \cong S_{gg'}$. Since
$S'_g$ is standard smooth (see Example \ref{example-make-standard-smooth}),
we win because a principal localization of a standard smooth
algebra is standard smooth, see Lemma \ref{lemma-standard-smooth}.
\end{proof}

\begin{definition}
\label{definition-smooth-at-prime}
Let $R \to S$ be a ring map.
Let $\mathfrak q$ be a prime of $S$.
We say $R \to S$ is {\it smooth at $\mathfrak q$} if there
exists a $g \in S$, $g \not \in \mathfrak q$ such
that $R \to S_g$ is smooth.
\end{definition}

\begin{lemma}
\label{lemma-locally-smooth}
Let $R \to S$ be a ring map.
Then $R \to S$ is smooth if and only if $R \to S$ is smooth
at every prime $\mathfrak q$ of $S$.
\end{lemma}

\begin{proof}
The direct implication is trivial. Suppose that $R \to S$ is smooth
at every prime $\mathfrak q$ of $S$. Since $\text{Spec}(S)$ is
quasi-compact, see Lemma \ref{lemma-quasicompact},
there exists a finite covering
$\text{Spec}(S) = \bigcup D(g_i)$ such that each $S_{g_i}$ is
smooth. By Lemma \ref{lemma-cover-upstairs} this implies that
$S$ is of finite presentation over $R$. Let $NL(\alpha)$ be
the naive cotangent complex of $S$ over $R$ with respect to some
presentation $\alpha$. According to Lemma \ref{lemma-localize-NL}
we see that
$NL(\alpha)_{g_i}$ is quasi-isomorphic to a finite projective
$S_{g_i}$-module. By Lemma \ref{lemma-finite-projective}
this implies that $NL(\alpha)$ is quasi-isomorphic to a finite
projective $S$-module.
\end{proof}

\begin{lemma}
\label{lemma-compose-smooth}
A composition of smooth ring maps is smooth.
\end{lemma}

\begin{proof}
This follows from a combination of
Lemmas \ref{lemma-smooth-syntomic}, \ref{lemma-compose-standard-smooth}
and \ref{lemma-locally-smooth}.
(You can also prove this in many different ways; including easier
ones.)
\end{proof}

\begin{lemma}
\label{lemma-relative-global-complete-intersection-smooth}
Let $R$ be a ring. Let $S = R[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$
be a relative global complete intersection.
Let $\mathfrak q \subset S$ be a prime. Then $R \to S$
is smooth at $\mathfrak q$ if and only if there exists a
subset $I \subset \{1, \ldots, n\}$ of cardinality $c$
such that the polynomial
$$
g_I = \det (\partial f_j/\partial x_i)_{j = 1, \ldots, c, \ i \in I}.
$$
does not map to an element of $\mathfrak q$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-relative-global-complete-intersection-conormal}
we see that the naive cotangent complex
associated to the given presentation of $S$ is the complex
$$
\bigoplus\nolimits_{j = 1}^c S \cdot f_j
\longrightarrow
\bigoplus\nolimits_{i = 1}^n S \cdot \text{d}x_i, \ 
f_j \longmapsto \sum \frac{\partial f_j}{\partial x_i} \text{d}x_i.
$$
The maximal minors of the matrix giving the map are exactly
the polynomials $g_I$.

\medskip\noindent
Assume $g_I$ maps to $g \in S$, wioth $g \not \in \mathfrak q$.
Then the algebra $S_g$ is smooth over $R$. Namely, its naive
cotangent complex is quasi-isomorphic to the complex above
localized at $g$, see Lemma \ref{lemma-localize-NL}. And by
construction it is quasi-isomorphic to a free rank $n - c$
module in degree $0$.

\medskip\noindent
Conversely, suppose that all $g_I$ end up in $\mathfrak q$.
In this case the complex above tensored with $\kappa(\mathfrak q)$
does not have maximal rank, and hence there is no localization
by an element $g \in S$, $g \not \in \mathfrak q$
where this map becomes a split injection. By Lemma \ref{lemma-localize-NL}
again there is no such localization which is smooth over $R$.
\end{proof}

\begin{lemma}
\label{lemma-flat-fibre-smooth}
Let $R \to S$ be a ring map.
Let $\mathfrak q \subset S$ be a prime lying over the
prime $\mathfrak p$ of $R$. Assume
\begin{enumerate}
\item there exists a $g \in S$, $g \not\in \mathfrak q$
such that $R \to S_g$ is of finite presentation,
\item the local ring homomorphism
$R_{\mathfrak p} \to S_{\mathfrak q}$ is flat,
\item the fibre $S \otimes_R \kappa(\mathfrak p)$ is smooth
over $\kappa(\mathfrak p)$ at the prime corresponding
to $\mathfrak q$.
\end{enumerate}
Then $R \to S$ is smooth at $\mathfrak q$.
\end{lemma}

\begin{proof}
By Lemmas \ref{lemma-syntomic} and \ref{lemma-smooth-over-field}
we see that there exists a $g \in S$ such that $S_g$ is a
relative global complete intersection. Replacing $S$ by $S_g$ we may assume
$S = R[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$ is a relative
global complete intersection.
For any subset $I \subset \{1, \ldots, n\}$ of cardinality
$c$ consider the polynomial
$g_I = \det (\partial f_j/\partial x_i)_{j = 1, \ldots, c, i \in I}$
of Lemma \ref{lemma-relative-global-complete-intersection-smooth}.
Note that the image $\overline{g}_I$ of $g_I$ in the polynomial ring
$\kappa(\mathfrak p)[x_1, \ldots, x_n]$ is the determinant
of the partial derivatives of the images $\overline{f}_j$ of the $f_j$
in the ring $\kappa(\mathfrak p)[x_1, \ldots, x_n]$. Thus the lemma follows
by applying Lemma \ref{lemma-relative-global-complete-intersection-smooth}
both to $R \to S$ and to
$\kappa(\mathfrak p) \to S \otimes_R \kappa(\mathfrak p)$.
\end{proof}

\noindent
Note that the sets $U, V$ in the following lemma
are open by definition.

\begin{lemma}
\label{lemma-flat-base-change-locus-smooth}
Let $R \to S$ be a ring map of finite presentation.
Let $R \to R'$ be a flat ring map.
Denote $S' = R' \otimes_R S$ the base change.
Let $U \subset \text{Spec}(S)$ be the set of primes at
which $R \to S$ is smooth.
Let $V \subset \text{Spec}(S')$ the set of primes at
which $R' \to S'$ is smooth.
Then $V$ is the inverse image of $U$ under the
map $f : \text{Spec}(S') \to \text{Spec}(S)$.
\end{lemma}

\begin{proof}
Choose a presentation $\alpha$ of $S$ over $R$ and
let $\alpha'$ be the associated presentation of $S'$
over $R'$, see Lemma \ref{lemma-change-base-NL}.
By that lemma we see that
$NL(\alpha) \otimes_S S' = NL(\alpha')$.
This already implies that $f^{-1}(U) \subset V$.

\medskip\noindent
Let $\mathfrak q' \subset S'$ be a prime lying over
$\mathfrak q \subset S$. Assume $\mathfrak q' \in V$.
We have to show that $\mathfrak q \in U$.
Since $S \to S'$ is flat,
we have that $S_{\mathfrak q} \to S'_{\mathfrak q'}$
is faithfully flat. Thus the vanishing of
$H^{-1}(NL(\alpha'))_{\mathfrak q'}$ implies the
vanishing of $H^{-1}(NL(\alpha))_{\mathfrak q}$.
The result then follows by applying
Lemma \ref{lemma-finite-projective-descends}
to the $S_{\mathfrak q}$-module $H^0(NL(\alpha))$
and the map $S_{\mathfrak q} \to S'_{\mathfrak q'}$.
\end{proof}

\begin{lemma}
\label{lemma-smooth-field-change-local}
Let $k \subset K$ be a field extension.
Let $S$ be a finite type algebra over $k$.
Let $\mathfrak q_K$ be a prime of $S_K = K \otimes_k S$
and let $\mathfrak q$ be the corresponding prime of $S$.
Then $S$ is smooth over $k$ at $\mathfrak q$ if and only if
$S_K$ is smooth at $\mathfrak q_K$ over $K$.
\end{lemma}

\begin{proof}
This is a special case of Lemma \ref{lemma-flat-base-change-locus-smooth}
above.
\end{proof}

\begin{lemma}
\label{lemma-lift-smooth}
Let $R$ be a ring and let $I \subset R$ be an ideal.
Let $R/I \to \overline{S}$ be a smooth ring map.
Then there exists elements $\overline{g}_i \in \overline{S}$
which generate the unit ideal of $\overline{S}$
such that each $\overline{S}_{g_i} \cong S_i/IS_i$
for some (standard) smooth ring $S_i$ over $R$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-smooth-syntomic} we find a collection of elements
$\overline{g}_i \in \overline{S}$
which generate the unit ideal of $\overline{S}$
such that each $\overline{S}_{g_i}$ is standard smooth over $R/I$.
Hence we may assume that $\overline{S}$ is standard smooth
over $R/I$. Write
$\overline{S} =
(R/I)[x_1, \ldots, x_n]/(\overline{f}_1, \ldots, \overline{f}_c)$
as in Definition \ref{definition-standard-smooth}.
Choose $f_1, \ldots, f_c \in R[x_1, \ldots, x_n]$
lifting $\overline{f}_1, \ldots, \overline{f}_c$.
Set $S = R[x_1, \ldots, x_n, x_{n+1}]/(f_1, \ldots, f_c, x_{n + 1}\Delta - 1)$
where $\Delta = \det(\frac{\partial f_i}{\partial x_j})_{i, j = 1, \ldots, c}$
as in Example \ref{example-make-standard-smooth}.
This proves the lemma.
\end{proof}








\section{Formally smooth maps}
\label{section-formally-smooth}

\begin{definition}
\label{definition-formally-smooth}
Let $R \to S$ be a ring map.
We say $S$ is {\it formally smooth over $R$} if for every
commutative solid diagram
$$
\xymatrix{
S \ar[r] \ar@{-->}[rd] & A/I \\
R \ar[r] \ar[u] & A \ar[u]
}
$$
where $I \subset A$ is an ideal of square zero, a dotted
arrow exists which makes the diagram commute.
\end{definition}

\begin{lemma}
\label{lemma-base-change-fs}
Let $R \to S$ be a formally smooth ring map.
Let $R \to R'$ be any ring map.
Then the base change $S' = R' \otimes_R S$ is formally smooth over $R'$.
\end{lemma}

\begin{proof}
Let a solid diagram
$$
\xymatrix{
S \ar[r] \ar@{-->}[rrd] & R' \otimes_R S \ar[r] \ar@{-->}[rd] & A/I \\
R  \ar[u] \ar[r] & R' \ar[r] \ar[u] & A \ar[u]
}
$$
as in Definition \ref{definition-formally-smooth} be given.
By assumption the longer dotted arrow exists. By the universal
property of tensor product we obtain the shorter dotted arrow.
\end{proof}

\begin{lemma}
\label{lemma-compose-formally-smooth}
A composition of formally smooth ring maps is formally smooth.
\end{lemma}

\begin{proof}
Omitted. (Hint: This is completely formal, and follows from considering
a suitable diagram.)
\end{proof}

\begin{lemma}
\label{lemma-polynomial-ring-formally-smooth}
A polynomial ring over $R$ is formally smooth over $R$.
\end{lemma}

\begin{proof}
Suppose we have a diagram as in Definition \ref{definition-formally-smooth}
with $S = R[x_j; j \in J]$. Then there exists a dotted arrow
simply by choosing lifts $a_j \in A$ of the elements in $A/I$
to which the elements $x_j$ map to under the top horizontal arrow.
\end{proof}

\begin{lemma}
\label{lemma-characterize-formally-smooth}
Let $R \to S$ be a ring map.
Let $P \to S$ be a surjective $R$-algebra map from a
polynomial ring $P$ onto $S$. Denote $J \subset P$ the
kernel. Then $R \to S$ is formally smooth if and only
if there exists an $R$-algebra map $\sigma : S \to P/J^2$
which is a right inverse to the surjection
$P/J^2 \to S$.
\end{lemma}

\begin{proof}
Assume $R \to S$ is formally smooth.
Consider the commutative diagram
$$
\xymatrix{
S \ar[r] \ar@{-->}[rd] & P/J \\
R \ar[r] \ar[u] &  P/J^2\ar[u]
}
$$
By assumption the dotted arrow exists. This proves that
$\sigma$ exists.

\medskip\noindent
Conversely, suppose we have a $\sigma$ as in the lemma.
Let a solid diagram
$$
\xymatrix{
S \ar[r] \ar@{-->}[rd] & A/I \\
R \ar[r] \ar[u] & A \ar[u]
}
$$
as in Definition \ref{definition-formally-smooth} be given.
Because $P$ is formally smooth by
Lemma \ref{lemma-polynomial-ring-formally-smooth},
there exists an $R$-algebra homomorphism
$\psi : P \to A$ which lifts the map $P \to S \to A/I$.
Clearly $\psi(J) \subset I$ and since $I^2 = 0$ we conclude that
$\psi(J^2) = 0$. Hence $\psi$ factors as
$\overline{\psi} : P/J^2 \to A$. The desired dotted arrow
is the composition $\overline{\psi} \circ \sigma : S \to A$.
\end{proof}

\begin{remark}
\label{remark-lemma-characterize-formally-smooth}
Lemma \ref{lemma-characterize-formally-smooth} above holds more
generally whenever $P$ is formally smooth over $R$.
\end{remark}

\begin{lemma}
\label{lemma-characterize-formally-smooth-again}
Let $R \to S$ be a ring map.
Let $P \to S$ be a surjective $R$-algebra map from a
polynomial ring $P$ onto $S$. Denote $J \subset P$ the
kernel. Then $R \to S$ is formally smooth if and only
if the sequence
$$
J/J^2 \to \Omega_{P/R} \otimes_R S \to \Omega_{S/R} \to 0
$$
of Lemma \ref{lemma-differential-seq} is a split exact sequence.
\end{lemma}

\begin{proof}
Assume $S$ is formally smooth over $R$. By
Lemma \ref{lemma-characterize-formally-smooth}
this means there exists an $R$-algebra map
$S \to P/J^2$ which is a left inverse to the
canonical map $P/J^2 \to S$. This means that
$$
P/J^2 \cong S \oplus J/J^2
$$
as $R$-algebras. Note that the middle term of the exact
sequence is $\Omega_{P/R} \otimes_P S \cong \Omega_{(P/J^2)/R} \otimes_R S$
by Lemma \ref{lemma-differential-mod-power-ideal}.
A direct computation shows that
$$
\Omega_{(S \oplus J/J^2)/R} \otimes_{(S \oplus J/J^2)} S =
\Omega_{S/R} \oplus J/J^2
$$
as desired.

\medskip\noindent
Assume the exact sequence of the lemma is split exact.
Choose a splitting $\sigma : \Omega_{S/R} \to \Omega_{P/R} \otimes_R S$.
For each $\lambda \in S$ choose $x_\lambda \in P$
which maps to $\lambda$. Next, for each $\lambda \in S$ choose
$f_\lambda \in J$ such that
$$
\text{d}f_\lambda = \text{d}x_\lambda - \sigma(\text{d}\lambda)
$$
in the middle term of the exact sequence.
We claim that $s : \lambda \mapsto x_\lambda - f_\lambda \mod J^2$
is an $R$-algebra homomorphism $s : S \to P/J^2$.
To prove this we will repeatedly use that if $h \in J$ and
$\text{d}h = 0$ in $\Omega_{P/R} \otimes_R S$, then $h \in J^2$.
Let $\lambda, \mu \in S$.
Then $\sigma(\text{d}\lambda + \text{d}\mu - \text{d}(\lambda + \mu)) = 0$.
This implies
$$
\text{d}(x_\lambda + x_\mu - x_{\lambda + \mu}
- f_\lambda - f_\mu + f_{\lambda + \mu}) = 0
$$
which means that $x_\lambda + x_\mu - x_{\lambda + \mu}
- f_\lambda - f_\mu + f_{\lambda + \mu} \in J^2$, which in turn
means that $s(\lambda) + s(\mu) = s(\lambda + \mu)$. 
Similarly, we have
$\sigma(\lambda \text{d}\mu + \mu \text{d}\lambda - \text{d}\lambda \mu) = 0$
which implies that
$$
\mu(\text{d}x_\lambda - \text{d}f_\lambda) +
\lambda(\text{d}x_\mu - \text{d}f_\mu) -
\text{d}x_{\lambda\mu} - \text{d}f_{\lambda\mu} = 0
$$
in the middle term of the exact sequence.
Moreover we have
$$
\text{d}(x_\lambda x_\mu) =
x_\lambda \text{d}x_\mu + x_\mu \text{d}x_\lambda =
\lambda \text{d}x_\mu + \mu \text{d} x_\lambda
$$
in the middle term again. Combined these equations mean that
$x_\lambda x_\mu - x_{\lambda\mu}
- \mu f_\lambda - \lambda f_\mu + f_{\lambda\mu} \in J^2$
which means that $s(\lambda)s(\mu) = s(\lambda\mu)$.
If $\lambda \in R$, then $\text{d}\lambda = 0$ and we see
that $\text{d}f_\lambda = \text{d}x_\lambda$, hence
$\lambda - x_\lambda + f_\lambda \in J^2$ and hence
$s(\lambda) = \lambda$ as desired. At this point we can
apply Lemma \ref{lemma-characterize-formally-smooth}
to conclude that $S/R$ is formally smooth.
\end{proof}

\begin{remark}
\label{remark-lemma-characterize-formally-smooth-again}
Lemma \ref{lemma-characterize-formally-smooth-again} above holds more
generally whenever $P$ is formally smooth over $R$. Note that the lemma
implies that $\Omega_{S/R}$ is a projective $S$-module when $S$ is
formally smooth over $R$. On the other hand, this is not a sufficient
condition for a ring map to be formally smooth.
\end{remark}

\begin{lemma}
\label{lemma-ses-formally-smooth}
Let $R \to S$ be a formally smooth ring map.
Then the sequence
$$
0 \to \Omega_{R/\mathbf{Z}} \otimes_R S
\to \Omega_{S/\mathbf{Z}}
\to \Omega_{S/R} \to 0
$$
of Lemma \ref{lemma-exact-sequence-differentials}
is a split short exact sequence.
\end{lemma}

\begin{proof}
Choose a polynomial algebra $P$ over $R$ and a surjection
$P \to S$. Note that the corresponding sequence
$$
0 \to \Omega_{R/\mathbf{Z}} \otimes_R P
\to \Omega_{P/\mathbf{Z}}
\to \Omega_{P/R} \to 0
$$
is split exact by a direct computation.
Consider the following commutative diagram
$$
\xymatrix{
&
\Omega_{R/\mathbf{Z}} \otimes_R S \ar[r] &
\Omega_{S/\mathbf{Z}} \ar[r] &
\Omega_{S/R} \ar[r] & 0 \\
0 \ar[r] &
\Omega_{R/\mathbf{Z}} \otimes_R S \ar[r] \ar[u] &
\Omega_{P/\mathbf{Z}} \otimes_P S \ar[r] \ar[u] &
\Omega_{P/R} \otimes_P S \ar[r] \ar[u] & 0 \\
& & J/J^2 \ar[r] \ar[u] & J/J^2 \ar[u]
}
$$
By Lemma \ref{lemma-characterize-formally-smooth-again}
the right vertical sequence is split exact also.
A diagram chase shows that the top row is short exact.
It is split exact since $\Omega_{S/R}$ is a projective $S$-module,
see Remark \ref{remark-lemma-characterize-formally-smooth-again}.
\end{proof}

\begin{lemma}
\label{lemma-lift-formal-smoothness}
Let $R \to S$ be a ring map.
Let $I \subset R$ be an ideal. Assume
\begin{enumerate}
\item $I^2 = 0$,
\item $R \to S$ is flat, and
\item $R/I \to S/IS$ is formally smooth.
\end{enumerate}
Then $R \to S$ is formally smooth.
\end{lemma}

\begin{proof}
Assume (1), (2) and (3).
Let $P = R[\{x_t\}_{t \in T}] \to S$ be a surjection of $R$-algebras
with kernel $J$. Thus $0 \to J \to P \to S \to 0$ is a
short exact sequence of flat $R$-modules. This implies that
$I \otimes_R S = IS$, $I \otimes_R P = IP$ and $I \otimes_R J = IJ$
as well as $J \cap IP = IJ$.
We will use throughout the proof that
$$
\Omega_{(S/IS)/(R/I)} = \Omega_{S/R} \otimes_S (S/IS)
= \Omega_{S/R} \otimes_R R/I = \Omega_{S/R} / I\Omega_{S/R}
$$
and similarly for $P$ (see Lemma \ref{lemma-differentials-base-change}).
By Lemma \ref{lemma-characterize-formally-smooth-again} the sequence
\begin{equation}
\label{equation-split}
0 \to J/(IJ + J^2) \to
\Omega_{P/R} \otimes_P S/IS \to
\Omega_{S/R} \otimes_S S/IS \to 0
\end{equation}
is split exact. Of course the middle term is
$\bigoplus_{t \in T} S/IS \text{d}x_t$. Choose a splitting
$\sigma : \Omega_{P/R} \otimes_P S/IS \to J/(IJ + J^2)$.
For each $t \in T$ choose an element $f_t \in J$ which maps
to $\sigma(\text{d}x_t)$ in $J/(IJ + J^2)$. This determines a
unique $S$-module map
$$
\tilde \sigma : \Omega_{P/R} \otimes_R S
= \bigoplus S\text{d}x_t \longrightarrow J/J^2
$$
with the property that $\tilde\sigma(\text{d}x_t) = f_t$.
As $\sigma$ is a section to $\text{d}$ the difference
$$
\Delta = \text{id}_{J/J^2} - \tilde \sigma \circ \text{d}
$$
is a self map $J/J^2 \to J/J^2$ whose image is contained in
$(IJ + J^2)/J^2$. In particular $\Delta((IJ + J^2)/J^2) = 0$
because $I^2 = 0$. This means that $\Delta$ factors as
$$
J/J^2 \to J/(IJ + J^2) \xrightarrow{\overline{\Delta}}
(IJ + J^2)/J^2 \to J/J^2
$$
where $\overline{\Delta}$ is a $S/IS$-module map.
Using again that the sequence (\ref{equation-split})
is split, we can find a $S/IS$-module map
$\overline{\delta} : \Omega_{P/R} \otimes_P S/IS \to (IJ + J^2)/J^2$
such that $\overline{\delta} \circ d$ is equal to $\overline{\Delta}$.
In the same manner as above the map $\overline{\delta}$ determines
an $S$-module map
$\delta : \Omega_{P/R} \otimes_P S \to J/J^2$.
After replacing $\tilde \sigma$ by $\tilde \sigma + \delta$
a simple computation shows that $\Delta = 0$. In other words $\tilde \sigma$
is a section of $J/J^2 \to \Omega_{P/R} \otimes_P S$.
By Lemma \ref{lemma-characterize-formally-smooth-again}
we conclude that $R \to S$ is formally smooth.
\end{proof}


\begin{lemma}
\label{lemma-smooth-formally-smooth}
Let $R \to S$ be a smooth ring map.
Then $R \to S$ is formally smooth.
\end{lemma}

\begin{proof}
Let $S = R[x_1, \ldots, x_n]/I$ with $I = (f_1, \ldots, f_m)$.
By Definition \ref{definition-smooth}
and the discussion directly below it, we have
a (noncanonical) direct sum decomposition
$$
\Omega_{R[x_1, \ldots, x_n]/R} \otimes_{R[x_1, \ldots, x_n]} S
= \bigoplus_{i = 1}^n S \text{d}x_i
= I/I^2 \oplus \Omega_{S/R}.
$$
Hence $S$ is formally smooth over $R$ by
Lemma \ref{lemma-characterize-formally-smooth-again}.
\end{proof}

\begin{lemma}
\label{lemma-formally-smooth-smooth}
Let $R$ be a ring. Let $S$ be a $R$-algebra.
If $S$ is of finite presentation and formally smooth over $R$
then $S$ is smooth over $R$.
\end{lemma}

\begin{proof}
We work backwards through the proof of
Lemma \ref{lemma-smooth-formally-smooth} above.
Choose a presentation $\alpha : R[x_1, \ldots, x_n]/I \cong S$.
By Lemma \ref{lemma-characterize-formally-smooth-again}
we see that the naive cotangent complex $NL(\alpha)$
is quasi-isomorphic to $\Omega_{S/R}$ and that $\Omega_{S/R}$
is a projective $S$-module. Hence $S$ is smooth over $R$ by
Definition \ref{definition-smooth}.
\end{proof}

\begin{lemma}
\label{lemma-finite-presentation-fs-Noetherian}
Let $R \to S$ be a ring map of finite presentation which is
also formally smooth. Then there exists a subring $R_0 \subset R$
of finite type over $\mathbf{Z}$ and a formally smooth
ring map $R_0 \to S_0$ of finite type such that $S \cong R \otimes_{R_0} S_0$.
\end{lemma}

\begin{proof}
Write $S = R[x_1, \ldots, x_n]/(f_1, \ldots, f_m)$
and denote $I = (f_1, \ldots, f_m)$.
Choose a right inverse
$\sigma : S \to R[x_1, \ldots, x_n]/I^2$
to the projection to $S$ as in
Lemma \ref{lemma-characterize-formally-smooth}.
Choose $h_i \in R[x_1, \ldots, x_n]$ such that
$\sigma(x_i \bmod I) = h_i \bmod I^2$.
The fact that $\sigma$ is an $R$-algebra homomorphism
$R[x_1, \ldots, x_n]/I \to R[x_1, \ldots, x_n]/I^2$
is equivalent to the condition that
$$
f_j(h_1, \ldots, h_n) = \sum\nolimits_{j_1 j_2} a_{j_1 j_2} f_{j_1} f_{j_2}
$$
for certain $a_{kl} \in R[x_1, \ldots, x_n]$.
Let $R_0 \subset R$ be the subring generated over $\mathbf{Z}$
by all the coefficients of the polynomials $f_j, h_i, a_{kl}$.
Set $S_0 = R_0[x_1, \ldots, x_n]/(f_1, \ldots, f_m)$,
with $I_0 = (f_1, \ldots, f_m)$.
Let $\sigma_0 : S_0 \to R_0[x_1, \ldots, x_n]/I_0^2$ defined by
the rule $x_i \mapsto h_i \bmod I_0^2$; this works since the
$a_{lk}$ are defined over $R_0$ and satisfy the same relations.
Thus by Lemma \ref{lemma-characterize-formally-smooth}
the ring $S_0$ is formally smooth over $R_0$.
\end{proof}

\begin{lemma}
\label{lemma-triangle-differentials-smooth}
Given ring maps $A \to B \to C$ with $B \to C$ smooth, then the sequence
$$
0 \to C \otimes_B \Omega_{B/A} \to \Omega_{C/A} \to \Omega_{C/B} \to 0
$$
of Lemma \ref{lemma-exact-sequence-differentials} is exact.
\end{lemma}

\begin{proof}
If $A \to B$ is of finite type, then this follows from
Lemma \ref{lemma-exact-sequence-NL}
since for a smooth ring map $B \to C$ the $H^{-1}$ of the
naive cotangent complex of $C/B$ is zero by definition.
(We should really have defined NL in complete generality so
the proof of this lemma would now be done.) By combining
Lemmas \ref{lemma-smooth-formally-smooth},
\ref{lemma-formally-smooth-smooth}, and
\ref{lemma-finite-presentation-fs-Noetherian}
we see that there exists a finitely generated $\mathbf{Z}$-sub algebra
$B_0 \subset B$ and a smooth ring map $B_0 \to C_0$ such that
$C = B \otimes_{B_0} C_0$. Let
$$
\Lambda = \{(E, F) \mid
E \subset A\text{ finite subset},
F \subset B\text{ finite subset}.
\}
$$
Put a partial ordering on $\Lambda$ using inclusion.
For $\lambda = (E, F) \in \Lambda$ let
$A_\lambda \subset A$ be the $\mathbf{Z}$-subalgebra generated by $E$
and let $B_\lambda \subset B$ be the $B_0$-subalgebra generated by
$F$ and the image of $E$. Set $C_\lambda = B_\lambda \otimes_{B_0} C_0$.
Then we see that
$$
\text{colim}_\lambda\ A_\lambda = A, \quad
\text{colim}_\lambda\ B_\lambda = B, \quad
\text{colim}_\lambda\ C_\lambda = C,
$$
that all the maps $A_\lambda \to B_\lambda$ are of finite type, and
the maps $B_\lambda \to C_\lambda$ are smooth. By the first
part of the proof the sequences
$$
0 \to C_\lambda \otimes_{B_\lambda} \Omega_{B_\lambda/A_\lambda}
\to \Omega_{C_\lambda/A_\lambda} \to \Omega_{C_\lambda/B_\lambda} \to 0
$$
are all exact. Hence the lemma follows by using that taking modules
of differentials commutes with colimits, and similar for $\otimes$, see
Lemma \ref{lemma-colimit-differentials},
\ref{lemma-tensor-products-commute-with-limits}
and using
Lemma \ref{lemma-directed-colimit-exact}.
\end{proof}


\section{Smoothness and differentials}
\label{section-smooth-differential}

\noindent
Warning: The following two lemmas do not hold over nonperfect
fields in general.

\begin{lemma}
\label{lemma-rank-omega}
Let $k$ be an algebraically closed field.
Let $S$ be a finite type $k$-algebra.
Let $\mathfrak m \subset S$ be a maximal ideal.
Then
$$
\dim_{\kappa(\mathfrak m)} \Omega_{S/k} \otimes_S \kappa(\mathfrak m)
=
\dim_{\kappa(\mathfrak m)} \mathfrak m/\mathfrak m^2.
$$
\end{lemma}

\begin{proof}
Since $k$ is algebraically closed we have $\kappa(\mathfrak m) = k$.
We may choose a presentation
$0 \to I \to k[x_1, \ldots, x_n] \to S \to 0$ such that
all $x_i$ end up in $\mathfrak m$. Write $I = (f_1, \ldots, f_m)$.
Note that each $f_i$ is contained in $(x_1, \ldots, x_n)$, i.e., each
$f_i$ has zero constant term. Hence we may write
$$
f_j = \sum a_{ij} x_i + \text{h.o.t.}
$$
By Lemma \ref{lemma-differential-seq} there is an exact sequence
$$
\bigoplus S \cdot f_j
\to
\bigoplus S \cdot \text{d}x_i
\to
\Omega_{S/k}
\to
0.
$$
Tensoring with $\kappa(\mathfrak m) = k$ we get
an exact sequence
$$
\bigoplus k \cdot f_j
\to
\bigoplus k \cdot \text{d}x_i
\to
\Omega_{S/k} \otimes \kappa(\mathfrak m)
\to
0.
$$
The matrix of the map is given by the partial derivatives of
the $f_j$ evaluated at $0$. In other words by the matrix $(a_{ij})$.
Similarly there is a short exact sequence
$$
(f_1, \ldots, f_m)/(x_1 f_1, \ldots, x_n f_m)
\to
(x_1, \ldots, x_n)/(x_1, \ldots, x_n)^2
\to
\mathfrak m/\mathfrak m^2
\to
0.
$$
Note that the first map is given by expanding the $f_j$
in terms of the $x_i$, i.e., by the same matrix $(a_{ij})$.
Hence the two numbers are the same.
\end{proof}

\begin{lemma}
\label{lemma-characterize-smooth-kbar}
Let $k$ be an algebraically closed field.
Let $S$ be a finite type $k$-algebra.
Let $\mathfrak m \subset S$ be a maximal ideal.
The following are equivalent:
\begin{enumerate}
\item The ring $S_{\mathfrak m}$ is a regular local ring.
\item We have
$\dim_{\kappa(\mathfrak m)} \Omega_{S/k} \otimes_S \kappa(\mathfrak m)
\leq \dim(S_{\mathfrak m})$.
\item We have
$\dim_{\kappa(\mathfrak m)} \Omega_{S/k} \otimes_S \kappa(\mathfrak m)
= \dim(S_{\mathfrak m})$.
\item There exists a $g \in S$, $g \not \in \mathfrak m$
such that $S_g$ is smooth over $k$. In other words $S/k$
is smooth at $\mathfrak m$.
\end{enumerate}
\end{lemma}

\begin{proof}
Note that (1), (2) and (3) are equivalent by Lemma \ref{lemma-rank-omega}
and Definition \ref{definition-regular}.

\medskip\noindent
Assume that $S$ is smooth at $\mathfrak q$.
By Lemma \ref{lemma-smooth-syntomic} we see that
$S_g$ is standard smooth over $k$
for a suitable $g \in S$, $g \not \in \mathfrak m$.
Hence by Lemma \ref{lemma-standard-smooth}
we see that $\Omega_{S_g/k}$ is free of rank $\dim(S_g)$.
Hence by Lemma \ref{lemma-rank-omega}
we see that $\dim(S_m) = \dim (\mathfrak m/\mathfrak m^2)$
in other words $S_\mathfrak m$ is regular.

\medskip\noindent
Conversely, suppose that $S_{\mathfrak m}$ is regular.
Let $d = \dim(S_{\mathfrak m}) = \dim \mathfrak m/\mathfrak m^2$.
Choose a presentation $S = k[x_1, \ldots, x_n]/I$
such that $x_i$ maps to an element of $\mathfrak m$ for
all $i$. In other words, $\mathfrak m'' = (x_1, \ldots, x_n)$
is the corresponding maximal ideal of $k[x_1, \ldots, x_n]$.
Note that we have a short exact sequence
$$
I/\mathfrak m''I \to \mathfrak m''/(\mathfrak m'')^2
\to \mathfrak m/(\mathfrak m)^2 \to 0
$$
Pick $c = n - d$ elements $f_1, \ldots, f_d \in I$ such that
their images in $\mathfrak m''/(\mathfrak m'')^2$ span the
kernel of the map to $\mathfrak m/(\mathfrak m)^2$. This is clearly
possible. Denote $J = (f_1, \ldots, f_c)$. So $J \subset I$.
Denote $S' = k[x_1, \ldots, x_n]/J$ so there is a surjection
$S' \to S$. Denote $\mathfrak m' = \mathfrak m''S'$ the corresponding
maximal ideal of $S'$. Hence we have
$$
\xymatrix{
k[x_1, \ldots, x_n] \ar[r] & S' \ar[r] & S \\
\mathfrak m'' \ar[u] \ar[r] & \mathfrak m' \ar[r] \ar[u] &
\mathfrak m \ar[u]
}
$$
By our choice of $J$ the exact sequence
$$
J/\mathfrak m''J \to \mathfrak m''/(\mathfrak m'')^2
\to \mathfrak m'/(\mathfrak m')^2 \to 0
$$
shows that $\dim( \mathfrak m'/(\mathfrak m')^2 ) = d$.
Since $S'_{\mathfrak m'}$ surjects onto $S_{\mathfrak m}$
we see that $\dim(S_{\mathfrak m'}) \geq d$. Hence by
the discussion preceding Definition \ref{definition-regular-local}
we conclude that $S'_{\mathfrak m'}$ is
regular of dimension $d$ as well. Because $S'$ was cut out
by $c = n - d$ equations we
conclude that there exists a $g' \in S'$, $g' \not \in \mathfrak m'$
such that $S'_{g'}$ is a global complete intersection over $k$,
see Lemma \ref{lemma-lci}.
Also the map $S'_{\mathfrak m'} \to S_{\mathfrak m}$
is a surjection of Noetherian local domains of the same
dimension and hence an isomorphism. By Lemma \ref{lemma-local-isomorphism}
we see that $S'_{g''} \cong S_{g''}$ for some $g'' \in S'$,
$g'' \not \in \mathfrak m'$. All in all we conclude that
after replacing $S$ by a principal localization we may
assume that $S$ is a global complete intersection.

\medskip\noindent
At this point we may write $S = k[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$
with $\dim S = n - c$. Recall that the naive cotangent complex
of this algebra is given by
$$
\bigoplus S \cdot f_j
\to
\bigoplus S \cdot \text{d}x_i
$$
see Lemma \ref{lemma-relative-global-complete-intersection-smooth}.
By this same lemma in order to show that $S$ is smooth at
$\mathfrak m$ we have to show that one of the $c \times c$
minors $g_I$ of the matrix ``$A$'' giving the map above
does not vanish at $\mathfrak m$. By Lemma \ref{lemma-rank-omega}
the matrix $A \bmod \mathfrak m$ has rank $c$. Thus we win.
\end{proof}

\begin{lemma}
\label{lemma-characterize-smooth-over-field}
Let $k$ be any field.
Let $S$ be a finite type $k$-algebra.
Let $X = \text{Spec}(S)$.
Let $\mathfrak q \subset S$ be a prime
corresponding to $x \in X$.
The following are equivalent:
\begin{enumerate}
\item The $k$-algebra $S$ is smooth at $\mathfrak q$ over $k$.
\item We have
$\dim_{\kappa(\mathfrak q)} \Omega_{S/k} \otimes_S \kappa(\mathfrak q)
\leq \dim_x X$.
\item We have
$\dim_{\kappa(\mathfrak q)} \Omega_{S/k} \otimes_S \kappa(\mathfrak q)
= \dim_x X$.
\end{enumerate}
Moreover, in this case the local ring $S_{\mathfrak q}$ is regular.
\end{lemma}

\begin{proof}
If $S$ is smooth at $\mathfrak q$ over $k$, then there exists
a $g \in S$, $g \not \in \mathfrak q$ such that $S_g$ is
standard smooth over $k$, see Lemma \ref{lemma-smooth-syntomic}.
A standard smooth algebra over $k$ has a module of differentials
which is free of rank equal to the dimension, see
Lemma \ref{lemma-standard-smooth}. Thus we see that
(1) implies (3). To finish the proof of the lemma it
suffices to show that (2) implies (1) and that it implies
that $S_{\mathfrak q}$ is regular.

\medskip\noindent
Assume (2). By Nakayama's Lemma \ref{lemma-NAK} we see that
$\Omega_{S/k, \mathfrak q}$ can be generated by $\leq \dim_x X$ elements.
We may replace $S$ by $S_g$ for some $g \in S$, $g \not \in \mathfrak q$
such that $\Omega_{S/k}$ is generated by at most
$\dim_x X$ elements.
Let $K \supset k$ be an algebraically closed field extension
such that there exists a $k$-algebra map $\psi : \kappa(\mathfrak q) \to K$.
Consider $S_K = K \otimes_k S$. Let $\mathfrak m \subset S_K$
be the maximal ideal corresponding to the surjection
$$
\xymatrix{
S_K = K \otimes_k S \ar[r] &
K \otimes_k \kappa(\mathfrak q)
\ar[r]^-{\text{id}_K \otimes \psi} &
K.
}
$$
Note that $\mathfrak m \cap S = \mathfrak q$, in other words
$\mathfrak m$ lies over $\mathfrak q$.
By Lemma \ref{lemma-dimension-at-a-point-preserved-field-extension}
the dimension of $X_K = \text{Spec}(S_K)$ at the point corresponding
to $\mathfrak m$ is $\dim_x X$. By
Lemma \ref{lemma-dimension-closed-point-finite-type-field}
this is equal to $\dim((S_K)_{\mathfrak m})$.
By Lemma \ref{lemma-differentials-base-change}
the module of differentials of $S_K$ over $K$ is
the base change of $\Omega_{S/k}$, hence also
generated by at most $\dim_x X = \dim((S_K)_{\mathfrak m})$
elements. By Lemma \ref{lemma-characterize-smooth-kbar}
we see that $S_K$ is smooth at $\mathfrak m$ over $K$.
By Lemma \ref{lemma-flat-base-change-locus-smooth} this
implies that $S$ is smooth at $\mathfrak q$ over $k$.
This proves (1). Moreover, we know by
Lemma \ref{lemma-characterize-smooth-kbar}
that the local ring $(S_K)_{\mathfrak m}$ is regular.
Since $S_{\mathfrak q} \to (S_K)_{\mathfrak m}$ is flat we
conclude from Lemma \ref{lemma-flat-under-regular}
that $S_{\mathfrak q}$ is regular.
\end{proof}

\noindent
The following lemma can be significantly generalized
(in several different ways).

\begin{lemma}
\label{lemma-computation-differential}
Let $k$ be a field.
Let $R$ be a Noetherian local ring containing $k$.
Assume that the residue field $\kappa = R/\mathfrak m$
is a finitely generated separable extension of $k$.
Then the map
$$
\text{d} :
\mathfrak m/\mathfrak m^2
\longrightarrow
\Omega_{R/k} \otimes_R \kappa(\mathfrak m)
$$
is injective.
\end{lemma}

\begin{proof}
We may replace $R$ by $R/\mathfrak m^2$. Hence we may assume that
$\mathfrak m^2 = 0$. By assumption we may write
$\kappa = k(\overline{x}_1, \ldots, \overline{x}_r, \overline{y})$
where $\overline{x}_1, \ldots, \overline{x}_r$ is a transcendence basis
of $\kappa$ over $k$ and $\overline{y}$ is separable algebraic over
$k(\overline{x}_1, \ldots, \overline{x}_r)$. Say its minimal
equation is $P(\overline{y}) = 0$ with $P(T) = T^d + \sum_{i < d} a_iT^i$,
with $a_i \in k(\overline{x}_1, \ldots, \overline{x}_r)$ and
$P'(\overline{y}) \not = 0$. Choose any lifts
$x_i \in R$ of the elements $\overline{x}_i \in \kappa$.
This gives a commutative diagram
$$
\xymatrix{
R \ar[r] & \kappa \\
& k(\overline{x}_1, \ldots, \overline{x}_r) \ar[lu]^\varphi \ar[u]
}
$$
of $k$-algebras. We want to extend the left upwards arrow
$\varphi$ to a $k$-algebra
map from $\kappa$ to $R$. To do this choose any $y \in R$ lifting
$\overline{y}$. To see that it defines a $k$-algebra map
defined on $\kappa \cong k(\overline{x}_1, \ldots, \overline{x}_r)[T]/(P)$
all we have to show is that we may choose $y$ such that $P^\varphi(y) = 0$.
If not then we compute for $\delta \in \mathfrak m$ that
$$
P(y + \delta) = P(y) + P'(y)\delta
$$
because $\mathfrak m^2 = 0$. Since $P'(y)\delta = P'(\overline{y})\delta$
we see that we can adjust our choice as desired.
This shows that $R \cong \kappa \oplus \mathfrak m$ as
$k$-algebras! From a direct computation of
$\Omega_{\kappa \oplus \mathfrak m/k}$ the lemma follows.
\end{proof}

\begin{lemma}
\label{lemma-separable-smooth}
Let $k$ be a field.
Let $S$ be a finite type $k$-algebra.
Let $\mathfrak q \subset S$ be a prime.
Assume $\kappa(\mathfrak q)$ is separable over $k$.
The following are equivalent:
\begin{enumerate}
\item The algebra $S$ is smooth at $\mathfrak q$ over $k$.
\item The ring $S_{\mathfrak q}$ is regular.
\end{enumerate}
\end{lemma}

\begin{proof}
Denote $R = S_{\mathfrak q}$ and denote its maximal
by $\mathfrak m$ and its residue field $\kappa$.
By Lemma \ref{lemma-computation-differential} and
\ref{lemma-differential-seq} we see that there is a short exact
sequence
$$
0 \to \mathfrak m/\mathfrak m^2 \to
\Omega_{R/k} \otimes_R \kappa \to
\Omega_{\kappa/k} \to 0
$$
Note that $\Omega_{R/k} = \Omega_{S/k, \mathfrak q}$, see
Lemma \ref{lemma-differentials-localize}.
Moreover, since $\kappa$ is separable over $k$
we have $\dim_{\kappa} \Omega_{\kappa/k} = \text{trdeg}_k(\kappa)$.
Hence we get
$$
\dim_{\kappa} \Omega_{R/k} \otimes_R \kappa
=
\dim_\kappa \mathfrak m/\mathfrak m^2 + \text{trdeg}_k (\kappa)
\geq
\dim R + \text{trdeg}_k (\kappa)
=
\dim_{\mathfrak q} S
$$
(see Lemma \ref{lemma-dimension-at-a-point-finite-type-field} for
the last equality)
with equality if and only if $R$ is regular.
Thus we win by applying Lemma \ref{lemma-characterize-smooth-over-field}.
\end{proof}

\begin{lemma}
\label{lemma-characteristic-zero}
Let $R \to S$ be a $\mathbf{Q}$-algebra map.
Let $f \in S$ be such that $\Omega_{S/R} = S \text{d}f \oplus C$
for some $S$-submodule $C$. Then
\begin{enumerate}
\item $f$ is not nilpotent, and
\item if $S$ is a Noetherian local ring, then $f$ is a nonzero divisor in $S$.
\end{enumerate}
\end{lemma}

\begin{proof}
For $a \in S$ write $\text{d}(a) = \theta(a)\text{d}f + c(a)$ for some
$\theta(a) \in S$ and $c(a) \in C$.
Consider the $R$-derivation $S \to S$, $a \mapsto \theta(a)$.
Note that $\theta(f) = 1$.

\medskip\noindent
If $f^n = 0$ with $n > 1$ minimal, then $0 = \theta(f^n) = n f^{n - 1}$
contradicting the minimality of $n$. We conclude that $f$ is not nilpotent.

\medskip\noindent
Suppose $fa = 0$. If $f$ is a unit then $a = 0$ and we win. Assume
$f$ is not a unit. Then
$0 = \theta(fa) = f\theta(a) + a$ by the Leibniz rule and hence $a \in (f)$.
By induction suppose we have shown $fa = 0 \Rightarrow a \in (f^n)$.
Then writing $a = f^nb$ we get
$0 = \theta(f^{n + 1}b) = (n + 1)f^nb + f^{n + 1}\theta(b)$.
Hence $a = f^n b = -f^{n + 1}\theta(b)/(n + 1) \in (f^{n + 1})$.
Since in the Noetherian local ring $S$ we have $\bigcap (f^n) = 0$, see
Lemma \ref{lemma-intersect-powers-ideal-module-zero}
we win.
\end{proof}

\noindent
The following is probably quite useless in applications.

\begin{lemma}
\label{lemma-characteristic-zero-local-smooth}
Let $k$ be a field of characteristic $0$.
Let $S$ be a finite type $k$-algebra.
Let $\mathfrak q \subset S$ be a prime.
The following are equivalent:
\begin{enumerate}
\item The algebra $S$ is smooth at $\mathfrak q$ over $k$.
\item The $S_{\mathfrak q}$-module $\Omega_{S/k, \mathfrak q}$
is (finite) free.
\item The ring $S_{\mathfrak q}$ is regular.
\end{enumerate}
\end{lemma}

\begin{proof}
In characteristic zero any field extension is separable and hence the
equivalence of (1) and (3) follows from Lemma \ref{lemma-separable-smooth}.
Also (1) implies (2) by definition of smooth algebras.
Assume that $\Omega_{S/k, \mathfrak q}$ is free over $S_{\mathfrak q}$.
We are going to use the notation and observations made in the
proof of Lemma \ref{lemma-separable-smooth}. So $R = S_{\mathfrak q}$
with maximal ideal $\mathfrak m$ and residue field $\kappa$.
Our goal is to prove $R$ is regular.

\medskip\noindent
If $\mathfrak m/\mathfrak m^2 = 0$, then $\mathfrak m = 0$
and $R \cong \kappa$. Hence $R$ is regular and we win.

\medskip\noindent
If $\mathfrak m/ \mathfrak m^2 \not = 0$, then choose any
$f \in \mathfrak m$ whose image in $\mathfrak m/ \mathfrak m^2$
is not zero. By Lemma \ref{lemma-computation-differential}
we see that $\text{d}f$ has nonzero image in
$\Omega_{R/k}/\mathfrak m\Omega_{R/k}$. By assumption
$\Omega_{R/k} = \Omega_{S/k, \mathfrak q}$ is finite free and
hence by Nakayama's Lemma \ref{lemma-NAK} we see that
$\text{d}f$ generates a direct summand. We apply
Lemma \ref{lemma-characteristic-zero}
to deduce that $f$ is a nonzero divisor in $R$.
Furthermore, by Lemma \ref{lemma-differential-seq} we get an exact sequence
$$
(f)/(f^2) \to \Omega_{R/k} \otimes_R R/fR \to \Omega_{(R/fR)/k} \to 0
$$
This implies that $\Omega_{(R/fR)/k}$ is finite free as well.
Hence by induction we see that $R/fR$ is a regular local ring.
Since $f \in \mathfrak m$ was a nonzero divisor we
conclude that $R$ is regular, see Lemma \ref{lemma-regular-mod-x}.
\end{proof}

\begin{example}
\label{example-characteristic-p}
Lemma \ref{lemma-characteristic-zero-local-smooth}
does not hold in characteristic $p > 0$.
The standard examples are the ring maps
$$
\mathbf{F}_p \longrightarrow \mathbf{F}_p[x]/(x^p)
$$
whose module of differentials is free but is clearly not smooth, and
the ring map ($p > 2$)
$$
\mathbf{F}_p(t) \to \mathbf{F}_p(t)[x, y]/(x^p + y^2 + \alpha)
$$
which is not smooth at the prime $\mathfrak q = (y, x^p - \alpha)$
but is regular.
\end{example}












\section{Smooth ring maps in the Noetherian case}
\label{section-smooth-Noetherian}

\begin{definition}
\label{definition-small-extension}
Let $\varphi : B' \to B$ be a ring map.
We say $\varphi$ is a {\it small extension} if
$B'$ and $B$ are local Artinian rings, $\varphi$ is surjective
and $I = \text{Ker}(\varphi)$ has length $1$ as a $B'$-module.
\end{definition}

\noindent
Clearly this means that $I^2 = 0$ and that $I = (x)$ for some
$x \in B'$ such that $\mathfrak m' x = 0$ where $\mathfrak m' \subset B'$
is the maximal ideal.

\begin{lemma}
\label{lemma-smooth-test-artinian}
Let $R \to S$ be a ring map. Let $\mathfrak q$ be a prime ideal of
$S$ lying over $\mathfrak p \subset R$. Assume $R$ is Noetherian
and $R \to S$ of finite type.
The following are equivalent:
\begin{enumerate}
\item $R \to S$ is smooth at $\mathfrak q$,
\item for every surjection of local $R$-algebras
$(B', \mathfrak m') \to (B, \mathfrak m)$
with $\text{Ker}(B' \to B)$ having square zero
and every solid commutative diagram
$$
\xymatrix{
S \ar[r] \ar@{-->}[rd] & B \\
R \ar[r] \ar[u] & B' \ar[u]
}
$$
such that $\mathfrak q = S \cap \mathfrak m$ there exists a dotted
arrow making the diagram commute,
\item same as in (2) but with $B' \to B$ ranging over small extensions, and
\item same as in (2) but with $B' \to B$ ranging over small extensions
such that in addition $S \to R$ induces an isomorphism
$\kappa(\mathfrak q) \cong \kappa(\mathfrak m)$.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume (1). This means there exists a $g \in S$, $g \not \in \mathfrak q$
such that $R \to S_g$ is smooth. By Lemma \ref{lemma-smooth-formally-smooth}
we know that $R \to S_g$ is formally smooth. Note that given any diagram
as in (2) the map $S \to B$ factors automatically through $S_{\mathfrak q}$
and a fortiori through $S_g$. The formal smoothness of $S_g$ over $R$
gives us a morphism $S_g \to B'$ fitting into a similar diagram with $S_g$ at
the upper left corner. Composing with $S \to S_g$ gives the desired arrow.
In other words, we have shown that (1) implies (2).

\medskip\noindent
Clearly (2) implies (3) and (3) implies (4).

\medskip\noindent
Assume (4). We are going to show that (1) holds, thereby finishing the
proof of the lemma. Choose a presentation
$S = R[x_1, \ldots, x_n]/(f_1, \ldots, f_m)$.
This is possible as $S$ is of finite type over $R$ and therefore of finite
presentation (see
Lemma \ref{lemma-Noetherian-finite-type-is-finite-presentation}).
Set $I = (f_1, \ldots, f_m)$.
Consider the naive cotangent complex
$$
\text{d} : I/I^2
\longrightarrow
\bigoplus\nolimits_{j = 1}^m S\text{d}x_j
$$
of this presentation (see Section \ref{section-netherlander}).
It suffices to show that when we localize this complex at $\mathfrak q$
then the map becomes a split injection.
Denote $S' = R[x_1, \ldots, x_n]/I^2$.
By Lemma \ref{lemma-differential-mod-power-ideal} we have
$$
S \otimes_{S'} \Omega_{S'/R} =
S \otimes_{R[x_1, \ldots, x_n]} \Omega_{R[x_1, \ldots, x_n]/R} =
\bigoplus\nolimits_{j = 1}^m S\text{d}x_j.
$$
Thus the map
$$
\text{d} :
I/I^2
\longrightarrow
S \otimes_{S'} \Omega^1_{S'/R}
$$
is the same as the map in the naive cotangent complex above. In particular
the truth of the assertion we are trying to prove
depends only on the three rings $R \to S' \to S$.
Let $\mathfrak q' \subset R[x_1, \ldots, x_n]$ be the prime ideal
corresponding to $\mathfrak q$. Since
localization commutes with taking modules of differentials
(Lemma \ref{lemma-differentials-localize}) we see that it suffices to show
that the map
\begin{equation}
\label{equation-target-map}
\text{d} :
I_{\mathfrak q'}/I_{\mathfrak q'}^2
\longrightarrow
S_{\mathfrak q} \otimes_{S'_{\mathfrak q'}} \Omega^1_{S'_{\mathfrak q'}/R}
\end{equation}
coming from $R \to S'_{\mathfrak q'} \to S_{\mathfrak q}$
is a split injection.

\medskip\noindent
Let $N \in \mathbf{N}$ be an integer.
Consider the ring
$$
B'_N = S'_{\mathfrak q'} / (\mathfrak q')^N S'_{\mathfrak q'}
= (S'/(\mathfrak q')^N S')_{\mathfrak q'}
$$
and its quotient $B_N = B'_N/IB'_N$. Note that
$B_N \cong S_{\mathfrak q}/\mathfrak q^NS_{\mathfrak q}$.
Observe that $B'_N$ is an Artinian local ring since it is the
quotient of a local Noetherian ring by a power of its maximal ideal.
Consider a filtration of the kernel $I_N$ of $B'_N \to B_N$
by $B'_N$-submodules
$$
0 \subset J_{N, 1} \subset J_{N, 2} \subset \ldots \subset J_{N, n(N)} = I_N
$$
such that each successive quotient $J_{N, i}/J_{N, i - 1}$ has length $1$.
(As $B'_N$ is Artinian such a filtration exists.)
This gives a sequence of small extensions
$$
B'_N  \to B'_N/J_{N, 1} \to B'_N/J_{N, 2} \to \ldots \to
B'_N/J_{N, n(N)} = B'_N/I_N
= B_N = S_{\mathfrak q}/\mathfrak q^NS_{\mathfrak q}
$$
Applying condition (4) successively to these small extensions
starting with the map $S \to B_N$ we see there
exists a commutative diagram
$$
\xymatrix{
S \ar[r] \ar[rd] & B_N  \\
R \ar[r] \ar[u] & B'_N \ar[u]
}
$$
Clearly the ring map $S \to B'_N$ factors as $S \to S_{\mathfrak q} \to B'_N$
where $S_{\mathfrak q} \to B'_N$ is a local homomorphism of local rings.
Moreover, since the maximal ideal of $B'_N$ to the $N$th power is zero
we conclude that $S_{\mathfrak q} \to B'_N$ factors through
$S_{\mathfrak q}/(\mathfrak q)^NS_{\mathfrak q} = B_N$. In other words
we have shown that for all $N \in \mathbf{N}$ the surjection of
$R$-algebras $B'_N \to B_N$ has a splitting.

\medskip\noindent
Consider the presentation
$$
I_N \to B_N \otimes_{B'_N} \Omega_{B'_N/R} \to \Omega_{B_N/R} \to 0
$$
coming from the surjection $B'_N \to B_N$ with kernel $I_N$ (see
Lemma \ref{lemma-differential-seq}). By the above the $R$-algebra map
$B'_N \to B_N$ has a right inverse. Hence by
Lemma \ref{lemma-differential-seq-split} we see that the sequence above
is split exact! Thus for every $N$ the map
$$
I_N \longrightarrow B_N \otimes_{B'_N} \Omega_{B'_N/R}
$$
is a split injection. The rest of the proof is gotten by unwinding what
this means exactly. Note that
$$
I_N = I_{\mathfrak q'}/
(I_{\mathfrak q'}^2 + (\mathfrak q')^N \cap I_{\mathfrak q'})
$$
By Artin-Rees (Lemma \ref{lemma-Artin-Rees}) we find a $c \geq 0$
such that
$$
S_{\mathfrak q}/\mathfrak q^{N - c}S_{\mathfrak q}
\otimes_{S_{\mathfrak q}} I_N =
S_{\mathfrak q}/\mathfrak q^{N - c}S_{\mathfrak q}
\otimes_{S_{\mathfrak q}}
I_{\mathfrak q'}/I_{\mathfrak q'}^2
$$
for all $N \geq c$
(these tensor product are just a fancy way of dividing by
$\mathfrak q^{N - c}$). We may of course assume $c \geq 1$.
By Lemma \ref{lemma-differential-mod-power-ideal} we see that
$$
S'_{\mathfrak q'}/(\mathfrak q')^{N - c}S'_{\mathfrak q'}
\otimes_{S'_{\mathfrak q'}} \Omega_{B'_N/R} =
S'_{\mathfrak q'}/(\mathfrak q')^{N - c}S'_{\mathfrak q'}
\otimes_{S'_{\mathfrak q'}} \Omega_{S'_{\mathfrak q'}/R}
$$
we can further tensor this by $B_N = S_{\mathfrak q}/\mathfrak q^N$
to see that
$$
S_{\mathfrak q}/\mathfrak q^{N - c}S_{\mathfrak q}
\otimes_{S'_{\mathfrak q'}} \Omega_{B'_N/R} =
S_{\mathfrak q}/\mathfrak q^{N - c}S_{\mathfrak q}
\otimes_{S'_{\mathfrak q'}} \Omega_{S'_{\mathfrak q'}/R}.
$$
Since a split injection remains a split injection after tensoring
with anything we see that
$$
S_{\mathfrak q}/\mathfrak q^{N - c}S_{\mathfrak q}
\otimes_{S_{\mathfrak q}}
(\ref{equation-target-map}) =
S_{\mathfrak q}/\mathfrak q^{N - c}S_{\mathfrak q}
\otimes_{S_{\mathfrak q}}
(I_N \longrightarrow B_N \otimes_{B'_N} \Omega_{B'_N/R})
$$
is a split injection for all $N \geq c$. By
Lemma \ref{lemma-split-injection-after-completion} we see that
(\ref{equation-target-map}) is a split injection. This finishes the proof.
\end{proof}








\section{Overview of results on smooth ring maps}
\label{section-smooth-overview}

\noindent
Here is a list of results on smooth ring maps that we
proved in the preceding sections. For more precise statements
and definitions please consult the references given.
\begin{enumerate}
\item A ring map $R \to S$ is smooth if it is of finite presentation
and the naive cotangent complex of $S/R$ is quasi-isomorphic to
a finite projective $S$-module in degree $0$, see
Definition \ref{definition-smooth}.
\item If $S$ is smooth over $R$, then $\Omega_{S/R}$ is a finite projective
$S$-module, see discussion following Definition \ref{definition-smooth}.
\item The property of being smooth is local on $S$, see
Lemma \ref{lemma-locally-smooth}.
\item The property of being smooth is stable under base change, see
Lemma \ref{lemma-base-change-smooth}.
\item The property of being smooth is stable under composition, see
Lemma \ref{lemma-compose-smooth}.
\item A smooth ring map is syntomic, in particular flat, see
Lemma \ref{lemma-smooth-syntomic}.
\item A finitely presented, flat ring map with smooth fibre rings
is smooth, see Lemma \ref{lemma-flat-fibre-smooth}.
\item A finitely presented ring map $R \to S$ is smooth if and
only if it is formally smooth, see
Lemmas \ref{lemma-smooth-formally-smooth} and
\ref{lemma-formally-smooth-smooth}.
\item If $R \to S$ is a finite type ring map with $R$ Noetherian
then to check that $R \to S$ is smooth it suffices to check the lifting
property of formal smoothness along small extensions of Artinian
local rings, see Lemma \ref{lemma-smooth-test-artinian}.
\item A smooth ring map $R \to S$ is the base change
of a smooth ring map $R_0 \to S_0$
with $R_0$ of finite type over $\mathbf{Z}$. To see this
combine (8) above with Lemma \ref{lemma-finite-presentation-fs-Noetherian}.
\item Formation of the set of points where a
ring map is smooth commutes with flat base change, see
Lemma \ref{lemma-flat-base-change-locus-smooth}.
\item If $S$ is of finite type over an algebraically closed
field $k$, and $\mathfrak m \subset S$ a maximal ideal,
then the following are equivalent
\begin{enumerate}
\item $S$ is smooth over $k$ in a neighbourhood of $\mathfrak m$,
\item $S_{\mathfrak m}$ is a regular local ring,
\item $\dim(S_{\mathfrak m}) =
\dim_{\kappa(m)} \Omega_{S/k} \otimes_S \kappa(\mathfrak m)$.
\end{enumerate}
see Lemma \ref{lemma-characterize-smooth-kbar}.
\item If $S$ is of finite type over a field $k$, and
$\mathfrak q \subset S$ a prime ideal,
then the following are equivalent
\begin{enumerate}
\item $S$ is smooth over $k$ in a neighbourhood of $\mathfrak q$,
\item $\dim_{\mathfrak q}(S/k) =
\dim_{\kappa(\mathfrak q)} \Omega_{S/k} \otimes_S \kappa(\mathfrak q)$.
\end{enumerate}
see Lemma \ref{lemma-characterize-smooth-over-field}.
\item If $S$ is smooth over a field, then all its local rings are
regular, see Lemma \ref{lemma-characterize-smooth-over-field}.
\item If $S$ is of finite type over a field $k$,
$\mathfrak q \subset S$ a prime ideal,
the field extension $k \subset \kappa(\mathfrak q)$ is separable
and $S_{\mathfrak q}$ is regular, then $S$ is smooth over $k$ at
$\mathfrak q$, see Lemma \ref{lemma-separable-smooth}.
\item If $S$ is of finite type over a field $k$,
if $k$ has characteristic $0$, if
$\mathfrak q \subset S$ a prime ideal, and if
$\Omega_{S/k, \mathfrak q}$ is free, then $S$ is smooth over $k$ at
$\mathfrak q$, see Lemma \ref{lemma-characteristic-zero-local-smooth}.
\end{enumerate}
Some of these results were proved using the notion of a standard
smooth ring map, see Definition \ref{definition-standard-smooth}.
This is the analogue of what a relative global
complete intersection map is for the case of syntomic morphisms.
It is also the easiest way to make examples.













\section{Etale ring maps}
\label{section-etale}

\noindent
An etale ring map is a smooth ring map whose relative dimension
is equal to zero. This is the same as the following slightly more
direct definition.

\begin{definition}
\label{definition-etale}
Let $R \to S$ be a ring map.
We say $R \to S$ is {\it etale} if it is of finite presentation
and for any presentation $\alpha$ the naive cotangent complex
$NL(\alpha)$ is quasi-isomorphic to zero. Given a prime $\mathfrak q$
of $S$ we say that $R \to S$ is {\it etale at $\mathfrak q$}
if there exists a $g \in S$, $g \not \in \mathfrak q$ such that
$R \to S_g$ is etale.
\end{definition}

\noindent
In particular we see that $\Omega_{S/R} = 0$ if $S$ is etale over $R$.
If $R \to S$ is smooth,
then $R \to S$ is etale if and only if $\Omega_{S/R} = 0$.
From our results on smooth ring maps we automatically get a whole host
of results for etale maps. We summarize these in the following
lemma.

\begin{lemma}
\label{lemma-etale}
Results on etale ring maps.
\begin{enumerate}
\item If $R \to R_f$ is etale for any ring $R$ and any $f \in R$.
\item Compositions of etale ring maps are etale.
\item A base change of an etale ring map is etale.
\item The property of being etale is local: Given a ring map
$R \to S$ and elements $g_1, \ldots, g_m \in S$ which generate the unit ideal
such that $R \to S_{g_j}$ is etale for $j = 1, \ldots, m$ then
$R \to S$ is etale.
\item Given $R \to S$ of finite presentation, and a flat ring map
$R \to R'$, set $S' = R' \otimes_R S$. The set of primes where $R \to S'$
is etale is the inverse image via $\text{Spec}(S') \to \text{Spec}(S)$
of the set of primes where $R \to S$ is etale.
\item An etale ring map is syntomic, in particular flat.
\item If $S$ is finite type over a field $k$, then $S$ is etale over
$k$ if and only if $\Omega_{S/k} = 0$.
\item Any etale ring map $R \to S$ is the base change of an etale
ring map $R_0 \to S_0$ with $R_0$ of finite type over $\mathbf{Z}$.
\item Let $A = \text{colim}\ A_i$ be a filtered colimit of rings.
Let $A \to B$ be an etale ring map. Then there exists an etale ring
map $A_i \to B_i$ for some $i$ such that $B \cong A \otimes_{A_i} B_i$.
\item Let $A$ be a ring. Let $S$ be a multiplicative subset of $A$.
Let $S^{-1}A \to B'$ be etale. Then there exists an etale ring map
$A \to B$ such that $B' \cong S^{-1}B$.
\end{enumerate}
\end{lemma}

\begin{proof}
In each case we use the corresponding result for smooth ring maps with
a small argument added to show that $\Omega_{S/R}$ is zero.

\medskip\noindent
Proof of (1). The ring map $R \to R_f$ is smooth and $\Omega_{R_f/R} = 0$.

\medskip\noindent
Proof of (2). The composition $A \to C$ of smooth maps $A \to B$ and
$B \to C$ is smooth, see Lemma \ref{lemma-compose-smooth}. By
Lemma \ref{lemma-exact-sequence-differentials} we see that
$\Omega_{C/A}$ is zero as both $\Omega_{C/B}$ and $\Omega_{B/A}$ are zero.

\medskip\noindent
Proof of (3). Let $R \to S$ be etale and $R \to R'$ be arbitrary.
Then $R' \to S' = R' \otimes_R S$ is smooth, see
Lemma \ref{lemma-base-change-smooth}. Since
$\Omega_{S'/R'} = S' \otimes_S \Omega_{S/R}$ by
Lemma \ref{lemma-differentials-base-change}
we conclude that $\Omega_{S'/R'} = 0$. Hence $R' \to S'$ is etale.

\medskip\noindent
Proof of (4). Assume the hypotheses of (4). By
Lemma \ref{lemma-locally-smooth} we see that $R \to S$ is smooth.
We are also given that $\Omega_{S_{g_i}/R} = (\Omega_{S/R})_{g_i} = 0$
for all $i$. Then $\Omega_{S/R} = 0$, see Lemma \ref{lemma-cover}.

\medskip\noindent
Proof of (5). The result for smooth maps is
Lemma \ref{lemma-flat-base-change-locus-smooth}.
In the proof of that lemma we used that the naive cotangent
complex satisfies $NL(S/R) \otimes_S S' \cong NL(S'/R')$.
This reduces us to showing that if $M$ is a finitely presented
$S$-module the set of primes $\mathfrak q'$ of $S'$
such that $(M\otimes_S S')_{\mathfrak q'} = 0$ is the inverse
image of the set of primes $\mathfrak q$ of $S$ such that
$M_{\mathfrak q} = 0$. This is true (proof omitted).

\medskip\noindent
Proof of (6). Follows directly from the corresponding result for
smooth ring maps (Lemma \ref{lemma-smooth-syntomic}).

\medskip\noindent
Proof of (7). Follows from Lemma \ref{lemma-characterize-smooth-over-field}
and the definitions.

\medskip\noindent
Proof of (8). Combining
Lemmas \ref{lemma-smooth-formally-smooth},
\ref{lemma-formally-smooth-smooth} and
\ref{lemma-finite-presentation-fs-Noetherian} gives the result for smooth
ring maps. The resulting smooth ring map $R_0 \to S_0$ satisfies the
hypotheses of Lemma \ref{lemma-relative-dimension-CM}, and hence we may
replace $S_0$ by the factor of relative dimension $0$ over $R_0$.

\medskip\noindent
Proof of (9). Follows from (8) since $R_0 \to A$ will factor through
$A_i$ for some $i$.

\medskip\noindent
Proof of (10). Follows from (9), (1), and (2) since $S^{-1}A$ is a
filtered colimit of principal localizations of $A$.
\end{proof}

\noindent
Next we work out in more detail what it means to be smooth
over a field.

\begin{lemma}
\label{lemma-etale-over-field}
Let $k$ be a field. A ring map $k \to S$ is etale if and only if $S$
is isomorphic as a $k$-algebra to a finite product of finite separable
extensions of $k$.
\end{lemma}

\begin{proof}
If $k \to k'$ is a finite separable field extension then we can
write $k' = k(\alpha) \cong k[x]/(f)$. Here $f$ is the minimal
polynomial of the element $\alpha$. Since $k'$ is separable over $k$
we have $\gcd(f, f') = 1$. This
implies that $\text{d} : k'\cdot f \to k' \cdot \text{d}x$
is an isomorphism. Hence $k \to k'$ is etale.

\medskip\noindent
Conversely, suppose that $k \to S$ is etale. Let $\overline{k}$
be an algebraic closure of $k$. Then $S \otimes_k \overline{k}$
is etale over $\overline{k}$. Suppose we have the result over $\overline{k}$.
Then $S \otimes_k \overline{k}$ is reduced and hence $S$ is reduced.
Also, $S \otimes_k \overline{k}$ is finite over $\overline{k}$
and hence $S$ is finite over $k$. Hence $S$ is a finite product
$S = \prod k_i$
of fields, see Proposition \ref{proposition-dimension-zero-ring}.
By elementary field theory the fact that $S \otimes_k \overline{k}$
is isomorphic to a finite product of copies of $\overline{k}$
implies that each $k \subset k_i$ is finite separable.
Thus we have reduced to the case $k = \overline{k}$. According to
Lemma \ref{lemma-characterize-smooth-kbar} (combined with
$\Omega_{S/k} = 0$) we see that $S_{\mathfrak m} \cong k$
for all maximal ideals $\mathfrak m \subset S$. This clearly
implies the result.
\end{proof}

\begin{lemma}
\label{lemma-etale-at-prime}
Let $R \to S$ be a ring map.
Let $\mathfrak q \subset S$ be a prime lying over $\mathfrak p$ in $R$.
If $S/R$ is etale at $\mathfrak q$ then
\begin{enumerate}
\item we have $\mathfrak p S_{\mathfrak q} = \mathfrak qS_{\mathfrak q}$
is the maximal ideal of the local ring $S_{\mathfrak q}$, and
\item the field extension $\kappa(\mathfrak p) \subset \kappa(\mathfrak q)$
is finite separable.
\end{enumerate}
\end{lemma}

\begin{proof}
First we may replace $S$ by $S_g$ for some $g \in S$, $g \not \in \mathfrak q$
and assume that $R \to S$ is etale. Then the lemma follows from
Lemma \ref{lemma-etale-over-field} by unwinding the
fact that $S \otimes_R \kappa(\mathfrak p)$ is etale over
$\kappa(\mathfrak p)$.
\end{proof}

\begin{lemma}
\label{lemma-etale-quasi-finite}
An etale ring map is quasi-finite.
\end{lemma}

\begin{proof}
Let $R \to S$ be an etale ring map. By definition $R \to S$ is of finite type.
For any prime $\mathfrak p \subset R$ the fibre ring
$S \otimes_R \kappa(\mathfrak p)$ is etale over $\kappa(\mathfrak p)$
and hence a finite products of fields finite separable over
$\kappa(\mathfrak p)$, in particular finite over $\kappa(\mathfrak p)$.
Thus $R \to S$ is quasi-finite by Lemma \ref{lemma-quasi-finite}.
\end{proof}

\begin{lemma}
\label{lemma-characterize-etale}
Let $R \to S$ be a ring map. Let $\mathfrak q$ be a prime of $S$
lying over a prime $\mathfrak p$ of $R$. If
\begin{enumerate}
\item $R \to S$ is of finite presentation,
\item $R_{\mathfrak p} \to S_{\mathfrak q}$ is flat
\item $\mathfrak p S_{\mathfrak q}$ is the maximal ideal
of the local ring $S_{\mathfrak q}$, and
\item the field extension $\kappa(\mathfrak p) \subset \kappa(\mathfrak q)$
is finite separable,
\end{enumerate}
then $R \to S$ is etale at $\mathfrak q$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-flat-fibre-smooth}
there exists a $g \in S$, $g \not \in \mathfrak q$
such that $R \to S_g$ is smooth. Thus we may replace $S$ by $S_g$ and
assume that $R \to S$ is smooth. By
Lemma \ref{lemma-smooth-syntomic} we may even assume that
$R \to S$ is standard smooth, say $S = R[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$.
Since $\mathfrak q$ is an isolated point of its fibre we conclude
that it lies of an irreducible component of the spectrum of the
fibre ring of dimension $0$. This can only happen if $n = c$, i.e.,
if $R \to S$ is etale.
\end{proof}

\noindent
Here is a completely new phenomenon.

\begin{lemma}
\label{lemma-map-between-etale}
Let $R \to S$ and $R \to S'$ be etale.
Then any $R$-algebra map $S' \to S$ is etale.
\end{lemma}

\begin{proof}
First of all we note that $S' \to S$ is of finite presentation by
Lemma \ref{lemma-compose-finite-type}.
Let $\mathfrak q \subset S$ be a prime ideal lying over the primes
$\mathfrak q' \subset S'$ and $\mathfrak p \subset R$.
By Lemma \ref{lemma-etale-at-prime} the ring map
$S_{\mathfrak q}/\mathfrak p S_{\mathfrak q} \to
S'_{\mathfrak q'}/\mathfrak p S'_{\mathfrak q'}$
is a map finite separable extensions of $\kappa(\mathfrak p)$.
In particular it is flat. Hence by
Lemma \ref{lemma-criterion-flatness-fibre} we see that
$S'_{\mathfrak q'} \to S_{\mathfrak q}$ is flat. Thus $S' \to S$
is flat. Moreover, the above also shows that $\mathfrak q'S_{\mathfrak q}$
is the maximal ideal of $S_{\mathfrak q}$ and that the residue
field extension of $S'_{\mathfrak q'} \to S_{\mathfrak q}$ is
finite separable. Hence from Lemma \ref{lemma-characterize-etale}
above we conclude that $S' \to S$ is etale at $\mathfrak q$. Since
being etale is local (see Lemma \ref{lemma-etale}) we win.
\end{proof}

\begin{lemma}
\label{lemma-surjective-flat-finitely-presented}
Let $\varphi :R \to S$ be a ring map. If $R \to S$ is surjective, flat and
finitely presented then there exist an idempotent $e \in R$ such that
$S = R_e$.
\end{lemma}

\begin{proof}
Since $\text{Spec}(S) \to \text{Spec}(R)$ is a homeomorphism
onto a closed subset (see Lemma \ref{lemma-spec-closed}) and
is open (see Proposition \ref{proposition-fppf-open}) we see that
the image is $D(e)$ for some idempotent $e \in R$ (see
Lemma \ref{lemma-disjoint-decomposition}). Thus $R_e \to S$
induces a bijection on spectra. Now this map induces an isomorphism
on all local rings for example by
Lemmas \ref{lemma-finite-flat-local} and \ref{lemma-NAK}.
Then it follows that $R_e \to S$ is also injective, for example
see Lemma \ref{lemma-characterize-zero-local}.
\end{proof}

\noindent
It turns out that any etale ring map is standard smooth.

\begin{lemma}
\label{lemma-etale-standard-smooth}
Any etale ring map is standard smooth.
\end{lemma}

\begin{proof}
Let $R \to S$ be etale. Write $S = R[x_1, \ldots, x_n]/I$. Since $R \to S$ is
smooth we know that
$$
\text{d} :
I/I^2
\longrightarrow
\bigoplus\nolimits_{i = 1, \ldots, n} S\text{d}x_i
$$
is an isomorphism. Choose $f_1, \ldots, f_n \in I$ such that
$\text{d}(f_i \bmod I^2) = \text{d}x_i$. Consider the ring
$$
S' = R[x_1, \ldots, x_n, x_{n + 1}]/
(f_1, \ldots, f_n, x_{n + 1}\det(\partial f_j/\partial x_i) - 1).
$$
As we have seen in Example \ref{example-make-standard-smooth}
the ring map $R \to S'$ is standard smooth. It is in fact etale because
the naive cotangent complex is quasi-isomorphic to $0$ by construction. Note
that there is a surjective $R$-algebra map $S' \to S$ which maps $x_{n + 1}$
to $1 \in S$. It is also etale by Lemma \ref{lemma-map-between-etale}.
By Lemma \ref{lemma-surjective-flat-finitely-presented}
we see that $S = S'_e$ for some idempotent $e \in S'$.
We conclude that $R \to S$ is standard smooth as a localization of $S'$ by
Lemma \ref{lemma-standard-smooth}.
\end{proof}

\begin{lemma}
\label{lemma-lift-etale}
Let $R$ be a ring and let $I \subset R$ be an ideal.
Let $R/I \to \overline{S}$ be an etale ring map.
Then there exists an etale ring map
$R \to S$ such that $\overline{S} \cong S/IS$ as $R/I$-algebras.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-etale-standard-smooth} we can write
$\overline{S} =
(R/I)[x_1, \ldots, x_n]/(\overline{f}_1, \ldots, \overline{f}_n)$
as in Definition \ref{definition-standard-smooth} with
$\overline{\Delta} =
\det(\frac{\partial \overline{f}_i}{\partial x_j})_{i, j = 1, \ldots, n}$
invertible in $\overline{S}$. Just take some lifts $f_i$ and set
$S = R[x_1, \ldots, x_n, x_{n+1}]/(f_1, \ldots, f_c, x_{n + 1}\Delta - 1)$
where $\Delta = \det(\frac{\partial f_i}{\partial x_j})_{i, j = 1, \ldots, c}$
as in Example \ref{example-make-standard-smooth}.
This proves the lemma.
\end{proof}

\begin{example}
\label{example-factor-polynomials-etale}
Let $n , m \geq 1$ be integers. Consider the ring map
\begin{eqnarray*}
R = \mathbf{Z}[a_1, \ldots, a_{n + m}]
& \longrightarrow &
S = \mathbf{Z}[b_1, \ldots, b_n, c_1, \ldots, c_m] \\
a_1 & \longmapsto & b_1 + c_1 \\
a_2 & \longmapsto & b_2 + b_1 c_1 + c_2 \\
\ldots & \ldots & \ldots \\
a_{n + m} & \longmapsto & b_n c_m
\end{eqnarray*}
of Example \ref{example-factor-polynomials}.
Write symbolically
$$
S = R[b_1, \ldots, c_m]/(\{a_k(b_i, c_j) - a_k\}_{k = 1, \ldots, n + m})
$$
where for example $a_1(b_i, c_j) = b_1 + c_1$.
The matrix of partial derivatives is
$$
\left(
\begin{matrix}
1 & c_1 & \ldots & c_m & 0 & \ldots & 0 \\
0 & 1 & c_1 & \ldots & c_m & \ldots & 0 \\
\ldots & \ldots & \ldots & \ldots & \ldots & \ldots & \ldots \\
0 & \ldots & 0 & 1 & c_1 & \ldots & c_m \\
1 & b_1 & \ldots & b_n & 0 & \ldots & 0 \\
0 & 1 & b_1 & \ldots & b_n & \ldots & 0 \\
\ldots & \ldots & \ldots & \ldots & \ldots & \ldots & \ldots \\
0 & \ldots & 0 & 1 & b_1 & \ldots & b_n \\
\end{matrix}
\right)
$$
The determinant $\Delta$ of this matrix is better known as the
{\it resultant} of the polynomials $g = x^n + b_1 x^{n - 1} + \ldots + b_n$
and $h = x^m + c_1 x^{m - 1} + \ldots + c_m$, and the matrix above
is known as the {\it Sylvester matrix} associated to $g, h$.
In a formula $\Delta = \text{Res}_x(g, h)$. The Sylvester matrix
is the tranpose of the matrix of the linear map
\begin{eqnarray*}
S[x]_{< m} \oplus S[x]_{< n} & \longrightarrow & S[x]_{< n + m} \\
a \oplus b & \longmapsto & ah + bg
\end{eqnarray*}
Let $\mathfrak q \subset S$ be any prime. By the above the
following are equivalent:
\begin{enumerate}
\item $R \to S$ is etale at $\mathfrak q$,
\item $\Delta = \text{Res}_x(g, h) \not \in \mathfrak q$,
\item the images $\overline{g}, \overline{h} \in \kappa(\mathfrak q)[x]$
of the polynomials $g, h$ are relatively prime in $\kappa(\mathfrak q)[x]$.
\end{enumerate}
The equivalence of (2) and (3) holds because the image of the
Sylvester matrix in $\text{Mat}(n + m, \kappa(\mathfrak q))$
has a kernel if and only if the polynomials $\overline{g}, \overline{h}$
have a factor in common. We conclude that the ring map
$$
R \longrightarrow S[\frac{1}{\Delta}] = S[\frac{1}{\text{Res}_x(g, h)}]
$$
is etale.
\end{example}

\noindent
Lemma \ref{lemma-etale-standard-smooth} tells us that it does not really
make sense to define a standard etale morphism to be
a standard smooth morphism of relative dimension $0$.
As a model for an etale morphism we take the example given
by a finite separable extension $k \subset k'$ of fields.
Namely, we can always find an element $\alpha \in k'$ such
that $k' = k(\alpha)$ and such that the minimal polynomial
$f(x) \in k[x]$ of $\alpha$ has derivative $f'$ which is
relatively prime to $f$.

\begin{definition}
\label{definition-standard-etale}
Let $R$ be a ring. Let $g , f  \in R[x]$.
Assume that $f$ is monic and the derivative $f'$ is invertible in
the localization $R[x]_g$.
In this case the ring map $R \to R[x]_g/(f)$ is said to be
{\it standard etale}.
\end{definition}

\begin{lemma}
\label{lemma-standard-etale}
Let $R \to R[x]_g/(f)$ be standard etale.
\begin{enumerate}
\item The ring map $R \to R[x]_g/(f)$ is etale.
\item For any ring map $R \to R'$ the base change $R' \to R'[x]_g/(f)$
of the standard etale ring map $R \to R[x]_g/(f)$ is standard etale.
\item Any principal localization of $R[x]_g/(f)$ is standard etale over $R$.
\item A composition of standard etale maps is {\bf not} standard etale
in general.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted. Here is an example for (4).
The ring map $\mathbf{F}_2 \to \mathbf{F}_{2^2}$ is standard etale.
The ring map
$\mathbf{F}_{2^2} \to \mathbf{F}_{2^2} \times \mathbf{F}_{2^2}
\times \mathbf{F}_{2^2} \times \mathbf{F}_{2^2}$ is standard etale.
But the ring map
$\mathbf{F}_2 \to \mathbf{F}_{2^2} \times \mathbf{F}_{2^2}
\times \mathbf{F}_{2^2} \times \mathbf{F}_{2^2}$ is not standard etale.
\end{proof}

\noindent
Standard etale morphisms are a convenient way to produce etale maps.
Here is an example.

\begin{lemma}
\label{lemma-make-etale-map-prescribed-residue-field}
Let $R$ be a ring.
Let $\mathfrak p$ be a prime of $R$.
Let $\kappa(\mathfrak p) \subset L$ be a finite separable field extension.
There exists an etale ring map $R \to R'$ together with a prime $\mathfrak p'$
lying over $\mathfrak p$ such that the field extension
$\kappa(\mathfrak p) \subset \kappa(\mathfrak p')$ is isomorphic
to $\kappa(\mathfrak p) \subset L$.
\end{lemma}

\begin{proof}
By the theorem of the primitive element we may write
$L = \kappa(\mathfrak p)[\alpha]$. Let
$\overline{f} \in \kappa(\mathfrak p)[x]$
denote the minimal polynomial for $\alpha$ (in particular this is monic).
After replacing $\alpha$ by $c\alpha$ for some $c \in R$,
$c\not \in \mathfrak p$ we may assume all the coefficients
of $\overline{f}$ are in the image of $R \to \kappa(\mathfrak p)$
(verification omitted). Thus we can find a monic polynomial
$f \in R[x]$ which maps to $\overline{f}$ in $\kappa(\mathfrak p)[x]$.
Since $\kappa(\mathfrak p) \subset L$ is separable, we see
that $\gcd(\overline{f}, \overline{f}') = 1$.
Hence there is an element $\gamma \in L$ such that
$\overline{f}'(\alpha) \gamma = 1$. Thus we get a $R$-algebra map
\begin{eqnarray*}
R[x, 1/f']/(f) & \longrightarrow & L \\
x & \longmapsto & \alpha \\
1/f' & \longmapsto & \gamma
\end{eqnarray*}
The left hand side is a standard etale algebra $R'$ over $R$
and the kernel of the ring map gives the desired prime.
\end{proof}






\begin{proposition}
\label{proposition-etale-locally-standard}
Let $R \to S$ be a ring map. Let $\mathfrak q \subset S$ be a prime.
If $R \to S$ is etale at $\mathfrak q$, then there exists
a $g \in S$, $g \not \in \mathfrak q$ such that $R \to S_g$
is standard etale.
\end{proposition}

\begin{proof}
The following proof is a little roundabout and there may be ways to
shorten it.

\medskip\noindent
Step 1. By Definition \ref{definition-etale}
there exists a $g \in S$, $g \not \in \mathfrak q$
such that $R \to S_g$ is etale. Thus we may assume that $S$ is etale
over $R$.

\medskip\noindent
Step 2. By Lemma \ref{lemma-etale} there exists an etale ring map $R_0 \to S_0$
with $R_0$ of finite type over $\mathbf{Z}$, and a ring map
$R_0 \to R$ such that $R = R \otimes_{R_0} S_0$. Denote
$\mathfrak q_0$ the prime of $S_0$ corresponding to $\mathfrak q$.
If we show the result for $(R_0 \to S_0, \mathfrak q_0)$ then the
result follows for $(R \to S, \mathfrak q)$ by base change. Hence
we may assume that $R$ is Noetherian.

\medskip\noindent
Step 3.
Note that $R \to S$ is quasi-finite by Lemma \ref{lemma-etale-quasi-finite}.
By Lemma \ref{lemma-quasi-finite-open-integral-closure}
there exists a finite ring map $R \to S'$, an $R$-algebra map
$S' \to S$, an element $g' \in S'$ such that
$g' \not \in \mathfrak q$ such that $S' \to S$ induces
an isomorphism $S'_{g'} \cong S_{g'}$.
(Note that of course $S'$ is not etale over $R$ in general.)
Thus we may assume that (a) $R$ is Noetherian, (b) $R \to S$ is finite
and (c) $R \to S$ is etale at $\mathfrak q$
(but no longer necessarily etale at all primes).

\medskip\noindent
Step 4. Let $\mathfrak p \subset R$ be the prime corresponding
to $\mathfrak q$. Consider the fibre ring
$S \otimes_R \kappa(\mathfrak p)$. This is a finite algebra over
$\kappa(\mathfrak p)$. Hence it is Artinian
(see Lemma \ref{lemma-finite-dimensional-algebra}) and
so a finite product of local rings
$$
S \otimes_R \kappa(\mathfrak p) = \prod\nolimits_{i = 1}^n A_i
$$
see Proposition \ref{proposition-dimension-zero-ring}. One of the factors,
say $A_1$, is the local ring $S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}$
which is isomorphic to $\kappa(\mathfrak q)$,
see Lemma \ref{lemma-etale-at-prime}. The other factors correspond to
the other primes, say $\mathfrak q_2, \ldots, \mathfrak q_n$ of
$S$ lying over $\mathfrak p$.

\medskip\noindent
Step 5. We may choose a nonzero element $\alpha \in \kappa(\mathfrak q)$ which
generates the finite separable field extension
$\kappa(\mathfrak p) \subset \kappa(\mathfrak q)$ (so even if the
field extension is trivial we do not allow $\alpha = 0$).
Note that for any $\lambda \in \kappa(\mathfrak p)^*$ the
element $\lambda \alpha$ also generates $\kappa(\mathfrak q)$
over $\kappa(\mathfrak p)$. Consider the element
$$
\overline{t} =
(\alpha, 0, \ldots, 0) \in
\prod\nolimits_{i = 1}^n A_i =
S \otimes_R \kappa(\mathfrak p).
$$
After possibly replacing $\alpha$ by $\lambda \alpha$ as above
we may assume that $\overline{t}$ is the image of $t \in S$.
Let $I \subset R[x]$ be the kernel of the $R$-algebra
map $R[x] \to S$ which maps $x$ to $t$. Set $S' = R[x]/I$,
so $S' \subset S$. Here is a diagram
$$
\xymatrix{
R[x] \ar[r] & S' \ar[r] & S \\
R \ar[u] \ar[ru] \ar[rru] & &
}
$$
By construction the primes $\mathfrak q_j$, $j \geq 2$ of $S$ all
lie over the prime $(\mathfrak p, x)$ of $R[x]$, whereas
the prime $\mathfrak q$ lies over a different prime of $R[x]$
because $\alpha \not = 0$.

\medskip\noindent
Step 6. Denote $\mathfrak q' \subset S'$ the prime of $S'$
corresponding to $\mathfrak q$. By the above $\mathfrak q$ is
the only prime of $S$ lying over $\mathfrak q'$. Thus we see that
$S_{\mathfrak q} = S_{\mathfrak q'}$, see
Lemma \ref{lemma-unique-prime-over-localize-below} (we have
going up for $S' \to S$ by Lemma \ref{lemma-integral-going-up}
since $S' \to S$ is finite as $R \to S$ is finite).
It follows that $S'_{\mathfrak q'} \to S_{\mathfrak q}$ is finite
and injective as the localization of the finite injective ring map
$S' \to S$. Consider the maps of local rings
$$
R_{\mathfrak p} \to S'_{\mathfrak q'} \to S_{\mathfrak q}
$$
The second map is finite and injective. We have
$S_{\mathfrak q}/\mathfrak pS_{\mathfrak q} = \kappa(\mathfrak q)$,
see Lemma \ref{lemma-etale-at-prime}.
Hence a fortiori
$S_{\mathfrak q}/\mathfrak q'S_{\mathfrak q} = \kappa(\mathfrak q)$.
Since
$$
\kappa(\mathfrak p) \subset \kappa(\mathfrak q') \subset \kappa(\mathfrak q)
$$
and since $\alpha$ is in the image of $\kappa(\mathfrak q')$ in
$\kappa(\mathfrak q)$
we conclude that $\kappa(\mathfrak q') = \kappa(\mathfrak q)$.
Hence by Nakayama's Lemma \ref{lemma-NAK} applied to the
$S'_{\mathfrak q'}$-module map $S'_{\mathfrak q'} \to S_{\mathfrak q}$,
the map $S'_{\mathfrak q'} \to S_{\mathfrak q}$ is surjective.
In other words,
$S'_{\mathfrak q'} \cong S_{\mathfrak q}$.

\medskip\noindent
Step 7. By Lemma \ref{lemma-local-isomorphism} there exists a $g' \in S'$,
$g' \not \in \mathfrak q'$ such that $S'_{g'} \cong S_{g'}$.
As $R$ is Noetherian the ring $S'$ is finite over $R$ as it is an $R$-submodule
of the finite $R$-module $S$. Hence after replacing $S$ by $S'$ we may
assume that (a) $R$ is Noetherian, (b) $S$ finite over $R$, (c)
$S$ is etale over $R$ at $\mathfrak q$, and (d) $S = R[x]/I$.

\medskip\noindent
Step 8. Consider the ring
$S \otimes_R \kappa(\mathfrak p) = \kappa(\mathfrak p)[x]/\overline{I}$
where $\overline{I} = I \cdot \kappa(\mathfrak p)[x]$ is the ideal generated
by $I$ in $\kappa(\mathfrak p)[x]$. As $\kappa(\mathfrak p)[x]$ is a PID
we know that $\overline{I} = (\overline{h})$ for some monic
$\overline{h} \in \kappa(\mathfrak p)$. After replacing $\overline{h}$
by $\lambda \cdot \overline{h}$ for some $\lambda \in \kappa(\mathfrak p)$
we may assume that $\overline{h}$ is the image of some $h \in R[x]$.
(The problem is that we do not know if we may choose $h$ monic.)
Also, as in Step 4 we know that
$S \otimes_R \kappa(\mathfrak p) = A_1 \times \ldots \times A_n$ with
$A_1 = \kappa(\mathfrak q)$ a finite separable extension of
$\kappa(\mathfrak p)$ and $A_2, \ldots, A_n$ local. This implies
that
$$
\overline{h} = \overline{h}_1 \overline{h}_2^{e_2} \ldots \overline{h}_n^{e_n}
$$
for certain pairwise coprime irreducible monic polynomials
$\overline{h}_i \in \kappa(\mathfrak p)[x]$ and certain
$e_2, \ldots, e_n \geq 1$. Here the numbering is chosen so that
$A_i = \kappa(\mathfrak p)[x]/(\overline{h}_i^{e_i})$ as
$\kappa(\mathfrak p)[x]$-algebras. Note that $\overline{h}_1$ is
the minimal polynomial of $\alpha \in \kappa(\mathfrak q)$ and hence
is a separable polynomial (its derivative is prime to itself).

\medskip\noindent
Step 9. Let $m \in I$ be a monic element; such an element exists
because the ring extension $R \to R[x]/I$ is finite hence integral.
Denote $\overline{m}$ the image in $\kappa(\mathfrak p)[x]$.
We may factor
$$
\overline{m} = \overline{k}
\overline{h}_1^{d_1} \overline{h}_2^{d_2} \ldots \overline{h}_n^{d_n}
$$
for some $d_1 \geq 1$, $d_j \geq e_j$, $j = 2, \ldots, n$ and
$\overline{k} \in \kappa(\mathfrak p)[x]$ prime to all the $\overline{h}_i$.
Set $f = m^l + h$ where $l \deg(m) > \deg(h)$, and $l \geq 2$.
Then $f$ is monic as a polynomial over $R$. Also, the image $\overline{f}$
of $f$ in $\kappa(\mathfrak p)[x]$ factors as
$$
\overline{f} =
\overline{h}_1 \overline{h}_2^{e_2} \ldots \overline{h}_n^{e_n}
+
\overline{k}^l \overline{h}_1^{ld_1} \overline{h}_2^{ld_2}
\ldots \overline{h}_n^{ld_n}
=
\overline{h}_1(\overline{h}_2^{e_2} \ldots \overline{h}_n^{e_n}
+
\overline{k}^l
\overline{h}_1^{ld_1 - 1} \overline{h}_2^{ld_2} \ldots \overline{h}_n^{ld_n})
= \overline{h}_1 \overline{w}
$$
with $\overline{w}$ a polynomial relatively prime to $\overline{h}_1$.
Set $g = f'$ (the derivative with respect to $x$).

\medskip\noindent
Step 10. The ring map $R[x] \to S = R[x]/I$ has the properties:
(1) it maps $f$ to zero, and
(2) it maps $g$ to an element of $S \setminus \mathfrak q$.
The first assertion is clear since $f$ is an element of $I$.
For the second assertion we just have to show that $g$ does
not map to zero in
$\kappa(\mathfrak q) = \kappa(\mathfrak p)[x]/(\overline{h}_1)$.
The image of $g$ in $\kappa(\mathfrak p)[x]$ is the derivative
of $\overline{f}$. Thus (2) is clear because
$$
\overline{g} =
\frac{\text{d}\overline{f}}{\text{d}x} =
\overline{w}\frac{\text{d}\overline{h}_1}{\text{d}x} +
\overline{h}_1\frac{\text{d}\overline{w}}{\text{d}x},
$$
$\overline{w}$ is prime to $\overline{h}_1$ and
$\overline{h}_1$ is separable.

\medskip\noindent
Step 11.
We conclude that $\varphi : R[x]/(f) \to S$ is a surjective ring map,
$R[x]_g/(f)$ is etale over $R$ (because it is standard etale,
see Lemma \ref{lemma-standard-etale}) and $\varphi(g) \not \in \mathfrak q$.
Pick an element $g' \in R[x]/(f)$ such that
also $\varphi(g') \not \in \mathfrak q$ and $S_{\varphi(g')}$
is etale over $R$ (which exists since $S$ is etale over $R$ at
$\mathfrak q$). Then the ring map
$R[x]_{gg'}/(f) \to S_{\varphi(g)}$ is a surjective map of etale
algebras over $R$. Hence it is etale by Lemma \ref{lemma-map-between-etale}.
Hence it is a localization by
Lemma \ref{lemma-surjective-flat-finitely-presented}.
Thus a localization of $S$ at an element not in $\mathfrak q$ is
isomorphic to a localization of a standard etale algebra over $R$
which is what we wanted to show.
\end{proof}

\noindent
The following two lemmas say that the etale topology is coarser than the
topology generated by Zariski coverings and finite flat morphisms.
They should be skipped on a first reading.

\begin{lemma}
\label{lemma-standard-etale-finite-flat-Zariski}
Let $R \to S$ be a standard etale morphism.
There exists a ring map $R \to S'$ with the following properties
\begin{enumerate}
\item $R \to S'$ is finite, finitely presented, and flat
(in other words it is finite projective as an $R$-module),
\item $\text{Spec}(S') \to \text{Spec}(R)$ is surjective,
\item for every prime $\mathfrak q \subset S$, lying over
$\mathfrak p \subset R$ and every prime
$\mathfrak q' \subset S'$ lying over $\mathfrak p$ there exists
a $g' \in S'$, $g' \not \in \mathfrak q'$
such that the ring map $R \to S'_{g'}$ factors
through a map $\varphi : S \to S'_{g'}$ with
$\varphi^{-1}(\mathfrak q'S'_{g'}) = \mathfrak q$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $S = R[x]_{g}/(f)$ be a presentation of $S$ as in
Definition \ref{definition-standard-etale}.
Write $f = x^n + a_1 x^{n - 1} + \ldots + a_n$ with $a_i \in R$.
By Lemma \ref{lemma-adjoin-roots} there exists a finite locally free
and faithfully flat ring map $R \to S'$ such that $f = \prod (x - \alpha_i)$
for certain $\alpha_i \in S'$. Hence $R \to S'$ satisfies conditions (1), (2).
Let $\mathfrak q \subset R[x]/(f)$ be a prime ideal with
$g \not \in \mathfrak q$ (i.e., it corresponds to a prime of $S$).
Let $\mathfrak p = R \cap \mathfrak q$ and let
$\mathfrak q' \subset S'$ be a prime lying over $\mathfrak p$.
Note that there are
$n$ maps of $R$-algebras
\begin{eqnarray*}
\varphi_i : R[x]/(f) & \longrightarrow & S' \\
x & \longmapsto & \alpha_i
\end{eqnarray*}
To finish the proof we have to show that for some $i$ we have
(a) the image of $\varphi_i(g)$ in $\kappa(\mathfrak q')$ is not zero,
and (b) $\varphi_i^{-1}(\mathfrak q') = \mathfrak q$.
Because then we can just take $g' = \varphi_i(g)$, and
$\varphi = \varphi_i$ for that $i$.

\medskip\noindent
Let $\overline{f}$ denote the image of $f$ in $\kappa(\mathfrak p)[x]$.
Note that as a point of $\text{Spec}(\kappa(\mathfrak p)[x]/(\overline{f}))$
the prime $\mathfrak q$ corresponds to an irreducible factor 
$f_1$ of $\overline{f}$. Moreover, $g \not \in \mathfrak q$ means
that $f_1$ does not divide the image $\overline{g}$ of $g$ in
$\kappa(\mathfrak p)[x]$.
Denote $\overline{\alpha}_1, \ldots, \overline{\alpha}_n$ the images
of $\alpha_1, \ldots, \alpha_n$ in $\kappa(\mathfrak q')$.
Note that the polynomial $\overline{f}$ splits completely
in $\kappa(\mathfrak q')[x]$, namely
$$
\overline{f} = \prod\nolimits_i (x - \overline{\alpha}_i)
$$
Moreover $\varphi_i(g)$ reduces to $\overline{g}(\overline{\alpha}_i)$.
It follows we may pick $i$ such that $f_1(\overline{\alpha}_i) = 0$ and
$\overline{g}(\overline{\alpha}_i) \not = 0$.
For this $i$ properties (a) and (b) hold. Some details omitted.
\end{proof}

\begin{lemma}
\label{lemma-etale-finite-flat-zariski}
Let $R \to S$ be a ring map.
Assume that
\begin{enumerate}
\item $R \to S$ is etale, and
\item $\text{Spec}(S) \to \text{Spec}(R)$ is surjective.
\end{enumerate}
Then there exists a ring map $R \to S'$ such that
\begin{enumerate}
\item $R \to S'$ is finite, finitely presented, and flat
(in other words it is finite projective as an $R$-module),
\item $\text{Spec}(S') \to \text{Spec}(R)$ is surjective,
\item for every prime $\mathfrak q' \subset S'$ there exists a
$g' \in S'$, $g' \not \in \mathfrak q'$ such that
the ring map $R \to S'_{g'}$ factors as $R \to S \to S'_{g'}$.
\end{enumerate}
\end{lemma}

\begin{proof}
By Proposition \ref{proposition-etale-locally-standard} and
the quasi-compactness of $\text{Spec}(S)$ (see Lemma \ref{lemma-quasicompact})
we can find $g_1, \ldots, g_n \in S$ generating the unit ideal
of $S$ such that each $R \to S_{g_i}$ is standard etale.
If we prove the lemma for the ring map $R \to \prod_{i = 1, \ldots, n} S_{g_i}$
then the lemma follows for the ring map $R \to S$.
Hence we may assume that $S = \prod_{i = 1, \ldots, n} S_i$
is a finite product of standard etale morphisms.

\medskip\noindent
For each $i$ choose a ring map $R \to S_i'$ as in
Lemma \ref{lemma-standard-etale-finite-flat-Zariski}
adapted to the standard etale morphism $R \to S_i$.
Set $S' = S_1' \otimes_R \ldots \otimes_R S_n'$; we will use
the $R$-algebra maps $S_i' \to S'$ without further mention below.
We claim this works. Properties (1) and (2) are immediate.
For property (3) suppose that $\mathfrak q' \subset S'$ is a prime.
Denote $\mathfrak p$ its image in $\text{Spec}(R)$.
Choose $i \in \{1, \ldots, n\}$ such that $\mathfrak p$
is in the image of $\text{Spec}(S_i) \to \text{Spec}(R)$; this is
possible by assumption. Set $\mathfrak q_i' \subset S_i'$
the image of $\mathfrak q'$ in the spectrum of $S_i'$.
By construction of $S'_i$ there exists a $g'_i \in S_i'$
such that $R \to (S_i')_{g_i'}$ factors as
$R \to S_i \to (S_i')_{g_i'}$. Hence also
$R \to S'_{g_i'}$ factors as
$$
R \to S_i \to (S_i')_{g_i'} \to S'_{g_i'}
$$
as desired.
\end{proof}

\begin{lemma}
\label{lemma-factor-mod-lift-etale}
Let $R$ be a ring. Let $f \in R[x]$ be a monic polynomial. Let $\mathfrak p$
be a prime of $R$. Let $f \bmod \mathfrak p = \overline{g} \overline{h}$
be a factorization of the image of $f$ in $\kappa(\mathfrak p)[x]$.
If $\gcd(\overline{g}, \overline{h}) = 1$, then there exist
\begin{enumerate}
\item an etale ring map $R \to R'$,
\item a prime $\mathfrak p' \subset R'$ lying over $\mathfrak p$, and
\item a factorization $f = g h$ in $R'[x]$
\end{enumerate}
such that
\begin{enumerate}
\item $\kappa(\mathfrak p) = \kappa(\mathfrak p')$,
\item $\overline{g} = g \bmod \mathfrak p'$,
$\overline{h} = h \bmod \mathfrak p'$, and
\item the polynomials $g, h$ generate the unit ideal in $R'[x]$.
\end{enumerate}
\end{lemma}

\begin{proof}
Suppose
$\overline{g} = \overline{b}_0 x^n + \overline{b}_1 x^{n - 1} + \ldots
+ \overline{b}_n$, and
$\overline{h} = \overline{c}_0 x^m + \overline{c}_1 x^{m - 1} + \ldots
+ \overline{c}_m$ with $\overline{b}_0, \overline{c}_0 \in \kappa(\mathfrak p)$
nonzero. After localizing $R$ at some element of $R$ not contained in
$\mathfrak p$ we may assume $\overline{b}_0$ is the
image of an invertible element $b_0 \in R$. Replacing
$\overline{g}$ by $\overline{g}/b_0$ and
$\overline{h}$ by $b_0\overline{h}$ we reduce to the case where
$\overline{g}$, $\overline{h}$ are monic (verification omitted).
Say $\overline{g} = x^n + \overline{b}_1 x^{n - 1} + \ldots + \overline{b}_n$,
and $\overline{h} = x^m + \overline{c}_1 x^{m - 1} + \ldots + \overline{c}_m$.
Write $f = x^{n + m} + a_1 x^{n - 1} + \ldots + a_{n + m}$.
Consider the fibre product
$$
R' = R \otimes_{\mathbf{Z}[a_1, \ldots, a_{n + m}]}
\mathbf{Z}[b_1, \ldots, b_n, c_1, \ldots, c_m]
$$
where the map $\mathbf{Z}[a_k] \to \mathbf{Z}[b_i, c_j]$
is as in Examples \ref{example-factor-polynomials} and
\ref{example-factor-polynomials-etale}. By construction there
is an $R$-algebra map
$$
R' = R \otimes_{\mathbf{Z}[a_1, \ldots, a_{n + m}]}
\mathbf{Z}[b_1, \ldots, b_n, c_1, \ldots, c_m]
\longrightarrow
\kappa(\mathfrak p)
$$
which maps $b_i$ to $\overline{b}_i$ and $c_j$ to $\overline{c}_j$.
Denote $\mathfrak p' \subset R'$ the kernel of this map.
Since by assumption the polynomials $\overline{g}, \overline{h}$
are relatively prime we see that the element
$\Delta = \text{Res}_x(g, h) \in \mathbf{Z}[b_i, c_j]$
(see Example \ref{example-factor-polynomials-etale})
does not map to zero in $\kappa(\mathfrak p)$ under the displayed map.
We conclude that $R \to R'$ is etale at $\mathfrak p'$.
In fact a solution to the problem posed in the lemma is
the ring map $R \to R'[1/\Delta]$ and the prime
$\mathfrak p' R'[1/\Delta]$. Because $\text{Res}_x(f, g)$ is
invertible in this ring the Sylvester matrix is invertible over
$R'$ and hence $1 = a g +  b h$ for some $a, b \in R'[x]$
see Example \ref{example-factor-polynomials-etale}.
\end{proof}

\noindent
The following lemmas say roughly that after an etale extension
a quasi-finite ring map becomes finite.
To help interpret the results recall that the locus where a
finite type ring map is quasi-finite is open
(see Lemma \ref{lemma-quasi-finite-open}) and that formation of
this locus commutes with arbitrary base change
(see Lemma \ref{lemma-quasi-finite-base-change}).

\begin{lemma}
\label{lemma-produce-finite}
Let $R \to S' \to S$ be ring maps.
Let $\mathfrak p \subset R$ be a prime.
Let $g \in S'$ be an element.
Assume
\begin{enumerate}
\item $R \to S'$ is integral,
\item $R \to S$ is finite type,
\item $S'_g \cong S_g$, and
\item $g$ invertible in $S' \otimes_R \kappa(\mathfrak p)$.
\end{enumerate}
Then there exists a $f \in R$, $f \not \in \mathfrak p$ such
that $R_f \to S_f$ is finite.
\end{lemma}

\begin{proof}
By assumption the image $T$ of $V(g) \subset \text{Spec}(S')$ under
the morphism $\text{Spec}(S') \to \text{Spec}(R)$ does not
contain $\mathfrak p$. By Section \ref{section-going-up}
especially, Lemma \ref{lemma-going-up-closed} we see $T$ is closed.
Pick $f \in R$, $f \not \in \mathfrak p$ such that
$T \cap V(f) = \emptyset$. Then we see that $g$ becomes invertible
in $S'_f$. Hence $S'_f \cong S_f$. Thus $S_f$ is both of finite type
and integral over $R_f$, hence finite.
\end{proof}

\begin{lemma}
\label{lemma-etale-makes-quasi-finite-finite-one-prime}
Let $R \to S$ be a ring map.
Let $\mathfrak q \subset S$ be a prime lying over
the prime $\mathfrak p \subset R$.
Assume $R \to S$ finite type and quasi-finite at $\mathfrak q$.
Then there exists
\begin{enumerate}
\item an etale ring map $R \to R'$,
\item a prime $\mathfrak p' \subset R'$ lying over $\mathfrak p$,
\item a product decomposition
$$
R' \otimes_R S = A \times B
$$
\end{enumerate}
with the following properties
\begin{enumerate}
\item $\kappa(\mathfrak p) = \kappa(\mathfrak p')$,
\item $R' \to A$ is finite,
\item $A$ has exactly one prime $\mathfrak r$ lying over $\mathfrak p'$, and
\item $\mathfrak r$ lies over $\mathfrak q$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $S' \subset S$ be the integral closure of $R$ in $S$.
Let $\mathfrak q' = S' \cap \mathfrak q$.
By Zariski's Main Theorem \ref{theorem-main-theorem}
there exists a $g \in S'$, $g \not \in \mathfrak q'$ such
that $S'_g \cong S_g$. Consider the fibre rings
$F = S \otimes_R \kappa(\mathfrak p)$ and
$F' = S' \otimes_R \kappa(\mathfrak p)$. Denote $\overline{\mathfrak q}'$
the prime of $F'$ corresponding to $\mathfrak q'$. Since
$F'$ is integral over $\kappa(\mathfrak p)$ we see
that $\overline{\mathfrak q}'$ is a closed point of
$\text{Spec}(F')$, see Lemma \ref{lemma-integral-over-field}.
Note that $\mathfrak q$ defines an isolated point $\overline{\mathfrak q}$ of
$\text{Spec}(F)$ (see Definition \ref{definition-quasi-finite}).
Since $S'_g \cong S_g$ we have $F'_g \cong F_g$,
so $\overline{\mathfrak q}$ and $\overline{\mathfrak q}'$
have isomorphic open neighbourhoods in $\text{Spec}(F)$
and $\text{Spec}(F')$. We conclude the set
$\{\overline{\mathfrak q}'\} \subset \text{Spec}(F')$ is
open. Combined with closedness shown above
we conclude that $\overline{\mathfrak q}'$ defines
an isolated point of $\text{Spec}(F')$ as well.

\medskip\noindent
An additional small remark is that under the map
$\text{Spec}(F) \to \text{Spec}(F')$ the point $\overline{\mathfrak q}$
is the only point mapping to $\overline{\mathfrak q}'$. This follows
from the discussion above.

\medskip\noindent
By Lemma \ref{lemma-disjoint-implies-product} we may write
$F = F_1 \times F_2$ with
$\text{Spec}(F_1) = \{\overline{\mathfrak q}'\}$.
Since $F = S' \otimes_R \kappa(\mathfrak p)$, there
exists an $s' \in S'$ which maps to the element
$(r, 0) \in F_1 \times F_2 = F$ for some $r \in R$, $r \not \in \mathfrak p$.
In fact, what we will use about $s'$ is that it is an element of $S'$,
not contained in $\mathfrak q'$, and contained in any other prime
lying over $\mathfrak p$.

\medskip\noindent
Let $f(x) \in R[x]$ be a monic polynomial such that $f(s') = 0$.
Denote $\overline{f} \in \kappa(\mathfrak p)[x]$ the image.
We can factor it as $\overline{f} = x^e \overline{h}$ where
$\overline{h}(0) \not = 0$. By Lemma \ref{lemma-factor-mod-lift-etale}
we can find an etale ring extension $R \to R'$,
a prime $\mathfrak p'$ lying over $\mathfrak p$, and
a factorization $f = h i$ in $R'[x]$ such that
$\kappa(\mathfrak p) = \kappa(\mathfrak p')$,
$x^e = h \bmod \mathfrak p'$,
$\overline{i} = i \bmod \mathfrak p'$, and
we can write $a h + b i = 1$ in $R'[x]$ (for suitable $a, b$).

\medskip\noindent
Consider the elements $h(s'), i(s') \in R' \otimes_R S'$.
By construction we have $h(s')i(s') = f(s') = 0$. On the other
hand they generate the unit ideal since $a(s')h(s') + b(s')i(s') = 1$.
Thus we see that $R' \otimes_R S'$ is the product of the
localizations at these elements:
$$
R' \otimes_R S'
=
(R' \otimes_R S')_{h(s')}
\times
(R' \otimes_R S')_{i(s')}
=
S'_1 \times S'_2
$$
Moreover this product decomposition is compatible with the product
decomposition we found for the fibre ring $F'$; this comes from our
choice of $s', h$ which garantee that $\overline{\mathfrak q}'$
is the only prime of $F'$ which does not contain the image of $h(s')$
in $F'$. Here we use that the fibre ring of $R'\otimes_R S'$ over $R'$ at
$\mathfrak p'$ is the same as $F'$ due to the fact that
$\kappa(\mathfrak p) = \kappa(\mathfrak p')$.
It follows that $S'_1$  has exactly
one prime, say $\mathfrak r'$,
lying over $\mathfrak p'$ and
that this prime lies over $\mathfrak q$.
Hence the element $g \in S'$ maps to an element of $S'_1$ not contained
in $\mathfrak r'$.

\medskip\noindent
The base change $R'\otimes_R S$ inherits a similar product decomposition
$$
R' \otimes_R S
=
(R' \otimes_R S)_{h(s')}
\times
(R' \otimes_R S)_{i(s')}
=
S_1 \times S_2
$$
It follows from the above that $S_1$ has exactly
one prime, say $\mathfrak r$,
lying over $\mathfrak p'$ (consider the fibre ring as above),
and that this prime lies over $\mathfrak q$.

\medskip\noindent
Now we may apply Lemma \ref{lemma-produce-finite} to the ring maps
$R' \to S'_1 \to S_1$, the prime $\mathfrak p'$ and
the element $g$ to see that after replacing $R'$ by
a principal localization we can assume that $S_1$ is
finite over $R'$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-etale-makes-quasi-finite-finite}
Let $R \to S$ be a ring map.
Let $\mathfrak p \subset R$ be a prime.
Assume $R \to S$ finite type.
Then there exists
\begin{enumerate}
\item an etale ring map $R \to R'$,
\item a prime $\mathfrak p' \subset R'$ lying over $\mathfrak p$,
\item a product decomposition
$$
R' \otimes_R S = A_1 \times \ldots \times A_n \times B
$$
\end{enumerate}
with the following properties
\begin{enumerate}
\item we have $\kappa(\mathfrak p) = \kappa(\mathfrak p')$,
\item each $A_i$ is finite over $R'$,
\item each $A_i$ has exactly one prime $\mathfrak r_i$ lying over
$\mathfrak p'$, and
\item $R' \to B$ not quasi-finite at any prime lying over $\mathfrak p'$.
\end{enumerate}
\end{lemma}

\begin{proof}
Denote $F = S \otimes_R \kappa(\mathfrak p)$ the fibre ring of $S/R$
at the prime $\mathfrak p$. As $F$ is of finite type over $\kappa(\mathfrak p)$
it is Noetherian and hence $\text{Spec}(F)$ has finitely many isolated
points. If there are no isolated points,
i.e., no primes $\mathfrak q$ of $S$ over $\mathfrak p$ such that
$S/R$ is quasi-finite at $\mathfrak q$, then the lemma holds.
If there exists at least one such prime $\mathfrak q$, then
we may apply Lemma \ref{lemma-etale-makes-quasi-finite-finite-one-prime} above.
This gives a diagram
$$
\xymatrix{
S \ar[r] & R'\otimes_R S \ar@{=}[r] & A_1 \times B' \\
R \ar[r] \ar[u] & R' \ar[u] \ar[ru]
}
$$
as in said lemma. Since the residue fields at $\mathfrak p$ and $\mathfrak p'$
are the same, the fibre rings of $S/R$ and $(A \times B)/R'$
are the same. Hence, by induction on the number of isolated points
of the fibre we may assume that the lemma holds for
$R' \to B$ and $\mathfrak p'$. Thus we get an etale ring
map $R' \to R''$, a prime $\mathfrak p'' \subset R''$ and
a decomposition
$$
R'' \otimes_{R'} B' = A_2 \times \ldots \times A_n \times B
$$
We omit the verification that the ring map $R \to R''$, the
prime $\mathfrak p''$ and the resulting decomposition
$$
R'' \otimes_R S = (R'' \otimes_{R'} A_1) \times
A_2 \times \ldots \times A_n \times B
$$
is a solution to the problem posed in the lemma.
\end{proof}

\begin{lemma}
\label{lemma-etale-makes-quasi-finite-finite-variant}
Let $R \to S$ be a ring map.
Let $\mathfrak p \subset R$ be a prime.
Assume $R \to S$ finite type.
Then there exists
\begin{enumerate}
\item an etale ring map $R \to R'$,
\item a prime $\mathfrak p' \subset R'$ lying over $\mathfrak p$,
\item a product decomposition
$$
R' \otimes_R S = A_1 \times \ldots \times A_n \times B
$$
\end{enumerate}
with the following properties
\begin{enumerate}
\item each $A_i$ is finite over $R'$,
\item each $A_i$ has exactly one prime $\mathfrak r_i$ lying over
$\mathfrak p'$,
\item the finite field extensions
$\kappa(\mathfrak p') \subset \kappa(\mathfrak r_i)$
are purely inseparable, and
\item $R' \to B$ not quasi-finite at any prime lying over $\mathfrak p'$.
\end{enumerate}
\end{lemma}

\begin{proof}
The strategy of the proof is to make two etale ring
extensions: first we control the residue fields, then we
apply Lemma \ref{lemma-etale-makes-quasi-finite-finite} above.

\medskip\noindent
Denote $F = S \otimes_R \kappa(\mathfrak p)$ the fibre ring of $S/R$
at the prime $\mathfrak p$.
As in the proof of Lemma \ref{lemma-etale-makes-quasi-finite-finite}
there are finitely may primes, say
$\mathfrak q_1, \ldots, \mathfrak q_n$ of $S$ lying over
$R$ at which the ring map $R \to S$ is quasi-finite.
Let $\kappa(\mathfrak p) \subset L_i \subset \kappa(\mathfrak q_i)$
be the subfield such that $\kappa(\mathfrak p) \subset L_i$
is separable, and the field extension $L_i \subset \kappa(\mathfrak q_i)$
is purely inseparable. Let $\kappa(\mathfrak p) \subset L$
be a finite Galois extension into which $L_i$ embeds for $i = 1, \ldots, n$.
By Lemma \ref{lemma-make-etale-map-prescribed-residue-field}
we can find an etale ring extension
$R \to R'$ together with a prime $\mathfrak p'$ lying over $\mathfrak p$
such that the field extension
$\kappa(\mathfrak p) \subset \kappa(\mathfrak p')$ is isomorphic
to $\kappa(\mathfrak p) \subset L$.
Thus the fibre ring of $R' \otimes_R S$ at $\mathfrak p'$ is
isomorphic to $F \otimes_{\kappa(\mathfrak p)} L$.
The primes lying over $\mathfrak q_i$ correspond to primes
of $\kappa(\mathfrak q_i) \otimes_{\kappa(\mathfrak p)} L$
which is a product of fields purely inseparable over
$L$ by our choice of $L$ and elementary field theory.
These are also the only primes over $\mathfrak p'$
at which $R' \to R' \otimes_R S$ is quasi-finite, by
Lemma \ref{lemma-quasi-finite-base-change}.
Hence after replacing $R$ by $R'$, $\mathfrak p$ by $\mathfrak p'$,
and $S$ by $R' \otimes_R S$ we may assume that for all
primes $\mathfrak q$ lying over $\mathfrak p$
for which $S/R$ is quasi-finite the field extensions
$\kappa(\mathfrak p) \subset \kappa(\mathfrak q)$
are purely inseparable.

\medskip\noindent
Next apply Lemma \ref{lemma-etale-makes-quasi-finite-finite}.
The result is what we want since the field extensions do not
change under this etale ring extension.
\end{proof}







\section{Local homomorphisms}
\label{section-local-homomorphisms}

\begin{lemma}
\label{lemma-etale-under-finite-flat}
Let $(R, \mathfrak m_R) \to (S, \mathfrak m_S)$ be a local homomorphism
of local rings. Assume $S$ is the localization of an etale ring extension
of $R$. Then there exists a finite, finitely presented, faithfully flat
ring map $R \to S'$ such that for every maximal ideal $\mathfrak m'$ of $S'$
there is a factorization
$$
R \to S \to S'_{\mathfrak m'}.
$$
of the ring map $R \to S'_{\mathfrak m'}$.
\end{lemma}

\begin{proof}
Write $S = T_{\mathfrak q}$ for some etale $R$-algebra $T$. By
Proposition \ref{proposition-etale-locally-standard}
we may assume $T$ is standard etale.
Apply
Lemma \ref{lemma-standard-etale-finite-flat-Zariski}
to the ring map $R \to T$ to get $R \to S'$. Then in particular
for every maximal ideal $\mathfrak m'$ of $S'$ we get a factorization
$\varphi : T \to S'_{g'}$ for some $g' \not \in \mathfrak m'$ such
that $\mathfrak q = \varphi^{-1}(\mathfrak m'S'_{g'})$. Thus $\varphi$
induces the desired local ring map $S \to S'_{\mathfrak m'}$.
\end{proof}





\section{Integral closure and smooth base change}
\label{section-integral-closure-smooth-base-change}

\begin{lemma}
\label{lemma-trick}
Let $R$ be a ring.
Let $f \in R[x]$ be a monic polynomial.
Let $R \to B$ be a ring map.
If $h \in B[x]/(f)$ is integral over $R$, then the element
$f' h$ can be written as $f'h = \sum_i b_i x^i$ with $b_i \in B$
integral over $R$.
\end{lemma}

\begin{proof}
Say $h^e + r_1 h^{e - 1} + \ldots + r_e = 0$ in the ring $B[x]/(f)$
with $r_i \in R$.
There exists a finite free ring extension $B \subset B'$ such that
$f = (x - \alpha_1) \ldots (x - \alpha_d)$ for some $\alpha_i \in B'$,
see Lemma \ref{lemma-adjoin-roots}.
Note that each $\alpha_i$ is integral over $R$.
We may represent $h = h_0 + h_1 x + \ldots + h_{d - 1} x^{d - 1}$
with $h_i \in B$. Then it is a universal fact that
$$
f' h
\equiv
\sum\nolimits_{i = 1, \ldots, d}
h(\alpha_i)
(x - \alpha_1) \ldots \widehat{(x - \alpha_i)} \ldots (x - \alpha_d)
$$
as elements of $B[x]/(f)$. You prove this by
evaluating both sides at the points $\alpha_i$ over the ring
$B_{univ} = \mathbf{Z}[\alpha_i, h_j]$ (some details omitted).
By our assumption that $h$ satisfies
$h^e + r_1 h^{e - 1} + \ldots + r_e = 0$ in the ring $B[x]/(f)$
we see that
$$
h(\alpha_i)^e + r_1 h(\alpha_i)^{e - 1} + \ldots + r_e = 0
$$
in $B'$. Hence $h(\alpha_i)$ is integral over $R$. Using the formula
above we see that $f'h \equiv \sum_{j = 0, \ldots, d - 1} b'_j x^j$
in $B'[x]/(f)$ with $b'_j \in B'$ integral over $R$. However,
since $f' h \in B[x]/(f)$ and since $1, x, \ldots, x^{d - 1}$ is a
$B'$-basis for $B'[x]/(f)$ we see that $b'_j \in B$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-integral-closure-commutes-etale}
Let $R \to S$ be an etale ring map.
Let $R \to B$ be any ring map.
Let $A \subset B$ be the integral closure of $R$ in $B$.
Let $A' \subset S \otimes_R B$ be the integral closure of $S$ in
$S \otimes_R B$. Then the canonical map $S \otimes_R A \to A'$ is
an isomorphism.
\end{lemma}

\begin{proof}
The map $S \otimes_R A \to A'$ is injective because $A \subset B$ and
$R \to S$ is flat. We are going to use repeatedly that taking integral
closure commutes with localization, see
Lemma \ref{lemma-integral-closure-localize}.
Hence we may localize on $S$, by Lemma \ref{lemma-cover} (the criterion
for checking whether an $S$-module map is an isomorphism).
Thus we may assume that $S = R[x]_g/(f) = (R[x]/(f))_g$
is standard etale over $R$,
see Proposition \ref{proposition-etale-locally-standard}.
Applying localization one more time we see that
$A'$ is $(A'')_g$ where $A''$ is the integral closure of
$R[x]/(f)$ in $B[x]/(f)$. Suppose that $a \in A''$. It suffices
to show that $a$ is in $S \otimes_R A$. By
Lemma \ref{lemma-trick} we see that $f' a = \sum a_i x^i$ with $a_i \in A$.
Since $f'$ is invertible in $B[x]_g/(f)$ (by definition of a standard
etale ring map) we conclude that $a \in S \otimes_R A$ as desired.
\end{proof}

\begin{example}
\label{example-fourier}
Let $p$ be a prime number.
For every $n > 0$ the ring extension
$$
R = \mathbf{Z}[1/p] \subset R' = \mathbf{Z}[1/p][x]/(x^{p^n} - 1)
$$
has the following property: For $d < p^n$ there exist elements
$\alpha_0, \ldots, \alpha_{d - 1} \in R'$ such that
$$
\prod\nolimits_{0 \leq i < j < d} (\alpha_i - \alpha_j)
$$
is a unit in $R'$. Namely, take $\alpha_i$ equal to the class of
$x^i$ in $R'$. Then we have
$$
T^{p^n} - 1 = \prod\nolimits_{i = 0, \ldots, p^n - 1} (T - \alpha_i)
$$
(for example because this is clear over $\mathbf{Q}$)
and hence by taking derivatives on both sides
$$
p^n \alpha_i^{p^n - 1}
=
(\alpha_i - \alpha_1) \ldots
\widehat{(\alpha_i - \alpha_i)} \ldots
(\alpha_i - \alpha_1)
$$
and we see this is invertible in $R'$.
\end{example}

\begin{lemma}
\label{lemma-integral-closure-commutes-smooth}
Let $R \to S$ be a smooth ring map.
Let $R \to B$ be any ring map.
Let $A \subset B$ be the integral closure of $R$ in $B$.
Let $A' \subset S \otimes_R B$ be the integral closure of $S$ in
$S \otimes_R B$. Then the canonical map $S \otimes_R A \to A'$ is
an isomorphism.
\end{lemma}

\begin{proof}
Arguing as in the proof of Lemma \ref{lemma-integral-closure-commutes-etale}
we may localize on $S$. Hence we may assume that $R \to S$ is a standard
smooth ring map, see Lemma \ref{lemma-smooth-syntomic}. By definition of
a standard smooth ring map we see that $S$ is etale over a polynomial
ring $R[x_1, \ldots, x_n]$. Since we have seen the result in the case of
an etale ring extension (Lemma \ref{lemma-integral-closure-commutes-etale})
this reduces us to the case where $S = R[x]$. Thus we have to show
$$
f = \sum b_i x^i
\text{ integral over }R[x]
\Leftrightarrow
\text{each }b_i\text{ integral over }R.
$$
The implication from right to left holds because the set of elements
in $B[x]$ integral over $R[x]$ is a ring
(Lemma \ref{lemma-integral-closure-is-ring}) and contains
$x$.

\medskip\noindent
Suppose that $f \in B[x]$ is integral over $R[x]$, and assume that
$f = \sum_{i < d} b_i x^i$ has degree $< d$. Since integral closure
and localization commute, it suffices to show that each $b_i$ is
integral over $R[1/2]$ and over $R[1/3]$. Hence, we can find a finite
free ring extension $R \subset R'$ such that $R'$ contains
$\alpha_1, \ldots, \alpha_d$ with the property that
$\prod_{i < j} (\alpha_i - \alpha_j)$ is a unit in $R'$, see
Example \ref{example-fourier}.
In this case we have the universal equality
$$
f
=
\sum_i
f(\alpha_i)
\frac{(x - \alpha_1) \ldots \widehat{(x - \alpha_i)} \ldots (x - \alpha_d)}
{(\alpha_i - \alpha_1) \ldots \widehat{(\alpha_i - \alpha_i)} \ldots
(\alpha_i - \alpha_d)}.
$$
OK, and the elements $f(\alpha_i)$ are integral over $R'$ since
$(R' \otimes_R B)[x] \to R' \otimes_R B$, $h \mapsto h(\alpha_i)$
is a ring map. Hence we see that the coefficients of $f$
in $(R' \otimes_R B)[x]$ are integral over over $R'$. Since $R'$ is finite
over $R$ (hence integral over $R$) we see that they are integral
over $R$ also, as desired.
\end{proof}



\section{Formally unramified maps}
\label{section-formally-unramified}

\noindent
It turns out to be logically more efficient to define
the notion of a formally unramified map before introducing
the notion of a formally etale one.

\begin{definition}
\label{definition-formally-unramified}
Let $R \to S$ be a ring map.
We say $S$ is {\it formally unramified over $R$} if for every
commutative solid diagram
$$
\xymatrix{
S \ar[r] \ar@{-->}[rd] & A/I \\
R \ar[r] \ar[u] & A \ar[u]
}
$$
where $I \subset A$ is an ideal of square zero, there exists
at most one dotted arrow making the diagram commute.
\end{definition}

\begin{lemma}
\label{lemma-characterize-formally-unramified}
Let $R \to S$ be a ring map.
The following are equivalent:
\begin{enumerate}
\item $R \to S$ is formally unramified,
\item the module of differentials $\Omega_{S/R}$ is zero.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $J = \text{Ker}(S \otimes_R S \to S)$ be the kernel of
the multiplication map. Let $A_{univ} = S \otimes_R S/J^2$. Recall
that $I_{univ} = J/J^2$ is isomorphic to $\Omega_{S/R}$, see
Lemma \ref{lemma-differentials-diagonal}. Moreover, the two $R$-algebra maps
$\sigma_1, \sigma_2 : S \to A_{univ}$, $\sigma_1(s) = s \otimes 1 \bmod J^2$,
and $\sigma_2(s) = 1 \otimes s \bmod J^2$ differ by the
universal derivation $\text{d} : S \to \Omega_{S/R} = I_{univ}$.

\medskip\noindent
Assume $R \to S$ formally unramified.
Then we see that $\sigma_1 = \sigma_2$.
Hence $\text{d}(s) = 0$ for all $s \in S$.
Hence $\Omega_{S/R} = 0$.

\medskip\noindent
Assume that $\Omega_{S/R} = 0$. Let $A, I, R \to A, S \to A/I$
be a solid diagram as in Definition \ref{definition-formally-unramified}.
Let $\tau_1, \tau_2 : S \to A$ be two dotted arrows making the
diagram commute. Consider the $R$-algebra map $A_{univ} \to A$
defined by the rule $s_1 \otimes s_2 \mapsto \tau_1(s_1)\tau_2(s_2)$.
We omit the verification that this is well defined. Since $A_{univ} \cong S$
as $I_{univ} = \Omega_{S/R} = 0$ we conclude that $\tau_1 = \tau_2$.
\end{proof}

\begin{lemma}
\label{lemma-formally-unramified-local}
Let $R \to S$ be a ring map.
The following are equivalent:
\begin{enumerate}
\item $R \to S$ is formally unramified,
\item $R \to S_{\mathfrak q}$ is formally unramified for all
primes $\mathfrak q$ of $S$, and
\item $R_{\mathfrak p} \to S_{\mathfrak q}$ is formally unramified
for all primes $\mathfrak q$ of $S$ with $\mathfrak p = R \cap \mathfrak q$.
\end{enumerate}
\end{lemma}

\begin{proof}
We have seen in
Lemma \ref{lemma-characterize-formally-unramified}
that (1) is equivalent to
$\Omega_{S/R} = 0$. Similarly, by
Lemma \ref{lemma-differentials-localize}
we see that (2) and (3)
are equivalent to $(\Omega_{S/R})_{\mathfrak q} = 0$ for all
$\mathfrak q$. Hence the equivalence follows from
Lemma \ref{lemma-characterize-zero-local}.
\end{proof}

\begin{lemma}
\label{lemma-formally-unramified-localize}
Let $A \to B$ be a formally unramified ring map.
\begin{enumerate}
\item For $S \subset A$ a multiplicative subset,
$S^{-1}A \to S^{-1}B$ is formally unramified.
\item For $S \subset B$ a multiplicative subset,
$A \to S^{-1}B$ is formally unramified.
\end{enumerate}
\end{lemma}

\begin{proof}
Follows from
Lemma \ref{lemma-formally-unramified-local}.
(You can also deduce it from
Lemma \ref{lemma-characterize-formally-unramified}
combined with
Lemma \ref{lemma-differentials-localize}.)
\end{proof}



\section{Conormal modules and universal thickenings}
\label{section-conormal}

\noindent
It turns out that one can define the first infinitesimal neighbourhood
not just for a closed immersion of schemes, but already for any formally
unramified morphism. This is based on the following algebraic fact.

\begin{lemma}
\label{lemma-universal-thickening}
Let $R \to S$ be a formally unramified ring map. There exists a surjection of
$R$-algebras $S' \to S$ whose kernel is an ideal of square zero with the
following universal property: Given any commutative diagram
$$
\xymatrix{
S \ar[r]_{a} & A/I \\
R \ar[r]^b \ar[u] & A \ar[u]
}
$$
where $I \subset A$ is an ideal of square zero, there is a unique $R$-algebra
map $a' : S' \to A$ such that $S' \to A \to A/I$ is equal to $S' \to S \to A$.
\end{lemma}

\begin{proof}
Choose a set of generators $z_i \in S$, $i \in I$ for $S$ as an $R$-algebra.
Let $P = R[\{x_i\_{i \in I}]$ denote the polynomial ring on generators
$x_i$, $i \in I$. Consider the $R$-algebra map $P \to S$ which maps
$x_i$ to $z_i$. Let $J = \text{Ker}(P \to S)$. Consider the map
$$
\text{d} : J/J^2 \longrightarrow \Omega_{P/R} \otimes_P S
$$
see
Lemma \ref{lemma-differential-seq}.
This is surjective since $\Omega_{S/R} = 0$ by assumption, see
Lemma \ref{lemma-characterize-formally-unramified}.
Note that $\Omega_{P/R}$ is free on $\text{d}x_i$, and hence the module
$\Omega_{P/R} \otimes_P S$ is free over $S$. Thus we may choose a splitting
of the surjection above and write
$$
J/J^2 = K \oplus \Omega_{P/R} \otimes_P S
$$
Let $J^2 \subset J' \subset J$ be the ideal of $P$ such that
$J'/J^2$ is the second summand in the decomposition above.
Set $S' = P/J'$. We obtain a short exact sequence
$$
0 \to J/J' \to S' \to S \to 0
$$
and we see that $J/J' \cong K$ is a square zero ideal in $S'$. Hence
$$
\xymatrix{
S \ar[r]_1 & S \\
R \ar[r] \ar[u] & S' \ar[u]
}
$$
is a diagram as above. In fact we claim that this is an initial object in
the category of diagrams. Namely, let $(I \subset A, a, b)$ be an arbitrary
diagram. We may choose an $R$-algebra map $\beta : P \to A$ such that
$$
\xymatrix{
S \ar[r]_1 & S \ar[r]_a & A/I \\
R \ar[r] \ar@/_/[rr]_b \ar[u] & P \ar[u] \ar[r]^\beta & A \ar[u]
}
$$
is commutative. Now it may not be the case that $\beta(J') = 0$, in other
words it may not be true that $\beta$ factors through $S' = P/J'$.
But what is clear is that $\beta(J') \subset I$ and
since $\beta(J) \subset I$ and $I^2 = 0$ we have $\beta(J^2) = 0$.
Thus the ``obstruction'' to finding a morphism from
$(J/J' \subset S', 1, R \to S')$ to $(I \subset A, a, b)$ is
the corresponding $S$-linear map $\overline{\beta} : J'/J^2 \to I$.
The choice in picking $\beta$ lies in the choice of $\beta(x_i)$.
A different choice of $\beta$, say $\beta'$, is gotten by taking
$\beta'(x_i) = \beta(x_i) + \delta_i$ with $\delta_i \in I$.
In this case, for $g \in J'$, we obtain
$$
\beta'(g) =
\beta(g) + \sum\nolimits_i \delta_i \frac{\partial g}{\partial x_i}.
$$
Since the map $\text{d}|_{J'/J^2} : J'/J^2 \to \Omega_{P/R} \otimes_P S$
given by $g \mapsto \frac{\partial g}{\partial x_i}\text{d}x_i$
is an isomorphism by construction, we see that there is a unique choice
of $\delta_i \in I$ such that $\beta'(g) = 0$ for all $g \in J'$.
(Namely, $\delta_i$ is $-\overline{\beta}(g)$ where $g \in J'/J^2$
is the unique element with $\frac{\partial g}{\partial x_j} = 1$ if
$i = j$ and $0$ else.) The uniqueness of the solution implies the
uniqueness required in the lemma.
\end{proof}

\noindent
In the situation of
Lemma \ref{lemma-universal-thickening}
the $R$-algebra map $S' \to S$ is unique up to unique isomorphism.

\begin{definition}
\label{definition-universal-thickening}
Let $R \to S$ be a formally unramified ring map.
\begin{enumerate}
\item The {\it universal first order thickening} of $S$ over $R$ is
the surjection of $R$-algebras $S' \to S$ of
Lemma \ref{lemma-universal-thickening}.
\item The {\it conormal module} of $R \to S$ is the kernel $I$ of the
universal first order thickening $S' \to S$, seen as a $S$-module.
\end{enumerate}
We often denote the conormal module {\it $C_{S/R}$} in this situation.
\end{definition}

\begin{lemma}
\label{lemma-universal-thickening-quotient}
Let $I \subset R$ be an ideal of a ring.
The universal first order thickening of $R/I$ over $R$
is the surjection $R/I^2 \to R/I$. The conormal module
of $R/I$ over $R$ is $C_{(R/I)/R} = I/I^2$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-universal-thickening-localize}
Let $A \to B$ be a formally unramified ring map.
Let $\varphi : B' \to B$ be the universal first order thickening of
$B$ over $A$.
\begin{enumerate}
\item Let $S \subset A$ be a multiplicative subset.
Then $S^{-1}B' \to S^{-1}B$ is the universal first order thickening of
$S^{-1}B$ over $S^{-1}A$. In particular $S^{-1}C_{B/A} = C_{S^{-1}B/S^{-1}A}$.
\item Let $S \subset B$ be a multiplicative subset.
Then $S' = \varphi^{-1}(S)$ is a multiplicative subset in $B'$
and $(S')^{-1}B' \to S^{-1}B$ is the universal first order thickening
of $S^{-1}B$ over $A$. In particular $S^{-1}C_{B/A} = C_{S^{-1}B/A}$.
\end{enumerate}
Note that the lemma makes sense by
Lemma \ref{lemma-formally-unramified-localize}.
\end{lemma}

\begin{proof}
With notation and assumptions as in (1). Let $(S^{-1}B)' \to S^{-1}B$
be the universal first order thickening of $S^{-1}B$ over $S^{-1}A$.
Note that $S^{-1}B' \to S^{-1}B$ is a surjection of $S^{-1}A$-algebras
whose kernel has square zero. Hence by definition we obtain a map
$(S^{-1}B)' \to S^{-1}B'$ compatible with the maps towards $S^{-1}B$.
Consider any commutative diagram
$$
\xymatrix{
B \ar[r] & S^{-1}B \ar[r] & D/I \\
A \ar[r] \ar[u] & S^{-1}A \ar[r] \ar[u] & D \ar[u]
}
$$
where $I \subset D$ is an ideal of square zero. Since $B'$ is the universal
first order thickening of $B$ over $A$ we obtain an $A$-algebra map
$B' \to D$. But it is clear that the image of $S$ in $D$ is mapped to
invertible elements of $D$, and hence we obtain a compatible map
$S^{-1}B' \to D$. Applying this to $D = (S^{-1}B)'$ we see that we get
a map $S^{-1}B' \to (S^{-1}B)'$. We omit the verification that this map
is inverse to the map described above.

\medskip\noindent
With notation and assumptions as in (2). Let $(S^{-1}B)' \to S^{-1}B$
be the universal first order thickening of $S^{-1}B$ over $A$.
Note that $(S')^{-1}B' \to S^{-1}B$ is a surjection of $A$-algebras
whose kernel has square zero. Hence by definition we obtain a map
$(S^{-1}B)' \to (S')^{-1}B'$ compatible with the maps towards $S^{-1}B$.
Consider any commutative diagram
$$
\xymatrix{
B \ar[r] & S^{-1}B \ar[r] & D/I \\
A \ar[r] \ar[u] & A \ar[r] \ar[u] & D \ar[u]
}
$$
where $I \subset D$ is an ideal of square zero. Since $B'$ is the universal
first order thickening of $B$ over $A$ we obtain an $A$-algebra map
$B' \to D$. But it is clear that the image of $S'$ in $D$ is mapped to
invertible elements of $D$, and hence we obtain a compatible map
$(S')^{-1}B' \to D$. Applying this to $D = (S^{-1}B)'$ we see that we get
a map $(S')^{-1}B' \to (S^{-1}B)'$. We omit the verification that this map
is inverse to the map described above.
\end{proof}

\begin{lemma}
\label{lemma-differentials-universal-thickening}
Let $R \to A  \to B$ be ring maps. Assume $A \to B$ formally unramified.
Let $B' \to B$ be the universal first order thickening of $B$ over $A$.
Then $B'$ is formally unramified over $A$, and the canonical map
$\Omega_{A/R} \otimes_A B \to \Omega_{B'/R} \otimes_{B'} B$ is an
isomorphism.
\end{lemma}

\begin{proof}
We are going to use the construction of $B'$ from the proof of
Lemma \ref{lemma-universal-thickening}
allthough in principle it should be possible to deduce these results
formally from the definition. Namely, we choose a presentation
$B = P/J$, where $P = A[x_i]$ is a polynomial ring over $A$.
Next, we choose elements $f_i \in J$ such that
$\text{d}f_i = \text{d}x_i \otimes 1$ in $\Omega_{P/A} \otimes_P B$.
Having made these choices we have
$B' = P/J'$ with $J' = (f_i) + J^2$, see proof of
Lemma \ref{lemma-universal-thickening}.

\medskip\noindent
Consider the canonical exact sequence
$$
J'/(J')^2 \to \Omega_{P/A} \otimes_P B' \to \Omega_{B'/A} \to 0
$$
see
Lemma \ref{lemma-differential-seq}.
By construction the classes of the $f_i \in J'$ map to elements of
the module $\Omega_{P/A} \otimes_P B'$ which generate it modulo
$J'/J^2$ by construction. Since $J'/J^2$ is a nilpotent ideal, we see
that these elements generate the module alltogether (by
Nakayama's Lemma \ref{lemma-NAK}). This proves that $\Omega_{B'/A} = 0$
and hence that $B'$ is formally unramified over $A$, see
Lemma \ref{lemma-characterize-formally-unramified}.

\medskip\noindent
Since $P$ is a polynomial ring over $A$ we have
$\Omega_{P/R} = \Omega_{A/R} \otimes_A P \oplus \bigoplus P\text{d}x_i$.
We are going to use this decomposition.
Consider the following exact sequence
$$
J'/(J')^2 \to
\Omega_{P/R} \otimes_P B' \to
\Omega_{B'/R} \to 0
$$
see
Lemma \ref{lemma-differential-seq}.
We may tensor this with $B$ and obtain the exact sequence
$$
J'/(J')^2 \otimes_{B'} B \to
\Omega_{P/R} \otimes_P B \to
\Omega_{B'/R} \otimes_{B'} B \to 0
$$
If we remember that $J' = (f_i) + J^2$
then we see that the first arrow annihilates the submodule $J^2/(J')^2$.
In terms of the direct sum decomposition
$\Omega_{P/R} \otimes_P B =
\Omega_{A/R} \otimes_A B \oplus \bigoplus B\text{d}x_i $ given
we see that the submodule $(f_i)/(J')^2 \otimes_{B'} B$ maps
isomorphically onto the summand $\bigoplus B\text{d}x_i$. Hence what is
left of this exact sequence is an isomorphism
$\Omega_{A/R} \otimes_A B \to \Omega_{B'/R} \otimes_{B'} B$
as desired.
\end{proof}









\section{Formally etale maps}
\label{section-formally-etale}

\begin{definition}
\label{definition-formally-etale}
Let $R \to S$ be a ring map.
We say $S$ is {\it formally etale over $R$} if for every
commutative solid diagram
$$
\xymatrix{
S \ar[r] \ar@{-->}[rd] & A/I \\
R \ar[r] \ar[u] & A \ar[u]
}
$$
where $I \subset A$ is an ideal of square zero, there exists
a unique dotted arrow making the diagram commute.
\end{definition}

\noindent
Clearly a ring map is formally etale if and only if
it is booth formally smooth and formally unramified.

\begin{lemma}
\label{lemma-formally-etale-etale}
Let $R \to S$ be a ring map of finite presentation.
The following are equivalent:
\begin{enumerate}
\item $R \to S$ is formally etale,
\item $R \to S$ is etale.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume that $R \to S$ is formally etale.
Then $R \to S$ is smooth by Lemma \ref{lemma-formally-smooth-smooth}.
By Lemma \ref{lemma-characterize-formally-unramified}
we have $\Omega_{S/R} = 0$.
Hence $R \to S$ is etale by definition.

\medskip\noindent
Assume that $R \to S$ is etale.
Then $R \to S$ is formally smooth by
Lemma \ref{lemma-smooth-formally-smooth}.
By Lemma \ref{lemma-characterize-formally-unramified}
it is formally unramified. Hence $R \to S$ is formally etale.
\end{proof}

\begin{lemma}
\label{lemma-colimit-formally-etale}
Let $R$ be a ring. Let $I$ be a directed partially ordered set.
Let $(S_i, \varphi_{ii'})$ be a system of $R$-algebras
over $I$. If each $R \to S_i$ is formally etale, then
$S = \text{colim}_{i \in I}\ S_i$ is formally etale over $R$
\end{lemma}

\begin{proof}
Consider a diagram as in Definition \ref{definition-formally-etale}.
By assumption we get unique $R$-algebra maps $S_i \to A$ lifting
the compositions $S_i \to S \to A/I$. Hence these are compatible
with the transition maps $\varphi_{ii'}$ and define a lift
$S \to A$. This proves existence.
The uniqueness is clear by restricting to each $S_i$.
\end{proof}

\begin{lemma}
\label{lemma-localization-formally-etale}
Let $R$ be a ring. Let $S \subset R$ be any multiplicative subset.
Then the ring map $R \to S^{-1}R$ is formally etale.
\end{lemma}

\begin{proof}
Let $I \subset A$ be an ideal of square zero. What we are saying
here is that given a ring map $\varphi : R \to A$ such that
$\varphi(f) \mod I$ is invertible for all $f \in S$ we have also that
$\varphi(f)$ is invertible in $A$ for all $f \in S$. This is true because
$A^*$ is the inverse image of $(A/I)^*$ under the canonical map
$A \to A/I$.
\end{proof}





\section{Unramified ring maps}
\label{section-unramified}

\noindent
The definition of a G-unramified ring map is the one from EGA.
The definition of an unramified ring map is the one from \cite{Henselian}.

\begin{definition}
\label{definition-unramified}
Let $R \to S$ be a ring map.
\begin{enumerate}
\item We say $R \to S$ is {\it unramified} if $R \to S$ is of
finite type and $\Omega_{S/R} = 0$.
\item We say $R \to S$ is {\it G-unramified} if $R \to S$ is of finite
presentation and $\Omega_{S/R} = 0$.
\item Given a prime $\mathfrak q$ of $S$ we say that $S$ is
{\it unramified at $\mathfrak q$} if there exists a
$g \in S$, $g \not \in \mathfrak q$ such that $R \to S_g$ is unramified.
\item Given a prime $\mathfrak q$ of $S$ we say that $S$ is
{\it G-unramified at $\mathfrak q$} if there exists a
$g \in S$, $g \not \in \mathfrak q$ such that $R \to S_g$ is G-unramified.
\end{enumerate}
\end{definition}

\noindent
Of course a G-unramified map is unramified.

\begin{lemma}
\label{lemma-formally-unramified-unramified}
Let $R \to S$ be a ring map. The following are equivalent
\begin{enumerate}
\item $R \to S$ is formally unramified and of finite type, and
\item $R \to S$ is unramified.
\end{enumerate}
Moreover, also the following are equivalent
\begin{enumerate}
\item $R \to S$ is formally unramified and of finite presentation, and
\item $R \to S$ is G-unramified.
\end{enumerate}
\end{lemma}

\begin{proof}
Follows from Lemma \ref{lemma-characterize-formally-unramified}
and the definitions.
\end{proof}

\begin{lemma}
\label{lemma-unramified}
Properties of unramified and G-unramified ring maps.
\begin{enumerate}
\item The base change of an unramified ring map is unramified.
The base change of a G-unramified ring map is G-unramified.
\item The composition of unramified ring maps is unramified.
The composition of G-unramified ring maps is G-unramified.
\item Any principal localization $R \to R_f$ is G-unramified and
unramified.
\item If $I \subset R$ is an ideal, then $R \to R/I$ is unramified.
If $I \subset R$ is a finitely generated ideal, then $R \to R/I$ is
G-unramified.
\item An etale ring map is G-unramified and unramified.
\item If $R \to S$ is of finite type (resp.\ finite presentation),
$\mathfrak q \subset S$ is a prime and $(\Omega_{S/R})_{\mathfrak q} = 0$,
then $R \to S$ is unramified (resp.\ G-unramified) at $\mathfrak q$.
\item If $R \to S$ is of finite type (resp.\ finite presentation),
$\mathfrak q \subset S$ is a prime and
$\Omega_{S/R} \otimes_S \kappa(\mathfrak q) = 0$, then
$R \to S$ is unramified (resp.\ G-unramified) at $\mathfrak q$.
\item If $R \to S$ is of finite type (resp.\ finite presentation),
$\mathfrak q \subset S$ is a prime lying over $\mathfrak p \subset R$ and
$(\Omega_{S \otimes_R \kappa(\mathfrak p)/\kappa(\mathfrak p)})_{\mathfrak q}
= 0$, then $R \to S$ is unramified (resp.\ G-unramified) at $\mathfrak q$.
\item If $R \to S$ is of finite type (resp.\ presentation),
$\mathfrak q \subset S$ is a prime lying over $\mathfrak p \subset R$ and
$(\Omega_{S \otimes_R \kappa(\mathfrak p)/\kappa(\mathfrak p)})
\otimes_{S \otimes_R \kappa(\mathfrak p)} \kappa(\mathfrak q) = 0$,
then $R \to S$ is unramified (resp.\ G-unramified) at $\mathfrak q$.
\item If $R \to S$ is a ring map, $g_1, \ldots, g_m \in S$ generate
the unit ideal and $R \to S_{g_j}$ is unramified (resp.\ G-unramified) for
$j = 1, \ldots, m$, then $R \to S$ is unramified (resp.\ G-unramified).
\item If $R \to S$ is a ring map which is unramified (resp.\ G-unramified)
at every prime of $S$, then $R \to S$ is unramified (resp.\ G-unramified).
\item If $R \to S$ is G-unramified, then there exists a finite type
$\mathbf{Z}$-algebra $R_0$ and a G-unramified ring map $R_0 \to S_0$
and a ring map $R_0 \to R$ such that $S = R \otimes_{R_0} S_0$.
\item If $R \to S$ is unramified, then there exists a finite type
$\mathbf{Z}$-algebra $R_0$ and an unramified ring map $R_0 \to S_0$
and a ring map $R_0 \to R$ such that $S$ is a quotient of
$R \otimes_{R_0} S_0$.
\end{enumerate}
\end{lemma}

\begin{proof}
We prove each point, in order.

\medskip\noindent
Ad (1). Follows from Lemmas \ref{lemma-differentials-base-change}
and \ref{lemma-compose-finite-type}.

\medskip\noindent
Ad (2). Follows from Lemmas \ref{lemma-exact-sequence-differentials}
and \ref{lemma-compose-finite-type}.

\medskip\noindent
Ad (3). Follows by direct computation of $\Omega_{R_f/R}$ which we omit.

\medskip\noindent
Ad (4). We have $\Omega_{(R/I)/R} = 0$, see
Lemma \ref{lemma-trivial-differential-surjective},
and the ring map $R \to R/I$
is of finite type. If $I$ is a finitely generated ideal then $R \to R/I$
is of finite presentation.

\medskip\noindent
Ad (5). See discussion following Definition \ref{definition-etale}.

\medskip\noindent
Ad (6). In this case $\Omega_{S/R}$ is a finite $S$-module (see
Lemma \ref{lemma-differentials-finitely-generated}) and hence there
exists a $g \in S$, $g \not \in \mathfrak q$ such that
$(\Omega_{S/R})_g = 0$. By Lemma \ref{lemma-differentials-localize}
this means that $\Omega_{S_g/R} = 0$ and hence $R \to S_g$ is
unramified as desired.

\medskip\noindent
Ad (7). Use Nakayama's lemma (Lemma \ref{lemma-NAK}) to see that
the condition is equivalent to the condition of (6).

\medskip\noindent
Ad (8) \& (9). These are equivalent in the same manner that (6) and (7)
are equivalent. Moreover
$\Omega_{S \otimes_R \kappa(\mathfrak p)/\kappa(\mathfrak p)} =
\Omega_{S/R} \otimes_S (S \otimes_R \kappa(\mathfrak p))$ by
Lemma \ref{lemma-differentials-base-change}.
Hence we see that (9) is equivalent to (7) since
the $\kappa(\mathfrak q)$ vector spaces in both are canonically
isomorphic.

\medskip\noindent
Ad (10). Follows from from Lemmas \ref{lemma-cover}
and \ref{lemma-differentials-localize}.

\medskip\noindent
Ad (11). Follows from (6) and (7) and the fact that the spectrum of $S$
is quasi-compact.

\medskip\noindent
Ad (12). Write $S = R[x_1, \ldots, x_n]/(g_1, \ldots, g_m)$.
As $\Omega_{S/R} = 0$ we can write
$$
\text{d}x_i = \sum h_{ij}\text{d}g_j + \sum a_{ijk}g_j\text{d}x_k
$$
in $\Omega_{R[x_1, \ldots, x_n]/R}$
for some $h_{ij}, a_{ijk} \in R[x_1, \ldots, x_n]$.
Choose a finitely generated
$\mathbf{Z}$-subalgebra $R_0 \subset R$ containing all the coefficients of the
polynomials $g_i, h_{ij}, a_{ijk}$. Set
$S_0 = R_0[x_1, \ldots, x_n]/(g_1, \ldots, g_m)$. This works.

\medskip\noindent
Ad (13). Write $S = R[x_1, \ldots, x_n]/I$.
As $\Omega_{S/R} = 0$ we can write
$$
\text{d}x_i = \sum h_{ij}\text{d}g_{ij} + \sum g'_{ik}\text{d}x_k
$$
in $\Omega_{R[x_1, \ldots, x_n]/R}$
for some $h_{ij} \in R[x_1, \ldots, x_n]$ and $g_{ij}, g'_{ik} \in I$.
Choose a finitely generated $\mathbf{Z}$-subalgebra $R_0 \subset R$
containing all the coefficients of the
polynomials $g_{ij}, h_{ij}, g'_{ik}$. Set
$S_0 = R_0[x_1, \ldots, x_n]/(g_{ij}, g'_{ik})$. This works.
\end{proof}

\begin{lemma}
\label{lemma-diagonal-unramified}
Let $R \to S$ be a ring map.
If $R \to S$ is unramified, then there exists an idempotent
$e \in S \otimes_R S$ such that $S \otimes_R S \to S$ is isomorphic
to $S \otimes_R S \to (S \otimes_R S)_e$.
\end{lemma}

\begin{proof}
Let $J = \text{Ker}(S \otimes_R S \to S)$. By assumption
$J/J^2 = 0$, see
Lemma \ref{lemma-differentials-diagonal}.
Since $S$ is of finite type over $R$ we
see that $J$ is finitely generated, namely by
$x_i \otimes 1 - 1 \otimes x_i$, where $x_i$ generate $S$ over $R$.
We win by Lemma \ref{lemma-ideal-is-squared-union-connected}.
\end{proof}

\begin{lemma}
\label{lemma-unramified-at-prime}
Let $R \to S$ be a ring map.
Let $\mathfrak q \subset S$ be
a prime lying over $\mathfrak p$ in $R$.
If $S/R$ is unramified at $\mathfrak q$ then
\begin{enumerate}
\item we have $\mathfrak p S_{\mathfrak q} = \mathfrak qS_{\mathfrak q}$
is the maximal ideal of the local ring $S_{\mathfrak q}$, and
\item the field extension $\kappa(\mathfrak p) \subset \kappa(\mathfrak q)$
is finite separable.
\end{enumerate}
\end{lemma}

\begin{proof}
We may first replace $S$ by $S_g$ for some $g \in S$, $g \not \in \mathfrak q$
and assume that $R \to S$ is unramified.
The base change $S \otimes_R \kappa(\mathfrak p)$
is unramified over $\kappa(\mathfrak p)$ by
Lemma \ref{lemma-unramified}.
By
Lemma \ref{lemma-characterize-smooth-over-field}
it is smooth hence etale over $\kappa(\mathfrak p)$.
Hence we see that
$S \otimes_R \kappa(\mathfrak p) =
(R \setminus \mathfrak p)^{-1} S/\mathfrak pS$
is a product of finite separable field extensions of
$\kappa(\mathfrak p)$ by Lemma \ref{lemma-etale-over-field}.
This implies the lemma.
\end{proof}

\begin{lemma}
\label{lemma-unramified-quasi-finite}
Let $R \to S$ be a finite type ring map.
Let $\mathfrak q$ be a prime of $S$.
If $R \to S$ is unramified at $\mathfrak q$ then
$R \to S$ is quasi-finite at $\mathfrak q$.
In particular, an unramified ring map is quasi-finite.
\end{lemma}

\begin{proof}
An unramified ring map is of finite type.
Thus it is clear that the second statement follows from the first.
To see the first statement apply the characterization of
Lemma \ref{lemma-isolated-point-fibre} part (2) using
Lemma \ref{lemma-unramified-at-prime}.
\end{proof}

\begin{lemma}
\label{lemma-characterize-unramified}
Let $R \to S$ be a ring map. Let $\mathfrak q$ be a prime of $S$
lying over a prime $\mathfrak p$ of $R$. If
\begin{enumerate}
\item $R \to S$ is of finite type,
\item $\mathfrak p S_{\mathfrak q}$ is the maximal ideal
of the local ring $S_{\mathfrak q}$, and
\item the field extension $\kappa(\mathfrak p) \subset \kappa(\mathfrak q)$
is finite separable,
\end{enumerate}
then $R \to S$ is unramified at $\mathfrak q$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-unramified} (8) it suffices to show that
$\Omega_{S \otimes_R \kappa(\mathfrak p) / \kappa(\mathfrak p)}$
is zero when localized at $\mathfrak q$. Hence we may replace $S$
by $S \otimes_R \kappa(\mathfrak p)$ and $R$ by $\kappa(\mathfrak p)$.
In other words, we may assume that $R = k$ is a field and $S$
is a finite type $k$-algebra.
In this case the hypotheses imply that
$S_{\mathfrak q} \cong \kappa(\mathfrak q)$
and hence $S = \kappa(\mathfrak q) \times S'$ (see
Lemma \ref{lemma-isolated-point}).
Hence $(\Omega_{S/k})_{\mathfrak q} = \Omega_{\kappa(\mathfrak q)/k}$
which is zero as desired.
\end{proof}

\begin{proposition}
\label{proposition-unramified-locally-standard}
Let $R \to S$ be a ring map. Let $\mathfrak q \subset S$ be a prime.
If $R \to S$ is unramified at $\mathfrak q$, then there exist
\begin{enumerate}
\item a $g \in S$, $g \not \in \mathfrak q$,
\item a standard etale ring map $R \to S'$, and
\item a surjective $R$-algebra map $S' \to S_g$.
\end{enumerate}
\end{proposition}

\begin{proof}
This proof is the ``same'' as the proof of
Proposition \ref{proposition-etale-locally-standard}.
The proof is a little roundabout and there may be ways to
shorten it.

\medskip\noindent
Step 1. By Definition \ref{definition-unramified}
there exists a $g \in S$, $g \not \in \mathfrak q$
such that $R \to S_g$ is unramified. Thus we may assume that $S$ is
unramified over $R$.

\medskip\noindent
Step 2. By Lemma \ref{lemma-unramified}
there exists an unramified ring map $R_0 \to S_0$
with $R_0$ of finite type over $\mathbf{Z}$, and a ring map
$R_0 \to R$ such that $S$ is a quotient of $R \otimes_{R_0} S_0$. Denote
$\mathfrak q_0$ the prime of $S_0$ corresponding to $\mathfrak q$.
If we show the result for $(R_0 \to S_0, \mathfrak q_0)$ then the
result follows for $(R \to S, \mathfrak q)$ by base change. Hence
we may assume that $R$ is Noetherian.

\medskip\noindent
Step 3.
Note that $R \to S$ is quasi-finite by
Lemma \ref{lemma-unramified-quasi-finite}.
By Lemma \ref{lemma-quasi-finite-open-integral-closure}
there exists a finite ring map $R \to S'$, an $R$-algebra map
$S' \to S$, an element $g' \in S'$ such that
$g' \not \in \mathfrak q$ such that $S' \to S$ induces
an isomorphism $S'_{g'} \cong S_{g'}$.
(Note that $S'$ may not unramified over $R$.)
Thus we may assume that (a) $R$ is Noetherian, (b) $R \to S$ is finite
and (c) $R \to S$ is unramified at $\mathfrak q$
(but no longer necessarily unramified at all primes).

\medskip\noindent
Step 4. Let $\mathfrak p \subset R$ be the prime corresponding
to $\mathfrak q$. Consider the fibre ring
$S \otimes_R \kappa(\mathfrak p)$. This is a finite algebra over
$\kappa(\mathfrak p)$. Hence it is Artinian
(see Lemma \ref{lemma-finite-dimensional-algebra}) and
so a finite product of local rings
$$
S \otimes_R \kappa(\mathfrak p) = \prod\nolimits_{i = 1}^n A_i
$$
see Proposition \ref{proposition-dimension-zero-ring}. One of the factors,
say $A_1$, is the local ring $S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}$
which is isomorphic to $\kappa(\mathfrak q)$,
see Lemma \ref{lemma-unramified-at-prime}. The other factors correspond to
the other primes, say $\mathfrak q_2, \ldots, \mathfrak q_n$ of
$S$ lying over $\mathfrak p$.

\medskip\noindent
Step 5. We may choose a nonzero element $\alpha \in \kappa(\mathfrak q)$ which
generates the finite separable field extension
$\kappa(\mathfrak p) \subset \kappa(\mathfrak q)$ (so even if the
field extension is trivial we do not allow $\alpha = 0$).
Note that for any $\lambda \in \kappa(\mathfrak p)^*$ the
element $\lambda \alpha$ also generates $\kappa(\mathfrak q)$
over $\kappa(\mathfrak p)$. Consider the element
$$
\overline{t} =
(\alpha, 0, \ldots, 0) \in
\prod\nolimits_{i = 1}^n A_i =
S \otimes_R \kappa(\mathfrak p).
$$
After possibly replacing $\alpha$ by $\lambda \alpha$ as above
we may assume that $\overline{t}$ is the image of $t \in S$.
Let $I \subset R[x]$ be the kernel of the $R$-algebra
map $R[x] \to S$ which maps $x$ to $t$. Set $S' = R[x]/I$,
so $S' \subset S$. Here is a diagram
$$
\xymatrix{
R[x] \ar[r] & S' \ar[r] & S \\
R \ar[u] \ar[ru] \ar[rru] & &
}
$$
By construction the primes $\mathfrak q_j$, $j \geq 2$ of $S$ all
lie over the prime $(\mathfrak p, x)$ of $R[x]$, whereas
the prime $\mathfrak q$ lies over a different prime of $R[x]$
because $\alpha \not = 0$.

\medskip\noindent
Step 6. Denote $\mathfrak q' \subset S'$ the prime of $S'$
corresponding to $\mathfrak q$. By the above $\mathfrak q$ is
the only prime of $S$ lying over $\mathfrak q'$. Thus we see that
$S_{\mathfrak q} = S_{\mathfrak q'}$, see
Lemma \ref{lemma-unique-prime-over-localize-below} (we have
going up for $S' \to S$ by Lemma \ref{lemma-integral-going-up}
since $S' \to S$ is finite as $R \to S$ is finite).
It follows that $S'_{\mathfrak q'} \to S_{\mathfrak q}$ is finite
and injective as the localization of the finite injective ring map
$S' \to S$. Consider the maps of local rings
$$
R_{\mathfrak p} \to S'_{\mathfrak q'} \to S_{\mathfrak q}
$$
The second map is finite and injective. We have
$S_{\mathfrak q}/\mathfrak pS_{\mathfrak q} = \kappa(\mathfrak q)$,
see Lemma \ref{lemma-unramified-at-prime}.
Hence a fortiori
$S_{\mathfrak q}/\mathfrak q'S_{\mathfrak q} = \kappa(\mathfrak q)$.
Since
$$
\kappa(\mathfrak p) \subset \kappa(\mathfrak q') \subset \kappa(\mathfrak q)
$$
and since $\alpha$ is in the image of $\kappa(\mathfrak q')$ in
$\kappa(\mathfrak q)$
we conclude that $\kappa(\mathfrak q') = \kappa(\mathfrak q)$.
Hence by Nakayama's Lemma \ref{lemma-NAK} applied to the
$S'_{\mathfrak q'}$-module map $S'_{\mathfrak q'} \to S_{\mathfrak q}$,
the map $S'_{\mathfrak q'} \to S_{\mathfrak q}$ is surjective.
In other words,
$S'_{\mathfrak q'} \cong S_{\mathfrak q}$.

\medskip\noindent
Step 7. By Lemma \ref{lemma-local-isomorphism} there exists a $g' \in S'$,
$g' \not \in \mathfrak q'$ such that $S'_{g'} \cong S_{g'}$.
As $R$ is Noetherian the ring $S'$ is finite over $R$ as it is an $R$-submodule
of the finite $R$-module $S$. Hence after replacing $S$ by $S'$ we may
assume that (a) $R$ is Noetherian, (b) $S$ finite over $R$, (c)
$S$ is unramified over $R$ at $\mathfrak q$, and (d) $S = R[x]/I$.

\medskip\noindent
Step 8. Consider the ring
$S \otimes_R \kappa(\mathfrak p) = \kappa(\mathfrak p)[x]/\overline{I}$
where $\overline{I} = I \cdot \kappa(\mathfrak p)[x]$ is the ideal generated
by $I$ in $\kappa(\mathfrak p)[x]$. As $\kappa(\mathfrak p)[x]$ is a PID
we know that $\overline{I} = (\overline{h})$ for some monic
$\overline{h} \in \kappa(\mathfrak p)$. After replacing $\overline{h}$
by $\lambda \cdot \overline{h}$ for some $\lambda \in \kappa(\mathfrak p)$
we may assume that $\overline{h}$ is the image of some $h \in R[x]$.
(The problem is that we do not know if we may choose $h$ monic.)
Also, as in Step 4 we know that
$S \otimes_R \kappa(\mathfrak p) = A_1 \times \ldots \times A_n$ with
$A_1 = \kappa(\mathfrak q)$ a finite separable extension of
$\kappa(\mathfrak p)$ and $A_2, \ldots, A_n$ local. This implies
that
$$
\overline{h} = \overline{h}_1 \overline{h}_2^{e_2} \ldots \overline{h}_n^{e_n}
$$
for certain pairwise coprime irreducible monic polynomials
$\overline{h}_i \in \kappa(\mathfrak p)[x]$ and certain
$e_2, \ldots, e_n \geq 1$. Here the numbering is chosen so that
$A_i = \kappa(\mathfrak p)[x]/(\overline{h}_i^{e_i})$ as
$\kappa(\mathfrak p)[x]$-algebras. Note that $\overline{h}_1$ is
the minimal polynomial of $\alpha \in \kappa(\mathfrak q)$ and hence
is a separable polynomial (its derivative is prime to itself).

\medskip\noindent
Step 9. Let $m \in I$ be a monic element; such an element exists
because the ring extension $R \to R[x]/I$ is finite hence integral.
Denote $\overline{m}$ the image in $\kappa(\mathfrak p)[x]$.
We may factor
$$
\overline{m} = \overline{k}
\overline{h}_1^{d_1} \overline{h}_2^{d_2} \ldots \overline{h}_n^{d_n}
$$
for some $d_1 \geq 1$, $d_j \geq e_j$, $j = 2, \ldots, n$ and
$\overline{k} \in \kappa(\mathfrak p)[x]$ prime to all the $\overline{h}_i$.
Set $f = m^l + h$ where $l \deg(m) > \deg(h)$, and $l \geq 2$.
Then $f$ is monic as a polynomial over $R$. Also, the image $\overline{f}$
of $f$ in $\kappa(\mathfrak p)[x]$ factors as
$$
\overline{f} =
\overline{h}_1 \overline{h}_2^{e_2} \ldots \overline{h}_n^{e_n}
+
\overline{k}^l \overline{h}_1^{ld_1} \overline{h}_2^{ld_2}
\ldots \overline{h}_n^{ld_n}
=
\overline{h}_1(\overline{h}_2^{e_2} \ldots \overline{h}_n^{e_n}
+
\overline{k}^l
\overline{h}_1^{ld_1 - 1} \overline{h}_2^{ld_2} \ldots \overline{h}_n^{ld_n})
= \overline{h}_1 \overline{w}
$$
with $\overline{w}$ a polynomial relatively prime to $\overline{h}_1$.
Set $g = f'$ (the derivative with respect to $x$).

\medskip\noindent
Step 10. The ring map $R[x] \to S = R[x]/I$ has the properties:
(1) it maps $f$ to zero, and
(2) it maps $g$ to an element of $S \setminus \mathfrak q$.
The first assertion is clear since $f$ is an element of $I$.
For the second assertion we just have to show that $g$ does
not map to zero in
$\kappa(\mathfrak q) = \kappa(\mathfrak p)[x]/(\overline{h}_1)$.
The image of $g$ in $\kappa(\mathfrak p)[x]$ is the derivative
of $\overline{f}$. Thus (2) is clear because
$$
\overline{g} =
\frac{\text{d}\overline{f}}{\text{d}x} =
\overline{w}\frac{\text{d}\overline{h}_1}{\text{d}x} +
\overline{h}_1\frac{\text{d}\overline{w}}{\text{d}x},
$$
$\overline{w}$ is prime to $\overline{h}_1$ and
$\overline{h}_1$ is separable.

\medskip\noindent
Step 11.
We conclude that $\varphi : R[x]/(f) \to S$ is a surjective ring map,
$R[x]_g/(f)$ is etale over $R$ (because it is standard etale,
see Lemma \ref{lemma-standard-etale}) and $\varphi(g) \not \in \mathfrak q$.
Thus the map $(R[x]/(f))_g \to S_{\varphi(g)}$ is the desired
surjection.
\end{proof}



\begin{lemma}
\label{lemma-etale-makes-unramfied-closed-at-prime}
Let $R \to S$ be a ring map.
Let $\mathfrak q$ be a prime of $S$ lying over $\mathfrak p \subset R$.
Assume that $R \to S$ is of finite type and unramified at $\mathfrak q$.
Then there exist
\begin{enumerate}
\item an etale ring map $R \to R'$,
\item a prime $\mathfrak p' \subset R'$ lying over $\mathfrak p$.
\item a product decomposition
$$
R' \otimes_R S = A \times B
$$
\end{enumerate}
with the following properties
\begin{enumerate}
\item $R' \to A$ is surjective, and
\item $\mathfrak p'A$ is a prime of $A$ lying over $\mathfrak p'$ and
over $\mathfrak q$.
\end{enumerate}
\end{lemma}

\begin{proof}
We may replace $(R \to S, \mathfrak p, \mathfrak q)$
with any base change $(R' \to R'\otimes_R S, \mathfrak p', \mathfrak q')$
by a etale ring map $R \to R'$ with a prime $\mathfrak p'$
lying over $\mathfrak p$, and a choice of $\mathfrak q'$ lying over
both $\mathfrak q$ and $\mathfrak p'$. Note also that given
$R \to R'$ and $\mathfrak p'$ a suitable $\mathfrak q'$ can always
be found.

\medskip\noindent
The assumption that $R \to S$ is of finite type means that we may apply
Lemma \ref{lemma-etale-makes-quasi-finite-finite-variant}. Thus we may
assume that $S = A_1 \times \ldots \times A_n \times B$, that
each $R \to A_i$ is finite with exactly one prime $\mathfrak r_i$
lying over $\mathfrak p$ such that
$\kappa(\mathfrak p) \subset \kappa(\mathfrak r_i)$ is purely inseparable
and that $R \to B$ is not quasi-finite at any prime lying over $\mathfrak p$.
Then clearly $\mathfrak q = \mathfrak r_i$ for some $i$, since
an unramified morphism is quasi-finite
(see Lemma \ref{lemma-unramified-quasi-finite}).
Say $\mathfrak q = \mathfrak r_1$.
By Lemma \ref{lemma-unramified-at-prime} we see that
$\kappa(\mathfrak p) \subset \kappa(\mathfrak r_1)$
is separable hence the trivial field extension, and that
$\mathfrak p(A_1)_{\mathfrak r_1}$ is the maximal ideal.
Also, by Lemma \ref{lemma-unique-prime-over-localize-below}
(which applies to $R \to A_1$ because a finite ring map satisfies going up by
Lemma \ref{lemma-integral-going-up})
we have $(A_1)_{\mathfrak r_1} = (A_1)_{\mathfrak p}$.
It follows from Nakayama's Lemma \ref{lemma-NAK}
that the map of local rings
$R_{\mathfrak p} \to (A_1)_{\mathfrak p} = (A_1)_{\mathfrak r_1}$
is surjective. Since $A_1$ is finite over $R$ we see that there
exists a $f \in R$, $f \not \in \mathfrak p$ such that
$R_f \to (A_1)_f$ is surjective. After replacing $R$ by $R_f$ we win.
\end{proof}

\begin{lemma}
\label{lemma-etale-makes-unramfied-closed}
Let $R \to S$ be a ring map.
Let $\mathfrak p$ be a prime of $R$.
If $R \to S$ is unramified then there exist
\begin{enumerate}
\item an etale ring map $R \to R'$,
\item a prime $\mathfrak p' \subset R'$ lying over $\mathfrak p$.
\item a product decomposition
$$
R' \otimes_R S = A_1 \times \ldots \times A_n \times B
$$
\end{enumerate}
with the following properties
\begin{enumerate}
\item $R' \to A_i$ is surjective,
\item $\mathfrak p'A_i$ is a prime of $A_i$ lying over $\mathfrak p'$, and
\item there is no prime of $B$ lying over $\mathfrak p'$.
\end{enumerate}
\end{lemma}

\begin{proof}
We may apply Lemma \ref{lemma-etale-makes-quasi-finite-finite-variant}.
Thus, after an etale base change,
we may assume that $S = A_1 \times \ldots \times A_n \times B$,
that each $R \to A_i$ is finite with exactly one prime $\mathfrak r_i$
lying over $\mathfrak p$ such that
$\kappa(\mathfrak p) \subset \kappa(\mathfrak r_i)$ is purely inseparable,
and that $R \to B$ is not quasi-finite at any prime lying over $\mathfrak p$.
Since $R \to S$ is quasi-finite (see
Lemma \ref{lemma-unramified-quasi-finite})
we see there is no prime of $B$ lying over $\mathfrak p$.
By Lemma \ref{lemma-unramified-at-prime} we see that
$\kappa(\mathfrak p) \subset \kappa(\mathfrak r_i)$
is separable hence the trivial field extension, and that
$\mathfrak p(A_i)_{\mathfrak r_i}$ is the maximal ideal.
Also, by Lemma \ref{lemma-unique-prime-over-localize-below}
(which applies to $R \to A_i$ because a finite ring map satisfies going up by
Lemma \ref{lemma-integral-going-up})
we have $(A_i)_{\mathfrak r_i} = (A_i)_{\mathfrak p}$.
It follows from Nakayama's Lemma \ref{lemma-NAK}
that the map of local rings
$R_{\mathfrak p} \to (A_i)_{\mathfrak p} = (A_i)_{\mathfrak r_i}$
is surjective. Since $A_i$ is finite over $R$ we see that there
exists a $f \in R$, $f \not \in \mathfrak p$ such that
$R_f \to (A_i)_f$ is surjective. After replacing $R$ by $R_f$ we win.
\end{proof}










\section{Henselian local rings}
\label{section-henselian}

\noindent
In this section we discuss a bit the notion of a henselian local ring.
Let $(R, \mathfrak m, \kappa)$ be a local ring.
For $a \in R$ we denote $\overline{a}$ the image of $a$ in $\kappa$.
For a polynomial $f \in R[T]$ we often denote $\overline{f}$
the image of $f$ in $\kappa[T]$.
Given a polynomial $f \in R[T]$ we denote $f'$ the derivative
of $f$ with respect to $T$. Note that $\overline{f}' = \overline{f'}$.

\begin{definition}
\label{definition-henselian}
Let $(R, \mathfrak m, \kappa)$ be a local ring.
\begin{enumerate}
\item We say $R$ is {\it henselian} if for every monic $f \in R[T]$ and
every root $a_0 \in \kappa$ of $\overline{f}$ such that
$\overline{f'}(a_0) \not = 0$
there exists an $a \in R$ such that $f(a) = 0$ and
$a_0 = \overline{a}$.
\item We say $R$ is {\it strictly henselian} if $R$ is henselian
and its residue field is separably algebraically closed.
\end{enumerate}
\end{definition}

\noindent
Note that the condition $\overline{f'}(a_0) \not = 0$ is
equivalent to the condition that $a_0$ is a simple root
of the polynomial $\overline{f}$. Here is the characterization of
henselian local rings.

\begin{lemma}
\label{lemma-characterize-henselian}
Let $(R, \mathfrak m, \kappa)$ be a local ring.
The following are equivalent
\begin{enumerate}
\item $R$ is henselian,
\item for every $f \in R[T]$ and every root $a_0 \in \kappa$
of $\overline{f}$ such that $\overline{f'}(a_0) \not = 0$
there exists an $a \in R$ such that $f(a) = 0$ and
$a_0 = \overline{a}$,
\item for any monic $f \in R[T]$ and any factorization
$\overline{f} = g_0 h_0$ with $\gcd(g_0, h_0) = 1$ there
exists a factorization $f = gh$ in $R[T]$ such that
$g_0 = \overline{g}$ and $h_0 = \overline{h}$,
\item for any monic $f \in R[T]$ and any factorization
$\overline{f} = g_0 h_0$ with $\gcd(g_0, h_0) = 1$ there
exists a factorization $f = gh$ in $R[T]$ such that
$g_0 = \overline{g}$ and $h_0 = \overline{h}$ and moreover
$\deg_T(g) = \deg_T(g_0)$,
\item for any $f \in R[T]$ and any factorization
$\overline{f} = g_0 h_0$ with $\gcd(g_0, h_0) = 1$ there
exists a factorization $f = gh$ in $R[T]$ such that
$g_0 = \overline{g}$ and $h_0 = \overline{h}$,
\item for any $f \in R[T]$ and any factorization
$\overline{f} = g_0 h_0$ with $\gcd(g_0, h_0) = 1$ there
exists a factorization $f = gh$ in $R[T]$ such that
$g_0 = \overline{g}$ and $h_0 = \overline{h}$ and
moreover $\deg_T(g) = \deg_T(g_0)$,
\item for any etale ring map $R \to S$ and prime $\mathfrak q$ of $S$
lying over $\mathfrak m$ with $\kappa = \kappa(\mathfrak q)$
there exists a section $\tau : S \to R$ of $R \to S$,
\item for any etale ring map $R \to S$ and prime $\mathfrak q$ of $S$
lying over $\mathfrak m$ with $\kappa = \kappa(\mathfrak q)$
there exists a section $\tau : S \to R$ of $R \to S$ with
$\mathfrak q = \tau^{-1}(\mathfrak m)$,
\item any finite $R$-algebra is a product of local rings,
\item any finite $R$-algebra is a finite product of local rings,
\item any finite type $R$-algebra $S$ can be written as
$A \times B$ with $R \to A$ finite
and $R \to B$ not quasi-finite at any prime lying over $\mathfrak m$,
\item any finite type $R$-algebra $S$ can be written as
$A \times B$ with $R \to A$ finite
such that each irreducible component of $\text{Spec}(B \otimes_R \kappa)$
has dimension $\geq 1$, and
\item any quasi-finite $R$-algebra $S$ can be written as
$S = A \times B$ with $R \to A$ finite such that $B \otimes_R \kappa = 0$.
\end{enumerate}
\end{lemma}

\begin{proof}
Here is a list of the easier implications:
\begin{enumerate}
\item[2$\Rightarrow$1] because in (2) we consider all polynomials and
in (1) only monic ones,
\item[5$\Rightarrow$3] because in (5) we consider all polynomials and
in (3) only monic ones,
\item[6$\Rightarrow$4] because in (6) we consider all polynomials and
in (4) only monic ones,
\item[4$\Rightarrow$3] is obvious,
\item[6$\Rightarrow$5] is obvious,
\item[8$\Rightarrow$7] is obvious,
\item[10$\Rightarrow$9] is obvious,
\item[11$\Leftrightarrow$12] by definition of being quasi-finite at a prime,
\item[11$\Rightarrow$13] by definition of being quasi-finite,
\end{enumerate}

\medskip\noindent
Proof of 1$\Rightarrow$8. Assume (1).
Let $R \to S$ be etale, and let $\mathfrak q \subset S$
be a prime ideal such that $\kappa(\mathfrak q) \cong \kappa$. By
Proposition \ref{proposition-etale-locally-standard}
we can find a $g \in S$, $g \not \in \mathfrak q$ such that
$R \to S_g$ is standard etale. After replacing $S$ by $S_g$ we may assume
that $S = R[t]_g/(f)$ is standard etale. Since the prime $\mathfrak q$
has residue field $\kappa$ it corresponds to a root $a_0$ of
$\overline{f}$ which is not a root of $\overline{g}$. By definition
of a standard etale algebra this also means that $\overline{f}(a_0) \not = 0$.
Since also $f$ is monic by definition of a standard etale algebra again we
may use that $R$ is henselian to conclude that there exists an $a \in R$
with $a_0 = \overline{a}$ such that $f(a) = 0$. This implies that
$g(a)$ is a unit of $R$ and we obtain the desired map
$\tau : S = R[t]_g/(f) \to R$ by the rule $t \mapsto a$. By construction
$\tau^{-1}(\mathfrak q) = \mathfrak m$. This proves (8) holds.

\medskip\noindent
Proof of 7$\Rightarrow$8. (This is really unimportant and should be
skipped.) Assume (7) holds and assume $R \to S$ is etale.
Let $\mathfrak q_1, \ldots, \mathfrak q_r$ be
the other primes of $S$ lying over $\mathfrak m$.
Then we can find a $g \in S$, $g \not \in \mathfrak q$ and
$g \in \mathfrak q_i$ for $i = 1, \ldots, r$, see
Lemma \ref{lemma-silly}. Apply (7) to the etale ring map
$R \to S_g$ and the prime $\mathfrak qS_g$. This gives a section
$\tau_g : S_g \to R$ such that the composition $\tau : S \to S_g \to R$
has the property $\tau^{-1}(\mathfrak q) = \mathfrak m$.
Minor details omitted.

\medskip\noindent
Proof of 8$\Rightarrow$11. Assume (8) and let $R \to S$ be a finite type
ring map. Apply
Lemma \ref{lemma-etale-makes-quasi-finite-finite}.
We find an etale ring map $R \to R'$ and a prime $\mathfrak m' \subset R'$
lying over $\mathfrak m$ with $\kappa = \kappa(\mathfrak m')$
such that $R' \otimes_R S = A' \times B'$ with $A'$ finite over $R'$
and $B'$ not quasi finite over $R'$ at any prime lying over $\mathfrak m'$.
Apply (6) to get a section $\tau : R' \to R$ with
$\mathfrak m = \tau^{-1}(\mathfrak m')$. Then use that
$$
S = (S \otimes_R R') \otimes_{R', \tau} R
= (A' \times B') \otimes_{R', \tau} R
= (A' \otimes_{R', \tau} R)  \times  (B' \otimes_{R', \tau} R)
$$
which gives a decomposition as in (11).

\medskip\noindent
Proof of 8$\Rightarrow$10. Assume (8) and let $R \to S$ be a finite
ring map. Apply
Lemma \ref{lemma-etale-makes-quasi-finite-finite}.
We find an etale ring map $R \to R'$ and a prime $\mathfrak m' \subset R'$
lying over $\mathfrak m$ with $\kappa = \kappa(\mathfrak m')$
such that $R' \otimes_R S = A'_1 \times \ldots \times A'_n \times B'$
with $A'_i$ finite over $R'$ having exactly one prime over $\mathfrak m'$
and $B'$ not quasi-finite over $R'$ at any prime lying over $\mathfrak m'$.
Apply (8) to get a section $\tau : R' \to R$ with
$\mathfrak m = \tau^{-1}(\mathfrak m')$. Then we obtain
\begin{align*}
S & = (S \otimes_R R') \otimes_{R', \tau} R \\
& = (A'_1 \times \ldots \times A'_n \times B') \otimes_{R', \tau} R \\
& = (A'_1 \otimes_{R', \tau} R)  \times
\ldots \times (A'_1 \otimes_{R', \tau} R) \times
(B' \otimes_{R', \tau} R) \\
& = A_1 \times \ldots \times A_n \times B
\end{align*}
The factor $B$ is finite over $R$ but $R \to B$
is not quasi-finite at any prime lying over $\mathfrak m$. Hence
$B = 0$. The factors $A_i$ are finite $R$-algebras having exactly
one prime lying over $\mathfrak m$, hence they are local rings.
This proves that $S$ is a finite product of local rings.

\medskip\noindent
Proof of 9$\Rightarrow$10. This holds because if $S$ is finite over the local
ring $R$, then it has at most finitely many maximal ideals. Namely, by
going up for $R \to S$ the maximal ideals of $S$ all lie over $\mathfrak m$,
and $S/\mathfrak mS$ is Artinian hence has finitely many primes.

\medskip\noindent
Proof of 10$\Rightarrow$1. Assume (10). Let $f \in R[T]$ be a monic
polynomial and $a_0 \in \kappa$ a simple root of $\overline{f}$.
Then $S = R[T]/(f)$ is a finite $R$-algebra. Applying (10)
we get $S = A_1 \times \ldots \times A_r$ is a finite product of
local $R$-algebras. In particular we see that
$S/\mathfrak mS = \prod A_i/\mathfrak mA_i$ is the decomposition
of $\kappa[T]/(\overline{f})$ as a product of local rings.
This means that one of the factors, say $A_1/\mathfrak mA_1$
is the quotient $\kappa[T]/(\overline{f}) \to \kappa[T]/(T - a_0)$.
Since $A_1$ is a summand of the finite free $R$-module $S$ it
is a finite free $R$-module itself. As $A_1/\mathfrak mA_1$ is a
$\kappa$-vector space of dimension 1 we see that $A_1 \cong R$ as an
$R$-module. Clearly this means that $R \to A_1$ is an isomorphism.
Let $a \in R$ be the image of $T$ under the map
$R[T] \to S \to A_1 \to R$. Then $f(a) = 0$ and $\overline{a} = a_0$
as desired.

\medskip\noindent
Proof of 13$\Rightarrow$1. Assume (13). Let $f \in R[T]$ be a monic
polynomial and $a_0 \in \kappa$ a simple root of $\overline{f}$.
Then $S_1 = R[T]/(f)$ is a finite $R$-algebra. Let $g \in R[T]$
be any element such that $\overline{g} = \overline{f}/(T - a_0)$.
Then $S = (S_1)_g$ is a quasi-finite $R$-algebra such that
$S \otimes_R \kappa \cong \kappa[T]_{\overline{g}}/(\overline{f})
\cong \kappa[T]/(T - a_0) \cong \kappa$.
Applying (13) to $S$ we get $S = A \times B$ with $A$ finite over $R$ and
$B \otimes_R \kappa = 0$. In particular we see that
$\kappa \cong S/\mathfrak mS = A/\mathfrak mA$.
Since $A$ is a summand of the flat $R$-algebra $S$ we see
that it is finite flat, hence free over $R$.
As $A/\mathfrak mA$ is a
$\kappa$-vector space of dimension 1 we see that $A \cong R$ as an
$R$-module. Clearly this means that $R \to A$ is an isomorphism.
Let $a \in R$ be the image of $T$ under the map
$R[T] \to S \to A \to R$. Then $f(a) = 0$ and $\overline{a} = a_0$
as desired.

\medskip\noindent
Proof of 8$\Rightarrow$2. Assume (8). Let $f \in R[T]$ be any
polynomial and let $a_0 \in \kappa$ be a simple root. Then
the algebra $S = R[T]_{f'}/(f)$ is etale over $R$.
Let $\mathfrak q \subset S$ be the prime
generated by $\mathfrak m$ and $T - b$ where $b \in R$ is any
element such that $\overline{b} = a_0$. Apply (8) to $S$ and $\mathfrak q$
to get $\tau : S \to R$.
Then the image $\tau(T) = a \in R$ works in (2).

\medskip\noindent
At this point we see that (1), (2), (7), (8), (9), (10), (11), (12), (13) are
all equivalent. The weakest assertion of (3), (4), (5) and (6)
is (3) and the strongest is (6). Hence we still have to prove that
(3) implies (1) and (1) implies (6).

\medskip\noindent
Proof of 3$\Rightarrow$1. Assume (3). Let $f \in R[T]$ be monic and
let $a_0 \in \kappa$ be a simple root of $\overline{f}$. This gives
a factorization $\overline{f} = (T - a_0)h_0$ with $h_0(a_0) \not = 0$,
so $\gcd(T - a_0, h_0) = 1$. Apply (3) to get a factorization
$f = gh$ with $\overline{g} = T - a_0$ and $\overline{h} = h_0$.
Set $S = R[T]/(f)$ which is a finite free $R$-algebra. We will write
$g$, $h$ also for the images of $g$ and $h$ in $S$. Then
$gS + hS = S$ by
Nakayama's Lemma \ref{lemma-NAK}
as the equality holds modulo $\mathfrak m$. Since $gh = f = 0$ in $S$
this also implies that $gS \cap hS = 0$. Hence by the Chinese Remainder
theorem we obtain $S = S/(g) \times S/(h)$. This implies that
$A = S/(g)$ is a summand of a finite free $R$-module, hence finite
free. Moreover, the rank of $A$ is $1$ as
$A/\mathfrak mA = \kappa[T]/(T - a_0)$. Thus the map $R \to A$
is an isomorphism. Setting $a \in R$ equal to the image of $T$
under the maps $R[T] \to S \to A \to R$ gives an element of $R$
with $f(a) = 0$ and $\overline{a} = a_0$.

\medskip\noindent
Proof of 1$\Rightarrow$6. Assume (1) or equivalently all of
(1), (2), (7), (8), (9), (10), (11), (12), (13).
Let $f \in R[T]$ be a polynomial.
Suppose that $\overline{f} = g_0h_0$ is a factorization with
$\gcd(g_0, h_0) = 1$. We may and do assume that $g_0$ is monic.
Consider $S = R[T]/(f)$. Because we
have the factorization we see that the coefficients of
$f$ generate the unit ideal in $R$.
This implies that $S$ has finite fibres over $R$, hence is
quasi-finite over $R$. It also implies that $S$ is flat over $R$ by
Lemma \ref{lemma-grothendieck}.
Combining (13) and (8) we may write
$S = A_1 \times \ldots \times A_n \times B$
where each $A_i$ is local and finite over $R$, and
$B \otimes_R \kappa = 0$. After reordering the factors $A_1, \ldots, A_n$
we may assume that
$$
\kappa[T]/(g_0) =
A_1/\mathfrak m A_1 \times \ldots \times A_r/\mathfrak mA_r,
\ \kappa[T]/(h_0) =
A_{r + 1}/\mathfrak mA_{r + 1} \times \ldots \times A_n/\mathfrak mA_n
$$
as quotients of $\kappa[T]$. OK, and now consider the finite flat
$R$-algebra $A = A_1 \times \ldots \times A_r$. being finite and
flat it is free as an $R$-module, and from the above we see that
its rank is $\deg_T(g_0)$. Let $g \in R[T]$ be the characteristic polynomial
of the $R$-linear operator $T : A \to A$. Then $g$ is a monic polynomial
of degree $\deg_T(g) = \deg_T(g_0)$ and moreover $\overline{g} = g_0$.
By Cayley-Hamilton
(Lemma \ref{lemma-charpoly})
we see that $g(T_A) = 0$ where $T_A$ indicates
the image of $T$ in $A$. Hence we obtain a well defined surjective map
$R[T]/(g) \to A$ which is an isomorphism by
Nakayana's Lemma \ref{lemma-NAK}. The map $R[T] \to A$ factors
through $R[T]/(f)$ by construction hence we may write $f = gh$ for
some $h$. This finishes the proof.
\end{proof}

\begin{lemma}
\label{lemma-finite-over-henselian}
Let $(R, \mathfrak m, \kappa)$ be a henselian local ring.
\begin{enumerate}
\item If $R \subset S$ is a finite ring extension then $S$ is
a finite product of henselian local rings.
\item If $R \subset S$ is a finite local homomorphism of local rings,
then $S$ is a henselian local ring.
\item If $R \to S$ is a finite type ring map, and $\mathfrak q$ is
a prime of $S$ lying over $\mathfrak m$
at which $R \to S$ is quasi-finite, then
$S_{\mathfrak q}$ is henselian.
\item If $R \to S$ is quasi-finite then $S_{\mathfrak q}$ is henselian
for every prime $\mathfrak q$ lying over $\mathfrak m$.
\end{enumerate}
\end{lemma}

\begin{proof}
Part (2) implies part (1) since $S$ as in part (1) is a finite product
of its localizations at the primes lying over $\mathfrak m$.
Part (2) follows from 
Lemma \ref{lemma-characterize-henselian} part (10)
since any finite $S$-algebra is also a finite $R$-algebra.
If $R \to S$ and $\mathfrak q$ are as in (3), then
$S_{\mathfrak q}$ is a local ring of a finite $R$-algebra by
Lemma \ref{lemma-characterize-henselian} part (11).
Hence (3) follows from (1).
Part (4) follows from part (3).
\end{proof}

\begin{lemma}
\label{lemma-colimit-henselian}
A filtered colimit of henselian local rings along local ring maps
is henselian.
\end{lemma}

\begin{proof}
Categories, Lemma \ref{categories-lemma-directed-category-system}
says that this is really just a question about a colimit of
henselian local rings over a directed partially ordered set.
Let $(R_i, \varphi_{ii'})$ be such a system with each $\varphi_{ii'}$
local. Then $R = \text{colim}_i\ R_i$ is local, and
its residue field $\kappa$ is $\text{colim}\ \kappa_i$
(argument omitted).
Suppose that $f \in R[T]$ is monic and that $a_0 \in \kappa$ is
a simple root of $\overline{f}$. Then for some large enough $i$
there exists an $f_i \in R_i[T]$ mapping to $f$ and an
$a_{0, i} \in \kappa_i$ mapping to $a_0$. Since
$\overline{f_i}(a_{0, i}) \in \kappa_i$,
resp.\ $\overline{f_i'}(a_{0, i}) \in \kappa_i$ maps to
$0 = \overline{f}(a_0) \in \kappa$,
resp.\ $0 \not = \overline{f'}(a_0) \in \kappa$
we conclude that $a_{0, i}$ is a simple root of $\overline{f_i}$.
As $R_i$ is henselian we can find $a_i \in R_i$ such that
$f_i(a_i) = 0$ and $a_{0, i} = \overline{a_i}$.
Then the image $a \in R$ of $a_i$ is the desired solution.
Thus $R$ is henselian.
\end{proof}

\begin{lemma}
\label{lemma-mop-up}
Let $(R, \mathfrak m, \kappa)$ be a henselian local ring.
Any finite type $R$-algebra $S$ can be written as
$S = A_1 \times \ldots \times A_n \times B$ with $A_i$ local
and finite over $R$ and $R \to B$ not quasi-finite at any
prime of $B$ lying over $\mathfrak m$.
\end{lemma}

\begin{proof}
This is a combination of parts (11) and (10) of
Lemma \ref{lemma-characterize-henselian}.
\end{proof}

\begin{lemma}
\label{lemma-henselian-cat-finite-etale}
Let $(R, \mathfrak m, \kappa)$ be a henselian local ring.
The category of finite etale ring extensions $R \to S$ is
equivalent to the category of finite etale algebras
$\kappa \to \overline{S}$ via the functor $S \mapsto S/\mathfrak mS$.
\end{lemma}

\begin{proof}
Denote $\mathcal{C} \to \mathcal{D}$ the functor of categories
of the statement.
Suppose that $R \to S$ is finite etale. Then we may write
$$
S = A_1 \times \ldots \times A_n
$$
with $A_i$ local and finite etale over $S$, use either
Lemma \ref{lemma-mop-up}
or
Lemma \ref{lemma-characterize-henselian} part (10).
In particular $A_i/\mathfrak mA_i$ is a finite separable field
extension of $\kappa$, see
Lemma \ref{lemma-etale-at-prime}.
Thus we see that every object of $\mathcal{C}$ and
$\mathcal{D}$ decomposes canonically into irreducible pieces
which correspond via the given functor.
Next, suppose that $S_1$, $S_2$ are finite etale over $R$ such that
$\kappa_1 = S_1/\mathfrak mS_1$ and $\kappa_2 = S_2/\mathfrak mS_2$
are fields (finite separable over $\kappa$). Then $S_1 \otimes_R S_2$
is finite etale over $R$ and we may write
$$
S_1 \otimes_R S_2 = A_1 \times \ldots \times A_n
$$
as before. Then we see that $\text{Hom}_R(S_1, S_2)$ is identified
with the set of indices $i \in \{1, \ldots, n\}$ such that
$S_2 \to A_i$ is an isomorphism. To see this use that given any $R$-algebra
map $\varphi : S_1 \to S_2$ the map
$\varphi \times 1 : S_1 \otimes_R S_2 \to S_2$
is surjective, and hence is equal to projection onto one of the factors $A_i$.
But in exectly the same way we see that
$\text{Hom}_\kappa(\kappa_1, \kappa_2)$ is identified with
the set of indices $i \in \{1, \ldots, n\}$ such that
$\kappa_2 \to A_i/\mathfrak mA_i$ is an isomorphism.
By the discussion above these sets of indices match, and we conclude
that our functor is fully faithful.
Finally, let $\kappa \subset \kappa'$ be a finite
separable field extension. By
Lemma \ref{lemma-make-etale-map-prescribed-residue-field}
there exists an etale ring map $R \to S$ and a prime $\mathfrak q$
of $S$ lying over $\mathfrak m$ such that $\kappa \subset \kappa(\mathfrak q)$
is isomorphic to the given extension. By part (1)
we may write $S = A_1 \times \ldots \times A_n \times B$.
Since $R \to S$ is quasi-finite we see that there exists no
prime of $B$ over $\mathfrak m$. Hence $S_{\mathfrak q}$ is
equal to $A_i$ for some $i$. Hence $R \to A_i$ is finite etale
and produces the given residue field extension. Thus the functor
is essentially surjective and we win.
\end{proof}

\begin{lemma}
\label{lemma-unramified-over-strictly-henselian}
Let $(R, \mathfrak m, \kappa)$ be a strictly henselian local ring.
Let $R \to S$ be an unramified ring map. Then
$$
S = A_1 \times \ldots \times A_n \times B
$$
with each $R \to A_i$ surjective and no prime of $B$ lying
over $\mathfrak m$.
\end{lemma}

\begin{proof}
First write $S = A_1 \times \ldots \times A_n \times B$ as in
Lemma \ref{lemma-mop-up}.
Now we see that $R \to A_i$ is finite unramified and $A_i$ local.
Hence the maximal ideal of $A_i$ is $\mathfrak mA_i$ and its
residue field $A_i / \mathfrak m A_i$ is a finite
separable extension of $\kappa$, see
Lemma \ref{lemma-unramified-at-prime}.
However, the condition that $R$ is strictly henselian means that
$\kappa$ is separably algebraically closed, so
$\kappa = A_i / \mathfrak m A_i$. By
Nakayama's Lemma \ref{lemma-NAK}
we conclude that $R \to A_i$ is surjective as desired.
\end{proof}

\begin{lemma}
\label{lemma-complete-henselian}
Let $(R, \mathfrak m, \kappa)$ be a complete local ring, see
Definition \ref{definition-complete-local-ring}.
Then $R$ is henselian.
\end{lemma}

\begin{proof}
Let $f \in R[T]$ be monic.
Denote $f_n \in R/\mathfrak m^{n + 1}[T]$ the image.
Denote $f'_n$ the derivative of $f_n$ with respect to $T$.
Let $a_0 \in \kappa$ be a simple root of $f_0$. We lift this
to a solution of $f$ over $R$ inductively as follows:
Suppose given $a_n \in R/\mathfrak m^{n + 1}$ such that
$a_n \bmod \mathfrak m = a_0$ and $f_n(a_n) = 0$. Pick any
element $b \in R/\mathfrak m^{n + 2}$ such that
$a_n = b \bmod \mathfrak m^{n + 1}$. Then
$f_{n + 1}(b) \in \mathfrak m^{n + 1}/\mathfrak m^{n + 2}$.
Set
$$
a_{n + 1} = b - f_{n + 1}(b)/f'_{n + 1}(b)
$$
(Newton's method). This makes sense as $f'_{n + 1}(b) \in R_{n + 1}$
is invertible by the condition on $a_0$. Then we compute
$f_{n + 1}(a_{n + 1}) = f_{n + 1}(b) - f_{n + 1}(b) = 0$
in $R/\mathfrak m^{n + 2}$. Since the system of elements
$a_n \in R/\mathfrak m^{n + 1}$ so constructed is compatible
we get an element
$a \in \text{lim}\ R/\mathfrak m = R$ (here we use that $R$ is complete).
Moreover, $f(a) = 0$ since it maps to zero in each $R/\mathfrak m^n$.
Finally $\overline{a} = a_0$ and we win.
\end{proof}

\begin{lemma}
\label{lemma-henselization}
Let $(R, \mathfrak m, \kappa)$ be a local ring. There exists a canonical
local ring map $R \to R^h$ with the following properties
\begin{enumerate}
\item $R^h$ is henselian,
\item $R^h$ is a filtered colimit of etale $R$-algebras,
\item $\mathfrak m R^h$ is the
maximal ideal of $R^h$, and
\item $\kappa = R^h/\mathfrak m R^h$.
\end{enumerate}
\end{lemma}

\begin{proof}
Consider the cateory of pairs $(S, \mathfrak q)$ where $R \to S$ is an
etale ring map, and $\mathfrak q$ is a prime of $S$ lying over
$\mathfrak m$ with $\kappa = \kappa(\mathfrak q)$. A morphism of pairs
$(S, \mathfrak q) \to (S', \mathfrak q')$ is given by an $R$-algebra
map $\varphi : S \to S'$ such that $\varphi^{-1}(\mathfrak q') = \mathfrak q$.
We set
$$
R^h = \text{colim}_{(S, \mathfrak q)}\ S.
$$
This clearly implies that $R^h$ is canonical, since no choices were
made in this construction. Moreover, property (2) is clear.

\medskip\noindent
Let us show that the category of pairs is filtered, see
Categories, Definition \ref{categories-definition-directed}.
The category contains the pair $(R, \mathfrak m)$ and hence is not empty,
which proves part (1) of
Categories, Definition \ref{categories-definition-directed}.
Note that for any pair $(S, \mathfrak q)$ the prime ideal $\mathfrak q$
is maximal, for example since
$\kappa \to S/\mathfrak q \subset \kappa(\mathfrak q)$ are isomorphisms.
Suppose that $(S, \mathfrak q)$ and $(S', \mathfrak q')$ are two objects. Set
$S'' = S \otimes_R S'$ and $\mathfrak q'' = \mathfrak qS'' + \mathfrak q'S''$.
Then $S''/\mathfrak q'' = S/\mathfrak q \otimes_R S'/\mathfrak q' = \kappa$
by what we said above. Moreover, $R \to S''$ is etale by
Lemma \ref{lemma-etale}.
This proves part (2) of
Categories, Definition \ref{categories-definition-directed}.
Next, suppose that
$\varphi, \psi : (S, \mathfrak q) \to (S', \mathfrak q')$
are two morphisms of pairs. Consider
$$
S'' = (S' \otimes_{\varphi, S, \psi} S')
\otimes_{S' \otimes_R S'} S'
$$
with prime ideal
$$
\mathfrak q'' =
(\mathfrak q' \otimes S' + S' \otimes \mathfrak q') \otimes S'
+
(S' \otimes_{\varphi, S, \psi} S') \otimes \mathfrak q'
$$
Arguing as above (base change of etale maps is etale, composition of
etale maps is etale) we see that $S''$ is etale over $R$. Moreover,
the canonical map $S' \to S''$ (using the right most factor for example)
equalizes $\varphi$ and $\psi$. This proves part (3) of
Categories, Definition \ref{categories-definition-directed}.
Hence we conclude that $R^h$ consists of triples $(S, \mathfrak q, f)$
with $f \in S$, and two such triples
$(S, \mathfrak q, f)$, $(S', \mathfrak q', f')$
define the same element of $R^h$ if and only if there exists
a pair $(S'', \mathfrak q'')$ and morphisms of pairs
$\varphi : (S, \mathfrak q) \to (S'', \mathfrak q'')$
and
$\varphi' : (S', \mathfrak q') \to (S'', \mathfrak q'')$
such that $\varphi(f) = \varphi'(f')$.

\medskip\noindent
Suppose that $x \in R^h$.
Represent $x$ by a triple $(S, \mathfrak q, f)$.
Let $\mathfrak q_1, \ldots, \mathfrak q_r$ be
the other primes of $S$ lying over $\mathfrak m$.
Then we can find a $g \in S$, $g \not \in \mathfrak q$ and
$g \in \mathfrak q_i$ for $i = 1, \ldots, r$, see
Lemma \ref{lemma-silly}. Consider the morphism of
pairs $(S, \mathfrak q) \to (S_g, \mathfrak qS_g)$.
In this way we see that we may always assume that $x$
is given by a triple $(S, \mathfrak q, f)$ where
$\mathfrak q$ is the only prime of $S$ lying over $\mathfrak m$,
i.e., $\sqrt{\mathfrak mS} = \mathfrak q$. But since
$R \to S$ is etale, we have
$\mathfrak mS_{\mathfrak q} = \mathfrak qS_{\mathfrak q}$, see
Lemma \ref{lemma-etale-at-prime}.
Hence we actually get that $\mathfrak mS = \mathfrak q$.

\medskip\noindent
Suppose that $x \not \in \mathfrak mR^h$.
Represent $x$ by a triple $(S, \mathfrak q, f)$ with
$\mathfrak mS = \mathfrak q$.
Then $f \not \in \mathfrak mS$, i.e., $f \not \in \mathfrak q$.
Hence $(S, \mathfrak q) \to (S_f, \mathfrak qS_f)$ is a morphism
of pairs such that the image of $f$ becomes invertible.
Hence $x$ is invertible with inverse represented by the triple
$(S_f, \mathfrak qS_f, 1/f)$. We conclude that $R^h$ is a local
ring with maximal ideal $\mathfrak mR^h$. The residue field is
$\kappa$ since we can define $R^h/\mathfrak mR^h \to \kappa$
by mapping a triple $(S, \mathfrak q, f)$ to the residue
class of $f$ module $\mathfrak q$.

\medskip\noindent
We still have to show that $R^h$ is henselian.
Namely, suppose that $P \in R^h[T]$ is a monic
polynomial and $a_0 \in \kappa$ is a simple root of
the reduction $\overline{P} \in \kappa[T]$.
Then we can find a pair $(S, \mathfrak q)$ such that
$P$ is the image of a monic polynomial $Q \in S[T]$.
Since $S \to R^h$ induces an isomorphism of residue
fields we see that $S' = S[T]/(Q)$ has a prime ideal
$\mathfrak q' = (\mathfrak q, T - a_0)$ at which
$S \to S'$ is standard etale. Moreover, $\kappa = \kappa(\mathfrak q')$.
Pick $g \in S'$, $g \not \in \mathfrak q'$ such that
$S'' = S'_g$ is etale over $S$. Then
$(S, \mathfrak q) \to (S'', \mathfrak q'S'')$ is a morphism
of pairs. Now that triple $(S'', \mathfrak q'S'', \text{class of }T)$
determines an element $a \in R^h$ with the properties $P(a) = 0$,
and $\overline{a} = a_0$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-strict-henselization}
Let $(R, \mathfrak m, \kappa)$ be a local ring.
Let $\kappa \subset \kappa^{sep}$ be a separable algebraic closure.
There exists a canonical commutative diagram
$$
\xymatrix{
\kappa \ar[r] & \kappa \ar[r] & \kappa^{sep} \\
R \ar[r] \ar[u] & R^h \ar[r] \ar[u] & R^{sh} \ar[u]
}
$$
with the following properties
\begin{enumerate}
\item the map $R^h \to R^{sh}$ is local
\item $R^{sh}$ is strictly henselian,
\item $R^{sh}$ is a filtered colimit of etale $R$-algebras,
\item $\mathfrak m R^{sh}$ is the
maximal ideal of $R^{sh}$, and
\item $\kappa^{sep} = R^{sh}/\mathfrak m R^{sh}$.
\end{enumerate}
\end{lemma}

\begin{proof}
This can be proved using the method followed in the proof of
Lemma \ref{lemma-henselization}.
The only difference is that, instead of pairs, one uses triples
$(S, \mathfrak q, \alpha)$ where $R \to S$ etale,
$\mathfrak q$ is a prime of $S$ lying over $\mathfrak m$, and
$\alpha : \kappa(\mathfrak q) \to \kappa^{sep}$ is an embedding
of extensions of $\kappa$.

\medskip\noindent
But we can also deduce the result directly from the result of
Lemma \ref{lemma-henselization}. Namely, for any finite separable
field sub extension $\kappa \subset \kappa' \subset \kappa^{sep}$
there exists a unique (up to unique isomorphism) finite etale local
ring extension $R^h \subset R^h(\kappa')$
whose residue field extension extension reproduces the given extension, see
Lemma \ref{lemma-henselian-cat-finite-etale}.
Hence we can set
$$
R^{sh} =
\bigcup\nolimits_{\kappa \subset \kappa' \subset \kappa^{sep}}
R^h(\kappa')
$$
The arrows in this system, compatible with the arrows on the level
of residue fields, exist by
Lemma \ref{lemma-henselian-cat-finite-etale}.
This will produce a henselian local ring by
Lemma \ref{lemma-colimit-henselian}
since each of the rings
$R^h(\kappa')$ is henselian by
Lemma \ref{lemma-finite-over-henselian}.
By construction the residue field extension induced by
$R^h \to R^{sh}$ is the field extension $\kappa \subset \kappa^{sep}$.
We omit the proof that $R^{sh}$ is a colimit of etale $R$-algebras.
\end{proof}

\begin{definition}
\label{definition-henselization}
Let $(R, \mathfrak m, \kappa)$ be a local ring.
\begin{enumerate}
\item The local ring map $R \to R^h$ constructed in
Lemma \ref{lemma-henselization}
is called the {\it henselization} of $R$.
\item Given a separable algebraic closure $\kappa \subset \kappa^{sep}$
the local ring map $R \to R^{sh}$ constructed in
Lemma \ref{lemma-strict-henselization}
is called the
{\it strict henselization of $R$ with respect to
$\kappa \subset \kappa^{sep}$}.
\item A local ring map $R \to R^{sh}$ is called a {\it strict henselization}
of $R$ if it is isomorphic to one of the local ring maps constructed in
Lemma \ref{lemma-strict-henselization}
\end{enumerate}
\end{definition}

\noindent
In the following lemmas we discuss functoriality properties of the
(strict) henselizations. This should make it clear exactly how canonical
these constructions really are.

\begin{lemma}
\label{lemma-henselian-functorial-prepare}
Let $R \to S$ be a local map of local rings.
Let $S \to S^h$ be the henselization.
Let $R \to A$ be an etale ring map and let $\mathfrak q$
be a prime of $A$ lying over $\mathfrak m_R$
such that $R/\mathfrak m_R \cong \kappa(\mathfrak q)$.
Then there exists a unique morphism of rings
$f : A \to S^h$ fitting into the commutative diagram
$$
\xymatrix{
A \ar[r]_f & S^h \\
R \ar[u] \ar[r] & S \ar[u]
}
$$
such that $f^{-1}(\mathfrak m_{S^h}) = \mathfrak q$.
\end{lemma}

\begin{proof}
Consider $A \otimes_R S^h$. This is an etale algebra over $S^h$, see
Lemma \ref{lemma-etale}.
Moreover
$\mathfrak q' = \mathfrak q \otimes S^h + A \otimes \mathfrak m_{S^h}$
is a maximal ideal lying over $\mathfrak m_{S^h}$ with residue
field equal to the residue field of $S^h$. Hence by
Lemma \ref{lemma-characterize-henselian}
there exists a (unique) splitting $\tau : A \otimes_R S^h \to S^h$
with $\tau^{-1}(\mathfrak m_{S^h}) = \mathfrak q'$.
Set $f$ equal to the composition $A \to A \otimes_R S^h \to S^h$.
Minor details omitted.
\end{proof}

\begin{lemma}
\label{lemma-henselian-functorial}
Let $R \to S$ be a local map of local rings.
Let $R \to R^h$ and $S \to S^h$ be the henselizations.
There exists a unique local ring map $R^h \to S^h$ fitting
into the commutative diagram
$$
\xymatrix{
R^h \ar[r]_f & S^h \\
R \ar[u] \ar[r] & S \ar[u]
}
$$
\end{lemma}

\begin{proof}
Write $R^h = \text{colim}\ R_i$ as a filtered colimit of etale $R$-algebras
$R_i$. Note that $\mathfrak m_i = \mathfrak m_{R^h} \cap R_i$
is a maximal ideal of $R_i$ with residue field $\kappa$.
Hence by
Lemma \ref{lemma-henselian-functorial-prepare}
we obtain canonical ring maps $f_i : R_i \to S^h$.
Setting $f = \text{colim}\ f_i$ we win.
\end{proof}

\begin{lemma}
\label{lemma-strictly-henselian-functorial-prepare}
Let $\varphi : R \to S$ be a local map of local rings.
Let $S/\mathfrak m_S \subset \kappa^{sep}$ be a separable algebraic closure.
Let $S \to S^{sh}$ be the strict henselization of $S$
with respect to $S/\mathfrak m_S \subset \kappa^{sep}$.
Let $R \to A$ be an etale ring map and let $\mathfrak q$
be a prime of $A$ lying over $\mathfrak m_R$.
Given any commutative diagram
$$
\xymatrix{
\kappa(\mathfrak q) \ar[r]_{\phi} & \kappa^{sep} \\
R/\mathfrak m_R \ar[r]^{\varphi} \ar[u] & S/\mathfrak m_S \ar[u]
}
$$
there exists a unique morphism of rings
$f : A \to S^{sh}$ fitting into the commutative diagram
$$
\xymatrix{
A \ar[r]_f & S^{sh} \\
R \ar[u] \ar[r]^{\varphi} & S \ar[u]
}
$$
such that $f^{-1}(\mathfrak m_{S^h}) = \mathfrak q$ and the induced
map $\kappa(\mathfrak q) \to \kappa^{sep}$ is the given one.
\end{lemma}

\begin{proof}
Consider $A \otimes_R S^h$.
This is an etale algebra over $S^h$, see Lemma \ref{lemma-etale}.
Moreover $I = \mathfrak q \otimes S^h + A \otimes \mathfrak m_{S^h}$
is an ideal lying over $\mathfrak m_{S^h}$ and our map
$\phi$ induces a surjection
$$
A \otimes_R S^h/I =
\kappa(\mathfrak q) \otimes_{R/\mathfrak m_R} \kappa^{sep}
\xrightarrow{\phi \otimes 1}
\kappa^{sep}
$$
The kernel of this surjection determines a maximal ideal $\mathfrak q'$
of $A \otimes_R S^h$. Hence by
Lemma \ref{lemma-characterize-henselian}
there exists a (unique) splitting $\tau : A \otimes_R S^h \to S^h$
with $\tau^{-1}(\mathfrak m_{S^h}) = \mathfrak q'$.
Set $f$ equal to the composition $A \to A \otimes_R S^h \to S^h$.
Minor details omitted.
\end{proof}

\begin{lemma}
\label{lemma-strictly-henselian-functorial}
Let $R \to S$ be a local map of local rings.
Choose separable algebraic closures
$R/\mathfrak m_R \subset \kappa_1^{sep}$
and
$S/\mathfrak m_S \subset \kappa_2^{sep}$.
Let $R \to R^{sh}$ and $S \to S^{sh}$ be the corresponding strict
henselizations. Given any commutative diagram
$$
\xymatrix{
\kappa_1^{sep} \ar[r]_{\phi} & \kappa_2^{sep} \\
R/\mathfrak m_R \ar[r]^{\varphi} \ar[u] & S/\mathfrak m_S \ar[u]
}
$$
There exists a unique local ring map $R^{sh} \to S^{sh}$ fitting
into the commutative diagram
$$
\xymatrix{
R^{sh} \ar[r]_f & S^{sh} \\
R \ar[u] \ar[r] & S \ar[u]
}
$$
and inducing $\phi$ on the residue fields of
$R^{sh}$ and $S^{sh}$.
\end{lemma}

\noindent
Here is a slightly different construction of the henselization.

\begin{proof}
Write $R^{sh} = \text{colim}\ R_i$ as a filtered colimit of etale
$R$-algebras $R_i$. Note that $\mathfrak m_i = \mathfrak m_{R^h} \cap R_i$
is a maximal ideal of $R_i$ with residue field contained in
$\kappa_1^{sep}$. Hence by
Lemma \ref{lemma-strictly-henselian-functorial-prepare}
we obtain canonical ring maps $f_i : R_i \to S^{sh}$.
Setting $f = \text{colim}\ f_i$ we win.
\end{proof}

\begin{lemma}
\label{lemma-henselization-different}
Let $R$ be a ring.
Let $\mathfrak p \subset R$ be a prime ideal.
Consider the category of pairs $(S, \mathfrak q)$ where
$R \to S$ is etale and $\mathfrak q$ is a prime lying over $\mathfrak p$
such that $\kappa(\mathfrak p) = \kappa(\mathfrak q)$.
This category is filtered and
$$
(R_{\mathfrak p})^h = \text{colim}_{(S, \mathfrak q)}\ S
$$
canonically.
\end{lemma}

\begin{proof}
A morphism of pairs $(S, \mathfrak q) \to (S', \mathfrak q')$
is given by an $R$-algebra map $\varphi : S \to S'$ such that
$\varphi^{-1}(\mathfrak q') = \mathfrak q$.
Let us show that the category of pairs is filtered, see
Categories, Definition \ref{categories-definition-directed}.
The category contains the pair $(R, \mathfrak p)$ and hence is not empty,
which proves part (1) of
Categories, Definition \ref{categories-definition-directed}.
Suppose that $(S, \mathfrak q)$ and $(S', \mathfrak q')$ are two pairs.
Note that $\mathfrak q$, resp.\ $\mathfrak q'$ correspond to primes
of the fibre rings $S \otimes \kappa(\mathfrak p)$,
resp.\ $S' \otimes \kappa(\mathfrak p)$ with residue fields
$\kappa(\mathfrak p)$, hence they correspond to maximal ideals of
$S \otimes \kappa(\mathfrak p)$, resp.\ $S' \otimes \kappa(\mathfrak p)$.
Set $S'' = S \otimes_R S'$. By the above there exists a unique
prime $\mathfrak q'' \subset S''$ lying over $\mathfrak q$ and over
$\mathfrak q'$ whose residue field is $\kappa(\mathfrak p)$.
The ring map $R \to S''$ is etale by
Lemma \ref{lemma-etale}.
This proves part (2) of
Categories, Definition \ref{categories-definition-directed}.
Next, suppose that
$\varphi, \psi : (S, \mathfrak q) \to (S', \mathfrak q')$
are two morphisms of pairs. Consider
$$
S'' = (S' \otimes_{\varphi, S, \psi} S')
\otimes_{S' \otimes_R S'} S'
$$
Arguing as above (base change of etale maps is etale, composition of
etale maps is etale) we see that $S''$ is etale over $R$. The fibre
ring of $S''$ over $\mathfrak p$ is
$$
F'' = (F' \otimes_{\varphi, F, \psi} F')
\otimes_{F' \otimes_{\kappa(\mathfrak p)} F'} F'
$$
where $F', F$ are the fibre rings of $S'$ and $S$. Since $\varphi$ and
$\psi$ are morphisms of pairs the map $F' \to \kappa(\mathfrak p)$
corresponding to $\mathfrak p'$ extends to a map $F'' \to \kappa(\mathfrak p)$
and in turn corresponds to a prime ideal $\mathfrak q'' \subset S''$
whose residue field is $\kappa(\mathfrak p)$.
The canonical map $S' \to S''$ (using the right most factor for example)
is a morphism of pairs $(S', \mathfrak q') \to (S'', \mathfrak q'')$
which equalizes $\varphi$ and $\psi$. This proves part (3) of
Categories, Definition \ref{categories-definition-directed}.
Hence we conclude that the category is filtered.

\medskip\noindent
Recall that in the proof of
Lemma \ref{lemma-henselization}
we constructed $(R_{\mathfrak p})^h$ as the corresponding colimit
but starting with $R_{\mathfrak p}$ and its maximal ideal
$\mathfrak pR_{\mathfrak p}$. Now, given any pair $(S, \mathfrak q)$
for $(R, \mathfrak p)$ we obtain a pair
$(S_{\mathfrak p}, \mathfrak qS_{\mathfrak p})$ for
$(R_{\mathfrak p}, \mathfrak pR_{\mathfrak p})$.
Moreover, in this situation
$$
S_{\mathfrak p} = \text{colim}_{f \in R, f \not \in \mathfrak p}\ S_f.
$$
Hence in order to show the equality
of the lemma, it suffices to show that any pair $(S_{loc}, \mathfrak q_{loc})$
for $(R_{\mathfrak p}, \mathfrak pR_{\mathfrak p})$ is of the form
$(S_{\mathfrak p}, \mathfrak qS_{\mathfrak p})$ for some pair
$(S, \mathfrak q)$ over $(R, \mathfrak p)$ (some details omitted).
This follows from
Lemma \ref{lemma-etale}.
\end{proof}

\begin{lemma}
\label{lemma-strict-henselization-different}
Let $R$ be a ring.
Let $\mathfrak p \subset R$ be a prime ideal.
Let $\kappa(\mathfrak p) \subset \kappa^{sep}$ be a
separable algebraic closure.
Consider the category of triples $(S, \mathfrak q, \phi)$
where $R \to S$ is etale, $\mathfrak q$ is a prime lying over $\mathfrak p$,
and $\phi : \kappa(\mathfrak q) \to \kappa^{sep}$ is a
$\kappa(\mathfrak p)$-algebra map. This category is filtered and
$$
(R_{\mathfrak p})^{sh} = \text{colim}_{(S, \mathfrak q, \phi)}\ S
$$
canonically.
\end{lemma}

\begin{proof}
A morphism of triples $(S, \mathfrak q, \phi) \to (S', \mathfrak q', \phi')$
is given by an $R$-algebra map $\varphi : S \to S'$ such that
$\varphi^{-1}(\mathfrak q') = \mathfrak q$ and such that
$\phi' \circ \varphi = \phi$.
Let us show that the category of pairs is filtered, see
Categories, Definition \ref{categories-definition-directed}.
The category contains the triple
$(R, \mathfrak p, \kappa(\mathfrak p) \subset \kappa^{sep})$
and hence is not empty, which proves part (1) of
Categories, Definition \ref{categories-definition-directed}.
Suppose that $(S, \mathfrak q, \phi)$ and $(S', \mathfrak q', \phi')$
are two triples.
Note that $\mathfrak q$, resp.\ $\mathfrak q'$ correspond to primes
of the fibre rings $S \otimes \kappa(\mathfrak p)$,
resp.\ $S' \otimes \kappa(\mathfrak p)$ with residue fields
finite separable over $\kappa(\mathfrak p)$ and $\phi$, resp.\ $\phi'$
correspond to maps into $\kappa^{sep}$. Hence this data corresponds to
$\kappa(\mathfrak p)$-algebra maps
$$
\phi : S \otimes_R \kappa(\mathfrak p) \longrightarrow \kappa^{sep},
\quad
\phi' : S' \otimes_R \kappa(\mathfrak p) \longrightarrow \kappa^{sep}.
$$
Set $S'' = S \otimes_R S'$. Combining the maps the above we get a unique
$\kappa(\mathfrak p)$-algerba map
$$
\phi'' = \phi \otimes \phi' :
S'' \otimes_R \kappa(\mathfrak p)
\longrightarrow
\kappa^{sep}
$$
whose kernel corresponds to a prime $\mathfrak q'' \subset S''$
lying over $\mathfrak q$ and over $\mathfrak q'$, and whose residue field
maps via $\phi''$ to the compositum of
$\phi(\kappa(\mathfrak q))$ and $\phi'(\kappa(\mathfrak q'))$ in
$\kappa^{sep}$. The ring map $R \to S''$ is etale by
Lemma \ref{lemma-etale}.
Hence $(S'', \mathfrak q'', \phi'')$ is a triple dominating both
$(S, \mathfrak q, \phi)$ and $(S', \mathfrak q', \phi')$.
This proves part (2) of
Categories, Definition \ref{categories-definition-directed}.
Next, suppose that
$\varphi, \psi : (S, \mathfrak q, \phi) \to (S', \mathfrak q', \phi')$
are two morphisms of pairs. Consider
$$
S'' = (S' \otimes_{\varphi, S, \psi} S')
\otimes_{S' \otimes_R S'} S'
$$
Arguing as above (base change of etale maps is etale, composition of
etale maps is etale) we see that $S''$ is etale over $R$. The fibre
ring of $S''$ over $\mathfrak p$ is
$$
F'' = (F' \otimes_{\varphi, F, \psi} F')
\otimes_{F' \otimes_{\kappa(\mathfrak p)} F'} F'
$$
where $F', F$ are the fibre rings of $S'$ and $S$. Since $\varphi$ and
$\psi$ are morphisms of triples the map $\phi' : F' \to \kappa^{sep}$
extends to a map $\phi'' : F'' \to \kappa^{sep}$
which in turn corresponds to a prime ideal $\mathfrak q'' \subset S''$.
The canonical map $S' \to S''$ (using the right most factor for example)
is a morphism of triples
$(S', \mathfrak q', \phi') \to (S'', \mathfrak q'', \phi'')$
which equalizes $\varphi$ and $\psi$. This proves part (3) of
Categories, Definition \ref{categories-definition-directed}.
Hence we conclude that the category is filtered.

\medskip\noindent
We still have to show that the colimit $R_{colim}$ of the system
is equal to the strict henselization
of $R_{\mathfrak p}$ with respect to $\kappa^{sep}$. To see this note that
the system of triples $(S, \mathfrak q, \phi)$ contains as a subsystem
the pairs $(S, \mathfrak q)$ of 
Lemma \ref{lemma-henselization-different}.
Hence $R_{colim}$ contains $R_{\mathfrak p}^h$ by the result of that lemma.
Moreover, it is clear that $R_{\mathfrak p}^h \subset R_{colim}$
is a directed colimit of etale ring extensions.
It follows that $R_{colim}$ is henselian by
Lemmas \ref{lemma-finite-over-henselian} and
\ref{lemma-colimit-henselian}.
Finally, by
Lemma \ref{lemma-make-etale-map-prescribed-residue-field}
we see that the residue field of $R_{colim}$ is equal to
$\kappa^{sep}$. Hence we conclude that $R_{colim}$ is strictly henselian
and hence equals the strict henselization of $R_{\mathfrak p}$ as desired.
Some details omitted.
\end{proof}

\begin{lemma}
\label{lemma-strictly-henselian-solutions}
Let $\varphi : R \to S$ be a local ring map of strictly henselian local rings.
Let $P_1, \ldots, P_n \in R[x_1, \ldots, x_n]$ be polynomials such that
$R[x_1, \ldots, x_n]/(P_1, \ldots, P_n)$ is etale over $R$.
Then the map
$$
R^n \longrightarrow S^n,\quad
(h_1, \ldots, h_n) \longmapsto (\varphi(h_1), \ldots, \varphi(h_n))
$$
induces a bijection between
$$
\{
(r_1, \ldots, r_n) \in R^n
\mid
P_i(r_1, \ldots, r_n) = 0,\ i = 1, \ldots, n
\}
$$
and
$$
\{
(s_1, \ldots, s_n) \in S^n
\mid
P'_i(s_1, \ldots, s_n) = 0,\ i = 1, \ldots, n
\}
$$
where $P'_i \in S[x_1, \ldots, x_n]$ are the images of the $P_i$
under $\varphi$.
\end{lemma}

\begin{proof}
The first solution set is canonically isomorphic to the set
$$
\text{Hom}_R(R[x_1, \ldots, x_n]/(P_1, \ldots, P_n), R).
$$
As $R$ is henselian the map $R \to R/\mathfrak m_R$ induces a bijection
between this set and the set of solutions in the 
residue field $R/\mathfrak m_R$, see
Lemma \ref{lemma-characterize-henselian}.
The same is true for $S$.
Now since $R[x_1, \ldots, x_n]/(P_1, \ldots, P_n)$ is etale over $R$
and $R/\mathfrak m_R$ is separably algebraically closed we see that
$R/\mathfrak m_R[x_1, \ldots, x_n]/(\overline{P_1}, \ldots, \overline{P_n})$
is a finite product of copies of $R/\mathfrak m_R$. Hence the
tensor product
$$
R/\mathfrak m_R[x_1, \ldots, x_n]/(\overline{P_1}, \ldots, \overline{P_n})
\otimes_{R/\mathfrak m_R} S/\mathfrak m_S
=
S/\mathfrak m_S[x_1, \ldots, x_n]/(\overline{P_1'}, \ldots, \overline{P_n'})
$$
is also a finite product of copies of $S/\mathfrak m_S$ with the same
index set. This proves the lemma.
\end{proof}








\section{Serre's criterion for normality}
\label{section-serre-criterion}

\noindent
We introduce the following properties of Noetherian rings.

\begin{definition}
\label{definition-conditions}
Let $R$ be a Noetherian ring.
Let $k \geq 0$ be an integer.
\begin{enumerate}
\item We say $R$ has property {\it $(R_k)$} if for every prime $\mathfrak p$
of height $\leq k$ the local ring $R_{\mathfrak p}$ is regular.
We also say that $R$ is {\it regular in codimension $\leq k$}.
\item We say $R$ has property {\it $(S_k)$} if for every prime $\mathfrak p$
the local ring $R_{\mathfrak p}$ has depth at least
$\min\{k, \dim(R_{\mathfrak p})\}$.
\item Let $M$ be a finite $R$-module. We say $M$ has property $(S_k)$
if for every prime $\mathfrak p$ the module
$M_{\mathfrak p}$ has depth at least $\min\{k, \dim(M_{\mathfrak p})\}$.
\end{enumerate}
\end{definition}

\noindent
Any Noetherian ring has property $(S_0)$ (and so does any finite module
over it).

\begin{lemma}
\label{lemma-criterion-no-embedded-primes}
Let $R$ be a Noetherian ring.
Let $M$ be a finite $R$-module.
The following are equivalent:
\begin{enumerate}
\item $M$ has no embedded associated prime, and
\item $M$ has property $(S_1)$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $\mathfrak p$ be an embedded associated prime of $M$.
Then there exists another associated prime $\mathfrak q$ of $M$
such that $\mathfrak p \subset \mathfrak q$. In particular this
implies that $\dim(M_{\mathfrak p}) \geq 1$ (since $\mathfrak q$
is in the support as well). On the other hand $\mathfrak pR_{\mathfrak p}$
is associated to $M_{\mathfrak p}$
(Lemma \ref{lemma-associated-primes-localize}) and hence
$\text{depth}(M_{\mathfrak p}) = 0$
(see Lemma \ref{lemma-ideal-nonzerodivisor}).
In other words $(S_1)$ does not hold.
Conversely, if $(S_1)$ does not then there exists a prime
$\mathfrak p$ such that $\dim(M_{\mathfrak p}) \geq 1$
and $\text{depth}(M_{\mathfrak p}) = 0$. Then we see
(arguing backwards using the lemmas cited above) that $\mathfrak p$
is an embedded associated prime.
\end{proof}

\begin{lemma}
\label{lemma-criterion-reduced}
Let $R$ be a Noetherian ring.
The following are equivalent:
\begin{enumerate}
\item $R$ is reduced, and
\item $R$ has properties $(R_0)$ and $(S_1)$.
\end{enumerate}
\end{lemma}

\begin{proof}
Suppose that $R$ is reduced. Then $R_{\mathfrak p}$ is a field for
every minimal prime $\mathfrak p$ of $R$, according to
Lemma \ref{lemma-minimal-prime-reduced-ring}. Hence we have $(R_0)$.
Let $\mathfrak p$ be a prime of height $\geq 1$. Then $A = R_{\mathfrak p}$
is a reduced local ring of dimension $\geq 1$. Hence its maximal
ideal $\mathfrak m$ is not an associated prime
since this would mean there exists a $x \in \mathfrak m$
with annihilator $\mathfrak m$ so $x^2 = 0$. Hence the depth of
$A = R_{\mathfrak p}$ is at least one, by Lemma \ref{lemma-ass-zero-divisors}.
This shows that $(S_1)$ holds.

\medskip\noindent
Conversely, assume that $R$ satisfies $(R_0)$ and $(S_1)$.
If $\mathfrak p$ is a minimal prime of $R$, then
$R_{\mathfrak p}$ is a field by $(R_0)$, and hence is reduced.
If $\mathfrak p$ is not minimal, then we see that $R_{\mathfrak p}$
has depth $\geq 1$ by $(S_1)$ and we conclude there exists an element
$t \in \mathfrak pR_{\mathfrak p}$ such that
$R_{\mathfrak p} \to R_{\mathfrak p}[1/t]$ is injective.
This implies that $R_{\mathfrak p}$ is a subring of localizations
of $R$ at primes of smaller height. Thus by induction on the height we
conclude that $R$ is reduced.
\end{proof}

\begin{lemma}
\label{lemma-criterion-normal}
(Serre's criterion for normality)
Let $R$ be a Noetherian ring.
The following are equivalent:
\begin{enumerate}
\item $R$ is a normal ring, and
\item $R$ has properties $(R_1)$ and $(S_2)$.
\end{enumerate}
\end{lemma}

\begin{proof}
Suppose that $R$ is normal. This means by definition that $R$
is reduced and all localizations $R_{\mathfrak p}$ are normal domains.
In particular we see that $R$ has $(R_0)$ and $(S_1)$ by
Lemma \ref{lemma-criterion-reduced}. Hence it suffices to show
that a local Noetherian normal domain $R$ of dimension $d$ has
depth $\geq \min(2, d)$ and is regular if $d = 1$. The assertion
if $d = 1$ follows from Lemma \ref{lemma-characterize-dvr}.

\medskip\noindent
Let $R$ be a local Noetherian normal domain with maximal ideal
$\mathfrak m$ and dimension $d \geq 2$. Choose
$x \in \mathfrak m$, $x \not \in \mathfrak m^2$. If $\text{depth}(R/xR) \geq 1$
then $\text{depth}(R) \geq 2$ and we win. Assume $\text{depth}(R/xR) = 0$ to
get a contradiction.
This means that $\mathfrak m/(x)$ is an associated prime of $R/xR$.
In other words, there exists an element $z \in R$ such that
$\mathfrak m z \subset (x)$, but $z \not \in (x)$. Consider the
element $z/x$ of the fraction field of $R$. Let $c \in \mathfrak m$
be an arbitrary nonzero element. We claim that $c z^n/x^n \in R$.
Namely, $c z^n/x^n = (cz/x) z^{n - 1}/x^{n - 1}$. By choice of
$z$ we have $cz = c' x$ for some $c' \in R$. Note that
$c' \in \mathfrak m$ since $x \not \in \mathfrak m^2$. Hence
$c z^n/x^n = c' z^{n - 1}/x^{n - 1}$ which is an element of $R$
by induction on $n$. In other words, this shows that $z/x$
is almost integral over $R$, see Definition \ref{definition-almost-integral}.
By Lemma \ref{lemma-almost-integral} we see that $z/x$ is integral over $R$.
As $R$ is normal we see that $z/x \in R$ which is the desired contradiction.

\medskip\noindent
Suppose that $R$ satisfies $(R_1)$ and $(S_2)$.
By Lemma \ref{lemma-criterion-reduced} we conclude that $R$ is
reduced. Hence it suffices to show that if $R$ is a reduced local
Noetherian ring of dimension $d$ satisfying $(S_2)$ and $(R_1)$
then $R$ is a normal domain. If $d = 0$, the result is clear.
If $d = 1$, then the result follows from Lemma \ref{lemma-characterize-dvr}.

\medskip\noindent
Let $R$ be a reduced local Noetherian ring with maximal ideal
$\mathfrak m$ and dimension $d$ which satisfies $(R_1)$ and
$(S_2)$. By Lemma \ref{lemma-characterize-reduced-ring-normal}
it suffices to show that $R$ is integrally closed in its
total ring of fractions.
Pick $x = f/g$, with $f, g \in R$ and $g$ a nonzero divisor
which satisfies a monic equation
$$
(f/g)^n + \sum\nolimits_{i = 1}^n a_i(f/g)^{n - i} = 0
$$
with $a_i \in R$.
Our goal is to show that $f \in (g) = gR$. We will prove this by induction
on $d$. By the remarks in the previous paragraph we know this
is the case when $d = 0$, and when $d = 1$, which starts the induction.
Assume $d \geq 2$. Consider the short exact sequence
$$
0 \to R \to R \to R/(g) \to 0.
$$
By Lemma \ref{lemma-depth-in-ses} this implies $\text{depth}(R/(g)) \geq 1$.
Hence there exists an element $t \in \mathfrak m$ which is a nonzero
divisor on $R/(g)$. Hence if $f$ has a nonzero image in
$R/(g)$ then it has a nonzero image in
$(R/(g))[1/t] \cong R_t/gR_t$. But by induction on the dimension
the image of $f$ is zero in $R_t/gR_t$ (for example by localizing at all
the primes of $D(t) \subset \text{Spec}(R)$). Hence we win.
\end{proof}

\begin{lemma}
\label{lemma-regular-normal}
A regular ring is normal.
\end{lemma}

\begin{proof}
Let $R$ be a regular ring. By
Lemma \ref{lemma-criterion-normal}
it suffices to prove that $R$ is $(R_1)$ and $(S_2)$.
As a regular local ring is Cohen-Macaulay, see
Lemma \ref{lemma-regular-ring-CM},
it is clear that $R$ is $(S_2)$.
Property $(R_1)$ is immediate.
\end{proof}

\begin{lemma}
\label{lemma-normal-domain-intersection-localizations-height-1}
Let $R$ be a Noetherian normal domain with fraction field $K$. Then
\begin{enumerate}
\item for any nonzero $a \in R$ the quotient $R/aR$ has no embedded primes,
and all its associated primes have height $1$
\item
$$
R = \bigcap\nolimits_{\text{height}(\mathfrak p) = 1} R_{\mathfrak p}
$$
\item For any nonzero $x \in K$ the quotient $R/(R \cap xR)$
has no embedded primes, and all its associates primes have height $1$.
\end{enumerate}
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-criterion-normal} we see that $R$ has $(S_2)$.
Hence for any nonzero element $a \in R$ we see that $R/aR$ has $(S_1)$
(use Lemma \ref{lemma-depth-in-ses} for example)
Hence $R/aR$ has no embedded primes
(Lemma \ref{lemma-criterion-no-embedded-primes}).
We conclude the associated primes of $R/aR$ are exactly
the minimal primes $\mathfrak p$ over $(a)$, which have height $1$
as $a$ is not zero (Lemma \ref{lemma-minimal-over-1}). This proves (1).

\medskip\noindent
Thus, given $b \in R$ we have $b \in aR$ if and only if
$b \in aR_{\mathfrak p}$ for every minimal prime $\mathfrak p$
over $(a)$ (see Lemma \ref{lemma-zero-at-ass-zero}).
These primes all have height $1$ as seen above so
$b/a \in R$ if and only if $b/a \in R_{\mathfrak p}$ for all
height 1 primes. Hence (2) holds.

\medskip\noindent
For (3) write $x = a/b$. Let $\mathfrak p_1, \ldots, \mathfrak p_r$
be the minimal primes over $(ab)$. These all have height 1 by the above.
Then we see that
$R \cap xR = \bigcap_{i = 1, \ldots, r} (R \cap xR_{\mathfrak p_i})$
by part (2) of the lemma. Hence $R/(R \cap xR)$ is a submodule of
$\bigoplus R/(R \cap xR_{\mathfrak p_i})$.
As $R_{\mathfrak p_i}$ is a discrete valuation ring (by property $(R_1)$
for the Noetherian normal domain $R$, see Lemma \ref{lemma-criterion-normal})
we have $xR_{\mathfrak p_i} = \mathfrak p_i^{e_i}R_{\mathfrak p_i}$
for some $e_i \in \mathbf{Z}$. Hence the direct sum is equal
to $\bigoplus_{e_i > 0} R/\mathfrak p_i^{(e_i)}$, see
Definition \ref{definition-symbolic-power}.
By Lemma \ref{lemma-symbolic-power-associated}
the only associated prime of the module
$R/\mathfrak p^{(n)}$ is $\mathfrak p$. Hence the set of associate primes
of $R/(R \cap xR)$ is a subset of $\{\mathfrak p_i\}$ and there are
no inclusion relations among them. This proves (3).
\end{proof}















\section{Formal smoothness of fields}
\label{section-p-bases}

\noindent
In this section we show that field extensions are formally smooth
if and only if they are separable.

\begin{lemma}
\label{lemma-derivative-zero-pth-power}
Let $K$ be a field of characteristic $p > 0$.
Let $a \in K$. Then $\text{d}a = 0$ in $\Omega_{K/\mathbf{F}_p}$
if and only if $a$ is a $p$th power.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-colimit-differentials} we see that there exists a subfield
$\mathbf{F}_p \subset L \subset K$ such that $\mathbf{F}_p \subset L$
is a finitely generated field extension and such that
$\text{d}a$ is zero in $\Omega_{L/\mathbf{F}_p}$.
Hence we may assume that $K$ is a finitely generated field extension
of $\mathbf{F}_p$.

\medskip\noindent
Choose a transcendence basis $x_1, \ldots, x_r \in K$
such that $K$ is finite separable over $\mathbf{F}_p(x_1, \ldots, x_r)$.
We remark that the result holds for the purely transcendental
subfield $\mathbf{F}_p(x_1, \ldots, x_r) \subset K$.
Namely,
$$
\Omega_{\mathbf{F}_p(x_1, \ldots, x_r)/\mathbf{F}_p} =
\bigoplus\nolimits_{i = 1}^r k(x_1, \ldots, x_r) \text{d}x_i
$$
and any rational function all of whose partial derivatives are zero
is a $p$th power. Moreover, we also have
$$
\Omega_{K/\mathbf{F}_p} =
\bigoplus\nolimits_{i = 1}^r K\text{d}x_i
$$
since $\mathbf{F}_p(x_1, \ldots, x_r) \subset K$ is finite separable
(computation omitted). Suppose $a \in K$ is an element such that
$\text{d}a = 0$ in the module of differentials. By our choice of $x_i$ we
see that the minimal polynomial $P(T) \in k(x_1, \ldots, x_r)[T]$
of $a$ is separable. Write
$$
P(T) = T^d + \sum\nolimits_{i = 1}^d a_i T^{d - i}
$$
and hence
$$
0 = \text{d}P(a) = \sum\nolimits_{i = 1}^d a^{d - i}\text{d}a_i
$$
in $\Omega_{K/\mathbf{F}_p}$. By the description of
$\Omega_{K/\mathbf{F}_p}$ above and the fact that $P$ was the minimal
polynomial of $a$, we see that this implies $\text{d}a_i = 0$.
Hence $a_i = b_i^p$ for each $i$. Therefore by Lemma \ref{lemma-pth-root}
we see that $a$ is a $p$th power.
\end{proof}

\begin{lemma}
\label{lemma-separable-differentials}
Let $k$ be a field of characteristic $p > 0$.
The following are equivalent:
\begin{enumerate}
\item the field extension $K/k$ is separable
(see Definition \ref{definition-separable-field-extension}), and
\item the map
$K \otimes_k \Omega_{k/\mathbf{F}_p} \to \Omega_{K/\mathbf{F}_p}$
is injective.
\end{enumerate}
\end{lemma}

\begin{proof}
Write $K$ as a directed colimit $K = \text{colim}_i K_i$ of finitely generated 
field extensions $k \subset K_i$. By definition $K$ is separable if and only
if each $K_i$ is separable over $k$, and by
Lemma \ref{lemma-colimit-differentials} we see that
$K \otimes_k \Omega_{k/\mathbf{F}_p} \to \Omega_{K/\mathbf{F}_p}$
is injective if and only if each
$K_i \otimes_k \Omega_{k/\mathbf{F}_p} \to \Omega_{K_i/\mathbf{F}_p}$
is injective. Hence we may assume that $K/k$ is a finitely generated field
extension.

\medskip\noindent
Assume $k \subset K$ is a finitely generated field extension which is
separable. Choose $x_1, \ldots, x_{r + 1} \in K$ as in
Lemma \ref{lemma-generating-finitely-generated-separable-field-extensions}.
In this case there exists an irreducible polynomial
$G(X_1, \ldots, X_{r + 1}) \in k[X_1, \ldots, X_{r + 1}]$
such that $G(x_1, \ldots, x_{r + 1}) = 0$ and such that
$\partial G/\partial X_{r + 1}$ is not identically zero.
Moreover $K$ is the field of fractions of the domain.
$S = K[X_1, \ldots, X_{r + 1}]/(G)$.
Write
$$
G = \sum a_I X^I,\quad X^I = X_1^{i_1}\ldots X_{r + 1}^{i_{r + 1}}.
$$
Using the presentation of $S$ above we see that
$$
\Omega_{S/\mathbf{F}_p}
=
\frac{
S \otimes_k \Omega_k \oplus
\bigoplus\nolimits_{i = 1, \ldots, r + 1} S\text{d}X_i
}{
\langle
\sum X^I \text{d}a_I + \sum \partial G/\partial X_i \text{d}X_i
\rangle
}
$$
Since $\Omega_{K/\mathbf{F}_p}$ is the localization
of the $S$-module $\Omega_{S/\mathbf{F}_p}$ (see
Lemma \ref{lemma-differentials-localize}) we conclude
that
$$
\Omega_{K/\mathbf{F}_p}
=
\frac{
K \otimes_k \Omega_k \oplus
\bigoplus\nolimits_{i = 1, \ldots, r + 1} K\text{d}X_i
}{
\langle
\sum X^I \text{d}a_I + \sum \partial G/\partial X_i \text{d}X_i
\rangle
}
$$
Now, since the polynomial $\partial G/\partial X_{r + 1}$ is not identically
zero we conclude that the map
$K \otimes_k \Omega_{k/\mathbf{F}_p} \to \Omega_{S/\mathbf{F}_p}$
is injective as desired.

\medskip\noindent
Assume $k \subset K$ is a finitely generated field extension
and that
$K \otimes_k \Omega_{k/\mathbf{F}_p} \to \Omega_{K/\mathbf{F}_p}$
is injective.
(This part of the proof is the same as the argument proving
Lemma \ref{lemma-characterize-separable-field-extensions}.)
Let $x_1, \ldots, x_r$ be a transcendence basis of $K$ over $k$ such
that the degree of inseparability of the finite extension
$k(x_1, \ldots, x_r) \subset K$ is minimal.
If $K$ is separable over $k(x_1, \ldots, x_r)$ then we win.
Assume this is not the case to get a contradiction.
Then there exists an element $\alpha \in K$ which is not
separable over $k(x_1, \ldots, x_r)$. Let $P(T) \in k(x_1, \ldots, x_r)[T]$
be its minimal polynomial. Because $\alpha$ is not separable
actually $P$ is a polynomial in $T^p$. Clear denominators
to get an irreducible polynomial
$$
G(X_1, \ldots, X_r, T) = \sum a_{I, i} X^I T^i \in k[X_1, \ldots, X_r, T]
$$
such that $G(x_1, \ldots, x_r, \alpha) = 0$ in $L$.
Note that this means $k[X_1, \ldots, X_r, T]/(G) \subset L$.
We may assume that for some pair $(I_0, i_0)$ the coefficient
$a_{I_0, i_0} = 1$.
We claim that ${\rm d}G/{\rm d}X_i$ is not identically zero
for at least one $i$. Namely, if this is not the case, then
$G$ is actually a polynomial in $X_1^p, \ldots, X_r^p, T^p$.
Then this means that
$$
\sum\nolimits_{(I, i) \not = (I_0, i_0)} x^I\alpha^i \text{d}a_{I, i}
$$
is zero in $\Omega_{K/\mathbf{F}_p}$. Note that there is no
$k$-linear relation among the elements
$$
\{x^I\alpha^i \mid a_{I, i} \not = 0 \text{ and } (I, i) \not = (I_0, i_0)\}
$$
of $K$. Hence the assumption
that $K \otimes_k \Omega_{k/\mathbf{F}_p} \to \Omega_{K/\mathbf{F}_p}$
is injective this implies that $\text{d}a_{I, i} = 0$
in $\Omega_{k/\mathbf{F}_p}$ for all $(I, i)$.
By Lemma \ref{lemma-derivative-zero-pth-power}
we see that each $a_{I, i}$ is a $p$th power, which
implies that $G$ is a $p$th power contradicting the irreducibility of
$G$. Thus,
after renumbering, we may assume that ${\rm d}G/{\rm d}X_1$ is not zero.
Then we see that $x_1$ is separably algebraic over
$k(x_2, \ldots, x_r, \alpha)$, and that $x_2, \ldots, x_r, \alpha$
is a transcendence basis of $L$ over $k$. This means that
the degree of inseparability of the finite extension
$k(x_2, \ldots, x_r, \alpha) \subset L$ is less than the
degree of inseparability of the finite extension
$k(x_1, \ldots, x_r) \subset L$, which is a contradiction.
\end{proof}

\begin{lemma}
\label{lemma-formally-smooth-implies-separable}
Let $k \subset K$ be an extension of fields.
If $K$ is formally smooth over $k$, then $K$ is
a separable extension of $k$.
\end{lemma}

\begin{proof}
Assume $K$ is formally smooth over $k$.
By Lemma \ref{lemma-ses-formally-smooth} we see that
$K \otimes_k \Omega_{k/\mathbf{Z}} \to \Omega_{K/\mathbf{Z}}$
is injective. Hence $K$ is separable over $k$ by
Lemma \ref{lemma-separable-differentials} above.
\end{proof}

\begin{lemma}
\label{lemma-characterize-formally-smooth-field-extension}
Let $k \subset K$ be an extension of fields.
Consider the presentation
$$
0 \longrightarrow J \longrightarrow
P = k[x_\lambda; \lambda \in K] \longrightarrow K
\longrightarrow 0
$$
of $K$ as a $k$-algebra. Then $K$ is formally smooth over $k$
if and only if the sequence
$$
J/J^2 \to
\bigoplus\nolimits_{\lambda \in K} K\text{d}x_\lambda \to
\Omega_{K/k} \to 0
$$
of Lemma \ref{lemma-differential-seq} is exact on the left also.
\end{lemma}

\begin{proof}
This follows from Lemma \ref{lemma-characterize-formally-smooth-again}
and the fact that a short exact sequence
of vector spaces is automatically split exact.
\end{proof}

\begin{lemma}
\label{lemma-formally-smooth-extensions-easy}
Let $k \subset K$ be an extension of fields.
\begin{enumerate}
\item If $K$ is purely transcendental over $k$, then
$K$ is formally smooth over $k$.
\item If $K$ is separable algebraic over $k$, then $K$ is
formally smooth over $k$.
\end{enumerate}
\end{lemma}

\begin{proof}
For (1) write $K = k(x_j; j \in J)$. Suppose that
$A$ is a $k$-algebra, and $I \subset A$ is an ideal of
square zero. Let $\varphi : K \to A/I$ be a $k$-algebra map.
Let $a_j \in A$ be an element such that $a_j \mod I = \varphi(x_j)$.
Then it is easy to see that there is a unique $k$-algebra
map $K \to A$ which maps $x_j$ to $a_j$ and which reduces
to $\varphi$ mod $I$. Hence $k \subset K$ is formally smooth.

\medskip\noindent
In case (2) we see that $k \subset K$ is a colimit of
etale ring extensions. An etale ring map is formally etale
(Lemma \ref{lemma-formally-etale-etale}). Hence this case follows from
Lemma \ref{lemma-colimit-formally-etale} and the trivial observation
that a formally etale ring map is formally smooth.
\end{proof}

\begin{lemma}
\label{lemma-fields-are-formally-smooth}
Let $k$ be a field.
\begin{enumerate}
\item If the characteristic of $k$ is zero, then any extension field
of $k$ is formally smooth over $k$.
\item If the characteristic of $k$ is $p > 0$, then $k \subset K$ is
formally smooth if it is a separable field extension.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume $k$ has characteristic zero. Let $k \subset K$ be a field extension.
Let $x_i$ be a transcendence basis for $K$ over $k$.
Then $k(x_i) \subset K$ is a separable algebraic extension.
Hence we see that $k \subset K$ is formally smooth
by combining Lemmas \ref{lemma-formally-smooth-extensions-easy}
and \ref{lemma-compose-formally-smooth}.

\medskip\noindent
Assume $k$ has characteristic $p > 0$.
Let $k \subset K$ be a separable field extension (see
Definition \ref{definition-separable-field-extension}).
First assume that $k \subset K$ is finitely generated.
Then there exists a transcendence basis $x_1, \ldots, x_r$
of $K$ over $k$ such that $k(x_1, \ldots, x_r) \subset K$ is
finite separable. Hence, as above, by
Lemmas \ref{lemma-formally-smooth-extensions-easy}
and \ref{lemma-compose-formally-smooth} we see that $k \subset K$
is formally smooth.

\medskip\noindent
The general case. Let $k \subset K$ be a separable field extension.
Consider the presentation
$$
0 \longrightarrow J \longrightarrow
P = k[x_\lambda; \lambda \in K] \longrightarrow K
\longrightarrow 0
$$
of $K$ as a $k$-algebra. By
Lemma \ref{lemma-characterize-formally-smooth-field-extension}
we have to show that the sequence
$$
J/J^2 \longrightarrow
\bigoplus\nolimits_{\lambda \in K} K\text{d}x_\lambda \longrightarrow
\Omega_{K/k} \longrightarrow 0
$$
is exact on the left also. Consider any
subextension $k \subset K' \subset K$ with $K'$ a finitely
generated field extension over $k$. Then we get a commutative
diagram
$$
\xymatrix{
0 \ar[r] &
J'/(J')^2 \ar[r] \ar[d] &
\bigoplus\nolimits_{\lambda \in K'} K'\text{d}x_\lambda \ar[r] \ar[d] &
\Omega_{K'/k} \ar[r] \ar[d] & 0 \\
& J/J^2 \ar[r] &
\bigoplus\nolimits_{\lambda \in K} K\text{d}x_\lambda \ar[r] &
\Omega_{K/k} \ar[r] & 0
}
$$
where $J' = \text{Ker}(P' = k[x_\lambda; \lambda \in K'] \to K')$.
Note that the middle arrow is injective and that the top row is
short exact by Lemma \ref{lemma-characterize-formally-smooth-field-extension}
and the fact (proved just above) that $K'$ is formally smooth over $k$.
Since every element of $J/J^2$ is in the image of $J'/(J')^2$
for a suitable $K'$ we win.
\end{proof}

\noindent
Here we put together all the different characterizations of separable
field extensions.

\begin{proposition}
\label{proposition-characterize-separable-field-extensions}
Let $k \subset K$ be a field extension.
If the characteristic of $k$ is zero then
\begin{enumerate}
\item $K$ is separable over $k$,
\item $K$ is geometrically reduced over $k$,
\item $K$ is formally smooth over $k$, and
\item the map $K \otimes_k \Omega_{k/\mathbf{Z}} \to \Omega_{K/\mathbf{Z}}$
is injective.
\end{enumerate}
If the characteristic of $k$ is $p > 0$, then the following are
equivalent:
\begin{enumerate}
\item $K$ is separable over $k$,
\item the ring $K \otimes_k k^{1/p}$ is reduced,
\item $K$ is geometrically reduced over $k$,
\item the map $K \otimes_k \Omega_{k/\mathbf{F}_p} \to \Omega_{K/\mathbf{F}_p}$
is injective, and
\item $K$ is formally smooth over $k$.
\end{enumerate}
\end{proposition}

\begin{proof}
This is a combination of
Lemmas \ref{lemma-characterize-separable-field-extensions},
\ref{lemma-fields-are-formally-smooth}
\ref{lemma-formally-smooth-implies-separable}, and
\ref{lemma-separable-differentials}.
\end{proof}

\noindent
Here is yet another characterization of finitely generated separable field
extensions.

\begin{lemma}
\label{lemma-localization-smooth-separable}
Let $k \subset K$ be a finitely generated field extension.
Then $K$ is separable over $k$ if and only if $K$ is
the localization of a smooth $k$-algebra.
\end{lemma}

\begin{proof}
If $k \subset R$ is a smooth $k$-algebra, then the map
$R \otimes_k \Omega_k \to \Omega_R$ is injective by
Lemma \ref{lemma-ses-formally-smooth} (and
Lemma \ref{lemma-smooth-formally-smooth}). Hence if
$K = R_{\mathfrak p}$ for some minimal prime $\mathfrak p$
we also have that $K \otimes_k \Omega_k \to \Omega_K$
is injective. Thus we see that $K/k$ is separable by
Proposition \ref{proposition-characterize-separable-field-extensions}.
(This direction is less interesting and could be proved in
many other ways, for example by reversing the argument in the
next paragraph.)

\medskip\noindent
Conversely, suppose that $k \subset K$ is a finitely generated field extension
and $K$ is separable over $k$. By
Lemma \ref{lemma-generating-finitely-generated-separable-field-extensions}
we see that we can find $x_1, \ldots, x_r, x_{r + 1} \in K$ such
that $x_1, \ldots, x_r$ form a transcendence basis of $K$ over $k$
and $x_{r + 1}$ is separable algebraic over $k(x_1, \ldots, x_r)$.
Let $P \in k[X_1, \ldots, X_{r + 1}]$ be an irreducible polynomial
such that $P(x_1, \ldots, x_{r + 1}) = 0$ in $K$.
Thus $K$ is the field of fractions
of $k[X_1, \ldots, X_{r + 1}]/(P)$. The separability of
$K/k(x_1, \ldots, x_r)$ means that
$\partial P/\partial X_{r + 1}(x_1, \ldots, x_{r + 1})$
is not zero in $K$. Hence
$$
R = k[X_1, \ldots, X_{r + 1}]/
(P)\left[\left(\frac{\partial P}{\partial X_{r + 1}}\right)^{-1}\right]
$$
is a smooth $k$-algebra whose fraction field is $K$.
\end{proof}




\section{Constructing flat ring maps}
\label{section-constructing-flat}

\begin{lemma}
\label{lemma-flat-local-given-residue-field}
Let $(R, \mathfrak m, k)$ be a local ring.
Let $k \subset K$ be a field extension.
There exists a local ring $R'$, a flat local ring map $R \to R'$ 
such that $\mathfrak m' = \mathfrak mR'$ and the residue field
extension $k = R/\mathfrak m \subset R'/\mathfrak m'$ is 
isomorphic to $k \subset K$.
\end{lemma}

\begin{proof}
Suppose that $k \subset k' = k(\alpha)$ is a monogenic extension of fields.
Then $k'$ is the residue field of a flat local extension $R \subset R'$
as in the lemma. Namely, if $\alpha$ is transcendental over $k$, then we let
$R'$ be the localization of $R[x]$ at the prime $\mathfrak mR[x]$.
If $\alpha$ is algebraic with minimal polynomial
$T^d + \sum \overline{\lambda}_iT^{d - i}$, then we let
$R' = R[T]/(T^d + \sum \lambda_i T^{d - i})$.

\medskip\noindent
Consider the collection of triples $(k', R \to R', \phi)$, where
$k \subset k' \subset K$ is a subfield,
$R \to R'$ is a local ring map as in the lemma, and
$\phi : R' \to k'$ induces an isomorphism $R'/\mathfrak mR' \cong k'$
of $k$-extensions. These form a ``big'' category $\mathcal{C}$ with morphisms
$(k_1, R_1, \phi_1) \to (k_2, R_2, \phi_2)$
given by ring maps $\psi : R_1 \to R_2$ such that
$$
\xymatrix{
R_1 \ar[d]_\psi \ar[r]_{\phi_1} & k_1 \ar[r] & K \ar@{=}[d] \\
R_2 \ar[r]^{\phi_2} & k_2 \ar[r] & K
}
$$
commutes. This implies that $k_1 \subset k_2$.

\medskip\noindent
Suppose that $I$ is a directed partially ordered set, and
$((R_i, k_i, \phi_i), \psi_{ii'})$ is a system over $I$, see
Categories, Section \ref{categories-section-posets-limits}.
In this case we can consider
$$
R' = \text{colim}_{i \in I}\ R_i
$$
This is a local ring with maximal ideal $\mathfrak mR'$, and
residue field $k' = \bigcup_{i \in I} k_i$. Moreover, the ring
map $R \to R'$ is flat as it is a colimit of flat maps (and tensor
products commute with directed colimits).
Hence we see that $(R', k', \phi')$ is an ``upper bound'' for the system.

\medskip\noindent
An almost trivial application of Zorn's Lemma would finish the proof
if $\mathcal{C}$ was a set, but it isn't.
(Actually, you can make this work by finding a reasonable bound on the
cardinals of the local rings occuring.)
To get around this problem we choose a total ordering on $K$.
For $x \in K$ we let $K(x)$ be the subfield of $K$ generated
by all elements of $K$ which are $\leq x$.
By transfinite induction on $x \in K$ we will produce ring maps
$R \subset R(x)$ as in the lemma with residue field extension
$k \subset K(x)$. Moreover, by construction we will have that
$R(x)$ will contain $R(y)$ for all $y \leq x$.
Namely, if $x$ has a predecessor $x'$, then $K(x) = K(x')[x]$
and hence we can let $R(x') \subset R(x)$ be the local ring extension
constructed in the first paragraph of the proof. If $x$ does not
have a predecessor, then we first set
$R'(x) = \text{colim}_{x' < x} R(x')$ as in the third paragraph
of the proof. The residue field of $R'(x)$ is $K'(x) = \bigcup_{x' < x} K(x')$.
Since $K(x) = K'(x)[x]$ we see that we can use the construction of the
first paragraph of the proof to produce $R'(x) \subset R(x)$.
This finishes the proof of the lemma.
\end{proof}







\section{The Cohen structure theorem}
\label{section-cohen-structure-theorem}

\noindent
Here is a fundamental notion in commutative algebra.

\begin{definition}
\label{definition-complete-local-ring}
Let $(R, \mathfrak m)$ be a local ring. We say $R$ is a
{\it complete local ring} if the canonical map
$$
R \longrightarrow \text{lim}_n\ R/\mathfrak m^n
$$
to the completion of $R$ with respect to $\mathfrak m$ is an
isomorphism\footnote{This includes the condition
that $\bigcap \mathfrak m^n = (0)$; in some texts this may be indicated
by saying that $R$ is complete and separated. Warning: It can happen
that the completion $\text{lim}_n\ R/\mathfrak m^n$ of a local ring is
non-complete. This does not happen for Noetherian rings, see
Section \ref{section-completion}.}
\end{definition}

\begin{lemma}
\label{lemma-quotient-complete-local}
Let $R$ be a Noetherian complete local ring.
Any quotient of $R$ is also a Noetherian complete local ring.
\end{lemma}

\begin{proof}
This is clear from the material in Section \ref{section-completion}.
\end{proof}

\begin{definition}
\label{definition-coefficient-ring}
Let $(R, \mathfrak m)$ be a complete local ring.
A subring $\Lambda \subset R$ is
called a {\it coefficient ring} if the following conditions hold:
\begin{enumerate}
\item $\Lambda$ is a complete local ring with maximal ideal
$\Lambda \cap \mathfrak m$,
\item the residue field of $\Lambda$ maps isomorphically to the
residue field of $R$, and
\item $\Lambda \cap \mathfrak m = p\Lambda$, where $p$ is the characteristic
of the residue field of $R$.
\end{enumerate}
\end{definition}

\noindent
Let us make some remarks on this definition. We split the discussion
into the following cases:
\begin{enumerate}
\item The local ring $R$ contains a field. This happens if
either $\mathbf{Q} \subset R$, or $pR = 0$ where $p$ is the
characteristic of $R/\mathfrak m$. In this case a coefficient ring
$\Lambda$ is a field contained in $R$ which maps isomorphically to
$R/\mathfrak m$.
\item The characteristic of $R/\mathfrak m$ is $p > 0$ but no
power of $p$ is zero in $R$. In this case $\Lambda$ is a complete
discrete valuation ring with uniformizer $p$ and residue field $R/\mathfrak m$.
\item The characteristic of $R/\mathfrak m$ is $p > 0$, and for some
$n > 1$ we have $p^{n - 1} \not = 0$, $p^n = 0$ in $R$. In this case
$\Lambda$ is an Artinian local ring whose maximal ideal is
generated by $p$ and which has residue field $R/\mathfrak m$.
\end{enumerate}
The complete discrete valuation rings with uniformizer $p$
above play a special role and we baptize them as follows.

\begin{definition}
\label{definition-cohen-ring}
A {\it Cohen ring} is a complete discrete valuation ring with
uniformizer $p$ a prime number.
\end{definition}

\begin{lemma}
\label{lemma-cohen-rings-exist}
Let $p$ be a prime number.
Let $k$ be a field of characteristic $p$.
There exists a Cohen ring $\Lambda$ with $\Lambda/p\Lambda \cong k$.
\end{lemma}

\begin{proof}
First note that the $p$-adic integers $\mathbf{Z}_p$ form a Cohen ring
for $\mathbf{F}_p$. Let $k$ be an arbitrary field of characteristic $p$.
Let $\mathbf{Z}_p \to R$ be a flat local ring map such that
$\mathfrak m_R = pR$ and $R/pR = K$, see
Lemma \ref{lemma-flat-local-given-residue-field}.
Then clearly $R$ is a discrete valuation ring. Hence its
completion is a Cohen ring for $k$.
\end{proof}

\begin{lemma}
\label{lemma-cohen-ring-formally-smooth}
Let $p > 0$ be a prime.
Let $\Lambda$ be a Cohen ring with residue field of characteristic $p$.
For every $n \geq 1$ the ring map
$$
\mathbf{Z}/p^n\mathbf{Z} \to \Lambda/p^n\Lambda
$$
is formally smooth.
\end{lemma}

\begin{proof}
If $n = 1$, this follows from
Proposition \ref{proposition-characterize-separable-field-extensions}.
For general $n$ we argue by induction on $n$.
Namely, if $\mathbf{Z}/p^n\mathbf{Z} \to \Lambda/p^n\Lambda$ is
formally smooth, then we can apply Lemma \ref{lemma-lift-formal-smoothness}
to the ring map
$\mathbf{Z}/p^{n + 1}\mathbf{Z} \to \Lambda/p^{n + 1}\Lambda$
and the ideal $I = (p^n) \subset \mathbf{Z}/p^{n + 1}\mathbf{Z}$.
\end{proof}

\begin{theorem}
\label{theorem-cohen-structure-theorem}
(Cohen structure theorem)
Let $(R, \mathfrak m)$ be a complete local ring.
\begin{enumerate}
\item $R$ has a coefficient ring (see
Definition \ref{definition-coefficient-ring}),
\item if $\mathfrak m$ is a finitely generated ideal, then
$R$ is isomorphic to a quotient
$$
\Lambda[[x_1, \ldots, x_n]]/I
$$
where $\Lambda$ is either a field or a Cohen ring.
\end{enumerate}
\end{theorem}

\begin{proof}
Let us prove a coefficient ring exists.
First we prove this in case the characteristic of the residue field $\kappa$
is zero. Namely, in this case we will prove by induction
on $n > 0$ that there exists a section
$$
\varphi_n : \kappa \longrightarrow R/\mathfrak m^n 
$$
to the canonical map $R/\mathfrak m^n \to \kappa = R/\mathfrak m$.
This is trivial for $n = 1$. If $n > 1$, let $\varphi_{n - 1}$ be given.
The field extension $\mathbf{Q} \subset \kappa$ is formally smooth by
Proposition \ref{proposition-characterize-separable-field-extensions}.
Hence we can find the dotted arrow
in the following diagram
$$
\xymatrix{
R/\mathfrak m^{n - 1} &
R/\mathfrak m^n \ar[l] \\
\kappa \ar[u]^{\varphi_{n - 1}} \ar@{..>}[ru] & \mathbf{Q} \ar[l] \ar[u]
}
$$
This proves the induction step. Putting these maps together
$$
\lim\nolimits_n\ \varphi_n : \kappa \longrightarrow
R = \lim\nolimits_n\ R/\mathfrak m^n
$$
gives a map whose image is the desired coefficient ring.

\medskip\noindent
Next, we prove the existence of a coefficient ring in the case
where the characteristic of the residue field $\kappa$ is $p > 0$.
Namely, choose a Cohen ring $\Lambda$ with $\kappa = \Lambda/p\Lambda$,
see Lemma \ref{lemma-cohen-rings-exist}. In this case we will prove by
induction on $n > 0$ that there exists a map
$$
\varphi_n :
\Lambda/p^n\Lambda
\longrightarrow
R/\mathfrak m^n 
$$
whose composition with the reduction map $R/\mathfrak m^n \to \kappa$
produces the given isomorphism $\Lambda/p\Lambda = \kappa$. This is trivial
for $n = 1$. If $n > 1$, let $\varphi_{n - 1}$ be given.
The ring map $\mathbf{Z}/p^n\mathbf{Z} \to \Lambda/p^n\Lambda$
is formally smooth by Lemma \ref{lemma-cohen-ring-formally-smooth}.
Hence we can find the dotted arrow
in the following diagram
$$
\xymatrix{
R/\mathfrak m^{n - 1} &
R/\mathfrak m^n \ar[l] \\
\Lambda/p^n\Lambda \ar[u]^{\varphi_{n - 1}} \ar@{..>}[ru] &
\mathbf{Z}/p^n\mathbf{Z} \ar[l] \ar[u]
}
$$
This proves the induction step. Putting these maps together
$$
\lim\nolimits_n\ \varphi_n :
\Lambda = \lim\nolimits_n\ \Lambda/p^n\Lambda
\longrightarrow
R = \lim\nolimits_n\ R/\mathfrak m^n
$$
gives a map whose image is the desired coefficient ring.

\medskip\noindent
The final statement of the theorem is now clear. Namely, if
$y_1, \ldots, y_n$ are generators of the ideal $\mathfrak m$,
then we can use the map $\Lambda \to R$ just constructed
to get a map
$$
\Lambda[[x_1, \ldots, x_n]] \longrightarrow R,
\quad x_i \longmapsto y_i.
$$
This map is surjective on each $R/\mathfrak m^n$ and hence
is surjective as $R$ is complete. Some details omitted.
\end{proof}

\begin{lemma}
\label{lemma-complete-local-ring-Noetherian}
Let $(R, \mathfrak m)$ be a complete local ring.
If $\mathfrak m$ is a finitely generated ideal then
$R$ is Noetherian.
\end{lemma}

\begin{proof}
A field is Noetherian, and a Cohen ring $\Lambda$ is Noetherian since
it is a discrete valuation ring. Hence the ring $\Lambda[[x_1, \ldots, x_n]]$
is Noetherian by Lemma \ref{lemma-Noetherian-power-series}.
Thus the lemma follows from the Cohen
structure theorem \ref{theorem-cohen-structure-theorem}.
\end{proof}

\begin{remark}
\label{remark-Noetherian-complete-local-ring-universally-catenary}
If $k$ is a field then the power series ring $k[[X_1, \ldots, X_d]]$
is a Noetherian complete local regular ring of dimension $d$.
If $\Lambda$ is a Cohen ring then $\Lambda[[X_1, \ldots, X_d]]$
is a complete local Noetherian regular ring of dimension $d + 1$.
Hence the Cohen structure theorem implies that any Noetherian
complete local ring is a quotient of a regular local ring.
In particular we see that a Noetherian complete local ring is
universally catenary, see Lemma \ref{lemma-CM-ring-catenary}
and Lemma \ref{lemma-regular-ring-CM}.
\end{remark}

\begin{lemma}
\label{lemma-complete-local-Noetherian-domain-finite-over-regular}
Let $(R, \mathfrak m)$ be a complete local ring.
If $R$ is Noetherian and a domain, then there exists a
Noetherian regular local subring $R_0 \subset R$ such that $R$ is
finite over $R_0$. In fact $R_0$ can be chosen to be isomorphic
to either $k[[X_1, \ldots, X_d]]$ where $k$ is a field or
$\Lambda[[X_1, \ldots, X_d]]$ where $\Lambda$ is a Cohen ring.
\end{lemma}

\begin{proof}
Let $\Lambda$ be a coefficient ring of $R$.
Since $R$ is a domain we see that either $\Lambda$ is a field
or $\Lambda$ is a Cohen ring.

\medskip\noindent
Case I: $\Lambda = k$ is a field. Let $d = \dim(R)$.
Choose $x_1, \ldots, x_d \in \mathfrak m$
which generate an ideal of definition $I \subset R$.
(See Section \ref{section-dimension}.)
By Lemma \ref{lemma-change-ideal-completion} we see that $R$
is $I$-adically complete as well.
Consider the map $R_0 = k[[X_1, \ldots, X_d]] \to R$
which maps $X_i$ to $x_i$.
Note that $R_0$ is complete with respect to the ideal
$I_0 = (X_1, \ldots, X_d)$,
and that $R/I_0R \cong R/IR$ is finite over $k = R_0/I_0$
(because $\dim(R/I) = 0$, see Section \ref{section-dimension}.)
Hence we conclude that $R_0 \to R$ is finite by
Lemma \ref{lemma-finite-over-complete-ring}.
Since $\dim(R) = \dim(R_0)$ this implies that
$R_0 \to R$ is injective (see Lemma \ref{lemma-integral-dim-up}),
and the lemma is proved.

\medskip\noindent
Case II: $\Lambda$ is a Cohen ring. Let $d + 1 = \dim(R)$.
Let $p > 0$ be the characteristic of the residue field $k$.
As $R$ is a domain we see that $p$ is a nonzero divisor in $R$.
Hence $\dim(R/pR) = d$, see Lemma \ref{lemma-one-equation}.
Choose $x_1, \ldots, x_d \in R$
which generate an ideal of definition in $R/pR$.
Then $I = (p, x_1, \ldots, x_d)$ is an ideal of definition of $R$.
By Lemma \ref{lemma-change-ideal-completion} we see that $R$
is $I$-adically complete as well.
Consider the map $R_0 = \Lambda[[X_1, \ldots, X_d]] \to R$
which maps $X_i$ to $x_i$.
Note that $R_0$ is complete with respect to the ideal
$I_0 = (p, X_1, \ldots, X_d)$,
and that $R/I_0R \cong R/IR$ is finite over $k = R_0/I_0$
(because $\dim(R/I) = 0$, see Section \ref{section-dimension}.)
Hence we conclude that $R_0 \to R$ is finite by
Lemma \ref{lemma-finite-over-complete-ring}.
Since $\dim(R) = \dim(R_0)$ this implies that
$R_0 \to R$ is injective (see Lemma \ref{lemma-integral-dim-up}),
and the lemma is proved.
\end{proof}





\section{Nagata and Japanese rings}
\label{section-nagata}

\noindent
In this section we discuss finiteness of integral closure.
It turns out that this is closely related to the relationship
between a local ring and its completion.

\begin{definition}
\label{definition-N}
Let $R$ be a a domain with field of fractions $K$.
\begin{enumerate}
\item We say $R$ is {\it N-1} if the integral closure of $R$ in $K$
is a finite $R$-module.
\item We say $R$ is {\it N-2}, or {\it Japanese} if for any finite
extension $K \subset L$ of fields the integral closure of $R$ in $L$
is finite over $R$.
\end{enumerate}
\end{definition}

\noindent
The main interest in these notions is for Noetherian rings,
but here is a non-Noetherian example.

\begin{example}
\label{example-Japanese-not-Noetherian}
Let $k$ be a field. The domain $R = k[x_1, x_2, x_3, \ldots]$ is Japanese,
but not Noetherian. The reason is the following. Suppose that $R \subset L$
and the field $L$ is a finite extension of the fraction field of $R$.
Then there exists an integer $n$ such that $L$ comes from a finite
extension $k(x_1, \ldots, x_n) \subset L_0$ by adjoining
the (transcendental) elements $x_{n + 1}, x_{n + 2}$, etc.
Let $S_0$ be the integral
closure of $k[x_1, \ldots, x_n]$ in $L_0$. By
Proposition \ref{proposition-ubiquity-nagata} below
it is true that $S_0$ is finite over $k[x_1, \ldots, x_n]$.
Moreover, the integral closure of $R$ in $L$ is
$S = S_0[x_{n + 1}, x_{n + 2}, \ldots]$ (use
Lemma \ref{lemma-polynomial-domain-normal}) and
hence finite over $R$. The same argument works for
$R = \mathbf{Z}[x_1, x_2, x_3, \ldots]$.
\end{example}

\begin{lemma}
\label{lemma-localize-N}
Let $R$ be a domain.
If $R$ is N-1 then so is any localization of $R$.
Same for N-2.
\end{lemma}

\begin{proof}
These statements hold because taking integral closure commutes
with localization, see Lemma \ref{lemma-integral-closure-localize}.
\end{proof}

\begin{lemma}
\label{lemma-Japanese-local}
Let $R$ be a domain. Let $f_1, \ldots, f_n \in R$ generate the
unit ideal. If each domain $R_{f_i}$ is N-1 then so is $R$.
Same for N-2.
\end{lemma}

\begin{proof}
Assume $R_{f_i}$ is N-2 (or N-1).
Let $L$ be a finite extension of the fraction field of $R$ (equal to
the fraction field in the N-1 case). Let $S$ be the integral
closure of $R$ in $L$. By Lemma \ref{lemma-integral-closure-localize}
we see that $S_{f_i}$ is the integral closure of $R_{f_i}$ in $L$.
Hence $S_{f_i}$ is finite over $R_{f_i}$ by assumption.
Thus $S$ is finite over $R$ by Lemma \ref{lemma-cover}.
\end{proof}

\begin{lemma}
\label{lemma-quasi-finite-over-Noetherian-japanese}
Let $R$ be a domain.
Let $R \subset S$ be a quasi-finite extension of domains
(for example finite).
Assume $R$ is N-2 and Noetherian.
Then $S$ is N-2.
\end{lemma}

\begin{proof}
Let $K = f.f.(R) \subset L = f.f.(S)$. Note that this is
a finite field extension (for example by
Lemma \ref{lemma-isolated-point-fibre} (3) applied
to the fibre $S \otimes_R K$, and the definition of a
quasi-finite ring map).
Let $S'$ be the integral closure of $R$ in $S$.
Then $S'$ is contained in the integral closure of $R$ in $L$
which is finite over $R$ by assumption. As $R$ is Noetherian this
implies $S'$ is finite over $R$.
By Lemma \ref{lemma-quasi-finite-open-integral-closure}
there exist elements $g_1, \ldots, g_n \in S'$
such that $S'_{g_i} \cong S_{g_i}$ and such that $g_1, \ldots, g_n$
generate the unit ideal in $S$. Hence it suffices to show that
$S'$ is N-2 by Lemmas \ref{lemma-localize-N} and \ref{lemma-Japanese-local}.
Thus we have reduced to the case where $S$ is finite over $R$.

\medskip\noindent
Assume $R \subset S$ with hypotheses as in the lemma and moreover
that $S$ is finite over $R$. Let $M$ be a finite field extension
of the fraction field of $S$. Then $M$ is also a finite field extension
of $f.f(R)$ and we conclude that the integral closure $T$ of $R$ in
$M$ is finite over $R$. By Lemma \ref{lemma-integral-closure-transitive}
we see that $T$ is also the integral closure of $S$ in $M$ and we win by
Lemma \ref{lemma-integral-permanence}.
\end{proof}

\begin{lemma}
\label{lemma-Laurent-ring-N-1}
Let $R$ be a Noetherian domain.
If $R[z, z^{-1}]$ is N-1, then so is $R$.
\end{lemma}

\begin{proof}
Let $R'$ be the integral closure of $R$ in its field of fractions $K$.
Let $S'$ be the integral closure of $R[z, z^{-1}]$ in its field of fractions.
Clearly $R' \subset S'$. 
Since $K[z, z^{-1}]$ is a normal domain we see that $S' \subset K[z, z^{-1}]$.
Suppose that $f_1, \ldots, f_n \in S'$ generate $S'$ as $R[z, z^{-1}]$-module.
Say $f_i = \sum a_{ij}z^j$ (finite sum), with $a_{ij} \in K$.
For any $x \in R'$ we can write
$$
x = \sum h_i f_i
$$
with $h_i \in R[z, z^{-1}]$. Thus we see that $R'$ is contained in the
finite $R$-submodule $\sum Ra_{ij} \subset K$. Since $R$ is Noetherian
we conclude that $R'$ is a finite $R$-module.
\end{proof}

\begin{lemma}
\label{lemma-finite-extesion-N-2}
Let $R$ be a Noetherian domain, and let $R \subset S$ be a
finite extension of domains. If $S$ is N-1, then so is $R$.
If $S$ is N-2, then so is $R$.
\end{lemma}

\begin{proof}
Omitted. (Hint: Integral closures of $R$ in extension fields
are contained in inegral closures of $S$ in extension fields.)
\end{proof}

\begin{lemma}
\label{lemma-Noetherian-normal-domain-finite-separable-extension}
Let $R$ be a Noetherian normal domain with fraction field $K$.
Let $K \subset L$ be a finite separable field extension.
Then the integral closure of $R$ in $L$ is finite over $R$.
\end{lemma}

\begin{proof}
Consider the trace pairing
$$
L \times L \longrightarrow K,
\quad (x, y) \longmapsto \langle x, y\rangle := \text{Tr}_{L/K}(xy).
$$
Since $L/K$ is separable this is nondegenerate (exercise in Galois theory).
Moreover, if $x \in L$ is integral over $R$, then
$\text{Tr}_{L/K}(x)$ is integral over $R$ also, and since $R$ is
normal we see $\text{Tr}_{L/K}(x) \in R$.
Pick $x_1, \ldots, x_n \in L$ which are integral over $R$
and which form a $K$-basis of $L$. Then the integral closure
$S \subset L$ is contained in the $R$-module
$$
M = \{y \in L \mid \langle x_i, y\rangle \in R,\ i = 1, \ldots, n\}
$$
By linear algebra we see that $M \cong R^{\oplus n}$ as an $R$-module.
Hence $S \subset R^{\oplus n}$ is a finitely generated $R$-module
as $R$ is Noetherian.
\end{proof}

\begin{example}
\label{example-bad-invariants}
Lemma \ref{lemma-Noetherian-normal-domain-finite-separable-extension}
does not work if the ring is not Noetherian.
For example consider the action of $G = \{+1, -1\}$ on
$A = \mathbf{C}[x_1, x_2, x_3, \ldots]$ where $-1$ acts by
mapping $x_i$ to $-x_i$. The invariant ring $R = A^G$ is
the $\mathbf{C}$-algebra generated by all $x_ix_j$. Hence
$R \subset A$ is not finite. But $R$ is a normal domain
with fraction field $K = L^G$ the $G$-invariants in the fraction field
$L$ of $A$. And clearly $A$ is the integral closure of $R$ in
$L$.
\end{example}

\begin{lemma}
\label{lemma-domain-char-zero-N-1-2}
A Noetherian domain of characteristic zero is N-1 if and only if
it is N-2 (i.e., Japanese).
\end{lemma}

\begin{proof}
This is clear from
Lemma \ref{lemma-Noetherian-normal-domain-finite-separable-extension}
since every field extension in characteristic zero is separable.
\end{proof}

\begin{lemma}
\label{lemma-domain-char-p-N-1-2}
Let $R$ be a Noetherian domain with fraction field $K$ of
characteristic $p > 0$. Then $R$ is Japanese if and only if
for every finite purely inseparable extension $K \subset L$ the integral
closure of $R$ in $L$ is finite over $R$.
\end{lemma}

\begin{proof}
Assume the integral closure of $R$ in every finite purely inseparable
field extension of $K$ is finite.
Let $K \subset L$ be any finite extension. We have to show the
integral closure of $R$ in $L$ is finite over $R$.
Choose a finite normal field extension $K \subset M$
containing $L$. As $R$ is Noetherian it suffices to show that
the integral closure of $R$ in $M$ is finite over $R$.
By Lemma \ref{lemma-normal-case}
there exists a subextension $K \subset M_{insep} \subset M$
such that $M_{insep}/K$ is purely inseparable, and $M/M_{insep}$
is separable. By assumption the integral closure $R'$ of $R$ in
$M_{insep}$ is finite over $R$. By
Lemma \ref{lemma-Noetherian-normal-domain-finite-separable-extension}
the integral
closure $R''$ of $R'$ in $M$ is finite over $R'$. Then $R''$ is finite
over $R$ by Lemma \ref{lemma-finite-transitive}.
Since $R''$ is also the integral closure
of $R$ in $M$ (see Lemma \ref{lemma-integral-closure-transitive}) we win.
\end{proof}

\begin{lemma}
\label{lemma-polynomial-ring-N-2}
Let $R$ be a Noetherian domain.
If $R$ is N-1 then $R[x]$ is N-1.
If $R$ is N-2 then $R[x]$ is N-2.
\end{lemma}

\begin{proof}
Assume $R$ is N-1. Let $R'$ be the integral closure of $R$
which is finite over $R$. Hence also $R'[x]$ is finite over
$R[x]$. The ring $R'[x]$ is normal (see
Lemma \ref{lemma-polynomial-domain-normal}), hence N-1.
This proves the first assertion.

\medskip\noindent
For the second assertion, by Lemma \ref{lemma-finite-extesion-N-2}
it suffices to show that $R'[x]$ is N-2. In other words we may
and do assume that $R$ is a normal N-2 domain. In characteristic zero
we are done by Lemma \ref{lemma-domain-char-zero-N-1-2}.
In characteristic $p > 0$ we have to show that the integral
closure of $R[x]$ is finite in any finite purely inseparable extension
of $f.f.(R[x]) = K(x) \subset L$ with $K = f.f.(R)$. Clearly there
exists a finite purely inseparable field extension $K \subset L'$
and $q = p^e$ such that $L \subset L'(x^{1/q})$. As $R[x]$ is
Noetherian it suffices to show that the integral closure of $R[x]$
in $L'(x^{1/q})$ is finite over $R[x]$. And this integral closure
is equal to $R'[x^{1/q}]$ with $R \subset R' \subset L'$ the inrtegral
closure of $R$ in $L'$.
Since $R$ is N-2 we see that $R'$ is finite over $R$ and hence
$R'[x^{1/q}]$ is finite over $R[x]$.
\end{proof}

\begin{lemma}
\label{lemma-tate-japanese}
(Tate)
Let $R$ be a ring.
Let $x \in R$.
Assume
\begin{enumerate}
\item $R$ is a normal Noetherian domain,
\item $R/xR$ is a Japanese domain,
\item $R \cong \lim_n R/x^nR$ is complete with respect to $x$.
\end{enumerate}
Then $R$ is Japanese.
\end{lemma}

\begin{proof}
We may assume $x \not = 0$ since otherwise the lemma is trivial.
Let $K$ be the fraction field of $R$. If the characteristic of $K$
is zero the lemma follows from (1), see
Lemma \ref{lemma-domain-char-zero-N-1-2}. Hence we may assume
that the characteristic of $K$ is $p > 0$, and we may apply
Lemma \ref{lemma-domain-char-p-N-1-2}. Thus given $K \subset L$
be a finite purely inseparable field extension we have to show
that the integral closure $S$ of $R$ in $L$ is finite over $R$.

\medskip\noindent
Let $q$ be a power of $p$ such that $L^q \subset K$.
By enlarging $L$ if necessary we may assume there exists
an element $y \in L$ such that $y^q = x$. Since $R \to S$
induces a homeomorphism of spectra (see Lemma \ref{lemma-p-ring-map})
there is a unique prime ideal $\mathfrak q \subset S$ lying
over the prime ideal $\mathfrak p = xR$. It is clear that
$$
\mathfrak q = \{f \in S \mid f^q \in \mathfrak p\} = yS
$$
since $y^q = x$. Hence $R_{\mathfrak p}$ and $S_{\mathfrak q}$
are discrete valuation rings, see Lemma \ref{lemma-characterize-dvr}.
By Lemma \ref{lemma-finite-extension-residue-fields-dimension-1} we
see that $\kappa(\mathfrak p) \subset \kappa(\mathfrak q)$ is
a finite field extension. Hence the integral closure
$S' \subset \kappa(\mathfrak q)$ of $R/xR$ is finite over
$R/xR$ by assumption (2). Since $S/yS \subset S'$ this implies
that $S/yS$ is finite over $R$. Note that $S/y^nS$ has a finite
filtration whose subquotients are the modules
$y^iS/y^{i + 1}S \cong S/yS$. Hence we see that each $S/y^nS$
is finite over $R$. In particular $S/xS$ is finite over $R$.
Also, it is clear that $\bigcap x^nS = (0)$ since an element
in the intersection has $q$th power contained in $\bigcap x^nR = (0)$
(Lemma \ref{lemma-intersect-powers-ideal-module-zero}).
Thus we may apply Lemma \ref{lemma-finite-over-complete-ring} to conclude
that $S$ is finite over $R$, and we win.
\end{proof}

\begin{lemma}
\label{lemma-power-series-over-N-2}
Let $R$ be a ring.
If $R$ is Noetherian, a domain, and N-2, then so is $R[[x]]$.
\end{lemma}

\begin{proof}
Apply Lemma \ref{lemma-tate-japanese} to the element $x \in R[[x]]$.
\end{proof}

\begin{definition}
\label{definition-nagata}
Let $R$ be a ring.
\begin{enumerate}
\item We say $R$ is {\it universally Japanese} if for any finite
type ring map $R \to S$ with $S$ a domain we have that $S$ is
Japanese (i.e., N-2).
\item We say that $R$ is a {\it Nagata ring} if $R$ is Noetherian and
for every prime ideal $\mathfrak p$ the ring $R/\mathfrak p$ is Japanese.
\end{enumerate}
\end{definition}

\noindent
It is clear that a Noetherian universally Japanese ring is a Nagata ring.
It is our goal to show that a Nagata ring is universally Japanese. This is
not obvious at all, and requires some work. But first, here is a useful
lemma.

\begin{lemma}
\label{lemma-nagata-in-reduced-finite-type-finite-integral-closure}
Let $R$ be a Nagata ring.
Let $R \to S$ be essentially of finite type with $S$ reduced.
Then the integral closure of $R$ in $S$ is finite over $R$.
\end{lemma}

\begin{proof}
As $S$ is essentially of finite type over $R$ it is Noetherian and
has finitely many minimal primes $\mathfrak q_1, \ldots, \mathfrak q_m$,
see Lemma \ref{lemma-Noetherian-irreducible-components}.
Since $S$ is reduced we have $S \subset \prod S_{\mathfrak q_i}$
and each $S_{\mathfrak q_i} = K_i$ is a field, see
Lemmas \ref{lemma-total-ring-fractions-no-embedded-points}
and \ref{lemma-minimal-prime-reduced-ring}.
It suffices to show that the integral closure
$A_i'$ of $R$ in each $K_i$ is finite over $R$.
This is true because $R$ is Noetherian and $A \subset \prod A_i'$.
Let $\mathfrak p_i \subset R$ be the prime of $R$
corresponding to $\mathfrak q_i$.
As $S$ is essentially of finite type over $R$ we see that
$K_i = S_{\mathfrak q_i} = \kappa(\mathfrak q_i)$ is a finitely
generated field extension of $\kappa(\mathfrak p_i)$. Hence the algebraic
closure $L_i$ of $\kappa(\mathfrak p_i)$ in $\subset K_i$
is finite over $\kappa(\mathfrak p_i)$, see
Lemma \ref{lemma-algebraic-closure-in-finitely-generated}.
It is clear that $A_i'$ is the integral closure of $R/\mathfrak p_i$
in $L_i$, and hence we win by definition of a Nagata ring.
\end{proof}

\begin{lemma}
\label{lemma-check-universally-japanese}
Let $R$ be a ring.
To check that $R$ is universally Japanese it suffices to show:
If $R \to S$ is of finite type, and $S$ a domain then $S$ is N-1.
\end{lemma}

\begin{proof}
Namely, assume the condition of the lemma.
Let $R \to S$ be a finite type ring map with $S$ a domain.
Let $f.f.(S) \subset L$ be a finite extension of its fraction field.
Then there exists a finite ring extension $S \subset S' \subset L$
with $f.f.(S') = L$. By assumption $S'$ is N-1, and hence the integral
closure $S''$ of $S'$ in $L$ is finite over $S'$. Thus $S''$ is finite
over $S$ (Lemma \ref{lemma-finite-transitive})
and $S''$ is the integral closure of $S$ in $L$
(Lemma \ref{lemma-integral-closure-transitive}).
We conclude that $R$ is universally Japanese.
\end{proof}

\begin{lemma}
\label{lemma-universally-japanese}
If $R$ is universally Japanese then any algebra essentially of finite type
over $R$ is universally Japanese.
\end{lemma}

\begin{proof}
The case of an algebra of finite type over $R$ is immediate from
the definition. The general case follows on applying
Lemma \ref{lemma-localize-N}.
\end{proof}

\begin{lemma}
\label{lemma-quasi-finite-over-nagata}
Let $R$ be a Nagata ring.
If $R \to S$ is a quasi-finite ring map (for example finite)
then $S$ is a Nagata ring also.
\end{lemma}

\begin{proof}
First note that $S$ is Noetherian as $R$ is Noetherian and a quasi-finite
ring map is of finite type.
Let $\mathfrak q \subset S$ be a prime ideal, and set
$\mathfrak p = R \cap \mathfrak q$. Then
$R/\mathfrak p \subset S/\mathfrak q$ is quasi-finite and
hence we conclude that $S/\mathfrak q$ is N-2 by
Lemma \ref{lemma-quasi-finite-over-Noetherian-japanese}
as desired.
\end{proof}

\begin{lemma}
\label{lemma-nagata-localize}
A localization of a Nagata ring is a Nagata ring.
\end{lemma}

\begin{proof}
Clear from Lemma \ref{lemma-localize-N}.
\end{proof}

\begin{lemma}
\label{lemma-nagata-local}
Let $R$ be a ring. Let $f_1, \ldots, f_n \in R$ generate the
unit ideal.
\begin{enumerate}
\item  If each $R_{f_i}$ is universally Japanese then so is $R$.
\item  If each $R_{f_i}$ is Nagata then so is $R$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $\varphi : R \to S$ be a finite type ring map so that $S$ is a domain.
Then $\varphi(f_1), \ldots, \varphi(f_n)$ generate the unit ideal
in $S$. Hence if each $S_{f_i} = S_{\varphi(f_i)}$ is N-1 then so is
$S$, see Lemma \ref{lemma-Japanese-local}. This proves (1).

\medskip\noindent
If each $R_{f_i}$ is Nagata, then each $R_{f_i}$ is Noetherian and
hence $R$ is Noetherian, see Lemma \ref{lemma-cover}. And if
$\mathfrak p \subset R$ is a prime, then we see each
$R_{f_i}/\mathfrak pR_{f_i} = (R/\mathfrak p)_{f_i}$ is Japanese
and hence we conclude $R/\mathfrak p$ is Japanese by
Lemma \ref{lemma-Japanese-local}. This proves (2).
\end{proof}

\begin{lemma}
\label{lemma-Noetherian-complete-local-Nagata}
A Noetherian complete local ring is a Nagata ring.
\end{lemma}

\begin{proof}
Let $R$ be a complete local Noetherian ring.
Let $\mathfrak p \subset R$ be a prime.
Then $R/\mathfrak p$ is also a complete local Noetherian ring,
see Lemma \ref{lemma-quotient-complete-local}.
Hence it suffices to show that a Noetherian complete local
domain $R$ is N-2. By
Lemmas \ref{lemma-quasi-finite-over-Noetherian-japanese}
and \ref{lemma-complete-local-Noetherian-domain-finite-over-regular}
we reduce to the case $R = k[[X_1, \ldots, X_d]]$ where $k$ is a field or
$R = \Lambda[[X_1, \ldots, X_d]]$ where $\Lambda$ is a Cohen ring.

\medskip\noindent
In the case $k[[X_1, \ldots, X_d]]$ we reduce to the statement that a
field is N-2 by Lemma \ref{lemma-power-series-over-N-2}. This is clear.
In the case $\Lambda[[X_1, \ldots, X_d]]$ we reduce to the statement
that a Cohen ring $\Lambda$ is N-2. Applying Lemma \ref{lemma-tate-japanese}
once more with $x = p \in \Lambda$ we reduce yet again to the case
of a field. Thus we win.
\end{proof}

\begin{definition}
\label{definition-analytically-unramified}
Let $(R, \mathfrak m)$ be a Noetherian local ring.
We say $R$ is {\it analytically unramified} if its completion
$R^\wedge = \lim_n R/\mathfrak m^n$ is reduced.
A prime ideal $\mathfrak p \subset R$ is said to be
{\it analytically unramified} if $R/\mathfrak p$ is analytically
unramified.
\end{definition}

\noindent
At this point we know
the following are true for any Noetherian local ring $R$:
The map $R \to R^\wedge$ is a faithfully flat local ring homomorphism
(Lemma \ref{lemma-completion-faithfully-flat}).
The completion $R^\wedge$ is Noetherian
(Lemma \ref{lemma-completion-Noetherian})
and complete (Lemma \ref{lemma-completion-complete}).
Hence the completion $R^\wedge$ is a Nagata ring
(Lemma \ref{lemma-Noetherian-complete-local-Nagata}).
Moreover, we have seen in Section \ref{section-cohen-structure-theorem}
that $R^\wedge$ is
a quotient of a regular local ring
(Theorem \ref{theorem-cohen-structure-theorem}), and hence
universally catenary
(Remark \ref{remark-Noetherian-complete-local-ring-universally-catenary}).

\begin{lemma}
\label{lemma-analytically-unramified-easy}
Let $(R, \mathfrak m)$ be a Noetherian local ring.
\begin{enumerate}
\item If $R$ is analytically unramified, then $R$ is reduced.
\item If $R$ is analytically unramified, then each minimal prime of
$R$ is analytically unramfied.
\item If $R$ is reduced with minimal primes
$\mathfrak q_1, \ldots, \mathfrak q_t$, and each $\mathfrak q_i$
is analytically unramified, then $R$ is analytically unramified.
\item If $R$ is analytically unramified, then the integral closure
of $R$ in its total ring of fractions $Q(R)$ is finite over $R$.
\item If $R$ is a domain and analytically unramified, then $R$ is N-1.
\end{enumerate}
\end{lemma}

\begin{proof}
In this proof we will use the remarks immediately following
Definition \ref{definition-analytically-unramified}.
As $R \to R^\wedge$ is a faithfully flat local ring homomorphism
it is injective and (1) follows.

\medskip\noindent
Let $\mathfrak q$ be a minimal prime of $R$, and assume $R$ is
analytically unramified.
Then $\mathfrak q$ is an associated
prime of $R$ (see Lemma \ref{proposition-minimal-primes-associated-primes}).
Hence there exists an $f \in R$
such that $\{x \in R \mid fx = 0\} = \mathfrak q$.
Note that $(R/\mathfrak q)^\wedge = R^\wedge/\mathfrak q^\wedge$,
and that $\{x \in R^\wedge \mid fx = 0\} = \mathfrak q^\wedge$,
because completion is exact (Lemma \ref{lemma-completion-flat}).
If $x \in R^\wedge$ is such
that $x^2 \in \mathfrak q^\wedge$, then $fx^2 = 0$ hence
$(fx)^2 = 0$ hence $fx = 0$ hence $x \in \mathfrak q^\wedge$.
Thus $\mathfrak q$ is analytically unramified and (2) holds.

\medskip\noindent
Assume $R$ is reduced with minimal primes
$\mathfrak q_1, \ldots, \mathfrak q_t$, and each $\mathfrak q_i$
is analytically unramified. Then
$R \to R/\mathfrak q_1 \times \ldots \times R/\mathfrak q_t$ is
injective. Since completion is exact (see Lemma \ref{lemma-completion-flat})
we see that
$R^\wedge \subset (R/\mathfrak q_1)^\wedge \times \ldots \times
(R/\mathfrak q_t)^\wedge$. Hence (3) is clear.

\medskip\noindent
Assume $R$ is analytically unramified.
Let $\mathfrak p_1, \ldots, \mathfrak p_s$ be the minimal primes
of $R^\wedge$. Then we see that
$$
Q(R^\wedge) = R_{\mathfrak p_1} \times \ldots \times R_{\mathfrak p_s}
$$
with each $R_{\mathfrak p_i}$ a field
as $R^\wedge$ is reduced (see
Lemma \ref{lemma-total-ring-fractions-no-embedded-points}).
Hence the integral closure $S$ of $R^\wedge$
in $Q(R^\wedge)$ is equal to $S = S_1 \times \ldots \times S_s$ with
$S_i$ the integral closure of $R/\mathfrak p_i$ in its fraction
field. In particular $S$ is finite over $R^\wedge$.
Denote $R'$ the integral closure of $R$ in $Q(R)$.
As $R \to R^\wedge$ is flat we see that
$R' \otimes_R R^\wedge \subset Q(R) \otimes_R R^\wedge \subset Q(R^\wedge)$.
Moreover $R' \otimes_R R^\wedge$ is integral over $R^\wedge$
(Lemma \ref{lemma-base-change-integral}).
Hence $R' \otimes_R R^\wedge \subset S$ is a $R^\wedge$-submodule.
As $R^\wedge$ is Noetherian it is a finite $R^\wedge$-module.
Thus we may find $f_1, \ldots, f_n \in R'$ such that
$R' \otimes_R R^\wedge$ is generated by the elements $f_i \otimes 1$
as a $R^\wedge$-module.
By faithful flatness we see that $R'$ is generated by $f_1, \ldots, f_n$
as an $R$-module. This proves (4).

\medskip\noindent
Part (5) is a special case of part (4).
\end{proof}

\begin{lemma}
\label{lemma-codimension-1-analytically-unramified}
Let $R$ be a Noetherian local ring.
Let $\mathfrak p \subset R$ be a prime.
Assume that
\begin{enumerate}
\item $R_{\mathfrak p}$ is a discrete valuation ring,
\item $\mathfrak p$ is analytically unramified.
\end{enumerate}
Then for any associated prime $\mathfrak q$ of $R^\wedge/\mathfrak pR^\wedge$
the local ring $(R^\wedge)_{\mathfrak q}$ is a discrete valuation ring.
\end{lemma}

\begin{proof}
Assumption (2) says that $R^\wedge/\mathfrak pR^\wedge$ is a reduced ring.
Hence an associated prime $\mathfrak q \subset R^\wedge$
of $R^\wedge/\mathfrak pR^\wedge$
is the same thing as a minimal prime over $\mathfrak pR^\wedge$.
In particular we see that the maximal ideal of $(R^\wedge)_{\mathfrak q}$
is $\mathfrak p(R^\wedge)_{\mathfrak q}$.
Choose $x \in R$ such that $xR_{\mathfrak p} = \mathfrak pR_{\mathfrak p}$.
By the above we see that $x \in (R^\wedge)_{\mathfrak q}$ generates
the maximal ideal. As $R \to R^\wedge$ is faithfully flat we see that
$x$ is a nonzero divisor in $(R^\wedge)_{\mathfrak q}$.
Hence we win.
\end{proof}

\begin{lemma}
\label{lemma-criterion-analytically-unramified}
Let $(R, \mathfrak m)$ be a Noetherian local domain.
Let $x \in \mathfrak m$. Assume that
\begin{enumerate}
\item $x \not = 0$,
\item $R/xR$ has no embedded primes,
\item for each associated prime $\mathfrak p \subset R$
of $R/xR$ we have
\begin{enumerate}
\item the local ring $R_{\mathfrak p}$ is regular, and
\item $\mathfrak p$ is analytically unramified.
\end{enumerate}
\end{enumerate}
Then $R$ is analytically unramified.
\end{lemma}

\begin{proof}
Let $\mathfrak p_1, \ldots, \mathfrak p_t$ be the associated primes
of the $R$-module $R/xR$. Since $R/xR$ has no embedded primes we
see that each $\mathfrak p_i$ has height $1$, and is a minimal
prime over $(x)$.
For each $i$, let $\mathfrak q_{i1}, \ldots, \mathfrak q_{is_i}$
be the associated primes of the $R^\wedge$-module
$R^\wedge/\mathfrak p_iR^\wedge$.
By Lemma \ref{lemma-codimension-1-analytically-unramified}.
we see that $(R^\wedge)_{\mathfrak q_{ij}}$ is regular.
By Lemma \ref{lemma-bourbaki} we see that
$$
\text{Ass}_{R^\wedge}(R^\wedge/xR^\wedge)
=
\bigcup\nolimits_{\mathfrak p \in \text{Ass}_R(R/xR)}
\text{Ass}_{R^\wedge}(R^\wedge/\mathfrak pR^\wedge)
=
\{\mathfrak q_{ij}\}.
$$
Let $y \in R^\wedge$ with $y^2 = 0$.
As $(R^\wedge)_{\mathfrak q_{ij}}$ is regular, and hence a domain
(Lemma \ref{lemma-regular-domain})
we see that $y$ maps to zero in $(R^\wedge)_{\mathfrak q_{ij}}$.
Hence $y$ maps to zero in $R^\wedge/xR^\wedge$ by
Lemma \ref{lemma-zero-at-ass-zero}.
Hence $y = xy'$. Since $x$ is a nonzero divisor (as $R \to R^\wedge$ is flat)
we see that $(y')^2 = 0$. Hence we conclude that
$y \in \bigcap x^nR^\wedge = (0)$
(Lemma \ref{lemma-intersect-powers-ideal-module-zero}).
\end{proof}

\begin{lemma}
\label{lemma-local-nagata-domain-analytically-unramified}
Let $(R, \mathfrak m)$ be a local ring.
If $R$ is Noetherian, a domain, and Nagata, then $R$ is
analytically unramified.
\end{lemma}

\begin{proof}
By induction on $\dim(R)$.
The case $\dim(R) = 0$ is trivial. Hence we assume $\dim(R) = d$ and that
the lemma holds for all Noetherian Nagata domains of dimension $< d$.

\medskip\noindent
Let $R \subset S$ be the integral closure
of $R$ in the field of fractions of $R$. By assumption $S$ is a finite
$R$-module. By Lemma \ref{lemma-quasi-finite-over-nagata} we see that
$S$ is Nagata. By Lemma \ref{lemma-integral-sub-dim-equal} we see
$\dim(R) = \dim(S)$.
Let $\mathfrak m_1, \ldots, \mathfrak m_t$ be the maximal
ideals of $S$. Each of these lies over the maximal ideal $\mathfrak m$
of $R$. Moreover
$$
(\mathfrak m_1 \cap \ldots \cap \mathfrak m_t)^n \subset \mathfrak mS 
$$
for sufficiently large $n$ as $S/\mathfrak mS$ is Artinian.
By Lemma \ref{lemma-completion-flat} $R^\wedge \to S^\wedge$
is an injective map, and by the Chinese Remainder
Lemma \ref{lemma-chinese-remainder} combined with
Lemma \ref{lemma-change-ideal-completion} we have
$S^\wedge = \prod S^\wedge_i$ where $S^\wedge_i$
is the completion of $S$ with respect to the maximal ideal $\mathfrak m_i$.
Hence it suffices to show that $S_{\mathfrak m_i}$ is analytically unramified.
In other words, we have reduced to the case where $R$ is a Noetherian
normal Nagata domain.

\medskip\noindent
Assume $R$ is a Noetherian, normal, local Nagata domain.
Pick a nonzero $x \in \mathfrak m$ in the maximal ideal.
We are going to apply Lemma \ref{lemma-criterion-analytically-unramified}.
We have to check properties (1), (2), (3)(a) and (3)(b).
Property (1) is clear.
We have that $R/xR$ has no embedded primes by
Lemma \ref{lemma-normal-domain-intersection-localizations-height-1}.
Thus property (2) holds. The same lemma also tells us each associated
prime $\mathfrak p$ of $R/xR$ has height $1$.
Hence $R_{\mathfrak p}$ is a $1$-dimensional normal domain
hence regular (Lemma \ref{lemma-characterize-dvr}). Thus (3)(a) holds.
Finally (3)(b) holds by induction hypothesis, since
$R/\mathfrak p$ is Nagata (by Lemmma \ref{lemma-quasi-finite-over-nagata}
or directly from the definition).
Thus we conclude $R$ is analytically unramified.
\end{proof}

\begin{lemma}
\label{lemma-openness-normal-locus}
Let $R$ be a Noetherian domain.
If there exists an $f \in R$ such that $R_f$ is normal
then
$$
U = \{\mathfrak p \in \text{Spec}(R) \mid R_{\mathfrak p} \text{ is normal}\}
$$
is open in $\text{Spec}(R)$.
\end{lemma}

\begin{proof}
It is clear that the standard open $D(f)$ is contained in $U$.
By Serre's criterion Lemma \ref{lemma-criterion-normal} we see that
$\mathfrak p \not \in U$ implies that for some
$\mathfrak q \subset \mathfrak p$ we have
either
\begin{enumerate}
\item Case I: $\text{depth}(R_{\mathfrak q}) < 2$
and $\dim(R_{\mathfrak q}) \geq 2$, and
\item Case II: $R_{\mathfrak q}$ is not regular
and $\dim(R_{\mathfrak q}) = 1$.
\end{enumerate}
This in particular also means that $R_{\mathfrak q}$ is not
normal, and hence $f \in \mathfrak q$. In case I we see that
$\text{depth}(R_{\mathfrak q}) =
\text{depth}(R_{\mathfrak q}/fR_{\mathfrak q}) + 1$.
Hence such a prime $\mathfrak q$ is the same thing as an embedded
associated prime of $R/fR$. In case II $\mathfrak q$ is an associated
prime of $R/fR$ of height 1. Thus there is a finite set $E$
of such primes $\mathfrak q$ (see Lemma \ref{lemma-finite-ass}) and
$$
\text{Spec}(R) \setminus U
=
\bigcup\nolimits_{\mathfrak q \in E} V(\mathfrak q)
$$
as desired.
\end{proof}

\begin{lemma}
\label{lemma-characterize-N-1}
Let $R$ be a Noetherian domain.
Assume
\begin{enumerate}
\item there exists a nonzero $f \in R$ such that $R_f$ is normal, and
\item for every maximal ideal $\mathfrak m \subset R$
the local ring $R_{\mathfrak m}$ is N-1.
\end{enumerate}
Then $R$ is N-1.
\end{lemma}

\begin{proof}
Set $K = f.f.(R)$. Suppose that $R \subset R' \subset K$ is a finite
extension of $R$ contained in $K$. Note that $R_f = R'_f$ since
$R_f$ is already normal. Hence by Lemma \ref{lemma-openness-normal-locus}
the set of primes
$\mathfrak p' \in \text{Spec}(R')$ with $R'_{\mathfrak p'}$ non-normal
is closed in $\text{Spec}(R')$. Since $\text{Spec}(R') \to \text{Spec}(R)$
is closed the image of this set is closed in $\text{Spec}(R)$.
For such a ring $R'$ denote $Z_{R'} \subset \text{Spec}(R)$ this image.

\medskip\noindent
Pick a maximal ideal $\mathfrak m \subset R$.
Let $R_{\mathfrak m} \subset R_{\mathfrak m}'$ be the integral
closure of the local ring in $K$. By assumption this is
a finite ring extension. By Lemma \ref{lemma-integral-closure-localize}
we can find finitely
many elements $r_1, \ldots, r_n \in K$ integral over $R$ such that
$R_{\mathfrak m}'$ is generated by $r_1, \ldots, r_n$ over $R_{\mathfrak m}$.
Let $R' = R[x_1, \ldots, x_n] \subset K$. With this choice it is clear
that $\mathfrak m \not \in Z_{R'}$.

\medskip\noindent
As $\text{Spec}(R)$ is quasi-compact, the above shows that we can
find a finite collection $R \subset R'_i \subset K$ such that
$\bigcap Z_{R'_i} = \emptyset$. Let $R'$ be the subring of $K$
generated by all of these. It is finite over $R$. Also $Z_{R'} = \emptyset$.
Namely, every prime $\mathfrak p'$ lies over a prime $\mathfrak p'_i$
such that $(R'_i)_{\mathfrak p'_i}$ is normal. This implies
that $R'_{\mathfrak p'} = (R'_i)_{\mathfrak p'_i}$ is normal too.
Hence $R'$ is normal, in other words
$R'$ is the integral closure of $R$ in $K$.
\end{proof}

\noindent
The following proposition says in particular that an algebra of finite
type over a Nagata ring is a Nagata ring.

\begin{proposition}
\label{proposition-nagata-universally-japanese}
(Nagata) Let $R$ be a ring. The following are equivalent:
\begin{enumerate}
\item $R$ is a Nagata ring,
\item any finite type $R$-algebra is Nagata, and
\item $R$ is universally Japanese and Noetherian.
\end{enumerate}
\end{proposition}

\begin{proof}
It is clear that a Noetherian universally Japanese ring is universally
Nagata (i.e., condition (2) holds). Let $R$ be a Nagata ring.
We will show that any finitely generated $R$-algebra $S$ is Nagata.
This will prove the proposition.

\medskip\noindent
Step 1. There exists a sequence of ring maps
$R = R_0 \to R_1 \to R_2 \to \ldots \to R_n = S$ such that
each $R_i \to R_{i + 1}$ is generated by a single element.
Hence by induction it suffices to prove $S$ is Nagata if
$S \cong R[x]/I$.

\medskip\noindent
Step 2. Let $\mathfrak q \subset S$ be a prime of $S$, and let
$\mathfrak p \subset R$ be the corresponding prime of $R$.
We have to show that $S/\mathfrak q$ is N-2. Hence we have
reduced to the proving the following:
(*) Given a Nagata domain $R$ and a monogenic extension $R \subset S$
of domains then $S$ is N-2.

\medskip\noindent
Step 3. Let $R$ be a Nagata domain and $R \subset S$ a monogenic
extension of domains. Let $R \subset R'$ be the integral closure
of $R$ in its fraction field. Let $S'$ be the subring of
$f.f.(S)$ generated by $R'$ and $S$. As $R'$ is finite over $R$
(by the Nagata property) also $S'$ is finite over $S$.
Since $S$ is Noetherian it suffices to prove that $S'$
is N-2 (Lemma \ref{lemma-finite-extesion-N-2}).
Hence we have reduced to proving the following:
(**) Given a normal Nagata domain $R$ and a
monogenic extension $R \subset S$ of domains then $S$ is N-2.

\medskip\noindent
Step 4: Let $R$ be a normal Nagata domain and
let $R \subset S$ be a monogenic extension of domains.
Suppose the extension of fraction fields $f.f.(R) \subset f.f.(S)$
is purely transcendental. In this case $S = R[x]$. By
Lemma \ref{lemma-polynomial-ring-N-2} we see that $S$ is N-2.
Hence we have reduced to proving the following:
(**) Given a normal Nagata domain $R$ and a
monogenic extension $R \subset S$ of domains
inducing a finite extension of fraction fields
then $S$ is N-2.

\medskip\noindent
Step 5. Let $R$ be a normal Nagata domain and
let $R \subset S$ be a monogenic extension of domains
inducing a finite extension of fraction fields
$K = f.f.(R) \subset f.f.(S) = L$. Choose an element $x \in S$
which generates $S$ as an $R$-algebra. Let $L \subset M$
be a finite extension of fields.
Let $R'$ be the integral closure of $R$ in $M$.
Then the integral closure $S'$ of $S$ in $M$ is equal to the integral
closure of $R'[x]$ in $M$.
Also $f.f.(R') = M$, and $R \subset R'$
is finite (by the Nagata property of $R$).
This implies that $R'$ is a Nagata ring
(Lemma \ref{lemma-quasi-finite-over-nagata}).
To show that $S'$ is finite over $S$ is the same as showing that
$S'$ is finite over $R'[x]$. Replace $R$ by $R'$ and $S$ by $S'$
to reduce to the following statement:
(***) Given a normal Nagata domain $R$ with fraction field $K$,
and $x \in K$, the ring $S \subset K$ generated by $R$ and $x$
is N-1.

\medskip\noindent
Step 6. Let $R$ be a normal Nagata domain with fraction field $K$.
Let $x = b/a \in K$. We have to show that the ring $S \subset K$
generated by $R$ and $x$ is N-1. Note that $S_a \cong R_a$ is normal.
Hence by Lemma \ref{lemma-characterize-N-1} it suffices to show that
$S_{\mathfrak m}$ is N-1 for every maximal ideal $\mathfrak m$ of $S$.

\medskip\noindent
With assumptions as in the preceding paragraph, pick such a maximal
ideal and set $\mathfrak n = R \cap \mathfrak m$. The residue field
extension $\kappa(\mathfrak n) \subset \kappa(\mathfrak m)$ is finite
(Theorem \ref{theorem-nullstellensatz}) and generated by the image of $x$.
Hence there exists a monic polynomial
$f(X) = X^d + \sum_{i = 1, \ldots, d} a_iX^{d -i}$ with
$f(x) \in \mathfrak m$. Let $K \subset K''$ be a finite extension
of fields such that $f(X)$ splits completely in $K''[X]$.
Let $R'$ be the integral closure of $R$ in $K''$.
Let $S' \subset K'$ be the subring generated by $R'$ and $x$.
As $R$ is Nagata we see $R'$ is finite over $R$ and Nagata
(Lemma \ref{lemma-quasi-finite-over-nagata}).
Moreover, $S'$ is finite over $S$. If for every maximal ideal
$\mathfrak m'$ of $S'$ the local ring $S'_{\mathfrak m'}$ is
N-1, then $S'_{\mathfrak m}$ is N-1 by
Lemma \ref{lemma-characterize-N-1}, which in turn
implies that $S_{\mathfrak m}$ is N-1 by
Lemma \ref{lemma-finite-extesion-N-2}.
After replacing $R$ by $R'$ and $S$ by $S'$, and $\mathfrak m$ by
any of the maximal ideals $\mathfrak m'$ lying over $\mathfrak m$
we reach the situation where the polynomial $f$ above split completely:
$f(X) = \prod_{i = 1, \ldots, d} (X - a_i)$ with $a_i \in R$.
Since $f(x) \in \mathfrak m$ we see that $x - a_i \in \mathfrak m$
for some $i$. Finally, after replacing $x$ by $x - a_i$ we may assume
that $x \in \mathfrak m$.

\medskip\noindent
To recapitulate: $R$ is a normal Nagata domain with fraction field $K$,
$x \in K$ and $S$ is the subring of $K$ generated by $x$ and $R$,
finally $\mathfrak m \subset S$ is a maximal ideal with $x \in \mathfrak m$.
We have to show $S_{\mathfrak m}$ is N-1.

\medskip\noindent
We will show that Lemma \ref{lemma-criterion-analytically-unramified}
applies to the local ring
$S_{\mathfrak m}$ and the element $x$. This will imply that
$S_{\mathfrak m}$ is analytically unramified, whereupon we
see that it is N-1 by Lemma \ref{lemma-analytically-unramified-easy}.

\medskip\noindent
We have to check properties (1), (2), (3)(a) and (3)(b).
Property (1) is trivial.
Let $I = \text{Ker}(R[X] \to S)$ where $X \mapsto x$.
We claim that $I$ is generated by all linear forms $aX + b$ such that
$ax = b$ in $K$. Clearly all these linear forms are in $I$.
If $g = a_d X^d + \ldots a_1 X + a_0 \in I$, then we see that
$a_dx$ is integral over $R$ (Lemma \ref{lemma-make-integral-trivial})
and hence $b := a_dx \in R$
as $R$ is normal. Then $g - (a_dX - b)X^{d - 1} \in I$ and we win by
induction on the degree. As a consequence we see that
$$
S/xS = R[X]/(X, I) = R/J
$$
where
$$
J = \{b \in R \mid ax = b \text{ for some }a \in R\} = xR \cap R
$$
By Lemma \ref{lemma-normal-domain-intersection-localizations-height-1}
we see that $S/xS = R/J$ has no embedded primes as an $R$-module, hence as
an $R/J$-module, hence as an $S/xS$-module, hence as an $S$-module.
This proves property (2).
Take such an associated prime $\mathfrak q \subset S$ with the
property $\mathfrak q \subset \mathfrak m$ (so that it is an
associated prime of $S_{\mathfrak m}/xS_{\mathfrak m}$ -- it does not
matter for the arguments).
Then $\mathfrak q$ is minimal over $xS$ and hence has height $1$.
By the sequence of equalities above we see that
$\mathfrak p = R \cap \mathfrak q$ is an associated
prime of $R/J$, and so has height $1$
(see Lemma \ref{lemma-normal-domain-intersection-localizations-height-1}).
Thus $R_{\mathfrak p}$ is a discrete valuation ring and therefore
$R_{\mathfrak p} \subset S_{\mathfrak q}$ is an equality. This shows
that $S_{\mathfrak q}$ is regular. This proves property (3)(a).
Finally, $(S/\mathfrak q)_{\mathfrak m}$ is a localization
of $S/\mathfrak q$, which is a quotient of $S/xS = R/J$.
Hence $(S/\mathfrak q)_{\mathfrak m}$ is a localization of
a quotient of the Nagata ring $R$, hence
Nagata (Lemmas \ref{lemma-quasi-finite-over-nagata}
and \ref{lemma-nagata-localize})
and hence analytically unramified
(Lemma \ref{lemma-local-nagata-domain-analytically-unramified}).
This shows (3)(b) holds and we are done.
\end{proof}

\begin{proposition}
\label{proposition-ubiquity-nagata}
The following types of rings are Nagata and in particular universally Japanese.
\begin{enumerate}
\item fields,
\item Noetherian complete local rings,
\item $\mathbf{Z}$,
\item Dedekind domains with fraction field of characteristic zero,
\item finite type ring extensions of any of the above.
\end{enumerate}
\end{proposition}

\begin{proof}
In each case you just check if $R/\mathfrak p$ is N-2 for every
prime ideal $\mathfrak p$ of the ring. This is clear whenever
$R/\mathfrak p$ is a field, i.e., $\mathfrak p$ is maximal.
Hence for the Dedeking ring case we only need to check it when
$\mathfrak p = (0)$. But since we assume the fraction field has
characteristic zero Lemma \ref{lemma-domain-char-zero-N-1-2} kicks in.
\end{proof}








\section{Ascending properties}
\label{section-ascending-properties}

\noindent
In this section we start proving some algebraic facts concerning the
``ascent'' of properties of rings.

\begin{lemma}
\label{lemma-apply-grothendieck}
Suppose that $R \to S$ is a flat and local ring homomorphism of Noetherian
local rings. Then
$$
\text{depth}_S(S) = \text{depth}_R(R) + \text{depth}_S(S/\mathfrak m_RS).
$$
\end{lemma}

\begin{proof}
Denote $n$ the right hand side of the equality of the lemma.
First assume that $n$ is zero.
Then $\text{depth}(R) = 0$ (resp.\ $\text{depth}(S/\mathfrak m_RS) = 0$)
which means there is a $z \in R$ (resp.\ $\overline{y} \in S/\mathfrak m_RS$)
whose annihilator is $\mathfrak m_R$ (resp.\ $\mathfrak m_S/\mathfrak m_R$).
Let $y \in S$ be a lift of $\overline{y}$.
It follows from the fact that $R \to S$ is flat that the annihilator
of $z$ in $S$ is $\mathfrak m_RS$, and hence the annihilator
of $zy$ is $\mathfrak m_S$. Thus $\text{depth}_S(S) = 0$ as well.

\medskip\noindent
Assume $n > 0$.
If $\text{depth}(S/\mathfrak m_RS) > 0$, then choose
an $f \in \mathfrak m_S$ which maps to a nonzero divisor
in $S/\mathfrak m_RS$. According to Lemma \ref{lemma-grothendieck}
the element $f \in S$ is a nonzero divisor
and $S/fS$ is flat over $R$. Hence by induction on $n$ we have
$$
\text{depth}(S/fS) = \text{depth}(R) + \text{depth}(S/(f, \mathfrak m_R)).
$$
Since $f$ and $\overline{f}$ are nonzero divisors we see that
$\text{depth}(S) = \text{depth}(S/fS) + 1$ and
$\text{depth}(S/\mathfrak m_RS) = \text{depth}(S/(f, \mathfrak m_R)) + 1$,
see Lemma \ref{lemma-depth-in-ses}. Hence we see that the equality holds for
$R \to S$ as well.

\medskip\noindent
If $n > 0$, but $\text{depth}(S/\mathfrak m_RS) = 0$, then choose
$f \in \mathfrak m_R$ a nonzero divisor. As $R \to S$ is flat it is
also the case that $f$ is a nonzero divisor on $S$. By induction on $n$
again we have
$$
\text{depth}(S/fS) = \text{depth}(R/fR) + \text{depth}(S/\mathfrak m_R).
$$
By a similar argument as above we conclude that the equality
holds for $R \to S$ as well.
\end{proof}

\noindent
Here is a more general statement involving modules, see
\cite[IV, Proposition 6.3.1]{EGA}.

\begin{lemma}
\label{lemma-apply-grothendieck-module}
We have
$$
\text{depth}_S(M \otimes_R N)
=
\text{depth}_R(M) + \text{depth}_{S/\mathfrak m_RS}(N/\mathfrak m_RN)
$$
where $R \to S$ is a local homomorphism of local Noetherian rings,
$M$ is a finite $R$-module, and $N$ is a finite $S$-module flat over $R$.
\end{lemma}

\begin{proof}
Omitted, but similar to the proof of Lemma \ref{lemma-apply-grothendieck}.
\end{proof}

\begin{lemma}
\label{lemma-CM-goes-up}
Let $R \to S$ be a local homomorphism of local Noetherian rings.
Assume
\begin{enumerate}
\item $S/\mathfrak m_RS$ is Cohen-Macaulay, and
\item $R \to S$ is flat.
\end{enumerate}
Then $S$ is Cohen-Macaulay if and only if $R$ is Cohen-Macaulay.
\end{lemma}

\begin{proof}
This follows from the definitions combined with
Lemmas \ref{lemma-apply-grothendieck} and
\ref{lemma-dimension-base-fibre-equals-total}.
\end{proof}

\begin{lemma}
\label{lemma-Sk-goes-up}
Let $\varphi : R \to S$ be a ring map. Assume
\begin{enumerate}
\item $R$ is Noetherian,
\item $S$ is Noetherian,
\item $\varphi$ is flat,
\item the fibre rings $S \otimes_R \kappa(\mathfrak p)$ are Cohen-Macaulay, and
\item $R$ has property $(S_k)$.
\end{enumerate}
Then $S$ has property $(S_k)$.
\end{lemma}

\begin{proof}
Let $\mathfrak q$ be a prime of $S$
lying over a prime $\mathfrak p$ of $R$. By
Lemma \ref{lemma-apply-grothendieck} we have
$$
\text{depth}(S_{\mathfrak q}) =
\text{depth}(S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}) +
\text{depth}(R_{\mathfrak p}).
$$
On the other hand, we have
$$
\dim(S_{\mathfrak q})
\leq
\dim(R_{\mathfrak p})
+
\dim(S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}).
$$
by Lemma \ref{lemma-dimension-base-fibre-total}.
(Actually equality holds, by
Lemma \ref{lemma-dimension-base-fibre-equals-total}
but strictly speaking we do not need this.)
Finally, as the fibre rings of the map
are assumed Cohen-Macaulay we see that
$\text{depth}(S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}) =
\dim(S_{\mathfrak q}/\mathfrak pS_{\mathfrak q})$.
Thus the lemma follows by the following string of inequalities
\begin{eqnarray*}
\text{depth}(S_{\mathfrak q}) & = &
\dim(S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}) +
\text{depth}(R_{\mathfrak p}) \\
& \geq &
\dim(S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}) +
\min(k, \dim(R_{\mathfrak p})) \\
& = &
\min(\dim(S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}) + k,
\dim(S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}) +
\dim(R_{\mathfrak p})) \\
& \geq &
\min(k, \dim(S_{\mathfrak q}))
\end{eqnarray*}
as desired.
\end{proof}

\begin{lemma}
\label{lemma-Rk-goes-up}
Let $\varphi : R \to S$ be a ring map. Assume
\begin{enumerate}
\item $R$ is Noetherian,
\item $S$ is Noetherian
\item $\varphi$ is flat,
\item the fibre rings $S \otimes_R \kappa(\mathfrak p)$ are regular, and
\item $R$ has property $(R_k)$.
\end{enumerate}
Then $S$ has property $(R_k)$.
\end{lemma}

\begin{proof}
Let $\mathfrak q$ be a prime of $S$
lying over a prime $\mathfrak p$ of $R$.
Assume that $\dim(S_{\mathfrak q}) \leq k$.
Since $\dim(S_{\mathfrak q}) = \dim(R_{\mathfrak p})
+ \dim(S_{\mathfrak q}/\mathfrak pS_{\mathfrak q})$ by
Lemma \ref{lemma-dimension-base-fibre-equals-total}
we see that $\dim(R_{\mathfrak p}) \leq k$.
Hence $R_{\mathfrak p}$ is regular by assumption.
It follows that $S_{\mathfrak q}$ is regular by
Lemma \ref{lemma-flat-over-regular-with-regular-fibre}.
\end{proof}

\begin{lemma}
\label{lemma-reduced-goes-up}
Let $\varphi : R \to S$ be a ring map. Assume
\begin{enumerate}
\item $\varphi$ is smooth,
\item $R$ is reduced.
\end{enumerate}
Then $S$ is reduced.
\end{lemma}

\begin{proof}
First assume $R$ is Noetherian.
In this case being reduced is the same as having properties
$(S_1)$ and $(R_0)$, see Lemma \ref{lemma-criterion-reduced}.
Note that $S$ is noetherian, and
$R \to S$ is flat with regular fibres (see the list of
results on smooth ring maps in Section \ref{section-smooth-overview}).
Hence we may apply Lemmas \ref{lemma-Sk-goes-up} and \ref{lemma-Rk-goes-up}
and we see that $S$ is $(S_1)$ and $(R_0)$, in other words reduced
by Lemma \ref{lemma-criterion-reduced} again.

\medskip\noindent
In the general case we may find a finitely generated
$\mathbf{Z}$-subalgebra $R_0 \subset R$ and a smooth ring
map $R_0 \to S_0$ such that $S \cong R \otimes_{R_0} S_0$, see
remark (10) in Section \ref{section-smooth-overview}.
Now, if $x \in S$ is an element with $x^2 = 0$,
then we can enlarge $R_0$ and assume that $x$ comes
from an element $x_0 \in S_0$. After enlarging
$R_0$ once more we may assume that $x_0^2 = 0$ in $S_0$.
However, since $R_0 \subset R$ is reduced we see that
$S_0$ is reduced and hence $x_0 = 0$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-normal-goes-up}
Let $\varphi : R \to S$ be a ring map. Assume
\begin{enumerate}
\item $\varphi$ is smooth,
\item $R$ is normal.
\end{enumerate}
Then $S$ is normal.
\end{lemma}

\begin{proof}
First assume $R$ is Noetherian.
In this case being reduced is the same as having properties
$(S_2)$ and $(R_1)$, see Lemma \ref{lemma-criterion-normal}.
Note that $S$ is noetherian, and
$R \to S$ is flat with regular fibres (see the list of
results on smooth ring maps in Section \ref{section-smooth-overview}).
Hence we may apply Lemmas \ref{lemma-Sk-goes-up} and \ref{lemma-Rk-goes-up}
and we see that $S$ is $(S_2)$ and $(R_1)$, in other words reduced
by Lemma \ref{lemma-criterion-normal} again.

\medskip\noindent
The general case. First note that $R$ is reduced and hence
$S$ is reduced by Lemma \ref{lemma-reduced-goes-up}.
Let $\mathfrak q$ be a prime of $S$ and let $\mathfrak p$ be
the corresponding prime of $R$. Note that $R_{\mathfrak p}$
is a normal domain. We have to show that $S_{\mathfrak q}$ is
a normal domain. To do this we may replace $R$ by $R_{\mathfrak p}$
and $S$ by $S_{\mathfrak p}$. Hence we may assume that $R$ is
a normal domain.

\medskip\noindent
Assume $R \to S$ smooth, and $R$ a normal domain.
We may find a finitely generated $\mathbf{Z}$-subalgebra
$R_0 \subset R$ and a smooth ring map $R_0 \to S_0$ such
that $S \cong R \otimes_{R_0} S_0$, see
remark (10) in Section \ref{section-smooth-overview}.
As $R_0$ is a Nagata domain (see Proposition \ref{proposition-ubiquity-nagata})
we see that its integral closure $R_0'$ is finite over $R_0$. 
Moreover, as $R$ is a normal domain it is clear that $R_0' \subset R$.
Hence we may replace $R_0$ by $R_0'$ and $S_0$ by
$R_0' \otimes_{R_0} S_0$ and assume that $R_0$ is a normal
Noetherian domain. By the first paragraph of the proof we conclude
that $S_0$ is a normal ring (it need not be a domain of course).
In this way we see that $R = \bigcup R_\lambda$
is the union of normal Noetherian domains and correspondingly
$S = \text{colim}\ R_\lambda \otimes_{R_0} S_0$ is the colimit
of normal rings. This implies that $S$ is a normal ring.
Some details omitted.
\end{proof}


\section{Descending properties}
\label{section-descending-properties}

\noindent
In this section we start proving some algebraic facts concerning the
``descent'' of properties of rings. It turns out that it is often
``easier'' to descend properties than it is to ascend them. In other
words, the assumption on the ring map $R \to S$ are often weaker than
the assumptions in the corresponding lemma of the preceding section.
However, we warn the reader that the results on descent are often
useless unless the corresponding ascent can also be shown!
Here is a typical result which illustrates this phenomenon.

\begin{lemma}
\label{lemma-descent-Noetherian}
Let $R \to S$ be a ring map.
Assume that
\begin{enumerate}
\item $R \to S$ is faithfully flat, and
\item $S$ is Noetherian.
\end{enumerate}
Then $R$ is Noetherian.
\end{lemma}

\begin{proof}
Let $I_0 \subset I_1 \subset I_2 \subset \ldots$ be a
growing sequence of ideals of $R$. By assumption we have
$I_nS = I_{n +1}S = I_{n + 2}S = \ldots$ for some $n$.
Since $R \to S$ is flat we have $I_kS = I_k \otimes_R S$.
Hence, as $R \to S$ is faithfully flat we see that
$I_nS = I_{n +1}S = I_{n + 2}S = \ldots$ implies that
$I_n = I_{n +1} = I_{n + 2} = \ldots$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-descent-reduced}
Let $R \to S$ be a ring map.
Assume that
\begin{enumerate}
\item $R \to S$ is faithfully flat, and
\item $S$ is reduced.
\end{enumerate}
Then $R$ is reduced.
\end{lemma}

\begin{proof}
This is clear as $R \to S$ is injective.
\end{proof}

\begin{lemma}
\label{lemma-descent-normal}
Let $R \to S$ be a ring map.
Assume that
\begin{enumerate}
\item $R \to S$ is faithfully flat, and
\item $S$ is a normal ring.
\end{enumerate}
Then $R$ is a normal ring.
\end{lemma}

\begin{proof}
Since $S$ is reduced it follows that $R$ is reduced.
Let $\mathfrak p$ be a prime of $R$. We have to show that
$R_{\mathfrak p}$ is a normal domain. Since $S_{\mathfrak p}$
is faithfully over $R_{\mathfrak p}$ too we may assume that
$R$ is local with maximal ideal $\mathfrak m$.
Let $\mathfrak q$ be a prime of $S$ lying over $\mathfrak m$.
Then we see that $R \to S_{\mathfrak q}$ is faithfully flat
(Lemma \ref{lemma-local-flat-ff}).
Hence we may assume $S$ is local as well.
In particular $S$ is a normal domain.
Since $R \to S$ is faithfully flat
and $S$ is a normal domain we see that $R$ is a domain.
Next, suppose that $a/b$ is integral over $R$ with $a, b \in R$.
Then $a/b \in S$ as $S$ is normal. Hence $a \in bS$.
This means that $a : R \to R/bR$ becomes the zero map
after base change to $S$. By faithful flatness we see that
$a \in bR$, so $a/b \in R$. Hence $R$ is normal.
\end{proof}

\begin{lemma}
\label{lemma-descent-Sk}
Let $R \to S$ be a ring map.
Assume that
\begin{enumerate}
\item $R \to S$ is faithfully flat of finite presentation, and
\item $S$ is Noetherian and has property $(S_k)$.
\end{enumerate}
Then $R$ is Noetherian and has property $(S_k)$.
\end{lemma}

\begin{proof}
We have already seen that (1) and (2) imply that $R$ is Noetherian,
see Lemma \ref{lemma-descent-Noetherian}.
Let $\mathfrak p \subset R$ be a prime ideal.
Choose a prime $\mathfrak q \subset S$ lying over $\mathfrak p$
which corresponds to a minimal prime of the fibre ring
$S \otimes_R \kappa(\mathfrak p)$. Then
$A = R_{\mathfrak p} \to S_{\mathfrak q} = B$ is a flat local ring
homomorphism of Noetherian local rings with $\mathfrak m_AB$ an
ideal of definition of $B$. Hence
$\dim(A) = \dim(B)$ (Lemma \ref{lemma-dimension-base-fibre-equals-total}) and
$\text{depth}(A) = \text{depth}(B)$ (Lemma \ref{lemma-apply-grothendieck}).
Hence since $B$ has $(S_k)$ we
see that $A$ has $(S_k)$.
\end{proof}

\begin{lemma}
\label{lemma-descent-Rk}
Let $R \to S$ be a ring map. Assume that
\begin{enumerate}
\item $R \to S$ is faithfully flat and of finite presentation, and
\item $S$ is Noetherian and has property $(R_k)$.
\end{enumerate}
Then $R$ is Noetherian and has property $(R_k)$.
\end{lemma}

\begin{proof}
We have already seen that (1) and (2) imply that $R$ is Noetherian,
see Lemma \ref{lemma-descent-Noetherian}.
Let $\mathfrak p \subset R$ be a prime ideal and assume
$\dim(R_{\mathfrak p}) \leq k$.
Choose a prime $\mathfrak q \subset S$ lying over $\mathfrak p$
which corresponds to a minimal prime of the fibre ring
$S \otimes_R \kappa(\mathfrak p)$. Then
$A = R_{\mathfrak p} \to S_{\mathfrak q} = B$ is a flat local ring
homomorphism of Noetherian local rings with $\mathfrak m_AB$ an
ideal of definition of $B$. Hence
$\dim(A) = \dim(B)$ (Lemma \ref{lemma-dimension-base-fibre-equals-total}).
As $S$ has $(R_k)$ we conclude that $B$ is a regular local ring.
By Lemma \ref{lemma-flat-under-regular} we conclude that $A$ is regular.
\end{proof}

\begin{lemma}
\label{lemma-descent-nagata}
Let $R \to S$ be a ring map. Assume that
\begin{enumerate}
\item $R \to S$ is smooth and surjective on spectra, and
\item $S$ is a Nagata ring.
\end{enumerate}
Then $R$ is a Nagata ring.
\end{lemma}

\begin{proof}
Recall that a Nagata ring is the same thing as a Noetherian
universally Japanese ring
(Proposition \ref{proposition-nagata-universally-japanese}).
We have already seen that $R$ is Noetherian in
Lemma \ref{lemma-descent-Noetherian}.
Let $R \to A$ be a finite type ring map into a domain.
According to Lemma \ref{lemma-check-universally-japanese}
it suffices to check that $A$ is N-1.
It is clear that $B = A \otimes_R S$ is a finite type $S$-algebra
and hence Nagata (Proposition \ref{proposition-nagata-universally-japanese}).
Since $A \to B$ is smooth (Lemma \ref{lemma-base-change-smooth})
we see that $B$ is reduced (Lemma \ref{lemma-reduced-goes-up}).
Since $B$ is Noetherian it has only a finite number of minimal
primes $\mathfrak q_1, \ldots, \mathfrak q_t$ (see
Lemma \ref{lemma-Noetherian-irreducible-components}).
As $A \to B$ is flat each of these lies over $(0) \subset A$
(by going down, see Lemma \ref{lemma-flat-going-down})
The total ring of fractions $Q(B)$ is the product of the
$L_i = f.f.(B/\mathfrak q_i)$ (Lemmas
\ref{lemma-total-ring-fractions-no-embedded-points} and
\ref{lemma-minimal-prime-reduced-ring}).
Moreover, the integral closure $B'$ of $B$ in $Q(B)$ is
the product of the integral closures $B_i'$ of the $B/\mathfrak q_i$
in the factors $L_i$ (compare with
Lemma \ref{lemma-characterize-reduced-ring-normal}).
Since $B$ is universally Japanese the
ring extensions $B/\mathfrak q_i \subset B_i'$ are finite
and we conclude that $B' = \prod B_i'$ is finite over $B$.
Since $A \to B$ is flat we see that any
nonzero divisor on $A$ maps to a nonzero divisor on $B$.
The corresponding map
$$
Q(A) \otimes_A B = (A \setminus \{0\})^{-1}A \otimes_A B
= (A \setminus \{0\})^{-1}B \to Q(B)
$$
is injective (we used Lemma \ref{lemma-tensor-localization}).
Via this map $A'$ maps into $B'$. This induces a map
$$
A' \otimes_A B \longrightarrow B'
$$
which is injective (by the above and the flatness of $A \to B$).
Since $B'$ is a finite $B$-module
and $B$ is Noetherian we see that $A' \otimes_A B$ is a finite $B$-module.
Hence there exist finitely many elements $x_i \in A'$ such that
the elements $x_i \otimes 1$ generate $A' \otimes_A B$ as a $B$-module.
Finally, by faithful flatness of $A \to B$ we conclude that
the $x_i$ also generated $A'$ as an $A$-module, and we win.
\end{proof}

\begin{remark}
\label{remark-universally-catenary-does-not-descend}
The property of being ``universally catenary'' does not descend;
not even along etale ring maps. In
Examples, Section \ref{examples-section-non-catenary-Noetherian-local}
there is a construction of a finite ring map $A \to B$ with
$A$ local Noetherian and not universally catenary,
$B$ semi-local with two maximal ideals $\mathfrak m$, $\mathfrak n$
with $B_{\mathfrak m}$ and $B_{\mathfrak n}$ regular of dimension $2$ and $1$
respectively, and the same residue fields as that of $A$.
Moreover, $\mathfrak m_A$ generates the maximal ideal in both
$B_{\mathfrak m}$ and $B_{\mathfrak n}$ (so $A \to B$ is unramified
as well as finite).
By Lemma \ref{lemma-etale-makes-unramfied-closed}
there exists a local etale ring map
$A \to A'$ such that $B \otimes_A A' = B_1 \times B_2$ decomposes
with $A' \to B_i$ surjective.
This shows that $A'$ has two minimal primes $\mathfrak q_i$
with $A'/\mathfrak q_i \cong B_i$. Since $B_i$ is regular local
(since it is etale over either $B_{\mathfrak m}$ or $B_{\mathfrak n}$)
we conclude that $A'$ is universally catenary.
\end{remark}









\section{Geometrically normal algebras}
\label{section-geometrically-normal}

\noindent
In this section we put some applications of ascent and descent of
properties of rings.

\begin{lemma}
\label{lemma-geometrically-normal}
Let $k$ be a field. Let $A$ be a $k$-algebra.
The following properties of $A$ are equivalent:
\begin{enumerate}
\item $k' \otimes_k A$ is a normal ring
for every field extension $k \subset k'$,
\item $k' \otimes_k A$ is a normal ring
for every finitely generated field extension $k \subset k'$, and
\item $k' \otimes_k A$ is a normal ring
for every finite purely inseparable extension $k \subset k'$.
\end{enumerate}
where normal ring is as defined in Definition \ref{definition-ring-normal}.
\end{lemma}

\begin{proof}
It is clear that (1) $\Rightarrow$ (2) $\Rightarrow$ (3).

\medskip\noindent
Assume (2) and let $k \subset k'$ be any field extension.
Then we can write $k' = \text{colim}_i\ k_i$ as a directed
colimit of finitely generated field extensions. Hence we
see that $k' \otimes_k A = \text{colim}_i\ k_i \otimes_k A$
is a directed colimit of normal rings. Thus we see
that $k' \otimes_k A$ is a normal ring by
Lemma \ref{lemma-colimit-normal-ring}.
Hence (1) holds.

\medskip\noindent
Assume (3) and let $k \subset K$ be a finitely generated field extension.
By Lemma \ref{lemma-make-separable} we can find a diagram
$$
\xymatrix{
K \ar[r] & K' \\
k \ar[u] \ar[r] & k' \ar[u]
}
$$
where $k \subset k'$, $K \subset K'$ are finite purely inseparable field
extensions such that $k' \subset K'$ is separable. By
Lemma \ref{lemma-localization-smooth-separable}
there exists a smooth $k'$-algebra $B$ such that $K'$ is the
fraction field of $B$. Now we can argue as follows:
Step 1: $k' \otimes_k A$ is a normal ring because we assumed (3).
Step 2: $B \otimes_{k'} k' \otimes_k A$ is a normal ring as
$k' \otimes_k A \to B \otimes_{k'} k' \otimes_k A$ is smooth
(Lemma \ref{lemma-base-change-smooth})
and ascent of normality along smooth maps
(Lemma \ref{lemma-normal-goes-up}).
Step 3. $K' \otimes_{k'} k' \otimes_k A = K' \otimes_k A$ is
a normal ring as it is a localization of a normal ring
(Lemma \ref{lemma-localization-normal-ring}).
Step 4. Finally $K \otimes_k A$ is a normal ring by descent of
normality along the faithfully flat ring map
$K \otimes_k A \to K' \otimes_k A$ (Lemma \ref{lemma-descent-normal}).
This proves the lemma.
\end{proof}

\begin{definition}
\label{definition-geometrically-normal}
Let $k$ be a field.
A $k$-algebra $R$ is called {\it geometrically normal} over $k$ if
the equivalent conditions of Lemma \ref{lemma-geometrically-normal} hold.
\end{definition}




\section{Geometrically regular algebras}
\label{section-geometrically-regular}

\noindent
Let $k$ be a field.
Let $A$ be a Noetherian $k$-algebra.
Let $k \subset K$ be a finitely generated field extension.
Then the ring $K \otimes_k A$ is Noetherian as well, see
Lemma \ref{lemma-Noetherian-field-extension}.
Thus the following lemma makes sense.

\begin{lemma}
\label{lemma-geometrically-regular}
Let $k$ be a field. Let $A$ be a $k$-algebra.
Assume $A$ is Noetherian.
The following properties of $A$ are equivalent:
\begin{enumerate}
\item $k' \otimes_k A$ is a regular ring
for every finitely generated field extension $k \subset k'$, and
\item $k' \otimes_k A$ is a regular ring
for every finite purely inseparable extension $k \subset k'$.
\end{enumerate}
where regular ring is as defined in Definition \ref{definition-regular}.
\end{lemma}

\begin{proof}
The lemma makes sense by the remarks preceding the lemma.
It is clear that (1) $\Rightarrow$ (2).

\medskip\noindent
Assume (2) and let $k \subset K$ be a finitely generated field extension.
By Lemma \ref{lemma-make-separable} we can find a diagram
$$
\xymatrix{
K \ar[r] & K' \\
k \ar[u] \ar[r] & k' \ar[u]
}
$$
where $k \subset k'$, $K \subset K'$ are finite purely inseparable field
extensions such that $k' \subset K'$ is separable. By
Lemma \ref{lemma-localization-smooth-separable}
there exists a smooth $k'$-algebra $B$ such that $K'$ is the
fraction field of $B$. Now we can argue as follows:
Step 1: $k' \otimes_k A$ is a regular ring because we assumed (2).
Step 2: $B \otimes_{k'} k' \otimes_k A$ is a regular ring as
$k' \otimes_k A \to B \otimes_{k'} k' \otimes_k A$ is smooth
(Lemma \ref{lemma-base-change-smooth})
and ascent of regularity along smooth maps
(Lemma \ref{lemma-Rk-goes-up} applied for all $(R_k)$; use
Lemma \ref{lemma-characterize-smooth-over-field} to see that the
hypotheses are satisfied).
Step 3. $K' \otimes_{k'} k' \otimes_k A = K' \otimes_k A$ is
a regular ring as it is a localization of a regular ring
(immediate from the definition).
Step 4. Finally $K \otimes_k A$ is a regular ring by descent of
regularity along the faithfully flat ring map
$K \otimes_k A \to K' \otimes_k A$
(Lemma \ref{lemma-descent-Rk} for all $(R_k)$).
This proves the lemma.
\end{proof}

\begin{definition}
\label{definition-geometrically-regular}
Let $k$ be a field. Let $R$ be a Noetherian $k$-algebra.
The $k$-algebra $R$ is called {\it geometrically regular} over $k$ if
the equivalent conditions of Lemma \ref{lemma-geometrically-regular} hold.
\end{definition}




\section{Geometrically Cohen-Macaulay algebras}
\label{section-geometrically-CM}

\noindent
This section is a bit of a misnomer, since Cohen-Macaulay algebras
are automatically geometrically Cohen-Macaulay. Namely, see
Lemma \ref{lemma-extend-field-CM-locus}
and
Lemma \ref{lemma-CM-geometrically-CM}
below.

\begin{lemma}
\label{lemma-tensor-fields-CM}
Let $k$ be a field and let $k \subset K$ and $k \subset L$ be
two field extensions such that one of them is a field extension of finite type.
Then $K \otimes_k L$ is a Noetherian Cohen-Macaulay ring.
\end{lemma}

\begin{proof}
The ring $K \otimes_k L$ is Noetherian by
Lemma \ref{lemma-Noetherian-field-extension}.
Say $K$ is a finite extension of the purely transcendental extension
$k(t_1, \ldots, t_r)$. Then
$k(t_1, \ldots, t_r) \otimes_k L \to K \otimes_k L$
is a finite free ring map. By
Lemma \ref{lemma-finite-flat-over-regular-CM}
it suffices to show that $k(t_1, \ldots, t_r) \otimes_k L$ is Cohen-Macaulay.
This is clear because it is a localization of the polynomial
ring $L[t_1, \ldots, t_r]$. (See for example
Lemma \ref{lemma-CM-polynomial-algebra}
for the fact that a polynomial ring is Cohen-Macaulay.)
\end{proof}

\begin{lemma}
\label{lemma-CM-geometrically-CM}
Let $k$ be a field. Let $S$ be a Noetherian $k$-algebra.
Let $k \subset K$ be a finitely generated field extension,
and set $S_K = K\otimes_k S$. Let $\mathfrak q \subset S$
be a prime of $S$. Let $\mathfrak q_K \subset S_K$ be a prime
of $S_K$ lying over $\mathfrak q$. Then $S_{\mathfrak q}$ is Cohen-Macaulay
if and only if $(S_K)_{\mathfrak q_K}$ is Cohen-Macaulay.
\end{lemma}

\begin{proof}
By
Lemma \ref{lemma-Noetherian-field-extension}
the ring $S_K$ is Noetherian. Hence
$S_{\mathfrak q} \to (S_K)_{\mathfrak q_K}$ is a flat local homomorphism
of Noetherian local rings. Note that the fibre
$$
(S_K)_{\mathfrak q_K} / \mathfrak q (S_K)_{\mathfrak q_K}
\cong (\kappa(\mathfrak q) \otimes_k K)_{\mathfrak q'}
$$
is the localization of the Cohen-Macaulay ring
$\kappa(\mathfrak q) \otimes_k K$ at a suitable prime ideal $\mathfrak q'$.
Hence the lemma follows from
Lemma \ref{lemma-CM-goes-up}.
\end{proof}





\input{chapters}

\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}
