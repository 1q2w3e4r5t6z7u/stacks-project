\input{preamble}

% OK, start here.
%
\begin{document}

\title{Commutative Algebra}

%\begin{abstract}
%\end{abstract}

\maketitle

\tableofcontents

\section{Introduction}
\label{section-introduction}

\noindent
Basic commutative algebra will be explained in this document.
A reference is \cite{MatCA}.

\section{Conventions}
\label{section-conventions}

\noindent
A ring is commutative with $1$. The zero ring is a ring. In fact it is
the only ring that does not have a prime ideal. The Kronecker
symbol $\delta_{ij}$ will be used.

\section{Basic notions}
\label{section-rings-basic}

\noindent
The following notions are considered basic and will not be defined,
and or proved. This does not mean they are all necessarily easy or 
well known.

\begin{enumerate}
\item $R$ is a {\it ring},
\label{ring}
\item $x\in R$ is {\it nilpotent},
\label{ring-element-nilpotent}
\item $x\in R$ is a {\it zero-divisor},
\label{ring-element-zerodivisor}
\item $x\in R$ is a {\it unit},
\label{ring-element-unit}
\item $\varphi : R_1 \to R_2$ is a {\it ring homomorphism},
\label{ring-homomorphism}
\item $\varphi : R_1 \to R_2$ is {\it of finite presentation}, or
{\it $R_2$ is a finitely presented $R_1$-algebra},
\label{ring-homomorphism-finite-presentation}
\item $\varphi : R_1 \to R_2$ is {\it of finite type}, or
{\it $R_2$ is a finitely type $R_1$-algebra},
\label{ring-homomorphism-finite-type}
\item $\varphi : R_1 \to R_2$ is {\it finite}, or
{\it $R_2$ is a finite $R_1$-algebra},
\label{ring-homomorphism-finite}
\item $R$ is a {\it (integral) domain},
\label{ring-domain}
\item $R$ is {\it reduced},
\label{ring-reduced}
\item $R$ is {\it Noetherian},
\label{ring-Noetherian}
\item $K$ is a {\it field},
\label{field}
\item $K \subset L$ is a {\it field extension},
\label{field-extension}
\item $K \subset L$ is an {\it algebraic field extension},
\label{field-extension-algebraic}
\item $\{t_i\}_{i\in I}$ is a {\it transcendence basis} for $L$ over $K$,
\label{transcendence-basis}
\item the {\it transcendence degree} $\text{trdeg}(L/K)$ of $L$
over $K$,
\label{transcendence-degree}
\item the field $k$ is {\it algebraically closed},
\label{algebraically-closed}
\item if $K \subset L$ is algebraic, and $K \to k$ a field map,
then there exists a map $L \to k$ extending the map on $K$,
\label{extend-into-algebraically-closed}
\item $I \subset R$ is an {\it ideal},
\label{ideal}
\item $I \subset R$ is {\it radical},
\label{ideal-radical}
\item if $I$ is an ideal then we have its {\it radical} $\sqrt{I}$,
\label{radical-ideal}
\item $I \subset R$ is {\it nilpotent} which means that $I^n = 0$ for
some $n \in \mathbf{N}$,
\label{ideal-nilpotent}
\item $\mathfrak p \subset R$ is a {\it prime ideal},
\label{prime-ideal}
\item if $\mathfrak p \subset R$ is prime and if $I, J \subset R$
are ideal, and if $IJ\subset \mathfrak p$, then
$I \subset \mathfrak p$ or $J \subset \mathfrak p$.
\label{prime-product-ideals}
\item $\mathfrak m \subset R$ is a {\it maximal ideal},
\label{maximal-ideal}
\item any nonzero ring has a maximal ideal,
\label{exists-maximal-ideal}
\item the {\it Jacobson radical} of $R$ is $\text{rad}(R) =
\cap_{\mathfrak m \subset R} \mathfrak m$ the intersection
of all the maximal ideals of $R$,
\label{jacobson-radical}
\item the ideal $(T)$ {\it generated} by a subset $T \subset R$,
\label{ideal-generated-by}
\item the {\it quotient ring} $R/I$,
\label{quotient-ring}
\item if $\varphi : R_1 \to R_2$ is a ring homomorphism, and if
$I \subset R_2$ is an ideal, then $\varphi^{-1}(I)$ is an
ideal of $R_1$,
\label{inverse-image-ideal}
\item if $\varphi : R_1 \to R_2$ is a ring homomorphism, and if
$I \subset R_1$ is an ideal, then $\varphi(I) \cdot R_2$ (sometimes
denoted $I \cdot R_2$, or $IR_2$) is the ideal of $R_2$ generated
by $\varphi(I)$,
\label{image-ideal}
\item if $\varphi : R_1 \to R_2$ is a ring homomorphism, and if
$\mathfrak p \subset R_2$ is a prime ideal, then
$\varphi^{-1}(\mathfrak p)$ is a prime ideal of $R_1$,
\label{inverse-image-prime}
\item $M$ is an {\it $R$-module},
\label{module}
\item $N \subset M$ is an {\it $R$-submodule},
\label{submodule}
\item $M$ is an {\it Noetherian $R$-module},
\label{Noetherian-module}
\item $M$ is a {\it finite $R$-module},
\label{finite-module}
\item $M$ is a {\it finitely generated $R$-module},
\label{finitely-generated-module}
\item $M$ is a {\it finitely presented $R$-module},
\label{finitely-presented-module}
\item $M$ is a {\it free $R$-module},
\label{free-module}
\item if $N \subset M \subset L$ are $R$-modules,
then $L/M = (L/N)/(M/N)$,
\label{isomorphism-theorem}
\item $S$ is a {\it multiplicative subset of $R$},
\label{multiplicative-subset}
\item the {\it localization} $R \to S^{-1}R$ of $R$,
\label{localization-ring}
\item if $R$ is a ring and $S$ is a multiplicative subset
of $R$ then $S^{-1}R$ is the zero ring if and only if $S$ contains
$0$,
\label{localization-zero}
\item if $R$ is a ring and if the multiplicative subset $S$
consists completely of nonzero divisors, then $R \to S^{-1}R$
is injective,
\label{localize-nonzerodivisors}
\item if $\varphi : R_1 \to R_2$ is a ring homomorphism, and
$S$ is a multiplicative subsets of $R_1$, then $\varphi(S)$ is
a multiplicative subset of $R_2$,
\item if $S$, $S'$ are multiplicative subsets of $R$,
and if $SS'$ denotes the set of products $SS' =
\{r \in R \mid \exists s\in S, \exists s' \in S', r = ss'\}$
then $SS'$ is a multiplicative subset of $R$,
\label{products-multiplicative-subsets}
\item if $S$, $S'$ are multiplicative subsets of $R$,
and if $\overline{S}$ denotes the image of $S$ in $(S')^{-1}R$,
then $(SS')^{-1}R = \overline{S}^{-1}((S')^{-1}R)$,
\label{localization-localization}
\item the {\it localization} $S^{-1}M$ of the $R$-module $M$,
\label{localization-module}
\item the functor $M \mapsto S^{-1}M$ preserves injective maps,
surjective maps, and exactness,
\label{localization-exact}
\item if $S$, $S'$ are multiplicative subsets of $R$,
and $M$ and $R$-module, then $(SS')^{-1}M =
S^{-1}((S')^{-1}M)$,
\label{localization-localization-module}
\item if $R$ is a ring, $I$ and ideal of $R$ and $S$ a multiplicative
subset of $R$, then $S^{-1}I$ is an ideal of $S^{-1}R$, and we have
$S^{-1}R/S^{-1}I = \overline{S}^{-1}(R/I)$, where $\overline{S}$
is the image of $S$ in $R/I$,
\label{localize-ideal}
\item if $R$ is a ring, and $S$ a multiplicative
subset of $R$, then any ideal $I'$ of $S^{-1}R$ is
of the form $S^{-1}I$, where one can take $I$ to be
the inverse image of $I'$ in $R$,
\label{ideal-in-localization}
\item if $R$ is a ring, $M$ an $R$-module, and $S$ a multiplicative
subset of $R$, then any submodule $N'$ of $S^{-1}M$ is of the form
$S^{-1}N$ for some submodule $N \subset M$, where
one can take $N$ to be the inverse image of $N'$ in $M$,
\label{submodule-in-localization}
\item if $S = \{1, f, f^2,\ldots\}$ then $R_f = S^{-1}R$, and
$M_f = S^{-1}M$,
\label{localiza-f}
\item if $S = R \setminus \mathfrak p$, then $R_{\mathfrak p} = S^{-1}R$
and $M_{\mathfrak p} = S^{-1}M$,
\label{localize-p}
\item given $R$ and $M_1$, $M_2$ the {\it tensor product} 
$M_1 \otimes_R M_2$,
\item etc.
\end{enumerate}

\section{The spectrum of a ring}
\label{section-spectrum-ring}

\noindent
We arbitrarily decide that the spectrum of a ring as a topological space
is part of the algebra chapter, whereas an affine scheme is part of the
chapter on schemes.

\begin{definition}
\label{definition-spectrum-ring}
Let $R$ be a ring.
\begin{enumerate}
\item The {\it spectrum} of $R$ is the set of prime ideals of $R$.
It is usually denoted $\text{Spec}(R)$.
\item Given a subset $T \subset R$ we let $V(T) \subset \text{Spec}(R)$
be the set of primes containing $T$, i.e., $V(T) = \{ \mathfrak p \in
\text{Spec}(R) \mid \forall f\in T, f\in \mathfrak p\}$.
\item Given an element $f \in R$ we let $D(f) \subset \text{Spec}(R)$
be the set of primes not containing $f$.
\end{enumerate}
\end{definition}

\begin{lemma}
\label{lemma-Zariski-topology}
Let $R$ be a ring.
\begin{enumerate}
\item The spectrum of a ring $R$ is empty if and only if $R$
is the zero ring.
\item Every nonzero ring has a maximal ideal.
\item Every nonzero ring has a minimal prime ideal.
\item Given an ideal $I \subset R$ and a prime ideal
$I \subset \mathfrak p$ there exists a prime 
$I \subset \mathfrak q \subset \mathfrak p$ such
that $\mathfrak q$ is minimal over $I$.
\item If $T \subset R$, and if $(T)$ is the ideal generated by
$T$ in $R$, then $V((T)) = V(T)$.
\item If $I$ is an ideal and $\sqrt{I}$ is its radical,
see basic notion (\ref{radical-ideal}), then $V(I) = V(\sqrt{I})$.
\item Given an ideal $I$ of $R$ we have $\sqrt{I} =
\bigcap_{I \subset \mathfrak p} \mathfrak p$.
\item If $I$ is an ideal then $V(I) = \emptyset$ if and only
if $I$ is the unit ideal.
\item If $I$, $J$ are ideals of $R$ then $V(I) \cup V(J) =
V(I \cap J)$.
\item If $(I_a)_{a\in A}$ is a set of ideals of $R$ then
$\cap_{a\in A} V(I_a) = V(\cup_{a\in A} I_a)$.
\item If $f \in R$, then $D(f) \sqcup V(f) = \text{Spec}(R)$.
\item If $f = u f'$ for some unit $u \in R$, then $D(f) = D(f')$.
\item If $I \subset R$ is an ideal, and $\mathfrak p$ is a prime of
$R$ with $\mathfrak p \not\in V(I)$, then there exists an $f \in R$
such that $\mathfrak p \in D(f)$, and $D(f) \cap V(I) = \emptyset$.
\item If $f,g \in R$, then $D(fg) = D(f) \cap D(g)$.
\end{enumerate}
\end{lemma}

\begin{proof}
FIXME.
\end{proof}

\noindent
The lemma implies that the subsets $V(T)$ from
Definition \ref{definition-spectrum-ring} form the closed
subsets of a topology on $\text{Spec}(R)$. And it also shows that
the sets $D(f)$ are open and form a basis for this
topology.

\begin{definition}
\label{definition-Zariski-topology}
Let $R$ be a ring.
The topology on $\text{Spec}(R)$ whose closed sets are the
sets $V(T)$ is called the {\it Zariski} topology. The open
subsets $D(f)$ are called the {\it standard opens} of $\text{Spec}(R)$.
\end{definition}

\noindent
It should be clear from context whether we consider $\text{Spec}(R)$
just as a set or as a topological space.

\begin{lemma}
\label{lemma-spec-functorial}
Suppose that $\varphi : R \to R'$ is a ring homomorphism.
The induced map
$$
\text{Spec}(\varphi) :
\text{Spec}(R')
\longrightarrow
\text{Spec}(R),\ \ 
\mathfrak p'
\longmapsto
\varphi^{-1}(\mathfrak p')
$$
is continuous for the Zariski toplogies. In fact, for
$f \in R$ we have
$\text{Spec}(\varphi)^{-1}(D(f)) = D(\varphi(f))$.
\end{lemma}

\begin{proof}
It is basic notion (\ref{inverse-image-prime}) that
$\mathfrak p := \varphi^{-1}(\mathfrak p')$
is indeed a prime ideal of $R$. The last assertion
of the lemma follows directly from the definitions,
and implies the first.
\end{proof}

\noindent
If $\varphi' : R' \to R''$ is a second ring homomorphism
then the composition
$$
\text{Spec}(R')
\longrightarrow
\text{Spec}(R')
\longrightarrow
\text{Spec}(R'')
$$
equals $\text{Spec}(\varphi' \circ \varphi)$. In other
words, $\text{Spec}$ is a contravariant functor from the
category of rings to the category of topological spaces.


\begin{lemma}
\label{lemma-spec-localization}
Let $R$ be a ring. Let $S \subset R$ be a multiplicative subset.
The map $R \to S^{-1}R$ induces via the functoriality of $\text{Spec}$
a homeomorphism 
$$
\text{Spec}(S^{-1}R)
\longrightarrow 
\{\mathfrak p \in \text{Spec}(R) \mid S \cap \mathfrak p = \emptyset \}
$$
where the topology on the right hand side is that induced from the
Zariski topology on $\text{Spec}(R)$. The inverse map is given
by $\mathfrak p \mapsto S^{-1}\mathfrak p$.
\end{lemma}

\begin{proof}
Denote the left hand side of the arrow of the lemma by $D$.
Choose a prime $\mathfrak p' \subset R_f$ and let $\mathfrak p$
the inverse image of $\mathfrak p'$ in $R$. Since $\mathfrak p'$
does not contain $1$ we see that $\mathfrak p$ does not contain
any element of $S$. Hence $\mathfrak p \in D$ and we see that
the image is contained in $D$. Let $\mathfrak p \in D$. By assumption
the set $S$ maps injectively into $R/\mathfrak p$, in other
words the image $\overline{S}$ does not contain $0$.
By basic notion (\ref{localization-zero})
$\overline{S}^{-1}(R/\mathfrak p)$ is not the zero ring.
By basic notion (\ref{localize-ideal}) we see
$S^{-1}R / S^{-1}\mathfrak p = \overline{S}^{-1}(R/\mathfrak p)$
is a domain, and hence $S^{-1}\mathfrak p$ is a prime.
The equality of rings also shows that the inverse image of
$S^{-1}\mathfrak p$ in $R$ is equal to $\mathfrak p$,
because $R/\mathfrak p \to \overline{S}^{-1}(R/\mathfrak p)$
is injective by basic notion (\ref{localize-nonzerodivisors}).
This proves that the map $\text{Spec}(S^{-1}R) \to \text{Spec}(R)$
is bijective onto $D$ with inverse as given.
It is continuous by Lemma \ref{lemma-spec-functorial}.
Finally, let $D(g) \subset \text{Spec}(S^{-1}R)$ be a standard
open. Write $g = h/s$ for some $h\in R$ and $s\in S$.
Since $g$ and $h/1$ differ by a unit we have $D(g) = 
D(h/1)$ in $\text{Spec}(S^{-1}R)$.
Hence by Lemma \ref{lemma-spec-functorial} and the bijectivity
above the image of $D(g) = D(h/1)$ is $D \cap D(h)$.
This proves the map is open as well.
\end{proof}

\begin{lemma}
\label{lemma-standard-open}
Let $R$ be a ring. Let $f \in R$.
The map $R \to R_f$ induces via the functoriality of
$\text{Spec}$ a homeomorphism
$$
\text{Spec}(R_f) \longrightarrow D(f) \subset \text{Spec}(R).
$$
The inverse is given by $\mathfrak p \mapsto \mathfrak p \cdot R_f$.
\end{lemma}

\begin{proof}
This is a special case of Lemma \ref{lemma-spec-localization}
above.
\end{proof}

\begin{lemma}
\label{lemma-spec-closed}
Let $R$ be a ring. Let $I \subset R$ be an ideal.
The map $R \to R/I$ induces via the functoriality of
$\text{Spec}$ a homeorphism
$$
\text{Spec}(R/I) \longrightarrow V(I) \subset \text{Spec}(R).
$$
The inverse is given by $\mathfrak p \mapsto \mathfrak p / I$.
\end{lemma}

\begin{proof}
It is immediate that the image is contained in $V(I)$.
On the other hand, if $\mathfrak p \in V(I)$
then $\mathfrak p \supset I$ and we may consider
the ideal $\mathfrak p /I \subset R/I$. Using
basic notion (\ref{isomorphism-theorem}) we see that
$(R/I)/(\mathfrak p/I) = R/\mathfrak p$ is a domain
and hence $\mathfrak p/I$ is a prime ideal. From this
it is immediately clear that the image of $D(f + I)$
is $D(f) \cap V(I)$, and hence the map is a homeomorphism.
\end{proof}

\begin{remark}
\label{remark-fundamental-diagram}
A fundamental commutative diagram associated to
$\varphi : R \to S$,
$\mathfrak q \subset S$ and
$\mathfrak p = \varphi^{-1}(\mathfrak q)$ is
the following
$$
\xymatrix{
\kappa(\mathfrak q) = S_{\mathfrak q}/{\mathfrak q}S_{\mathfrak q}
&
S_{\mathfrak q} \ar[l]
&
S \ar[r] \ar[l]
&
S/\mathfrak q \ar[r]
&
\kappa(\mathfrak q) = \text{f.f.}(S/\mathfrak q)
\\
\kappa(\mathfrak p) \otimes_R S = S_{\mathfrak p}/{\mathfrak p}S_{\mathfrak p} \ar[u]
&
S_{\mathfrak p} \ar[u] \ar[l]
&
S \ar[u] \ar[r] \ar[l]
&
S/\mathfrak pS \ar[u] \ar[r]
&
S \otimes_R \kappa(\mathfrak p) = (R \setminus \mathfrak p)^{-1}S \ar[u]
\\
\kappa(\mathfrak p) = R_{\mathfrak p}/{\mathfrak p}R_{\mathfrak p} \ar[u]
&
R_{\mathfrak p} \ar[u] \ar[l]
&
R \ar[u] \ar[r] \ar[l]
&
R/\mathfrak p \ar[u] \ar[r]
&
\kappa(\mathfrak p) = \text{f.f.}(R/\mathfrak p) \ar[u]
}
$$
In this diagram the arrows on the outer left and outer right columns
are identical. The horizontal maps induce on the associated spectrums
always an homeomorphism onto the image. The lower two rows
of the diagram make sense without assuming $\mathfrak q$ exists.
The lower squares induce fibre squares of topological spaces.
This diagram shows that $\mathfrak p$ is in the image
of the map on Spec if and only if $S \otimes_R \kappa(\mathfrak p)$
is not the zero ring.
\end{remark}

\begin{lemma}
\label{lemma-quasicompact}
Let $R$ be a ring. The space $\text{Spec}(R)$ is quasicompact.
\end{lemma}

\begin{proof}
It suffices to prove that any covering of $\text{Spec}(R)$
by standard opens can be refined by a finite covering.
Thus suppose that $\text{Spec}(R) = \cup D(f_i)$
for a set of elements $f_i$ of $R$. This means that
$\cap V(f_i) = \emptyset$. According to Lemma
\ref{lemma-Zariski-topology} this means that
$V(\{f_i \}) = \emptyset$. According to the
same lemma this means that the ideal generated
by the $f_i$ is the unit ideal of $R$. This means
that we can write $1$ as a {\it finite} sum like so
$1 = \sum_{i \in finite\ list} r_i f_i$.
And then it follows that $\text{Spec}(R) 
= \cup_{i \in finite\ list} D(f_i)$.
\end{proof}

\begin{lemma}
\label{lemma-irreducible}
The closed irreducible subsets of $\text{Spec}(R)$ are
exactly the subsets $V(\mathfrak p)$, with $\mathfrak \subset R$
a prime. The irreducible components (see Topology,
Definition \ref{topology-definition-components}) of $\text{Spec}(R)$ are 
exactly the subsets $V(\mathfrak p)$, with $\mathfrak p \subset R$
a minimal prime.
\end{lemma}

\begin{proof}
The first assertion implies the second. For the first consider
$V(I) \subset \text{Spec}(R)$ with $I$ a radical ideal.
If $I$ is not prime, then choose $a,b\in R$, $a,b\not \in I$
with $ab\in I$. In this case $V(I,a) \cup V(I,b) = V(I)$,
but neither $V(I,b) = V(I)$ nor $V(I,a) = V(I)$, by
Lemma \ref{lemma-Zariski-topology}. Conversely, if 
$I = \mathfrak p$ is prime, then $V(I) = \overline{\{\mathfrak p\}}$
is the closure of a $1$-point set and hence irreducible.
\end{proof}

\section{Flat modules and flat ring maps}
\label{section-flat}

\noindent
One often used result is that if $M = \text{colim}_{i\in \mathcal{I}} M_i$
is a colimit of $R$-modules and if $N$ is another then
$$
M \otimes N
=
\text{colim}_{i\in \mathcal{I}} M_i \otimes_R N.
$$
This follows almost immediately from the universal 
property of colimits and the universal property of
the tensor product in terms of bilinear maps.
This property is usually expressed by saying
that {\it $\otimes$ commutes with limits}.

\medskip\noindent
Another often used result is that if $0\to N_1 \to N_2 \to N_3\to 0$
is an exact sequence and if $M$ is any $R$-module, then
$$
M\otimes_R N_1
\to
M\otimes_R N_2
\to
M\otimes_R N_3
\to
0
$$
is still exact. Again this follows almost immediately from
the interpretation of the tensor product in terms of
bilinear maps. Of course this property is usually expressed
by saying that {\it $-\otimes_R M$ is right exact}.

\medskip\noindent
Let $M$ be an $R$-module. Let $x_i$, $i=1,\ldots,n$ be elements
of $M$. Let $f_i \in R$ be elements such that $\sum f_i x_i = 0$
in $M$. We say the elements $f_i$ give a {\it relation}
among the elements $x_i$.

\begin{lemma}
\label{lemma-module-colimit-fp}
Let $R$ be a ring and let $M$ be an $R$-module.
Then $M$ is the colimit of a directed system
$(I, \geq)$, $(M_i, f_{ii'})$ of $R$-modules
with all $M_i$ finitely presented $R$-modules.
\end{lemma}

\begin{proof}
Consider any finite subset $S \subset M$ and any finite
collection of relations $E$ among the elements
of $S$. So each $s \in S$ corresponds to $x_s \in M$ and
each $e \in E$ consists of a vector
of elements $f_{e,s} \in R$ such that $\sum f_{e,s} x_s = 0$.
Let $M_{S,E}$ be the cokernel of the map
$$
R^{\#E}
\longrightarrow
R^{\#S},\ \ 
(g_e)_{e\in E}
\longmapsto
(\sum g_e f_{e,s})_{s\in S}.
$$
There are canonical maps $M_{S,E} \to M$.
If $S \subset S'$ and if the elements of
$E$ correspond, via this map, to relations 
in $E'$, then there is an obvious map
$M_{S,E} \to M_{S', E'}$ commuting with the
maps to $M$. Thus $I$ is the set of pairs 
$(S,E)$ with ordering by inclusion as above.
It is clear that the limit of this directed system is $M$.
\end{proof}

\begin{definition}
\label{definition-flat}
Let $R$ be a ring.
\begin{enumerate}
\item An $R$-module $M$ is called {\it flat} if whenever
$N_1 \to N_2 \to N_3$ is an exact sequence of $R$-modules
the sequence $M\otimes_R N_1 \to M\otimes_R N_1\to M\otimes_R N_1$
is exact as well.
\item An $R$-module $M$ is called {\it faithfully flat} if the
complex of $R$-modules
$N_1 \to N_2 \to N_3$ is exact if and only if
the sequence $M\otimes_R N_1\to M\otimes_R N_1\to M\otimes_R N_1$
is exact.
\item A ring map $R \to S$ is called {\it flat} if
$S$ is flat as an $R$-module.
\item A ring map $R \to S$ is called {\it faithfully flat} if
$S$ is faithfully flat as an $R$-module.
\end{enumerate}
\end{definition}

\begin{lemma}
\label{lemma-flat}
Let $M$ be an $R$-module. The following are equivalent:
\begin{enumerate}
\item $M$ is flat over $R$.
\label{flat}
\item for every injection of $R$-modules $N \subset N'$
the map $N\otimes_R M \to N'\otimes_R M$ is injective.
\label{injective}
\item for every ideal $I \subset R$ the map
$I\otimes_R M \to R\otimes_R M = M$ is injective.
\label{f-ideal}
\item for every finitely generated ideal $I \subset R$
the map $I\otimes_R M \to R\otimes_R M = M$ is injective.
\label{ffg-ideal}
\end{enumerate}
\end{lemma}

\begin{proof}
The implications (\ref{flat}) implies (\ref{injective})
implies (\ref{f-ideal}) implies (\ref{ffg-ideal}) are all
trivial. Thus we prove (\ref{ffg-ideal}) implies (\ref{flat}).
Suppose that $N_1 \to N_2 \to N_3$ is exact.
Let $K_2 = \text{Ker}(N_2 \to N_3)$. 
It is clear that the surjection $N_1 \to K$
induces a surjection $N_1 \otimes_R M \to K_2\otimes_R M$.
Hence it suffices to show $K_2\otimes_R M \to N_2\otimes_R M$
is injective.

\medskip\noindent
Let $x \in \text{Ker}(K_2\otimes_R M \to N_2\otimes_R M)$.
We have to show that $x$ is zero.
Write $x = \sum_{i=1,\ldots,r} k_i \otimes m_i$. By
Lemma \ref{lemma-module-colimit-fp}
we can find a finitely generated module $N$,
a map $N \to N_2$, and elements $n_i \in N$, $i=1,\ldots,r$ such that
(a) $n_i$ maps to $k_i$, (b) the element $y = \sum_i n_i \otimes m_i$
maps to zero in $N \otimes_R M$. Let $K \subset N$
be the submodule generated by the $n_i$. It suffices to show that
$y$ is zero as an element of $K' \otimes_R M$.

\medskip\noindent
We do this by induction on the minimal number of generators of
$N$. If this number is $>1$ then we can find a short exact
sequence
$0 \to N' \to N \to N''\to 0$
such that $N'$ and $N''$ are finitely generated with a smaller
number of generators. By induction the element $y$ maps
to zero in $K'' \otimes_R M$ with $K''$ the image of $K$
in $N''$. And by the right exactness of $\otimes$ we see
that $y$ comes from some element of $K' \otimes_R M$
where $K'$ is the intersection of $K$ with $N'$. Again
by induction we see that $y' = 0$.

\medskip\noindent
The base case of the induction above is when
$N$ is generated by $1$ element. In other words
$N = R/I$, and then $y = \sum g_i \otimes m_i$,
Let $J = (g_1,\ldots,g_r) \subset R$.
By right exactness, we see that $R/I \otimes_R M
= M/IM$. Our assumption is that $y$ is zero
in $R/I \otimes_R M = M/IM$ in other words
$\sum g_im_i \in IM$, in other words
$\sum g_im_i = \sum h_j m'_j$ for suitable
$h_j \in I$. We may replace $I$ by the finitely
generated ideal $(h_j)$ without modifying the assumptions.
In this case we have $K = J+I/I$
$$
K\otimes_R M
=
(J+I)\otimes_R M /I\otimes_R M
=
(J+I)M / IM
$$
the first equality by right exactness
and the second by assumption on $M$.
Thus $y$ is zero in $K\otimes_RM$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-flat-base-change}
Suppose that $M$ is flat over $R$, and that $R \to R'$
is a ring map. Then $M\otimes_R R'$ is flat over $R'$.
\end{lemma}

\begin{proof}
For any $R'$-module $N$ we have a canonical
isomorphism $N \otimes_{R'} (R'\otimes_R M)
= N \otimes_R M$. Hence the exactness of
$-\otimes_{R'}(R'\otimes_R M)$ follows from
the exactness of $-\otimes_R M$.
\end{proof}

\noindent
We say the relation $\sum f_i x_i$
is {\it trivial} if there exist an integer $m \geq 0$,
elements $y_j$, $j=1,\ldots, m$, and elements $g_{ij} \in R$,
$i=1,\ldots,n$, $j=1,\ldots,m$ such that
$$
x_i = \sum\nolimits_j a_{ij} y_j, \forall j,
\text{ and }
0 = \sum\nolimits_i f_ia_{ij}, \forall i.
$$

\begin{lemma}
\label{lemma-flat-eq}
(Equational criterion of flatness.)
A module $M$ over $R$ is flat if and only if
every relation in $M$ is trivial.
\end{lemma}

\begin{proof}
Assume $M$ is flat and let $\sum f_i x_i$ be a relation.
Let $I = (f_1,\ldots,f_n)$, and let $K = \text{ker}(R^n \to I)$.
So we have the short exact sequence
$0\to K \to R^n \to I\to 0$. Then $\sum f_i \otimes x_i$
is an element of $I\otimes_R M$ which maps
to zero in $R\otimes_R M = M$. By flatness
$\sum f_i \otimes x_i$ is zero in $I\otimes_R M$.
Thus there exists an element of $K\otimes_R M$ mapping
to $\sum e_i \otimes m_i \in R^n\otimes_R M$.
Write this element as $\sum k_j \otimes y_j$
and then write the image of $k_j$ in $R^n$ as
$\sum a_{ij} e_i$ to get the result.

\medskip\noindent
Assume every relation is trivial, let $I$
be a finitely generated ideal, and let $x = \sum f_i\otimes x_i$
be an element of $I\otimes_R M$ mapping to zero in $R\otimes_R M = M$.
This just means exactly that $\sum h_i x_i$ is a relation in
$M$. And the fact that it is trivial implies easily that
$x$ is zero, because
$$
x
=
\sum f_i \otimes x_i
=
\sum f_i \otimes (\sum a_{ij}y_j)
=
\sum (\sum f_i a_{ij}) \otimes y_j
=
0
$$
\end{proof}

\begin{lemma}
\label{lemma-flat-tor-zero}
Suppose that $R$ is a ring, $0 \to M'' \to M' \to M \to 0$
a short exact sequence, and $N$ an $R$-module. If $M$ is flat
then $N\otimes_R M'' \to N\otimes_R M'$ is injective.
\end{lemma}

\begin{proof}
Let $R^{(I)} \to N$ be a surjection from a free module
onto $N$ with kernel $K$. The result follows
by a simple diagram chase from the following diagram
$$
\begin{matrix}
&
&
0
&
&
0
&
&
0
&
&
\\
&
&
\uparrow
&
&
\uparrow
&
&
\uparrow
&
&
\\
&
&
M''\otimes_R N
&
\to
&
M' \otimes_R N
&
\to
&
M\otimes_R N
&
\to
&
0
\\
&
&
\uparrow
&
&
\uparrow
&
&
\uparrow
&
&
\\
0
&
\to
&
(M'')^{(I)}
&
\to
&
(M')^{(I)}
&
\to
&
M^{(I)}
&
\to
&
0
\\
&
&
\uparrow
&
&
\uparrow
&
&
\uparrow
&
&
\\
&
&
M''\otimes_R N
&
\to
&
M' \otimes_R N
&
\to
&
M\otimes_R N
&
\to
&
0
\\
&
&
&
&
&
&
\uparrow
&
&
\\
&
&
&
&
&
&
0
&
&
\end{matrix}
$$
with exact rows and columns. The middle row is exact because tensoring
with the free module $R^{(I)}$ is exact.
\end{proof}


\begin{lemma}
\label{lemma-flat-ses}
Suppose that $0 \to M' \to M \to M''\to 0$ is
a short exact sequence of $R$-modules.
If $M'$ and $M''$ are flat so is $M$.
If $M$ and $M''$ are flat so is $M'$.
\end{lemma}

\begin{proof}
We will use the criterion that a module $N$ is $R$ flat if for
every ideal the map $N\otimes_RI \to N$ is injective,
see Lemma \ref{lemma-flat}.
Consider an ideal $I \subset R$.
Consider the diagram
$$
\begin{matrix}
0
&
\to 
&
M'
&
\to
&
M
&
\to
&
M''
&
\to
&
0
\\
&
&
\uparrow
&
&
\uparrow
&
&
\uparrow
&
&
\\
& 
&
M'\otimes_R I
&
\to
&
M\otimes_R I
&
\to
&
M''\otimes_R I
&
\to
&
0
\end{matrix}
$$
with exact rows. This immediately proves the first assertion.
The second follows because if $M''$ is flat then the lower left 
horizontal arrow is injective by Lemma \ref{lemma-flat-tor-zero}.
\end{proof}

\begin{lemma}
\label{lemma-characterize-zero-local}
An $R$-module $M$ is zero if and only if $M_{\mathfrak p}$ is
zero for all $\mathfrak p \in \text{Spec}(R)$.
\end{lemma}

\begin{proof}
Suppose $M_{\mathfrak p} = 0$ for all primes. 
Let $m \in M$. Let $I = \{f \in R \mid fm = 0\}$.
It is easy to see that $I$ is an ideal (it is the
annihilator of $m$). The condition means that for
all primes $\mathfrak p$ there exists an $f \in R \setminus
\mathfrak p$ such that $fm =0$. In other words,
we have $V(I) = \emptyset$. According to Lemma 
\ref{lemma-Zariski-topology} $I$ is the unit ideal.
Hence $m$ is zero.
\end{proof}

\begin{lemma}
\label{lemma-easy-ff}
An $R$-module $M$ is faithfully flat if and only if $M$ is flat
and for all maps $\alpha : N \to N'$ we have 
$\alpha = 0$ if and only if $\alpha \otimes \text{id}_M = 0$.
\end{lemma}

\begin{proof}
If $M$ is faithfully flat $0 \to \text{Ker}(\alpha)
\to N \to 0$ is exact if and only if the same holds
after tensoring with $M$. This proves one direction.
For the other, let $N_1 \to N_2 \to N_3$
be a complex, and assume the complex
$N_1 \otimes_R M \to N_2 \otimes_R M \to N_3\otimes_R M$
is exact. Take $x \in \text{Ker}(N_2 \to N_3)$,
and consider the map $\alpha : R\to N_2/\text{Im}(N_1)$,
$r \mapsto rx + \text{Im}(N_1)$. By the exactness
of the complex $-\otimes_R M$ we see that $\alpha \otimes 
\text{id}_M$ is zero. By assumption we get that $\alpha$ is
zero. Hence $x $ is in the image of $N_1 \to N_2$.
\end{proof}

\begin{lemma}
\label{lemma-ff}
Let $M$ be a flat $R$-module.
The following are equivalent:
\begin{enumerate}
\item $M$ is faithfully flat,
\item for all $\mathfrak p \in \text{Spec}(R)$
the tensor product $M\otimes_R \kappa(\mathfrak p)$ is nonzero, and
\item for all maximal ideals $\mathfrak m$ of $R$
the tensor product $M\otimes_R \kappa(\mathfrak m) = M/{\mathfrak m}M$
is nonzero.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume $M$ faithfully flat. Since $R \to \kappa({\mathfrak p})$ is not
zero we deduce that $M \to M \otimes_R \kappa({\mathfrak p})$ is not zero,
see Lemma \ref{lemma-easy-ff}.

\medskip\noindent
Conversely assume that $M$ is flat and that
$M/{\mathfrak m}M$ is never zero.
Suppose that $N_1 \to N_2 \to N_3$ is a complex and
suppose that $N_1 \otimes_R M \to N_2\otimes_R M \to
N_3\otimes_R M$ is exact. Let $H$ be the cohomology of the complex,
so $H = \text{Ker}(N_2 \to N_3)/\text{Im}(N_1 \to N_2)$.
By flatness we see that $H \otimes_R M = 0$. 
Take $x \in H$ and let $I = \{f \in R \mid fx = 0 \}$
be its annihilator. Since $R/I \subset H$ we get
$M/IM \subset H\otimes_R M = 0$ by flatness of $M$.
If $I \not=  R$ we may choose
a maximal ideal $I \subset \mathfrak m \subset R$.
This immediately gives a contradiction.
\end{proof}

\begin{lemma}
\label{lemma-ff-rings}
Let $R \to S$ be a flat ring map.
The following are equivalent:
\begin{enumerate}
\item $R \to S$ is faithfully flat,
\item the induced map on $\text{Spec}$ is surjective, and
\item any closed point $x \in \text{Spec}(R)$ is
in the image of the map $\text{Spec}(S) \to \text{Spec}(R)$.
\end{enumerate}
\end{lemma}

\begin{proof}
This follows quickly from Lemma \ref{lemma-ff}, because we
saw in Remark \ref{remark-fundamental-diagram}
that $\mathfrak p$ is in the image
if and only if the ring $S \otimes_R \kappa(\mathfrak p)$
is nonzero.
\end{proof}

\begin{lemma}
\label{lemma-flat-gd}
Let $R\to S$ be flat. Let $\mathfrak p \subset \mathfrak p'$.
If $\mathfrak p'$ is in the image of $\text{Spec}(S)
\to \text{Spec}(R)$ so is $\mathfrak p$.
\end{lemma}

\begin{proof}
Namely, consider $R_{\mathfrak p'} \to S_{\mathfrak p'}$.
By assumption there is a prime ideal $\mathfrak q  \subset  S_{\mathfrak p'}$
lying over $\mathfrak p' R_{\mathfrak p'}$.
By Lemma \ref{lemma-ff-rings} above this implies it is faithfully
flat. By the same lemma again there is a prime mapping to
$\mathfrak p R_{\mathfrak p'}$. The inverse image of this
prime in $S$ does the job.
\end{proof}


\section{Noetherian rings}
\label{section-Noetherian}

\noindent
A ring $R$ is {\it Noetherian} if any ideal of $R$ is
finitely generated. It is clearly equivalent to the
ascending chain condition for ideals of $R$.

\begin{lemma}
\label{lemma-Noetherian-permanence}
Any finitely generated ring over a Noetherian ring
is Noetherian. Any localization of a Noetherian ring
is Noetherian.
\end{lemma}

\begin{proof}
The statement on localizations follows from the fact
that any ideal $J \subset S^{-1}R$ is of the form
$I \cdot S^{-1}R$. Any quotient $R/I$ of a Noetherian
ring $R$ is Noetherian because any ideal $\overline{J} \subset R/I$
is of the form $J/I$ for some ideal $I \subset J \subset R$.
Thus it suffices to show that if $R$ is Noetherian so
is $R[X]$. If $J_1 \subset J_2 \subset \ldots$ is an
acsending chain of ideals, then consider the ideals $I_{i,d}$
defined as the ideal of elements of $R$ which occur as leading
coefficients of degree $d$ polynomials in $J_i$.
Clearly $I_{i, d} \subset I_{i', d'}$ whenever
$i \leq i'$ and $d \leq d'$. By the ascending chain condition
in $R$ there are at most finitely many distinct ideals among all of
the $I_{i,d}$. Take $i_0$ so large that $I_{i, d} = I_{i_0, d}$
for all $i \geq i_0$. Suppose $f \in J_i$ for some $i \geq i_0$.
By induction on the degree $d = \deg(f)$ we show that $f \in J_{i_0}$.
Namely, there exists a $g\in J_{i_0}$ whose degree is $d$ and which
has the same leading coefficient as $f$. By induction
$f - g \in J_{i_0}$ and we win.
\end{proof}

\begin{lemma}
\label{lemma-Noetherian-basic}
Let $R$ be a Noetherian ring.
Any finite $R$-module is of finite presentation; any submodule
of a finite $R$-module is finite.
Any finite type $R$-algebra is of finite presentation over $R$.
\end{lemma}

\begin{proof}
The last statement is clear because any ideal of
$R[x_1,\ldots,x_n]$ is finitely generated by Lemma
\ref{lemma-Noetherian-permanence} above.

\medskip\noindent
We first show that any submodule $N$ of a finite $R$-module 
$M$ is finite. We do this by induction on the number of
generators of $M$. If this number is $1$, then $N = J/I \subset
M = R/I$ for some ideals $I \subset J \subset R$. Thus the definition
of Noetherian implies the result. If the number of generators of
$M$ is greater than $1$, then we can find a short exact sequence
$0 \to M' \to M \to M'' \to 0$ where $M'$ and $M''$ have fewer
generators. Note that setting $N' = M' \cap N$ and $N'' = \text{Im}(N\to
M'')$ gives a similar short exact sequence for $N$. Hence the result
follows from the induction hypothesis 
since the number of generators of $N$ is at most the number of
generators of $N'$ plus the number of generators of $N''$.

\medskip\noindent
To show that $M$ is finitely presented just apply the previous result
to the kernel of a presentation $R^n \to M$.
\end{proof}

\begin{lemma}
\label{lemma-Noetherian-topology}
If $R$ is a Noetherian ring then $\text{Spec}(R)$ 
is a Noetherian topological space, see Topology,
Definition \ref{topology-definition-components}.
\end{lemma}

\begin{proof}
This is because any closed subset of $\text{Spec}(R)$
is uniquely of the form $V(I)$ with $I$ a radical ideal,
see Lemma \ref{lemma-Zariski-topology}.
And this correspdonce is inclusion reversing.
Thus the result follows from the definitions.
\end{proof}

\begin{lemma}
\label{lemma-Noetherian-irreducible-components}
If $R$ is a Noetherian ring then $\text{Spec}(R)$
has finitely many irreducible components. In other words
$R$ has finitely many minimal primes.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-Noetherian-topology} and
Topology, Lemma \ref{topology-lemma-Noetherian}
we see there are finitely many irreducible components.
By Lemma \ref{lemma-irreducible} these correspond to minimal primes of $R$.
\end{proof}

\begin{lemma}
\label{lemma-Noetherian-power}
Let $R$ be a Noethrian ring.
Let $I, J$ be ideals of $R$.
Suppose $J \subset \sqrt{I}$.
Then $J^n \subset I$ for some $n$.
\end{lemma}

\begin{proof}
Say $J = (f_1,\ldots,f_s)$. 
By assumption $f_i^{d_i} \in I$. 
Take $n = d_1 + d_2 + \ldots + d_s + 1$.
\end{proof}

\begin{lemma}
\label{lemma-Artin-Rees}
(Artin-Rees lemma.)
Suppose that $R$ is Noetherian, $I \subset R$ an ideal.
Let $N \subset M$ be finite $R$-modules.
There exists a constant $c > 0$ such that
$I^n M \cap N  =  I^{n-c}(I^cM \cap N)$.
\end{lemma}

\begin{proof}
Consider the ring $S = R \oplus I \oplus I^2 \oplus \ldots
= \bigoplus_{n \geq 0} I^n$. Convention: $I^0 = R$.
Multiplication maps $I^n \times I^m$
into $I^{n+m}$ by multiplitcation in $R$.
Note that if $I = (f_1, \ldots, f_t)$
then $S$ is a quotient of the Noetherian ring $R[X_1,\ldots,X_t]$.
The map just sends the monomial $X_1^{e_1}\ldots X_t^{e_t}$
to $f_1^{e_1}\ldots f_t^{e_t}$. Thus $S$ is Noetherian. 
Similarly, consider the module $M \oplus IM \oplus I^2M \oplus \ldots
= \bigoplus_{n \geq 0} I^nM$. This is a finitely generated $S$-module.
Namely, if $x_1,\ldots,x_r$ generate $M$ over $R$, then they also generate
$\bigoplus_{n \geq 0} I^nN$ over $S$. Next, consider the
submodule $\bigoplus_{n \geq 0} I^nM \cap N$.
This is an $S$-submodule, as is easily verified. By
Lemma \ref{lemma-Noetherian-permanence} it is finitely generated as
an $S$-module,
say by $\xi_j \in \bigoplus_{n \geq 0} I^nM \cap N$, $j = 1,\ldots,s$.
We may assume by decomposing each $\xi_j$ into its homogeneous
pieces that each $\xi_j \in I^{d_j}M \cap N$ for some $d_j$.
Set $c = \max\{d_j\}$. Then for all $n \geq c$ every element
in $I^nM \cap N$ is of the form $\sum h_j \xi_j$ with
$h_j \in I^{n - d_j}$. The lemma now follows from this and the trivial 
observation that $I^{n-d_j}(I^{d_j}M \cap N) \subset I^{n-c}(I^cM \cap N)$.
\end{proof}

\begin{lemma}
\label{lemma-map-AR}
Suppose that $0 \to K \to M \xrightarrow{f} N$ is an
exact sequence of finitely generated modules
over a Noetherian ring $R$. Let $I \subset R$ be an ideal.
Then there exists a $c$ such that $f^{-1}(I^nN)
= K + I^{n-c}f^{-1}(I^cN)$.
\end{lemma}

\begin{proof}
Apply Lemma \ref{lemma-Artin-Rees} to
$\text{Im}(f) \subset N$ and note that
$f : I^{n-c}M \to I^{n-c}f(M)$ is surjective.
\end{proof}

\section{Length}
\label{section-length}

\noindent
Let $R$ be a ring. For any $R$-module $M$
we define the {\it length} of $M$ over $R$ by the
formula
$$
\text{length}_R(M)
=
\sup
\{
n
\mid
\exists\ M_0 \subset M_1 \subset \ldots \subset M_n=M,
\text{ }M_i \not= M_{i+1}
\}.
$$
In other words it is the supremum of the lengths of chains 
of submodules.


\begin{lemma}
\label{lemma-length-additive}
If $0 \to M' \to M \to M'' \to 0$
is a short exact sequence of modules over $R$ then
the length of $M$ is the sum of the
lengths of $M'$ and $M''$.
\end{lemma}

\begin{proof}
Given filtrations of $M'$ and $M''$ of lengths $n', n''$
it is easy to make a corresponding filtration of $M$ 
of length $n' + n''$. Thus we see that $\text{length}_R M
\geq \text{length}_R M' + \text{length}_R M''$.
Conversely, given a filtration
$M_0 \subset M_1 \subset \ldots \subset M_n$ of
$M$ consider the induced filtrations
$M_i' = M_i \cap M'$ and $M_i'' = \text{Im}(M_i \to M'')$.
Let $n'$ (resp.\ $n''$) be the number of steps in the filtration
$\{M'_i\}$ (resp.\ $\{M''_i\}$).
If $M_i' = M_{i+1}'$ and $M_i'' = M_{i+1}''$ then
$M_i = M_{i+1}$. Hence we conclude that $n' + n'' \geq n$.
Combined with the earlier result we win.
\end{proof}

\begin{lemma}
\label{lemma-length-infinite}
Let $R$ be a local ring with maximal ideal $\mathfrak m$.
If $M$ is a finite $R$-module such that
$\mathfrak m^n M \not = 0$ for all $n\geq 0$,
then $\text{length}_R(M) = \infty$.
\end{lemma}

\begin{proof}
By NAK, Lemma \ref{lemma-NAK} all the steps in the filtration
$0 \subset \mathfrak m^n M 
\subset \mathfrak m^{n-1} M \subset \ldots \subset
\mathfrak m M \subset M$ are distinct.
\end{proof}

\begin{lemma}
\label{lemma-dimension-is-length}
Let $R$ be a local ring with maximal ideal $\mathfrak m$.
Suppose that $M$ is a finite $R$-module with
$\mathfrak m M  =  0$. Then the length of $M$ as
an $R$-module agrees with the dimension of $M$ as
a $R/\mathfrak m$ vector space, and it is finite.
\end{lemma}

\begin{proof}
A filtration of $M$ by $R$-submodules is the same as a filtration
of $M$ by subvector spaces.
\end{proof}

\begin{lemma}
\label{lemma-length-finite}
Let $R$ be a local ring with finitely generated
maximal ideal $\mathfrak m$. (For example $R$ Noetherian.)
Suppose that $M$ is a finite $R$-module with
$\mathfrak m^n M  =  0$ for some $n$. 
Then $\text{length}_R(M) < \infty$.
\end{lemma}

\begin{proof}
Consider the filtration
$0 = \mathfrak m^n M \subset
\mathfrak m^{n-1} M \subset
\ldots \subset \mathfrak m M \subset M$.
All of the subquotients are finitely generated $R$-modules
to which Lemma \ref{lemma-dimension-is-length}. We conclude
by additivity, see Lemma \ref{lemma-length-additive}.
\end{proof}

\section{Artinian rings}
\label{section-artinian}

\noindent
A ring $R$ is {\it Artinian} if it satisfies the 
descending chain condition for ideals.

\begin{lemma}
\label{lemma-artinian-finite-nr-max}
If $R$ is Artinian then $R$ has only finitely many
maximal ideals.
\end{lemma}

\begin{proof}
Suppose that $\mathfrak m_i$, $i=1,2,3,\ldots$ are maximal ideals.
Then $\mathfrak m_1 \supset \mathfrak m_1\cap \mathfrak m_2
\supset \mathfrak m_1 \cap \mathfrak m_2 \cap \mathfrak m_3 \supset \ldots$
is an infinite descending sequence (because by the Chinese
remainder theorem all the maps $R \to \oplus_{i=1}^n R/\mathfrak m_i$
are surjective).
\end{proof}

\begin{lemma}
\label{lemma-artinian-radical-nilpotent}
Let $R$ be Artinian. The radical $\text{rad}(R)$ of $R$ is
a nilpotent ideal.
\end{lemma}

\begin{proof}
Denote the radical $I$.
Note that $I \supset I^2 \supset I^3 \supset \ldots$ is a descending
sequence. Thus $I^n = I^{n+1}$ for some $n$.
Set $J = \{ x\in R \mid xI^n = 0\}$. We have to show $J = R$.
If not, choose an ideal $J' \not= J$, $J \subset J'$ minimal (possible
by the Artinian property). Then $J' = J + Rx$ for some $x \in R$.
By NAK, Lemma \ref{lemma-NAK}, we have $IJ' \subset J$.
Hence $xI^{n+1} \subset xI \cdot I^n \subset J \cdot I^n = 0$.
Since $I^{n+1}=I^n$ we conclude $x\in J$. Contradiction.
\end{proof}

\begin{lemma}
\label{lemma-lift-idempotents}
Suppose that $R$ is a ring and $I \subset R$ nilpotent.
Then $R \to R/I$ induces a bijection on idempotents.
\end{lemma}

\begin{proof}
Suppose $\overline{e} \in R/I$ is an idempotent.
We have to lift $\overline{e}$ to an idempotent of $R$.
Choose a lift $e \in R$ such that $x = e^2 - e \in I^k$ for some
$k\geq 1$. Let $e' = e - (2e-1)x$, which is another lift of $\overline{e}$
and compute $(e')^2 - e' =
e^2 - 2(2e-e)x - e + (2e-1)x \bmod I^{2k} =
x - x \bmod I^{2k} = 0 \bmod I^{2k}$.
By succesively improving the approximation as above we reach a
stage where $I^k = 0$, and we win.
\end{proof}

\begin{lemma}
\label{lemma-product-local}
Any ring with finitely many maximal ideals and
nilpotent radical is the product of its localizations
at its maximal ideal.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-artinian-finite-nr-max} there are
finitely many maximal ideals.
Let $I = \bigcap_{i=1}^n \mathfrak m_i$ be the radical of $R$.
Then $R/I \cong \bigoplus R/\mathfrak m_i$
which is a product of fields.
Hence by Lemma \ref{lemma-lift-idempotents}
there are nilpotents $e_i$, $i=1,\ldots,n$
with $e_i \bmod \mathfrak m_j = \delta_{ij}$.
Hence $R = \prod Re_i$, and each $Re_i$ is a
ring with exactly one maximal ideal.
\end{proof}

\begin{lemma}
\label{lemma-artinian-finite-length}
A ring $R$ is Artinian if and only if it has finite length
as a module over itself. Any such ring is both Artinian and
Noetherian, and is equal to the product of its localizations
at its maximal ideals.
\end{lemma}

\begin{proof}
If $R$ has finite length over itself then it satisfies both 
the ascending chain condition and the descending chain
condition for ideals. Hence it is both Noetherian and Artinian.
Any Artinian ring is equal to product of its localizations
at maximal ideals by Lemmas \ref{lemma-artinian-finite-nr-max},
\ref{lemma-artinian-radical-nilpotent}, and \ref{lemma-product-local}.

\medskip\noindent
Suppose that $R$ is Artinian. We will show $R$ has finite
length over itself. It suffices to exhibit a chain of
submodules whose succesive quotients have finite length.
By what we said above
we may assume that $R$ is local, with maximal ideal $\mathfrak m$.
By Lemma \ref{lemma-artinian-radical-nilpotent} we have
$\mathfrak m^n =0$ for some $n$. 
Consider the sequence
$0 = \mathfrak m^n \subset \mathfrak m^{n-1} \subset
\ldots \subset \mathfrak m \subset R$. By Lemma
\ref{lemma-dimension-is-length} the length of each subquotient
$\mathfrak m^j/\mathfrak m^{j+1}$ is the dimension of this
as a vector space over $\kappa(\mathfrak m)$. This has to be
finite since otherwise we would have an infinite descending
chain of subvector spaces which would correspond to an
infinite descending chain of ideals in $R$.
\end{proof}

\section{Completion}
\label{section-completion}

\noindent
Suppose that $R$ is a ring and $I$ is an ideal.
We define the {\it completion of $R$ with respect to $I$}
to be the limit
$$
\hat R = \lim_{n} R/I^n.
$$
An element of $\hat R$ is simply given by a sequence
of elements $f_n \in R/I^n$ such that $f_n \cong f_{n+1} \bmod I^n$
for all $n$. Similarly, if $M$ is an $R$-module then we define the
{\it completion of $M$ with respect to $I$}
to be the limit
$$
\hat M = \lim_{n} M/I^nM.
$$
An element of $\hat M$ is simply given by a sequence of
elemtents $m_n \in M/I^nM$ such that $m_n \cong m_{n+1} \bmod I^nM$
for all $n$. From this description it is clear that there 
is always a natural map
$$
M \otimes_R \hat R
\longrightarrow
\hat M.
$$

\begin{lemma}
\label{lemma-completion-tensor}
Suppose $R$ is Noetherian.
\begin{enumerate}
\item If $N \to M$ is an injective map of finite $R$-modules,
then $\hat N \to \hat M$ is injective.
\item If $M$ is a finite $R$-module, then $\hat M = M \otimes_R \hat R$.
\end{enumerate}
\end{lemma}

\begin{proof}
For the first statement, by the Artin-Rees Lemma \ref{lemma-Artin-Rees},
we have a constant $c$ such that $I^nM \cap N$
equals $I^{n-c}(I^cM \cap N) \subset I^{n-c}N$.
Thus if $(n_i) \in \hat N$ maps to zero in
$\hat M$, then each $n_i$ maps to zero in $N/I^{i-c}N$.
And hence $n_{i-c} = 0$. Thus $\hat N \to \hat M$ is injective.

\medskip\noindent
For the second statement let $0\to K \to R^t \to M \to 0$
be a presentation of $M$, corresponding the the generators
$x_1,\ldots,x_t$ of $M$. Let $(m_n) \in \hat M$.
We will inductively choose lifts $x_n \in (R/I^n)^t$ of 
$m_n \in M/I^nM$ such that $x_n \cong x_{n-1} \bmod (I^n)^t$.
Namely, given $x_1,\ldots, x_n$ choose some $y \in R^t$
lifting $x_n$. Then the image $\overline{y}$ and $m_{n=1}$
in $M/I^{n+1}M$ map to the same element in $M/I^nM$. 
Hence we can write the difference as
$\overline{y} - m_{n+1} = \sum h_j x_j$ with
$h_j \in I^n$. Take $x_{n+1} = y - \sum h_j e_j$, where
$e_j$ is the standard basis element of $R^t$.
This shows that $\hat R^t \to \hat M$ is surjective,
and hence for any finitely generated $R$-module the
canonical map $M \otimes_R \hat R \to M$ is surjective.
Hence to prove the second statement it suffices
to prove the the kernel of $\hat R^t \to \hat M$ is
exactly $\hat K$.

\medskip\noindent
Let $(x_n) \in \hat R^t$ be in the kernel. Note that
each $x_n$ is in the image of the map $K/I^nK \to (R/I^n)^t$.
Choose $c$ as in the Artin-Rees
Lemma \ref{lemma-Artin-Rees} such that $(I^n)^t \cap K 
\subset I^{n-c} K$. For each $n \geq 0$ choose 
$y_n \in K/I^{n+c}K$ mapping to $x_{n+c}$, and
set $z_n = y_n \bmod I^nK$. The elements $z_n$ satisfy $z_{n+1} - z_n \bmod I^nK
= y_{n+1} - y_{n} \bmod I^nK$, and $y_{n+1} - y_n \in
I^{n+c}R^t$ by construction. Hence $z_{n+1} \cong z_n \bmod I^nK$
by the choice of $c$ above.
\end{proof}

\begin{lemma}
\label{lemma-completion-flat}
Let $R$ be a Noetherian ring.
Let $I \subset R$ be an ideal.
The ring map $R \to \hat R$ is flat.
\end{lemma}

\begin{proof}
Let $I \subset R$ be an ideal.
Consider $I \otimes_R \hat R \to R\otimes_R \hat R = \hat R$.
According to Lemma \ref{lemma-completion-tensor} this
is identified with $\hat I \to \hat R$ and this is injective.
The result follows from Lemma \ref{lemma-flat}.
\end{proof}

\begin{lemma}
\label{lemma-completion-faithfully-flat}
Let $R$ be a Noetherian local ring.
Let $\mathfrak m \subset R$ be the maximal ideal.
Let $I \subset \mathfrak m$ be an ideal.
The ring map $R \to \hat R$ is faithfully flat.
In particular the completion with respect to $\mathfrak m$,
namely $\lim_n R/\mathfrak m^n$ is faithfully flat.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-completion-flat} it is flat.
The composition $R \to \hat R \to R/\mathfrak m$ where
the last map is the projection map $\hat R \to R/I$
combined with $R/I \to R/\mathfrak m$ shows that
$\mathfrak m$ is in the image of $\text{Spec}(\hat R)
\to \text{Spec}(R)$. Hence the map is faithfully
flat by Lemma \ref{lemma-ff}.
\end{proof}

\begin{lemma}
\label{lemma-mod-injective}
Suppose that $R \to S$ is a flat, local homomorphism of Noetherian
local rings. Denote $\mathfrak m$ the maximal ideal of $R$.
Let $u : M \to N$ be a map of finite $S$-modules.
Assume $N$ flat over $R$.
If $\overline{u} : M/\mathfrak mM \to N/\mathfrak mN$
is injective then $u$ is injective.
\end{lemma}

\begin{proof}
First we claim that $u_n : M/{\mathfrak m}^nM \to N/{\mathfrak m}^nN$ 
is injective for all $n \geq 1$. We proceed by induction, the base
case given by assumption. By our assumption that $N$ is flat
over $R$ we have  a short exact sequence
$0 \to N\otimes_R {\mathfrak m}^n/{\mathfrak m}^{n+1}
\to N/{\mathfrak m}^{n+1}N \to N/{\mathfrak m}^n N\to 0$.
Also, $N\otimes_R {\mathfrak m}^n/{\mathfrak m}^{n+1}
= N/{\mathfrak m}N \otimes_{R/{\mathfrak m}}
{\mathfrak m}^n/{\mathfrak m}^{n+1}$. We have 
a similar exact sequence $M\otimes_R {\mathfrak m}^n/{\mathfrak m}^{n+1}
\to M/{\mathfrak m}^{n+1}M \to M/{\mathfrak m}^n M\to 0$
for $M$ except we do not have the zero on the left. We also
have $M\otimes_R {\mathfrak m}^n/{\mathfrak m}^{n+1}
= M/{\mathfrak m}M \otimes_{R/{\mathfrak m}}
{\mathfrak m}^n/{\mathfrak m}^{n+1}$. Thus the map $u_{n+1}$ is
injective as both $u_n$ and the map
$\overline{u}\otimes \text{id}_{{\mathfrak m}^n/{\mathfrak m}^{n+1}}$ are.

\medskip\noindent
Note that $\lim_n M/{\mathfrak m}^nM$ is the completion
of the module $M$ with respect to the ideal $I = {\mathfrak m}S$,
and similarly for $N$. Since $M$ and $N$ are finite $S$-modules
we have $\hat M = M \otimes \hat S$ and similarly for $N$, see Lemma
\ref{lemma-completion-tensor}.
We conclude that $u \otimes 1 : M \otimes \hat S
\to N \otimes \hat S$ is injective. Since $\hat S$ is faithfully
flat over $S$, see Lemma \ref{lemma-completion-faithfully-flat},
we conclude that $u$ is injective, see Lemma \ref{lemma-flat}.
\end{proof}


\begin{lemma}
\label{lemma-grothendieck}
Suppose that $R \to S$ is a flat and local ring homomorphism of Noetherian
local rings. Denote $\mathfrak m$ the maximal ideal of $R$.
Suppose $f \in S$ is a nonzero divisor in $S/{\mathfrak m}S$.
Then $S/fS$ is flat over $R$.
\end{lemma}

\begin{proof}
Let $I \subset R$ be an ideal. We have to show that
$S/fS \otimes_R I \to S/fS$ is injective.
Consider the diagram
$$
\begin{matrix}
&
&
0
&
&
0
&
&
0
&
&
\\
&
&
\uparrow
&
&
\uparrow
&
&
\uparrow
&
&
\\
&
&
S/IS
&
\to
&
S/IS
&
\to
&
S/(I,f)S
&
\to
&
0
\\
&
&
\uparrow
&
&
\uparrow
&
&
\uparrow
&
&
\\
0
&
\to
&
S
&
\to
&
S
&
\to
&
S/IS
&
\to
&
0
\\
&
&
\uparrow
&
&
\uparrow
&
&
\uparrow
&
&
\\
0
&
\to
&
S \otimes_R I
&
\to
&
S \otimes_R I
&
\to
&
S/fS\otimes_R I
&
\to
&
0
\end{matrix}
$$
By flatness of $S/R$ we get $S\otimes_R I = IS$ and the
injectivity of multiplicaiton by $f$ on $S\otimes_RI$.
By the snake lemma it follows that to prove 
$S/fS \otimes_R I \to S/fS$ is injective it suffices
to show that multiplication by $f$ on $S/IS$ is injective.
Note that $S/IS$ is flat over $R/I$ by Lemma \ref{lemma-flat-base-change}.
Thus the lemma follows from Lemma \ref{lemma-mod-injective}.
\end{proof}

\section{K-groups}
\label{section-K-groups}

\noindent
Let $R$ be a ring. We will introduce two abelian groups associated
to $R$. The first of the two is denoted $K'_0(R)$ and has the following
properties:
\begin{enumerate}
\item For every finite $R$-module $M$ there is given an element $[M]$ in
$K'_0(R)$,
\item for every short exact sequence $0 \to M' \to M \to M'' \to 0$
we have the relation $[M] = [M'] + [M'']$, 
\item the group $K'_0(R)$ is generated by the elements $[M]$, and
\item all relations in $K_0(R)$ are $\mathbf{Z}$-linear combinations
of the relations coming from exact sequences as above.
\end{enumerate}
The actual construction is a bit more annoying since one has to take care
that the collection of all finitely generated $R$-modules is a proper class.
However, this problem can be overcome by taking as set of generators
of the group $K_0'(R)$ the elements $[R^n/K]$ where $n$ ranges over
all integers and $K$ ranges over all submodules $K \subset R^n$.
The generators of for the subgroup of relations imposed on these elements
will be the relations coming from short exact sequences whose terms
are of the form $R^n/K$. The element $[M]$ is defined by 
choosing $n$ and $K$ such that $M \cong R^n/K$ and putting
$[M] = [R^n/K]$. Details left to the reader.

\begin{lemma}
\label{lemma-length-K0}
If $R$ is an Artinian local ring then the length function
defines a natural abelian group homomoprhism
$\text{length}_R : K_0(R) \to \mathbf{Z}$.
\end{lemma}

\begin{proof}
The length of any finite $R$-module is finite,
because it is the quotient of $R^n$ which has finite length by
Lemma \ref{lemma-artinian-finite-length}. And the length function
is additive, see Lemma \ref{lemma-length-additive}.
\end{proof}

\medskip\noindent
The second of the two is denoted $K_0(R)$ and has the following
properties:
\begin{enumerate}
\item For every finite projective $R$-module $M$ there
is given an element $[M]$ in $K'_0(R)$,
\item for every short exact sequence $0 \to M' \to M \to M'' \to 0$
we have the relation $[M] = [M'] + [M'']$, 
\item the group $K'_0(R)$ is generated by the elements $[M]$, and
\item all relations in $K_0(R)$ are $\mathbf{Z}$-linear combinations
of the relations coming from exact sequences as above.
\end{enumerate}
The construction of this group is done as above.

\medskip\noindent
We note that there is an obvious map $K_0(R) \to K_0'(R)$
which is not an isomorphism in general.

\begin{example}
\label{example-K0-field}
Note that if $R = k$ is a field then we clearly have
$K_0(k) = K_0'(k) \cong \mathbf{Z}$ with the isomorphism
given by the dimension function (which is also the length function).
\end{example}

\section{Graded rings}
\label{section-graded}

\noindent
A {\it graded ring} will be for us a ring $S$ endowed
with a direct sum decomposition $S = \bigoplus_{d \geq 0} S_d$
such that $S_d \cdot S_e \subset S_{d+e}$.
Note that we do not allow (nonzero) elements in negative degrees.
The {\it irrelevant ideal} is the ideal $S_{+} = \bigoplus_{d > 0} S_d$.
A {\it graded module}
will be an $S$-module $M$ endowed with a direct sum decomposition
$M = \bigoplus_{n\in \mathbf{Z}} M_n$ such that $S_d \cdot M_e
\subset M_{d+e}$. Note that for modules we do allow
nonzero elements in negative degrees.
An element $x$ (resp.\ $f$) of $M$ (resp.\ $S$) is called
{\it homogeneous}
if $x \in M_d$ (resp.\ $f \in S_d$) for some $d$.
A {\it map of graded $S$-modules} is a map of $S$-modules
$\varphi : M \to M'$ such that $\varphi(M_d) \subset M'_d$.\footnote{We do not allow maps to shift degrees. Later we will define twisting and then we can express such maps in terms of the twisted modules.}

\medskip\noindent
At this point there are the notions of graded ideal,
graded quotient ring, graded submodule, graded quotient
module, etc. We leave it to the reader to find the
relevant definitions, and lemmas. For example: A short exact sequence
of graded modules is short exact in every degree.

\begin{lemma}
\label{lemma-graded-Noetherian}
A graded ring $S$ is Noetherian if and only if $S_0$ is 
Noetherian and $S_{+}$ is finitely generated. Furthermore,
a set of homogenenous elements $f_i \in S_{+}$ generates $S$
as an algebra over $S_0$ if and only if they generate
$S_{+}$ as an ideal.
\end{lemma}

\begin{proof}
It is clear that if $S$ is Noetherian then $S_0 S/S_{+}$ is Noetherian
and $S_{+}$ is finitely generated. It is also clear that if
$f_i$ generate $S$ over $S_0$ then they generate $S_{+}$ as an
ideal. Conversely, suppose that
$S_{+} = (f_1, \ldots, f_n)$ and $S_0$ Noetherian.
By decomposing the $f_i$ into homogenous pieces we may assume each
$f_i$ is homogeneous. Consider the map
$\Psi : S_0[X_1,\ldots X_n] \to S$ which maps $X_i$ to $f_i$.
We claim this is surjective. Once we have seent his the result
follows from Lemma \ref{lemma-Noetherian-permanence}.
Namely, suppose that $f \in S_d$ for some $d$.
By assumption we may write $f = \sum a_i f_i$.
We may replace $a_i$ by its piece of degree $\deg(f) - \deg(f_i)$
and still obtain a valid relation. Now each $a_i$ is homogenous
of strictly smaller degree than $f_i$, and hence by induction
on the degree we may assume $a_i$ is in the image of $\Psi$.
Of course then $f$ is in the image too.
\end{proof}

\begin{definition}
\label{definition-numerical-polynomial}
Let $A$ be an abelian group.
We say that a function $f : n \mapsto f(n) \in A$
defined for all sufficient large integers $n$ is a
{\it numerical polynomial} if there exists $r \geq 0$,
elements $a_0,\ldots,a_r\in A$ such that
$$
f(n) = \sum\nolimits_{i=0}^r {n \choose i}a_i
$$
for all $n \gg 0$.
\end{definition}

\noindent
The reason for using the binomial coefficients is the
elementary fact that any polynomial $P \in \mathbf{Q}[T]$
all of whose values at integer points are integers, is
equal to a sum $P(T) = \sum a_i{T \choose i}$ with
$a_i \in \mathbf{Z}$. Note that in particular the 
expressions ${T+1 \choose i + 1}$ are of this form.

\begin{lemma}
\label{lemma-numerical-polynomial-functorial}
If $A \to A'$ is a homomorphism of abelian groups and if
$f : n \mapsto f(n) \in A$ is a numerical polynomial,
then so is the composition.
\end{lemma}

\begin{proof}
This is immediate from the definitions.
\end{proof}

\begin{lemma}
\label{lemma-numerical-polynomial}
Suppose that $f: n \mapsto f(n) \in A$
is defined for all $n$ sufficiently large
and suppose that $n \mapsto f(n) - f(n-1)$
is a numerical polynomial. Then $f$ is a
numerical polynomial.
\end{lemma}

\begin{proof}
Let $f(n) - f(n-1) = \sum\nolimits_{i=0}^r {n \choose i}a_i$
for all $n \gg 0$. Set
$g(n) = f(n) - \sum\nolimits_{i=0}^r {n+1 \choose i+1}a_i$.
Then $g(n) - g(n-1) = 0$ for all $n \gg 0$. Hence $g$ is
eventually constant, say equal to $a_{-1}$. We leave it
to the reader to show that
$a_{-1} + \sum\nolimits_{i=0}^r {n+1 \choose i+1}a_i$
has the required shape (see remark above the lemma).
\end{proof}

\begin{lemma}
\label{lemma-graded-module-fg}
If $M$ is a finitely generated graded $S$-module,
and if $S$ is finitely generated over $S_0$, then
each $M_n$ is a finite $S_0$-module.
\end{lemma}

\begin{proof}
Suppose the generators of $M$ are $m_i$ and the generators
of $S$ are $f_i$. By taking homogeneous components we may
assume that the $m_i$ and the $f_i$ are homogeneous
and we may assume $f_i \in S_{+}$. In this case it is
clear that each $M_n$ is generated over $S_0$
by the ``monomials'' $\prod f_i^{e_i} m_j$ whose
degree is $n$.
\end{proof}

\begin{proposition}
\label{proposition-graded-hilbert-polynomial}
Suppose that $S$ is a Noetherian graded ring
and $M$ a finite graded $S$-module. Consider the
function
$$
\mathbf{Z} \longrightarrow K_0'(S_0),\ \ 
n \longmapsto [M_n]
$$
see Lemma \ref{lemma-graded-module-fg} above.
If $S_{+}$ is generated by elements of degree $1$,
then this function is a numerical polynomial.
\end{proposition}

\begin{proof}
We prove this by induction on the minimal number of
generators of $S_1$. If this number is $0$, then
$M_n = 0$ for all $n \gg 0$ and the result holds.
To prove the induction step, let $x\in S_1$
be one of a minimal set of generators, such that
the induction hypothesis applies to the
graded ring $S/(x)$.

\medskip\noindent
First we show the result holds if $x$ is nilpotent on $M$.
This we do by induction on the minimal integer $r$ such that
$x^r M  = 0$. If $r = 1$, then $M$ is a module over $S/xS$
and the result holds (by the other induction hypothesis).
If $r > 1$, then we can find a short exact sequence
$0 \to M' \to M \to M'' \to 0$ such that the integers
$r', r''$ are stricly smaller than $r$. Thus we know
the result for $M''$ and $M'$. Hence
we get the result for $M$ because of the relation
$
[M_d]  = [M'_d] + [M''_d]
$
in $K_0'(R)$.

\medskip\noindent
If $x$ is not nilpotent on $M$, let $M' \subset M$ be
the largest submodule on which $x$ is nilpotent. 
Consider the exact sequence $0 \to M' \to M \to M/M' \to 0$
we see again it suffices to prove the result for $M/M'$. In other
words we may assume that multiplication by $x$ is injective.

\medskip\noindent
Let $\overline{M} = M/xM$. Note that the map $x : M \to M$
is {\it not} a map of graded $S$-modules, since it does
not map $M_d$ into $M_d$. Namely, for each $d$ we have the
following short exact sequence
$$
0 \to M_d \xrightarrow{x} M_{d+1} \to \overline{M}_{d+1} \to 0
$$
This proves that $[M_{d+1}] - [M_d] = [\overline{M}_{d+1}]$.
Hence we win by Lemma \ref{lemma-numerical-polynomial}.
\end{proof}

\begin{remark}
If $S$ is still Noetherian but $S$ is not generated in degree $1$,
then the function associated to a graded $S$-module is a periodic
polynomial (i.e., it is a numerical polynomial on the
congruence classes of integers modulo $n$ for some $n$).
\end{remark}

\begin{example}
\label{example-hilbert-function}
Suppose that $S = k[X_1,\ldots,X_d]$.
By Example \ref{example-K0-field} we may identify
$K_0(k) = K_0'(k) = \mathbf{Z}$. Hence any finitely
generated graded $k[X_1,\ldots,X_d]$-module
gives rise to a numerical polynomial
$n \mapsto \dim_k(M_n)$.
\end{example}

\begin{lemma}
\label{lemma-quotient-smaller-d}
Let $k$ be a field. Suppose that $I \subset k[X_1,\ldots,X_d]$
is a nonzero graded ideal. Let $M = k[X_1,\ldots,X_d]/I$.
Then the numerical polynomial $n \mapsto \dim_k(M_n)$ (see
Example \ref{example-hilbert-function} above)
has degree $ < d - 1$ (or is zero if $d = 1$).
\end{lemma}

\begin{proof}
The numerical polynomial associated to the graded module
$k[X_1,\ldots,X_n]$ is $n \mapsto {n - 1 + d \choose d - 1}$.
For any nonzero homogeneous $f \in I$ of degree $e$
and any degree $n >> e$ we have $I_n \supset f \cdot k[X_1,\ldots,X_d]_{n-e}$
and hence $\dim_k(I_n) \geq {n - e - 1 + d \choose d - 1}$.
Hence $\dim_k(M_n) \leq {n - 1 + d \choose d - 1} -
{n - e - 1 + d \choose d - 1}$. We win because the last expression
has degree $ < d - 1$ (or is zero if $d = 1$).
\end{proof}

\section{Noetherian local rings}
\label{section-Noetherian-local}

\noindent
In all of this section $(R, \mathfrak m, \kappa)$
is a Noetherian local ring. 
Let $M$ be a finite $R$-module. We define the {\it Hilbert
function} of $M$ to be the function
$$
\varphi_M : n 
\longmapsto
\text{length}_R(\mathfrak m^nM/{\mathfrak m}^{n+1}M).
$$
Note that we have by Lemma \ref{lemma-length-additive}
that
$$
\text{length}_R(M / \mathfrak m^{n+1}M)
=
\sum\nolimits_{i=0}^n
\varphi_M(i).
$$
There is a variant of this construction which uses an
ideal $I \subset R$ such that $\sqrt{I} = \mathfrak m$.
Such an ideal is called {\it an ideal of definition
of $R$}. Because $R$ is Noetherian this means that
$\mathfrak m^r \subset I$ for some $r$, see Lemma
\ref{lemma-Noetherian-power}. Hence any finite $R$-module
annihilated by a power of $I$ has a finite length, see Lemma
\ref{lemma-length-finite}.
Thus in this case we may put
$$
\varphi_{I,M} : n 
\longmapsto
\text{length}_R(I^nM/I^{n+1}M).
$$
Again we have that
$$
\text{length}_R(M / I^{n+1}M)
=
\sum\nolimits_{i=0}^n
\varphi_{I,M}(i).
$$

\begin{lemma}
\label{lemma-differ-finite}
Suppose that $M' \subset M$ are finite $R$-modules
with finite length quotient.
Then there exist constants $c_1, c_2$
such that $\varphi_{I,M}(n) \geq \varphi_{I, M'}(n-c_1) - c_2$
and $\varphi_{I, M'}(n) \geq \varphi_{I,M}(n) - c_2$.
\end{lemma}

\begin{proof}
By induction on the length of $M/M'$ we may assume
that $M'/M$ has length $1$, i.e., that $M/M' \cong R/\mathfrak m$.
In this case $IM \subset M'$ and hence
$\varphi_{I, M}(n) \geq \varphi_{I, M'}(n-1) - 1$.
On the other hand, $\varphi_{I, M'}(n) \geq \varphi_{I, M}(n) - 1$
because of the relations $M'/I^nM' \supset M/I^nM' \to M/I^nM$.
\end{proof}

\begin{lemma}
\label{lemma-hilbert-ses}
Suppose that $0 \to M' \to M \to M'' \to 0$
is a short exact sequence of finite $R$-modules.
Then there exists a submodule $N \subset M'$ with
finite colength and an integer $c$ such that $\varphi_{I,M}(n)
= \varphi_{I, M''}(n) + \varphi_{I,N}(n-c)$ for all $n$ large enough.
\end{lemma}

\begin{proof}
Note that $M/I^nM \to M''/I^nM''$ is surjective
with kernel $M' / M' \cap I^nM$. By the Artin-Rees
Lemma \ref{lemma-Artin-Rees} there exists a
constant $c$ such that $M' \cap I^nM =
I^{n-c}(M' \cap I^cM)$. Denote $N = M' \cap I^cM$.
Note that $I^c M' \subset N \subset M'$.
Hence $\text{length}_R(M' / M' \cap I^nM) 
= \text{length}_R(M'/N) + \text{length}_R(N/I^{n-c}N)$.
Then we obtain the equality
$$
\sum_{i=0}^{n-1} \varphi_{I,M}(i)
=
\sum_{i=0}^{n-1} \varphi_{I,M''}(i)
+
\sum_{i=0}^{n-c-1} \varphi_{I,N}(i)
+
\text{length}_R(M'/N)
$$
for $n$ large enough. Thus we get $\varphi_{I,M}(n)
= \varphi_{I, M''}(n) + \varphi_{I,N}(n-c)$ for
$n$ large enough.
\end{proof}

\begin{lemma}
\label{lemma-hilbert-change-I}
Suppose that $I$, $I'$ are two ideals of definition
for the Noetherian local ring $R$. Let $M$ be a
finite $R$-module. There exists a constant $a$ such that
$
\sum_{i = 0}^n \varphi_{I,M}(i) \leq
\sum_{i = 0}^{an}\varphi_{I',M}(i)$.
\end{lemma}

\begin{proof}
There exists an integer $a$ such that $(I')^a \subset I$.
Hence we get a surjection $M/(I')^{a(n+1)}M \to M/I^{n+1}M$.
Whence the result (with $a+1$).
\end{proof}

\begin{proposition}
\label{proposition-hilbert-function-polynomial}
For every Noetherian local ring $R$, any $I \subset R$
such that $\sqrt{I} = \mathfrak m$ and every
finite $R$-module $M$ the hilbert function $\varphi_{I,M}$
is a numerical polynomial.
\end{proposition}

\begin{proof}
Consider the graded ring $S = R/I \oplus I/I^2 \oplus I^2/I^3 \oplus
\ldots = \bigoplus_{d \geq 0} I^d/I^{d+1}$. Consider the graded
$S$-module $N = M/IM \oplus IM/I^2M \oplus \ldots =
\bigoplus_{d \geq 0} I^dM/I^{d+1}M$. This pair $(S, N)$ satisfies
the hypotheses of Proposition \ref{proposition-graded-hilbert-polynomial}.
Hence the result follows from that Proposition, and
Lemma \ref{lemma-length-K0}.
\end{proof}

\begin{lemma}
\label{lemma-d-independent}
Suppose that $M$ is a finite $R$-module.
The degree of the numerical polynomial 
$\varphi_{I,M}$ is independent of the
ideal of definition $I$.
\end{lemma}

\begin{proof}
This follows immediately from Lemma \ref{lemma-hilbert-change-I}.
\end{proof}

\begin{definition}
\label{definition-d}
If $R$ is a local Noetherian ring and $M$ a finite $R$-module.
If $\mathfrak m^nM = 0$ we set $d(M) = 0$.
Otherwise we denote $d(M)$ the degree $+1$ of any of the numerical polynomials
$\varphi_{I,M}$ above.
\end{definition}

\noindent
In other words, $d(M)$ is the degree of the numerical polynomial
$n \mapsto \text{length}_R(M/I^nM)$ for any ideal of definition $I$.
We will denote this function
$$
\chi_{I,M}(n) = \text{length}_R(M/I^{n+1}M).
$$
We will frequently use that $\chi_{I,M}(n)
= \sum_{i=0}^n \varphi_{I,M}(i)$ without further mention.

\begin{lemma}
\label{lemma-differ-finite-chi}
Suppose $M \subset M'$ with finite length quotient,
but neither finite length.
Then $\chi_{I,M} - \chi_{I,M'}$
is a polynomial of degree $<$ degree of either 
polynomial.
\end{lemma}

\begin{proof}
Immediate from Lemma \ref{lemma-differ-finite} by elementary calculus.
\end{proof}

\begin{lemma}
\label{lemma-hilbert-ses-chi}
Suppose that $0 \to M' \to M \to M'' \to 0$
is a short exact sequence of finite $R$-modules.
The $\max\{ \deg(\chi_{I, M'}), \deg(\chi_{I, M''}) \}
= \deg(\chi_{I, M})$.
Suppose the length of $M'$ is not finite.
Then $\chi_{I,M} - \chi_{I, M''} - \chi_{I,M'}$
is a numerical polynomial of degree $<$ the degree of
$\chi_{I,M'}$.
\end{lemma}

\begin{proof}
Immediate from Lemma \ref{lemma-hilbert-ses}, and 
\ref{lemma-differ-finite-chi} by elementary calculus.
\end{proof}

\section{Images and ring maps of finite presentation}
\label{section-images-finite-presentation}

\noindent
In this section we prove some results on the 
topology of maps $\text{Spec}(S) \to \text{Spec}(R)$
induced by ring maps $R \to S$. First we discuss Chevalley's Theorem.
In order to do this we will use the notions of constructible sets,
quasi-compact sets, retrocompact sets, and so on
which are defined in Topology, Section \ref{topology-section-quasi-compact}.

\begin{lemma}
\label{lemma-qc-open}
Let $U \subset \text{Spec}(R)$ be open. The following
are equivalent:
\begin{enumerate}
\item $U$ is retrocompact in $\text{Spec}(R)$,
\item $U$ is quasi-compact, and
\item $U$ is a finite union of standard opens.
\end{enumerate}
\end{lemma}

\begin{proof}
The implication (2)$\Rightarrow$(3) is immediate from the fact that standard
opens form a basis for the topology. Each standard open is
homeomorphic to the spectrum of a ring and hence quasi-compact,
by Lemmas \ref{lemma-quasicompact} and \ref{lemma-standard-open}.
To finish it suffices to show that a finite union
$\cup_{i=1\ldots n} D(f_i)$ is retrocompact in $\text{Spec}(R)$.
In order to do this it suffices to show that 
$(\cup_{i=1\ldots n} D(f_i)) \cap (\cup_{j=1\ldots m} D(g_j))$
is quasi-compact, which is clear because it equals
$\cup_{i,j} D(f_i g_j)$.
\end{proof}

\begin{lemma}
\label{lemma-constructible-is-image}
Let $R$ be a ring and let $T \subset \text{Spec}(R)$
be constructible. Then there exists an $R \to S$ of
finite presentation such that $T$ is the image of
$\text{Spec}(S)$ in $\text{Spec}(R)$.
\end{lemma}

\begin{proof}
Since the spectrum of a finite product of rings 
is the dijoint union of the spectra, we may assume
that $T = (\cup D(f_i)) \cap (\cup D(g_j))^c$.
In fact we may assume that $T = D(f) \cap V(g_1,\ldots,g_m)$.
In this case $T$ is the image of the map
$R \to (R/(g_1,\ldots,g_m))_f$.
\end{proof}

\begin{lemma}
\label{lemma-open-fp}
Let $R$ be a ring.
Let $f$ be an element of $R$.
Let $S = R_f$.
Then the image of a constructible of $\text{Spec}(S)$
is constructible in $\text{Spec}(R)$.
\end{lemma}

\begin{proof}
Follows immediately from Lemma \ref{lemma-qc-open} and the
definitions.
\end{proof}

\begin{lemma}
\label{lemma-closed-fp}
Let $R$ be a ring.
Let $I$ be a finitely generated ideal of $R$.
Let $S = R/I$.
Then the image of a constructible of $\text{Spec}(S)$
is constructible in $\text{Spec}(R)$.
\end{lemma}

\begin{proof}
If $I = (f_1,\ldots,f_m)$, then we see that
$V(I)$ is the complement of $\cup D(f_i)$ and
hence constructible, by Lemma \ref{lemma-qc-open}.
Denote the map $R \to S$ by $f \mapsto \overline{f}$.
We have to show that if $\overline{U}, \overline{V}$
are retrocompact opens of $\text{Spec}(S)$, then the
image of $\overline{U} \cap \overline{V}^c$
in $\text{Spec}(R)$ is constructible.
By Lemma \ref{lemma-qc-open} we may write
$\overline{U} = \cup D(\overline{g_i})$.
Setting ${U} = \cup D({g_i})$ we see $\overline{U}$
has image $U \cap V(I)$ which is constructible in
$\text{Spec}(R)$. Similarly the image of $\overline{V}$ equals
$V \cap V(I)$ for some retrocompact open $V$ of $\text{Spec}(R)$.
Hence the image of $\overline{U} \cap \overline{V}^c$
equals $U \cap V(I) \cap V^c$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-affineline-open}
Let $R$ be a ring. The map $\text{Spec}(R[x]) \to \text{Spec}(R)$
is open, and the image of any standard open is a quasi-compact
open.
\end{lemma}

\begin{proof}
It suffices to show that the image of a standard open
$D(f)$, $f\in R$ is quasi-compact open.
Recall that $\mathfrak p\subset R$ is in the image
if and only if $\kappa(\mathfrak p)[x]_f$ is not the
zero ring. This is exactly the condition that $f$ does not map
to zero in $\kappa(\mathfrak p)[x]$, in other words, that
some coefficient of $f$ is not in $\mathfrak p$.
Hence we see: if $f = a_d x^d + \ldots a_0$, then
the image of $D(f)$ is $D(a_d) \cup \ldots \cup D(a_0)$.
\end{proof}

\begin{lemma}
\label{lemma-affineline-special}
Let $R$ be a ring. Let $f, g \in R[x]$ be polynomials.
Assume the leading coefficient of $g$ is a unit of $R$.
There exists elements $r_i\in R$, $i=1\ldots,n$ such that
the image of $D(f) \cap V(g)$ in $\text{Spec}(R)$ is
$\cup D(r_i)$.
\end{lemma}

\begin{proof}
Write $g = ux^d + a_{d-1}x^{d-1} + \ldots a_0$, where
$d$ is the degree of $g$, and hence $u \in R^*$.
Consider the ring $A = R[x]/(g)$.
It is, as an $R$-module, finite free with basis the images
of $1,x,\ldots,x^{d-1}$. Consider multiplication
by (the image of) $f$ on $A$. This is an $R$-module map.
Hence we can let $P(T) \in R[T]$ be the characteristic polynomial
of this map. Write $P(T) = T^d + r_{d-1} T^{d-1} + \ldots r_0$.
We claim that $r_0, \ldots, r_{d-1}$ have the desired property.
We will use below the property of characteristic polynomials 
that
$$
\mathfrak p \in V(r_0, \ldots, r_{d-1})
\Leftrightarrow
\text{multiplication by }g\text{ nilpotent on }
A\otimes_R \kappa(\mathfrak p).
$$

\medskip\noindent
Suppose $\mathfrak q\in D(f) \cap V(g)$, and let
$\mathfrak p = \mathfrak q \cap R$. Then
$A\otimes_R \kappa(\mathfrak p)$ surjects onto $\kappa(\mathfrak q)$
and $g$ acts as a unit on $\kappa(\mathfrak q)$. 
Thus we conclude $\mathfrak p \not \in  V(r_0, \ldots, r_{d-1})$.

\medskip\noindent
On the other hand, suppose that $r_i \not\in \mathfrak p$ for some
prime $\mathfrak p$ of $R$ and some $0 \leq i \leq d-1$.
Then multiplication by $f$ is not nilpotent on the algebra
$A \otimes_R \kappa(\mathfrak p)$.
Hence there exists a maximal ideal $\overline{\mathfrak q} \subset
A \otimes_R \kappa(\mathfrak p)$ not containing the image of $f$.
The inverse image of $\overline{\mathfrak q}$ in $R[x]$ 
is an element of $D(f) \cap V(g)$ mapping to $\mathfrak p$.
\end{proof}

\begin{theorem}
\label{theorem-chevalley}
Suppose that $R \to S$ is of finite presentation.
The image of a constructible subset of
$\text{Spec}(S)$ in $\text{Spec}(R)$ is constructible.
\end{theorem}

\begin{proof}
Write $S = R[x_1,\ldots,x_n]/(f_1,\ldots,f_m)$.
We may factor $R \to S$ as $R \to R[x_1] \to R[x_1,x_2]
\to \ldots \to R[x_1,\ldots,x_{n-1}] \to S$. Hence 
we may assume that $S = R[x]/(f_1,\ldots,f_m)$.
In this case we factor the map as $R \to R[x] \to S$,
and by Lemma \ref{lemma-closed-fp} we reduce to
the case $S = R[x]$. By Lemma \ref{lemma-qc-open} suffices
to show that if
$T = (\cup_{i=1\ldots n} D(f_i)) \cap V(g_1,\ldots,g_m)$ 
for $f_i , g_j \in R[x]$ then the image in $\text{Spec}(R)$ is
constructible. Since finite unions of constructible sets
are constructible, it suffices to deal with the case $n=1$,
i.e., when $T = D(f) \cap V(g_1,\ldots,g_m)$.

\medskip\noindent
Note that if $c \in R$, then we have $\text{Spec}(R) =
V(c) \sqcup D(c) = \text{Spec}(R/(c)) \sqcup 
\text{Spec}(R_c))$, and correspondingly $\text{Spec}(R[x]) =
V(c) \sqcup D(c) = \text{Spec}(R/(c)[x]) \sqcup 
\text{Spec}(R_c[x]))$. The intersection of $T = D(f) \cap V(g_1,\ldots,g_m)$
with each part still has the same shape, with $f$, $g_i$ replaced
by their images in $R/(c)[x]$, respectively $R_c[x]$.
Note that the image of $T$
in $\text{Spec}(R)$ is the union of the image of
$T \cap V(c)$ and $T \cap D(c)$. Using Lemmas \ref{lemma-open-fp}
and \ref{lemma-closed-fp} it suffices to prove the images of both
parts are constructible in $\text{Spec}(R/(c))$, respectively
$\text{Spec}(R_c)$.

\medskip\noindent
Let us assume we have $T = D(f) \cap V(g_1,\ldots,g_m)$
as above, with $\deg(g_1) \leq \deg(g_2) \leq \ldots \leq \deg(g_m)$.
We are going to use descending induction on $m$, and on the 
degrees of the $g_i$. Let $d = \deg(g_1)$, i.e., $g_1 = c x^{d_1} + l.o.t$
with $c \in R$ not zero. Cutting $R$ up into the pieces
$R/(c)$ and $R_c$ we either lower the degree of $g_1$ (and this
is covered by induction)
or we reduce to the case where $c$ is invertible.
If $c$ is invertible, and $m > 1$, then write
$g_2 = c' x^{d_2} + l.o.t$. In this case consider
$g_2' = g_2 - (c'/c) x^{d_2 - d_1} g_1$. Since the ideals
$(g_1, g_2, \ldots, g_m)$ and $(g_1, g_2', g_3, \ldots, g_m)$
are equal we see that $T = D(f) \cap V(g_1,g_2',g_3\ldots,g_m)$.
But here the degree of $g_2'$ is strictly less than the degree
of $g_2$ and hence this case is covered by induction.

\medskip\noindent
The bases case for the induction above are the cases
(a) $T = D(f) \cap V(g)$ where the leading coefficient
of $g$ is invertible, and (b) $T = D(f)$. These two cases
are dealt with in Lemmas \ref{lemma-affineline-special}
and \ref{lemma-affineline-open}.
\end{proof}


\begin{proposition}
\label{proposition-fppf-open}
Let $R \to S$ be flat and of finite presentation.
Then $\text{Spec}(R) \to \text{Spec}(S)$ is open.
\end{proposition}

\begin{proof}
It suffices to prove that the image of a standard open $D(f)$ is open.
After replacing $S$ by $S_f$ we see it suffices to prove the image is
open. Let $T \subset \text{Spec}(R)$ be the complement of the image.
Let $\mathfrak p$ be in the image (hence $\mathfrak p \not \in T$),
and in the closure of $T$. According to
Lemma \ref{lemma-constructible-is-image} we may
write $T$ as the image of $\text{Spec}(S') \to \text{Spec}(R)$
for some finitely presented $R$-algebra $S'$. The fact that $\mathfrak p$
is in the closure of $T$ means that for all $f \in R \setminus \mathfrak p$
the ring $S'_f$ is not zero. By Lemma \ref{lemma-localize-colimit}
we see that $S'_{\mathfrak p} = S' \otimes_R R_{\mathfrak p}$
is not zero. (Because you can test whether a ring is zero
by testing whether $1=0$ which does not happen in any of the
$S'_f$ above.) This implies that there is an point of
$\text{Spec}(R_{\mathfrak p})$ which is not in the image
of $\text{Spec}(S_{\mathfrak p}) \to \text{Spec}(R_{\mathfrak p})$
and this contradicts Lemma \ref{lemma-flat-gd}.
\end{proof}

\section{Differentials}
\label{section-differentials}

\begin{definition}
\label{definition-derivation}
Let $\varphi : R \to S$ be a ring map and let $M$ be an $S$-module.
An {\it $R$-derivation} into $M$ is a map $D : S \to M$
which is additive, annihilates elements of $\varphi(R)$,
and satisfies the {\it Leibniz rule}: 
$D(ab) = aD(b) + D(a)b$.
\end{definition}

\noindent
Note that $D(ra) = rD(a)$ if $r\in R$ and $a\in S$.
The set of all $R$-derivations forms an
$S$-module: Given two $R$-derivations $D, D'$
the sum $D+D' : S \to M$, $a \mapsto D(a)+D'(a)$
is an $R$-derivation, and given an $R$-derivation $D$
and an element $c\in S$ the scalar multiple $cD : S \to M$,
$a \mapsto cD(a)$ is an $R$-derivation. We denote this
$S$-module
$$
\text{Der}_R(S, M).
$$
Also, if $\alpha : M \to N$ is an $S$-module map, then the
composition $\alpha \circ D$ is an $R$-derivation into
$N$. In this way the assignment $M \mapsto \text{Der}_R(S, M)$
is a covariant functor.

\medskip\noindent
Let $\Omega_{S/R}$ be the $S$-module which has the
following presentation:
$$
\begin{matrix}
\bigoplus_{(a,b)\in S^2} S[(a,b)] \oplus \bigoplus_{r\in R} S[r]
&
\to
&
\bigoplus_{a\in S} S [a]
&
\to
&
\Omega_{S/R}
&
\to
&
0
\\
[(a,b)]
&
\mapsto
&
a[b] + b[a]
&
&
&
&
\\
[r]
&
\mapsto
&
[\varphi(r)]
&
&
&
&
\end{matrix}
$$
Here the notation is that $[\xi]$ represents the basis
element corresponoding to the element $\xi$ of the index set
of the direct sum. There is a map $\text{d} : S \to \Omega_{S/R}$
which maps $a$ to the class $\text{d}a$ of $[a]$ in the cokernel.
It is obvious that this is an $R$-derivation.
The pair $(\Omega_{S/R}, \text{d})$ is called the module
of K\"ahler diffentials of $S$ over $R$.

\begin{lemma}
\label{lemma-universal-omega}
The module of differentials of $S$ over $R$ has the following
universal property. The map
$$
\text{Hom}_S(\Omega_{S/R}, M)
\longrightarrow
\text{Der}_R(S, M),\ \ 
\alpha 
\longmapsto
\alpha \circ \text{d}
$$
is an isomorphism of functors.
\end{lemma}

\begin{proof}
By definition an $R$-derivation is a rule which associates
to each $a \in S$ an element $D(a) \in M$. Thus $D$ gives
rise to a map $[D] : \bigoplus S[a] \to M$. However, the conditions
of being an $R$-derivation exactly mean that $[D]$ annihilates
the image of the leftmost map in the displayed presentation of
$\Omega_{S/R}$ above.
\end{proof}

\noindent
Suppose that
$$
\xymatrix{
S \ar[r]^\varphi
&
S'
\\
R \ar[r]^\psi \ar[u]^\alpha
&
R' \ar[u]^\beta
}
$$
is a commutative diagram of rings. In this case there is a
natural map of modules of differentials fitting into the
commutative diagram
$$
\begin{matrix}
\Omega_{S/R}
&
\longrightarrow
&
\Omega_{S'/R'}
\\
\uparrow
&
&
\uparrow
\\
S
&
\longrightarrow
&
S'
\end{matrix}
$$
To construct the map just use the obvious map
between the presentations for $\Omega_{S/R}$ and $\Omega_{S'/R'}$.
Namely,
$$
\xymatrix{
\bigoplus_{(a',b')\in (S')^2} S'[(a',b')]
\oplus
\bigoplus_{r'\in R'} S'[r'] \ar[r]
&
\bigoplus_{a'\in S'} S' [a'] \ar[r]
&
\Omega_{S'/R'} \ar[r]
&
0
\\
\bigoplus_{(a,b)\in (S)^2} S[(a,b)]
\oplus
\bigoplus_{r\in R} S[r] \ar[r]
\ar[u]^{[(a,b)] \mapsto [(\varphi(a),\varphi(b)]}_{[r]\mapsto [\psi(r)]}
&
\bigoplus_{a\in S} S[a] \ar[r] \ar[u]^{[a] \mapsto [\varphi(a)]}
&
\Omega_{S'/R'} \ar[r] \ar[u]
&
0
}
$$

\begin{lemma}
\label{lemma-trivial-differential-surjective}
Suppose that $R \to S$ is surjective.
Then $\Omega_{S/R} = 0$.
\end{lemma}

\begin{proof}
You can see this either because all $R$-derivations
clearly have to be zero, or because
the map in the presentation of $\Omega_{S/R}$ is surjective.
\end{proof}

\begin{lemma}
\label{lemma-differential-surjective}
Suppose that $S \to S'$ is surjective with kernel $I \subset S$.
Then $\Omega_{S/R} \to \Omega_{S'/R'}$ is surjective with
kernel generated as an $S$-module by the elements 
\begin{enumerate}
\item $i\eta$ with $i\in I$ and $\eta \in \Omega_{S/R}$,
\item $\text{d}i$, $i \in I$, and
\item the elements $\text{d}f$, where $f \in S$ is
such that $\varphi(f) \in \beta(R')$.
\end{enumerate}
\end{lemma}

\begin{proof}
Consider the map of presentations above. Clearly the middle vertical
map of free modules is surjective. Thus the map is surjective.
An easy diagram chase completes the proof.
\end{proof}

\begin{lemma}
\label{lemma-differential-seq}
Suppose that $S \to S'$ is surjective with kernel $I \subset S$,
and assume that $R' = R$.
Then there is a canonical exact sequence of $S'$-modules
$$
I/I^2 
\longrightarrow
\Omega_{S/R}\otimes_S S'
\longrightarrow
\Omega_{S'/R}
\longrightarrow
0
$$
The rightmost map is characterized by the rule that
$f \in I$ maps to $\text{d}f \otimes 1$.
\end{lemma}

\begin{proof}
Note that the middle term can also be written as 
$\Omega_{S/R}/I\Omega_{S/R}$. For $f \in I$ denote
$\overline{f}$ the image of $f$ in $I/I^2$.
To show that the map $\overline{f} \mapsto \text{d}f \otimes 1$
is well defined we just have to check that
$\text{d} f_1f_2 \otimes 1 = 0$ if $f_1, f_2 \in I$. 
And this is clear from the Leibniz rule 
$\text{d} f_1f_2 \otimes 1
=
(f_1 \text{d}f_2 + f_2 \text{d} f_1 )\otimes 1
=
\text{d}f_2 \otimes f_1 + \text{d}f_2 \otimes f_1
=
0$. It is also $S' = S/I$-linear because of the $S/I$-module
structure on $I/I^2$ is defined through $S$-multiplication 
combined with the Leibniz rule.

\medskip\noindent
The exactness is now a direct consequence of
Lemma \ref{lemma-differential-surjective}
which describes the kernel of the surjective map.
\end{proof}

\begin{lemma}
\label{lemma-differentials-base-change}
Suppose that we have ring maps $R \to R'$ and $R \to S'$.
Set $S' = S\otimes_R R'$. Then the canonical map defined above
induces an isomorphism $\Omega_{S/R} \otimes_R R' = \Omega_{S'/R'}$.
\end{lemma}

\begin{proof}
Let $\text{d}' : S' = S\otimes_R R' \to \Omega_{S/R} \otimes_R R'$ denote the
map $\text{d}'( \sum a_i \otimes x_i ) = \text{d}(a_i) \otimes x_i$.
It exists because the map $S \times R' \to \Omega_{S/R} \otimes_R R'$,
$(a,x)\mapsto \text{d}a\otimes_R x$ is $R$-bilinear.
This is an $R'$-derivation, as can be verified by a simple computation.
We will show that $(\Omega_{S/R} \otimes_R R', \text{d}')$ satisfies
the universal property. Let $D : S' \to M'$ be an $R'$ derivation
into an $S'$-module. The composition $S \to S' \to M'$ is an $R$-derivation,
hence we get an $S$-linear map $\varphi_D : \Omega_{S/R} \to M'$. We may
tensor this with $R'$ and get the map $\varphi'_D : 
\Omega_{S/R} \otimes_R R' \to M'$, $\varphi'_D(\eta \otimes x) =
x\varphi_D(\eta)$. It is clear that $D = \varphi'_D \circ \text{d}'$.
\end{proof}

\noindent
The multiplication map $S\otimes_R S \to S$ is the $R$-algebra
map which maps $a \otimes b$ to $ab$ in $S$. It is also an
$S$-algebra map, if we think of $S\otimes_R S$ as an $S$-algebra
via either of the maps $S \to S\otimes_R S$.

\begin{lemma}
\label{lemma-differentials-diagonal}
Let $R \to S$ be a ring map. Let $J = \text{Ker}(S\otimes_R S \to S)$
be the kernel of the multiplication map. There is a canonical
isomorphism of $S$-modules $\Omega_{S/R} \to J/J^2$,
$a \text{d} b \mapsto a\otimes b - ab\otimes 1$.
\end{lemma}

\begin{proof}
First we show that the rule $a \text{d} b \mapsto a\otimes b - ab\otimes 1$
is well defined. In order to do this we have to show 
that $\text{d}r$ and $a\text{d}b + b \text{d}a$ map to zero.
The first because $r\otimes 1 - 1 \otimes r = 0$ by definition
of the tensor product. The second because
$a\otimes b - ab\otimes 1 + b\otimes a - ba\otimes 1
=
(a\otimes 1 - 1\otimes a)(b\otimes 1 - 1\otimes b)
$
is in $J^2$.

\medskip\noindent
We construct a map in the other direction.
We may think of $S \to S\otimes_R S$, $a \mapsto a\otimes 1$
as the base change of $R \to S$. Hence we have
$\Omega_{S\otimes_R S/S} = \Omega_{S/R} \otimes_S (S\otimes_R S)$,
by Lemma \ref{lemma-differentials-base-change}.
At this point the sequence of Lemma \ref{lemma-differential-seq} gives a map
$$
J/J^2  \to \Omega_{S\otimes_RS/ S} \otimes_{S\otimes_R S} S
= (\Omega_{S/R} \otimes_S (S\otimes_R S))\otimes_{S\otimes_R S} S
= \Omega_{S/R}.
$$
We leave it to the reader to see it is the inverse of the map
above.
\end{proof}




\begin{lemma}
\label{lemma-differentials-polynomial-ring}
If $S = R[x_1,\ldots,x_n]$, then 
$\Omega_{S/R}$ is a finite free $S$-module with
basis $\text{d}x_1,\ldots, \text{d}x_n$.
\end{lemma}

\begin{proof}
We first show that $\text{d}x_1,\ldots, \text{d}x_n$
generate $\Omega_{S/R}$ as an $S$-module. To prove this
we show that $\text{d}g$ can be expressed as a 
sum $\sum g_i \text{d}x_i$ for any $g \in R[x_1,\ldots,x_n]$.
We do this by induction on the (total) degree of $g$.
It is clear if the degree of $g$ is $0$, because then
$\text{d}g = 0$. If the degree of $g$ is $>0$, then
we may write $g$ as $c + \sum g_i x_i$ with $c\in R$
and $\deg(g_i) < \deg(g)$. By the Leibnize rule we have
$\text{d}g = \sum g_i \text{d} x_i + \sum x_i \text{d}g_i$,
and hence we win by induction.

\medskip\noindent
Consider the $R$-derivation $\partial / \partial x_i :
R[x_1,\ldots,x_n] \to R[x_1,\ldots,x_n]$. (We leave it to
the reader to define this; the defining property
being that $\partial / \partial x_i (x_j) = \delta_{ij}$.)
By the universal property this corresponds to an $S$-module map $l_i : 
\Omega_{S/R} \to R[x_1,\ldots,x_n]$ which maps $\text{d}x_i$
to $1$ and $\text{d}x_j$ to $0$ for $j \not= i$. 
Thus it is clear that there are no $S$-linear relations
among the elements $\text{d}x_1,\ldots, \text{d}x_n$.
\end{proof}

\begin{lemma}
\label{lemma-differentials-finitely-presented}
Suppose $R \to S$ is of finite presentation.
Then $\Omega_{S/R}$ is a finitely presented
$S$-module.
\end{lemma}

\begin{proof}
Write $S = R[x_1,\ldots,x_n]/(f_1, \ldots, f_m)$. 
Write $I = (f_1, \ldots, f_m)$. According
to Lemma \ref{lemma-differential-seq} there is an exact sequence
of $S$-modules
$$
I/I^2
\to
\Omega_{R[x_1,\ldots,x_n]/R}\otimes_{R[x_1,\ldots,x_n]} S
\to 
\Omega_{S/R}
\to
0
$$
The result follows from the fact that $I/I^2$ is a finite 
$S$-module (generated by the images of the $f_i$), and that
the middle term is finite free by
Lemma \ref{lemma-differentials-polynomial-ring}.
\end{proof}

\begin{lemma}
\label{lemma-differentials-finitely-generated}
Suppose $R \to S$ is of finite type.
Then $\Omega_{S/R}$ is finitely generated
$S$-module.
\end{lemma}

\begin{proof}
This is very similar to, but easier than the proof
of Lemma \ref{lemma-differentials-finitely-presented}.
\end{proof}

\noindent
Suppose that $R \to S$ is of finite type.
We say that a {\it presentation} of $S$ over $R$ is
given by the choice of an integer $n \geq 0$, and
a surjection $\alpha : R[x_1,\ldots,x_n] \to S$
of $R$-algebras. We will usually just indicate
this by saying: ``Let $R[x_1,\ldots,x_n] \to S$ be a presentation of
$S/R$'', or ``Let $0\to I \to R[x_1,\ldots,x_n] \to S \to 0$
be a presentation of $S/R$'' if we want to indicate that $I$
is the kernel of the presentation.

\medskip\noindent
Note that for every presentation $\alpha$ we obtain a two term
complex of $S$-modules
$$
NL(\alpha) :
I/I^2 \longrightarrow \Omega_{R[x_1,\ldots,x_n]/R}\otimes S.
$$
The cokernel of this complex is canonically $\Omega_{S/R}$,
see Lemma \ref{lemma-differential-seq}. We call the complex
$NL(\alpha)$
the {\it naive cotangent complex}\footnote{This is better know as the {\it Netherlander complex} in some localities.} associated to the
presentation $\alpha : R[x_1,\ldots,x_n] \to S$ of $S/R$. We will
sometimes use the notation
$I/I^2 \to \bigoplus_{i=1,\ldots,n} S\text{d}x_i$
to denote this complex.

\medskip\noindent
A {\it morphism of presentations of $S/R$} from the presentation
$\alpha : R[x_1,\ldots,x_n] \to S$ to the presentation
$\beta : R[y_1,\ldots,y_m] \to S$ is defined to be a
map $\varphi : R[x_1,\ldots,x_n] \to R[y_1,\ldots,y_m]$
such that $\alpha = \beta \circ \varphi$. Note that
in this case $\varphi(I) \subset J$, where $I = \text{ker}(\alpha)$
and $J = \text{ker}(\beta)$. Thus $\varphi$ induces a map
of $S$-modules $I/I^2 \to J/J^2$ and by functoriality of
differentials also a $S$-module map
$\Omega_{R[x_1,\ldots,x_n]/R}\otimes S
\to \Omega_{R[y_1,\ldots,y_m]/R}\otimes S$.
These maps are compatible and we obtain a map
of naive cotangent complexes
$$
NL(\alpha) \longrightarrow NL(\beta).
$$
We leave it to the reader to see that if $\psi$ is a morphism
of presentations from $\beta$ to $\gamma$, then $\psi \circ \varphi$
is a morphism from $\alpha$ to $\gamma$ and furthermore 
the composition $NL(\alpha) \to NL(\beta) \to NL(\gamma)$
is the map associated to $\psi \circ \varphi$.

\begin{lemma}
\label{lemma-NL-homotopy}
Let $S$ be a finite type $R$-algebra.
Let $\alpha : R[x_1,\ldots,x_n] \to S$, and
$\beta : R[y_1,\ldots,y_m] \to S$ be presentations.
\begin{enumerate}
\item For any map $\varphi$ of presentations from
$\alpha$ to $\beta$ the induced map $NL(\alpha) \to NL(\beta)$
is a quasi-isomorphism.
\item For any pair of maps $\varphi, \varphi'$ the induced maps
$NL(\alpha) \to NL(\beta)$ are homotopic.
\end{enumerate}
See the proof of the lemma for a simple explanation
of the assertions.
\end{lemma}

\begin{proof}
In the simple case of complexes with two terms a quasi-isomoprhism
is just a map that induces an isomorphism on both the cokernel
and the kernel of the maps between the terms. In this case the
fact that $\varphi$ induces an isomorphism on cokernels is by
the choice of $NL(\alpha)$ having cokernel equal to $\Omega_{S/R}$.

\medskip\noindent
Note that the first assertion of the lemma follows from the second.
This is so because we may always choose a morphism of presentations
$\varphi'$ from $\beta$ to $\alpha$. The compositions
$\varphi' \circ \varphi$ and $\varphi \circ \varphi'$
will by (2) induce self maps of $NL(\alpha)$ and $NL(\beta)$
which are homotopic to the identity and hence quasi-isomorphism
(see below).
Hence both compositions $NL(\alpha) \to NL(\beta) \to NL(\alpha)$
and $NL(\beta) \to NL(\alpha) \to NL(\beta)$ are quasi-isomoprhisms
(inducing the indentity on cohomology) and hence so are the maps induced
by $\varphi$ and $\varphi'$.

\medskip\noindent
For the second assertion, let $\varphi$ and $\varphi'$ as stated.
Let $I = \text{Ker}(\alpha)$ and $J = \text{Ker}(\beta)$.
We have to construct the diagonal map in the diagram
$$
\xymatrix{
I/I^2 \ar[r]^{\text{d}} \ar@<1ex>[d] \ar@<-1ex>[d]
&
\bigoplus S\text{d}x_i \ar@<1ex>[d] \ar@<-1ex>[d] \ar[ld]_h
\\
J/J^2 \ar[r]^{\text{d}}
&
\bigoplus S\text{d}y_j
}
$$
where the vertical maps are induced by $\varphi$, $\varphi'$.
The condition is that $\text{d} \circ h + h \circ \text{d}$ should be
the difference of the vertical arrows. It is immediate in this
very simple case of complexes with two terms that this implies 
the vertical maps induce the same maps on kernel and cokernel
of the horizontal maps.

\medskip\noindent
Write $\varphi(x_i) - \varphi'(x_i) = h_i$ for some
$h_i \in R[y_j]$. Of course $h_i \in J$. For all $i$ we have
$\varphi(\text{d}x_i) = \text{d}\varphi(x_i)
=\text{d}(\varphi'(x_i) + h_i) =
\text{d}(\varphi'(x_i)) + \text{d}h_i$. On the other hand,
for every $f = f(x_1,\ldots,x_n) \in I$ we have $\varphi(f) = 
f(\varphi(x_1),\ldots, \varphi(x_n)) =
f(\varphi'(x_1) + h_1,\ldots, \varphi'(x_n) + h_n) =
f(\varphi'(x_1),\ldots, \varphi'(x_n)) + 
\sum_i h_i \partial f/\partial x_i + $ terms in 
$J^2$. Hence the map $h : \bigoplus S\text{d}x_i \to J/J^2$,
$x_i \to h_i$ gives the desired homoropy.
\end{proof}

\section{Hilbert Nullstellensatz}
\label{section-nullstellensatz}

\noindent
In this section we give a quick and dirty proof
of the Hilbert Nullstellensatz which uses some
simple field theory.

\begin{lemma}
\label{lemma-tensor-fields}
Suppose that $k \subset k_1$ and $k\subset k_2$ are
field extensions. Then there exists an surjection
$k_1\otimes_k k_2 \to k_3$ onto a field $k_3$ such
that $\text{trdeg}(k_3/k_1) = \text{trdeg}(k_2/k)$
and  $\text{trdeg}(k_2/k_1) = \text{trdeg}(k_3/k)$
\end{lemma}

\begin{proof}
Choose transcendence bases $t_i$ for $k_1/k$ and
$s_j$ for $k_2/k$. Let $\Omega$ be any algebraic closure
of the field $k(\{t_i\}\cup \{s_j\})$. By construction
there are $k$-algebra maps $k_1 \to \Omega$ and
$k_2 \to \Omega$. Let $k_3$ be the field generated
by their images.
\end{proof}

\begin{lemma}
\label{lemma-dimension}
Suppose that $k$ is an uncountable algebraically closed field,
and suppose that $V$ is a nonzero vector space of countable dimension
over $k$. For any linear operator $T : V \to V$ there exists
some $\lambda \in k$ such that $T - \lambda$ is not invertible.
\end{lemma}

\begin{proof}
If not then $V$ inherits the structure of a vector space over
the field $k(T)$. But the dimension of $k(T)$ over $k$ is
uncountable due to the fact that the elements $\frac{1}{T - \lambda}$
are linearly independent.
\end{proof}

\begin{theorem}
\label{theorem-nulstellensatz}
Let $k$ be a field and let $\mathfrak m \subset 
k[x_1,\ldots,x_n]$ be a maximal ideal.
The field extension $k \subset \kappa(\mathfrak m)$
is finite. The same is true for any maximal ideal in
any finite type $k$-algebra.
\end{theorem}

\begin{proof}
Of course it suffices to prove the result for $\mathfrak m \subset 
k[x_1,\ldots,x_n]$, because any finite type $k$-algebra is a
quotient of one of these. 
If we show that $k \subset \kappa(\mathfrak m)$
is algebraic then the result follows since it is
finitely generated as a $k$-algebra.

\medskip\noindent
First assume that $k$ is uncountable and algebraically closed.
To arrive at a contradiction pick
$T \in \kappa(\mathfrak m)$ transcendental over $k$.
Note that the $k$-linear map $T : \kappa(\mathfrak m)
\to \kappa(\mathfrak m)$ has the property that
$T - \lambda$ is invertible for all $\lambda \in k$.
Also, $\kappa(\mathfrak m)$ has countable dimension
over $k$ since it is a quotient of the vector space
$k[x_1,\ldots,x_m]$ over $k$.
This is impossible by Lemma \ref{lemma-dimension}.

\medskip\noindent
In the general case, choose an uncountable algebraically closed
field extension $k \subset k_1$. Choose a quotient
$k_1\otimes_k \kappa(\mathfrak m) \to \kappa$ as in
Lemma \ref{lemma-tensor-fields}. Since the field
$\kappa$ is a quotient of $k_1[x_1,\ldots,x_n]$ via
$$
k_1[x_1,\ldots,x_n]
=
k_1 \otimes_k k[x_1,\ldots,x_n]
\to 
k_1\otimes_k \kappa(\mathfrak m)
\to
\kappa
$$
we see that we may apply the previous case to conclude the
extension $k_1 \subset \kappa$ is algebraic. By our choice
of $\kappa$ we win.
\end{proof}

\section{Dimension}
\label{section-dimension}

\begin{definition}
\label{definition-Krull}
The {\it Krull dimension} of the ring $R$ is the 
Krull dimension of the topological space $\text{Spec}(R)$,
see Topology, \ref{topology-definition-Krull}.
In other words it is the supremum of the integers $n\geq 0$
such that there exists a chain of prime ideals of length $n$:
$$
\mathfrak p_0
\subset 
\mathfrak p_1
\subset
\ldots
\subset
\mathfrak p_n,\ \ 
\mathfrak p_i \not= \mathfrak p_{i+1}.
$$
\end{definition}

\begin{definition}
\label{definition-height}
The {\it height} of a prime ideal $\mathfrak p$ of
a ring $R$ is the dimension of the local ring $R_{\mathfrak p}$.
\end{definition}

\begin{lemma}
\label{lemma-dimension-height}
The Krull dimension of $R$ is the supremum of the
heights of its (maximal) primes.
\end{lemma}

\begin{proof}
This is so because we can always add a maximal ideal at the end of a chain
of prime ideals.
\end{proof}

\begin{lemma}
\label{lemma-Noetherian-dimension-0}
A Noetherian ring of dimension $0$ is Artinian.
Conversely, any Artinian ring has dimension zero.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-Noetherian-topology} the space $\text{Spec}(R)$
is Noetherian. By Topology, Lemma \ref{topology-lemma-Noetherian} we see
that $\text{Spec}(R)$ has finitely many irreducible
components, say $\text{Spec}(R) = Z_1 \cup \ldots Z_r$.
According to Lemma \ref{lemma-irreducible}, each $Z_i = V(\mathfrak p_i)$
with $\mathfrak p_i$ a minimal ideal. Since the dimension is $0$
these $\mathfrak p_i$ are also maximal. Thus $\text{Spec}(R)$
is the discrete topological space with elements $\mathfrak p_i$.
All elements $f$ of the radical $I = \cap \mathfrak p_i$
are nilpotent since otherwise $R_f$ would not be the zero ring
and we would have another prime. Since $I$ is finitely generated
we conclude that $I$ is nilpotent, Lemma \ref{lemma-Noetherian-power}.
By Lemma \ref{lemma-product-local} $R$ is the product of its
local rings. By Lemma \ref{lemma-length-finite} each of these
has finite length over $R$. Hence we conclude that $R$
is Artinian by Lemma \ref{lemma-artinian-finite-length}.

\medskip\noindent
If $R$ is Artinian then it has finitely many maximal
ideals $\mathfrak m_i$, $i=1,\ldots,n$
(Lemma \ref{lemma-artinian-finite-nr-max})
and the radical $I = \mathfrak m_1 \mathfrak m_2 \ldots \mathfrak m_n$
is nilpotent (Lemma \ref{lemma-artinian-radical-nilpotent}).
Hence any prime $\mathfrak p$ contains
$(\mathfrak m_1 \mathfrak m_2 \ldots \mathfrak m_n)^r$,
hence contains $\mathfrak m_1 \mathfrak m_2 \ldots \mathfrak m_n$
hence contains one of the $\mathfrak m_i$. Thus $\mathfrak p$
is equal to one of the $\mathfrak m_i$.
\end{proof}

\noindent
In the following we will use the invariant $d(-)$ defined
in Definition \ref{definition-d}. Here is a warm up lemma.

\begin{lemma}
\label{lemma-dimension-0-d-0}
Let $R$ be a Noetherian local ring.
Then $\dim(R) = 0 \Leftrightarrow d(R) = 0$.
\end{lemma}

\begin{proof}
This is because $d(R) = 0$ if and only if $R$ has finite
length as an $R$-module. See Lemma \ref{lemma-artinian-finite-length}.
\end{proof}

\begin{lemma}
\label{lemma-height-1}
Let $R$ be a local Noetherian ring.
The following are equivalent:
\begin{enumerate}
\item $\dim(R) = 1$,
\label{dim-1}
\item $d(R) = 1$,
\label{d-1}
\item there exists an $x \in \mathfrak m$, $x$ not nilpotent
such that $V(x) = \{\mathfrak m\}$,
\label{Vx}
\item there exists an $x \in \mathfrak m$, $x$ not nilpotent
such that $\mathfrak m = \sqrt{(x)}$, and
\label{x}
\item there exists an ideal of definition generated by $1$ element,
and no ideal of definition is generated by $0$ elements.
\label{ideal-1}
\end{enumerate}
\end{lemma}

\begin{proof}
First, assume that $\dim(R) = 1$.
Let $\mathfrak p_i$ be the minimal primes of $R$.
Because the dimension is $1$ the only other prime of $R$
is $\mathfrak m$.
According to Lemma \ref{lemma-Noetherian-irreducible-components}
there are finitely many. Hence we can find $x \in \mathfrak m$,
$x \not \in \mathfrak p_i$, see Lemma \ref{lemma-silly}.
Thus the only prime containing $x$ is $\mathfrak m$ and
hence (\ref{Vx}).

\medskip\noindent
If (\ref{Vx}) then $\mathfrak m = \sqrt{(x)}$ by
Lemma \ref{lemma-Zariski-topology}, and hence (\ref{x}).
The converse is clear as well.
The equivalence of (\ref{x}) and (\ref{ideal-1}) follows
from directly the definitions.

\medskip\noindent
Assume (\ref{ideal-1}).
Let $I = (x)$ be an ideal of definition.
Note that $I^n/I^{n+1}$ is a quotient of $R/I$ via multiplication
by $x^n$ and hence $\text{length}_R(I^n/I^{n+1})$ is bounded.
Thus $d(R) = 0$ or $d(R) = 1$, but $d(R)=0$ is excluded
by the assumption that $0$ is not an ideal of definition.

\medskip\noindent
Assume (\ref{d-1}). To get a contradiction, assume there
exist primes $\mathfrak p \subset \mathfrak q \subset \mathfrak m$,
with both inclusions strict. Pick some ideal of definition $I \subset R$.
We will repeatedly use
Lemma \ref{lemma-hilbert-ses-chi}. First of all
it implies, via the exact sequence
$0 \to \mathfrak p \to R \to R/\mathfrak p \to 0$,
that $d(R/\mathfrak p) \leq 1$. But it clearly cannot
be zero. Pick $x\in \mathfrak q$, $x\not \in \mathfrak p$.
Consider the short exact sequence
$$
0 \to R/\mathfrak p \to R/\mathfrak p \to R/(xR + \mathfrak p) \to 0.
$$
This implies that $\chi_{I,R/\mathfrak p} - \chi_{I,R/\mathfrak p}
- \chi_{I, R/(xR + \mathfrak p)} = - \chi_{I, R/(xR + \mathfrak p)}$
has degree $ < 1$. In other words, $d(R/(xR + \mathfrak p) = 0$,
and hence $\dim(R/(xR + \mathfrak p)) = 0$, by
Lemma \ref{lemma-dimension-0-d-0}. But $R/(xR + \mathfrak p)$
has the distinct primes $\mathfrak q/(xR + \mathfrak p)$ and
$\mathfrak m/(xR + \mathfrak p)$ which gives the desired contradiction.
\end{proof}

\begin{proposition}
\label{proposition-dimension}
Let $R$ be a local Noetherian ring.
The following are equivalent:
\begin{enumerate}
\item $\dim(R) = d$,
\label{dim-d}
\item $d(R) = d$,
\label{d-d}
\item there exists an ideal of definition generated by $d$ elements,
and no ideal of definition is generated by fewer than $d$ elements.
\label{ideal-d}
\end{enumerate}
\end{proposition}

\begin{proof}
This proof is really just the same as the proof of Lemma
\ref{lemma-height-1}. We will prove the proposition by induction
on $d$. By Lemmas \ref{lemma-dimension-0-d-0} and \ref{lemma-height-1}
we may assume that $d > 1$. Denote the minimal number of
generators for an ideal of definition of $R$ by $d'(R)$.
We will prove that the inequalities
$\dim(R) \geq d'(R) \geq d(R) \geq \dim(R)$,
and hence they are all equal.

\medskip\noindent
First, assume that $\dim(R) = d$.
Let $\mathfrak p_i$ be the minimal primes of $R$.
According to Lemma \ref{lemma-Noetherian-irreducible-components}
there are finitely many. Hence we can find $x \in \mathfrak m$,
$x \not \in \mathfrak p_i$, see Lemma \ref{lemma-silly}.
Note that every maximal chain of primes starts with some $\mathfrak p_i$,
hence the dimension of $R/xR$ is at most $d-1$. By induction
there are $x_2,\ldots, x_d$ which generate an ideal of definition
in $R/xR$. Hence $R$ has an ideal of definition generated
by (at most) $d$ elements.

\medskip\noindent
Assume $d'(R) = d$. Let $I = (x_1,\ldots,x_d)$ be an ideal
of definition. Note that $I^n/I^{n+1}$ is a quotient of a direct
sum of ${d + n - 1 \choose d - 1}$ copies $R/I$ via multiplication
by all degree $n$ monomials in $x_1,\ldots,x_n$.
Hence $\text{length}_R(I^n/I^{n+1})$ is bounded by a polynomial
of degree $d-1$. Thus $d(R) \leq d$.

\medskip\noindent
Assume $d(R) = d$. Consider a chain of primes
$\mathfrak p \subset \mathfrak q \subset 
\mathfrak q_2 \subset \ldots \subset \mathfrak p_e = \mathfrak m$,
with all inclusions strict, and $e \geq 2$.
Pick some ideal of definition $I \subset R$.
We will repeatedly use
Lemma \ref{lemma-hilbert-ses-chi}. First of all
it implies, via the exact sequence
$0 \to \mathfrak p \to R \to R/\mathfrak p \to 0$,
that $d(R/\mathfrak p) \leq d$. But it clearly cannot
be zero. Pick $x\in \mathfrak q$, $x\not \in \mathfrak p$.
Consider the short exact sequence
$$
0 \to R/\mathfrak p \to R/\mathfrak p \to R/(xR + \mathfrak p) \to 0.
$$
This implies that $\chi_{I,R/\mathfrak p} - \chi_{I,R/\mathfrak p}
- \chi_{I, R/(xR + \mathfrak p)} = - \chi_{I, R/(xR + \mathfrak p)}$
has degree $ < d$. In other words, $d(R/(xR + \mathfrak p)) \leq d - 1$,
and hence $\dim(R/(xR + \mathfrak p)) \leq d - 1$, by
induction. Now $R/(xR + \mathfrak p)$ has the chain of prime ideals
$\mathfrak q/(xR + \mathfrak p) \subset \mathfrak q_2/(xR + \mathfrak p)
\subset \ldots \subset \mathfrak q_e/(xR + \mathfrak p)$ which gives
$e - 1 \leq d - 1$. Since we started with an arbitrary chain of
primes this proves that $\dim(R) \leq d(R)$.

\medskip\noindent
Reading back the reader will see we proved the circular 
inequalities as desired.
\end{proof}

\noindent
Let $(R, \mathfrak m)$ be a Noetherian local ring.
From the above it is clear that $\mathfrak m$ cannot be 
generated by fewer than $\dim(R)$ variables.
By Nakayama's Lemma \ref{lemma-NAK} the minimal number
of generators of $\mathfrak m$ equals $\dim_{\kappa(\mathfrak m)}
\mathfrak m/\mathfrak m^2$. Hence we have the following
fundamental inequality
$$
\dim(R) \leq \dim_{\kappa(\mathfrak m)} \mathfrak m/\mathfrak m^2.
$$
It turns out that the rings where equality holds
have a lot of good properties. They are called
regular local rings.

\begin{definition}
\label{definition-regular-local}
A Noetherian local ring is called {\it regular}
if $\mathfrak m$ can be generated by $\dim(R)$
elements of $R$.
\end{definition}


\noindent
The folllowing two lemmas are clear from the proofs of the
lemmas and proposition above, but we spell them out so we have
a convenient references.

\begin{lemma}
\label{lemma-minimal-over-1}
Let $R$ be a Noetherian ring.
\begin{enumerate}
\item Let $x\in R$, $\mathfrak p, \mathfrak q\in \text{Spec}(R)$.
Suppose that $\mathfrak p \subset (\mathfrak p, x) \subset
\mathfrak q$ and $\mathfrak q$ minimal over $(\mathfrak p, x)$.
Then there is no prime strictly between $\mathfrak p$ and $\mathfrak q$.
\item If $x\in R$ and $x \in \mathfrak p$ is minimal over $(x)$
then the height of $\mathfrak p$ is $0$ or $1$.
\end{enumerate}
\end{lemma}

\begin{proof}
Consider the situation of the first assertion.
The primes containing $\mathfrak p$ and contained
in $\mathfrak q$ correspond to primes of
$R_{\mathfrak q}/\mathfrak pR_{\mathfrak q}$, and
the primes containing $x$ correspond to the ones containing
the image of $x$. Thus we may assume $R$ is a Noetherian local domain,
$\mathfrak p = (0)$ and $\mathfrak q$ maximal. Now since
$\sqrt{(x)}$ is the intersection of the prime ideals
containing it, and since $\mathfrak q$ is the only prime
containing $x$ by minimality, we see that $\sqrt{(x)} = \mathfrak q$.
Hence Lemma \ref{lemma-height-1} applies.
The second assertion follows from the first.
\end{proof}

\begin{lemma}
\label{lemma-one-equation}
Suppose that $R$ is a local ring and $x\in \mathfrak m$ an
element of its maximal ideal. Then $\dim R <= \dim R/xR + 1$.
If $x$ is not contained in any of the minimal primes of $R$
then equality holds.
\end{lemma}

\begin{proof}
If $x_1,\ldots,d_{\dim R/xR} \in R$ map to elements of $R/xR$ which
generate an ideal of definition for $R/xR$, then $x, x_1, \ldots,
x_{\dim R/xR}$ generate an ideal of definition for $R$. Hence
the inequality by Proposition \ref{proposition-dimension}.
On the other hand, if $x$ is not contained in any minimal
prime of $R$, then the chains of primes in $R/xR$ all give
rise to chains in $R$ which are at least one step away
from being maximal.
\end{proof}

\begin{lemma}
\label{lemma-finite-dimensional-algebra}
Suppose $R$ is a finite dimensional algebra over a field.
Then $R$ is Artinian.
\end{lemma}

\begin{proof}
The descending chain condition for ideals obviously holds.
\end{proof}

\begin{lemma}
\label{lemma-finite-no-rel}
Suppose that $R \to S$ is finite. Suppose that
$\mathfrak q, \mathfrak q' \in \text{Spec}(S)$
map to the same prime $\mathfrak p$ in 
$\text{Spec}(R)$. Then neither $\mathfrak q \subset \mathfrak q'$
nor $\mathfrak q' \subset \mathfrak q$.
\end{lemma}

\begin{proof}
In fact the topology on the fibre of
$\text{Spec}(S) \to  \text{Spec}(R)$ over
$\mathfrak p$ is the topology on
$\text{Spec}(S \otimes_R \kappa(\mathfrak p))$.
See Remark \ref{remark-fundamental-diagram}.
Note that $S \otimes_R \kappa(\mathfrak p)$ is finite
over $\kappa(\mathfrak p)$. Hence the result follows
from Lemma \ref{lemma-finite-dimensional-algebra}.
\end{proof}

\begin{lemma}
\label{lemma-finite-dim-up}
Suppose that $R \to S$ is finite.
Then $\dim (R) \geq \dim(S)$.
\end{lemma}

\begin{proof}
Immediate from Lemma \ref{lemma-finite-no-rel} and the definitions.
\end{proof}

\section{Support and dimension of modules}
\label{section-support}

\begin{lemma}
\label{lemma-trivial-filter-finite-module}
Let $R$ be a ring, and let $M$ be a finite $R$-module.
There exists a filtration by $R$-submodules
$$
0 = M_0 \subset M_1 \subset \ldots \subset M_n = M
$$
such that each quotient $M_i/M_{i-1}$ is isomorphic
to $R/I_i$ for some ideal $I_i$ of $R$.
\end{lemma}

\begin{proof}
This is clear.
\end{proof}

\begin{lemma}
\label{lemma-filter-Noetherian-module}
Let $R$ be a Noetherian ring, and let $M$ be a finite $R$-module.
There exists a filtration by $R$-submodules
$$
0 = M_0 \subset M_1 \subset \ldots \subset M_n = M
$$
such that each quotient $M_i/M_{i-1}$ is isomorphic
to $R/\mathfrak p_i$ for some prime ideal $\mathfrak p_i$
of $R$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-trivial-filter-finite-module}
it suffices to do the case $M=R/I$ for some ideal $I$.
Consider the set $S$ of ideals $J$ such that the lemma
does not hold for the module $R/J$, and order it by
inclusion. To arrive at a
contradiction, assume that $S$ is not empty. Because
$R$ is Noetherian, $S$ has a maximal element $J$.
By definition of $S$, the ideal $J$ cannot be prime.
Pick $a,b\in R$ such that $ab \in J$, but neither
$a \in J$ nor $b\in J$. Consider the filtration
$0 \subset aR/(J \cap aR) \subset R/J$.
Note that $aR/(J \cap aR)$ is a quotient of $R/(J + bR)$
and the second quotient equals $R/(aR + J)$. Hence by 
maximality of $J$, each of these has a filtration as
above and hence so does $R/J$. Contradiction.
\end{proof}

\begin{definition}
\label{definition-support-module}
Let $R$ be a ring and let $M$ be an $R$-module.
The {\it support of $M$} is the set
$$
\text{Supp}(M)
=
\{
\mathfrak p \in \text{Spec}(R)
\mid 
M_{\mathfrak p} \not= 0
\}
$$
\end{definition}

\begin{lemma}
\label{lemma-support-closed}
Let $R$ be a ring and let $M$ be an $R$-module.
If $M$ is finite, then $\text{Supp}(M)$ is closed.
\end{lemma}

\begin{proof}
Let $x_1,\ldots,x_r \in M$ be generators.
Suppose that $M_{\mathfrak p} = 0$.
By Lemma \ref{lemma-localize-colimit} there exists
an $f \in R$, $f\not\in \mathfrak p$ such that
$x_i\otimes 1 = 0$ in $M_f$. Hence $M_f = 0$.
Hence $M_{\mathfrak q} = 0$ for all $\mathfrak q\in D(f)$.
\end{proof}

\begin{lemma}
\label{lemma-support-quotient}
Let $R$ be a ring and let $M$ be an $R$-module.
\begin{enumerate}
\item If $M$ is finite then the support
of $M/IM$ is $\text{Supp}(M) \cap V(I)$.
\item If $N \subset M$, then $\text{Supp}(N) \subset
\text{Supp}(M)$.
\item If $Q$ is a quotient module of $M$ then $\text{Supp}(Q) \subset
\text{Supp}(M)$.
\item If $0 \to N \to M \to Q \to 0$ is a short exact sequence
then $\text{Supp}(M) = \text{Supp}(Q) \cup
\text{Supp}(N)$.
\end{enumerate}
\end{lemma}

\begin{proof}
The functors $M \mapsto M_{\mathfrak p}$ are exact. This immediately
implies all but the first assertion. For the first assertion
we need to show that $M_\mathfrak p \not = 0$ and
$I \subset \mathfrak p$ implies $(M/IM)_{\mathfrak p}
= M_\mathfrak p/IM_\mathfrak p \not = 0$. This follows
from Nakayama's Lemma \ref{lemma-NAK}.
\end{proof}

\begin{lemma}
\label{lemma-filter-primes-in-support}
Let $R$, $M$, $M_i$, $\mathfrak p_i$ as in
Lemma \ref{lemma-filter-Noetherian-module}.
All of the primes $\mathfrak p_i$ are in the support of
$M$.
\end{lemma}

\begin{proof}
Since localization is exact, we see that
$(R/\mathfrak p_i)_{\mathfrak p_i}$ is a
subquotient of $M_{\mathfrak p_i}$.
Hence $M_{\mathfrak p_i}$ is not zero.
\end{proof}

\begin{lemma}
\label{lemma-support-point}
Suppose that $R$ is a Noetherian local ring with
maximal ideal $\mathfrak m$. Let $M$ be a finite
$R$-module. Then $\text{Supp}(M) = \{ \mathfrak m\}$
if and only if $M$ has finite length over $R$.
\end{lemma}

\begin{proof}
Assume that $\text{Supp}(M) = \{ \mathfrak m\}$.
It suffices to show that all the primes $\mathfrak p_i$
in the filtration of Lemma \ref{lemma-filter-Noetherian-module}
are the maximal ideal. This is clear by
Lemma \ref{lemma-filter-primes-in-support}.

\medskip\noindent
Suppose that $M$ has finite length over $R$.
Then $\mathfrak m^n M = 0$ by Lemma \ref{lemma-length-infinite}.
Since some element of $\mathfrak m$ maps to a unit
in $R_{\mathfrak p}$ for any prime
$\mathfrak p \not = \mathfrak m$ in $R$ we see $M_{\mathfrak p} = 0$.
\end{proof}

\begin{lemma}
\label{lemma-filter-minimal-primes-in-support}
Let $R$, $M$, $M_i$, $\mathfrak p_i$ as in
Lemma \ref{lemma-filter-Noetherian-module}.
The minimal elements of the set $\{\mathfrak p_i\}$
are the minimal elements of $\text{Supp}(M)$, and
the number of times a minimal prime $\mathfrak p$
occurs is
$$
\#\{i \mid \mathfrak p_i = \mathfrak p\}
=
\text{length}_{R_\mathfrak p} M_{\mathfrak p}.
$$
\end{lemma}

\begin{proof}
We have already seen $\{\mathfrak p_i\} \subset \text{Supp}(M)$,
in Lemma \ref{lemma-filter-primes-in-support}.
Let $\mathfrak p \in \text{Supp}(M)$ be minimal.
The support of $M_{\mathfrak p}$ is the set
consisting of the maximal ideal $\mathfrak p R_{\mathfrak p}$.
Hence by Lemma \ref{lemma-support-point} the length
of $M_{\mathfrak p}$ is finite and $>0$. Next we
note that $M_{\mathfrak p}$ has a filtration with subquotients
$
(R/\mathfrak p_i)_{\mathfrak p}
=
R_{\mathfrak p}/{\mathfrak p_i}R_{\mathfrak p}
$
These are zero if $\mathfrak p_i \not \subset \mathfrak p$
and equal to $\kappa(\mathfrak p)$ if $\mathfrak p_i \subset
\mathfrak p$ because by minimality of $\mathfrak p$
we have $\mathfrak p_i = \mathfrak p$ in this case.
The result follows since $\kappa(\mathfrak p)$ has length $1$.
\end{proof}

\begin{lemma}
\label{lemma-support-dimension-d}
Let $R$ be a Noetherian local ring.
Let $M$ be a finite $R$-module.
Then $d(M) = \dim(\text{Supp}(M))$.
\end{lemma}

\begin{proof}
Let $M_i, \mathfrak p_i$ be as in Lemma \ref{lemma-filter-Noetherian-module}.
By Lemma \ref{lemma-hilbert-ses-chi} we have
$d(M) = \max \{ d(R/\mathfrak p_i) \}$. By
Proposition \ref{proposition-dimension} we have
$d(R/\mathfrak p_i) = \dim(R/\mathfrak p_i)$
Trivially $\dim(R/\mathfrak p_i) = \dim V(\mathfrak p_i)$.
Since all minimal primes of $\text{Supp}(M)$ occur among
the $\mathfrak p_i$ we win.
\end{proof}

\section{Associated primes}
\label{section-ass}

\begin{definition}
\label{definition-associated}
Let $R$ be a ring. Let $M$ be an $R$-module.
A prime $\mathfrak p$ of $R$ is {\it associated} to $M$
if there exists an element $m \in M$ whose annihilator
is $\mathfrak p$.
The set of all such primes is denoted $\text{Ass}_R(M)$
or $\text{Ass}(M)$.
\end{definition}

\begin{lemma}
\label{lemma-ass-filter}
Let $R$, $M$, $M_i$, $\mathfrak p_i$ as in
Lemma \ref{lemma-filter-Noetherian-module}.
Then $\text{Ass}(M) \subset \{\mathfrak p_i\}$.
\end{lemma}

\begin{proof}
By induction on the length $n$ of the filtration $\{ M_i \}$.
Pick $m \in M$ whose annihilator is a prime $\mathfrak p$.
If $m \in M_{n-1}$ we are done by induction. If not,
then $m$ maps to a nonzero element of $M/M_{n-1} \cong
R/\mathfrak p_n$. Hence we have $\mathfrak p \subset \mathfrak p_n$.
If equality does not hold, then we can find $f \in \mathfrak p_n$,
$f \not\in \mathfrak p$. In this case the annihilator of $fm$ is still
$\mathfrak p$ and $fm \in M_{n-1}$. Thus we win by induction.
\end{proof}

\begin{lemma}
\label{lemma-finite-ass}
Let $R$ be a Noetherian ring.
Let $M$ be a finite $R$-module.
Then $\text{Ass}(M)$ is finite.
\end{lemma}

\begin{proof}
Immediate from Lemma \ref{lemma-ass-filter} and
Lemma \ref{lemma-filter-Noetherian-module}.
\end{proof}

\begin{proposition}
Let $R$ be a Noetherian ring.
Let $M$ be a finite $R$-module.
The following sets of primes are the same:
\begin{enumerate}
\item The minimal primes in the support of $M$.
\item The minimal primes in $\text{Ass}(M)$.
\item For any filtration $0 = M_0 \subset M_1 \subset \ldots
\subset M_{n-1} \subset M_n = M$ with $M_i/M_{i-1} \cong R/\mathfrak p_i$
the minimal primes of the set $\{\mathfrak p_i\}$.
\end{enumerate}
\end{proposition}

\begin{proof}
Part of this we saw in Lemma \ref{lemma-filter-minimal-primes-in-support}.
It suffices to prove that if $\mathfrak p$ is a minimal element of
the set $\{\mathfrak p_i\}$ then it is the annihilator of
an element of $M$. Let $i$ be minimal such that
$\mathfrak p = \mathfrak p_i$.
Pick $m \in M_i$, $m \not \in M_{i-1}$. The annihilator of $m$ 
is contained in $\mathfrak p_i = \mathfrak p$ and contains
$\mathfrak p_1 \mathfrak p_2 \ldots \mathfrak p_i$. By our choice of
$i$ we have $\mathfrak p_1 \mathfrak p_2 \ldots \mathfrak p_{i-1}
\not \subset \mathfrak p_i$. Pick
$f \in \mathfrak p_1 \mathfrak p_2 \ldots \mathfrak p_{i-1}$,
$f \not \in \mathfrak p$. Then $fm$ has annihilator $\mathfrak p$.
\end{proof}

\begin{lemma}
\label{lemma-ass-zero-divisors}
Let $R$ be a Noetherian ring.
Let $M$ be a finite $R$-module.
The union $\bigcup_{\mathfrak q \in \text{Ass}(M)} \mathfrak q$
is the set elements of $R$ which are zero divisors on $M$.
\end{lemma}

\begin{proof}
Any element in any associated prime clearly is a zero divisor
on $M$. Conversely, suppose $x \in R$ is a zero divisor on $M$.
Consider the submodule $N = \{m \in M \mid xm = 0\}$.
Since $N$ is not zero it has an associated prime $\mathfrak q$,
and clearly $x \in \mathfrak q$. But just as clearly $\mathfrak q$
is also an associated prime of $M$.
\end{proof}


\section{Regular sequences and depth}
\label{section-depth}

\noindent
There is a characterization of depth in terms of Ext-groups
that we will discuss in a later chapter. Here we just do
a minimal amount of work to prove the inequality between
depth and dimension.

\begin{definition}
\label{definition-regular-sequence}
Let $R$ be a ring.
Let $M$ be an $R$-module. 
A sequence of elements $f_1,\ldots,f_r$ is called {\it $M$-regular}
if the following conditions hold:
\begin{enumerate}
\item $f_i$ is a nonzero divisor on
$M/(f_1,\ldots,f_{r-1})M$
for each $i = 1, \ldots, r$, and
\item the module $M/(f_1,\ldots,f_r)M$ is not zero.
\end{enumerate}
If $I$ is an ideal of $R$ and $f_1,\ldots,f_r \in I$
then we call $f_1,\ldots, f_r$ a {\it $M$-regular sequence
in $I$}. If $M = R$, we call $f_1,\ldots,f_r$ simply a
{\it regular sequence} (in $I$).
\end{definition}

\noindent
Please pay attention to the fact that the definition depends
on the order of the elements $f_1,\ldots,f_r$. Here are two 
examples.

\begin{example}
\label{example-global-regular}
Let $k$ be a field. In the ring $k[x,y,z]$
the sequence $x, y(1-x), z(1-x)$ is regular
but the sequence $y(1-x), z(1-x), x$ is not.
\end{example}

\begin{example}
\label{example-local-regular}
Let $k$ be a field. Consider the ring 
$k[x,y,w_0,w_1,w_2,\ldots]/I$
where $I$ is generated by $yw_i$, $i=0,1,2,\ldots$ and
$w_i - xw_{i+1}$, $i=0,1,2,\ldots$.
The sequence $x, y$ is regular, but $y$ is a zero divisor.
Moreover you can localize at the maximal ideal
$(x,y,w_i)$ and still get an example.
\end{example}

\begin{definition}
Let $R$ be a ring, and $I \subset R$ an ideal.
Let $M$ be an $R$-module.
The {\it $I$-depth} of $M$ is the supremum of the lengths
of $M$-regular sequences in $M$; we denote it
$\text{depth}_I(M)$. If $(R, \mathfrak m)$ is
local we call $\text{depth}_{\mathfrak m}(M)$ simply
the {\it depth} of $M$.
\end{definition}

\noindent
Example \ref{example-global-regular} shows depth does not
behave well even if the ring is Noetheriam, and Example
\ref{example-local-regular} shows that it does not
behave well if the ring is local but non Noetherian.
We will see later depth behaves well if the ring is local
Noetherian. The following two lemmas are an indication of this.

\begin{lemma}
\label{lemma-permute-xi}
Let $R$ be a local Noetherian ring.
Let $M$ be a finite $R$-module.
Let $x_1,\ldots,x_c$ be an $M$-regular sequence.
Then any permutation of the $x_i$ is a regular
sequence as well.
\end{lemma}

\begin{proof}
First we do the case $c=2$.
Consider $K \subset M$ the kernel of $x_2 : M \to M$.
For any $z \in K$ we know that $z = x_1 z'$
for some $z' \in M$ because
$x_2$ is a nonzero divisor on $M/x_1M$. 
Because $x_1$ is a nonzero divsor on $M$ we see that $x_2 z = 0$
as well. Hence $x_1 : K \to K$ is surjective.
Thus $K = 0$ by Nakayama's Lemma \ref{lemma-NAK}.
Next, consider multiplication by $x_1$ on $M/x_2M$.
If $z \in M$ maps to an element $\overline{z} \in M/x_2M$
in the kernel of this map, then $x_1 z = x_2 y$ for some $y \in M$.
But then since $x_1, x_2$ is a regular sequence we see that
$y = x_1 y'$ for some $y' \in M$. Hence $x_1 ( z - x_2 y' ) =0$
and hence $z = x_2 y'$ and hence $\overline{z} = 0$ as desired.

\medskip\noindent
For the general case, observe that any permutation is
a composition of transpositions of adjacent indices.
Hence it suffices to prove that
$x_1,\ldots,x_{i-2},x_i,x_{i-1},x_{i+1},\ldots,x_c$ 
is an $M$-regular sequence. This follows from the case we 
just did applied to the module $M/(x_1,\ldots,x_{i-2})$
and the length $2$ regular sequence $x_{i-1}, x_i$.
\end{proof}

\begin{lemma}
\label{lemma-bound-depth}
Let $R$ be a Noetherian local ring.
Let $M$ be a finite $R$-module.
Then $\dim(\text{Support}(M)) \geq \text{depth}(M)$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-support-dimension-d} it suffices
to prove that if $f \in \mathfrak m$ is a nonzero
divisor on $M$, then $d(M/fM) \leq d(M) - 1$.
The existence of $f$ shows that $M$ does not have finite length.
Consider the exact sequence
$$
0 \to M \xrightarrow{f} M \to M/fM \to 0
$$
and apply Lemma \ref{lemma-hilbert-ses-chi}.
It shows that $d(M/fM) < d(M)$.
\end{proof}

\noindent
Here are a few more results on depth.

\begin{lemma}
\label{lemma-ideal-nonzerodivisor}
Let $R$ be a Noetherian local ring with
maximal ideal $\mathfrak m$. Let $I \subset \mathfrak m$
be an ideal. Let $M$ be a finite $R$-module.
The following are equivalent:
\begin{enumerate}
\item There exists an $x \in I$ which is not a zero
divisor on $M$, in other words $\text{depth}_I(M) \geq 1$.
\item We have $\mathfrak m \not\in \text{Ass}(M)$ and
$I \not \subset \mathfrak q$ for all $\mathfrak q \in \text{Ass}(M)$.
\end{enumerate}
\end{lemma}

\begin{proof}
If there exists a nonzero divisor $x$ in $\mathfrak m$,
then it is clear that no nonzero element of $M$ has annihilator
$\mathfrak m$. Also, $x$ clearly cannot be in any associated
prime of $M$. Conversely, suppose $I \not \subset \mathfrak q$
for all $\mathfrak q \in \text{Ass}(M)$. In this case we can
choose $x \in I$, $x \not \in \mathfrak q$ for all
$\mathfrak q \in \text{Ass}(M)$ by Lemma \ref{lemma-silly}.
By Lemma \ref{lemma-ass-zero-divisors} the element $x$
is not a zero divisor.
\end{proof}

\begin{lemma}
Let $R$ be a ring.
\begin{enumerate}
\item Suppose that $J = (f_1,\ldots,f_c)$ is an ideal generated
by a regular sequence $f_1,\ldots,f_c$ of $R$. Then the graded
ring $\bigoplus J^n/J^{n+1}$ is graded isomorphic to
$(R/J)[X_1,\ldots,X_c]$.
\item Suppose that $M$ is an $R$-module and that $J=(f_1,\ldots,f_c)$
is an ideal generated by the $M$-regular sequence
$f_1,\ldots,f_c$. In this case the graded
$\bigoplus J^n/J^{n+1}$-module $\bigoplus J^nM/J^{n+1}M$
is graded isomorphic to the module $(M/JM)[X_1,\ldots,X_c]$.
\end{enumerate}
The second statement is elucidated in the proof below.
\end{lemma}

\begin{proof}
We prove the first assertion by induction on $c$.
We have to show that given any relation
$\sum_{|I| = n} a_I f^I \in J^{n + 1}$ with $a_I \in R$ we
actually have $a_I \in J$ for all multi-indices $I$. Since
any element of $J^{n+1}$ is of the form $\sum_{|I| = n} b_I f^I$
with $b_I \in J$ we may assume, after replacing $a_I$ by $a_I - b_I$,
the relation reads $\sum_{|I| = n} a_I f^I = 0$. We can rewrite 
this as
$$
\sum\nolimits_{e = 0}^n
\left(
\sum\nolimits_{|I'| = n - e}
a_{I',e} f^{I'}
\right)
f_c^e
=
0
$$
Here and below the multi-indices $I'$ are required to be of the form
$I'=(i_1,\ldots,i_{d-1},0)$. We will show by descending
induction on $l \in \{0,\ldots,n\}$
that if we have a relation
$$
\sum\nolimits_{e = 0}^l
\left(
\sum\nolimits_{|I'| = n - e}
a_{I',e} f^{I'}
\right)
f_c^e
=
0
$$
then $a_{I',e} \in J$ for all $I', e$.
Namely, set $J' = (f_1,\ldots,f_{c-1})$.
We observe that $\sum\nolimits_{|I'| = n - l} a_{I',l} f^{I'}$
is mapped into $J'$ by $f_c^{l}$ and hence
(because $f_c$ is not a zero divisor on $R/J'$) it is in $J'$.
By induction hypotheses (for the induction on $c$),
we see that $a_{I',l} \in J'$.
This allows us to rewrite the term 
$(\sum\nolimits_{|I'| = n - l} a_{I',l} f^{I'})f_c^l$
in the form $(\sum\nolimits_{|I'| = n - l + 1} f_c b_{I',l - 1} f^{I'})f_c^{l-1}$. This gives a new relation of the form
$$
\sum\nolimits_{|I'| = n - l + 1}
(a_{I', l-1} + f_c b_{I',l - 1}) f^{I'})f_c^{l-1}
+
\sum\nolimits_{e = 0}^{l - 2}
\left(
\sum\nolimits_{|I'| = n - e}
a_{I',e} f^{I'}
\right)
f_c^e
=
0
$$
Now by the induction hypothesis (on $l$ this time) we see that
all $a_{I', l-1} + f_c b_{I',l - 1} \in J$ and
all $a_{I', e} \in J$ for $e \leq l - 2$. This, combined with
$a_{I', l} \in J' \subset J$ seen above, finishes the proof of the
induction step.

\medskip\noindent
The second assertion means that given any formal expression
$F = \sum_{|I| = n} m_I X^I$, $m_I \in M$ with $\sum m_I f^I
\in J^{n+1}M$, then all the coefficients $m_I$ are in $J$.
This is proved in exactly the same way as we prove the corresponding
result for the first assertion above.
\end{proof}

\section{Ext groups and depth}
\label{section-ext}

\noindent
In this section we do a tiny bit of homological algebra,
in order to esthablish some fundamental properties of
depth over Noetherian local rings.

\begin{lemma}
\label{lemma-resolution-by-finite-free}
Let $R$ be a ring. Let $M$ be an $R$-module.
\begin{enumerate}
\item The exists an exact complex
$$
\ldots \to F_2 \to F_1 \to F_0 \to M \to 0.
$$
with $F_i$ free $R$-modules.
\item If $R$ is Noetherian and $M$ finite $R$, then we
choose the complex such that each $F_i$ is finite free.
In other words, we may find an exact complex
$$
\ldots \to R^{n_2} \to R^{n_1} \to R^{n_0} \to M \to 0.
$$
\end{enumerate}
\end{lemma}

\begin{proof}
Let us explain only the Noetherian case.
As a first step choose a surjection $R^{n_0} \to M$.
Then having constructed an exact complex of length
$e$ we simply choose a surjection $R^{n_{e+1}} \to 
\text{Ker}(R^{n_e} \to R^{n_{e-1}})$ which is possible
because $R$ is Noetherian.
\end{proof}

\begin{definition}
\label{definition-finite-free-resolution}
We call a complex as in (1) of
Lemma \ref{lemma-resolution-by-finite-free}
a {\it resolution of $M$ by free $R$-modules}.
Similarly we call a complex as in (2) of
Lemma \ref{lemma-resolution-by-finite-free}
a {\it resolution of $M$ by finite free $R$-modules}.
\end{definition}

\noindent
We often use the notation $F_{\bullet}$ to denote a complex
of $R$-modules
$$
\ldots \to F_i \to F_{i-1} \to \ldots
$$
In this case we often use $d_i$ or $d_{F, i}$ to denote the map
$F_i \to F_{i-1}$. In this section we are always going to
assume that $F_0$ is the last nonzero term in the complex.
The {\it $i$th homology group of the complex} $F_{\bullet}$
is the group $H^i = \text{Ker}(d_{F,i})/\text{Im}(d_{F,i+1})$.
A {\it map of complexes $\alpha : F_{\bullet} \to G_{\bullet}$}
is given by maps $\alpha_i : F_i \to G_i$ such that
$\alpha_{i-1} \circ d_{F, i} = d_{G, i-1} \circ \alpha_i$.
Such a map induces a map on cohomology $H^i(\alpha) :
H^i(F_{\bullet}) \to H^i(G_{\bullet})$. If $\alpha, \beta
:  F_{\bullet} \to G_{\bullet}$ are maps of complexes, then
a {\it homotopy} between $\alpha$ and $\beta$ is given by
a collection of maps $h_i : F_i \to G_{i+1}$ such that
$\alpha_i - \beta_i = d_{G, i+1} \circ h_i +
h_{i-1} \circ d_{F, i}$.

\medskip\noindent
We will use a very similar notation regarding complexes
of the form $F^{\bullet}$ which look like
$$
\ldots \to F^i \xrightarrow{d^{i+1}} F^{i+1} \to \ldots
$$
There are maps of complexes, homotopies, etc.
In this case we set $H^i(F^{\bullet}) =
\text{Ker}(d^{i+1})/\text{Im}(d^{i})$ and we call it
the {\it $i$th cohomology group}.

\begin{lemma}
\label{lemma-homotopic-equal-homology}
Any two homotopic maps of complexes induce the same maps on
(co)homology groups.
\end{lemma}

\begin{proof}
FIXME.
\end{proof}

\begin{lemma}
\label{lemma-compare-resolutions}
Suppose given an exact complex $M_{\bullet}$, a complex
$F_{\bullet}$ of free $R$-modules and a map
of $R$-modules $\text{Coker}(F_1 \to F_0) \to \text{Coker}(M_1 \to M_0)$. 
Then
\begin{enumerate}
\item there exists a map of complexes $F_{\bullet}
\to M_{\bullet}$ inducing the given map on cokernels.
\item any two maps $\alpha, \beta : F_{\bullet}
\to M_{\bullet}$ inducing the same map 
$\text{Coker}(F_1 \to F_0) \to \text{Coker}(M_1 \to M_0)$
are homotopic.
\end{enumerate}
\end{lemma}

\begin{proof}
Because $F_0$ is free we can find a map $F_0 \to M_0$
lifting the map $F_0 \to \text{Coker}(F_1 \to F_0)
\to \text{Coker}(M_1 \to M_0)$. We obtain an induced
map $F_1 \to F_0 \to M_0$ wich ends up in the image
of $M_1 \to M_0$. Since $F_1$ is free we may lift this
to a map $F_1 \to M_1$. This in turn induces a map
$F_2 \to F_1 \to M_1$ which maps to zero into
$M_0$. Since $M_{\bullet}$ is exact we see that
the image of this map is contained in the image
of $M_2 \to M_1$. Hence we may lift to get a map
$F_2 \to M_2$. Repeat.

\medskip\noindent
To show that $\alpha, \beta$ are homotopic it suffices
to show the difference $\gamma = \alpha - \beta$ is homotopic
to zero. Note that the image of $\gamma_0 : F_0 \to M_0$
is contained in the image of $M_1 \to M_0$. Hence we may lift
$\gamma_0$ to a map $h_0 : F_0 \to M_1$. Consider the map
$\gamma_1' = \gamma_1 - h_0 \circ d_{F, 1}$. By our choice of $h_0$
we see that the image of $\gamma_1'$ is contained in
the kernel of $M_1 \to M_0$. Since $M_{\bullet}$ is exact 
we may lift $\gamma_1'$ to a map $h_1 : F_1 \to M_2$.
At this point we have $\gamma_1 = h_0 \circ d_{F, 1}
+ d_{M, 2} \circ h_1$. Repeat.
\end{proof}

\noindent
At this point we are ready to define the groups
$\text{Ext}^i_R(M, N)$. Namely, choose a resolution
$F_{\bullet}$ of $M$ by free $R$-modules, see Lemma
\ref{lemma-resolution-by-finite-free}. Consider
the (cohomological) complex 
$$
\text{Hom}_R(F_\bullet, N) :
\text{Hom}_R(F_0, N) \to 
\text{Hom}_R(F_1, N) \to 
\text{Hom}_R(F_2, N) \to \ldots
$$
We define $\text{Ext}^i_R(M, N)$ to be the $i$th
cohomology group of this complex.\footnote{At this point
it would perhaps be more appropriate to say ``an'' in stead
of ``the'' Ext-group.} The following lemma explains
in what sense this is well defined.

\begin{lemma}
\label{lemma-ext-welldefined}
Suppose that $F_{\bullet}$ is a free resolution of the module $M_1$,
and $G_{\bullet}$ is a free resolutions of the module $M_2$.
Let $\varphi : M_1 \to M_2$ be a module map.
Let $\alpha : F_{\bullet} \to G_{\bullet}$ be
a map of complexes inducing $\varphi$ on
$M_1 = \text{Coker}(d_{F, 1}) \to M_2 = \text{Coker}(d_{G, 1})$,
see Lemma \ref{lemma-compare-resolutions}.
Then the induced maps
$$
H^i(\alpha) :
H^i(\text{Hom}_R(F_{\bullet}, N))
\longrightarrow
H^i(\text{Hom}_R(G_{\bullet}, N))
$$
are independent of the choice of $\alpha$.
If $\varphi$ is an isomorphism, so are all the maps
$H^i(\alpha)$.
\end{lemma}

\begin{proof}
Another map $\beta : F_{\bullet} \to G_{\bullet}$
inducing $\varphi$ is homotopic to $\alpha$ by
Lemma \ref{lemma-compare-resolutions}. Hence the
maps $\text{Hom}_R(F_\bullet, N) \to
\text{Hom}_R(G_\bullet, N)$ are homotopic.
Hence the independence result follows from
Lemma \ref{lemma-homotopic-equal-homology}.

\medskip\noindent
Suppose that $\varphi$ is an isomorphism.
Let $\psi : M_2 \to M_1$ be an inverse.
Choose $\beta : G_{\bullet} \to F_{\bullet}$
be a map inducing $\psi :
M_2 = \text{Coker}(d_{G, 1}) \to M_1 = \text{Coker}(d_{F, 1})$,
see Lemma \ref{lemma-compare-resolutions}. 
Ok, and now consider the map
$H^i(\alpha) \circ H^i(\beta) =
H^i(\alpha \circ \beta)$. By the above the
map $H^i(\alpha \circ \beta)$ is the {\it same}
as the map $H^i(\text{id}_{G_{\bullet}}) = \text{id}$.
Similarly for the composition $H^i(\beta) \circ H^i(\alpha)$.
Hence $H^i(\alpha)$ and $H^i(\beta)$ are inverses of each other.
\end{proof}

\begin{lemma}
\label{lemma-long-exact-seq-ext}
Let $R$ be a ring. Let $M$ be an $R$-module.
Let $0 \to N' \to N \to N'' \to 0$ be a 
short exact sequence. Then we get a long exact
sequence
$$
\begin{matrix}
0
\to \text{Hom}_R(M, N')
\to \text{Hom}_R(M, N)
\to \text{Hom}_R(M, N'')
\\
\phantom{0\ }
\to \text{Ext}^1_R(M, N')
\to \text{Ext}^1_R(M, N)
\to \text{Ext}^1_R(M, N'')
\to \ldots
\end{matrix}
$$
\end{lemma}

\begin{proof}
Pick a free resolution $F_{\bullet} \to M$.
Since each of the $F_i$ are free we see that 
we get a short exact sequence of complexes
$$
0 \to
\text{Hom}_R(F_{\bullet}, N') \to
\text{Hom}_R(F_{\bullet}, N) \to
\text{Hom}_R(F_{\bullet}, N'') \to
0
$$
Thus we get the long exact sequence from
the snake lemma applied to this.
\end{proof}

\begin{lemma}
\label{lemma-annihilate-ext}
Let $R$ be a ring. Let $M$, $N$ be $R$-modules.
Any $x\in R$ such that either $xN = 0$, or $xM = 0$
annihilates each of the modules $\text{Ext}^i_R(M,N)$.
\end{lemma}

\begin{proof}
Pick a free resolution $F_{\bullet}$ of $M$.
Since $\text{Ext}^i_R(M, N)$
is defined as the cohomology of the complex
$\text{Hom}_R(F_{\bullet}, N)$ the lemma is
clear when $xN = 0$. If $xM = 0$, then 
we see that multiplication by $x$ on $F_{\bullet}$
lifts the zero map on $M$. Hence by Lemma
\ref{lemma-ext-welldefined} we see that it
induces the same map on EXt groups as the
zero map.
\end{proof}

\begin{lemma}
\label{lemma-depth-ext}
Let $R$ be a Noetherian local ring with maximal ideal $\mathfrak m$.
Let $M$ be a finite $R$-module. Then $\text{depth}_R(M)$
is equal to the smallest integer $i$ such that
$\text{Ext}^i_R(R/\mathfrak m, M)$ is nonzero.
\end{lemma}

\begin{proof}
Let $\delta(M)$ denote the depth of $M$ and let $i=i(M)$ denote
the smallest integer such that $\text{Ext}^i_R(R/\mathfrak m, M)$
is nonzero. We will see in a moment that $i(M) < \infty$.
By Lemma \ref{lemma-ideal-nonzerodivisor} we have
$\delta(M) = 0$ if and only if $i(M) = 0$, because
$\mathfrak m \in \text{Ass}(M)$ exactly means
that $i(M) = 0$. Hence if $\delta(M)$ or $i(M)$ is $> 0$, then we may
choose $x \in \mathfrak m$ such that (a) $x$ is a nonzero
divisor on $M$, and (b) $\text{depth}(M/xM) = \delta(M) - 1$.
Consider the long exact sequence
of Ext-groups associated to the short exact sequence
$0 \to M \to M \to M/xM \to 0$ by Lemma \ref{lemma-long-exact-seq-ext}:
$$
\begin{matrix}
0
\to \text{Hom}_R(\kappa, M)
\to \text{Hom}_R(\kappa, M)
\to \text{Hom}_R(\kappa, M/xM)
\\
\phantom{0\ }
\to \text{Ext}^1_R(\kappa, M)
\to \text{Ext}^1_R(\kappa, M)
\to \text{Ext}^1_R(\kappa, M/xM)
\to \ldots
\end{matrix}
$$
Since $x \in \mathfrak m$ all the maps $\text{Ext}^i_R(\kappa, M)
\to \text{Ext}^i_R(\kappa, M)$ are zero, see \ref{lemma-annihilate-ext}.
Thus it is clear that $i(M/xM) = i(M) - 1$. Induction, e.g., on
$\dim(\text{Support}(M))$, finishes the proof.
\end{proof}

\begin{lemma}
\label{lemma-depth-in-ses}
Let $R$ be a local Noetherian ring. Let $0 \to N' \to N \to N'' \to 0$
be a short exact sequence of finite $R$-modules.
\begin{enumerate}
\item
$\text{depth}(N'') \geq \min\{\text{depth}(N), \text{depth}(N') - 1\}$
\item
$\text{depth}(N') \geq \min\{\text{depth}(N), \text{depth}(N'') + 1\}$
\end{enumerate}
\end{lemma}

\begin{proof}
This is easy using the results above. Hint:
Use the characterization of depth using the Ext groups
$\text{Ext}^i(\kappa, N)$, see Lemma \ref{lemma-annihilate-ext},
and use the long exact cohomology sequence
$$
\begin{matrix}
0
\to \text{Hom}_R(\kappa, N')
\to \text{Hom}_R(\kappa, N)
\to \text{Hom}_R(\kappa, N'')
\\
\phantom{0\ }
\to \text{Ext}^1_R(\kappa, N')
\to \text{Ext}^1_R(\kappa, N)
\to \text{Ext}^1_R(\kappa, N'')
\to \ldots
\end{matrix}
$$
from Lemma \ref{lemma-long-exact-seq-ext}.
\end{proof}


\section{What makes a complex exact?}
\label{section-complex-exact}

\noindent
Some of this material can be found in a paper by Buchsbaum and Eisenbud.

\begin{situation}
\label{situation-complex}
Here $R$ is a ring, and we have a complex
$$
0
\to
R^{n_e}
\xrightarrow{\varphi_e}
R^{n_{e-1}}
\xrightarrow{\varphi_{e-1}}
\ldots
\xrightarrow{\varphi_{i+1}}
R^{n_i}
\xrightarrow{\varphi_i}
R^{n_{i-1}}
\xrightarrow{\varphi_{i-1}}
\ldots
\xrightarrow{\varphi_1}
R^{n_0}
$$
\end{situation}

\begin{lemma}
\label{lemma-add-trivial-complex}
In Situation \ref{situation-complex}.
Suppose $R$ is a local ring with maximal ideal $\mathfrak m$.
Suppose that for some $i$, $e \leq i \leq 1$
some matrix coefficient of the map $\varphi_i$. Then the complex
$0 \to R^{n_e} \to R^{n_{e-1}} \to \ldots \to R^{n_0}$
is isomorphic to the direct sum of a complex
$0 \to R^{n_e} \to \ldots \to R^{n_i - 1} \to
R^{n_{i-1} - 1} \to \ldots \to R^{n_0}$
and the complex $0 \to 0 \to \ldots \to R \to R \to 0 \to \ldots \to 0$
where the map is the identity.
\end{lemma}

\begin{proof}
The assumption means, after a change of basis of
$R^{n_i}$ and $R^{n_{i-1}}$ that the first basis
vector of $R^{n_i}$ is mapped via $\varphi_i$ to the first basis
vector of $R^{n_{i-1}}$. Let $e_j$ denote the
$j$th basis vector of $R^{n_i}$ and $f_k$ the $k$th
basis vector of $R^{n_{i-1}}$. Write $\varphi_i(e_j) 
= \sum a_{jk} f_k$. So $a_{1k} = 0$ unless $k = 1$
and $a_{11} = 1$. Change basis on $R^{n_i}$ again
by setting $e'_j = e_j - a_{j1} e_1$ for $j > 1$.
After this change of coordinates we have $a_{j1} = 0$
for $j > 1$. Note the image
of $R^{n_{i+1}} \to R^{n_i}$ is contained in the
subspace spanned by $e_j$, $j > 1$. Note also
that $R^{n_{i-1}} \to R^{n_{i-2}}$ has to annihilate
$f_1$ since it is in the image. These conditions
and the shape of the matrix $(a_{jk})$ for $\varphi_i$
imply the lemma.
\end{proof}

\noindent
Let us say that an acyclic complex of the form
$\ldots \to 0 \to R \to R \to 0 \to \ldots $
is {\it trivial}. The lemma above clearly says that
any finite complex of finite free modules over a local ring is up to direct
sums with trivial complexes the same as a complex
all of whose maps have all matrix coefficients in 
the maximal ideal.

\begin{lemma}
\label{lemma-exact-artinian-local}
In Situation \ref{situation-complex}.
Let $R$ be a Artinian local ring.
Suppose that $0 \to R^{n_e} \to R^{n_{e-1}}
\to \ldots \to R^{n_0}$ is an exact complex.
Then the complex is isomorphic to a direct sum of
trivial complexes.
\end{lemma}

\begin{proof}
By induction on the integer $\sum n_i$.
Clearly $\text{Ass}(R) = \{\mathfrak m\}$.
Pick $x \in R$, $x \not = 0$, $\mathfrak m x = 0$.
Pick a basis vector $e_i \in R^{n_e}$.
Since $xe_i$ cannot be mapped to zero by
exactness we deduce that some matrix 
coefficient of the map $R^{n_e} \to R^{n_{e-1}}$.
Lemma \ref{lemma-add-trivial-complex} then allows
us to decrease $\sum n_i$.
\end{proof}


\begin{definition}
\label{definition-rank}
Let $R$ be a ring. Suppose that $\varphi : R^m \to R^n$ is a map
of finite free modules.
\begin{enumerate}
\item The {\it rank} of $\varphi$ is the maximal $r$ such that
$\wedge^r \varphi : \wedge^r R^m \to \wedge^r R^n$ is nonzero.
\item We let $I(\varphi) \subset R$ be the ideal generated by
the $r\times r$ minors of the matrix of $\varphi$, where $r$
is the rank as defined above.
\end{enumerate}
\end{definition}

\begin{lemma}
\label{lemma-trivial-case-exact}
In Situation \ref{situation-complex}, suppose the complex is
isomorphic to a direct sum of trivial complexes. Then
for all $i$, $1 \leq i \leq e$ we have
$\text{rank}(\varphi_{i+1}) + \text{rank}(\varphi_i) = n_i$
and each $I(\varphi_i) = R$.
\end{lemma}

\begin{proof}
We may assume the complex is the direct sum of trivial
complexes. In this case the assertion is clear since for
each $i$ we can split the basis elements of $R^{n_i}$
into those that get mapped to by a basis element, and those
that map to a basis element.
\end{proof}

\noindent
In particular in the situation of the lemma the
maps $\varphi_i$ have rank
$(-1)^{e-i} n_e + (-1)^{e-1-i} n_{e-1} + \ldots + n_i$.

\begin{lemma}
\label{lemma-exact-length-1}
Let $R$ be a local Noetherian ring.
Suppose that $\varphi : R^m \to R^n$ is a map
of finite free modules. The following are equivalent
\begin{enumerate}
\item $\varphi$ is injective.
\item the rank of $\varphi$ is $m$ and
either $I(\varphi) = R$ or it contains a nonzero divisor.
\end{enumerate}
\end{lemma}

\begin{proof}
If any matrix coefficient of $\varphi$ is not in $\mathfrak m$,
then we apply lemma \ref{lemma-add-trivial-complex} to write
$\varphi$ as the sum of $1 : R \to R$ and a map
$\varphi' : R^{m-1} \to R^{n-1}$. It is easy to see that
the lemma for $\varphi'$ implies the lemma for $\varphi$.
Thus we may assume from the outset that all the matrix 
coefficients of $\varphi$ are in $\mathfrak m$.

\medskip\noindent
Suppose $\varphi$ is injective. We may assume $m > 0$.
Let $q \in \text{Ass}(R)$. Let $x \in R$ be an element
whose annihilator is $\mathfrak q$. Note that $\varphi$
induces a injective map $xR^m \to xR^n$ which is isomorphic
to the map $\varphi_{\mathfrak q} : (R/\mathfrak q)^m \to (R/\mathfrak q)^n$
induced by $\varphi$. Since $R/\mathfrak q$ is a domain
we deduce immediately by localizing to its fraction field
that the rank of $\varphi_{\mathfrak q}$ is $m$ and that
$I(\varphi_{\mathfrak q})$ is not the zero ideal. Hence we
conclude by Lemma \ref{lemma-ideal-nonzerodivisor}.

\medskip\noindent
Conversely, assume that the rank of $\varphi$ is $m$
and that $I(\varphi)$ contains a non zerodivisor.
The rank being $m$ implies $n \geq m$. Let $I$ be
a subset $I \subset \{1,\ldots,n\}$ of cardinality
$m$ and denote $p_I : R^{n} \to R^m$ the projection
corresponding to the coordinate functions whose indices
are in $I$. Denote $\varphi_I$ the composition
$p_I \circ \varphi$ and $a_I = \det(\varphi_I)$.
our assumption is that there exist $b_I \in R$ such
that $x = \sum b_I a_I$ is a nonzero divisor.
Let $\psi_I : R^m \to R^m$ be a the adjoint map, i.e.,
such that $\varphi_I \circ \psi_I = \psi_I \circ \varphi_I = 
a_I \text{id}_{R^m}$. Suppose $v \in R^m$ is in the kernel of $\varphi$.
Then $\varphi_I(v) = 0$. Hence $xv = \sum b_I a_I v 
= \sum b_I (\psi_I \circ \varphi_I)(v)
= \sum b_I \psi_I(\varphi_I(v)) = 0$. Thus $v = 0$.
\end{proof}

\begin{lemma}
\label{lemma-exact-depth-zero-local}
In Situation \ref{situation-complex}. Suppose $R$ is
a local Noetherian ring with maximal ideal $\mathfrak m$.
Assume $\mathfrak m \in \text{Ass}(R)$, in other words
$R$ has depth $0$. Suppose that the complex is exact.
In this case the complex is isomorphic to a direct sum of trivial
complexes.
\end{lemma}

\begin{proof}
The proof is the same as in \ref{lemma-exact-artinian-local},
except using Lemma \ref{lemma-exact-length-1} to garantee
that $I(\varphi_e) = R$, and hence some matrix coefficient
of $\varphi_e$ is not in $\mathfrak m$.
\end{proof}

\begin{lemma}
\label{lemma-div-x-exact-one-less}
In Situation \ref{situation-complex}, suppose $R$ is
a local Noetherian ring, and suppose that the complex
is exact. Let $x$ be an element of the maximal ideal
which is a nonzero divisor. The complex
$0 \to (R/xR)^{n_e} \to \ldots \to (R/xR)^{n_1}$
is still exact.
\end{lemma}

\begin{proof}
Follows easily from the snake lemma.
\end{proof}

\begin{lemma}
\label{lemma-acyclic}
(Acyclicity lemma.)
Let $R$ be a local Noetherian ring.
Let $0 \to M_e \to M_{e-1} \to \ldots \to M_0$
be a complex of finite $R$-modules. 
Assume $\text{depth}(M_i) \geq i$.
Let $i$ be the largest index such that the complex is
not exact at $M_i$. If $i > 0$ then
$\text{Ker}(M_i \to M_{i-1})/\text{Im}(M_{i+1} \to M_i)$
has depth $\geq 1$.
\end{lemma}

\begin{proof}
Let $H = \text{Ker}(M_i \to M_{i-1})/\text{Im}(M_{i+1} \to M_i)$ be the 
cohomology group in question.
We may break the complex into short exact sequences
$0 \to M_e \to M_{e-1} \to K_{e-2} \to 0$,
$0 \to K_j \to M_j \to K_{j-1} \to 0$, for $i+2 \leq j \leq e-2 $,
$0 \to K_{i+1} \to M_{i+1} \to B_i \to 0$,
$0 \to K_i \to M_i \to M_{i-1}$, and
$0 \to B_i \to K_i \to H \to 0$.
We proceed up through these complexes to
prove the statements about depths, repeatedly using
Lemma \ref{lemma-depth-in-ses}.
First of all, since $\text{depth}(M_e) \geq e$,
and $\text{depth}(M_{e-1}) \geq e-1$ we deduce
that $\text{depth}(K_{e-1}) \geq e - 1$. At this point the
sequences $0 \to K_j \to M_j \to K_{j-1} \to 0$ for $i+2 \leq j \leq e-2 $
imply similarly that $\text{depth}(K_{j-1}) \geq j - 1$ for
$i+2 \leq j \leq e-2$. The sequence $0 \to K_{i+1} \to M_{i+1} \to B_i \to 0$
then shows that $\text{depth}(B_i) \geq i$. The sequence
$0 \to K_i \to M_i \to M_{i-1}$ shows that $\text{depth}(K_i) \geq 1$
since $M_i$ has depth $\geq i \geq 1$ by assumption.
The sequence $0 \to B_i \to K_i \to H \to 0$ then
implies the result.
\end{proof}

\begin{proposition}
In Situation \ref{situation-complex}, suppose $R$ is
a local Noetherian ring. The complex is exact if and
only if for all $i$, $1 \leq i \leq e$
the following two conditions are satisfied:
\begin{enumerate}
\item we have $\text{rank}(\varphi_{i+1}) + \text{rank}(\varphi_i)
= n_i$, and
\item $I(\varphi_i) = R$, or $I(\varphi_i)$ contains a
regular sequence of length $i$.
\end{enumerate}
\end{proposition}

\begin{proof}
This proof is very similar to the proof of Lemma
\ref{lemma-exact-length-1}.
As in the proof of Lemma \ref{lemma-exact-length-1} we may assume
that all matrix entries of each $\varphi_i$ are elements of
the maximal ideal. We may also assume that $e \geq 1$.

\medskip\noindent
Assume the complex is exact. Let $q \in \text{Ass}(R)$.
(There is at least one such prime.)
Note that the ring $R_{\mathfrak q}$ has depth $0$.
We apply Lemmas \ref{lemma-exact-depth-zero-local} and
\ref{lemma-trivial-case-exact} to the localized complex
over $R_{\mathfrak q}$. all of the ideals
$I(\varphi_i)_{\mathfrak q}$, $e \geq i \geq 1$
are equal to $R_{\mathfrak q}$. Thus none of the ideals
$I(\varphi_i)$ is contained in $\mathfrak q$.
This implies that $I(\varphi_e)I(\varphi_{e-1})\ldots I(\varphi_1)$
is not contained in any of the associated primes 
of $R$. By Lemma \ref{lemma-silly} we may choose
$x \in I(\varphi_e)I(\varphi_{e-1})\ldots I(\varphi_1)$,
$x \not \in \mathfrak q$ for all $q\in \text{Ass}(R)$.
According to Lemma \ref{lemma-div-x-exact-one-less}
the complex $0 \to (R/xR)^{n_e}
\to \ldots \to (R/xR)^{n_1}$ is exact. By induction
on $e$ all the ideals $I(\varphi_i)/xR$ have a regular
sequence of length $i-1$. This proves that $I(\varphi_i)$
contains a regular sequence of length $i$.

\medskip\noindent
Assume the two conditions on the ranks of $\varphi_i$
and the ideals $I(\varphi_i)$ is satisfied. Note that
$I(\varphi_i) \subset \mathfrak m$ for all $i$ because
of what was said in the first paragraph of the proof.
Hence the assumption in particular implies that
$\text{depth}(R) \geq e$. By induction
on the dimension of $R$ we may assume the complex
is exact when localized at any nonmaximal prime of $R$.
Thus $\text{Ker}(\varphi_i)/\text{Im}(\varphi_{i+1})$
has support $\{\mathfrak m\}$ and hence (if nonzero)
depth $0$. By Lemma \ref{lemma-acyclic} we see
that the complex is exact.
\end{proof}



\section{Cohen-Macaulay modules}
\label{section-CM}

\noindent
Here we just do a minimal amount of work to show that
Cohen-Macaulay modules have good properties. We postpone
using Ext groups to esthablish the connection with duality
and so on.

\begin{definition}
\label{definition-CM}
Let $R$ be a Noetherian local ring.
Let $M$ be a finite $R$-module.
We say $M$ is {\it Cohen-Macaulay}
if $\dim(\text{Support}(M)) = \text{depth}(M)$.
\end{definition}

\noindent
Let $R$ be a local Noetherian ring. Let $M$ be
a Cohen-Macaulay module, and let $f_1,\ldots,f_d$
be an $M$-regular sequence with $d = \dim(\text{Support}(M))$.
We say that $g \in \mathfrak m$ is {\it good with respect to
$(M, f_1,\ldots,f_d)$} if for all $i = 0, 1, \ldots, d-1$
we have $\dim (\text{Support}(M) \cap V(g,f_1,\ldots,f_i))
= d - i - 1$. This is equivalent to the condition that
$\dim((\text{Support}(M/(f_1,\ldots,f_i)M) \cap V(g) =
d - i -1$ for $i = 0, 1, \ldots, d-1$.

\begin{lemma}
\label{lemma-good-element}
Notation and assumptions as above. If $g$ is good with respect to
$(M, f_1,\ldots,f_d)$, then (a) $g$ is a nonzero-divisor on $M$,
and (b) $M/gM$ is Cohen-Macaulay with maximal regular
sequence $f_1,\ldots,f_{d-1}$.
\end{lemma}

\begin{proof}
We prove the lemma by induction on $d$.
If $d = 0$, then $M$ is finite and there is no case
to which the lemma applies.
If $d = 1$, then we have to show that $g : M \to M$ is
injective. The kernel $K$ has support $\{\mathfrak m\}$
because by assumption $\dim \text{Supp}(M) \cap V(g) = 0$.
Hence $K$ has finite length. Hence $f_1 : K \to K$ injective
implies the length of the image is the length of $K$, and hence
$f_1 K = K$, which by Nakayama's Lemma \ref{lemma-NAK} implies $K = 0$.
Also, $\dim \text{Supp}(M/gM) = 0$ and so $M/gM$ is Cohen-Macaulay
of depth $0$.

\medskip\noindent
For $d > 1$ we essentially argue in the same way. Let $K \subset M$
be the kernel of multiplication by $g$. As above $f_1 : K \to K$
cannot be surjective if $K \not= 0$
Consider the commutative diagram
$$
\begin{matrix}
0 & \to & M & \xrightarrow{f_1} & M & \to & M/f_1M & \to & 0 \\
& & \downarrow{g} & & \downarrow{g} & & \downarrow{g} && \\
0 & \to & M & \xrightarrow{f_1} & M & \to & M/f_1M & \to & 0 \\
\end{matrix}
$$
This shows that the kernel $K_1$ of $g : M/f_1M \to M/f_1M$
cannot be zero if $K$ is not zero. But $g$ is good for
$(M/f_1M, f_2,\ldots,f_d)$, as is easy seen from the definition.
We conclude that $K_1 = 0$, and so $K = 0$. From the snake
lemma we see that
$0 \to M/gM \to M/gM \to M/(f_1, g)M \to 0$
is exact. By induction, we have that $M/(g, f_1)M$
is Cohen-Macaulay with regular sequence $f_2,\ldots,f_{d-1}$.
Thus $M/gM$ is Cohen-Macaulay with regular sequence $f_1,\ldots,f_{d-1}$.
\end{proof}

\begin{lemma}
\label{lemma-CM-one-g}
Let $R$ be a Noetherian local ring.
Let $M$ be a Cohen-Macaulay module over $R$.
Suppose $g \in \mathfrak m$ is such that $\dim(\text{Supp}(M) \cap V(g))
= \dim(\text{Supp}(M)) - 1$. Then (a) $g$ is a nonzero divisor on $M$,
and (b) $M/gM$ is Cohen-Macaulay of depth one less.
\end{lemma}

\begin{proof}
Choose a $M$-regular sequence $f_1,\ldots,f_d$ with
$d = \dim(\text{Supp}(M))$. If $g$ is is good with respect to
$(M, f_1,\ldots,f_d)$ we win by Lemma \ref{lemma-good-element}.
In particular the lemma holds if $d = 1$. (The case $d = 0$ does
not occur.) Assume $d > 1$. Choose an element $h \in R$ such that
(a) $h$ is good with respect to $(M, f_1,\ldots,f_d)$,
and (b) $\dim( \text{Supp}(M) \cap V(h, g) = d - 2$.
To see $h$ exists, let $\{\mathfrak q_i\}$ be the (finite) set of
minimal primes of the closed sets $\text{Supp}(M)$,
$\text{Supp}(M)\cap V(f_1,\ldots,f_i)$, $i=1,\ldots, d-1$,
and $\text{Supp}(M) \cap V(g)$. None of these $\mathfrak q_i$
is equal to $\mathfrak m$ and hence we may find $h \in \mathfrak m$,
$h \not \in \mathfrak q_i$ by Lemma \ref{lemma-silly}. It is clear
that $h$ satisfies (a) and (b). At this point we may
apply Lemma \ref{lemma-good-element} to conclude that
$M/hM$ is Cohen-Macaulay. By (b) we see that the pair
$(M/hM, g)$ satisfies the induction hypothesis. Hence
$M/(h,g)M$ is Cohen-Macaulay, and $g : M/hM \to M/hM$
is injective. From this it follows easily that
$g : M \to M$ is injective, by a snake lemma argument.
This in its turn implies that $h : M/gM \to M/gM$
is injective. Combined with the fact that $M/(g,h)M$
is Cohen-Macaulay this finishes the proof.
\end{proof}

\begin{proposition}
\label{proposition-CM-module}
Let $R$ be a Noetherian local ring, with maximal ideal $\mathfrak m$.
Let $M$ be a Cohen-Macaulay module over $R$ whose support has dimension $d$.
Suppose that $g_1,\ldots,g_c$ are elements of
$\mathfrak m$ such that $\dim(\text{Supp}(M/(g_1,\ldots,g_c)M))
= d - c$. Then $g_1,\ldots,g_c$ is an $M$-regular sequence,
and can be extended to a maximal $M$-regular sequence.
\end{proposition}

\begin{proof}
Let $Z = \text{Supp}(M) \subset \text{Spec}(R)$.
By Lemma \ref{lemma-one-equation} in the chain
$Z \supset Z \cap V(g_1) \supset \ldots \supset Z \cap V(g_1,\ldots,g_c)$
each step decreases the dimension at most by $1$. Hence by assumption
each step decreases the dimension by exactly $1$ each time. Thus we 
may succesively apply Lemma \ref{lemma-CM-one-g} above to the modules
$M/(g_1,\ldots,g_i)$ and the element $g_{i+1}$.

\medskip\noindent
To extend $g_1,\ldots,g_c$ by one element if $c < d$ we simply
choose an element $g_{c+1} \in \mathfrak m$ which is not
in any of the finitely many minimal primes of $Z \cap V(g_1,\ldots,g_c)$,
using Lemma \ref{lemma-silly}.
\end{proof}

\section{Cohen-Macaulay rings}
\label{section-CM-ring}

\begin{definition}
\label{definition-local-ring-CM}
A Noetherian local ring $R$ is called {\it Cohen-Macaulay}
if it is Cohen-Macaualay as a module over itself.
\end{definition}

\begin{lemma}
\label{lemma-maximal-chain-CM}
Suppose $R$ is a Cohen-Macaulay local ring of dimension $d$.
Any chain of ideals $\mathfrak p_0 \subset
\mathfrak p_1 \subset \ldots \subset \mathfrak p_n$
such that there is no prime strictly between $\mathfrak p_i$ and
$\mathfrak p_{i+1}$ has length $n = d$.
\end{lemma}

\begin{proof}
Choose an element $x \in \mathfrak p_1$, with $x$ not in
any of the minimal primes of $R$, and in particular
$x \not \in \mathfrak p_0$. (See Lemma \ref{lemma-silly}.)
Then $\dim (R/xR) < \dim (R)$ and $R/xR$ is Cohen-Macaulay
by Proposition \ref{proposition-CM-module}. By induction
the chain $\mathfrak p_1/xR \subset \ldots \mathfrak p_n/xR$
has length $d - 1$.
\end{proof}

\begin{lemma}
\label{lemma-CM-dim-formula}
Suppose $R$ is a Noetherian local Cohen-Macaulay ring of dimension $d$.
For any prime $\mathfrak p \subset R$ we have
$$
\dim(R) = \dim(R_{\mathfrak p}) + \dim(R/\mathfrak p).
$$
\end{lemma}

\begin{proof}
This is immediate from the result on maximal sequences
above, by looking at maximal sequences which have $\mathfrak p$
in them.
\end{proof}

\begin{lemma}
\label{lemma-localize-CM}
Suppose $R$ is a Cohen-Macaulay local ring.
For any prime $\mathfrak p \subset R$ the
ring $R_{\mathfrak p}$ is Cohen-Macaulay as well.
\end{lemma}

\begin{proof}
Suppose that $\dim(R) = d$ and that $\dim(R/\mathfrak p) = d - c$.
We may choose $f_1,\ldots,f_c \in \mathfrak p$ such that
$\dim V(f_1,\ldots,f_i) = d - i$, using Lemma \ref{lemma-silly}
at each step to avoid minimal primes of $V(f_1,\ldots,f_{i-1})$.
Then $\mathfrak p$ is minimal over $(f_1,\ldots,f_c)$ and hence
the support of $R_{\mathfrak p}/(f_1,\ldots,f_c)R_{\mathfrak p}$ consists
of the maximal ideal of $R_{\mathfrak p}$. In other words
$R_{\mathfrak p}$ has an ideal of definition generated by
$c$ elements, and has dimension $c$ by Lemma \ref{lemma-CM-dim-formula}.
\end{proof}

\begin{definition}
\label{definition-ring-CM}
A Noetherian ring $R$ is called {\it Cohen-Macaulay} if all
its local rings are Cohen-Macaulay.
\end{definition}

\begin{lemma}
\label{lemma-dimension-shift}
Suppose that $R$ is a Noetherian local Cohen-Macaulay ring of dimension $d$.
Suppose that $M$ is a finite $R$-module, and suppose that
$0 \to K \to R^{n} \to M \to 0$ is an exact sequence of $R$-modules.
Then either $\text{depth}(K) > \text{depth}(M)$, or
$\text{depth}(K) = \text{depth}(M) = d$.
\end{lemma}

\begin{proof}
If $\text{depth}(M) = 0$ the lemma is clear.
Let $x \in \mathfrak m$ be a nonzero divisor on $M$ and
on $R$. Then $x$ is a nonzero divisor on $M$ and on $K$
and it follows by an easy diagram chase that
$0 \to K/xK \to (R/xR)^n \to M/xM \to 0$ is exact.
Thus the result follows from the result for $K/xK$
over $R/xR$ which has smaller dimension.
\end{proof}

\begin{definition}
\label{definition-maximal-CM}
Let $R$ be a Noetherian local Cohen-Macaulay ring.
A finite module $M$ over $R$ is called a {\it maximal
Cohen-Macaualay} module if $\text{depth}(M) = \dim(R)$.
\end{definition}

\begin{lemma}
\label{lemma-mcm-resolution}
Let $R$ be a local Noetherian Cohen-Macaulay ring of dimension $d$
Let $M$ be a finite $R$ module of depth $e$.
There exists an exact complex
$$
0 \to K \to F_{d-e-1} \to \ldots \to F_0 \to M \to 0
$$
with each $F_i$ finite free and $K$ maximal Cohen-Macaulay.
\end{lemma}

\begin{proof}
Immediate from the definition and Lemma \ref{lemma-dimension-shift}.
\end{proof}


\section{Regular rings}
\label{section-regular}

\noindent
It is not that easy to show that all prime localizations of a regular local
are regular. A nice proof of this fact uses projective dimension and
is better discussed after having introduced Ext, Tor, etc. We will do
this in a later chapter.

\begin{lemma}
\label{lemma-regular-graded}
Let $R$ be a regular local ring with maximal ideal $\mathfrak m$.
The graded ring $\bigoplus \mathfrak m^n / \mathfrak m^{n+1}$
is isomorphic to the graded polynomial algebra
$\kappa(\mathfrak m)[X_1,\ldots,X_d]$.
\end{lemma}

\begin{proof}
Let $x_1,\ldots,x_d$ be a minimal set of generators
for the maximal ideal $\mathfrak m$.
Write $\kappa = \kappa(\mathfrak m)$.
There is a surjection $\kappa[X_1,\ldots,X_d]
\to \bigoplus \mathfrak m^n/\mathfrak m^{n+1}$,
which maps the class of $x_i$ in $\mathfrak m/\mathfrak m^2$
to $X_i$. Since $d(R) = d$ we know that the numerical
polynomial $n \mapsto \dim_\kappa \mathfrak m^n/\mathfrak m^{n+1}$
has degree $d$. By Lemma \ref{lemma-quotient-smaller-d} we 
conclude that the surjection $\kappa[X_1,\ldots,X_d]
\to \bigoplus \mathfrak m^n/\mathfrak m^{n+1}$ is an isomorphism.
\end{proof}

\begin{lemma}
\label{lemma-regular-domain}
Any regular local ring is a domain.
\end{lemma}

\begin{proof}
We will use that $\bigcap \mathfrak m^n = 0$
by Lemma \ref{lemma-completion-faithfully-flat}.
Let $f, g \in R$ such that $fg = 0$.
Suppose that $f \in \mathfrak m^a$ and
$g \in \mathfrak m^b$, with $a,b$ maximal.
Since $fg = 0 \in \mathfrak m^{a+b+1}$
we see from the result of Lemma \ref{lemma-regular-graded}
that either $f \in \mathfrak m^{a+1}$ or
$g \in \mathfrak m^{b+1}$. Contradiction.
\end{proof}

\begin{lemma}
Let $R$ be a regular local ring and let
$x_1,\ldots,x_d$ be a minimal set of generators
for the maximal ideal $\mathfrak m$. Then
$x_1,\ldots,x_d$ is a regular sequence, and
each $R/(x_1,\ldots,x_c)$ is a regular local ring
of dimension $d - c$.
\end{lemma}

\begin{proof}
Note that $R/x_1R$ is a Noetherian local ring of dimension $\geq d - 1$
by Lemma \ref{lemma-one-equation} with $x_2,\ldots,x_d$
generating the maximal ideal. Hence it is regular by definition.
Since $R$ is a domain by Lemma \ref{lemma-regular-domain}
$x_1$ is a nonzero divisor.
\end{proof}

\begin{lemma}
\label{lemma-free-mod-x}
Let $R$ be a Noetherian local ring.
Let $x \in \mathfrak m$ be a nonzero divisor.
Let $M$ be a finite $R$-module such that 
$M/xM$ is free over $R/xR$.
Then $M$ is free over $R$.
\end{lemma}

\begin{proof}
Let $m_1,\ldots,m_r$ be elements of $M$ which map to
a $R/xR$-basis of $M/xM$. By Nakayama's Lemma \ref{lemma-NAK}
$m_1,\ldots,m_r$ generate $M$. If $\sum a_i m_i = 0$
is a relation, then $a_i \in xR$ for all $i$. Hence
$a_i = b_i x$ for some $b_i \in R$. Hence
the kernel $K$ of $R^r \to M$ satisfies $xK = K$
and hence is zero by Nakayama's lemma.
\end{proof}

\begin{lemma}
\label{lemma-regular-mcm-free}
Let $R$ be a local Noetherian regular ring.
Any maximal Cohen-Macaulay module over $R$ is
free.
\end{lemma}

\begin{proof}
Let $M$ be a maximal Cohen-Macaulay module over $R$.
Let $x \in \mathfrak m$ be part of a regular sequence
generating $\mathfrak m$. Then $x$ is a nonzero divisor
on $M$ by Proposition \ref{proposition-CM-module}, and
$M/xM$ is a maximal Cohen-Macaulay module over $R/xR$.
By induction on $\dim(R)$ we see that $M/xM$ is free.
We win by Lemma \ref{lemma-free-mod-x}.
\end{proof}

\section{Rings of finite global dimension}
\label{section-ring-finite-gl-dim}

\begin{definition}
\label{definition-locally-free}
Let $R$ be a ring and $M$ an $R$-module.
We say that $M$ is {\it locally free} if 
we can cover $\text{Spec}(R)$ by standard
opens $D(f_i)$, $i \in I$ such that $M_{f_i}$
is a free $R_{f_i}$-module for all $i \in I$.
We say that $M$ is {\it finite locally free} if
each $M_{f_i}$ is finite free.
\end{definition}

\noindent
Note that a finite locally free $R$-module is
automatically finitely presented by Lemma \ref{lemma-cover}.

\begin{lemma}
\label{lemma-finite-projective}
Let $R$ be a ring and let $M$ be an $R$-module.
The following are equivalent
\begin{enumerate}
\item $M$ is finitely presented and $R$-flat,
\item $M$ is finite projective,
\item $M$ is finitely presented and
for all $\mathfrak p \in \text{Spec}(R)$ the
localization $M_{\mathfrak p}$ is free,
\item $M$ is finitely presented and
for all maximal ideals $\mathfrak m \subset R$ the
localization $M_{\mathfrak m}$ is free,
\item $M$ is finite and locally free, and
\item $M$ is finite locally free.
\end{enumerate}
\end{lemma}

\begin{proof}
FIXME.
\end{proof}

\begin{remark}
\label{remark-warning}
It is not true that a finite $R$-module which is
$R$-flat is automatically projective. A counter
example is where $R = \mathcal{C}^\infty(\mathbf{R})$
is the ring of infinitely differentiable functions on
$\mathbf{R}$, and $M = R_{\mathfrak m} = R/I$ where
$\mathfrak m = \{f \in R \mid f(0) = 0\}$ and
$I = \{f \in R \mid \exists \epsilon, \epsilon > 0 :
f(x) = 0\ \forall x, |x| < \epsilon\}$.
\end{remark}

\begin{lemma}
\label{lemma-finite-flat-local}
(Warning: see Remark \ref{remark-warning} above.)
Suppose $R$ is a local ring, and $M$ is a finite
flat $R$-module. Then $M$ is finite free.
\end{lemma}

\begin{proof}
Follows from the equational criterion of flatness, see
Lemma \ref{lemma-flat-eq}. FIXME.
\end{proof}

\begin{lemma}
\label{lemma-Schanuel}
(Schanuel's lemma.)
Let $R$ be a ring. Let $M$ be an $R$-module.
Suppose that $0 \to K \to P_1 \to M \to 0$
and $0 \to L \to P_2 \to M \to 0$ are two short exact
sequences, with $P_i$ projective.
Then $K \oplus P_2 \cong L \oplus P_1$.
\end{lemma}

\begin{proof}
Consider the module
$N$ defined by the short exaxt sequence
$0 \to N \to P_1 \oplus P_2 \to M \to 0$,
where the last map is the sum of the two maps
$P-i \to M$. It is easy to see that the projection
$N \to P_1$ is surjective with kernel $L$, and that
$N \to P_2$ is surjective with kernel $K$.
Since $P_i$ are projective we have $N \cong K \oplus P_2
\cong L \oplus P_1$.
\end{proof}

\begin{definition}
\label{definition-finite-proj-dim}
Let $R$ be a Noetherian ring.
A finite module $M$ over $R$ is said to have {\it finite
projective dimension} if it has a finite length resolution by finite
projective $R$-modules. The minimal length of such a
finite projective resolution is called the {\it projective
dimension} of $M$.
\end{definition}

\noindent
The following lemma explains to what extend the projective
dimension is independent of the choice of a finite projective
resolution.

\begin{lemma}
\label{lemma-independent-resolution}
Let $R$ be a Noetherian ring.
Suppose that $M$ is a finite $R$-module
of projective dimension $d$.
Suppose that $F_e \to F_{e-1} \to \ldots \to F_0 \to M \to 0$
is exact with $F_i$ finite projective and $e \geq d - 1$.
Then the kernel of $F_e \to F_{e-1}$ is finite projective
(or the kernel of $F_0 \to M$ is finite projective in case
$e = 0$).
\end{lemma}

\begin{proof}
We prove this by induction on $d$. If $d = 0$, then
$M$ is projective. In this case there is a splitting
$F_0 = \text{Ker}(F_0 \to M) \oplus M$, and hence
$\text{Ker}(F_0 \to M)$ is finite projective. This finishes
the proof if $e = 0$, and if $e > 0$, then replacing
$M$ by $\text{Ker}(F_0 \to M)$ we decrease $e$.

\medskip\noindent
Next assume $d > 0$.
Let $0 \to P_d \to P_{d-1} \to \ldots \to P_0 \to M \to 0$
be a minimal length finite resolution with $P_i$ finite projective. 
According to Schanuel's Lemma \ref{lemma-Schanuel} we have
$P_0 \oplus \text{Ker}(F_0 \to M) \cong F_0 \oplus \text{Ker}(P_0 \to M)$.
This proves the case $d = 1$, $e = 0$, because then the right
hand side is $F_0 \oplus P_1$ which is projective. Hence now we may
assume $e > 0$. The module
$F_0 \oplus \text{Ker}(P_0 \to M)$ has the finite projective resolution
$0 \to P_d \oplus F_0 \to P_{d-1} \oplus F_0 \to \ldots \to P_1 \oplus F_0
\to \text{Ker}(P_0 \to M) \oplus F_0 \to 0$ of length $d - 1$.
By induction on $d$ we see that the kernel of
$F_{e} \oplus P_0 \to F_{e-1} \oplus P_0$ is finite projective.
This implies the lemma.
\end{proof}

\begin{definition}
\label{definition-finite-gl-dim}
Let $R$ be a Noetherian ring. The ring
$R$ is said to have {\it finite global dimension}
if there exists an integer $n$ such that
every finite $R$-module has a resolution by finite
projective $R$-modules of length at most $n$.
The minimal such $n$ is then called the {\it global dimension}
of $R$.
\end{definition}

\begin{proposition}
\label{proposition-regular-finite-gl-dim}
Let $R$ be a regular local ring of dimension $d$.
Every finite $R$-module $M$ of depth $e$ has a finite free
resolution
$$
0 \to F_{d-e} \to \ldots \to F_0 \to M \to 0.
$$
In particular a regular local ring has global dimension $\leq d$.
\end{proposition}

\begin{proof}
This is clear in view of Lemma \ref{lemma-regular-mcm-free}
and Lemma \ref{lemma-mcm-resolution}.
\end{proof}

\begin{lemma}
\label{lemma-localize-finite-gl-dim}
If $R$ is a Noetherian ring which has finite global dimension,
then any localization of $R$ has finite global dimension
at most the global dimesion of $R$.
\end{lemma}

\begin{proof}
Let $S \subset R$ be a multiplicative subset.
Let $M'$ be a finite $S^{-1}R$-module. 
Because $S^{-1}R$ is Noetherian $M'$ is finitely presented.
Say $M'$ is the cokernel of $A : (S^{-1}R)^m
\to (S^{-1}R)^n$. There exists an element $s$ of $S$ such
that $sA$ is the image of a matrix $B$ with coefficients in $R$.
Thus we see that $M = \text{Coker}(B : R^m \to R^n)$
is a finite $R$-module such that $M' = S^{-1}M$.
Since localization is an exact functor, the fact that
$M$ has a finite length resolution by finite projective
modules implies the same for $M'$.
\end{proof}

\begin{lemma}
\label{lemma-finite-gl-dim-primes}
Let $R$ be a Noetherian ring.
Then $R$ has finite global dimension if and
only if there exists an integer $n$ such that
for all maximal ideals $\mathfrak m$ of $R$
the ring $R_{\mathfrak m}$ has global dimension
$\leq n$.
\end{lemma}

\begin{proof}
We saw, Lemma \ref{lemma-localize-finite-gl-dim}
that if $R$ has finite global dimension $n$,
then so do the localizations $R_{\mathfrak m}$.
Conversely, suppose that all the $R_{\mathfrak m}$
have global dimension $n$. Let $M$ be a finite
$R$-module. Let
$0 \to K_n \to F_{n-1} \to \ldots \to F_0 \to M\to 0$.
be a resolution with $F_i$ finite projective.
According to Lemma \ref{lemma-independent-resolution}
and the assumption all the modules $K_n \otimes_R R_{\mathfrak m}$
are finite free. Hence by Lemma \ref{lemma-finite-projective}
the module $K_n$ is finite projective.
\end{proof}


\begin{lemma}
\label{lemma-exact-mod-x}
Suppose that $R$ is a ring, $x\in R$, and
$0 \to M' \to M \to M'' \to 0$ is a short exact
sequence such that $x$ is a nonzero divisor on $M''$.
Then $0 \to M'/xM' \to M/xM \to M''/xM'' \to 0$ is a short exact
sequence.
\end{lemma}

\begin{proof}
Easy application of the snake lemma.
\end{proof}

\begin{lemma}
\label{lemma-polynomial-finite-gl-dim}
If $R$ is Noetherian and has finite global dimension, so does $R[x]$.
In fact the global dimension of $R[x]$ is at most one more than
that of $R$.
\end{lemma}

\begin{proof}
Let $d$ be the global dimension of $R$.
Let $M$ be a finite module over $R[x]$. 
Choose a surjection $R[x]^n \to M$ and denote $K$ the kernel.
Let $F_{d-1} \to \ldots \to F_0 \to K \to 0$
be an exact complex with $F_j$ finite free $R[x]$ modules.
Let $\mathfrak q \subset R[x]$ be a maximal ideal,
and let $\mathfrak m \subset R$ be the inverse image in $R$.
By the Nullstellensatz, there exists an element $f \in \mathfrak q$
whose leading coefficient is not in $\mathfrak m$. Hence
$f$ is not a zero divisor in $R[x]_{\mathfrak q}$.
By Lemma \ref{lemma-exact-mod-x} the complex
with terms $F_i/fF_i$ is a resolution of $M/fM$. 
\end{proof}

\noindent
At this point we know that regular local rings are Cohen-Macaulay and
hence all their localizations are Cohen-Macaulay. Similarly,
regular local rings have finite global dimension, and so all
the localizations have finite local dimension. As explained
above we will see later that these localizations are in fact
regular as well.



\section{Dimension of finite type algebras over fields}
\label{section}

\begin{lemma}
\label{lemma-nrgens-affine-space}
Let $\mathfrak m$ be a maximal ideal in $k[x_1,\ldots,x_n]$.
The ideal $\mathfrak m$ is generated by $n$ elements.
\end{lemma}

\begin{proof}
By the Hilbert Nullstellensatz \ref{theorem-nulstellensatz},
we know the residue field $\kappa = \kappa(\mathfrak m)$ is
a finite extension of $k$. Denote $\alpha_i \in \kappa$ the
image of $x_i$. Denote $\kappa_i = k(\alpha_1,\ldots,\alpha_i)
\subset \kappa$, $i=1,\ldots, n$ and $\kappa_0 = k$.
Note that $\kappa_i = k[\alpha_1,\ldots,\alpha_i]$
by field theory. Define inductively elements
$f_i \in \mathfrak m \cap k[x_1,\ldots,x_i]$
as follows: Let $P_i(T) \in \kappa_{i-1}[T]$
be the monic minimal polynomial of $\alpha_i $ over $\kappa_{i-1}$.
Let $Q_i(T) \in k[x_1,\ldots,x_{i-1}][T]$ be a monic lift of $P_i(T)$
(of the same degree). Set $f_i = Q_i(x_i)$. 
Note that if $d_i = \deg_T(P_i) = \deg_T(Q_i) = \deg_{x_i}(f_i)$
then $d_1d_2\ldots d_n = [\kappa : k]$ by elementary field theory.

\medskip\noindent
We claim that there is an isomorphism
$k[x_1, \ldots, x_n] /(f_1, \ldots, f_n) \to \kappa$.
First of all, by construction we have $f_i \in \mathfrak m$
which gives us the map. Also, via this map, the ring
$k[x_1,\ldots,x_i]/(f_1, \ldots, f_i)$
maps onto $\kappa_i$. We wiil prove by induction that
$k[x_1,\ldots,x_i]/(f_1, \ldots, f_i) \to \kappa_i$
is an isomorphism, i.e., injective. Namely, the ring extension
$k[x_1,\ldots,x_i]/(f_1, \ldots, f_i) \to 
k[x_1,\ldots,x_{i+1}]/(f_1, \ldots, f_{i+1})$
is generated by $1$ element over a field and one
irreducible equation. By elementrary field theory
$k[x_1,\ldots,x_{i+1}]/(f_1, \ldots, f_{i+1})$
is a field.
\end{proof}

\begin{lemma}
\label{lemma-dim-affine-space}
Let $\mathfrak m$ be a maximal ideal in $k[x_1,\ldots,x_n]$.
The local ring $k[x_1,\ldots,x_n]_{\mathfrak m}$ has dimension
$n$.
\end{lemma}

\begin{proof}
Since the maximal ideal can be generated by (at most) $n$ elements
(Lemma \ref{lemma-nrgens-affine-space})
the local ring
has dimension at most $n$, by Proposition \ref{proposition-dimension}.
Denote the residue field of $\mathfrak m$ by $\kappa$ and
the images of $x_1,\ldots, x_n$ by $\alpha_1, \ldots,
\alpha_n$.

\medskip\noindent
If the residue field $\kappa$ of $\mathfrak m$ is $k$, then
$\mathfrak m = (x_1 - \alpha_1, \ldots, x_n - \alpha_n)$
and it is easy to see that $\mathfrak q_0 = (0) \subset
\mathfrak q_1 = (x_1 - \alpha_1)
\subset 
\mathfrak q_2 = (x_1 - \alpha_1, x_2 - \alpha_2) \subset
\ldots \subset 
\mathfrak q_n = (x_1 - \alpha_1, \ldots, x_n - \alpha_n)$
clearly is a chain of length $n$.

\medskip\noindent
In general, consider the finite ring extension
$k[x_1,\ldots, x_n] \to \kappa[x_1,\ldots,x_n]$,
and let $\mathfrak m' = (x_1 - \alpha_1, \ldots, x_n - \alpha_n)$.
Note that by construction $\mathfrak m'$ maps to
$\mathfrak m$ under the induced map of spectra.
By Lemma \ref{lemma-finite-no-rel} the images of the
$\mathfrak q_i$ are all distinct and hence provide
a chain of primes of length $n$ in $k[x_1,\ldots,x_n]_{\mathfrak m}$.
\end{proof}

\begin{proposition}
The local ring of a polynomial algebra over a field
at a maximal ideal $\mathfrak m$ is regular.
\end{proposition}

\begin{proof}
This is just the combination of Lemma \ref{lemma-nrgens-affine-space}
and \ref{lemma-nrgens-affine-space} above.
\end{proof}

\section{Syntomic morphisms}
\label{section-syntomic}

\noindent
We will exclusively deal with finitely presented ring maps
in this section. We will freely use the following
notation. Suppose $R \to S$ is of finite presentation, and
$\mathfrak q \subset S$ is a prime ideal.
Then for any presentation $\alpha : R[x_1,\ldots,x_n] \to S$ of $S$
over $R$, we denote $\mathfrak q_{\alpha}$ the
corresponding prime of $R[x_1,\ldots,x_n]$.
In particular we have the surjection
$(R[x_1,\ldots,x_n])_{\mathfrak q_{\alpha}} \to S_{\mathfrak q}$.
Also, in this section we will denote $J_{\mathfrak q_\alpha}$ the kernel
of this map:
$$
0
\to
J_{\mathfrak q_\alpha}
\to
(R[x_1,\ldots,x_n])_{\mathfrak q_{\alpha}}
\to
S_{\mathfrak q}
\to
0
$$

\begin{lemma}
\label{lemma-lci-field}
Let $k$ be a field.
Let $S$ be a finite type $k$-algebra.
Let $\mathfrak q \subset S$ be a prime.
The following are equivalent
\begin{enumerate}
\item for any presentation $\alpha : k[x_1,\ldots,x_n]
\to S$ the ideal $J_{\mathfrak q_\alpha}$ is generated
by a regular sequence,
\item for some presentation $\alpha : k[x_1,\ldots,x_n]
\to S$ the ideal $J_{\mathfrak q_\alpha}$ is generated
by a regular sequence,
\item there exists an $f \in S$, $f \not \in \mathfrak p$
such that $S_f = k[x_1,\ldots,x_n]/(f_1,\ldots,f_c)$
and $\dim(S_f) = n - c$.
\end{enumerate}
\end{lemma}



\begin{lemma}
\label{lemma-many}
Let $R$ be a ring.
Let $S$ be a finitely presented $R$-algebra. Let
$\mathfrak q$ be a prime of $S$ lying over the prime
ideal $\mathfrak p$ of $R$. The following are equivalent
\begin{enumerate}
\item $R_{\mathfrak p} \to S_{\mathfrak q}$ is flat
and 


Let $I \subset R$ be an ideal. Let $J = (I, T)R[T]$.
Let $\mathfrak q = (\mathfrak m, T)R[T]$.
If $J_{\mathfrak q}$ is generated by a regular sequence,
then $I$ is generated by a regular sequence in $R$.
\end{enumerate}
\end{lemma}

\begin{proof}
Say $J_{\mathfrak q} = (f_1, \ldots, f_t)$ with $f_1, \ldots, f_t$
a regular sequence. In particular $T = \sum g_i f_i$
for some $g_i \in (R[T])_{\mathfrak q}$. 

\end{proof}


\begin{lemma}
\label{lemma-lci-independent}
Suppose that $R \to S$ is of finite presentation.
Let $\mathfrak q \subset S$ be a prime mapping to
$\mathfrak p \subset R$. Suppose for some presentation
$\alpha : R[x_1,\ldots,x_n] \to S$ of $S$ the kernel
of $(R[x_1,\ldots,x_n])_{\alpha^{-1}(\mathfrak q)}
\to S_{\mathfrak q}$ is generated by a regular sequence.
Then the same is true for every presentation.
\end{lemma}

\begin{proof}
Let us denote the prime $\alpha^{-1}(\mathfrak q)$
by $\mathfrak q_{\alpha}$, and similarly for other
presentations. Consider a presentation
$\beta : R[x_1,\ldots,x_n,x_{n+1}] \to S$
which agrees with $\alpha$ on $R[x_1,\ldots,x_n]$.
In this case there exists a polynomial $h \in R[x_1,\ldots,x_n]$
such that $\alpha(h) = \beta(x_{n+1})$. Note that $x_{n+1} - h$
is a nonzero divisor in $\mathfrak q_{\beta}$ and that
the natural map $R[x_1,\ldots,x_n] \to
R[x_1,\ldots, x_n, x_{n + 1}]/(x_{n + 1} - h)$
is an isomorphism. Thus the assertion for $\alpha$
implies the assertion for $\beta$. 

\medskip\noindent
On the other hand, it is clear from the above as well that
$(R[x_1,\ldots, x_n, x_{n + 1}])_{\mathfrak q_{\beta}}$
is the localization of
$(R[x_1,\ldots, x_n])_{\mathfrak q_{\alpha}}[T]$
at the maximal ideal corresponding to $T = 0$.
Here $T = x_{n+1} - h$. 

\end{proof}




\begin{definition}
\label{definition-lci}
A ring map $R \to S$ is called {\it syntomic}, or {\it flat lci} 
if it is flat, of finite presentation, and if all of its fibres
$S \otimes_R \kappa(\mathfrak p)$ are 
\end{definition}



\section{Smooth ring maps}
\label{section-smooth}

\begin{definition}
\label{definition-smooth}
A ring map $R \to S$ is {\it smooth} if it is of finite presentation
and 
\end{definition}

\section{Miscellany}
\label{section-miscellany}

\noindent
The proofs in this section should not refer to any results except
those from the section on basic notions, Section \ref{section-rings-basic}.

\begin{lemma}
\label{lemma-silly}
Suppose $R$ is a ring, $\mathfrak p_i$, $i=1,\ldots,r$ primes
and $I \subset R$ an ideal. Assume $I \not\subset \mathfrak p_i$
for all $i$. Then there exists an $x\in I$, $x\not\in \mathfrak p_i$ for
all $i$.
\end{lemma}

\begin{proof}
We may assume there are no inclusions among the $\mathfrak p_i$.
The result is true for $r = 1$.
Suppose the result holds for $r-1$.
Pick $x \in I$, $x \not \in \mathfrak p_i$ for all $i=1,\ldots,r-1$.
If $I\mathfrak p_1 \ldots \mathfrak p_{r-1} \subset \mathfrak p_r$
then $I \subset \mathfrak p_r$ a contradiction.
Pick $y \in I\mathfrak p_1 \ldots \mathfrak p_{r-1}$,
$y \not \in \mathfrak p_r$. Then $x+y$ works.
\end{proof}

\begin{lemma}
\label{lemma-chinese-remainder}
(Chinese remainder.)
Let $R$ be a ring.
\begin{enumerate}
\item If $I_1,\ldots,I_r$ are ideals such that $I_a + I_b = R$
when $a \not = b$, then $I_1 \cap \ldots \cap I_r = 
I_1I_2\ldots I_r$ and $R/(I_1I_2\ldots I_r)
\cong R/I_1 \times \ldots \times R/I_r$.
\item If $\mathfrak m_1,\ldots,\mathfrak m_r$ are pairwise distinct maximal
ideals then $\mathfrak m_a + \mathfrak m_b = R$ for $a \not=b$ and the
above applies.
\end{enumerate}
\end{lemma}

\begin{proof}
FIXME.
\end{proof}

\begin{lemma}
\label{lemma-localize-colimit}
Let $M$ be an $R$-module, and let $S \subset R$ be
a multiplicative subset. Then $S^{-1}M = M\otimes_R S^{-1}R$
is the directed colimit of the modules $M_f$, $f\in S$ with
transition maps $M_f \to M_{f'}, m/f^n \mapsto (f'')^n m/(f')^n$
whenever $f =f' f''$ with $f,f',f''\in S$.
\end{lemma}

\begin{proof}
FIXME.
\end{proof}

\begin{lemma}
\label{lemma-NAK}
(Nakayama's lemma.)
Let $R$ be a ring, let $M$ be an $R$-module, and let $I \subset R$
be an ideal.
\begin{enumerate}
\item If $M$ is finite, and $IM = M$, then there exists a
$f = 1+i \in 1 + I$ such that $fM = 0$.
\label{nakayama}
\item If $M$ is finite, $IM = M$, and $I \subset \text{rad}(R)$
then $M=0$.
\item If $IM=M$, $I$ is nilpotent, then $M=0$.
\end{enumerate}
\end{lemma}

\begin{proof}
Proof of \ref{nakayama}.
Write $M = \sum Rx_j$, $j=1,\ldots,r$. Write $x_j = \sum i_{jj'} x_{j'}$ with
$i_{jj'} \in I$.  In other words $\sum (\delta_{jj'} - i_{jj'})x_{j'} = 0$.
Hence the determinant $f$ of the $r\times r$ matrix
$(\delta_{jj'} - i_{jj'})$ is a solution. The other parts are easy.
\end{proof}

\begin{lemma}
\label{lemma-cover}
Let $R$ be a ring, and let $M$ be an $R$-module.
Suppose that $f_1,\ldots,f_n$ is a finite list of
elements of $R$ such that $\bigcup D(f_i) = \text{Spec}(R)$
(in other words $(f_1,\ldots,f_n) = R$).
\begin{enumerate}
\item If each $M_{f_i}$ is a finite $R_{f_i}$-module,
then $M$ is a finite $R$-module.
\item If each $M_{f_i}$ is a finitely presented $R_{f_i}$-module,
then $M$ is a finitely presented $R$-module.
\end{enumerate}
\end{lemma}

\begin{proof}
FIXME.
\end{proof}


\input{chapters}

\bibliography{my}
\bibliographystyle{alpha}

\end{document}
