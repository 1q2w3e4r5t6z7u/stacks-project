\input{preamble}

% OK, start here.
%
\begin{document}

\title{Commutative Algebra}

%\begin{abstract}
%\end{abstract}

\maketitle

\tableofcontents

\section{Introduction}
\label{section-introduction}

\noindent
Basic commutative algebra will be explained in this document.
A reference is \cite{MatCA}.

\section{Conventions}
\label{section-conventions}

\noindent
A ring is commutative with $1$. The zero ring is a ring. In fact it is
the only ring that does not have a prime ideal.

\section{Basic notions}
\label{section-rings-basic}

\noindent
The following notions are considered basic and will not be defined,
and or proved. This does not mean they are all necessarily easy or 
well known.

\begin{enumerate}
\item $R$ is a {\it ring},
\label{ring}
\item $x\in R$ is {\it nilpotent},
\label{ring-element-nilpotent}
\item $x\in R$ is a {\it zero-divisor},
\label{ring-element-zerodivisor}
\item $x\in R$ is a {\it unit},
\label{ring-element-unit}
\item $\varphi : R_1 \to R_2$ is a {\it ring homomorphism},
\label{ring-homomorphism}
\item $\varphi : R_1 \to R_2$ is {\it of finite presentation}, or
{\it $R_2$ is a finitely presented $R_1$-algebra},
\label{ring-homomorphism-finite-presentation}
\item $\varphi : R_1 \to R_2$ is {\it of finite type}, or
{\it $R_2$ is a finitely type $R_1$-algebra},
\label{ring-homomorphism-finite-type}
\item $\varphi : R_1 \to R_2$ is {\it finite}, or
{\it $R_2$ is a finite $R_1$-algebra},
\label{ring-homomorphism-finite}
\item $R$ is a {\it (integral) domain},
\label{ring-domain}
\item $R$ is {\it reduced},
\label{ring-reduced}
\item $R$ is {\it Noetherian},
\label{ring-Noetherian}
\item $K$ is a {\it field},
\label{field}
\item $K \subset L$ is a {\it field extension},
\label{field-extension}
\item $K \subset L$ is an {\it algebraic field extension},
\label{field-extension-algebraic}
\item $\{t_i\}_{i\in I}$ is a {\it transcendence basis} for $L$ over $K$,
\label{transcendence-basis}
\item the {\it transcendence degree} $\text{trdeg}(L/K)$ of $L$
over $K$,
\label{transcendence-degree}
\item the field $k$ is {\it algebraically closed},
\label{algebraically-closed}
\item if $K \subset L$ is algebraic, and $K \to k$ a field map,
then there exists a map $L \to k$ extending the map on $K$,
\label{extend-into-algebraically-closed}
\item $I \subset R$ is an {\it ideal},
\label{ideal}
\item if $I$ is an ideal then we have its {\it radical} $\sqrt{I}$,
\label{radical-ideal}
\item $\mathfrak p \subset R$ is a {\it prime ideal},
\label{prime-ideal}
\item $\mathfrak m \subset R$ is a {\it maximal ideal},
\label{maximal-ideal}
\item any nonzero ring has a maximal ideal,
\label{exists-maximal-ideal}
\item the ideal $(T)$ {\it generated} by a subset $T \subset R$,
\label{ideal-generated-by}
\item the {\it quotient ring} $R/I$,
\label{quotient-ring}
\item if $\varphi : R_1 \to R_2$ is a ring homomorphism, and if
$I \subset R_2$ is an ideal, then $\varphi^{-1}(I)$ is an
ideal of $R_1$,
\label{inverse-image-ideal}
\item if $\varphi : R_1 \to R_2$ is a ring homomorphism, and if
$I \subset R_1$ is an ideal, then $\varphi(I) \cdot R_2$ (sometimes
denoted $I \cdot R_2$, or $IR_2$) is the ideal of $R_2$ generated
by $\varphi(I)$,
\label{image-ideal}
\item if $\varphi : R_1 \to R_2$ is a ring homomorphism, and if
$\mathfrak p \subset R_2$ is a prime ideal, then
$\varphi^{-1}(\mathfrak p)$ is a prime ideal of $R_1$,
\label{inverse-image-prime}
\item $M$ is an {\it $R$-module},
\label{module}
\item $N \subset M$ is an {\it $R$-submodule},
\label{submodule}
\item $M$ is an {\it Noetherian $R$-module},
\label{Noetherian-module}
\item $M$ is a {\it finite $R$-module},
\label{finite-module}
\item $M$ is a {\it finitely generated $R$-module},
\label{finitely-generated-module}
\item $M$ is a {\it finitely presented $R$-module},
\label{finitely-presented-module}
\item $M$ is a {\it free $R$-module},
\label{free-module}
\item if $N \subset M \subset L$ are $R$-modules,
then $L/M = (L/N)/(M/N)$,
\label{isomorphism-theorem}
\item $S$ is a {\it multiplicative subset of $R$},
\label{multiplicative-subset}
\item the {\it localization} $R \to S^{-1}R$ of $R$,
\label{localization-ring}
\item if $R$ is a ring and $S$ is a multiplicative subset
of $R$ then $S^{-1}R$ is the zero ring if and only if $S$ contains
$0$,
\label{localization-zero}
\item if $R$ is a ring and if the multiplicative subset $S$
consists completely of nonzero divisors, then $R \to S^{-1}R$
is injective,
\label{localize-nonzerodivisors}
\item if $\varphi : R_1 \to R_2$ is a ring homomorphism, and
$S$ is a multiplicative subsets of $R_1$, then $\varphi(S)$ is
a multiplicative subset of $R_2$,
\item if $S$, $S'$ are multiplicative subsets of $R$,
and if $SS'$ denotes the set of products $SS' =
\{r \in R \mid \exists s\in S, \exists s' \in S', r = ss'\}$
then $SS'$ is a multiplicative subset of $R$,
\label{products-multiplicative-subsets}
\item if $S$, $S'$ are multiplicative subsets of $R$,
and if $\overline{S}$ denotes the image of $S$ in $(S')^{-1}R$,
then $(SS')^{-1}R = \overline{S}^{-1}((S')^{-1}R)$,
\label{localization-localization}
\item the {\it localization} $S^{-1}M$ of the $R$-module $M$,
\label{localization-module}
\item the functor $M \mapsto S^{-1}M$ preserves injective maps,
surjective maps, and exactness,
\label{localization-exact}
\item if $S$, $S'$ are multiplicative subsets of $R$,
and $M$ and $R$-module, then $(SS')^{-1}M =
S^{-1}((S')^{-1}M)$,
\label{localization-localization-module}
\item if $R$ is a ring, $I$ and ideal of $R$ and $S$ a multiplicative
subset of $R$, then $S^{-1}I$ is an ideal of $S^{-1}R$, and we have
$S^{-1}R/S^{-1}I = \overline{S}^{-1}(R/I)$, where $\overline{S}$
is the image of $S$ in $R/I$,
\label{localize-ideal}
\item if $R$ is a ring, and $S$ a multiplicative
subset of $R$, then any ideal $I'$ of $S^{-1}R$ is
of the form $S^{-1}I$, where one can take $I$ to be
the inverse image of $I'$ in $R$,
\label{ideal-in-localization}
\item if $R$ is a ring, $M$ an $R$-module, and $S$ a multiplicative
subset of $R$, then any submodule $N'$ of $S^{-1}M$ is of the form
$S^{-1}N$ for some submodule $N \subset M$, where
one can take $N$ to be the inverse image of $N'$ in $M$,
\label{submodule-in-localization}
\item if $S = \{1, f, f^2,\ldots\}$ then $R_f = S^{-1}R$, and
$M_f = S^{-1}M$,
\label{localiza-f}
\item if $S = R \setminus \mathfrak p$, then $R_{\mathfrak p} = S^{-1}R$
and $M_{\mathfrak p} = S^{-1}M$,
\label{localize-p}
\item given $R$ and $M_1$, $M_2$ the {\it tensor product} 
$M_1 \otimes_R M_2$,
\item etc.
\end{enumerate}

\section{The spectrum of a ring}
\label{section-spectrum-ring}

\noindent
We arbitrarily decide that the spectrum of a ring as a topological space
is part of the algebra chapter, whereas an affine scheme is part of the
chapter on schemes.

\begin{definition}
\label{definition-spectrum-ring}
Let $R$ be a ring.
\begin{enumerate}
\item The {\it spectrum} of $R$ is the set of prime ideals of $R$.
It is usually denoted $\text{Spec}(R)$.
\item Given a subset $T \subset R$ we let $V(T) \subset \text{Spec}(R)$
be the set of primes containing $T$, i.e., $V(T) = \{ \mathfrak p \in
\text{Spec}(R) \mid \forall f\in T, f\in \mathfrak p\}$.
\item Given an element $f \in R$ we let $D(f) \subset \text{Spec}(R)$
be the set of primes not containing $f$.
\end{enumerate}
\end{definition}

\begin{lemma}
\label{lemma-Zariski-topology}
Let $R$ be a ring.
\begin{enumerate}
\item The spectrum of a ring $R$ is empty if and only if $R$
is the zero ring.
\item Every nonzero ring has a maximal ideal.
\item Every nonzero ring has a minimal prime ideal.
\item Given an ideal $I \subset R$ and a prime ideal
$I \subset \mathfrak p$ there exists a prime 
$I \subset \mathfrak q \subset \mathfrak p$ such
that $\mathfrak q$ is minimal over $I$.
\item If $T \subset R$, and if $(T)$ is the ideal generated by
$T$ in $R$, then $V((T)) = V(T)$.
\item If $I$ is an ideal and $\sqrt{I}$ is its radical,
see basic notion (\ref{radical-ideal}), then $V(I) = V(\sqrt{I})$.
\item Given an ideal $I$ of $R$ we have $\sqrt{I} =
\bigcap_{I \subset \mathfrak p} \mathfrak p$.
\item If $I$ is an ideal then $V(I) = \emptyset$ if and only
if $I$ is the unit ideal.
\item If $I$, $J$ are ideals of $R$ then $V(I) \cup V(J) =
V(I \cap J)$.
\item If $(I_a)_{a\in A}$ is a set of ideals of $R$ then
$\cap_{a\in A} V(I_a) = V(\cup_{a\in A} I_a)$.
\item If $f \in R$, then $D(f) \sqcup V(f) = \text{Spec}(R)$.
\item If $f = u f'$ for some unit $u \in R$, then $D(f) = D(f')$.
\item If $I \subset R$ is an ideal, and $\mathfrak p$ is a prime of
$R$ with $\mathfrak p \not\in V(I)$, then there exists an $f \in R$
such that $\mathfrak p \in D(f)$, and $D(f) \cap V(I) = \emptyset$.
\item If $f,g \in R$, then $D(fg) = D(f) \cap D(g)$.
\end{enumerate}
\end{lemma}

\begin{proof}
FIXME.
\end{proof}

\noindent
The lemma implies that the subsets $V(T)$ from
Definition \ref{definition-spectrum-ring} form the closed
subsets of a topology on $\text{Spec}(R)$. And it also shows that
the sets $D(f)$ are open and form a basis for this
topology.

\begin{definition}
\label{definition-Zariski-topology}
Let $R$ be a ring.
The topology on $\text{Spec}(R)$ whose closed sets are the
sets $V(T)$ is called the {\it Zariski} topology. The open
subsets $D(f)$ are called the {\it standard opens} of $\text{Spec}(R)$.
\end{definition}

\noindent
It should be clear from context whether we consider $\text{Spec}(R)$
just as a set or as a topological space.

\begin{lemma}
\label{lemma-spec-functorial}
Suppose that $\varphi : R \to R'$ is a ring homomorphism.
The induced map
$$
\text{Spec}(\varphi) :
\text{Spec}(R')
\longrightarrow
\text{Spec}(R),\ \ 
\mathfrak p'
\longmapsto
\varphi^{-1}(\mathfrak p')
$$
is continuous for the Zariski toplogies. In fact, for
$f \in R$ we have
$\text{Spec}(\varphi)^{-1}(D(f)) = D(\varphi(f))$.
\end{lemma}

\begin{proof}
It is basic notion (\ref{inverse-image-prime}) that
$\mathfrak p := \varphi^{-1}(\mathfrak p')$
is indeed a prime ideal of $R$. The last assertion
of the lemma follows directly from the definitions,
and implies the first.
\end{proof}

\noindent
If $\varphi' : R' \to R''$ is a second ring homomorphism
then the composition
$$
\text{Spec}(R')
\longrightarrow
\text{Spec}(R')
\longrightarrow
\text{Spec}(R'')
$$
equals $\text{Spec}(\varphi' \circ \varphi)$. In other
words, $\text{Spec}$ is a contravariant functor from the
category of rings to the category of topological spaces.


\begin{lemma}
\label{lemma-spec-localization}
Let $R$ be a ring. Let $S \subset R$ be a multiplicative subset.
The map $R \to S^{-1}R$ induces via the functoriality of $\text{Spec}$
a homeomorphism 
$$
\text{Spec}(S^{-1}R)
\longrightarrow 
\{\mathfrak p \in \text{Spec}(R) \mid S \cap \mathfrak p = \emptyset \}
$$
where the topology on the right hand side is that induced from the
Zariski topology on $\text{Spec}(R)$. The inverse map is given
by $\mathfrak p \mapsto S^{-1}\mathfrak p$.
\end{lemma}

\begin{proof}
Denote the left hand side of the arrow of the lemma by $D$.
Choose a prime $\mathfrak p' \subset R_f$ and let $\mathfrak p$
the inverse image of $\mathfrak p'$ in $R$. Since $\mathfrak p'$
does not contain $1$ we see that $\mathfrak p$ does not contain
any element of $S$. Hence $\mathfrak p \in D$ and we see that
the image is contained in $D$. Let $\mathfrak p \in D$. By assumption
the set $S$ maps injectively into $R/\mathfrak p$, in other
words the image $\overline{S}$ does not contain $0$.
By basic notion (\ref{localization-zero})
$\overline{S}^{-1}(R/\mathfrak p)$ is not the zero ring.
By basic notion (\ref{localize-ideal}) we see
$S^{-1}R / S^{-1}\mathfrak p = \overline{S}^{-1}(R/\mathfrak p)$
is a domain, and hence $S^{-1}\mathfrak p$ is a prime.
The equality of rings also shows that the inverse image of
$S^{-1}\mathfrak p$ in $R$ is equal to $\mathfrak p$,
because $R/\mathfrak p \to \overline{S}^{-1}(R/\mathfrak p)$
is injective by basic notion (\ref{localize-nonzerodivisors}).
This proves that the map $\text{Spec}(S^{-1}R) \to \text{Spec}(R)$
is bijective onto $D$ with inverse as given.
It is continuous by Lemma \ref{lemma-spec-functorial}.
Finally, let $D(g) \subset \text{Spec}(S^{-1}R)$ be a standard
open. Write $g = h/s$ for some $h\in R$ and $s\in S$.
Since $g$ and $h/1$ differ by a unit we have $D(g) = 
D(h/1)$ in $\text{Spec}(S^{-1}R)$.
Hence by Lemma \ref{lemma-spec-functorial} and the bijectivity
above the image of $D(g) = D(h/1)$ is $D \cap D(h)$.
This proves the map is open as well.
\end{proof}

\begin{lemma}
\label{lemma-standard-open}
Let $R$ be a ring. Let $f \in R$.
The map $R \to R_f$ induces via the functoriality of
$\text{Spec}$ a homeomorphism
$$
\text{Spec}(R_f) \longrightarrow D(f) \subset \text{Spec}(R).
$$
The inverse is given by $\mathfrak p \mapsto \mathfrak p \cdot R_f$.
\end{lemma}

\begin{proof}
This is a special case of Lemma \ref{lemma-spec-localization}
above.
\end{proof}

\begin{lemma}
\label{lemma-spec-closed}
Let $R$ be a ring. Let $I \subset R$ be an ideal.
The map $R \to R/I$ induces via the functoriality of
$\text{Spec}$ a homeorphism
$$
\text{Spec}(R/I) \longrightarrow V(I) \subset \text{Spec}(R).
$$
The inverse is given by $\mathfrak p \mapsto \mathfrak p / I$.
\end{lemma}

\begin{proof}
It is immediate that the image is contained in $V(I)$.
On the other hand, if $\mathfrak p \in V(I)$
then $\mathfrak p \supset I$ and we may consider
the ideal $\mathfrak p /I \subset R/I$. Using
basic notion (\ref{isomorphism-theorem}) we see that
$(R/I)/(\mathfrak p/I) = R/\mathfrak p$ is a domain
and hence $\mathfrak p/I$ is a prime ideal. From this
it is immediately clear that the image of $D(f + I)$
is $D(f) \cap V(I)$, and hence the map is a homeomorphism.
\end{proof}

\begin{remark}
\label{remark-fundamental-diagram}
A fundamental commutative diagram associated to
$\varphi : R \to S$,
$\mathfrak q \subset S$ and
$\mathfrak p = \varphi^{-1}(\mathfrak q)$ is
the following
$$
\xymatrix{
\kappa(\mathfrak q) = S_{\mathfrak q}/{\mathfrak q}S_{\mathfrak q}
&
S_{\mathfrak q} \ar[l]
&
S \ar[r] \ar[l]
&
S/\mathfrak q \ar[r]
&
\kappa(\mathfrak q) = \text{f.f.}(S/\mathfrak q)
\\
\kappa(\mathfrak p) \otimes_R S = S_{\mathfrak p}/{\mathfrak p}S_{\mathfrak p} \ar[u]
&
S_{\mathfrak p} \ar[u] \ar[l]
&
S \ar[u] \ar[r] \ar[l]
&
S/\mathfrak pS \ar[u] \ar[r]
&
S \otimes_R \kappa(\mathfrak p) = (R \setminus \mathfrak p)^{-1}S \ar[u]
\\
\kappa(\mathfrak p) = R_{\mathfrak p}/{\mathfrak p}R_{\mathfrak p} \ar[u]
&
R_{\mathfrak p} \ar[u] \ar[l]
&
R \ar[u] \ar[r] \ar[l]
&
R/\mathfrak p \ar[u] \ar[r]
&
\kappa(\mathfrak p) = \text{f.f.}(R/\mathfrak p) \ar[u]
}
$$
In this diagram the arrows on the outer left and outer right columns
are identical. The horizontal maps induce on the associated spectrums
always an homeomorphism onto the image. The lower two rows
of the diagram make sense without assuming $\mathfrak q$ exists.
The lower squares induce fibre squares of topological spaces.
This diagram shows that $\mathfrak p$ is in the image
of the map on Spec if and only if $S \otimes_R \kappa(\mathfrak p)$
is not the zero ring.
\end{remark}

\begin{lemma}
\label{lemma-quasicompact}
Let $R$ be a ring. The space $\text{Spec}(R)$ is quasicompact.
\end{lemma}

\begin{proof}
It suffices to prove that any covering of $\text{Spec}(R)$
by standard opens can be refined by a finite covering.
Thus suppose that $\text{Spec}(R) = \cup D(f_i)$
for a set of elements $f_i$ of $R$. This means that
$\cap V(f_i) = \emptyset$. According to Lemma
\ref{lemma-Zariski-topology} this means that
$V(\{f_i \}) = \emptyset$. According to the
same lemma this means that the ideal generated
by the $f_i$ is the unit ideal of $R$. This means
that we can write $1$ as a {\it finite} sum like so
$1 = \sum_{i \in finite\ list} r_i f_i$.
And then it follows that $\text{Spec}(R) 
= \cup_{i \in finite\ list} D(f_i)$.
\end{proof}

\section{Flat modules and flat ring maps}
\label{section-flat}

\noindent
One often used result is that if $M = \text{colim}_{i\in \mathcal{I}} M_i$
is a colimit of $R$-modules and if $N$ is another then
$$
M \otimes N
=
\text{colim}_{i\in \mathcal{I}} M_i \otimes_R N.
$$
This follows almost immediately from the universal 
property of colimits and the universal property of
the tensor product in terms of bilinear maps.
This property is usually expressed by saying
that {\it $\otimes$ commutes with limits}.

\medskip\noindent
Another often used result is that if $0\to N_1 \to N_2 \to N_3\to 0$
is an exact sequence and if $M$ is any $R$-module, then
$$
M\otimes_R N_1
\to
M\otimes_R N_2
\to
M\otimes_R N_3
\to
0
$$
is still exact. Again this follows almost immediately from
the interpretation of the tensor product in terms of
bilinear maps. Of course this property is usually expressed
by saying that {\it $-\otimes_R M$ is right exact}.

\medskip\noindent
Let $M$ be an $R$-module. Let $x_i$, $i=1,\ldots,n$ be elements
of $M$. Let $f_i \in R$ be elements such that $\sum f_i x_i = 0$
in $M$. We say the elements $f_i$ give a {\it relation}
among the elements $x_i$.

\begin{lemma}
\label{lemma-module-colimit-fp}
Let $R$ be a ring and let $M$ be an $R$-module.
Then $M$ is the colimit of a directed system
$(I, \geq)$, $(M_i, f_{ii'})$ of $R$-modules
with all $M_i$ finitely presented $R$-modules.
\end{lemma}

\begin{proof}
Consider any finite subset $S \subset M$ and any finite
collection of relations $E$ among the elements
of $S$. So each $s \in S$ corresponds to $x_s \in M$ and
each $e \in E$ consists of a vector
of elements $f_{e,s} \in R$ such that $\sum f_{e,s} x_s = 0$.
Let $M_{S,E}$ be the cokernel of the map
$$
R^{\#E}
\longrightarrow
R^{\#S},\ \ 
(g_e)_{e\in E}
\longmapsto
(\sum g_e f_{e,s})_{s\in S}.
$$
There are canonical maps $M_{S,E} \to M$.
If $S \subset S'$ and if the elements of
$E$ correspond, via this map, to relations 
in $E'$, then there is an obvious map
$M_{S,E} \to M_{S', E'}$ commuting with the
maps to $M$. Thus $I$ is the set of pairs 
$(S,E)$ with ordering by inclusion as above.
It is clear that the limit of this directed system is $M$.
\end{proof}

\begin{definition}
\label{definition-flat}
Let $R$ be a ring.
\begin{enumerate}
\item An $R$-module $M$ is called {\it flat} if whenever
$N_1 \to N_2 \to N_3$ is an exact sequence of $R$-modules
the sequence $M\otimes_R N_1 \to M\otimes_R N_1\to M\otimes_R N_1$
is exact as well.
\item An $R$-module $M$ is called {\it faithfully flat} if the
complex of $R$-modules
$N_1 \to N_2 \to N_3$ is exact if and only if
the sequence $M\otimes_R N_1\to M\otimes_R N_1\to M\otimes_R N_1$
is exact.
\item A ring map $R \to S$ is called {\it flat} if
$S$ is flat as an $R$-module.
\item A ring map $R \to S$ is called {\it faithfully flat} if
$S$ is faithfully flat as an $R$-module.
\end{enumerate}
\end{definition}

\begin{lemma}
\label{lemma-flat}
Let $M$ be an $R$-module. The following are equivalent:
\begin{enumerate}
\item $M$ is flat over $R$.
\label{flat}
\item for every injection of $R$-modules $N \subset N'$
the map $N\otimes_R M \to N'\otimes_R M$ is injective.
\label{injective}
\item for every ideal $I \subset R$ the map
$I\otimes_R M \to R\otimes_R M = M$ is injective.
\label{f-ideal}
\item for every finitely generated ideal $I \subset R$
the map $I\otimes_R M \to R\otimes_R M = M$ is injective.
\label{ffg-ideal}
\end{enumerate}
\end{lemma}

\begin{proof}
The implications (\ref{flat}) implies (\ref{injective})
implies (\ref{f-ideal}) implies (\ref{ffg-ideal}) are all
trivial. Thus we prove (\ref{ffg-ideal}) implies (\ref{flat}).
Suppose that $N_1 \to N_2 \to N_3$ is exact.
Let $K_2 = \text{Ker}(N_2 \to N_3)$. 
It is clear that the surjection $N_1 \to K$
induces a surjection $N_1 \otimes_R M \to K_2\otimes_R M$.
Hence it suffices to show $K_2\otimes_R M \to N_2\otimes_R M$
is injective.

\medskip\noindent
Let $x \in \text{Ker}(K_2\otimes_R M \to N_2\otimes_R M)$.
We have to show that $x$ is zero.
Write $x = \sum_{i=1,\ldots,r} k_i \otimes m_i$. By
Lemma \ref{lemma-module-colimit-fp}
we can find a finitely generated module $N$,
a map $N \to N_2$, and elements $n_i \in N$, $i=1,\ldots,r$ such that
(a) $n_i$ maps to $k_i$, (b) the element $y = \sum_i n_i \otimes m_i$
maps to zero in $N \otimes_R M$. Let $K \subset N$
be the submodule generated by the $n_i$. It suffices to show that
$y$ is zero as an element of $K' \otimes_R M$.

\medskip\noindent
We do this by induction on the minimal number of generators of
$N$. If this number is $>1$ then we can find a short exact
sequence
$0 \to N' \to N \to N''\to 0$
such that $N'$ and $N''$ are finitely generated with a smaller
number of generators. By induction the element $y$ maps
to zero in $K'' \otimes_R M$ with $K''$ the image of $K$
in $N''$. And by the right exactness of $\otimes$ we see
that $y$ comes from some element of $K' \otimes_R M$
where $K'$ is the intersection of $K$ with $N'$. Again
by induction we see that $y' = 0$.

\medskip\noindent
The base case of the induction above is when
$N$ is generated by $1$ element. In other words
$N = R/I$, and then $y = \sum g_i \otimes m_i$,
Let $J = (g_1,\ldots,g_r) \subset R$.
By right exactness, we see that $R/I \otimes_R M
= M/IM$. Our assumption is that $y$ is zero
in $R/I \otimes_R M = M/IM$ in other words
$\sum g_im_i \in IM$, in other words
$\sum g_im_i = \sum h_j m'_j$ for suitable
$h_j \in I$. We may replace $I$ by the finitely
generated ideal $(h_j)$ without modifying the assumptions.
In this case we have $K = J+I/I$
$$
K\otimes_R M
=
(J+I)\otimes_R M /I\otimes_R M
=
(J+I)M / IM
$$
the first equality by right exactness
and the second by assumption on $M$.
Thus $y$ is zero in $K\otimes_RM$ as desired.
\end{proof}

\noindent
We say the relation $\sum f_i x_i$
is {\it trivial} if there exist an integer $m \geq 0$,
elements $y_j$, $j=1,\ldots, m$, and elements $g_{ij} \in R$,
$i=1,\ldots,n$, $j=1,\ldots,m$ such that
$$
x_i = \sum\nolimits_j a_{ij} y_j, \forall j,
\text{ and }
0 = \sum\nolimits_i f_ia_{ij}, \forall i.
$$

\begin{lemma}
\label{lemma-flat-eq}
(Equational criterion of flatness.)
A module $M$ over $R$ is flat if and only if
every relation in $M$ is trivial.
\end{lemma}

\begin{proof}
Assume $M$ is flat and let $\sum f_i x_i$ be a relation.
Let $I = (f_1,\ldots,f_n)$, and let $K = \text{ker}(R^n \to I)$.
So we have the short exact sequence
$0\to K \to R^n \to I\to 0$. Then $\sum f_i \otimes x_i$
is an element of $I\otimes_R M$ which maps
to zero in $R\otimes_R M = M$. By flatness
$\sum f_i \otimes x_i$ is zero in $I\otimes_R M$.
Thus there exists an element of $K\otimes_R M$ mapping
to $\sum e_i \otimes m_i \in R^n\otimes_R M$.
Write this element as $\sum k_j \otimes y_j$
and then write the image of $k_j$ in $R^n$ as
$\sum a_{ij} e_i$ to get the result.

\medskip\noindent
Assume every relation is trivial, let $I$
be a finitely generated ideal, and let $x = \sum f_i\otimes x_i$
be an element of $I\otimes_R M$ mapping to zero in $R\otimes_R M = M$.
This just means exactly that $\sum h_i x_i$ is a relation in
$M$. And the fact that it is trivial implies easily that
$x$ is zero, because
$$
x
=
\sum f_i \otimes x_i
=
\sum f_i \otimes (\sum a_{ij}y_j)
=
\sum (\sum f_i a_{ij}) \otimes y_j
=
0
$$
\end{proof}

\begin{lemma}
\label{lemma-characterize-zero-local}
An $R$-module $M$ is zero if and only if $M_{\mathfrak p}$ is
zero for all $\mathfrak p \in \text{Spec}(R)$.
\end{lemma}

\begin{proof}
Suppose $M_{\mathfrak p} = 0$ for all primes. 
Let $m \in M$. Let $I = \{f \in R \mid fm = 0\}$.
It is easy to see that $I$ is an ideal (it is the
annihilator of $m$). The condition means that for
all primes $\mathfrak p$ there exists an $f \in R \setminus
\mathfrak p$ such that $fm =0$. In other words,
we have $V(I) = \emptyset$. According to Lemma 
\ref{lemma-Zariski-topology} $I$ is the unit ideal.
Hence $m$ is zero.
\end{proof}

\begin{lemma}
\label{lemma-easy-ff}
An $R$-module $M$ is faithfully flat if and only if $M$ is flat
and for all maps $\alpha : N \to N'$ we have 
$\alpha = 0$ if and only if $\alpha \otimes \text{id}_M = 0$.
\end{lemma}

\begin{proof}
If $M$ is faithfully flat $0 \to \text{Ker}(\alpha)
\to N \to 0$ is exact if and only if the same holds
after tensoring with $M$. This proves one direction.
For the other, let $N_1 \to N_2 \to N_3$
be a complex, and assume the complex
$N_1 \otimes_R M \to N_2 \otimes_R M \to N_3\otimes_R M$
is exact. Take $x \in \text{Ker}(N_2 \to N_3)$,
and consider the map $\alpha : R\to N_2/\text{Im}(N_1)$,
$r \mapsto rx + \text{Im}(N_1)$. By the exactness
of the complex $-\otimes_R M$ we see that $\alpha \otimes 
\text{id}_M$ is zero. By assumption we get that $\alpha$ is
zero. Hence $x $ is in the image of $N_1 \to N_2$.
\end{proof}

\begin{lemma}
\label{lemma-ff}
Let $M$ be a flat $R$-module.
The following are equivalent:
\begin{enumerate}
\item $M$ is faithfully flat,
\item for all $\mathfrak p \in \text{Spec}(R)$
the tensor product $M\otimes_R \kappa(\mathfrak p)$ is nonzero, and
\item for all maximal ideals $\mathfrak m$ of $R$
the tensor product $M\otimes_R \kappa(\mathfrak m) = M/{\mathfrak m}M$
is nonzero.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume $M$ faithfully flat. Since $R \to \kappa({\mathfrak p})$ is not
zero we deduce that $M \to M \otimes_R \kappa({\mathfrak p})$ is not zero,
see Lemma \ref{lemma-easy-ff}.

\medskip\noindent
Conversely assume that $M$ is flat and that
$M/{\mathfrak m}M$ is never zero.
Suppose that $N_1 \to N_2 \to N_3$ is a complex and
suppose that $N_1 \otimes_R M \to N_2\otimes_R M \to
N_3\otimes_R M$ is exact. Let $H$ be the cohomology of the complex,
so $H = \text{Ker}(N_2 \to N_3)/\text{Im}(N_1 \to N_2)$.
By flatness we see that $H \otimes_R M = 0$. 
Take $x \in H$ and let $I = \{f \in R \mid fx = 0 \}$
be its annihilator. Since $R/I \subset H$ we get
$M/IM \subset H\otimes_R M = 0$ by flatness of $M$.
If $I \not=  R$ we may choose
a maximal ideal $I \subset \mathfrak m \subset R$.
This immediately gives a contradiction.
\end{proof}

\begin{lemma}
\label{lemma-ff-rings}
Let $R \to S$ be a flat ring map.
The following are equivalent:
\begin{enumerate}
\item $R \to S$ is faithfully flat,
\item the induced map on $\text{Spec}$ is surjective, and
\item any closed point $x \in \text{Spec}(R)$ is
in the image of the map $\text{Spec}(S) \to \text{Spec}(R)$.
\end{enumerate}
\end{lemma}

\begin{proof}
This follows quickly from Lemma \ref{lemma-ff}, because we
saw in Remark \ref{remark-fundamental-diagram}
that $\mathfrak p$ is in the image
if and only if the ring $S \otimes_R \kappa(\mathfrak p)$
is nonzero.
\end{proof}

\begin{lemma}
\label{lemma-flat-gd}
Let $R\to S$ be flat. Let $\mathfrak p \subset \mathfrak p'$.
If $\mathfrak p'$ is in the image of $\text{Spec}(S)
\to \text{Spec}(R)$ so is $\mathfrak p$.
\end{lemma}

\begin{proof}
Namely, consider $R_{\mathfrak p'} \to S_{\mathfrak p'}$.
By assumption there is a prime ideal $\mathfrak q  \subset  S_{\mathfrak p'}$
lying over $\mathfrak p' R_{\mathfrak p'}$.
By Lemma \ref{lemma-ff-rings} above this implies it is faithfully
flat. By the same lemma again there is a prime mapping to
$\mathfrak p R_{\mathfrak p'}$. The inverse image of this
prime in $S$ does the job.
\end{proof}

\section{Images and ring maps of finite presentation}
\label{section-images-finite-presentation}

\noindent
In this section we prove some results on the 
topology of maps $\text{Spec}(S) \to \text{Spec}(R)$
induced by ring maps $R \to S$. First we discuss Chevalley's Theorem.
In order to do this we will use the notions of constructible sets,
quasi-compact sets, retrocompact sets, and so on
which are defined in Topology, Section \ref{topology-section-quasi-compact}.

\begin{lemma}
\label{lemma-qc-open}
Let $U \subset \text{Spec}(R)$ be open. The following
are equivalent:
\begin{enumerate}
\item $U$ is retrocompact in $\text{Spec}(R)$,
\item $U$ is quasi-compact, and
\item $U$ is a finite union of standard opens.
\end{enumerate}
\end{lemma}

\begin{proof}
The implication (2)$\Rightarrow$(3) is immediate from the fact that standard
opens form a basis for the topology. Each standard open is
homeomorphic to the spectrum of a ring and hence quasi-compact,
by Lemmas \ref{lemma-quasicompact} and \ref{lemma-standard-open}.
To finish it suffices to show that a finite union
$\cup_{i=1\ldots n} D(f_i)$ is retrocompact in $\text{Spec}(R)$.
In order to do this it suffices to show that 
$(\cup_{i=1\ldots n} D(f_i)) \cap (\cup_{j=1\ldots m} D(g_j))$
is quasi-compact, which is clear because it equals
$\cup_{i,j} D(f_i g_j)$.
\end{proof}

\begin{lemma}
\label{lemma-constructible-is-image}
Let $R$ be a ring and let $T \subset \text{Spec}(R)$
be constructible. Then there exists an $R \to S$ of
finite presentation such that $T$ is the image of
$\text{Spec}(S)$ in $\text{Spec}(R)$.
\end{lemma}

\begin{proof}
Since the spectrum of a finite product of rings 
is the dijoint union of the spectra, we may assume
that $T = (\cup D(f_i)) \cap (\cup D(g_j))^c$.
In fact we may assume that $T = D(f) \cap V(g_1,\ldots,g_m)$.
In this case $T$ is the image of the map
$R \to (R/(g_1,\ldots,g_m))_f$.
\end{proof}

\begin{lemma}
\label{lemma-open-fp}
Let $R$ be a ring.
Let $f$ be an element of $R$.
Let $S = R_f$.
Then the image of a constructible of $\text{Spec}(S)$
is constructible in $\text{Spec}(R)$.
\end{lemma}

\begin{proof}
Follows immediately from Lemma \ref{lemma-qc-open} and the
definitions.
\end{proof}

\begin{lemma}
\label{lemma-closed-fp}
Let $R$ be a ring.
Let $I$ be a finitely generated ideal of $R$.
Let $S = R/I$.
Then the image of a constructible of $\text{Spec}(S)$
is constructible in $\text{Spec}(R)$.
\end{lemma}

\begin{proof}
If $I = (f_1,\ldots,f_m)$, then we see that
$V(I)$ is the complement of $\cup D(f_i)$ and
hence constructible, by Lemma \ref{lemma-qc-open}.
Denote the map $R \to S$ by $f \mapsto \overline{f}$.
We have to show that if $\overline{U}, \overline{V}$
are retrocompact opens of $\text{Spec}(S)$, then the
image of $\overline{U} \cap \overline{V}^c$
in $\text{Spec}(R)$ is constructible.
By Lemma \ref{lemma-qc-open} we may write
$\overline{U} = \cup D(\overline{g_i})$.
Setting ${U} = \cup D({g_i})$ we see $\overline{U}$
has image $U \cap V(I)$ which is constructible in
$\text{Spec}(R)$. Similarly the image of $\overline{V}$ equals
$V \cap V(I)$ for some retrocompact open $V$ of $\text{Spec}(R)$.
Hence the image of $\overline{U} \cap \overline{V}^c$
equals $U \cap V(I) \cap V^c$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-affineline-open}
Let $R$ be a ring. The map $\text{Spec}(R[x]) \to \text{Spec}(R)$
is open, and the image of any standard open is a quasi-compact
open.
\end{lemma}

\begin{proof}
It suffices to show that the image of a standard open
$D(f)$, $f\in R$ is quasi-compact open.
Recall that $\mathfrak p\subset R$ is in the image
if and only if $\kappa(\mathfrak p)[x]_f$ is not the
zero ring. This is exactly the condition that $f$ does not map
to zero in $\kappa(\mathfrak p)[x]$, in other words, that
some coefficient of $f$ is not in $\mathfrak p$.
Hence we see: if $f = a_d x^d + \ldots a_0$, then
the image of $D(f)$ is $D(a_d) \cup \ldots \cup D(a_0)$.
\end{proof}

\begin{lemma}
\label{lemma-affineline-special}
Let $R$ be a ring. Let $f, g \in R[x]$ be polynomials.
Assume the leading coefficient of $g$ is a unit of $R$.
There exists elements $r_i\in R$, $i=1\ldots,n$ such that
the image of $D(f) \cap V(g)$ in $\text{Spec}(R)$ is
$\cup D(r_i)$.
\end{lemma}

\begin{proof}
Write $g = ux^d + a_{d-1}x^{d-1} + \ldots a_0$, where
$d$ is the degree of $g$, and hence $u \in R^*$.
Consider the ring $A = R[x]/(g)$.
It is, as an $R$-module, finite free with basis the images
of $1,x,\ldots,x^{d-1}$. Consider multiplication
by (the image of) $f$ on $A$. This is an $R$-module map.
Hence we can let $P(T) \in R[T]$ be the characteristic polynomial
of this map. Write $P(T) = T^d + r_{d-1} T^{d-1} + \ldots r_0$.
We claim that $r_0, \ldots, r_{d-1}$ have the desired property.
We will use below the property of characteristic polynomials 
that
$$
\mathfrak p \in V(r_0, \ldots, r_{d-1})
\Leftrightarrow
\text{multiplication by }g\text{ nilpotent on }
A\otimes_R \kappa(\mathfrak p).
$$

\medskip\noindent
Suppose $\mathfrak q\in D(f) \cap V(g)$, and let
$\mathfrak p = \mathfrak q \cap R$. Then
$A\otimes_R \kappa(\mathfrak p)$ surjects onto $\kappa(\mathfrak q)$
and $g$ acts as a unit on $\kappa(\mathfrak q)$. 
Thus we conclude $\mathfrak p \not \in  V(r_0, \ldots, r_{d-1})$.

\medskip\noindent
On the other hand, suppose that $r_i \not\in \mathfrak p$ for some
prime $\mathfrak p$ of $R$ and some $0 \leq i \leq d-1$.
Then multiplication by $f$ is not nilpotent on the algebra
$A \otimes_R \kappa(\mathfrak p)$.
Hence there exists a maximal ideal $\overline{\mathfrak q} \subset
A \otimes_R \kappa(\mathfrak p)$ not containing the image of $f$.
The inverse image of $\overline{\mathfrak q}$ in $R[x]$ 
is an element of $D(f) \cap V(g)$ mapping to $\mathfrak p$.
\end{proof}

\begin{theorem}
\label{theorem-chevalley}
Suppose that $R \to S$ is of finite presentation.
The image of a constructible subset of
$\text{Spec}(S)$ in $\text{Spec}(R)$ is constructible.
\end{theorem}

\begin{proof}
Write $S = R[x_1,\ldots,x_n]/(f_1,\ldots,f_m)$.
We may factor $R \to S$ as $R \to R[x_1] \to R[x_1,x_2]
\to \ldots \to R[x_1,\ldots,x_{n-1}] \to S$. Hence 
we may assume that $S = R[x]/(f_1,\ldots,f_m)$.
In this case we factor the map as $R \to R[x] \to S$,
and by Lemma \ref{lemma-closed-fp} we reduce to
the case $S = R[x]$. By Lemma \ref{lemma-qc-open} suffices
to show that if
$T = (\cup_{i=1\ldots n} D(f_i)) \cap V(g_1,\ldots,g_m)$ 
for $f_i , g_j \in R[x]$ then the image in $\text{Spec}(R)$ is
constructible. Since finite unions of constructible sets
are constructible, it suffices to deal with the case $n=1$,
i.e., when $T = D(f) \cap V(g_1,\ldots,g_m)$.

\medskip\noindent
Note that if $c \in R$, then we have $\text{Spec}(R) =
V(c) \sqcup D(c) = \text{Spec}(R/(c)) \sqcup 
\text{Spec}(R_c))$, and correspondingly $\text{Spec}(R[x]) =
V(c) \sqcup D(c) = \text{Spec}(R/(c)[x]) \sqcup 
\text{Spec}(R_c[x]))$. The intersection of $T = D(f) \cap V(g_1,\ldots,g_m)$
with each part still has the same shape, with $f$, $g_i$ replaced
by their images in $R/(c)[x]$, respectively $R_c[x]$.
Note that the image of $T$
in $\text{Spec}(R)$ is the union of the image of
$T \cap V(c)$ and $T \cap D(c)$. Using Lemmas \ref{lemma-open-fp}
and \ref{lemma-closed-fp} it suffices to prove the images of both
parts are constructible in $\text{Spec}(R/(c))$, respectively
$\text{Spec}(R_c)$.

\medskip\noindent
Let us assume we have $T = D(f) \cap V(g_1,\ldots,g_m)$
as above, with $\deg(g_1) \leq \deg(g_2) \leq \ldots \leq \deg(g_m)$.
We are going to use descending induction on $m$, and on the 
degrees of the $g_i$. Let $d = \deg(g_1)$, i.e., $g_1 = c x^{d_1} + l.o.t$
with $c \in R$ not zero. Cutting $R$ up into the pieces
$R/(c)$ and $R_c$ we either lower the degree of $g_1$ (and this
is covered by induction)
or we reduce to the case where $c$ is invertible.
If $c$ is invertible, and $m > 1$, then write
$g_2 = c' x^{d_2} + l.o.t$. In this case consider
$g_2' = g_2 - (c'/c) x^{d_2 - d_1} g_1$. Since the ideals
$(g_1, g_2, \ldots, g_m)$ and $(g_1, g_2', g_3, \ldots, g_m)$
are equal we see that $T = D(f) \cap V(g_1,g_2',g_3\ldots,g_m)$.
But here the degree of $g_2'$ is strictly less than the degree
of $g_2$ and hence this case is covered by induction.

\medskip\noindent
The bases case for the induction above are the cases
(a) $T = D(f) \cap V(g)$ where the leading coefficient
of $g$ is invertible, and (b) $T = D(f)$. These two cases
are dealt with in Lemmas \ref{lemma-affineline-special}
and \ref{lemma-affineline-open}.
\end{proof}


\begin{proposition}
\label{proposition-fppf-open}
Let $R \to S$ be flat and of finite presentation.
Then $\text{Spec}(R) \to \text{Spec}(S)$ is open.
\end{proposition}

\begin{proof}
It suffices to prove that the image of a standard open $D(f)$ is open.
After replacing $S$ by $S_f$ we see it suffices to prove the image is
open. Let $T \subset \text{Spec}(R)$ be the complement of the image.
Let $\mathfrak p$ be in the image (hence $\mathfrak p \not \in T$),
and in the closure of $T$. According to
Lemma \ref{lemma-constructible-is-image} we may
write $T$ as the image of $\text{Spec}(S') \to \text{Spec}(R)$
for some finitely presented $R$-algebra $S'$. The fact that $\mathfrak p$
is in the closure of $T$ means that for all $f \in R \setminus \mathfrak p$
the ring $S'_f$ is not zero. By Lemma \ref{lemma-localize-colimit}
we see that $S'_{\mathfrak p} = S' \otimes_R R_{\mathfrak p}$
is not zero. (Because you can test whether a ring is zero
by testing whether $1=0$ which does not happen in any of the
$S'_f$ above.) This implies that there is an point of
$\text{Spec}(R_{\mathfrak p})$ which is not in the image
of $\text{Spec}(S_{\mathfrak p}) \to \text{Spec}(R_{\mathfrak p})$
and this contradicts Lemma \ref{lemma-flat-gd}.
\end{proof}

\section{Differentials}
\label{section-differentials}

\begin{definition}
\label{definition-derivation}
Let $\varphi : R \to S$ be a ring map and let $M$ be an $S$-module.
A {\it $R$-derivation} into $M$ is a map $D : S \to M$
which is additive, annihilates elements of $\varphi(R)$,
and satisfies the {\it Leibniz rule}: 
$D(ab) = aD(b) + D(a)b$.
\end{definition}

\noindent
Note that $D(ra) = rD(a)$ if $r\in R$ and $a\in S$.
The set of all $R$-derivations forms an
$S$-module: Given two $R$-derivations $D, D'$
the sum $D+D' : S \to M$, $a \mapsto D(a)+D'(a)$
is an $R$-derivation, and given an $R$-derivation $D$
and an element $c\in S$ the scalar multiple $cD : S \to M$,
$a \mapsto cD(a)$ is an $R$-derivation. We denote this
$S$-module
$$
\text{Der}_R(S, M).
$$
Also, if $\alpha : M \to N$ is an $S$-module map, then the
composition $\alpha \circ D$ is an $R$-derivation into
$N$. In this way the assignment $M \mapsto \text{Der}_R(S, M)$
is a covariant functor.

\medskip\noindent
Let $\Omega_{S/R}$ be the $S$-module which has the
following presentation:
$$
\begin{matrix}
\bigoplus_{(a,b)\in S^2} S[(a,b)] \oplus \bigoplus_{r\in R} S[r]
&
\to
&
\bigoplus_{a\in S} S [a]
&
\to
&
\Omega_{S/R}
&
\to
&
0
\\
[(a,b)]
&
\mapsto
&
a[b] + b[a]
&
&
&
&
\\
[r]
&
\mapsto
&
[\varphi(r)]
&
&
&
&
\end{matrix}
$$
Here the notation is that $[\xi]$ represents the basis
element corresponoding to the element $\xi$ of the index set
of the direct sum. There is a map $\text{d} : S \to \Omega_{S/R}$
which maps $a$ to the class $\text{d}a$ of $[a]$ in the cokernel.
It is obvious that this is an $R$-derivation.
The pair $(\Omega_{S/R}, \text{d})$ is called the module
of K\"ahler diffentials of $S$ over $R$.

\begin{lemma}
\label{lemma-universal-omega}
The module of differentials of $S$ over $R$ has the following
universal property. The map
$$
\text{Hom}_S(\Omega_{S/R}, M)
\longrightarrow
\text{Der}_R(S, M),\ \ 
\alpha 
\longmapsto
\alpha \circ \text{d}
$$
is an isomorphism of functors.
\end{lemma}

\begin{proof}
FIXME.
\end{proof}

\noindent
Suppose that
$$
\xymatrix{
S \ar[r]^\varphi
&
S'
\\
R \ar[r]^\psi \ar[u]^\alpha
&
R' \ar[u]^\beta
}
$$
is a commutative diagram of rings. In this case there is a
natural map of modules of differentials fitting into the
commutative diagram
$$
\begin{matrix}
\Omega_{S/R}
&
\longrightarrow
&
\Omega_{S'/R'}
\\
\uparrow
&
&
\uparrow
\\
S
&
\longrightarrow
&
S'
\end{matrix}
$$
To construct the map just use the obvious map
between the presentations for $\Omega_{S/R}$ and $\Omega_{S'/R'}$.
Namely,
$$
\xymatrix{
\bigoplus_{(a',b')\in (S')^2} S'[(a',b')]
\oplus
\bigoplus_{r'\in R'} S'[r'] \ar[r]
&
\bigoplus_{a'\in S'} S' [a'] \ar[r]
&
\Omega_{S'/R'} \ar[r]
&
0
\\
\bigoplus_{(a,b)\in (S)^2} S[(a,b)]
\oplus
\bigoplus_{r\in R} S[r] \ar[r]
\ar[u]^{[(a,b)] \mapsto [(\varphi(a),\varphi(b)]}_{[r]\mapsto [\psi(r)]}
&
\bigoplus_{a\in S} S[a] \ar[r] \ar[u]^{[a] \mapsto [\varphi(a)]}
&
\Omega_{S'/R'} \ar[r] \ar[u]
&
0
}
$$

\begin{lemma}
\label{lemma-differential-surjective}
Suppose that $S \to S'$ is surjective with kernel $I \subset S$.
Then $\Omega_{S/R} \to \Omega_{S'/R'}$ is surjective with
kernel generated as an $S$-module by the elements 
\begin{enumerate}
\item $i\eta$ with $i\in I$ and $\eta \in \Omega_{S/R}$,
\item $\text{d}i$, $i \in I$, and
\item the elements $\text{d}f$, where $f \in S$ is
such that $\varphi(f) \in \beta(R')$.
\end{enumerate}
\end{lemma}

\begin{proof}
Consider the map of presentations above. Clearly the middle vertical
map of free modules is surjective. Thus the map is surjective.
An easy diagram chase completes the proof.
\end{proof}

\begin{lemma}
\label{lemma-differential-seq}
Suppose that $S \to S'$ is surjective with kernel $I \subset S$,
and assume that $R' = R$.
Then there is a canonical exact sequence of $S'$-modules
$$
I/I^2 
\longrightarrow
\Omega_{S/R}\otimes_S S'
\longrightarrow
\Omega_{S'/R}
\longrightarrow
0
$$
The rightmost map is characterized by the rule that
$f \in I$ maps to $\text{d}f \otimes 1$.
\end{lemma}

\begin{proof}
Note that the middle term can also be written as 
$\Omega_{S/R}/I\Omega_{S/R}$. For $f \in I$ denote
$\overline{f}$ the image of $f$ in $I/I^2$.
To show that the map $\overline{f} \mapsto \text{d}f \otimes 1$
is well defined we just have to check that
$\text{d} f_1f_2 \otimes 1 = 0$ if $f_1, f_2 \in I$. 
And this is clear from the Leibniz rule 
$\text{d} f_1f_2 \otimes 1
=
(f_1 \text{d}f_2 + f_2 \text{d} f_1 )\otimes 1
=
\text{d}f_2 \otimes f_1 + \text{d}f_2 \otimes f_1
=
0$. It is also $S' = S/I$-linear because of the $S/I$-module
structure on $I/I^2$ is defined through $S$-multiplication 
combined with the Leibniz rule.

\medskip\noindent
The exactness is now a direct consequence of
Lemma \ref{lemma-differential-surjective}
which describes the kernel of the surjective map.
\end{proof}

\begin{lemma}
\label{lemma-differentials-base-change}
Suppose that we have ring maps $R \to R'$ and $R \to S'$.
Set $S' = S\otimes_R R'$. Then the canonical map defined above
induces an isomorphism $\Omega_{S/R} \otimes_R R' = \Omega_{S'/R'}$.
\end{lemma}

\begin{proof}
Let $\text{d}' : S' = S\otimes_R R' \to \Omega_{S/R} \otimes_R R'$ denote the
map $\text{d}'( \sum a_i \otimes x_i ) = \text{d}(a_i) \otimes x_i$.
It exists because the map $S \times R' \to \Omega_{S/R} \otimes_R R'$,
$(a,x)\mapsto \text{d}a\otimes_R x$ is $R$-bilinear.
This is an $R'$-derivation, as can be verified by a simple computation.
We will show that $(\Omega_{S/R} \otimes_R R', \text{d}')$ satisfies
the universal property. Let $D : S' \to M'$ be an $R'$ derivation
into an $S'$-module. The composition $S \to S' \to M'$ is an $R$-derivation,
hence we get an $S$-linear map $\varphi_D : \Omega_{S/R} \to M'$. We may
tensor this with $R'$ and get the map $\varphi'_D : 
\Omega_{S/R} \otimes_R R' \to M'$, $\varphi'_D(\eta \otimes x) =
x\varphi_D(\eta)$. It is clear that $D = \varphi'_D \circ \text{d}'$.
\end{proof}

\begin{lemma}
\label{lemma-differentials-polynomial-ring}
If $S = R[x_1,\ldots,x_n]$, then 
$\Omega_{S/R}$ is finite free with
basis $\text{d}x_1,\ldots, \text{d}x_n$.
\end{lemma}

\begin{proof}
We first show that $\text{d}x_1,\ldots, \text{d}x_n$
generate $\Omega_{S/R}$ as an $S$-module. To prove this
we show that $\text{d}g$ can be expressed as a 
sum $\sum g_i \text{d}x_i$ for any $g \in R[x_1,\ldots,x_n]$.
We do this by induction on the (total) degree of $g$.
It is clear if the degree of $g$ is $0$, because then
$\text{d}g = 0$. If the degree of $g$ is $>0$, then
we may write $g$ as $c + \sum g_i x_i$ with $c\in R$
and $\deg(g_i) < \deg(g)$. By the Leibnize rule we have
$\text{d}g = \sum g_i \text{d} x_i + \sum x_i \text{d}g_i$,
and hence we win by induction.

\medskip\noindent
Consider the $R$-derivation $\partial / \partial x_i :
R[x_1,\ldots,x_n] \to R[x_1,\ldots,x_n]$. (We leave it to
the reader to define this; the defining property
being that $\partial / \partial x_i (x_j) = \delta_{ij}$.)
By the universal property this corresponds to an $S$-module map $l_i : 
\Omega_{S/R} \to R[x_1,\ldots,x_n]$ which maps $\text{d}x_i$
to $1$ and $\text{d}x_j$ to $0$ for $j \not= i$. 
Thus it is clear that there are no $S$-linear relations
among the elements $\text{d}x_1,\ldots, \text{d}x_n$.
\end{proof}

\begin{lemma}
\label{lemma-differentials-finitely-presented}
Suppose $R \to S$ is of finite presentation.
Then $\Omega_{S/R}$ is a finitely presented
$S$-module.
\end{lemma}

\begin{proof}
Write $S = R[x_1,\ldots,x_n]/(f_1, \ldots, f_m)$. 
Write $I = (f_1, \ldots, f_m)$. According
to Lemma \ref{lemma-differential-seq} there is an exact sequence
of $S$-modules
$$
I/I^2
\to
\Omega_{R[x_1,\ldots,x_n]/R}\otimes_{R[x_1,\ldots,x_n]} S
\to 
\Omega_{S/R}
\to
0
$$
The result follows from the fact that $I/I^2$ is a finite 
$S$-module (generated by the images of the $f_i$), and that
the middle term is finite free by
Lemma \ref{lemma-differentials-polynomial-ring}.
\end{proof}

\begin{lemma}
\label{lemma-differentials-finitely-generated}
Suppose $R \to S$ is of finite type.
Then $\Omega_{S/R}$ is finitely generated
$S$-module.
\end{lemma}

\begin{proof}
This is very similar to, but easier than the proof
of Lemma \ref{lemma-differentials-finitely-presented}.
\end{proof}

\noindent
Suppose that $R \to S$ is of finite type.
We say that a {\it presentation} of $S$ over $R$ is
given by the choice of an integer $n \geq 0$, and
a surjection $\alpha : R[x_1,\ldots,x_n] \to S$
of $R$-algebras. We will usually just indicate
this by saying: ``Let $R[x_1,\ldots,x_n] \to S$ be a presentation of
$S/R$'', or ``Let $0\to I \to R[x_1,\ldots,x_n] \to S \to 0$
be a presentation of $S/R$'' if we want to indicate that $I$
is the kernel of the presentation.

\medskip\noindent
Note that for every presentation $\alpha$ we obtain a two term
complex of $S$-modules
$$
NL(\alpha) :
I/I^2 \longrightarrow \Omega_{R[x_1,\ldots,x_n]/R}\otimes S.
$$
The cokernel of this complex is canonically $\Omega_{S/R}$,
see Lemma \ref{lemma-differential-seq}. We call the complex
$NL(\alpha)$
the {\it naive cotangent complex}\footnote{This is better know as the {\it Netherlander complex} in some localities.} associated to the
presentation $\alpha : R[x_1,\ldots,x_n] \to S$ of $S/R$. We will
sometimes use the notation
$I/I^2 \to \bigoplus_{i=1,\ldots,n} S\text{d}x_i$
to denote this complex.

\medskip\noindent
A {\it morphism of presentations of $S/R$} from the presentation
$\alpha : R[x_1,\ldots,x_n] \to S$ to the presentation
$\beta : R[y_1,\ldots,y_m] \to S$ is defined to be a
map $\varphi : R[x_1,\ldots,x_n] \to R[y_1,\ldots,y_m]$
such that $\alpha = \beta \circ \varphi$. Note that
in this case $\varphi(I) \subset J$, where $I = \text{ker}(\alpha)$
and $J = \text{ker}(\beta)$. Thus $\varphi$ induces a map
of $S$-modules $I/I^2 \to J/J^2$ and by functoriality of
differentials also a $S$-module map
$\Omega_{R[x_1,\ldots,x_n]/R}\otimes S
\to \Omega_{R[y_1,\ldots,y_m]/R}\otimes S$.
These maps are compatible and we obtain a map
of naive cotangent complexes
$$
NL(\alpha) \longrightarrow NL(\beta).
$$
We leave it to the reader to see that if $\psi$ is a morphism
of presentations from $\beta$ to $\gamma$, then $\psi \circ \varphi$
is a morphism from $\alpha$ to $\gamma$ and furthermore 
the composition $NL(\alpha) \to NL(\beta) \to NL(\gamma)$
is the map associated to $\psi \circ \varphi$.

\begin{lemma}
\label{lemma-NL-homotopy}
Let $S$ be a finite type $R$-algebra.
Let $\alpha : R[x_1,\ldots,x_n] \to S$, and
$\beta : R[y_1,\ldots,y_m] \to S$ be presentations.
\begin{enumerate}
\item For any map $\varphi$ of presentations from
$\alpha$ to $\beta$ the induced map $NL(\alpha) \to NL(\beta)$
is a quasi-isomorphism.
\item For any pair of maps $\varphi, \varphi'$ the induced maps
$NL(\alpha) \to NL(\beta)$ are homotopic.
\end{enumerate}
See the proof of the lemma for a simple explanation
of the assertions.
\end{lemma}

\begin{proof}
In the simple case of complexes with two terms a quasi-isomoprhism
is just a map that induces an isomorphism on both the cokernel
and the kernel of the maps between the terms. In this case the
fact that $\varphi$ induces an isomorphism on cokernels is by
the choice of $NL(\alpha)$ having cokernel equal to $\Omega_{S/R}$.

\medskip\noindent
Note that the first assertion of the lemma follows from the second.
This is so because we may always choose a morphism of presentations
$\varphi'$ from $\beta$ to $\alpha$. The compositions
$\varphi' \circ \varphi$ and $\varphi \circ \varphi'$
will by (2) induce self maps of $NL(\alpha)$ and $NL(\beta)$
which are homotopic to the identity and hence quasi-isomorphism
(see below).
Hence both compositions $NL(\alpha) \to NL(\beta) \to NL(\alpha)$
and $NL(\beta) \to NL(\alpha) \to NL(\beta)$ are quasi-isomoprhisms
(inducing the indentity on cohomology) and hence so are the maps induced
by $\varphi$ and $\varphi'$.

\medskip\noindent
For the second assertion, let $\varphi$ and $\varphi'$ as stated.
Let $I = \text{Ker}(\alpha)$ and $J = \text{Ker}(\beta)$.
We have to construct the diagonal map in the diagram
$$
\xymatrix{
I/I^2 \ar[r]^{\text{d}} \ar@<1ex>[d] \ar@<-1ex>[d]
&
\bigoplus S\text{d}x_i \ar@<1ex>[d] \ar@<-1ex>[d] \ar[ld]_h
\\
J/J^2 \ar[r]^{\text{d}}
&
\bigoplus S\text{d}y_j
}
$$
where the vertical maps are induced by $\varphi$, $\varphi'$.
The condition is that $\text{d} \circ h + h \circ \text{d}$ should be
the difference of the vertical arrows. It is immediate in this
very simple case of complexes with two terms that this implies 
the vertical maps induce the same maps on kernel and cokernel
of the horizontal maps.

\medskip\noindent
Write $\varphi(x_i) - \varphi'(x_i) = h_i$ for some
$h_i \in R[y_j]$. Of course $h_i \in J$. For all $i$ we have
$\varphi(\text{d}x_i) = \text{d}\varphi(x_i)
=\text{d}(\varphi'(x_i) + h_i) =
\text{d}(\varphi'(x_i)) + \text{d}h_i$. On the other hand,
for every $f = f(x_1,\ldots,x_n) \in I$ we have $\varphi(f) = 
f(\varphi(x_1),\ldots, \varphi(x_n)) =
f(\varphi'(x_1) + h_1,\ldots, \varphi'(x_n) + h_n) =
f(\varphi'(x_1),\ldots, \varphi'(x_n)) + 
\sum_i h_i \partial f/\partial x_i + $ terms in 
$J^2$. Hence the map $h : \bigoplus S\text{d}x_i \to J/J^2$,
$x_i \to h_i$ gives the desired homoropy.
\end{proof}

\section{Hilbert Nullstellensatz}
\label{section-nullstellensatz}

\noindent
In this section we give a quick and dirty proof
of the Hilbert Nullstellensatz which uses some
simple field theory.

\begin{lemma}
\label{lemma-tensor-fields}
Suppose that $k \subset k_1$ and $k\subset k_2$ are
field extensions. Then there exists an surjection
$k_1\otimes_k k_2 \to k_3$ onto a field $k_3$ such
that $\text{trdeg}(k_3/k_1) = \text{trdeg}(k_2/k)$
and  $\text{trdeg}(k_2/k_1) = \text{trdeg}(k_3/k)$
\end{lemma}

\begin{proof}
Choose transcendence bases $t_i$ for $k_1/k$ and
$s_j$ for $k_2/k$. Let $\Omega$ be any algebraic closure
of the field $k(\{t_i\}\cup \{s_j\})$. By construction
there are $k$-algebra maps $k_1 \to \Omega$ and
$k_2 \to \Omega$. Let $k_3$ be the field generated
by their images.
\end{proof}

\begin{lemma}
\label{lemma-dimension}
Suppose that $k$ is an uncountable algebraically closed field,
and suppose that $V$ is a nonzero vector space of countable dimension
over $k$. For any linear operator $T : V \to V$ there exists
some $\lambda \in k$ such that $T - \lambda$ is not invertible.
\end{lemma}

\begin{proof}
If not then $V$ inherits the structure of a vector space over
the field $k(T)$. But the dimension of $k(T)$ over $k$ is
uncountable due to the fact that the elements $\frak{1}{T - \lambda}$
are linearly independent.
\end{proof}

\begin{theorem}
\label{theorem-nulstellensatz}
Let $k$ be a field and let $\mathfrak m \subset 
k[x_1,\ldots,x_n]$ be a maximal ideal.
The field extension $k \subset \kappa(\mathfrak m)$
is finite. The same is true for any maximal ideal in
any finite type $k$-algebra.
\end{theorem}

\begin{proof}
Of course it suffices to prove the result for $\mathfrak m \subset 
k[x_1,\ldots,x_n]$, because any finite type $k$-algebra is a
quotient of one of these. 
If we show that $k \subset \kappa(\mathfrak m)$
is algebraic then the result follows since it is
finitely generated as a $k$-algebra.

\medskip\noindent
First assume that $k$ is uncountable and algebraically closed.
To arrive at a contradiction pick
$T \in \kappa(\mathfrak m)$ transcendental over $k$.
Note that the $k$-linear map $T : \kappa(\mathfrak m)
\to \kappa(\mathfrak m)$ has the property that
$T - \lambda$ is invertible for all $\lambda \in k$.
Also, $\kappa(\mathfrak m)$ has countable dimension
over $k$ since it is a quotient of the vector space
$k[x_1,\ldots,x_m]$ over $k$.
This is impossible by Lemma \ref{lemma-dimension}.

\medskip\noindent
In the general case, choose an uncountable algebraically closed
field extension $k \subset k_1$. Choose a quotient
$k_1\otimes_k \kappa(\mathfrak m) \to \kappa$ as in
Lemma \ref{lemma-tensor-fields}. Since the field
$\kappa$ is a quotient of $k_1[x_1,\ldots,x_n]$ via
$$
k_1[x_1,\ldots,x_n]
=
k_1 \otimes_k k[x_1,\ldots,x_n]
\to 
k_1\otimes_k \kappa(\mathfrak m)
\to
\kappa
$$
we see that we may apply the previous case to conclude the
extension $k_1 \subset \kappa$ is algebraic. By our choice
of $\kappa$ we win.
\end{proof}

\section{Dimension}
\label{section-dimension}

\begin{definition}
\label{definition-Krull}
The {\it Krull dimension} of the ring $R$ is the 
Krull dimension of the topological space $\text{Spec}(R)$,
see Topology, \ref{topology-definition-Krull}.
In other words it is the supremum of the integers $n\geq 0$
such that there exists a chain of prime ideals of length $n$:
$$
\mathfrak p_0
\subset 
\mathfrak p_1
\subset
\ldots
\subset
\mathfrak p_n,\ \ 
\mathfrak p_i \not= \mathfrak p_{i+1}.
$$
\end{definition}

\begin{definition}
\label{definition-height}
The {\it height} of a prime ideal $\mathfrak p$ of
a ring $R$ is the dimension of the local ring $R_{\mathfrak p}$.
\end{definition}

\begin{lemma}
\label{lemma-height-1}
Let $R$ be a local ring. Let $x$ be an element 
in its maximal ideal $\mathfrak m$ such that
$\sqrt{(x)} = \mathfrak m$. Then the dimension
of $R$ is $1$ or $0$.
\end{lemma}

\begin{proof}
We have the decomposition $\text{Spec}(R)
= D(x) \sqcup V(x)$. And $V(x) = \{\mathfrak m\}$.
On the other hand, every nonunit $y \in R$ is in
$\mathfrak m$ and hence $y^n = rx$ for some $n \geq 0$ and
$r \in R$ and hence $y$ is invertible in $R_x$. Thus either
$R_x$ is a field or zero. Thus either $\text{Spec}(R)$
has one element or two. In the second case the dimension
is $1$ in the first the dimension is $0$.
\end{proof}

\begin{lemma}
\label{lemma-minimal-over-1}
Let $R$ be a ring. Let $x\in R$, $\mathfrak p, \mathfrak q\in \text{Spec}(R)$.
Suppose that $\mathfrak p \subset (\mathfrak p, x) \subset
\mathfrak q$ and $\mathfrak q$ minimal over $(\mathfrak p, x)$.
Then there is no prime strictly between $\mathfrak p$ and $\mathfrak q$.
\end{lemma}

\begin{proof}
Since we are considering only primes containing $\mathfrak p$
and contained in $\mathfrak q$, we may consider the
local domain $R_{\mathfrak q}/\mathfrak pR_{\mathfrak q}$.
Thus we may assume


\end{proof}


\begin{lemma}
\label{lemma-one-equation}
Suppose that $R$ is a local ring and $x\in \mathfrak m$ an
element of its maximal ideal. Then $\dim R <= \dim R/(x) + 1$.
\end{lemma}

\begin{proof}
Let $\mathfrak p_0 \subset \mathfrak p_1 \subset \ldots \subset \mathfrak p_n$
be a chain of length $n$ in $R$. We may as well assume that $\mathfrak p_n
= \mathfrak m$, so $x\in \mathfrak p_n$. Let $\mathfrak q_n = \mathfrak p_n$.
Let $(\mathfrak p_{n-1}, x) \subset \mathfrak q_{n-1} \subset \mathfrak q_n$,
such that $\mathfrak q_{n-1}$ is a minimal prime over $(\mathfrak p_{n-1}, x)$.
Continue choosing $(\mathfrak p_{i-1}, x) \subset \mathfrak q_{i-1}
\subset \mathfrak q_i$, such that $\mathfrak q_{i-1}$ is a minimal prime
over $(\mathfrak p_{i-1}, x)$. Now we have
$$
\begin{matrix}
\mathfrak p_0
&
\subset 
&
\mathfrak p_1
&
\subset
&
\ldots
&
\subset
&
\mathfrak p_n
\\
\cap
&
&
\cap
&
&
&
&
\cap
\\
\mathfrak q_0
&
\subset 
&
\mathfrak q_1
&
\subset
&
\ldots
&
\subset
&
\mathfrak q_n
\end{matrix}
$$

\end{proof}

















\section{Smooth ring maps}
\label{section-smooth}

\begin{definition}
\label{definition-smooth}
A ring map $R \to S$ is {\it smooth} if it is of finite presentation
and 
\end{definition}

\section{Miscellany}
\label{section-miscellany}

\begin{lemma}
\label{lemma-localize-colimit}
Let $M$ be an $R$-module, and let $S \subset R$ be
a multiplicative subset. Then $S^{-1}M = M\otimes_R S^{-1}R$
is the directed colimit of the modules $M_f$, $f\in S$ with
transition maps $M_f \to M_{f'}, m/f^n \mapsto (f'')^n m/(f')^n$
whenever $f =f' f''$ with $f,f',f''\in S$.
\end{lemma}

\begin{proof}
FIXME.
\end{proof}

\input{chapters}

\bibliography{my}
\bibliographystyle{alpha}

\end{document}
