\input{preamble}

% OK, start here.
%
\begin{document}

\title{Commutative Algebra}

%\begin{abstract}
%\end{abstract}

\maketitle

\tableofcontents





\section{Introduction}
\label{section-introduction}

\noindent
Basic commutative algebra will be explained in this document.
A reference is \cite{MatCA}.






\section{Conventions}
\label{section-conventions}

\noindent
A ring is commutative with $1$. The zero ring is a ring. In fact it is
the only ring that does not have a prime ideal. The Kronecker
symbol $\delta_{ij}$ will be used.






\section{Basic notions}
\label{section-rings-basic}

\noindent
The following notions are considered basic and will not be defined,
and or proved. This does not mean they are all necessarily easy or 
well known.

\begin{enumerate}
\item $R$ is a {\it ring},
\label{ring}
\item $x\in R$ is {\it nilpotent},
\label{ring-element-nilpotent}
\item $x\in R$ is a {\it zero-divisor},
\label{ring-element-zerodivisor}
\item $x\in R$ is a {\it unit},
\label{ring-element-unit}
\item $e \in R$ is an {\it idempotent},
\label{ring-element-idempotent}
\item an idempotent $e \in R$ is called {\it trivial}
if $e = 1$ or $e = 0$,
\label{idempotent-trivial}
\item $\varphi : R_1 \to R_2$ is a {\it ring homomorphism},
\label{ring-homomorphism}
\item $\varphi : R_1 \to R_2$ is {\it of finite presentation}, or
{\it $R_2$ is a finitely presented $R_1$-algebra},
see Defintion \ref{definition-essentially-finite-p-t},
\label{ring-homomorphism-finite-presentation}
\item $\varphi : R_1 \to R_2$ is {\it of finite type}, or
{\it $R_2$ is a finitely type $R_1$-algebra},
see Definition \ref{definition-essentially-finite-p-t},
\label{ring-homomorphism-finite-type}
\item $\varphi : R_1 \to R_2$ is {\it finite}, or
{\it $R_2$ is a finite $R_1$-algebra},
\label{ring-homomorphism-finite}
\item $R$ is a {\it (integral) domain},
\label{ring-domain}
\item $R$ is {\it reduced},
\label{ring-reduced}
\item $R$ is {\it Noetherian},
\label{ring-Noetherian}
\item $R$ is a {\it principal ideal domain} or a {\it PID},
\label{ring-PID}
\item $R$ is a {\it Euclidean domain},
\label{ring-Euclidean}
\item $R$ is a {\it unique factorization domain} or a {\it UFD},
\label{ring-UFD}
\item $R$ is a {\it discrete valuation ring} or a {\it dvr},
\label{ring-dvr}
\item $K$ is a {\it field},
\label{field}
\item $K \subset L$ is a {\it field extension},
\label{field-extension}
\item $K \subset L$ is an {\it algebraic field extension},
\label{field-extension-algebraic}
\item $\{t_i\}_{i\in I}$ is a {\it transcendence basis} for $L$ over $K$,
\label{transcendence-basis}
\item the {\it transcendence degree} $\text{trdeg}(L/K)$ of $L$
over $K$,
\label{transcendence-degree}
\item the field $k$ is {\it algebraically closed},
\label{algebraically-closed}
\item if $K \subset L$ is algebraic, and $K \to k$ a field map,
then there exists a map $L \to k$ extending the map on $K$,
\label{extend-into-algebraically-closed}
\item $I \subset R$ is an {\it ideal},
\label{ideal}
\item $I \subset R$ is {\it radical},
\label{ideal-radical}
\item if $I$ is an ideal then we have its {\it radical} $\sqrt{I}$,
\label{radical-ideal}
\item $I \subset R$ is {\it nilpotent} which means that $I^n = 0$ for
some $n \in \mathbf{N}$,
\label{ideal-nilpotent}
\item $\mathfrak p \subset R$ is a {\it prime ideal},
\label{prime-ideal}
\item if $\mathfrak p \subset R$ is prime and if $I, J \subset R$
are ideal, and if $IJ\subset \mathfrak p$, then
$I \subset \mathfrak p$ or $J \subset \mathfrak p$.
\label{prime-product-ideals}
\item $\mathfrak m \subset R$ is a {\it maximal ideal},
\label{maximal-ideal}
\item any nonzero ring has a maximal ideal,
\label{exists-maximal-ideal}
\item the {\it Jacobson radical} of $R$ is $\text{rad}(R) =
\cap_{\mathfrak m \subset R} \mathfrak m$ the intersection
of all the maximal ideals of $R$,
\label{jacobson-radical}
\item the ideal $(T)$ {\it generated} by a subset $T \subset R$,
\label{ideal-generated-by}
\item the {\it quotient ring} $R/I$,
\label{quotient-ring}
\item an ideal $I$ in the ring $R$ is prime if and only if $R/I$
is a domain,
\label{characterize-prime-ideal}
\item an ideal $I$ in the ring $R$ is maximal if and only if the
ring $R/I$ is a field,
\label{characterize-maximal-ideal}
\item if $\varphi : R_1 \to R_2$ is a ring homomorphism, and if
$I \subset R_2$ is an ideal, then $\varphi^{-1}(I)$ is an
ideal of $R_1$,
\label{inverse-image-ideal}
\item if $\varphi : R_1 \to R_2$ is a ring homomorphism, and if
$I \subset R_1$ is an ideal, then $\varphi(I) \cdot R_2$ (sometimes
denoted $I \cdot R_2$, or $IR_2$) is the ideal of $R_2$ generated
by $\varphi(I)$,
\label{image-ideal}
\item if $\varphi : R_1 \to R_2$ is a ring homomorphism, and if
$\mathfrak p \subset R_2$ is a prime ideal, then
$\varphi^{-1}(\mathfrak p)$ is a prime ideal of $R_1$,
\label{inverse-image-prime}
\item $M$ is an {\it $R$-module},
\label{module}
\item $N \subset M$ is an {\it $R$-submodule},
\label{submodule}
\item $M$ is an {\it Noetherian $R$-module},
\label{Noetherian-module}
\item $M$ is a {\it finite $R$-module},
\label{finite-module}
\item $M$ is a {\it finitely generated $R$-module},
\label{finitely-generated-module}
\item $M$ is a {\it finitely presented $R$-module},
\label{finitely-presented-module}
\item $M$ is a {\it free $R$-module},
\label{free-module}
\item if $N \subset M \subset L$ are $R$-modules,
then $L/M = (L/N)/(M/N)$,
\label{isomorphism-theorem}
\item $S$ is a {\it multiplicative subset of $R$},
\label{multiplicative-subset}
\item the {\it localization} $R \to S^{-1}R$ of $R$,
\label{localization-ring}
\item if $R$ is a ring and $S$ is a multiplicative subset
of $R$ then $S^{-1}R$ is the zero ring if and only if $S$ contains
$0$,
\label{localization-zero}
\item if $R$ is a ring and if the multiplicative subset $S$
consists completely of nonzero divisors, then $R \to S^{-1}R$
is injective,
\label{localize-nonzerodivisors}
\item if $\varphi : R_1 \to R_2$ is a ring homomorphism, and
$S$ is a multiplicative subsets of $R_1$, then $\varphi(S)$ is
a multiplicative subset of $R_2$,
\item if $S$, $S'$ are multiplicative subsets of $R$,
and if $SS'$ denotes the set of products $SS' =
\{r \in R \mid \exists s\in S, \exists s' \in S', r = ss'\}$
then $SS'$ is a multiplicative subset of $R$,
\label{products-multiplicative-subsets}
\item if $S$, $S'$ are multiplicative subsets of $R$,
and if $\overline{S}$ denotes the image of $S$ in $(S')^{-1}R$,
then $(SS')^{-1}R = \overline{S}^{-1}((S')^{-1}R)$,
\label{localization-localization}
\item the {\it localization} $S^{-1}M$ of the $R$-module $M$,
\label{localization-module}
\item the functor $M \mapsto S^{-1}M$ preserves injective maps,
surjective maps, and exactness,
\label{localization-exact}
\item if $S$, $S'$ are multiplicative subsets of $R$,
and $M$ and $R$-module, then $(SS')^{-1}M =
S^{-1}((S')^{-1}M)$,
\label{localization-localization-module}
\item if $R$ is a ring, $I$ and ideal of $R$ and $S$ a multiplicative
subset of $R$, then $S^{-1}I$ is an ideal of $S^{-1}R$, and we have
$S^{-1}R/S^{-1}I = \overline{S}^{-1}(R/I)$, where $\overline{S}$
is the image of $S$ in $R/I$,
\label{localize-ideal}
\item if $R$ is a ring, and $S$ a multiplicative
subset of $R$, then any ideal $I'$ of $S^{-1}R$ is
of the form $S^{-1}I$, where one can take $I$ to be
the inverse image of $I'$ in $R$,
\label{ideal-in-localization}
\item if $R$ is a ring, $M$ an $R$-module, and $S$ a multiplicative
subset of $R$, then any submodule $N'$ of $S^{-1}M$ is of the form
$S^{-1}N$ for some submodule $N \subset M$, where
one can take $N$ to be the inverse image of $N'$ in $M$,
\label{submodule-in-localization}
\item if $S = \{1, f, f^2,\ldots\}$ then $R_f = S^{-1}R$, and
$M_f = S^{-1}M$,
\label{localize-f}
\item if $S = R \setminus \mathfrak p = \{x\in R \mid x\not\in \mathfrak p\}$
for some prime ideal $\mathfrak p$,
then it is customary to denote $R_{\mathfrak p} = S^{-1}R$
and $M_{\mathfrak p} = S^{-1}M$,
\label{localize-p}
\item a {\it local ring} is a ring with exactly one maximal ideal,
\label{local-ring}
\item if $\mathfrak p$ is a prime in $R$, then $R_{\mathfrak p}$ is
a local ring with maximal ideal $\mathfrak p R_{\mathfrak p}$,
\label{localize-p-local-ring}
\item the {\it residue field}, denoted $\kappa(\mathfrak p)$,
of the prime $\mathfrak p$ in the
ring $R$ is the quotient $R_{\mathfrak p}/{\mathfrak p}R_{\mathfrak p}
= (R \setminus \mathfrak p)^{-1}R/{\mathfrak p}$,
\label{residue-field}
\item given $R$ and $M_1$, $M_2$ the {\it tensor product} 
$M_1 \otimes_R M_2$,
\label{tensor-product}
\item etc.
\end{enumerate}





















\section{Localization}
\label{section-localization}

\begin{definition}
\label{definition-multiplicative-subset}
Let $R$ be a ring, $S$ a subset of $R$.
We say $S$ is a
\emph{multiplicative subset of $R$} is
$1\in S$ and $S$ is closed
under multiplication, i.e., $s,s' \in S \Rightarrow ss' \in S$.
\end{definition}

\noindent
Given a ring $A$ and a multiplicative subset $S$, we
define a relation on $A\times S$ as follows:
\[
(x,s)\sim(y,t) \iff \exists u\in S,\ \text{such that}\ (xt-ys)u=0
\]
It is easily checked that this is an equivalence relation.

\begin{definition}
\label{definition-localization}
Let $x/s$ (or $\frac{x}{s}$) be the equivalence class of $(x,s)$ and
$S^{-1}A$ be the set of all equivalence classes. Define addition
and multiplication in $S^{-1}A$ as follows:
\begin{align}
x/s+y/t&=(xt+ys)/st\\
x/s\cdot y/t&=xy/st
\end{align}
One can check that $S^{-1}A$ becomes a ring under these operations.
This ring is called the localization of $A$ with respect to $S$.
\end{definition}

\noindent
We have a natural ring map from $A$ to its localization $S^{-1}A$,
\[
\varphi:A\rightarrow S^{-1}A,\quad x\mapsto x/1
\]

\medskip\noindent
The localization of a ring has the following universal property.

\begin{proposition}
\label{proposition-universal-property-localization}
Let $f:A\rightarrow B$ be a ring map that sends every element in $S$ to a unit
of $B$. Then there is a unique homomorphism $g:S^{-1}A\rightarrow B$ such
that the following diagram commutes.
\[
\xymatrix{
    A \ar[rr]^{f} \ar[dr]_{\varphi} & &B\\
    &S^{-1}A \ar[ur]_{g}
    }
\]
\end{proposition}

\begin{proof}
Existence. We define a map $g$ as follows. For $x/s\in
S^{-1}A$, let $g(x/s)=f(x)f(s)^{-1}\in B$. It is easily checked from
the definition that this is a well-defined ring map. And it is also clear that 
this makes the diagram commutative.

\medskip\noindent
Uniqueness. We now show that if $g':S^{-1}A \rightarrow B$
satisfies $g'\varphi=f$, then $g=g'$. First of all, to make
the diagram commutative, $g'$ should send
$x/1$ to $f(x)$. Next $f(s)=g'(s/1)$ for $s\in S$ by the
commutativity of the diagram. But then $g'(1/s)f(s)=1$ in $B$,
which implies that $g'(1/s)=f(s)^{-1}$ and hence
$g'(x/s)=g'(x/1)g'(1/s)=f(x)f(s)^{-1}=g(x/s)$.
\end{proof}

\noindent
In general the localization map is not injective, unless $S$
contains no zero divisors. For, if $x/1=0$, then there is a $u\in S$
such that $xu=0$ in $A$ and hence $x=0$ since there are no zero
divisors in $S$.

\begin{lemma}
\label{lemma-localization-zero}
The localization $S^{-1}A$ is the zero ring if and only if $0\in S$.
\end{lemma}

\begin{proof}
If $0\in S$, any pair $(a,s)\sim (0,1)$ by definition.
If $0\not \in S$, then clearly $1/1 \neq 0/1$ in $S^{-1}A$.
\end{proof}

\noindent
The notion of localization of a ring can be generalized to the
localization of a module.

\medskip\noindent
Let $A$ be a ring, $S$ a multiplicative subset of $A$ and $M$ an $A$-module.
We define a relation on
$M\times S$ as follows
\[
(m,s)\sim(n,t) \iff \exists u\in S,\ \text{such that}\ (mt-ns)u=0
\]
This is clearly an equivalence relation. Denote by $m/s$ (or
$\frac{m}{s}$) be the equivalence class of $(m,s)$ and $S^{-1}M$ be
the set of all equivalence classes. Define the addition and scalar
multiplication as follows
\begin{align}
m/s+n/t&=(mt+ns)/st\\
m/s\cdot n/t&=mn/st
\end{align}
It is clear that this makes $S^{-1}M$ an $S^{-1}A$ module.

\medskip\noindent
The $S^{-1}A$-module $S^{-1}M$ is called the \emph{localization} of $M$ at $S$.

\begin{example}
(1) If $\mathfrak p$ is a prime ideal of $A$, $S=A\setminus\mathfrak p$. It is
immediately checked that $S$ is a multiplicative set. Then denote by
$A_\mathfrak p$ and $M_\mathfrak p$ the localization of $A$ and $M$ with 
respect to
$S$ respectively.

(2) Suppose $f\in A$, $S=\{1,f,f^2,\cdots\}$, then denote by $A_f$
(resp. $M_f$) the localization $S^{-1}A$ (resp. $S^{-1}M$). Note
that $A_f=0$ if and only if $f$ is nilpotent in $A$.
\end{example}

\noindent
In the following paragraph,
let $A$ denote a ring,
and $M,N$ denote modules over $A$.

\medskip\noindent
If $S$ and $S'$ are multiplicative sets of $A$, then it is
clear that
\[
SS'=\{ss':s\in S,\ s'\in S'\}
\]
is also a multiplicative set of $A$. Then the following holds.

\begin{proposition}
Let $\overline{S}$ be the image of $S$ in $S'^{-1}A$, then
$(SS')^{-1}A$ is isomorphic to $\overline{S}^{-1}(S'^{-1}A)$.
\end{proposition}

\begin{proof}
The map sending $x\in A$ to $x/1\in (SS'^{-1})A$ induces a map
sending $x/s\in S'^{-1}A$ to $x/s \in (SS'^{-1})A$, by universal
property. The image of the elements in $\overline{S}$ are invertible
in $(SS'^{-1})A$. By the universal property we get a map
$f:\overline{S}^{-1}(S'^{-1}A)\rightarrow (SS'^{-1})A$ which maps
$(x/t')/(s/s')$ to $(x/t')\cdot(s/s')^{-1}$.

\medskip\noindent
On the other hand, the map from $A$ to $\overline{S}^{-1}(S'^{-1}A)$
sending $x\in A$ to $(x/1)/(1/1)$ also induces a map
$g:(SS'^{-1})A\rightarrow \overline{S}^{-1}(S'^{-1}A)$ which sends $x/ss'$
to $(x/s')/(s/1)$, by the universal property again. It is
immediately checked that $f$ and $g$ are inverse to each other,
hence they are both isomorphisms.
\end{proof}

\noindent
For the module $M$ we have

\begin{proposition}
View $S'^{-1}M$ as an $A$-module, then $S^{-1}(S'^{-1}M)$ is
isomorphic to $(SS')^{-1}M$.
\end{proposition}

\begin{proof}
Note that given a $A$-module M, we have not proved any
universal property for $S^{-1}M$. Hence we cannot reason
as in the preceding proof; we have to construct the isomorphism explicitly.

\medskip\noindent
We define the maps as follows
\begin{align*}
&f:S^{-1}(S'^{-1}M) \longrightarrow (SS')^{-1}M, \quad \frac{x/s'}{s}\mapsto
x/ss'\\
&g:(SS')^{-1}M \longrightarrow S^{-1}(S'^{-1}M), \quad x/t\mapsto
\frac{x/s'}{s}\ \text{for some}\ s\in S, s'\in S',\ \text{and}\
t=ss'
\end{align*}
We have to check that these homomorphisms are well-defined, that is, 
independent the choice of the fraction. This is easily checked and it is also 
straightforward to show that they are inverse to each other.
\end{proof}

\noindent
If $u:M\rightarrow N$ is an $A$ homomorphism, then the localization indeed
induces a well-defined $S^{-1}A$ homomorphism $S^{-1}u:S^{-1}M\rightarrow
S^{-1}N$ which sends $x/s$ to $u(x)/s$. It is immediately checked that
this construction is functorial, so that $S^{-1}$
is actually a functor from the category of $A$-modules to the
category of $S^{-1}A$-modules. Moreover this functor is exact,
as we show in the following proposition.

\begin{proposition}
Let $L\xrightarrow{u} M\xrightarrow{v} N$ is an exact sequence. Then
$S^{-1}L\rightarrow S^{-1}M\rightarrow S^{-1}N$ is also exact.
\end{proposition}

\begin{proof}
First it is clear that $S^{-1}v\circ S^{-1}u=0$ since $S^{-1}$ is a
functor. Next suppose that $S^{-1}v(x/s)=0$ for some $x/s\in
S^{-1}M$. Then by definition there is a $t\in S$ such that
$v(xt)=v(x)t=0$ in $M$, which means $xt\in\text{Ker}(v)$.
By the exactness of $L\rightarrow M\rightarrow
N$ we have $xt=u(y)$ for some $y$ in $L$. Then $x/s=S^{-1}u(y/st)$,
which shows $\text{Ker} S^{-1}v\subset\text{Im} S^{-1}u$. The exactness then
follows.
\end{proof}

\begin{lemma}
Localization respects quotients, i.e. if $N$ is a submodule of
$M$, then $S^{-1}(M/N)\simeq (S^{-1}M)/(S^{-1}N)$.
\end{lemma}

\begin{proof}
From the exact sequence
\[
0 \longrightarrow N \longrightarrow M \longrightarrow M/N \longrightarrow 0
\]
we have
\[
0 \longrightarrow S^{-1}N \longrightarrow S^{-1}M
\longrightarrow S^{-1}(M/N) \longrightarrow 0
\]
The corollary then follows.
\end{proof}

\noindent
If, in the preceding Corollary, we take $N=I$ and $M=A$ for an ideal $I$ of 
$A$, we see that $S^{-1}A/S^{-1}I \simeq S^{-1}(A/I)$ as $A$-modules. The next 
proposition shows that they are isomorphic as rings.

\begin{proposition}
\label{proposition-localize-quotient}
Let $I$ be an ideal of $A$, $S$ a multiplicative set of $A$. Then
$S^{-1}I$ is an ideal of $S^{-1}A$ and $\overline{S}^{-1}(A/I)$ is
isomorphic to $S^{-1}A/S^{-1}I$, where $\overline{S}$ is
the image of $S$ in $A/I$.
\end{proposition}

\begin{proof}
The fact that $S^{-1}I$ is an ideal is clear since $I$ itself is an
ideal. Define
\[
f:S^{-1}A\longrightarrow \overline{S}^{-1}(A/I),\quad x/s\mapsto
\overline{x}/\overline{s}
\]
where $\overline{x}$ and $\overline{s}$ are the images of $x$ and
$s$ in $A/I$. We shall keep similar notations in this proof.
This map is well-defined by the universal property of
$S^{-1}A$, and $S^{-1}I$ is contained in the kernel of it,
therefore it induces a map
\[
\overline{f}:S^{-1}A/S^{-1}I \longrightarrow \overline{S}^{-1}(A/I),\quad
\overline{x/s}\mapsto \overline{x}/\overline{s}
\]

\medskip\noindent
On the other hand, the map $A\rightarrow S^{-1}A/S^{-1}I$ sending $x$ to
$\overline{x/1}$ induces a map $A/I \rightarrow S^{-1}A/S^{-1}I$ sending
$\overline{x}$ to $\overline{x/1}$. The image of $\overline{S}$ is
invertible in $S^{-1}A/S^{-1}I$, thus induces a map
\[
g:\overline{S}^{-1}(A/I) \longrightarrow S^{-1}A/S^{-1}I, \quad
\frac{\overline{x}}{\overline{s}}\mapsto \overline{x/s}
\]
by the universal property. It is then clear that $\overline{f}$ and $g$
are inverse to each other, hence are both isomorphisms.
\end{proof}

\noindent
We now consider how submodules behave in localization.

\begin{lemma}
\label{lemma-submodule-localization}
Any submodule $N'$ of $S^{-1}M$ is of the form $S^{-1}N$ for some
$N\subset M$. Indeed one can take $N$ to be the inverse image of
$N'$ in $M$.
\end{lemma}

\begin{proof}
Let $N$ be the inverse image of $N'$ in $M$. Then one can see that
$S^{-1}N\supset N'$. To show they are equal, take $x/s$ in
$S^{-1}N$, where $s\in S$ and $x\in N$. This yields that $x/1\in
N'$. Since $N'$ is an $S^{-1}R$-submodule we have
$x/s=x/1\cdot1/s\in N'$. This finishes the proof.
\end{proof}

\noindent
Taking $M=A$ and $N=I$ an ideal of $A$, we have the following
corollary, which can be viewed as a converse of the first part of
proposition \ref{proposition-localize-quotient}.

\begin{lemma}
Each ideal $I'$ of $S^{-1}A$ takes the form $S^{-1}I$, where one can
take $I$ to be the inverse image of $I'$ in $A$.
\end{lemma}

\noindent
The next lemma concerns the spectrum and localization.
FIXME: This should be moved later in the manuscript.

\begin{lemma}
Let $S$ be a multiplicative set of $A$. Then the map
\[
f: \text{Spec}(S^{-1}A)\longrightarrow \text{Spec}(A)
\]
induced by the canonical ring map
$A \rightarrow S^{-1}A$ is a homeomorphism onto its image and
$\text{Im}(f)=
\{ \mathfrak p\in \text{Spec}(R): \mathfrak p\cap S=\emptyset \}$.
\end{lemma}

\begin{proof}
Denote the localization map by $\varphi:A\rightarrow S^{-1}A$. We first
show that
$\text{Im}(f)=\{ \mathfrak p\in \text{Spec}(R):
\mathfrak p\cap S=\emptyset \}$. For any
ideal
$\mathfrak q$ of $S^{-1}A$, $\varphi^{-1}(\mathfrak q)\cap S={0}$.
Otherwise if $x\not=0\in\varphi^{-1}(\mathfrak q)\cap S$, then
$x/1\in \mathfrak q$. But $x\in S$, hence $x/1$ is invertible in
$S^{-1}A$ which is impossible since $\mathfrak q$ is a prime ideal.
For any prime ideal $\mathfrak p$ in
$A$ which does not meet $S$, $S^{-1}\mathfrak p$ is an ideal in $S^{-1}A$.
Moreover it is a prime ideal. This is because $S^{-1}A/S^{-1}\mathfrak p$ is
isomorphic to $\overline{S}^{-1}(A/\mathfrak p)$ and the localization of an
integral domain is again an integral domain.

\medskip\noindent
We still have to show that this map is open, i.e. we have to show
that the image of a standard open set is again open. For any
$x/s\in S^{-1}A$, we claim that the image of $D(x/s)$ is
$D(x)\cap\text{Im}(f)$.
First if $x/s\not\in S^{-1}\mathfrak p$ for some prime
ideal $\mathfrak p$ of $A$, then $x\not\in\mathfrak p$.
Conversely, if $x\not\in\mathfrak p$
and $\mathfrak p$ does not meet $S$, then
$x/s\not\in S^{-1}\mathfrak p$. This is
due to that fact that $\mathfrak p\cap S=\emptyset$.

\medskip\noindent
Thus $f$ is indeed an homeomorphism onto its image.
\end{proof}





























































\section{The spectrum of a ring}
\label{section-spectrum-ring}

\noindent
We arbitrarily decide that the spectrum of a ring as a topological space
is part of the algebra chapter, whereas an affine scheme is part of the
chapter on schemes.

\begin{definition}
\label{definition-spectrum-ring}
Let $R$ be a ring.
\begin{enumerate}
\item The {\it spectrum} of $R$ is the set of prime ideals of $R$.
It is usually denoted $\text{Spec}(R)$.
\item Given a subset $T \subset R$ we let $V(T) \subset \text{Spec}(R)$
be the set of primes containing $T$, i.e., $V(T) = \{ \mathfrak p \in
\text{Spec}(R) \mid \forall f\in T, f\in \mathfrak p\}$.
\item Given an element $f \in R$ we let $D(f) \subset \text{Spec}(R)$
be the set of primes not containing $f$.
\end{enumerate}
\end{definition}

\begin{lemma}
\label{lemma-Zariski-topology}
Let $R$ be a ring.
\begin{enumerate}
\item The spectrum of a ring $R$ is empty if and only if $R$
is the zero ring.
\item Every nonzero ring has a maximal ideal.
\item Every nonzero ring has a minimal prime ideal.
\item Given an ideal $I \subset R$ and a prime ideal
$I \subset \mathfrak p$ there exists a prime 
$I \subset \mathfrak q \subset \mathfrak p$ such
that $\mathfrak q$ is minimal over $I$.
\item If $T \subset R$, and if $(T)$ is the ideal generated by
$T$ in $R$, then $V((T)) = V(T)$.
\item If $I$ is an ideal and $\sqrt{I}$ is its radical,
see basic notion (\ref{radical-ideal}), then $V(I) = V(\sqrt{I})$.
\item Given an ideal $I$ of $R$ we have $\sqrt{I} =
\bigcap_{I \subset \mathfrak p} \mathfrak p$.
\item If $I$ is an ideal then $V(I) = \emptyset$ if and only
if $I$ is the unit ideal.
\item If $I$, $J$ are ideals of $R$ then $V(I) \cup V(J) =
V(I \cap J)$.
\item If $(I_a)_{a\in A}$ is a set of ideals of $R$ then
$\cap_{a\in A} V(I_a) = V(\cup_{a\in A} I_a)$.
\item If $f \in R$, then $D(f) \coprod V(f) = \text{Spec}(R)$.
\item If $f \in R$ then $D(f) = \emptyset$ if and only if $f$
is nilpotent.
\item If $f = u f'$ for some unit $u \in R$, then $D(f) = D(f')$.
\item If $I \subset R$ is an ideal, and $\mathfrak p$ is a prime of
$R$ with $\mathfrak p \not\in V(I)$, then there exists an $f \in R$
such that $\mathfrak p \in D(f)$, and $D(f) \cap V(I) = \emptyset$.
\item If $f,g \in R$, then $D(fg) = D(f) \cap D(g)$.
\item If $f_i \in R$ for $i \in I$, then
$\bigcup_{i\in I} D(f_i)$ is the complement of $V(\{f_i \}_{i\in I})$
in $\text{Spec}(R)$.
\end{enumerate}
\end{lemma}

\begin{proof}
\
\begin{enumerate}
\item This is a direct consequence of (2) and (3).
\item Let $\mathfrak{A}$ be the set of all proper ideals of $R$. This set is 
ordered by inclusion and is non-empty, since $(0) \in \mathfrak{A}$ is a proper 
ideal. Let $A$ be a totally ordered subset of $R$. $\bigcup_{I \in A} I$ is in 
fact an ideal. Since 1 $\notin I$ for all $I \in A$, the union does not contain 
1 and thus is proper. Hence $\bigcup_{I \in A} I$ is in $\mathfrak{A}$ and is 
an upper bound for the set $A$. Thus by Zorn's lemma $\mathfrak{A}$ has a 
maximal element, which is the soughtafter maximal ideal.
\item Since $R$ is nonzero, it contains a maximal ideal which is a prime ideal. 
Thus the set $\mathfrak{A}$ of all prime ideals of $R$ is nonempty. 
$\mathfrak{A}$ is ordered by reverse-inclusion. Let $A$ be a totally ordered 
subset of $\mathfrak{A}$. It's pretty clear that $J = \bigcap_{I \in A} I$ is 
in fact an ideal. Not so clear, however, is that it is prime. Let $xy \in J$. 
Then $xy \in I$ for all $I \in A$. Now let $B = \{I \in A | y \in I\}$. Let $K 
= \bigcap_{I \in B} I$. Since $A$ is totally ordered, either $K = J$ (and we're 
done, since then $y \in J$) or $K \supset J$ and for all $I \in A$ such that 
$I$ is properly contained in $K$, we have $y \notin I$. But that means that for 
all those $I, x \in I$, since they are prime. Hence $x \in J$. In either case, 
$J$ is prime as desired. Hence by Zorn's lemma we get a maximal element which 
in this case is a minimal prime ideal.
\item This is the same exact argument as (3) except you only consider prime 
ideals contained in $\mathfrak{p}$ and containing $I$.
\item $(T)$ is the smallest ideal containing $T$. Hence if $T \subset I$, some 
ideal, then $(T) \subset I$ as well. Hence if $I \in V(T)$, then $I \in V((T))$ 
as well. The other inclusion is obvious.
\item Since $I \subset \sqrt{I}, V(\sqrt{I}) \subset V(I)$. Now let 
$\mathfrak{p} \in V(I)$. Let $x \in \sqrt{I}$. Then $x^n \in I$ for some $n$. 
Hence $x^n \in \mathfrak{p}$. But since $\mathfrak{p}$ is prime, a boring 
induction argument gets you that $x \in \mathfrak{p}$. Hence $\sqrt{I} \subset 
\mathfrak{p}$ and $\mathfrak{p} \in V(\sqrt{I})$.
\item Let $f \in R \setminus \sqrt{I}$. Then $f^n \notin I$ for all $n$. Hence 
$S = \{1,f,f^2,...\}$ is a multiplicative subset, not containing $0$. Take a 
prime ideal $\bar{\mathfrak{p}} \subset S^{-1}R$ containing $S^{-1}I$. Then the 
pull-back $\mathfrak{p}$ in $R$ of $\bar{\mathfrak{p}}$ is a prime ideal 
containing $I$ that does not intersect $S$. This shows that $\bigcap_{I \subset 
\mathfrak p} \mathfrak p \subset \sqrt{I}$. Now if $a \in \sqrt{I}$, then $a^n 
\in I$ for some $n$. Hence if $I \subset \mathfrak{p}$, then $a^n \in 
\mathfrak{p}$. But since $\mathfrak{p}$ is prime, we have $a \in \mathfrak{p}$. 
Thus the equality is shown.
\item $I$ is not the unit ideal iff $I$ is contained in some maximal ideal (to 
see this, apply (2) to the ring $R/I$) which is therefore prime.
\item If $\mathfrak{p} \in V(I) \cup V(J)$, then $I \subset \mathfrak{p}$ or $J 
\subset \mathfrak{p}$ which means that $I \cap J \subset \mathfrak{p}$. Now if 
$I \cap J \subset \mathfrak{p}$, then $IJ \subset \mathfrak{p}$ and hence 
either $I$ of $J$ is in $\mathfrak{p}$, since $\mathfrak{p}$ is prime.
\item $\mathfrak{p} \in \bigcap_{a \in A} V(I_a) \Leftrightarrow I_a \subset 
\mathfrak{p}, \forall a \in A \Leftrightarrow \mathfrak{p} \in V(\cup_{a\in A} 
I_a)$
\item If $\mathfrak{p}$ is a prime ideal and $f \in R$, then either $f \in 
\mathfrak{p}$ or $f \notin \mathfrak{p}$ (strictly) which is what the disjoint 
union says.
\item If $a \in R$ is nilpotent, then $a^n = 0$ for some $n$. Hence $a^n \in 
\mathfrak{p}$ for any prime ideal. Thus $a \in \mathfrak{p}$ as can be shown by 
induction and $D(f)=\emptyset$. Now, as shown in (7), if $a \in R$ is not 
nilpotent, then there is a prime ideal that does not contain it.
\item $f \in \mathfrak{p} \Leftrightarrow uf \in \mathfrak{p}$, since $u$ is 
invertible.
\item If $\mathfrak{p} \notin V(I)$, then $\exists f \in I \setminus 
\mathfrak{p}$. Then $f \notin \mathfrak{p}$ so $\mathfrak{p} \in D(f)$. Also if 
$\mathfrak{q} \in D(f)$, then $f \notin \mathfrak{q}$ and thus $I$ is not 
contained in $\mathfrak{q}$. Thus $D(f) \cap V(I) = \emptyset$.
\item If $fg \in \mathfrak{p}$, then $f \in \mathfrak{p}$ or $g \in 
\mathfrak{p}$. Hence if $f \notin \mathfrak{p}$ and $g \notin \mathfrak{p}$, 
then $fg \notin \mathfrak{p}$. Since $\mathfrak{p}$ is an ideal, if $fg \notin 
\mathfrak{p}$, then $f \notin \mathfrak{p}$ and $g \notin \mathfrak{p}$.
\item $\mathfrak{p} \in \bigcup_{i \in I} D(f_i) \Leftrightarrow \exists i \in 
I, f_i \notin \mathfrak{p} \Leftrightarrow \mathfrak{p} \in \mathrm{spec}(R) 
\setminus V(\{f_i\}_{i \in I})$
\end{enumerate}
\end{proof}

\noindent
The lemma implies that the subsets $V(T)$ from
Definition \ref{definition-spectrum-ring} form the closed
subsets of a topology on $\text{Spec}(R)$. And it also shows that
the sets $D(f)$ are open and form a basis for this
topology.

\begin{definition}
\label{definition-Zariski-topology}
Let $R$ be a ring.
The topology on $\text{Spec}(R)$ whose closed sets are the
sets $V(T)$ is called the {\it Zariski} topology. The open
subsets $D(f)$ are called the {\it standard opens} of $\text{Spec}(R)$.
\end{definition}

\noindent
It should be clear from context whether we consider $\text{Spec}(R)$
just as a set or as a topological space.

\begin{lemma}
\label{lemma-spec-functorial}
Suppose that $\varphi : R \to R'$ is a ring homomorphism.
The induced map
$$
\text{Spec}(\varphi) :
\text{Spec}(R')
\longrightarrow
\text{Spec}(R),\ \ 
\mathfrak p'
\longmapsto
\varphi^{-1}(\mathfrak p')
$$
is continuous for the Zariski toplogies. In fact, for
$f \in R$ we have
$\text{Spec}(\varphi)^{-1}(D(f)) = D(\varphi(f))$.
\end{lemma}

\begin{proof}
It is basic notion (\ref{inverse-image-prime}) that
$\mathfrak p := \varphi^{-1}(\mathfrak p')$
is indeed a prime ideal of $R$. The last assertion
of the lemma follows directly from the definitions,
and implies the first.
\end{proof}

\noindent
If $\varphi' : R' \to R''$ is a second ring homomorphism
then the composition
$$
\text{Spec}(R')
\longrightarrow
\text{Spec}(R')
\longrightarrow
\text{Spec}(R'')
$$
equals $\text{Spec}(\varphi' \circ \varphi)$. In other
words, $\text{Spec}$ is a contravariant functor from the
category of rings to the category of topological spaces.

\begin{lemma}
\label{lemma-spec-localization}
Let $R$ be a ring. Let $S \subset R$ be a multiplicative subset.
The map $R \to S^{-1}R$ induces via the functoriality of $\text{Spec}$
a homeomorphism 
$$
\text{Spec}(S^{-1}R)
\longrightarrow 
\{\mathfrak p \in \text{Spec}(R) \mid S \cap \mathfrak p = \emptyset \}
$$
where the topology on the right hand side is that induced from the
Zariski topology on $\text{Spec}(R)$. The inverse map is given
by $\mathfrak p \mapsto S^{-1}\mathfrak p$.
\end{lemma}

\begin{proof}
Denote the right hand side of the arrow of the lemma by $D$.
Choose a prime $\mathfrak p' \subset S^{-1}R$ and let $\mathfrak p$
the inverse image of $\mathfrak p'$ in $R$. Since $\mathfrak p'$
does not contain $1$ we see that $\mathfrak p$ does not contain
any element of $S$. Hence $\mathfrak p \in D$ and we see that
the image is contained in $D$. Let $\mathfrak p \in D$.
By assumption the image $\overline{S}$ does not contain $0$.
By basic notion (\ref{localization-zero})
$\overline{S}^{-1}(R/\mathfrak p)$ is not the zero ring.
By basic notion (\ref{localize-ideal}) we see
$S^{-1}R / S^{-1}\mathfrak p = \overline{S}^{-1}(R/\mathfrak p)$
is a domain, and hence $S^{-1}\mathfrak p$ is a prime.
The equality of rings also shows that the inverse image of
$S^{-1}\mathfrak p$ in $R$ is equal to $\mathfrak p$,
because $R/\mathfrak p \to \overline{S}^{-1}(R/\mathfrak p)$
is injective by basic notion (\ref{localize-nonzerodivisors}).
This proves that the map $\text{Spec}(S^{-1}R) \to \text{Spec}(R)$
is bijective onto $D$ with inverse as given.
It is continuous by Lemma \ref{lemma-spec-functorial}.
Finally, let $D(g) \subset \text{Spec}(S^{-1}R)$ be a standard
open. Write $g = h/s$ for some $h\in R$ and $s\in S$.
Since $g$ and $h/1$ differ by a unit we have $D(g) = 
D(h/1)$ in $\text{Spec}(S^{-1}R)$.
Hence by Lemma \ref{lemma-spec-functorial} and the bijectivity
above the image of $D(g) = D(h/1)$ is $D \cap D(h)$.
This proves the map is open as well.
\end{proof}

\begin{lemma}
\label{lemma-standard-open}
Let $R$ be a ring. Let $f \in R$.
The map $R \to R_f$ induces via the functoriality of
$\text{Spec}$ a homeomorphism
$$
\text{Spec}(R_f) \longrightarrow D(f) \subset \text{Spec}(R).
$$
The inverse is given by $\mathfrak p \mapsto \mathfrak p \cdot R_f$.
\end{lemma}

\begin{proof}
This is a special case of Lemma \ref{lemma-spec-localization}
above.
\end{proof}

\begin{example}
\label{example-affine-open-not-standard}
Consider the ring
$$
R = \{ f \in \mathbf{Q}[z]\text{ with } f(0) = f(1) \}.
$$
This ring is isomorphic to $\mathbf{Q}[A,B]/(A^3 - B^2 + AB)$
where $A = z^2 - z$ and $B = z^3 - z^2$. On the other hand,
let $a \in \mathbf{Q}$, $a \not = 1/2, 0, 1$ and consider
$$
R_a = \{ f \in \mathbf{Q}[z, \frac{1}{z-a}]\text{ with }f(0) = f(1) \}.
$$
This is a finitely generated $\mathbf{Q}$-algebra as well.
Then $\text{Spec}(R_a) \to \text{Spec}(R)$
is a homeomorphism onto an open of $\text{Spec}(R)$
but $R_a$ is not a localization of $R$. What happens if
$a = 1/2$?
\end{example}

\begin{lemma}
\label{lemma-spec-closed}
Let $R$ be a ring. Let $I \subset R$ be an ideal.
The map $R \to R/I$ induces via the functoriality of
$\text{Spec}$ a homeorphism
$$
\text{Spec}(R/I) \longrightarrow V(I) \subset \text{Spec}(R).
$$
The inverse is given by $\mathfrak p \mapsto \mathfrak p / I$.
\end{lemma}

\begin{proof}
It is immediate that the image is contained in $V(I)$.
On the other hand, if $\mathfrak p \in V(I)$
then $\mathfrak p \supset I$ and we may consider
the ideal $\mathfrak p /I \subset R/I$. Using
basic notion (\ref{isomorphism-theorem}) we see that
$(R/I)/(\mathfrak p/I) = R/\mathfrak p$ is a domain
and hence $\mathfrak p/I$ is a prime ideal. From this
it is immediately clear that the image of $D(f + I)$
is $D(f) \cap V(I)$, and hence the map is a homeomorphism.
\end{proof}


\begin{example}
\label{example-spec-Zxmodx2minus4}
In this example we describe $X = \text{Spec} (\mathbf{Z}[x]/(x^2 - 4))$.
Let $\mathfrak{p}$ be an arbitrary prime in $X$.
Let $\phi: \mathbf{Z} \to \mathbf{Z}[x]/(x^2 - 4)$ be the natural ring map.
Then, $ \phi^{-1}(\mathfrak p)$ is a prime in $\mathbf{Z}$.
If $ \phi^{-1}(\mathfrak p) = (2)$, then since $\mathfrak p$ contains $2$,
it corresponds to a prime ideal in
$\mathbf{Z}[x]/(x^2 - 4, 2) \cong (\mathbf{Z}/2\mathbf{Z})[x]/(x^2)$
via the map $ \mathbf{Z}[x]/(x^2 - 4) \to  \mathbf{Z}[x]/(x^2 - 4, 2)$.
Any prime in $(\mathbf{Z}/2\mathbf{Z})[x]/(x^2)$ corresponds to a prime
in $(\mathbf{Z}/2\mathbf{Z})[x]$ containing $(x^2)$.  Such primes will
then contain $x$.  Since
$(\mathbf{Z}/2\mathbf{Z}) \cong (\mathbf{Z}/2\mathbf{Z})[x]/(x)$ is a field,
$(x)$ is a maximal ideal.  Since any prime contains $(x)$ and $(x)$ is
maximal, the ring contains only one prime $(x)$.  Thus, in this case,
$\mathfrak p = (2, x)$.  Now, if $ \phi^{-1}(\mathfrak p) = (q)$ for
$q > 2$, then since $\mathfrak p$ contains $q$, it corresponds to a
prime ideal in
$\mathbf{Z}[x]/(x^2 - 4, q) \cong (\mathbf{Z}/q\mathbf{Z})[x]/(x^2 - 4)$
via the map $ \mathbf{Z}[x]/(x^2 - 4) \to  \mathbf{Z}[x]/(x^2 - 4, q)$.
Any prime in $(\mathbf{Z}/q\mathbf{Z})[x]/(x^2 - 4)$ corresponds to a
prime in $(\mathbf{Z}/q\mathbf{Z})[x]$ containing $(x^2 - 4) = (x -2)(x+2)$.
Hence, these primes must contain either $x -2$ or $x+2$.  Since
$(\mathbf{Z}/q\mathbf{Z})[x]$ is a PID, all nonzero
primes are maximal, and so there
are precisely 2 primes in $(\mathbf{Z}/q\mathbf{Z})[x]$ containing
$(x-2)(x+2)$, namely $(x-2)$ and $(x+2)$.  In conclusion, there exist two
primes $(q, x-2)$ and $(q, x+2)$ since $2 \neq -2 \in \mathbf{Z}/(q)$.
Finally, we treat the case where $\phi^{-1}(\mathfrak p) = (0)$.  Notice
that $\mathfrak p$ corresponds to a prime ideal in $\mathbf{Z}[x]$ that
contains $(x^2 - 4) = (x -2)(x+2)$.  Hence, $\mathfrak p$ contains either
$(x-2)$ or $(x+2)$.  Hence, $\mathfrak p$ corresponds to a prime in
$\mathbf{Z}[x]/(x-2)$ or one in $\mathbf{Z}[x]/(x+2)$ that intersects
$\mathbf{Z}$ only at $0$, by assumption.  Since
$\mathbf{Z}[x]/(x-2) \cong \mathbf{Z}$ and
$\mathbf{Z}[x]/(x-2) \cong \mathbf{Z}$, this means that $\mathfrak p$
must correspond to $0$ in one of these rings.  Thus,
$\mathfrak p = (x-2)$ or $\mathfrak p = (x+2)$ in the original ring.
\end{example}

\begin{example}
\label{example-spec-Zx}
In this example we describe $X = \text{Spec} (\mathbf{Z}[x])$.
Fix $\mathfrak p \in X$.
Let $\phi: \mathbf{Z} \to \mathbf{Z}[x]$ and notice
that $\phi^{-1}(\mathfrak p) \in \text{Spec} \mathbf{Z}$.
If $\phi^{-1}(\mathfrak p) = (q)$ for $q$ a prime number $q > 0$,
then it $\mathfrak p$ corresponds to a prime in $(\mathbf{Z}/(q))[x]$,
which must be generated by a polynomial that is irreducible in
$(\mathbf{Z}/(q))[x]$.   If we choose a representative of this polynomial
with minimal degree, then it will also be irreducible in $\mathbf{Z}[x]$.
Hence, in this case $\mathfrak p = (q, f_q)$ where $f_q$ is an irreducible
polynomial in $\mathbf{Z}[x]$ that is irreducible when viewed
in $(\mathbf{Z}/(q) [x])$. Now, assume that $\phi^{-1}(\mathfrak p) = (0)$.
In this case, $\mathfrak p$ must be generated by nonconstant polynomials
which, since $\mathfrak p$ is prime, may be assumed to be irreducible in
$\mathbf{Z}[x]$.  By Gauss' lemma, these polynomials are also irreducible
in $\mathbf{Q}[x]$.  Since $\mathbf{Q}[x]$ is a Euclidean domain, if there
are at least two distinct irreducibles $f, g$ generating $\mathfrak p$,
then $1 = af + bg$ for $a,b \in \mathbf{Q}[x]$.  Multiplying through by
a common denominator, we see that $m = \bar{a}f + \bar{b} g$ for
$\bar{a},\bar{b} \in \mathbf{Z}[x]$ and nonzero $m \in \mathbf{Z}$.
This is a contradiction.  Hence, $\mathfrak p$ is generated by one
irreducible polynomial in $\mathbf{Z}[x]$.
\end{example}

\begin{example}
\label{example-spec-kxy}
In this example we describe $X = \text{Spec}(k[x,y])$
when $k$ is an arbitrary field.
Clearly $(0)$ is prime, and any principal ideal generated by an
irreducible polynomial will also be a prime since $k[x,y]$ is a
unique factorization domain. Now assume $\mathfrak p$ is an
element of $X$ that is not principal. Since $k[x,y]$ is a
Noetherian UFD, the prime ideal $\mathfrak p$ can be generated
by a finite number of irreducible polynomials $(f_1,\ldots, f_n)$.
Now, I claim that if $f, g$ are irreducible polynomials in $k[x,y]$
that are not associates, then $(f,g) \cap k[x] \neq 0$. To do this,
it is enough to show that $f$ and $g$ are relatively prime when
viewed in $k(x)[y]$. In this case, $k(x)[y]$ is a Euclidean domain,
so by applying the Euclidean algorithm and clearing denominators, we
obtain $p = af + bg$ for $p, a,b \in k[x]$. Thus, assume this is not
the case, that is, that some nonunit $h \in k(x)[y]$ divides both
$f$ and $g$. Then, by Gauss's lemma, for some $a, b \in k(x)$ we
have $ah | f$ and $bh | g$ for $ah, bh \in k[x]$ since
$\textrm{Frac}(k[x]) = k(x)$. By irreducibility, $ah = f$ and
$bh = g$ (since $h \notin k(x)$). So, back in $k(x)[y]$, $f,g $
are associates, as $\frac{a}{b} g = f$. Since
$k(x) = \textrm{Frac}(k[x])$, we can write $g = \frac{r}{s} f $
for elements $r ,s \in k[x]$ sharing no common factors. This
implies that $sg = rf$ in $k[x,y]$ and so $s$ must divide $f$
since $k[x,y]$ is a UFD. Hence, $s = 1$ or $s = f$. If $s = f$,
then $r = g$, implying $f, g \in k[x]$ and thus must be units in
$k(x)$ and relatively prime in $k(x)[y]$, contradicting our
hypothesis. If $s = 1$, then $g = rf$, another contradiction.
Thus, we must have $f, g$ relatively prime in $k(x)[y]$, a
Euclidean domain. Thus, we have reduced to the case $\mathfrak p$
contains some irreducible polynomial $p \in k[x] \subseteq k[x,y]$.
By the above, $\mathfrak p$ corresponds to a prime in the ring
$k[x,y]/(p) = k(\alpha)[y]$, where $\alpha$ is an element
algebraic over $k$ with minimum polynomial $p$. This is a
PID, and so any prime ideal corresonds to $(0)$ or an
irreducible polynomial in $k(\alpha)[y]$. Thus, $\mathfrak p$
is of the form $(p)$ or $(p, f)$ where $f$ is a
polynomial in $k[x,y]$ that is irreducible in the quotient
$k[x,y]/(p)$.
\end{example}

\begin{remark}
\label{remark-fundamental-diagram}
A fundamental commutative diagram associated to
$\varphi : R \to S$,
$\mathfrak q \subset S$ and
$\mathfrak p = \varphi^{-1}(\mathfrak q)$ is
the following
$$
\xymatrix{
\kappa(\mathfrak q) = S_{\mathfrak q}/{\mathfrak q}S_{\mathfrak q}
&
S_{\mathfrak q} \ar[l]
&
S \ar[r] \ar[l]
&
S/\mathfrak q \ar[r]
&
\kappa(\mathfrak q) = \text{f.f.}(S/\mathfrak q)
\\
\kappa(\mathfrak p) \otimes_R S =
S_{\mathfrak p}/{\mathfrak p}S_{\mathfrak p} \ar[u]
&
S_{\mathfrak p} \ar[u] \ar[l]
&
S \ar[u] \ar[r] \ar[l]
&
S/\mathfrak pS \ar[u] \ar[r]
&
(R \setminus \mathfrak p)^{-1}S/\mathfrak pS =
S \otimes_R \kappa(\mathfrak p) \ar[u]
\\
\kappa(\mathfrak p) =
R_{\mathfrak p}/{\mathfrak p}R_{\mathfrak p} \ar[u]
&
R_{\mathfrak p} \ar[u] \ar[l]
&
R \ar[u] \ar[r] \ar[l]
&
R/\mathfrak p \ar[u] \ar[r]
&
\kappa(\mathfrak p) = \text{f.f.}(R/\mathfrak p) \ar[u]
}
$$
In this diagram the arrows on the outer left and outer right columns
are identical. The horizontal maps induce on the associated spectrums
always an homeomorphism onto the image. The lower two rows
of the diagram make sense without assuming $\mathfrak q$ exists.
The lower squares induce fibre squares of topological spaces.
This diagram shows that $\mathfrak p$ is in the image
of the map on Spec if and only if $S \otimes_R \kappa(\mathfrak p)$
is not the zero ring.
\end{remark}

\begin{lemma}
\label{lemma-in-image}
Let $\varphi : R \to S$ be a ring map. Let $\mathfrak p$
be a prime of $R$. The following are equivalent
\begin{enumerate}
\item $\mathfrak p$ is in the image of
$\text{Spec}(S) \to \text{Spec}(R)$,
\item $S \otimes_R \kappa(\mathfrak p) \not= 0$,
\item $S_{\mathfrak p}/\mathfrak p S_{\mathfrak p} \not = 0$,
\item $(S/\mathfrak pS)_{\mathfrak p} \not = 0$, and
\item $\mathfrak p = \varphi^{-1}(\mathfrak pS)$.
\end{enumerate}
\end{lemma}

\begin{proof}
We have already seen the equivalence of the first two
in Remark \ref{remark-fundamental-diagram}. The others
are just reformulations of this.
\end{proof}

\begin{lemma}
\label{lemma-quasicompact}
Let $R$ be a ring. The space $\text{Spec}(R)$ is quasicompact.
\end{lemma}

\begin{proof}
It suffices to prove that any covering of $\text{Spec}(R)$
by standard opens can be refined by a finite covering.
Thus suppose that $\text{Spec}(R) = \cup D(f_i)$
for a set of elements $\{f_i\}_{i\in I}$ of $R$. This means that
$\cap V(f_i) = \emptyset$. According to Lemma
\ref{lemma-Zariski-topology} this means that
$V(\{f_i \}) = \emptyset$. According to the
same lemma this means that the ideal generated
by the $f_i$ is the unit ideal of $R$. This means
that we can write $1$ as a {\it finite} sum:
$1 = \sum_{i \in J} r_i f_i$ with $J \subset I$ finite.
And then it follows that $\text{Spec}(R) 
= \cup_{i \in J} D(f_i)$.
\end{proof}

\begin{lemma}
\label{lemma-idempotent-spec}
Let $R$ be a ring. Let $e \in R$ be an idempotent.
In this case
$$
\text{Spec}(R) = D(e) \coprod D(1-e).
$$
\end{lemma}

\begin{proof}
Note that an idempotent $e$ of a domain is either $1$ or $0$.
Hence we see that
\begin{eqnarray*}
D(e)
& = &
\{ \mathfrak p \in \text{Spec}(R)
\mid
e \not\in \mathfrak p \} \\
& = &
\{ \mathfrak p \in \text{Spec}(R)
\mid
e \not= 0\text{ in }\kappa(\mathfrak p) \} \\
& = &
\{ \mathfrak p \in \text{Spec}(R)
\mid
e = 1\text{ in }\kappa(\mathfrak p) \}
\end{eqnarray*}
Similarly we have
\begin{eqnarray*}
D(1-e)
& = &
\{ \mathfrak p \in \text{Spec}(R)
\mid
1 - e \not\in \mathfrak p \} \\
& = &
\{ \mathfrak p \in \text{Spec}(R)
\mid
e \not= 1\text{ in }\kappa(\mathfrak p) \} \\
& = &
\{ \mathfrak p \in \text{Spec}(R)
\mid
e = 0\text{ in }\kappa(\mathfrak p) \}
\end{eqnarray*}
Since the image of $e$ in any residue field is either $1$ or $0$
we deduce that $D(e)$ and $D(1-e)$ cover all of $\text{Spec}(R)$.
\end{proof}

\begin{lemma}
\label{lemma-spec-product}
Let $R_1$ and $R_2$ be rings.
Let $R = R_1 \times R_2$. 
The maps $R \to R_1$, $(x,y) \mapsto x$ and $R \to R_2$,
$(x,y) \mapsto y$
induce continuous maps $\text{Spec}(R_1) \to \text{Spec}(R)$ and
$\text{Spec}(R_2) \to \text{Spec}(R)$.
The induced map
$$
\text{Spec}(R_1) \coprod \text{Spec}(R_2) 
\longrightarrow
\text{Spec}(R)
$$
is a homeomorphism. In other words,
the spectrum of $R = R_1\times R_2$ is the
disjoint union of the spectrum of $R_1$ and the
spectrum of $R_2$.
\end{lemma}

\begin{proof}
Write $1 = e_1 + e_2$ with $e_1 = (1,0)$ and $e_2 = (0,1)$.
Note that $e_1$ and $e_2 = 1 - e_1$ are idempotents.
We leave it to the reader to show that
$R_1 = R_{e_1}$ is the localization of $R$ at $e_1$.
Similarly for $e_2$.
Thus the statement of the lemma follows from Lemma
\ref{lemma-idempotent-spec} combined with Lemma
\ref{lemma-standard-open}.
\end{proof}

\begin{lemma}
\label{lemma-disjoint-decomposition}
Let $R$ be a ring. For each $U \subset \text{Spec}(R)$
which is open and closed
there exists a unique idempotent $e \in R$ such that
$U = D(e)$. This induces a 1-1 correspondence between
open and closed subsets $U \subset \text{Spec}(R)$ and
idempotents $e \in R$.
\end{lemma}

\begin{proof}[First proof of Lemma \ref{lemma-disjoint-decomposition}]
Let $U \subset \text{Spec}(R)$ be open and closed.
Since $U$ is closed it is quasi-compact by
Lemma \ref{lemma-quasicompact}, and similarly for
its complement.
Write $U = \bigcup_{i=1}^n D(f_i)$ as a finite union of standard opens.
Similarly, write $\text{Spec}(R) \setminus U = \bigcup_{j=1}^m D(g_j)$
as a finite union of standard opens. Since $\emptyset =
D(f_i) \cap D(g_j) = D(f_i g_j)$ we see that $f_i g_j$ is
nilpotent by Lemma \ref{lemma-Zariski-topology}.
Let $I = (f_1, \ldots, f_n) \subset R$ and let
$J = (g_1, \ldots, g_m) \subset R$.
Note that $V(J)$ equals $U$, that $V(I)$
equals the complement of $U$, so $\text{Spec}(R) = V(I) \coprod V(J)$.
By the remark on nilpotency above,
we see that $(IJ)^N = (0)$ for some sufficiently large integer $N$.
Since $\bigcup D(f_i) \cup \bigcup D(g_j) = \text{Spec}(R)$
we see that $I + J = R$, see Lemma \ref{lemma-Zariski-topology}.
By raising this equation to the $2N$th power we conclude that
$I^N + J^N = R$. Write $1 = x + y$ with $x \in I^N$ and $y \in J^N$.
Then $1 = (x + y)^2 = x^2 + y^2$ because $I^N J^N = (0)$.
Then $z = x - x^2 \in I^N \cap J^N$. Thus $zx = 0$ and $z^2 = 0$.
Hence $(x - z) - (x - z)^2 = x - x^2 - z = 0$.
In other words, $e = x - z$ is an idempotent contained in
$I^N \subset I$, and the idempotent $e' = 1 - e = y + z$
is contained in $J^N \subset J$. This shows that the
idempotent $e$ maps to $1$ in every residue field
$\kappa(\mathfrak p)$ for $\mathfrak p \in V(J)$ and
that $e$ maps to $0$ in $\kappa(\mathfrak p)$
for every $\mathfrak p \in V(I)$.

\medskip\noindent
To see uniqueness suppose that $e_1, e_2$ are
distinct idempotents in $R$. We have to show there
exists a prime $\mathfrak p$ such that $e_1 \in \mathfrak p$
and $e_2 \not \in \mathfrak p$, or conversely.
Write $e_i' = 1 - e_i$. If $e_1 \not = e_2$, then
$0 \not = e_1 - e_2  = e_1(e_2 + e_2') - (e_1 + e_1')e_2
= e_1 e_2' - e_1' e_2$. Hence either the idempotent
$e_1 e_2' \not = 0$ or $e_1' e_2 \not = 0$. An idempotent
is not nilpotent, and hence we find a prime 
$\mathfrak p$ such that either $e_1e_2' \not \in \mathfrak p$
or $e_1'e_2 \not \in \mathfrak p$, by Lemma \ref{lemma-Zariski-topology}.
It is easy to see this gives the desired prime.
\end{proof}

\begin{proof}[Second proof of Lemma \ref{lemma-disjoint-decomposition}]
Having assured ourselves that for generators ${f_1,...,f_n}$ for the unit ideal
of a ring $R$ the sequence

\[
0 \rightarrow R \rightarrow \bigoplus_{i=1}^ {n} R_{f_{i}} \rightarrow 
\bigoplus_{i,j} R_{f_{i}f_{j}}
\]

\noindent is exact, we now provide an alternate proof of the surjectivity of
the map from idempotents $e$ of $R$ to open and closed subsets of
$\text{Spec}(R)$ 
presented in Lemma \ref{lemma-disjoint-decomposition}.

Let $U \subset \text{Spec}(R)$ be open and closed, and $W$ be its
complement. We can 
write $U$ and $V$ as unions of standard opens such that
$U = \bigcup_{i=1}^{n}  D(f_i)$ and
$W = \bigcup_{j=1}^{m} D(g_j)$.  Since
$\text{Spec}(R) = \bigcup D(f_i) \cup \bigcup D(g_j)$,
we observe that the collection $\{ f_i;g_j\}$ must 
generate the unit ideal in $R$ by Lemma \ref{lemma-Zariski-topology}. 
So the following sequence is exact.

\begin{equation}
\label{idempotent-exact-sequence}
0 \rightarrow R \rightarrow \bigoplus_{i=1}^ {n} R_{f_{i}} \oplus 
\bigoplus_{j=1}^{m} R_{g_j}
\rightarrow
\bigoplus_{i_1,i_2} R_{f_{i_1}f_{i_2}} 
\oplus \bigoplus_{i,j} R_{f_{i}g_{j}}
\oplus \bigoplus_{j_1,j_2} R_{g_{j_1}g_{j_2}}
\end{equation}

\noindent
However, notice that for any pair $i,j$,
$D(f_i) \cap D(g_j) = \emptyset$
since $D(f_i) \subset U$ and $D(g_j) \subset W)$. From part (15) 
of Lemma \ref{lemma-Zariski-topology}
we recall that $D(f_i g_j) = D(f_i) \cap D(g_j) = \emptyset$. Therefore by 
Lemma \ref{lemma-spec-localization}
$\text{Spec}(R_{f_i g_j} = D(f_i g_j) = \emptyset$,
implying that $R_{f_i g_j}$ is the 
zero ring for each pair $i,j$ by part (3) of
Lemma \ref{lemma-Zariski-topology}. 
Consider the element
$(1,...1,0,...0) \in \bigoplus_{i=1}^ {n} R_{f_{i}}
\oplus \bigoplus_{j=1}^{m} R_{g_j}$
whose coordinates are $1$ in each $R_{f_i}$ and 
$0$ in each $R_{g_j}$. This is sent to $0$ under the map 

\[
\beta: \bigoplus_{i=1}^ {n} R_{f_{i}} \oplus \bigoplus_{j=1}^{m} R_{g_j} 
\rightarrow \bigoplus_{i_1,i_2} R_{f_{i_1}f_{i_2}} \oplus \bigoplus_{j_1,j_2} 
R_{g_{j_1}g_{j_2}}
\] 

\noindent
so by the exactness of the sequence 
\eqref{idempotent-exact-sequence}, there must be some element of $R$ whose 
image under $\alpha$ is $(1,...,1,0,...,0)$. Call it $e$. We see that 
$\alpha(e^2) = \alpha(e)^2 = (1,...,1,0,...,0) = \alpha(e)$. Since $\alpha$ is 
injective, $e = e^2$ in $R$ and $e$ is an idempotent of $R$. We claim that
$U = D(e)$.
Notice that for arbitrary $j$, the map $R \rightarrow R_{g_j}$ maps $e$ 
to $0$. Therefore there must be some positive integer $k_j$ such that 
$g_j^{k_j}(e-0) = 0$ in $R$. Multiplying by $e$ as necessary,
we see that $(g_j e)^{k_j} = 0$,
so $g_j e$ is nilpotent in $R$. By
Lemma \ref{lemma-Zariski-topology}
$D(g_j) \cap D(e) = D(g_j e) = \emptyset$. So since
$V = \bigcup D(g_j)$, $D(e) \cap V = \emptyset$ and
$D(e) \subset U$. Furthermore, for arbitrary $i$, the 
map $R \rightarrow R_{f_i}$ maps $e$ to $1$, so there must be some $l_i$ such 
that $f_i^{l_i}(e-1) =0$ in $R$. Hence $f_i^{l_i}e = f_i^{l_i}$. Suppose 
$\mathfrak{p} \in \text{Spec}(R)$ contains $e$,
then $\mathfrak{p}$ contains  
$f_i^{l_i}e = f_i^{l_i}$, and since $\mathfrak{p}$ is prime, $f_i \in 
\mathfrak{p}$. So $V(e) \subset V(f_i)$, implying that $D(f_i) \subset D(e)$. 
Therefore $U = \bigcup D(f_i) \subset D(e)$, and $U = D(e)$.
Therefore any open 
and closed subset of $\text{Spec}(R)$ is the standard open
of an idempotent as 
desired. 
\end{proof}

\begin{lemma}
\label{lemma-characterize-spec-connected}
Let $R$ be a ring. Then $\text{Spec}(R)$ is
connected if and only if $R$ has no nontrivial
idempotents.
\end{lemma}

\begin{proof}
Obvious from Lemma \ref{lemma-disjoint-decomposition} above.
\end{proof}

\begin{lemma}
\label{lemma-irreducible}
Let $R$ be a ring.
\begin{enumerate}
\item For a prime $\mathfrak p \subset R$ the closure
of $\{\mathfrak p\}$ in the Zariski topology is $V(\mathfrak p)$.
In a formula $\overline{\{\mathfrak p\}} = V(\mathfrak p)$.
\item The irreducible closed subsets of $\text{Spec}(R)$ are
exactly the subsets $V(\mathfrak p)$, with $\mathfrak p \subset R$
a prime.
\item The irreducible components (see Topology,
Definition \ref{topology-definition-irreducible-components})
of $\text{Spec}(R)$ are  exactly the subsets $V(\mathfrak p)$,
with $\mathfrak p \subset R$ a minimal prime.
\end{enumerate}
\end{lemma}

\begin{proof}
Note that if $ \mathfrak p \in V(I)$, then
$I \subset \mathfrak p$. Hence,
clearly $\overline{\{\mathfrak p\}} = V(\mathfrak p)$.
In particular $V(\mathfrak p)$ is the closure of
a singleton and hence irreducible.
The second assertion implies the third.
To show the second, let
$V(I) \subset \text{Spec}(R)$ with $I$ a radical ideal.
If $I$ is not prime, then choose $a,b\in R$, $a,b\not \in I$
with $ab\in I$. In this case $V(I,a) \cup V(I,b) = V(I)$,
but neither $V(I,b) = V(I)$ nor $V(I,a) = V(I)$, by
Lemma \ref{lemma-Zariski-topology}. Hence $V(I)$ is not
irreducible.
\end{proof}

\noindent
In other words, this lemma shows that every irreducible closed
subset of $\text{Spec}(R)$ is of the form $V(\mathfrak p)$ for
some prime $\mathfrak p$. Since $V(\mathfrak p) = \overline{\{\mathfrak p\}}$
we see that each irreducible closed subset has a unique generic point,
see Topology, Definition \ref{topology-definition-generic-point}.
In particular, $\text{Spec}(R)$ is a sober topological space.

\begin{lemma}
\label{lemma-minimal-prime-reduced-ring}
Let $\mathfrak p$ be a minimal prime of a ring $R$.
Every element of the maximal ideal of $R_{\mathfrak p}$
is nilpotent. If $R$ is reduced then $R_{\mathfrak p}$
is a field.
\end{lemma}

\begin{proof}
If some element $x$ of ${\mathfrak p}R_{\mathfrak p}$
is not nilpotent, then $D(x) \not = \emptyset$, see
Lemma \ref{lemma-Zariski-topology}. This contradicts
the minimality of $\mathfrak p$. If $R$ is reduced,
then ${\mathfrak p}R_{\mathfrak p} = 0$ and
hence it is a field.
\end{proof}

\begin{lemma}
\label{lemma-reduced-ring-sub-product-fields}
Let $R$ be a reduced ring.
Then $R$ is a subring of a product of fields.
In fact, $R \subset \prod_{\mathfrak p\text{ minimal}} R_{\mathfrak p}$
is such an embedding.
\end{lemma}

\begin{proof}
This is clear from Lemma \ref{lemma-minimal-prime-reduced-ring} above
and the fact that $\bigcup_{\mathfrak p} \mathfrak p = (0)$
in a reduced ring, see Lemma \ref{lemma-Zariski-topology}.
\end{proof}


\begin{lemma}
\label{lemma-characterize-local-ring}
Let $R$ be a ring. The following are equivalent:
\begin{enumerate}
\item $R$ is a local ring,
\item $\text{Spec}(R)$ has exactly one closed point, and
\item $R$ has a maximal ideal $\mathfrak m$
and every element of $R \setminus \mathfrak m$
is a unit.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $R$ be a ring, and $\mathfrak m$ a maximal ideal.
If $x \in R \setminus \mathfrak m$, and $x$ is not a unit
then there is a maximal ideal $\mathfrak m'$ containing
$x$. Hence $R$ has at least two maximal ideals. Conversely,
if $\mathfrak m'$ is another maximal ideal, then choose
$x \in \mathfrak m'$, $x \not \in \mathfrak m$. Clearly
$x$ is not a unit. This proves the equivalence of the
first and last conditions. The equivalence of the first
two is tautological.
\end{proof}





















\section{Images and ring maps of finite presentation}
\label{section-images-finite-presentation}

\noindent
In this section we prove some results on the 
topology of maps $\text{Spec}(S) \to \text{Spec}(R)$
induced by ring maps $R \to S$, mainly Chevalley's Theorem.
In order to do this we will use the notions of constructible sets,
quasi-compact sets, retrocompact sets, and so on
which are defined in Topology, Section \ref{topology-section-quasi-compact}.

\begin{lemma}
\label{lemma-qc-open}
Let $U \subset \text{Spec}(R)$ be open. The following
are equivalent:
\begin{enumerate}
\item $U$ is retrocompact in $\text{Spec}(R)$,
\item $U$ is quasi-compact, and
\item $U$ is a finite union of standard opens.
\end{enumerate}
\end{lemma}

\begin{proof}
The implication (2)$\Rightarrow$(3) is immediate from the fact that standard
opens form a basis for the topology. Each standard open is
homeomorphic to the spectrum of a ring and hence quasi-compact,
by Lemmas \ref{lemma-quasicompact} and \ref{lemma-standard-open}.
Hence a finite union of standard opens is quasi-compact as well.
To finish it suffices to show that a finite union
$\bigcup_{i=1\ldots n} D(f_i)$ is retrocompact in $\text{Spec}(R)$.
In order to do this it suffices to show that 
$(\bigcup_{i=1\ldots n} D(f_i)) \cap (\bigcup_{j=1\ldots m} D(g_j))$
is quasi-compact, which is clear because it equals
$\bigcup_{i,j} D(f_i g_j)$.
\end{proof}

\begin{lemma}
\label{lemma-affine-map-quasi-compact}
Let $\varphi : R \to S$ be a ring map.
The induced continuous map $f : \text{Spec}(S) \to \text{Spec}(R)$
is quasi-compact. For any constructible set $E \subset \text{Spec}(R)$
the inverse image $f^{-1}(E)$ is constructible in $\text{Spec}(S)$.
\end{lemma}

\begin{proof}
We first show that the inverse image of any quasi-compact
open $U \subset \text{Spec}(R)$ is quasi-compact. By
Lemma \ref{lemma-qc-open} we may write $U$ as a finite
open of standard opens. Thus by Lemma \ref{lemma-spec-functorial}
we see that $f^{-1}(U)$ is a finite union of standard opens.
Hence $f^{-1}(U)$ is quasi-compact by Lemma \ref{lemma-qc-open} again.
The second assertion now follows from Topology, Lemma 
\ref{topology-lemma-inverse-images-constructibles}.
\end{proof}

\begin{lemma}
\label{lemma-constructible-is-image}
Let $R$ be a ring and let $T \subset \text{Spec}(R)$
be constructible. Then there exists a ring map $R \to S$ of
finite presentation such that $T$ is the image of
$\text{Spec}(S)$ in $\text{Spec}(R)$.
\end{lemma}

\begin{proof}
Let $T \subset \text{Spec}(R)$ be constructible.
The spectrum of a finite product of rings 
is the disjoint union of the spectra, see
Lemma \ref{lemma-spec-product}. Hence if $T = T_1 \cup T_2$
and the result holds for $T_1$ and $T_2$, then the
result holds for $T$. In particular we may assume
that $T = U \cap V^c$, where $U, V \subset \text{Spec}(R)$
are retrocompact open. By Lemma \ref{lemma-qc-open} we may write
$T = (\bigcup D(f_i)) \cap (\bigcup D(g_j))^c = 
\bigcup \big(D(f_i) \cap V(g_1,\ldots,g_m)\big)$.
In fact we may assume that $T = D(f) \cap V(g_1,\ldots,g_m)$
(by the argument on unions above).
In this case $T$ is the image of the map
$R \to (R/(g_1,\ldots,g_m))_f$, see Lemmas
\ref{lemma-standard-open} and \ref{lemma-spec-closed}.
\end{proof}

\begin{lemma}
\label{lemma-open-fp}
Let $R$ be a ring.
Let $f$ be an element of $R$.
Let $S = R_f$.
Then the image of a constructible subset of $\text{Spec}(S)$
is constructible in $\text{Spec}(R)$.
\end{lemma}

\begin{proof}
We repeatedly use Lemma \ref{lemma-qc-open} without mention.
Let $U, V$ be quasi-compact open in $\text{Spec}(S)$.
We will show that the image of $U \cap V^c$ is constructible.
Under the identification
$\text{Spec}(S) = D(f)$ of Lemma \ref{lemma-standard-open}
the sets $U, V$ correspond to quasi-compact opens
$U', V'$ of $\text{Spec}(R)$.
Hence it suffices to show that $U' \cap (V')^c$
is constructible in $\text{Spec}(R)$ which is clear.
\end{proof}

\begin{lemma}
\label{lemma-closed-fp}
Let $R$ be a ring.
Let $I$ be a finitely generated ideal of $R$.
Let $S = R/I$.
Then the image of a constructible of $\text{Spec}(S)$
is constructible in $\text{Spec}(R)$.
\end{lemma}

\begin{proof}
If $I = (f_1,\ldots,f_m)$, then we see that
$V(I)$ is the complement of $\bigcup D(f_i)$,
see Lemma \ref{lemma-Zariski-topology}.
Hence it is constructible, by Lemma \ref{lemma-qc-open}.
Denote the map $R \to S$ by $f \mapsto \overline{f}$.
We have to show that if $\overline{U}, \overline{V}$
are retrocompact opens of $\text{Spec}(S)$, then the
image of $\overline{U} \cap \overline{V}^c$
in $\text{Spec}(R)$ is constructible.
By Lemma \ref{lemma-qc-open} we may write
$\overline{U} = \bigcup D(\overline{g_i})$.
Setting $U = \bigcup D({g_i})$ we see $\overline{U}$
has image $U \cap V(I)$ which is constructible in
$\text{Spec}(R)$. Similarly the image of $\overline{V}$ equals
$V \cap V(I)$ for some retrocompact open $V$ of $\text{Spec}(R)$.
Hence the image of $\overline{U} \cap \overline{V}^c$
equals $U \cap V(I) \cap V^c$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-affineline-open}
Let $R$ be a ring. The map $\text{Spec}(R[x]) \to \text{Spec}(R)$
is open, and the image of any standard open is a quasi-compact
open.
\end{lemma}

\begin{proof}
It suffices to show that the image of a standard open
$D(f)$, $f\in R[x]$ is quasi-compact open.
The image of $D(f)$ is the image of
$\text{Spec}(R[x]_f) \to \text{Spec}(R)$.
Let $\mathfrak p \subset R$ be a prime ideal.
Let $\overline{f}$ be the image of $f$ in
$\kappa(\mathfrak p)[x]$.
Recall, see Lemma \ref{lemma-in-image},
that $\mathfrak p$ is in the image
if and only if $R[x]_f \otimes_R \kappa(\mathfrak p) =
\kappa(\mathfrak p)[x]_{\overline{f}}$ is not the
zero ring. This is exactly the condition that $f$ does not map
to zero in $\kappa(\mathfrak p)[x]$, in other words, that
some coefficient of $f$ is not in $\mathfrak p$.
Hence we see: if $f = a_d x^d + \ldots a_0$, then
the image of $D(f)$ is $D(a_d) \cup \ldots \cup D(a_0)$.
\end{proof}

\noindent
We prove a property of characteristic polynomials which
will be used below.

\begin{lemma}
\label{lemma-characteristic-polynomial-prime}
Let $R \to A$ be a ring homomorphism.
Assume $A \cong R^{\oplus n}$ as an $R$-module.
Let $f \in A$. The multiplication map $m_f: A
\to A$ is $R$-linear and hence
has a characteristic polynomial
$P(T) = T^n + r_{n-1}T^{n-1} + \cdots + r_0 \in R[T]$.
For any prime
$\mathfrak{p} \in \text{Spec} R$, $f$ acts nilpotently on $A
\otimes_R \kappa(\mathfrak{p})$ if and only if $\mathfrak p \in
V(r_0,\ldots, r_{n-1})$.
\end{lemma}

\begin{proof}
This follows quite easily once we prove that the characteristic
polynomial $\bar P(T) \in \kappa(\mathfrak p)[T]$ of the
multiplication map $m_{\bar f}: A \otimes_R \kappa(\mathfrak p) \to
A \otimes_R \kappa(\mathfrak p)$ which multiplies elements of $A
\otimes_R \kappa(\mathfrak p)$ by $\bar f$, the image of $f$ viewed in
$\kappa(\mathfrak p)$, is just the image of $P(T)$ in
$\kappa(\mathfrak p)[T]$. Let $(a_{ij})$ be the matrix of the map
$m_f$ with entries in $R$, using a basis $e_1, \ldots, e_n$
of $A$ as an $R$-module.
Then, $A \otimes_R \kappa(\mathfrak p) \cong (R \otimes_R
\kappa(\mathfrak p))^{\oplus n} = \kappa(\mathfrak p)^n$, which is
an $n$-dimensional vector space over $\kappa(\mathfrak p)$ with
basis $e_1 \otimes 1,\ldots, e_n \otimes 1$. The image $\bar f = f
\otimes 1$, and so the multiplication map $m_{\bar f}$ has matrix
$(a_{ij} \otimes 1)$. Thus, the characteristic polynomial is
precisely the image of $P(T)$.

\medskip\noindent
From linear algebra, we know that a linear transformation acts
nilpotently on an $n$-dimensional vector space if and only if the
characteristic polynomial is $T^n$ (since the characteristic
polynomial divides some power of the minimal polynomial). Hence,
$f$ acts nilpotently on $A \otimes_R \kappa(\mathfrak p)$ if and
only if $\bar P(T) = T^n$. This occurs if and only if $r_i \in
\mathfrak p$ for all $0 \leq i \leq n - 1$, that is when $\mathfrak p \in
V(r_0,\ldots, r_{n - 1}).$
\end{proof}

\begin{lemma}
\label{lemma-affineline-special}
Let $R$ be a ring. Let $f, g \in R[x]$ be polynomials.
Assume the leading coefficient of $g$ is a unit of $R$.
There exists elements $r_i\in R$, $i=1\ldots,n$ such that
the image of $D(f) \cap V(g)$ in $\text{Spec}(R)$ is
$\bigcup_{i=1,\ldots,n} D(r_i)$.
\end{lemma}

\begin{proof}
Write $g = ux^d + a_{d-1}x^{d-1} + \ldots a_0$, where
$d$ is the degree of $g$, and hence $u \in R^*$.
Consider the ring $A = R[x]/(g)$.
It is, as an $R$-module, finite free with basis the images
of $1,x,\ldots,x^{d-1}$. Consider multiplication
by (the image of) $f$ on $A$. This is an $R$-module map.
Hence we can let $P(T) \in R[T]$ be the characteristic polynomial
of this map. Write $P(T) = T^d + r_{d-1} T^{d-1} + \ldots r_0$.
We claim that $r_0, \ldots, r_{d-1}$ have the desired property.
We will use below the property of characteristic polynomials 
that
$$
\mathfrak p \in V(r_0, \ldots, r_{d-1})
\Leftrightarrow
\text{multiplication by }f\text{ is nilpotent on }
A\otimes_R \kappa(\mathfrak p).
$$
This was proved in Lemma \ref{lemma-characteristic-polynomial-prime} above.

\medskip\noindent
Suppose $\mathfrak q\in D(f) \cap V(g)$, and let
$\mathfrak p = \mathfrak q \cap R$. Then there is a nonzero map
$A\otimes_R \kappa(\mathfrak p) \to \kappa(\mathfrak q)$ which
is compatible with multiplication by $f$.
And $f$ acts as a unit on $\kappa(\mathfrak q)$. 
Thus we conclude $\mathfrak p \not \in  V(r_0, \ldots, r_{d-1})$.

\medskip\noindent
On the other hand, suppose that $r_i \not\in \mathfrak p$ for some
prime $\mathfrak p$ of $R$ and some $0 \leq i \leq d - 1$.
Then multiplication by $f$ is not nilpotent on the algebra
$A \otimes_R \kappa(\mathfrak p)$.
Hence there exists a maximal ideal $\overline{\mathfrak q} \subset
A \otimes_R \kappa(\mathfrak p)$ not containing the image of $f$.
The inverse image of $\overline{\mathfrak q}$ in $R[x]$ 
is an element of $D(f) \cap V(g)$ mapping to $\mathfrak p$.
\end{proof}

\begin{theorem}
\label{theorem-chevalley}
Chevalley's Theorem.
Suppose that $R \to S$ is of finite presentation.
The image of a constructible subset of
$\text{Spec}(S)$ in $\text{Spec}(R)$ is constructible.
\end{theorem}

\begin{proof}
Write $S = R[x_1,\ldots,x_n]/(f_1,\ldots,f_m)$.
We may factor $R \to S$ as $R \to R[x_1] \to R[x_1,x_2]
\to \ldots \to R[x_1,\ldots,x_{n-1}] \to S$. Hence 
we may assume that $S = R[x]/(f_1,\ldots,f_m)$.
In this case we factor the map as $R \to R[x] \to S$,
and by Lemma \ref{lemma-closed-fp} we reduce to
the case $S = R[x]$. By Lemma \ref{lemma-qc-open} suffices
to show that if
$T = (\bigcup_{i=1\ldots n} D(f_i)) \cap V(g_1,\ldots,g_m)$ 
for $f_i , g_j \in R[x]$ then the image in $\text{Spec}(R)$ is
constructible. Since finite unions of constructible sets
are constructible, it suffices to deal with the case $n=1$,
i.e., when $T = D(f) \cap V(g_1,\ldots,g_m)$.

\medskip\noindent
Note that if $c \in R$, then we have $\text{Spec}(R) =
V(c) \coprod D(c) = \text{Spec}(R/(c)) \coprod
\text{Spec}(R_c))$, and correspondingly $\text{Spec}(R[x]) =
V(c) \coprod D(c) = \text{Spec}(R/(c)[x]) \coprod 
\text{Spec}(R_c[x]))$. The intersection of $T = D(f) \cap V(g_1,\ldots,g_m)$
with each part still has the same shape, with $f$, $g_i$ replaced
by their images in $R/(c)[x]$, respectively $R_c[x]$.
Note that the image of $T$
in $\text{Spec}(R)$ is the union of the image of
$T \cap V(c)$ and $T \cap D(c)$. Using Lemmas \ref{lemma-open-fp}
and \ref{lemma-closed-fp} it suffices to prove the images of both
parts are constructible in $\text{Spec}(R/(c))$, respectively
$\text{Spec}(R_c)$.

\medskip\noindent
Let us assume we have $T = D(f) \cap V(g_1,\ldots,g_m)$
as above, with $\deg(g_1) \leq \deg(g_2) \leq \ldots \leq \deg(g_m)$.
We are going to use descending induction on $m$, and on the 
degrees of the $g_i$. Let $d = \deg(g_1)$, i.e., $g_1 = c x^{d_1} + l.o.t$
with $c \in R$ not zero. Cutting $R$ up into the pieces
$R/(c)$ and $R_c$ we either lower the degree of $g_1$ (and this
is covered by induction)
or we reduce to the case where $c$ is invertible.
If $c$ is invertible, and $m > 1$, then write
$g_2 = c' x^{d_2} + l.o.t$. In this case consider
$g_2' = g_2 - (c'/c) x^{d_2 - d_1} g_1$. Since the ideals
$(g_1, g_2, \ldots, g_m)$ and $(g_1, g_2', g_3, \ldots, g_m)$
are equal we see that $T = D(f) \cap V(g_1,g_2',g_3\ldots,g_m)$.
But here the degree of $g_2'$ is strictly less than the degree
of $g_2$ and hence this case is covered by induction.

\medskip\noindent
The bases case for the induction above are the cases
(a) $T = D(f) \cap V(g)$ where the leading coefficient
of $g$ is invertible, and (b) $T = D(f)$. These two cases
are dealt with in Lemmas \ref{lemma-affineline-special}
and \ref{lemma-affineline-open}.
\end{proof}

\begin{lemma}
\label{lemma-generic-finite-presentation}
Let $R \subset S$ be an inclusion of domains.
Assume that $R \to S$ is of finite type.
There exists a nonzero $f \in R$, and a nonzero $g \in S$
such that $R_f \to S_{fg}$ is of finite presentation.
\end{lemma}

\begin{proof}
By induction on the number of generators of
$S$ over $R$.

\medskip\noindent
Suppose that $S$ is generated by a single element
over $R$. Then $S = R[x]/\mathfrak q$ for some
prime ideal $\mathfrak q \subset R[x]$. If $\mathfrak q = (0)$
there is nothing to prove. If $\mathfrak q \not = (0)$,
then let $g \in \mathfrak q$ be an element with minimal
degree in $x$. Since $K[x] = f.f.(R)[x]$ is a PID we see that
$g$ is irreducible over $K$ and that $f.f.(S) = K[x]/(g)$.
Write $g = a_d x^d + \ldots + a_0$
with $a_i \in R$ and $a_d \not = 0$. After inverting $a_d$
in $R$ we may assume that $g$ is monic. Hence we see that
$R \to R[x]/(g) \to S$ with the last map surjective.
But $R[x]/(g) = R \oplus Rx \oplus \ldots \oplus Rx^{d-1}$
maps injectively into $f.f.(S) = K[x]/(g) = K \oplus Kx \oplus
\ldots \oplus Kx^{d-1}$. Thus $S \cong R[x]/(g)$ is finitely
presented.

\medskip\noindent
Suppose that $S$ is generated by $n > 1$ elements over $R$.
Say $x_1,\ldots,x_n \in S$ generate $S$. Denote $S' \subset S$
the subring generated by $x_1,\ldots,x_{n-1}$. By induction
hypothesis we see that there exist $f\in R$ and $g \in S'$
nonzero such that $R_f \to S'_{fg}$ is of finite presentation.
Next we apply the induction hypothesis to $S'_{fg} \to S_{fg}$
to see that there exist $f' \in S'_{fg}$ and
$g' \in S_{fg}$ such that $S'_{fgf'} \to S_{fgf'g'}$
is of finite presentation. We leave it to the reader to conclude.
\end{proof}

\begin{lemma}
\label{lemma-characterize-image-finite-type}
Let $R \to S$ be a finite type ring map.
Denote $X = \text{Spec}(R)$ and $Y = \text{Spec}(S)$.
Write $f : Y \to X$ the induced
map of spectra. Let $E \subset Y = \text{Spec}(S)$ be a
constructible set.
If a point $\xi \in X$ is in $f(E)$, then
$\overline{\{\xi\}} \cap f(E)$ contains an open
dense subset of $\overline{\{\xi\}}$.
\end{lemma}

\begin{proof}
Let $\xi \in X$ be a point of $f(E)$. Choose a point $\eta \in E$
mapping to $\xi$. Let $\mathfrak p \subset R$ be the prime
corresponding to $\xi$ and let $\mathfrak q \subset S$ be the
prime corresponding to $\eta$. Consider the diagram
$$
\xymatrix{
\eta \ar[r] \ar@{|->}[d] & E \cap Y' \ar[r] \ar[d] &
Y' = \text{Spec}(S/\mathfrak q) \ar[r] \ar[d] &
Y \ar[d] \cr
\xi \ar[r] & f(E) \cap X' \ar[r] &
X' = \text{Spec}(R/\mathfrak p) \ar[r] &
X 
}
$$
It follows from this diagram that we may replace $X$ by $X'$ and
$Y$ by $Y'$. Hence we may assume that $R \subset S$ is an
inclusion of domains, $\xi$ is the generic
point of $X$, and $\eta$ is the generic point of $Y$.
By Lemma \ref{lemma-generic-finite-presentation}
combined with Chevalley's theorem \ref{theorem-chevalley}
we see that there exist dense opens $U \subset X$,
$V \subset Y$ such that $f(V) \subset U$ and
such that $f : V \to U$ maps constructible sets
to constructible sets. Note that $E \cap V$ is
constructible in $V$, see Topology,
Lemma \ref{topology-lemma-open-immersion-constructible-inverse-image}.
Hence $f(E \cap V)$ is constructible in $U$ and contains $\xi$.
By Topology, Lemma \ref{topology-lemma-generic-point-in-constructible}
we see that $f(E \cap V)$ contains a dense open $U' \subset U$.
\end{proof}

\noindent
At the end of this section we present a few more results on
images of maps on Spectra that have nothing to do with constructible
sets.

\begin{lemma}
\label{lemma-surjective-spec-radical-ideal}
Let $\varphi : R \to S$ be a ring map.
The following are equivalent:
\begin{enumerate}
\item The map $\text{Spec}(S) \to \text{Spec}(R)$ is surjective.
\item For any radical ideal $I \subset R$
the inverse image of $IS$ in $R$ is equal to $I$.
\item For every prime $\mathfrak p$ of $R$ the inverse
image of $\mathfrak p S$ in $R$ is $\mathfrak p$.
\end{enumerate}
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-Zariski-topology} we have
$I = \bigcap_{I \subset \mathfrak p} \mathfrak p$.
By Lemma \ref{lemma-in-image} we have $\mathfrak p
= \varphi^{-1}(\mathfrak p S)$ if and only if
$\mathfrak p$ is in the image.
The result follows easily from these facts.
\end{proof}

\begin{lemma}
\label{lemma-domain-image-dense-set-points-generic-point}
Let $R$ be a domain. Let $\varphi : R \to S$ be a ring map.
The following are equivalent:
\begin{enumerate}
\item The ring map $R \to S$ is injective.
\item The image $\text{Spec}(S) \to \text{Spec}(R)$
contains a dense set of points.
\item There exists a prime ideal $\mathfrak q \subset S$
whose inverse image in $R$ is $(0)$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $K$ be the field of fractions of the domain $R$.
Assume that $R \to S$ is injective. Since localization
is exact we see that $K \to S \otimes_R K$ is injective.
Hence there is a prime mapping to $(0)$ by
Lemma \ref{lemma-in-image}.

\medskip\noindent
Note that $(0)$ is dense in $\text{Spec}(R)$, so that the
last condition implies the second.

\medskip\noindent
Suppose the second condition holds. Let $f \in R$,
$f \not = 0$. As $R$ is a domain we see that $V(f)$
is a proper closed subset of $R$. By assumption
there exists a prime $\mathfrak q$
of $S$ such that $\varphi(f) \not \in \mathfrak q$.
Hence $\varphi(f) \not = 0$.
Hence $R \to S$ is injective.
\end{proof}















\section{Noetherian rings}
\label{section-Noetherian}

\noindent
A ring $R$ is {\it Noetherian} if any ideal of $R$ is
finitely generated. It is clearly equivalent to the
ascending chain condition for ideals of $R$.

\begin{lemma}
\label{lemma-Noetherian-permanence}
Any finitely generated ring over a Noetherian ring
is Noetherian. Any localization of a Noetherian ring
is Noetherian.
\end{lemma}

\begin{proof}
The statement on localizations follows from the fact
that any ideal $J \subset S^{-1}R$ is of the form
$I \cdot S^{-1}R$. Any quotient $R/I$ of a Noetherian
ring $R$ is Noetherian because any ideal $\overline{J} \subset R/I$
is of the form $J/I$ for some ideal $I \subset J \subset R$.
Thus it suffices to show that if $R$ is Noetherian so
is $R[X]$. Suppose $J_1 \subset J_2 \subset \ldots$ is an
acsending chain of ideals in $R[X]$. Consider the ideals $I_{i,d}$
defined as the ideal of elements of $R$ which occur as leading
coefficients of degree $d$ polynomials in $J_i$.
Clearly $I_{i, d} \subset I_{i', d'}$ whenever
$i \leq i'$ and $d \leq d'$. By the ascending chain condition
in $R$ there are at most finitely many distinct ideals among all of
the $I_{i,d}$.
(Hint: Any infinite set of elements of
$\mathbf{N} \times \mathbf{N}$ contains an increasing
infinite sequence.)
Take $i_0$ so large that $I_{i, d} = I_{i_0, d}$
for all $i \geq i_0$ and all $d$. Suppose $f \in J_i$ for some $i \geq i_0$.
By induction on the degree $d = \deg(f)$ we show that $f \in J_{i_0}$.
Namely, there exists a $g\in J_{i_0}$ whose degree is $d$ and which
has the same leading coefficient as $f$. By induction
$f - g \in J_{i_0}$ and we win.
\end{proof}

\noindent
The following lemma, allthough easy, is usefull because
finite type $\mathbf{Z}$-algebras come up quite often in
a technique called ``absolute Noetherian reduction''.

\begin{lemma}
\label{lemma-obvious-Noetherian}
Any finite type algebra over a field is Noetherian.
Any finite type algebra over $\mathbf{Z}$ is Noetherian.
\end{lemma}

\begin{proof}
This is immediate from the above and the fact that
$\mathbf{Z}$ is a Noetherian ring because it is a
principal ideal domain.
\end{proof}

\begin{lemma}
\label{lemma-Noetherian-finite-type-is-finite-presentation}
Let $R$ be a Noetherian ring.
Any finite type $R$-algebra is of finite presentation over $R$.
\end{lemma}

\begin{proof}
The statement is clear because any ideal of
$R[x_1,\ldots,x_n]$ is finitely generated by Lemma
\ref{lemma-Noetherian-permanence} above.
\end{proof}

\begin{lemma}
\label{lemma-Noetherian-topology}
If $R$ is a Noetherian ring then $\text{Spec}(R)$ 
is a Noetherian topological space, see Topology,
Definition \ref{topology-definition-noetherian}.
\end{lemma}

\begin{proof}
This is because any closed subset of $\text{Spec}(R)$
is uniquely of the form $V(I)$ with $I$ a radical ideal,
see Lemma \ref{lemma-Zariski-topology}.
And this correspondence is inclusion reversing.
Thus the result follows from the definitions.
\end{proof}

\begin{lemma}
\label{lemma-Noetherian-irreducible-components}
If $R$ is a Noetherian ring then $\text{Spec}(R)$
has finitely many irreducible components. In other words
$R$ has finitely many minimal primes.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-Noetherian-topology} and
Topology, Lemma \ref{topology-lemma-Noetherian}
we see there are finitely many irreducible components.
By Lemma \ref{lemma-irreducible} these correspond to
minimal primes of $R$.
\end{proof}



















\section{Hilbert Nullstellensatz}
\label{section-nullstellensatz}

\noindent
In this section we first give a quick and dirty proof
of a version of the Hilbert Nullstellensatz for uncountable
fields. After this we prove the general version.

\begin{lemma}
\label{lemma-dimension}
Suppose that $k$ is an uncountable field,
and suppose that $V$ is a nonzero vector
space of countable dimension over $k$.
For any linear operator $T : V \to V$ there exists
some monic polynomial $P(t) \in k[t]$ such that
$P(T)$ is not invertible.
\end{lemma}

\begin{proof}
If not then $V$ inherits the structure of a vector space over
the field $k(t)$. But the dimension of $k(t)$ over $k$ is
uncountable for example due to the fact that the elements
$\frac{1}{T - \lambda}$ are linearly independent.
\end{proof}

\begin{theorem}
\label{theorem-uncountable-nullstellensatz}
Let $k$ be an uncountable field and let $\mathfrak m \subset 
k[x_1, x_2, x_3, \ldots]$ be a maximal ideal of the polynomial
ring in countably many variables.
The field extension $k \subset \kappa(\mathfrak m)$
is algebraic. The same is true for any maximal ideal in
any $k$-algebra generated by countably many elements.
\end{theorem}

\begin{proof}
Of course it suffices to prove the result for $\mathfrak m \subset 
k[x_1, x_2, x_3, \ldots]$, because any countably generated $k$-algebra
is a quotient of one of these. 

\medskip\noindent
To arrive at a contradiction pick
$T \in \kappa(\mathfrak m)$ transcendental over $k$.
Note that the $k$-linear map $T : \kappa(\mathfrak m)
\to \kappa(\mathfrak m)$ given by multiplication by $T$
has the property that $P(T)$ is invertible for all
monic polynomials $P(t) \in k[t]$.
Also, $\kappa(\mathfrak m)$ has countable dimension
over $k$ since it is a quotient of the vector space
$k[x_1, x_2, x_3, \ldots]$ over $k$.
This is impossible by Lemma \ref{lemma-dimension}.
\end{proof}

\begin{example}
Let $k$ be a countable field. Let $x$ be a variable,
and let $k(x)$ be the field of rational functions in $x$.
Consider the polynomial algebra $R = k[x, \{x_f\}_{f \in k[x]-\{0\}}]$.
Let $I = (\{fx_f - 1\}_{f\in k[x] - \{0\}})$. Note that
$I$ is a proper ideal in $R$.
Choose a maximal ideal $I \subset \mathfrak m$.
Then $k \subset R/\mathfrak m$ is isomorphic to
$k(x)$, and is not algebraic over $k$.
\end{example}

\begin{theorem}
\label{theorem-nullstellensatz}
(Hilbert Nullstellensatz)
Let $k$ be a field.
\begin{enumerate}
\item For any maximal ideal $\mathfrak m \subset k[x_1,\ldots,x_n]$
the field extension $k \subset \kappa(\mathfrak m)$ is finite.
\label{finite-kappa}
\item Any radical ideal $I \subset k[x_1,\ldots,x_n]$
is the intersection of maximal ideals containing it.
\label{polynomial-ring-Jacobson}
\end{enumerate}
The same is true in any finite type $k$-algebra.
\end{theorem}

\begin{proof}
It is enough to prove part (\ref{finite-kappa}) of
the theorem for the case of a polynomial
algebra $k[x_1, \ldots, x_n]$, because any finitely generated
$k$-algebra is a quotient of such a polynomial algebra.
We prove this by induction on $n$. The case $n = 0$ is clear.
Suppose that $\mathfrak m$ is a maximal ideal in $k[x_1, \ldots, x_n]$.
Let $\mathfrak p \subset k[x_n]$ be the intersection
of $\mathfrak m$ with $k[x_n]$.

\medskip\noindent
If $\mathfrak p \not = (0)$,
then $\mathfrak p$ is maximal and generated by an irreducible
monic polynomial $P$ (because of the Euclidean algorithm
in $k[x_n]$). Then
$k' = k[x_n]/\mathfrak p$ is a finite field extension of $k$
and contained in $\kappa(\mathfrak m)$. In this case
we get a surjection
$$
k'[x_1, \ldots, x_{n-1}] 
\to
k'[x_1,\ldots,x_n] =
k' \otimes_k k[x_1,\ldots, x_n]
\longrightarrow
\kappa(\mathfrak m)
$$
and hence we see that $\kappa(\mathfrak m)$ is a finite
extension  of $k'$ by induction hypothesis. Thus $\kappa(\mathfrak m)$
is finite over $k$ as well.

\medskip\noindent
If $\mathfrak p = (0)$ we consider the ring
extension $k[x_n] \subset k[x_1, \ldots, x_n]/\mathfrak m$.
This is a finitely generated ring extension, hence
of finite presentation by
Lemmas \ref{lemma-obvious-Noetherian} and
\ref{lemma-Noetherian-finite-type-is-finite-presentation}.
Thus the image of $\text{Spec}(k[x_1, \ldots, x_n]/\mathfrak m)$
in $\text{Spec}(k[x_n])$ is constructible by
Theorem \ref{theorem-chevalley}. Since the image
contains $(0)$ we conclude that it contains a standard
open $D(f)$ for some $f\in k[x_n]$ nonzero. Since clearly
$D(f)$ is infinite we get a contradiction with the
assumption that $k[x_1,\ldots,x_n]/\mathfrak m$ is
a field (and hence has a spectrum consisting of one point).

\medskip\noindent
To prove part (\ref{polynomial-ring-Jacobson}) let
$I \subset R$ be radical, with $R$ of finite type over $k$.
Let $f \in R$, $f \not \in I$. Pick a maximal ideal $\mathfrak m'$
in the nonzero ring $R_f/IR_f = (R/I)_f$. Let $\mathfrak m \subset R$
be the inverse image of $\mathfrak m'$ in $R$. We see that
$I \subset \mathfrak m$
and $f \not \in \mathfrak m$. If we show that $\mathfrak m$ is a maximal
ideal of $R$, then we are done. We clearly have
$$
k \subset R/\mathfrak m \subset \kappa(\mathfrak m').
$$
By part (\ref{finite-kappa}) the field extension
$k \subset \kappa(\mathfrak m')$
is finite. By elementary field theory we conclude that $R/\mathfrak m$
is a field.
\end{proof}






















\section{Jacobson rings}
\label{section-ring-jacobson}

\noindent
Let $R$ be a ring. The closed points of $\text{Spec}(R)$ are the
maximal ideals of $R$. Often rings which occur naturally in algebraic
geometry have lot's of maximal ideals. For example finite type algebras
over a field or over $\mathbf{Z}$. We will show that these
are examples of Jacobson rings.

\begin{definition}
\label{definition-ring-jacobson}
Let $R$ be a ring. We say that $R$ is a
{\it Jacobson ring} if every radical
ideal $I$ is the intersection of the
maximal ideals containing it.
\end{definition}

\begin{lemma}
\label{lemma-finite-type-field-Jacobson}
Any algebra of finite type over a field is Jacobson.
\end{lemma}

\begin{proof}
This follows from Theorem \ref{theorem-nullstellensatz}
and Definition \ref{definition-ring-jacobson}.
\end{proof}

\begin{lemma}
\label{lemma-jacobson-prime}
Let $R$ be a ring. If every prime ideal of $R$ is the
intersection of the maximal ideals containing it,
then $R$ is Jacobson.
\end{lemma}

\begin{proof}
This is immediately clear from the fact that
every radical ideal $I \subset R$ is the
intersection of the primes containing it.
See Lemma \ref{lemma-Zariski-topology}.
\end{proof}

\begin{lemma}
\label{lemma-jacobson}
A ring $R$ is Jacobson if and only if $\text{Spec}(R)$
is Jacobson, see Topology,
Definition \ref{topology-definition-space-jacobson}.
\end{lemma}

\begin{proof}
Suppose $R$ is Jacobson. Let $Z \subset \text{Spec}(R)$
be a closed subset. We have to show that the set of closed
points in $Z$ is dense in $Z$. Let $U \subset \text{Spec}(R)$
be an open such that $U \cap Z$ is nonempty.
We have to show $Z \cap U$ contains a closed point
of $\text{Spec}(R)$. We may
assume $U = D(f)$ as standard opens form a basis for the
topology on $\text{Spec}(R)$. According to
Lemma \ref{lemma-Zariski-topology} we may assume that
$Z = V(I)$, where $I$ is a radical ideal. We see also
that $f \not \in I$. By assumption, there exists a
maximal ideal $\mathfrak m \subset R$ such that
$I \subset \mathfrak m$ but $f \not\in \mathfrak m$.
Hence $\mathfrak m \in D(f) \cap V(I) = U \cap Z$ as desired.

\medskip\noindent
Conversely, suppose that $\text{Spec}(R)$ is Jacobson.
Let $I \subset R$ be a radical ideal. Let
$J = \cap_{I \subset \mathfrak m} \mathfrak m$
be the intersection of the maximal ideals containing $I$.
Clearly $J$ is radical, $V(J) \subset V(I)$, and
$V(J)$ is the smallest closed subset of $V(I)$ containing
all the closed points of $V(I)$. By assumption we see that
$V(J) = V(I)$. But Lemma \ref{lemma-Zariski-topology}
shows there is a bijection between Zariski closed
sets and radical ideals, hence $I = J$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-pid-jacobson}
The ring $\mathbf{Z}$ is a Jacobson ring.
In fact any PID with infinitely many primes
is a Jacobson ring.\footnote{See
Lemma \ref{lemma-noetherian-dim-1-Jacobson}
for a more natural result.}
\end{lemma}

\begin{proof}
Let $R$ be a PID. Apart from the prime $(0)$, the
other primes are maximal ideals. The statement
means that $(0) = \bigcap_{\mathfrak m \subset R} \mathfrak m$
if there exist infinitely many maximal ideals $\mathfrak m$.
Let $\mathfrak m_1, \mathfrak m_2, \ldots$ be pairwise
distinct maximal ideals. Write $\mathfrak m_1 = (x_1)$,
$\mathfrak m_1 \cap \mathfrak m_2 = (x_2)$, 
$\mathfrak m_1 \cap \mathfrak m_2 \cap \mathfrak m_3 = (x_3)$, and so on.
Note that the inclusions $(x_1) \supset (x_2) \supset \ldots $
are all strict (see Lemma \ref{lemma-silly}). 
Suppose $x \in \bigcap \mathfrak m$ is a nonzero element in the intersection
of all the maximal ideals. Then $x = y_1 x_1 = y_2 x_2 = \ldots$
for some $y_i \in R$. Then $(y_1) \subset (y_2) \subset \ldots$
with inclusions all strict (by the above). This contradicts the
fact that $\bigcup (y_i)$ is principal.
\end{proof}

\begin{example}
Let $A$ be an infinite set.
For each $\alpha \in A$, let $k_\alpha$ be a field.
We claim that $R = \prod_{\alpha\in A} k_\alpha$ is Jacobson.
First, note that any element $f \in R$ has the form
$f = ue$, with $u \in R$ a unit and $e\in R$ an idempotent
(left to the reader). 
Hence $D(f) = D(e)$, and $R_f = R_e = R/(1-e)$ is a quotient of $R$.
Actually, any ring with this property is Jacobson.
Namely, say $\mathfrak p \subset R$ is a prime ideal
and $f \in R$, $f \not \in \mathfrak p$. We have to find
a maximal ideal $\mathfrak m$ of $R$ such that
$\mathfrak p \subset \mathfrak m$ and $f \not\in \mathfrak m$.
Because $R_f$ is a quotient of $R$ we see that any maximal
ideal of $R_f$ corresponds to a maximal ideal of $R$
not containing $f$. Hence the result follows 
by choosing a maximal ideal of $R_f$ containing $\mathfrak p R_f$.
\end{example}

\begin{example}
\label{example-not-jacobson}
A domain $R$ with finitely many maximal ideals
$\mathfrak m_i$, $i = 1, \ldots, n$ is not a
Jacobson ring, except when it is a field.
Namely, in this case $(0)$ is not the intersection
of the maximal ideals $(0) \not=
\mathfrak m_1 \cap \mathfrak m_2 \cap \ldots \cap \mathfrak m_n
\supset \mathfrak m_1 \cdot \mathfrak m_2 \cdot \ldots
\cdot \mathfrak m_n \not= 0$.
In particular a discrete valuation ring, or any local ring with
at least two prime ideals is not a Jacobson
ring.
\end{example}

\begin{lemma}
\label{lemma-Jacobson-invert-element}
Let $R$ be a Jacobson ring. Let $f \in R$.
The ring $R_f$ is Jacobson and maximal ideals
of $R_f$ correspond to maximal ideals of $R$.
\end{lemma}

\begin{proof}
By Topology, Lemma \ref{topology-lemma-jacobson-inherited}
we see that $D(f) = \text{Spec}(R_f)$ is Jacobson and
that closed points of $D(f)$
correspond to closed points in $\text{Spec}(R)$
which happen to lie in $D(f)$. Thus we win by
Lemma \ref{lemma-jacobson}.
\end{proof}

\begin{example}
\label{example-localize-not-preserve-closed-points}
Here is a simple example that shows Lemma \ref{lemma-Jacobson-invert-element}
to be false if $R$ is not Jacobson.
Consider the ring $R = \mathbf{Z}_{(2)}$, i.e., the localization
of $\mathbf{Z}$ at the prime $(2)$. The localization of $R$ at
the element $2$ is isomorphic to $\mathbf{Q}$, in a formula:
$R_2 \cong \mathbf{Q}$. Clearly the map $R \to R_2$ maps the
closed point of $\text{Spec}(\mathbf{Q})$ to the generic point
of $\text{Spec}(R)$.
\end{example}

\begin{example}
\label{example-infinite-localize-not-preserve-closed-points}
Here is a simple example that shows
Lemma \ref{lemma-Jacobson-invert-element}
is false if $R$ is Jacobson but we localize at infinitely
many elements.
Namely, let $R = \mathbf{Z}$ and consider the localization
$(R \setminus \{0\})^{-1}R \cong \mathbf{Q}$
of $R$ at the set of all nonzero elements. 
Clearly the map $\mathbf{Z} \to \mathbf{Q}$ maps the
closed point of $\text{Spec}(\mathbf{Q})$ to the generic point
of $\text{Spec}(\mathbf{Z})$.
\end{example}

\begin{lemma}
\label{lemma-Jacobson-mod-ideal}
Let $R$ be a Jacobson ring. Let $I \subset R$ be an ideal.
The ring $R/I$ is Jacobson and maximal ideals
of $R/I$ correspond to maximal ideals of $R$.
\end{lemma}

\begin{proof}
The proof is the same as the proof of
Lemma \ref{lemma-Jacobson-invert-element}.
\end{proof}

\begin{lemma}
\label{lemma-finite-residue-extension-closed}
Let $R \to S$ be a ring map.
Let $\mathfrak m \subset R$ be a maximal ideal.
Let $\mathfrak q \subset S$ be a prime ideal
lying over $\mathfrak m$ such that $\kappa(\mathfrak m)
\subset \kappa(\mathfrak q)$ is an algebraic field extension.
Then $\mathfrak q$ is a maximal ideal of $S$.
\end{lemma}

\begin{proof}
Consider the diagram
$$
\xymatrix{
S \ar[r] & S/\mathfrak q \ar[r] & \kappa(\mathfrak q) \\
R \ar[r] \ar[u] & R/\mathfrak p \ar[u]
}
$$
We see that $\kappa(\mathfrak p) \subset S/\mathfrak q \subset
\kappa(\mathfrak q)$. Because the field extension
$\kappa(\mathfrak p) \subset \kappa(\mathfrak q)$
is algebraic, any ring between $\kappa(\mathfrak p)$
and $\kappa(\mathfrak q)$ is a field (by elementary
field theory). Thus $S/\mathfrak q$ is a field, and a posteriori equal
to $\kappa(\mathfrak q)$.
\end{proof}

\begin{proposition}
\label{proposition-Jacobson-permanence}
Let $R$ be a Jacobson ring. Let $R \to S$ be a
ring map of finite type. Then
\begin{enumerate}
\item The ring $S$ is Jacobson.
\item The map $\text{Spec}(S) \to \text{Spec}(R)$ transforms
closed points to closed points.
\item For $\mathfrak m' \subset S$ maximal lying over $\mathfrak m \subset R$
the field extension $\kappa(\mathfrak m) \subset \kappa(\mathfrak m')$
is finite.
\end{enumerate}
\end{proposition}

\begin{proof}
Let $A \to B \to C$ be finite type ring maps.
Suppose $\text{Spec}(C) \to \text{Spec}(B)$ and
$\text{Spec}(B) \to \text{Spec}(A)$ map closed 
points to closed points, and induce finite residue
field extensions on residue fields at closed points.
Then so does $\text{Spec}(C) \to \text{Spec}(A)$.
Thus it is clear that if we factor $R \to S$ as
$R \to S' \to S$ for some finite type $R$-algebra
$S'$, then it suffices to prove the lemma
for $R\to S'$ and then $S' \to S$.
Writing $S = R[x_1,\ldots,x_n]/I$ we see that
it suffices to prove the lemma in the cases
$S = R[x]$ and $S = R/I$. The case $S = R/I$
is Lemma \ref{lemma-Jacobson-mod-ideal}.

\medskip\noindent
The case  $S = R[x]$.
Take an irreducible closed subset
$Z \subset \text{Spec}(R[x])$.
In other words $Z = V(\mathfrak q)$ for some
prime $\mathfrak q \subset R[x]$. Set
$\mathfrak p = \mathfrak q \cap R$. 
Let $U \subset \text{Spec}(R[x])$ be open
such that $U \cap Z \not = \emptyset$.
We have to find a closed point in $U \cap Z$.
In fact, we will find
\begin{list}{$(*)$}{}
\item
a closed point $y$ of $U \cap Z$
which maps to a closed point $x$ of $\text{Spec}(R)$
such that additionally $\kappa(x) \subset \kappa(y)$
is finite.
\end{list}
To do this we may assume $U = D(f)$ for some $f \in R[x]$.
In this case $U\cap V(\mathfrak q) \not = \emptyset$
means $f \not \in \mathfrak q$. Consider the diagram
$$
\xymatrix{
R[x] \ar[r] & R/\mathfrak p[x]  \\
R \ar[r] \ar[u] & R/\mathfrak p  \ar[u]
}
$$
It suffices to solve the problem on the right hand side
of this diagram. Thus
we see we may assume $R$ is Jacobson, a domain and
$\mathfrak p = (0)$.

\medskip\noindent
In case $\mathfrak q = (0)$, write $f = a_d x^d + \ldots + a_0$.
We see that not all $a_i$ are zero. Take any maximal ideal
$\mathfrak m$ of $R$ such that $a_i \not \in \mathfrak m$
for some $i$ (here we use $R$ is Jacobson). Next, choose
a maximal ideal $\overline{\mathfrak m}' \subset (R/\mathfrak m)[x]$
not containing the image of $f$ (possible because
$\kappa(\mathfrak m)[x]$ is Jacobson). Then the inverse image
$\mathfrak m' \subset R[x]$ defines a closed point of
$U \cap Z$ and maps to $\mathfrak m$. Also, by construction
$\kappa(\mathfrak m) \subset \kappa(\mathfrak m')$ is finite.
Thus we have shown $(*)$ in this case.

\medskip\noindent
In case $\mathfrak q \not = (0)$, let $K$ be the
fraction field of $R$. Write $\mathfrak q K[x]
= (g)$ for some irreducible $g \in K[x]$. Clearing
denominators, we may assume that $g \in R[x]$, and
hence in $\mathfrak q$. Write $g = b_e x^e + \ldots + b_0$,
$b_i \in R$ with $b_e \not= 0$.
The maps $R \to R_{b_e}$ and $R[x] \to R[x]_{b_e}$
satisfies the conclusion of the lemma, by Lemma
\ref{lemma-Jacobson-invert-element} and moreover induce
isomorphisms on residue fields. Hence, in order to prove $(*)$,
we may replace $R$ by $R_{b_e}$ and assume that $g$ is monic.
In this case we see that $R[x]/\mathfrak q$ is a 
quotient of the finite free $R$-module
$R[x]/(g) = R \oplus Rx \oplus \ldots \oplus Rx^{e-1}$.
But on the other hand we have $R[x]/(g) \subset K[x]/(g)
= K[x]/\mathfrak q K[x]$. Hence $\mathfrak q = (g)$, and
$Z = V(\mathfrak q) = V(g)$. At this point, by Lemma
\ref{lemma-affineline-special} the image of $D(f) \cap V(g)$
in $\text{Spec}(R)$ is $D(r_1) \cup \ldots \cup D(r_d)$
for some $r_i \in R$ (of course it is nonempty).
Take any maximal ideal $\mathfrak m \subset R$ in this
image (possible because $R$ is Jacobson) and take any
prime $\mathfrak m' \subset R[x]$
corresponding to a point of $D(f) \cap V(g)$
lying over $\mathfrak m$. Note that the residue field
extension $\kappa(\mathfrak m) \subset \kappa(\mathfrak m')$
is finite (because $g \in \mathfrak m'$). By
Lemma \ref{lemma-finite-residue-extension-closed}
we see that $\mathfrak m'$ is a closed point.
This proves $(*)$ in this case.

\medskip\noindent
At this point we are done. Namely, $(*)$ implies
that $\text{Spec}(R[x])$ is Jacobson (via Lemma \ref{lemma-jacobson}).
Also, if $Z$ is a singleton closed set, then $(*)$ implies that
$Z = \{ \mathfrak m' \}$ with $\mathfrak m'$ lying over a maximal
ideal $\mathfrak m \subset R$ such that $\kappa(\mathfrak m)
\subset \kappa(\mathfrak m')$ is finite.
\end{proof}

\begin{lemma}
\label{lemma-corollary-jacobson}
Any finite type algebra over $\mathbf{Z}$ is Jacobson.
\end{lemma}

\begin{proof}
Combine Lemma \ref{lemma-pid-jacobson} and
Proposition \ref{proposition-Jacobson-permanence}.
\end{proof}

\begin{lemma}
\label{lemma-image-finite-type-map-Jacobson-rings}
Let $R \to S$ be a finite type ring map of Jacobson rings.
Denote $X = \text{Spec}(R)$ and $Y = \text{Spec}(S)$.
Write $f : Y \to X$ the induced
map of spectra. Let $E \subset Y = \text{Spec}(S)$ be a
constructible set. Denote with a subscript ${}_0$ the set
of closed points of a topological space.
\begin{enumerate}
\item We have $f(E)_0 = f(E_0) = X_0 \cap f(E)$.
\item A point $\xi \in X$ is in $f(E)$ if and only if
$\overline{\{\xi\}} \cap f(E_0)$ is dense in $\overline{\{\xi\}}$.
\end{enumerate}
\end{lemma}

\begin{proof}
We have a commutative diagram with of continuous maps
$$
\xymatrix{
E \ar[r] \ar[d] & Y \ar[d] \cr
f(E) \ar[r] & X 
}
$$
Suppose $x \in f(E)$ is closed in $f(E)$. Then $f^{-1}(\{x\})\cap E$
is closed in $E$. Hence $f^{-1}(\{x\})\cap E$ is constructible, nonempty
in $Y$. By Topology, Lemma \ref{topology-lemma-jacobson-inherited},
the intersection $Y_0 \cap f^{-1}(\{x\})\cap E$ is not empty.
Thus there exists $y \in Y_0$ mapping to $x$.
Since clearly $y \in E_0$ we see that $x \in f(E_0)$.
This proves that $f(E)_0 \subset f(E_0)$.
Proposition \ref{proposition-Jacobson-permanence} implies that
$f(E_0) \subset X_0 \cap f(E)$. The inclusion
$X_0 \cap f(E) \subset f(E)_0$ is trivial. This proves the
first assertion.

\medskip\noindent
Suppose that $\xi \in f(E)$. According to
Lemma \ref{lemma-characterize-image-finite-type}
the set $f(E) \cap \overline{\{\xi\}}$ contains a dense
open subset of $\overline{\{\xi\}}$. Since $X$ is Jacobson
we conclude that $f(E) \cap \overline{\{\xi\}}$ contains a
dense set of closed points, see Topology, 
Lemma \ref{topology-lemma-jacobson-inherited}.
We conclude by part (1) of the lemma.

\medskip\noindent
On the other hand, suppose that $\overline{\{\xi\}} \cap f(E_0)$
is dense in $\overline{\{\xi\}}$. By
Lemma \ref{lemma-constructible-is-image}
there exists a ring map $S \to S'$ of finite presentation
such that $E$ is the image of $Y' := \text{Spec}(S') \to Y$.
Then $E_0$ is the image of $Y'_0$ by the first part of the
lemma applied to the ring map $S \to S'$. Thus we may assume that
$E = Y$ by replacing $S$ by $S'$. Suppose $\xi$ corresponds
to $\mathfrak p \subset R$. Consider the diagram
$$
\xymatrix{
S \ar[r] & S/\mathfrak p S \cr
R \ar[r] \ar[u] & R/\mathfrak p \ar[u]
}
$$
This diagram and the density of $f(Y_0) \cap V(\mathfrak p)$ 
in $V(\mathfrak p)$
shows that the morphism $R/\mathfrak p \to S/\mathfrak p S$
satisfies condition (2) of
Lemma \ref{lemma-domain-image-dense-set-points-generic-point}.
Hence we conclude
there exists a prime $\overline{\mathfrak q} \subset S/\mathfrak pS$
mapping to $(0)$. In other words the inverse image $\mathfrak q$
of $\overline{\mathfrak q}$ in $S$ maps to $\mathfrak p$ as desired.
\end{proof}

\noindent
The conclusion of the lemma above is that we can read off
the image of $f$ from the set of closed points of the image.
This is a little nicer in case the map is of finite presentation
because then we know that images of constructibles are constructible.
Before we state it we introduce some notation.
Denote $\text{Constr}(X)$ the set of constructible
Let $R \to S$ be a ring map.
Denote $X = \text{Spec}(R)$ and $Y = \text{Spec}(S)$.
Write $f : Y \to X$ the induced map of spectra.
Denote with a subscript ${}_0$ the set
of closed points of a topological space.


\begin{lemma}
\label{lemma-conclude-jacobson-Noetherian}
With notation as above. Assume that $R$ is a Noetherian Jacobson ring.
Further assume $R \to S$ is of finite type.
There is a commutative diagram
$$
\xymatrix{
\text{Constr}(Y) \ar[r]^{E \mapsto E_0} \ar[d]^{E \mapsto f(E)} &
\text{Constr}(Y_0) \ar[d]^{E \mapsto f(E)} \cr
\text{Constr}(X) \ar[r]^{E \mapsto E_0} &
\text{Constr}(X_0)
}
$$
where the horizontal arrows are the bijections from
Topology, Lemma \ref{topology-lemma-jacobson-equivalent-constructible}.
\end{lemma}

\begin{proof}
Since $R \to S$ is of finite type, it is of finite presentation,
see Lemma \ref{lemma-Noetherian-finite-type-is-finite-presentation}.
Thus the image of a constructible set in $X$ is constructible
in $Y$ by Chevalley's theorem \ref{theorem-chevalley}. Combined with
Lemma \ref{lemma-image-finite-type-map-Jacobson-rings}
above the lemma follows.
\end{proof}






































\section{Finite and integral ring extensions}
\label{section-finite-ring-extensions}

\noindent
Trivial lemmas concerning finite and integral ring maps.
We recall the definition.

\begin{definition}
\label{definition-integral-ring-map}
Let $\varphi : R \to S$ be a ring map. An element $s \in S$
is {\it integral over $R$} if there exists a monic
polynomial $P(x) \in R[x]$ such that
$P^\varphi(s) = 0$, where $P^\varphi(x) \in S[x]$
is the image of $P$ under $\varphi : R[x] \to S[x]$.
The ring map $\varphi$ is {\it integral}
if every $s \in S$ is integral over $R$.
\end{definition}

\begin{lemma}
\label{lemma-finite-is-integral}
A finite ring extension is integral.
\end{lemma}

\begin{proof}
Let $R \to S$ be finite. Let $x_1 = 1 \in S$ and
$x_i \in S$, $i=2,\ldots,n$ be a finite set of
elements generating $S$ as an $R$-module.
For any $s\in S$ write $sx_i = \sum \varphi(a_{ij}) x_j$
for some $a_{ij} \in R$. Let $P(x) \in R[x]$ be
the characteristic polynomial of the $n\times n$ matrix
$A = (a_{ij})$. By Lemma \ref{lemma-charpoly} we see
$P(A) = 0$. By construction the map $\pi : R^n \to S$,
$(a_1,\ldots,a_n) \mapsto \sum a_i x_i$
commutes with $A : R^n \to R^n$ and
multiplication by $s$. In a formula
$\pi(Av) = s\pi(v)$. Thus $P(s) = P(s) \cdot 1
= P(s) \cdot x_1 = P(s) \cdot \pi((1,0,\ldots,0))
= \pi(P(A)(1,0,\ldots,0)) = 0$.
\end{proof}

\begin{lemma}
\label{lemma-finite-transitive}
Suppose that $R \to S$ and $S \to T$ are finite
ring maps. Then $R \to T$ is finite.
\end{lemma}

\begin{proof}
If $t_i$ generate $T$ as an $S$-module and $s_j$ generate $S$ as an
$R$-module, then $t_i s_j$ generate $T$ as an $R$-module.
\end{proof}

\begin{lemma}
\label{lemma-characterize-integral}
Let $\varphi : R \to S$ be a ring map. Let $s_1,\ldots,s_n$
be a finite set of elements of $S$.
In this case $s_i$ is integral over $R$ for all $i=1,\ldots,n$
if and only if
there exists an $R$-subalgebra $S' \subset S$ finite over $R$
containing all of the $s_i$.
\end{lemma}

\begin{proof}
If each $s_i$ is integral, then the subalgebra
generated by $\varphi(R)$ and the $s_i$ is finite
over $R$. Namely, if $s_i$ satisfies a monic equation
of degree $d_i$ over $R$, then this subalgebra is generated as an
$R$-module by the elements $s_1^{e_1} \ldots s_n^{e_n}$
with $0 \leq e_i \leq d_i - 1$.
Conversely, suppose given a finite $R$-subalgebra
$S'$ containing all the $s_i$. Then all of the
$s_i$ are integral by Lemma \ref{lemma-finite-is-integral}.
\end{proof}

\begin{lemma}
\label{lemma-integral-transitive}
Suppose that $R \to S$ and $S \to T$ are integral
ring maps. Then $R \to T$ is integral.
\end{lemma}

\begin{proof}
Let $t \in T$. Let $P(x) \in S[x]$ be a
monic polynomial such that $P(t) = 0$.
Apply Lemma \ref{lemma-characterize-integral}
to the finite set of coefficients of $P$.
Hence $t$ is integral over some subalgebra
$S' \subset S$ finite over $R$. Apply Lemma
\ref{lemma-characterize-integral} again to find
a subalgebra $T' \subset T$ finite over $S'$ and
containing $t$. Lemma \ref{lemma-finite-transitive}
applied to $R \to S' \to T'$ shows that $T'$ is finite
over $R$. The integrality of $t$ over $R$
now follows from Lemma \ref{lemma-finite-is-integral}.
\end{proof}

\begin{lemma}
\label{lemma-integral-closure-is-ring}
Let $R \to S$ be a ring homomorphism.
The set
$$
S' = \{s \in S \mid s\text{ is integral over }R\}
$$
is an $R$-subalgebra of $S$.
\end{lemma}

\begin{proof}
This is clear from Lemmas \ref{lemma-characterize-integral}
and \ref{lemma-finite-is-integral}.
\end{proof}

\begin{definition}
\label{definition-integral-closure}
Let $R \to S$ be a ring map. 
The ring $S' \subset S$ of elements integral over
$R$, see Lemma \ref{lemma-integral-closure-is-ring},
is called the {\it integral closure} of $R$
in $S$. If $R \subset S$ we say that {\it $R$ is
integrally closed in $S$} if $R = S'$.
\end{definition}

\begin{lemma}
\label{lemma-integral-overring-surjective}
Suppose that $R \to S$ is an integral
ring extension with $R \subset S$.
Then $\varphi : \text{Spec}(S) \to \text{Spec}(R)$
is surjective.
\end{lemma}

\begin{proof}
Let $\mathfrak p \subset R$ be a prime ideal.
We have to show $\mathfrak pS \not = S$, see Lemma \ref{lemma-in-image}.
Suppose $1 = \sum f_i s_i$ with $f_i \in \mathfrak p$
and $s_i \in S$ in order to get a contradiction.
Let $R \subset S' \subset S$
be such that $R\to S'$ is finite and $s_i \in S$,
see Lemma \ref{lemma-characterize-integral}.
The equation $1 = \sum f_i s_i$ implies that
the finite $R_{\mathfrak p}$-module 
$S'_{\mathfrak p}$ satisfies
$S'_{\mathfrak p} = \mathfrak pS'_{\mathfrak p}$
Hence by Nakayama's Lemma \ref{lemma-NAK}
we see $S'_{\mathfrak p} = 0$. On the other hand
$R_{\mathfrak p} \subset S'_{\mathfrak p}$ because localization
is exact. Contradiction.
\end{proof}

\begin{lemma}
\label{lemma-integral-over-field}
Let $k$ be a field. Let $S$ be a $k$-algebra over $k$.
\begin{enumerate}
\item If $S$ is a domain and finite dimensional over $k$,
then $S$ is a field.
\item If $S$ is integral over $k$ and a domain,
then $S$ is a field.
\item If $S$ is integral over $k$ then every prime of
$S$ is a maximal ideal.
\end{enumerate}
\end{lemma}

\begin{proof}
The statement on primes follows from the statement
``integral $+$ domain $\Rightarrow$ field''.
Let $S$ integral over $k$ and assume $S$ is a domain,
Take $s \in S$. By Lemma
\ref{lemma-characterize-integral} we may find a 
finite dimensional $k$-subalgebra $k \subset S' \subset S$.
containing $s$. Hence $S$ is a field if we can prove the
first statement. Assume $S$ finite dimensional
over $k$ and a domain. Pick $s\in S$.
Since $S$ is a domain the multiplication
map $s : S \to S$ is surjective by dimension
reasons. Hence there exists an element $s_1 \in S$
such that $ss_1 = 1$. So $S$ is a field.
\end{proof}

\begin{lemma}
\label{lemma-integral-no-inclusion}
Suppose $R \to S$ is integral.
Let $\mathfrak q, \mathfrak q' \in \text{Spec}(S)$
be distinct primes
having the same image in $\text{Spec}(R)$.
Then neither $\mathfrak q \subset \mathfrak q'$
nor $\mathfrak q' \subset \mathfrak q$.
\end{lemma}

\begin{proof}
Let $\mathfrak p \subset R$ be the image.
By Remark \ref{remark-fundamental-diagram}
the primes $\mathfrak q, \mathfrak q'$
correspond to ideals in
$S \otimes_R \kappa(\mathfrak p)$.
Thus the lemma follows from Lemma \ref{lemma-integral-over-field}.
\end{proof}

\begin{lemma}
\label{lemma-integral-going-up}
Let $R \to S$ be a ring map such that
$S$ is integral over $R$.
Let $\mathfrak p \subset \mathfrak p' \subset R$
be primes. Let $\mathfrak q$ be a prime of $S$ mapping
to $\mathfrak p$. Then there exists a prime $\mathfrak q'$
with $\mathfrak q \subset \mathfrak q'$
mapping to $\mathfrak p'$.
\end{lemma}

\begin{proof}
We may replace $R$ by $R/\mathfrak p$ and $S$ by $S/\mathfrak q$. 
This reduces us to the situation of having an integral
extension of domains $R \subset S$ and a prime $\mathfrak p' \subset R$.
By Lemma \ref{lemma-integral-overring-surjective} we win.
\end{proof}

\noindent
The property expressed in the Lemma above is called
the ``going up property'' for the ring map $R \to S$,
see Definition \ref{definition-going-up-down}.

\begin{definition}
\label{definition-ring-normal}
A domain $R$ is called {\it normal} if it is integrally
closed in its field of fractions.
\end{definition}

\noindent
The following notion is occasionally usefull when
studying normality.

\begin{definition}
\label{definition-almost-integral}
Let $R$ be a domain. An element $g$ of its fraction
field is called {\it almost integral over $A$}
if there exists an element $r \in R$, $r\not=0$
such that $rg^n \in R$ for all $n \geq 0$.
\end{definition}

\begin{lemma}
\label{lemma-almost-integral}
Let $R$ be a domain with fraction field $K$.
If $u,v \in K$ are almost integral over $R$, then so are
$u+v$ and $uv$. Any element $g \in K$ which is integral over $R$
is almost integral over $R$. If $R$ is Noetherian
then the converse holds as well.
\end{lemma}

\begin{proof}
If $ru^n \in R$ for all $n \geq 0$ and 
$v^nr' \in R$ for all $n \geq 0$, then
$(uv)^nrr'$ and $(u+v)^nrr'$ are in $R$ for
all $n \geq 0$. Hence the first assertion.
Suppose $g \in K$ is integral over $R$.
In this case there exists an $d > 0$ such that
the ring $R[g]$ is generated by $1,g,\ldots,g^d$ as an $R$-module.
Let $r \in R$ be a common denominator of the elements
$1,g,\ldots,g^d \in K$. It is follows that $rR[g] \subset R$,
and hence $g$ is almost integral over $R$.

\medskip\noindent
Suppose $R$ is Noetherian and $g \in K$ is almost integral over $R$.
Let $r \in R$, $r\not= 0$ be as in the definition. 
Then $R[g] \subset {1 \over r}R$ as an $R$-module.
Since $R$ is Noetherian this implies that $R[g]$ is
finite over $R$. Hence $g$ is integral over $R$, see
Lemma \ref{lemma-finite-is-integral}.
\end{proof}

\begin{lemma}
\label{lemma-localize-normal-domain}
Any localization of a normal domain is normal.
\end{lemma}

\begin{proof}
Let $R$ be a normal domain, and let $S \subset R$ be
a multiplicative subset. Suppose $g$ is an element
of the fraction field of $R$ which is integral over $S^{-1}R$.
Let $P = x^d + \sum_{j < d} a_j x^j$ be a polynomial
with $a_i \in S^{-1}R$ such that $P(g) = 0$.
Choose $s \in S$ such that $sa_i \in R$ for all $i$. 
Then $sg$ satisfies the monic polynomial
$x^d + \sum_{j < d} s^{d-j}a_j x^j$ which has coefficients
$s^{d-j}a_j$ in $R$. Hence $sg \in R$ because $R$ is normal.
Hence $g \in S^{-1}R$.
\end{proof}

\begin{lemma}
\label{lemma-PID-normal}
A principal ideal domain is normal.
\end{lemma}

\begin{proof}
Let $R$ be a principal ideal domain.
Let $g = a/b$ be an element of the fraction field
of $R$ integral over $R$. Because $R$ is a principal ideal domain
we may divide out a common factor of $a$ and $b$
and assume $(a,b) = R$. In this case, any equation
$(a/b)^n + r_{n-1} (a/b)^{n-1} + \ldots + r_0 = 0$
with $r_i \in R$ would imply $a^n \in (b)$. This
contradicts $(a,b) = R$ unless $b$ is a unit in $R$.
\end{proof}

\begin{lemma}
\label{lemma-prepare-polynomial-ring-normal}
Let $R$ be a domain with fraction field $K$.
Suppose $f = \sum \alpha_i x^i$ is an
element of $K[x]$.
\begin{enumerate}
\item If $f$ is integral over $R[x]$
then all $\alpha_i$ are integral over $R[x]$, and
\item If $f$ is almost integral over $R[x]$
then all $\alpha_i$ are almost integral over $R[x]$.
\end{enumerate}
\end{lemma}

\begin{proof}
We first prove the second statement.
Write $f = \alpha_d x^d + \ldots + \alpha_r x^r$
with $\alpha_r \not = 0$. 
By assumption there exists $h = b_d x^d + \ldots b_s x^s \in R[x]$,
$b_s \not= 0$ such that $f^n h \in R[x]$ for all
$n \geq 0$. This implies that $b_s \alpha_r^n \in R$
for all $n \geq 0$. Hence $\alpha_r$ is almost
integral over $R$. Since the set of almost integral
elements form a subring we deduce that
$f - \alpha_r x^r = \alpha_d x^d + \ldots + \alpha_{r-1} x^{r-1}$
is almost integral over $R[x]$. By induction on $d-r$ we win.

\medskip\noindent
In order to prove the first statement we will use absolute Noetherian
reduction. Namely, write $\alpha_i = a_i / b_i$ and
let $P(t) = t^d + \sum_{j < d} f_j t^j$ be a polynomial
with coefficients $f_j \in R[x]$ such that $P(g) = 0$.
Let $f_j = \sum f_{ji}x^i$. Consider the subring
$R_0 \subset R$ generated by the finite list of elements
$a_i, b_i, f_{ji}$ of $R$. It is a domain; let
$K_0$ be its field of fractions. Since $R_0$ is a finite type
$\mathbf{Z}$-algebra it is Noetherian, see
Lemma \ref{lemma-obvious-Noetherian}. It is still
the case that $g \in K_0[x]$ is integral over $R_0[x]$,
because all the identities in $R$
among the elements $a_i, b_i, f_{ji}$ also hold in $R_0$.
By Lemma \ref{lemma-almost-integral} the element
$g$ is almost integral over $R_0[x]$. By the first part of
the lemma, the elements $\alpha_i$ are almost integral
over $R_0$. And since $R_0$ is Noetherian, the are
integral over $R_0$, see Lemma \ref{lemma-almost-integral}.
Of course, then they are integral over $R$.
\end{proof}

\begin{lemma}
\label{lemma-polynomial-ring-normal}
Let $R$ be a normal domain.
Then $R[x]$ is a normal domain.
\end{lemma}

\begin{proof}
The result is true if $R$ is a field $K$ because
$K[x]$ is a euclidean domain and hence a principal ideal
domain and hence normal by Lemma \ref{lemma-PID-normal}.
Let $g$ be an element of the fraction field of
$R[x]$ which is integral over $R[x]$. Because $g$
is integral over $K[x]$ where $K$ is the fraction
field of $R$ we may write $g = \alpha_d x^d + \alpha_{d-1}x^{d-1} + 
\ldots + \alpha_0$ with $\alpha_i \in K$.
By Lemma \ref{lemma-prepare-polynomial-ring-normal}
the elements $\alpha_i$ are integral over $R$ and
hence are in $R$.
\end{proof}

\begin{definition}
Let $\varphi : R\to S$ be a ring map.
Let $I \subset R$ be an ideal.
We say an element $g \in S$ is 
{\it integral over $I$} if
there exists a monic
polynomial $P = x^d + \sum_{j < d} a_j x^j$
with coefficients $a_j \in I^{d-j}$ such
that $P^\varphi(g) = 0$ in $S$.
\end{definition}

\begin{lemma}
\label{lemma-characterize-integral-ideal}
Let $\varphi : R \to S$ be a ring map.
Let $I \subset R$ be an ideal.
Let $A = \sum I^nt^n \subset R[t]$ be the
subring of the polynomial ring
generated by $R \oplus It \subset R[t]$.
An element $s \in S$ is integral over $I$ if
and only if the element $st \in S[t]$
is integral over $A$.
\end{lemma}

\begin{proof}
Suppose $st$ is integral over $A$.
Let $P = x^d + \sum_{j < d} a_j x^j$
be a monic polynomial with coefficients in $A$
such that $P^\varphi(x) = 0$. Let $a_j' \in A$
be the degree $d-j$ part of $a_i$, in other
words $a_j' = a_j'' t^{d-j}$ with $a_j'' \in I^{d-j}$.
For degree reasons we still have
$(st)^d + \sum_{j < d} \varphi(a_j'') t^{d-j} (st)^j = 0$.
Hence we see that $s$ is integral over $I$.

\medskip\noindent
Suppose that $s$ is integral over $I$.
Say $P = x^d + \sum_{j < d} a_j x^j$
with $a_j \in I^{d-j}$. The we immediately find a
polynomial $Q = x^d + \sum_{j < d} (a_j t^{d-j}) x^j$
with coefficients in $A$ which proves that
$st$ is integral over $A$.
\end{proof}

\begin{lemma}
\label{lemma-integral-over-ideal-is-submodule}
Let $\varphi : R \to S$ be a ring map.
Let $I \subset R$ be an ideal.
The set of elements of $S$ which are integral
over $I$ form a $R$-submodule of $S$.
Furthermore, if $s \in S$ is integral over
$R$, and $s'$ is integral over $I$, then
$ss'$ is integral over $I$.
\end{lemma}

\begin{proof}
Closure under addition is clear from the
characterization of Lemma \ref{lemma-characterize-integral-ideal}.
Any element $s \in S$ which is integral over
$R$ corresponds to the degree $0$ element $s$ of $S[x]$
which is integral over $A$ (because $R \subset A$). 
Hence we see that multiplication by $s$ on $S[x]$
preserves the property of being integral over $A$,
by Lemma \ref{lemma-integral-closure-is-ring}.
\end{proof}

\begin{lemma}
\label{lemma-integral-integral-over-ideal}
Suppose $\varphi : R \to S$ is integral.
Suppose $I \subset R$ is an ideal.
Then every element of $IS$ is integral over $I$.
\end{lemma}

\begin{proof}
Immediate from Lemma \ref{lemma-integral-over-ideal-is-submodule}.
\end{proof}

\begin{lemma}
\label{lemma-polynomials-divide}
Let $R$ be a domain with field of fractions $K$.
Let $n,m \in \mathbf{N}$ and $a_0,\ldots,a_{n-1},b_0,\ldots,b_{m-1} \in R$.
If the polynomial $x^n + a_{n-1}x^{n-1} + \ldots + a_0$
divides the polynomial $x^m + b_{m-1} x^{m-1} + \ldots + b_0$
in $K[x]$ then 
\begin{enumerate}
\item $a_0,\ldots,a_{n-1}$ are integral over the subring
of $R$ generated by $b_0,\ldots,b_{m-1}$, and
\item each $a_i$ lies in $\sqrt{(b_0,\ldots,b_m)}$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $K \supset R$ be the fraction field of $R$.
Let $L \supset K$ be a field extension such that
we can write $x^m + b_{m-1} x^{m-1} + \ldots + b_0 =
\prod_{i=1}^m (x-\beta_i)$ with $\beta_i \in L$.
Each $\beta_i$ is integral over the subring generated
by $b_0,\ldots,b_{m-1}$. Since each $a_i$ is a
homogeneous polynomial in $\beta_1,\ldots,\beta_m$
we deduce the same for the $a_i$.

\medskip\noindent
Choose $c_0, \ldots, c_{m-n-1} \in K$ such that
$$
\begin{matrix}
x^m + b_{m-1} x^{m-1} + \ldots + b_0 =  \\
(x^n + a_{n-1}x^{n-1} + \ldots + a_0)
(x^{m-n} + c_{m-n-1}x^{m-n-1}+ \ldots + c_0).
\end{matrix}
$$
By the first part we see that the elements $c_i$
are integral over $R$. Let $R'$ be the sub $R$-algebra
of $K$ generated by $c_0, \ldots, c_{m-n-1}$. 
By Lemmas \ref{lemma-integral-overring-surjective}
and \ref{lemma-surjective-spec-radical-ideal}
we see that $R \cap \sqrt{(b_0,\ldots,b_m)R'}
= \sqrt{(b_0,\ldots,b_m)}$. Thus we may replace
$R$ by $R'$ and assume $c_i \in R$.
Dividing out the radical $\sqrt{(b_0,\ldots,b_m)}$
we get a reduced ring $\overline{R}$.
We have to show that the images $\overline{a_i} \in \overline{R}$
are zero. And in
$\overline{R}[x]$ we have the relation
$$
\begin{matrix}
x^m + \overline{b_{m-1}} x^{m-1} + \ldots + \overline{b_0} = \\
(x^n + \overline{a_{n-1}}x^{n-1} + \ldots + \overline{a_0})
(x^{m-n} + \overline{c_{m-n-1}}x^{m-n-1}+ \ldots + \overline{c_0}).
\end{matrix}
$$
It is easy to see that this implies $\overline{a_i} = 0$ for all $i$.
For example one can see this by localizing at all the minimal
primes, see Lemma \ref{lemma-reduced-ring-sub-product-fields}.
\end{proof}

\begin{lemma}
\label{lemma-minimal-polynomial-normal-domain}
Let $R \subset S$ be an inclusion of domains.
Assume $R$ is normal. Let $g \in S$ be integral
over $R$. Then the minimal polynomial of $g$ 
has coefficients in $R$.
\end{lemma}

\begin{proof}
Let $P = x^m + b_{m-1} x^{m-1} + \ldots + b_0$
be a polynomial with coefficients in $R$
such that $P(g) = 0$. Let $Q = x^n + a_{n-1}x^{n-1} + \ldots + a_0$
be the minimal polynomial for $g$ over the fraction field
$K$ of $R$. Then $Q$ divides $P$ in $K[x]$. By Lemma
\ref{lemma-polynomials-divide} we see the $a_i$ are
integral over $R$. Since $R$ is normal this
means they are in $R$.
\end{proof}

\begin{proposition}
\label{proposition-going-down-normal-integral}
Let $R \subset S$ be an inclusion of domains.
Assume $R$ is normal and $S$ integral over $R$.
Let $\mathfrak p \subset \mathfrak p' \subset R$
be primes. Let $\mathfrak q'$ be a prime of $S$
with $\mathfrak p' = R \cap \mathfrak q'$.
Then there exists a prime $\mathfrak q$
with $\mathfrak q \subset \mathfrak q'$
such that $\mathfrak p = R \cap \mathfrak q$. In other words:
the going down property holds for $R \to S$, see
Definition \ref{definition-going-up-down}.
\end{proposition}

\begin{proof}
Let $\mathfrak p$, $\mathfrak p'$ and $\mathfrak q'$
be as in the statment. We have to show there is a prime
$\mathfrak q$, $\mathfrak q \subset \mathfrak q'$ such that
$R \cap \mathfrak q = \mathfrak p$. This is the same
as finding a prime of
$S_{\mathfrak q'}$ mapping to $\mathfrak p$.
According to Lemma \ref{lemma-in-image} we have to show
that $\mathfrak p S_{\mathfrak q'} \cap R
= \mathfrak p$. Pick $z \in \mathfrak p S_{\mathfrak q'} \cap R$.
We may write $z = y/g$ with $y \in \mathfrak pS$ and 
$g \in S$, $g \not\in \mathfrak q'$. Written
differently we have $zg = y$.

\medskip\noindent
By Lemma \ref{lemma-integral-integral-over-ideal}
there exists a monic polynomial
$P = x^m + b_{m-1} x^{m-1} + \ldots + b_0$
with $b_i \in \mathfrak p$ such that $P(y) = 0$.

\medskip\noindent
By Lemma \ref{lemma-minimal-polynomial-normal-domain}
the minimal polynomial of $g$ over $K$ has coefficients
in $R$. Write it as $Q = x^n + a_{n-1} x^{n-1} + \ldots
+ a_0$. Note that not all $a_i$, $i=n-1,\ldots,0$
are in $\mathfrak p$ since that would imply 
$g^n = \sum_{j < n} a_j g^j \in \mathfrak pS
\subset \mathfrak p'S
\subset \mathfrak q'$
which is a contradiction.

\medskip\noindent
Since $y = zg$ we see immediately from the above
that $Q' = x^n + za_{n-1} x^{n-1} + \ldots + z^{n}a_0$
is the minimal polynomial for $y$. Hence
$Q'$ divides $P$ and by Lemma \ref{lemma-polynomials-divide}
we see that $z^ja_{n - j} \in \sqrt{(b_0,\ldots,b_{m-1})} 
\subset \mathfrak p$, $j =  1, \ldots, n$.
Because not all $a_i$, $i=n-1,\ldots,0$
are in $\mathfrak p$ we conclude $z \in \mathfrak p$
as desired.
\end{proof}






















\section{Flat modules and flat ring maps}
\label{section-flat}

\noindent
One often used result is that if $M = \text{colim}_{i\in \mathcal{I}} M_i$
is a colimit of $R$-modules and if $N$ is another then
$$
M \otimes N
=
\text{colim}_{i\in \mathcal{I}} M_i \otimes_R N.
$$
This follows almost immediately from the universal 
property of colimits and the universal property of
the tensor product in terms of bilinear maps.
This property is usually expressed by saying
that {\it $\otimes$ commutes with colimits}.

\medskip\noindent
Another often used result is that if $0\to N_1 \to N_2 \to N_3\to 0$
is an exact sequence and if $M$ is any $R$-module, then
$$
M\otimes_R N_1
\to
M\otimes_R N_2
\to
M\otimes_R N_3
\to
0
$$
is still exact. Again this follows almost immediately from
the interpretation of the tensor product in terms of
bilinear maps. Of course this property is usually expressed
by saying that {\it $-\otimes_R M$ is right exact}.

\medskip\noindent
Let $M$ be an $R$-module. Let $x_i$, $i=1,\ldots,n$ be elements
of $M$. Let $f_i \in R$ be elements such that $\sum f_i x_i = 0$
in $M$. We say the elements $f_i$ give a {\it relation}
among the elements $x_i$.

\begin{lemma}
\label{lemma-module-colimit-fp}
Let $R$ be a ring and let $M$ be an $R$-module.
Then $M$ is the colimit of a directed system
$(I, \geq)$, $(M_i, f_{ii'})$ of $R$-modules
with all $M_i$ finitely presented $R$-modules.
\end{lemma}

\begin{proof}
Consider any finite subset $S \subset M$ and any finite
collection of relations $E$ among the elements
of $S$. So each $s \in S$ corresponds to $x_s \in M$ and
each $e \in E$ consists of a vector
of elements $f_{e,s} \in R$ such that $\sum f_{e,s} x_s = 0$.
Let $M_{S,E}$ be the cokernel of the map
$$
R^{\#E}
\longrightarrow
R^{\#S},\ \ 
(g_e)_{e\in E}
\longmapsto
(\sum g_e f_{e,s})_{s\in S}.
$$
There are canonical maps $M_{S,E} \to M$.
If $S \subset S'$ and if the elements of
$E$ correspond, via this map, to relations 
in $E'$, then there is an obvious map
$M_{S,E} \to M_{S', E'}$ commuting with the
maps to $M$. Thus $I$ is the set of pairs 
$(S,E)$ with ordering by inclusion as above.
It is clear that the limit of this directed system is $M$.
\end{proof}

\begin{definition}
\label{definition-flat}
Let $R$ be a ring.
\begin{enumerate}
\item An $R$-module $M$ is called {\it flat} if whenever
$N_1 \to N_2 \to N_3$ is an exact sequence of $R$-modules
the sequence $M\otimes_R N_1 \to M\otimes_R N_1\to M\otimes_R N_1$
is exact as well.
\item An $R$-module $M$ is called {\it faithfully flat} if the
complex of $R$-modules
$N_1 \to N_2 \to N_3$ is exact if and only if
the sequence $M\otimes_R N_1\to M\otimes_R N_1\to M\otimes_R N_1$
is exact.
\item A ring map $R \to S$ is called {\it flat} if
$S$ is flat as an $R$-module.
\item A ring map $R \to S$ is called {\it faithfully flat} if
$S$ is faithfully flat as an $R$-module.
\end{enumerate}
\end{definition}

\begin{lemma}
\label{lemma-flat}
Let $M$ be an $R$-module. The following are equivalent:
\begin{enumerate}
\item $M$ is flat over $R$.
\label{flat}
\item for every injection of $R$-modules $N \subset N'$
the map $N\otimes_R M \to N'\otimes_R M$ is injective.
\label{injective}
\item for every ideal $I \subset R$ the map
$I\otimes_R M \to R\otimes_R M = M$ is injective.
\label{f-ideal}
\item for every finitely generated ideal $I \subset R$
the map $I\otimes_R M \to R\otimes_R M = M$ is injective.
\label{ffg-ideal}
\end{enumerate}
\end{lemma}

\begin{proof}
The implications (\ref{flat}) implies (\ref{injective})
implies (\ref{f-ideal}) implies (\ref{ffg-ideal}) are all
trivial. Thus we prove (\ref{ffg-ideal}) implies (\ref{flat}).
Suppose that $N_1 \to N_2 \to N_3$ is exact.
Let $K_2 = \text{Ker}(N_2 \to N_3)$. 
It is clear that the surjection $N_1 \to K$
induces a surjection $N_1 \otimes_R M \to K_2\otimes_R M$.
Hence it suffices to show $K_2\otimes_R M \to N_2\otimes_R M$
is injective.

\medskip\noindent
Let $x \in \text{Ker}(K_2\otimes_R M \to N_2\otimes_R M)$.
We have to show that $x$ is zero.
Write $x = \sum_{i=1,\ldots,r} k_i \otimes m_i$. By
Lemma \ref{lemma-module-colimit-fp}
we can find a finitely generated module $N$,
a map $N \to N_2$, and elements $n_i \in N$, $i=1,\ldots,r$ such that
(a) $n_i$ maps to $k_i$, (b) the element $y = \sum_i n_i \otimes m_i$
maps to zero in $N \otimes_R M$. Let $K \subset N$
be the submodule generated by the $n_i$. It suffices to show that
$y$ is zero as an element of $K' \otimes_R M$.

\medskip\noindent
We do this by induction on the minimal number of generators of
$N$. If this number is $>1$ then we can find a short exact
sequence
$0 \to N' \to N \to N''\to 0$
such that $N'$ and $N''$ are finitely generated with a smaller
number of generators. By induction the element $y$ maps
to zero in $K'' \otimes_R M$ with $K''$ the image of $K$
in $N''$. And by the right exactness of $\otimes$ we see
that $y$ comes from some element of $K' \otimes_R M$
where $K'$ is the intersection of $K$ with $N'$. Again
by induction we see that $y' = 0$.

\medskip\noindent
The base case of the induction above is when
$N$ is generated by $1$ element. In other words
$N = R/I$, and then $y = \sum g_i \otimes m_i$,
Let $J = (g_1,\ldots,g_r) \subset R$.
By right exactness, we see that $R/I \otimes_R M
= M/IM$. Our assumption is that $y$ is zero
in $R/I \otimes_R M = M/IM$ in other words
$\sum g_im_i \in IM$, in other words
$\sum g_im_i = \sum h_j m'_j$ for suitable
$h_j \in I$. We may replace $I$ by the finitely
generated ideal $(h_j)$ without modifying the assumptions.
In this case we have $K = J+I/I$
$$
K\otimes_R M
=
(J+I)\otimes_R M /I\otimes_R M
=
(J+I)M / IM
$$
the first equality by right exactness
and the second by assumption on $M$.
Thus $y$ is zero in $K\otimes_RM$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-flat-base-change}
Suppose that $M$ is flat over $R$, and that $R \to R'$
is a ring map. Then $M\otimes_R R'$ is flat over $R'$.
\end{lemma}

\begin{proof}
For any $R'$-module $N$ we have a canonical
isomorphism $N \otimes_{R'} (R'\otimes_R M)
= N \otimes_R M$. Hence the exactness of
$-\otimes_{R'}(R'\otimes_R M)$ follows from
the exactness of $-\otimes_R M$.
\end{proof}

\noindent
We say the relation $\sum f_i x_i$
is {\it trivial} if there exist an integer $m \geq 0$,
elements $y_j$, $j=1,\ldots, m$, and elements $g_{ij} \in R$,
$i=1,\ldots,n$, $j=1,\ldots,m$ such that
$$
x_i = \sum\nolimits_j a_{ij} y_j, \forall j,
\text{ and }
0 = \sum\nolimits_i f_ia_{ij}, \forall i.
$$

\begin{lemma}
\label{lemma-flat-eq}
(Equational criterion of flatness.)
A module $M$ over $R$ is flat if and only if
every relation in $M$ is trivial.
\end{lemma}

\begin{proof}
Assume $M$ is flat and let $\sum f_i x_i$ be a relation.
Let $I = (f_1,\ldots,f_n)$, and let $K = \text{ker}(R^n \to I)$.
So we have the short exact sequence
$0\to K \to R^n \to I\to 0$. Then $\sum f_i \otimes x_i$
is an element of $I\otimes_R M$ which maps
to zero in $R\otimes_R M = M$. By flatness
$\sum f_i \otimes x_i$ is zero in $I\otimes_R M$.
Thus there exists an element of $K\otimes_R M$ mapping
to $\sum e_i \otimes m_i \in R^n\otimes_R M$.
Write this element as $\sum k_j \otimes y_j$
and then write the image of $k_j$ in $R^n$ as
$\sum a_{ij} e_i$ to get the result.

\medskip\noindent
Assume every relation is trivial, let $I$
be a finitely generated ideal, and let $x = \sum f_i\otimes x_i$
be an element of $I\otimes_R M$ mapping to zero in $R\otimes_R M = M$.
This just means exactly that $\sum h_i x_i$ is a relation in
$M$. And the fact that it is trivial implies easily that
$x$ is zero, because
$$
x
=
\sum f_i \otimes x_i
=
\sum f_i \otimes (\sum a_{ij}y_j)
=
\sum (\sum f_i a_{ij}) \otimes y_j
=
0
$$
\end{proof}

\begin{lemma}
\label{lemma-flat-tor-zero}
Suppose that $R$ is a ring, $0 \to M'' \to M' \to M \to 0$
a short exact sequence, and $N$ an $R$-module. If $M$ is flat
then $N\otimes_R M'' \to N\otimes_R M'$ is injective.
\end{lemma}

\begin{proof}
Let $R^{(I)} \to N$ be a surjection from a free module
onto $N$ with kernel $K$. The result follows
by a simple diagram chase from the following diagram
$$
\begin{matrix}
&
&
0
&
&
0
&
&
0
&
&
\\
&
&
\uparrow
&
&
\uparrow
&
&
\uparrow
&
&
\\
&
&
M''\otimes_R N
&
\to
&
M' \otimes_R N
&
\to
&
M\otimes_R N
&
\to
&
0
\\
&
&
\uparrow
&
&
\uparrow
&
&
\uparrow
&
&
\\
0
&
\to
&
(M'')^{(I)}
&
\to
&
(M')^{(I)}
&
\to
&
M^{(I)}
&
\to
&
0
\\
&
&
\uparrow
&
&
\uparrow
&
&
\uparrow
&
&
\\
&
&
M''\otimes_R N
&
\to
&
M' \otimes_R N
&
\to
&
M\otimes_R N
&
\to
&
0
\\
&
&
&
&
&
&
\uparrow
&
&
\\
&
&
&
&
&
&
0
&
&
\end{matrix}
$$
with exact rows and columns. The middle row is exact because tensoring
with the free module $R^{(I)}$ is exact.
\end{proof}


\begin{lemma}
\label{lemma-flat-ses}
Suppose that $0 \to M' \to M \to M''\to 0$ is
a short exact sequence of $R$-modules.
If $M'$ and $M''$ are flat so is $M$.
If $M$ and $M''$ are flat so is $M'$.
\end{lemma}

\begin{proof}
We will use the criterion that a module $N$ is $R$ flat if for
every ideal the map $N\otimes_RI \to N$ is injective,
see Lemma \ref{lemma-flat}.
Consider an ideal $I \subset R$.
Consider the diagram
$$
\begin{matrix}
0
&
\to 
&
M'
&
\to
&
M
&
\to
&
M''
&
\to
&
0
\\
&
&
\uparrow
&
&
\uparrow
&
&
\uparrow
&
&
\\
& 
&
M'\otimes_R I
&
\to
&
M\otimes_R I
&
\to
&
M''\otimes_R I
&
\to
&
0
\end{matrix}
$$
with exact rows. This immediately proves the first assertion.
The second follows because if $M''$ is flat then the lower left 
horizontal arrow is injective by Lemma \ref{lemma-flat-tor-zero}.
\end{proof}

\begin{lemma}
\label{lemma-characterize-zero-local}
An $R$-module $M$ is zero if and only if $M_{\mathfrak p}$ is
zero for all $\mathfrak p \in \text{Spec}(R)$.
\end{lemma}

\begin{proof}
Suppose $M_{\mathfrak p} = 0$ for all primes. 
Let $m \in M$. Let $I = \{f \in R \mid fm = 0\}$.
It is easy to see that $I$ is an ideal (it is the
annihilator of $m$). The condition means that for
all primes $\mathfrak p$ there exists an $f \in R \setminus
\mathfrak p$ such that $fm =0$. In other words,
we have $V(I) = \emptyset$. According to Lemma 
\ref{lemma-Zariski-topology} $I$ is the unit ideal.
Hence $m$ is zero.
\end{proof}

\begin{lemma}
\label{lemma-easy-ff}
An $R$-module $M$ is faithfully flat if and only if $M$ is flat
and for all maps $\alpha : N \to N'$ we have 
$\alpha = 0$ if and only if $\alpha \otimes \text{id}_M = 0$.
\end{lemma}

\begin{proof}
If $M$ is faithfully flat $0 \to \text{Ker}(\alpha)
\to N \to 0$ is exact if and only if the same holds
after tensoring with $M$. This proves one direction.
For the other, let $N_1 \to N_2 \to N_3$
be a complex, and assume the complex
$N_1 \otimes_R M \to N_2 \otimes_R M \to N_3\otimes_R M$
is exact. Take $x \in \text{Ker}(N_2 \to N_3)$,
and consider the map $\alpha : R\to N_2/\text{Im}(N_1)$,
$r \mapsto rx + \text{Im}(N_1)$. By the exactness
of the complex $-\otimes_R M$ we see that $\alpha \otimes 
\text{id}_M$ is zero. By assumption we get that $\alpha$ is
zero. Hence $x $ is in the image of $N_1 \to N_2$.
\end{proof}

\begin{lemma}
\label{lemma-ff}
Let $M$ be a flat $R$-module.
The following are equivalent:
\begin{enumerate}
\item $M$ is faithfully flat,
\item for all $\mathfrak p \in \text{Spec}(R)$
the tensor product $M\otimes_R \kappa(\mathfrak p)$ is nonzero, and
\item for all maximal ideals $\mathfrak m$ of $R$
the tensor product $M\otimes_R \kappa(\mathfrak m) = M/{\mathfrak m}M$
is nonzero.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume $M$ faithfully flat. Since $R \to \kappa({\mathfrak p})$ is not
zero we deduce that $M \to M \otimes_R \kappa({\mathfrak p})$ is not zero,
see Lemma \ref{lemma-easy-ff}.

\medskip\noindent
Conversely assume that $M$ is flat and that
$M/{\mathfrak m}M$ is never zero.
Suppose that $N_1 \to N_2 \to N_3$ is a complex and
suppose that $N_1 \otimes_R M \to N_2\otimes_R M \to
N_3\otimes_R M$ is exact. Let $H$ be the cohomology of the complex,
so $H = \text{Ker}(N_2 \to N_3)/\text{Im}(N_1 \to N_2)$.
By flatness we see that $H \otimes_R M = 0$. 
Take $x \in H$ and let $I = \{f \in R \mid fx = 0 \}$
be its annihilator. Since $R/I \subset H$ we get
$M/IM \subset H\otimes_R M = 0$ by flatness of $M$.
If $I \not=  R$ we may choose
a maximal ideal $I \subset \mathfrak m \subset R$.
This immediately gives a contradiction.
\end{proof}

\begin{lemma}
\label{lemma-ff-rings}
Let $R \to S$ be a flat ring map.
The following are equivalent:
\begin{enumerate}
\item $R \to S$ is faithfully flat,
\item the induced map on $\text{Spec}$ is surjective, and
\item any closed point $x \in \text{Spec}(R)$ is
in the image of the map $\text{Spec}(S) \to \text{Spec}(R)$.
\end{enumerate}
\end{lemma}

\begin{proof}
This follows quickly from Lemma \ref{lemma-ff}, because we
saw in Remark \ref{remark-fundamental-diagram}
that $\mathfrak p$ is in the image
if and only if the ring $S \otimes_R \kappa(\mathfrak p)$
is nonzero.
\end{proof}

\begin{lemma}
\label{lemma-local-flat-ff}
A flat local ring homomorphism of local rings is faithfully flat.
\end{lemma}

\begin{proof}
Immediate from Lemma \ref{lemma-ff-rings}.
\end{proof}

\begin{lemma}
\label{lemma-flat-going-down}
Let $R\to S$ be flat. Let $\mathfrak p \subset \mathfrak p'$
be primes of $R$. Let $\mathfrak q' \subset S$ be a prime of $S$
mapping to $\mathfrak p'$. Then there exists a prime
$\mathfrak q \subset \mathfrak q'$ mapping to $\mathfrak p$.
\end{lemma}

\begin{proof}
Namely, consider the flat local ring map
$R_{\mathfrak p'} \to S_{\mathfrak q'}$.
By Lemma \ref{lemma-local-flat-ff} above this is faithfully
flat. By Lemma \ref{lemma-ff-rings} there is a prime mapping to
$\mathfrak p R_{\mathfrak p'}$. The inverse image of this
prime in $S$ does the job.
\end{proof}

\noindent
The property of $R \to S$ described in the lemma is called the
``going down property''. See Definition \ref{definition-going-up-down}.















\section{Going up and going down}
\label{section-going-up}

\noindent
Suppose $\mathfrak p$, $\mathfrak p'$ are primes
of the ring $R$. Let $X = \text{Spec}(R)$ with the Zariski
topology. Denote $x \in X$ the point corresponding 
to $\mathfrak p$ and $x' \in X$ the point corresponding
to $\mathfrak p'$. Then we have:
$$
x' \leadsto x \Leftrightarrow \mathfrak p' \subset \mathfrak p.
$$
In words: $x$ is a specialization of $x'$ if and
only if $\mathfrak p' \subset \mathfrak p$.
See Topology, Section \ref{topology-section-specialization}
for terminology and notation.

\begin{definition}
\label{definition-going-up-down}
Let $\varphi : R \to S$ be a ring map.
\begin{enumerate}
\item We say a $\varphi : R \to S$ satisfies {\it going up} if
given primes $\mathfrak p \subset \mathfrak p'$ in $R$
and a prime $\mathfrak q$ in $S$ lying over $\mathfrak p$
there exists a prime $\mathfrak q'$ of $S$ such that
(a) $\mathfrak q \subset \mathfrak q'$, and (b) 
$\mathfrak q'$ lies over $\mathfrak p'$.
\item We say a $\varphi : R \to S$ satisfies {\it going down} if
given primes $\mathfrak p \subset \mathfrak p'$ in $R$
and a prime $\mathfrak q'$ in $S$ lying over $\mathfrak p'$
there exists a prime $\mathfrak q$ of $S$ such that
(a) $\mathfrak q \subset \mathfrak q'$, and (b) 
$\mathfrak q$ lies over $\mathfrak p$.
\end{enumerate}
\end{definition}

\noindent
Sofar we have see the following cases of this:
\begin{enumerate}
\item An integral ring map satisfies going up, see
Lemma \ref{lemma-integral-going-up}.
\item As a special case maps of the form $R \to R/I$ satisfy
going up.
\item A flat ring map satisfies going down, see
Lemma \ref{lemma-flat-going-down}
\item As a special case any localization satisfies going down.
\item An extension $R \subset S$ of domains, with $R$ normal
and $S$ integral over $R$ satisfies going down, see
Proposition \ref{proposition-going-down-normal-integral}.
\end{enumerate}

\begin{lemma}
\label{lemma-going-up-down-specialization}
Let $R \to S$ be a ring map.
\begin{enumerate}
\item $R \to S$ satisfies going down if and only if
generalizations lift along $\text{Spec}(S) \to \text{Spec}(R)$,
see Topology, Definition \ref{topology-definition-lift-specializations}.
\item $R \to S$ satisfies going up if and only if
specializations lift along $\text{Spec}(S) \to \text{Spec}(R)$,
see Topology, Definition \ref{topology-definition-lift-specializations}.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-going-up-down-composition}
Suppose $R \to S$ and $S \to T$ are ring maps satisfying
going down. Then so does $R \to T$. Similarly for going up.
\end{lemma}

\begin{proof}
According to Lemma \ref{lemma-going-up-down-specialization}
this follows from 
Topology, Lemma \ref{topology-lemma-lift-specialization-composition}
\end{proof}

\begin{lemma}
\label{lemma-image-stable-specialization-closed}
Let $R \to S$ be a ring map. Let $T \subset \text{Spec}(R)$
be the image of $\text{Spec}(S)$. If $T$ is stable under specialization,
then $T$ is closed.
\end{lemma}

\begin{proof}
Let $\mathfrak p \subset R$ be a prime ideal such that
the corresponding point of $\text{Spec}(R)$ is in the closure
of $T$. This means that for ever $f \in R$, $f \not \in \mathfrak p$
we have $D(f) \cap T \not = \emptyset$. Note that $D(f) \cap T$
is the image of $\text{Spec}(S_f)$ in $\text{Spec}(R)$. Hence
we conclude that $S_f \not = 0$. In other words, $1 \not = 0$ in
the ring $S_f$. Since $S_{\mathfrak p}$ is the directed limit
of the rings $S_f$ we conclude that $1 \not = 0$ in
$S_{\mathfrak p}$. In other words, $S_{\mathfrak p} \not = 0$ and
considering the image of $\text{Spec}(S_{\mathfrak p})
\to \text{Spec}(S) \to \text{Spec}(R)$ we see there exists
a $\mathfrak p' \in T$ with $\mathfrak p' \subset \mathfrak p$.
As we assumed $T$ closed under specialization we conclude $\mathfrak p$
is a point of $T$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-going-up-closed}
Let $R \to S$ be a ring map. The following are equivalent:
\begin{enumerate}
\item Going up holds for $R \to S$, and
\item the map $\text{Spec}(S) \to \text{Spec}(R)$ is closed.
\end{enumerate}
\end{lemma}

\begin{proof}
It is a general fact that specializations lift along a
closed map of topological spaces, see Topology 
Lemma \ref{topology-lemma-closed-open-map-specialization}.
Hence the second condition implies the first.

\medskip\noindent
Assume that going up holds for $R \to S$.
Let $V(I) \subset \text{Spec}(S)$ be a closed set.
We want to show that the image of $V(I)$ in $\text{Spec}(R)$ is closed.
The ring map $S \to S/I$ obviously satisfies going up.
Hence $R \to S \to S/I$ satisfies going up,
by Lemma \ref{lemma-going-up-down-composition}.
Replacing $S$ by $S/I$ it suffices to show the image $T$
of $\text{Spec}(S)$ in $\text{Spec}(R)$ is closed.
By Topology, Lemmas \ref{topology-lemma-open-closed-specialization}
and \ref{topology-lemma-lift-specializations-images} this 
image is stable under specialization. Thus the result follows
from Lemma \ref{lemma-image-stable-specialization-closed}.
\end{proof}

\begin{lemma}
\label{lemma-constructible-stable-specialization-closed}
Let $R$ be a ring. Let $E \subset \text{Spec}(R)$ be a constructible subset.
\begin{enumerate}
\item If $E$ is stable under specialization, then $E$ is closed.
\item If $E$ is stable under generalization, then $E$ is open.
\end{enumerate}
\end{lemma}

\begin{proof}
The first assertion
follows from Lemma \ref{lemma-image-stable-specialization-closed}
combined with Lemma \ref{lemma-constructible-is-image}.
The second follows because the complement of a constructible
set is constructible
(see Topology, Lemma \ref{topology-lemma-constructible}),
the first part of the lemma and Topology,
Lemma \ref{topology-lemma-open-closed-specialization}.
\end{proof}

\begin{proposition}
\label{proposition-fppf-open}
Let $R \to S$ be flat and of finite presentation.
Then $\text{Spec}(R) \to \text{Spec}(S)$ is open.
More generally this holds for any ring map $R \to S$ of
finite presentation which satisfies going down.
\end{proposition}

\begin{proof}
Assume that $R \to S$ has finite presentation and satisfies
going down. 
It suffices to prove that the image of a standard open $D(f)$ is open.
Since $S \to S_f$ satsifies going down as well, we see that
$R \to S_f$ satisfies going down. Thus after replacing
$S$ by $S_f$ we see it suffices to prove the image is
open. By Chevalley's theorem \ref{theorem-chevalley}
the image is a constructible set $E$. And $E$ is stable
under generalization because $R \to S$ satisfies going down,
see Topology, Lemmas \ref{topology-lemma-open-closed-specialization}
and \ref{topology-lemma-lift-specializations-images}.
Hence $E$ is open by
Lemma \ref{lemma-constructible-stable-specialization-closed}.
\end{proof}

























\section{More Noetherian rings}
\label{section-Noetherian-again}


\begin{lemma}
\label{lemma-Noetherian-basic}
Let $R$ be a Noetherian ring.
Any finite $R$-module is of finite presentation; any submodule
of a finite $R$-module is finite.
\end{lemma}

\begin{proof}
We first show that any submodule $N$ of a finite $R$-module 
$M$ is finite. We do this by induction on the number of
generators of $M$. If this number is $1$, then $N = J/I \subset
M = R/I$ for some ideals $I \subset J \subset R$. Thus the definition
of Noetherian implies the result. If the number of generators of
$M$ is greater than $1$, then we can find a short exact sequence
$0 \to M' \to M \to M'' \to 0$ where $M'$ and $M''$ have fewer
generators. Note that setting $N' = M' \cap N$ and $N'' = \text{Im}(N\to
M'')$ gives a similar short exact sequence for $N$. Hence the result
follows from the induction hypothesis 
since the number of generators of $N$ is at most the number of
generators of $N'$ plus the number of generators of $N''$.

\medskip\noindent
To show that $M$ is finitely presented just apply the previous result
to the kernel of a presentation $R^n \to M$.
\end{proof}

\begin{definition}
\label{definition-locally-nilpotent-ideal}
Let $R$ be a ring. Let $I \subset R$ be an ideal.
We say $I$ is {\it locally nilpotent} if for every
$x \in I$ there exists an $n \in \mathbf{N}$ such
that $x^n = 0$. We say $I$ is {\it nilpotent} if
there exists an $n \in \mathbf{N}$ such that $I^n = 0$.
\end{definition}

\begin{lemma}
\label{lemma-Noetherian-power}
Let $R$ be a Noetherian ring. Let $I, J$ be ideals of $R$.
Suppose $J \subset \sqrt{I}$. Then $J^n \subset I$ for some $n$.
In particular, in a Noetherian ring the notions of
``locally nilpotent ideal''
and ``nilpotent ideal'' coincide.
\end{lemma}

\begin{proof}
Say $J = (f_1,\ldots,f_s)$. 
By assumption $f_i^{d_i} \in I$. 
Take $n = d_1 + d_2 + \ldots + d_s + 1$.
\end{proof}

\begin{lemma}
\label{lemma-Artin-Rees}
(Artin-Rees lemma)
Suppose that $R$ is Noetherian, $I \subset R$ an ideal.
Let $N \subset M$ be finite $R$-modules.
There exists a constant $c > 0$ such that
$I^n M \cap N  =  I^{n-c}(I^cM \cap N)$.
\end{lemma}

\begin{proof}
Consider the ring $S = R \oplus I \oplus I^2 \oplus \ldots
= \bigoplus_{n \geq 0} I^n$. Convention: $I^0 = R$.
Multiplication maps $I^n \times I^m$
into $I^{n+m}$ by multiplication in $R$.
Note that if $I = (f_1, \ldots, f_t)$
then $S$ is a quotient of the Noetherian ring $R[X_1,\ldots,X_t]$.
The map just sends the monomial $X_1^{e_1}\ldots X_t^{e_t}$
to $f_1^{e_1}\ldots f_t^{e_t}$. Thus $S$ is Noetherian. 
Similarly, consider the module $M \oplus IM \oplus I^2M \oplus \ldots
= \bigoplus_{n \geq 0} I^nM$. This is a finitely generated $S$-module.
Namely, if $x_1,\ldots,x_r$ generate $M$ over $R$, then they also generate
$\bigoplus_{n \geq 0} I^nM$ over $S$. Next, consider the
submodule $\bigoplus_{n \geq 0} I^nM \cap N$.
This is an $S$-submodule, as is easily verified. By
Lemma \ref{lemma-Noetherian-permanence} it is finitely generated as
an $S$-module,
say by $\xi_j \in \bigoplus_{n \geq 0} I^nM \cap N$, $j = 1,\ldots,s$.
We may assume by decomposing each $\xi_j$ into its homogeneous
pieces that each $\xi_j \in I^{d_j}M \cap N$ for some $d_j$.
Set $c = \max\{d_j\}$. Then for all $n \geq c$ every element
in $I^nM \cap N$ is of the form $\sum h_j \xi_j$ with
$h_j \in I^{n - d_j}$. The lemma now follows from this and the trivial 
observation that $I^{n-d_j}(I^{d_j}M \cap N) \subset I^{n-c}(I^cM \cap N)$.
\end{proof}

\begin{lemma}
\label{lemma-map-AR}
Suppose that $0 \to K \to M \xrightarrow{f} N$ is an
exact sequence of finitely generated modules
over a Noetherian ring $R$. Let $I \subset R$ be an ideal.
Then there exists a $c$ such that $f^{-1}(I^nN)
= K + I^{n-c}f^{-1}(I^cN)$ for all $n \geq c$.
\end{lemma}

\begin{proof}
Apply Lemma \ref{lemma-Artin-Rees} to
$\text{Im}(f) \subset N$ and note that
$f : I^{n-c}M \to I^{n-c}f(M)$ is surjective.
\end{proof}

\begin{lemma}
\label{lemma-intersect-powers-ideal-module-zero}
Let $R$ be a Noetherian local ring. Let $I \subset R$ be
a proper ideal. Let $M$ be a finite $R$-module.
Then $\bigcap_{n \geq 0} I^nM = 0$.
\end{lemma}

\begin{proof}
Let $N = \bigcap_{n \geq 0} I^nM$.
Then $N = I^nM \cap N$ for all $n \geq 0$.
By the Artin-Rees Lemma \ref{lemma-Artin-Rees}
we see that $N = I^nM \cap N \subset IN$ for
some suitably large $n$. By Nakayama's Lemma \ref{lemma-NAK}
we see that $N = 0$.
\end{proof}

\begin{lemma}
\label{lemma-intersection-powers-ideal-module}
Let $R$ be a Noetherian ring.
Let $I \subset R$ be an ideal.
Let $M$ be a finite $R$-module.
Let $N = \bigcap_n I^n M$. 
For every prime $\mathfrak p$,
$I \subset \mathfrak p$ there
exists a $f \in R$, $f \not \in \mathfrak p$
such that $N_f = 0$.
\end{lemma}

\begin{proof}
Let $x_1,\ldots, x_n$ be generators for the module $N$,
see Lemma \ref{lemma-Noetherian-basic}. For every prime
$\mathfrak p$, $I \subset \mathfrak p$ we see that
the image of $N$ in the localization $M_{\mathfrak p}$
is zero, by Lemma \ref{lemma-intersect-powers-ideal-module-zero}.
Hence we can find $g_i \in R$, $g_i \not \in \mathfrak p$
such that $x_i$ maps to zero in $N_{g_i}$. Thus
$N_{g_1g_2\ldots g_n} = 0$.
\end{proof}

\begin{remark}
\label{remark-intersection-powers-ideal}
Lemma \ref{lemma-intersect-powers-ideal-module-zero} 
in particular implies that $\bigcap_n I^n = (0)$
when $I \subset R$ is a non-unit ideal in a Noetherian
local ring $R$. More generally, let $R$ be a Noetherian ring and
$I \subset R$ an ideal. Suppose that $f \in \bigcap_{n \in \mathbf{N}} I^n$.
Then Lemma \ref{lemma-intersection-powers-ideal-module}
says that for every prime ideal $I \subset \mathfrak p$
there exists a $g \in R$, $g \not \in \mathfrak p$
such that $f$ maps to zero in $R_g$. In algebraic geometry we
express this by saying that ``$f$ is zero in an open neighbourhood
of the closed set $V(I)$ of $\text{Spec}(R)$''.
\end{remark}

\begin{lemma}
\label{lemma-Artin-Tate}
(Artin-Tate) Let $R$ be a Noetherian ring. Let $S$ be a finitely
generated $R$-algebra. If $T \subset S$ is an $R$-subalgebra such
that $S$ is finitely generated as a $T$-module, then $T$ is a
finite type over $R$.
\end{lemma}

\begin{proof}
Choose $x_1,\ldots,x_n \in S$ which generate $S$ as an $R$-algebra.
Choose $y_1,\ldots,y_m$ in $S$ which generate $S$ as a $T$-module.
Thus there exist $a_{ij} \in T$ such that
$x_i = \sum a_{ij} y_j$. There also exist $b_{ijk} \in T$ such
that $y_i y_j = \sum b_{ijk} y_k$. Let $T' \subset T$ be the
sub $R$-algebra generated by $a_{ij}$ and $b_{ijk}$. This is a finitely
generated $R$-algebra, hence Noetherian. Consider the algebra
$$
S' = T'[Y_1, \ldots, Y_m]/(Y_i Y_j - \sum b_{ijk} Y_k).
$$
Note that $S'$ is finite over $T'$, namely as a $T'$-module it is 
generated by the classes of $1, Y_1,\ldots, Y_m$.
Consider the $T'$-algebra homomorphism $S' \to S$ which maps
$Y_i$ to $y_i$. Because $a_{ij} \in T'$ we see that $x_j$ is
in the image of this map. Thus $S' \to S$ is surjective. 
Therefore $S$ is finite over $T'$ as well. Since $T'$ is Noetherian
and we conclude that $T \subset S$ is finite over $T'$ and
we win.
\end{proof}























\section{Length}
\label{section-length}

\noindent
Let $R$ be a ring. For any $R$-module $M$
we define the {\it length} of $M$ over $R$ by the
formula
$$
\text{length}_R(M)
=
\sup
\{
n
\mid
\exists\ 0=M_0 \subset M_1 \subset \ldots \subset M_n=M,
\text{ }M_i \not= M_{i+1}
\}.
$$
In other words it is the supremum of the lengths of chains 
of submodules. There is an obvious notion of when a chain
of submodules is a refinement of another. This gives a partial
ordering on the collection of all chains of submodules,
with the smallest chain having the shape $0 = M_0 \subset M_1 = M$
if $M$ is not zero.
We note the obvious fact that if the length of
$M$ is finite, then every chain can be refined to a
maximal chain. But it is not as obvious that all maximal
chains have the same length (as we will see later).

\begin{lemma}
\label{lemma-length-additive}
If $0 \to M' \to M \to M'' \to 0$
is a short exact sequence of modules over $R$ then
the length of $M$ is the sum of the
lengths of $M'$ and $M''$.
\end{lemma}

\begin{proof}
Given filtrations of $M'$ and $M''$ of lengths $n', n''$
it is easy to make a corresponding filtration of $M$ 
of length $n' + n''$. Thus we see that $\text{length}_R M
\geq \text{length}_R M' + \text{length}_R M''$.
Conversely, given a filtration
$M_0 \subset M_1 \subset \ldots \subset M_n$ of
$M$ consider the induced filtrations
$M_i' = M_i \cap M'$ and $M_i'' = \text{Im}(M_i \to M'')$.
Let $n'$ (resp.\ $n''$) be the number of steps in the filtration
$\{M'_i\}$ (resp.\ $\{M''_i\}$).
If $M_i' = M_{i+1}'$ and $M_i'' = M_{i+1}''$ then
$M_i = M_{i+1}$. Hence we conclude that $n' + n'' \geq n$.
Combined with the earlier result we win.
\end{proof}

\begin{lemma}
\label{lemma-length-infinite}
Let $R$ be a local ring with maximal ideal $\mathfrak m$.
If $M$ is a finite $R$-module such that
$\mathfrak m^n M \not = 0$ for all $n\geq 0$,
then $\text{length}_R(M) = \infty$.
\end{lemma}

\begin{proof}
By NAK, Lemma \ref{lemma-NAK} all the steps in the filtration
$0 \subset \mathfrak m^n M 
\subset \mathfrak m^{n-1} M \subset \ldots \subset
\mathfrak m M \subset M$ are distinct.
\end{proof}

\begin{lemma}
\label{lemma-length-independent}
Let $R \to S$ be a ring map.
Let $M$ be an $S$-module. 
Then $\text{length}_R(M) \geq \text{length}_S(M)$.
If $R \to S$ is surjective then equality holds.
\end{lemma}

\begin{proof}
A filtration of $M$ by $S$-submodules gives rise a filtration
of $M$ by $R$-submodules. This proves the inequality.
And if $R \to S$ is surjective, then any $R$-submodule
of $M$ is automatically a $S$-submodule. Hence equality
in this case.
\end{proof}

\begin{lemma}
\label{lemma-dimension-is-length}
Let $R$ be a ring with maximal ideal $\mathfrak m$.
Suppose that $M$ is an $R$-module with
$\mathfrak m M  =  0$. Then the length of $M$ as
an $R$-module agrees with the dimension of $M$ as
a $R/\mathfrak m$ vector space. 
The length is finite if and only if $M$ is a finite $R$-module.
\end{lemma}

\begin{proof}
The first part is a special case of Lemma \ref{lemma-length-independent}.
Thus the length is finite if and only if $M$ has a finite basis
as a $R/\mathfrak m$-vector space if and only if $M$ has a finite
set of generators as an $R$-module.
\end{proof}

\begin{lemma}
\label{lemma-length-localize}
Let $R$ be a ring. Let $M$ be an $R$-module. Let $S \subset R$ be
a multiplicative subset. Then
$\text{length}_R(M) \geq \text{length}_{S^{-1}R}(S^{-1}M)$.
\end{lemma}

\begin{proof}
Any submodule $N' \subset S^{-1}M$ is of the form
$S^{-1}N$ for some $R$-submodule $N \subset M$, by Lemma
\ref{lemma-submodule-localization}. The lemma follows.
\end{proof}

\begin{lemma}
\label{lemma-length-finite}
Let $R$ be a local ring with finitely generated
maximal ideal $\mathfrak m$. (For example $R$ Noetherian.)
Suppose that $M$ is a finite $R$-module with
$\mathfrak m^n M  =  0$ for some $n$. 
Then $\text{length}_R(M) < \infty$.
\end{lemma}

\begin{proof}
Consider the filtration
$0 = \mathfrak m^n M \subset
\mathfrak m^{n-1} M \subset
\ldots \subset \mathfrak m M \subset M$.
All of the subquotients are finitely generated $R$-modules
to which Lemma \ref{lemma-dimension-is-length} applies. We conclude
by additivity, see Lemma \ref{lemma-length-additive}.
\end{proof}

\begin{definition}
\label{definition-simple-module}
Let $R$ be a ring. Let $M$ be an $R$-module.
We say $M$ is {\it simple} if $M \not = 0$ and
every submodule of $M$ is either equal to $M$ or
to $0$.
\end{definition}

\begin{lemma}
\label{lemma-characterize-length-1}
Let $R$ be a ring. Let $M$ be an $R$-module.
The following are equivalent:
\begin{enumerate}
\item $M$ is simple,
\item $\text{length}_R(M) = 1$, and
\item $M \cong R/\mathfrak m$ for some maximal ideal
$\mathfrak m \subset R$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $\mathfrak m$ be a maximal ideal of $R$.
By Lemma \ref{lemma-dimension-is-length} the module
$R/\mathfrak m$ has length $1$. The equivalence of
the first two assertions is tautological. 
Suppose that $M$ is simple. Choose $x \in M$, $x \not = 0$.
As $M$ is simple we have $M = R \cdot x$. 
Let $I \subset R$ be the annihilator of $x$, i.e.,
$I = \{f \in R \mid fx = 0\}$. The map $R/I \to M$,
$f \bmod I \mapsto fx$ is an isomorphism, hence
$R/I$ is a simple $R$-module. Since $R/I \not = 0$ we see $I \not = R$.
Let $I \subset \mathfrak m$ be a maximal ideal containing $I$.
If $I \not = \mathfrak m$, then $\mathfrak m /I \subset R/I$
is a nontrivial submodule contradicting the simplicity
of $R/I$. Hence we see $I = \mathfrak m$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-simple-pieces}
Let $R$ be a ring. Let $M$ be a finite length $R$-module.
Let $\ell = \text{length}_R(M)$. Choose any maximal chain of
submodules
$$
0 = M_0 \subset M_1 \subset M_2 \subset \ldots \subset M_n = M
$$
with $M_i \not = M_{i-1}$, $i=1,\ldots,n$. Then
\begin{enumerate}
\item $n = \ell$,
\item each $M_i/M_{i-1}$ is simple,
\item each $M_i/M_{i-1}$ is of the form
$R/\mathfrak m_i$ for some maximal ideal $\mathfrak m_i$,
\item given a maximal ideal $\mathfrak m \subset R$
we have
$$
\# \{i \mid \mathfrak m_i = \mathfrak m\}
=
\text{length}_{R_{\mathfrak m}} (M_{\mathfrak m}).
$$
\end{enumerate}
\end{lemma}

\begin{proof}
If $M_i/M_{i-1}$ is not simple then we can refine the filtration
and the filtration is not maximal. Thus we see that $M_i/M_{i-1}$
is simple. By Lemma \ref{lemma-characterize-length-1} the modules
$M_i/M_{i-1}$ have length $1$ and are of the form $R/\mathfrak m_i$
for some maximal ideals $\mathfrak m_i$. By additivity of length,
Lemma \ref{lemma-length-additive}, we see $n = \ell$. Since localization
is exact, we see that
$$
0 = (M_0)_{\mathfrak m}
\subset (M_1)_{\mathfrak m}
\subset (M_2)_{\mathfrak m}
\subset \ldots
\subset (M_n)_{\mathfrak m} = M_{\mathfrak m}
$$
is a filtration of $M_{\mathfrak m}$ with successive quotients
$(M_i/M_{i-1})_{\mathfrak m}$. Thus the last statement follows
directly from the fact that given maximal ideals $\mathfrak m$,
$\mathfrak m'$ of $R$ we have
$$
(R/\mathfrak m')_{\mathfrak m}
\cong
\left\{
\begin{matrix}
0 &
\text{if } \mathfrak m \not = \mathfrak m', \\
R_{\mathfrak m}/\mathfrak m R_{\mathfrak m} &
\text{if } \mathfrak m  = \mathfrak m'
\end{matrix} \right.
$$
This we leave to the reader.
\end{proof}





\section{Artinian rings}
\label{section-artinian}

\begin{definition}
\label{definition-artinian}
A ring $R$ is {\it Artinian} if it satisfies the 
descending chain condition for ideals.
\end{definition}

\begin{lemma}
\label{lemma-finite-dimensional-algebra}
Suppose $R$ is a finite dimensional algebra over a field.
Then $R$ is Artinian.
\end{lemma}

\begin{proof}
The descending chain condition for ideals obviously holds.
\end{proof}

\begin{lemma}
\label{lemma-artinian-finite-nr-max}
If $R$ is Artinian then $R$ has only finitely many
maximal ideals.
\end{lemma}

\begin{proof}
Suppose that $\mathfrak m_i$, $i=1,2,3,\ldots$ are maximal ideals.
Then $\mathfrak m_1 \supset \mathfrak m_1\cap \mathfrak m_2
\supset \mathfrak m_1 \cap \mathfrak m_2 \cap \mathfrak m_3 \supset \ldots$
is an infinite descending sequence (because by the Chinese
remainder theorem all the maps $R \to \oplus_{i=1}^n R/\mathfrak m_i$
are surjective).
\end{proof}

\begin{lemma}
\label{lemma-artinian-radical-nilpotent}
Let $R$ be Artinian. The radical $\text{rad}(R)$ of $R$ is
a nilpotent ideal.
\end{lemma}

\begin{proof}
Denote the radical $I$.
Note that $I \supset I^2 \supset I^3 \supset \ldots$ is a descending
sequence. Thus $I^n = I^{n+1}$ for some $n$.
Set $J = \{ x\in R \mid xI^n = 0\}$. We have to show $J = R$.
If not, choose an ideal $J' \not= J$, $J \subset J'$ minimal (possible
by the Artinian property). Then $J' = J + Rx$ for some $x \in R$.
By NAK, Lemma \ref{lemma-NAK}, we have $IJ' \subset J$.
Hence $xI^{n+1} \subset xI \cdot I^n \subset J \cdot I^n = 0$.
Since $I^{n+1}=I^n$ we conclude $x\in J$. Contradiction.
\end{proof}

\begin{lemma}
\label{lemma-lift-idempotents}
Let $R$ be a ring. Let $I \subset R$ be a locally nilpotent ideal.
Then $R \to R/I$ induces a bijection on idempotents.
\end{lemma}

\begin{proof}[First proof of Lemma \ref{lemma-lift-idempotents}]
As $I$ is locally nilpotent is is contained in every prime ideal.
Hence $\text{Spec}(R/I) = V(I) = \text{Spec}(R)$. Hence the
lemma follows from Lemma \ref{lemma-disjoint-decomposition}.
\end{proof}

\begin{proof}[Second proof of Lemma \ref{lemma-lift-idempotents}]
First assume $I$ is nilpotent.
Suppose $\overline{e} \in R/I$ is an idempotent.
We have to lift $\overline{e}$ to an idempotent of $R$.
Choose a lift $e \in R$ such that $x = e^2 - e \in I^k$ for some
$k\geq 1$. Let $e' = e - (2e-1)x$, which is another lift of $\overline{e}$
and compute $(e')^2 - e' =
e^2 - 2(2e-e)x - e + (2e-1)x \bmod I^{2k} =
x - x \bmod I^{2k} = 0 \bmod I^{2k}$.
By succesively improving the approximation as above we reach a
stage where $I^k = 0$, and we win.

\medskip\noindent
Next, suppose $I$ is locally nilpotent. 
Let $\overline{e} \in R/I$ be an idempotent.
Let $f \in R$ be any element lifting $\overline{e}$.
Denote $R' \subset R$ the $\mathbf{Z}$-subalgebra of $R$ generated
by $f$. Denote $I' = R' \cap I$. Since $R'$ is Noetherian,
see Lemma \ref{lemma-obvious-Noetherian} we see that $I'$ is
nilpotent, see Lemma \ref{lemma-Noetherian-power}. On the other
hand we have $R' / I' \subset R/I$ and hence the image
$\overline{f} \in R'/I'$ of $f$ is an idempotent. 
Thus by the first part of the proof we see that
we can find an idempotent $e \in R'$ which
is a lift of $\overline{f}$.
Then $e \in R$ is also a lift of $\overline{e}$ in $R/I$.
\end{proof}

\begin{lemma}
\label{lemma-product-local}
Any ring with finitely many maximal ideals and
nilpotent radical is the product of its localizations
at its maximal ideals. Also, all primes are maximal.
\end{lemma}

\begin{proof}
Let $R$ be a ring with finitely many maximal ideals
$\mathfrak m_1,\ldots,\mathfrak m_n$. We will use
the Chinse remainder Lemma \ref{lemma-chinese-remainder}.
Let $I = \bigcap_{i=1}^n \mathfrak m_i = \mathfrak m_1 \ldots \mathfrak m_n$
be the radical of $R$. Assume $I^n = 0$.
Since every prime $\mathfrak p$ contains $0$ we see
$ \mathfrak p \supset \mathfrak m_1 \ldots \mathfrak m_n$,
hence $\mathfrak p = \mathfrak m_i$ for some $i$.
Also $R/I \cong \bigoplus R/\mathfrak m_i$
which is a product of fields.
Hence by Lemma \ref{lemma-lift-idempotents}
there are nilpotents $e_i$, $i=1,\ldots,n$
with $e_i \bmod \mathfrak m_j = \delta_{ij}$.
Hence $R = \prod Re_i$, and each $Re_i$ is a
ring with exactly one maximal ideal.
\end{proof}

\begin{lemma}
\label{lemma-artinian-finite-length}
A ring $R$ is Artinian if and only if it has finite length
as a module over itself. Any such ring is both Artinian and
Noetherian, and is equal to the product of its localizations
at its maximal ideals.
\end{lemma}

\begin{proof}
If $R$ has finite length over itself then it satisfies both 
the ascending chain condition and the descending chain
condition for ideals. Hence it is both Noetherian and Artinian.
Any Artinian ring is equal to product of its localizations
at maximal ideals by Lemmas \ref{lemma-artinian-finite-nr-max},
\ref{lemma-artinian-radical-nilpotent}, and \ref{lemma-product-local}.

\medskip\noindent
Suppose that $R$ is Artinian. We will show $R$ has finite
length over itself. It suffices to exhibit a chain of
submodules whose succesive quotients have finite length.
By what we said above
we may assume that $R$ is local, with maximal ideal $\mathfrak m$.
By Lemma \ref{lemma-artinian-radical-nilpotent} we have
$\mathfrak m^n =0$ for some $n$. 
Consider the sequence
$0 = \mathfrak m^n \subset \mathfrak m^{n-1} \subset
\ldots \subset \mathfrak m \subset R$. By Lemma
\ref{lemma-dimension-is-length} the length of each subquotient
$\mathfrak m^j/\mathfrak m^{j+1}$ is the dimension of this
as a vector space over $\kappa(\mathfrak m)$. This has to be
finite since otherwise we would have an infinite descending
chain of subvector spaces which would correspond to an
infinite descending chain of ideals in $R$.
\end{proof}






































\section{K-groups}
\label{section-K-groups}

\noindent
Let $R$ be a ring. We will introduce two abelian groups associated
to $R$. The first of the two is denoted $K'_0(R)$ and has the following
properties:
\begin{enumerate}
\item For every finite $R$-module $M$ there is given an element $[M]$ in
$K'_0(R)$,
\item for every short exact sequence $0 \to M' \to M \to M'' \to 0$
we have the relation $[M] = [M'] + [M'']$, 
\item the group $K'_0(R)$ is generated by the elements $[M]$, and
\item all relations in $K_0'(R)$ are $\mathbf{Z}$-linear combinations
of the relations coming from exact sequences as above.
\end{enumerate}
The actual construction is a bit more annoying since one has to take care
that the collection of all finitely generated $R$-modules is a proper class.
However, this problem can be overcome by taking as set of generators
of the group $K_0'(R)$ the elements $[R^n/K]$ where $n$ ranges over
all integers and $K$ ranges over all submodules $K \subset R^n$.
The generators of for the subgroup of relations imposed on these elements
will be the relations coming from short exact sequences whose terms
are of the form $R^n/K$. The element $[M]$ is defined by 
choosing $n$ and $K$ such that $M \cong R^n/K$ and putting
$[M] = [R^n/K]$. Details left to the reader.

\begin{lemma}
\label{lemma-length-K0}
If $R$ is an Artinian local ring then the length function
defines a natural abelian group homomorphism
$\text{length}_R : K_0'(R) \to \mathbf{Z}$.
\end{lemma}

\begin{proof}
The length of any finite $R$-module is finite,
because it is the quotient of $R^n$ which has finite length by
Lemma \ref{lemma-artinian-finite-length}. And the length function
is additive, see Lemma \ref{lemma-length-additive}.
\end{proof}

\medskip\noindent
The second of the two is denoted $K_0(R)$ and has the following
properties:
\begin{enumerate}
\item For every finite projective $R$-module $M$ there
is given an element $[M]$ in $K_0(R)$,
\item for every short exact sequence $0 \to M' \to M \to M'' \to 0$
of finite projective $R$-modules we have the relation $[M] = [M'] + [M'']$, 
\item the group $K_0(R)$ is generated by the elements $[M]$, and
\item all relations in $K_0(R)$ are $\mathbf{Z}$-linear combinations
of the relations coming from exact sequences as above.
\end{enumerate}
The construction of this group is done as above.

\medskip\noindent
We note that there is an obvious map $K_0(R) \to K_0'(R)$
which is not an isomorphism in general.

\begin{example}
\label{example-K0-field}
Note that if $R = k$ is a field then we clearly have
$K_0(k) = K_0'(k) \cong \mathbf{Z}$ with the isomorphism
given by the dimension function (which is also the length function).
\end{example}

\begin{example}
\label{example-K0-polynomial-ring}
Let $k$ be a field. Then $K_0(k[x]) = K_0'(k[x]) = \mathbf{Z}$.
\end{example}

\begin{example}
\label{example-K0-node}
Let $k$ be a field. Let $R = \{f \in k[x] \mid f(0) = f(1)\}$,
compare Example \ref{example-affine-open-not-standard}. 
In this case $K_0(R) \cong k^* \oplus \mathbf{Z}$, but
$K_0'(R) = \mathbf{Z}$.
\end{example}

\begin{lemma}
\label{lemma-K0-product}
Let $R = R_1 \times R_2$. Then $K_0(R) = K_0(R_1) \times K_0(R_2)$
and $K_0'(R) = K_0'(R_1) \times K_0'(R_2)$
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-K0prime-Artinian}
Let $R$ be an Artinian local ring.
The map $\text{length}_R : K_0'(R) \to \mathbf{Z}$
of Lemma \ref{lemma-length-K0} is an isomorphism.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-K0-local}
Let $R$ be a local ring. Every finite projective $R$-module
is finite free. The map $\text{rank}_R : K_0(R) \to \mathbf{Z}$
defined by $[M] \to \text{rank}_R(M)$ is well defined
and an isomorphism.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-K0-and-K0prime-Artinian-local}
Let $R$ be a local Artinian ring. There is a commutative
diagram
$$
\xymatrix{
K_0(R) \ar[rr] \ar[d]_{\text{rank}_R} & &
K_0'(R) \ar[d]^{\text{length}_R} \\
\mathbf{Z} \ar[rr]^{\text{length}_R(R)} & &
\mathbf{Z}
}
$$
\end{lemma}

\begin{proof}
Omitted.
\end{proof}


















\section{Graded rings}
\label{section-graded}

\noindent
A {\it graded ring} will be for us a ring $S$ endowed
with a direct sum decomposition $S = \bigoplus_{d \geq 0} S_d$
such that $S_d \cdot S_e \subset S_{d+e}$.
Note that we do not allow (nonzero) elements in negative degrees.
The {\it irrelevant ideal} is the ideal $S_{+} = \bigoplus_{d > 0} S_d$.
A {\it graded module}
will be an $S$-module $M$ endowed with a direct sum decomposition
$M = \bigoplus_{n\in \mathbf{Z}} M_n$ such that $S_d \cdot M_e
\subset M_{d+e}$. Note that for modules we do allow
nonzero elements in negative degrees.
An element $x$ (resp.\ $f$) of $M$ (resp.\ $S$) is called
{\it homogeneous}
if $x \in M_d$ (resp.\ $f \in S_d$) for some $d$.
A {\it map of graded $S$-modules} is a map of $S$-modules
$\varphi : M \to M'$ such that $\varphi(M_d) \subset M'_d$.\footnote{We do not 
allow maps to shift degrees. Later we will define twisting and then we can 
express such maps in terms of the twisted modules.}

\medskip\noindent
At this point there are the notions of graded ideal,
graded quotient ring, graded submodule, graded quotient
module, etc. We leave it to the reader to find the
relevant definitions, and lemmas. For example: A short exact sequence
of graded modules is short exact in every degree.

\begin{lemma}
\label{lemma-graded-Noetherian}
A graded ring $S$ is Noetherian if and only if $S_0$ is 
Noetherian and $S_{+}$ is finitely generated. Furthermore,
a set of homogenenous elements $f_i \in S_{+}$ generates $S$
as an algebra over $S_0$ if and only if they generate
$S_{+}$ as an ideal.
\end{lemma}

\begin{proof}
It is clear that if $S$ is Noetherian then $S_0 = S/S_{+}$ is Noetherian
and $S_{+}$ is finitely generated. It is also clear that if
$f_i$ generate $S$ over $S_0$ then they generate $S_{+}$ as an
ideal. Conversely, suppose that
$S_{+} = (f_1, \ldots, f_n)$ and $S_0$ Noetherian.
By decomposing the $f_i$ into homogenous pieces we may assume each
$f_i$ is homogeneous. Consider the map
$\Psi : S_0[X_1,\ldots X_n] \to S$ which maps $X_i$ to $f_i$.
We claim this is surjective. Once we have seent his the result
follows from Lemma \ref{lemma-Noetherian-permanence}.
Namely, suppose that $f \in S_d$ for some $d$.
By assumption we may write $f = \sum a_i f_i$.
We may replace $a_i$ by its piece of degree $\deg(f) - \deg(f_i)$
and still obtain a valid relation. Now each $a_i$ is homogenous
of strictly smaller degree than $f_i$, and hence by induction
on the degree we may assume $a_i$ is in the image of $\Psi$.
Of course then $f$ is in the image too.
\end{proof}

\begin{definition}
\label{definition-numerical-polynomial}
Let $A$ be an abelian group.
We say that a function $f : n \mapsto f(n) \in A$
defined for all sufficient large integers $n$ is a
{\it numerical polynomial} if there exists $r \geq 0$,
elements $a_0,\ldots,a_r\in A$ such that
$$
f(n) = \sum\nolimits_{i=0}^r {n \choose i}a_i
$$
for all $n \gg 0$.
\end{definition}

\noindent
The reason for using the binomial coefficients is the
elementary fact that any polynomial $P \in \mathbf{Q}[T]$
all of whose values at integer points are integers, is
equal to a sum $P(T) = \sum a_i{T \choose i}$ with
$a_i \in \mathbf{Z}$. Note that in particular the 
expressions ${T+1 \choose i + 1}$ are of this form.

\begin{lemma}
\label{lemma-numerical-polynomial-functorial}
If $A \to A'$ is a homomorphism of abelian groups and if
$f : n \mapsto f(n) \in A$ is a numerical polynomial,
then so is the composition.
\end{lemma}

\begin{proof}
This is immediate from the definitions.
\end{proof}

\begin{lemma}
\label{lemma-numerical-polynomial}
Suppose that $f: n \mapsto f(n) \in A$
is defined for all $n$ sufficiently large
and suppose that $n \mapsto f(n) - f(n-1)$
is a numerical polynomial. Then $f$ is a
numerical polynomial.
\end{lemma}

\begin{proof}
Let $f(n) - f(n-1) = \sum\nolimits_{i=0}^r {n \choose i}a_i$
for all $n \gg 0$. Set
$g(n) = f(n) - \sum\nolimits_{i=0}^r {n+1 \choose i+1}a_i$.
Then $g(n) - g(n-1) = 0$ for all $n \gg 0$. Hence $g$ is
eventually constant, say equal to $a_{-1}$. We leave it
to the reader to show that
$a_{-1} + \sum\nolimits_{i=0}^r {n+1 \choose i+1}a_i$
has the required shape (see remark above the lemma).
\end{proof}

\begin{lemma}
\label{lemma-graded-module-fg}
If $M$ is a finitely generated graded $S$-module,
and if $S$ is finitely generated over $S_0$, then
each $M_n$ is a finite $S_0$-module.
\end{lemma}

\begin{proof}
Suppose the generators of $M$ are $m_i$ and the generators
of $S$ are $f_i$. By taking homogeneous components we may
assume that the $m_i$ and the $f_i$ are homogeneous
and we may assume $f_i \in S_{+}$. In this case it is
clear that each $M_n$ is generated over $S_0$
by the ``monomials'' $\prod f_i^{e_i} m_j$ whose
degree is $n$.
\end{proof}

\begin{proposition}
\label{proposition-graded-hilbert-polynomial}
Suppose that $S$ is a Noetherian graded ring
and $M$ a finite graded $S$-module. Consider the
function
$$
\mathbf{Z} \longrightarrow K_0'(S_0),\ \ 
n \longmapsto [M_n]
$$
see Lemma \ref{lemma-graded-module-fg} above.
If $S_{+}$ is generated by elements of degree $1$,
then this function is a numerical polynomial.
\end{proposition}

\begin{proof}
We prove this by induction on the minimal number of
generators of $S_1$. If this number is $0$, then
$M_n = 0$ for all $n \gg 0$ and the result holds.
To prove the induction step, let $x\in S_1$
be one of a minimal set of generators, such that
the induction hypothesis applies to the
graded ring $S/(x)$.

\medskip\noindent
First we show the result holds if $x$ is nilpotent on $M$.
This we do by induction on the minimal integer $r$ such that
$x^r M  = 0$. If $r = 1$, then $M$ is a module over $S/xS$
and the result holds (by the other induction hypothesis).
If $r > 1$, then we can find a short exact sequence
$0 \to M' \to M \to M'' \to 0$ such that the integers
$r', r''$ are stricly smaller than $r$. Thus we know
the result for $M''$ and $M'$. Hence
we get the result for $M$ because of the relation
$
[M_d]  = [M'_d] + [M''_d]
$
in $K_0'(R)$.

\medskip\noindent
If $x$ is not nilpotent on $M$, let $M' \subset M$ be
the largest submodule on which $x$ is nilpotent. 
Consider the exact sequence $0 \to M' \to M \to M/M' \to 0$
we see again it suffices to prove the result for $M/M'$. In other
words we may assume that multiplication by $x$ is injective.

\medskip\noindent
Let $\overline{M} = M/xM$. Note that the map $x : M \to M$
is {\it not} a map of graded $S$-modules, since it does
not map $M_d$ into $M_d$. Namely, for each $d$ we have the
following short exact sequence
$$
0 \to M_d \xrightarrow{x} M_{d+1} \to \overline{M}_{d+1} \to 0
$$
This proves that $[M_{d+1}] - [M_d] = [\overline{M}_{d+1}]$.
Hence we win by Lemma \ref{lemma-numerical-polynomial}.
\end{proof}

\begin{remark}
If $S$ is still Noetherian but $S$ is not generated in degree $1$,
then the function associated to a graded $S$-module is a periodic
polynomial (i.e., it is a numerical polynomial on the
congruence classes of integers modulo $n$ for some $n$).
\end{remark}

\begin{example}
\label{example-hilbert-function}
Suppose that $S = k[X_1,\ldots,X_d]$.
By Example \ref{example-K0-field} we may identify
$K_0(k) = K_0'(k) = \mathbf{Z}$. Hence any finitely
generated graded $k[X_1,\ldots,X_d]$-module
gives rise to a numerical polynomial
$n \mapsto \dim_k(M_n)$.
\end{example}

\begin{lemma}
\label{lemma-quotient-smaller-d}
Let $k$ be a field. Suppose that $I \subset k[X_1,\ldots,X_d]$
is a nonzero graded ideal. Let $M = k[X_1,\ldots,X_d]/I$.
Then the numerical polynomial $n \mapsto \dim_k(M_n)$ (see
Example \ref{example-hilbert-function} above)
has degree $ < d - 1$ (or is zero if $d = 1$).
\end{lemma}

\begin{proof}
The numerical polynomial associated to the graded module
$k[X_1,\ldots,X_n]$ is $n \mapsto {n - 1 + d \choose d - 1}$.
For any nonzero homogeneous $f \in I$ of degree $e$
and any degree $n >> e$ we have $I_n \supset f \cdot k[X_1,\ldots,X_d]_{n-e}$
and hence $\dim_k(I_n) \geq {n - e - 1 + d \choose d - 1}$.
Hence $\dim_k(M_n) \leq {n - 1 + d \choose d - 1} -
{n - e - 1 + d \choose d - 1}$. We win because the last expression
has degree $ < d - 1$ (or is zero if $d = 1$).
\end{proof}








\section{Noetherian local rings}
\label{section-Noetherian-local}

\noindent
In all of this section $(R, \mathfrak m, \kappa)$
is a Noetherian local ring. 
Let $M$ be a finite $R$-module. We define the {\it Hilbert
function} of $M$ to be the function
$$
\varphi_M : n 
\longmapsto
\text{length}_R(\mathfrak m^nM/{\mathfrak m}^{n+1}M).
$$
Note that we have by Lemma \ref{lemma-length-additive}
that
$$
\text{length}_R(M / \mathfrak m^{n+1}M)
=
\sum\nolimits_{i=0}^n
\varphi_M(i).
$$
There is a variant of this construction which uses an
ideal $I \subset R$ such that $\sqrt{I} = \mathfrak m$.
Such an ideal is called {\it an ideal of definition
of $R$}. Because $R$ is Noetherian this means that
$\mathfrak m^r \subset I$ for some $r$, see Lemma
\ref{lemma-Noetherian-power}. Hence any finite $R$-module
annihilated by a power of $I$ has a finite length, see Lemma
\ref{lemma-length-finite}.
Thus in this case we may put
$$
\varphi_{I,M} : n 
\longmapsto
\text{length}_R(I^nM/I^{n+1}M).
$$
Again we have that
$$
\text{length}_R(M / I^{n+1}M)
=
\sum\nolimits_{i=0}^n
\varphi_{I,M}(i).
$$

\begin{lemma}
\label{lemma-differ-finite}
Suppose that $M' \subset M$ are finite $R$-modules
with finite length quotient.
Then there exist constants $c_1, c_2$
such that $\varphi_{I,M}(n) \geq \varphi_{I, M'}(n-c_1) - c_2$
and $\varphi_{I, M'}(n) \geq \varphi_{I,M}(n) - c_2$.
\end{lemma}

\begin{proof}
By induction on the length of $M/M'$ we may assume
that $M'/M$ has length $1$, i.e., that $M/M' \cong R/\mathfrak m$.
In this case $IM \subset M'$ and hence
$\varphi_{I, M}(n) \geq \varphi_{I, M'}(n-1) - 1$.
On the other hand, $\varphi_{I, M'}(n) \geq \varphi_{I, M}(n) - 1$
because of the relations $M'/I^nM' \supset M/I^nM' \to M/I^nM$.
\end{proof}

\begin{lemma}
\label{lemma-hilbert-ses}
Suppose that $0 \to M' \to M \to M'' \to 0$
is a short exact sequence of finite $R$-modules.
Then there exists a submodule $N \subset M'$ with
finite colength and an integer $c$ such that $\varphi_{I,M}(n)
= \varphi_{I, M''}(n) + \varphi_{I,N}(n-c)$ for all $n$ large enough.
\end{lemma}

\begin{proof}
Note that $M/I^nM \to M''/I^nM''$ is surjective
with kernel $M' / M' \cap I^nM$. By the Artin-Rees
Lemma \ref{lemma-Artin-Rees} there exists a
constant $c$ such that $M' \cap I^nM =
I^{n-c}(M' \cap I^cM)$. Denote $N = M' \cap I^cM$.
Note that $I^c M' \subset N \subset M'$.
Hence $\text{length}_R(M' / M' \cap I^nM) 
= \text{length}_R(M'/N) + \text{length}_R(N/I^{n-c}N)$.
Then we obtain the equality
$$
\sum_{i=0}^{n-1} \varphi_{I,M}(i)
=
\sum_{i=0}^{n-1} \varphi_{I,M''}(i)
+
\sum_{i=0}^{n-c-1} \varphi_{I,N}(i)
+
\text{length}_R(M'/N)
$$
for $n$ large enough. Thus we get $\varphi_{I,M}(n)
= \varphi_{I, M''}(n) + \varphi_{I,N}(n-c)$ for
$n$ large enough.
\end{proof}

\begin{lemma}
\label{lemma-hilbert-change-I}
Suppose that $I$, $I'$ are two ideals of definition
for the Noetherian local ring $R$. Let $M$ be a
finite $R$-module. There exists a constant $a$ such that
$
\sum_{i = 0}^n \varphi_{I,M}(i) \leq
\sum_{i = 0}^{an}\varphi_{I',M}(i)$.
\end{lemma}

\begin{proof}
There exists an integer $a$ such that $(I')^a \subset I$.
Hence we get a surjection $M/(I')^{a(n+1)}M \to M/I^{n+1}M$.
Whence the result (with $a+1$).
\end{proof}

\begin{proposition}
\label{proposition-hilbert-function-polynomial}
For every Noetherian local ring $R$, any $I \subset R$
such that $\sqrt{I} = \mathfrak m$ and every
finite $R$-module $M$ the hilbert function $\varphi_{I,M}$
is a numerical polynomial.
\end{proposition}

\begin{proof}
Consider the graded ring $S = R/I \oplus I/I^2 \oplus I^2/I^3 \oplus
\ldots = \bigoplus_{d \geq 0} I^d/I^{d+1}$. Consider the graded
$S$-module $N = M/IM \oplus IM/I^2M \oplus \ldots =
\bigoplus_{d \geq 0} I^dM/I^{d+1}M$. This pair $(S, N)$ satisfies
the hypotheses of Proposition \ref{proposition-graded-hilbert-polynomial}.
Hence the result follows from that Proposition, and
Lemma \ref{lemma-length-K0}.
\end{proof}

\begin{lemma}
\label{lemma-d-independent}
Suppose that $M$ is a finite $R$-module.
The degree of the numerical polynomial 
$\varphi_{I,M}$ is independent of the
ideal of definition $I$.
\end{lemma}

\begin{proof}
This follows immediately from Lemma \ref{lemma-hilbert-change-I}.
\end{proof}

\begin{definition}
\label{definition-d}
If $R$ is a local Noetherian ring and $M$ a finite $R$-module.
If $\mathfrak m^nM = 0$ we set $d(M) = 0$.
Otherwise we denote $d(M)$ the degree $+1$ of any of the numerical polynomials
$\varphi_{I,M}$ above.
\end{definition}

\noindent
In other words, $d(M)$ is the degree of the numerical polynomial
$n \mapsto \text{length}_R(M/I^nM)$ for any ideal of definition $I$.
We will denote this function
$$
\chi_{I,M}(n) = \text{length}_R(M/I^{n+1}M).
$$
We will frequently use that $\chi_{I,M}(n)
= \sum_{i=0}^n \varphi_{I,M}(i)$ without further mention.

\begin{lemma}
\label{lemma-differ-finite-chi}
Suppose $M \subset M'$ with finite length quotient,
but neither finite length.
Then $\chi_{I,M} - \chi_{I,M'}$
is a polynomial of degree $<$ degree of either 
polynomial.
\end{lemma}

\begin{proof}
Immediate from Lemma \ref{lemma-differ-finite} by elementary calculus.
\end{proof}

\begin{lemma}
\label{lemma-hilbert-ses-chi}
Suppose that $0 \to M' \to M \to M'' \to 0$
is a short exact sequence of finite $R$-modules.
The $\max\{ \deg(\chi_{I, M'}), \deg(\chi_{I, M''}) \}
= \deg(\chi_{I, M})$.
Suppose the length of $M'$ is not finite.
Then $\chi_{I,M} - \chi_{I, M''} - \chi_{I,M'}$
is a numerical polynomial of degree $<$ the degree of
$\chi_{I,M'}$.
\end{lemma}

\begin{proof}
Immediate from Lemma \ref{lemma-hilbert-ses}, and 
\ref{lemma-differ-finite-chi} by elementary calculus.
\end{proof}



































\section{Dimension}
\label{section-dimension}

\begin{definition}
\label{definition-Krull}
The {\it Krull dimension} of the ring $R$ is the 
Krull dimension of the topological space $\text{Spec}(R)$,
see Topology, \ref{topology-definition-Krull}.
In other words it is the supremum of the integers $n\geq 0$
such that there exists a chain of prime ideals of length $n$:
$$
\mathfrak p_0
\subset 
\mathfrak p_1
\subset
\ldots
\subset
\mathfrak p_n,\ \ 
\mathfrak p_i \not= \mathfrak p_{i+1}.
$$
\end{definition}

\begin{definition}
\label{definition-height}
The {\it height} of a prime ideal $\mathfrak p$ of
a ring $R$ is the dimension of the local ring $R_{\mathfrak p}$.
\end{definition}

\begin{lemma}
\label{lemma-dimension-height}
The Krull dimension of $R$ is the supremum of the
heights of its (maximal) primes.
\end{lemma}

\begin{proof}
This is so because we can always add a maximal ideal at the end of a chain
of prime ideals.
\end{proof}

\begin{lemma}
\label{lemma-Noetherian-dimension-0}
A Noetherian ring of dimension $0$ is Artinian.
Conversely, any Artinian ring has dimension zero.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-Noetherian-topology} the space $\text{Spec}(R)$
is Noetherian. By Topology, Lemma \ref{topology-lemma-Noetherian} we see
that $\text{Spec}(R)$ has finitely many irreducible
components, say $\text{Spec}(R) = Z_1 \cup \ldots Z_r$.
According to Lemma \ref{lemma-irreducible}, each $Z_i = V(\mathfrak p_i)$
with $\mathfrak p_i$ a minimal ideal. Since the dimension is $0$
these $\mathfrak p_i$ are also maximal. Thus $\text{Spec}(R)$
is the discrete topological space with elements $\mathfrak p_i$.
All elements $f$ of the radical $I = \cap \mathfrak p_i$
are nilpotent since otherwise $R_f$ would not be the zero ring
and we would have another prime. Since $I$ is finitely generated
we conclude that $I$ is nilpotent, Lemma \ref{lemma-Noetherian-power}.
By Lemma \ref{lemma-product-local} $R$ is the product of its
local rings. By Lemma \ref{lemma-length-finite} each of these
has finite length over $R$. Hence we conclude that $R$
is Artinian by Lemma \ref{lemma-artinian-finite-length}.

\medskip\noindent
If $R$ is Artinian then it has finitely many maximal
ideals $\mathfrak m_i$, $i=1,\ldots,n$
(Lemma \ref{lemma-artinian-finite-nr-max})
and the radical $I = \mathfrak m_1 \mathfrak m_2 \ldots \mathfrak m_n$
is nilpotent (Lemma \ref{lemma-artinian-radical-nilpotent}).
Hence any prime $\mathfrak p$ contains
$(\mathfrak m_1 \mathfrak m_2 \ldots \mathfrak m_n)^r$,
hence contains $\mathfrak m_1 \mathfrak m_2 \ldots \mathfrak m_n$
hence contains one of the $\mathfrak m_i$. Thus $\mathfrak p$
is equal to one of the $\mathfrak m_i$.
\end{proof}

\noindent
In the following we will use the invariant $d(-)$ defined
in Definition \ref{definition-d}. Here is a warm up lemma.

\begin{lemma}
\label{lemma-dimension-0-d-0}
Let $R$ be a Noetherian local ring.
Then $\dim(R) = 0 \Leftrightarrow d(R) = 0$.
\end{lemma}

\begin{proof}
This is because $d(R) = 0$ if and only if $R$ has finite
length as an $R$-module. See Lemma \ref{lemma-artinian-finite-length}.
\end{proof}

\begin{proposition}
\label{proposition-dimension-zero-ring}
Let $R$ be a ring. The following are equivalent:
\begin{enumerate}
\item $R$ is Artinian,
\item $R$ is Noetherian and $\dim(R) = 0$,
\item $R$ has finite length as a module over itself,
\item $R$ is a finite product of Artinian local rings,
\item $R$ is Noetherian and $\text{Spec}(R)$ is a
finite discrete topological space,
\item $R$ is a finite product of Noetherian local rings
of dimension $0$,
\item $R$ is a finite product of Noetherian local rings
$R_i$ with $d(R_i) = 0$,
\item $R$ is a finite product of Noetherian local rings
$R_i$ whose maximal ideals are nilpotent,
\item $R$ is Noetherian, has finitely many maximal
ideals and its radical ideal is nilpotent, and
\item $R$ is Noetherian and there are no strict inclusions
among its primes.
\end{enumerate}
\end{proposition}

\begin{proof}
This is a combination of Lemmas
\ref{lemma-product-local},
\ref{lemma-artinian-finite-length},
\ref{lemma-Noetherian-dimension-0}, and
\ref{lemma-dimension-0-d-0}.
\end{proof}

\begin{lemma}
\label{lemma-height-1}
Let $R$ be a local Noetherian ring.
The following are equivalent:
\begin{enumerate}
\item $\dim(R) = 1$,
\label{dim-1}
\item $d(R) = 1$,
\label{d-1}
\item there exists an $x \in \mathfrak m$, $x$ not nilpotent
such that $V(x) = \{\mathfrak m\}$,
\label{Vx}
\item there exists an $x \in \mathfrak m$, $x$ not nilpotent
such that $\mathfrak m = \sqrt{(x)}$, and
\label{x}
\item there exists an ideal of definition generated by $1$ element,
and no ideal of definition is generated by $0$ elements.
\label{ideal-1}
\end{enumerate}
\end{lemma}

\begin{proof}
First, assume that $\dim(R) = 1$.
Let $\mathfrak p_i$ be the minimal primes of $R$.
Because the dimension is $1$ the only other prime of $R$
is $\mathfrak m$.
According to Lemma \ref{lemma-Noetherian-irreducible-components}
there are finitely many. Hence we can find $x \in \mathfrak m$,
$x \not \in \mathfrak p_i$, see Lemma \ref{lemma-silly}.
Thus the only prime containing $x$ is $\mathfrak m$ and
hence (\ref{Vx}).

\medskip\noindent
If (\ref{Vx}) then $\mathfrak m = \sqrt{(x)}$ by
Lemma \ref{lemma-Zariski-topology}, and hence (\ref{x}).
The converse is clear as well.
The equivalence of (\ref{x}) and (\ref{ideal-1}) follows
from directly the definitions.

\medskip\noindent
Assume (\ref{ideal-1}).
Let $I = (x)$ be an ideal of definition.
Note that $I^n/I^{n+1}$ is a quotient of $R/I$ via multiplication
by $x^n$ and hence $\text{length}_R(I^n/I^{n+1})$ is bounded.
Thus $d(R) = 0$ or $d(R) = 1$, but $d(R)=0$ is excluded
by the assumption that $0$ is not an ideal of definition.

\medskip\noindent
Assume (\ref{d-1}). To get a contradiction, assume there
exist primes $\mathfrak p \subset \mathfrak q \subset \mathfrak m$,
with both inclusions strict. Pick some ideal of definition $I \subset R$.
We will repeatedly use
Lemma \ref{lemma-hilbert-ses-chi}. First of all
it implies, via the exact sequence
$0 \to \mathfrak p \to R \to R/\mathfrak p \to 0$,
that $d(R/\mathfrak p) \leq 1$. But it clearly cannot
be zero. Pick $x\in \mathfrak q$, $x\not \in \mathfrak p$.
Consider the short exact sequence
$$
0 \to R/\mathfrak p \to R/\mathfrak p \to R/(xR + \mathfrak p) \to 0.
$$
This implies that $\chi_{I,R/\mathfrak p} - \chi_{I,R/\mathfrak p}
- \chi_{I, R/(xR + \mathfrak p)} = - \chi_{I, R/(xR + \mathfrak p)}$
has degree $ < 1$. In other words, $d(R/(xR + \mathfrak p) = 0$,
and hence $\dim(R/(xR + \mathfrak p)) = 0$, by
Lemma \ref{lemma-dimension-0-d-0}. But $R/(xR + \mathfrak p)$
has the distinct primes $\mathfrak q/(xR + \mathfrak p)$ and
$\mathfrak m/(xR + \mathfrak p)$ which gives the desired contradiction.
\end{proof}

\begin{proposition}
\label{proposition-dimension}
Let $R$ be a local Noetherian ring.
The following are equivalent:
\begin{enumerate}
\item $\dim(R) = d$,
\label{dim-d}
\item $d(R) = d$,
\label{d-d}
\item there exists an ideal of definition generated by $d$ elements,
and no ideal of definition is generated by fewer than $d$ elements.
\label{ideal-d}
\end{enumerate}
\end{proposition}

\begin{proof}
This proof is really just the same as the proof of Lemma
\ref{lemma-height-1}. We will prove the proposition by induction
on $d$. By Lemmas \ref{lemma-dimension-0-d-0} and \ref{lemma-height-1}
we may assume that $d > 1$. Denote the minimal number of
generators for an ideal of definition of $R$ by $d'(R)$.
We will prove that the inequalities
$\dim(R) \geq d'(R) \geq d(R) \geq \dim(R)$,
and hence they are all equal.

\medskip\noindent
First, assume that $\dim(R) = d$.
Let $\mathfrak p_i$ be the minimal primes of $R$.
According to Lemma \ref{lemma-Noetherian-irreducible-components}
there are finitely many. Hence we can find $x \in \mathfrak m$,
$x \not \in \mathfrak p_i$, see Lemma \ref{lemma-silly}.
Note that every maximal chain of primes starts with some $\mathfrak p_i$,
hence the dimension of $R/xR$ is at most $d-1$. By induction
there are $x_2,\ldots, x_d$ which generate an ideal of definition
in $R/xR$. Hence $R$ has an ideal of definition generated
by (at most) $d$ elements.

\medskip\noindent
Assume $d'(R) = d$. Let $I = (x_1,\ldots,x_d)$ be an ideal
of definition. Note that $I^n/I^{n+1}$ is a quotient of a direct
sum of ${d + n - 1 \choose d - 1}$ copies $R/I$ via multiplication
by all degree $n$ monomials in $x_1,\ldots,x_n$.
Hence $\text{length}_R(I^n/I^{n+1})$ is bounded by a polynomial
of degree $d-1$. Thus $d(R) \leq d$.

\medskip\noindent
Assume $d(R) = d$. Consider a chain of primes
$\mathfrak p \subset \mathfrak q \subset 
\mathfrak q_2 \subset \ldots \subset \mathfrak p_e = \mathfrak m$,
with all inclusions strict, and $e \geq 2$.
Pick some ideal of definition $I \subset R$.
We will repeatedly use
Lemma \ref{lemma-hilbert-ses-chi}. First of all
it implies, via the exact sequence
$0 \to \mathfrak p \to R \to R/\mathfrak p \to 0$,
that $d(R/\mathfrak p) \leq d$. But it clearly cannot
be zero. Pick $x\in \mathfrak q$, $x\not \in \mathfrak p$.
Consider the short exact sequence
$$
0 \to R/\mathfrak p \to R/\mathfrak p \to R/(xR + \mathfrak p) \to 0.
$$
This implies that $\chi_{I,R/\mathfrak p} - \chi_{I,R/\mathfrak p}
- \chi_{I, R/(xR + \mathfrak p)} = - \chi_{I, R/(xR + \mathfrak p)}$
has degree $ < d$. In other words, $d(R/(xR + \mathfrak p)) \leq d - 1$,
and hence $\dim(R/(xR + \mathfrak p)) \leq d - 1$, by
induction. Now $R/(xR + \mathfrak p)$ has the chain of prime ideals
$\mathfrak q/(xR + \mathfrak p) \subset \mathfrak q_2/(xR + \mathfrak p)
\subset \ldots \subset \mathfrak q_e/(xR + \mathfrak p)$ which gives
$e - 1 \leq d - 1$. Since we started with an arbitrary chain of
primes this proves that $\dim(R) \leq d(R)$.

\medskip\noindent
Reading back the reader will see we proved the circular 
inequalities as desired.
\end{proof}

\noindent
Let $(R, \mathfrak m)$ be a Noetherian local ring.
From the above it is clear that $\mathfrak m$ cannot be 
generated by fewer than $\dim(R)$ variables.
By Nakayama's Lemma \ref{lemma-NAK} the minimal number
of generators of $\mathfrak m$ equals $\dim_{\kappa(\mathfrak m)}
\mathfrak m/\mathfrak m^2$. Hence we have the following
fundamental inequality
$$
\dim(R) \leq \dim_{\kappa(\mathfrak m)} \mathfrak m/\mathfrak m^2.
$$
It turns out that the rings where equality holds
have a lot of good properties. They are called
regular local rings.

\begin{definition}
\label{definition-regular-local}
A Noetherian local ring is called {\it regular}
if $\mathfrak m$ can be generated by $\dim(R)$
elements of $R$.
\end{definition}


\noindent
The folllowing two lemmas are clear from the proofs of the
lemmas and proposition above, but we spell them out so we have
convenient references.

\begin{lemma}
\label{lemma-minimal-over-1}
Let $R$ be a Noetherian ring.
\begin{enumerate}
\item Let $x\in R$, $\mathfrak p, \mathfrak q\in \text{Spec}(R)$.
Suppose that $\mathfrak p \subset (\mathfrak p, x) \subset
\mathfrak q$ and $\mathfrak q$ minimal over $(\mathfrak p, x)$.
Then there is no prime strictly between $\mathfrak p$ and $\mathfrak q$.
\item If $x\in R$ and $x \in \mathfrak p$ is minimal over $(x)$
then the height of $\mathfrak p$ is $0$ or $1$.
\end{enumerate}
\end{lemma}

\begin{proof}
Consider the situation of the first assertion.
The primes containing $\mathfrak p$ and contained
in $\mathfrak q$ correspond to primes of
$R_{\mathfrak q}/\mathfrak pR_{\mathfrak q}$, and
the primes containing $x$ correspond to the ones containing
the image of $x$. Thus we may assume $R$ is a Noetherian local domain,
$\mathfrak p = (0)$ and $\mathfrak q$ maximal. Now since
$\sqrt{(x)}$ is the intersection of the prime ideals
containing it, and since $\mathfrak q$ is the only prime
containing $x$ by minimality, we see that $\sqrt{(x)} = \mathfrak q$.
Hence Lemma \ref{lemma-height-1} applies.
The second assertion follows from the first.
\end{proof}

\begin{lemma}
\label{lemma-one-equation}
Suppose that $R$ is a local ring and $x\in \mathfrak m$ an
element of its maximal ideal. Then $\dim R <= \dim R/xR + 1$.
If $x$ is not contained in any of the minimal primes of $R$
then equality holds.
\end{lemma}

\begin{proof}
If $x_1,\ldots,x_{\dim R/xR} \in R$ map to elements of $R/xR$ which
generate an ideal of definition for $R/xR$, then $x, x_1, \ldots,
x_{\dim R/xR}$ generate an ideal of definition for $R$. Hence
the inequality by Proposition \ref{proposition-dimension}.
On the other hand, if $x$ is not contained in any minimal
prime of $R$, then the chains of primes in $R/xR$ all give
rise to chains in $R$ which are at least one step away
from being maximal.
\end{proof}

\begin{lemma}
\label{lemma-noetherian-dim-1-Jacobson}
Noetherian Jacobson rings.
\begin{enumerate}
\item Any Noetherian domain $R$ of dimension $1$
with infinitely many primes is Jacobson.
\item Any Noetherian ring such that every prime
$\mathfrak p$ is either maximal or contained in
infinitely many maximal ideals is Jacobson.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $R$ be a $1$-dimensional Noetherian domain with
infinitely many maximal ideals. To show it is Jacobson
we have to show that $(0)$ is the intersection of 
the maximal ideals in $R$.
If $x \in R$ is not zero, then $R/xR$ is
a zero dimensional Noetherian ring.
Hence it has finitely many
maximal ideals, see Proposition \ref{proposition-dimension-zero-ring}. Thus
$x$ is contained in at most finitely many maximal ideals.
This proves that $(0) = \bigcap \mathfrak m$ as desired.

\medskip\noindent
Let $R$ be a Noetherian ring such that
every non-maximal prime $\mathfrak p$ is contained
in infinitely many maximal ideals. Consider the
collection $\mathcal{Z}$ of closed subsets $Z \subset \text{Spec}(R)$
which do not contain a dense subset of closed points.
To get a contradiction assume that $\mathcal{Z} \not = \emptyset$.
Since $\text{Spec}(R)$ is Noetherian, see
Lemma \ref{lemma-Noetherian-topology}, there exists a
minimal element $Z \subset \mathcal{Z}$. Since
$Z = Z_1 \cup \ldots \cup Z_r$ is a finite union
of irreducible closed subsets, we get a contradiction
with minimality if $r > 0$. Thus $Z = V(\mathfrak p)$
for some prime $\mathfrak p \subset R$.

\medskip\noindent
Let $T \subset Z$ be the closure of the set of closed
points of $Z$. Hence $T \not = Z$, and by assumption
$T$ contains infinitely many (closed) points.
Write $T = V(I) = \text{Spec}(R/I)$ for some radical
ideal $I \subset R$. Note that
$V(\mathfrak p) \supset V(I)$ hence $\mathfrak p \subset I$.
Then $\dim(T) > 0$ because $T$ is the spectrum
of the Noetherian ring $R/I$ with infinitely many primes,
see Proposition \ref{proposition-dimension-zero-ring}. 
Thus we can find a maximal ideal $\overline{\mathfrak m}$
of $R/I$ such that $\dim((R/I)_{\overline{\mathfrak m}}) > 0$.
Let $\mathfrak m \subset R$ be the corresponding maximal
ideal in $R$. Note that $\mathfrak m \supset I \supset \mathfrak p$
and that $(R/I)_{\overline{\mathfrak m}} = R_{\mathfrak m}/IR_{\mathfrak m}$.
Observe that $\dim(R_{\mathfrak m}/\mathfrak pR_{\mathfrak m}) >
\dim(R_{\mathfrak m}/IR_{\mathfrak m})$, as $(0)$ is the
unique minimal prime of $R_{\mathfrak m}/\mathfrak pR_{\mathfrak m}$
and $IR_{\mathfrak m}/\mathfrak pR_{\mathfrak m}$ is not zero.
Let $f \in \mathfrak m$ be an element
whose image in $(R/I)_{\overline{\mathfrak m}}$ is not
in any minimal prime of this local ring. Such an element
exists because the dimension of $(R/I)_{\overline{\mathfrak m}}$
is bigger than $0$. In particular,
$f \not \in I$ and a fortiori $f \not \in \mathfrak p$.
Consider the closed subset $V(f) \cap V(\mathfrak p)
\subset \text{Spec}(R)$. By construction 
the dimension of $R_{\mathfrak m}/(f, \mathfrak p)R_{\mathfrak m}$
is one less than the dimension of
$R_{\mathfrak m}/\mathfrak pR_{\mathfrak m}$,
see Lemma \ref{lemma-one-equation}. By our
choice of $f$
and the same lemma
we also have that the dimension
of $R_{\mathfrak m}/(f, I)R_{\mathfrak m}$
is one less than the dimension of $R_{\mathfrak m}/IR_{\mathfrak m}$.
Thus by our previous inequality we see
that $\dim(R_{\mathfrak m}/(f, \mathfrak p)R_{\mathfrak m})$
is bigger than $\dim(R_{\mathfrak m}/(f, I)R_{\mathfrak m})$.
Hence $V(f) \cap V(\mathfrak p)$ is
different from $V(f) \cap V(I)$. In particular the
closed points of $V(f) \cap V(\mathfrak p)$ are
not dense in $V(f) \cap V(\mathfrak p)$ (because they
are contained in $V(I)$). This contradicts the minimality
of $Z = V(\mathfrak p)$ and we win.
\end{proof}





















\section{Support and dimension of modules}
\label{section-support}

\begin{lemma}
\label{lemma-trivial-filter-finite-module}
Let $R$ be a ring, and let $M$ be a finite $R$-module.
There exists a filtration by $R$-submodules
$$
0 = M_0 \subset M_1 \subset \ldots \subset M_n = M
$$
such that each quotient $M_i/M_{i-1}$ is isomorphic
to $R/I_i$ for some ideal $I_i$ of $R$.
\end{lemma}

\begin{proof}
This is clear.
\end{proof}

\begin{lemma}
\label{lemma-filter-Noetherian-module}
Let $R$ be a Noetherian ring, and let $M$ be a finite $R$-module.
There exists a filtration by $R$-submodules
$$
0 = M_0 \subset M_1 \subset \ldots \subset M_n = M
$$
such that each quotient $M_i/M_{i-1}$ is isomorphic
to $R/\mathfrak p_i$ for some prime ideal $\mathfrak p_i$
of $R$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-trivial-filter-finite-module}
it suffices to do the case $M=R/I$ for some ideal $I$.
Consider the set $S$ of ideals $J$ such that the lemma
does not hold for the module $R/J$, and order it by
inclusion. To arrive at a
contradiction, assume that $S$ is not empty. Because
$R$ is Noetherian, $S$ has a maximal element $J$.
By definition of $S$, the ideal $J$ cannot be prime.
Pick $a,b\in R$ such that $ab \in J$, but neither
$a \in J$ nor $b\in J$. Consider the filtration
$0 \subset aR/(J \cap aR) \subset R/J$.
Note that $aR/(J \cap aR)$ is a quotient of $R/(J + bR)$
and the second quotient equals $R/(aR + J)$. Hence by 
maximality of $J$, each of these has a filtration as
above and hence so does $R/J$. Contradiction.
\end{proof}

\begin{definition}
\label{definition-support-module}
Let $R$ be a ring and let $M$ be an $R$-module.
The {\it support of $M$} is the set
$$
\text{Supp}(M)
=
\{
\mathfrak p \in \text{Spec}(R)
\mid 
M_{\mathfrak p} \not= 0
\}
$$
\end{definition}

\begin{lemma}
\label{lemma-support-closed}
Let $R$ be a ring and let $M$ be an $R$-module.
If $M$ is finite, then $\text{Supp}(M)$ is closed.
\end{lemma}

\begin{proof}
Let $x_1,\ldots,x_r \in M$ be generators.
Suppose that $M_{\mathfrak p} = 0$.
By Lemma \ref{lemma-localize-colimit} there exists
an $f \in R$, $f\not\in \mathfrak p$ such that
$x_i\otimes 1 = 0$ in $M_f$. Hence $M_f = 0$.
Hence $M_{\mathfrak q} = 0$ for all $\mathfrak q\in D(f)$.
\end{proof}

\begin{lemma}
\label{lemma-support-quotient}
Let $R$ be a ring and let $M$ be an $R$-module.
\begin{enumerate}
\item If $M$ is finite then the support
of $M/IM$ is $\text{Supp}(M) \cap V(I)$.
\item If $N \subset M$, then $\text{Supp}(N) \subset
\text{Supp}(M)$.
\item If $Q$ is a quotient module of $M$ then $\text{Supp}(Q) \subset
\text{Supp}(M)$.
\item If $0 \to N \to M \to Q \to 0$ is a short exact sequence
then $\text{Supp}(M) = \text{Supp}(Q) \cup
\text{Supp}(N)$.
\end{enumerate}
\end{lemma}

\begin{proof}
The functors $M \mapsto M_{\mathfrak p}$ are exact. This immediately
implies all but the first assertion. For the first assertion
we need to show that $M_\mathfrak p \not = 0$ and
$I \subset \mathfrak p$ implies $(M/IM)_{\mathfrak p}
= M_\mathfrak p/IM_\mathfrak p \not = 0$. This follows
from Nakayama's Lemma \ref{lemma-NAK}.
\end{proof}

\begin{lemma}
\label{lemma-filter-primes-in-support}
Let $R$, $M$, $M_i$, $\mathfrak p_i$ as in
Lemma \ref{lemma-filter-Noetherian-module}.
All of the primes $\mathfrak p_i$ are in the support of
$M$.
\end{lemma}

\begin{proof}
Since localization is exact, we see that
$(R/\mathfrak p_i)_{\mathfrak p_i}$ is a
subquotient of $M_{\mathfrak p_i}$.
Hence $M_{\mathfrak p_i}$ is not zero.
\end{proof}

\begin{lemma}
\label{lemma-support-point}
Suppose that $R$ is a Noetherian local ring with
maximal ideal $\mathfrak m$. Let $M$ be a finite
$R$-module. Then $\text{Supp}(M) = \{ \mathfrak m\}$
if and only if $M$ has finite length over $R$.
\end{lemma}

\begin{proof}
Assume that $\text{Supp}(M) = \{ \mathfrak m\}$.
It suffices to show that all the primes $\mathfrak p_i$
in the filtration of Lemma \ref{lemma-filter-Noetherian-module}
are the maximal ideal. This is clear by
Lemma \ref{lemma-filter-primes-in-support}.

\medskip\noindent
Suppose that $M$ has finite length over $R$.
Then $\mathfrak m^n M = 0$ by Lemma \ref{lemma-length-infinite}.
Since some element of $\mathfrak m$ maps to a unit
in $R_{\mathfrak p}$ for any prime
$\mathfrak p \not = \mathfrak m$ in $R$ we see $M_{\mathfrak p} = 0$.
\end{proof}

\begin{lemma}
\label{lemma-filter-minimal-primes-in-support}
Let $R$, $M$, $M_i$, $\mathfrak p_i$ as in
Lemma \ref{lemma-filter-Noetherian-module}.
The minimal elements of the set $\{\mathfrak p_i\}$
are the minimal elements of $\text{Supp}(M)$, and
the number of times a minimal prime $\mathfrak p$
occurs is
$$
\#\{i \mid \mathfrak p_i = \mathfrak p\}
=
\text{length}_{R_\mathfrak p} M_{\mathfrak p}.
$$
\end{lemma}

\begin{proof}
We have already seen $\{\mathfrak p_i\} \subset \text{Supp}(M)$,
in Lemma \ref{lemma-filter-primes-in-support}.
Let $\mathfrak p \in \text{Supp}(M)$ be minimal.
The support of $M_{\mathfrak p}$ is the set
consisting of the maximal ideal $\mathfrak p R_{\mathfrak p}$.
Hence by Lemma \ref{lemma-support-point} the length
of $M_{\mathfrak p}$ is finite and $>0$. Next we
note that $M_{\mathfrak p}$ has a filtration with subquotients
$
(R/\mathfrak p_i)_{\mathfrak p}
=
R_{\mathfrak p}/{\mathfrak p_i}R_{\mathfrak p}
$
These are zero if $\mathfrak p_i \not \subset \mathfrak p$
and equal to $\kappa(\mathfrak p)$ if $\mathfrak p_i \subset
\mathfrak p$ because by minimality of $\mathfrak p$
we have $\mathfrak p_i = \mathfrak p$ in this case.
The result follows since $\kappa(\mathfrak p)$ has length $1$.
\end{proof}

\begin{lemma}
\label{lemma-support-dimension-d}
Let $R$ be a Noetherian local ring.
Let $M$ be a finite $R$-module.
Then $d(M) = \dim(\text{Supp}(M))$.
\end{lemma}

\begin{proof}
Let $M_i, \mathfrak p_i$ be as in Lemma \ref{lemma-filter-Noetherian-module}.
By Lemma \ref{lemma-hilbert-ses-chi} we have
$d(M) = \max \{ d(R/\mathfrak p_i) \}$. By
Proposition \ref{proposition-dimension} we have
$d(R/\mathfrak p_i) = \dim(R/\mathfrak p_i)$
Trivially $\dim(R/\mathfrak p_i) = \dim V(\mathfrak p_i)$.
Since all minimal primes of $\text{Supp}(M)$ occur among
the $\mathfrak p_i$ we win.
\end{proof}











\section{Associated primes}
\label{section-ass}

\begin{definition}
\label{definition-associated}
Let $R$ be a ring. Let $M$ be an $R$-module.
A prime $\mathfrak p$ of $R$ is {\it associated} to $M$
if there exists an element $m \in M$ whose annihilator
is $\mathfrak p$.
The set of all such primes is denoted $\text{Ass}_R(M)$
or $\text{Ass}(M)$.
\end{definition}

\begin{lemma}
\label{lemma-ass-filter}
Let $R$, $M$, $M_i$, $\mathfrak p_i$ as in
Lemma \ref{lemma-filter-Noetherian-module}.
Then $\text{Ass}(M) \subset \{\mathfrak p_i\}$.
\end{lemma}

\begin{proof}
By induction on the length $n$ of the filtration $\{ M_i \}$.
Pick $m \in M$ whose annihilator is a prime $\mathfrak p$.
If $m \in M_{n-1}$ we are done by induction. If not,
then $m$ maps to a nonzero element of $M/M_{n-1} \cong
R/\mathfrak p_n$. Hence we have $\mathfrak p \subset \mathfrak p_n$.
If equality does not hold, then we can find $f \in \mathfrak p_n$,
$f \not\in \mathfrak p$. In this case the annihilator of $fm$ is still
$\mathfrak p$ and $fm \in M_{n-1}$. Thus we win by induction.
\end{proof}

\begin{lemma}
\label{lemma-finite-ass}
Let $R$ be a Noetherian ring.
Let $M$ be a finite $R$-module.
Then $\text{Ass}(M)$ is finite.
\end{lemma}

\begin{proof}
Immediate from Lemma \ref{lemma-ass-filter} and
Lemma \ref{lemma-filter-Noetherian-module}.
\end{proof}

\begin{proposition}
Let $R$ be a Noetherian ring.
Let $M$ be a finite $R$-module.
The following sets of primes are the same:
\begin{enumerate}
\item The minimal primes in the support of $M$.
\item The minimal primes in $\text{Ass}(M)$.
\item For any filtration $0 = M_0 \subset M_1 \subset \ldots
\subset M_{n-1} \subset M_n = M$ with $M_i/M_{i-1} \cong R/\mathfrak p_i$
the minimal primes of the set $\{\mathfrak p_i\}$.
\end{enumerate}
\end{proposition}

\begin{proof}
Part of this we saw in Lemma \ref{lemma-filter-minimal-primes-in-support}.
It suffices to prove that if $\mathfrak p$ is a minimal element of
the set $\{\mathfrak p_i\}$ then it is the annihilator of
an element of $M$. Let $i$ be minimal such that
$\mathfrak p = \mathfrak p_i$.
Pick $m \in M_i$, $m \not \in M_{i-1}$. The annihilator of $m$ 
is contained in $\mathfrak p_i = \mathfrak p$ and contains
$\mathfrak p_1 \mathfrak p_2 \ldots \mathfrak p_i$. By our choice of
$i$ we have $\mathfrak p_1 \mathfrak p_2 \ldots \mathfrak p_{i-1}
\not \subset \mathfrak p_i$. Pick
$f \in \mathfrak p_1 \mathfrak p_2 \ldots \mathfrak p_{i-1}$,
$f \not \in \mathfrak p$. Then $fm$ has annihilator $\mathfrak p$.
\end{proof}

\begin{lemma}
\label{lemma-ass-zero-divisors}
Let $R$ be a Noetherian ring.
Let $M$ be a finite $R$-module.
The union $\bigcup_{\mathfrak q \in \text{Ass}(M)} \mathfrak q$
is the set elements of $R$ which are zero divisors on $M$.
\end{lemma}

\begin{proof}
Any element in any associated prime clearly is a zero divisor
on $M$. Conversely, suppose $x \in R$ is a zero divisor on $M$.
Consider the submodule $N = \{m \in M \mid xm = 0\}$.
Since $N$ is not zero it has an associated prime $\mathfrak q$,
and clearly $x \in \mathfrak q$. But just as clearly $\mathfrak q$
is also an associated prime of $M$.
\end{proof}












\section{Regular sequences and depth}
\label{section-depth}

\noindent
There is a characterization of depth in terms of Ext-groups
that we will discuss in Section \ref{section-ext}. Here we just do
a minimal amount of work to prove the inequality between
depth and dimension.

\begin{definition}
\label{definition-regular-sequence}
Let $R$ be a ring.
Let $M$ be an $R$-module. 
A sequence of elements $f_1,\ldots,f_r$ is called {\it $M$-regular}
if the following conditions hold:
\begin{enumerate}
\item $f_i$ is a nonzero divisor on
$M/(f_1,\ldots,f_{r-1})M$
for each $i = 1, \ldots, r$, and
\item the module $M/(f_1,\ldots,f_r)M$ is not zero.
\end{enumerate}
If $I$ is an ideal of $R$ and $f_1,\ldots,f_r \in I$
then we call $f_1,\ldots, f_r$ a {\it $M$-regular sequence
in $I$}. If $M = R$, we call $f_1,\ldots,f_r$ simply a
{\it regular sequence} (in $I$).
\end{definition}

\noindent
Please pay attention to the fact that the definition depends
on the order of the elements $f_1,\ldots,f_r$. Here are two 
examples.

\begin{example}
\label{example-global-regular}
Let $k$ be a field. In the ring $k[x,y,z]$
the sequence $x, y(1-x), z(1-x)$ is regular
but the sequence $y(1-x), z(1-x), x$ is not.
\end{example}

\begin{example}
\label{example-local-regular}
Let $k$ be a field. Consider the ring 
$k[x,y,w_0,w_1,w_2,\ldots]/I$
where $I$ is generated by $yw_i$, $i=0,1,2,\ldots$ and
$w_i - xw_{i+1}$, $i=0,1,2,\ldots$.
The sequence $x, y$ is regular, but $y$ is a zero divisor.
Moreover you can localize at the maximal ideal
$(x,y,w_i)$ and still get an example.
\end{example}

\begin{definition}
Let $R$ be a ring, and $I \subset R$ an ideal.
Let $M$ be an $R$-module.
The {\it $I$-depth} of $M$ is the supremum of the lengths
of $M$-regular sequences in $M$; we denote it
$\text{depth}_I(M)$. If $(R, \mathfrak m)$ is
local we call $\text{depth}_{\mathfrak m}(M)$ simply
the {\it depth} of $M$.
\end{definition}

\noindent
Example \ref{example-global-regular} shows depth does not
behave well even if the ring is Noetheriam, and Example
\ref{example-local-regular} shows that it does not
behave well if the ring is local but non Noetherian.
We will see later depth behaves well if the ring is local
Noetherian. The following two lemmas are an indication of this.

\begin{lemma}
\label{lemma-permute-xi}
Let $R$ be a local Noetherian ring.
Let $M$ be a finite $R$-module.
Let $x_1,\ldots,x_c$ be an $M$-regular sequence.
Then any permutation of the $x_i$ is a regular
sequence as well.
\end{lemma}

\begin{proof}
First we do the case $c=2$.
Consider $K \subset M$ the kernel of $x_2 : M \to M$.
For any $z \in K$ we know that $z = x_1 z'$
for some $z' \in M$ because
$x_2$ is a nonzero divisor on $M/x_1M$. 
Because $x_1$ is a nonzero divsor on $M$ we see that $x_2 z = 0$
as well. Hence $x_1 : K \to K$ is surjective.
Thus $K = 0$ by Nakayama's Lemma \ref{lemma-NAK}.
Next, consider multiplication by $x_1$ on $M/x_2M$.
If $z \in M$ maps to an element $\overline{z} \in M/x_2M$
in the kernel of this map, then $x_1 z = x_2 y$ for some $y \in M$.
But then since $x_1, x_2$ is a regular sequence we see that
$y = x_1 y'$ for some $y' \in M$. Hence $x_1 ( z - x_2 y' ) =0$
and hence $z = x_2 y'$ and hence $\overline{z} = 0$ as desired.

\medskip\noindent
For the general case, observe that any permutation is
a composition of transpositions of adjacent indices.
Hence it suffices to prove that
$x_1,\ldots,x_{i-2},x_i,x_{i-1},x_{i+1},\ldots,x_c$ 
is an $M$-regular sequence. This follows from the case we 
just did applied to the module $M/(x_1,\ldots,x_{i-2})$
and the length $2$ regular sequence $x_{i-1}, x_i$.
\end{proof}

\begin{lemma}
\label{lemma-bound-depth}
Let $R$ be a Noetherian local ring.
Let $M$ be a finite $R$-module.
Then $\dim(\text{Support}(M)) \geq \text{depth}(M)$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-support-dimension-d} it suffices
to prove that if $f \in \mathfrak m$ is a nonzero
divisor on $M$, then $d(M/fM) \leq d(M) - 1$.
The existence of $f$ shows that $M$ does not have finite length.
Consider the exact sequence
$$
0 \to M \xrightarrow{f} M \to M/fM \to 0
$$
and apply Lemma \ref{lemma-hilbert-ses-chi}.
It shows that $d(M/fM) < d(M)$.
\end{proof}

\noindent
Here are a few more results on depth.

\begin{lemma}
\label{lemma-ideal-nonzerodivisor}
Let $R$ be a Noetherian local ring with
maximal ideal $\mathfrak m$. Let $I \subset \mathfrak m$
be an ideal. Let $M$ be a finite $R$-module.
The following are equivalent:
\begin{enumerate}
\item There exists an $x \in I$ which is not a zero
divisor on $M$, in other words $\text{depth}_I(M) \geq 1$.
\item We have $\mathfrak m \not\in \text{Ass}(M)$ and
$I \not \subset \mathfrak q$ for all $\mathfrak q \in \text{Ass}(M)$.
\end{enumerate}
\end{lemma}

\begin{proof}
If there exists a nonzero divisor $x$ in $\mathfrak m$,
then it is clear that no nonzero element of $M$ has annihilator
$\mathfrak m$. Also, $x$ clearly cannot be in any associated
prime of $M$. Conversely, suppose $I \not \subset \mathfrak q$
for all $\mathfrak q \in \text{Ass}(M)$. In this case we can
choose $x \in I$, $x \not \in \mathfrak q$ for all
$\mathfrak q \in \text{Ass}(M)$ by Lemma \ref{lemma-silly}.
By Lemma \ref{lemma-ass-zero-divisors} the element $x$
is not a zero divisor.
\end{proof}

\begin{lemma}
\label{lemma-flat-increases-depth}
Let $R, S$ be local rings.
Let $R \to S$ be a local flat ring map.
Suppose that $x_1,\ldots,x_r$ form
a $M$-regular sequence in $R$.
Then the images of $x_1,\ldots,x_r$ in
$S$ form a $M\otimes_RS$-regular sequence.
\end{lemma}

\begin{proof}
This is so because $R\to S$ is faithfully flat
by Lemma \ref{lemma-local-flat-ff}.
\end{proof}

\begin{lemma}
Let $R$ be a ring.
\begin{enumerate}
\item Suppose that $J = (f_1,\ldots,f_c)$ is an ideal generated
by a regular sequence $f_1,\ldots,f_c$ of $R$. Then the graded
ring $\bigoplus J^n/J^{n+1}$ is graded isomorphic to
$(R/J)[X_1,\ldots,X_c]$.
\item Suppose that $M$ is an $R$-module and that $J=(f_1,\ldots,f_c)$
is an ideal generated by the $M$-regular sequence
$f_1,\ldots,f_c$. In this case the graded
$\bigoplus J^n/J^{n+1}$-module $\bigoplus J^nM/J^{n+1}M$
is graded isomorphic to the module $(M/JM)[X_1,\ldots,X_c]$.
\end{enumerate}
The second statement is elucidated in the proof below.
\end{lemma}

\begin{proof}
We prove the first assertion by induction on $c$.
We have to show that given any relation
$\sum_{|I| = n} a_I f^I \in J^{n + 1}$ with $a_I \in R$ we
actually have $a_I \in J$ for all multi-indices $I$. Since
any element of $J^{n+1}$ is of the form $\sum_{|I| = n} b_I f^I$
with $b_I \in J$ we may assume, after replacing $a_I$ by $a_I - b_I$,
the relation reads $\sum_{|I| = n} a_I f^I = 0$. We can rewrite 
this as
$$
\sum\nolimits_{e = 0}^n
\left(
\sum\nolimits_{|I'| = n - e}
a_{I',e} f^{I'}
\right)
f_c^e
=
0
$$
Here and below the multi-indices $I'$ are required to be of the form
$I'=(i_1,\ldots,i_{d-1},0)$. We will show by descending
induction on $l \in \{0,\ldots,n\}$
that if we have a relation
$$
\sum\nolimits_{e = 0}^l
\left(
\sum\nolimits_{|I'| = n - e}
a_{I',e} f^{I'}
\right)
f_c^e
=
0
$$
then $a_{I',e} \in J$ for all $I', e$.
Namely, set $J' = (f_1,\ldots,f_{c-1})$.
We observe that $\sum\nolimits_{|I'| = n - l} a_{I',l} f^{I'}$
is mapped into $J'$ by $f_c^{l}$ and hence
(because $f_c$ is not a zero divisor on $R/J'$) it is in $J'$.
By induction hypotheses (for the induction on $c$),
we see that $a_{I',l} \in J'$.
This allows us to rewrite the term 
$(\sum\nolimits_{|I'| = n - l} a_{I',l} f^{I'})f_c^l$
in the form $(\sum\nolimits_{|I'| = n - l + 1} f_c b_{I',l - 1} 
f^{I'})f_c^{l-1}$. This gives a new relation of the form
$$
\sum\nolimits_{|I'| = n - l + 1}
(a_{I', l-1} + f_c b_{I',l - 1}) f^{I'})f_c^{l-1}
+
\sum\nolimits_{e = 0}^{l - 2}
\left(
\sum\nolimits_{|I'| = n - e}
a_{I',e} f^{I'}
\right)
f_c^e
=
0
$$
Now by the induction hypothesis (on $l$ this time) we see that
all $a_{I', l-1} + f_c b_{I',l - 1} \in J$ and
all $a_{I', e} \in J$ for $e \leq l - 2$. This, combined with
$a_{I', l} \in J' \subset J$ seen above, finishes the proof of the
induction step.

\medskip\noindent
The second assertion means that given any formal expression
$F = \sum_{|I| = n} m_I X^I$, $m_I \in M$ with $\sum m_I f^I
\in J^{n+1}M$, then all the coefficients $m_I$ are in $J$.
This is proved in exactly the same way as we prove the corresponding
result for the first assertion above.
\end{proof}











\section{Ext groups and depth}
\label{section-ext}

\noindent
In this section we do a tiny bit of homological algebra,
in order to esthablish some fundamental properties of
depth over Noetherian local rings.

\begin{lemma}
\label{lemma-resolution-by-finite-free}
Let $R$ be a ring. Let $M$ be an $R$-module.
\begin{enumerate}
\item The exists an exact complex
$$
\ldots \to F_2 \to F_1 \to F_0 \to M \to 0.
$$
with $F_i$ free $R$-modules.
\item If $R$ is Noetherian and $M$ finite $R$, then we
choose the complex such that each $F_i$ is finite free.
In other words, we may find an exact complex
$$
\ldots \to R^{n_2} \to R^{n_1} \to R^{n_0} \to M \to 0.
$$
\end{enumerate}
\end{lemma}

\begin{proof}
Let us explain only the Noetherian case.
As a first step choose a surjection $R^{n_0} \to M$.
Then having constructed an exact complex of length
$e$ we simply choose a surjection $R^{n_{e+1}} \to 
\text{Ker}(R^{n_e} \to R^{n_{e-1}})$ which is possible
because $R$ is Noetherian.
\end{proof}

\begin{definition}
\label{definition-finite-free-resolution}
We call a complex as in (1) of
Lemma \ref{lemma-resolution-by-finite-free}
a {\it resolution of $M$ by free $R$-modules}.
Similarly we call a complex as in (2) of
Lemma \ref{lemma-resolution-by-finite-free}
a {\it resolution of $M$ by finite free $R$-modules}.
\end{definition}

\noindent
We often use the notation $F_{\bullet}$ to denote a complex
of $R$-modules
$$
\ldots \to F_i \to F_{i-1} \to \ldots
$$
In this case we often use $d_i$ or $d_{F, i}$ to denote the map
$F_i \to F_{i-1}$. In this section we are always going to
assume that $F_0$ is the last nonzero term in the complex.
The {\it $i$th homology group of the complex} $F_{\bullet}$
is the group $H_i = \text{Ker}(d_{F,i})/\text{Im}(d_{F,i+1})$.
A {\it map of complexes $\alpha : F_{\bullet} \to G_{\bullet}$}
is given by maps $\alpha_i : F_i \to G_i$ such that
$\alpha_{i-1} \circ d_{F, i} = d_{G, i-1} \circ \alpha_i$.
Such a map induces a map on homology $H_i(\alpha) :
H_i(F_{\bullet}) \to H_i(G_{\bullet})$. If $\alpha, \beta
:  F_{\bullet} \to G_{\bullet}$ are maps of complexes, then
a {\it homotopy} between $\alpha$ and $\beta$ is given by
a collection of maps $h_i : F_i \to G_{i+1}$ such that
$\alpha_i - \beta_i = d_{G, i+1} \circ h_i +
h_{i-1} \circ d_{F, i}$.

\medskip\noindent
We will use a very similar notation regarding complexes
of the form $F^{\bullet}$ which look like
$$
\ldots \to F^i \xrightarrow{d^{i+1}} F^{i+1} \to \ldots
$$
There are maps of complexes, homotopies, etc.
In this case we set $H^i(F^{\bullet}) =
\text{Ker}(d^{i+1})/\text{Im}(d^{i})$ and we call it
the {\it $i$th cohomology group}.

\begin{lemma}
\label{lemma-homotopic-equal-homology}
Any two homotopic maps of complexes induce the same maps on
(co)homology groups.
\end{lemma}

\begin{proof}
FIXME.
\end{proof}

\begin{lemma}
\label{lemma-compare-resolutions}
Suppose given an exact complex $M_{\bullet}$, a complex
$F_{\bullet}$ of free $R$-modules and a map
of $R$-modules $\text{Coker}(F_1 \to F_0) \to \text{Coker}(M_1 \to M_0)$. 
Then
\begin{enumerate}
\item there exists a map of complexes $F_{\bullet}
\to M_{\bullet}$ inducing the given map on cokernels.
\item any two maps $\alpha, \beta : F_{\bullet}
\to M_{\bullet}$ inducing the same map 
$\text{Coker}(F_1 \to F_0) \to \text{Coker}(M_1 \to M_0)$
are homotopic.
\end{enumerate}
\end{lemma}

\begin{proof}
Because $F_0$ is free we can find a map $F_0 \to M_0$
lifting the map $F_0 \to \text{Coker}(F_1 \to F_0)
\to \text{Coker}(M_1 \to M_0)$. We obtain an induced
map $F_1 \to F_0 \to M_0$ wich ends up in the image
of $M_1 \to M_0$. Since $F_1$ is free we may lift this
to a map $F_1 \to M_1$. This in turn induces a map
$F_2 \to F_1 \to M_1$ which maps to zero into
$M_0$. Since $M_{\bullet}$ is exact we see that
the image of this map is contained in the image
of $M_2 \to M_1$. Hence we may lift to get a map
$F_2 \to M_2$. Repeat.

\medskip\noindent
To show that $\alpha, \beta$ are homotopic it suffices
to show the difference $\gamma = \alpha - \beta$ is homotopic
to zero. Note that the image of $\gamma_0 : F_0 \to M_0$
is contained in the image of $M_1 \to M_0$. Hence we may lift
$\gamma_0$ to a map $h_0 : F_0 \to M_1$. Consider the map
$\gamma_1' = \gamma_1 - h_0 \circ d_{F, 1}$. By our choice of $h_0$
we see that the image of $\gamma_1'$ is contained in
the kernel of $M_1 \to M_0$. Since $M_{\bullet}$ is exact 
we may lift $\gamma_1'$ to a map $h_1 : F_1 \to M_2$.
At this point we have $\gamma_1 = h_0 \circ d_{F, 1}
+ d_{M, 2} \circ h_1$. Repeat.
\end{proof}

\noindent
At this point we are ready to define the groups
$\text{Ext}^i_R(M, N)$. Namely, choose a resolution
$F_{\bullet}$ of $M$ by free $R$-modules, see Lemma
\ref{lemma-resolution-by-finite-free}. Consider
the (cohomological) complex 
$$
\text{Hom}_R(F_\bullet, N) :
\text{Hom}_R(F_0, N) \to 
\text{Hom}_R(F_1, N) \to 
\text{Hom}_R(F_2, N) \to \ldots
$$
We define $\text{Ext}^i_R(M, N)$ to be the $i$th
cohomology group of this complex.\footnote{At this point
it would perhaps be more appropriate to say ``an'' in stead
of ``the'' Ext-group.} The following lemma explains
in what sense this is well defined.

\begin{lemma}
\label{lemma-ext-welldefined}
Let $R$ be a ring. Let $M_1, M_2, N$ be $R$-modules.
Suppose that $F_{\bullet}$ is a free resolution of the module $M_1$,
and $G_{\bullet}$ is a free resolutions of the module $M_2$.
Let $\varphi : M_1 \to M_2$ be a module map.
Let $\alpha : F_{\bullet} \to G_{\bullet}$ be
a map of complexes inducing $\varphi$ on
$M_1 = \text{Coker}(d_{F, 1}) \to M_2 = \text{Coker}(d_{G, 1})$,
see Lemma \ref{lemma-compare-resolutions}.
Then the induced maps
$$
H^i(\alpha) :
H^i(\text{Hom}_R(F_{\bullet}, N))
\longrightarrow
H^i(\text{Hom}_R(G_{\bullet}, N))
$$
are independent of the choice of $\alpha$.
If $\varphi$ is an isomorphism, so are all the maps
$H^i(\alpha)$. If $M_1 = M_2$, $F_\bullet = G_\bullet$, and
$\varphi$ is the identity, so are all the maps $H_i(\alpha)$.
\end{lemma}

\begin{proof}
Another map $\beta : F_{\bullet} \to G_{\bullet}$
inducing $\varphi$ is homotopic to $\alpha$ by
Lemma \ref{lemma-compare-resolutions}. Hence the
maps $\text{Hom}_R(F_\bullet, N) \to
\text{Hom}_R(G_\bullet, N)$ are homotopic.
Hence the independence result follows from
Lemma \ref{lemma-homotopic-equal-homology}.

\medskip\noindent
Suppose that $\varphi$ is an isomorphism.
Let $\psi : M_2 \to M_1$ be an inverse.
Choose $\beta : G_{\bullet} \to F_{\bullet}$
be a map inducing $\psi :
M_2 = \text{Coker}(d_{G, 1}) \to M_1 = \text{Coker}(d_{F, 1})$,
see Lemma \ref{lemma-compare-resolutions}. 
Ok, and now consider the map
$H^i(\alpha) \circ H^i(\beta) =
H^i(\alpha \circ \beta)$. By the above the
map $H^i(\alpha \circ \beta)$ is the {\it same}
as the map $H^i(\text{id}_{G_{\bullet}}) = \text{id}$.
Similarly for the composition $H^i(\beta) \circ H^i(\alpha)$.
Hence $H^i(\alpha)$ and $H^i(\beta)$ are inverses of each other.
\end{proof}

\begin{lemma}
\label{lemma-long-exact-seq-ext}
Let $R$ be a ring. Let $M$ be an $R$-module.
Let $0 \to N' \to N \to N'' \to 0$ be a 
short exact sequence. Then we get a long exact
sequence
$$
\begin{matrix}
0
\to \text{Hom}_R(M, N')
\to \text{Hom}_R(M, N)
\to \text{Hom}_R(M, N'')
\\
\phantom{0\ }
\to \text{Ext}^1_R(M, N')
\to \text{Ext}^1_R(M, N)
\to \text{Ext}^1_R(M, N'')
\to \ldots
\end{matrix}
$$
\end{lemma}

\begin{proof}
Pick a free resolution $F_{\bullet} \to M$.
Since each of the $F_i$ are free we see that 
we get a short exact sequence of complexes
$$
0 \to
\text{Hom}_R(F_{\bullet}, N') \to
\text{Hom}_R(F_{\bullet}, N) \to
\text{Hom}_R(F_{\bullet}, N'') \to
0
$$
Thus we get the long exact sequence from
the snake lemma applied to this.
\end{proof}

\begin{lemma}
\label{lemma-annihilate-ext}
Let $R$ be a ring. Let $M$, $N$ be $R$-modules.
Any $x\in R$ such that either $xN = 0$, or $xM = 0$
annihilates each of the modules $\text{Ext}^i_R(M,N)$.
\end{lemma}

\begin{proof}
Pick a free resolution $F_{\bullet}$ of $M$.
Since $\text{Ext}^i_R(M, N)$
is defined as the cohomology of the complex
$\text{Hom}_R(F_{\bullet}, N)$ the lemma is
clear when $xN = 0$. If $xM = 0$, then 
we see that multiplication by $x$ on $F_{\bullet}$
lifts the zero map on $M$. Hence by Lemma
\ref{lemma-ext-welldefined} we see that it
induces the same map on EXt groups as the
zero map.
\end{proof}

\begin{lemma}
\label{lemma-depth-ext}
Let $R$ be a Noetherian local ring with maximal ideal $\mathfrak m$.
Let $M$ be a finite $R$-module. Then $\text{depth}_R(M)$
is equal to the smallest integer $i$ such that
$\text{Ext}^i_R(R/\mathfrak m, M)$ is nonzero.
\end{lemma}

\begin{proof}
Let $\delta(M)$ denote the depth of $M$ and let $i=i(M)$ denote
the smallest integer such that $\text{Ext}^i_R(R/\mathfrak m, M)$
is nonzero. We will see in a moment that $i(M) < \infty$.
By Lemma \ref{lemma-ideal-nonzerodivisor} we have
$\delta(M) = 0$ if and only if $i(M) = 0$, because
$\mathfrak m \in \text{Ass}(M)$ exactly means
that $i(M) = 0$. Hence if $\delta(M)$ or $i(M)$ is $> 0$, then we may
choose $x \in \mathfrak m$ such that (a) $x$ is a nonzero
divisor on $M$, and (b) $\text{depth}(M/xM) = \delta(M) - 1$.
Consider the long exact sequence
of Ext-groups associated to the short exact sequence
$0 \to M \to M \to M/xM \to 0$ by Lemma \ref{lemma-long-exact-seq-ext}:
$$
\begin{matrix}
0
\to \text{Hom}_R(\kappa, M)
\to \text{Hom}_R(\kappa, M)
\to \text{Hom}_R(\kappa, M/xM)
\\
\phantom{0\ }
\to \text{Ext}^1_R(\kappa, M)
\to \text{Ext}^1_R(\kappa, M)
\to \text{Ext}^1_R(\kappa, M/xM)
\to \ldots
\end{matrix}
$$
Since $x \in \mathfrak m$ all the maps $\text{Ext}^i_R(\kappa, M)
\to \text{Ext}^i_R(\kappa, M)$ are zero, see \ref{lemma-annihilate-ext}.
Thus it is clear that $i(M/xM) = i(M) - 1$. Induction, e.g., on
$\dim(\text{Support}(M))$, finishes the proof.
\end{proof}

\begin{lemma}
\label{lemma-depth-in-ses}
Let $R$ be a local Noetherian ring. Let $0 \to N' \to N \to N'' \to 0$
be a short exact sequence of finite $R$-modules.
\begin{enumerate}
\item
$\text{depth}(N'') \geq \min\{\text{depth}(N), \text{depth}(N') - 1\}$
\item
$\text{depth}(N') \geq \min\{\text{depth}(N), \text{depth}(N'') + 1\}$
\end{enumerate}
\end{lemma}

\begin{proof}
This is easy using the results above. Hint:
Use the characterization of depth using the Ext groups
$\text{Ext}^i(\kappa, N)$, see Lemma \ref{lemma-annihilate-ext},
and use the long exact cohomology sequence
$$
\begin{matrix}
0
\to \text{Hom}_R(\kappa, N')
\to \text{Hom}_R(\kappa, N)
\to \text{Hom}_R(\kappa, N'')
\\
\phantom{0\ }
\to \text{Ext}^1_R(\kappa, N')
\to \text{Ext}^1_R(\kappa, N)
\to \text{Ext}^1_R(\kappa, N'')
\to \ldots
\end{matrix}
$$
from Lemma \ref{lemma-long-exact-seq-ext}.
\end{proof}














\section{Tor groups and flatness}
\label{section-tor}

\noindent
In this section we use some of the homological algebra
developed in the previous section to explain what
Tor groups are. Namely, suppose that $R$ is a ring
and that $M$, $N$ are two $R$-modules. Choose
a resolution $F_\bullet$ of $M$ by free $R$-modules.
See Lemma \ref{lemma-resolution-by-finite-free}.
Consider the homological complex
$$
F_\bullet \otimes_R N
:
\ldots 
\to F_2 \otimes_R N 
\to F_1 \otimes_R N 
\to F_0 \otimes_R N 
$$
We define $\text{Tor}^R_i(M, N)$ to be the $i$th homology
group of this complex. The following lemma explains in
what sense this is well defined.

\begin{lemma}
\label{lemma-tor-welldefined}
Let $R$ be a ring. Let $M_1, M_2, N$ be $R$-modules.
Suppose that $F_\bullet$ is a free resolution of
the module $M_1$ and that $G_\bullet$ is a free
resolution of the module $M_2$. Let $\varphi : M_1 \to M_2$
be a module map. Let $\alpha : F_\bullet \to G_\bullet$
be a map of complexes inducing $\varphi$ on
$M_1 = \text{Coker}(d_{F,1}) \to M_2 = \text{Coker}(d_{G,1})$,
see Lemma \ref{lemma-compare-resolutions}.
Then the induced maps
$$
H_i(\alpha) :
H_i(F_\bullet \otimes_R N)
\longrightarrow
H_i(G_\bullet \otimes_R N)
$$
are independent of the choice of $\alpha$. If $\varphi$
is an isomorphism, so are all the maps $H_i(\alpha)$.
If $M_1 = M_2$, $F_\bullet = G_\bullet$, and
$\varphi$ is the identity, so are all the maps $H_i(\alpha)$.
\end{lemma}

\begin{proof}
The proof of this lemma is identical to the proof of Lemma
\ref{lemma-ext-welldefined}.
\end{proof}

\noindent
Not only does this lemma imply that the Tor modules are well defined,
but it also provides for the functoriality of the constructions
$(M, N) \mapsto \text{Tor}_i^R(M, N)$ in the first variable. Of course
the functoriality in the second variable is evident. We leave it to
the reader to see that each of the $\text{Tor}_i^R$ is in fact
a functor
$$
\text{Mod}_R \times \text{Mod}_R \to \text{Mod}_R.
$$
Here $\text{Mod}_R$ denotes the category of $R$-modules, and
for the definition of the product category
see Categories, Definition \ref{categories-definition-product-category}.
Namely, given morphisms of $R$-modules $M_1 \to M_2$
and $N_1 \to N_2$ we get a commutative diagram
$$
\xymatrix{
\text{Tor}_i^R(M_1, N_1) \ar[r] \ar[d] &
\text{Tor}_i^R(M_1, N_2) \ar[d] \cr
\text{Tor}_i^R(M_2, N_1) \ar[r] &
\text{Tor}_i^R(M_2, N_2) \cr
}
$$

\begin{lemma}
\label{lemma-long-exact-sequence-tor}
Let $R$ be a ring and let $M$ be an $R$-module.
Suppose that $0 \to N' \to N \to N'' \to 0$ is a short
exact sequence of $R$-modules. There exists a long 
exact sequence
$$
\begin{matrix}
M \otimes_R N'
\to M\otimes_R N
\to M\otimes_R N''
\to 0
\\
\text{Tor}_1^R(M, N')
\to \text{Tor}_1^R(M, N)
\to \text{Tor}_1^R(M, N'')
\to
\end{matrix}
$$
\end{lemma}

\begin{proof}
The proof of this is the same as the proof of
Lemma \ref{lemma-long-exact-seq-ext}.
\end{proof}

\noindent
Consider a homological double complex of $R$-modules
$$
\xymatrix{
\ldots \ar[r]^d &
A_{2,0} \ar[r]^d &
A_{1,0} \ar[r]^d &
A_{0,0} \cr
\ldots \ar[r]^d &
A_{2,1} \ar[r]^d \ar[u]^\delta &
A_{1,1} \ar[r]^d \ar[u]^\delta &
A_{0,1} \ar[u]^\delta \cr
\ldots \ar[r]^d &
A_{2,2} \ar[r]^d \ar[u]^\delta &
A_{1,2} \ar[r]^d \ar[u]^\delta &
A_{0,2} \ar[u]^\delta \cr
&
\ldots \ar[u]^\delta &
\ldots \ar[u]^\delta &
\ldots \ar[u]^\delta \cr
}
$$
This means that $d_{i,j} : A_{i,j} \to A_{i-1,j}$
and $\delta_{i,j} : A_{i,j} \to A_{i, j-1}$ have the following
properties
\begin{enumerate}
\item Any composition of two $d_{i,j}$ is zero. In other words
the rows of the double complex are complexes.
\item Any composition of two $\delta_{i,j}$ is zero. In other words
the columns of the double complex are complexes.
\item For any pair $(i,j)$ we have $\delta_{i-1,j} \circ d_{i,j}
= d_{i,j-1} \circ \delta_{i,j}$. In other words, all the squares
commute.
\end{enumerate}
The correct thing to do is to associate a spectral sequence to
any such double complex. However, for the moment we can get away with
doing something slightly easier.

\medskip\noindent
Namely, for the purposes of this section only, given a double
complex $(A_{\bullet,\bullet}, d, \delta)$ set
$R(A)_j = \text{Coker}(A_{1,j} \to A_{0,j})$ and
$U(A)_i = \text{Coker}(A_{i,1} \to A_{i,0})$. (The letters
$R$ and $U$ are meant to suggest Right and Up.)
We endow $R(A)_\bullet$ with the structure of a complex
using the maps $\delta$. Similarly we endow $U(A)_\bullet$
with the structure of a complex using the maps $d$.
In other words we obtain the following huge commutative diagram
$$
\xymatrix{
\ldots \ar[r]^d &
U(A)_2 \ar[r]^d &
U(A)_1 \ar[r]^d &
U(A)_0 &
\cr
\ldots \ar[r]^d &
A_{2,0} \ar[r]^d \ar[u] &
A_{1,0} \ar[r]^d \ar[u] &
A_{0,0} \ar[r] \ar[u] &
R(A)_0 \cr
\ldots \ar[r]^d &
A_{2,1} \ar[r]^d \ar[u]^\delta &
A_{1,1} \ar[r]^d \ar[u]^\delta &
A_{0,1} \ar[r] \ar[u]^\delta &
R(A)_1 \ar[u]^\delta \cr
\ldots \ar[r]^d &
A_{2,2} \ar[r]^d \ar[u]^\delta &
A_{1,2} \ar[r]^d \ar[u]^\delta &
A_{0,2} \ar[r] \ar[u]^\delta &
R(A)_2 \ar[u]^\delta \cr
&
\ldots \ar[u]^\delta &
\ldots \ar[u]^\delta &
\ldots \ar[u]^\delta &
\ldots \ar[u]^\delta \cr
}
$$
(This is no longer a double complex of course.)
It is clear what a morphism $\Phi : (A_{\bullet,\bullet}, d, \delta)
\to (B_{\bullet,\bullet}, d, \delta)$ of double complexes
is, and it is clear that this induces morphisms of complexes
$R(\Phi) : R(A)_\bullet \to R(B)_\bullet$ and
$U(\Phi) : U(A)_\bullet \to U(B)_\bullet$.

\begin{lemma}
\label{lemma-no-spectral-sequence}
Let $(A_{\bullet,\bullet}, d, \delta)$ be a double complex such
that
\begin{enumerate}
\item Each row $A_{\bullet, j}$ is a resolution of $R(A)_j$.
\item Each column $A_{i, \bullet}$ is a resolution of $U(A)_i$.
\end{enumerate}
Then there are canonical isomorphisms
$$
H_i(R(A)_\bullet)
\cong
H_i(U(A)_\bullet).
$$
The isomorphisms are functorial with respect to morphisms
of double complexes with the properties above.
\end{lemma}

\begin{proof}
We will show that $H_i(R(A)_\bullet))$
and $H_i(U(A)_\bullet)$ are canonically
isomorphic to a third group. Namely
$$
\mathbf{H}_i(A) :=
\frac{
\{
(a_{i,0}, a_{i-1,1}, \ldots, a_{0,i})
\mid
d(a_{i,0}) = \delta(a_{i-1,1}),\ldots,
d(a_{1, i-1}) = \delta(a_{0,i})
\}}
{
\{
d(a_{i+1,0}) - \delta(a_{i,1}),
d(a_{i,1}) - \delta(a_{i-1,2}),
\ldots,
d(a_{1,i}) - \delta(a_{0,i+1})
\}
}
$$
Here we use the notational convention that $a_{i,j}$ denotes
an element of $A_{i,j}$. In other words, an element of $\mathbf{H}_i$
is represented by a zig-zag, represented as follows for $i = 2$
$$
\xymatrix{
a_{2,0} \ar@{|->}[r] & d(a_{2,0}) = \delta(a_{1,1}) & \cr
& a_{1,1} \ar@{|->}[u] \ar@{|->}[r] & d(a_{1,1}) = \delta(a_{0,2}) \cr
& & a_{0,2} \ar@{|->}[u] \cr
}
$$
Naturally, we divide out by ``trivial'' zig-zags, namely the submodule
generated by elements of the form $(0,\ldots,0,-\delta(a_{t+1,t-i}),
d(a_{t+1,t-i}),0,\ldots,0)$. Note that there are canonical
homomorphisms
$$
\mathbf{H}_i(A) \to H_i(R(A)_\bullet),\ \ 
(a_{i,0}, a_{i-1,1}, \ldots, a_{0,i}) \mapsto 
\text{class of image of }a_{0,i}
$$
and
$$
\mathbf{H}_i(A) \to H_i(U(A)_\bullet),\ \ 
(a_{i,0}, a_{i-1,1}, \ldots, a_{0,i}) \mapsto 
\text{class of image of }a_{i,0}
$$

\medskip\noindent
First we show that these maps are surjective.
Suppose that $\overline{r} \in H_i(R(A)_\bullet)$.
Let $r \in R(A)_i$ be a cocycle representing the
class of $\overline{r}$.
Let $a_{0,i} \in A_{0,i}$ be an element which
maps to $r$. Because $\delta(r) = 0$,
we see that $\delta(a_{0,i})$ is in the
image of $d$. Hence there exists an element
$a_{1, i-1} \in A_{1,i-1}$ such that
$d(a_{1,i-1}) = \delta(a_{0,i})$. This in turn
implies that $\delta(a_{1,i-1})$ is in the kernel
of $d$ (because $d(\delta(a_{1,i-1})) = \delta(d(a_{1,i-1}))
= \delta(\delta(a_{0,i})) = 0$. By exactness of the
rows we find an element $a_{2, i-2}$ such that
$d(a_{2,i-2}) = \delta(a_{1,i-1})$. And so on
until a full zig-zag is found. Of course surjectivity
of $\mathbf{H}_i \to H_i(U(A))$ is shown similarly.

\medskip\noindent
To prove injectivity we argue in exactly the same way.
Namely, suppose we are given a zig-zag 
$(a_{i,0}, a_{i-1,1}, \ldots, a_{0,i})$
which maps to zero in $H_i(R(A)_\bullet)$.
This means that $a_{0, i}$ maps to an element
of $\text{Coker}(A_{i, 1} \to A_{i,0})$
which is in the image of
$\delta : \text{Coker}(A_{i+1, 1} \to A_{i+1,0}) \to
\text{Coker}(A_{i, 1} \to A_{i,0})$.
In other words, $a_{0,i}$ is in the image of
$\delta \oplus d : A_{0,i+1} \oplus A_{1, i} \to A_{0,i}$.
From the definition of trivial zig-zags we see that
we may modify our zig-zag by a trivial one and
assume that $a_{0,i} = 0$. This immediately
implies that $d(a_{1, i-1}) = 0$. As the rows
are exact this implies that $a_{1, i-1}$ is
in the image of $d : A_{2, i-1} \to A_{1, i-1}$.
Thus we may modify our zig-zag once again by a
trivial zig-zag and assume that our zig-zag looks
like $(a_{i,0}, a_{i-1,1}, \ldots, a_{2,i-2},0,0)$.
Continuing like this we obtain the desired injectivity.

\medskip\noindent
If $\Phi : (A_{\bullet,\bullet}, d, \delta)
\to (B_{\bullet,\bullet}, d, \delta)$ is a morphism
of double complexes both of which satisfy the conditions
of the lemma, then we clearly obtain a commutative
diagram
$$
\xymatrix{
H_i(U(A)_\bullet) \ar[d] &
\mathbf{H}_i(A) \ar[r] \ar[l] \ar[d] &
H_i(R(A)_\bullet) \ar[d] \cr
H_i(U(B)_\bullet) &
\mathbf{H}_i(B) \ar[r] \ar[l] &
H_i(R(B)_\bullet) \cr
}
$$
This proves the functoriality.
\end{proof}

\begin{remark}
\label{remark-signs-double-complex}
The isomorphism constructed above is the ``correct'' one only up to signs.
A good part of homological algebra is concerned with choosing signs for
various maps and showing commutativity of diagrams with intervention
of suitable signs. For the moment we will simply use the isomorphism
as given in the proof above, and worry about signs later.
\end{remark}

\begin{lemma}
\label{lemma-tor-left-right}
Let $R$ be a ring. For any $i \geq 0$ the functors
$\text{Mod}_R \times \text{Mod}_R \to \text{Mod}_R$,
$(M, N) \mapsto \text{Tor}_i^R(M,N)$ and
$(M, N) \mapsto \text{Tor}_i^R(N,M)$ are
canonically isomorphic.
\end{lemma}

\begin{proof}
Let $F_\bullet$ be a free resolution of the module $M$ and
let $G_\bullet$ be a free resolution of the module $N$.
Consider the double complex $(A_{i,j}, d, \delta)$ defined
as follows:
\begin{enumerate}
\item set $A_{i, j} = F_i \otimes_R G_j$, 
\item set $d_{i, j} : F_i \otimes_R G_j \to F_{i-1} \otimes G_j$
equal to $d_{F, i} \otimes \text{id}$, and
\item set $\delta_{i, j} : F_i \otimes_R G_j \to F_i \otimes G_{j-1}$
equal to $\text{id} \otimes d_{G, j}$.
\end{enumerate}
This double complex is usually simply denoted $F_\bullet \otimes_R G_\bullet$.

\medskip\noindent
Since each $G_j$ is free, and hence flat we see that each
row of the double complex is exact except in homological
degree $0$. Since each $F_i$ is free and hence flat we see that each
column of the double complex is exact except in homological
degree $0$. Hence the double complex satisfies the conditions
of Lemma \ref{lemma-no-spectral-sequence}.

\medskip\noindent
To see what the lemma says we compute $R(A)_\bullet$ and $U(A)_\bullet$.
Namely,
\begin{eqnarray*}
R(A)_i & = & \text{Coker}(A_{1, i} \to A_{0,i}) \cr
& = & \text{Coker}(F_1 \otimes_R G_i \to F_0 \otimes_R G_i) \cr
& = & \text{Coker}(F_1 \to F_0) \otimes_R G_i \cr
& = & M \otimes_R G_i
\end{eqnarray*}
In fact these isomorphisms are compatible with the differentials
$\delta$ and we see that $R(A)_\bullet = M \otimes_R G_\bullet$
as homological complexes. In exactly the same way we see that
$U(A)_\bullet = F_\bullet \otimes_R N$. We get
\begin{eqnarray*}
\text{Tor}_i^R(M, N)
& = & H_i(F_\bullet \otimes_R N) \cr
& = & H_i(U(A)_\bullet) \cr
& = & H_i(R(A)_\bullet) \cr
& = & H_i(M \otimes_R G_\bullet) \cr
& = & H_i(G_\bullet\otimes_R M) \cr
& = & \text{Tor}_i^R(N, M)
\end{eqnarray*}
Here the third equality is Lemma \ref{lemma-no-spectral-sequence}, and
the fifth equality uses the isomorphism $V\otimes W = W \otimes V$
of the tensor product.

\medskip\noindent
Functoriality. Suppose that we have $R$-modules $M_\nu$, $N_\nu$,
$\nu = 1,2$. Let $\varphi : M_1 \to M_2$ and $\psi : N_1 \to N_2$
be morphisms of $R$-modules.
Suppose that we have free resolutions $F_{\nu, \bullet}$
for $M_\nu$ and free resolutions $G_{\nu, \bullet}$ for $N_\nu$.
By Lemma \ref{lemma-compare-resolutions} we may choose
maps of complexes $\alpha : F_{1, \bullet} \to F_{2, \bullet}$
and $\beta : G_{1, \bullet} \to G_{2, \bullet}$ compatible
with $\varphi$ and $\psi$. We claim that
the pair $(\alpha, \beta)$ induces a morphism of double
complexes
$$
\alpha \otimes \beta :
F_{1, \bullet} \otimes_R G_{1, \bullet}
\longrightarrow
F_{2, \bullet} \otimes_R G_{2, \bullet}
$$
This is really a very straightforward check using the rule
that $F_{1,i} \otimes_R G_{1,j} \to F_{2,i} \otimes_R G_{2,j}$
is given by $\alpha_i \otimes \beta_j$ where $\alpha_i$, resp.\ 
$\beta_j$ is the degree $i$, resp.\ $j$ component of $\alpha$,
resp.\ $\beta$. The reader also readily verifies that the
induced maps $R(F_{1, \bullet} \otimes_R G_{1, \bullet})_\bullet
\to R(F_{2, \bullet} \otimes_R G_{2, \bullet})_\bullet$
agrees with the map $M_1 \otimes_R G_{1,\bullet}
\to M_2 \otimes_R G_{2, \bullet}$ induced by $\varphi \otimes \beta$.
Similarly for the map induced on the $U(-)_\bullet$ complexes.
Thus the statement on functoriality follows from the statement
on functoriality in Lemma \ref{lemma-no-spectral-sequence}.
\end{proof}

\begin{remark}
\label{remark-curiosity-signs-swap}
An interesting case occurs when $M = N$ in the above.
In this case we get a canonical map $\text{Tor}_i^R(M, M)
\to \text{Tor}_i^R(M, M)$. Note that this map is not the
identity, because even when $i = 0$ this map is not the
identity! For example, if $V$ is a vector space of dimension
$n$ over a field, then the switch map $V \otimes_k V \to V\otimes_k V$
has $(n^2+n)/2$ eigenvalues $+1$ and $(n^2-n)/2$ eigenvalues
$-1$. In characteristic $2$ it is not even diagonalizable.
Note that even changing the sign of the map will not get rid
of this.
\end{remark}

\begin{lemma}
\label{lemma-characterize-flat}
Let $R$ be a ring. Let $M$ be an $R$-module. 
The following are equivalent:
\begin{enumerate}
\item The module $M$ is flat over $R$.
\item For all $i$ the functor $\text{Tor}_i^R(M, -)$ is zero.
\item The functor $\text{Tor}_1^R(M, -)$ is zero.
\item For all ideals $I \subset R$ we have $\text{Tor}_1^R(M, R/I) = 0$.
\item For all finitely generated ideals $I \subset R$ we have
$\text{Tor}_1^R(M, R/I) = 0$.
\end{enumerate}
\end{lemma}

\begin{proof}
Suppose $M$ is flat. Let $N$ be an $R$-module.
Let $F_\bullet$ be a free resolution of $N$.
Then $F_\bullet \otimes_R M$ is a resolution of $N\otimes_R M$,
by flatness of $M$. Hence all higher tor groups vanish.

\medskip\noindent
It now suffices to show that the last condition implies that
$M$ is flat. Let $I \subset R$ be an ideal.
Consider the short exact sequence
$0 \to I \to R \to R/I \to 0$. Apply
Lemma \ref{lemma-long-exact-sequence-tor}. We get an
exact sequence
$$
\text{Tor}_1^R(M, R/I) \to
M \otimes_R I \to
M \otimes_R R \to
M \otimes_R R/I \to
0
$$
Since obviously $M\otimes_R R = M$ we conclude that the
last hypothesis implies that $M \otimes_R I \to M$ is
injective for every finitely generated ideal $I$. 
Thus $M$ is flat by Lemma \ref{lemma-flat}.
\end{proof}

\begin{remark}
\label{remark-Tor-ring-mod-ideal}
The proof of Lemma \ref{lemma-characterize-flat} actually shows
that
$$
\text{Tor}_1^R(M, R/I)
=
\text{Ker}(I \otimes_R M \to M).
$$
\end{remark}














\section{Functorialities for $\text{Tor}$}
\label{section-functoriality-tor}

\noindent
In this section we briefly discuss the functoriality
of $\text{Tor}$ with respect to change of ring, etc.
Here is a list of items to work out.
\begin{enumerate}
\item Given a ring map $R \to R'$, an $R$-module
$M$ and an $R'$-module $N'$
the $R$-modules $\text{Tor}_i^R(M, N')$ have
a natural $R'$-module structure.
\item Given a ring map $R \to R'$ and $R$-modules
$M$, $N$ there is a natural $R$-module map
$\text{Tor}_i^R(M, N) \to \text{Tor}_i^{R'}(M \otimes_R R', N\otimes_R R')$.
\item Given a ring map $R \to R'$ an $R$-module $M$ and
an $R'$-module $N'$ there exists a natural
$R'$-module map
$\text{Tor}_i^R(M, N') \to \text{Tor}_i^{R'}(M \otimes_R R', N')$.
\end{enumerate}




















\section{Completion}
\label{section-completion}

\noindent
Suppose that $R$ is a ring and $I$ is an ideal.
We define the {\it completion of $R$ with respect to $I$}
to be the limit
$$
\hat R = \lim_{n} R/I^n.
$$
An element of $\hat R$ is simply given by a sequence
of elements $f_n \in R/I^n$ such that $f_n \cong f_{n+1} \bmod I^n$
for all $n$. Similarly, if $M$ is an $R$-module then we define the
{\it completion of $M$ with respect to $I$}
to be the limit
$$
\hat M = \lim_{n} M/I^nM.
$$
An element of $\hat M$ is simply given by a sequence of
elemtents $m_n \in M/I^nM$ such that $m_n \cong m_{n+1} \bmod I^nM$
for all $n$. From this description it is clear that there 
is always a natural map
$$
M \otimes_R \hat R
\longrightarrow
\hat M.
$$

\begin{lemma}
\label{lemma-completion-tensor}
Suppose $R$ is Noetherian.
\begin{enumerate}
\item If $N \to M$ is an injective map of finite $R$-modules,
then $\hat N \to \hat M$ is injective.
\item If $M$ is a finite $R$-module, then $\hat M = M \otimes_R \hat R$.
\end{enumerate}
\end{lemma}

\begin{proof}
For the first statement, by the Artin-Rees Lemma \ref{lemma-Artin-Rees},
we have a constant $c$ such that $I^nM \cap N$
equals $I^{n-c}(I^cM \cap N) \subset I^{n-c}N$.
Thus if $(n_i) \in \hat N$ maps to zero in
$\hat M$, then each $n_i$ maps to zero in $N/I^{i-c}N$.
And hence $n_{i-c} = 0$. Thus $\hat N \to \hat M$ is injective.

\medskip\noindent
For the second statement let $0\to K \to R^t \to M \to 0$
be a presentation of $M$, corresponding the the generators
$x_1,\ldots,x_t$ of $M$. Let $(m_n) \in \hat M$.
We will inductively choose lifts $x_n \in (R/I^n)^t$ of 
$m_n \in M/I^nM$ such that $x_n \cong x_{n-1} \bmod (I^n)^t$.
Namely, given $x_1,\ldots, x_n$ choose some $y \in R^t$
lifting $x_n$. Then the image $\overline{y}$ and $m_{n=1}$
in $M/I^{n+1}M$ map to the same element in $M/I^nM$. 
Hence we can write the difference as
$\overline{y} - m_{n+1} = \sum h_j x_j$ with
$h_j \in I^n$. Take $x_{n+1} = y - \sum h_j e_j$, where
$e_j$ is the standard basis element of $R^t$.
This shows that $\hat R^t \to \hat M$ is surjective,
and hence for any finitely generated $R$-module the
canonical map $M \otimes_R \hat R \to \hat M$ is surjective.
Hence to prove the second statement it suffices
to prove the the kernel of $\hat R^t \to \hat M$ is
exactly $\hat K$.

\medskip\noindent
Let $(x_n) \in \hat R^t$ be in the kernel. Note that
each $x_n$ is in the image of the map $K/I^nK \to (R/I^n)^t$.
Choose $c$ as in the Artin-Rees
Lemma \ref{lemma-Artin-Rees} such that $(I^n)^t \cap K 
\subset I^{n-c} K$. For each $n \geq 0$ choose 
$y_n \in K/I^{n+c}K$ mapping to $x_{n+c}$, and
set $z_n = y_n \bmod I^nK$. The elements $z_n$ satisfy $z_{n+1} - z_n \bmod I^nK
= y_{n+1} - y_{n} \bmod I^nK$, and $y_{n+1} - y_n \in
I^{n+c}R^t$ by construction. Hence $z_{n+1} \cong z_n \bmod I^nK$
by the choice of $c$ above.
\end{proof}

\begin{lemma}
\label{lemma-completion-flat}
Let $R$ be a Noetherian ring.
Let $I \subset R$ be an ideal.
The ring map $R \to \hat R$ is flat.
\end{lemma}

\begin{proof}
Let $I \subset R$ be an ideal.
Consider $I \otimes_R \hat R \to R\otimes_R \hat R = \hat R$.
According to Lemma \ref{lemma-completion-tensor} this
is identified with $\hat I \to \hat R$ and this is injective.
The result follows from Lemma \ref{lemma-flat}.
\end{proof}

\begin{lemma}
\label{lemma-completion-faithfully-flat}
Let $R$ be a Noetherian local ring.
Let $\mathfrak m \subset R$ be the maximal ideal.
Let $I \subset \mathfrak m$ be an ideal.
The ring map $R \to \hat R$ is faithfully flat.
In particular the completion with respect to $\mathfrak m$,
namely $\lim_n R/\mathfrak m^n$ is faithfully flat.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-completion-flat} it is flat.
The composition $R \to \hat R \to R/\mathfrak m$ where
the last map is the projection map $\hat R \to R/I$
combined with $R/I \to R/\mathfrak m$ shows that
$\mathfrak m$ is in the image of $\text{Spec}(\hat R)
\to \text{Spec}(R)$. Hence the map is faithfully
flat by Lemma \ref{lemma-ff}.
\end{proof}























\section{Criteria for flatness}
\label{section-criteria-flatness}

\begin{lemma}
\label{lemma-mod-injective}
Suppose that $R \to S$ is a local homomorphism of Noetherian
local rings. Denote $\mathfrak m$ the maximal ideal of $R$.
Let $u : M \to N$ be a map of finite $S$-modules.
Assume $N$ flat over $R$.
If $\overline{u} : M/\mathfrak mM \to N/\mathfrak mN$
is injective then $u$ is injective.
In this case $N/u(M)$ is flat over $R$.
\end{lemma}

\begin{proof}
First we claim that $u_n : M/{\mathfrak m}^nM \to N/{\mathfrak m}^nN$ 
is injective for all $n \geq 1$. We proceed by induction, the base
case given by assumption. By our assumption that $N$ is flat
over $R$ we have  a short exact sequence
$0 \to N\otimes_R {\mathfrak m}^n/{\mathfrak m}^{n+1}
\to N/{\mathfrak m}^{n+1}N \to N/{\mathfrak m}^n N\to 0$.
Also, $N\otimes_R {\mathfrak m}^n/{\mathfrak m}^{n+1}
= N/{\mathfrak m}N \otimes_{R/{\mathfrak m}}
{\mathfrak m}^n/{\mathfrak m}^{n+1}$. We have 
a similar exact sequence $M\otimes_R {\mathfrak m}^n/{\mathfrak m}^{n+1}
\to M/{\mathfrak m}^{n+1}M \to M/{\mathfrak m}^n M\to 0$
for $M$ except we do not have the zero on the left. We also
have $M\otimes_R {\mathfrak m}^n/{\mathfrak m}^{n+1}
= M/{\mathfrak m}M \otimes_{R/{\mathfrak m}}
{\mathfrak m}^n/{\mathfrak m}^{n+1}$. Thus the map $u_{n+1}$ is
injective as both $u_n$ and the map
$\overline{u}\otimes \text{id}_{{\mathfrak m}^n/{\mathfrak m}^{n+1}}$ are.

\medskip\noindent
Note that $\lim_n M/{\mathfrak m}^nM$ is the completion
of the module $M$ with respect to the ideal $I = {\mathfrak m}S$,
and similarly for $N$. Since $M$ and $N$ are finite $S$-modules
we have $\hat M = M \otimes \hat S$ and similarly for $N$, see Lemma
\ref{lemma-completion-tensor}.
We conclude that $u \otimes 1 : M \otimes \hat S
\to N \otimes \hat S$ is injective. Since $\hat S$ is faithfully
flat over $S$, see Lemma \ref{lemma-completion-faithfully-flat},
we conclude that $u$ is injective, see Lemma \ref{lemma-flat}.

\medskip\noindent
Finally, we have to prove that $I \otimes_R N/u(M) \to N/u(M)$
is injective for every ideal $I \subset R$. Consider the diagram
$$
\begin{matrix}
&
&
0
&
&
0
&
&
0
&
&
\\
&
&
\uparrow
&
&
\uparrow
&
&
\uparrow
&
&
\\
&
&
M/IM
&
\to
&
N/IN
&
\to
&
N/(IN+u(M))
&
\to
&
0
\\
&
&
\uparrow
&
&
\uparrow
&
&
\uparrow
&
&
\\
0
&
\to
&
M
&
\to
&
N
&
\to
&
N/u(M)
&
\to
&
0
\\
&
&
\uparrow
&
&
\uparrow
&
&
\uparrow
&
&
\\
&
&
M \otimes_R I
&
\to
&
N \otimes_R I
&
\to
&
N/u(M)\otimes_R I
&
\to
&
0
\end{matrix}
$$
The arrow $N\otimes_R I \to N$ is injective.
Chasing through the diagram we see 
that it suffices to prove that
$M/IM$ injects into $N/IN$.
Note that $M/IM$ and $N/IN$ are modules
over the Noetherian ring $S/IS$,
$N/IN$ is flat over $R/I$ and
$u \bmod I : M/IM \to N/IN$ is injective
module $\mathfrak m$ we may apply
the result above to $u \bmod I$, and we win.
\end{proof}

\begin{lemma}
\label{lemma-grothendieck}
Suppose that $R \to S$ is a flat and local ring homomorphism of Noetherian
local rings. Denote $\mathfrak m$ the maximal ideal of $R$.
Suppose $f \in S$ is a nonzero divisor in $S/{\mathfrak m}S$.
Then $S/fS$ is flat over $R$.
\end{lemma}

\begin{proof}
Follows directly from Lemma \ref{lemma-mod-injective}.
\end{proof}

\begin{lemma}
\label{lemma-free-fibre-flat-free}
Let $R \to S$ be a local homomorphism of Noetherian
local rings. Let $\mathfrak m$ be the maximal
ideal of $R$. Let $M$ be a finite $S$-modules.
Suppose that (a) $M/\mathfrak mM$
is a free $S/\mathfrak mS$-module, and (b) $M$ is flat over $R$.
Then $M$ is free and $S$ is flat over $R$.
\end{lemma}

\begin{proof}
Let $\overline{x}_1,\ldots,\overline{x}_n$ be a basis
for the free module $M/\mathfrak mM$. Choose lifts
$x_1,\ldots,x_n \in M$ of the $\overline{x}_i$. Let
$u : S^{\oplus n} \to M$ be the map which maps the $i$th
standard basis vector to $x_i$. By Lemma \ref{lemma-mod-injective}
we see that $u$ is injective. On the other hand, by
Nakayama's Lemma \ref{lemma-NAK} the map is surjective. The
lemma follows.
\end{proof}

\begin{lemma}
\label{lemma-complex-exact-mod}
Let $R \to S$ be a local homomorphism of local Noetherian
rings. Let $\mathfrak m$ be the maximal ideal of $R$.
Let $0 \to F_e \to F_{e-1} \to \ldots \to F_0$
be a finite complex of finite $S$-modules. Assume that
each $F_i$ is $R$-flat, and that the complex
$0 \to F_e/\mathfrak m F_e \to F_{e-1}/\mathfrak m F_{e-1}
\to \ldots \to F_0 / \mathfrak m F_0$ is exact.
Then $0 \to F_e \to F_{e-1} \to \ldots \to F_0$
is exact, and moreover the module
$\text{Coker}(F_1 \to F_0)$ is $R$-flat.
\end{lemma}

\begin{proof}
By induction on $e$. If $e = 1$, then this is exactly
Lemma \ref{lemma-mod-injective}. If $e > 1$, we see
by Lemma \ref{lemma-mod-injective} that $F_e \to F_{e-1}$
is injective and that $C = \text{Coker}(F_e \to F_{e-1})$
is a finite $S$-module flat over $R$. Hence we can 
apply the induction hypothesis to the complex
$0 \to C \to F_{e-2} \to \ldots \to F_0$.
We deduce that $C \to F_{e-2}$ is injective
and the exactness of the complex follows, as well
as the flatness of the cokernel of $F_1 \to F_0$.
\end{proof}

\begin{lemma}
\label{lemma-prepare-local-criterion-flatness}
Let $R$ be a local ring with maximal ideal $\mathfrak m$
and residue field $\kappa = R/\mathfrak m$.
Let $M$ be an $R$-module. If $\text{Tor}_1^R(\kappa, M) = 0$,
then for every finite length $R$-module $N$ we have
$\text{Tor}_1^R(N, M) = 0$.
\end{lemma}

\begin{proof}
By descending induction on the length of $N$.
If the length of $N$ is $1$, then $N \cong \kappa$
and we are done. If the length of $N$ is more than
$1$, then we can fit $N$ into a short exact sequence
$0 \to N' \to N \to N'' \to 0$ where $N'$, $N''$ are
finite length $R$-modules of smaller length.
The vanishing of $\text{Tor}_1^R(N, M)$ follows
from the vanishing of $\text{Tor}_1^R(N', M)$
and $\text{Tor}_1^R(N'', M)$ (induction hypothesis)
and the long exact sequence of Tor groups, see Lemma
\ref{lemma-long-exact-sequence-tor}.
\end{proof}

\begin{lemma}
\label{lemma-local-criterion-flatness}
Local criterion for flatness.
Let $R \to S$ be a local homomorphism of local Noetherian
rings. Let $\mathfrak m$ be the maximal ideal of $R$,
and let $\kappa = R/\mathfrak m$.
Let $M$ be a finite $S$-module. If $\text{Tor}_1^R(\kappa, M) = 0$,
then $M$ is flat over $R$.
\end{lemma}

\begin{proof}
Let $I \subset R$ be an ideal. By Lemma \ref{lemma-flat} it suffices
to show that $I \otimes_R M \to M$ is injective. By Remark
\ref{remark-Tor-ring-mod-ideal} we see that this kernel is
equal to $\text{Tor}_1^R(M, R/I)$. By
Lemma \ref{lemma-prepare-local-criterion-flatness}
we see that $J \otimes_R M \to M$ is injective for all ideals
of finite colength.

\medskip\noindent
Choose $n >> 0$ and consider the following short exact 
sequence
$$
0
\to I \cap \mathfrak m^n
\to I \oplus \mathfrak m^n
\to I + \mathfrak m^n
\to 0
$$
This is a sub sequence of the short exact sequence
$0 \to R \to R^{\oplus 2} \to R \to 0$. Thus we get the diagram
$$
\xymatrix{
(I\cap \mathfrak m^n) \otimes_R M \ar[r] \ar[d] &
I \otimes_R M \oplus \mathfrak m^n \otimes_R M \ar[r] \ar[d] &
(I + \mathfrak m^n) \otimes_R M \ar[d] \cr
M \ar[r] & 
M \oplus M \ar[r] &
M
}
$$
Note that $I + \mathfrak m^n$ and $\mathfrak m^n$
are ideals of finite colength.
Thus a diagram chase shows that
$\text{Ker}((I \cap \mathfrak m^n)\otimes_R M \to M)
\to \text{Ker}(I\otimes_R M \to M)$
is surjective. We conclude in particular that
$K = \text{Ker}(I\otimes_R M \to M)$ is contained
in the image of $(I \cap \mathfrak m^n) \otimes_R M$
in $I \otimes_R M$. By Artin-Rees, Lemma \ref{lemma-Artin-Rees}
we see that $K$ is contained
in $\mathfrak m^{n-c}(I \otimes_R M)$ for some $c > 0$
and all $n >> 0$. Since $I \otimes_R M$ is a finite
$S$-module (!) and since $S$ is Noetherian, we see
that this implies $K = 0$. Namely, the above implies
$K$ maps to zero in the $\mathfrak mS$-adic completion
of $I\otimes_R M$. But the map from $S$
to its $\mathfrak mS$-adic completion is faithfully flat
by Lemma \ref{lemma-completion-faithfully-flat}.
Hence $K = 0$, as desired.
\end{proof}

\begin{lemma}
\label{lemma-variant-local-criterion-flatness}
Let $R \to S$ be a local homomorphism of Noetherian
local rings. Let $I \not = R$ be an ideal in $R$.
Let $M$ be a finite $S$-module. If $\text{Tor}_1^R(M, R/I) = 0$
and $M/IM$ is flat over $R/I$, then $M$ is flat over $R$.
\end{lemma}

\begin{proof}
Let $\mathfrak m$ be the maximal ideal of $R$.
We will show that $\mathfrak m \otimes_R M \to M$ is injective,
and then apply Lemma \ref{lemma-local-criterion-flatness}.
Suppose that $\sum f_i \otimes x_i \in \mathfrak m \otimes_R M$
and that $\sum f_i x_i = 0$ in $M$. By the equational criterion
for flatness Lemma \ref{lemma-flat-eq} applied to $M/IM$
over $R/I$ we see there exist $\overline{a}_{ij} \in R/I$
and $\overline{y}_j \in M/IM$ such that
$x_i \bmod IM = \sum_j \overline{a}_{ij} \overline{y}_j $
and $0 = \sum_i (f_i \bmod I) \overline{a}_{ij}$.
Let $a_{ij} \in R$ be a lift of $\overline{a}_{ij}$ and
similarly let $y_j \in M$ be a lift of $\overline{y}_j$.
Then we see that
\begin{eqnarray*}
\sum f_i \otimes x_i
& = &
\sum f_i \otimes x_i +
\sum f_ia_{ij} \otimes y_j -
\sum f_i \otimes a_{ij} y_j
\\
& = &
\sum f_i \otimes (x_i - \sum a_{ij} y_j) +
\sum (\sum f_i a_{ij}) \otimes y_j
\end{eqnarray*}
Since $x_i - \sum a_{ij} y_j \in IM$ and
$\sum f_i a_{ij} \in I$ we see that there exists
an element in $I \otimes_R M$ which maps to our given
element $\sum f_i \otimes x_i$ in $\mathfrak m \otimes_R M$.
But $I \otimes_R M \to M$ is injective by assumption (see
Remark \ref{remark-Tor-ring-mod-ideal}) and we win.
\end{proof}

\begin{lemma}
\label{lemma-surjective-on-tor-one}
Let $R \to R' \to R''$ be ring maps.
Let $M$ be an $R$-module. Suppose that $M \otimes_R R'$ 
is flat over $R'$. Then the natural map
$\text{Tor}_1^R(M, R') \otimes_{R'} R'' \to
\text{Tor}_1^R(M, R'')$ is onto.
\end{lemma}

\begin{proof}
Let $F_\bullet$ be a free resolution of $M$ over $R$.
The complex $F_2 \otimes_R R' \to F_1\otimes_R R' \to F_0 \otimes_R R'$
computes $\text{Tor}_1^R(M, R')$. 
The complex $F_2 \otimes_R R'' \to F_1\otimes_R R'' \to F_0 \otimes_R R''$
computes $\text{Tor}_1^R(M, R'')$. Note that
$F_i \otimes_R R' \otimes_{R'} R'' = F_i \otimes_R R''$. Let
$K' = \text{Ker}(F_1\otimes_R R' \to F_0 \otimes_R R')$ and
similarly $K'' = \text{Ker}(F_1\otimes_R R'' \to F_0 \otimes_R R'')$.
Thus we have an exact sequence
$$
0 \to K' \to F_1\otimes_R R' \to F_0 \otimes_R R' \to M\otimes_R R' \to 0.
$$
By the assumption that $M\otimes_R R'$ is flat over $R'$,
the sequence $0 \to K' \otimes_{R'} R''
\to F_1 \otimes_R R'' \to F_0 \otimes_R R'' \to M\otimes_R R'' \to 0$
is still exact. This means that $K'' = K' \otimes_{R'} R''$.
Since $\text{Tor}_1^R(M, R')$ is a quotient of $K'$ and
$\text{Tor}_1^R(M, R'')$ is a quotient of $K''$ we win.
\end{proof}

\begin{lemma}
\label{lemma-surjective-on-tor-one-trivial}
Let $R \to R'$ be a ring map. Let $I \subset R$ be
an ideal and $I' = IR$. Let $M$ be an $R$-module
and set $M' = M \otimes_R R'$. The natural map
$\text{Tor}_1^R(R'/I', M) \to \text{Tor}_1^{R'}(R'/I', M')$
is surjective.
\end{lemma}

\begin{proof}
Let $F_2 \to F_1 \to F_0 \to M \to 0$ be a free resolution of
$M$ over $R$. Set $F_i' = F_i \otimes_R R'$. The sequence
$F_2' \to F_1' \to F_0' \to M' \to 0$ may no longer be exact
at $F_1'$. A free resolution of $M'$ over $R'$ therefore looks
like
$$
F_2' \oplus F_2'' \to F_1' \to F_0' \to M' \to 0
$$
for a suitable free module $F_2''$ over $R'$. Next, note that
$F_i \otimes_R R'/I' = F_i' / IF_i' = F_i'/I'F_i'$.
So the complex $F_2'/I'F_2' \to F_1'/I'F_1' \to F_0'/I'F_0'$
computes $\text{Tor}_1^R(M, R'/I')$. On the other hand
$F_i' \otimes_{R'} R'/I' = F_i'/I'F_i'$ and similarly
for $F_2''$. Thus the complex
$F_2'/I'F_2' \oplus F_2''/I'F_2'' \to F_1'/I'F_1' \to F_0'/I'F_0'$
computes $\text{Tor}_1^{R'}(M', R'/I')$. Since the vertical
map on complexes
$$
\xymatrix{
F_2'/I'F_2' \ar[r] \ar[d] &
F_1'/I'F_1' \ar[r] \ar[d] &
F_0'/I'F_0' \ar[d] \\
F_2'/I'F_2' \oplus F_2''/I'F_2'' \ar[r] &
F_1'/I'F_1' \ar[r] &
F_0'/I'F_0'
}
$$
clearly induces a surjection on cohomology we win.
\end{proof}

\begin{lemma}
\label{lemma-another-variant-local-criterion-flatness}
Let
$$
\xymatrix{
S \ar[r] & S' \\
R \ar[r] \ar[u] & R' \ar[u]
}
$$
be a commutative diagram of local homomorphisms of local Noetherian rings.
Let $I \subset R$ be an ideal. 
Let $M$ be an $S$-module.
Denote $I' = IR'$ and $M' = M\otimes_S S'$.
Assume that
\begin{enumerate}
\item $S'$ is a localization of the tensor product
$S \otimes_R R'$,
\item $M/IM$ is flat over $R/I$,
\item $\text{Tor}_1^R(M, R/I) \to \text{Tor}_1^{R'}(M', R'/I')$
is zero.
\end{enumerate}
Then $M'$ is flat over $R'$.
\end{lemma}

\begin{proof}
Since $S'$ is a localization of $S \otimes_R R'$ we see that
$M'$ is a localization of $M \otimes_R R'$. Note that
by Lemma \ref{lemma-flat-base-change} the module $M/IM \otimes_{R/I} R'/I'
= M \otimes_R R' /I'(M \otimes_R R')$ is flat over $R'/I'$. Hence also
$M'/I'M'$ is flat over $R'/I'$ as the localization of a flat module
is flat. By Lemma \ref{lemma-variant-local-criterion-flatness}
it suffices to show that $\text{Tor}_1^{R'}(M', R'/I')$ is zero.
Since $M'$ is a localization of $M \otimes_R R'$, the last assumption
implies that it suffices to show that
$\text{Tor}_1^R(M, R/I) \otimes_R R'
\to
\text{Tor}_1^{R'}(M \otimes_R R', R'/I')$
is surjective.

\medskip\noindent
By Lemma \ref{lemma-surjective-on-tor-one-trivial} we see that
$\text{Tor}_1^R(M, R'/I') \to \text{Tor}_1^{R'}(M\otimes_R R', R'/I')$
is surjective. So now it suffices to show that
$\text{Tor}_1^R(M, R/I) \otimes_R R'
\to
\text{Tor}_1^R(M, R'/I')$
is surjective. This follows from Lemma \ref{lemma-surjective-on-tor-one}
by looking at the ring maps $R \to R/I \to R'/I'$ and the module $M$.
\end{proof}
























\section{What makes a complex exact?}
\label{section-complex-exact}

\noindent
Some of this material can be found in a paper by Buchsbaum and Eisenbud.

\begin{situation}
\label{situation-complex}
Here $R$ is a ring, and we have a complex
$$
0
\to
R^{n_e}
\xrightarrow{\varphi_e}
R^{n_{e-1}}
\xrightarrow{\varphi_{e-1}}
\ldots
\xrightarrow{\varphi_{i+1}}
R^{n_i}
\xrightarrow{\varphi_i}
R^{n_{i-1}}
\xrightarrow{\varphi_{i-1}}
\ldots
\xrightarrow{\varphi_1}
R^{n_0}
$$
In other words we require $\varphi_i \circ \varphi_{i+1} = 0$
for $i = 1, \ldots, e - 1$.
\end{situation}

\begin{lemma}
\label{lemma-add-trivial-complex}
In Situation \ref{situation-complex}.
Suppose $R$ is a local ring with maximal ideal $\mathfrak m$.
Suppose that for some $i$, $e \leq i \leq 1$
some matrix coefficient of the map $\varphi_i$ is invertible.
Then the complex $0 \to R^{n_e} \to R^{n_{e-1}} \to \ldots \to R^{n_0}$
is isomorphic to the direct sum of a complex
$0 \to R^{n_e} \to \ldots \to R^{n_i - 1} \to
R^{n_{i-1} - 1} \to \ldots \to R^{n_0}$
and the complex $0 \to 0 \to \ldots \to R \to R \to 0 \to \ldots \to 0$
where the map $R \to R$ is the identity map.
\end{lemma}

\begin{proof}
The assumption means, after a change of basis of
$R^{n_i}$ and $R^{n_{i-1}}$ that the first basis
vector of $R^{n_i}$ is mapped via $\varphi_i$ to the first basis
vector of $R^{n_{i-1}}$. Let $e_j$ denote the
$j$th basis vector of $R^{n_i}$ and $f_k$ the $k$th
basis vector of $R^{n_{i-1}}$. Write $\varphi_i(e_j) 
= \sum a_{jk} f_k$. So $a_{1k} = 0$ unless $k = 1$
and $a_{11} = 1$. Change basis on $R^{n_i}$ again
by setting $e'_j = e_j - a_{j1} e_1$ for $j > 1$.
After this change of coordinates we have $a_{j1} = 0$
for $j > 1$. Note the image
of $R^{n_{i+1}} \to R^{n_i}$ is contained in the
subspace spanned by $e_j$, $j > 1$. Note also
that $R^{n_{i-1}} \to R^{n_{i-2}}$ has to annihilate
$f_1$ since it is in the image. These conditions
and the shape of the matrix $(a_{jk})$ for $\varphi_i$
imply the lemma.
\end{proof}

\noindent
Let us say that an acyclic complex of the form
$\ldots \to 0 \to R \to R \to 0 \to \ldots $
is {\it trivial}. The lemma above clearly says that
any finite complex of finite free modules over a local ring is up to direct
sums with trivial complexes the same as a complex
all of whose maps have all matrix coefficients in 
the maximal ideal.

\begin{lemma}
\label{lemma-exact-artinian-local}
In Situation \ref{situation-complex}.
Let $R$ be a Artinian local ring.
Suppose that $0 \to R^{n_e} \to R^{n_{e-1}}
\to \ldots \to R^{n_0}$ is an exact complex.
Then the complex is isomorphic to a direct sum of
trivial complexes.
\end{lemma}

\begin{proof}
By induction on the integer $\sum n_i$.
Clearly $\text{Ass}(R) = \{\mathfrak m\}$.
Pick $x \in R$, $x \not = 0$, $\mathfrak m x = 0$.
Pick a basis vector $e_i \in R^{n_e}$.
Since $xe_i$ is not be mapped to zero by
exactness of the complex we deduce that some matrix 
coefficient of the map $R^{n_e} \to R^{n_{e-1}}$
is not in $\mathfrak m$.
Lemma \ref{lemma-add-trivial-complex} then allows
us to decrease $\sum n_i$.
\end{proof}

\noindent
Below we define the rank of a map of finite free modules.
This is just one possible definition of rank. It 
is just the definition that works in this section; there
are others that may be more convenient in other settings.

\begin{definition}
\label{definition-rank}
Let $R$ be a ring. Suppose that $\varphi : R^m \to R^n$ is a map
of finite free modules.
\begin{enumerate}
\item The {\it rank} of $\varphi$ is the maximal $r$ such that
$\wedge^r \varphi : \wedge^r R^m \to \wedge^r R^n$ is nonzero.
\item We let $I(\varphi) \subset R$ be the ideal generated by
the $r\times r$ minors of the matrix of $\varphi$, where $r$
is the rank as defined above.
\end{enumerate}
\end{definition}

\begin{lemma}
\label{lemma-trivial-case-exact}
In Situation \ref{situation-complex}, suppose the complex is
isomorphic to a direct sum of trivial complexes. Then
we have
\begin{enumerate}
\item the maps $\varphi_i$ have rank
$r_i = n_i - n_{i+1} + \ldots + (-1)^{e-i-1} n_{e-1} + (-1)^{e-i} n_e$,
\item for all $i$, $1 \leq i \leq e$ we have
$\text{rank}(\varphi_{i+1}) + \text{rank}(\varphi_i) = n_i$,
\item each $I(\varphi_i) = R$.
\end{enumerate}
\end{lemma}

\begin{proof}
We may assume the complex is the direct sum of trivial
complexes. Then for each $i$ we can split the standard basis
elements of $R^{n_i}$ into those that map to a basis element
of $R^{n_{i-1}}$ and those that are mapped to zero (and these
are mapped onto by basis elements of $R^{n_{i+1}}$).
Using descending
induction starting with $i = e$ it is easy to prove that there
are $r_{i+1}$-basis elements of $R^{n_i}$ which are mapped
to zero and $r_i$ which are mapped to basis elements of
$R^{n_{i-1}}$. From this the result follows.
\end{proof}

\begin{lemma}
\label{lemma-exact-length-1}
Let $R$ be a local Noetherian ring.
Suppose that $\varphi : R^m \to R^n$ is a map
of finite free modules. The following are equivalent
\begin{enumerate}
\item $\varphi$ is injective.
\item the rank of $\varphi$ is $m$ and
either $I(\varphi) = R$ or it contains a nonzero divisor.
\end{enumerate}
\end{lemma}

\begin{proof}
If any matrix coefficient of $\varphi$ is not in $\mathfrak m$,
then we apply lemma \ref{lemma-add-trivial-complex} to write
$\varphi$ as the sum of $1 : R \to R$ and a map
$\varphi' : R^{m-1} \to R^{n-1}$. It is easy to see that
the lemma for $\varphi'$ implies the lemma for $\varphi$.
Thus we may assume from the outset that all the matrix 
coefficients of $\varphi$ are in $\mathfrak m$.

\medskip\noindent
Suppose $\varphi$ is injective. We may assume $m > 0$.
Let $q \in \text{Ass}(R)$. Let $x \in R$ be an element
whose annihilator is $\mathfrak q$. Note that $\varphi$
induces a injective map $xR^m \to xR^n$ which is isomorphic
to the map $\varphi_{\mathfrak q} : (R/\mathfrak q)^m \to (R/\mathfrak q)^n$
induced by $\varphi$. Since $R/\mathfrak q$ is a domain
we deduce immediately by localizing to its fraction field
that the rank of $\varphi_{\mathfrak q}$ is $m$ and that
$I(\varphi_{\mathfrak q})$ is not the zero ideal. Hence we
conclude by Lemma \ref{lemma-ideal-nonzerodivisor}.

\medskip\noindent
Conversely, assume that the rank of $\varphi$ is $m$
and that $I(\varphi)$ contains a non zerodivisor.
The rank being $m$ implies $n \geq m$. Let $I$ be
a subset $I \subset \{1,\ldots,n\}$ of cardinality
$m$ and denote $p_I : R^{n} \to R^m$ the projection
corresponding to the coordinate functions whose indices
are in $I$. Denote $\varphi_I$ the composition
$p_I \circ \varphi$ and $a_I = \det(\varphi_I)$.
our assumption is that there exist $b_I \in R$ such
that $x = \sum b_I a_I$ is a nonzero divisor.
Let $\psi_I : R^m \to R^m$ be a the adjoint map, i.e.,
such that $\varphi_I \circ \psi_I = \psi_I \circ \varphi_I = 
a_I \text{id}_{R^m}$. Suppose $v \in R^m$ is in the kernel of $\varphi$.
Then $\varphi_I(v) = 0$. Hence $xv = \sum b_I a_I v 
= \sum b_I (\psi_I \circ \varphi_I)(v)
= \sum b_I \psi_I(\varphi_I(v)) = 0$. Thus $v = 0$.
\end{proof}

\begin{lemma}
\label{lemma-exact-depth-zero-local}
In Situation \ref{situation-complex}. Suppose $R$ is
a local Noetherian ring with maximal ideal $\mathfrak m$.
Assume $\mathfrak m \in \text{Ass}(R)$, in other words
$R$ has depth $0$. Suppose that the complex is exact.
In this case the complex is isomorphic to a direct sum of trivial
complexes.
\end{lemma}

\begin{proof}
The proof is the same as in \ref{lemma-exact-artinian-local},
except using Lemma \ref{lemma-exact-length-1} to garantee
that $I(\varphi_e) = R$, and hence some matrix coefficient
of $\varphi_e$ is not in $\mathfrak m$.
\end{proof}

\begin{lemma}
\label{lemma-div-x-exact-one-less}
In Situation \ref{situation-complex}, suppose $R$ is
a local Noetherian ring, and suppose that the complex
is exact. Let $x$ be an element of the maximal ideal
which is a nonzero divisor. The complex
$0 \to (R/xR)^{n_e} \to \ldots \to (R/xR)^{n_1}$
is still exact.
\end{lemma}

\begin{proof}
Follows easily from the snake lemma.
\end{proof}

\begin{lemma}
\label{lemma-acyclic}
(Acyclicity lemma.)
Let $R$ be a local Noetherian ring.
Let $0 \to M_e \to M_{e-1} \to \ldots \to M_0$
be a complex of finite $R$-modules. 
Assume $\text{depth}(M_i) \geq i$.
Let $i$ be the largest index such that the complex is
not exact at $M_i$. If $i > 0$ then
$\text{Ker}(M_i \to M_{i-1})/\text{Im}(M_{i+1} \to M_i)$
has depth $\geq 1$.
\end{lemma}

\begin{proof}
Let $H = \text{Ker}(M_i \to M_{i-1})/\text{Im}(M_{i+1} \to M_i)$ be the 
cohomology group in question.
We may break the complex into short exact sequences
$0 \to M_e \to M_{e-1} \to K_{e-2} \to 0$,
$0 \to K_j \to M_j \to K_{j-1} \to 0$, for $i+2 \leq j \leq e-2 $,
$0 \to K_{i+1} \to M_{i+1} \to B_i \to 0$,
$0 \to K_i \to M_i \to M_{i-1}$, and
$0 \to B_i \to K_i \to H \to 0$.
We proceed up through these complexes to
prove the statements about depths, repeatedly using
Lemma \ref{lemma-depth-in-ses}.
First of all, since $\text{depth}(M_e) \geq e$,
and $\text{depth}(M_{e-1}) \geq e-1$ we deduce
that $\text{depth}(K_{e-1}) \geq e - 1$. At this point the
sequences $0 \to K_j \to M_j \to K_{j-1} \to 0$ for $i+2 \leq j \leq e-2 $
imply similarly that $\text{depth}(K_{j-1}) \geq j - 1$ for
$i+2 \leq j \leq e-2$. The sequence $0 \to K_{i+1} \to M_{i+1} \to B_i \to 0$
then shows that $\text{depth}(B_i) \geq i$. The sequence
$0 \to K_i \to M_i \to M_{i-1}$ shows that $\text{depth}(K_i) \geq 1$
since $M_i$ has depth $\geq i \geq 1$ by assumption.
The sequence $0 \to B_i \to K_i \to H \to 0$ then
implies the result.
\end{proof}

\begin{proposition}
\label{proposition-what-exact}
In Situation \ref{situation-complex}, suppose $R$ is
a local Noetherian ring. The complex is exact if and
only if for all $i$, $1 \leq i \leq e$
the following two conditions are satisfied:
\begin{enumerate}
\item we have $\text{rank}(\varphi_{i+1}) + \text{rank}(\varphi_i)
= n_i$, and
\item $I(\varphi_i) = R$, or $I(\varphi_i)$ contains a
regular sequence of length $i$.
\end{enumerate}
\end{proposition}

\begin{proof}
This proof is very similar to the proof of Lemma
\ref{lemma-exact-length-1}.
As in the proof of Lemma \ref{lemma-exact-length-1} we may assume
that all matrix entries of each $\varphi_i$ are elements of
the maximal ideal. We may also assume that $e \geq 1$.

\medskip\noindent
Assume the complex is exact. Let $q \in \text{Ass}(R)$.
(There is at least one such prime.)
Note that the ring $R_{\mathfrak q}$ has depth $0$.
We apply Lemmas \ref{lemma-exact-depth-zero-local} and
\ref{lemma-trivial-case-exact} to the localized complex
over $R_{\mathfrak q}$. all of the ideals
$I(\varphi_i)_{\mathfrak q}$, $e \geq i \geq 1$
are equal to $R_{\mathfrak q}$. Thus none of the ideals
$I(\varphi_i)$ is contained in $\mathfrak q$.
This implies that $I(\varphi_e)I(\varphi_{e-1})\ldots I(\varphi_1)$
is not contained in any of the associated primes 
of $R$. By Lemma \ref{lemma-silly} we may choose
$x \in I(\varphi_e)I(\varphi_{e-1})\ldots I(\varphi_1)$,
$x \not \in \mathfrak q$ for all $q\in \text{Ass}(R)$.
According to Lemma \ref{lemma-div-x-exact-one-less}
the complex $0 \to (R/xR)^{n_e}
\to \ldots \to (R/xR)^{n_1}$ is exact. By induction
on $e$ all the ideals $I(\varphi_i)/xR$ have a regular
sequence of length $i-1$. This proves that $I(\varphi_i)$
contains a regular sequence of length $i$.

\medskip\noindent
Assume the two conditions on the ranks of $\varphi_i$
and the ideals $I(\varphi_i)$ is satisfied. Note that
$I(\varphi_i) \subset \mathfrak m$ for all $i$ because
of what was said in the first paragraph of the proof.
Hence the assumption in particular implies that
$\text{depth}(R) \geq e$. By induction
on the dimension of $R$ we may assume the complex
is exact when localized at any nonmaximal prime of $R$.
Thus $\text{Ker}(\varphi_i)/\text{Im}(\varphi_{i+1})$
has support $\{\mathfrak m\}$ and hence (if nonzero)
depth $0$. By Lemma \ref{lemma-acyclic} we see
that the complex is exact.
\end{proof}












\section{Cohen-Macaulay modules}
\label{section-CM}

\noindent
Here we just do a minimal amount of work to show that
Cohen-Macaulay modules have good properties. We postpone
using Ext groups to esthablish the connection with duality
and so on.

\begin{definition}
\label{definition-CM}
Let $R$ be a Noetherian local ring.
Let $M$ be a finite $R$-module.
We say $M$ is {\it Cohen-Macaulay}
if $\dim(\text{Support}(M)) = \text{depth}(M)$.
\end{definition}

\noindent
Let $R$ be a local Noetherian ring. Let $M$ be
a Cohen-Macaulay module, and let $f_1,\ldots,f_d$
be an $M$-regular sequence with $d = \dim(\text{Support}(M))$.
We say that $g \in \mathfrak m$ is {\it good with respect to
$(M, f_1,\ldots,f_d)$} if for all $i = 0, 1, \ldots, d-1$
we have $\dim (\text{Support}(M) \cap V(g,f_1,\ldots,f_i))
= d - i - 1$. This is equivalent to the condition that
$\dim((\text{Support}(M/(f_1,\ldots,f_i)M) \cap V(g) =
d - i -1$ for $i = 0, 1, \ldots, d-1$.

\begin{lemma}
\label{lemma-good-element}
Notation and assumptions as above. If $g$ is good with respect to
$(M, f_1,\ldots,f_d)$, then (a) $g$ is a nonzero-divisor on $M$,
and (b) $M/gM$ is Cohen-Macaulay with maximal regular
sequence $f_1,\ldots,f_{d-1}$.
\end{lemma}

\begin{proof}
We prove the lemma by induction on $d$.
If $d = 0$, then $M$ is finite and there is no case
to which the lemma applies.
If $d = 1$, then we have to show that $g : M \to M$ is
injective. The kernel $K$ has support $\{\mathfrak m\}$
because by assumption $\dim \text{Supp}(M) \cap V(g) = 0$.
Hence $K$ has finite length. Hence $f_1 : K \to K$ injective
implies the length of the image is the length of $K$, and hence
$f_1 K = K$, which by Nakayama's Lemma \ref{lemma-NAK} implies $K = 0$.
Also, $\dim \text{Supp}(M/gM) = 0$ and so $M/gM$ is Cohen-Macaulay
of depth $0$.

\medskip\noindent
For $d > 1$ we essentially argue in the same way. Let $K \subset M$
be the kernel of multiplication by $g$. As above $f_1 : K \to K$
cannot be surjective if $K \not= 0$
Consider the commutative diagram
$$
\begin{matrix}
0 & \to & M & \xrightarrow{f_1} & M & \to & M/f_1M & \to & 0 \\
& & \downarrow{g} & & \downarrow{g} & & \downarrow{g} && \\
0 & \to & M & \xrightarrow{f_1} & M & \to & M/f_1M & \to & 0 \\
\end{matrix}
$$
This shows that the kernel $K_1$ of $g : M/f_1M \to M/f_1M$
cannot be zero if $K$ is not zero. But $g$ is good for
$(M/f_1M, f_2,\ldots,f_d)$, as is easy seen from the definition.
We conclude that $K_1 = 0$, and so $K = 0$. From the snake
lemma we see that
$0 \to M/gM \to M/gM \to M/(f_1, g)M \to 0$
is exact. By induction, we have that $M/(g, f_1)M$
is Cohen-Macaulay with regular sequence $f_2,\ldots,f_{d-1}$.
Thus $M/gM$ is Cohen-Macaulay with regular sequence $f_1,\ldots,f_{d-1}$.
\end{proof}

\begin{lemma}
\label{lemma-CM-one-g}
Let $R$ be a Noetherian local ring.
Let $M$ be a Cohen-Macaulay module over $R$.
Suppose $g \in \mathfrak m$ is such that $\dim(\text{Supp}(M) \cap V(g))
= \dim(\text{Supp}(M)) - 1$. Then (a) $g$ is a nonzero divisor on $M$,
and (b) $M/gM$ is Cohen-Macaulay of depth one less.
\end{lemma}

\begin{proof}
Choose a $M$-regular sequence $f_1,\ldots,f_d$ with
$d = \dim(\text{Supp}(M))$. If $g$ is is good with respect to
$(M, f_1,\ldots,f_d)$ we win by Lemma \ref{lemma-good-element}.
In particular the lemma holds if $d = 1$. (The case $d = 0$ does
not occur.) Assume $d > 1$. Choose an element $h \in R$ such that
(a) $h$ is good with respect to $(M, f_1,\ldots,f_d)$,
and (b) $\dim( \text{Supp}(M) \cap V(h, g) = d - 2$.
To see $h$ exists, let $\{\mathfrak q_i\}$ be the (finite) set of
minimal primes of the closed sets $\text{Supp}(M)$,
$\text{Supp}(M)\cap V(f_1,\ldots,f_i)$, $i=1,\ldots, d-1$,
and $\text{Supp}(M) \cap V(g)$. None of these $\mathfrak q_i$
is equal to $\mathfrak m$ and hence we may find $h \in \mathfrak m$,
$h \not \in \mathfrak q_i$ by Lemma \ref{lemma-silly}. It is clear
that $h$ satisfies (a) and (b). At this point we may
apply Lemma \ref{lemma-good-element} to conclude that
$M/hM$ is Cohen-Macaulay. By (b) we see that the pair
$(M/hM, g)$ satisfies the induction hypothesis. Hence
$M/(h,g)M$ is Cohen-Macaulay, and $g : M/hM \to M/hM$
is injective. From this it follows easily that
$g : M \to M$ is injective, by a snake lemma argument.
This in its turn implies that $h : M/gM \to M/gM$
is injective. Combined with the fact that $M/(g,h)M$
is Cohen-Macaulay this finishes the proof.
\end{proof}

\begin{proposition}
\label{proposition-CM-module}
Let $R$ be a Noetherian local ring, with maximal ideal $\mathfrak m$.
Let $M$ be a Cohen-Macaulay module over $R$ whose support has dimension $d$.
Suppose that $g_1,\ldots,g_c$ are elements of
$\mathfrak m$ such that $\dim(\text{Supp}(M/(g_1,\ldots,g_c)M))
= d - c$. Then $g_1,\ldots,g_c$ is an $M$-regular sequence,
and can be extended to a maximal $M$-regular sequence.
\end{proposition}

\begin{proof}
Let $Z = \text{Supp}(M) \subset \text{Spec}(R)$.
By Lemma \ref{lemma-one-equation} in the chain
$Z \supset Z \cap V(g_1) \supset \ldots \supset Z \cap V(g_1,\ldots,g_c)$
each step decreases the dimension at most by $1$. Hence by assumption
each step decreases the dimension by exactly $1$ each time. Thus we 
may succesively apply Lemma \ref{lemma-CM-one-g} above to the modules
$M/(g_1,\ldots,g_i)$ and the element $g_{i+1}$.

\medskip\noindent
To extend $g_1,\ldots,g_c$ by one element if $c < d$ we simply
choose an element $g_{c+1} \in \mathfrak m$ which is not
in any of the finitely many minimal primes of $Z \cap V(g_1,\ldots,g_c)$,
using Lemma \ref{lemma-silly}.
\end{proof}












\section{Cohen-Macaulay rings}
\label{section-CM-ring}

\begin{definition}
\label{definition-local-ring-CM}
A Noetherian local ring $R$ is called {\it Cohen-Macaulay}
if it is Cohen-Macaualay as a module over itself.
\end{definition}

\noindent
Note that this is equivalent to requiring the existence
of a $R$-regular sequence $x_1,\ldots,x_d$ of the maximal
ideal such that $R/(x_1,\ldots,x_d)$ has dimension $0$.
We will usually just say ``regular sequence'' and not
``$R$-regular sequence''.

\begin{lemma}
\label{lemma-maximal-chain-CM}
Let $R$ be Noetherian local.
Suppose $R$ is Cohen-Macaulay of dimension $d$.
Any maximal chain of ideals $\mathfrak p_0 \subset
\mathfrak p_1 \subset \ldots \subset \mathfrak p_n$
has length $n = d$.
\end{lemma}

\begin{proof}
Choose an element $x \in \mathfrak p_1$, with $x$ not in
any of the minimal primes of $R$, and in particular
$x \not \in \mathfrak p_0$. (See Lemma \ref{lemma-silly}.)
Then $\dim (R/xR) < \dim (R)$ and $R/xR$ is Cohen-Macaulay
by Proposition \ref{proposition-CM-module}. By induction
the chain $\mathfrak p_1/xR \subset \ldots \mathfrak p_n/xR$
has length $d - 1$.
\end{proof}

\begin{lemma}
\label{lemma-CM-dim-formula}
Suppose $R$ is a Noetherian local Cohen-Macaulay ring of dimension $d$.
For any prime $\mathfrak p \subset R$ we have
$$
\dim(R) = \dim(R_{\mathfrak p}) + \dim(R/\mathfrak p).
$$
\end{lemma}

\begin{proof}
This is immediate from the result on maximal sequences
above, by looking at maximal sequences which have $\mathfrak p$
in them.
\end{proof}

\begin{lemma}
\label{lemma-localize-CM}
Suppose $R$ is a Cohen-Macaulay local ring.
For any prime $\mathfrak p \subset R$ the
ring $R_{\mathfrak p}$ is Cohen-Macaulay as well.
\end{lemma}

\begin{proof}
Suppose that $\dim(R) = d$ and that $\dim(R/\mathfrak p) = d - c$.
We may choose $f_1,\ldots,f_c \in \mathfrak p$ such that
$\dim V(f_1,\ldots,f_i) = d - i$, using Lemma \ref{lemma-silly}
at each step to avoid minimal primes of $V(f_1,\ldots,f_{i-1})$.
Then $\mathfrak p$ is minimal over $(f_1,\ldots,f_c)$ and hence
the support of $R_{\mathfrak p}/(f_1,\ldots,f_c)R_{\mathfrak p}$ consists
of the maximal ideal of $R_{\mathfrak p}$. In other words
$R_{\mathfrak p}$ has an ideal of definition generated by
$c$ elements, and has dimension $c$ by Lemma \ref{lemma-CM-dim-formula}.
\end{proof}

\begin{definition}
\label{definition-ring-CM}
A Noetherian ring $R$ is called {\it Cohen-Macaulay} if all
its local rings are Cohen-Macaulay.
\end{definition}

\begin{lemma}
\label{lemma-CM-polynomial-algebra}
Suppose $R$ is a Cohen-Macaulay ring.
Any polynomial algebra over $R$ is Cohen-Macaulay.
\end{lemma}

\begin{proof}
By induction on the number of variables it suffices
to prove that $R[x]$ is Cohen-Macaulay if $R$ is.
Let $\mathfrak q \subset R[x]$ be a prime, and
let $\mathfrak p$ be its image.
Let $f_1,\ldots,f_d$ be a regular sequence
in the maximal ideal of $R_{\mathfrak p}$ of length
$d = \dim(R_{\mathfrak p})$. Note that since
$R[x]$ is flat over $R$ the localization
$R[x]_{\mathfrak q}$ is flat over $R_{\mathfrak p}$.
Hence, by Lemma \ref{lemma-flat-increases-depth}, the sequence $f_1,\ldots,f_d$
is a regular sequence of length $d$ in $R[x]_{\mathfrak q}$.
The quotient $R[x]_{\mathfrak q}/(f_1,\ldots,f_d)$
is a localization of $(R_{\mathfrak p}/(f_1,\ldots,f_d))[x]$
at a prime $\overline{\mathfrak q}$. It is clear that
either $\overline{\mathfrak q}$ contains a monic
polynomial $f$ in $(R_{\mathfrak p}/(f_1,\ldots,f_d))[x]$,
or $\overline{\mathfrak q}$ equals the kernel of
$(R_{\mathfrak p}/(f_1,\ldots,f_d))[x] \to \kappa(\mathfrak p)[x]$.
In the first case the monic polynomial $f$ is a nonzero
divisor in $(R_{\mathfrak p}/(f_1,\ldots,f_d))[x]$ and hence
in $R[x]_{\mathfrak q}/(f_1,\ldots,f_d)$, and $x_1,\ldots,x_d, f$
is a regular sequence in $R[x]_{\mathfrak q}$
such that $\dim(R[x]_{\mathfrak q}/(x_1,\ldots,x_d,f)) = 0$.
In the second case it is already the case that
$\dim R[x]_{\mathfrak q}/(f_1,\ldots,f_d) = 0$.
\end{proof}


\begin{lemma}
\label{lemma-dimension-shift}
Suppose that $R$ is a Noetherian local Cohen-Macaulay ring of dimension $d$.
Suppose that $M$ is a finite $R$-module, and suppose that
$0 \to K \to R^{n} \to M \to 0$ is an exact sequence of $R$-modules.
Then either $\text{depth}(K) > \text{depth}(M)$, or
$\text{depth}(K) = \text{depth}(M) = d$.
\end{lemma}

\begin{proof}
If $\text{depth}(M) = 0$ the lemma is clear.
Let $x \in \mathfrak m$ be a nonzero divisor on $M$ and
on $R$. Then $x$ is a nonzero divisor on $M$ and on $K$
and it follows by an easy diagram chase that
$0 \to K/xK \to (R/xR)^n \to M/xM \to 0$ is exact.
Thus the result follows from the result for $K/xK$
over $R/xR$ which has smaller dimension.
\end{proof}

\begin{definition}
\label{definition-maximal-CM}
Let $R$ be a Noetherian local Cohen-Macaulay ring.
A finite module $M$ over $R$ is called a {\it maximal
Cohen-Macaualay} module if $\text{depth}(M) = \dim(R)$.
\end{definition}

\begin{lemma}
\label{lemma-mcm-resolution}
Let $R$ be a local Noetherian Cohen-Macaulay ring of dimension $d$
Let $M$ be a finite $R$ module of depth $e$.
There exists an exact complex
$$
0 \to K \to F_{d-e-1} \to \ldots \to F_0 \to M \to 0
$$
with each $F_i$ finite free and $K$ maximal Cohen-Macaulay.
\end{lemma}

\begin{proof}
Immediate from the definition and Lemma \ref{lemma-dimension-shift}.
\end{proof}








\section{Catenary rings}
\label{section-catenary}

\begin{definition}
\label{definition-catenary}
A ring $R$ is said to be {\it catenary} if for any pair of prime ideals
$\mathfrak p \subset \mathfrak q$, all maximal chains of primes
$\mathfrak p = \mathfrak p_0 \subset \mathfrak p_1 \subset \ldots \subset
\mathfrak p_e = \mathfrak q$ have the same (finite) length.
\end{definition}

\begin{lemma}
\label{lemma-localization-catenary}
Any localization of a catenary ring is catenary.
\end{lemma}

\begin{proof}
FIXME.
\end{proof}

\begin{lemma}
\label{lemma-quotient-catenary}
Any quotient of a catenary ring is catenary.
\end{lemma}

\begin{proof}
FIXME.
\end{proof}

\noindent
In general it is not the case that a finitely generated
$R$-algebra is catenary if $R$ is. Thus we make the following
definition.

\begin{definition}
\label{definition-universally-catenary}
A ring $R$ is said to be {\it universally catenary}
if $R$ is Noetherian and every $R$ algebra of finite
type is catenary.
\end{definition}

\noindent
By Lemma \ref{lemma-quotient-catenary}
this just means that $R$ is Noetherian
and that each polynomial algebra $R[x_1,\ldots,x_n]$
is catenary.

\begin{lemma}
\label{lemma-CM-ring-catenary}
A Cohen-Macaulay ring is universally catenary.
\end{lemma}

\begin{proof}
Since a polynomial algebra over $R$ is Cohen-Macaulay,
by Lemma \ref{lemma-CM-polynomial-algebra},
it suffices to show that a Cohen-Macaulay ring is
catenary.
Let $R$ be Cohen-Macaulay and $\mathfrak p \subset \mathfrak q$
primes of $R$. By definition $R_{\mathfrak q}$ and
$R_{\mathfrak p}$ are Cohen-Macaulay.
Take a maximal chain of primes
$\mathfrak p = \mathfrak p_0 \subset \mathfrak p_1 \subset
\ldots \subset \mathfrak p_n = \mathfrak q$.
Next choose a maximal chain of primes
$\mathfrak q_0 \subset \mathfrak q_1 \subset \ldots \subset
\mathfrak q_m = \mathfrak p$.
By \ref{lemma-maximal-chain-CM} we have
$n + m = \dim(R_{\mathfrak q})$. And we have
$m = \dim(R_{\mathfrak p})$ by the same lemma.
Hence $n = \dim(R_{\mathfrak q}) - \dim(R_{\mathfrak p})$
is independent of choices.
\end{proof}















\section{Regular rings}
\label{section-regular}

\noindent
It is not that easy to show that all prime localizations of a regular local
are regular. In fact, quite a bit of the material developped sofar is
geared towards a proof of this fact. See
Proposition \ref{proposition-finite-gl-dim-regular}, and
trace back the references.

\begin{lemma}
\label{lemma-regular-graded}
Let $R$ be a regular local ring with maximal ideal $\mathfrak m$.
The graded ring $\bigoplus \mathfrak m^n / \mathfrak m^{n+1}$
is isomorphic to the graded polynomial algebra
$\kappa(\mathfrak m)[X_1,\ldots,X_d]$.
\end{lemma}

\begin{proof}
Let $x_1,\ldots,x_d$ be a minimal set of generators
for the maximal ideal $\mathfrak m$.
Write $\kappa = \kappa(\mathfrak m)$.
There is a surjection $\kappa[X_1,\ldots,X_d]
\to \bigoplus \mathfrak m^n/\mathfrak m^{n+1}$,
which maps the class of $x_i$ in $\mathfrak m/\mathfrak m^2$
to $X_i$. Since $d(R) = d$ we know that the numerical
polynomial $n \mapsto \dim_\kappa \mathfrak m^n/\mathfrak m^{n+1}$
has degree $d$. By Lemma \ref{lemma-quotient-smaller-d} we 
conclude that the surjection $\kappa[X_1,\ldots,X_d]
\to \bigoplus \mathfrak m^n/\mathfrak m^{n+1}$ is an isomorphism.
\end{proof}

\begin{lemma}
\label{lemma-regular-domain}
Any regular local ring is a domain.
\end{lemma}

\begin{proof}
We will use that $\bigcap \mathfrak m^n = 0$
by Lemma \ref{lemma-intersect-powers-ideal-module-zero}.
Let $f, g \in R$ such that $fg = 0$.
Suppose that $f \in \mathfrak m^a$ and
$g \in \mathfrak m^b$, with $a,b$ maximal.
Since $fg = 0 \in \mathfrak m^{a+b+1}$
we see from the result of Lemma \ref{lemma-regular-graded}
that either $f \in \mathfrak m^{a+1}$ or
$g \in \mathfrak m^{b+1}$. Contradiction.
\end{proof}

\begin{lemma}
\label{lemma-regular-ring-CM}
Let $R$ be a regular local ring and let
$x_1,\ldots,x_d$ be a minimal set of generators
for the maximal ideal $\mathfrak m$. Then
$x_1,\ldots,x_d$ is a regular sequence, and
each $R/(x_1,\ldots,x_c)$ is a regular local ring
of dimension $d - c$. In particular $R$ is Cohen-Macaulay.
\end{lemma}

\begin{proof}
Note that $R/x_1R$ is a Noetherian local ring of dimension $\geq d - 1$
by Lemma \ref{lemma-one-equation} with $x_2,\ldots,x_d$
generating the maximal ideal. Hence it is regular by definition.
Since $R$ is a domain by Lemma \ref{lemma-regular-domain}
$x_1$ is a nonzero divisor.
\end{proof}

\begin{lemma}
\label{lemma-free-mod-x}
Let $R$ be a Noetherian local ring.
Let $x \in \mathfrak m$ be a nonzero divisor.
Let $M$ be a finite $R$-module such that 
$M/xM$ is free over $R/xR$.
Then $M$ is free over $R$.
\end{lemma}

\begin{proof}
Let $m_1,\ldots,m_r$ be elements of $M$ which map to
a $R/xR$-basis of $M/xM$. By Nakayama's Lemma \ref{lemma-NAK}
$m_1,\ldots,m_r$ generate $M$. If $\sum a_i m_i = 0$
is a relation, then $a_i \in xR$ for all $i$. Hence
$a_i = b_i x$ for some $b_i \in R$. Hence
the kernel $K$ of $R^r \to M$ satisfies $xK = K$
and hence is zero by Nakayama's lemma.
\end{proof}

\begin{lemma}
\label{lemma-regular-mcm-free}
Let $R$ be a local Noetherian regular ring.
Any maximal Cohen-Macaulay module over $R$ is
free.
\end{lemma}

\begin{proof}
Let $M$ be a maximal Cohen-Macaulay module over $R$.
Let $x \in \mathfrak m$ be part of a regular sequence
generating $\mathfrak m$. Then $x$ is a nonzero divisor
on $M$ by Proposition \ref{proposition-CM-module}, and
$M/xM$ is a maximal Cohen-Macaulay module over $R/xR$.
By induction on $\dim(R)$ we see that $M/xM$ is free.
We win by Lemma \ref{lemma-free-mod-x}.
\end{proof}








\section{Finite projective modules}
\label{section-finite-projective-modules}

\begin{definition}
\label{definition-locally-free}
Let $R$ be a ring and $M$ an $R$-module.
We say that $M$ is {\it locally free} if 
we can cover $\text{Spec}(R)$ by standard
opens $D(f_i)$, $i \in I$ such that $M_{f_i}$
is a free $R_{f_i}$-module for all $i \in I$.
We say that $M$ is {\it finite locally free} if
each $M_{f_i}$ is finite free.
\end{definition}

\noindent
Note that a finite locally free $R$-module is
automatically finitely presented by Lemma \ref{lemma-cover}.

\begin{lemma}
\label{lemma-finite-projective}
Let $R$ be a ring and let $M$ be an $R$-module.
The following are equivalent
\begin{enumerate}
\item $M$ is finitely presented and $R$-flat,
\item $M$ is finite projective,
\item $M$ is a direct summand of a finite free $R$-module,
\item $M$ is finitely presented and
for all $\mathfrak p \in \text{Spec}(R)$ the
localization $M_{\mathfrak p}$ is free,
\item $M$ is finitely presented and
for all maximal ideals $\mathfrak m \subset R$ the
localization $M_{\mathfrak m}$ is free,
\item $M$ is finite and locally free, and
\item $M$ is finite locally free.
\end{enumerate}
\end{lemma}

\begin{proof}
FIXME.
\end{proof}

\begin{remark}
\label{remark-warning}
It is not true that a finite $R$-module which is
$R$-flat is automatically projective. A counter
example is where $R = \mathcal{C}^\infty(\mathbf{R})$
is the ring of infinitely differentiable functions on
$\mathbf{R}$, and $M = R_{\mathfrak m} = R/I$ where
$\mathfrak m = \{f \in R \mid f(0) = 0\}$ and
$I = \{f \in R \mid \exists \epsilon, \epsilon > 0 :
f(x) = 0\ \forall x, |x| < \epsilon\}$.
\end{remark}

\begin{lemma}
\label{lemma-finite-flat-local}
(Warning: see Remark \ref{remark-warning} above.)
Suppose $R$ is a local ring, and $M$ is a finite
flat $R$-module. Then $M$ is finite free.
\end{lemma}

\begin{proof}
Follows from the equational criterion of flatness, see
Lemma \ref{lemma-flat-eq}. Namely, suppose that 
$x_1,\ldots, x_r \in M$ map to a basis of
$M/\mathfrak mM$. By Nakayama's Lemma \ref{lemma-NAK}
these elements generate $M$. We want to show there
is no relation among the $x_i$. In stead, we will show
by induction on $n$ that if $x_1,\ldots,x_n \in M$
are linearly independent in the vector space
$M/\mathfrak mM$ then they are independent over $R$.

\medskip\noindent
The base case of the induction is where we have
$x \in M$, $x \not\in \mathfrak mM$ and a relation
$fx = 0$. By the equational criterion there
exist $y_j \in M$ and $a_j \in R$ such that
$x = \sum a_j y_j$ and $fa_j = 0$ for all $j$.
Since $x \not\in \mathfrak mM$ we see that
at least one $a_j$ is a unit and hence $f = 0 $.

\medskip\noindent
Suppose that $\sum f_i x_i$ is a relation among $x_1,\ldots,x_n$.
By our choice of $x_i$ we have $f_i \in \mathfrak m$.
According to the equational criterion of flatness there exist
$a_{ij} \in R$ and $y_j \in M$ such that
$x_i = \sum a_{ij} y_j$ and $\sum f_i a_{ij} = 0$.
Since $x_n \not \in \mathfrak mM$ we see that
$a_{nj}\not\in \mathfrak m$ for at least one $j$.
Since $\sum f_i a_{ij} = 0$ we get
$f_n = \sum_{i=1}^{n-1} (-a_{ij}/a_{nj}) f_i$.
The relation $\sum f_i x_i = 0$ now can be rewritten
as $\sum_{i=1}^{n-1} f_i( x_i + (-a_{ij}/a_{nj}) x_n) = 0$.
Note that the elements $x_i + (-a_{ij}/a_{nj}) x_n$ map
to $n-1$ linearly independent elements of $M/\mathfrak mM$.
By induction assumption we get that all the $f_i$, $i \leq n-1$
have to be zero, and also $f_n = \sum_{i=1}^{n-1} (-a_{ij}/a_{nj}) f_i$.
This proves the induction step.
\end{proof}

\begin{lemma}
\label{lemma-cokernel-flat}
Let $R$ be a ring. Let $\varphi : P_1 \to P_2$ be a map of
finite projective modules. Then
\begin{enumerate}
\item The set $U$ of primes
$\mathfrak p \in \text{Spec}(R)$ such that
$\varphi \otimes \kappa(\mathfrak p)$ is injective is open.
\item For any $f\in R$ such that
$D(f) \subset U$ the module $\text{Coker}(\varphi)_f$
is finite projective over $R_f$.
\item The set $V$ of primes $\mathfrak p \in \text{Spec}(R)$ such that
$\varphi \otimes \kappa(\mathfrak p)$ is an isomorphism
is open.
\item For any $f\in R$ such that
$D(f) \subset V$ the map $\varphi: P_{1,f} \to P_{2,f}$
is an isomorphism of modules over $R_f$.
\end{enumerate}
\end{lemma}

\begin{proof}
To prove the sets $U$ and $V$ are open we may work locally on
$\text{Spec}(R)$. Thus we may replace $R$ by a suitable localization
and assume that $P_1 = R^{n_1}$ and $P_2=R^{n_2}$, see Lemma
\ref{lemma-finite-projective}. In this case injectivity of
$\varphi \otimes \kappa(\mathfrak p)$ is equivalent to
some $n_1 \times n_1$ minor $f$ of the matrix of $\varphi$ being
invertible in $\kappa(\mathfrak p)$. Thus $D(f) \subset U$.
Similarly for $V$, but in that case with the added assumption
that $m = n$ (and hence $f$ is just the determinant of the map).

\medskip\noindent
Now suppose $D(f) \subset U$. By Lemma \ref{lemma-finite-projective}
it suffices to prove that $\text{Coker}(\varphi)$ is finite projective
locally on $D(f)$. Thus, as we saw above, we may
assume that $P_1 = R^{n_1}$ and $P_2=R^{n_2}$
and that some minor of the matrix of $\varphi$ is invertible in $R$.
If the minor in question corresponds to the first $n_1$
basis vectors of $R^{n_2}$, then using the last $n_2-n_1$ basis
vectors we get a map $R^{n_2 - n_1} \to
R^{n_2} \to \text{Coker}(\varphi)$ which is easily seen to be
an isomorphism. If $D(f) \subset V$ the argument is even easier.
\end{proof}












\section{Rings of finite global dimension}
\label{section-ring-finite-gl-dim}

\noindent
The following lemma is often used to compare different
projective resolutions of a given module.

\begin{lemma}
\label{lemma-Schanuel}
(Schanuel's lemma.)
Let $R$ be a ring. Let $M$ be an $R$-module.
Suppose that $0 \to K \to P_1 \to M \to 0$
and $0 \to L \to P_2 \to M \to 0$ are two short exact
sequences, with $P_i$ projective.
Then $K \oplus P_2 \cong L \oplus P_1$.
\end{lemma}

\begin{proof}
Consider the module
$N$ defined by the short exaxt sequence
$0 \to N \to P_1 \oplus P_2 \to M \to 0$,
where the last map is the sum of the two maps
$P_i \to M$. It is easy to see that the projection
$N \to P_1$ is surjective with kernel $L$, and that
$N \to P_2$ is surjective with kernel $K$.
Since $P_i$ are projective we have $N \cong K \oplus P_2
\cong L \oplus P_1$.
\end{proof}

\begin{definition}
\label{definition-finite-proj-dim}
Let $R$ be a Noetherian ring.
A finite module $M$ over $R$ is said to have {\it finite
projective dimension} if it has a finite length resolution by finite
projective $R$-modules. The minimal length of such a
finite projective resolution is called the {\it projective
dimension} of $M$.
\end{definition}

\noindent
The following lemma explains to what extend the projective
dimension is independent of the choice of a finite projective
resolution.

\begin{lemma}
\label{lemma-independent-resolution}
Let $R$ be a Noetherian ring.
Suppose that $M$ is a finite $R$-module
of projective dimension $d$.
Suppose that $F_e \to F_{e-1} \to \ldots \to F_0 \to M \to 0$
is exact with $F_i$ finite projective and $e \geq d - 1$.
Then the kernel of $F_e \to F_{e-1}$ is finite projective
(or the kernel of $F_0 \to M$ is finite projective in case
$e = 0$).
\end{lemma}

\begin{proof}
We prove this by induction on $d$. If $d = 0$, then
$M$ is projective. In this case there is a splitting
$F_0 = \text{Ker}(F_0 \to M) \oplus M$, and hence
$\text{Ker}(F_0 \to M)$ is finite projective. This finishes
the proof if $e = 0$, and if $e > 0$, then replacing
$M$ by $\text{Ker}(F_0 \to M)$ we decrease $e$.

\medskip\noindent
Next assume $d > 0$.
Let $0 \to P_d \to P_{d-1} \to \ldots \to P_0 \to M \to 0$
be a minimal length finite resolution with $P_i$ finite projective. 
According to Schanuel's Lemma \ref{lemma-Schanuel} we have
$P_0 \oplus \text{Ker}(F_0 \to M) \cong F_0 \oplus \text{Ker}(P_0 \to M)$.
This proves the case $d = 1$, $e = 0$, because then the right
hand side is $F_0 \oplus P_1$ which is projective. Hence now we may
assume $e > 0$. The module
$F_0 \oplus \text{Ker}(P_0 \to M)$ has the finite projective resolution
$0 \to P_d \oplus F_0 \to P_{d-1} \oplus F_0 \to \ldots \to P_1 \oplus F_0
\to \text{Ker}(P_0 \to M) \oplus F_0 \to 0$ of length $d - 1$.
By induction on $d$ we see that the kernel of
$F_{e} \oplus P_0 \to F_{e-1} \oplus P_0$ is finite projective.
This implies the lemma.
\end{proof}

\begin{definition}
\label{definition-finite-gl-dim}
Let $R$ be a Noetherian ring. The ring
$R$ is said to have {\it finite global dimension}
if there exists an integer $n$ such that
every finite $R$-module has a resolution by finite
projective $R$-modules of length at most $n$.
The minimal such $n$ is then called the {\it global dimension}
of $R$.
\end{definition}

\begin{proposition}
\label{proposition-regular-finite-gl-dim}
Let $R$ be a regular local ring of dimension $d$.
Every finite $R$-module $M$ of depth $e$ has a finite free
resolution
$$
0 \to F_{d-e} \to \ldots \to F_0 \to M \to 0.
$$
In particular a regular local ring has global dimension $\leq d$.
\end{proposition}

\begin{proof}
This is clear in view of Lemma \ref{lemma-regular-mcm-free}
and Lemma \ref{lemma-mcm-resolution}.
\end{proof}

\begin{lemma}
\label{lemma-localize-finite-gl-dim}
If $R$ is a Noetherian ring which has finite global dimension,
then any localization of $R$ has finite global dimension
at most the global dimension of $R$.
\end{lemma}

\begin{proof}
Let $S \subset R$ be a multiplicative subset.
Let $M'$ be a finite $S^{-1}R$-module. 
Because $S^{-1}R$ is Noetherian $M'$ is finitely presented.
Say $M'$ is the cokernel of $A : (S^{-1}R)^m
\to (S^{-1}R)^n$. There exists an element $s$ of $S$ such
that $sA$ is the image of a matrix $B$ with coefficients in $R$.
Thus we see that $M = \text{Coker}(B : R^m \to R^n)$
is a finite $R$-module such that $M' = S^{-1}M$.
Since localization is an exact functor, the fact that
$M$ has a finite length resolution by finite projective
modules implies the same for $M'$.
\end{proof}

\begin{lemma}
\label{lemma-finite-gl-dim-primes}
Let $R$ be a Noetherian ring.
Then $R$ has finite global dimension if and
only if there exists an integer $n$ such that
for all maximal ideals $\mathfrak m$ of $R$
the ring $R_{\mathfrak m}$ has global dimension
$\leq n$.
\end{lemma}

\begin{proof}
We saw, Lemma \ref{lemma-localize-finite-gl-dim}
that if $R$ has finite global dimension $n$,
then all the localizations $R_{\mathfrak m}$
have finite global dimension at most $n$.
Conversely, suppose that all the $R_{\mathfrak m}$
have global dimension $n$. Let $M$ be a finite
$R$-module. Let
$0 \to K_n \to F_{n-1} \to \ldots \to F_0 \to M\to 0$.
be a resolution with $F_i$ finite projective.
According to Lemma \ref{lemma-independent-resolution}
and the assumption all the modules $K_n \otimes_R R_{\mathfrak m}$
are finite free. Hence by Lemma \ref{lemma-finite-projective}
the module $K_n$ is finite projective.
\end{proof}

\begin{lemma}
\label{lemma-length-resolution-residue-field}
Suppose that $R$ is a Noetherian local ring
with maximal ideal $\mathfrak m$ and
residue field $\kappa$. In this case
the projective dimension of $\kappa$ is
$\geq \dim_\kappa \mathfrak m / \mathfrak m^2$.
\end{lemma}

\begin{proof}
Let $x_1 , \ldots x_n$ be elements of $\mathfrak m$
whose images in $\mathfrak m / \mathfrak m^2$ form a basis.
Consider the {\it Koszul complex} on $x_1,\ldots,x_n$.
This is the complex
$$
0 \to \wedge^n R^n \to \wedge^{n-1} R^n \to \wedge^{n-2} R^n \to
\ldots \to \wedge^i R^n \to \ldots \to R^n \to R
$$
with maps given by
$$
e_{j_1} \wedge \ldots \wedge e_{j_i}
\longmapsto
\sum_{a = 1}^i x_{j_a} e_{j_1} \wedge \ldots
\wedge \hat e_{j_a} \wedge \ldots \wedge e_{j_i}
$$
It is easy to see that this is a complex $K_{\bullet}(R, x_{\bullet})$.
Note that the cokernel of the last map of $K_{\bullet}(R, x_{\bullet})$
is clearly $\kappa$.

\medskip\noindent
Now, let $F_{\bullet} \to \kappa$ by any finite resolution by
finite free $R$-modules. By Lemma \ref{lemma-add-trivial-complex} 
we may assume all the maps in the complex $F_{\bullet}$
have to property that $\text{Im}(F_i \to F_{i-1})
\subset \mathfrak m F_{i-1}$, because removing a trivial
summand from the resolution can at worst shorten the resolution.
By Lemma \ref{lemma-compare-resolutions} we can find a map
of complexes $\alpha : K_{\bullet}(R, x_{\bullet}) \to F_{\bullet}$
inducing the identity on $\kappa$. We will prove by induction
that the maps $\alpha_i : \wedge^i R^n = K_i(R, x_{\bullet}) \to F_i$
have the property that $\alpha_i \otimes \kappa
: \wedge^i \kappa^n \to F_i \otimes \kappa$ are injective.
This will prove the lemma since it clearly shows that
$F_n \not = 0$.

\medskip\noindent
The result is clear for $i = 0$ because the composition
$R \xrightarrow{\alpha_0} F_0 \to \kappa$ is nonzero.
Note that $F_0$ must have rank $1$ since
otherwise the map $F_1 \to F_0$ whose cokernel is a single
copy of $\kappa$ cannot have image contained in $\mathfrak m F_0$.
For $\alpha_1$ we use that $x_1,\ldots,x_n$ is a minimal
set of generators for $\mathfrak m$. Namely, we saw above that
$F_0 = R$ and $F_1 \to F_0 = R$ has image $\mathfrak m$.
We have a commutative diagram
$$
\begin{matrix}
R^n & = & K_1(R, x_{\bullet}) & \to & K_0(R,x_{\bullet}) & = & R \\
& & \downarrow & & \downarrow & & \downarrow \\
& & F_1 & \to & F_0 & = & R
\end{matrix}
$$
where the rightmost vertical arrow is given by multiplication
by a unit. Hence we see that the image of the composition
$R^n \to F_1 \to F_0 = R$ is also equal to $\mathfrak m$.
Thus the map $R^n \otimes \kappa \to F_1 \otimes \kappa$
has to be injective since $\dim_\kappa (\mathfrak m / \mathfrak m^2) = n$.

\medskip\noindent
Suppose the injectivity of $\alpha_j \otimes \kappa$ has been
proved for all $j \leq i - 1$. Consider the commutative diagram
$$
\begin{matrix}
\wedge^i R^n & = & K_i(R, x_{\bullet}) & \to & K_{i-1}(R,x_{\bullet})
& = & \wedge^{i-1} R^n \\
& & \downarrow & & \downarrow & & \\
& & F_i & \to & F_{i-1} & &
\end{matrix}
$$
We know that $\wedge^{i-1} \kappa^n \to F_{i-1} \otimes \kappa$
is injective. This proves that
$\wedge^{i-1} \kappa^n \otimes_{\kappa} \mathfrak m/\mathfrak m^2
\to F_{i-1} \otimes \mathfrak m/\mathfrak m^2$ is injective.
Also, by our choice of the complex, $F_i$ maps into
$\mathfrak mF_{i-1}$, and similarly for the Koszul complex.
Hence we get a commutative diagram
$$
\begin{matrix}
\wedge^i \kappa^n & \to &
\wedge^{i-1} \kappa^n \otimes \mathfrak m/\mathfrak m^n \\
\downarrow & & \downarrow \\
F_i \otimes \kappa & \to & F_{i-1}\otimes \mathfrak m/\mathfrak m^2
\end{matrix}
$$
At this point it suffices to verify the map
$\wedge^i \kappa^n \to 
\wedge^{i-1} \kappa^n \otimes \mathfrak m/\mathfrak m^n$
is injective, which can be done by hand.
\end{proof}

\begin{lemma}
\label{lemma-dim-gl-dim}
Let $R$ be a Noetherian local ring.
Suppose that the residue field $\kappa$ has finite
projective dimension $n$ over $R$.
In this case $\dim(R) \geq n$.
\end{lemma}

\begin{proof}
Let $F_{\bullet}$ be a finite resolution of $\kappa$ by finite free
$R$-modules. By Lemma \ref{lemma-add-trivial-complex} 
we may assume all the maps in the complex $F_{\bullet}$
have to property that $\text{Im}(F_i \to F_{i-1})
\subset \mathfrak m F_{i-1}$, because removing a trivial
summand from the resolution can at worst shorten the resolution.
Say $F_n \not = 0$ and $F_i = 0$ for $i > n$, so that
the projective dimension of $\kappa$ is $n$.
By Proposition \ref{proposition-what-exact} we see that
$\text{depth}(I(\varphi_n)) \geq n$ since $I(\varphi_n)$
cannot equal $R$ by our choice of the complex.
Thus by Lemma \ref{lemma-bound-depth} also $\dim(R) \geq n$.
\end{proof}

\begin{proposition}
\label{proposition-finite-gl-dim-regular}
A Noetherian local ring whose residue field
has finite projective dimension is regular.
In particular a Noetherian local ring of
finite global dimension is regular.
\end{proposition}

\begin{proof}
By Lemmas \ref{lemma-length-resolution-residue-field}
and \ref{lemma-dim-gl-dim} we see that
$\dim(R) \geq \dim_\kappa(\mathfrak m /\mathfrak m^2)$. 
Thus the result follows immediately from Definition
\ref{definition-regular-local}.
\end{proof}

\noindent
In particular, by the proposition and
Proposition \ref{proposition-regular-finite-gl-dim}
we see that
a Noetherian local ring is regular if and only if
it has finite global dimension. Furthermore, any localization
$R_{\mathfrak p}$ has finite global dimension,
see Lemma \ref{lemma-localize-finite-gl-dim},
and hence is regular. Thus it now
makes sense to make the following definition,
because it does not conclict with the earlier
definition of a regular local ring.

\begin{definition}
\label{definition-regular}
A Noetherian ring $R$ is said to be {\it regular}
if all the localizations $R_{\mathfrak p}$ are
regular local rings.
\end{definition}

\noindent
Note that this is not the same as asking $R$ to have finite
global dimension, even assuming $R$ is Noetherian. This is
because there is an example of a regular Noetherian ring
which does not have finite global dimension, namely because
it does not have finite dimension.

\begin{lemma}
\label{lemma-finite-gl-dim-finite-dim-regular}
Let $R$ be a Noetherian ring.
The following are equivalent:
\begin{enumerate}
\item $R$ has finite global dimension $n$,
\item there exists an integer $n$ such that
all the localizations $R_{\mathfrak m}$ at maximal ideals
are regular of dimension $\leq n$ with equality for at least
one $\mathfrak m$, and
\item there exists an integer $n$ such that
all the localizations $R_{\mathfrak p}$ at prime ideals
are regular of dimension $\leq n$ with equality for at least
one $\mathfrak p$.
\end{enumerate}
\end{lemma}

\begin{proof}
This is a reformulation of Lemma \ref{lemma-finite-gl-dim-primes}
in view of the discussion surrouding Definition \ref{definition-regular}.
See especially Propositions
\ref{proposition-regular-finite-gl-dim} and
\ref{proposition-finite-gl-dim-regular}.
\end{proof}










\section{Homomorphisms and dimension}
\label{section-homomorphism-dimension}

\noindent
This section contains a collection of easy results relating
dimensions of rings when there are maps between them.

\begin{lemma}
\label{lemma-dimension-going-up}
Suppose $R \to S$ is a ring map satisfying either going up, see
Defintion \ref{definition-going-up-down}, or going down
see Definition \ref{definition-going-up-down}.
Assume in addition that $\text{Spec}(S) \to \text{Spec}(R)$
is surjective. Then $\dim(R) \leq \dim(S)$.
\end{lemma}

\begin{proof}
Assume going up.
Take any chain $\mathfrak p_0 \subset \mathfrak p_1 \subset \ldots
\subset \mathfrak p_e$ of prime ideals in $R$.
By surjectivity we may choose a prime $\mathfrak q_0$ mapping
to $\mathfrak p_0$. By going up we may extend this to a chain
of length $e$ of primes $\mathfrak q_i$ lying over
$\mathfrak p_i$. Thus $\dim(S) \geq \dim(R)$.
The case of going down is exactly the same.
\end{proof}

\begin{lemma}
\label{lemma-going-up-maximal-on-top}
Suppose that $R \to S$ is a ring map with the going up property,
see Definition \ref{definition-going-up-down}. If
$\mathfrak q \subset S$ is a maximal ideal.
then the inverse image of $\mathfrak q$ in $R$
is a maximal ideal too.
\end{lemma}

\begin{proof}
Trivial.
\end{proof}

\begin{lemma}
\label{lemma-integral-dim-up}
Suppose that $R \to S$ is a ring map such that $S$ is integral over $R$.
Then $\dim (R) \geq \dim(S)$, and every closed point of $\text{Spec}(S)$
maps to a closed point of $\text{Spec}(R)$.
\end{lemma}

\begin{proof}
Immediate from Lemmas \ref{lemma-integral-no-inclusion} and
\ref{lemma-going-up-maximal-on-top}
and the definitions.
\end{proof}

\begin{lemma}
\label{lemma-integral-sub-dim-equal}
Suppose $R \subset S$ and $S$ integral over $R$.
Then $\dim(R) = \dim(S)$.
\end{lemma}

\begin{proof}
This is a combination of Lemmas
\ref{lemma-integral-going-up},
\ref{lemma-integral-overring-surjective},
\ref{lemma-dimension-going-up}, and
\ref{lemma-integral-dim-up}.
\end{proof}

\begin{definition}
\label{definition-fibre}
Suppose that $R \to S$ is a ring map.
Let $\mathfrak q \subset S$ be a prime lying
over the prime $\mathfrak p$ of $R$.
The {\it local ring of the fibre at $\mathfrak q$}
is the local ring
$$
S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}
=
(S/\mathfrak pS)_{\mathfrak q}
=
(S\otimes_R \kappa(\mathfrak p))_{\mathfrak q}
$$
\end{definition}

\begin{lemma}
\label{lemma-dimension-base-fibre-total}
Let $R \to S$ be a homomorphism of Noetherian rings.
Let $\mathfrak q \subset S$ be a prime lying
over the prime $\mathfrak p$. Then
$$
\dim(S_{\mathfrak q})
\leq
\dim(R_{\mathfrak p})
+
\dim(S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}).
$$
\end{lemma}

\begin{proof}
We use the characterization of dimension from
Proposition \ref{proposition-dimension}.
Let $x_1,\ldots,x_d$ be elements of $\mathfrak p$ 
generating an ideal of definition of $R_{\mathfrak p}$ with
$d = \dim(R_{\mathfrak p})$.
Let $y_1,\ldots,y_e$ be elements of $\mathfrak q$
generating an ideal of definition of
$S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}$
with $e = \dim(S_{\mathfrak q}/\mathfrak pS_{\mathfrak q})$.
It is clear that $S_{\mathfrak q}/(x_1,\ldots,x_d,y_1,\ldots,y_e)$
has a nilpotent maximal ideal. Hence
$x_1,\ldots,x_d,y_1,\ldots,y_e$ generate an ideal of definition
if $S_{\mathfrak q}$.
\end{proof}

\begin{lemma}
\label{lemma-dimension-base-fibre-equals-total}
Let $R \to S$ be a homomorphism of Noetherian rings.
Let $\mathfrak q \subset S$ be a prime lying
over the prime $\mathfrak p$. Assume the going down property holds
for $R \to S$ (for example if $R \to S$ is flat, see
Lemma \ref{lemma-flat-going-down}). Then
$$
\dim(S_{\mathfrak q})
=
\dim(R_{\mathfrak p})
+
\dim(S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}).
$$
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-dimension-base-fibre-total}
we have an inequality
$\dim(S_{\mathfrak q}) \leq
\dim(R_{\mathfrak p}) + \dim(S_{\mathfrak q}/\mathfrak pS_{\mathfrak q})$.
To get equality, choose a chain of primes
$\mathfrak pS \subset \mathfrak q_0 \subset \mathfrak q_1 \subset \ldots
\subset \mathfrak q_d = \mathfrak q$ with
$d = \dim(S_{\mathfrak q}/\mathfrak pS_{\mathfrak q})$.
On the other hand, choose a chain of primes
$\mathfrak p_0 \subset \mathfrak p_1 \subset \ldots \subset \mathfrak p_e
= \mathfrak p$ with $e = \dim(S_{\mathfrak p})$.
By the going down theorem we may choose
$\mathfrak q_{-1} \subset \mathfrak q_0$ lying over
$\mathfrak p_{e-1}$. And then we may choose
$\mathfrak q_{-2} \subset \mathfrak q_{e-1}$ lying over
$\mathfrak p_{e-2}$. Inductively we keep going until we
get a chain 
$\mathfrak q_{-e} \subset \ldots \subset \mathfrak q_d$
of length $e+d$. 
\end{proof}











\section{Dimension of finite type algebras over fields}
\label{section}

\begin{lemma}
\label{lemma-nrgens-affine-space}
Let $\mathfrak m$ be a maximal ideal in $k[x_1,\ldots,x_n]$.
The ideal $\mathfrak m$ is generated by $n$ elements.
\end{lemma}

\begin{proof}
By the Hilbert Nullstellensatz \ref{theorem-nullstellensatz},
we know the residue field $\kappa = \kappa(\mathfrak m)$ is
a finite extension of $k$. Denote $\alpha_i \in \kappa$ the
image of $x_i$. Denote $\kappa_i = k(\alpha_1,\ldots,\alpha_i)
\subset \kappa$, $i=1,\ldots, n$ and $\kappa_0 = k$.
Note that $\kappa_i = k[\alpha_1,\ldots,\alpha_i]$
by field theory. Define inductively elements
$f_i \in \mathfrak m \cap k[x_1,\ldots,x_i]$
as follows: Let $P_i(T) \in \kappa_{i-1}[T]$
be the monic minimal polynomial of $\alpha_i $ over $\kappa_{i-1}$.
Let $Q_i(T) \in k[x_1,\ldots,x_{i-1}][T]$ be a monic lift of $P_i(T)$
(of the same degree). Set $f_i = Q_i(x_i)$. 
Note that if $d_i = \deg_T(P_i) = \deg_T(Q_i) = \deg_{x_i}(f_i)$
then $d_1d_2\ldots d_n = [\kappa : k]$ by elementary field theory.

\medskip\noindent
We claim that there is an isomorphism
$k[x_1, \ldots, x_n] /(f_1, \ldots, f_n) \to \kappa$.
First of all, by construction we have $f_i \in \mathfrak m$
which gives us the map. Also, via this map, the ring
$k[x_1,\ldots,x_i]/(f_1, \ldots, f_i)$
maps onto $\kappa_i$. We will prove by induction that
$k[x_1,\ldots,x_i]/(f_1, \ldots, f_i) \to \kappa_i$
is an isomorphism, i.e., injective. Namely, the ring extension
$k[x_1,\ldots,x_i]/(f_1, \ldots, f_i) \to 
k[x_1,\ldots,x_{i+1}]/(f_1, \ldots, f_{i+1})$
is generated by $1$ element over a field and one
irreducible equation. By elementrary field theory
$k[x_1,\ldots,x_{i+1}]/(f_1, \ldots, f_{i+1})$
is a field.
\end{proof}

\begin{lemma}
\label{lemma-dim-affine-space}
Let $\mathfrak m$ be a maximal ideal in $k[x_1,\ldots,x_n]$.
The local ring $k[x_1,\ldots,x_n]_{\mathfrak m}$ has dimension
$n$.
\end{lemma}

\begin{proof}
Since the maximal ideal can be generated by (at most) $n$ elements
(Lemma \ref{lemma-nrgens-affine-space})
the local ring
has dimension at most $n$, by Proposition \ref{proposition-dimension}.
Denote the residue field of $\mathfrak m$ by $\kappa$ and
the images of $x_1,\ldots, x_n$ by $\alpha_1, \ldots,
\alpha_n$.

\medskip\noindent
If the residue field $\kappa$ of $\mathfrak m$ is $k$, then
$\mathfrak m = (x_1 - \alpha_1, \ldots, x_n - \alpha_n)$
and it is easy to see that $\mathfrak q_0 = (0) \subset
\mathfrak q_1 = (x_1 - \alpha_1)
\subset 
\mathfrak q_2 = (x_1 - \alpha_1, x_2 - \alpha_2) \subset
\ldots \subset 
\mathfrak q_n = (x_1 - \alpha_1, \ldots, x_n - \alpha_n)$
clearly is a chain of length $n$.

\medskip\noindent
In general, consider the finite ring extension
$k[x_1,\ldots, x_n] \to \kappa[x_1,\ldots,x_n]$,
and let $\mathfrak m' = (x_1 - \alpha_1, \ldots, x_n - \alpha_n)$.
Note that by construction $\mathfrak m'$ maps to
$\mathfrak m$ under the induced map of spectra.
By Lemma \ref{lemma-integral-no-inclusion} the images of the
$\mathfrak q_i$ are all distinct and hence provide
a chain of primes of length $n$ in $k[x_1,\ldots,x_n]_{\mathfrak m}$.
\end{proof}

\begin{proposition}
\label{proposition-finite-gl-dim-polynomial-ring}
A polynomial algebra in $n$ variables over a field is a regular ring.
It has global dimension $n$. All localizations at maximal ideals
are regular local rings of dimension $n$.
\end{proposition}

\begin{proof}
The combination of Lemmas \ref{lemma-nrgens-affine-space}
and \ref{lemma-nrgens-affine-space} above shows that
all localizations $k[x_1,\ldots,x_n]_{\mathfrak m}$
at maximal ideals are regular local rings of dimension $n$. Hence
we conclude by Lemma \ref{lemma-finite-gl-dim-finite-dim-regular}.
\end{proof}

\begin{lemma}
\label{lemma-one-relation}
Let $k$ be a field.
Let $S = k[x_1,\ldots,x_n]/I$ for some ideal $I$.
If $I \not= 0$, then there exist $y_1,\ldots,y_{n-1} \in k[x_1,\ldots,x_n]$
such that $S$ is finite over $k[y_1,\ldots,y_{n-1}]$. Moreover we may
choose $y_i$ to be in the $\mathbf{Z}$-subalgebra of $k[x_1,\ldots,x_n]$
generated by $x_1,\ldots,x_n$.
\end{lemma}

\begin{proof}
Pick $f \in I$, $f\not = 0$. It suffices to show the lemma
for $k[x_1,\ldots,x_n]/(f)$ since $S$ is a quotient of that ring.
We will take $y_i = x_i - x_n^{e_i}$, $i = 1,\ldots,n-1$
for suitable integers $e_i$. When does this work? It suffices
to show that $\overline{x_n} \in k[x_1,\ldots,x_n]/(f)$
is integral over the ring $k[y_1,\ldots,y_{n-1}]$. The
equation for $\overline{x_n}$ over this ring is
$$
f(y_1 + x_n^{e_1}, \ldots, y_{n-1} + x_n^{e_{n-1}}, x_n) = 0.
$$
Hence we are done if we can show there exists integers $e_i$ such
that the leading coefficient w.r.t.\ $x_n$ of the equation
above is an element of $k$. Consider a monomial
$x^\nu = x_1^{\nu_1} \ldots x_n^{\nu_n}$ occuring with
nonzero coefficient in $f$. The leading term in
$$
(y_1 + x_n^{e_1})^{\nu_1} \ldots (y_{n-1} + x_n^{e_{n-1}})^{\nu_{n-1}}
x_n^{\nu_n}
\text{\ \ is\ \ }x_n^{e_1\nu_1 + \ldots + e_{n-1}\nu_{n-1} + \nu_n}.
$$
Thus it suffices to choose $e_1,\ldots,e_{n-1}$ such that
the integers $e_1\nu_1 + \ldots + e_{n-1}\nu_{n-1} + \nu_n$
for $x^\nu$ occuring in $f$ are all pairwise distinct.
This can be achieved for example by choosing $e_1 \gg
e_2 \gg \ldots \gg e_{n-1}$.
\end{proof}

\begin{lemma}
\label{lemma-Noether-normalization}
Let $k$ be a field. Let $S = k[x_1,\ldots,x_n]/I$ for some ideal $I$.
There exist $r\geq 0$, and $y_1,\ldots,y_r \in k[x_1,\ldots,x_n]$
such that (a) the map $k[y_1,\ldots,y_r] \to S$ is injective,
and (b) the map $k[y_1,\ldots,y_r] \to S$ is finite.
In this case the integer $r$ is the dimension of $S$.
Moreover we may choose $y_i$ to be in the
$\mathbf{Z}$-subalgebra of $k[x_1,\ldots,x_n]$
generated by $x_1,\ldots,x_n$.
\end{lemma}

\begin{proof}
By induction on $n$, with $n = 0$ being trivial.
If $I = 0$, then take $r = n$ and $y_i = x_i$.
If $I \not = 0$, then choose $y_1,\ldots, y_{n-1}$
as in Lemma \ref{lemma-one-relation}. Let
$S' \subset S$ be the subring generated by
the images of the $y_i$. By induction we can
choose $r$ and $z_1,\ldots, z_r \in k[y_1,\ldots,y_{n-1}]$
such that (a), (b) hold for $k[z_1,\ldots,z_r]
\to S'$. Since $S' \to S$ is injective and finite
we see (a), (b) hold for $k[z_1,\ldots,z_r]
\to S$. The last assertion follows from Lemma
\ref{lemma-integral-sub-dim-equal}.
\end{proof}

\begin{lemma}
\label{lemma-dimension-prime-polynomial-ring}
Let $k$ be a field. Let $\mathfrak p \subset k[x_1,\ldots,x_n]$
be a prime ideal. Let $S = k[x_1,\ldots,x_n]/\mathfrak p$.
Let $r = \text{trdeg}(\kappa(\mathfrak p)/k)$ be the transcendence
degree of the field of fractions of $S$ over $k$. Then
\begin{enumerate}
\item $\dim(S) = r$,
\item any maximal chain of primes in $S$ has length $r$,
\item $\dim(k[x_1,\ldots,x_n]_{\mathfrak p}) = n - r$,
\item for any maximal ideal $\mathfrak m \subset S$
we have $\dim(S_{\mathfrak m}) = r$,
\item for any prime ideal $\mathfrak q \subset S$ we
have $\dim(S_{\mathfrak q}) + \dim(S/\mathfrak q) = r$,
and all maximal chains of primes in $S/\mathfrak q$
(resp.\ $S_{\mathfrak q}$) have the same length.
\item if $\mathfrak p \subset \mathfrak q \subset k[x_1,\ldots,x_n]$
is another prime, then every maximal chain of primes 
$\mathfrak p = \mathfrak p_0 \subset \mathfrak p_1 \subset \ldots
\subset \mathfrak p_e = \mathfrak q$
between $\mathfrak p$ and $\mathfrak q$ has length
$e = r - \text{trdeg}(\kappa(\mathfrak q))$.
\end{enumerate}
\end{lemma}

\begin{proof}
First pick $k[y_1,\ldots,y_{r'}] \subset S$
as in Lemma \ref{lemma-Noether-normalization}. By
Lemma \ref{lemma-integral-sub-dim-equal} we see
$r' = \dim (k[x_1,\ldots,x_n]/\mathfrak p)$, because the dimension
of $k[y_1,\ldots,y_{r'}]$ is $r'$
(by Proposition \ref{proposition-finite-gl-dim-polynomial-ring}).
On the other hand, the field extension $k(y_1,\ldots,y_{r'}) \subset
\kappa(\mathfrak p)$ is finite and hence algebraic and so $r' = r$.
At this point by Lemma \ref{lemma-integral-sub-dim-equal}
every maximal ideal $\mathfrak m \subset S$ maps to a
maximal ideal $\mathfrak m' \subset k[y_1,\ldots,y_{r'}]$
and then the same lemma again applied to the finite
ring map $k[y_1,\ldots,y_{r'}]_{\mathfrak m'} \subset S_{\mathfrak m}$
implies the dimension of $S_{\mathfrak m}$ is $r$. (This uses
Proposition \ref{proposition-finite-gl-dim-polynomial-ring} again.)

\medskip\noindent
Choose a maximal ideal $\mathfrak p \subset \mathfrak m$.
The ring $k[x_1,\ldots,x_n]_{\mathfrak m}$ is regular
of dimension $n$ (see Proposition
\ref{proposition-finite-gl-dim-polynomial-ring})
and hence Cohen-Macaulay of dimension $n$ by
Lemma \ref{lemma-regular-ring-CM}.
Thus by Lemma \ref{lemma-CM-dim-formula} we have 
$$
\dim(k[x_1,\ldots,x_n]_{\mathfrak p}) + 
\dim(
k[x_1,\ldots,x_n]_{\mathfrak m}/{\mathfrak p}k[x_1,\ldots,x_n]_{\mathfrak m}
)
= n.
$$
We proved above that the ring 
$k[x_1,\ldots,x_n]_{\mathfrak m}/{\mathfrak p}k[x_1,\ldots,x_n]_{\mathfrak m}$
which is the localization of $S$ at the maximal ideal $\mathfrak m/\mathfrak p$
has dimension $r$. This proves that
$\dim(k[x_1,\ldots,x_n]_{\mathfrak p}) = n - r$.

\medskip\noindent
At this point we have proven the assertion on the dimension of $S$,
and $S_{\mathfrak m}$ and on the dimension of
$k[x_1,\ldots,x_n]_{\mathfrak p}$. Also,
any maximal chain of primes in $k[x_1,\ldots,x_n]$ has length
$n$ because each localization $k[x_1,\ldots,x_n]$ at a maximal
ideal is Cohen-Macaulay of dimension $n$.
The combination of these results implies the other statements.

\medskip\noindent
For example, a maximal chain of primes in $S$, say of length $e$
really is a maximal
chain of primes between $\mathfrak p$ and a maximal ideal of
$k[x_1,\ldots,x_n]$. We may extend this to a maximal chain of
primes in $k[x_1,\ldots,x_n]$ by a maximal chain of primes between
$(0)$ and $\mathfrak p$ which has length $n-r$ by the above.
Then $e+n-r = n$ and we see $e= r$ as desired.

\medskip\noindent
Also, say $\mathfrak q \subset S$ is a prime. Take any maximal
chain of primes in $S/{\mathfrak q}$; this corresponds
to a maximal chain of primes in $S$ containing $\mathfrak q$,
say of length $a$. So $a \leq \dim(S/{\mathfrak q})$ and equality
holds for some choice of some chain.
Take a maximal chain of primes in
$S_{\mathfrak q}$; this corresponds to a maximal chain of primes
in $S$ contained in $\mathfrak q$, say of length $b$.
So $b \leq \dim(S_{\mathfrak q})$, and equality holds for some
choice of some chain.
We may combine these to form a corresponding maximal chain
of primes in $S$ of length $a + b$. By the above $a + b = r$
whenever you choose chains as above. Hence 
$\dim(S/{\mathfrak q}) + \dim(S_{\mathfrak q}) = r$
and equality holds for any choice of chains.

\medskip\noindent
The last statement is left to the reader.
\end{proof}


















\section{Quasi-finite maps and Zariski's main theorem}
\label{section-Zariski}

\noindent
Consider a ring map $R \to S$ of finite type.
A map $\text{Spec}(S) \to \text{Spec}(R)$ is quasi-finite
at a point if that point is isolated in its fibre.
This means that the fibre is zero dimensional at that point.
Our goal in this section is to show that the set
of points of $\text{Spec}(S)$ where the map is quasi-finite
is {\it open}. This is a somewhat tricky thing to prove and
we do it by a long list of lemmas concering integral and
finite extensions of rings. This material may be found
in \cite{Henselian}, and \cite{Peskine}. We also found notes
by Thierry Coquand helpful.

\begin{lemma}
\label{lemma-isolated-point}
Let $k$ be a field.
Let $S$ be a finite type $k$ algebra.
Let $\mathfrak q$ be a prime of $S$.
The following are equivalent:
\begin{enumerate}
\item $\mathfrak q$ is an isolated point of $\text{Spec}(S)$,
\item $S_{\mathfrak q}$ is finite over $k$, and
\item there exists a $g \in S$, $g \not\in \mathfrak q$ such that
$D(g) = \{ \mathfrak q \}$.
\end{enumerate}
In this case $S = S_{\mathfrak q} \times S'$ for some
finite type $k$-algebra $S'$. Also, the element $g$
as in (3) has the property $S_{\mathfrak q} = S_g$.
\end{lemma}

\begin{proof}
Suppose $\mathfrak q$ is an isolated point.
By Lemma \ref{lemma-disjoint-decomposition} we may
write $S = S_1 \times S_2$ with $\mathfrak q$ 
corresponding to the only point $\text{Spec}(S_1)$
Hence $S_1 = S_{\mathfrak q}$ is a zero dimensional
ring of finite type over $k$. Hence it is finite over $k$
for example by Lemma \ref{lemma-Noether-normalization}.

\medskip\noindent
Suppose $S_{\mathfrak q}$ is finite over $k$.
Consider the exact sequence $0 \to K \to S \to S_{\mathfrak q}
\to Q \to 0$. It is clear that $K_{\mathfrak q} = Q_{\mathfrak q} = 0$.
Also, both are finitely generated as $S$-modules. Hence there
exists $g \in S$, $g \not \in \mathfrak q$ such that
$K_g = Q_g = 0$. Thus $S_{\mathfrak q} = S_g$ and
$D(g) = \{ \mathfrak q \}$.

\medskip\noindent
Suppose $D(g) =  \{ \mathfrak q \}$.
Then $\mathfrak q$ corresponds to a maximal ideal
of $S_g$. Hence $\kappa(\mathfrak q)$ is a finite
extension of $k$, see Theorem \ref{theorem-nullstellensatz}.
Hence $\mathfrak q$ is a closed point of $\text{Spec}(S)$,
see for example Lemma \ref{lemma-dimension-prime-polynomial-ring}.
Thus $\{ \mathfrak q \}$ is both open and closed and
hence $\mathfrak q$ is an isolated point of
$\text{Spec}(S)$.

\medskip\noindent
The two statements at the end of the lemma we saw during the
course of the proof of the equivalence of (1), (2) and (3) above.
\end{proof}

\begin{lemma}
\label{lemma-isolated-point-fibre}
Let $R$ be a ring.
Let $R \to S$ be a ring map of finite type.
Let $\mathfrak q \subset S$ be a prime lying over
$\mathfrak p \subset R$. The following are equivalent
\begin{enumerate}
\item $\mathfrak q$ is an isolated point of
its fibre, i.e., of $\text{Spec}(S \otimes_R \kappa(\mathfrak p))$,
\item $S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}$ is finite over
$\kappa(\mathfrak p)$, and
\item there exists a $g \in S$, $g \not \in \mathfrak q$ such that
the only prime of $D(g)$ mapping to $\mathfrak p$
is $\mathfrak q$.
\end{enumerate}
\end{lemma}

\begin{proof}
The equivalence of (1), (2) and (3) is immediate from
Lemma \ref{lemma-isolated-point}.
\end{proof}

\begin{definition}
\label{definition-quasi-finite}
Let $R \to S$ be a finite type ring map.
Let $\mathfrak q \subset S$ be a prime.
If the equivalent conditions of Lemma \ref{lemma-isolated-point-fibre}
are satisfied then we say $R \to S$ is {\it quasi-finite at $\mathfrak q$}.
If $R \to S$ is quasi-finite at all primes of $S$ then we say
$S$ is {\it quasi-finite over $R$}.
\end{definition}

\begin{lemma}
\label{lemma-quasi-finite}
Let $R \to S$ be a finite type ring map.
Then $R \to S$ is quasi-finite if and only if for all
primes $\mathfrak p \subset R$
the fibre $S \otimes_R \kappa(\mathfrak p)$ is finite
over $\kappa(\mathfrak p)$.
\end{lemma}

\begin{proof}
If the fibres are finite then the map is clearly quasi-finite.
For the converse, note that $S \otimes_R \kappa(\mathfrak p)$
is a $\kappa(\mathfrak p)$-algebra of finite type over
$k$ of dimension $0$. Hence it is finite over $k$ for example
by Lemma \ref{lemma-Noether-normalization}.
\end{proof}

\begin{lemma}
\label{lemma-four-rings}
Let
$$
\begin{matrix}
S & \to & S' \\
\uparrow & & \uparrow \\
R & \to & R'
\end{matrix}
$$
be a commutative diagram of rings.
Let $\mathfrak q'$ be a prime of $S'$, lying over primes
$\mathfrak q \subset S$, $\mathfrak p' \subset R'$, and
$\mathfrak p \subset R$. Assume $R \to S$ and $R' \to S'$
of finite type, and $S \otimes_R R' \to S'$ surjective.
If $R \to S$ is quasi-finite at $\mathfrak q$, then
$R' \to S'$ is quasi-finite at $\mathfrak q'$.
\end{lemma}

\begin{proof}
Write $S \otimes_R \kappa(\mathfrak p) = S_1 \times S_2$
with $S_1$ finite over $\kappa(\mathfrak p)$ and such that
$\mathfrak q$ corresponds to a point of $S_1$ as in
Lemma \ref{lemma-isolated-point}.
Because $S \otimes_R R' \to S'$ surjective the canonical map
$(S \otimes_R \kappa(\mathfrak p)) \otimes_{\kappa(\mathfrak p)}
\kappa(\mathfrak p') \to S' \otimes_{R'} \kappa(\mathfrak p')$
is surjective. Let $S_i'$ be the image of $S_i \otimes_{\kappa(\mathfrak p)}
\kappa(\mathfrak p')$ in $S' \otimes_{R'} \kappa(\mathfrak p')$.
Then $S' \otimes_{R'} \kappa(\mathfrak p') =S'_1 \times
S'_2$ and $S'_1$ is finite over $\kappa(\mathfrak p')$.
The map $S' \otimes_{R'} \kappa(\mathfrak p') \to
\kappa(\mathfrak q')$ factors through $S_1'$
(i.e.\ it annihilates the factor $S_2'$) 
because the map $S\otimes_R \kappa(\mathfrak p) \to
\kappa(\mathfrak q)$ factors through $S_1$
(i.e.\ it annihilates the factor $S_2$). Thus
$\mathfrak q'$ corresponds to a point of
$\text{Spec}(S_1')$ in the disjoint union decomposition
of the fibre: $\text{Spec}(S' \otimes_{R'} \kappa(\mathfrak p'))
= \text{Spec}(S_1') \sqcup \text{Spec}(S_1')$. (See
Lemma \ref{lemma-spec-product}.)
Since $S_1'$ is finite over a field, it is Artinian ring,
and hence $\text{Spec}(S_1')$ is a finite discrete set.
(See Proposition \ref{proposition-dimension-zero-ring}.)
We conclude $\mathfrak q'$ is isolated in its fibre as
desired.
\end{proof}

\begin{lemma}
\label{lemma-make-integral-trivial}
Let $\varphi : R \to S$ be a ring map.
Suppose $t \in S$ satisfies the
relation $\varphi(a_0) + \varphi(a_1)t + \ldots + \varphi(a_n) t^n = 0$.
Then $\varphi(a_n)t$ is integral over $R$.
\end{lemma}

\begin{proof}
Namely, multiply the equation 
$\varphi(a_0) + \varphi(a_1)t + \ldots + \varphi(a_n) t^n = 0$
with $\varphi(a_n)^{n-1}$ and write it as
$\varphi(a_0 a_n^{n-1}) + 
\varphi(a_1 a_n^{n-2}) (\varphi(a_n)t) +
\ldots +
(\varphi(a_n) t)^n = 0$.
\end{proof}

\begin{lemma}
\label{lemma-make-integral-less-trivial}
Let $\varphi : R \to S$ be a ring map.
Suppose $t \in S$ satisfies the
relation $\varphi(a_0) + \varphi(a_1)t + \ldots + \varphi(a_n) t^n = 0$.
Set $u_n = \varphi(a_n)$, $u_{n-1} = u_n t + \varphi(a_{n-1})$,
and so on till $u_1 = u_2 t + \varphi(a_1)$. 
Then all of $u_n, u_{n-1}, \ldots, u_1$ and
$u_nt, u_{n-1}t, \ldots, u_1t$ are integral over $R$,
and the ideals $(\varphi(a_0), \ldots, \varphi(a_n))$ and
$(u_n,\ldots, u_1)$ of $S$ are equal.
\end{lemma}

\begin{proof}
We first remark that $u_{i} = 
\varphi(a_n)t^{n-i} + \varphi(a_{n-1})t^{n-i-1} + \ldots + \varphi(a_{i})$
which is easy to verify by descending induction on $i$. Hence it
is clear that $u_{i}t^{i} + \varphi(a_{i-1})t^{i-1} +
\ldots + \varphi(a_0) = 0$.  
By Lemma \ref{lemma-make-integral-trivial}
we see that $u_it$ is integral over $R$. 
Also, $u_n \in \text{Im}(\varphi)$ is integral over
$R$, and $u_i = u_{i+1}t + \varphi(a_i)$ is integral over $R$
because it is the sum of two elements integral over $R$.
The statement on the ideals is immediate from the
shape of the elements and the fact that
$u_0 = u_1t + \varphi(a_0) = 0$ as we saw above.
\end{proof}

\begin{lemma}
\label{lemma-make-integral-not-in-ideal}
Let $\varphi : R \to S$ be a ring map.
Suppose $t \in S$ satisfies the
relation $\varphi(a_0) + \varphi(a_1)t + \ldots + \varphi(a_n) t^n = 0$.
Let $J \subset S$ be an ideal such that for at
least on $i$ we have $\varphi(a_i) \not \in J$.
Then there exists a $u \in S$, $u \not\in J$ such
that both $u$ and $ut$ are integral over $R$.
\end{lemma}

\begin{proof}
This is immediate from Lemma \ref{lemma-make-integral-less-trivial}
since one of the elements $u_i$ will not be in $J$.
\end{proof}

\noindent
The following lemma is in some sense the key lemma in this
section.

\begin{lemma}
\label{lemma-make-integral-trick}
Let $R$ be a ring and let $\varphi : R[x] \to S$ be
a ring map. Assume that (a) $t \in S$ is integral over $R[x]$,
and (b) there exists a monic $p \in R[x]$ such that
$t \varphi(p) \in \text{Im}(\varphi)$. Then there
exists a $q \in R[x]$ such that $t - \varphi(q)$
is integral over $R$.
\end{lemma}

\begin{proof}
Write $t \varphi(p) = \varphi(r)$ for some $r \in R[x]$.
Using euclidean division, write $r = qp + r'$ with
$q,r' \in R[x]$ and $\deg(r') < \deg(p)$. We may replace
$t$ by $t - \varphi(q)$ which is still integral over
$R[x]$, so that we obtain $t \varphi(p) = \varphi(r')$.
In the ring $S_t$ we may write this as
$\varphi(p) - (1/t) \varphi(r') = 0$.
This implies that $\varphi(x)$ gives an element of the
localization $S_t$ which is integral over
$\varphi(R)[1/t] \subset S_t$. On the other hand,
$t$ is integral over the subring $\varphi(R)[\varphi(x)] \subset S$.
Combined we conclude that $t$ is integral over
the subring $\varphi(R)[1/t] \subset S_t$, see Lemma
\ref{lemma-integral-transitive}. In other words
there exists an equation of the form
$t^d + \sum_{i<d} (\varphi(r_i)/t^{n_i}) t^i = 0$
in $S_t$ with $r_i \in R$. This means that
$t^{d+N} + \sum_{i < d} \varphi(r_i) t^{i + N - n_i} = 0$ in $S$
for some $N$ large enough. In other words
$t$ is integral over $R$.
\end{proof}

\begin{lemma}
\label{lemma-change-equation-multiply}
Let $R$ be a ring and let $\varphi : R[x] \to S$ be
a ring map. Let $t \in S$. If $t$ is integral over
$R[x]$, then there exists an $\ell \geq 0$ such that
for every $a \in R$ the element $\varphi(a)^\ell t$
is integral over $\varphi_a : R["ax"] \to S$, defined by
$"ax" \mapsto \varphi(ax)$ and $r \mapsto \varphi(r)$
for $r\in R$.
\end{lemma}

\begin{proof}
Say $t^d + \sum_{i<d} \varphi(f_i)t^i = 0$
with $f_i \in R[x]$. Let $\ell$ be the maximum degree
in $x$ of all the $f_i$. Multiply the equation
by $\varphi(a)^\ell$ to get
$\varphi(a)^\ell t^d + \sum_{i<d} \varphi(a^\ell f_i)t^i = 0$.
Note that each $\varphi(a^\ell f_i)$ is in the image of
$\varphi_a$. The result follows from
Lemma \ref{lemma-make-integral-trivial}.
\end{proof}

\begin{lemma}
\label{lemma-combine-lemmas}
Let $R$ be a ring and let $\varphi : R[x] \to S$ be
a ring map. Let $t \in S$. Assume $t$ is integral
over $R[x]$. Let $p \in R[x]$, $p = a_0 + a_1x + \ldots +
a_k x^k$ such that $t \varphi(p) \in \text{Im}(\varphi)$.
Then there exists a $q \in R[x]$ and $n \geq 0$
such that $\varphi(a_k)^n t - \varphi(q) $ is integral
over $R$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-change-equation-multiply} there exists
an $\ell \geq 0$ such that
the element $\varphi(a_k)^\ell t$ is integral
over the map $\varphi' : R[y] \to S$, $\varphi'(y) = 
\varphi(a_k x)$ and $\varphi'(r) = \varphi(r)$, for $r\in R$.
The polynomial $p' = a_k^{k-1} a_0 + a_k^{k-2} a_1 y
+ \ldots + y^k$ is monic and $t \varphi'(p')
= \varphi(a_k^{k-1}) t \varphi(p) \in \text{Im}(\varphi)$.
By definition of $\varphi'$ this implies there exists
a $n \geq k-1$ such that $\varphi(a_k^n)t \varphi'(p')
\in \text{Im}(\varphi')$. If also $n \geq \ell$, then
$\varphi(a_k)^n t$ is still integral over $R[y]$.
By Lemma \ref{lemma-make-integral-trick} 
we see that $\varphi(a_k)^n t - \varphi'(q)$ is integral over $R$
for some $q \in R[y]$. Again by the simple relationship between
$\varphi'$ and $\varphi$ this implies the lemma.
\end{proof}

\begin{situation}
\label{situation-one-transcendental-element}
Let $R$ be a ring.
Let $\varphi : R[x] \to S$ be finite.
Let
$$
J = \{ g \in S \mid gS \subset \text{Im}(\varphi)\}
$$
be the ``conductor ideal'' of $\varphi$.
Assume $\varphi(R) \subset S$ integrally closed in $S$.
\end{situation}

\begin{lemma}
\label{lemma-leading-coefficient-in-J}
In Situation \ref{situation-one-transcendental-element}.
Suppose $u \in S$, $a_0,\ldots, a_k \in R$,
$u \varphi(a_0 + a_1x + \ldots + a_k x^k) \in J$.
Then there exists an $m \geq 0$ such that
$u \varphi(a_k)^m \in J$.
\end{lemma}

\begin{proof}
Assume that $S$ is generated by $t_1,\ldots, t_n$
as an $R[x]$-module. In this case
$J = \{ g \in S \mid gt_i \in \text{Im}(\varphi)\text{ for all }i\}$.
Note that each element $u t_i$ is integral over
$R[x]$, see Lemma \ref{lemma-finite-is-integral}.
We have $\varphi(a_0 + a_1x + \ldots + a_k x^k) u t_i \in
\text{Im}(\varphi)$. By Lemma \ref{lemma-combine-lemmas}, for
each $i$ there exists an integer $n_i$ and an element
$q_i \in R[x]$ such that $\varphi(a_k^{n_i}) u t_i - \varphi(q_i)$
is integral over $R$. By assumption this element is in $R$
and hence $\varphi(a_k^{n_i}) u t_i \in \text{Im}(\varphi)$.
It follows that $m = \max\{n_1,\ldots,n_n\}$ works.
\end{proof}

\begin{lemma}
\label{lemma-all-coefficients-in-J}
In Situation \ref{situation-one-transcendental-element}.
Suppose $u \in S$, $a_0,\ldots, a_k \in R$,
$u \varphi(a_0 + a_1x + \ldots + a_k x^k) \in \sqrt{J}$.
Then $u \varphi(a_i) \in \sqrt{J}$ for all $i$.
\end{lemma}

\begin{proof}
Under the assumptions of the lemma we have
$u^n \varphi(a_0 + a_1x + \ldots + a_k x^k)^n \in J$ for
some $n \geq 1$. By Lemma \ref{lemma-leading-coefficient-in-J}
we deduce $u^n \varphi(a_k^{nm}) \in J$ for some $m \geq 1$.
Thus $u \varphi(a_k) \in \sqrt{J}$, and so
$u \varphi(a_0 + a_1x + \ldots + a_k x^k) - u \varphi(a_k) =
u \varphi(a_0 + a_1x + \ldots + a_{k-1} x^{k-1}) \in \sqrt{J}$.
We win by induction on $k$.
\end{proof}

\noindent
This lemma suggests the following definition.

\begin{definition}
\label{definition-strongly-transcendental}
Given an inclusion of rings $R \subset S$ and
an element $x \in S$ we say that $x$ is
{\it strongly transcendental over $R$} if
whenever $u(a_0 + a_1 x + \ldots + a_k x^k) = 0$
we have $ua_i = 0$ for all $i$.
\end{definition}

\begin{lemma}
\label{lemma-reduced-strongly-transcendental-minimal-prime}
Suppose $R \subset S$ is an inclusion of reduced rings
and suppose that $x \in S$ is strongly transcendental over $R$.
Let $\mathfrak q \subset S$ be a minimal prime
and let $\mathfrak p = R \cap \mathfrak q$.
Then the image of $x$ in $S/\mathfrak q$ is strongly
transcendental over the subring $R/\mathfrak p$.
\end{lemma}

\begin{proof}
Suppose $u(a_0 + a_1x + \ldots + a_k x^k) \in \mathfrak q$.
By Lemma \ref{lemma-minimal-prime-reduced-ring}
the local ring $S_{\mathfrak q}$ is a field,
and hence $u(a_0 + a_1x + \ldots + a_k x^k) $ is zero
in $S_{\mathfrak q}$. Thus $uu'(a_0 + a_1x + \ldots + a_k x^k) = 0$
for some $u' \in S$, $u' \not\in \mathfrak q$.
Since $x$ is strongly transcendental over $R$ we get
$uu'a_i = 0$ for all $i$. This in turn implies
that $ua_i \in \mathfrak q$.
\end{proof}

\begin{lemma}
\label{lemma-domains-transcendental-not-quasi-finite}
Suppose $R\subset S$ is an inclusion of domains and
let $x \in S$. Assume $x$ is (strongly) transcendental over $R$
and that $S$ is finite over $R[x]$. Then $R\to S$ is not
quasi-finite at any prime of $S$.
\end{lemma}

\begin{proof}
As a first case, assume that $R$ is normal.
By Lemma \ref{lemma-polynomial-ring-normal}
we see that $R[x]$ is normal.
Take a prime $\mathfrak q \subset S$,
and set $\mathfrak p = R \cap \mathfrak q$.
Assume that the extension $\kappa(\mathfrak p)
\subset \kappa(\mathfrak q)$ is finite.
This would be the case if $R \to S$ is
quasi-finite at $\mathfrak q$.
Let $\mathfrak r = R[x] \cap \mathfrak q$.
Then since $\kappa(\mathfrak p)
\subset \kappa(\mathfrak r) \subset \kappa(\mathfrak q)$
we see that the extension $\kappa(\mathfrak p)
\subset \kappa(\mathfrak r)$ is finite too.
Thus the inclusion $\mathfrak r \supset \mathfrak p R[x]$
is strict. By going down for $R[x] \subset S$,
see Proposition \ref{proposition-going-down-normal-integral},
we find a prime $\mathfrak q' \subset \mathfrak q$,
$\mathfrak q' \not = \mathfrak q$,
lying over the prime $\mathfrak pR[x]$. Hence
the fibre $\text{Spec}(S \otimes_R \kappa(\mathfrak p))$
contains a point not equal to $\mathfrak q$,
namely $\mathfrak q'$, whose closure contains $\mathfrak q$ and hence
$\mathfrak q$ is not isolated in its fibre.

\medskip\noindent
If $R$ is not normal, let $R \subset R' \subset K$ be
the integral closure $R'$ of $R$ in its field of fractions
$K$. Let $S \subset S' \subset L$ be the subring $S'$ of
the field of fractions $L$ of $S$ generated by $R'$ and
$S$. Note that by construction the map $S \otimes_R R'
\to S'$ is surjective. Also, the map $S \subset S'$
induces a surjection on $\text{Spec}$, see
Lemma \ref{lemma-integral-overring-surjective}.
We conclude by Lemma \ref{lemma-four-rings} and the normal case
we just discussed.
\end{proof}

\begin{lemma}
\label{lemma-reduced-strongly-transcendental-not-quasi-finite}
Suppose $R \subset S$ is an inclusion of reduced rings.
Assume $x \in S$ be strongly transcendental over $R$,
and $S$ finite over $R[x]$. Then $R\to S$ is not
quasi-finite at any prime of $S$.
\end{lemma}

\begin{proof}
Let $\mathfrak q \subset S$ be any prime.
Choose a minimal prime $\mathfrak q' \subset \mathfrak q$.
According to Lemmas
\ref{lemma-reduced-strongly-transcendental-minimal-prime} and
\ref{lemma-domains-transcendental-not-quasi-finite}
the extension $R/(R \cap \mathfrak q') \subset
S/\mathfrak q'$ is not quasi-finite at the prime corresponding
to $\mathfrak q$. By Lemma \ref{lemma-four-rings}
the extension $R \to S$ is not quasi-finite
at $\mathfrak q$.
\end{proof}

\begin{lemma}
\label{lemma-finite-after-localization}
Let $R$ be a ring, let $f \in R$.
Suppose we have $S$, $S'$ and the solid arrows
forming the following commutative diagram of rings
$$
\xymatrix{
& S'' \ar@{-->}[rd] \ar@{-->}[dd] & 
\\
R \ar[rr] \ar@{-->}[ru] \ar[d] &  & S \ar[d]
\\
R_f \ar[r] & S' \ar[r] & S_f
}
$$
Assume that $R_f \to S'$ is finite. Then we can find
a finite ring map $R \to S''$ and dotted arrows as
in the diagram such that $S' = S''_f$.
\end{lemma}

\begin{proof}
Namely, suppose that $S'$ is generated by
$x_i$ over $R_f$, $i=1,\ldots,w$. Let $P_i(t) \in R_f[t]$
be a monic polynomial such that $P_i(x_i) = 0$.
Say $P_i$ has degree $d_i > 0$. Write
$P_i(t) = t^{d_i} + \sum_{j < d_i} (a_{ij}/f^n) t^j$
for some uniform $n$. Also write 
the image of $x_i$ in $S_f$ as $g_i / f^n$
for suitable $g_i \in S$. Then we know
that the element
$\xi_i = f^{nd_i} g_i^{d_i} + \sum_{j < d_i} f^{n(d_i - j)} a_{ij} g_i^j$
of $S$ is killed by a power of $f$.
Hence upon increasing $n$ to $n'$, which replaces 
$g_i$ by $f^{n' - n}g_i$ we may assume $\xi_i = 0$.
Then $S'$ is generated by the elements
$f^n x_i$, each of which is a zero of the
monic polynomial $Q_i(t) = t^{d_i} +
\sum_{j < d_i} f^{n(d_i - j)} a_{ij} t^j$
with coefficients in $R$. Also, by construction
$Q_i(f^ng_i) = 0$. Thus we get a finite $R$-algebra
$S'' = R[z_1,\ldots,z_w]/(Q_1(z_1),\ldots,Q_w(z_w))$
which fits into a commutative diagram as above.
The map $\alpha : S'' \to S$ maps $z_i$ to $f^ng_i$ and
the map $\beta : S'' \to S'$ maps $z_i$ to $f^nx_i$. 
It is not yet the case that $S''_f \cong S'$,
for the moment we only know that this map
is surjective. The problem is that there could be
elements $h/f^n \in S''_h$ which map to zero
in $S'$ but are not zero. In this case $\beta(h)$
is an element of $S$ such that $f^N \beta(h) = 0$
for some $N$. Thus $f^N h$ is an element ot the ideal
$J = \{h \in S'' \mid \alpha(h) = 0 \text{ and }
\beta(h) = 0\}$ of $S''$. OK, and it is easy to see that
$S''/J$ does the job.
\end{proof}

\noindent
The following two lemmas are a way of describing closed
subschemes of $\mathbf{P}^1_R$ cut out by one (nondegenerate)
equation.

\begin{lemma}
\label{lemma-P1}
Let $R$ be a ring.
Let $F(X,Y) \in R[X,Y]$ be homogenous of degree
$d$. Assume that for every prime $\mathfrak p$ of $R$
at least one coefficient of $F$ is not in $\mathfrak p$.
Let $S = R[X,Y]/(F)$ as a graded ring.
Then for all $n \geq d$ the $R$-module $S_n$
is finite locally free of rank $d$.
\end{lemma}

\begin{proof}
The $R$-module $S_n$ has a presentation
$$
R[X,Y]_{n-d} \to R[X,Y]_n \to S_n \to 0.
$$
Thus by Lemma \ref{lemma-cokernel-flat}
it is enough to show that multiplication
by $F$ induces an injective map
$\kappa(\mathfrak p)[X,Y]
\xrightarrow{F} \kappa(\mathfrak p)[X,Y]$
for all primes $\mathfrak p$.
This is clear from the assumption that
$F$ does not map to the zero polynomial mod $\mathfrak p$.
The assertion on ranks is clear from this as well.
\end{proof}

\begin{lemma}
\label{lemma-rel-prime-pols}
Let $k$ be a field. Let $F,G \in k[X,Y]$ be homogeneous
of degrees $d,e$. Assume $F,G$ relatively prime.
Then multiplication by $G$ is injective on $S = k[X,Y]/(F)$.
\end{lemma}

\begin{proof}
This is more or less the definition of relatively prime.
\end{proof}

\begin{lemma}
\label{lemma-P1-localize}
Let $R$ be a ring. Let $F(X,Y) \in R[X,Y]$ be homogenous of degree
$d$. Let $S = R[X,Y]/(F)$ as a graded ring.
Let $\mathfrak p \subset R$ be a prime such that
some coefficient of $F$ is not in $\mathfrak p$.
There exists an $f \in R$ $f \not\in \mathfrak p$,
an integer $e$, and a $G \in R[X,Y]_e$
such that multiplication by $G$ induces isomorphisms
$(S_n)_f \to (S_{n+e})_f$ for all $n \geq d$.
\end{lemma}

\begin{proof}
During the course of the proof we may replace $R$ by $R_f$
for $f\in R$, $f\not\in \mathfrak p$ (finitely often).
As a first step we do such a replacement such that
some coefficient of $F$ is invertible in $R$.
In particular the modules $S_n$ are now locally
free of rank $d$ for $n \geq d$ by Lemma \ref{lemma-P1}.
Pick any $G \in R[X,Y]_e$ such that the image of
$G$ in $\kappa(\mathfrak p)[X,Y]$ is relatively
prime to the image of $F(X,Y)$ (this is possible for some $e$).
Apply Lemma \ref{lemma-cokernel-flat} to the map
induced by multiplication by $G$ from $S_{d} \to S_{d+e}$.
By our choice of $G$ and Lemma \ref{lemma-rel-prime-pols}
we see
$S_{d}\otimes \kappa(\mathfrak p) \to S_{d+e} \otimes \kappa(\mathfrak p)$
is bijective. Thus, after replacing $R$ by $R_f$ for a suitable
$f$ we may assume that $G : S_{d} \to S_{d+e}$
is bijective. This in turn implies that the image
of $G$ in $\kappa(\mathfrak p')[X,Y]$ is relatively
prime to the image of $F$ for all primes $\mathfrak p'$ 
of $R$. And then by Lemma \ref{lemma-cokernel-flat}
again we see that all the maps
$G : S_{d} \to S_{d+e}$, $n \geq d$ are isomorphisms.
\end{proof}

\begin{remark}
\label{remark-algebra}
Let $R$ be a ring. Suppose that we have $F \in R[X,Y]_d$
and $G \in R[X,Y]_e$ such that, setting $S = R[X,Y]/(F)$
we have (1) $S_n$ is finite locally free of rank $d$ for
all $n \geq d$, and (2) multiplication by $G$ defines
ismorphisms $S_n \to S_{n+e}$ for all $n \geq d$. In this
case we may define a finite flat $R$-algebra
$A$ as follows:
\begin{enumerate}
\item as an $R$-module $A = S_{ed}$, and
\item multiplication $A \times A \to A$ is given by
the rule that $H_1 H_2 = H_3$ if and only if $G^d H_3 = H_1 H_2$
in $S_{2ed}$.
\end{enumerate}
This makes sense because multiplication by $G^d$
induces a bijective map $S_{de} \to S_{2de}$.
It is easy to see that this defines a ring structure.
Note the confusing fact that the element $G^d$
defines the unit element of the ring $A$.
\end{remark}

\begin{lemma}
\label{lemma-quasi-finite-monogenic}
Let $R$ be a ring. Let $S = R[x]/I$.
Let $\mathfrak q \subset S$ be a prime.
Assume $R \to S$ is quasi-finite at $\mathfrak q$.
There exists a finite $R$-algebra $S'$ and an
$R$-algebra map $S' \to S$ and an element
$g \in S'$, which does not map to an
element of $\mathfrak q$ such that
$S'_g \cong S_g$.
\end{lemma}

\begin{proof}
Let $\mathfrak p$ be the image of $\mathfrak q$ in $\text{Spec}(R)$.
During the course of the proof, we may (finitely often)
replace $R$ by $R_f$ and $S$ by $S_f$ for any
$f \not \in \mathfrak p$. This follows from
Lemma \ref{lemma-finite-after-localization}.

\medskip\noindent
By assumption there exists a polynomial $f(x) \in I \subset R[x]$
whose image in $\kappa(\mathfrak p)[x]$ is not zero. We may
replace $I$ by the ideal $(f)$, since if we have a solution
$\varphi : S' \to R[x]/(f)$ then we obtain the solution
for $S'/\varphi^{-1}(I/(f)) \to R[x]/I$ for the general case.

\medskip\noindent
Let $F(X,Y) \in R[X,Y]$ be homogeneous of
degree $d$ such that $F(x, 1) = f(x)$.
By Lemma \ref{lemma-P1-localize} we may choose a $G \in R[X,Y]_e$
such that, after localizing $R$ as in the initial remark of
the proof, $F$ and $G$ satisfy the assumptions (1) and (2) of Remark
\ref{remark-algebra}. Let $A$ be the finite $R$-algebra constructed
constructed from the pair $F$, $G$ in Remark \ref{remark-algebra}.
Choose a $H \in R[X,Y]_{ed}$ such that $G^d H = Y^{2de} \bmod (F)$.
Note that this implies that $G(x,1)^dH(x,1) = 1 \bmod (f(x))$.
In other words $G(x,1)$ maps to a unit of $R[x]/(f)$. We can then define
$$
A \longrightarrow R[x]/(f),\ \ 
L \bmod (F) \longmapsto L(x,1)/G(x,1)^d \bmod f.
$$
It is straightforward to verify this is well defined.
We claim setting $A = S'$ with the given map 
is a solution to the lemma.

\medskip\noindent
Namely, consider the element $g = Y^{de} \bmod (F) \in A$.
It maps to the invertible element $1/G(x,1)^d$ of
$R[x]/(f)$. Thus we obtain a map $A_g \to R[x]/(f(x))$.
We will show this is an isomorphism, thereby concluding the proof.
If $i+j = de$ we will use the phrase ``let $X^iY^j \in A$'' to mean
the image of $X^iY^j$ in the quotient $A = S_{de}$.
Consider the element $t \in A_g$ which is the fraction
with numerator $XY^{de-1} \in A$ and denominator $g$.
A simple calculation shows that $t^i$ is the same
as the quotient $X^i Y^{de-i}/g$, in $A_g$ for
$i = 0, 1, \ldots, de$. The unit element $1_A$ corresponds
to $G^d \in A = S_{de}$. Write $G = \sum_{i+j =de} r_{ij}X^iY^j$
then we see that $1/g$ in $A_g$ corresponds to
$\sum r_{ij}t^i$. 
A general element of $A_g$ is a sum of elements which are
quotients of $X^iY^j$, $i + j = de$ by powers of $g$.
Hence we see that $A_g$ is generated by $t$ over $R$.
Note that the map $A_g \to R[x]/(f)$ maps $t$ to the
class of $x$. Note also that $F(t, 1) = 0$ by construction
of $A$. Hence $A_g \to R[x]/(f)$ is surjective and injective
and we are done.
\end{proof}

\begin{proposition}
\label{proposition-main-theorem}
(Zariski's Main Theorem.)
Let $R$ be a ring. Let $R \to S$ be a finite type $R$-algebra.
Let $S' \subset S$ be the integral closure of $R$ in $S$.
Let $\mathfrak q \subset S$ be a prime of $S$.
If $R \to S$ is quasi-finite at $\mathfrak q$ then
there exists a $g \in S'$, $g \not \in \mathfrak q$
such that $S'_g \cong S_g$.
\end{proposition}

\begin{proof}
There exist finitely many elements
$x_1,\ldots, x_n \in S$ such that $S$ is finite
over the $R$-sub algebra generated by $x_1,\ldots,x_n$. (For
example generators of $S$ over $R$.) We prove the proposition
by induction on the minimal such number $n$.

\medskip\noindent
The case $n = 0$ is trivial, because in this case $S' = S$,
see Lemma \ref{lemma-finite-is-integral}.

\medskip\noindent
The case $n = 1$. We may and do replace $R$ by its integral
closure in $S$, in particular this means that $R \subset S$.
Consider the map $\varphi : R[x] \to S$, $x \mapsto x_1$.
(We will see that $\varphi$ is not injective below.)
By assumption $\varphi$ is finite. Hence we are in Situation
\ref{situation-one-transcendental-element}.
Let $J \subset S$ be the ``conductor ideal'' defined
in Situation \ref{situation-one-transcendental-element}.
Consider the diagram
$$
\xymatrix{
R[x] \ar[r] & S \ar[r] & S/\sqrt{J} & R/(R \cap \sqrt{J})[x] \ar[l]
\\
& R \ar[lu] \ar[r] \ar[u] & R/(R \cap \sqrt{J}) \ar[u] \ar[ru] &
}
$$
According to Lemma \ref{lemma-all-coefficients-in-J} 
the image of $x$ in the quotient $S/\sqrt{J}$
is strongly transcendental over $R/ (R \cap \sqrt{J})$.
Hence by Lemma \ref{lemma-reduced-strongly-transcendental-not-quasi-finite}
the ring map $R/ (R \cap \sqrt{J}) \to S/\sqrt{J}$
is not quasi-finite at any prime of $S/\sqrt{J}$.
By Lemma \ref{lemma-four-rings} we deduce that $\mathfrak q$
does not lie in $V(J) \subset \text{Spec}(S)$.
Thus there exists an element $s \in J$,
$s \not\in \mathfrak q$. By definition of $J$ we may write
$s = \varphi(f)$ for some polynomial $f \in R[x]$.
Now let $I = \text{Ker}(R[x] \to S)$. Since $\varphi(f) \in J$
we get $(R[x]/I)_f \cong S_{\varphi(f)}$, and $s \not \in \mathfrak q$
means that $\mathfrak q$ corresponds to a prime of $(R[x]/I)_f$
at which $R \to R[x]/I$ is quasi-finite. This reduces us
to the case $S = R[x]/I$. In this case
Lemma \ref{lemma-quasi-finite-monogenic} implies the result.

\medskip\noindent
The case $n > 1$. Consider the subring $R' \subset S$
which is the integral closure of $R[x_1,\ldots,x_{n-1}]$
in $S$. By Lemma \ref{lemma-four-rings} the extension
$S/R'$ is quasi-finite at $\mathfrak q$. Also, note
that $S$ is finite over $R'[x_n]$.
By the case $n = 1$ above, there exists a $g' \in R'$,
$g' \not \in \mathfrak q$ such that
$R'_{g'} \cong S_{g'}$.\footnote{At this point we cannot
immediately apply induction
to $R \to R'$ since $R'$ may not be finite type over $R$.}
Since $S$ is finitely generated over $R$ we deduce in particular
that $R'_{g'}$ is finitely generated over $R$. Say
the elements $g'$, and $y_1/(g')^{n_1},\ldots, y_N/(g')^{n_N}$
with $y_i \in R'$
generate $R'_{g'}$ over $R$. Let $R''$ be the $R$-sub algebra
of $R'$ generated by $x_1,\ldots,x_{n-1}, y_1,\ldots,y_N, g'$.
This has the property $R''_{g'} \cong S_{g'}$. Surjectivity
because of how we chose $y_i$, injectivity because
$R'' \subset R'$, and localization is exact. Note that
$R''$ is finite over $R[x_1,\ldots,x_{n-1}]$ because
of our choice of $R'$, see Lemma \ref{lemma-characterize-integral}.
Let $\mathfrak q'' = R'' \cap \mathfrak q$. Since
$R''_{\mathfrak q''} = S_{\mathfrak q}$ we see that
$R \to R''$ is quasi-finite at $\mathfrak q''$, see
Lemma \ref{lemma-isolated-point-fibre}.
We apply our induction hypothesis to $R \to R''$, $\mathfrak q''$
and $x_1,\ldots,x_{n-1} \in R''$ and we find a subring
$R''' \subset R''$ which is integral over $R$ and an
element $g'' \in R'''$, $g'' \not \in \mathfrak q''$
such that $R'''_{g''} \cong R''_{g''}$. Write the image of $g'$ in
$R''$ as $g'''/(g'')^n$ for some $g''' \in  R'''$.
Set $g = g'g'' \in R'''$. Then it is clear that $g \not\in
\mathfrak q$ and $R'''_g \cong S_g$. Since by construction
we have $R''' \subset S'$ we still have $S'_g \cong S_g$
as desired.
\end{proof}

\begin{lemma}
\label{lemma-quasi-finite-open}
Let $R$ be a ring. Let $R \to S$ be a finite type ring map.
The set of points $\mathfrak q$ of $\text{Spec}(S)$ at which
$S/R$ is quasi-finite is open in $\text{Spec}(S)$.
\end{lemma}

\begin{proof}
Let $\mathfrak q \subset S$ be a point at which the ring map
is quasi-finite. By Proposition \ref{proposition-main-theorem}
there exists an integral ring extension $R \to S'$, $S' \subset S$
and an element $g \in S'$, $g\not \in \mathfrak q$ such that
$S'_g \cong S_g$. Since $S$ and hence $S_g$ are of finite type
over $R$ we may find finitely many elements
$y_1,\ldots, y_N$ of $S'$ such that $S''_g \cong S$
where $S'' \subset S'$ is the sub $R$-algebra generated
by $g, y_1,\ldots, y_N$. Since $S''$ is finite over $R$
(see Lemma \ref{lemma-characterize-integral}) we see that
$S''$ is quasi-finite over $R$, hence
$S''_g$ is quasi-finite over $R$, and hence 
$S_g$ is quasi-finite over $R$.
\end{proof}


\begin{lemma}
\label{lemma-quasi-finite-open-integral-closure}
Let $R \to S$ be a finite type ring map.
Suppose that $S$ is quasi-finite over $R$.
Let $S' \subset S$ be the integral closure of
$R$ in $S$.
\begin{enumerate}
\item $\text{Spec}(S) \to \text{Spec}(S')$ is
an open immersion,
\item if $g \in S'$ and $D(g)$ is contained in the image
of the map, then $S'_g \cong S_g$, and
\item there exists a finite $R$-algebra $S'' \subset S'$
such that (1) and (2) hold for the ring map
$S'' \to S$.
\end{enumerate}
\end{lemma}

\begin{proof}
Because $S/R$ is quasi-finite we may apply
Proposition \ref{proposition-main-theorem} to
each point $\mathfrak q$ of $\text{Spec}(S)$.
Since $\text{Spec}(S)$ is quasi-compact, see
Lemma \ref{lemma-quasicompact}, we may choose
a finite number of $g_i \in S'$, $i=1,\ldots,n$
such that $S'_{g_i} = S_{g_i}$, and such that
$g_1,\ldots,g_n$ generate the unit ideal in $S$
(in other words the standard opens of $\text{Spec}(S)$ associated
to $g_1,\ldots,g_n$ cover all of $\text{Spec}(S)$).

\medskip\noindent
Suppose that $D(g) \subset \text{Spec}(S')$
is contained in the image. Then $D(g) \subset \bigcup D(g_i)$.
In other words, $g_1,\ldots,g_n$ generate the unit ideal of
$S'_g$. Note that $S'_{gg_i} \cong S_{gg_i}$ by our choice
of $g_i$. Hence $S'_g \cong S_g$ by Lemma \ref{lemma-cover}.

\medskip\noindent
We construct a finite algebra $S'' \subset S'$ as
in (3). To do this note that each $S'_{g_i} \cong S_{g_i}$ 
is a finite type $R$-algebra. For each $i$ pick
some elements $y_{ij} \in S'$ such that each
$S'_{g_i}$ is generated as $R$-algebra by $1/g_i$
and the elements $y_{ij}$. Then set $S''$
equal to the $R$-algebra generated by all $g_i$
and all the $y_{ij}$. Details left to the reader.
\end{proof}








































\section{Dimension of fibres}
\label{section-dimension-fibres}

\noindent
We study the behaviour of dimensions of fibres, using 
Zariski's main theorem. Recall that we defined the
dimension $\dim_x(X)$ of a topological space $X$ at a point $x$
in Topology, Definition \ref{topology-definition-Krull}.

\begin{definition}
Suppose that $R \to S$ is of finite type, and let
$\mathfrak q \subset S$ be a prime lying over a prime
$\mathfrak p$ of $R$.
We define the {\it relative dimension
of $S/R$ at $\mathfrak q$}, denoted
$\dim_{\mathfrak q}(S/R)$, to be the dimension
of $\text{Spec}(S \otimes_R \kappa(\mathfrak p))$
at the point corresponding to $\mathfrak q$. We let
$\dim(S/R)$ be the supremum of $\dim_{\mathfrak q}(S/R)$
over all $\mathfrak q$. This is called the
{\it relative dimension of} $S/R$.
\end{definition}

\noindent
In particular, $R \to S$ is quasi-finite at $\mathfrak q$ if
and only if $\dim_{\mathfrak q}(S/R) = 0$.

\begin{lemma}
\label{lemma-quasi-finite-over-polynomial-algebra}
Let $R \to S$ be a finite type ring map.
Let $\mathfrak q \subset S$ be a prime.
Suppose that $\dim_{\mathfrak q}(S/R) = n$.
There exists a $g \in S$, $g \not\in \mathfrak q$
such that $S_g$ is quasi-finite over a
polynomial algebra $R[t_1,\ldots, t_n]$.
\end{lemma}

\begin{proof}
The ring $\overline{S} = S \otimes_R \kappa(\mathfrak p)$ is
of finite type over $\kappa(\mathfrak p)$, and hence Noetherian
(see Lemma \ref{lemma-obvious-Noetherian}).
Let $\{ \mathfrak q_j \}$ be the finite set of minimal primes
of this ring, see Lemma \ref{lemma-Noetherian-irreducible-components}.
Let $\overline{\mathfrak q}$ be the prime of $\overline{S}$
corresponding to $\mathfrak q$.
By definition, if $\dim(\overline{S}/\mathfrak q_i) > n$,
then $\overline{\mathfrak q} \not\in V(\mathfrak q_i)$.
Hence $\cup_{\dim V(\mathfrak q_i) > n} V(\mathfrak q_i)$
is a closed set not containing $\overline{\mathfrak q}$.
Since the topology on $\text{Spec}(\overline{S})$ is
induced from the topology on $\text{Spec}(S)$ (see
Remark \ref{remark-fundamental-diagram}), we can find
a $g \in S$, $g \not \in \mathfrak q$ such that
$g \in \mathfrak q_i$ whenever $\dim V(\mathfrak q_i) > n$.
Thus, after replacing $S$ by $S_g$ we see that 
all irreducible components of $\text{Spec}(\overline{S})$
have dimension $\leq n$, and at least one of them has dimension $n$.

\medskip\noindent
Next, write $S = R[x_1,\ldots,x_N]/I$ for some ideal $I$. 
By Lemma \ref{lemma-Noether-normalization} there exist
elements $y_1, \ldots, y_n$ in $S$ such that the map
$R[t_1,\ldots, t_n] \to S$, $t_i \mapsto y_i$ has the property
that $\kappa(\mathfrak p)[t_1\ldots, t_n] \to \overline{S}$
is finite. In particular, $S$ is quasi-finite over $R[t_1,\ldots,t_n]$
at $\mathfrak q$. Hence, by Lemma \ref{lemma-quasi-finite-open}
we may replace $S$ by $S_g$ for some $g\in S$, $g \not \in \mathfrak q$
such that $R[t_1,\ldots,t_n] \to S$ is quasi-finite.
\end{proof}

\begin{lemma}
\label{lemma-dimension-quasi-finite-over-polynomial-algebra}
Let $k$ be a field, and let
$k[t_1,\ldots,t_n] \subset S$ be
quasi-finite. Then $\dim(S) \leq n$.
\end{lemma}

\begin{proof}
By Proposition \ref{proposition-main-theorem} we may assume
that $S$ is integral over $k[t_1,\ldots,t_n]$. 
The result follows from Lemmas \ref{lemma-integral-dim-up}
and \ref{lemma-dim-affine-space}.
\end{proof}

\begin{lemma}
\label{lemma-dimension-fibres-bounded-open-upstairs}
Let $R \to S$ be a finite type ring map.
Let $\mathfrak q \subset S$ be a prime.
Suppose that $\dim_{\mathfrak q}(S/R) = n$.
There exists an open neighbourhood $V$ of $\mathfrak q$
in $\text{Spec}(S)$ such that
$\dim_{\mathfrak q'}(S/R) \leq n$ for all $\mathfrak q' \in V$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-quasi-finite-over-polynomial-algebra}
we see that we may assume that $S$ is quasi-finite over
a polynomial algebra $R[t_1,\ldots,t_n]$. Considering
the fibres, we reduce to
Lemma \ref{lemma-dimension-quasi-finite-over-polynomial-algebra}.
\end{proof}


















\section{Limits and maps of finite presentation}
\label{section-limits-flat}

\noindent
In this section we prove some preliminary lemmas
dealing with absolute Noetherian reduction.

\begin{definition}
\label{definition-essentially-finite-p-t}
Let $R \to S$ be a ring map.
\begin{enumerate}
\item We say $R \to S$ is {\it of finite type} if there exist
$n \in \mathbf{N}$, an ideal $I \subset R[x_1,\ldots,x_n]$ and
an isomorphism of $R$-algebras $S \cong R[x_1,\ldots,x_n]/I$.
\item We say $R \to S$ is {\it of finite presentation} if there
exist integers $n,m \in \mathbf{N}$ and polynomials
$f_1,\ldots,f_m \in R[x_1,\ldots,x_n]$
and an isomorphism of $R$-algebras
$S \cong R[x_1,\ldots,x_n]/(f_1,\ldots,f_m)$.
\item We say that $R \to S$ is {\it essentially of finite type} if
$S$ is the localization of an $R$-algebra of finite type.
\item We say that $R \to S$ is {\it essentially of finite presentation} if
$S$ is the localization of an $R$-algebra of finite presentation.
\end{enumerate}
\end{definition}

\noindent
In the following we will encounter the following types of
objects repeatedly. Let $(\Lambda, \geq)$ a partially
ordered set. A system of rings over $\Lambda$ is given by
a ring $R_\lambda$ for every $\lambda \in \Lambda$,
and a morphism $R_\lambda \to R_\mu$ whenever $\lambda \leq \mu$.
These morphisms have to satisfy the rule that
$R_\lambda \to R_\mu \to R_\nu$ is equal to the map
$R_\lambda \to R_\nu$ for all $\lambda \leq \mu \leq \nu$.
See Categories, subsection \ref{categories-subsection-posets-limits}.
We will often assume that $(I, \leq)$ is a directed
partially ordered set.
Recall that the colimit $\text{colim}_\lambda R_\lambda$
is sometimes called a ``directed limit'' in this case
(but we will not use this terminology).

\begin{lemma}
\label{lemma-limit-essentially-finite-type}
Suppose $R \to S$ is a local ring map of local rings.
Assume that $S$ is essentially of finite type over $R$.
Then there exists a directed set $(\Lambda, \leq)$, and
a system of local ring maps $R_\lambda \to S_\lambda$
of local rings such that
\begin{enumerate}
\item The colimit of the system $R_\lambda \to S_\lambda$
is equal to $R \to S$.
\item Each $R_\lambda$ is essentially of finite type
over $\mathbf{Z}$.
\item Each $S_\lambda$ is essentially of finite type
over $R_\lambda$.
\item For each $\lambda \leq \mu$ the map
$S_\lambda \otimes_{R_\lambda} R_\mu \to S_\mu$
presents $S_\mu$ as the localization of a quotient
of $S_\lambda \otimes_{R_\lambda} R_\mu$.
\end{enumerate}
\end{lemma}

\begin{proof}
Denote $\varphi : R  \to S$ the ring map.
Let $\mathfrak m \subset R$ be the maximal ideal
of $R$ and let $\mathfrak n \subset S$ be the maximal
ideal of $S$. Let $x_1,\ldots,x_n \in S$ be elements such that
$S$ is a localization of the sub $R$-algebra of $S$
generated by $x_1,\ldots, x_n$. In other words, $S$
is a quotient of a localization of the polynomial ring
$R[x_1,\ldots,x_n]$.

\medskip\noindent
Let $\Lambda = \{ A \subset R \mid \# A < \infty\}$
be the set of finite subsets of $R$. As partial
ordering we take the inclusion relation. For each
$\lambda = A \in \Lambda$ we let $R'_\lambda$ be
the sub $\mathbf{Z}$-algebra generated by
$a \in A$, and we let $S'_\lambda$ be the sub
$\mathbf{Z}$-algebra generated by $\varphi(a)$, $a \in A$
and the elements $x_1,\ldots, x_n$. Let $R_\lambda$ be
the localization of $R'_\lambda$ at the prime ideal
$R'_\lambda \cap \mathfrak m$ and let
$S_\lambda$ be the localization of $S'_\lambda$ at
the prime ideal $S'_\lambda \cap \mathfrak n$.
In a picture
$$
\xymatrix{
\varphi(A) \coprod \{x_i\} \ar[r] &
S'_\lambda \ar[r] &
S_\lambda \ar[r] &
S \\
A \ar[r] \ar[u] &
R'_\lambda \ar[r] \ar[u] &
R_\lambda \ar[r] \ar[u] &
R \ar[u]
}
$$
It is clear that if $A \subset B$ corresponds to
$\lambda \leq \mu$ in $\Lambda$, then there are
canonical maps $R_\lambda \to R_\mu$, and $S_\lambda \to S_\mu$
and we obtain a system over the directed set $\Lambda$.

\medskip\noindent
The assertion that $R = \text{colim} R_\lambda$ is clear
because all the maps $R_\lambda \to R$ are injective and
any element of $R$ eventually is in the image. The same
argument works for $S = \text{colim} S_\lambda$. 
Assertions (2), (3) are true by construction. 
The final assertion holds because clearly
the maps $S'_\lambda \otimes_{R'_\lambda} R'_\mu
\to S'_\mu$ are surjective.
\end{proof}

\begin{lemma}
\label{lemma-limit-essentially-finite-presentation}
Suppose $R \to S$ is a local ring map of local rings.
Assume that $S$ is essentially of finite presentation over $R$.
Then there exists a directed set $(\Lambda, \leq)$, and
a system of local ring maps $R_\lambda \to S_\lambda$
of local rings such that
\begin{enumerate}
\item The colimit of the system $R_\lambda \to S_\lambda$
is equal to $R \to S$.
\item Each $R_\lambda$ is essentially of finite type
over $\mathbf{Z}$.
\item Each $S_\lambda$ is essentially of finite type
over $R_\lambda$.
\item For each $\lambda \leq \mu$ the map
$S_\lambda \otimes_{R_\lambda} R_\mu \to S_\mu$
presents $S_\mu$ as the localization of
$S_\lambda \otimes_{R_\lambda} R_\mu$
at a prime ideal.
\end{enumerate}
\end{lemma}

\begin{proof}
Choose an isomorphism
$\Phi : (R[x_1,\ldots, x_n]/I)_{\mathfrak q} \to S$
where $I \subset R[x_1,\ldots,x_n]$ is a finitely generated ideal,
and $\mathfrak q \subset R[x_1,\ldots, x_n]/I$ is a prime.
(Note that the pull back of $\mathfrak q$ to $R$
is equal to the maximal ideal $\mathfrak m$ of $R$.)
We also choose generators $f_1,\ldots, f_m \in I$ for the ideal $I$.
Write $R$ in any way as a colimit $R = \text{colim} R_\lambda$
over a directed set $(\Lambda, \leq )$, with each $R_\lambda$
local and essentially of finite type over $\mathbf{Z}$.
There exists some $\lambda_0 \in \Lambda$ such that $f_j$ is the image
of some $f_{j, \lambda_0} \in R_{\lambda_0}[x_1,\ldots,x_n]$.
For all $\lambda \geq \lambda_0$ denote
$f_{j, \lambda} \in R_{\lambda}[x_1,\ldots,x_n]$ the image
of $f_{j, \lambda_0}$. Thus we obtain a system of ring maps
$$
R_\lambda[x_1,\ldots,x_n]/(f_{1,\lambda}, \ldots, f_{n,\lambda})
\to
R[x_1,\ldots, x_n]/(f_1,\ldots, f_n) \to S
$$
Set $\mathfrak q_\lambda$ the inverse image of $\mathfrak q$.
Set $S_\lambda =
(R_\lambda[x_1,\ldots,x_n]/(f_{1,\lambda}, \ldots, f_{n,\lambda}))_{\mathfrak 
q_\lambda}$. We leave it to the reader to see that this works.
\end{proof}

\begin{remark}
\label{remark-suitable-systems-limits}
This remark will not be used in the text.
Suppose that $R \to S$ is a local homomorphism
of local rings, which is essentially of finite type.
Take any system $(\Lambda, \leq)$, $R_\lambda \to S_\lambda$
with the properties listed in
Lemma \ref{lemma-limit-essentially-finite-type}.
Choose an isomorphism
$\Phi : (R[x_1,\ldots, x_n]/I)_{\mathfrak q} \to S$
where $I \subset R[x_1,\ldots,x_n]$ is a finitely generated ideal,
and $\mathfrak q \subset R[x_1,\ldots, x_n]/I$ is a prime.
(Note that the pull back of $\mathfrak q$ to $R$
is equal to the maximal ideal $\mathfrak m$ of $R$.)
We also choose generators $f_1,\ldots, f_m \in I$ for
the ideal $I$.

\medskip\noindent
Next, we use that $S$ is the colimit of the $S_\lambda$
and that $R$ is the colimit of the $R_\lambda$.
Namely, this implies that we may successively choose
$\lambda_1, \lambda_2, \ldots \in \Lambda$,
$\lambda_1 \leq \lambda_2 \leq \ldots$ large enough such that
\begin{enumerate}
\item All coefficients of each $f_j$ lie in the image of
$R_{\lambda_1}$.
\item Pick $f_{j, \lambda_1} \in R_{\lambda_1}[x_1,\ldots, x_n]$
mapping to $f_j$. Denote $f_{j, \lambda} \in R_\lambda[x_1,\ldots, x_n]$
the image of $f_{j, \lambda_1}$ for all $\lambda \geq \lambda_1$.
\item The images $\Phi(x_i) \in S$ are in the image of
$S_{\lambda_2} \to S$.
\item Pick $x_{i, \lambda_2} \in S_{\lambda_2}$
and denote $x_{i, \lambda} \in S_{\lambda}$ the image of
$x_{i, \lambda_2}$ for all $\lambda \geq \lambda_2$.
\item All the elements
$f_{j, \lambda_3}(x_{1,\lambda_3},\ldots, x_{n, \lambda_3}) = 0$.
This we can do because the image in $S$ is zero.
Thus we will also have
$f_{j, \lambda}(x_{1,\lambda},\ldots, x_{n, \lambda}) = 0$
for all $\lambda \geq \lambda_3$.
\item Pick $y_1,\ldots,y_t \in S_{\lambda_3}$
such that $S_{\lambda_3}$ is a localization of the
$R_{\lambda_3}$-subalgebra generated by $y_1,\ldots,y_t$.
Denote $y_{k, \lambda}$ the image of $y_k$ in $S_\lambda$
for all $\lambda \geq \lambda_3$.
Note that by property (4) of
Lemma \ref{lemma-limit-essentially-finite-type}
the elements $y_{k, \lambda}$ essentially generate
$S_{\lambda}$ over $R_\lambda$ for all $\lambda \geq \lambda_3$.
\item The elements $y_{k, \lambda_4}$ are in the
localization of the $R_{\lambda_4}$-subalgebra generated
by $x_{i, \lambda_4}$. We can find $\lambda_4$ because it is
true in $S$. Thus for all $\lambda \geq \lambda_4$ the
ring $S_\lambda$ is the localization of the $R_\lambda$-subalgebra
generated by $x_{i, \lambda}$. In other words
there is a map
$$
R_\lambda[x_1,\ldots,x_n]/(f_{1, \lambda},\ldots,f_{m, \lambda})
\longrightarrow
S_\lambda
$$
which is surjective after localization.
\end{enumerate}
However, it is in general {\it not} possible to prove that
the maps displayed above are localizations. A counter example
is given by the ring
$R = \mathbf{Z}[z, y_1, y_2, \ldots]/(y_i^2 - zy_{i+1})$,
$S = R/zR$ and the system parametrized by $\Lambda = \mathbf{N}$
with $R_n = \mathbf{Z}[z, y_1, y_2, \ldots, y_n]/(y_i^2 - zy_{i+1}, 
i=1,\ldots,n-1)$ and $S_n = R_n/(z, x_n^2)$.
\end{remark}

\begin{lemma}
\label{lemma-limit-module-essentially-finite-presentation}
Suppose $R \to S$ is a local ring map of local rings.
Assume that $S$ is essentially of finite presentation over $R$.
Let $M$ be a finitely presented $S$-module.
Then there exists a directed set $(\Lambda, \leq)$, and
a system of local ring maps $R_\lambda \to S_\lambda$
of local rings together with $S_\lambda$-modules $M_\lambda$,
such that
\begin{enumerate}
\item The colimit of the system $R_\lambda \to S_\lambda$
is equal to $R \to S$. The colimit of the system $M_\lambda$
is $M$.
\item Each $R_\lambda$ is essentially of finite type
over $\mathbf{Z}$.
\item Each $S_\lambda$ is essentially of finite type
over $R_\lambda$.
\item Each $M_\lambda$ is finite over $S_\lambda$.
\item For each $\lambda \leq \mu$ the map
$S_\lambda \otimes_{R_\lambda} R_\mu \to S_\mu$
presents $S_\mu$ as the localization of
$S_\lambda \otimes_{R_\lambda} R_\mu$
at a prime ideal.
\item For each $\lambda \leq \mu$ the map
$M_\lambda \otimes_{S_\lambda} S_\mu \to S_\mu$
is an isomorphism.
\end{enumerate}
\end{lemma}

\begin{proof}
As in the proof of Lemma \ref{lemma-limit-essentially-finite-presentation}
we may first write $R = \text{colim} R_\lambda$ as a directed colimit
of local $\mathbf{Z}$-algebras which are essentially of finite type.
Next, we may assume that for some $\lambda_1 \in \Lambda$ there
exist $f_{j, \lambda_1} \in R_{\lambda_1}[x_1,\ldots,x_n]$
such that
$$
S =
\text{colim}_{\lambda \geq \lambda_1}\ S_\lambda, \text{ with }
S_\lambda = 
(R_\lambda[x_1,\ldots,x_n]/(f_{1,\lambda},\ldots,f_{m,\lambda}))_{\mathfrak 
q_\lambda}
$$
Choose a presentation
$$
S^{\oplus s} \to S^{\oplus t} \to M \to 0
$$
of $M$ over $S$. Let $A \in \text{Mat}(t\times s, S)$ be
the matrix of the presentation. For some $\lambda_2 \in \Lambda$,
$\lambda_2 \geq \lambda_1$
we can find a matrix $A_{\lambda_2} \in \text{Mat}(t\times s, S_{\lambda_2})$
which maps to $A$. For all $\lambda \geq \lambda_2$ we let
$M_\lambda = \text{Coker}(S_\lambda^{\oplus s} \xrightarrow{A_\lambda}
S_\lambda^{\oplus t})$. We leave it to the reader to see that
this works.
\end{proof}

\begin{lemma}
\label{lemma-colimit-eventually-flat}
Let $R \to S$, $M$ be as in the previous
Lemma \ref{lemma-limit-module-essentially-finite-presentation}.
Assume that $M$ is flat over $R$.
Then for some $\lambda \in \Lambda$ the module
$M_\lambda$ is flat over $R_\lambda$.
\end{lemma}

\begin{proof}
Pick some $\lambda \in \Lambda$ and consider
$$
\text{Tor}_1^{R_\lambda}(M_\lambda, R_\lambda/\mathfrak m_\lambda)
=
\text{Ker}(\mathfrak m_\lambda \otimes_{R_\lambda} M_\lambda
\to M_\lambda).
$$
See Remark \ref{remark-Tor-ring-mod-ideal}. The right hand side
shows that this is a finitely generated $S_\lambda$-module (because
$S_\lambda$ is Noetherian and the modules in question are finite).
Let $\xi_1,\ldots,\xi_n$ be generators.
Because $M$ is flat over $R$ we
have that $0 = \text{Ker}(\mathfrak m_\lambda R \otimes_R M \to M)$.
Since $\otimes$ commutes with colimits we see there exists
a $\lambda' \geq \lambda$ such that each $\xi_i$ maps to
zero in
$\mathfrak m_{\lambda}R_{\lambda'} \otimes_{R_{\lambda'}} M_{\lambda'}$.
Hence we see that
$$
\text{Tor}_1^{R_\lambda}(M_\lambda, R_\lambda/\mathfrak m_\lambda)
\longrightarrow
\text{Tor}_1^{R_{\lambda'}}(M_\lambda,
R_{\lambda'}/\mathfrak m_{\lambda}R_{\lambda'})
$$
is zero. Note that
$M_\lambda \otimes_{R_\lambda} R_\lambda/\mathfrak m_\lambda$
is flat over $R_\lambda/\mathfrak m_\lambda$ because this last
ring is a field. Hence we may apply Lemma
\ref{lemma-another-variant-local-criterion-flatness}
to get that $M_{\lambda'}$ is flat over $R_\lambda$.
\end{proof}

\begin{lemma}
\label{lemma-limit-finite-type}
Suppose $R \to S$ is a ring map.
Assume that $S$ is of finite type over $R$.
Then there exists a directed set $(\Lambda, \leq)$, and
a system of ring maps $R_\lambda \to S_\lambda$
such that
\begin{enumerate}
\item The colimit of the system $R_\lambda \to S_\lambda$
is equal to $R \to S$.
\item Each $R_\lambda$ is of finite type
over $\mathbf{Z}$.
\item Each $S_\lambda$ is of finite type
over $R_\lambda$.
\item For each $\lambda \leq \mu$ the map
$S_\lambda \otimes_{R_\lambda} R_\mu \to S_\mu$
presents $S_\mu$ as a quotient
of $S_\lambda \otimes_{R_\lambda} R_\mu$.
\end{enumerate}
\end{lemma}

\begin{proof}
This is the non-local version of
Lemma \ref{lemma-limit-essentially-finite-type}.
Proof is similar and left to the reader.
\end{proof}

\begin{lemma}
\label{lemma-limit-finite-presentation}
Suppose $R \to S$ is a ring map.
Assume that $S$ is of finite presentation over $R$.
Then there exists a directed set $(\Lambda, \leq)$, and
a system of ring maps $R_\lambda \to S_\lambda$
such that
\begin{enumerate}
\item The colimit of the system $R_\lambda \to S_\lambda$
is equal to $R \to S$.
\item Each $R_\lambda$ is of finite type
over $\mathbf{Z}$.
\item Each $S_\lambda$ is of finite type
over $R_\lambda$.
\item For each $\lambda \leq \mu$ the map
$S_\lambda \otimes_{R_\lambda} R_\mu \to S_\mu$
is an isomorphism.
\end{enumerate}
\end{lemma}

\begin{proof}
This is the non-local version of
Lemma \ref{lemma-limit-essentially-finite-presentation}.
Proof is similar and left to the reader.
\end{proof}

\begin{lemma}
\label{lemma-limit-module-finite-presentation}
Suppose $R \to S$ is a ring map.
Assume that $S$ is of finite presentation over $R$.
Let $M$ be a finitely presented $S$-module.
Then there exists a directed set $(\Lambda, \leq)$, and
a system of ring maps $R_\lambda \to S_\lambda$
together with $S_\lambda$-modules $M_\lambda$,
such that
\begin{enumerate}
\item The colimit of the system $R_\lambda \to S_\lambda$
is equal to $R \to S$. The colimit of the system $M_\lambda$
is $M$.
\item Each $R_\lambda$ is of finite type
over $\mathbf{Z}$.
\item Each $S_\lambda$ is of finite type
over $R_\lambda$.
\item Each $M_\lambda$ is finite over $S_\lambda$.
\item For each $\lambda \leq \mu$ the map
$S_\lambda \otimes_{R_\lambda} R_\mu \to S_\mu$
is an isomorphism.
\item For each $\lambda \leq \mu$ the map
$M_\lambda \otimes_{S_\lambda} S_\mu \to S_\mu$
is an isomorphism.
\end{enumerate}
In particular, for every $\lambda \in \Lambda$ we have
$$
M = M_\lambda \otimes_{S_\lambda} S
= M_\lambda \otimes_{R_\lambda} R.
$$
\end{lemma}

\begin{proof}
This is the non-local version of
Lemma \ref{lemma-limit-module-essentially-finite-presentation}.
Proof is similar and left to the reader.
\end{proof}

\begin{lemma}
\label{lemma-finite-presentation-independent}
Suppose $R \to S$ is a ring map of finite presentation.
Let $\Phi : R[y_1,\ldots, y_t] \to S$ be any surjective map.
Then $\text{Ker}(\Phi)$ is a finitely generated ideal.
\end{lemma}

\begin{proof}
Write $R = \text{colim} R_\lambda$ and $S = \text{colim} S_\lambda$
as in Lemma \ref{lemma-limit-finite-presentation}.
Pick $\lambda_1 \in \Lambda$ and write
$S_{\lambda_1} = R_{\lambda_1}[x_1,\ldots,x_n]/
(f_{1,\lambda_1},\ldots,f_{m,\lambda_1})$. For $\lambda \geq \lambda_1$
denote $f_{j, \lambda}$ the image of $f_{j, \lambda_1}$ in
$R_\lambda[x_1,\ldots,x_n]$. Thus we have
$S_{\lambda} = R_{\lambda}[x_1,\ldots,x_n]/
(f_{1,\lambda},\ldots,f_{m,\lambda})$. Pick $\lambda_2 \geq \lambda_1$
such that (a) $\Phi(y_1),\ldots,\Phi(y_t)$ are in the image of
$S_{\lambda_2} \to S$, and (b) the images of $x_1,\ldots,x_n$
are in the image of $\Phi : R_{\lambda_2}[y_1,\ldots,y_t] \to S$.
Choose $g_{1,\lambda_2},\ldots,g_{t, \lambda_2} \in 
R_{\lambda_2}[x_1,\ldots,x_n]$ which map to $\Phi(y_1),\ldots,\Phi(y_t)$.
Also choose polynomials
$h_{1,\lambda_2},\ldots, h_{n,\lambda_2} \in R_{\lambda_2}[y_1,\ldots,y_t]$
mapping to the images of $x_1,\ldots,x_n$.
For any $\lambda \geq \lambda_2$ we denote 
$g_{i, \lambda} \in R_{\lambda}[x_1,\ldots,x_n]$
and
$h_{i, \lambda} \in R_{\lambda}[y_1,\ldots,y_t]$
the images as before. Let
$$
I_{\lambda_2} = \text{Ker}\Big(
R_{\lambda_2}[y_1,\ldots,y_t]
\xrightarrow{y_i \mapsto g_{i, \lambda_2}}
R_{\lambda_2}[x_1,\ldots,x_n]/(f_{1,\lambda_2},\ldots,f_{m,\lambda_2})
= S_{\lambda_2}
\Big)
$$
Clearly $I_{\lambda_2}$ is finitely generated. The existence of
$h_{i, \lambda_2}$ implies that 
$$
0 \to I_{\lambda_2} \to R_{\lambda_2}[y_1,\ldots,y_t]
\to S_{\lambda_2} \to 0
$$
is exact. Hence for all $\lambda \geq \lambda_2$ we see
that
$$
I_{\lambda_2} \otimes_{R_{\lambda_2}} R_\lambda
\to 
R_{\lambda}[y_1,\ldots,y_t]
\to S_{\lambda} \to 0
$$
is exact. This proves that $\text{Ker}(\Phi)$
is a quotient of $\text{colim}_\lambda\ 
I_{\lambda_2} \otimes_{R_{\lambda_2}} R_\lambda $ and hence
is finitely generated.
\end{proof}









\section{Openness of the flat locus}
\label{section-open-flat}


\begin{lemma}
\label{lemma-CM-dim-finite-type}
Let $k$ be a field. Let $S$ be a finite type
$k$ algebra. Let $f_1, \ldots, f_i$ be elements
of $S$. Assume that $S$ is Cohen-Macaulay and
equidimensional of dimension $d$, and that
$\dim V(f_1,\ldots,f_i) \leq d - i$. Then equality
holds and $f_1, \ldots, f_i$ forms a regular
sequence in $S_{\mathfrak q}$ for every prime
in $V(f_1,\ldots,f_i)$.
\end{lemma}

\begin{proof}
This follows from the material in the section
on Cohen-Macaulay modules and the fact that
dimensions behave well in finite type algebras
over fields. FIXME.
\end{proof}



\begin{lemma}
\label{lemma-open-regular-sequence}
Suppose that $R \to S$ is a ring map which is
finite type, flat. Let $d$ be an integer
such that all fibres
$S \otimes_R \kappa(\mathfrak p)$ are
Cohen-Macaulay and equidimensional
of dimension $d$. Let $f_1,\ldots,f_i$
be elements of $S$. The set
$$
\{ \mathfrak q \in V(f_1,\ldots,f_i)
\mid f_1, \ldots, f_i 
\text{ form a regular sequence on }
S_{\mathfrak q}/\mathfrak p S_{\mathfrak q}
\}
$$
is open in $V(f_1,\ldots,f_i)$.
\end{lemma}

\begin{proof}
Write $\overline{S} = S/(f_1,\ldots,f_i)$.
Suppose $\mathfrak q$ is an element of the set defined in the
lemma. Then $\dim_{\mathfrak q}(\overline{S}/R) = d - i$.
FIXME: add references. By Lemma
\ref{lemma-dimension-fibres-bounded-open-upstairs}
we have $\dim_{\mathfrak q'}(\overline{S}/R) \leq d - i$
for all $\mathfrak q' \in V(f_1,\ldots, f_i) = \text{Spec}(\overline{S})$
in a neighbourhood of $\mathfrak q$. Thus after replacing
$S$ by $S_g$ for some $g \in S$, $g \not \in \mathfrak q$
we may assume that the inequality holds for all
$\mathfrak q'$. The result follows from Lemma
\ref{lemma-CM-dim-finite-type}.
\end{proof}

\begin{lemma}
\label{lemma-exact-on-fibres-open}
Let $R \to S$ is a ring map.
Consider a finite homological complex of 
finite free $S$-modules:
$$
F_{\bullet} :
0
\to
S^{n_e}
\xrightarrow{\varphi_e}
S^{n_{e-1}}
\xrightarrow{\varphi_{e-1}}
\ldots
\xrightarrow{\varphi_{i+1}}
S^{n_i}
\xrightarrow{\varphi_i}
S^{n_{i-1}}
\xrightarrow{\varphi_{i-1}}
\ldots
\xrightarrow{\varphi_1}
S^{n_0}
$$
For every prime $\mathfrak q$ of $S$ consider the
complex $\overline{F}_{\bullet, \mathfrak q} =
F_{\bullet, \mathfrak q} \otimes_R \kappa(\mathfrak p)$
where $\mathfrak p$ is inverse image of $\mathfrak q$ in $R$.
Assume there exists an integer $d$ such
that $R \to S$ is finite type, flat
with fibres $S \otimes_R \kappa(\mathfrak p)$
Cohen-Macaulay of dimension $d$.
The set
$$
\{\mathfrak q \in \text{Spec}(S) \mid
\overline{F}_{\bullet, \mathfrak q}\text{ is exact}\}
$$
is open in $\text{Spec}(S)$.
\end{lemma}

\begin{proof}
Let $\mathfrak q$ be an element of the set defined in the lemma.
We are going to use Proposition \ref{proposition-what-exact}
to show there exists a $g \in S$, $g \not \in \mathfrak q$
such that $D(g)$ is contained in the set defined in the lemma.
In other words, we are going to show that after replacing $S$
by $S_g$, the set of the lemma is all of $\text{Spec}(S)$.
Thus during the proof we will, finitely often, replace
$S$ by such a localization.
Recall that Proposition \ref{proposition-what-exact}
characterizes exactness of complexes
in terms of ranks of the maps $\varphi_i$ and the ideals
$I(\varphi_i)$, in case the ring is local. We first address
the rank condition. Set
$r_i = n_i - n_{i+1} + \ldots + (-1)^{e - i} n_e$.
Note that $r_i + r_{i+1} = n_i$ and note that
$r_i$ is the expected rank of $\varphi_i$ (in the
exact case).

\medskip\noindent
By Lemma \ref{lemma-complex-exact-mod} we see that if
$\overline{F}_{\bullet, \mathfrak q}$ is exact, then
the localization $F_{\bullet, \mathfrak q}$ is exact.
In particular the complex $F_\bullet$ becomes
exact after localizing by an element
$g \in S$, $g \not \in \mathfrak q$. In this case
Proposition \ref{proposition-what-exact} applied
to all localizations of $S$ at prime ideals
implies that all $(r_i + 1) \times (r_i + 1)$-minors
of $\varphi_i$ are zero. Thus we see that the rank of
of $\varphi_i$ is at most $r_i$.

\medskip\noindent
Let $I_i \subset S$ denote the ideal generated
by the $r_i \times r_i$-minors of the matrix
of $\varphi_i$. By Proposition \ref{proposition-what-exact}
the complex $\overline{F}_{\bullet, \mathfrak q}$ is exact
if and only if for every $1 \leq i \leq e$ we have
either $(I_i)_{\mathfrak q} = S_{\mathfrak q}$ or
$(I_i)_{\mathfrak q}$ contains a $S_{\mathfrak q}/\mathfrak p
S_{\mathfrak q}$-regular sequence of length $i$.
Namely, by our choice of $r_i$ above and by the
bound on the ranks of the $\varphi_i$ this is the
only way the conditions of Proposition \ref{proposition-what-exact}
can be satisfied.

\medskip\noindent
If $(I_i)_{\mathfrak q} = S_{\mathfrak q}$, then after localizing $S$ at
some element $g \not\in \mathfrak q$ we may assume that
$I_i = S$. Clearly, this is an open condition.

\medskip\noindent
If $(I_i)_{\mathfrak q} \not = S_{\mathfrak q}$, then we have
a sequence $f_1, \ldots, f_i \in (I_i)_{\mathfrak q}$ which
form a regular sequence in $S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}$.
Note that for any prime $\mathfrak q' \subset S$ such that
$(f_1, \ldots, f_i) \not \subset \mathfrak q'$ we have
$(I_i)_{\mathfrak q'} = S_{\mathfrak q'}$.
Thus the result follows from Lemma \ref{lemma-open-regular-sequence}.
\end{proof}


\begin{theorem}
Let $R$ be a ring. Let $R \to S$ be a ring map of finite
presentation. Let $M$ be a finitely presented $S$-module.
The set
$$
\{ \mathfrak q \in \text{Spec}(S) \mid
M_{\mathfrak q}\text{ is flat over }R\}
$$
is open in $\text{Spec}(S)$.
\end{theorem}

\begin{proof}
Let $\mathfrak q \in \text{Spec}(S)$ be a prime.
Let $\mathfrak p \subset R$ be the inverse image of $\mathfrak q$ in $R$.
Note that $M_{\mathfrak q}$ is flat over $R$ if and only if 
it is flat over $R_{\mathfrak p}$. 
Let us assume that $M_{\mathfrak q}$ is flat over $R$.
We claim that there exists a $g \in S$, $g \not \in \mathfrak q$
such that $M_g$ is flat over $R$.

\medskip\noindent
We first reduce to the case where $R$ and $S$ are
of finite type over $\mathbf{Z}$.
Choose a directed partially ordered set $\Lambda$ and
a system $(R_\lambda \to S_\Lambda, M_\lambda)$
as in Lemma \ref{lemma-limit-module-finite-presentation}.
Set $\mathfrak p_\lambda$ equal to the inverse image of
$\mathfrak p$ in $R_\lambda$. 
Set $\mathfrak q_\lambda$ equal to the inverse image of
$\mathfrak q$ in $S_\lambda$.
Then the system
$$
((R_\lambda)_{\mathfrak p_\lambda},
(S_\lambda)_{\mathfrak q_\lambda},
(M_\lambda)_{\mathfrak q_{\lambda}})
$$
is a system as in 
Lemma \ref{lemma-limit-module-essentially-finite-presentation}.
Hence by Lemma \ref{lemma-colimit-eventually-flat}
we see that for some $\lambda$ the module
$M_\lambda$ is flat over $R_\lambda$ at the prime
$\mathfrak q_{\lambda}$. Suppose we
can prove our claim for the system
$(R_\lambda \to S_\lambda, M_\lambda, \mathfrak q_{\lambda})$.
In other words, suppose that we can find a $g \in S_\lambda$,
$g \not\in \mathfrak q_\lambda$ such that $(M_\lambda)_g$
is flat over $R_\lambda$. By Lemma \ref{lemma-limit-module-finite-presentation}
we have $M = M_\lambda \otimes_{R_\lambda} R$ and hence
also $M_g = (M_\lambda)_g \otimes_{R_\lambda} R$. Thus by
Lemma \ref{lemma-flat-base-change} we deduce the claim
for the system $(R \to S, M, \mathfrak q)$.

\medskip\noindent
At this point we may assume that $R$ and $S$ are of finite type
over $\mathbf{Z}$. We may write $S$ as a quotient of a
polynomial ring $R[x_1,\ldots,x_n]$. Of course, we may replace
$S$ by $R[x_1,\ldots,x_n]$ and assume that $S$ is a polynomial
ring over $R$. In particular we see that $R \to S$ is flat
and all fibres rings $S \otimes_R \kappa(\mathfrak p)$
have global dimension $n$.

\medskip\noindent
Choose a resolution $F_\bullet$ of $M$ over $S$ with each
$F_i$ finite free, see Lemma \ref{lemma-resolution-by-finite-free}.
Let $K_n = \text{Ker}(F_{n-1} \to F_{n-2})$. Note that
$(K_n)_{\mathfrak q}$ is flat over $R$, since each $F_i$
is flat over $R$ and by assumption on $M$, see Lemma
\ref{lemma-flat-ses}. In addition, the sequence
$$
0 \to
K_n/\mathfrak p K_n \to
F_{n-1}/ \mathfrak p F_{n-1} \to
\ldots \to
F_0 / \mathfrak p F_0 \to
M/\mathfrak p M \to
0
$$
is exact upon localizing at $\mathfrak q$, because of vanishing
of $\text{Tor}_i^{R_\mathfrak p}(\kappa(\mathfrak p), M_{\mathfrak q})$.
Since the global dimension of $S_\mathfrak q/\mathfrak p S_{\mathfrak q}$
is $n$ we conclude that $K_n / \mathfrak p K_n$ localized
at $\mathfrak q$ is a finite free module over 
$S_\mathfrak q/\mathfrak p S_{\mathfrak q}$. By
Lemma \ref{lemma-free-fibre-flat-free} $(K_n)_{\mathfrak q}$
is free over $S_{\mathfrak q}$. In particular, there exists a
$g \in S$, $g \not \in \mathfrak q$ such that $(K_n)_g$
is finite free over $S_g$.

\medskip\noindent
By Lemma \ref{lemma-exact-on-fibres-open}
there exists a further localization $S_g$ such that
the complex
$$
0 \to K_n \to F_{n-1} \to \ldots \to F_0
$$
is exact on {\it all fibres} of $R \to S$. By
Lemma \ref{lemma-complex-exact-mod}
this implies that the cokernel of $F_1 \to F_0$ is
flat. This proves the theorem in the Noetherian case.
\end{proof}





















\section{Syntomic morphisms}
\label{section-syntomic}

\noindent
We will exclusively deal with finitely presented ring maps
in this section. We will freely use the following
notation. Suppose $R \to S$ is of finite presentation, and
$\mathfrak q \subset S$ is a prime ideal.
Then for any presentation $\alpha : R[x_1,\ldots,x_n] \to S$ of $S$
over $R$, we denote $\mathfrak q_{\alpha}$ the
corresponding prime of $R[x_1,\ldots,x_n]$.
In particular we have the surjection
$(R[x_1,\ldots,x_n])_{\mathfrak q_{\alpha}} \to S_{\mathfrak q}$.
Also, in this section we will denote $J_{\mathfrak q_\alpha}$ the kernel
of this map:
$$
0
\to
J_{\mathfrak q_\alpha}
\to
(R[x_1,\ldots,x_n])_{\mathfrak q_{\alpha}}
\to
S_{\mathfrak q}
\to
0
$$

\begin{lemma}
\label{lemma-lci-field}
Let $k$ be a field.
Let $S$ be a finite type $k$-algebra.
Let $\mathfrak q \subset S$ be a prime.
The following are equivalent
\begin{enumerate}
\item for any presentation $\alpha : k[x_1,\ldots,x_n]
\to S$ the ideal $J_{\mathfrak q_\alpha}$ is generated
by a regular sequence,
\item for some presentation $\alpha : k[x_1,\ldots,x_n]
\to S$ the ideal $J_{\mathfrak q_\alpha}$ is generated
by a regular sequence,
\item there exists an $f \in S$, $f \not \in \mathfrak p$
such that $S_f = k[x_1,\ldots,x_n]/(f_1,\ldots,f_c)$
and $\dim(S_f) = n - c$.
\end{enumerate}
\end{lemma}



\begin{lemma}
\label{lemma-many}
Let $R$ be a ring.
Let $S$ be a finitely presented $R$-algebra. Let
$\mathfrak q$ be a prime of $S$ lying over the prime
ideal $\mathfrak p$ of $R$. The following are equivalent
\begin{enumerate}
\item $R_{\mathfrak p} \to S_{\mathfrak q}$ is flat
and 


Let $I \subset R$ be an ideal. Let $J = (I, T)R[T]$.
Let $\mathfrak q = (\mathfrak m, T)R[T]$.
If $J_{\mathfrak q}$ is generated by a regular sequence,
then $I$ is generated by a regular sequence in $R$.
\end{enumerate}
\end{lemma}

\begin{proof}
Say $J_{\mathfrak q} = (f_1, \ldots, f_t)$ with $f_1, \ldots, f_t$
a regular sequence. In particular $T = \sum g_i f_i$
for some $g_i \in (R[T])_{\mathfrak q}$. 

\end{proof}


\begin{lemma}
\label{lemma-lci-independent}
Suppose that $R \to S$ is of finite presentation.
Let $\mathfrak q \subset S$ be a prime mapping to
$\mathfrak p \subset R$. Suppose for some presentation
$\alpha : R[x_1,\ldots,x_n] \to S$ of $S$ the kernel
of $(R[x_1,\ldots,x_n])_{\alpha^{-1}(\mathfrak q)}
\to S_{\mathfrak q}$ is generated by a regular sequence.
Then the same is true for every presentation.
\end{lemma}

\begin{proof}
Let us denote the prime $\alpha^{-1}(\mathfrak q)$
by $\mathfrak q_{\alpha}$, and similarly for other
presentations. Consider a presentation
$\beta : R[x_1,\ldots,x_n,x_{n+1}] \to S$
which agrees with $\alpha$ on $R[x_1,\ldots,x_n]$.
In this case there exists a polynomial $h \in R[x_1,\ldots,x_n]$
such that $\alpha(h) = \beta(x_{n+1})$. Note that $x_{n+1} - h$
is a nonzero divisor in $\mathfrak q_{\beta}$ and that
the natural map $R[x_1,\ldots,x_n] \to
R[x_1,\ldots, x_n, x_{n + 1}]/(x_{n + 1} - h)$
is an isomorphism. Thus the assertion for $\alpha$
implies the assertion for $\beta$. 

\medskip\noindent
On the other hand, it is clear from the above as well that
$(R[x_1,\ldots, x_n, x_{n + 1}])_{\mathfrak q_{\beta}}$
is the localization of
$(R[x_1,\ldots, x_n])_{\mathfrak q_{\alpha}}[T]$
at the maximal ideal corresponding to $T = 0$.
Here $T = x_{n+1} - h$. 

\end{proof}




\begin{definition}
\label{definition-lci}
A ring map $R \to S$ is called {\it syntomic}, or {\it flat lci} 
if it is flat, of finite presentation, and if all of its fibres
$S \otimes_R \kappa(\mathfrak p)$ are 
\end{definition}




\section{Differentials}
\label{section-differentials}

\begin{definition}
\label{definition-derivation}
Let $\varphi : R \to S$ be a ring map and let $M$ be an $S$-module.
An {\it $R$-derivation} into $M$ is a map $D : S \to M$
which is additive, annihilates elements of $\varphi(R)$,
and satisfies the {\it Leibniz rule}: 
$D(ab) = aD(b) + D(a)b$.
\end{definition}

\noindent
Note that $D(ra) = rD(a)$ if $r\in R$ and $a\in S$.
The set of all $R$-derivations forms an
$S$-module: Given two $R$-derivations $D, D'$
the sum $D+D' : S \to M$, $a \mapsto D(a)+D'(a)$
is an $R$-derivation, and given an $R$-derivation $D$
and an element $c\in S$ the scalar multiple $cD : S \to M$,
$a \mapsto cD(a)$ is an $R$-derivation. We denote this
$S$-module
$$
\text{Der}_R(S, M).
$$
Also, if $\alpha : M \to N$ is an $S$-module map, then the
composition $\alpha \circ D$ is an $R$-derivation into
$N$. In this way the assignment $M \mapsto \text{Der}_R(S, M)$
is a covariant functor.

\medskip\noindent
Let $\Omega_{S/R}$ be the $S$-module which has the
following presentation:
$$
\begin{matrix}
\bigoplus_{(a,b)\in S^2} S[(a,b)] \oplus \bigoplus_{r\in R} S[r]
&
\to
&
\bigoplus_{a\in S} S [a]
&
\to
&
\Omega_{S/R}
&
\to
&
0
\\
[(a,b)]
&
\mapsto
&
a[b] + b[a]
&
&
&
&
\\
[r]
&
\mapsto
&
[\varphi(r)]
&
&
&
&
\end{matrix}
$$
Here the notation is that $[\xi]$ represents the basis
element corresponoding to the element $\xi$ of the index set
of the direct sum. There is a map $\text{d} : S \to \Omega_{S/R}$
which maps $a$ to the class $\text{d}a$ of $[a]$ in the cokernel.
It is obvious that this is an $R$-derivation.
The pair $(\Omega_{S/R}, \text{d})$ is called the module
of K\"ahler diffentials of $S$ over $R$.

\begin{lemma}
\label{lemma-universal-omega}
The module of differentials of $S$ over $R$ has the following
universal property. The map
$$
\text{Hom}_S(\Omega_{S/R}, M)
\longrightarrow
\text{Der}_R(S, M),\ \ 
\alpha 
\longmapsto
\alpha \circ \text{d}
$$
is an isomorphism of functors.
\end{lemma}

\begin{proof}
By definition an $R$-derivation is a rule which associates
to each $a \in S$ an element $D(a) \in M$. Thus $D$ gives
rise to a map $[D] : \bigoplus S[a] \to M$. However, the conditions
of being an $R$-derivation exactly mean that $[D]$ annihilates
the image of the leftmost map in the displayed presentation of
$\Omega_{S/R}$ above.
\end{proof}

\noindent
Suppose that
$$
\xymatrix{
S \ar[r]^\varphi
&
S'
\\
R \ar[r]^\psi \ar[u]^\alpha
&
R' \ar[u]^\beta
}
$$
is a commutative diagram of rings. In this case there is a
natural map of modules of differentials fitting into the
commutative diagram
$$
\begin{matrix}
\Omega_{S/R}
&
\longrightarrow
&
\Omega_{S'/R'}
\\
\uparrow
&
&
\uparrow
\\
S
&
\longrightarrow
&
S'
\end{matrix}
$$
To construct the map just use the obvious map
between the presentations for $\Omega_{S/R}$ and $\Omega_{S'/R'}$.
Namely,
$$
\xymatrix{
\bigoplus_{(a',b')\in (S')^2} S'[(a',b')]
\oplus
\bigoplus_{r'\in R'} S'[r'] \ar[r]
&
\bigoplus_{a'\in S'} S' [a'] \ar[r]
&
\Omega_{S'/R'} \ar[r]
&
0
\\
\bigoplus_{(a,b)\in (S)^2} S[(a,b)]
\oplus
\bigoplus_{r\in R} S[r] \ar[r]
\ar[u]^{[(a,b)] \mapsto [(\varphi(a),\varphi(b)]}_{[r]\mapsto [\psi(r)]}
&
\bigoplus_{a\in S} S[a] \ar[r] \ar[u]^{[a] \mapsto [\varphi(a)]}
&
\Omega_{S'/R'} \ar[r] \ar[u]
&
0
}
$$

\begin{lemma}
\label{lemma-trivial-differential-surjective}
Suppose that $R \to S$ is surjective.
Then $\Omega_{S/R} = 0$.
\end{lemma}

\begin{proof}
You can see this either because all $R$-derivations
clearly have to be zero, or because
the map in the presentation of $\Omega_{S/R}$ is surjective.
\end{proof}

\begin{lemma}
\label{lemma-differential-surjective}
Suppose that $S \to S'$ is surjective with kernel $I \subset S$.
Then $\Omega_{S/R} \to \Omega_{S'/R'}$ is surjective with
kernel generated as an $S$-module by the elements 
\begin{enumerate}
\item $i\eta$ with $i\in I$ and $\eta \in \Omega_{S/R}$,
\item $\text{d}i$, $i \in I$, and
\item the elements $\text{d}f$, where $f \in S$ is
such that $\varphi(f) \in \beta(R')$.
\end{enumerate}
\end{lemma}

\begin{proof}
Consider the map of presentations above. Clearly the middle vertical
map of free modules is surjective. Thus the map is surjective.
An easy diagram chase completes the proof.
\end{proof}

\begin{lemma}
\label{lemma-differential-seq}
Suppose that $S \to S'$ is surjective with kernel $I \subset S$,
and assume that $R' = R$.
Then there is a canonical exact sequence of $S'$-modules
$$
I/I^2 
\longrightarrow
\Omega_{S/R}\otimes_S S'
\longrightarrow
\Omega_{S'/R}
\longrightarrow
0
$$
The rightmost map is characterized by the rule that
$f \in I$ maps to $\text{d}f \otimes 1$.
\end{lemma}

\begin{proof}
Note that the middle term can also be written as 
$\Omega_{S/R}/I\Omega_{S/R}$. For $f \in I$ denote
$\overline{f}$ the image of $f$ in $I/I^2$.
To show that the map $\overline{f} \mapsto \text{d}f \otimes 1$
is well defined we just have to check that
$\text{d} f_1f_2 \otimes 1 = 0$ if $f_1, f_2 \in I$. 
And this is clear from the Leibniz rule 
$\text{d} f_1f_2 \otimes 1
=
(f_1 \text{d}f_2 + f_2 \text{d} f_1 )\otimes 1
=
\text{d}f_2 \otimes f_1 + \text{d}f_2 \otimes f_1
=
0$. It is also $S' = S/I$-linear because of the $S/I$-module
structure on $I/I^2$ is defined through $S$-multiplication 
combined with the Leibniz rule.

\medskip\noindent
The exactness is now a direct consequence of
Lemma \ref{lemma-differential-surjective}
which describes the kernel of the surjective map.
\end{proof}

\begin{lemma}
\label{lemma-differentials-base-change}
Suppose that we have ring maps $R \to R'$ and $R \to S'$.
Set $S' = S\otimes_R R'$. Then the canonical map defined above
induces an isomorphism $\Omega_{S/R} \otimes_R R' = \Omega_{S'/R'}$.
\end{lemma}

\begin{proof}
Let $\text{d}' : S' = S\otimes_R R' \to \Omega_{S/R} \otimes_R R'$ denote the
map $\text{d}'( \sum a_i \otimes x_i ) = \text{d}(a_i) \otimes x_i$.
It exists because the map $S \times R' \to \Omega_{S/R} \otimes_R R'$,
$(a,x)\mapsto \text{d}a\otimes_R x$ is $R$-bilinear.
This is an $R'$-derivation, as can be verified by a simple computation.
We will show that $(\Omega_{S/R} \otimes_R R', \text{d}')$ satisfies
the universal property. Let $D : S' \to M'$ be an $R'$ derivation
into an $S'$-module. The composition $S \to S' \to M'$ is an $R$-derivation,
hence we get an $S$-linear map $\varphi_D : \Omega_{S/R} \to M'$. We may
tensor this with $R'$ and get the map $\varphi'_D : 
\Omega_{S/R} \otimes_R R' \to M'$, $\varphi'_D(\eta \otimes x) =
x\varphi_D(\eta)$. It is clear that $D = \varphi'_D \circ \text{d}'$.
\end{proof}

\noindent
The multiplication map $S\otimes_R S \to S$ is the $R$-algebra
map which maps $a \otimes b$ to $ab$ in $S$. It is also an
$S$-algebra map, if we think of $S\otimes_R S$ as an $S$-algebra
via either of the maps $S \to S\otimes_R S$.

\begin{lemma}
\label{lemma-differentials-diagonal}
Let $R \to S$ be a ring map. Let $J = \text{Ker}(S\otimes_R S \to S)$
be the kernel of the multiplication map. There is a canonical
isomorphism of $S$-modules $\Omega_{S/R} \to J/J^2$,
$a \text{d} b \mapsto a\otimes b - ab\otimes 1$.
\end{lemma}

\begin{proof}
First we show that the rule $a \text{d} b \mapsto a\otimes b - ab\otimes 1$
is well defined. In order to do this we have to show 
that $\text{d}r$ and $a\text{d}b + b \text{d}a$ map to zero.
The first because $r\otimes 1 - 1 \otimes r = 0$ by definition
of the tensor product. The second because
$a\otimes b - ab\otimes 1 + b\otimes a - ba\otimes 1
=
(a\otimes 1 - 1\otimes a)(b\otimes 1 - 1\otimes b)
$
is in $J^2$.

\medskip\noindent
We construct a map in the other direction.
We may think of $S \to S\otimes_R S$, $a \mapsto a\otimes 1$
as the base change of $R \to S$. Hence we have
$\Omega_{S\otimes_R S/S} = \Omega_{S/R} \otimes_S (S\otimes_R S)$,
by Lemma \ref{lemma-differentials-base-change}.
At this point the sequence of Lemma \ref{lemma-differential-seq} gives a map
$$
J/J^2  \to \Omega_{S\otimes_RS/ S} \otimes_{S\otimes_R S} S
= (\Omega_{S/R} \otimes_S (S\otimes_R S))\otimes_{S\otimes_R S} S
= \Omega_{S/R}.
$$
We leave it to the reader to see it is the inverse of the map
above.
\end{proof}




\begin{lemma}
\label{lemma-differentials-polynomial-ring}
If $S = R[x_1,\ldots,x_n]$, then 
$\Omega_{S/R}$ is a finite free $S$-module with
basis $\text{d}x_1,\ldots, \text{d}x_n$.
\end{lemma}

\begin{proof}
We first show that $\text{d}x_1,\ldots, \text{d}x_n$
generate $\Omega_{S/R}$ as an $S$-module. To prove this
we show that $\text{d}g$ can be expressed as a 
sum $\sum g_i \text{d}x_i$ for any $g \in R[x_1,\ldots,x_n]$.
We do this by induction on the (total) degree of $g$.
It is clear if the degree of $g$ is $0$, because then
$\text{d}g = 0$. If the degree of $g$ is $>0$, then
we may write $g$ as $c + \sum g_i x_i$ with $c\in R$
and $\deg(g_i) < \deg(g)$. By the Leibnize rule we have
$\text{d}g = \sum g_i \text{d} x_i + \sum x_i \text{d}g_i$,
and hence we win by induction.

\medskip\noindent
Consider the $R$-derivation $\partial / \partial x_i :
R[x_1,\ldots,x_n] \to R[x_1,\ldots,x_n]$. (We leave it to
the reader to define this; the defining property
being that $\partial / \partial x_i (x_j) = \delta_{ij}$.)
By the universal property this corresponds to an $S$-module map $l_i : 
\Omega_{S/R} \to R[x_1,\ldots,x_n]$ which maps $\text{d}x_i$
to $1$ and $\text{d}x_j$ to $0$ for $j \not= i$. 
Thus it is clear that there are no $S$-linear relations
among the elements $\text{d}x_1,\ldots, \text{d}x_n$.
\end{proof}

\begin{lemma}
\label{lemma-differentials-finitely-presented}
Suppose $R \to S$ is of finite presentation.
Then $\Omega_{S/R}$ is a finitely presented
$S$-module.
\end{lemma}

\begin{proof}
Write $S = R[x_1,\ldots,x_n]/(f_1, \ldots, f_m)$. 
Write $I = (f_1, \ldots, f_m)$. According
to Lemma \ref{lemma-differential-seq} there is an exact sequence
of $S$-modules
$$
I/I^2
\to
\Omega_{R[x_1,\ldots,x_n]/R}\otimes_{R[x_1,\ldots,x_n]} S
\to 
\Omega_{S/R}
\to
0
$$
The result follows from the fact that $I/I^2$ is a finite 
$S$-module (generated by the images of the $f_i$), and that
the middle term is finite free by
Lemma \ref{lemma-differentials-polynomial-ring}.
\end{proof}

\begin{lemma}
\label{lemma-differentials-finitely-generated}
Suppose $R \to S$ is of finite type.
Then $\Omega_{S/R}$ is finitely generated
$S$-module.
\end{lemma}

\begin{proof}
This is very similar to, but easier than the proof
of Lemma \ref{lemma-differentials-finitely-presented}.
\end{proof}

\noindent
Suppose that $R \to S$ is of finite type.
We say that a {\it presentation} of $S$ over $R$ is
given by the choice of an integer $n \geq 0$, and
a surjection $\alpha : R[x_1,\ldots,x_n] \to S$
of $R$-algebras. We will usually just indicate
this by saying: ``Let $R[x_1,\ldots,x_n] \to S$ be a presentation of
$S/R$'', or ``Let $0\to I \to R[x_1,\ldots,x_n] \to S \to 0$
be a presentation of $S/R$'' if we want to indicate that $I$
is the kernel of the presentation.

\medskip\noindent
Note that for every presentation $\alpha$ we obtain a two term
complex of $S$-modules
$$
NL(\alpha) :
I/I^2 \longrightarrow \Omega_{R[x_1,\ldots,x_n]/R}\otimes S.
$$
The cokernel of this complex is canonically $\Omega_{S/R}$,
see Lemma \ref{lemma-differential-seq}. We call the complex
$NL(\alpha)$
the {\it naive cotangent complex}\footnote{This is better know as the {\it 
Netherlander complex} in some localities.} associated to the
presentation $\alpha : R[x_1,\ldots,x_n] \to S$ of $S/R$. We will
sometimes use the notation
$I/I^2 \to \bigoplus_{i=1,\ldots,n} S\text{d}x_i$
to denote this complex.

\medskip\noindent
A {\it morphism of presentations of $S/R$} from the presentation
$\alpha : R[x_1,\ldots,x_n] \to S$ to the presentation
$\beta : R[y_1,\ldots,y_m] \to S$ is defined to be a
map $\varphi : R[x_1,\ldots,x_n] \to R[y_1,\ldots,y_m]$
such that $\alpha = \beta \circ \varphi$. Note that
in this case $\varphi(I) \subset J$, where $I = \text{ker}(\alpha)$
and $J = \text{ker}(\beta)$. Thus $\varphi$ induces a map
of $S$-modules $I/I^2 \to J/J^2$ and by functoriality of
differentials also a $S$-module map
$\Omega_{R[x_1,\ldots,x_n]/R}\otimes S
\to \Omega_{R[y_1,\ldots,y_m]/R}\otimes S$.
These maps are compatible and we obtain a map
of naive cotangent complexes
$$
NL(\alpha) \longrightarrow NL(\beta).
$$
We leave it to the reader to see that if $\psi$ is a morphism
of presentations from $\beta$ to $\gamma$, then $\psi \circ \varphi$
is a morphism from $\alpha$ to $\gamma$ and furthermore 
the composition $NL(\alpha) \to NL(\beta) \to NL(\gamma)$
is the map associated to $\psi \circ \varphi$.

\begin{lemma}
\label{lemma-NL-homotopy}
Let $S$ be a finite type $R$-algebra.
Let $\alpha : R[x_1,\ldots,x_n] \to S$, and
$\beta : R[y_1,\ldots,y_m] \to S$ be presentations.
\begin{enumerate}
\item For any map $\varphi$ of presentations from
$\alpha$ to $\beta$ the induced map $NL(\alpha) \to NL(\beta)$
is a quasi-isomorphism.
\item For any pair of maps $\varphi, \varphi'$ the induced maps
$NL(\alpha) \to NL(\beta)$ are homotopic.
\end{enumerate}
See the proof of the lemma for a simple explanation
of the assertions.
\end{lemma}

\begin{proof}
In the simple case of complexes with two terms a quasi-isomorphism
is just a map that induces an isomorphism on both the cokernel
and the kernel of the maps between the terms. In this case the
fact that $\varphi$ induces an isomorphism on cokernels is by
the choice of $NL(\alpha)$ having cokernel equal to $\Omega_{S/R}$.

\medskip\noindent
Note that the first assertion of the lemma follows from the second.
This is so because we may always choose a morphism of presentations
$\varphi'$ from $\beta$ to $\alpha$. The compositions
$\varphi' \circ \varphi$ and $\varphi \circ \varphi'$
will by (2) induce self maps of $NL(\alpha)$ and $NL(\beta)$
which are homotopic to the identity and hence quasi-isomorphism
(see below).
Hence both compositions $NL(\alpha) \to NL(\beta) \to NL(\alpha)$
and $NL(\beta) \to NL(\alpha) \to NL(\beta)$ are quasi-isomorphisms
(inducing the indentity on cohomology) and hence so are the maps induced
by $\varphi$ and $\varphi'$.

\medskip\noindent
For the second assertion, let $\varphi$ and $\varphi'$ as stated.
Let $I = \text{Ker}(\alpha)$ and $J = \text{Ker}(\beta)$.
We have to construct the diagonal map in the diagram
$$
\xymatrix{
I/I^2 \ar[r]^{\text{d}} \ar@<1ex>[d] \ar@<-1ex>[d]
&
\bigoplus S\text{d}x_i \ar@<1ex>[d] \ar@<-1ex>[d] \ar[ld]_h
\\
J/J^2 \ar[r]^{\text{d}}
&
\bigoplus S\text{d}y_j
}
$$
where the vertical maps are induced by $\varphi$, $\varphi'$.
The condition is that $\text{d} \circ h + h \circ \text{d}$ should be
the difference of the vertical arrows. It is immediate in this
very simple case of complexes with two terms that this implies 
the vertical maps induce the same maps on kernel and cokernel
of the horizontal maps.

\medskip\noindent
Write $\varphi(x_i) - \varphi'(x_i) = h_i$ for some
$h_i \in R[y_j]$. Of course $h_i \in J$. For all $i$ we have
$\varphi(\text{d}x_i) = \text{d}\varphi(x_i)
=\text{d}(\varphi'(x_i) + h_i) =
\text{d}(\varphi'(x_i)) + \text{d}h_i$. On the other hand,
for every $f = f(x_1,\ldots,x_n) \in I$ we have $\varphi(f) = 
f(\varphi(x_1),\ldots, \varphi(x_n)) =
f(\varphi'(x_1) + h_1,\ldots, \varphi'(x_n) + h_n) =
f(\varphi'(x_1),\ldots, \varphi'(x_n)) + 
\sum_i h_i \partial f/\partial x_i + $ terms in 
$J^2$. Hence the map $h : \bigoplus S\text{d}x_i \to J/J^2$,
$x_i \to h_i$ gives the desired homoropy.
\end{proof}





\section{Smooth ring maps}
\label{section-smooth}

\begin{definition}
\label{definition-smooth}
A ring map $R \to S$ is {\it smooth} if it is of finite presentation
and 
\end{definition}










\section{Miscellany}
\label{section-miscellany}

\noindent
The proofs in this section should not refer to any results except
those from the section on basic notions, Section \ref{section-rings-basic}.

\begin{lemma}
\label{lemma-silly}
Suppose $R$ is a ring, $\mathfrak p_i$, $i=1,\ldots,r$ primes
and $I \subset R$ an ideal. Assume $I \not\subset \mathfrak p_i$
for all $i$. Then there exists an $x\in I$, $x\not\in \mathfrak p_i$ for
all $i$.
\end{lemma}

\begin{proof}
We may assume there are no inclusions among the $\mathfrak p_i$.
The result is true for $r = 1$.
Suppose the result holds for $r-1$.
Pick $x \in I$, $x \not \in \mathfrak p_i$ for all $i=1,\ldots,r-1$.
If $x \not\in \mathfrak p_r$ we are done. So assume $x \in \mathfrak p_r$.
If $I\mathfrak p_1 \ldots \mathfrak p_{r-1} \subset \mathfrak p_r$
then $I \subset \mathfrak p_r$ a contradiction.
Pick $y \in I\mathfrak p_1 \ldots \mathfrak p_{r-1}$,
$y \not \in \mathfrak p_r$. Then $x+y$ works.
\end{proof}

\begin{lemma}
\label{lemma-chinese-remainder}
(Chinese remainder.)
Let $R$ be a ring.
\begin{enumerate}
\item If $I_1,\ldots,I_r$ are ideals such that $I_a + I_b = R$
when $a \not = b$, then $I_1 \cap \ldots \cap I_r = 
I_1I_2\ldots I_r$ and $R/(I_1I_2\ldots I_r)
\cong R/I_1 \times \ldots \times R/I_r$.
\item If $\mathfrak m_1,\ldots,\mathfrak m_r$ are pairwise distinct maximal
ideals then $\mathfrak m_a + \mathfrak m_b = R$ for $a \not=b$ and the
above applies.
\end{enumerate}
\end{lemma}

\begin{proof}
FIXME.
\end{proof}

\begin{lemma}
\label{lemma-localize-colimit}
Let $M$ be an $R$-module, and let $S \subset R$ be
a multiplicative subset. Then $S^{-1}M = M\otimes_R S^{-1}R$
is the directed colimit of the modules $M_f$, $f\in S$ with
transition maps $M_{f'} \to M_f, m/(f')^n \mapsto (f'')^n m/f^n$
whenever $f = f' f''$ with $f,f',f''\in S$.
\end{lemma}

\begin{proof}
FIXME.
\end{proof}

\begin{lemma}
\label{lemma-NAK}
(Nakayama's lemma.)
Let $R$ be a ring, let $M$ be an $R$-module, and let $I \subset R$
be an ideal.
\begin{enumerate}
\item If $M$ is finite, and $IM = M$, then there exists a
$f = 1+i \in 1 + I$ such that $fM = 0$.
\label{nakayama}
\item If $M$ is finite, $IM = M$, and $I \subset \text{rad}(R)$
then $M=0$.
\item If $IM=M$, $I$ is nilpotent, then $M=0$.
\end{enumerate}
\end{lemma}

\begin{proof}
Proof of (\ref{nakayama}).
Write $M = \sum Rx_j$, $j=1,\ldots,r$. Write $x_j = \sum i_{jj'} x_{j'}$ with
$i_{jj'} \in I$.  In other words $\sum (\delta_{jj'} - i_{jj'})x_{j'} = 0$.
Hence the determinant $f$ of the $r\times r$ matrix
$(\delta_{jj'} - i_{jj'})$ is a solution. The other parts are easy.
\end{proof}

\begin{lemma}
\label{lemma-cover}
Let $R$ be a ring, and let $M$ be an $R$-module.
Suppose that $f_1,\ldots,f_n$ is a finite list of
elements of $R$ such that $\bigcup D(f_i) = \text{Spec}(R)$
(in other words $(f_1,\ldots,f_n) = R$).
\begin{enumerate}
\item If each $M_{f_i}$ is a finite $R_{f_i}$-module,
then $M$ is a finite $R$-module.
\item If each $M_{f_i}$ is a finitely presented $R_{f_i}$-module,
then $M$ is a finitely presented $R$-module.
\item Let $M \to N$ be a map of $R$-modules. If $M_{f_i} \to N_{f_i}$
is an isomorphism for each $i$ then $M \to N$ is an isomorphism.
\end{enumerate}
\end{lemma}

\begin{proof}
FIXME.
\end{proof}

\begin{lemma}
\label{lemma-charpoly}
Let $R$ be a ring. Let $A = (a_{ij})$ be an $n\times n$
matrix with coefficients in $R$. Let $P(x) \in R[x]$
be the characteristic polynomial of $A$ (defined
as $\det(x\text{id}_{n\times n} - A)$).
Then $P(A) = 0$ in $\text{Mat}(n\times n, R)$.
\end{lemma}

\begin{proof}
FIXME.
\end{proof}


\input{chapters}

\bibliography{my}
\bibliographystyle{alpha}

\end{document}
