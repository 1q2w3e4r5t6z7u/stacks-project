\input{preamble}

% OK, start here.
%
\begin{document}

\title{More on flatness}

\maketitle

\phantomsection
\label{section-phantom}

\tableofcontents



\section{Introduction}
\label{section-introduction}

\noindent
In this chapter, we discuss some advanced results on flat modules and
flat morphisms of schemes. Most of these results can be
found in the paper \cite{GruRay} by Raynaud and Gruson.

\medskip\noindent
Before reading this chapter we advise the reader to take a look
at the following results (this list also serves as a pointer to
previous results):
\begin{enumerate}
\item General discussion on flat modules in
Algebra, Section \ref{algebra-section-flat}.
\item The relationship between $\text{Tor}$-groups and flatness, see
Algebra, Section \ref{algebra-section-tor}.
\item The sections on flatness criteria, namely,
Algebra, Section \ref{algebra-section-criteria-flatness}
(Noetherian case),
Algebra, Section \ref{algebra-section-flatness-artinian}
(Artinian case),
Algebra, Section \ref{algebra-section-more-flatness-criteria}
(non-Noetherian case), and finally
More on Morphisms, Section \ref{more-morphisms-section-criterion-flat-fibres}.
\item Generic flatness, see
Algebra, Section \ref{algebra-section-generic-flatness}
and
Morphisms, Section \ref{morphisms-section-generic-flatness}.
\item Openness of the flat locus, see
Algebra, Section \ref{algebra-section-open-flat}
and
More on Morphisms, Section \ref{more-morphisms-section-open-flat}.
\item Flattening stratification, see
Algebra, Section \ref{algebra-section-flattening}.
\item Additional algebraic in
Algebra, Sections \ref{algebra-section-descent-flatness-integral},
\ref{algebra-section-torsion-flat},
\ref{algebra-section-flat-finite}, and
\ref{algebra-section-blowup-flat}.
\end{enumerate}








\section{The local structure of a finite type module}
\label{section-local-structure-module}

\noindent
The key technical lemma that makes a lot of the arguments in this
chapter work is the following geometric lemma.

\begin{lemma}
\label{lemma-elementary-devissage}
Let $f : X \to S$ be a finite type morphism of schemes.
Let $\mathcal{F}$ be a finite type quasi-coherent $\mathcal{O}_X$-module.
Let $x \in X$ with image $s = f(x)$ in $S$.
Set $\mathcal{F}_s = \mathcal{F}|_{X_s}$ and
$n = \dim_x(\text{Supp}(\mathcal{F}_s))$.
Then we can construct
\begin{enumerate}
\item elementary etale neighbourhoods $g : (X', x') \to (X, x)$,
$e : (S', s') \to (S, s)$,
\item a commutative diagram
$$
\xymatrix{
X' \ar[d]_g & Z' \ar[l]^i \ar[r]_\pi & Y' \ar[r]_h & S' \ar[d]^e \\
X \ar[rrr]^f & & & S
}
$$
\item points $z' \in Z'$, $y' = \pi(z') \in Y'$ mapping to $x'$, $s'$, and
\item a finite type quasi-coherent $\mathcal{O}_{Z'}$-module $\mathcal{G}$
\end{enumerate}
such that the following properties hold
\begin{enumerate}
\item $X'$, $Z'$, $Y'$, $S'$ are affine schemes,
\item $i$ is a closed immersion of finite presentation,
\item $i_*(\mathcal{G}) \cong \mathcal{F}$,
\item $\pi$ is finite and $\pi^{-1}(\{y'\}) = \{x'\}$,
\item $h$ is smooth of relative dimension $n$
with geometrically integral fibres,
\item $\kappa(s') \subset \kappa(y')$ is
purely transcendental, and
\item an integer $r \geq 0$ and a map
$\alpha : \mathcal{O}_{Y'}^{\oplus r} \to \pi_*(\mathcal{G})$
such that $\alpha_{\xi} \otimes \kappa(\xi)$ is an isomorphism
where $\xi \in Y'_{s'}$ is the generic point.
\end{enumerate}
Moreover, if $f$ is locally of finite presentation and
$\mathcal{F}$ is an $\mathcal{O}_X$-module of finite presentation,
then $\mathcal{G}$ is an $\mathcal{O}_{Z'}$-module of finite presentation.
\end{lemma}

\begin{proof}
Let $V \subset S$ be an affine neighbourhood of $s$.
Let $U \subset f^{-1}(V)$ be an affine neighbourhood of $x$.
Then it suffices to prove the lemma for $f|_U : U \to V$ and
$\mathcal{F}|_U$. Hence we may assume that $X$ and $S$ are affine.

\medskip\noindent
Say the morphism $f : X \to S$ is given by the ring map
$A \to B$ and that $\mathcal{F}$ is the quasi-coherent sheaf
associated to the $B$-module $M$. By
Morphisms, Lemma \ref{morphisms-lemma-locally-finite-type-characterize}
we know that $A \to B$ is a finite type ring map, and by
Properties, Lemma \ref{properties-lemma-finite-type-module}
we know that $M$ is a finite $B$-module. In particular the
support of $\mathcal{F}$ is the closed subscheme of $\text{Spec}(B)$
cut out by $I = \{x \in B \mid xm = 0\ \forall m \in M\}$
the annihilator of $M$, see
Algebra, Lemma \ref{algebra-lemma-support-closed}.
Let $\mathfrak q \subset B$ be the prime ideal corresponding to $x$
and let $\mathfrak p \subset A$ be the prime ideal corresponding to $s$.
Note that $X_s = \text{Spec}(B \otimes_A \kappa(\mathfrak p))$ and
that $\mathcal{F}_s$ is the quasi-coherent sheaf associated to the
$B \otimes_A \kappa(\mathfrak p)$ module $M \otimes_A \kappa(\mathfrak p)$. By
Divisors, Lemma \ref{divisors-lemma-support-finite-type}
the support of $\mathcal{F}_s$ is equal to
$V(I(B \otimes_A \kappa(\mathfrak p)))$. Since
$B \otimes_A \kappa(\mathfrak p)$ is of finite type over $\kappa(\mathfrak p)$
there exist finitely many elements $f_1, \ldots, f_m \in I$
such that
$$
I(B \otimes_A \kappa(\mathfrak p)) =
(f_1, \ldots, f_n)(B \otimes_A \kappa(\mathfrak p)).
$$
Denote $i : Z \to X$ the closed subscheme cut out by
$(f_1, \ldots, f_m)$, in a formula $Z = \text{Spec}(B/(f_1, \ldots, f_m))$.
Since $M$ is annihilated by $I$ we can think of $M$ as an
$B/(f_1, \ldots, f_m)$-module. In other words, $\mathcal{F}$ is the
pushforward of a finite type module on $Z$.

\end{proof}





\section{Flattening stratification}
\label{section-flattening}

\noindent
If $f : X \to S$ is a proper, finitely presented morphism
of schemes then one can find a stratification of the base
over whose members the morphism $f$ is flat. It is not so hard
to find this stratification, but what is a bit tricky is to prove
that this stratification is characterized by a universal property.
In this section we discuss this and some of its variants.

\medskip\noindent
The first case is where the base is the spectrum of a complete
local Noetherian ring. In this case the closed stratum is defined
and satisfies the desired universal property even for a general
finite type morphism, provided we {\it only} look for flatness in
points lying over the closed point.

\begin{lemma}
\label{lemma-flattening-complete-noetherian}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{F}$ be a quasi-coherent sheaf on $X$.
Assume
\begin{enumerate}
\item $S = \text{Spec}(A)$ is the spectrum of a Noetherian complete
local ring $A$,
\item $f$ is of finite type, and
\item $\mathcal{F}$ is a finite type $\mathcal{O}_X$-module.
\end{enumerate}
Then there exists a closed subscheme $Z \subset S$ with the following
universal property: Given a morphism $S' \to S$ which corresponds to
a local homomorphism $A' \to A$ of local rings the following
are equivalent
\begin{enumerate}
\item[(a)] the pullback $\mathcal{F}'$ of $\mathcal{F}$ to
$X' = S' \times_S X$ is flat over $S'$ at all points $x' \in X'$
lying over the closed point of $S'$, and
\item[(b)] $S' \to S$ factors through $Z$.
\end{enumerate}
In particular, $Z$ is the largest closed subscheme of $S$ such that
$\mathcal{F}|_{X_Z}$ is flat over $Z$ at all points
of $X_Z$ lying over the closed point of $Z$.
\end{lemma}

\begin{proof}
As $f$ is of finite type it is quasi-compact. Hence $X$ is quasi-compact.
Choose a finite affine open covering $X = \bigcup X_i$.
Write $X_i = \text{Spec}(B_i)$ so that $A \to B_i$ is a finite type
ring map. Note that $\mathcal{F}|_{X_i}$ corresponds to a finite
$B_i$-module $M_i$. Set $Y = \coprod X_i = \text{Spec}(\prod B_i)$
and $\mathcal{G} = \widetilde{\prod M_i}$ on $Y$.
Now if $S' \to S$ is a morphism as in the lemma, then (a) holds
for $\mathcal{F}'$ relative to $X' \to S'$ if and only if (a) holds for
$\mathcal{G}'$ relative to $Y' \to S'$. Hence this
reduces us to the case where $X$ is affine.
In this case $Z$ exists by
Algebra,
Lemma \ref{algebra-lemma-flattening-complete-local-universal-property}.
(Hint: We strongly suggest the reader only read the construction of
$Z = \text{Spec}(A/I)$ in
Algebra, Lemma \ref{algebra-lemma-flattening-complete-local-noetherian}.)
\end{proof}





\input{chapters}


\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}
