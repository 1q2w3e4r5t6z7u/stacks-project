\input{preamble}

% OK, start here.
%
\begin{document}

\title{More on flatness}

\maketitle

\phantomsection
\label{section-phantom}

\tableofcontents



\section{Introduction}
\label{section-introduction}

\noindent
In this chapter, we discuss some advanced results on flat modules and
flat morphisms of schemes. Most of these results can be
found in the paper \cite{GruRay} by Raynaud and Gruson.

\medskip\noindent
Before reading this chapter we advise the reader to take a look
at the following results (this list also serves as a pointer to
previous results):
\begin{enumerate}
\item General discussion on flat modules in
Algebra, Section \ref{algebra-section-flat}.
\item The relationship between $\text{Tor}$-groups and flatness, see
Algebra, Section \ref{algebra-section-tor}.
\item The sections on flatness criteria, namely,
Algebra, Section \ref{algebra-section-criteria-flatness}
(Noetherian case),
Algebra, Section \ref{algebra-section-flatness-artinian}
(Artinian case),
Algebra, Section \ref{algebra-section-more-flatness-criteria}
(non-Noetherian case), and finally
More on Morphisms, Section \ref{more-morphisms-section-criterion-flat-fibres}.
\item Generic flatness, see
Algebra, Section \ref{algebra-section-generic-flatness}
and
Morphisms, Section \ref{morphisms-section-generic-flatness}.
\item Openness of the flat locus, see
Algebra, Section \ref{algebra-section-open-flat}
and
More on Morphisms, Section \ref{more-morphisms-section-open-flat}.
\item Flattening stratification, see
More on Algebra, Section \ref{more-algebra-section-flattening}.
\item Additional algebraic results in
More on Algebra, Sections \ref{more-algebra-section-descent-flatness-integral},
\ref{more-algebra-section-torsion-flat},
\ref{more-algebra-section-flat-finite}, and
\ref{more-algebra-section-blowup-flat}.
\end{enumerate}




\section{A remark on finite type versus finite presentation}
\label{section-finite-type-finite-presentation}

\noindent
Let $R$ be a ring. Let $A \to B$ be a finite map of finite type $R$-algebras.
Let $M$ be a finite $B$-module. In this case it is {\bf not} true that
$$
M\text{ of finite presentation over }B
\Leftrightarrow
M\text{ of finite presentation over }A
$$
A counter example is $A = R = k[x_1, x_2, x_3, \ldots]$ and $B = R/(x_i)$
and $M = B$. To ``fix'' this we introduce a relative notion of finite
presentation.

\begin{lemma}
\label{lemma-relatively-finitely-presented}
Let $R \to A$ be a ring map of finite type.
Let $M$ be an $A$-module.
The following are equivalent
\begin{enumerate}
\item for some presentation $\alpha : R[x_1, \ldots, x_n] \to A$
the module $M$ is a fintely presented $R[x_1, \ldots, x_n]$-module,
\item for all presentations $\alpha : R[x_1, \ldots, x_n] \to A$
the module $M$ is a fintely presented $R[x_1, \ldots, x_n]$-module, and
\item for any surjection $A' \to A$ where $A'$ is a finitely presented
$R$-algebra, the module $M$ is finitely presented as $A'$-module.
\end{enumerate}
In this case $M$ is a finitely presented $A$-module.
\end{lemma}

\begin{proof}
If $\alpha : R[x_1, \ldots, x_n] \to A$ and
$\beta : R[y_1, \ldots, y_m] \to A$ are presentations, then we get a
commutative diagram
$$
\xymatrix{
R[x_1, \ldots, x_n, y_1, \ldots, y_m] \ar[d] \ar[r] &
R[x_1, \ldots, x_n] \ar[d] \\
R[y_1, \ldots, y_m] \ar[r] & A
}
$$
and hence the equivalence of (1) and (2) follows by applying
Algebra, Lemmas \ref{algebra-lemma-finitely-presented-over-subring} and
\ref{algebra-lemma-finite-finitely-presented-extension}.
The equivalence of (2) and (3) follows by choosing a presentation
$A' = R[x_1, \ldots, x_n]/(f_1, \ldots, f_m)$ and using
Algebra, Lemma \ref{algebra-lemma-finite-finitely-presented-extension}
to show that $M$ is finitely presented as $A'$-module if and only if
$M$ is finitely presented as a $R[x_1, \ldots, x_n]$-module.
\end{proof}

\begin{definition}
\label{definition-relatively-finitely-presented}
Let $R \to A$ be a finite type ring map. Let $M$ be an $A$-module.
We say $M$ is {\it an $A$-module finitely presented relative to $R$}
if the equivalent conditions of
Lemma \ref{lemma-relatively-finitely-presented}
hold.
\end{definition}

\noindent
Now we can formulate the result we were looking for.

\begin{lemma}
\label{lemma-finite-extension}
Let $R$ be a ring. Let $A \to B$ be a finite map of finite type $R$-algebras.
Let $M$ be a $B$-module. Then
$M$ is an $A$-module finitely presented relative to $R$
if and only if
$M$ is an $B$-module finitely presented relative to $R$.
\end{lemma}

\begin{proof}
Choose a surjection $R[x_1, \ldots, x_n] \to A$.
Choose $y_1, \ldots, y_m \in B$ which generate $B$ over $A$.
As $A \to B$ is finite each $y_i$ satisfies a monic equation with
coefficients in $A$. Hence we can find monic polynomials
$P_j(T) \in R[x_1, \ldots, x_n][T]$ such that $P_j(y_j) = 0$ in $B$.
Then we get a commutative diagram
$$
\xymatrix{
R[x_1, \ldots, x_n] \ar[d] \ar[r] &
R[x_1, \ldots, x_n, y_1, \ldots, y_m]/(P_j(y_j)) \ar[d] \\
A \ar[r] & B
}
$$
Since the top arrow is a finite and finitely presented ring map
we conclude by
Algebra, Lemma \ref{algebra-lemma-finite-finitely-presented-extension}
and the definition.
\end{proof}

\noindent
With this result in hand we see that the relative notion makes sense
and behaves well with regards to finite maps of rings of finite type
over $R$. It is also clear that the notion is stable under localization:
If $R \to A$ is a finite type ring map and $M$ is an $A$-module
of finite presentation relative to $R$, and if $f \in A$, then
$M_f$ is an $A_f$-module of finite presentation relative to $R$.
(Proof omitted.) Hence this notion localizes well and we can define
a scheme theoretic notion as follows.

\begin{definition}
\label{definition-relatively-finitely-presented-sheaf}
Let $f : X \to S$ be locally of finite type.
Let $\mathcal{F}$ be a finite type quasi-coherent $\mathcal{O}_X$-module.
Then we say {\it $\mathcal{F}$ is locally finitely presented relative to $S$}
if there exists an affine open covering $S = \bigcup V_i$ and
$f^{-1}(V_i) = \bigcup_j U_{ij}$ such that $\mathcal{F}(U_{ij})$
is a $\mathcal{O}_X(U_{ij})$-module of finite presentation relative
to $\mathcal{O}_S(V_i)$.
\end{definition}

\noindent
In this way we can make sense of when a sheaf of modules on $X$ is
locally of finite presentation over $S$ even if $X$ is not locally
of finite presentation over $S$. And of course, $X \to S$ is locally
of finite presentation if and only if $\mathcal{O}_X$ is locally
of finite presentation relative to $S$.


\section{Lemmas on \'etale localization}
\label{section-etale-localization}

\noindent
In this section we list some lemmas on \'etale localization which will be
useful later in this chapter. Please skip this section on a first reading.

\begin{lemma}
\label{lemma-lift-etale}
Let $i : Z \to X$ be a closed immersion of affine schemes.
Let $Z' \to Z$ be an \'etale morphism with $Z'$ affine.
Then there exists an \'etale morphism $X' \to X$ with $X'$
affine such that $Z' \cong Z \times_X X'$ as schemes over $Z$.
\end{lemma}

\begin{proof}
See
Algebra, Lemma \ref{algebra-lemma-lift-etale}.
\end{proof}

\begin{lemma}
\label{lemma-etale-at-point}
Let
$$
\xymatrix{
X \ar[d] & X' \ar[l] \ar[d] \\
S & S' \ar[l]
}
$$
be a commutative diagram of schemes with $X' \to X$ and $S' \to S$ \'etale.
Let $s' \in S'$ be a point. Then
$$
X' \times_{S'} \text{Spec}(\mathcal{O}_{S', s'})
\longrightarrow
X \times_S \text{Spec}(\mathcal{O}_{S', s'})
$$
is \'etale.
\end{lemma}

\begin{proof}
This is true because $X' \to X_{S'}$ is \'etale as a morphism of
schemes \'etale over $X$, see
Morphisms, Lemma \ref{morphisms-lemma-etale-permanence}
and the base change of an \'etale morphism is \'etale, see
Morphisms, Lemma \ref{morphisms-lemma-base-change-etale}.
\end{proof}

\begin{lemma}
\label{lemma-etale-flat-up-down}
Let $X \to T \to S$ be morphisms of schemes with $T \to S$ \'etale.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
Let $x \in X$ be a point. Then
$$
\mathcal{F}\text{ flat over }S\text{ at }x
\Leftrightarrow
\mathcal{F}\text{ flat over }T\text{ at }x
$$
In particular $\mathcal{F}$ is flat over $S$ if and only if $\mathcal{F}$
is flat over $T$.
\end{lemma}

\begin{proof}
As an \'etale morphism is a flat morphism (see
Morphisms, Lemma \ref{morphisms-lemma-etale-flat})
the implication ``$\Leftarrow$'' follows from
Algebra, Lemma \ref{algebra-lemma-composition-flat}.
For the converse assume that $\mathcal{F}$ is flat at $x$ over $S$.
Denote $\tilde x \in X \times_S T$ the point lying over $x$ in $X$
and over the image of $x$ in $T$ in $T$.
Then $(X \times_S T \to X)^*\mathcal{F}$ is flat at $\tilde x$ over $T$
via $\text{pr}_2 : X \times_S T \to T$, see
Morphisms, Lemma \ref{morphisms-lemma-base-change-module-flat}.
The diagonal $\Delta_{T/S} : T \to T \times_S T$ is an open immersion;
combine
Morphisms, Lemmas \ref{morphisms-lemma-diagonal-unramfied-morphism} and
\ref{morphisms-lemma-etale-smooth-unramified}.
So $X$ is identified with open subscheme of $X \times_S T$,
the restriction of $\text{pr}_2$ to this open is the given morphism $X \to T$,
the point $\tilde x$ corresponds to the point $x$ in this open, and
$(X \times_S T \to X)^*\mathcal{F}$ restricted to this open is $\mathcal{F}$.
Whence we see that $\mathcal{F}$ is flat at $x$ over $T$.
\end{proof}

\begin{lemma}
\label{lemma-etale-flat-up-down-local-ring}
Let $T \to S$ be an \'etale morphism. Let $t \in T$ with image $s \in S$.
Let $M$ be a $\mathcal{O}_{T, t}$-module. Then
$$
M\text{ flat over }\mathcal{O}_{S, s}
\Leftrightarrow
M\text{ flat over }\mathcal{O}_{T, t}.
$$
\end{lemma}

\begin{proof}
We may replace $S$ by an affine neighbourhood of $s$ and after that
$T$ by an affine neighbourhood of $t$.
Set $\mathcal{F} = (\text{Spec}(\mathcal{O}_{T, t}) \to T)_*\widetilde M$.
This is a quasi-coherent sheaf (see
Schemes, Lemma \ref{schemes-lemma-push-forward-quasi-coherent}
or argue directly)
on $T$ whose stalk at $t$ is $M$ (details omitted).
Apply
Lemma \ref{lemma-etale-flat-up-down}.
\end{proof}

\begin{lemma}
\label{lemma-finite-flat-weak-assassin-up-down}
Let $g : T \to S$ be a finite flat morphism of schemes.
Let $\mathcal{G}$ be a quasi-coherent $\mathcal{O}_S$-module.
Let $t \in T$ be a point with image $s \in S$. Then
$$
t \in \text{WeakAss}(g^*\mathcal{G})
\Leftrightarrow
s \in \text{WeakAss}(\mathcal{G})
$$
\end{lemma}

\begin{proof}
The implication ``$\Leftarrow$'' follows immediately from
Divisors, Lemma \ref{divisors-lemma-weakly-ass-pullback}.
Assume $t \in \text{WeakAss}(g^*\mathcal{G})$.
Let $\text{Spec}(A) \subset S$ be an affine open neighbourhood of $s$.
Let $\mathcal{G}$ be the quasi-coherent sheaf associated to the $A$-module $M$.
Let $\mathfrak p \subset A$ be the prime ideal corresponding to $s$.
As $g$ is finite flat we have $g^{-1}(\text{Spec}(A)) = \text{Spec}(B)$
for some finite flat $A$-algebra $B$. Note that
$g^*\mathcal{G}$ is the quasi-coherent $\mathcal{O}_{\text{Spec}(B)}$-module
associated to the $B$-module $M \otimes_A B$ and $g_*g^*\mathcal{G}$ is the
quasi-coherent $\mathcal{O}_{\text{Spec}(A)}$-module associated to the
$A$-module $M \otimes_A B$. By
Algebra, Lemma \ref{algebra-lemma-finite-flat-local}
we have $B_{\mathfrak p} \cong A_{\mathfrak p}^{\oplus n}$
for some integer $n \geq 0$. Note that $n \geq 1$ as we assumed there
exists at least one point of $T$ lying over $s$. Hence we see by
looking at stalks that
$$
s \in \text{WeakAss}(\mathcal{G})
\Leftrightarrow
s \in \text{WeakAss}(g_*g^*\mathcal{G})
$$
Now the assumption that $t \in \text{WeakAss}(g^*\mathcal{G})$
implies that $s \in \text{WeakAss}(g_*g^*\mathcal{G})$ by
Divisors, Lemma \ref{divisors-lemma-weakly-associated-finite}
and hence by the above $s \in  \text{WeakAss}(\mathcal{G})$.
\end{proof}

\begin{lemma}
\label{lemma-etale-weak-assassin-up-down}
Let $h : U \to S$ be an \'etale morphism of schemes.
Let $\mathcal{G}$ be a quasi-coherent $\mathcal{O}_S$-module.
Let $u \in U$ be a point with image $s \in S$. Then
$$
u \in \text{WeakAss}(h^*\mathcal{G})
\Leftrightarrow
s \in \text{WeakAss}(\mathcal{G})
$$
\end{lemma}

\begin{proof}
After replacing $S$ and $U$ by affine neighbourhoods of $s$ and $u$
we may assume that $g$ is a standard \'etale morphism of affines, see
Morphisms, Lemma \ref{morphisms-lemma-etale-locally-standard-etale}.
Thus we may assume $S = \text{Spec}(A)$ and
$X = \text{Spec}(A[x, 1/g]/(f))$, where $f$ is monic and $f'$
is invertible in $A[x, 1/g]$.
Note that $A[x, 1/g]/(f) = (A[x]/(f))_g$ is also the localization
of the finite free $A$-algebra $A[x]/(f)$. Hence we may think of
$U$ as an open subscheme of the scheme $T = \text{Spec}(A[x]/(f))$
which is finite locally free over $S$. This reduces us to 
Lemma \ref{lemma-finite-flat-weak-assassin-up-down}
above.
\end{proof}





\section{The local structure of a finite type module}
\label{section-local-structure-module}

\noindent
The key technical lemma that makes a lot of the arguments in this
chapter work is the geometric
Lemma \ref{lemma-elementary-devissage}.

\begin{lemma}
\label{lemma-sheaf-lives-on-subscheme}
Let $f : X \to S$ be a finite type morphism of affine schemes.
Let $\mathcal{F}$ be a finite type quasi-coherent $\mathcal{O}_X$-module.
Let $x \in X$ with image $s = f(x)$ in $S$.
Set $\mathcal{F}_s = \mathcal{F}|_{X_s}$.
Then there exist a closed immersion $i : Z \to X$ of finite presentation,
and a quasi-coherent finite type $\mathcal{O}_Z$-module $\mathcal{G}$
such that $i_*\mathcal{G} = \mathcal{F}$ and
$Z_s = \text{Supp}(\mathcal{F}_s)$.
\end{lemma}

\begin{proof}
Say the morphism $f : X \to S$ is given by the ring map
$A \to B$ and that $\mathcal{F}$ is the quasi-coherent sheaf
associated to the $B$-module $M$. By
Morphisms, Lemma \ref{morphisms-lemma-locally-finite-type-characterize}
we know that $A \to B$ is a finite type ring map, and by
Properties, Lemma \ref{properties-lemma-finite-type-module}
we know that $M$ is a finite $B$-module. In particular the
support of $\mathcal{F}$ is the closed subscheme of $\text{Spec}(B)$
cut out by the annihilator
$I = \{x \in B \mid xm = 0\ \forall m \in M\}$ of $M$, see
Algebra, Lemma \ref{algebra-lemma-support-closed}.
Let $\mathfrak q \subset B$ be the prime ideal corresponding to $x$
and let $\mathfrak p \subset A$ be the prime ideal corresponding to $s$.
Note that $X_s = \text{Spec}(B \otimes_A \kappa(\mathfrak p))$ and
that $\mathcal{F}_s$ is the quasi-coherent sheaf associated to the
$B \otimes_A \kappa(\mathfrak p)$ module $M \otimes_A \kappa(\mathfrak p)$. By
Coherent, Lemma \ref{coherent-lemma-support-finite-type}
the support of $\mathcal{F}_s$ is equal to
$V(I(B \otimes_A \kappa(\mathfrak p)))$. Since
$B \otimes_A \kappa(\mathfrak p)$ is of finite type over $\kappa(\mathfrak p)$
there exist finitely many elements $f_1, \ldots, f_m \in I$
such that
$$
I(B \otimes_A \kappa(\mathfrak p)) =
(f_1, \ldots, f_n)(B \otimes_A \kappa(\mathfrak p)).
$$
Denote $i : Z \to X$ the closed subscheme cut out by
$(f_1, \ldots, f_m)$, in a formula $Z = \text{Spec}(B/(f_1, \ldots, f_m))$.
Since $M$ is annihilated by $I$ we can think of $M$ as an
$B/(f_1, \ldots, f_m)$-module. In other words, $\mathcal{F}$ is the
pushforward of a finite type module on $Z$.
As $Z_s = \text{Supp}(\mathcal{F}_s)$ by construction, this
proves the lemma.
\end{proof}

\begin{lemma}
\label{lemma-elementary-devissage}
Let $f : X \to S$ be morphism of schemes which is locally of finite type.
Let $\mathcal{F}$ be a finite type quasi-coherent $\mathcal{O}_X$-module.
Let $x \in X$ with image $s = f(x)$ in $S$.
Set $\mathcal{F}_s = \mathcal{F}|_{X_s}$ and
$n = \dim_x(\text{Supp}(\mathcal{F}_s))$.
Then we can construct
\begin{enumerate}
\item elementary \'etale neighbourhoods $g : (X', x') \to (X, x)$,
$e : (S', s') \to (S, s)$,
\item a commutative diagram
$$
\xymatrix{
X \ar[dd]_f & X' \ar[dd] \ar[l]^g & Z' \ar[l]^i \ar[d]^\pi \\
& & Y' \ar[d]^h \\
S & S' \ar[l]_e & S' \ar@{=}[l]
}
$$
\item a point $z' \in Z'$ with $i(z') = x'$, $y' = \pi(z')$, $h(y') = s'$,
\item a finite type quasi-coherent $\mathcal{O}_{Z'}$-module $\mathcal{G}$,
\end{enumerate}
such that the following properties hold
\begin{enumerate}
\item $X'$, $Z'$, $Y'$, $S'$ are affine schemes,
\item $i$ is a closed immersion of finite presentation,
\item $i_*(\mathcal{G}) \cong g^*\mathcal{F}$,
\item $\pi$ is finite and $\pi^{-1}(\{y'\}) = \{z'\}$,
\item the extension $\kappa(s') \subset \kappa(y')$ is purely transcendental,
\item $h$ is smooth of relative dimension $n$
with geometrically integral fibres.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $V \subset S$ be an affine neighbourhood of $s$.
Let $U \subset f^{-1}(V)$ be an affine neighbourhood of $x$.
Then it suffices to prove the lemma for $f|_U : U \to V$ and
$\mathcal{F}|_U$. Hence in the rest of the proof we assume that
$X$ and $S$ are affine.

\medskip\noindent
First, suppose that $X_s = \text{Supp}(\mathcal{F}_s)$, in particular
$n = \dim_x(X_s)$. Apply
More on Morphisms,
Lemmas \ref{more-morphisms-lemma-local-local-structure-finite-type} and
\ref{more-morphisms-lemma-local-local-structure-finite-type-affine}.
This gives us a commutative diagram
$$
\xymatrix{
X \ar[dd] & X' \ar[l]^g \ar[d]^\pi \\
& Y' \ar[d]^h  \\
S & S' \ar[l]_e 
}
$$
and point $x' \in X'$. We set $Z' = X'$, $i = \text{id}$, and
$\mathcal{G} = g^*\mathcal{F}$ to obtain a solution in this case.

\medskip\noindent
In general choose a closed immersion $Z \to X$ and a sheaf
$\mathcal{G}$ on $Z$ as in
Lemma \ref{lemma-sheaf-lives-on-subscheme}.
Applying the result of the previous paragraph to $Z \to S$ and
$\mathcal{G}$ we obtain a diagram
$$
\xymatrix{
X \ar[dd]_f & Z \ar[l] \ar[dd]_{f|_Z} & Z' \ar[l]^g \ar[d]^\pi \\
& & Y' \ar[d]^h \\
S & S \ar@{=}[l] & S' \ar[l]_e
}
$$
and point $z' \in Z'$ satisfying all the required properties.
We will use
Lemma \ref{lemma-lift-etale}
to embed $Z'$ into a scheme \'etale over $X$. We cannot apply the lemma directly
as we want $X'$ to be a scheme over $S'$. Instead we
consider the morphisms
$$
\xymatrix{
Z' \ar[r] & Z \times_S S' \ar[r] & X \times_S S'
}
$$
The first morphism is \'etale by
Morphisms, Lemma \ref{morphisms-lemma-etale-permanence}.
The second is a closed immersion as a base change of a closed immersion.
Finally, as $X$, $S$, $S'$, $Z$, $Z'$ are all affine we may apply
Lemma \ref{lemma-lift-etale}
to get an \'etale morphism of affine schemes $X' \to X \times_S S'$ such that 
$$
Z' = (Z \times_S S') \times_{(X \times_S S')} X' = Z \times_X X'.
$$
As $Z \to X$ is a closed immersion of finite presentation, so is $Z' \to X'$.
Let $x' \in X'$ be the point corresponding to $z' \in Z'$.
Then the completed diagram
$$
\xymatrix{
X \ar[dd] & X' \ar[dd] \ar[l] & Z' \ar[l]^i \ar[d]^\pi \\
& & Y' \ar[d]^h \\
S & S' \ar[l]_e & S' \ar@{=}[l]
}
$$
is a solution of the original problem.
\end{proof}

\begin{lemma}
\label{lemma-devissage-finite-presentation}
Assumptions and notation as in
Lemma \ref{lemma-elementary-devissage}.
If $f$ is locally of finite presentation
then $\pi$ is of finite presentation.
In this case the following are equivalent
\begin{enumerate}
\item $\mathcal{F}$ is an $\mathcal{O}_X$-module of finite presentation
in a neighbourhood of $x$,
\item $\mathcal{G}$ is an $\mathcal{O}_{Z'}$-module of finite presentation
in a neighbourhood of $z'$, and
\item $\pi_*\mathcal{G}$ is an $\mathcal{O}_{Y'}$-module of
finite presentation in a neighbourhood of $y'$.
\end{enumerate}
Still assuming $f$ locally of finite presentation the following are
equivalent to each other
\begin{enumerate}
\item[(a)] $\mathcal{F}_x$ is an $\mathcal{O}_{X, x}$-module of finite
presentation,
\item[(b)] $\mathcal{G}_{z'}$ is an $\mathcal{O}_{Z', z'}$-module of
finite presentation, and
\item[(c)] $(\pi_*\mathcal{G})_{y'}$ is an $\mathcal{O}_{Y', y'}$-module
of finite presentation.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume $f$ locally of finite presentation. Then $Z' \to S$ is locally
of finite presentation as a composition of such, see
Morphisms, Lemma \ref{morphisms-lemma-composition-finite-presentation}.
Note that $Y' \to S$ is also locally of finite presentation as a composition
of a smooth and an \'etale morphism. Hence
Morphisms, Lemma \ref{morphisms-lemma-finite-presentation-permanence}
implies $\pi$ is locally of finite presentation.
Since $\pi$ is finite we conclude that it is also separated and
quasi-compact, hence $\pi$ is actually of finite presentation.

\medskip\noindent
To prove the equivalence of (1), (2), and (3) we also consider:
(4) $g^*\mathcal{F}$ is a $\mathcal{O}_{X'}$-module of finite presentation
in a neighbourhood of $x'$. The pull back of a module of finite presentation
is of finite presentation, see
Modules, Lemma \ref{modules-lemma-pullback-finite-presentation}.
Hence (1) $\Rightarrow$ (4).
The \'etale morphism $g$ is open, see
Morphisms, Lemma \ref{morphisms-lemma-etale-open}.
Hence for any open neighbourhood $U' \subset X'$ of $x'$, the image
$g(U')$ is an open neighbourhood of $x$ and the map
$\{U' \to g(U')\}$ is an \'etale covering. Thus (4) $\Rightarrow$ (1) by
Descent, Lemma \ref{descent-lemma-finite-presentation-descends}.
Using
Descent, Lemma \ref{descent-lemma-finite-finitely-presented-module}
and some easy topological arguments (see
More on Morphisms,
Lemma \ref{more-morphisms-lemma-finite-morphism-single-point-in-fibre})
we see that
(4) $\Leftrightarrow$ (2) $\Leftrightarrow$ (3).

\medskip\noindent
To prove the equivalence of (a), (b), (c) consider the ring maps
$$
\mathcal{O}_{X, x} \to
\mathcal{O}_{X', x'} \to
\mathcal{O}_{Z', z'} \leftarrow
\mathcal{O}_{Y', y'}
$$
The first ring map is faithfully flat. Hence
$\mathcal{F}_x$ is of finite presentation over $\mathcal{O}_{X, x}$
if and only if $g^*\mathcal{F}_{x'}$ is of finite presentation over
$\mathcal{O}_{X', x'}$, see
Algebra, Lemma \ref{algebra-lemma-descend-properties-modules}.
The second ring map is surjective (hence finite) and
finitely presented by assumption, hence
$g^*\mathcal{F}_{x'}$ is of finite presentation over $\mathcal{O}_{X', x'}$
if and only if $\mathcal{G}_{z'}$ is of finite presentation over
$\mathcal{O}_{Z', z'}$, see
Algebra, Lemma \ref{algebra-lemma-finite-finitely-presented-extension}.
Because $\pi$ is finite, of finite presentation, and
$\pi^{-1}(\{y'\}) = \{x'\}$ the ring homomorphism
$\mathcal{O}_{Y', y'} \leftarrow \mathcal{O}_{Z', z'}$ is finite
and of finite presentation, see
More on Morphisms,
Lemma \ref{more-morphisms-lemma-finite-morphism-single-point-in-fibre}.
Hence $\mathcal{G}_{z'}$ is of finite presentation over $\mathcal{O}_{Z', z'}$
if and only if $\pi_*\mathcal{G}_{y'}$ is of finite presentation over
$\mathcal{O}_{Y', y'}$, see
Algebra, Lemma \ref{algebra-lemma-finite-finitely-presented-extension}.
\end{proof}

\begin{lemma}
\label{lemma-devissage-flat}
Assumptions and notation as in
Lemma \ref{lemma-elementary-devissage}.
The following are equivalent
\begin{enumerate}
\item $\mathcal{F}$ is flat over $S$ in a neighbourhood of $x$,
\item $\mathcal{G}$ is flat over $S'$ in a neighbourhood of $z'$, and
\item $\pi_*\mathcal{G}$ is flat over $S'$ in a neighbourhood of $y'$.
\end{enumerate}
The following are equivalent also
\begin{enumerate}
\item[(a)] $\mathcal{F}_x$ is flat over $\mathcal{O}_{S, s}$,
\item[(b)] $\mathcal{G}_{z'}$ is flat over $\mathcal{O}_{S', s'}$, and
\item[(c)] $(\pi_*\mathcal{G})_{y'}$ is flat over $\mathcal{O}_{S', s'}$.
\end{enumerate}
\end{lemma}

\begin{proof}
To prove the equivalence of (1), (2), and (3) we also consider:
(4) $g^*\mathcal{F}$ is flat over $S$ in a neighbourhood of $x'$.
We will use
Lemma \ref{lemma-etale-flat-up-down}
to equate flatness over $S$ and $S'$ without further mention.
The \'etale morphism $g$ is flat and open, see
Morphisms, Lemma \ref{morphisms-lemma-etale-open}.
Hence for any open neighbourhood $U' \subset X'$ of $x'$, the image
$g(U')$ is an open neighbourhood of $x$ and the map
$U' \to g(U')$ is surjective and flat.
Thus (4) $\Leftrightarrow$ (1) by
Morphisms, Lemma \ref{morphisms-lemma-flat-permanence}.
Note that
$$
\Gamma(X', g^*\mathcal{F}) =
\Gamma(Z', \mathcal{G}) =
\Gamma(Y', \pi_*\mathcal{G})
$$
Hence the flatness of $g^*\mathcal{F}$, $\mathcal{G}$ and $\pi_*\mathcal{G}$
over $S'$ are all equivalent (this uses that $X'$, $Z'$, $Y'$, and
$S'$ are all affine). Some omitted topological arguments (compare
More on Morphisms,
Lemma \ref{more-morphisms-lemma-finite-morphism-single-point-in-fibre})
regarding affine neighbourhoods now show that
(4) $\Leftrightarrow$ (2) $\Leftrightarrow$ (3).

\medskip\noindent
To prove the equivalence of (a), (b), (c) consider the commutative diagram
of local ring maps
$$
\xymatrix{
\mathcal{O}_{X', x'} \ar[r]_\iota &
\mathcal{O}_{Z', z'} &
\mathcal{O}_{Y', y'} \ar[l]^\alpha &
\mathcal{O}_{S', s'} \ar[l]^\beta \\
\mathcal{O}_{X, x} \ar[u]^\gamma & & &
\mathcal{O}_{S, s} \ar[lll]_\varphi \ar[u]_\epsilon
}
$$
We will use
Lemma \ref{lemma-etale-flat-up-down-local-ring}
to equate flatness over $\mathcal{O}_{S, s}$ and $\mathcal{O}_{S', s'}$
without further mention.
The map $\gamma$ is faithfully flat. Hence
$\mathcal{F}_x$ is flat over $\mathcal{O}_{S, s}$
if and only if $g^*\mathcal{F}_{x'}$ is flat over
$\mathcal{O}_{S', s'}$, see
Algebra, Lemma \ref{algebra-lemma-flatness-descends-more-general}.
As $\mathcal{O}_{S', s'}$-modules the modules
$g^*\mathcal{F}_{x'}$, $\mathcal{G}_{z'}$, and
$\pi_*\mathcal{G}_{y'}$ are all isomorphic, see
More on Morphisms,
Lemma \ref{more-morphisms-lemma-finite-morphism-single-point-in-fibre}.
This finishes the proof.
\end{proof}









\section{One step d\'evissage}
\label{section-one-step-devissage}

\noindent
In this section we explain what is a one step d\'evissage of a
module. A one step d\'evissage exist \'etale locally on base and target.
We discuss base change, Zariski shrinking and \'etale localization of
a one step d\'evissage.

\begin{definition}
\label{definition-one-step-devissage}
Let $S$ be a scheme.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module of finite type.
Let $s \in S$ be a point.
A {\it one step d\'evissage of $\mathcal{F}/X/S$ over $s$}
is given by morphisms of schemes over $S$
$$
\xymatrix{
X & Z \ar[l]_i \ar[r]^\pi & Y
}
$$
and a quasi-coherent $\mathcal{O}_Z$-module $\mathcal{G}$ of finite type
such that
\begin{enumerate}
\item $X$, $S$, $Z$ and $Y$ are affine,
\item $i$ is a closed immersion of finite presentation,
\item $\mathcal{F} \cong i_*\mathcal{G}$,
\item $\pi$ is finite, and
\item the structure morphism $Y \to S$ is smooth with
geometrically irreducible fibres of
dimension $\dim(\text{Supp}(\mathcal{F}_s))$.
\end{enumerate}
In this case we say $(Z, Y, i, \pi, \mathcal{G})$ is a one step
d\'evissage of $\mathcal{F}/X/S$ over $s$.
\end{definition}

\noindent
Note that such a one step d\'evissage can only exist if $X$ and $S$
are affine. In the definition above we only require $X$ to be
(locally) of finite type over $S$ and we continue working in this
setting below. In \cite{GruRay} the authors use consistently the setup
where $X \to S$ is locally of finite presentation and $\mathcal{F}$
quasi-coherent $\mathcal{O}_X$-module of finite type. The advantage
of this choice is that it ``makes sense'' to ask for $\mathcal{F}$ to
be of finite presentation as an $\mathcal{O}_X$-module, whereas in our
setting it ``does not make sense''. Please see
Section \ref{section-finite-type-finite-presentation}
for a discussion; the observations made there show that in our setup
we may consider the condition of $\mathcal{F}$ being ``locally of finite
presentation relative to $S$'', and we could work consistently with this
notion. Instead however, we will rely on the results of
Lemma \ref{lemma-devissage-finite-presentation}
and the observations in
Remark \ref{remark-finite-presentation}
to deal with this issue in an ad hoc fashion whenever it comes up.

\begin{definition}
\label{definition-one-step-devissage-at-x}
Let $S$ be a scheme.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module of finite type.
Let $x \in X$ be a point with image $s$ in $S$.
A {\it one step d\'evissage of $\mathcal{F}/X/S$ at $x$}
is a system $(Z, Y, i, \pi, \mathcal{G}, z, y)$, where
$(Z, Y, i, \pi, \mathcal{G})$ is a one step d\'evissage of
$\mathcal{F}/X/S$ over $s$ and
\begin{enumerate}
\item $\dim_x(\text{Supp}(\mathcal{F}_s)) = \dim(\text{Supp}(\mathcal{F}_s))$,
\item $z \in Z$ is a point with $i(z) = x$ and $\pi(z) = y$,
\item we have $\pi^{-1}(\{y\}) = \{z\}$,
\item the extension $\kappa(s) \subset \kappa(y)$ is purely
transcendental.
\end{enumerate}
\end{definition}

\noindent
A one step d\'evissage of $\mathcal{F}/X/S$ at $x$ can only exist if
$X$ and $S$ are affine. Condition (1) assures us that $Y \to S$ has
relative dimension equal to $\dim_x(\text{Supp}(\mathcal{F}_s))$
via condition (5) of
Definition \ref{definition-one-step-devissage}.

\begin{lemma}[Reformulation of Lemma \ref{lemma-elementary-devissage}]
\label{lemma-elementary-devissage-variant}
Let $f : X \to S$ be morphism of schemes which is locally of finite type.
Let $\mathcal{F}$ be a finite type quasi-coherent $\mathcal{O}_X$-module.
Let $x \in X$ with image $s = f(x)$ in $S$.
Then there exists a commutative diagram of pointed schemes
$$
\xymatrix{
(X, x) \ar[d]_f & (X', x') \ar[l]^g \ar[d] \\
(S, s) & (S', s') \ar[l] \\
}
$$
such that $(S', s') \to (S, s)$ and $(X', x') \to (X, x)$
are elementary \'etale neighbourhoods, and such that
$g^*\mathcal{F}/X'/S'$ has a one step d\'evissage at $x'$.
\end{lemma}

\begin{proof}
This is immediate from
Definition \ref{definition-one-step-devissage-at-x}
and
Lemma \ref{lemma-elementary-devissage}.
\end{proof}

\begin{lemma}
\label{lemma-base-change-one-step}
Let $S$, $X$, $\mathcal{F}$, $s$ be as in
Definition \ref{definition-one-step-devissage}.
Let $(Z, Y, i, \pi, \mathcal{G})$ be a one step d\'evissage
of $\mathcal{F}/X/S$ over $s$.
Let $(S', s') \to (S, s)$ be any morphism of pointed schemes.
Given this data let $X', Z', Y', i', \pi'$ be the base
changes of $X, Z, Y, i, \pi$ via $S' \to S$.
Let $\mathcal{F}'$ be the pullback of $\mathcal{F}$ to $X'$
and let $\mathcal{G}'$ be the pullback of $\mathcal{G}$ to $Z'$.
If $S'$ is affine, then $(Z', Y', i', \pi', \mathcal{G}')$
is a one step d\'evissage of $\mathcal{F}'/X'/S'$ over $s'$.
\end{lemma}

\begin{proof}
Fibre products of affines are affine, see
Schemes, Lemma \ref{schemes-lemma-fibre-product-affines}.
Base change preserves
closed immersions,
morphisms of finite presentation,
finite morphisms,
smooth morphisms,
morphisms with geometrically irreducible fibres, and
morphisms of relative dimension $n$, see
Morphisms, Lemmas \ref{morphisms-lemma-base-change-closed-immersion},
\ref{morphisms-lemma-base-change-finite-presentation},
\ref{morphisms-lemma-base-change-finite},
\ref{morphisms-lemma-base-change-smooth}, 
\ref{morphisms-lemma-base-change-relative-dimension-d}, and
More on Morphisms, Lemma
\ref{more-morphisms-lemma-base-change-fibres-geometrically-irreducible}.
We have $i'_*\mathcal{G}' \cong \mathcal{F}'$ because pushforward
along the finite morphism $i$ commutes with base change, see
Coherent, Lemma \ref{coherent-lemma-affine-base-change}.
We have
$\dim(\text{Supp}(\mathcal{F}_s)) = \dim(\text{Supp}(\mathcal{F}'_{s'}))$
by
Morphisms, Lemma \ref{morphisms-lemma-dimension-fibre-after-base-change}
because
$$
\text{Supp}(\mathcal{F}_s) \times_s s' = \text{Supp}(\mathcal{F}'_{s'}).
$$
This proves the lemma.
\end{proof}

\begin{lemma}
\label{lemma-base-change-one-step-at-x}
Let $S$, $X$, $\mathcal{F}$, $x$, $s$ be as in
Definition \ref{definition-one-step-devissage-at-x}.
Let $(Z, Y, i, \pi, \mathcal{G}, z, y)$ be a one step d\'evissage
of $\mathcal{F}/X/S$ at $x$.
Let $(S', s') \to (S, s)$ be a morphism of pointed schemes
which induces an isomorphism $\kappa(s) = \kappa(s')$.
Let $(Z', Y', i', \pi', \mathcal{G}')$ be as constructed in
Lemma \ref{lemma-base-change-one-step}
and let $x' \in X'$ (resp.\ $z' \in Z'$, $y' \in Y'$) be the
unique point mapping to both $x \in X$ (resp.\ $z \in Z$, $y \in Y$)
and $s' \in S'$.
If $S'$ is affine, then $(Z', Y', i', \pi', \mathcal{G}', z', y')$
is a one step d\'evissage of $\mathcal{F}'/X'/S'$ at $x'$.
\end{lemma}

\begin{proof}
By
Lemma \ref{lemma-base-change-one-step}
$(Z', Y', i', \pi', \mathcal{G}')$ is a one step d\'evissage of
$\mathcal{F}'/X'/S'$ over $s'$. Properties (1) -- (4) of
Definition \ref{definition-one-step-devissage-at-x}
hold for $(Z', Y', i', \pi', \mathcal{G}', z', y')$
as the assumption that $\kappa(s) = \kappa(s')$ insures that the fibres
$X'_{s'}$, $Z'_{s'}$, and $Y'_{s'}$ are isomorphic to
$X_s$, $Z_s$, and $Y_s$.
\end{proof}

\begin{definition}
\label{definition-shrink}
Let $S$, $X$, $\mathcal{F}$, $x$, $s$ be as in
Definition \ref{definition-one-step-devissage-at-x}.
Let $(Z, Y, i, \pi, \mathcal{G}, z, y)$ be a one step d\'evissage
of $\mathcal{F}/X/S$ at $x$. Let us define a
{\it standard shrinking} of this situation to be
given by standard opens $S' \subset S$, $X' \subset X$, $Z' \subset Z$,
and $Y' \subset Y$ such that $s \in S'$, $x \in X'$, $z \in Z'$, and
$y \in Y'$ and such that
$$
(Z', Y', i|_{Z'}, \pi|_{Z'}, \mathcal{G}|_{Z'}, z, y)
$$
is a one step d\'evissage of $\mathcal{F}|_{X'}/X'/S'$ at $x$.
\end{definition}

\begin{lemma}
\label{lemma-shrink}
With assumption and notation as in
Definition \ref{definition-shrink}
we have:
\begin{enumerate}
\item
\label{item-shrink-base}
If $S' \subset S$ is a standard open neighbourhood of $s$, then
setting $X' = X_{S'}$, $Z' = Z_{S'}$ and $Y' = Y_{S'}$ we obtain a
standard shrinking.
\item
\label{item-shrink-on-Y}
Let $W \subset Y$ be a standard open neighbourhood of $y$.
Then there exists a standard shrinking with $Y' = W \times_S S'$.
\item
\label{item-shrink-on-X}
Let $U \subset X$ be an open neighbourhood of $x$.
Then there exists a standard shrinking with $X' \subset U$.
\end{enumerate}
\end{lemma}

\begin{proof}
Part (1) is immediate from
Lemma \ref{lemma-base-change-one-step-at-x}
and the fact that the inverse image of a standard open under a morphism
of affine schemes is a standard open, see
Algebra, Lemma \ref{algebra-lemma-spec-functorial}.

\medskip\noindent
Let $W \subset Y$ as in (2). Because $Y \to S$ is smooth it is open, see
Morphisms, Lemma \ref{morphisms-lemma-smooth-open}.
Hence we can find a standard open neighbourhood $S'$ of $s$
contained in the image of $W$. Then the fibres of $W_{S'} \to S'$
are nonempty open subschemes of the fibres of $Y \to S$ over $S'$
and hence geometrically irreducible too. Setting $Y' = W_{S'}$
and $Z' = \pi^{-1}(Y')$ we see that $Z' \subset Z$ is a standard open
neighbourhood of $z$. Let $\overline{h} \in \Gamma(Z, \mathcal{O}_Z)$
be a function such that $Z' = D(\overline{h})$. As $i : Z \to X$
is a closed immersion, we can find a function $h \in \Gamma(X, \mathcal{O}_X)$
such that $i^\sharp(h) = \overline{h}$. Take $X' = D(h) \subset X$.
In this way we obtain a standard shrinking as in (2).

\medskip\noindent
Let $U \subset X$ be as in (3). We may after shrinking $U$ assume that
$U$ is a standard open. By
More on Morphisms,
Lemma \ref{more-morphisms-lemma-finite-morphism-single-point-in-fibre}
there exists a standard open $W \subset Y$ neighbourhood of $y$ such
that $\pi^{-1}(W) \subset i^{-1}(U)$. Apply (2) to get a standard
shrinking $X', S', Z', Y'$ with $Y' = W_{S'}$. Since
$Z' \subset \pi^{-1}(W) \subset i^{-1}(U)$ we may replace $X'$ by
$X' \cap U$ (still a standard open as $U$ is also standard open)
without violating any of the conditions defining a standard shrinking.
Hence we win.
\end{proof}

\begin{lemma}
\label{lemma-elementary-etale-neighbourhood}
Let $S$, $X$, $\mathcal{F}$, $x$, $s$ be as in
Definition \ref{definition-one-step-devissage-at-x}.
Let $(Z, Y, i, \pi, \mathcal{G}, z, y)$ be a one step d\'evissage
of $\mathcal{F}/X/S$ at $x$. Let
$$
\xymatrix{
(Y, y) \ar[d] & (Y', y') \ar[l] \ar[d] \\
(S, s) & (S', s') \ar[l]
}
$$
be a commutative diagram of pointed schemes such that the horizontal
arrows are elementary \'etale neighbourhoods. Then there exists
a commutative diagram
$$
\xymatrix{
& & (X'', x'') \ar[lld] \ar[d] & (Z'', z'') \ar[l] \ar[lld] \ar[d] \\
(X, x) \ar[d] & (Z, z) \ar[l] \ar[d] &
(S'', s'') \ar[lld] & (Y'', y'') \ar[lld] \ar[l] \\
(S, s) & (Y, y) \ar[l]
}
$$
of pointed schemes with the following properties:
\begin{enumerate}
\item $(S'', s'') \to (S', s')$ is an elementary \'etale neighbourhood and
the morphism $S'' \to S$ is the composition $S'' \to S' \to S$,
\item $Y''$ is an open subscheme of $Y' \times_{S'} S''$,
\item $Z'' = Z \times_Y Y''$,
\item $(X'', x'') \to (X, x)$ is an elementary \'etale neighbourhood, and
\item $(Z'', Y'', i'', \pi'', \mathcal{G}'', z'', y'')$ is a one step
d\'evissage at $x''$ of the sheaf $\mathcal{F}''$.
\end{enumerate}
Here $\mathcal{F}''$ (resp.\ $\mathcal{G}''$) is the pullback of
$\mathcal{F}$ (resp.\ $\mathcal{G}$) via the morphism $X'' \to X$
(resp.\ $Z'' \to Z$) and $i'' : Z'' \to X''$ and $\pi'' : Z'' \to Y''$
are as in the diagram.
\end{lemma}

\begin{proof}
Let $(S'', s'') \to (S', s')$ be any elementary \'etale neighbourhood
with $S''$ affine. Let $Y'' \subset Y' \times_{S'} S''$ be any affine
open neighbourhood containing the point $y'' = (y', s'')$. Then we
obtain an affine $(Z'', z'')$ by (3). Moreover $Z_{S''} \to X_{S''}$
is a closed immersion and $Z'' \to Z_{S''}$ is an \'etale
morphism. Hence
Lemma \ref{lemma-lift-etale}
applies and we can find an \'etale morphism $X'' \to X_{S'}$ of affines
such that $Z'' \cong X'' \times_{X_{S'}} Z_{S'}$. Denote $i'' : Z'' \to X''$
the corresponding closed immersion. Setting $x'' = i''(z'')$ we obtain a
commutative diagram as in the lemma.
Properties (1), (2), (3), and (4) hold by construction.
Thus it suffices to show that (5) holds for a suitable choice of
$(S'', s'') \to (S', s')$ and $Y''$.

\medskip\noindent
We first list those properties which hold for any choice of
$(S'', s'') \to (S', s')$ and $Y''$ as in the first paragraph.
As we have $Z'' = X'' \times_X Z$ by construction we see that
$i''_*\mathcal{G}'' = \mathcal{F}''$ (with notation as in the
statement of the lemma), see
Coherent, Lemma \ref{coherent-lemma-affine-base-change}.
Set $n = \dim(\text{Supp}(\mathcal{F}_s)) = \dim_x(\text{Supp}(\mathcal{F}_s))$.
The morphism $Y'' \to S''$ is smooth of relative dimension $n$
(because $Y' \to S'$ is smooth of relative dimension $n$
as the composition $Y' \to Y_{S'} \to S'$ of an \'etale and
smooth morphism of relative dimension $n$ and because base change
preserves smooth morphisms of relative dimension $n$).
We have $\kappa(y'') = \kappa(y)$ and $\kappa(s) = \kappa(s'')$
hence $\kappa(y'')$ is a purely transcendental extension of $\kappa(s'')$.
The morphism of fibres $X''_{s''} \to X_s$ is an \'etale morphism of affine
schemes over $\kappa(s) = \kappa(s'')$ mapping the point $x''$ to the
point $x$ and pulling back $\mathcal{F}_s$ to $\mathcal{F}''_{s''}$.
Hence
$$
\dim(\text{Supp}(\mathcal{F}''_{s''})) =
\dim(\text{Supp}(\mathcal{F}_s)) = n =
\dim_x(\text{Supp}(\mathcal{F}_s)) =
\dim_{x''}(\text{Supp}(\mathcal{F}''_{s''}))
$$
because dimension is invariant under \'etale localization, see
Descent, Lemma \ref{descent-lemma-dimension-at-point-local}.
As $\pi'' : Z'' \to Y''$ is the base change of $\pi$ we see that
$\pi''$ is finite and as $\kappa(y) = \kappa(y'')$ we see that
$\pi^{-1}(\{y''\}) = \{z''\}$.

\medskip\noindent
At this point we have verified all the conditions of
Definition \ref{definition-one-step-devissage}
except we have not verfied that $Y'' \to S''$ has geometrically
irreducible fibres. Of course in general this is not going to be
true, and it is at this point that we will use that
$\kappa(s) \subset \kappa(y)$ is purely transcendental. Namely,
let $T \subset Y'_{s'}$ be the irreducible component of
$Y'_{s'}$ containing $y' = (y, s')$. Note that $T$ is an open subscheme
of $Y'_{s'}$ as this is a smooth scheme over $\kappa(s')$. By
Varieties,
Lemma \ref{varieties-lemma-geometrically-connected-if-connected-and-point}
we see that $T$ is geometrically connected because $\kappa(s') = \kappa(s)$
is algebraically closed in $\kappa(y') = \kappa(y)$.
As $T$ is smooth we see that $T$ is geometrically irreducible. Hence
More on Morphisms,
Lemma \ref{more-morphisms-lemma-normal-morphism-irreducible}
applies and we can find an elementary \'etale morphism
$(S'', s'') \to (S', s')$ and an affine open $Y'' \subset Y'_{S''}$
such that all fibres of $Y'' \to S''$ are geometrically irreducible
and such that $T = Y''_{s''}$. After shrinking (first $Y''$ and then $S''$)
we may assume that both $Y''$ and $S''$ are affine.
This finishes the proof of the lemma.
\end{proof}

\begin{lemma}
\label{lemma-existence-alpha}
Let $S$, $X$, $\mathcal{F}$, $s$ be as in
Definition \ref{definition-one-step-devissage}.
Let $(Z, Y, i, \pi, \mathcal{G})$ be a one step d\'evissage
of $\mathcal{F}/X/S$ over $s$.
Let $\xi \in Y_s$ be the (unique) generic point.
Then there exists an integer $r > 0$ and an $\mathcal{O}_Y$-module map
$$
\alpha : \mathcal{O}_Y^{\oplus r} \longrightarrow \pi_*\mathcal{G}
$$
such that
$$
\alpha :
\kappa(\xi)^{\oplus r}
\longrightarrow
(\pi_*\mathcal{G})_\xi \otimes_{\mathcal{O}_{Y, \xi}} \kappa(\xi)
$$
is an isomorphism. Moreover, in this case we have
$$
\dim(\text{Supp}(\text{Coker}(\alpha)_s)) < \dim(\text{Supp}(\mathcal{F}_s)).
$$
\end{lemma}

\begin{proof}
By assumption the schemes $S$ and $Y$ are affine.
Write $S = \text{Spec}(A)$ and $Y = \text{Spec}(B)$.
As $\pi$ is finite the $\mathcal{O}_Y$-module $\pi_*\mathcal{G}$
is a finite type quasi-coherent $\mathcal{O}_Y$-module.
Hence $\pi_*\mathcal{G} = \widetilde{N}$ for some finite $B$-module $N$.
Let $\mathfrak p \subset B$ be the prime ideal corresponding to $\xi$.
To obtain $\alpha$ set
$r = \dim_{\kappa(\mathfrak p)} N \otimes_B \kappa(\mathfrak p)$
and pick $x_1, \ldots, x_r \in N$ which form a basis of
$N \otimes_B \kappa(\mathfrak p)$. Take $\alpha : B^{\oplus r} \to N$
to be the map given by the formula $\alpha(b_1, \ldots, b_r) = \sum b_ix_i$.
It is clear that
$\alpha : \kappa(\mathfrak p)^{\oplus r} \to N \otimes_B \kappa(\mathfrak p)$
is an isomorphism as desired. Finally, suppose $\alpha$ is any map with this
property. Then $N' = \text{Coker}(\alpha)$ is a finite $B$-module
such that $N' \otimes \kappa(\mathfrak p) = 0$. By Nakayama's lemma
(Algebra, Lemma \ref{algebra-lemma-NAK})
we see that $N'_{\mathfrak p} = 0$. Since the fibre $Y_s$ is
geometrically irreducible of dimension $n$ with generic point $\xi$
and since we have just seen that $\xi$ is not in the support of
$\text{Coker}(\alpha)$ the last assertion of the lemma holds.
\end{proof}


\section{Complete d\'evissage}
\label{section-complete-devissage}

\noindent
In this section we explain what is a complete d\'evissage of a
module and prove that such exist. The material in this
section is mainly bookkeeping.

\begin{definition}
\label{definition-complete-devissage}
Let $S$ be a scheme.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module of finite type.
Let $s \in S$ be a point.
A {\it complete d\'evissage of $\mathcal{F}/X/S$ over $s$} is given by a
diagram
$$
\xymatrix{
X & Z_1 \ar[l]^{i_1} \ar[d]^{\pi_1} \\
& Y_1 & Z_2 \ar[l]^{i_2} \ar[d]^{\pi_2} \\
& & Y_2 & Z_3 \ar[l] \ar[d] \\
& & & ... & ... \ar[l] \ar[d] \\
& & & & Y_n
}
$$
of schemes over $S$, finite type quasi-coherent $\mathcal{O}_{Z_k}$-modules
$\mathcal{G}_k$, and $\mathcal{O}_{Y_k}$-module maps
$$
\alpha_k :
\mathcal{O}_{Y_k}^{\oplus r_k}
\longrightarrow
\pi_{k, *}\mathcal{G}_k,
\quad
k = 1, \ldots, n
$$
satisfying the following properties:
\begin{enumerate}
\item $(Z_1, Y_1, i_1, \pi_1, \mathcal{G}_1)$ is a one step
d\'evissage of $\mathcal{F}/X/S$ over $s$,
\item the map $\alpha_k$ induces an isomorphism
$$
\kappa(\xi_k)^{\oplus r_k} \longrightarrow
(\pi_{k, *}\mathcal{G}_k)_{\xi_k}
\otimes_{\mathcal{O}_{Y_k, \xi_k}} \kappa(\xi_k)
$$
where $\xi_k \in (Y_k)_s$ is the unique generic point,
\item for $k = 2, \ldots, n$ the system
$(Z_k, Y_k, i_k, \pi_k, \mathcal{G}_k)$
is a one step d\'evissage of $\text{Coker}(\alpha_{k - 1})/Y_{k - 1}/S$
over $s$,
\item $\text{Coker}(\alpha_n) = 0$.
\end{enumerate}
In this case we say that
$(Z_k, Y_k, i_k, \pi_k, \mathcal{G}_k, \alpha_k)_{k = 1, \ldots, n}$
is a complete d\'evissage of $\mathcal{F}/X/S$ over $s$.
\end{definition}

\begin{definition}
\label{definition-complete-devissage-at-x}
Let $S$ be a scheme.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module of finite type.
Let $x \in X$ be a point with image $s \in S$.
A {\it complete d\'evissage of $\mathcal{F}/X/S$ at $x$} is given by a
system
$$
(Z_k, Y_k, i_k, \pi_k, \mathcal{G}_k, \alpha_k, z_k, y_k)_{k = 1, \ldots, n}
$$
such that $(Z_k, Y_k, i_k, \pi_k, \mathcal{G}_k, \alpha_k)$ is a
complete d\'evissage of $\mathcal{F}/X/S$ over $s$, and such that
\begin{enumerate}
\item $(Z_1, Y_1, i_1, \pi_1, \mathcal{G}_1, z_1, y_1)$ is a one step
d\'evissage of $\mathcal{F}/X/S$ at $x$,
\item for $k = 2, \ldots, n$ the system
$(Z_k, Y_k, i_k, \pi_k, \mathcal{G}_k, z_k, y_k)$
is a one step d\'evissage of $\text{Coker}(\alpha_{k - 1})/Y_{k - 1}/S$
at $y_{k - 1}$.
\end{enumerate}
\end{definition}

\noindent
Again we remark that a complete d\'evissage can only exist if $X$ and
$S$ are affine.

\begin{lemma}
\label{lemma-base-change-complete}
Let $S$, $X$, $\mathcal{F}$, $s$ be as in
Definition \ref{definition-complete-devissage}.
Let $(S', s') \to (S, s)$ be any morphism of pointed schemes.
Let $(Z_k, Y_k, i_k, \pi_k, \mathcal{G}_k, \alpha_k)_{k = 1, \ldots, n}$
be a complete d\'evissage of $\mathcal{F}/X/S$ over $s$.
Given this data let $X', Z'_k, Y'_k, i'_k, \pi'_k$ be the base
changes of $X, Z_k, Y_k, i_k, \pi_k$ via $S' \to S$.
Let $\mathcal{F}'$ be the pullback of $\mathcal{F}$ to $X'$
and let $\mathcal{G}'_k$ be the pullback of $\mathcal{G}_k$ to $Z'_k$.
Let $\alpha'_k$ be the pullback of $\alpha_k$ to $Y'_k$.
If $S'$ is affine, then
$(Z'_k, Y'_k, i'_k, \pi'_k, \mathcal{G}'_k, \alpha'_k)_{k = 1, \ldots, n}$
is a complete d\'evissage of $\mathcal{F}'/X'/S'$ over $s'$.
\end{lemma}

\begin{proof}
By
Lemma \ref{lemma-base-change-one-step}
we know that the base change of a one step d\'evissage is a one step
d\'evissage. Hence it suffices to prove that formation of
$\text{Coker}(\alpha_k)$ commutes with base change and that
condition (2) of
Definition \ref{definition-complete-devissage}
is preserved by base change. The first is true as
$\pi'_{k, *}\mathcal{G}'_k$ is the pullback of
$\pi_{k, *}\mathcal{G}_k$ (by
Coherent, Lemma \ref{coherent-lemma-affine-base-change})
and because $\otimes$ is right exact. The second because
by the same token we have
$$
(\pi_{k, *}\mathcal{G}_k)_{\xi_k}
\otimes_{\mathcal{O}_{Y_k, \xi_k}} \kappa(\xi_k)
\otimes_{\kappa(\xi_k)} \kappa(\xi'_k)
\cong
(\pi'_{k, *}\mathcal{G}'_k)_{\xi'_k}
\otimes_{\mathcal{O}_{Y'_k, \xi'_k}} \kappa(\xi'_k)
$$
with obvious notation.
\end{proof}

\begin{lemma}
\label{lemma-base-change-complete-at-x}
Let $S$, $X$, $\mathcal{F}$, $x$, $s$ be as in
Definition \ref{definition-complete-devissage-at-x}.
Let $(S', s') \to (S, s)$ be a morphism of pointed schemes
which induces an isomorphism $\kappa(s) = \kappa(s')$. Let
$(Z_k, Y_k, i_k, \pi_k, \mathcal{G}_k, \alpha_k, z_k, y_k)_{k = 1, \ldots, n}$
be a complete d\'evissage of $\mathcal{F}/X/S$ at $x$.
Let
$(Z'_k, Y'_k, i'_k, \pi'_k, \mathcal{G}'_k, \alpha'_k)_{k = 1, \ldots, n}$
be as constructed in
Lemma \ref{lemma-base-change-complete}
and let $x' \in X'$ (resp.\ $z'_k \in Z'$, $y'_k \in Y'$) be the
unique point mapping to both $x \in X$ (resp.\ $z_k \in Z_k$, $y_k \in Y_k$)
and $s' \in S'$.
If $S'$ is affine, then
$(Z'_k, Y'_k, i'_k, \pi'_k, \mathcal{G}'_k, \alpha'_k,
z'_k, y'_k)_{k = 1, \ldots, n}$
is a complete d\'evissage of $\mathcal{F}'/X'/S'$ at $x'$.
\end{lemma}

\begin{proof}
Combine
Lemma \ref{lemma-base-change-complete}
and
Lemma \ref{lemma-base-change-one-step-at-x}.
\end{proof}

\begin{definition}
\label{definition-shrink-complete}
Let $S$, $X$, $\mathcal{F}$, $x$, $s$ be as in
Definition \ref{definition-complete-devissage-at-x}.
Consider a complete d\'evissage
$(Z_k, Y_k, i_k, \pi_k, \mathcal{G}_k, \alpha_k, z_k, y_k)_{k = 1, \ldots, n}$
of $\mathcal{F}/X/S$ at $x$. Let us define a
{\it standard shrinking} of this situation to be
given by standard opens $S' \subset S$, $X' \subset X$,
$Z'_k \subset Z_k$, and $Y'_k \subset Y_k$ such that $s_k \in S'$,
$x_k \in X'$, $z_k \in Z'$, and $y_k \in Y'$ and such that
$$
(Z'_k, Y'_k, i'_k, \pi'_k,
\mathcal{G}'_k, \alpha'_k, z_k, y_k)_{k = 1, \ldots, n}
$$
is a one step d\'evissage of $\mathcal{F}'/X'/S'$ at $x$ where
$\mathcal{G}'_k = \mathcal{G}_k|_{Z'_k}$ and
$\mathcal{F}' = \mathcal{F}|_{X'}$.
\end{definition}

\begin{lemma}
\label{lemma-shrink-complete}
With assumption and notation as in
Definition \ref{definition-shrink-complete}
we have:
\begin{enumerate}
\item
\label{item-shrink-base-complete}
If $S' \subset S$ is a standard open neighbourhood of $s$, then
setting $X' = X_{S'}$, $Z'_k = Z_{S'}$ and $Y'_k = Y_{S'}$ we obtain a
standard shrinking.
\item
\label{item-shrink-on-Y-complete}
Let $W \subset Y_n$ be a standard open neighbourhood of $y$.
Then there exists a standard shrinking with $Y'_n = W \times_S S'$.
\item
\label{item-shrink-on-X-complete}
Let $U \subset X$ be an open neighbourhood of $x$.
Then there exists a standard shrinking with $X' \subset U$.
\end{enumerate}
\end{lemma}

\begin{proof}
Part (1) is immediate from
Lemmas \ref{lemma-base-change-complete-at-x} and
\ref{lemma-shrink}.

\medskip\noindent
Proof of (2). For convenience denote $X = Y_0$. We apply
Lemma \ref{lemma-shrink} (\ref{item-shrink-on-Y})
to find a standard shrinking
$S', Y'_{n - 1}, Z'_n, Y'_n$
of the one step d\'evissage of $\text{Coker}(\alpha_{n - 1})/Y_{n - 1}/S$
at $y_{n - 1}$ with $Y'_n = W \times_S S'$. We may repeat this procedure
and find a standard shrinking
$S'', Y''_{n - 2}, Z''_{n - 1}, Y''_{n - 1}$
of the one step d\'evissage of $\text{Coker}(\alpha_{n - 2})/Y_{n - 2}/S$
at $y_{n - 2}$ with $Y''_{n - 1} = Y'_{n - 1} \times_S S''$.
We may continue in this manner until we obtain
$S^{(n)}, Y^{(n)}_0, Z^{(n)}_1, Y^{(n)}_1$.
At this point it is clear that we obtain our desired standard shrinking
by taking $S^{(n)}$, $X^{(n)}$, $Z_k^{(n - k)} \times_S S^{(n)}$, and
$Y_k^{(n - k)} \times_S S^{(n)}$ with the desired property.

\medskip\noindent
Proof of (3). We use induction on the length of the complete
d\'evissage. First we apply
Lemma \ref{lemma-shrink} (\ref{item-shrink-on-X})
to find a standard shrinking
$S', X', Z'_1, Y'_1$ 
of the one step d\'evissage of $\mathcal{F}/X/S$ at $x$
with $X' \subset U$. If $n = 1$, then we are done.
If $n > 1$, then by induction we can find a standard shrinking
$S''$, $Y''_1$, $Z''_k$, and $Y''_k$ of the complete d\'evissage
$(Z_k, Y_k, i_k, \pi_k, \mathcal{G}_k, \alpha_k, z_k, y_k)_{k = 2, \ldots, n}$
of $\text{Coker}(\alpha_1)/Y_1/S$ at $x$ such that
$Y''_1 \subset Y'_1$. Using
Lemma \ref{lemma-shrink} (\ref{item-shrink-on-Y})
we can find $S''' \subset S'$, $X''' \subset X'$, $Z'''_1$ and
$Y'''_1 = Y''_1 \times_S S'''$ which is a standard shrinking.
The solution to our problem is to take
$$
S''', X''', Z'''_1, Y'''_1, Z''_2 \times_S S''',
Y''_2 \times_S S''', \ldots, Z''_n \times_S S''', Y''_n \times_S S'''
$$
This ends the proof of the lemma.
\end{proof}

\begin{proposition}
\label{proposition-existence-complete-at-x}
Let $S$ be a scheme.
Let $X$ be locally of finite type over $S$.
Let $x \in X$ be a point with image $s \in S$.
There exists a commutative diagram
$$
\xymatrix{
(X, x) \ar[d] & (X', x') \ar[l]^g \ar[d] \\
(S, s) & (S', s') \ar[l]
}
$$
of pointed schemes such that the horizontal
arrows are elementary \'etale neighbourhoods
and such that $g^*\mathcal{F}/X'/S'$ has a complete
d\'evissage at $x$.
\end{proposition}

\begin{proof}
We prove this by induction on the integer
$d = \dim_x(\text{Supp}(\mathcal{F}_s))$.
By
Lemma \ref{lemma-elementary-devissage-variant}
there exists a diagram
$$
\xymatrix{
(X, x) \ar[d] & (X', x') \ar[l]^g \ar[d] \\
(S, s) & (S', s') \ar[l]
}
$$
of pointed schemes such that the horizontal
arrows are elementary \'etale neighbourhoods
and such that $g^*\mathcal{F}/X'/S'$ has a one step d\'evissage at $x'$.
The local nature of the problem implies that we may replace
$(X, x) \to (S, s)$ by $(X', x') \to (S', s')$. Thus after doing so
we may assume that there exists a one step d\'evissage
$(Z_1, Y_1, i_1, \pi_1, \mathcal{G}_1)$ of $\mathcal{F}/X/S$ at $x$.

\medskip\noindent
We apply
Lemma \ref{lemma-existence-alpha}
to find a map
$$
\alpha_1 :
\mathcal{O}_{Y_1}^{\oplus r_1}
\longrightarrow
\pi_{1, *}\mathcal{G}_1
$$
which induces an isomorphism of vector spaces over $\kappa(\xi_1)$
where $\xi_1 \in Y_1$ is the unique generic point of the fibre of
$Y_1$ over $s$. Moreover
$\dim_{y_1}(\text{Supp}(\text{Coker}(\alpha_1)_{s})) < d$.
It may happen that the stalk of $\text{Coker}(\alpha_1)_{s}$
at $y_1$ is zero. In this case we may shrink $Y_1$ by
Lemma \ref{lemma-shrink} (\ref{item-shrink-on-Y})
and assume that $\text{Coker}(\alpha_1) = 0$ so we obtain a
complete d\'evissage of length zero.

\medskip\noindent
Assume now that the stalk of $\text{Coker}(\alpha_1)_{s}$
at $y_1$ is not zero. In this case, by induction, there exists a
commutative diagram
\begin{equation}
\label{equation-overcome-this}
\vcenter{
\xymatrix{
(Y_1, y_1) \ar[d] & (Y'_1, y'_1) \ar[l]^h \ar[d] \\
(S, s) & (S', s') \ar[l]
}
}
\end{equation}
of pointed schemes such that the horizontal
arrows are elementary \'etale neighbourhoods
and such that $h^*\text{Coker}(\alpha_1)/Y'_1/S'$ has a complete
d\'evissage
$$
(Z_k, Y_k, i_k, \pi_k, \mathcal{G}_k, \alpha_k, z_k, y_k)_{k = 2, \ldots, n}
$$
at $y'_1$. (In particular $i_2 : Z_2 \to Y'_1$ is a closed immersion into
$Y'_2$.) At this point we apply
Lemma \ref{lemma-elementary-etale-neighbourhood}
to $S, X, \mathcal{F}, x, s$, the system
$(Z_1, Y_1, i_1, \pi_1, \mathcal{G}_1)$ and
diagram (\ref{equation-overcome-this}). We obtain a diagram
$$
\xymatrix{
& & (X'', x'') \ar[lld] \ar[d] & (Z''_1, z''_1) \ar[l] \ar[lld] \ar[d] \\
(X, x) \ar[d] & (Z_1, z_1) \ar[l] \ar[d] &
(S'', s'') \ar[lld] & (Y''_1, y''_1) \ar[lld] \ar[l] \\
(S, s) & (Y_1, y_1) \ar[l]
}
$$
with all the properties as listed in the referenced lemma.
In particular $Y''_1 \subset Y'_1 \times_{S'} S''$. Set
$X_1 = Y'_1 \times_{S'} S''$ and let $\mathcal{F}_1$ denote the
pullback of $\text{Coker}(\alpha_1)$. By
Lemma \ref{lemma-base-change-complete-at-x}
the system
\begin{equation}
\label{equation-shrink-this}
(Z_k \times_{S'} S'',
Y_k \times_{S'} S'', i''_k, \pi''_k, \mathcal{G}''_k,
\alpha''_k, z''_k, y''_k)_{k = 2, \ldots, n}
\end{equation}
is a complete d\'evissage of $\mathcal{F}_1$
to $X_1$. Again, the nature of the problem allows
us to replace $(X, x) \to (S, s)$ by $(X'', x'') \to (S'', s'')$.
In this we see that we may assume:
\begin{enumerate}
\item[(a)] There exists a one step d\'evissage
$(Z_1, Y_1, i_1, \pi_1, \mathcal{G}_1)$ of $\mathcal{F}/X/S$ at $x$,
\item[(b)] there exists an $\alpha_1 : \mathcal{O}_{Y_1}^{\oplus r_1}
\to \pi_{1, *}\mathcal{G}_1$ such that $\alpha \otimes \kappa(\xi_1)$
is an isomorphism,
\item[(c)] $Y_1 \subset X_1$ is open, $y_1 = x_1$, and
$\mathcal{F}_1|_{Y_1} \cong \text{Coker}(\alpha_1)$, and
\item[(d)] there exists a complete d\'evissage
$(Z_k, Y_k, i_k, \pi_k, \mathcal{G}_k, \alpha_k, z_k, y_k)_{k = 2, \ldots, n}$
of $\mathcal{F}_1/X_1/S$ at $x_1$.
\end{enumerate}
To finish the proof all we have to do is shrink the one step d\'evissage
and the complete d\'evissage such that they fit together to a complete
d\'evissage. (We suggest the reader do this on their own using
Lemmas \ref{lemma-shrink} and
\ref{lemma-shrink-complete}
instead of reading the proof that follows.) Since $Y_1 \subset X_1$
is an open neighbourhood of $x_1$ we may apply
Lemma \ref{lemma-shrink-complete} (\ref{item-shrink-on-X-complete})
to find a standard shrinking $S', X'_1, Z'_2, Y'_2, \ldots, Y'_n$
of the datum (d) so that $X'_1 \subset Y_1$. Note that $X'_1$ is also
a standard open of the affine scheme $Y_1$. Next, we shrink the datum
(a) as follows: first we shrink the base $S$ to $S'$, see
Lemma \ref{lemma-shrink} (\ref{item-shrink-base}) and then
we shrink the result to $S''$, $X''$, $Z''_1$, $Y''_1$ using
Lemma \ref{lemma-shrink} (\ref{item-shrink-on-Y})
such that eventually $Y''_1 = X'_1 \times_S S''$ and $S'' \subset S'$.
Then we see that
$$
Z''_1, Y''_1, Z'_2 \times_{S'} S'', Y'_2 \times_{S'} S'', \ldots,
Y'_n \times_{S'} S''
$$
gives the complete d\'evissage we were looking for.
\end{proof}

\noindent
Some more bookkeeping gives the following consequence.

\begin{lemma}
\label{lemma-existence-complete}
Let $X \to S$ be a finite type morphism of schemes.
Let $\mathcal{F}$ be a finite type quasi-coherent $\mathcal{O}_X$-module.
Let $s \in S$ be a point.
There exists an elementary \'etale neighbourhood
$(S', s') \to (S, s)$ and \'etale morphisms
$h_i : Y_i \to X_{S'}$, $i = 1, \ldots, n$ such that for each
$i$ there exists a complete d\'evissage of $\mathcal{F}_i/Y_i/S'$ over $s'$,
where $\mathcal{F}_i$ is the pullback of $\mathcal{F}_i$ to $Y_i$
and such that $X_s = (X_{S'})_{s'} \subset \bigcup h_i(Y_i)$.
\end{lemma}

\begin{proof}
For every point $x \in X_s$ we can find a diagram
$$
\xymatrix{
(X, x) \ar[d] & (X', x') \ar[l]^g \ar[d] \\
(S, s) & (S', s') \ar[l]
}
$$
of pointed schemes such that the horizontal arrows are elementary
\'etale neighbourhoods and such that $g^*\mathcal{F}/X'/S'$ has a
complete d\'evissage at $x'$. As $X \to S$ is of finite type the
fibre $X_s$ is quasi-compact, and since each $g : X' \to X$ as above
is open we can cover $X_s$ by a finite union of $g(X'_{s'})$.
Thus we can find a finite family of such diagrams
$$
\vcenter{
\xymatrix{
(X, x) \ar[d] & (X'_i, x'_i) \ar[l]^{g_i} \ar[d] \\
(S, s) & (S'_i, s'_i) \ar[l]
}
}
\quad i = 1, \ldots, n
$$
such that $X_s = \bigcup g_i(X'_i)$. Set
$S' = S'_1 \times_S \ldots \times_S S'_n$
and let $Y_i = X_i \times_{S'_i} S'$ be the base change of $X'_i$ to $S'$. By
Lemma \ref{lemma-base-change-complete}
we see that the pullback of $\mathcal{F}$ to $Y_i$ has a complete d\'evissage
over $s$ and we win.
\end{proof}



\section{Translation into algebra}
\label{section-translation}

\noindent
It may be useful to spell out algebraically what it means to have a
complete d\'evissage. We introduce the following notion (which is not
that useful so we give it an impossibly long name).

\begin{definition}
\label{definition-elementary-etale-neighbourhood}
Let $R \to S$ be a ring map. Let $\mathfrak q$ be a prime of $S$ lying over
the prime $\mathfrak p$ of $R$. A {\it elementary \'etale localization of
the ring map $R \to S$ at $\mathfrak q$} is given by a commutative diagram
of rings and accompanying primes
$$
\xymatrix{
S \ar[r] & S' \\
R \ar[u] \ar[r] & R' \ar[u]
}
\quad\quad
\xymatrix{
\mathfrak q \ar@{-}[r] & \mathfrak q' \\
\mathfrak p \ar@{-}[u] \ar@{-}[r] & \mathfrak p' \ar@{-}[u]
}
$$
such that $R \to R'$ and $S \to S'$ are \'etale ring maps and
$\kappa(\mathfrak p) = \kappa(\mathfrak p')$ and
$\kappa(\mathfrak q) = \kappa(\mathfrak q')$.
\end{definition}

\begin{definition}
\label{definition-complete-devissage-algebra}
Let $R \to S$ be a finite type ring map.
Let $\mathfrak r$ be a prime of $R$.
Let $N$ be a finite $S$-module.
A {\it complete d\'evissage of $N/S/R$ over $\mathfrak r$}
is given by $R$-algebra maps
$$
\xymatrix{
& A_1 & & A_2 & & ... & & A_n \\
S \ar[ru] & & B_1 \ar[lu] \ar[ru] & & ... \ar[lu] \ar[ru] & &
... \ar[lu] \ar[ru] & & B_n \ar[lu]
}
$$
finite $A_i$-modules $M_i$ and $B_i$-module maps
$\alpha_i : B_i^{\oplus r_i} \to M_i$ such that
\begin{enumerate}
\item $S \to A_1$ is surjective and of finite presentation,
\item $B_i \to A_{i + 1}$ is surjective and of finite presentation,
\item $B_i \to A_i$ is finite,
\item $R \to B_i$ is smooth with geometrically irreducible fibres,
\item $N \cong M_1$ as $S$-modules,
\item $\text{Coker}(\alpha_i) \cong M_{i + 1}$ as $B_i$-modules,
\item $\alpha_i : \kappa(\mathfrak p_i)^{\oplus r_i}
\to M_i \otimes_{B_i} \kappa(\mathfrak p_i)$ is an isomorphism
where $\mathfrak p_i = \mathfrak rB_i$, and
\item $\text{Coker}(\alpha_n) = 0$.
\end{enumerate}
In this situation we say that
$(A_i, B_i, M_i, \alpha_i)_{i = 1, \ldots, n}$
is a complete d\'evissage of $N/S/R$ over $\mathfrak r$. 
\end{definition}

\begin{remark}
\label{remark-finite-presentation}
Note that the $R$-algebras $B_i$ for all $i$ and $A_i$ for $i \geq 2$
are of finite presentation over $R$. If $S$ is of finite presentation over
$R$, then it is also the case that $A_1$ is of finite presentation over
$R$. In this case all the ring maps in the complete d\'evissage are of
finite presentation. See
Algebra, Lemma \ref{algebra-lemma-compose-finite-type}.
Still assuming $S$ of finite presentation over $R$
the following are equivalent
\begin{enumerate}
\item $M$ is of finite presentation over $S$,
\item $M_1$ is of finite presentation over $A_1$,
\item $M_1$ is of finite presentation over $B_1$,
\item each $M_i$ is of finite presentation both as an $A_i$-module
and as a $B_i$-module.
\end{enumerate}
The equivalences (1) $\Leftrightarrow$ (2) and (2) $\Leftrightarrow$ (3)
follow from
Algebra, Lemma \ref{algebra-lemma-finite-finitely-presented-extension}.
If $M_1$ is finitely presented, so is $\text{Coker}(\alpha_1)$ (see
Algebra, Lemma \ref{algebra-lemma-extension})
and hence $M_2$, etc.
\end{remark}

\begin{definition}
\label{definition-complete-devissage-at-x-algebra}
Let $R \to S$ be a finite type ring map.
Let $\mathfrak q$ be a prime of $S$ lying over the prime $\mathfrak r$ of $R$.
Let $N$ be a finite $S$-module.
A {\it complete d\'evissage of $N/S/R$ at $\mathfrak q$} is given by a
complete d\'evissage $(A_i, B_i, M_i, \alpha_i)_{i = 1, \ldots, n}$
of $N/S/R$ over $\mathfrak r$ and prime ideals $\mathfrak q_i \subset B_i$
lying over $\mathfrak r$ such that
\begin{enumerate}
\item $\kappa(\mathfrak r) \subset \kappa(\mathfrak q_i)$ is purely
transcendental,
\item there is a unique prime $\mathfrak q'_i \subset A_i$
lying over $\mathfrak q_i \subset B_i$,
\item $\mathfrak q = \mathfrak q'_1 \cap S$ and
$\mathfrak q_i = \mathfrak q'_{i + 1} \cap A_i$,
\item $R \to B_i$ has relative dimension
$\dim_{\mathfrak q_i}(\text{Supp}(M_i \otimes_R \kappa(\mathfrak r)))$.
\end{enumerate}
\end{definition}

\begin{remark}
\label{remark-same-notion}
Let $A \to B$ be a finite type ring map and let $N$ be a finite
$B$-module. Let $\mathfrak q$ be a prime of $B$ lying over the prime
$\mathfrak r$ of $A$. Set $X = \text{Spec}(B)$, $S = \text{Spec}(A)$ and
$\mathcal{F} = \widetilde{N}$ on $X$. Let $x$ be the point corresponding
to $\mathfrak q$ and let $s \in S$ be the point corresponding to
$\mathfrak p$. Then
\begin{enumerate}
\item if there exists a complete d\'evissage of $\mathcal{F}/X/S$
over $s$ then there exists a complete d\'evissage of
$N/B/A$ over $\mathfrak p$, and
\item there exists a complete d\'evissage of $\mathcal{F}/X/S$
at $x$ if and only if there exists a complete d\'evissage of
$N/B/A$ at $\mathfrak q$.
\end{enumerate}
There is just a small twist in that we omitted the condition on
the relative dimension in the formulation of ``a complete d\'evissage of
$N/B/A$ over $\mathfrak p$'' which is why the implication in (1)
only goes in one direction.
The notion of a complete d\'evissage at
$\mathfrak q$ does have this condition built in. In any case we will
only use that existence for $\mathcal{F}/X/S$
implies the existence for $N/B/A$.
\end{remark}

\begin{lemma}
\label{lemma-existence-algebra}
Let $R \to S$ be a finite type ring map.
Let $M$ be a finite $S$-module.
Let $\mathfrak q$ be a prime ideal of $S$.
There exists an elementary \'etale localization
$R' \to S', \mathfrak q', \mathfrak p'$ of
the ring map $R \to S$ at $\mathfrak q$ such that
there exists a complete d\'evissage of
$(M \otimes_S S')/S'/R'$ at $\mathfrak q'$.
\end{lemma}

\begin{proof}
This is a reformulation of
Proposition \ref{proposition-existence-complete-at-x}
via
Remark \ref{remark-same-notion}
\end{proof}




\section{Localization and universally injective maps}
\label{section-localize-universally-injective}


\begin{lemma}
\label{lemma-homothety-spectrum}
Let $R \to S$ be a ring map.
Let $N$ be a $S$-module.
Assume
\begin{enumerate}
\item $R$ is a local ring with maximal ideal $\mathfrak m$,
\item $\overline{S} = S/\mathfrak m S$ is Noetherian, and
\item $\overline{N} = N/\mathfrak m_R N$ is a finite $\overline{S}$-module.
\end{enumerate}
Let $\Sigma \subset S$ be the multiplicative subset of elements which are not
a zero divisor on $\overline{N}$. Then $\Sigma^{-1}S$ is a semi-local ring
whose spectrum consists of primes $\mathfrak q \subset S$ contained in an
element of $\text{Ass}_S(\overline{N})$. Moreover, any maximal
ideal of $\Sigma^{-1}S$ corresponds to an associated prime of
$\overline{N}$ over $\overline{S}$.
\end{lemma}

\begin{proof}
Note that
$\text{Ass}_S(\overline{N}) = \text{Ass}_{\overline{S}}(\overline{N})$, see
Algebra, Lemma \ref{algebra-lemma-ass-quotient-ring}.
This is a finite set by
Algebra, Lemma \ref{algebra-lemma-finite-ass}.
Say $\{\mathfrak q_1, \ldots, \mathfrak q_r\} = \text{Ass}_S(\overline{N})$.
We have $\Sigma = S \setminus (\bigcup \mathfrak q_i)$ by
Algebra, Lemma \ref{algebra-lemma-ass-zero-divisors}.
By the description of $\text{Spec}(\Sigma^{-1}S)$ in
Algebra, Lemma \ref{algebra-lemma-spec-localization}
we see that the primes of $\Sigma^{-1}S$ correspond to the primes of
$S$ contained in one of the $\mathfrak q_i$.
Hence the maximal ideals of $\Sigma^{-1}S$ correspond one-to-one with the
maximal (w.r.t.\ inclusion) elements of the set
$\{\mathfrak q_1, \ldots, \mathfrak q_r\}$. This proves the lemma.
\end{proof}

\begin{lemma}
\label{lemma-homothety-universally-injective}
Assumption and notation as in
Lemma \ref{lemma-homothety-spectrum}.
Assume moreover that
\begin{enumerate}
\item $S$ is local and $R \to S$ is a local homomorphism,
\item $S$ is essentially of finite presentation over $R$,
\item $N$ is finitely presented over $S$, and
\item $N$ is flat over $R$.
\end{enumerate}
Then each $s \in \Sigma$ defines a
universally injective $R$-module map $s : N \to N$, and the
map $N \to \Sigma^{-1}N$ is $R$-universally injective.
\end{lemma}

\begin{proof}
By
Algebra, Lemma \ref{algebra-lemma-mod-injective-general}
the sequence $0 \to N \to N \to N/sN \to 0$ is exact and
$N/sN$ is flat over $R$. This implies that $s : N \to N$
is universally injective, see
Algebra, Lemma \ref{algebra-lemma-flat-tor-zero}.
The map $N \to \Sigma^{-1}N$ is universally injective as the directed
colimit of the maps $s : N \to N$.
\end{proof}

\begin{lemma}
\label{lemma-base-change-universally-flat-local}
Let $R \to S$ be a ring map.
Let $N$ be an $S$-module.
Let $S \to S'$ be a ring map.
Assume
\begin{enumerate}
\item $R \to S$ is a local homomorphism of local rings
\item $S$ is essentially of finite presentation over $R$,
\item $N$ is of finite presentation over $S$,
\item $N$ is flat over $R$,
\item $S \to S'$ is flat, and
\item the image of $\text{Spec}(S') \to \text{Spec}(S)$ contains
all primes $\mathfrak q$ of $S$ lying over $\mathfrak m_R$
such that $\mathfrak q$ is an associated prime of $N/\mathfrak m_R N$.
\end{enumerate}
Then $N \to N \otimes_R S'$ is $R$-universally injective.
\end{lemma}

\begin{proof}
Set $N' = N \otimes_R S'$. Consider the commutative diagram
$$
\xymatrix{
N \ar[d] \ar[r] & N' \ar[d] \\
\Sigma^{-1}N \ar[r] & \Sigma^{-1}N'
}
$$
where $\Sigma \subset S$ is the set of elements which are not a
zero divisor on $N/\mathfrak m_R N$. If we can show that the map
$N \to \Sigma^{-1}N'$ is universally injective, then $N \to N'$
is too (see
Algebra, Lemma \ref{algebra-lemma-universally-injective-permanence}).

\medskip\noindent
By
Lemma \ref{lemma-homothety-spectrum}
the ring $\Sigma^{-1}S$ is a semi-local ring whose maximal ideals
correspond to associated primes of $N/\mathfrak m_R N$.
Hence the image of
$\text{Spec}(\Sigma^{-1}S') \to \text{Spec}(\Sigma^{-1}S)$
contains all these maximal ideals by assumption. By
Algebra, Lemma \ref{algebra-lemma-ff-rings}
the ring map $\Sigma^{-1}S \to \Sigma^{-1}S'$ is faithfully flat.
Hence $\Sigma^{-1}N \to \Sigma^{-1}N'$, which is the map
$$
N \otimes_S \Sigma^{-1}S \longrightarrow N \otimes_S \Sigma^{-1}S'
$$
is universally injective, see
Algebra, Lemmas \ref{algebra-lemma-faithfully-flat-universally-injective} and
\ref{algebra-lemma-universally-injective-tensor}.
Finally, we apply
Lemma \ref{lemma-homothety-universally-injective}
to see that $N \to \Sigma^{-1}N$ is universally injective.
As the composition of universally injective module maps is universally
injective (see
Algebra, Lemma \ref{algebra-lemma-composition-universally-injective})
we conclude that $N \to \Sigma^{-1}N'$ is universally injective and we win.
\end{proof}

\begin{lemma}
\label{lemma-base-change-universally-flat}
Let $R \to S$ be a ring map.
Let $N$ be an $S$-module.
Let $S \to S'$ be a ring map.
Assume
\begin{enumerate}
\item $R \to S$ is of finite presentation and $N$ is of finite presentation
over $S$,
\item $N$ is flat over $R$,
\item $S \to S'$ is flat, and
\item the image of $\text{Spec}(S') \to \text{Spec}(S)$ contains
all primes $\mathfrak q$ such that $\mathfrak q$ is an associated prime
of $N \otimes_R \kappa(\mathfrak p)$ where $\mathfrak p$ is the inverse
image of $\mathfrak q$ in $R$.
\end{enumerate}
Then $N \to N \otimes_R S'$ is $R$-universally injective.
\end{lemma}

\begin{proof}
By
Algebra, Lemma \ref{algebra-lemma-universally-injective-check-stalks}
it suffices to show that $N_{\mathfrak q} \to (N \otimes_R S')_{\mathfrak q}$
is a $R_{\mathfrak p}$-universally injective for any prime $\mathfrak q$
of $S$ lying over $\mathfrak p$ in $R$. Thus we may apply
Lemma \ref{lemma-base-change-universally-flat-local}
to the ring maps
$R_{\mathfrak p} \to S_{\mathfrak q} \to S'_{\mathfrak q}$
and the module $N_{\mathfrak q}$.
\end{proof}

\noindent
The reader may want to compare the following lemma to
Algebra, Lemma \ref{algebra-lemma-mod-injective} and
Lemma \ref{algebra-lemma-mod-injective-general}.
In each case the conclusion is that the map $u : M \to N$ is
universally injective with flat cokernel.

\begin{lemma}
\label{lemma-universally-injective-local}
Let $(R, \mathfrak m)$ be a local ring. Let $u : M \to N$ be an $R$-module map.
If $M$ is a projective $R$-module, $N$ is a flat $R$-module, and
$\overline{u} : M/\mathfrak mM \to N/\mathfrak mN$ is injective
then $u$ is universally injective.
\end{lemma}

\begin{proof}
By
Algebra, Theorem \ref{algebra-theorem-projective-free-over-local-ring}
the module $M$ is free. If we show the result holds for every finitely
generated direct summand of $M$, then the lemma follows. Hence we may
assume that $M$ is finite free. Write $N = \text{colim}_i\ N_i$ as
a directed colimit of finite free modules, see
Algebra, Theorem \ref{algebra-theorem-lazard}.
Note that $u : M \to N$ factors through $N_i$ for some $i$ (as $M$ is finite
free). Denote $u_i : M \to N_i$ the corresponding $R$-module map.
As $\overline{u}$ is injective we see that
$\overline{u_i} : M/\mathfrak mM \to N_i/\mathfrak mN_i$ is
injective and remains injective on composing with the maps
$N_i/\mathfrak mN_i \to N_{i'}/\mathfrak mN_{i'}$ for all $i' \geq i$.
As $M$ and $N_{i'}$ are finite free over the local ring $R$ this implies
that $M \to N_{i'}$ is a split injection for all $i' \geq i$. Hence
for any $R$-module $Q$ we see that $M \otimes_R Q \to N_{i'} \otimes_R Q$
is injective for all $i' \geq i$. As $- \otimes_R Q$ commutes with
colimits we conclude that $M \otimes_R Q \to N_{i'} \otimes_R Q$
is injective as desired.
\end{proof}

\begin{lemma}
\label{lemma-invert-universally-injective}
Assumption and notation as in
Lemma \ref{lemma-homothety-spectrum}.
Assume moreover that $N$ is projective as an $R$-module.
Then each $s \in \Sigma$ defines a
universally injective $R$-module map $s : N \to N$, and the
map $N \to \Sigma^{-1}N$ is $R$-universally injective.
\end{lemma}

\begin{proof}
Pick $s \in \Sigma$. By
Lemma \ref{lemma-universally-injective-local}
the map $s : N \to N$ is universally injective.
The map $N \to \Sigma^{-1}N$ is universally injective as the directed
colimit of the maps $s : N \to N$.
\end{proof}






\section{Completion and Mittag-Leffler modules}
\label{section-completion-ML}

\begin{lemma}
\label{lemma-universally-injective-completion-direct-sum-into-product}
Let $R$ be a ring.
Let $I \subset R$ be an ideal.
Let $A$ be a set.
Assume $R$ is Noetherian and complete with respect to $I$. Then
$$
\left(\bigoplus\nolimits_{\alpha \in A} R\right)^\wedge
\longrightarrow
\prod\nolimits_{\alpha \in A} R
$$
of the $I$-adic completion of the direct sum into the
direct product is universally injective.
\end{lemma}

\begin{proof}
By definition an element $x$ of the left hand side is $x = (x_n)$ where
$x_n = (x_{n, \alpha}) \in \bigoplus\nolimits_{\alpha \in A} R/I^n$
such that $x_{n, \alpha} = x_{n + 1, \alpha} \bmod I^n$. 
As $R = R^\wedge$ we see that for any $\alpha$ there exists a $y_\alpha \in R$
such that $x_{n, \alpha} = y_\alpha \bmod I^n$. Note that for each $n$ there
are only finitely many $\alpha$ such that the elements $x_{n, \alpha}$ are
nonzero. Conversely, given $(y_\alpha) \in \prod_\alpha R$ such that for each
$n$ there are only finitely many $\alpha$ such that $y_{\alpha} \bmod I^n$
is nonzero, then this defines an element of the left hand side.
Hence we can think of an element of the left hand side as infinite
``convergent sums'' $\sum_\alpha y_\alpha$ with $y_\alpha \in R$
such that for each $n$ there are only finitely many $y_\alpha$
which are nonzero modulo $I^n$. The displayed map maps this element
to the element to $(y_\alpha)$ in the product.
In particular the map is injective.

\medskip\noindent
Let $Q$ be a finite $R$-module. We have to show that the map
$$
Q \otimes_R \left(\bigoplus\nolimits_{\alpha \in A} R\right)^\wedge
\longrightarrow
Q \otimes_R \left(\prod\nolimits_{\alpha \in A} R\right)
$$
is injective, see
Algebra, Theorem \ref{algebra-theorem-universally-exact-criteria}.
Choose a presentation $R^{\oplus k} \to R^{\oplus m} \to Q \to 0$
and denote $q_1, \ldots, q_m \in Q$ the corresponding generators for $Q$.
By Artin-Rees
(Algebra, Lemma \ref{algebra-lemma-Artin-Rees})
there exists a constant $c$ such that
$\text{Im}(R^{\oplus k} \to R^{\oplus m}) \cap (I^N)^{\oplus m}
\subset \text{Im}((I^{N - c})^{\oplus k} \to R^{\oplus m})$.
Let us contemplate the diagram
$$
\xymatrix{
\bigoplus_{l = 1}^k \left(\bigoplus\nolimits_{\alpha \in A} R\right)^\wedge
\ar[r] \ar[d] &
\bigoplus_{j = 1}^m \left(\bigoplus\nolimits_{\alpha \in A} R\right)^\wedge
\ar[r] \ar[d] &
Q \otimes_R \left(\bigoplus\nolimits_{\alpha \in A} R\right)^\wedge
\ar[r] \ar[d] &
0 \\
\bigoplus_{l = 1}^k \left(\prod\nolimits_{\alpha \in A} R\right)
\ar[r] &
\bigoplus_{j = 1}^m \left(\prod\nolimits_{\alpha \in A} R\right)
\ar[r] &
Q \otimes_R \left(\prod\nolimits_{\alpha \in A} R\right)
\ar[r] &
0
}
$$
with exact rows. Pick an element $\sum_j \sum_\alpha y_{j, \alpha}$ of
$\bigoplus_{j = 1, \ldots, m}
\left(\bigoplus\nolimits_{\alpha \in A} R\right)^\wedge$.
If this element maps to zero in the module
$Q \otimes_R \left(\prod\nolimits_{\alpha \in A} R\right)$,
then we see in particular that
$\sum_j q_j \otimes y_{j, \alpha} = 0$ in $Q$ for each $\alpha$.
Thus we can find an element
$(z_{1, \alpha}, \ldots, z_{k, \alpha}) \in \bigoplus_{l = 1, \ldots, k} R$
which maps to
$(y_{1, \alpha}, \ldots, y_{m, \alpha}) \in \bigoplus_{j = 1, \ldots, m} R$.
Moreover, if $y_{j, \alpha} \in I^{N_\alpha}$ for $j = 1, \ldots, m$, then
we may assume that $z_{l, \alpha} \in I^{N_\alpha - c}$ for
$l = 1, \ldots, k$.
Hence the sum $\sum_l \sum_\alpha z_{l, \alpha}$ is ``convergent'' and
defines an element of
$\bigoplus_{l = 1, \ldots, k}
\left(\bigoplus\nolimits_{\alpha \in A} R\right)^\wedge$
which maps to the element $\sum_j \sum_\alpha y_{j, \alpha}$ we started
out with. Thus the right vertical arrow is injective and we win.
\end{proof}

\begin{lemma}
\label{lemma-completed-direct-sum-ML}
Let $R$ be a ring. Let $I \subset R$ be an ideal. Let $A$ be a set.
Assume $R$ is Noetherian and complete with respect to $I$. The completion
$\left(\bigoplus\nolimits_{\alpha \in A} R\right)^\wedge$
is flat and Mittag-Leffler.
\end{lemma}

\begin{proof}
By
Lemma \ref{lemma-universally-injective-completion-direct-sum-into-product}
the map $\left(\bigoplus\nolimits_{\alpha \in A} R\right)^\wedge
\to \prod_{\alpha \in A} R$ is universally injective.
Thus, by
Algebra, Lemmas \ref{algebra-lemma-ui-flat-domain} and
\ref{algebra-lemma-pure-submodule-ML}
it suffices to show that $\prod_{\alpha \in A} R$ is flat and Mittag-Leffler.
By
Algebra, Proposition \ref{algebra-proposition-characterize-coherent}
(and
Algebra, Lemma \ref{algebra-lemma-Noetherian-coherent})
we see that $\prod_{\alpha \in A} R$ is flat.
Thus we conclude because a product of copies of $R$ is Mittag-Leffler, see
Algebra, Lemma \ref{algebra-lemma-product-over-Noetherian-ring}.
\end{proof}

\begin{lemma}
\label{lemma-lift-ML}
Let $R$ be a ring. Let $I \subset R$ be an ideal.
Let $M$ be an $R$-module.
Assume
\begin{enumerate}
\item $R$ is Noetherian and $I$-adically complete,
\item $M$ is flat over $R$, and
\item $M/IM$ is a projective $R/I$-module.
\end{enumerate}
Then the $I$-adic completion $M^\wedge$ is a flat Mittag-Leffler
$R$-module.
\end{lemma}

\begin{proof}
Choose a surjection $F \to M$ where $F$ is a free $R$-module. By
Algebra, Lemma \ref{algebra-lemma-split-completed-sequence}
the module $M^\wedge$ is a direct summand of the module $F^\wedge$.
Hence it suffices to prove the lemma for $F$.
In this case the lemma follows from
Lemma \ref{lemma-completed-direct-sum-ML}.
\end{proof}

\noindent
In
Lemmas \ref{lemma-universally-injective-to-completion} and
\ref{lemma-universally-injective-to-completion-flat}
the assumption that $S$ be Noetherian holds if $R \to S$ is of finite type, see
Algebra, Lemma \ref{algebra-lemma-Noetherian-permanence}.

\begin{lemma}
\label{lemma-universally-injective-to-completion}
Let $R$ be a ring.
Let $I \subset R$ be an ideal.
Let $R \to S$ be a ring map, and $N$ an $S$-module.
Assume
\begin{enumerate}
\item $R$ is a Noetherian ring,
\item $S$ is a Noetherian ring,
\item $N$ is a finite $S$-module, and
\item for any finite $R$-module $Q$, any
$\mathfrak q \in \text{Ass}_S(Q \otimes_R N)$
satisfies $IS + \mathfrak q \not = S$.
\end{enumerate}
Then the map $N \to N^\wedge$ of $N$ into the $I$-adic completion of $N$
is universally injective as a map of $R$-modules.
\end{lemma}

\begin{proof}
We have to show that for any finite $R$-module $Q$ the map
$Q \otimes_R N \to Q \otimes_R N^\wedge$ is injective, see
Algebra, Theorem \ref{algebra-theorem-universally-exact-criteria}.
As there is a canonical map $Q \otimes_R N^\wedge \to (Q \otimes_R N)^\wedge$
it suffices to prove that the canonical map
$Q \otimes_R N \to (Q \otimes_R N)^\wedge$ is injective.
Hence we may replace $N$ by $Q \otimes_R N$ and it suffices to prove the
injectivity for the map $N \to N^\wedge$.

\medskip\noindent
Let $K = \text{Ker}(N \to N^\wedge)$. It suffices to show that
$K_{\mathfrak q} = 0$ for $\mathfrak q \in \text{Ass}(N)$ as $N$ is a
submodule of $\prod_{\mathfrak q \in \text{Ass}(N)} N_{\mathfrak q}$, see
Algebra, Lemma \ref{algebra-lemma-zero-at-ass-zero}.
Pick $\mathfrak q \in \text{Ass}(N)$. By the last assumption we see that
there exists a prime $\mathfrak q' \supset IS + \mathfrak q$.
Since $K_{\mathfrak q}$ is a localization of $K_{\mathfrak q'}$
it suffices to prove the vanishing of $K_{\mathfrak q'}$.
Note that $K = \bigcap I^nN$, hence
$K_{\mathfrak q'} \subset \bigcap I^nN_{\mathfrak q'}$.
Hence $K_{\mathfrak q'} = 0$ by
Algebra, Lemma \ref{algebra-lemma-intersect-powers-ideal-module-zero}.
\end{proof}

\begin{lemma}
\label{lemma-universally-injective-to-completion-flat}
Let $R$ be a ring.
Let $I \subset R$ be an ideal.
Let $R \to S$ be a ring map, and $N$ an $S$-module.
Assume
\begin{enumerate}
\item $R$ is a Noetherian ring,
\item $S$ is a Noetherian ring,
\item $N$ is a finite $S$-module,
\item $N$ is flat over $R$, and
\item for any prime $\mathfrak q \subset S$ which is an associated prime of
$N \otimes_R \kappa(\mathfrak p)$ where $\mathfrak p = R \cap \mathfrak q$
we have $IS + \mathfrak q \not = S$.
\end{enumerate}
Then the map $N \to N^\wedge$ of $N$ into the $I$-adic completion of $N$
is universally injective as a map of $R$-modules.
\end{lemma}

\begin{proof}
This follows from
Lemma \ref{lemma-universally-injective-to-completion}
because
Algebra, Lemma \ref{algebra-lemma-bourbaki-fibres}
and
Remark \ref{algebra-remark-bourbaki}
guarantee that the set of associated primes of tensor products
$N \otimes_R Q$ are contained in the set of associated primes of
the modules $N \otimes_R \kappa(\mathfrak p)$.
\end{proof}




\section{Projective modules}
\label{section-projective}

\noindent
The following lemma can be used to prove projectivity by
Noetherian induction on the base, see
Lemma \ref{lemma-fibres-irreducible-flat-projective}.

\begin{lemma}
\label{lemma-flat-pure-over-complete-projective}
Let $R$ be a ring.
Let $I \subset R$ be an ideal.
Let $R \to S$ be a ring map, and $N$ an $S$-module.
Assume
\begin{enumerate}
\item $R$ is Noetherian and $I$-adically complete,
\item $R \to S$ is of finite type,
\item $N$ is a finite $S$-module,
\item $N$ is flat over $R$,
\item $N/IN$ is projective as a $R/I$-module, and
\item for any prime $\mathfrak q \subset S$ which is an associated prime of
$N \otimes_R \kappa(\mathfrak p)$ where $\mathfrak p = R \cap \mathfrak q$
we have $IS + \mathfrak q \not = S$.
\end{enumerate}
Then $N$ is projective as an $R$-module.
\end{lemma}

\begin{proof}
By
Lemma \ref{lemma-universally-injective-to-completion-flat}
the map $N \to N^\wedge$ is universally injective.
By
Lemma \ref{lemma-lift-ML}
the module $N^\wedge$ is Mittag-Leffler.
By
Algebra, Lemma \ref{algebra-lemma-pure-submodule-ML}
we conclude that $N$ is Mittag-Leffler.
Hence $N$ is countably generated, flat and Mittag-Leffler as an $R$-module,
whence projective by
Algebra, Lemma \ref{algebra-lemma-countgen-projective}.
\end{proof}

\begin{lemma}
\label{lemma-fibres-irreducible-flat-projective}
Let $R$ be a ring.
Let $R \to S$ be a ring map.
Assume
\begin{enumerate}
\item $R$ is Noetherian,
\item $R \to S$ is of finite type and flat, and
\item every fibre ring $S \otimes_R \kappa(\mathfrak p)$ is
geometrically integral over $\kappa(\mathfrak p)$.
\end{enumerate}
Then $S$ is projective as an $R$-module.
\end{lemma}

\begin{proof}
Consider the set
$$
\{I \subset R \mid S/IS\text{ not projective as }R/I\text{-module}\}
$$
We have to show this set is empty. To get a contradiction assume it is
nonempty. Then it contains a maximal element $I$.
Let $J = \sqrt{I}$ be its radical. If $I \not = J$, then
$S/JS$ is projective as a $R/J$-module, and $S/IS$ is flat over $R/I$
and $J/I$ is a nilpotent ideal in $R/I$. Applying
Algebra, Lemma \ref{algebra-lemma-lift-projective}
we see that $S/IS$ is a projective $R/I$-module, which is a contradiction.
Hence we may assume that $I$ is a radical ideal. In other words we
are reduced to proving the lemma in case $R$ is a reduced ring and
$S/IS$ is a projective $R/I$-module for every nonzero ideal $I$
of $R$.

\medskip\noindent
Assume $R$ is a reduced ring and $S/IS$ is a projective $R/I$-module
for every nonzero ideal $I$ of $R$. By generic flatness,
Algebra, Lemma \ref{algebra-lemma-generic-flatness-Noetherian}
(applied to a localization $R_g$ which is a domain) or the more general
Algebra, Lemma \ref{algebra-lemma-generic-flatness-reduced}
there exists a nonzero $f \in R$ such that $S_f$ is free as an
$R_f$-module. Denote $R^\wedge = \lim R/(f^n)$ the $(f)$-adic completion
of $R$. Note that the ring map
$$
R \longrightarrow R_f \times R^\wedge
$$
is a faithfully flat ring map, see
Algebra, Lemma \ref{algebra-lemma-completion-flat}.
Hence by faithfully flat descent of projectivity, see
Algebra, Theorem \ref{algebra-theorem-ffdescent-projectivity}
it suffices to prove that $S \otimes_R R^\wedge$ is a projective
$R^\wedge$-module. To see this we will use the criterion of
Lemma \ref{lemma-fibres-irreducible-flat-projective}.
First of all, note that $S/fS = (S \otimes_R R^\wedge)/f(S \otimes_R R^\wedge)$
is a projective $R/(f)$-module and that $S \otimes_R R^\wedge$ is flat
and of finite type over $R^\wedge$ as a base change of such.
Next, suppose that $\mathfrak p^\wedge$ is a prime ideal
of $R^\wedge$. Let $\mathfrak p \subset R$ be the corresponding prime
of $R$. As $R \to S$ has geometrically integral fibre rings, the
same is true for the fibre rings of any base change. Hence
$\mathfrak q^\wedge = \mathfrak p^\wedge(S \otimes_R R^\wedge)$,
is a prime ideals lying over $\mathfrak p^\wedge$
and it is the unique associated prime of
$S \otimes_R \kappa(\mathfrak p^\wedge)$. Thus we win if
$f(S \otimes_R R^\wedge) + \mathfrak q^\wedge \not = S \otimes_R R^\wedge$.
This is true because $\mathfrak p^\wedge + fR^\wedge \not = R^\wedge$
as $f$ lies in the radical of the $f$-adically complete ring $R^\wedge$
and because $R^\wedge \to S \otimes_R R^\wedge$ is surjective on spectra
as its fibres are nonempty (irreducible spaces are nonempty).
\end{proof}

\begin{lemma}
\label{lemma-fibres-irreducible-flat-projective-nonnoetherian}
Let $R$ be a ring. Let $R \to S$ be a ring map.
Assume
\begin{enumerate}
\item $R \to S$ is of finite presentation and flat, and
\item every fibre ring $S \otimes_R \kappa(\mathfrak p)$ is
geometrically integral over $\kappa(\mathfrak p)$.
\end{enumerate}
Then $S$ is projective as an $R$-module.
\end{lemma}

\begin{proof}
We can find a cocartesian diagram of rings
$$
\xymatrix{
S_0 \ar[r] & S \\
R_0 \ar[u] \ar[r] & R \ar[u]
}
$$
such that $R_0$ is of finite type over $\mathbf{Z}$, the map
$R_0 \to S_0$ is of finite type and flat with geometrically integral
fibres, see
More on Morphisms,
Lemmas \ref{more-morphisms-lemma-Noetherian-approximation-flat},
\ref{more-morphisms-lemma-Noetherian-approximation-geometrically-reduced},
\ref{more-morphisms-lemma-Noetherian-approximation-geometrically-irreducible},
and \ref{more-morphisms-lemma-Noetherian-approximation-combine}.
By
Lemma \ref{lemma-fibres-irreducible-flat-projective}
we see that $S_0$ is a projective $R_0$-module. Hence $S = S_0 \otimes_{R_0} R$
is a projective $R$-module, see
Algebra, Lemma \ref{algebra-lemma-ascend-properties-modules}.
\end{proof}

\begin{remark}
\label{remark-how-in-RG}
Lemma \ref{lemma-fibres-irreducible-flat-projective-nonnoetherian}
is a key step in the development of results in this chapter. The analogue
of this lemma in \cite{GruRay} is \cite[I Proposition 3.3.1]{GruRay}:
If $R \to S$ is smooth with geometrically integral fibres, then $S$
is projective as an $R$-module. This is a special case of
Lemma \ref{lemma-fibres-irreducible-flat-projective-nonnoetherian},
but as we will later improve on this lemma anyway, we do not gain much
from having a stronger result at this point.
We briefly sketch the proof of this as it is given in \cite{GruRay}.
\begin{enumerate}
\item First reduce to the case where $R$ is Noetherian as above.
\item Since projectivity descends through faithfully flat ring maps, see
Algebra, Theorem \ref{algebra-theorem-ffdescent-projectivity}
we may work locally in the fppf topology on $R$, hence we may assume
that $R \to S$ has a section $\sigma : S \to R$. (Just by the usual trick of
base changing to $S$.) Set $I = \text{Ker}(S \to R)$.
\item Localizing a bit more on $R$ we may assume that $I/I^2$ is a free
$R$-module and that the completion $S^\wedge$ of $S$ with respect to $I$
is isomorphic to $R[[t_1, \ldots, t_n]]$, see
Morphisms, Lemma \ref{morphisms-lemma-section-smooth-morphism}.
Here we are using that $R \to S$ is smooth.
\item To prove that $S$ is projective as an $R$-module, it suffices to
prove that $S$ is flat, countably generated and Mittag-Leffler as an
$R$-module, see
Algebra, Lemma \ref{algebra-lemma-countgen-projective}.
The first two properties are evident. Thus it suffices to prove that $S$
is Mittag-Leffler as an $R$-module. By
Algebra, Lemma \ref{algebra-lemma-power-series-ML}
the module $R[[t_1, \ldots, t_n]]$ is Mittag-Leffler over $R$. Hence
Algebra, Lemma \ref{algebra-lemma-pure-submodule-ML}
shows that it suffices to show that the
$S \to S^\wedge$ is universally injective as a map of $R$-modules.
\item Apply
Lemma \ref{lemma-base-change-universally-flat}
to see that $S \to S^\wedge$ is $R$-universally injective.
Namely, as $R \to S$ has geometrically integral fibres, any associated
point of any fibre ring is just the generic point of the fibre ring which
is in the image of $\text{Spec}(S^\wedge) \to \text{Spec}(S)$.
\end{enumerate}
There is an analogy between the proof as sketched just now, and the
development of the arguments leading to the proof of
Lemma \ref{lemma-fibres-irreducible-flat-projective-nonnoetherian}.
In both a completion plays an essential role, and both times the
assumption of having geometrically integral fibres assures one that the
map from $S$ to the completion of $S$ is $R$-universally injective.
\end{remark}













\section{Flat finite type modules, Part I}
\label{section-finite-type-flat-I}

\noindent
In some cases given a ring map $R \to S$ of finite presentation and
a finite $S$-module $N$ the flatness of $N$ over $R$ implies that $N$
is of finite presentation. In this section we prove this is true
``pointwise''. We remark that the first proof of
Proposition \ref{proposition-finite-type-flat-at-point}
uses the geometric results of
Section \ref{section-local-structure-module}
but not the existence of a complete d\'evissage.

\begin{lemma}
\label{lemma-induction-step}
Let $(R, \mathfrak m)$ be a local ring. Let $R \to S$ be a finitely presented
flat ring map with geometrically integral fibres. Write
$\mathfrak p = \mathfrak mS$. Let $\mathfrak q \subset S$ be a prime ideal
lying over $\mathfrak m$. Let $N$ be a finite $S$-module.
There exists $r \geq 0$ and an $S$-module map
$$
\alpha : S^{\oplus r} \longrightarrow N
$$
such that
$\alpha : \kappa(\mathfrak p)^{\oplus r} \to N \otimes_S \kappa(\mathfrak p)$
is an isomorphism. For any such $\alpha$ the following are equivalent:
\begin{enumerate}
\item $N_{\mathfrak q}$ is $R$-flat,
\item $\alpha$ is $R$-universally injective and
$\text{Coker}(\alpha)_{\mathfrak q}$ is $R$-flat,
\item $\alpha$ is injective and
$\text{Coker}(\alpha)_{\mathfrak q}$ is $R$-flat,
\item $\alpha_{\mathfrak p}$ is an isomorphism and
$\text{Coker}(\alpha)_{\mathfrak q}$ is $R$-flat, and
\item $\alpha_{\mathfrak q}$ is injective and
$\text{Coker}(\alpha)_{\mathfrak q}$ is $R$-flat.
\end{enumerate}
\end{lemma}

\begin{proof}
To obtain $\alpha$ set
$r = \dim_{\kappa(\mathfrak p)} N \otimes_S \kappa(\mathfrak p)$ and pick
$x_1, \ldots, x_r \in N$ which form a basis of
$N \otimes_S \kappa(\mathfrak p)$. Define
$\alpha(s_1, \ldots, s_r) = \sum s_i x_i$. This proves the existence.

\medskip\noindent
Fix an $\alpha$. The most interesting implication is
(1) $\Rightarrow$ (2) which we prove first. Assume (1).
Because $S/\mathfrak mS$ is a domain with fraction field $\kappa(\mathfrak p)$
we see that
$(S/\mathfrak mS)^{\oplus r} \to
N_{\mathfrak p}/\mathfrak mN_{\mathfrak p} = N \otimes_S \kappa(\mathfrak p)$
is injective. Hence by
Lemmas \ref{lemma-universally-injective-local} and
\ref{lemma-fibres-irreducible-flat-projective-nonnoetherian}.
the map $S^{\oplus r} \to N_{\mathfrak p}$ is $R$-universally injective.
It follows that $S^{\oplus r} \to N$ is $R$-universally injective, see
Algebra, Lemma \ref{algebra-lemma-universally-injective-permanence}.
Then also the localization $\alpha_{\mathfrak q}$ is $R$-universally
injective, see
Algebra, Lemma \ref{algebra-lemma-universally-injective-localize}.
We conclude that $\text{Coker}(\alpha)_{\mathfrak q}$ is $R$-flat by
Algebra, Lemma \ref{algebra-lemma-ui-flat-domain}.

\medskip\noindent
The implication (2) $\Rightarrow$ (3) is immediate. If (3) holds, then
$\alpha_{\mathfrak p}$ is injective as a localization of an injective
module map. By Nakayama's lemma
(Algebra, Lemma \ref{algebra-lemma-NAK})
$\alpha_{\mathfrak p}$ is surjective too. Hence (3) $\Rightarrow$ (4).
If (4) holds, then $\alpha_{\mathfrak p}$ is an isomorphism, so
$\alpha$ is injective as $S_{\mathfrak q} \to S_{\mathfrak p}$ is injective.
Namely, elements of $S \setminus \mathfrak p$ are nonzero divisors on $S$
by a combination of
Lemmas \ref{lemma-invert-universally-injective} and
\ref{lemma-fibres-irreducible-flat-projective-nonnoetherian}.
Hence (4) $\Rightarrow$ (5). Finally, if (5) holds, then
$N_{\mathfrak q}$ is $R$-flat as an extension of flat modules, see
Algebra, Lemma \ref{algebra-lemma-flat-ses}.
Hence (5) $\Rightarrow$ (1) and the proof is finished.
\end{proof}

\begin{lemma}
\label{lemma-complete-devissage-flat-finite-type-module}
Let $(R, \mathfrak m)$ be a local ring.
Let $R \to S$ be a ring map of finite presentation.
Let $N$ be a finite $S$-module.
Let $\mathfrak q$ be a prime of $S$ lying over $\mathfrak m$.
Assume that $N_{\mathfrak q}$ is flat over $R$, and
assume there exists a complete d\'evissage of $N/S/R$ at $\mathfrak q$.
Then $N$ is a finitely presented $S$-module, free as an $R$-module,
and there exists an isomorphism
$$
N \cong B_1^{\oplus r_1} \oplus \ldots \oplus B_n^{\oplus r_n}
$$
as $R$-modules where each $B_i$ is a smooth $R$-algebra with geometrically
irreducible fibres.
\end{lemma}

\begin{proof}
Let $(A_i, B_i, M_i, \alpha_i, \mathfrak q_i)_{i = 1, \ldots, n}$
be the given complete d\'evissage. We prove the lemma by induction on $n$.
Note that $N$ is finitely presented as an $S$-module if and only if
$M_1$ is finitely presented as an $B_1$-module, see
Remark \ref{remark-finite-presentation}.
Note that $N_{\mathfrak q} \cong (M_1)_{\mathfrak q_1}$ as $R$-modules
because (a) $N_{\mathfrak q} \cong (M_1)_{\mathfrak q'_1}$ where
$\mathfrak q'_1$ is the unique prime in $A_1$ lying over $\mathfrak q_1$
and (b) $(A_1)_{\mathfrak q'_1} = (A_1)_{\mathfrak q_1}$ by
Algebra, Lemma \ref{algebra-lemma-unique-prime-over-localize-below},
so (c) $(M_1)_{\mathfrak q'_1} \cong (M_1)_{\mathfrak q_1}$.
Hence $(M_1)_{\mathfrak q_1}$ is a flat $R$-module. Thus we may replace
$(S, N)$ by $(B_1, M_1)$ in order to prove the lemma. By
Lemma \ref{lemma-induction-step}
the map $\alpha_1 : B_1^{\oplus r_1} \to M_1$ is $R$-universally injective
and $\text{Coker}(\alpha_1)_{\mathfrak q}$ is $R$-flat.
Note that $(A_i, B_i, M_i, \alpha_i, \mathfrak q_i)_{i = 2, \ldots, n}$
is a complete d\'evissage of $\text{Coker}(\alpha_1)/B_1/R$ at
$\mathfrak q_1$. Hence the induction hypothesis
implies that $\text{Coker}(\alpha_1)$ is finitely presented as a
$B_1$-module, free as an $R$-module, and has a decomposition as in the lemma.
This implies that $M_1$ is finitely presented as a $B_1$-module, see
Algebra, Lemma \ref{algebra-lemma-extension}.
It further implies that
$M_1 \cong B_1^{\oplus r_1} \oplus \text{Coker}(\alpha_1)$
as $R$-modules, hence a decomposition as in the lemma.
Finally, $B_1$ is projective as an $R$-module by
Lemma \ref{lemma-fibres-irreducible-flat-projective-nonnoetherian}
hence free as an $R$-module by
Algebra, Theorem \ref{algebra-theorem-projective-free-over-local-ring}.
This finishes the proof.
\end{proof}

\begin{proposition}
\label{proposition-finite-type-flat-at-point}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{F}$ be a quasi-coherent sheaf on $X$.
Let $x \in X$ with image $s \in S$.
Assume that
\begin{enumerate}
\item $f$ is locally of finite presentation,
\item $\mathcal{F}$ is of finite type, and
\item $\mathcal{F}$ is flat at $x$ over $S$.
\end{enumerate}
Then there exists an elementary \'etale neighbourhood $(S', s') \to (S, s)$
and an open subscheme
$$
V \subset X \times_S \text{Spec}(\mathcal{O}_{S', s'})
$$
which contains the unique point of
$X \times_S \text{Spec}(\mathcal{O}_{S', s'})$ mapping to $x$
such that the pullback of $\mathcal{F}$ to $V$ is an $\mathcal{O}_V$-module
of finite presentation and flat over $\mathcal{O}_{S', s'}$.
\end{proposition}

\begin{proof}[First proof]
This proof is longer but does not use the existence of a complete d\'evissage.
The problem is local around $x$ and $s$, hence we may assume that $X$
and $S$ are affine. During the proof we will finitely many times replace
$S$ by an elementary \'etale neighbourhood of $(S, s)$. The goal is then to find
(after such a replacement) an open
$V \subset X \times_S \text{Spec}(\mathcal{O}_{S, s})$ containing $x$
such that $\mathcal{F}|_V$ is flat over $S$ and finitely presented.
Of course we may also replace $S$ by $\text{Spec}(\mathcal{O}_{S, s})$
at any point of the proof, i.e., we may assume $S$ is a local scheme.
We will prove the lemma by induction on the integer
$n = \dim_x(\text{Supp}(\mathcal{F}_s))$.

\medskip\noindent
We can choose
\begin{enumerate}
\item elementary \'etale neighbourhoods $g : (X', x') \to (X, x)$,
$e : (S', s') \to (S, s)$,
\item a commutative diagram
$$
\xymatrix{
X \ar[dd]_f & X' \ar[dd] \ar[l]^g & Z' \ar[l]^i \ar[d]^\pi \\
& & Y' \ar[d]^h \\
S & S' \ar[l]_e & S' \ar@{=}[l]
}
$$
\item a point $z' \in Z'$ with $i(z') = x'$, $y' = \pi(z')$, $h(y') = s'$,
\item a finite type quasi-coherent $\mathcal{O}_{Z'}$-module $\mathcal{G}$,
\end{enumerate}
as in
Lemma \ref{lemma-elementary-devissage}.
We are going to replace $S$ by $\text{Spec}(\mathcal{O}_{S', s'})$, see
remarks in first paragraph of the proof. Consider the diagram
$$
\xymatrix{
X_{\mathcal{O}_{S', s'}} \ar[ddr]_f &
X'_{\mathcal{O}_{S', s'}} \ar[dd] \ar[l]^g &
Z'_{\mathcal{O}_{S', s'}} \ar[l]^i \ar[d]^\pi \\
& & Y'_{\mathcal{O}_{S', s'}} \ar[dl]^h \\
& \text{Spec}(\mathcal{O}_{S', s'})
}
$$
Here we have base changed the schemes $X', Z', Y'$ over $S'$ via
$\text{Spec}(\mathcal{O}_{S', s'}) \to S'$ and the scheme $X$ over $S$ via
$\text{Spec}(\mathcal{O}_{S', s'}) \to S$. It is still the case that
$g$ is \'etale, see
Lemma \ref{lemma-etale-at-point}.
After replacing $X$ by $X_{\mathcal{O}_{S', s'}}$,
$X'$ by $X'_{\mathcal{O}_{S', s'}}$,
$Z'$ by $Z'_{\mathcal{O}_{S', s'}}$, and
$Y'$ by $Y'_{\mathcal{O}_{S', s'}}$
we may assume we have a diagram as
Lemma \ref{lemma-elementary-devissage}
where in addition $S = S'$ is a local scheme with closed point $s$. By
Lemmas \ref{lemma-devissage-finite-presentation} and
\ref{lemma-devissage-flat}
the result for $Y' \to S$, the sheaf $\pi_*\mathcal{G}$, and the
point $y'$ implies the result for $X \to S$, $\mathcal{F}$ and $x$.
Hence we may assume that $S$ is local and $X \to S$ is a smooth morphism
of affines with geometrically irreducible fibres of dimension $n$.

\medskip\noindent
The base case of the induction: $n = 0$.
As $X \to S$ is smooth with geometrically
irredible fibres of dimension $0$ we see that $X \to S$ is an open
immersion, see
Descent, Lemma \ref{descent-lemma-universally-injective-etale-open-immersion}.
As $S$ is local and the closed point is in the image of $X \to S$
we conclude that $X = S$. Thus we see that $\mathcal{F}$ corresponds
to a finite flat $\mathcal{O}_{S, s}$ module. In this case the result
follows from
Algebra, Lemma \ref{algebra-lemma-finite-flat-local}
which tells us that $\mathcal{F}$ is in fact finite free.

\medskip\noindent
The induction step. Assume the result holds whenever the dimension
of the support in the closed fibre is $< n$. Write $S = \text{Spec}(A)$,
$X = \text{Spec}(B)$ and $\mathcal{F} = \widetilde{N}$ for some $B$-module
$N$. Note that $A$ is a local ring; denote its maximal ideal $\mathfrak m$.
Then $\mathfrak p = \mathfrak mB$ is the unique minimal prime lying over
$\mathfrak m$ as $X \to S$ has geometrically irreducible fibres. Finally,
let $\mathfrak q \subset B$ be the prime corresponding to $x$. By
Lemma \ref{lemma-induction-step}
we can choose a map
$$
\alpha : B^{\oplus r} \to N
$$
such that $\kappa(\mathfrak p)^{\oplus r} \to N \otimes_B \kappa(\mathfrak p)$
is an isomorphism. Moreover, as $N_{\mathfrak q}$ is $A$-flat the lemma
also shows that $\alpha$ is injective and that
$\text{Coker}(\alpha)_{\mathfrak q}$ is $A$-flat.
Set $Q = \text{Coker}(\alpha)$. Note that the support of $Q/\mathfrak mQ$
does not contain $\mathfrak p$. Hence it is certainly the case that
$\dim_{\mathfrak q}(\text{Supp}(Q/\mathfrak mQ)) < n$.
Combining everything we know about $Q$ we see
that the induction hypothesis applies to $Q$. It follows that there exists
an elementary \'etale morphism $(S', s) \to (S, s)$ such that the conclusion
holds for $Q \otimes_A A'$ over $B \otimes_A A'$ where
$A' = \mathcal{O}_{S', s'}$. After replacing $A$ by $A'$ we have an
exact sequence
$$
0 \to B^{\oplus r} \to N \to Q \to 0
$$
(here we use that $\alpha$ is injective as mentioned above)
of finite $B$-modules and we also get an element
$g \in B$, $g \not \in \mathfrak q$ such that
$Q_g$ is finitely presented over $B_g$ and flat over $A$. Since localization
is exact we see that
$$
0 \to B_g^{\oplus r} \to N_g \to Q_g \to 0
$$
is still exact. As $B_g$ and $Q_g$ are flat over $A$ we conlude that
$N_g$ is flat over $A$, see
Algebra, Lemma \ref{algebra-lemma-flat-ses},
and as $B_g$ and $Q_g$ are finitely presented over $B_g$ the same holds
for $N_g$, see
Algebra, Lemma \ref{algebra-lemma-extension}.
\end{proof}

\begin{proof}[Second proof]
We apply
Proposition \ref{proposition-existence-complete-at-x}
to find a commutative diagram
$$
\xymatrix{
(X, x) \ar[d] & (X', x') \ar[l]^g \ar[d] \\
(S, s) & (S', s') \ar[l]
}
$$
of pointed schemes such that the horizontal
arrows are elementary \'etale neighbourhoods
and such that $g^*\mathcal{F}/X'/S'$ has a complete
d\'evissage at $x$.
(In particular $S'$ and $X'$ are affine.) By
Morphisms, Lemma \ref{morphisms-lemma-flat-permanence}
we see that $g^*\mathcal{F}$ is flat at $x'$ over $S$ and by
Lemma \ref{lemma-etale-flat-up-down}
we see that it is flat at $x'$ over $S'$. Via
Remark \ref{remark-same-notion}
we deduce that
$$
\Gamma(X', g^*\mathcal{F})/
\Gamma(X', \mathcal{O}_{X'})/
\Gamma(S', \mathcal{O}_{S'})
$$
has a complete d\'evisage at the prime of $\Gamma(X', \mathcal{O}_{X'})$
corresponding to $x'$. We may base change this complete
d\'evissage to the local ring $\mathcal{O}_{S', s'}$
of $\Gamma(S', \mathcal{O}_{S'})$ at the prime corresponding to
$s'$. Thus
Lemma \ref{lemma-complete-devissage-flat-finite-type-module}
implies that
$$
\Gamma(X', \mathcal{F}')
\otimes_{\Gamma(S', \mathcal{O}_{S'})}
\mathcal{O}_{S', s'}
$$
is flat over $\mathcal{O}_{S', s'}$ and of finite presentation over
$\Gamma(X', \mathcal{O}_{X'})
\otimes_{\Gamma(S', \mathcal{O}_{S'}} \mathcal{O}_{S', s'}$.
In other words, the restriction of $\mathcal{F}$ to
$X' \times_{S'} \text{Spec}(\mathcal{O}_{S', s'})$
is of finite presentation and flat over $\mathcal{O}_{S', s'}$.
Since the morphism
$X' \times_{S'} \text{Spec}(\mathcal{O}_{S', s'})
\to X \times_S \text{Spec}(\mathcal{O}_{S', s'})$
is \'etale
(Lemma \ref{lemma-etale-at-point})
its image $V \subset X \times_S \text{Spec}(\mathcal{O}_{S', s'})$
is an open subscheme, and by \'etale descent the restriction
of $\mathcal{F}$ to $V$ is of finite presentation and flat over
$\mathcal{O}_{S', s'}$. (Results used:
Morphisms, Lemma \ref{morphisms-lemma-etale-open},
Descent, Lemma \ref{descent-lemma-finite-presentation-descends}, and
Morphisms, Lemma \ref{morphisms-lemma-flat-permanence}.)
\end{proof}

\begin{lemma}
\label{lemma-finite-type-flat-at-point-X}
Let $S$ be a scheme. Let $X$ be locally of finite type over $S$.
Let $x \in X$ with image $s \in S$.
If $X$ is flat at $x$ over $S$, then there exists an elementary
\'etale neighbourhood $(S', s') \to (S, s)$ and an open subscheme
$$
V \subset X \times_S \text{Spec}(\mathcal{O}_{S', s'})
$$
which contains the unique point of
$X \times_S \text{Spec}(\mathcal{O}_{S', s'})$ mapping to $x$
such that $V \to \text{Spec}(\mathcal{O}_{S', s'})$
is flat and of finite presentation.
\end{lemma}

\begin{proof}
The question is local on $X$ and $S$, hence we may assume $X$ and $S$
are affine. Write $X = \text{Spec}(B)$, $S = \text{Spec}(A)$ and write
$B = A[x_1, \ldots, x_n]/I$. In other words we obtain a closed immersion
$i : X \to \mathbf{A}^n_S$. Denote $t = i(x) \in \mathbf{A}^n_S$.
We may apply
Proposition \ref{proposition-finite-type-flat-at-point}
to $\mathbf{A}^n_S \to S$, the sheaf $\mathcal{F} = i_*\mathcal{O}_X$
and the point $t$. We obtain an elementary
\'etale neighbourhood $(S', s') \to (S, s)$ and an open subscheme
$$
W \subset \mathbf{A}^n_{\mathcal{O}_{S', s'}}
$$
such that the pull back of $i_*\mathcal{O}_X$ is flat and of finite
presentation. This means that
$V := W \cap \big(X \times_S \text{Spec}(\mathcal{O}_{S', s'})\big)$
is the desired open subscheme.
\end{proof}

\begin{lemma}
\label{lemma-finite-type-flat-at-point-local}
Let $f : X \to S$ be a morphism which is locally of finite presentation.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module of finite type.
If $x \in X$ and $\mathcal{F}$ is flat at $x$ over $S$, then
$\mathcal{F}_x$ is an $\mathcal{O}_{X, x}$-module of finite presentation.
\end{lemma}

\begin{proof}
Let $s = f(x)$. By
Proposition \ref{proposition-finite-type-flat-at-point}
there exists an elementary \'etale neighbourhood $(S', s') \to (S, s)$
such that the pullback of $\mathcal{F}$ to
$X \times_S \text{Spec}(\mathcal{O}_{S', s'})$ is of
finite presentation in a neighbourhood of the point $x' \in X_{s'} = X_s$
corresponding to $x$. The ring map
$$
\mathcal{O}_{X, x} \longrightarrow
\mathcal{O}_{X \times_S \text{Spec}(\mathcal{O}_{S', s'}), x'}
=
\mathcal{O}_{X \times_S S', x'}
$$
is flat and local as a localization of an \'etale ring map. Hence
$\mathcal{F}_x$ is of finite presentation over $\mathcal{O}_{X, x}$
by descent, see
Algebra, Lemma \ref{algebra-lemma-descend-properties-modules}
(and also that a flat local ring map is faithfully flat, see
Algebra, Lemma \ref{algebra-lemma-local-flat-ff}).
\end{proof}

\begin{lemma}
\label{lemma-finite-type-flat-at-point-local-X}
Let $f : X \to S$ be a morphism which is locally of finite type.
Let $x \in X$ with image $s \in S$. If $f$ is flat at $x$ over $S$, then
$\mathcal{O}_{X, x}$ is essentially of finite presentation over
$\mathcal{O}_{S, s}$.
\end{lemma}

\begin{proof}
We may assume $X$ and $S$ affine. Write $X = \text{Spec}(B)$,
$S = \text{Spec}(A)$ and write $B = A[x_1, \ldots, x_n]/I$.
In other words we obtain a closed immersion $i : X \to \mathbf{A}^n_S$.
Denote $t = i(x) \in \mathbf{A}^n_S$. We may apply
Lemma \ref{lemma-finite-type-flat-at-point-local}
to $\mathbf{A}^n_S \to S$, the sheaf $\mathcal{F} = i_*\mathcal{O}_X$
and the point $t$. We conclude that $\mathcal{O}_{X, x}$ is 
of finite presentation over $\mathcal{O}_{\mathbf{A}^n_S, t}$
which implies what we want.
\end{proof}


\section{Flat finitely presented modules}
\label{section-finitely-presented-flat}

\noindent
In some cases given a ring map $R \to S$ of finite presentation and
a finitely presented $S$-module $N$ the flatness of $N$ over $R$ implies
that $N$ is projective as an $R$-module, at least after replacing $S$
by an \'etale extension. In this section we collect a some results
of this nature.

\begin{lemma}
\label{lemma-induction-step-fp}
Let $R$ be a ring. Let $R \to S$ be a finitely presented
flat ring map with geometrically integral fibres. Let
$\mathfrak q \subset S$ be a prime ideal lying over the prime
$\mathfrak r \subset R$. Set $\mathfrak p = \mathfrak r S$.
Let $N$ be a finitely presented $S$-module.
There exists $r \geq 0$ and an $S$-module map
$$
\alpha : S^{\oplus r} \longrightarrow N
$$
such that
$\alpha : \kappa(\mathfrak p)^{\oplus r} \to N \otimes_S \kappa(\mathfrak p)$
is an isomorphism. For any such $\alpha$ the following are equivalent:
\begin{enumerate}
\item $N_{\mathfrak q}$ is $R$-flat,
\item there exists an $f \in R$, $f \not \in \mathfrak r$ such that
$\alpha_f : S_f^{\oplus r} \to N_f$ is $R_f$-universally injective and
a $g \in S$, $g \not \in \mathfrak q$ such that $\text{Coker}(\alpha)_g$
is $R$-flat,
\item $\alpha_{\mathfrak r}$ is $R_{\mathfrak r}$-universally injective and
$\text{Coker}(\alpha)_{\mathfrak q}$ is $R$-flat
\item $\alpha_{\mathfrak r}$ is injective and
$\text{Coker}(\alpha)_{\mathfrak q}$ is $R$-flat,
\item $\alpha_{\mathfrak p}$ is an isomorphism and
$\text{Coker}(\alpha)_{\mathfrak q}$ is $R$-flat, and
\item $\alpha_{\mathfrak q}$ is injective and
$\text{Coker}(\alpha)_{\mathfrak q}$ is $R$-flat.
\end{enumerate}
\end{lemma}

\begin{proof}
To obtain $\alpha$ set
$r = \dim_{\kappa(\mathfrak p)} N \otimes_S \kappa(\mathfrak p)$ and pick
$x_1, \ldots, x_r \in N$ which form a basis of
$N \otimes_S \kappa(\mathfrak p)$. Define
$\alpha(s_1, \ldots, s_r) = \sum s_i x_i$. This proves the existence.

\medskip\noindent
Fix a choice of $\alpha$.
We may apply
Lemma \ref{lemma-induction-step}
to the map
$\alpha_{\mathfrak r} : S_{\mathfrak r}^{\oplus r} \to N_{\mathfrak r}$.
Hence we see that (1), (3), (4), (5), and (6) are all equivalent.
Since it is also clear that (2) implies (3) we see that all we have to
do is show that (1) implies (2).

\medskip\noindent
Assume (1). By openness of flatness, see
Algebra, Theorem \ref{algebra-theorem-openess-flatness},
the set
$$
U_1 = \{\mathfrak q' \subset S \mid N_{\mathfrak q'}\text{ is flat over }R\}
$$
is open in $\text{Spec}(S)$. It contains $\mathfrak q$ by assumption
and hence $\mathfrak p$. Because $S^{\oplus r}$ and $N$ are finitely presented
$S$-modules the set
$$
U_2 = \{\mathfrak q' \subset S \mid
\alpha_{\mathfrak q'}\text{ is an isomorphism}\}
$$
is open in $\text{Spec}(S)$, see
Algebra, Lemma \ref{algebra-lemma-map-between-finitely-presented}.
It contains $\mathfrak p$ by (5). As $R \to S$
is finitely presented and flat the map
$\Phi : \text{Spec}(S) \to \text{Spec}(R)$ is open, see
Algebra, Proposition \ref{algebra-proposition-fppf-open}.
For any prime $\mathfrak r' \in \Phi(U_1 \cap U_2)$ we see that
there exists a prime $\mathfrak q'$ lying over $\mathfrak r'$ such that
$N_{\mathfrak q'}$ is flat and such that $\alpha_{\mathfrak q'}$ is
an isomorphism, which implies that $\alpha \otimes \kappa(\mathfrak p')$
is an isomorphism where $\mathfrak p' = \mathfrak r' S$. Thus
$\alpha_{\mathfrak r'}$ is $R_{\mathfrak r'}$-universally injective
by the implication (1) $\Rightarrow$ (3).
Hence if we pick $f \in R$, $f \not \in \mathfrak r$ such that
$D(f) \subset \Phi(U_1 \cap U_2)$ then we conclude that
$\alpha_f$ is $R_f$-universally injective, see
Algebra, Lemma \ref{algebra-lemma-universally-injective-check-stalks}.
The same reasoning also shows that for any
$\mathfrak q' \in U_1 \cap \Phi^{-1}(\Phi(U_1 \cap U_2))$
the module $\text{Coker}(\alpha)_{\mathfrak q'}$ is $R$-flat.
Note that $\mathfrak q \in U_1 \cap \Phi^{-1}(\Phi(U_1 \cap U_2))$.
Hence we can find a $g \in S$, $g \not \in \mathfrak q$ such
that $D(g) \subset U_1 \cap \Phi^{-1}(\Phi(U_1 \cap U_2))$
and we win.
\end{proof}

\begin{lemma}
\label{lemma-complete-devissage-flat-finitely-presented-module}
Let $R \to S$ be a ring map of finite presentation.
Let $N$ be a finitely presented $S$-module flat over $R$.
Let $\mathfrak r \subset R$ be a prime ideal.
Assume there exists a complete d\'evissage of $N/S/R$ over $\mathfrak r$.
Then there exists an $f \in R$, $f \not \in \mathfrak r$
such that
$$
N_f \cong B_1^{\oplus r_1} \oplus \ldots \oplus B_n^{\oplus r_n}
$$
as $R$-modules where each $B_i$ is a smooth $R_f$-algebra with geometrically
irreducible fibres. Moreover, $N_f$ is projective as an $R_f$-module.
\end{lemma}

\begin{proof}
Let $(A_i, B_i, M_i, \alpha_i)_{i = 1, \ldots, n}$ be the given
complete d\'evissage. We prove the lemma by induction on $n$.
Note that the assertions of the lemma are entirely about the structure
of $N$ as an $R$-module. Hence we may replace $N$ by $M_1$, and we
may think of $M_1$ as a $B_1$-module. See
Remark \ref{remark-finite-presentation}
in order to see why $M_1$ is of finite presentation as a $B_1$-module. By
Lemma \ref{lemma-induction-step-fp}
we may, after replacing $R$ by $R_f$ for some
$f \in R$, $f \not \in \mathfrak r$, assume
the map $\alpha_1 : B_1^{\oplus r_1} \to M_1$ is $R$-universally injective.
Since $M_1$ and $B_1^{\oplus r_1}$ are $R$-flat and finitely presented as
$B_1$-modules we see that $\text{Coker}(\alpha_1)$ is $R$-flat
(Algebra, Lemma \ref{algebra-lemma-ui-flat-domain})
and finitely presented as a $B_1$-module. Note that
$(A_i, B_i, M_i, \alpha_i)_{i = 2, \ldots, n}$ is a complete
d\'evissage of $\text{Coker}(\alpha_1)$. Hence the induction hypothesis
implies that, after replacing
$R$ by $R_f$ for some $f \in R$, $f \not \in \mathfrak r$,
we may assume that $\text{Coker}(\alpha_1)$ has a decomposition
as in the lemma and is projective. In particular
$M_1 = B_1^{\oplus r_1} \oplus \text{Coker}(\alpha_1)$.
This proves the statement regarding the decomposition.
The statement on projectivity follows as $B_1$ is projective as
an $R$-module by
Lemma \ref{lemma-fibres-irreducible-flat-projective-nonnoetherian}.
\end{proof}

\begin{remark}
\label{remark-complete-devissage-flat-finitely-presented-module}
There is a variant of
Lemma \ref{lemma-complete-devissage-flat-finitely-presented-module}
where we weaken the flatness condition by assuming only that $N$
is flat at some given prime $\mathfrak q$ lying over $\mathfrak r$
but where we strengthen the d\'evissage condition by assuming
the existence of a complete d\'evissage {\it at $\mathfrak q$}. Compare with
Lemma \ref{lemma-complete-devissage-flat-finite-type-module}.
\end{remark}

\begin{proposition}
\label{proposition-finite-presentation-flat-at-point}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{F}$ be a quasi-coherent sheaf on $X$.
Let $x \in X$ with image $s \in S$.
Assume that
\begin{enumerate}
\item $f$ is locally of finite presentation,
\item $\mathcal{F}$ is of finite presentation, and
\item $\mathcal{F}$ is flat at $x$ over $S$.
\end{enumerate}
Then there exists a commutative diagram of pointed schemes
$$
\xymatrix{
(X, x) \ar[d] & (X', x') \ar[l]^g \ar[d] \\
(S, s) & (S', s') \ar[l]
}
$$
whose horizontal arrows are elementary \'etale neighbourhoods
such that $X'$, $S'$ are affine and such that
$\Gamma(X', g^*\mathcal{F})$ is a projective
$\Gamma(S', \mathcal{O}_{S'})$-module.
\end{proposition}

\begin{proof}
By openness of flatness, see
More on Morphisms, Theorem \ref{more-morphisms-theorem-openess-flatness}
we may replace $X$ by an open neighbourhood of $x$ and assume that
$\mathcal{F}$ is flat over $S$. Next, we apply
Proposition \ref{proposition-existence-complete-at-x}
to find a diagram as in the statement of the proposition such
that $g^*\mathcal{F}/X'/S'$ has a complete d\'evissage over $s'$.
(In particular $S'$ and $X'$ are affine.) By
Morphisms, Lemma \ref{morphisms-lemma-flat-permanence}
we see that $g^*\mathcal{F}$ is flat over $S$ and by
Lemma \ref{lemma-etale-flat-up-down}
we see that it is flat over $S'$. Via
Remark \ref{remark-same-notion}
we deduce that
$$
\Gamma(X', g^*\mathcal{F})/
\Gamma(X', \mathcal{O}_{X'})/
\Gamma(S', \mathcal{O}_{S'})
$$
has a complete d\'evisage over the prime of $\Gamma(S', \mathcal{O}_{S'})$
corresponding to $s'$. Thus
Lemma \ref{lemma-complete-devissage-flat-finitely-presented-module}
implies that the result of the proposition holds after replacing
$S'$ by a standard open neighbourhood of $s'$.
\end{proof}

\begin{lemma}
\label{lemma-finite-presentation-flat-at-point-X}
Let $f : X \to S$ be locally of finite presentation.
Let $x \in X$ with image $s \in S$.
If $f$ is flat at $x$ over $S$, then there exists a commutative
diagram of pointed schemes
$$
\xymatrix{
(X, x) \ar[d] & (X', x') \ar[l]^g \ar[d] \\
(S, s) & (S', s') \ar[l]
}
$$
whose horizontal arrows are elementary \'etale neighbourhoods
such that $X'$, $S'$ are affine and such that
$\Gamma(X', \mathcal{O}_{X'})$ is a projective
$\Gamma(S', \mathcal{O}_{S'})$-module.
\end{lemma}

\begin{proof}
This is a special case of
Proposition \ref{proposition-finite-presentation-flat-at-point}.
\end{proof}







\section{Flat finite type modules, Part II}
\label{section-finite-type-flat-II}

\noindent
The following lemma will be superseded by the stronger
Lemma \ref{lemma-weak-bourbaki}
below.

\begin{lemma}
\label{lemma-weak-bourbaki-pre}
Let $(R, \mathfrak m)$ be a local ring.
Let $R \to S$ be of finite presentation.
Let $N$ be a finitely presented $S$-module which is free as an $R$-module.
Let $M$ be an $R$-module.
Let $\mathfrak q$ be a prime of $S$ lying over $\mathfrak m$.
Then
\begin{enumerate}
\item if $\mathfrak q \in \text{WeakAss}_S(M \otimes_R N)$
then $\mathfrak m \in \text{WeakAss}_R(M)$ and
$\overline{\mathfrak q} \in \text{Ass}_{\overline{S}}(\overline{N})$,
\item if $\mathfrak m \in \text{WeakAss}_R(M)$ and
$\overline{\mathfrak q} \in \text{Ass}_{\overline{S}}(\overline{N})$
is a maximal element then $\mathfrak q \in \text{WeakAss}_S(M \otimes_R N)$.
\end{enumerate}
Here $\overline{S} = S/\mathfrak m S$,
$\overline{\mathfrak q} = \mathfrak q \overline{S}$, and
$\overline{N} = N/\mathfrak m N$.
\end{lemma}

\begin{proof}
Suppose that
$\overline{\mathfrak q} \not \in \text{Ass}_{\overline{S}}(\overline{N})$.
By
Algebra, Lemmas \ref{algebra-lemma-ass-zero-divisors},
\ref{algebra-lemma-finite-ass}, and
\ref{algebra-lemma-silly}
there exists an element $\overline{g} \in \overline{\mathfrak q}$
which is not a zero divisor on $\overline{N}$. Let $g \in \mathfrak q$
be an element which maps to $\overline{g}$ in $\overline{\mathfrak q}$. By
Lemma \ref{lemma-invert-universally-injective}
the map $g : N \to N$ is $R$-universally injective. In particular
we see that $g : M \otimes_R N \to M \otimes_R N$ is injective.
Clearly this implies that
$\mathfrak q \not \in \text{WeakAss}_S(M \otimes_R N)$.
We conclude that $\mathfrak q \in \text{WeakAss}_S(M \otimes_R N)$ implies
$\overline{\mathfrak q} \in \text{Ass}_{\overline{S}}(\overline{N})$.

\medskip\noindent
Assume $\mathfrak q \in \text{WeakAss}_S(M \otimes_R N)$.
Let $z \in M \otimes_R N$ be an element whose annihilator in $S$
has radical $\mathfrak q$. As $N$ is a free $R$-module, we can find
a finite free direct summand $F \subset N$ such that
$z \in M \otimes_R F$. The radical of the annihilator of
$z \in M \otimes_R F$ in $R$ is $\mathfrak m$ (by our assumption on $z$
and because $\mathfrak q$ lies over $\mathfrak m$). Hence we see that
$\mathfrak m \in \text{WeakAss}(M \otimes_R F)$ which implies
that $\mathfrak m \in \text{WeakAss}(M)$ by
Algebra, Lemma \ref{algebra-lemma-weakly-ass}.
This finishes the proof of (1).

\medskip\noindent
Assume that $\mathfrak m \in \text{WeakAss}_R(M)$ and
$\overline{\mathfrak q} \in \text{Ass}_{\overline{S}}(\overline{N})$
is a maximal element.
Let $y \in M$ be an element whose annihilator $I = \text{Ann}_R(y)$
has radical $\mathfrak m$. Then $R/I \subset M$ and by flatness of $N$
over $R$ we get $N/IN = R/I \otimes_R N \subset M \otimes_R N$. Hence
it is enough to show that $\mathfrak q \in \text{WeakAss}(N/IN)$.
Write $\overline{\mathfrak q} = (\overline{g}_1, \ldots, \overline{g}_n)$
for some $\overline{g}_i \in \overline{S}$. Choose lifts
$g_i \in \mathfrak q$. Consider the map
$$
\Psi : N/IN \longrightarrow N/IN^{\oplus n}, \quad
z \longmapsto (g_1z, \ldots, g_nz).
$$
We may think of this as a map of free $R/I$-modules. As the ring
$R/I$ is auto-associated (since $\mathfrak m/I$ is locally nilpotent)
and since $\Psi \otimes R/\mathfrak m$ isn't injective (since
$\overline{\mathfrak q} \in \text{Ass}(\overline{N})$) we see by
More on Algebra, Lemma \ref{more-algebra-lemma-P-fPD-zero}
that $\Psi$ isn't injective. Pick $z \in N/IN$ nonzero in the kernel
of $\Psi$. The annihilator of $z$ contains $I$ and $g_i$, whence
its radical $J = \sqrt{\text{Ann}_S(z)}$ contains $\mathfrak q$. 
Let $\mathfrak q' \supset J$ be a minimal prime over $J$.
Then $\mathfrak q' \in \text{WeakAss}(M \otimes_R N)$ (by definition)
and by (1) we see that
$\overline{\mathfrak q}' \in \text{Ass}(\overline{N})$.
Then since $\mathfrak q \subset \mathfrak q'$ by construction the
maximality of $\overline{\mathfrak q}$ implies $\mathfrak q = \mathfrak q'$
whence $\mathfrak q \in \text{WeakAss}(M \otimes_R N)$.
This proves part (2) of the lemma.
\end{proof}

\begin{lemma}
\label{lemma-bourbaki-finite-type-general-base-at-point}
Let $S$ be a scheme.
Let $f : X \to S$ be locally of finite type.
Let $x \in X$ with image $s \in S$.
Let $\mathcal{F}$ be a finite type quasi-coherent sheaf on $X$.
Let $\mathcal{G}$ be a quasi-coherent sheaf on $Y$.
If $\mathcal{F}$ is flat at $x$ over $S$, then
$$
x \in \text{WeakAss}_X(\mathcal{F} \otimes_{\mathcal{O}_X} f^*\mathcal{G})
\Leftrightarrow
s \in \text{WeakAss}_S(\mathcal{G})
\text{ and }
x \in \text{Ass}_{X_s}(\mathcal{F}_s).
$$
\end{lemma}

\begin{proof}
The question is local on $X$ and $S$, hence we may assume $X$ and $S$
are affine. Write $X = \text{Spec}(B)$, $S = \text{Spec}(A)$ and write
$B = A[x_1, \ldots, x_n]/I$. In other words we obtain a closed immersion
$i : X \to \mathbf{A}^n_S$ over $S$. Denote $t = i(x) \in \mathbf{A}^n_S$.
Note that $i_*\mathcal{F}$ is a finite type quasi-coherent sheaf on
$\mathbf{A}^n_S$ which is flat at $t$ over $S$ and note that
$$
i_*(\mathcal{F} \otimes_{\mathcal{O}_X} f^*\mathcal{G}) =
i_*\mathcal{F} \otimes_{\mathcal{O}_{\mathbf{A}^n_S}} p^*\mathcal{G}
$$
where $p : \mathbf{A}^n_S \to S$ is the projection. Note that
$t$ is a weakly associated point of
$i_*(\mathcal{F} \otimes_{\mathcal{O}_X} f^*\mathcal{G})$
if and only if $x$ is a weakly associated popint of
$\mathcal{F} \otimes_{\mathcal{O}_X} f^*\mathcal{G}$, see
Divisors, Lemma \ref{divisors-lemma-weakly-associated-finite}.
Similarly $x \in \text{Ass}_{X_s}(\mathcal{F}_s)$ if and only
if $t \in \text{Ass}_{\mathbf{A}^n_s}((i_*\mathcal{F})_s)$ (see
Algebra, Lemma \ref{algebra-lemma-ass-quotient-ring}).
Hence it suffices to prove the the lemma in case $X = \mathbf{A}^n_S$.
In particular we may assume that $X \to S$ is of finite presentation.

\medskip\noindent
Recall that $\text{Ass}_{X_s}(\mathcal{F}_s)$ is a locally finite subset
of the locally Noetherian scheme $X_s$, see
Divisors, Lemma \ref{divisors-lemma-finite-ass}.
After replacing $X$ by a suitable affine neighbourhood of $x$ we may
assume that
\begin{list}{$(*)$}{}
\item if $x' \in \text{Ass}_{X_s}(\mathcal{F}_s)$ and $x \leadsto x'$
then $x = x'$.
\end{list}
(Proof omitted. Hint: using
Algebra, Lemma \ref{algebra-lemma-silly}
invert a function which does not vanish at $x$ but does vanish
in all the finitely many points of $\text{Ass}_{X_s}(\mathcal{F}_s)$
which are specializations of $x$ but not equal to $x$.)
In words, no point of $\text{Ass}_{X_s}(\mathcal{F}_s)$
is a proper specialization of $x$.

\medskip\noindent
Suppose given a commutative diagram
$$
\xymatrix{
(X, x) \ar[d] & (X', x') \ar[l]^g \ar[d] \\
(S, s) & (S', s') \ar[l]_e
}
$$
of pointed schemes whose horizontal arrows are elementary \'etale
neighbourhoods. Then it suffices to prove the statement for
$x'$, $s'$, $g^*\mathcal{F}$ and $e^*\mathcal{G}$, see
Lemma \ref{lemma-etale-weak-assassin-up-down}.
Note that property $(*)$ is preserved by such an \'etale localization
by the same lemma (if there is a proper specialization 
$x' \leadsto x''$ on $X'_{s'}$ then this maps to a proper
specialization on $X_s$ because the fibres of an \'etale morphism
are discrete). We may also replace $S$ by the spectrum of its local ring
as the condition of being an associated point of a quasi-coherent sheaf
depends only on the stalk of the sheaf. Again property $(*)$ is
preserved by this as well. Thus we may first apply
Propostion \ref{proposition-finite-type-flat-at-point}
to reduce to the case where $\mathcal{F}$ is of finite presentation
and flat over $S$, whereupon we may use
Proposition \ref{proposition-finite-presentation-flat-at-point}
to reduce to the case that $X \to S$ is a morphism of affines
and $\Gamma(X, \mathcal{F})$ is a finitely presented
$\Gamma(X, \mathcal{O}_X)$-module which is projective as a
$\Gamma(S, \mathcal{O}_S)$-module. Localizing $S$ once more we
may assume that $\Gamma(S, \mathcal{O}_S)$ is a local ring such that
$s$ corresponds to the maximal ideal. In this case
Algebra, Theorem \ref{algebra-theorem-projective-free-over-local-ring}
guarantees that $\Gamma(X, \mathcal{F})$ is free as an
$\Gamma(S, \mathcal{O}_S)$-module. The implication
$x \in \text{WeakAss}_X(\mathcal{F} \otimes_{\mathcal{O}_X} f^*\mathcal{G})
\Rightarrow
s \in \text{WeakAss}_S(\mathcal{G})
\text{ and }
x \in \text{Ass}_{X_s}(\mathcal{F}_s)$ follows from part (1) of
Lemma \ref{lemma-weak-bourbaki-pre}.
The converse implication follows from the same lemma as property $(*)$
insures that the prime corresponding
to $x$ gives rise to a maximal element of
$\text{Ass}_{\overline{S}}(\overline{N})$ as in the statement
of part (2) of
Lemma \ref{lemma-weak-bourbaki-pre}.
\end{proof}

\begin{lemma}
\label{lemma-weak-bourbaki}
Let $R \to S$ be a ring map which is essentially of finite type.
Let $N$ be a localization of a finite $S$-module flat over $R$.
Let $M$ be an $R$-module. Then
$$
\text{WeakAss}_S(M \otimes_R N) 
=
\bigcup\nolimits_{\mathfrak p \in \text{WeakAss}_R(M)}
\text{Ass}_{S \otimes_R \kappa(\mathfrak p)}(N \otimes_R \kappa(\mathfrak p))
$$
\end{lemma}

\begin{proof}
This lemma is a translation of
Lemma \ref{lemma-bourbaki-finite-type-general-base-at-point}
into algebra. Details of translation omitted.
\end{proof}

\begin{lemma}
\label{lemma-bourbaki-finite-type-general-base}
Let $f : X \to S$ be a morphism which is locally of finite type.
Let $\mathcal{F}$ be a finite type quasi-coherent sheaf on $X$
which is flat over $S$. Let $\mathcal{G}$ be a quasi-coherent sheaf on $S$.
Then we have
$$
\text{WeakAss}_X(\mathcal{F} \otimes_{\mathcal{O}_X} f^*\mathcal{G}) =
\bigcup\nolimits_{s \in \text{WeakAss}_S(\mathcal{G})}
\text{Ass}_{X_s}(\mathcal{F}_s)
$$
\end{lemma}

\begin{proof}
Immediate consequence of
Lemma \ref{lemma-bourbaki-finite-type-general-base-at-point}.
\end{proof}

\begin{theorem}
\label{theorem-finite-type-flat}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
Assume
\begin{enumerate}
\item $X \to S$ is locally of finite presentation,
\item $\mathcal{F}$ is an $\mathcal{O}_X$-module of finite type, and
\item the set of weakly associated points of $S$ is locally finite in $S$.
\end{enumerate}
Then $U = \{x \in X \mid \mathcal{F}\text{ flat at }x\text{ over }S\}$
is open in $X$ and $\mathcal{F}|_U$ is an $\mathcal{O}_U$-module
of finite presentation and flat over $S$.
\end{theorem}

\begin{proof}
Let $x \in X$ be such that $\mathcal{F}$ is flat at $x$ over $S$.
We have to find an open neighbourhood of $x$ such that $\mathcal{F}$ restricts
to a $S$-flat finitely presented module on this neighbourhood.
The problem is local on $X$ and $S$, hence we may assume that $X$ and $S$
are affine. As $\mathcal{F}_x$ is a finitely presented
$\mathcal{O}_{X, x}$-module by
Lemma \ref{lemma-finite-type-flat-at-point-local}
we conclude from
Algebra, Lemma \ref{algebra-lemma-finite-presentation-module-independent}
there exists a finitely presented $\mathcal{O}_X$-module $\mathcal{F}'$
and a map $\varphi : \mathcal{F}' \to \mathcal{F}$ which induces
an isomorphism $\varphi_x : \mathcal{F}'_x \to \mathcal{F}_x$. In particular
we see that $\mathcal{F}'$ is flat over $S$ at $x$, hence by openness
of flatness
More on Morphisms, Theorem \ref{more-morphisms-theorem-openess-flatness}
we see that after shrinking $X$ we may assume that
$\mathcal{F}'$ is flat over $S$. As $\mathcal{F}$ is of finite type
after shrinking $X$ we may assume that $\varphi$ is surjective, see
Modules, Lemma \ref{modules-lemma-finite-type-surjective-on-stalk}
or alternatively use Nakayama's lemma
(Algebra, lemma \ref{algebra-lemma-NAK}).
By
Lemma \ref{lemma-bourbaki-finite-type-general-base}
we have
$$
\text{WeakAss}_X(\mathcal{F}') \subset
\bigcup\nolimits_{s \in \text{WeakAss}(S)} \text{Ass}_{X_s}(\mathcal{F}'_s)
$$
As $\text{WeakAss}(S)$ is finite by assumption and since
$\text{Ass}_{X_s}(\mathcal{F}'_s)$ is finite by
Divisors, Lemma \ref{divisors-lemma-finite-ass}
we conclude that $\text{WeakAss}_X(\mathcal{F}')$ is finite. Using
Algebra, Lemma \ref{algebra-lemma-silly}
we may, after shrinking $X$ once more, assume that
$\text{WeakAss}_X(\mathcal{F}')$ is contained in the generalization
of $x$. Now consider $\mathcal{K} = \text{Ker}(\varphi)$. We have
$\text{WeakAss}_X(\mathcal{K}) \subset \text{WeakAss}_X(\mathcal{F}')$
(by
Divisors, Lemma \ref{divisors-lemma-ses-weakly-ass})
but on the other hand, $\varphi_x$ is an isomorphism, also $\varphi_{x'}$
is an isomorphism for all $x' \leadsto x$. We conclude that
$\text{WeakAss}_X(\mathcal{K}) = \emptyset$ whence
$\mathcal{K} = 0$ by
Divisors, Lemma \ref{divisors-lemma-weakly-ass-zero}.
\end{proof}

\begin{lemma}[Algebra version of Theorem \ref{theorem-finite-type-flat}]
\label{lemma-finite-type-flat-algebra}
Let $R \to S$ be a ring map of finite presentation.
Let $M$ be a finite $S$-module. Assume $\text{WeakAss}_S(S)$ is finite.
Then
$$
U = \{\mathfrak q \subset S \mid M_{\mathfrak q}\text{ flat over }R\}
$$
is open in $\text{Spec}(S)$ and for every $g \in S$ such that
$D(g) \subset U$ the localization $M_g$ is a finitely presented
$S_g$-module flat over $R$.
\end{lemma}

\begin{proof}
Follows immediately from
Theorem \ref{theorem-finite-type-flat}.
\end{proof}

\begin{lemma}
\label{lemma-finite-type-flat-X}
Let $f : X \to S$ be a morphism of schemes which is locally of finite
type. Assume the set of weakly associated points of $S$ is locally finite
in $S$. Then the set of points $x \in X$ where $f$ is flat is an open
subscheme $U \subset X$ and $U \to S$ is flat and locally of finite
presentation.
\end{lemma}

\begin{proof}
The problem is local on $X$ and $S$, hence we may assume that
$X$ and $S$ are affine. Then $X \to S$ corresponds to a finite type
ring map $A \to B$. Choose a surjection $A[x_1, \ldots, x_n] \to B$
and consider $B$ as an $A[x_1, \ldots, x_n]$-module. An application of
Lemma \ref{lemma-finite-type-flat-algebra}
finishes the proof.
\end{proof}

\begin{lemma}
\label{lemma-finite-type-flat-over-integral}
Let $f : X \to S$ be a morphism of schemes which is
locally of finite type and flat. If $S$ is integral, then $f$
is locally of finite presentation.
\end{lemma}

\begin{proof}
Special case of
Lemma \ref{lemma-finite-type-flat-X}.
\end{proof}

\begin{lemma}
\label{lemma-finite-type-flat-over-integral-algebra}
Let $A \to B$ be a finite type, flat ring map with $A$ an integral
domain. Then $B$ is a finitely presented $A$-algebra.
\end{lemma}

\begin{proof}
Special case of
Lemma \ref{lemma-finite-type-flat-over-integral}.
It is also a consequence of
More on Algebra, Proposition
\ref{more-algebra-proposition-flat-finite-type-finite-presentation-domain}.
\end{proof}

\begin{remark}[Finite type version of Theorem \ref{theorem-finite-type-flat}]
\label{remark-finite-type-flat}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
Assume
\begin{enumerate}
\item $X \to S$ is locally of finite type,
\item $\mathcal{F}$ is an $\mathcal{O}_X$-module of finite type, and
\item the set of weakly associated points of $S$ is locally finite in $S$.
\end{enumerate}
Then $U = \{x \in X \mid \mathcal{F}\text{ flat at }x\text{ over }S\}$
is open in $X$ and $\mathcal{F}|_U$ is flat over $S$ and locally
finitely presented relative to $S$ (see
Definition \ref{definition-relatively-finitely-presented-sheaf}).
If we ever need this result in the stacks project we will convert
this remark into a lemma with a proof.
\end{remark}

\begin{remark}[Algebra version of Remark \ref{remark-finite-type-flat}]
\label{remark-finite-type-flat-algebra}
Let $R \to S$ be a ring map of finite type.
Let $M$ be a finite $S$-module.
Assume $\text{WeakAss}_S(S)$ is finite.
Then
$$
U = \{\mathfrak q \subset S \mid M_{\mathfrak q}\text{ flat over }R\}
$$
is open in $\text{Spec}(S)$ and for every $g \in S$ such that
$D(g) \subset U$ the localization $M_g$ is flat over $R$ and
an $S_g$-module finitely presented relative to $R$ (see
Definition \ref{definition-relatively-finitely-presented}).
If we ever need this result in the stacks project we will convert
this remark into a lemma with a proof.
\end{remark}









\section{Examples of relatively pure modules}
\label{section-examples-pure-modules}

\noindent
In the short section we discuss some examples of results that will serve
as motivation for the notion of a {\it relatively pure module} and the
concept of an {\it impurity} which we will introduce later. Each of the
examples is stated as a lemma. Note the similarity with the condition on
associated primes to the conditions appearing in
Lemmas \ref{lemma-base-change-universally-flat},
\ref{lemma-universally-injective-to-completion},
\ref{lemma-universally-injective-to-completion-flat}, and
\ref{lemma-flat-pure-over-complete-projective}.
See also
Algebra, Lemma \ref{algebra-lemma-compare-relative-assassins}
for a discussion.

\begin{lemma}
\label{lemma-explain-why-pure}
Let $R$ be a local ring with maximal ideal $\mathfrak m$.
Let $R \to S$ be a ring map. Let $N$ be an $S$-module.
Assume
\begin{enumerate}
\item $N$ is projective as an $R$-module, and
\item $S/\mathfrak mS$ is Noetherian and $N/\mathfrak mN$ is a finite
$S/\mathfrak mS$-module.
\end{enumerate}
Then for any prime $\mathfrak q \subset S$ which is an associated prime of
$N \otimes_R \kappa(\mathfrak p)$ where $\mathfrak p = R \cap \mathfrak q$
we have $\mathfrak q + \mathfrak m S \not = S$.
\end{lemma}

\begin{proof}
Note that the hypotheses of
Lemmas \ref{lemma-homothety-spectrum} and
\ref{lemma-invert-universally-injective}
are satisfied. We will use the conclusions of these lemmas without further
mention. Let $\Sigma \subset S$ be the multiplicative set of elements
which are not zero divisors on $N/\mathfrak mN$. The map
$N \to \Sigma^{-1}N$ is $R$-universally injective. Hence we see that
any $\mathfrak q \subset S$ which is an associated prime of
$N \otimes_R \kappa(\mathfrak p)$ is also an associated prime of
$\Sigma^{-1}N \otimes_R \kappa(\mathfrak p)$. Clearly this implies that
$\mathfrak q$ corresponds to a prime of $\Sigma^{-1}S$.
Thus $\mathfrak q \subset \mathfrak q'$ where $\mathfrak q'$
corresponds to an associated prime of $N/\mathfrak mN$ and we win.
\end{proof}

\noindent
The following lemma gives another (slightly silly) example of this phenomenon.

\begin{lemma}
\label{lemma-explain-why-pure-complete}
Let $R$ be a ring. Let $I \subset R$ be an ideal.
Let $R \to S$ be a ring map. Let $N$ be an $S$-module.
If $N$ is $I$-adically complete, then for any $R$-module $M$ and
for any prime $\mathfrak q \subset S$ which is an associated prime of
$N \otimes_R M$ we have $\mathfrak q + I S \not = S$.
\end{lemma}

\begin{proof}
Let $S^\wedge$ denote the $I$-adic completion of $S$.
Note that $N$ is an $S^\wedge$-module, hence also
$N \otimes_R M$ is an $S^\wedge$-module.
Let $z \in N \otimes_R M$ be an element such that
$\mathfrak q = \text{Ann}_S(z)$. Since $z \not = 0$ we see
that $\text{Ann}_{S^\wedge}(z) \not = S^\wedge$. Hence
$\mathfrak q S^\wedge \not = S^\wedge$. Hence there exists a
maximal ideal $\mathfrak m \subset S^\wedge$ with
$\mathfrak q S^\wedge \subset \mathfrak m$. Since
$IS^\wedge \subset \mathfrak m$ by
Algebra, Lemma \ref{algebra-lemma-radical-completion}
we win.
\end{proof}

\begin{lemma}
\label{lemma-explain-why-pure-direct-sum-finite-modules}
Let $R$ be a local ring with maximal ideal $\mathfrak m$.
Let $R \to S$ be a ring map. Let $N$ be an $S$-module.
Assume $N$ is isomorphic as an $R$-module to a direct
sum of finite $R$-modules. Then for any $R$-module $M$ and
for any prime $\mathfrak q \subset S$ which is an associated prime of
$N \otimes_R M$ we have $\mathfrak q + \mathfrak m S \not = S$.
\end{lemma}

\begin{proof}
Write $N = \bigoplus_{i \in I} M_i$ with each $M_i$ a finite $R$-module.
Let $M$ be an $R$-module and let $\mathfrak q \subset S$ be an associated
prime of $N \otimes_R M$ such that $\mathfrak q + \mathfrak m S = S$. Let
$z \in N \otimes_R M$ be an element with $\mathfrak q = \text{Ann}_S(z)$.
After modifying the direct sum decomposition a little bit we may assume that
$z \in M_1 \otimes_R M$ for some element $1 \in I$. Write
$1 = f + \sum x_j g_j$ for some $f \in \mathfrak q$, $x_j \in \mathfrak m$,
and $g_j \in S$. For any $g \in S$ denote $g'$ the $R$-linear map
$$
M_1 \to N \xrightarrow{g} N \to M_1
$$
where the first arrow is the inclusion map, the second arrow is multiplication
by $g$ and the third arrow is the projection map. Because each $x_j \in R$
we obtain the equality
$$
f' + \sum x_j g'_j = \text{id}_{M_1} \in \text{End}_R(M_1)
$$
By Nakayama's lemma
(Algebra, Lemma \ref{algebra-lemma-NAK})
we see that $f'$ is surjective, hence by
Algebra, Lemma \ref{algebra-lemma-fun}
we see that $f'$ is an isomorphism. In particular the map
$$
M_1 \otimes_R M \to N \otimes_R M \xrightarrow{f} N \otimes_R M
\to M_1 \otimes_R M
$$
is an isomorphism. This contradicts the assumption that $fz = 0$.
\end{proof}

\begin{lemma}
\label{lemma-explain-why-pure-ML}
Let $R$ be a henselian local ring with maximal ideal $\mathfrak m$.
Let $R \to S$ be a ring map. Let $N$ be an $S$-module.
Assume $N$ is countably generated and Mittag-Leffler as an $R$-module.
Then for any $R$-module $M$ and for any prime $\mathfrak q \subset S$
which is an associated prime of $N \otimes_R M$ we have
$\mathfrak q + \mathfrak m S \not = S$.
\end{lemma}

\begin{proof}
This lemma reduces to
Lemma \ref{lemma-explain-why-pure-direct-sum-finite-modules}
by
Algebra, Lemma \ref{algebra-lemma-split-ML-henselian}.
\end{proof}

\noindent
Suppose $f : X \to S$ is a morphism of schemes and
$\mathcal{F}$ is a quasi-coherent module on $X$.
Let $\xi \in \text{Ass}_{X/S}(\mathcal{F})$ and let $Z = \overline{\{\xi\}}$.
Picture
$$
\xymatrix{
\xi \ar@{|->}[d] & Z \ar[r] \ar[rd] & X \ar[d]^f \\
f(\xi) & & S
}
$$
Note that $f(Z) \subset \overline{\{f(\xi)\}}$ and that $f(Z)$ is closed
if and only if equality holds, i.e., $f(Z) = \overline{\{f(\xi)\}}$.
It follows from
Lemma \ref{lemma-explain-why-pure}
that if $S$, $X$ are affine, the fibres $X_s$ are Noetherian,
$\mathcal{F}$ is of finite type, and $\Gamma(X, \mathcal{F})$
is a projective $\Gamma(S, \mathcal{O}_S)$-module, then
$f(Z) = \overline{\{f(\xi)\}}$ is a closed subset.
Slightly different analogous statements holds for the cases described in
Lemmas \ref{lemma-explain-why-pure-complete},
\ref{lemma-explain-why-pure-direct-sum-finite-modules}, and
\ref{lemma-explain-why-pure-ML}.




\section{Impurities}
\label{section-impure}

\noindent
We want to formalize the phenomenon of which we gave examples in
Section \ref{section-examples-pure-modules}
in terms of specializations of points of $\text{Ass}_{X/S}(\mathcal{F})$.
We also want to work locally around a point $s \in S$. In order to do so we
make the following definitions.

\begin{situation}
\label{situation-pre-pure}
Here $S$, $X$ are schemes and $f : X \to S$ is a finite type morphism.
Also, $\mathcal{F}$ is a finite type quasi-coherent $\mathcal{O}_X$-module.
Finally $s$ is a point of $S$.
\end{situation}

\noindent
In this situation consider a morphism $g : T \to S$, a point $t \in T$
with $g(t) = s$, a specialization $t' \leadsto t$, and a point
$\xi \in X_T$ in the base change of $X$ lying over $t'$. Picture
\begin{equation}
\label{equation-impurity}
\vcenter{
\xymatrix{
\xi \ar@{|->}[d] & \\
t' \ar@{~>}[r] & t \ar@{|->}[d] \\
& s
}
}
\quad\quad
\vcenter{
\xymatrix{
X_T \ar[d] \ar[r] & X \ar[d] \\
T \ar[d]^g \ar[r]^g & S \\
S
}
}
\end{equation}
Moreover, denote $\mathcal{F}_T$ the pullback of $\mathcal{F}$ to $X_T$.

\begin{definition}
\label{definition-impurity}
In
Situation \ref{situation-pre-pure}
we say a diagram (\ref{equation-impurity}) defines an
{\it impurity of $\mathcal{F}$ above $s$}
if $\xi \in \text{Ass}_{X_T/T}(\mathcal{F}_T)$ and
$\overline{\{\xi\}} \cap X_t = \emptyset$. We will indicate
this by saying ``let $(g : T \to S, t' \leadsto t, \xi)$ be
an impurity of $\mathcal{F}$ above $s$''.
\end{definition}

\begin{lemma}
\label{lemma-impure-finite-presentation}
In Situation \ref{situation-pre-pure}.
If there exists an impurity of $\mathcal{F}$ above $s$, then
there exists an impurity $(g : T \to S, t' \leadsto t, \xi)$
of $\mathcal{F}$ above $s$ such that $g$ is locally of finite
presentation and $t$ a closed point of the fibre of $g$ above $s$.
\end{lemma}

\begin{proof}
Let $(g : T \to S, t' \leadsto t, \xi)$ be any impurity of
$\mathcal{F}$ above $s$. We apply
Limits, Lemma \ref{limits-lemma-separate}
to $t \in T$ and $Z = \overline{\{\xi\}}$ to obtain
$V \subset T$, $a : V \to T'$, $b : T' \to S$, and $Z' \subset X_{T'}$.
As $t'$ specializes to $t$ we may replace $T$ by the open neighbourhood
$V$ of $t$. Thus we have a commutative diagram
$$
\xymatrix{
X_T \ar[d] \ar[r] &
X_{T'} \ar[d] \ar[r] &
X \ar[d] \\
T \ar[r]^a & T' \ar[r]^b & S
}
$$
where $b \circ a = g$. Let $\xi' \in X_{T'}$ denote the
image of $\xi$. By
Divisors, Lemma \ref{divisors-lemma-base-change-relative-assasin}
we see that $\xi' \in \text{Ass}_{X_{T'}/T'}(\mathcal{F}_{T'})$.
Moreover, by construction the closure of $\overline{\{\xi'\}}$
is contained in the closed subset $Z'$ which avoids the fibre
$X_{a(t)}$. In this way we see that $(T' \to S, a(t') \leadsto a(t), \xi')$
is an impurity of $\mathcal{F}$ above $s$.

\medskip\noindent
Thus we may assume that $g : T \to S$ is locally of finite presentation.
Let $Z = \overline{\{\xi\}}$. By assumption $Z_t = \emptyset$. By
More on Morphisms, Lemma \ref{more-morphisms-lemma-empty-generic-fibre}
this means that $Z_{t''} = \emptyset$ for $t''$ in an open subset
of $\overline{\{t\}}$. Since the fibre of
$T \to S$ over $s$ is a Jacobson scheme, see
Morphisms, Lemma \ref{morphisms-lemma-ubiquity-Jacobson-schemes}
we find that there exist a closed point $t'' \in \overline{\{t\}}$ such that
$Z_{t''} = \emptyset$. Then $(g : T \to S, t' \leadsto t'', \xi)$ is the
desired impurity.
\end{proof}

\begin{lemma}
\label{lemma-impure-limit}
In Situation \ref{situation-pre-pure}.
Let $(g : T \to S, t' \leadsto t, \xi)$ be an impurity of
$\mathcal{F}$ above $s$. Assume $S$ is affine and that $T$
is written $T = \text{lim}_{i \in I}\ T_i$ as a directed colimit
of affine schemes over $S$. Then for some $i$ the triple
$(T_i \to S, t'_i \leadsto t_i, \xi_i)$ is an impurity of
$\mathcal{F}$ above $s$.
\end{lemma}

\begin{proof}
The notation in the statement means this: Let $f_i : T \to T_i$
be the projection morphisms, let $t_i = f_i(t)$ and $t'_i = f_i(t')$.
Finally $\xi_i \in X_{T_i}$ is the image of $\xi$. By
Divisors, Lemma \ref{divisors-lemma-base-change-relative-assasin}
it is true that $\xi_i$ is a point of the relative
assassin of $\mathcal{F}_{T_i}$ over $T_i$. Thus the only point is to
show that $\overline{\{\xi_i\}} \cap X_{t_i} = \emptyset$ for some
$i$. In order to show this, set $Z = \overline{\{\xi\}}$ and
choose a diagram
$$
\xymatrix{
V \ar[d] \ar[r]_a & T' \ar[d]^b \\
T \ar[r]^g & S,
}
$$
and a closed subscheme $Z' \subset X_{T'}$ as in
Limits, Lemma \ref{limits-lemma-separate}.
We may assume $V$ is an affine open of $T$, hence by
Limits, Lemmas \ref{limits-lemma-descend-opens} and
\ref{limits-lemma-limit-affine}
we can find an $i$ and an affine open $V_i \subset T_i$ with
$V = f_i^{-1}(V_i)$. By
Limits,
Proposition \ref{limits-proposition-characterize-locally-finite-presentation}
after possibly increasing $i$ a bit we can find a morphism
$a_i : V_i \to T'$ such that $a = a_i \circ f_i|_V$.
As $Z' \cap X_{t'} = \emptyset$ we conclude that
$(T_i \to S, t'_i \leadsto t_i, \xi_i)$ is an impurity of
$\mathcal{F}$ above $s$.
\end{proof}

\begin{lemma}
\label{lemma-quasi-finite-impurity-elementary}
In Situation \ref{situation-pre-pure}.
If there exists an impurity $(g : T \to S, t' \leadsto t, \xi)$
of $\mathcal{F}$ above $s$ with $g$ quasi-finite at $t$, then there
exists an impurity $(g : T \to S, t' \leadsto t, \xi)$ such that
$(T, t) \to (S, s)$ is an elementary \'etale neighbourhood.
\end{lemma}

\begin{proof}
Let $(g : T \to S, t' \leadsto t, \xi)$ be an impurity of
$\mathcal{F}$ above $s$ such that $g$ is quasi-finite at $t$.
After shrinking $T$ we may assume that $g$ is locally of finite type.
Apply
More on Morphisms,
Lemma \ref{more-morphisms-lemma-etale-makes-quasi-finite-finite-at-point}
to $T \to S$ and $t \mapsto s$. This gives us a diagram
$$
\xymatrix{
T \ar[d] & T \times_S U \ar[l] \ar[d] & V \ar[l] \ar[ld] \\
S & U \ar[l]
}
$$
where $(U, u) \to (S, s)$ is an elementary \'etale neighbourhood
and $V \subset T \times_S U$ is an open neighbouhood of $v = (t, u)$
such that $V \to U$ is finite and such that $v$ is the unique point of $V$
lying over $u$. Since the morphism $V \to T$ is \'etale
hence flat we see that there exists a specialization $v' \leadsto v$ such
that $v' \mapsto t'$. Note that $\kappa(t') \subset \kappa(v')$
is finite separable. Pick any point $\zeta \in X_{v'}$ mapping to
$\xi \in X_{t'}$. By
Divisors, Lemma \ref{divisors-lemma-base-change-relative-assasin}
we see that $\zeta \in \text{Ass}_{X_V/V}(\mathcal{F}_V)$.
Moreover, the closure $\overline{\{\zeta\}}$ does not meet
the fibre $X_v$ as by assumption the closure $\overline{\{\xi\}}$
does not meet $X_t$. In other words $(V \to S, v' \leadsto v, \zeta)$
is an impurity of $\mathcal{F}$ above $S$.

\medskip\noindent
Next, let $u' \in U'$ be the image of $v'$ and let
$\theta \in X_U$ be the image of $\zeta$.
Then $\theta \mapsto u'$ and $u' \leadsto u$.
By
Divisors, Lemma \ref{divisors-lemma-base-change-relative-assasin}
we see that $\theta \in \text{Ass}_{X_U/U}(\mathcal{F})$.
Moreover, as $\pi : X_V \to X_U$ is finite we see that
$\pi\big(\overline{\{\zeta\}}\big) = \overline{\{\pi(\zeta)\}}$. Since
$v$ is the unique point of $V$ lying over $u$ we see that
$X_u \cap \overline{\{\pi(\zeta)\}} = \emptyset$ because
$X_v \cap \overline{\{\zeta\}} = \emptyset$. In this way we conclude that
$(U \to S, u' \leadsto u, \theta)$ is an impurity of
$\mathcal{F}$ above $s$ and we win.
\end{proof}

\begin{lemma}
\label{lemma-Noetherian-impurity-quasi-finite}
In Situation \ref{situation-pre-pure}.
Assume that $S$ is locally Noetherian.
If there exists an impurity of $\mathcal{F}$ above $s$, then
there exists an impurity $(g : T \to S, t' \leadsto t, \xi)$
of $\mathcal{F}$ above $s$ such that $g$ is quasi-finite at $t$.
\end{lemma}

\begin{proof}
We may replace $S$ by an affine neighbourhood of $s$. By
Lemma \ref{lemma-impure-finite-presentation}
we may assume that we have an impurity $(g : T \to S, t' \leadsto t, \xi)$
of such that $g$ is locally of finite type and $t$ a closed point of the
fibre of $g$ above $s$. We may replace $T$ by the reduced induced
scheme structure on $\overline{\{t'\}}$. Let
$Z = \overline{\{\xi\}} \subset X_T$. By assumption $Z_t = \emptyset$
and the image of $Z \to T$ contains $t'$. By
Divisors, Lemma \ref{divisors-lemma-relative-assasin-in-neighbourhood}
there exists a nonempty open $V \subset Z$ such that for any
$w \in f(V)$ any generic point $\xi'$ of $V_w$ is in
$\text{Ass}_{X_T/T}(\mathcal{F}_T)$. By
More on Morphisms, Lemma \ref{more-morphisms-lemma-nonempty-generic-fibre}
there exists a nonempty open $W \subset T$ with $W \subset f(V)$. By
More on Morphisms, Lemma
\ref{more-morphisms-lemma-quasi-finite-quasi-section-meeting-nearby-open-X}
there exists a closed subscheme $T' \subset T$ such that
$t \in T'$, $T' \to S$ is quasi-finite at $t$, and there exists a point
$z \in T' \cap W$, $z \leadsto t$ which does not map to $s$.
Choose any generic point $\xi'$ of the nonempty scheme $V_z$.
Then $(T' \to S, z \leadsto t, \xi')$ is the desired impurity.
\end{proof}

\noindent
In the following we will use the henselization
$S^h = \text{Spec}(\mathcal{O}_{S, s}^h)$
of $S$ at $s$, see
\'Etale Cohomology,
Definition \ref{etale-cohomology-definition-etale-local-rings}.
Since $S^h \to S$ maps to closed point of $S^h$ to $s$ and
induces an isomorphism of residue fields, we will indicate
$s \in S^h$ this closed point also. Thus $(S^h, s) \to (S, s)$ is
a morphism of pointed schemes.

\begin{lemma}
\label{lemma-impurity-on-henselization}
In Situation \ref{situation-pre-pure}.
If there exists an impurity $(S^h \to S, s' \leadsto s, \xi)$
of $\mathcal{F}$ above $s$ then there exists an impurity
$(T \to S, t' \leadsto t, \xi)$ of $\mathcal{F}$ above $s$
where $(T, t) \to (S, s)$ is an elementary \'etale neighbourhood.
\end{lemma}

\begin{proof}
We may replace $S$ by an affine neighbourhood of $s$.
Say $S = \text{Spec}(A)$ and $s$ corresponds to the prime
$\mathfrak p \subset A$. Then
$\mathcal{O}_{S, s}^h = \text{colim}_{(T, t)} \Gamma(T, \mathcal{O}_T)$
where the limit is over the opposite of the
cofiltered category of affine elementary \'etale neighbourhoods
$(T, t)$ of $(S, s)$, see
More on Morphisms,
Lemma \ref{more-morphisms-lemma-elementary-etale-neighbourhoods}
and
\'Etale Cohomology,
Lemma \ref{etale-cohomology-lemma-describe-henselization}.
Hence $S^h = \text{lim}_i\ T_i$ and we win by
Lemma \ref{lemma-impure-limit}.
\end{proof}

\begin{lemma}
\label{lemma-pure-along-X-s}
In Situation \ref{situation-pre-pure} the following
are equivalent
\begin{enumerate}
\item there exists an impurity $(S^h \to S, s' \leadsto s, \xi)$
of $\mathcal{F}$ above $s$ where $S^h$ is the henselization of $S$ at $s$,
\item there exists an impurity $(T \to S, t' \leadsto t, \xi)$
of $\mathcal{F}$ above $s$ such that $(T, t) \to (S, s)$ is an
elementary \'etale neighbourhood, and
\item there exists an impurity $(T \to S, t' \leadsto t, \xi)$
of $\mathcal{F}$ above $s$ such that $T \to S$ is quasi-finite at $t$.
\end{enumerate}
\end{lemma}

\begin{proof}
As an \'etale morphism is locally quasi-finite it is clear that
(2) implies (3). We have seen that (3) implies (2) in
Lemma \ref{lemma-quasi-finite-impurity-elementary}.
We have seen that (1) implies (2) in
Lemma \ref{lemma-impurity-on-henselization}.
Finally, if $(T \to S, t' \leadsto t, \xi)$ is an impurity
of $\mathcal{F}$ above $s$ such that $(T, t) \to (S, s)$ is an
elementary \'etale neighbourhood, then we can choose a factorization
$S^h \to T \to S$ of the structure morphism $S^h \to S$.
Choose any point $s' \in S^h$ mapping to $t'$ and choose any
$\xi' \in X_{s'}$ mapping to $\xi \in X_{t'}$. Then
$(S^h \to S, s' \leadsto s, \xi')$ is an impurity of
$\mathcal{F}$ above $s$. We omit the details.
\end{proof}





\section{Relatively pure modules}
\label{section-pure}

\noindent
The notion of a module pure relative to a base was introduced in \cite{GruRay}.

\begin{definition}
\label{definition-pure}
Let $f : X \to S$ be a morphism of schemes which is of finite type.
Let $\mathcal{F}$ be a finite type quasi-coherent $\mathcal{O}_X$-module.
\begin{enumerate}
\item Let $s \in S$. We say $\mathcal{F}$ is {\it pure along $X_s$}
if there is no impurity $(g : T \to S, t' \leadsto t, \xi)$
of $\mathcal{F}$ above $s$ with $(T, t) \to (S, s)$ an
elementary \'etale neighbourhood.
\item We say $\mathcal{F}$ is {\it universally pure along $X_s$}
if there does not exist any impurity of $\mathcal{F}$ above $s$.
\item We say that $X$ is {\it pure along $X_s$} if $\mathcal{O}_X$
is pure along $X_s$.
\item We say $\mathcal{F}$ is {\it universally $S$-pure}, or
{\it universally pure relative to $S$} if $\mathcal{F}$ is universally
pure along $X_s$ for every $s \in S$.
\item We say $\mathcal{F}$ is {\it $S$-pure}, or
{\it pure relative to $S$} if $\mathcal{F}$ is pure along $X_s$
for every $s \in S$.
\item We say that $X$ is {\it $S$-pure} or {\it pure relative to $S$}
if $\mathcal{O}_X$ is pure relative to $S$.
\end{enumerate}
\end{definition}

\noindent
We intentionally restrict ourselves here to morphisms which are
of finite type and not just morphisms which are locally of
finite type, see
Remark \ref{remark-discuss-finite-type}
for a discussion. In the situation of the definition
Lemma \ref{lemma-pure-along-X-s}
tells us that the following are equivalent
\begin{enumerate}
\item $\mathcal{F}$ is pure along $X_s$,
\item there is no impurity $(g : T \to S, t' \leadsto t, \xi)$ with $g$
quasi-finite at $t$,
\item there does not exist any impurity of the form
$(S^h \to S, s' \leadsto s, \xi)$, where $S^h$ is the strict henselization
of $S$ at $s$.
\end{enumerate}
If we denote $X^h = X \times_S S^h$ and $\mathcal{F}^h$ the pullback
of $\mathcal{F}$ to $X^h$, then we can formulate the last condition
in the following more positive way:
\begin{enumerate}
\item[(4)] All points of $\text{Ass}_{X^h/S^h}(\mathcal{F}^h)$ specialize
to points of $X_s$.
\end{enumerate}
In particular, it is clear that $\mathcal{F}$ is pure along $X_s$
if and only if the pullback of $\mathcal{F}$ to
$X \times_S \text{Spec}(\mathcal{O}_{S, s})$ is pure along $X_s$.

\begin{remark}
\label{remark-discuss-finite-type}
Let $f : X \to S$ be a morphism which is locally of finite type
and $\mathcal{F}$ a quasi-coherent finite type $\mathcal{O}_X$-module.
In this case it is still true that (1) and (2) above are equivalent
because the proof of
Lemma \ref{lemma-quasi-finite-impurity-elementary}
does not use that $f$ is quasi-compact. It is also clear that
(3) and (4) are equivalent. However, we don't know if (1) and (3) are
equivalent. In this case it may sometimes be more convenient to define
purity using the equivalent conditions (3) and (4) as is done in \cite{GruRay}.
On the other hand, for many applications it seems that the correct notion
is really that of being universally pure.
\end{remark}

\noindent
A natural question to ask is if the propery of being pure relative to
the base is preserved by base change. It turns out that this is true
over Noetherian base schemes, or if the sheaf is flat. It is not true
in general, even if the morphism and the sheaf are of finite presentation, see
Examples, Section \ref{examples-section-pure-not-universally}.
Before we explain this we match our usage of "universally"
to the usual notion.

\begin{lemma}
\label{lemma-base-change-universally}
Let $f : X \to S$ be a morphism of schemes which is of finite type.
Let $\mathcal{F}$ be a finite type quasi-coherent $\mathcal{O}_X$-module.
Let $s \in S$. The following are equivalent
\begin{enumerate}
\item $\mathcal{F}$ is universally pure along $X_s$, and
\item for every morphism of pointed schemes $(S', s') \to (S, s)$
the pullback $\mathcal{F}_{S'}$ is pure along $X_{s'}$.
\end{enumerate}
In particular, $\mathcal{F}$ is universally pure relative to $S$ if and
only if every base change $\mathcal{F}_{S'}$ of $\mathcal{F}$ is
pure relative to $S'$.
\end{lemma}

\begin{proof}
This is formal.
\end{proof}

\begin{lemma}
\label{lemma-quasi-finite-base-change}
Let $f : X \to S$ be a morphism of schemes which is of finite type.
Let $\mathcal{F}$ be a finite type quasi-coherent $\mathcal{O}_X$-module.
Let $s \in S$. Let $(S', s') \to (S, s)$ be a morphism of pointed schemes.
If $S' \to S$ is quasi-finite at $s'$ and $\mathcal{F}$ is pure along $X_s$,
then $\mathcal{F}_{S'}$ is pure along $X_{s'}$.
\end{lemma}

\begin{proof}
It $(T \to S', t' \leadsto t, \xi)$ is an impurity of
$\mathcal{F}_{S'}$ above $s'$ with $T \to S'$ quasi-finite at $t$,
then $(T \to S, t' \to t, \xi)$ is an impurity of $\mathcal{F}$
above $s$ with $T \to S$ quasi-finite at $t$, see
Morphisms, Lemma \ref{morphisms-lemma-composition-quasi-finite}.
Hence the lemma follows immediately from the characterization (2)
of purity given following
Definition \ref{definition-pure}.
\end{proof}

\begin{lemma}
\label{lemma-Noetherian-base-change}
Let $f : X \to S$ be a morphism of schemes which is of finite type.
Let $\mathcal{F}$ be a finite type quasi-coherent $\mathcal{O}_X$-module.
Let $s \in S$. If $\mathcal{O}_{S, s}$ is Noetherian then
$\mathcal{F}$ is pure along $X_s$ if and only if $\mathcal{F}$
is universally pure along $X_s$.
\end{lemma}

\begin{proof}
First we may replace $S$ by $\text{Spec}(\mathcal{O}_{S, s})$, i.e.,
we may assume that $S$ is Noetherian. Next, use
Lemma \ref{lemma-Noetherian-impurity-quasi-finite}
and characterization (2) of purity given in discussion following
Definition \ref{definition-pure}
to conclude.
\end{proof}

\noindent
Purity satisfies flat descent.

\begin{lemma}
\label{lemma-flat-descend-pure}
Let $f : X \to S$ be a morphism of schemes which is of finite type.
Let $\mathcal{F}$ be a finite type quasi-coherent $\mathcal{O}_X$-module.
Let $s \in S$. Let $(S', s') \to (S, s)$ be a morphism of pointed schemes.
Assume $S' \to S$ is flat at $s'$.
\begin{enumerate}
\item If $\mathcal{F}_{S'}$ is pure along $X_{s'}$,
then $\mathcal{F}$ is pure along $X_s$.
\item If $\mathcal{F}_{S'}$ is universally pure along $X_{s'}$,
then $\mathcal{F}$ is universally pure along $X_s$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $(T \to S, t' \leadsto t, \xi)$ be an impurity of
$\mathcal{F}$ above $s$. Set $T_1 = T \times_S S'$, and let $t_1$
be the unique point of $T_1$ mapping to $t$ and $s'$. Since
$T_1 \to T$ is flat at $t_1$, see
Morphisms, Lemma \ref{morphisms-lemma-base-change-flat},
there exists a specialization $t'_1 \leadsto t_1$ lying over
$t' \leadsto t$, see
Algebra, Section \ref{algebra-section-going-up}.
Choose a point $\xi_1 \in X_{t'_1}$ which corresponds to a generic
point of $\text{Spec}(\kappa(t'_1) \otimes_{\kappa(t')} \kappa(\xi))$, see
Schemes, Lemma \ref{schemes-lemma-points-fibre-product}.
By
Divisors, Lemma \ref{divisors-lemma-base-change-relative-assasin}
we see that $\xi_1 \in \text{Ass}_{X_{T_1}/T_1}(\mathcal{F}_{T_1})$.
As the Zariski closure of $\{\xi_1\}$ in $X_{T_1}$ maps into the
Zariski closure of $\{\xi\}$ in $X_T$ we conclude that
this closure is disjoint from $X_{t_1}$. Hence
$(T_1 \to S', t'_1 \leadsto t_1, \xi_1)$
is an impurity of $\mathcal{F}_{S'}$ above $s'$.
In other words we have proved the contrapositive to part (2) of the
lemma. Finally, if $(T, t) \to (S, s)$ is an elementary
\'etale neighbourhood, then $(T_1, t_1) \to (S', s')$ is an
elementary \'etale neighbourhood too, and in this way we see that (1) holds.
\end{proof}

\begin{lemma}
\label{lemma-supported-on-closed}
Let $i : Z \to X$ be a closed immersion of schemes of finite type over
a scheme $S$. Let $s \in S$. Let $\mathcal{F}$ be a
finite type, quasi-coherent sheaf on $Z$. Then $\mathcal{F}$ is
(universally) pure along $Z_s$ if and only if $i_*\mathcal{F}$
is (universally) pure along $X_s$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}








\section{Examples of relatively pure sheaves}
\label{section-examples-pure-sheaves}

\noindent
Here are some example cases where it is possible to see what purity means.

\begin{lemma}
\label{lemma-proper-pure}
Let $f : X \to S$ be a proper morphism of schemes.
Then every finite type, quasi-coherent $\mathcal{O}_X$-module
$\mathcal{F}$ is universally pure relative to $S$. In particular
$X$ is universally pure relative to $S$.
\end{lemma}

\begin{proof}
Let $(g : T \to S, t' \leadsto t, \xi)$ be an impurity of $\mathcal{F}$
above $s \in S$. Since $f$ is proper, it is universally closed. Hence
$f_T : X_T \to T$ is closed. Since $f_T(\xi) = t'$ this implies that
$t \in f(\overline{\{\xi\}})$ which is a contradiction.
\end{proof}

\begin{lemma}
\label{lemma-quasi-finite-pure}
Let $f : X \to S$ be a separated, finite type morphism of schemes.
Let $\mathcal{F}$ be a finite type, quasi-coherent $\mathcal{O}_X$-module.
Assume that $\text{Supp}(\mathcal{F}_s)$ is finite for every $s \in S$.
Then the following are equivalent
\begin{enumerate}
\item $\mathcal{F}$ is pure relative to $S$,
\item the scheme theoretic support of $\mathcal{F}$ is finite over $S$, and
\item $\mathcal{F}$ is universally pure relative to $S$.
\end{enumerate}
In particular, given a quasi-finite separated morphism $X \to S$ we see
that $X$ is pure relative to $S$ if and only if $X \to S$ is finite.
\end{lemma}

\begin{proof}
Let $Z \subset X$ be the scheme theoretic support of $\mathcal{F}$, see
Coherent, Definition \ref{coherent-definition-scheme-theoretic-support}.
Then $Z \to S$ is a separated, finite type morphism of schemes with
finite fibres. Hence it is separated and quasi-finite, see
Morphisms, Lemma \ref{morphisms-lemma-quasi-finite}.
By
Lemma \ref{lemma-supported-on-closed}
it suffices to prove the lemma for $Z \to S$ and the sheaf $\mathcal{F}$
viewed as a finite type quasi-coherent module on $Z$. Hence we may
assume that $X \to S$ is separated and quasi-finite and that
$\text{Supp}(\mathcal{F}) = X$.

\medskip\noindent
It follows from
Lemma \ref{lemma-proper-pure}
and
Morphisms, Lemma \ref{morphisms-lemma-finite-proper}
that (2) implies (3). Trivially (3) implies (1). Assume (1) holds.
We will prove that (2) holds. It is clear that we may assume $S$ is affine. By
More on Morphisms,
Lemma \ref{more-morphisms-lemma-quasi-finite-separated-pass-through-finite}
we can find a diagram
$$
\xymatrix{
X \ar[rd]_f \ar[rr]_j & & T \ar[ld]^\pi \\
& S &
}
$$
with $\pi$ finite and $j$ a quasi-compact open immersion.
If we show that $j$ is closed, then $j$ is a closed immersion
and we conclude that $f = \pi \circ j$ is finite.
To show that $j$ is closed it suffices to show that specializations
lift along $j$, see
Schemes, Lemma \ref{schemes-lemma-quasi-compact-closed}.
Let $x \in X$, set $t' = j(x)$ and let $t' \leadsto t$ be a specialization.
We have to show $t \in j(X)$. Set $s' = f(x)$ and $s = \pi(t)$ so
$s' \leadsto s$. By
More on Morphisms, Lemma
\ref{more-morphisms-lemma-etale-splits-off-quasi-finite-part-technical}
we can find an elementary \'etale neighbourhood
$(U, u) \to (S, s)$ and a decomposition
$$
T_U = T \times_S U = V \amalg W
$$
into open and closed subschemes, such that $V \to U$ is finite and
there exists a unique point $v$ of $V$ mapping to $u$, and such that
$v$ maps to $t$ in $T$. As $V \to T$ is etale, we can lift generalizations, see
Morphisms, Lemmas \ref{morphisms-lemma-generalizations-lift-flat} and
\ref{morphisms-lemma-etale-flat}.
Hence there exists a specialization $v' \leadsto v$ such that $v'$
maps to $t' \in T$. In particular we see that $v' \in X_U \subset T_U$.
Denote $u' \in U$ the image of $t'$. Note that
$v' \in \text{Ass}_{X_U/U}(\mathcal{F})$ because $X_{u'}$ is a finite
discrete set and $X_{u'} = \text{Supp}(\mathcal{F}_{u'})$.
As $\mathcal{F}$ is pure relative to $S$ we see that $v'$ must
specialize to a point in $X_u$. Since $v$ is the only point of
$V$ lying over $u$ (and since no point of $W$ can be a specialization
of $v'$) we see that $v \in X_u$. Hence $t \in X$.
\end{proof}

\begin{lemma}
\label{lemma-flat-geometrically-integral-fibres-pure}
Let $f : X \to S$ be a finite type, flat morphism of schemes
with geometrically integral fibres. Then $X$ is universally pure
over $S$.
\end{lemma}

\begin{proof}
Let $\xi \in X$ with $s' = f(\xi)$ and $s' \leadsto s$ a specialization
of $S$. If $\xi$ is an associated point of $X_{s'}$, then $\xi$ is the
unique generic point because $X_{s'}$ is an integral scheme. Let
$\xi_0$ be the unique generic point of $X_s$. As $X \to S$ is flat
we can lift $s' \leadsto s$ to a specialization
$\xi' \leadsto \xi_0$ in $X$, see
Morphisms, Lemma \ref{morphisms-lemma-generalizations-lift-flat}.
The $\xi \leadsto \xi'$ because $\xi$ is the generic point of $X_{s'}$
hence $\xi \leadsto \xi_0$. This means that $(\text{id}_S, s' \to s, \xi)$
is not an impurity of $\mathcal{O}_X$ above $s$. Since the assumption
that $f$ is finite type, flat with geometrically integral fibres
is preserved under base change, we see that there doesn't exist an
impurity after any base change. In this way we see that $X$ is
universally $S$-pure.
\end{proof}




\section{Flattening stratification}
\label{section-flattening}

\noindent
If $f : X \to S$ is a proper, finitely presented morphism
of schemes then one can find a stratification of the base
over whose members the morphism $f$ is flat. It is not so hard
to find this stratification, but what is a bit tricky is to prove
that this stratification is characterized by a universal property.
In this section we discuss this and some of its variants.

\medskip\noindent
The first case is where the base is the spectrum of a complete
local Noetherian ring. In this case the closed stratum is defined
and satisfies the desired universal property even for a general
finite type morphism, provided we {\it only} look for flatness in
points lying over the closed point.

\begin{lemma}
\label{lemma-flattening-complete-noetherian}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{F}$ be a quasi-coherent sheaf on $X$.
Assume
\begin{enumerate}
\item $S = \text{Spec}(A)$ is the spectrum of a Noetherian complete
local ring $A$,
\item $f$ is of finite type, and
\item $\mathcal{F}$ is a finite type $\mathcal{O}_X$-module.
\end{enumerate}
Then there exists a closed subscheme $Z \subset S$ with the following
universal property: Given a morphism $S' \to S$ which corresponds to
a local homomorphism $A' \to A$ of local rings the following
are equivalent
\begin{enumerate}
\item[(a)] the pullback $\mathcal{F}'$ of $\mathcal{F}$ to
$X' = S' \times_S X$ is flat over $S'$ at all points $x' \in X'$
lying over the closed point of $S'$, and
\item[(b)] $S' \to S$ factors through $Z$.
\end{enumerate}
In particular, $Z$ is the largest closed subscheme of $S$ such that
$\mathcal{F}|_{X_Z}$ is flat over $Z$ at all points
of $X_Z$ lying over the closed point of $Z$.
\end{lemma}

\begin{proof}
As $f$ is of finite type it is quasi-compact. Hence $X$ is quasi-compact.
Choose a finite affine open covering $X = \bigcup X_i$.
Write $X_i = \text{Spec}(B_i)$ so that $A \to B_i$ is a finite type
ring map. Note that $\mathcal{F}|_{X_i}$ corresponds to a finite
$B_i$-module $M_i$. Set $Y = \coprod X_i = \text{Spec}(\prod B_i)$
and $\mathcal{G} = \widetilde{\prod M_i}$ on $Y$.
Now if $S' \to S$ is a morphism as in the lemma, then (a) holds
for $\mathcal{F}'$ relative to $X' \to S'$ if and only if (a) holds for
$\mathcal{G}'$ relative to $Y' \to S'$. Hence this
reduces us to the case where $X$ is affine.
In this case $Z$ exists by
More on Algebra,
Lemma \ref{more-algebra-lemma-flattening-complete-local-universal-property}.
(Hint: We strongly suggest the reader only read the construction of
$Z = \text{Spec}(A/I)$ in
More on Algebra,
Lemma \ref{more-algebra-lemma-flattening-complete-local-noetherian}.)
\end{proof}





\input{chapters}


\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}
