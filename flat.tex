\input{preamble}

% OK, start here.
%
\begin{document}

\title{More on flatness}

\maketitle

\phantomsection
\label{section-phantom}

\tableofcontents



\section{Introduction}
\label{section-introduction}

\noindent
In this chapter, we discuss some advanced results on flat modules and
flat morphisms of schemes. Most of these results can be
found in the paper \cite{GruRay} by Raynaud and Gruson.

\medskip\noindent
Before reading this chapter we advise the reader to take a look
at the following results (this list also serves as a pointer to
previous results):
\begin{enumerate}
\item General discussion on flat modules in
Algebra, Section \ref{algebra-section-flat}.
\item The relationship between $\text{Tor}$-groups and flatness, see
Algebra, Section \ref{algebra-section-tor}.
\item The sections on flatness criteria, namely,
Algebra, Section \ref{algebra-section-criteria-flatness}
(Noetherian case),
Algebra, Section \ref{algebra-section-flatness-artinian}
(Artinian case),
Algebra, Section \ref{algebra-section-more-flatness-criteria}
(non-Noetherian case), and finally
More on Morphisms, Section \ref{more-morphisms-section-criterion-flat-fibres}.
\item Generic flatness, see
Algebra, Section \ref{algebra-section-generic-flatness}
and
Morphisms, Section \ref{morphisms-section-generic-flatness}.
\item Openness of the flat locus, see
Algebra, Section \ref{algebra-section-open-flat}
and
More on Morphisms, Section \ref{more-morphisms-section-open-flat}.
\item Flattening stratification, see
Algebra, Section \ref{algebra-section-flattening}.
\item Additional algebraic in
Algebra, Sections \ref{algebra-section-descent-flatness-integral},
\ref{algebra-section-torsion-flat},
\ref{algebra-section-flat-finite}, and
\ref{algebra-section-blowup-flat}.
\end{enumerate}








\section{The local structure of a finite type module}
\label{section-local-structure-module}

\noindent
The key technical lemma that makes a lot of the arguments in this
chapter work is the geometric
Lemma \ref{lemma-elementary-devissage}.

\begin{lemma}
\label{lemma-sheaf-lives-on-subscheme}
Let $f : X \to S$ be a finite type morphism of affine schemes.
Let $\mathcal{F}$ be a finite type quasi-coherent $\mathcal{O}_X$-module.
Let $x \in X$ with image $s = f(x)$ in $S$.
Set $\mathcal{F}_s = \mathcal{F}|_{X_s}$.
Then there exist a closed immersion $i : Z \to X$ of finite presentation,
and a quasi-coherent finite type $\mathcal{O}_Z$-module $\mathcal{G}$
such that $i_*\mathcal{G} = \mathcal{F}$ and
$Z_s = \text{Supp}(\mathcal{F}_s)$.
\end{lemma}

\begin{proof}
Say the morphism $f : X \to S$ is given by the ring map
$A \to B$ and that $\mathcal{F}$ is the quasi-coherent sheaf
associated to the $B$-module $M$. By
Morphisms, Lemma \ref{morphisms-lemma-locally-finite-type-characterize}
we know that $A \to B$ is a finite type ring map, and by
Properties, Lemma \ref{properties-lemma-finite-type-module}
we know that $M$ is a finite $B$-module. In particular the
support of $\mathcal{F}$ is the closed subscheme of $\text{Spec}(B)$
cut out by the annihilator
$I = \{x \in B \mid xm = 0\ \forall m \in M\}$ of $M$, see
Algebra, Lemma \ref{algebra-lemma-support-closed}.
Let $\mathfrak q \subset B$ be the prime ideal corresponding to $x$
and let $\mathfrak p \subset A$ be the prime ideal corresponding to $s$.
Note that $X_s = \text{Spec}(B \otimes_A \kappa(\mathfrak p))$ and
that $\mathcal{F}_s$ is the quasi-coherent sheaf associated to the
$B \otimes_A \kappa(\mathfrak p)$ module $M \otimes_A \kappa(\mathfrak p)$. By
Divisors, Lemma \ref{divisors-lemma-support-finite-type}
the support of $\mathcal{F}_s$ is equal to
$V(I(B \otimes_A \kappa(\mathfrak p)))$. Since
$B \otimes_A \kappa(\mathfrak p)$ is of finite type over $\kappa(\mathfrak p)$
there exist finitely many elements $f_1, \ldots, f_m \in I$
such that
$$
I(B \otimes_A \kappa(\mathfrak p)) =
(f_1, \ldots, f_n)(B \otimes_A \kappa(\mathfrak p)).
$$
Denote $i : Z \to X$ the closed subscheme cut out by
$(f_1, \ldots, f_m)$, in a formula $Z = \text{Spec}(B/(f_1, \ldots, f_m))$.
Since $M$ is annihilated by $I$ we can think of $M$ as an
$B/(f_1, \ldots, f_m)$-module. In other words, $\mathcal{F}$ is the
pushforward of a finite type module on $Z$.
As $Z_s = \text{Supp}(\mathcal{F}_s)$ by construction, this
proves the lemma.
\end{proof}

\begin{lemma}
\label{lemma-lift-etale}
Let $i : Z \to X$ be a closed immersion of affine schemes.
Let $Z' \to Z$ be an etale morphism with $Z'$ affine.
Then there exists an etale morphism $X' \to X$ with $X'$
affine such that $Z' \cong Z \times_X X'$ as schemes over $Z$.
\end{lemma}

\begin{proof}
See
Algebra, Lemma \ref{algebra-lemma-lift-etale}.
\end{proof}

\begin{lemma}
\label{lemma-elementary-devissage}
Let $f : X \to S$ be morphism of schemes which is locally of finite type.
Let $\mathcal{F}$ be a finite type quasi-coherent $\mathcal{O}_X$-module.
Let $x \in X$ with image $s = f(x)$ in $S$.
Set $\mathcal{F}_s = \mathcal{F}|_{X_s}$ and
$n = \dim_x(\text{Supp}(\mathcal{F}_s))$.
Then we can construct
\begin{enumerate}
\item elementary etale neighbourhoods $g : (X', x') \to (X, x)$,
$e : (S', s') \to (S, s)$,
\item a commutative diagram
$$
\xymatrix{
X' \ar[d]_g & Z' \ar[l]^i \ar[r]_\pi & Y' \ar[r]_h & S' \ar[d]^e \\
X \ar[rrr]^f & & & S
}
$$
\item a point $z' \in Z'$ with $i(z') = x'$, $y' = \pi(z')$, $h(y') = s'$,
\item a finite type quasi-coherent $\mathcal{O}_{Z'}$-module $\mathcal{G}$,
\end{enumerate}
such that the following properties hold
\begin{enumerate}
\item $X'$, $Z'$, $Y'$, $S'$ are affine schemes,
\item $i$ is a closed immersion of finite presentation,
\item $i_*(\mathcal{G}) \cong g^*\mathcal{F}$,
\item $\pi$ is finite and $\pi^{-1}(\{y'\}) = \{z'\}$,
\item $h$ is smooth of relative dimension $n$
with geometrically integral fibres.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $V \subset S$ be an affine neighbourhood of $s$.
Let $U \subset f^{-1}(V)$ be an affine neighbourhood of $x$.
Then it suffices to prove the lemma for $f|_U : U \to V$ and
$\mathcal{F}|_U$. Hence in the rest of the proof we assume that
$X$ and $S$ are affine.

\medskip\noindent
First, suppose that $X_s = \text{Supp}(\mathcal{F}_s)$, in particular
$n = \dim_x(X_s)$. Apply
More on Morphisms,
Lemmas \ref{more-morphisms-lemma-local-local-structure-finite-type} and
\ref{more-morphisms-lemma-local-local-structure-finite-type-affine}.
This gives us a commutative diagram
$$
\xymatrix{
X' \ar[d]_g \ar[r]_\pi & Y' \ar[r]_h & S' \ar[d]^e \\
X \ar[rr]^f & & S
}
$$
and point $x' \in X'$. We set $Z' = X'$, $i = \text{id}$, and
$\mathcal{G} = g^*\mathcal{F}$ to obtain a solution in this case.

\medskip\noindent
In general choose a closed immersion $Z \to X$ and a sheaf
$\mathcal{G}$ on $Z$ as in
Lemma \ref{lemma-sheaf-lives-on-subscheme}.
Applying the result of the previous paragraph to $Z \to S$ and
$\mathcal{G}$ we obtain a diagram
$$
\xymatrix{
 & Z' \ar[d]_g \ar[r]_\pi & Y' \ar[r]_h & S' \ar[d]^e \\
X & Z \ar[l] \ar[rr]^{f|_Z} & & S
}
$$
and point $z' \in Z'$ satisfying all the required properties.
Finally, as $X$, $Z$, $Z'$ are all affine we may apply
Lemma \ref{lemma-lift-etale}
to get an etale morphism of affine schemes $X' \to X$ such that 
$Z' = Z \times_X X'$. Let $x' \in X'$ be the point corresponding to
$z' \in Z'$. Then the completed diagram
$$
\xymatrix{
X' \ar[d] & Z' \ar[l]_i \ar[r]_\pi & Y' \ar[r]_h & S' \ar[d]^e \\
X \ar[rrr]^f & & & S
}
$$
is a solution of the original problem.
\end{proof}

\begin{lemma}
\label{lemma-devissage-finite-presentation}
Assumptions and notation as in
Lemma \ref{lemma-elementary-devissage}.
If $f$ is locally of finite presentation
then $\pi$ is of finite presentation.
In this case the following are equivalent
\begin{enumerate}
\item $\mathcal{F}$ is an $\mathcal{O}_X$-module of finite presentation
in a neighbourhood of $x$,
\item $\mathcal{G}$ is an $\mathcal{O}_{Z'}$-module of finite presentation
in a neighbourhood of $z'$, and
\item $\pi_*\mathcal{G}$ is an $\mathcal{O}_{Y'}$-module of
finite presentation in a neighbourhood of $y'$.
\end{enumerate}
Still assuming $f$ locally of finite presentation the following are
equivalent to each other
\begin{enumerate}
\item[(a)] $\mathcal{F}_x$ is an $\mathcal{O}_{X, x}$-module of finite
presentation,
\item[(b)] $\mathcal{G}_{z'}$ is an $\mathcal{O}_{Z', z'}$-module of
finite presentation, and
\item[(c)] $(\pi_*\mathcal{G})_{y'}$ is an $\mathcal{O}_{Y', y'}$-module
of finite presentation.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume $f$ locally of finite presentation. Then $Z' \to S$ is locally
of finite presentation as a composition of such, see
Morphisms, Lemma \ref{morphisms-lemma-composition-finite-presentation}.
Note that $Y' \to S$ is also locally of finite type as a composition
of a smooth and an etale morphism. Hence
Morphisms, Lemma \ref{morphisms-lemma-finite-presentation-permanence}
implies $\pi$ is locally of finite presentation.
Since $\pi$ is finite we conclude that it is also separated and
quasi-compact, hence $\pi$ is actually of finite presentation.

\medskip\noindent
To prove the equivalence of (1), (2), and (3) we also consider:
(4) $g^*\mathcal{F}$ is a $\mathcal{O}_{X'}$-module of finite presentation
in a neighbourhood of $x'$. The pull back of a module of finite presentation
is of finite presentation, see
Modules, Lemma \ref{modules-lemma-pullback-finite-presentation}.
Hence (1) $\Rightarrow$ (4).
The etale morphism $g$ is open, see
Morphisms, Lemma \ref{morphisms-lemma-etale-open}.
Hence for any open neighbourhood $U' \subset X'$ of $x'$, the image
$g(U')$ is an open neighbourhood of $x$ and the map
$\{U' \to g(U')\}$ is an etale covering. Thus (4) $\Rightarrow$ (1) by
Descent, Lemma \ref{descent-lemma-finite-presentation-descends}.
Using
Descent, Lemma \ref{descent-lemma-finite-finitely-presented-module}
and some easy topological arguments (see
More on Morphisms,
Lemma \ref{more-morphisms-lemma-finite-morphism-single-point-in-fibre})
we see that
(4) $\Leftrightarrow$ (2) $\Leftrightarrow$ (3).

\medskip\noindent
To prove the equivalence of (a), (b), (c) consider the ring maps
$$
\mathcal{O}_{X, x} \to
\mathcal{O}_{X', x'} \to
\mathcal{O}_{Z', z'} \leftarrow
\mathcal{O}_{Y', y'}
$$
The first ring map is faithfully flat. Hence
$\mathcal{F}_x$ is of finite presentation over $\mathcal{O}_{X, x}$
if and only if $g^*\mathcal{F}_{x'}$ is of finite presentation over
$\mathcal{O}_{X', x'}$, see
Algebra, Lemma \ref{algebra-lemma-descend-properties-modules}.
The second ring map is surjective (hence finite) and
finitely presented by assumption, hence
$g^*\mathcal{F}_{x'}$ is of finite presentation over $\mathcal{O}_{X', x'}$
if and only if $\mathcal{G}_{z'}$ is of finite presentation over
$\mathcal{O}_{Z', z'}$, see
Algebra, Lemma \ref{algebra-lemma-finite-finitely-presented-extension}.
Because $\pi$ is finite, of finite presentation, and
$\pi^{-1}(\{y'\}) = \{x'\}$ the ring homomorphism
$\mathcal{O}_{Y', y'} \leftarrow \mathcal{O}_{Z', z'}$ is finite
and of finite presentation, see
More on Morphisms,
Lemma \ref{more-morphisms-lemma-finite-morphism-single-point-in-fibre}.
Hence $\mathcal{G}_{z'}$ is of finite presentation over $\mathcal{O}_{Z', z'}$
if and only if $\pi_*\mathcal{G}_{y'}$ is of finite presentation over
$\mathcal{O}_{Y', y'}$, see
Algebra, Lemma \ref{algebra-lemma-finite-finitely-presented-extension}.
\end{proof}

\begin{lemma}
\label{lemma-etale-flat-up-down}
Let $X \to T \to S$ be morphisms of schemes with $T \to S$ etale.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
Let $x \in X$ be a point. Then
$$
\mathcal{F}\text{ flat over }S\text{ at }x
\Leftrightarrow
\mathcal{F}\text{ flat over }T\text{ at }x
$$
In particular $\mathcal{F}$ is flat over $S$ if and only if $\mathcal{F}$
is flat over $T$.
\end{lemma}

\begin{proof}
As an etale morphism is a flat morphism (see
Morphisms, Lemma \ref{morphisms-lemma-etale-flat})
the implication ``$\Leftarrow$'' follows from
Algebra, Lemma \ref{algebra-lemma-composition-flat}.
For the converse assume that $\mathcal{F}$ is flat at $x$ over $S$.
Denote $\tilde x \in X \times_S T$ the point lying over $x$ in $X$
and over the image of $x$ in $T$ in $T$.
Then $(X \times_S T \to X)^*\mathcal{F}$ is flat at $\tilde x$ over $T$
via $\text{pr}_2 : X \times_S T \to T$, see
Morphisms, Lemma \ref{morphisms-lemma-base-change-module-flat}.
The diagonal $\Delta_{T/S} : T \to T \times_S T$ is an open immersion;
combine
Morphisms, Lemmas \ref{morphisms-lemma-diagonal-unramfied-morphism} and
\ref{morphisms-lemma-etale-smooth-unramified}.
So $X$ is identified with open subscheme of $X \times_S T$,
the restriction of $\text{pr}_2$ to this open is the given morphism $X \to T$,
the point $\tilde x$ corresponds to the point $x$ in this open, and
$(X \times_S T \to X)^*\mathcal{F}$ restricted to this open is $\mathcal{F}$.
Whence we see that $\mathcal{F}$ is flat at $x$ over $T$.
\end{proof}

\begin{lemma}
\label{lemma-etale-flat-up-down-local-ring}
Let $T \to S$ be an etale morphism. Let $t \in T$ with image $s \in S$.
Let $M$ be a $\mathcal{O}_{T, t}$-module. Then
$$
M\text{ flat over }\mathcal{O}_{S, s}
\Leftrightarrow
M\text{ flat over }\mathcal{O}_{T, t}.
$$
\end{lemma}

\begin{proof}
We may replace $S$ by an affine neighbourhood of $s$ and after that
$T$ by an affine neighbourhood of $t$.
Set $\mathcal{F} = (\text{Spec}(\mathcal{O}_{T, t}) \to T)_*\widetilde M$.
This is a quasi-coherent sheaf (see
Schemes, Lemma \ref{schemes-lemma-push-forward-quasi-coherent}
or argue directly)
on $T$ whose stalk at $t$ is $M$ (details omitted).
Apply
Lemma \ref{lemma-etale-flat-up-down}.
\end{proof}

\begin{lemma}
\label{lemma-devissage-flat}
Assumptions and notation as in
Lemma \ref{lemma-elementary-devissage}.
The following are equivalent
\begin{enumerate}
\item $\mathcal{F}$ is flat over $S$ in a neighbourhood of $x$,
\item $\mathcal{G}$ is flat over $S'$ in a neighbourhood of $z'$, and
\item $\pi_*\mathcal{G}$ is flat over $S'$ in a neighbourhood of $y'$.
\end{enumerate}
The following are equivalent also
\begin{enumerate}
\item[(a)] $\mathcal{F}_x$ is flat over $\mathcal{O}_{S, s}$,
\item[(b)] $\mathcal{G}_{z'}$ is flat over $\mathcal{O}_{S', s'}$, and
\item[(c)] $(\pi_*\mathcal{G})_{y'}$ is flat over $\mathcal{O}_{S', s'}$.
\end{enumerate}
\end{lemma}

\begin{proof}
To prove the equivalence of (1), (2), and (3) we also consider:
(4) $g^*\mathcal{F}$ is flat over $S$ in a neighbourhood of $x'$.
We will use
Lemma \ref{lemma-etale-flat-up-down}
to equate flatness over $S$ and $S'$ without further mention.
The etale morphism $g$ is flat and open, see
Morphisms, Lemma \ref{morphisms-lemma-etale-open}.
Hence for any open neighbourhood $U' \subset X'$ of $x'$, the image
$g(U')$ is an open neighbourhood of $x$ and the map
$U' \to g(U')$ is surjective and flat.
Thus (4) $\Leftrightarrow$ (1) by
Morphisms, Lemma \ref{morphisms-lemma-flat-permanence}.
Note that
$$
\Gamma(X', g^*\mathcal{F}) =
\Gamma(Z', \mathcal{G}) =
\Gamma(Y', \pi_*\mathcal{G})
$$
Hence the flatness of $g^*\mathcal{F}$, $\mathcal{G}$ and $\pi_*\mathcal{G}$
over $S'$ are all equivalent (this uses that $X'$, $Z'$, $Y'$, and
$S'$ are all affine). Some omitted topological arguments (compare
More on Morphisms,
Lemma \ref{more-morphisms-lemma-finite-morphism-single-point-in-fibre})
regarding affine neighbourhoods now show that
(4) $\Leftrightarrow$ (2) $\Leftrightarrow$ (3).

\medskip\noindent
To prove the equivalence of (a), (b), (c) consider the commutative diagram
of local ring maps
$$
\xymatrix{
\mathcal{O}_{X', x'} \ar[r]_\iota &
\mathcal{O}_{Z', z'} &
\mathcal{O}_{Y', y'} \ar[l]^\alpha &
\mathcal{O}_{S', s'} \ar[l]^\beta \\
\mathcal{O}_{X, x} \ar[u]^\gamma & & &
\mathcal{O}_{S, s} \ar[lll]_\varphi \ar[u]_\epsilon
}
$$
We will use
Lemma \ref{lemma-etale-flat-up-down-local-ring}
to equate flatness over $\mathcal{O}_{S, s}$ and $\mathcal{O}_{S', s'}$
without further mention.
The map $\gamma$ is faithfully flat. Hence
$\mathcal{F}_x$ is flat over $\mathcal{O}_{S, s}$
if and only if $g^*\mathcal{F}_{x'}$ is flat over
$\mathcal{O}_{S', s'}$, see
Algebra, Lemma \ref{algebra-lemma-flatness-descends-more-general}.
As $\mathcal{O}_{S', s'}$-modules the modules
$g^*\mathcal{F}_{x'}$, $\mathcal{G}_{z'}$, and
$\pi_*\mathcal{G}_{y'}$ are all isomorphic, see
More on Morphisms,
Lemma \ref{more-morphisms-lemma-finite-morphism-single-point-in-fibre}.
This finishes the proof.
\end{proof}




\section{Auxiliary lemmas}
\label{section-auxiliary}


\begin{lemma}
\label{lemma-universally-injective-completion-direct-sum-into-product}
Let $R$ be a ring.
Let $I \subset R$ be an ideal.
Let $M$ be an $R$-module.
Assume $R$ is complete with respect to $I$, $R$ is Noetherian, and
$M$ is a finite $R$-module. Then
$$
\left(\bigoplus\nolimits_{i \in \mathbf{N}} M\right)^\wedge
\longrightarrow
\prod\nolimits_{i \in \mathbf{N}} M
$$
of the $I$-adic completion of a countable direct sum into the
countable product is universally injective.
\end{lemma}

\begin{proof}
By definition an element $x$ of the left hand side is $x = (x_n)$
where $x_n = (x_{n, 1}, x_{n, 2}, \ldots) \in
\bigoplus\nolimits_{n \in \mathbf{N}} M/I^nM$
such that $x_{n, i} = x_{n + 1, i} \bmod I^nM$. 
As $M = M^\wedge$, see
Algebra, Lemma \ref{algebra-lemma-completion-tensor}
we see that for any $i$ there exists a $y_i \in M$ such that
$x_{n, i} = y_i \bmod I^nM$. Note that for each $n$ there are only
finitely many $i$ such that the elements $x_{n, i}$ are nonzero.
Hence we can think of an element of the left hand side as an infinite ``sum''
$\sum_i y_i$ with $y_i \in M$ such that for each $n$ there are only
finitely many $y_i$ which are nonzero modulo $I^nM$. The displayed map
maps this element to the element to $(y_i)_i$ in the product.
In particular the map is injective.

\medskip\noindent
Let $Q$ be a finite $R$-module. We have to show that the map
$$
Q \otimes_R \left(\bigoplus\nolimits_{i \in \mathbf{N}} M\right)^\wedge
\longrightarrow
Q \otimes_R \left(\prod\nolimits_{i \in \mathbf{N}} M\right)
$$
is injective. Choose a presentation
$R^{\oplus k} \to R^{\oplus m} \to Q \to 0$
and denote $q_1, \ldots, q_m \in Q$ the corresponding generators for $Q$.
By Artin-Rees
(Algebra, Lemma \ref{algebra-lemma-Artin-Rees})
there exists a constant $c$ such that
$\text{Im}(R^{\oplus k} \to R^{\oplus m}) \cap (I^N)^{\oplus m}
\subset \text{Im}((I^{N - c})^{\oplus k} \to R^{\oplus m})$.
Let us contemplate the diagram
$$
\xymatrix{
\bigoplus_{l = 1}^k \left(\bigoplus\nolimits_{i \in \mathbf{N}} M\right)^\wedge
\ar[r] \ar[d] &
\bigoplus_{j = 1}^m \left(\bigoplus\nolimits_{i \in \mathbf{N}} M\right)^\wedge
\ar[r] \ar[d] &
Q \otimes_R \left(\bigoplus\nolimits_{i \in \mathbf{N}} M\right)^\wedge
\ar[r] \ar[d] &
0 \\
\bigoplus_{l = 1}^k \left(\prod\nolimits_{i \in \mathbf{N}} M\right)
\ar[r] &
\bigoplus_{j = 1}^m \left(\prod\nolimits_{i \in \mathbf{N}} M\right)
\ar[r] &
Q \otimes_R \left(\prod\nolimits_{i \in \mathbf{N}} M\right)
\ar[r] &
0
}
$$
with exact rows. Pick an element $\sum_j \sum_i y_{j, i}$ of
$\bigoplus_{j = 1, \ldots, m}
\left(\bigoplus\nolimits_{i \in \mathbf{N}} M\right)^\wedge$.
If this element maps to zero in the module
$Q \otimes_R \left(\prod\nolimits_{i \in \mathbf{N}} M\right)$,
then we see in particular that
$\sum_j q_j \otimes y_{j, i} = 0$ in $Q \otimes_R M$ for each $i$.
Thus we can find an element
$(z_{1, i}, \ldots, z_{k, i}) \in \bigoplus_{l = 1, \ldots, k} M$ which maps to
$(y_{1, i}, \ldots, y_{m, i}) \in \bigoplus_{j = 1, \ldots, m} M$.
Moreover, if $y_{j, i} \in I^{N_i}M$ for $j = 1, \ldots, m$, then
we may assume that $z_{l, i} \in I^{N_i - c}M$.
Hence we see that $\sum_l \sum_i z_{l, i}$ defines an element of
$\bigoplus_{l = 1, \ldots, k}
\left(\bigoplus\nolimits_{i \in \mathbf{N}} M\right)^\wedge$
which maps to the element $\sum_j \sum_i y_{j, i}$ we started
out with. Thus the right vertical arrow is injective and we win.
\end{proof}

\begin{lemma}
\label{lemma-separate}
Let $f : X \to S$ be a quasi-compact morphism of schemes.
Let $g : T \to S$ be a morphism of schemes.
Let $t \in T$ be a point and $Z \subset X_T$ be a closed
subscheme such that $Z \cap X_t = \emptyset$.
Then there exists an open neighbourhood
$V \subset T$ of $t$, a commutative diagram
$$
\xymatrix{
V \ar[d] \ar[r]_a & T' \ar[d]^b \\
T \ar[r]^g & S,
}
$$
and a closed subscheme $Z' \subset X_{T'}$ such that
\begin{enumerate}
\item the morphism $b : T' \to S$ is locally of finite presentation,
\item with $t' = a(t)$ we have $Z' \cap X_{t'} = \emptyset$, and
\item $Z \cap X_V$ maps into $Z'$ via the morphism $X_V \to X_{T'}$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $s = g(t)$. During the proof we may always replace $T$ by an
open neighbourhood of $t$. Hence we may also replace $S$ by an open
neighbourhood of $s$. Thus we may and do assume that $T$ and $S$ are affine.
Say $S = \text{Spec}(A)$, $T = \text{Spec}(B)$, $g$ is given by the
ring map $A \to B$, and $t$ correspond to the prime ideal
$\mathfrak q \subset B$.

\medskip\noindent
As $X \to S$ is quasi-compact and $S$ is affine we may write
$X = \bigcup_{i = 1, \ldots, n} U_i$ as a finite union of affine opens.
Write $U_i = \text{Spec}(C_i)$. In particular we have
$X_T = \bigcup_{i = 1, \ldots, n} U_{i, T} =
\bigcup_{i = 1, \ldots n} \text{Spec}(C_i \otimes_A B)$.
Let $I_i \subset C_i \otimes_A B$ be the ideal corresponding to the
closed subscheme $Z \cap U_{i, T}$. The condition that
$Z \cap X_t = \emptyset$ signifies that $I_i$ generates the
unit ideal in the ring
$$
C_i \otimes_A \kappa(\mathfrak q) =
(B \setminus \mathfrak q)^{-1}\left(
C_i \otimes_A B/\mathfrak q C_i \otimes_A B \right)
$$
Since $I_i (B \setminus \mathfrak q)^{-1}(C_i \otimes_A B) =
(B \setminus \mathfrak q)^{-1} I_i$ this means that $1 = x_i/g_i$
for some $x_i \in I_i$ and $g_i \in B$, $g_i \not \in \mathfrak q$.
Thus, clearing denominators we can find a relation of the form
$$
x_i + \sum\nolimits_j f_{i, j}c_{i, j} = g_i
$$
with $x_i \in I_i$, $f_{i, j} \in \mathfrak q$, $c_{i, j} \in C_i \otimes_A B$,
and $g_i \in B$, $g_i \not \in \mathfrak q$. After replacing $B$ by
$B_{g_1 \ldots g_n}$, i.e., after replacing $T$ by a smaller affine
neighbourhood of $t$, we may assume the equations read
$$
x_i + \sum\nolimits_j f_{i, j}c_{i, j} = 1
$$
with $x_i \in I_i$, $f_{i, j} \in \mathfrak q$, $c_{i, j} \in C_i \otimes_A B$.

\medskip\noindent
To finish the argument write $B$ as a colimit of finitely presented
$A$-algebras $B_\lambda$ over a directed partially ordered set $\Lambda$.
For each $\lambda$ set
$\mathfrak q_\lambda = (B_\lambda \to B)^{-1}(\mathfrak q)$.
For sufficiently large $\lambda \in \Lambda$ we can find
\begin{enumerate}
\item an element
$x_{i, \lambda} \in C_i \otimes_A B_\lambda$ which maps to $x_i$,
\item elements $f_{i, j, \lambda} \in \mathfrak q_{i, \lambda}$
mapping to $f_{i, j}$, and
\item elements $c_{i, j, \lambda} \in C_i \otimes_A B_\lambda$
mapping to $c_{i, j}$.
\end{enumerate}
After increasing $\lambda$ a bit more the equation
$$
x_{i, \lambda} + \sum\nolimits_j f_{i, j, \lambda}c_{i, j, \lambda} = 1
$$
will hold. Fix such a $\lambda$ and set $T' = \text{Spec}(B_\lambda)$.
Then $t' \in T'$ is the point corresponding to the prime $\mathfrak q_\lambda$.
Finally, let $Z' \subset X_{T'}$ be the scheme theoretic closure of
$Z \to X_T \to X_{T'}$. As $X_T \to X_{T'}$ is affine, we can compute $Z'$
on the affine open pieces $U_{i, T'}$ as the closed subscheme associated
to $\text{Ker}(C_i \otimes_A B_\lambda \to C_i \otimes_A B/I_i)$, see
Morphisms, Example \ref{morphisms-example-scheme-theoretic-image}.
Hence $x_{i, \lambda}$ is in the ideal defining $Z'$. Thus the last
displayed equation shows that $Z' \cap X_{t'}$ is empty.
\end{proof}







\section{Flattening stratification}
\label{section-flattening}

\noindent
If $f : X \to S$ is a proper, finitely presented morphism
of schemes then one can find a stratification of the base
over whose members the morphism $f$ is flat. It is not so hard
to find this stratification, but what is a bit tricky is to prove
that this stratification is characterized by a universal property.
In this section we discuss this and some of its variants.

\medskip\noindent
The first case is where the base is the spectrum of a complete
local Noetherian ring. In this case the closed stratum is defined
and satisfies the desired universal property even for a general
finite type morphism, provided we {\it only} look for flatness in
points lying over the closed point.

\begin{lemma}
\label{lemma-flattening-complete-noetherian}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{F}$ be a quasi-coherent sheaf on $X$.
Assume
\begin{enumerate}
\item $S = \text{Spec}(A)$ is the spectrum of a Noetherian complete
local ring $A$,
\item $f$ is of finite type, and
\item $\mathcal{F}$ is a finite type $\mathcal{O}_X$-module.
\end{enumerate}
Then there exists a closed subscheme $Z \subset S$ with the following
universal property: Given a morphism $S' \to S$ which corresponds to
a local homomorphism $A' \to A$ of local rings the following
are equivalent
\begin{enumerate}
\item[(a)] the pullback $\mathcal{F}'$ of $\mathcal{F}$ to
$X' = S' \times_S X$ is flat over $S'$ at all points $x' \in X'$
lying over the closed point of $S'$, and
\item[(b)] $S' \to S$ factors through $Z$.
\end{enumerate}
In particular, $Z$ is the largest closed subscheme of $S$ such that
$\mathcal{F}|_{X_Z}$ is flat over $Z$ at all points
of $X_Z$ lying over the closed point of $Z$.
\end{lemma}

\begin{proof}
As $f$ is of finite type it is quasi-compact. Hence $X$ is quasi-compact.
Choose a finite affine open covering $X = \bigcup X_i$.
Write $X_i = \text{Spec}(B_i)$ so that $A \to B_i$ is a finite type
ring map. Note that $\mathcal{F}|_{X_i}$ corresponds to a finite
$B_i$-module $M_i$. Set $Y = \coprod X_i = \text{Spec}(\prod B_i)$
and $\mathcal{G} = \widetilde{\prod M_i}$ on $Y$.
Now if $S' \to S$ is a morphism as in the lemma, then (a) holds
for $\mathcal{F}'$ relative to $X' \to S'$ if and only if (a) holds for
$\mathcal{G}'$ relative to $Y' \to S'$. Hence this
reduces us to the case where $X$ is affine.
In this case $Z$ exists by
Algebra,
Lemma \ref{algebra-lemma-flattening-complete-local-universal-property}.
(Hint: We strongly suggest the reader only read the construction of
$Z = \text{Spec}(A/I)$ in
Algebra, Lemma \ref{algebra-lemma-flattening-complete-local-noetherian}.)
\end{proof}





\input{chapters}


\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}
