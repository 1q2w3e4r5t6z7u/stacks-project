\input{preamble}

% OK, start here.
%
\begin{document}

\title{More on flatness}

\maketitle

\phantomsection
\label{section-phantom}

\tableofcontents



\section{Introduction}
\label{section-introduction}

\noindent
In this chapter, we discuss some advanced results on flat modules and
flat morphisms of schemes. Most of these results can be
found in the paper \cite{GruRay} by Raynaud and Gruson.

\medskip\noindent
Before reading this chapter we advise the reader to take a look
at the following results (this list also serves as a pointer to
previous results):
\begin{enumerate}
\item General discussion on flat modules in
Algebra, Section \ref{algebra-section-flat}.
\item The relationship between $\text{Tor}$-groups and flatness, see
Algebra, Section \ref{algebra-section-tor}.
\item The sections on flatness criteria, namely,
Algebra, Section \ref{algebra-section-criteria-flatness}
(Noetherian case),
Algebra, Section \ref{algebra-section-flatness-artinian}
(Artinian case),
Algebra, Section \ref{algebra-section-more-flatness-criteria}
(non-Noetherian case), and finally
More on Morphisms, Section \ref{more-morphisms-section-criterion-flat-fibres}.
\item Generic flatness, see
Algebra, Section \ref{algebra-section-generic-flatness}
and
Morphisms, Section \ref{morphisms-section-generic-flatness}.
\item Openness of the flat locus, see
Algebra, Section \ref{algebra-section-open-flat}
and
More on Morphisms, Section \ref{more-morphisms-section-open-flat}.
\item Flattening stratification, see
Algebra, Section \ref{algebra-section-flattening}.
\item Additional algebraic in
Algebra, Sections \ref{algebra-section-descent-flatness-integral},
\ref{algebra-section-torsion-flat},
\ref{algebra-section-flat-finite}, and
\ref{algebra-section-blowup-flat}.
\end{enumerate}








\section{The local structure of a finite type module}
\label{section-local-structure-module}

\noindent
The key technical lemma that makes a lot of the arguments in this
chapter work is the geometric
Lemma \ref{lemma-elementary-devissage}.

\begin{lemma}
\label{lemma-sheaf-lives-on-subscheme}
Let $f : X \to S$ be a finite type morphism of affine schemes.
Let $\mathcal{F}$ be a finite type quasi-coherent $\mathcal{O}_X$-module.
Let $x \in X$ with image $s = f(x)$ in $S$.
Set $\mathcal{F}_s = \mathcal{F}|_{X_s}$.
Then there exist a closed immersion $i : Z \to X$ of finite presentation,
and a quasi-coherent finite type $\mathcal{O}_Z$-module $\mathcal{G}$
such that $i_*\mathcal{G} = \mathcal{F}$ and
$Z_s = \text{Supp}(\mathcal{F}_s)$.
\end{lemma}

\begin{proof}
Say the morphism $f : X \to S$ is given by the ring map
$A \to B$ and that $\mathcal{F}$ is the quasi-coherent sheaf
associated to the $B$-module $M$. By
Morphisms, Lemma \ref{morphisms-lemma-locally-finite-type-characterize}
we know that $A \to B$ is a finite type ring map, and by
Properties, Lemma \ref{properties-lemma-finite-type-module}
we know that $M$ is a finite $B$-module. In particular the
support of $\mathcal{F}$ is the closed subscheme of $\text{Spec}(B)$
cut out by the annihilator
$I = \{x \in B \mid xm = 0\ \forall m \in M\}$ of $M$, see
Algebra, Lemma \ref{algebra-lemma-support-closed}.
Let $\mathfrak q \subset B$ be the prime ideal corresponding to $x$
and let $\mathfrak p \subset A$ be the prime ideal corresponding to $s$.
Note that $X_s = \text{Spec}(B \otimes_A \kappa(\mathfrak p))$ and
that $\mathcal{F}_s$ is the quasi-coherent sheaf associated to the
$B \otimes_A \kappa(\mathfrak p)$ module $M \otimes_A \kappa(\mathfrak p)$. By
Divisors, Lemma \ref{divisors-lemma-support-finite-type}
the support of $\mathcal{F}_s$ is equal to
$V(I(B \otimes_A \kappa(\mathfrak p)))$. Since
$B \otimes_A \kappa(\mathfrak p)$ is of finite type over $\kappa(\mathfrak p)$
there exist finitely many elements $f_1, \ldots, f_m \in I$
such that
$$
I(B \otimes_A \kappa(\mathfrak p)) =
(f_1, \ldots, f_n)(B \otimes_A \kappa(\mathfrak p)).
$$
Denote $i : Z \to X$ the closed subscheme cut out by
$(f_1, \ldots, f_m)$, in a formula $Z = \text{Spec}(B/(f_1, \ldots, f_m))$.
Since $M$ is annihilated by $I$ we can think of $M$ as an
$B/(f_1, \ldots, f_m)$-module. In other words, $\mathcal{F}$ is the
pushforward of a finite type module on $Z$.
As $Z_s = \text{Supp}(\mathcal{F}_s)$ by construction, this
proves the lemma.
\end{proof}

\begin{lemma}
\label{lemma-lift-etale}
Let $i : Z \to X$ be a closed immersion of affine schemes.
Let $Z' \to Z$ be an \'etale morphism with $Z'$ affine.
Then there exists an \'etale morphism $X' \to X$ with $X'$
affine such that $Z' \cong Z \times_X X'$ as schemes over $Z$.
\end{lemma}

\begin{proof}
See
Algebra, Lemma \ref{algebra-lemma-lift-etale}.
\end{proof}

\begin{lemma}
\label{lemma-elementary-devissage}
Let $f : X \to S$ be morphism of schemes which is locally of finite type.
Let $\mathcal{F}$ be a finite type quasi-coherent $\mathcal{O}_X$-module.
Let $x \in X$ with image $s = f(x)$ in $S$.
Set $\mathcal{F}_s = \mathcal{F}|_{X_s}$ and
$n = \dim_x(\text{Supp}(\mathcal{F}_s))$.
Then we can construct
\begin{enumerate}
\item elementary \'etale neighbourhoods $g : (X', x') \to (X, x)$,
$e : (S', s') \to (S, s)$,
\item a commutative diagram
$$
\xymatrix{
X' \ar[d]_g & Z' \ar[l]^i \ar[r]_\pi & Y' \ar[r]_h & S' \ar[d]^e \\
X \ar[rrr]^f & & & S
}
$$
\item a point $z' \in Z'$ with $i(z') = x'$, $y' = \pi(z')$, $h(y') = s'$,
\item a finite type quasi-coherent $\mathcal{O}_{Z'}$-module $\mathcal{G}$,
\end{enumerate}
such that the following properties hold
\begin{enumerate}
\item $X'$, $Z'$, $Y'$, $S'$ are affine schemes,
\item $i$ is a closed immersion of finite presentation,
\item $i_*(\mathcal{G}) \cong g^*\mathcal{F}$,
\item $\pi$ is finite and $\pi^{-1}(\{y'\}) = \{z'\}$,
\item $h$ is smooth of relative dimension $n$
with geometrically integral fibres.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $V \subset S$ be an affine neighbourhood of $s$.
Let $U \subset f^{-1}(V)$ be an affine neighbourhood of $x$.
Then it suffices to prove the lemma for $f|_U : U \to V$ and
$\mathcal{F}|_U$. Hence in the rest of the proof we assume that
$X$ and $S$ are affine.

\medskip\noindent
First, suppose that $X_s = \text{Supp}(\mathcal{F}_s)$, in particular
$n = \dim_x(X_s)$. Apply
More on Morphisms,
Lemmas \ref{more-morphisms-lemma-local-local-structure-finite-type} and
\ref{more-morphisms-lemma-local-local-structure-finite-type-affine}.
This gives us a commutative diagram
$$
\xymatrix{
X' \ar[d]_g \ar[r]_\pi & Y' \ar[r]_h & S' \ar[d]^e \\
X \ar[rr]^f & & S
}
$$
and point $x' \in X'$. We set $Z' = X'$, $i = \text{id}$, and
$\mathcal{G} = g^*\mathcal{F}$ to obtain a solution in this case.

\medskip\noindent
In general choose a closed immersion $Z \to X$ and a sheaf
$\mathcal{G}$ on $Z$ as in
Lemma \ref{lemma-sheaf-lives-on-subscheme}.
Applying the result of the previous paragraph to $Z \to S$ and
$\mathcal{G}$ we obtain a diagram
$$
\xymatrix{
 & Z' \ar[d]_g \ar[r]_\pi & Y' \ar[r]_h & S' \ar[d]^e \\
X & Z \ar[l] \ar[rr]^{f|_Z} & & S
}
$$
and point $z' \in Z'$ satisfying all the required properties.
Finally, as $X$, $Z$, $Z'$ are all affine we may apply
Lemma \ref{lemma-lift-etale}
to get an \'etale morphism of affine schemes $X' \to X$ such that 
$Z' = Z \times_X X'$. Let $x' \in X'$ be the point corresponding to
$z' \in Z'$. Then the completed diagram
$$
\xymatrix{
X' \ar[d] & Z' \ar[l]_i \ar[r]_\pi & Y' \ar[r]_h & S' \ar[d]^e \\
X \ar[rrr]^f & & & S
}
$$
is a solution of the original problem.
\end{proof}

\begin{lemma}
\label{lemma-devissage-finite-presentation}
Assumptions and notation as in
Lemma \ref{lemma-elementary-devissage}.
If $f$ is locally of finite presentation
then $\pi$ is of finite presentation.
In this case the following are equivalent
\begin{enumerate}
\item $\mathcal{F}$ is an $\mathcal{O}_X$-module of finite presentation
in a neighbourhood of $x$,
\item $\mathcal{G}$ is an $\mathcal{O}_{Z'}$-module of finite presentation
in a neighbourhood of $z'$, and
\item $\pi_*\mathcal{G}$ is an $\mathcal{O}_{Y'}$-module of
finite presentation in a neighbourhood of $y'$.
\end{enumerate}
Still assuming $f$ locally of finite presentation the following are
equivalent to each other
\begin{enumerate}
\item[(a)] $\mathcal{F}_x$ is an $\mathcal{O}_{X, x}$-module of finite
presentation,
\item[(b)] $\mathcal{G}_{z'}$ is an $\mathcal{O}_{Z', z'}$-module of
finite presentation, and
\item[(c)] $(\pi_*\mathcal{G})_{y'}$ is an $\mathcal{O}_{Y', y'}$-module
of finite presentation.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume $f$ locally of finite presentation. Then $Z' \to S$ is locally
of finite presentation as a composition of such, see
Morphisms, Lemma \ref{morphisms-lemma-composition-finite-presentation}.
Note that $Y' \to S$ is also locally of finite type as a composition
of a smooth and an \'etale morphism. Hence
Morphisms, Lemma \ref{morphisms-lemma-finite-presentation-permanence}
implies $\pi$ is locally of finite presentation.
Since $\pi$ is finite we conclude that it is also separated and
quasi-compact, hence $\pi$ is actually of finite presentation.

\medskip\noindent
To prove the equivalence of (1), (2), and (3) we also consider:
(4) $g^*\mathcal{F}$ is a $\mathcal{O}_{X'}$-module of finite presentation
in a neighbourhood of $x'$. The pull back of a module of finite presentation
is of finite presentation, see
Modules, Lemma \ref{modules-lemma-pullback-finite-presentation}.
Hence (1) $\Rightarrow$ (4).
The \'etale morphism $g$ is open, see
Morphisms, Lemma \ref{morphisms-lemma-etale-open}.
Hence for any open neighbourhood $U' \subset X'$ of $x'$, the image
$g(U')$ is an open neighbourhood of $x$ and the map
$\{U' \to g(U')\}$ is an \'etale covering. Thus (4) $\Rightarrow$ (1) by
Descent, Lemma \ref{descent-lemma-finite-presentation-descends}.
Using
Descent, Lemma \ref{descent-lemma-finite-finitely-presented-module}
and some easy topological arguments (see
More on Morphisms,
Lemma \ref{more-morphisms-lemma-finite-morphism-single-point-in-fibre})
we see that
(4) $\Leftrightarrow$ (2) $\Leftrightarrow$ (3).

\medskip\noindent
To prove the equivalence of (a), (b), (c) consider the ring maps
$$
\mathcal{O}_{X, x} \to
\mathcal{O}_{X', x'} \to
\mathcal{O}_{Z', z'} \leftarrow
\mathcal{O}_{Y', y'}
$$
The first ring map is faithfully flat. Hence
$\mathcal{F}_x$ is of finite presentation over $\mathcal{O}_{X, x}$
if and only if $g^*\mathcal{F}_{x'}$ is of finite presentation over
$\mathcal{O}_{X', x'}$, see
Algebra, Lemma \ref{algebra-lemma-descend-properties-modules}.
The second ring map is surjective (hence finite) and
finitely presented by assumption, hence
$g^*\mathcal{F}_{x'}$ is of finite presentation over $\mathcal{O}_{X', x'}$
if and only if $\mathcal{G}_{z'}$ is of finite presentation over
$\mathcal{O}_{Z', z'}$, see
Algebra, Lemma \ref{algebra-lemma-finite-finitely-presented-extension}.
Because $\pi$ is finite, of finite presentation, and
$\pi^{-1}(\{y'\}) = \{x'\}$ the ring homomorphism
$\mathcal{O}_{Y', y'} \leftarrow \mathcal{O}_{Z', z'}$ is finite
and of finite presentation, see
More on Morphisms,
Lemma \ref{more-morphisms-lemma-finite-morphism-single-point-in-fibre}.
Hence $\mathcal{G}_{z'}$ is of finite presentation over $\mathcal{O}_{Z', z'}$
if and only if $\pi_*\mathcal{G}_{y'}$ is of finite presentation over
$\mathcal{O}_{Y', y'}$, see
Algebra, Lemma \ref{algebra-lemma-finite-finitely-presented-extension}.
\end{proof}

\begin{lemma}
\label{lemma-etale-flat-up-down}
Let $X \to T \to S$ be morphisms of schemes with $T \to S$ \'etale.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
Let $x \in X$ be a point. Then
$$
\mathcal{F}\text{ flat over }S\text{ at }x
\Leftrightarrow
\mathcal{F}\text{ flat over }T\text{ at }x
$$
In particular $\mathcal{F}$ is flat over $S$ if and only if $\mathcal{F}$
is flat over $T$.
\end{lemma}

\begin{proof}
As an \'etale morphism is a flat morphism (see
Morphisms, Lemma \ref{morphisms-lemma-etale-flat})
the implication ``$\Leftarrow$'' follows from
Algebra, Lemma \ref{algebra-lemma-composition-flat}.
For the converse assume that $\mathcal{F}$ is flat at $x$ over $S$.
Denote $\tilde x \in X \times_S T$ the point lying over $x$ in $X$
and over the image of $x$ in $T$ in $T$.
Then $(X \times_S T \to X)^*\mathcal{F}$ is flat at $\tilde x$ over $T$
via $\text{pr}_2 : X \times_S T \to T$, see
Morphisms, Lemma \ref{morphisms-lemma-base-change-module-flat}.
The diagonal $\Delta_{T/S} : T \to T \times_S T$ is an open immersion;
combine
Morphisms, Lemmas \ref{morphisms-lemma-diagonal-unramfied-morphism} and
\ref{morphisms-lemma-etale-smooth-unramified}.
So $X$ is identified with open subscheme of $X \times_S T$,
the restriction of $\text{pr}_2$ to this open is the given morphism $X \to T$,
the point $\tilde x$ corresponds to the point $x$ in this open, and
$(X \times_S T \to X)^*\mathcal{F}$ restricted to this open is $\mathcal{F}$.
Whence we see that $\mathcal{F}$ is flat at $x$ over $T$.
\end{proof}

\begin{lemma}
\label{lemma-etale-flat-up-down-local-ring}
Let $T \to S$ be an \'etale morphism. Let $t \in T$ with image $s \in S$.
Let $M$ be a $\mathcal{O}_{T, t}$-module. Then
$$
M\text{ flat over }\mathcal{O}_{S, s}
\Leftrightarrow
M\text{ flat over }\mathcal{O}_{T, t}.
$$
\end{lemma}

\begin{proof}
We may replace $S$ by an affine neighbourhood of $s$ and after that
$T$ by an affine neighbourhood of $t$.
Set $\mathcal{F} = (\text{Spec}(\mathcal{O}_{T, t}) \to T)_*\widetilde M$.
This is a quasi-coherent sheaf (see
Schemes, Lemma \ref{schemes-lemma-push-forward-quasi-coherent}
or argue directly)
on $T$ whose stalk at $t$ is $M$ (details omitted).
Apply
Lemma \ref{lemma-etale-flat-up-down}.
\end{proof}

\begin{lemma}
\label{lemma-devissage-flat}
Assumptions and notation as in
Lemma \ref{lemma-elementary-devissage}.
The following are equivalent
\begin{enumerate}
\item $\mathcal{F}$ is flat over $S$ in a neighbourhood of $x$,
\item $\mathcal{G}$ is flat over $S'$ in a neighbourhood of $z'$, and
\item $\pi_*\mathcal{G}$ is flat over $S'$ in a neighbourhood of $y'$.
\end{enumerate}
The following are equivalent also
\begin{enumerate}
\item[(a)] $\mathcal{F}_x$ is flat over $\mathcal{O}_{S, s}$,
\item[(b)] $\mathcal{G}_{z'}$ is flat over $\mathcal{O}_{S', s'}$, and
\item[(c)] $(\pi_*\mathcal{G})_{y'}$ is flat over $\mathcal{O}_{S', s'}$.
\end{enumerate}
\end{lemma}

\begin{proof}
To prove the equivalence of (1), (2), and (3) we also consider:
(4) $g^*\mathcal{F}$ is flat over $S$ in a neighbourhood of $x'$.
We will use
Lemma \ref{lemma-etale-flat-up-down}
to equate flatness over $S$ and $S'$ without further mention.
The \'etale morphism $g$ is flat and open, see
Morphisms, Lemma \ref{morphisms-lemma-etale-open}.
Hence for any open neighbourhood $U' \subset X'$ of $x'$, the image
$g(U')$ is an open neighbourhood of $x$ and the map
$U' \to g(U')$ is surjective and flat.
Thus (4) $\Leftrightarrow$ (1) by
Morphisms, Lemma \ref{morphisms-lemma-flat-permanence}.
Note that
$$
\Gamma(X', g^*\mathcal{F}) =
\Gamma(Z', \mathcal{G}) =
\Gamma(Y', \pi_*\mathcal{G})
$$
Hence the flatness of $g^*\mathcal{F}$, $\mathcal{G}$ and $\pi_*\mathcal{G}$
over $S'$ are all equivalent (this uses that $X'$, $Z'$, $Y'$, and
$S'$ are all affine). Some omitted topological arguments (compare
More on Morphisms,
Lemma \ref{more-morphisms-lemma-finite-morphism-single-point-in-fibre})
regarding affine neighbourhoods now show that
(4) $\Leftrightarrow$ (2) $\Leftrightarrow$ (3).

\medskip\noindent
To prove the equivalence of (a), (b), (c) consider the commutative diagram
of local ring maps
$$
\xymatrix{
\mathcal{O}_{X', x'} \ar[r]_\iota &
\mathcal{O}_{Z', z'} &
\mathcal{O}_{Y', y'} \ar[l]^\alpha &
\mathcal{O}_{S', s'} \ar[l]^\beta \\
\mathcal{O}_{X, x} \ar[u]^\gamma & & &
\mathcal{O}_{S, s} \ar[lll]_\varphi \ar[u]_\epsilon
}
$$
We will use
Lemma \ref{lemma-etale-flat-up-down-local-ring}
to equate flatness over $\mathcal{O}_{S, s}$ and $\mathcal{O}_{S', s'}$
without further mention.
The map $\gamma$ is faithfully flat. Hence
$\mathcal{F}_x$ is flat over $\mathcal{O}_{S, s}$
if and only if $g^*\mathcal{F}_{x'}$ is flat over
$\mathcal{O}_{S', s'}$, see
Algebra, Lemma \ref{algebra-lemma-flatness-descends-more-general}.
As $\mathcal{O}_{S', s'}$-modules the modules
$g^*\mathcal{F}_{x'}$, $\mathcal{G}_{z'}$, and
$\pi_*\mathcal{G}_{y'}$ are all isomorphic, see
More on Morphisms,
Lemma \ref{more-morphisms-lemma-finite-morphism-single-point-in-fibre}.
This finishes the proof.
\end{proof}





\section{Localization and universally injective maps}
\label{section-localize-universally-injective}


\begin{lemma}
\label{lemma-homothety-spectrum}
Let $R \to S$ be a local homomorphism of local rings.
Let $M$ be a $S$-module.
Write $\overline{S} = S/\mathfrak m_R S$ and
$\overline{M} = M/\mathfrak m_R M$.
Let $\Sigma \subset S$ be the multiplicative subset of elements which are not
a zero divisor on $\overline{M}$.
If $\overline{S}$ is Noetherian and $\overline{M}$ is finite
over $\overline{S}$, then $\Sigma^{-1}S$ is a semi-local ring whose
spectrum corresponds to those $\mathfrak q \subset S$ whose image in
$\overline{S}$ are contained in an element of
$\text{Ass}_{\overline{S}}(\overline{M})$. Moreover, the maximal
ideals of $\Sigma^{-1}S$ correspond to associated primes of
$\overline{M}$ over $\overline{S}$.
\end{lemma}

\begin{proof}
Say $\{\mathfrak q_1, \ldots, \mathfrak q_r\}$ is the set of primes
of $S$ which correspond to the elements of the finite set
$\text{Ass}_{\overline{S}}(\overline{M})$ (finite by
Algebra, Lemma \ref{algebra-lemma-finite-ass}).
By
Algebra, Lemma \ref{algebra-lemma-ass-zero-divisors}
we have $\Sigma = S \setminus (\bigcup \mathfrak q_i)$.
Thus the maximal ideals of $\Sigma^{-1}S$ correspond one-to-one with the
maximal (w.r.t.\ inclusion) elements of the set
$\{\mathfrak q_1, \ldots, \mathfrak q_r\}$. Hence the lemma follows.
\end{proof}

\begin{lemma}
\label{lemma-homothety-universally-injective}
With assumptions and notation as in
Lemma \ref{lemma-homothety-spectrum}.
Assume moreover that
\begin{enumerate}
\item $S$ is essentially of finite presentation over $R$,
\item $M$ is finitely presented over $S$, and
\item $M$ is flat over $R$.
\end{enumerate}
Then each $s \in \Sigma$ defines a
universally injective $R$-module map $s : M \to M$, and the
map $M \to \Sigma^{-1}M$ is $R$-universally injective.
\end{lemma}

\begin{proof}
By
Algebra, Lemma \ref{algebra-lemma-mod-injective-general}.
the sequence $0 \to M \to M \to M/sM \to 0$ is exact and
$M/sM$ is flat over $R$. This implies that $s : M \to M$
is universally injective, see
Algebra, Lemma \ref{algebra-lemma-flat-tor-zero}.
The map $M \to \Sigma^{-1}M$ is universally injective as the directed
colimit of the maps $s : M \to M$.
\end{proof}

\begin{lemma}
\label{lemma-base-change-universally-flat-local}
Let $R \to S$ be a ring map.
Let $M$ be an $S$-module.
Let $S \to S'$ be a ring map.
Assume
\begin{enumerate}
\item $R \to S$ is a local homomorphism of local rings
\item $S$ is essentially of finite presentation over $R$,
\item $M$ is of finite presentation over $S$,
\item $M$ is flat over $R$,
\item $S \to S'$ is flat, and
\item the image of $\text{Spec}(S') \to \text{Spec}(S)$ contains
all primes $\mathfrak q$ of $S$ lying over $\mathfrak m_R$
such that $\mathfrak q$ is an associated prime of $M/\mathfrak m_R M$.
\end{enumerate}
Then $M \to M \otimes_R S'$ is $R$-universally injective.
\end{lemma}

\begin{proof}
Set $M' = M \otimes_R S'$. Consider the commutative diagram
$$
\xymatrix{
M \ar[d] \ar[r] & M' \ar[d] \\
\Sigma^{-1}M \ar[r] & \Sigma^{-1}M'
}
$$
where $\Sigma \subset S$ is the set of elements which are not a
zero divisor on $M/\mathfrak m_R M$. If we can show that the map
$M \to \Sigma^{-1}M'$ is universally injective, then $M \to M'$
is too (see
Algebra, Lemma \ref{algebra-lemma-universally-injective-permanence}).

\medskip\noindent
By
Lemma \ref{lemma-homothety-spectrum}
the ring $\Sigma^{-1}S$ is a semi-local ring whose maximal ideals
correspond to associated primes of $M/\mathfrak m_R M$.
Hence the image of
$\text{Spec}(\Sigma^{-1}S') \to \text{Spec}(\Sigma^{-1}S)$
contains all these maximal ideals by assumption. By
Algebra, Lemma \ref{algebra-lemma-ff-rings}
the ring map $\Sigma^{-1}S \to \Sigma^{-1}S'$ is faithfully flat.
Hence $\Sigma^{-1}M \to \Sigma^{-1}M'$, which is the map
$$
M \otimes_S \Sigma^{-1}S \longrightarrow M \otimes_S \Sigma^{-1}S'
$$
is universally injective, see
Algebra, Lemmas \ref{algebra-lemma-faithfully-flat-universally-injective} and
\ref{algebra-lemma-universally-injective-tensor}.
Finally, we apply
Lemma \ref{lemma-homothety-universally-injective}
to see that $M \to \Sigma^{-1}M$ is universally injective.
As the composition of universally injective module maps is universally
injective (see
Algebra, Lemma \ref{algebra-lemma-composition-universally-injective})
we conclude that $M \to \Sigma^{-1}M'$ is universally injective and we win.
\end{proof}

\begin{lemma}
\label{lemma-base-change-universally-flat}
Let $R \to S$ be a ring map.
Let $M$ be an $S$-module.
Let $S \to S'$ be a ring map.
Assume
\begin{enumerate}
\item $R \to S$ is of finite presentation and $M$ is of finite presentation
over $S$,
\item $M$ is flat over $R$,
\item $S \to S'$ is flat, and
\item the image of $\text{Spec}(S') \to \text{Spec}(S)$ contains
all primes $\mathfrak q$ such that $\mathfrak q$ is an associated prime
of $M \otimes_R \kappa(\mathfrak p)$ where $\mathfrak p$ is the inverse
image of $\mathfrak q$ in $R$.
\end{enumerate}
Then $M \to M \otimes_R S'$ is $R$-universally injective.
\end{lemma}

\begin{proof}
By
Algebra, Lemma \ref{algebra-lemma-universally-injective-check-stalks}
it suffices to show that $M_{\mathfrak q} \to (M \otimes_R S')_{\mathfrak q}$
is a $R_{\mathfrak p}$-universally injective for any prime $\mathfrak q$
of $S$ lying over $\mathfrak p$ in $R$. Thus we may apply
Lemma \ref{lemma-base-change-universally-flat-local}
to the ring maps
$R_{\mathfrak p} \to S_{\mathfrak q} \to S'_{\mathfrak q}$
and the module $M_{\mathfrak q}$.
\end{proof}




\section{Completion and Mittag-Leffler modules}
\label{section-completion-ML}

\begin{lemma}
\label{lemma-universally-injective-completion-direct-sum-into-product}
Let $R$ be a ring.
Let $I \subset R$ be an ideal.
Let $A$ be a set.
Assume $R$ is Noetherian and complete with respect to $I$. Then
$$
\left(\bigoplus\nolimits_{\alpha \in A} R\right)^\wedge
\longrightarrow
\prod\nolimits_{\alpha \in A} R
$$
of the $I$-adic completion of the direct sum into the
direct product is universally injective.
\end{lemma}

\begin{proof}
By definition an element $x$ of the left hand side is $x = (x_n)$ where
$x_n = (x_{n, \alpha}) \in \bigoplus\nolimits_{\alpha \in A} R/I^n$
such that $x_{n, \alpha} = x_{n + 1, \alpha} \bmod I^n$. 
As $R = R^\wedge$ we see that for any $\alpha$ there exists a $y_\alpha \in R$
such that $x_{n, \alpha} = y_\alpha \bmod I^n$. Note that for each $n$ there
are only finitely many $\alpha$ such that the elements $x_{n, \alpha}$ are
nonzero. Conversely, given $(y_\alpha) \in \prod_\alpha R$ sych that for each
$n$ there are only finitely many $\alpha$ such that $y_{\alpha} \bmod I^n$
is nonzero, then this defines an element of the left hand side.
Hence we can think of an element of the left hand side as infinite
``convergent sums'' $\sum_\alpha y_\alpha$ with $y_\alpha \in R$
such that for each $n$ there are only finitely many $y_\alpha$
which are nonzero modulo $I^n$. The displayed map maps this element
to the element to $(y_\alpha)$ in the product.
In particular the map is injective.

\medskip\noindent
Let $Q$ be a finite $R$-module. We have to show that the map
$$
Q \otimes_R \left(\bigoplus\nolimits_{\alpha \in A} R\right)^\wedge
\longrightarrow
Q \otimes_R \left(\prod\nolimits_{\alpha \in A} R\right)
$$
is injective, see
Algebra, Theorem \ref{algebra-theorem-universally-exact-criteria}.
Choose a presentation $R^{\oplus k} \to R^{\oplus m} \to Q \to 0$
and denote $q_1, \ldots, q_m \in Q$ the corresponding generators for $Q$.
By Artin-Rees
(Algebra, Lemma \ref{algebra-lemma-Artin-Rees})
there exists a constant $c$ such that
$\text{Im}(R^{\oplus k} \to R^{\oplus m}) \cap (I^N)^{\oplus m}
\subset \text{Im}((I^{N - c})^{\oplus k} \to R^{\oplus m})$.
Let us contemplate the diagram
$$
\xymatrix{
\bigoplus_{l = 1}^k \left(\bigoplus\nolimits_{\alpha \in A} R\right)^\wedge
\ar[r] \ar[d] &
\bigoplus_{j = 1}^m \left(\bigoplus\nolimits_{\alpha \in A} R\right)^\wedge
\ar[r] \ar[d] &
Q \otimes_R \left(\bigoplus\nolimits_{\alpha \in A} R\right)^\wedge
\ar[r] \ar[d] &
0 \\
\bigoplus_{l = 1}^k \left(\prod\nolimits_{\alpha \in A} R\right)
\ar[r] &
\bigoplus_{j = 1}^m \left(\prod\nolimits_{\alpha \in A} R\right)
\ar[r] &
Q \otimes_R \left(\prod\nolimits_{\alpha \in A} R\right)
\ar[r] &
0
}
$$
with exact rows. Pick an element $\sum_j \sum_\alpha y_{j, \alpha}$ of
$\bigoplus_{j = 1, \ldots, m}
\left(\bigoplus\nolimits_{\alpha \in A} R\right)^\wedge$.
If this element maps to zero in the module
$Q \otimes_R \left(\prod\nolimits_{\alpha \in A} R\right)$,
then we see in particular that
$\sum_j q_j \otimes y_{j, \alpha} = 0$ in $Q$ for each $\alpha$.
Thus we can find an element
$(z_{1, \alpha}, \ldots, z_{k, \alpha}) \in \bigoplus_{l = 1, \ldots, k} R$
which maps to
$(y_{1, \alpha}, \ldots, y_{m, \alpha}) \in \bigoplus_{j = 1, \ldots, m} R$.
Moreover, if $y_{j, \alpha} \in I^{N_\alpha}$ for $j = 1, \ldots, m$, then
we may assume that $z_{l, \alpha} \in I^{N_\alpha - c}$ for
$l = 1, \ldots, k$.
Hence the sum $\sum_l \sum_\alpha z_{l, \alpha}$ is ``convergent'' and
defines an element of
$\bigoplus_{l = 1, \ldots, k}
\left(\bigoplus\nolimits_{\alpha \in A} R\right)^\wedge$
which maps to the element $\sum_j \sum_\alpha y_{j, \alpha}$ we started
out with. Thus the right vertical arrow is injective and we win.
\end{proof}

\begin{lemma}
\label{lemma-completed-direct-sum-ML}
Let $R$ be a ring. Let $I \subset R$ be an ideal. Let $A$ be a set.
Assume $R$ is Noetherian and complete with respect to $I$. The completion
$\left(\bigoplus\nolimits_{\alpha \in A} R\right)^\wedge$
is flat and Mittag-Leffler.
\end{lemma}

\begin{proof}
By
Lemma \ref{lemma-universally-injective-completion-direct-sum-into-product}
the map $\left(\bigoplus\nolimits_{\alpha \in A} R\right)^\wedge
\to \prod_{\alpha \in A} R$ is universally injective.
Thus, by
Algebra, Lemmas \ref{algebra-lemma-ui-flat-domain} and
\ref{algebra-lemma-pure-submodule-ML}
it suffices to show that $\prod_{\alpha \in A} R$ is flat and Mittag-Leffler.
By
Algebra, Proposition \ref{algebra-proposition-characterize-coherent}
(and
Algebra, Lemma \ref{algebra-lemma-Noetherian-coherent})
we see that $\prod_{\alpha \in A} R$ is flat.
Thus we conclude because a product of copies of $R$ is Mittag-Leffler, see
Algebra, Lemma \ref{algebra-lemma-product-over-Noetherian-ring}.
\end{proof}

\begin{lemma}
\label{lemma-lift-ML}
Let $R$ be a ring.
Let $I \subset R$ be an ideal.
Let $R \to S$ be a ring map, and $M$ an $S$-module.
Assume
\begin{enumerate}
\item $R$ is Noetherian and $I$-adically complete,
\item $R \to S$ is of finite type,
\item $M$ is a finite $S$-module,
\item $M$ is flat over $R$, and
\item $M/IM$ is a projective $R/I$-module.
\end{enumerate}
Then the $I$-adic completion $M^\wedge$ is a flat Mittag-Leffler
$R$-module.
\end{lemma}

\begin{proof}
We may write $S$ as a quotient of $R[x_1, \ldots, x_n]$, hence
we may assume $S = R[x_1, \ldots, x_n]$. Choose a surjection
$S^{\oplus m} \to M$. By
Algebra, Lemma \ref{algebra-lemma-split-completed-sequence}
the module $M^\wedge$ is a direct summand of the module
$(S^{\oplus m})^\wedge$. Hence it suffices to prove the lemma
in case $M = S = R[x_1, \ldots, x_n] \cong \bigoplus_{n \in \mathbf{N}} R$.
In this case the lemma follows from
Lemma \ref{lemma-completed-direct-sum-ML}.
\end{proof}

\begin{lemma}
\label{lemma-universally-injective-to-completion}
Let $R$ be a ring.
Let $I \subset R$ be an ideal.
Let $R \to S$ be a ring map, and $M$ an $S$-module.
Assume
\begin{enumerate}
\item $R$ is Noetherian,
\item $R \to S$ is of finite type,
\item $M$ is a finite $S$-module, and
\item for any finite $R$-module $Q$, any
$\mathfrak q \in \text{Ass}_S(Q \otimes_R M)$
satisfies $IS + \mathfrak q \not = S$.
\end{enumerate}
Then the map $M \to M^\wedge$ of $M$ into the $I$-adic completion of $M$
is universally injective as a map of $R$-modules.
\end{lemma}

\begin{proof}
We have to show that for any finite $R$-module $Q$ the map
$Q \otimes_R M \to Q \otimes_R M^\wedge$ is injective, see
Algebra, Theorem \ref{algebra-theorem-universally-exact-criteria}.
As there is a canonical map $Q \otimes_R M^\wedge \to (Q \otimes_R M)^\wedge$
it suffices to prove that the canonnical map
$Q \otimes_R M \to (Q \otimes_R M)^\wedge$ is injective.
Hence we may replace $M$ by $Q \otimes_R M$ and it suffices to prove the
injectivity for the map $M \to M^\wedge$.

\medskip\noindent
The ring $S$ is Noetherian, see
Algebra, Lemma \ref{algebra-lemma-Noetherian-permanence}.
The module $M^\wedge = \lim M/I^nM$ is also the $IS$-adic completion of $M$.
The kernel of the map is the module $K = \bigcap I^nM$.
For any prime $\mathfrak q$ of $S$ we have
$K_{\mathfrak q} \subset \bigcap I^nM_{\mathfrak q}$.
Let $\mathfrak q$ be an associated prime of $M$.
By the last assumption we see that there exists a prime
$\mathfrak q' \supset IS + \mathfrak q$. By the above and
Algebra, Lemma \ref{algebra-lemma-intersect-powers-ideal-module-zero}
we have $K_{\mathfrak q'} = 0$ which implies that $K_{\mathfrak q} = 0$.
Hence $K = 0$ as $M$ is a submodule of
$\prod_{\mathfrak q \in \text{Ass}(M)} M_{\mathfrak q}$, see
Algebra, Lemma \ref{algebra-lemma-zero-at-ass-zero}.
\end{proof}

\begin{lemma}
\label{lemma-universally-injective-to-completion-flat}
Let $R$ be a ring.
Let $I \subset R$ be an ideal.
Let $R \to S$ be a ring map, and $M$ an $S$-module.
Assume
\begin{enumerate}
\item $R$ is Noetherian,
\item $R \to S$ is of finite type,
\item $M$ is a finite $S$-module,
\item $M$ is flat over $R$, and
\item for any prime $\mathfrak q$ of $S$, lying over any $\mathfrak p$ in $R$
such that $\mathfrak q$ is an associated prime of
$M \otimes_R \kappa(\mathfrak p)$ we have $IS + \mathfrak q \not = S$.
\end{enumerate}
Then the map $M \to M^\wedge$ of $M$ into the $I$-adic completion of $M$
is universally injective as a map of $R$-modules.
\end{lemma}

\begin{proof}
This follows from
Lemma \ref{lemma-universally-injective-to-completion}
because
Algebra, Lemma \ref{algebra-lemma-bourbaki-fibres}
guarantees that the set of associated primes of tensor products
$M \otimes_R Q$ are contained in the set of associated primes of
the modules $M \otimes_R \kappa(\mathfrak p)$.
\end{proof}




\section{Projective modules}
\label{section-projective}

\noindent
In this section we use the earlier material to show that if a flat, finitely
presented ring extension $R \subset S$ possesses a certain ``purity'' then
$S$ is projective as an $R$-module.

\medskip\noindent
The following lemma sometimes can be used to prove projectivity by
Noetherian induction on the base.

\begin{lemma}
\label{lemma-flat-pure-over-complete-projective}
Let $R$ be a ring.
Let $I \subset R$ be an ideal.
Let $R \to S$ be a ring map, and $M$ an $S$-module.
Assume
\begin{enumerate}
\item $R$ is Noetherian and $I$-adically complete,
\item $R \to S$ is of finite type,
\item $M$ is a finite $S$-module,
\item $M$ is flat over $R$,
\item $M/IM$ is projective as a $R/I$-module, and
\item for any prime $\mathfrak q$ of $S$, lying over any $\mathfrak p$ in $R$
such that $\mathfrak q$ is an associated prime of
$M \otimes_R \kappa(\mathfrak p)$ we have $IS + \mathfrak q \not = S$.
\end{enumerate}
Then $M$ is projective as an $R$-module.
\end{lemma}

\begin{proof}
By
Lemma \ref{lemma-universally-injective-to-completion-flat}
the map $M \to M^\wedge$ is universally injective.
By
Lemma \ref{lemma-lift-ML}
the module $M^\wedge$ is Mittag-Leffler.
By
Algebra, Lemma \ref{algebra-lemma-pure-submodule-ML}
we conclude that $M$ is Mittag-Leffler.
Hence $M$ is countably generated, flat and Mittag-Leffler as an $R$-module,
whence projective by
Algebra, Lemma \ref{algebra-lemma-countgen-projective}.
\end{proof}

\begin{lemma}
\label{lemma-fibres-irreducible-flat-projective}
Let $R$ be a ring.
Let $R \to S$ be a ring map.
Assume
\begin{enumerate}
\item $R$ is Noetherian,
\item $R \to S$ is of finite type and flat, and
\item every fibre ring $S \otimes_R \kappa(\mathfrak p)$ is
geometrically integral over $\kappa(\mathfrak p)$.
\end{enumerate}
Then $S$ is projective as an $R$-module.
\end{lemma}

\begin{proof}
Consider the set
$$
\{I \subset R \mid S/IS\text{ not projective as }R/I\text{-module}\}
$$
We have to show this set is empty. To get a contradiction assume it is
nonempty. Then it contains a maximal element $I$.
Let $J = \sqrt{I}$ be its radical. If $I \not = J$, then
$S/JS$ is projective as a $R/J$-module, and $S/IS$ is flat over $R/I$
and $J/I$ is a nilpotent ideal in $R/I$. Applying
Algebra, Lemma \ref{algebra-lemma-lift-projective}
we see that $S/IS$ is a projective $R/I$-module, which is a contradiction.
Hence we may assume that $I$ is a radical ideal. In other words we
are reduced to proving the lemma in case $R$ is a reduced ring and
$S/IS$ is a projective $R/I$-module for every nonzero ideal $I$
of $R$.

\medskip\noindent
Assume $R$ is a reduced ring and $S/IS$ is a projective $R/I$-module
for every nonzero ideal $I$ of $R$. By generic flatness,
Algebra, Lemma \ref{algebra-lemma-generic-flatness-Noetherian}
(applied to a localization $R_g$ which is a domain) or the more general
Algebra, Lemma \ref{algebra-lemma-generic-flatness-reduced}
there exists a nonzero $f \in R$ such that $S_f$ is free as an
$R_f$-module. Denote $R^\wedge = \lim R/(f^n)$ the $(f)$-adic completion
of $R$. Note that the ring map
$$
R \longrightarrow R_f \times R^\wedge
$$
is a faithfully flat ring map, see
Algebra, Lemma \ref{algebra-lemma-completion-flat}.
Hence by faithfully flat descent of projectivity, see
Algebra, Theorem \ref{algebra-theorem-ffdescent-projectivity}
it suffices to prove that $S \otimes_R R^\wedge$ is a projective
$R^\wedge$-module. To see this we will use the criterion of
Lemma \ref{lemma-fibres-irreducible-flat-projective}.
First of all, note that $S/fS = (S \otimes_R R^\wedge)/f(S \otimes_R R^\wedge)$
is a projective $R/(f)$-module and that $S \otimes_R R^\wedge$ is flat
and of finite type over $R^\wedge$ as a base change of such.
Next, suppose that $\mathfrak p^\wedge$ is a prime ideal
of $R^\wedge$. Let $\mathfrak p \subset R$ be the corresponding prime
of $R$. As $R \to S$ has geometrically integral fibre rings, the
same is true for the fibre rings of any base change. Hence
$\mathfrak q^\wedge = \mathfrak p^\wedge(S \otimes_R R^\wedge)$,
is a prime ideals lying over $\mathfrak p^\wedge$
and it is the unique associated prime of
$S \otimes_R \kappa(\mathfrak p^\wedge)$. Thus we win if
$f(S \otimes_R R^\wedge) + \mathfrak q^\wedge \not = S \otimes_R R^\wedge$.
This is true because $\mathfrak p^\wedge + fR^\wedge \not = R^\wedge$
as $f$ lies in the radical of the $f$-adically complete ring $R^\wedge$.
\end{proof}








\section{Auxiliary lemmas}
\label{section-auxiliary}




\begin{lemma}
\label{lemma-separate}
Let $f : X \to S$ be a quasi-compact morphism of schemes.
Let $g : T \to S$ be a morphism of schemes.
Let $t \in T$ be a point and $Z \subset X_T$ be a closed
subscheme such that $Z \cap X_t = \emptyset$.
Then there exists an open neighbourhood
$V \subset T$ of $t$, a commutative diagram
$$
\xymatrix{
V \ar[d] \ar[r]_a & T' \ar[d]^b \\
T \ar[r]^g & S,
}
$$
and a closed subscheme $Z' \subset X_{T'}$ such that
\begin{enumerate}
\item the morphism $b : T' \to S$ is locally of finite presentation,
\item with $t' = a(t)$ we have $Z' \cap X_{t'} = \emptyset$, and
\item $Z \cap X_V$ maps into $Z'$ via the morphism $X_V \to X_{T'}$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $s = g(t)$. During the proof we may always replace $T$ by an
open neighbourhood of $t$. Hence we may also replace $S$ by an open
neighbourhood of $s$. Thus we may and do assume that $T$ and $S$ are affine.
Say $S = \text{Spec}(A)$, $T = \text{Spec}(B)$, $g$ is given by the
ring map $A \to B$, and $t$ correspond to the prime ideal
$\mathfrak q \subset B$.

\medskip\noindent
As $X \to S$ is quasi-compact and $S$ is affine we may write
$X = \bigcup_{i = 1, \ldots, n} U_i$ as a finite union of affine opens.
Write $U_i = \text{Spec}(C_i)$. In particular we have
$X_T = \bigcup_{i = 1, \ldots, n} U_{i, T} =
\bigcup_{i = 1, \ldots n} \text{Spec}(C_i \otimes_A B)$.
Let $I_i \subset C_i \otimes_A B$ be the ideal corresponding to the
closed subscheme $Z \cap U_{i, T}$. The condition that
$Z \cap X_t = \emptyset$ signifies that $I_i$ generates the
unit ideal in the ring
$$
C_i \otimes_A \kappa(\mathfrak q) =
(B \setminus \mathfrak q)^{-1}\left(
C_i \otimes_A B/\mathfrak q C_i \otimes_A B \right)
$$
Since $I_i (B \setminus \mathfrak q)^{-1}(C_i \otimes_A B) =
(B \setminus \mathfrak q)^{-1} I_i$ this means that $1 = x_i/g_i$
for some $x_i \in I_i$ and $g_i \in B$, $g_i \not \in \mathfrak q$.
Thus, clearing denominators we can find a relation of the form
$$
x_i + \sum\nolimits_j f_{i, j}c_{i, j} = g_i
$$
with $x_i \in I_i$, $f_{i, j} \in \mathfrak q$, $c_{i, j} \in C_i \otimes_A B$,
and $g_i \in B$, $g_i \not \in \mathfrak q$. After replacing $B$ by
$B_{g_1 \ldots g_n}$, i.e., after replacing $T$ by a smaller affine
neighbourhood of $t$, we may assume the equations read
$$
x_i + \sum\nolimits_j f_{i, j}c_{i, j} = 1
$$
with $x_i \in I_i$, $f_{i, j} \in \mathfrak q$, $c_{i, j} \in C_i \otimes_A B$.

\medskip\noindent
To finish the argument write $B$ as a colimit of finitely presented
$A$-algebras $B_\lambda$ over a directed partially ordered set $\Lambda$.
For each $\lambda$ set
$\mathfrak q_\lambda = (B_\lambda \to B)^{-1}(\mathfrak q)$.
For sufficiently large $\lambda \in \Lambda$ we can find
\begin{enumerate}
\item an element
$x_{i, \lambda} \in C_i \otimes_A B_\lambda$ which maps to $x_i$,
\item elements $f_{i, j, \lambda} \in \mathfrak q_{i, \lambda}$
mapping to $f_{i, j}$, and
\item elements $c_{i, j, \lambda} \in C_i \otimes_A B_\lambda$
mapping to $c_{i, j}$.
\end{enumerate}
After increasing $\lambda$ a bit more the equation
$$
x_{i, \lambda} + \sum\nolimits_j f_{i, j, \lambda}c_{i, j, \lambda} = 1
$$
will hold. Fix such a $\lambda$ and set $T' = \text{Spec}(B_\lambda)$.
Then $t' \in T'$ is the point corresponding to the prime $\mathfrak q_\lambda$.
Finally, let $Z' \subset X_{T'}$ be the scheme theoretic closure of
$Z \to X_T \to X_{T'}$. As $X_T \to X_{T'}$ is affine, we can compute $Z'$
on the affine open pieces $U_{i, T'}$ as the closed subscheme associated
to $\text{Ker}(C_i \otimes_A B_\lambda \to C_i \otimes_A B/I_i)$, see
Morphisms, Example \ref{morphisms-example-scheme-theoretic-image}.
Hence $x_{i, \lambda}$ is in the ideal defining $Z'$. Thus the last
displayed equation shows that $Z' \cap X_{t'}$ is empty.
\end{proof}







\section{Flattening stratification}
\label{section-flattening}

\noindent
If $f : X \to S$ is a proper, finitely presented morphism
of schemes then one can find a stratification of the base
over whose members the morphism $f$ is flat. It is not so hard
to find this stratification, but what is a bit tricky is to prove
that this stratification is characterized by a universal property.
In this section we discuss this and some of its variants.

\medskip\noindent
The first case is where the base is the spectrum of a complete
local Noetherian ring. In this case the closed stratum is defined
and satisfies the desired universal property even for a general
finite type morphism, provided we {\it only} look for flatness in
points lying over the closed point.

\begin{lemma}
\label{lemma-flattening-complete-noetherian}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{F}$ be a quasi-coherent sheaf on $X$.
Assume
\begin{enumerate}
\item $S = \text{Spec}(A)$ is the spectrum of a Noetherian complete
local ring $A$,
\item $f$ is of finite type, and
\item $\mathcal{F}$ is a finite type $\mathcal{O}_X$-module.
\end{enumerate}
Then there exists a closed subscheme $Z \subset S$ with the following
universal property: Given a morphism $S' \to S$ which corresponds to
a local homomorphism $A' \to A$ of local rings the following
are equivalent
\begin{enumerate}
\item[(a)] the pullback $\mathcal{F}'$ of $\mathcal{F}$ to
$X' = S' \times_S X$ is flat over $S'$ at all points $x' \in X'$
lying over the closed point of $S'$, and
\item[(b)] $S' \to S$ factors through $Z$.
\end{enumerate}
In particular, $Z$ is the largest closed subscheme of $S$ such that
$\mathcal{F}|_{X_Z}$ is flat over $Z$ at all points
of $X_Z$ lying over the closed point of $Z$.
\end{lemma}

\begin{proof}
As $f$ is of finite type it is quasi-compact. Hence $X$ is quasi-compact.
Choose a finite affine open covering $X = \bigcup X_i$.
Write $X_i = \text{Spec}(B_i)$ so that $A \to B_i$ is a finite type
ring map. Note that $\mathcal{F}|_{X_i}$ corresponds to a finite
$B_i$-module $M_i$. Set $Y = \coprod X_i = \text{Spec}(\prod B_i)$
and $\mathcal{G} = \widetilde{\prod M_i}$ on $Y$.
Now if $S' \to S$ is a morphism as in the lemma, then (a) holds
for $\mathcal{F}'$ relative to $X' \to S'$ if and only if (a) holds for
$\mathcal{G}'$ relative to $Y' \to S'$. Hence this
reduces us to the case where $X$ is affine.
In this case $Z$ exists by
Algebra,
Lemma \ref{algebra-lemma-flattening-complete-local-universal-property}.
(Hint: We strongly suggest the reader only read the construction of
$Z = \text{Spec}(A/I)$ in
Algebra, Lemma \ref{algebra-lemma-flattening-complete-local-noetherian}.)
\end{proof}





\input{chapters}


\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}
