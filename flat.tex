\input{preamble}

% OK, start here.
%
\begin{document}

\title{More on flatness}

\maketitle

\phantomsection
\label{section-phantom}

\tableofcontents



\section{Introduction}
\label{section-introduction}

\noindent
In this chapter, we discuss some advanced results on flat modules and
flat morphisms of schemes. Most of these results can be
found in the paper \cite{GruRay} by Raynaud and Gruson.

\medskip\noindent
Before reading this chapter we advise the reader to take a look
at the following results (this list also serves as a pointer to
previous results):
\begin{enumerate}
\item General discussion on flat modules in
Algebra, Section \ref{algebra-section-flat}.
\item The relationship between $\text{Tor}$-groups and flatness, see
Algebra, Section \ref{algebra-section-tor}.
\item The sections on flatness criteria, namely,
Algebra, Section \ref{algebra-section-criteria-flatness}
(Noetherian case),
Algebra, Section \ref{algebra-section-flatness-artinian}
(Artinian case),
Algebra, Section \ref{algebra-section-more-flatness-criteria}
(non-Noetherian case), and finally
More on Morphisms, Section \ref{more-morphisms-section-criterion-flat-fibres}.
\item Generic flatness, see
Algebra, Section \ref{algebra-section-generic-flatness}
and
Morphisms, Section \ref{morphisms-section-generic-flatness}.
\item Openness of the flat locus, see
Algebra, Section \ref{algebra-section-open-flat}
and
More on Morphisms, Section \ref{more-morphisms-section-open-flat}.
\item Flattening stratification, see
Algebra, Section \ref{algebra-section-flattening}.
\item Additional algebraic results in
Algebra, Sections \ref{algebra-section-descent-flatness-integral},
\ref{algebra-section-torsion-flat},
\ref{algebra-section-flat-finite}, and
\ref{algebra-section-blowup-flat}.
\end{enumerate}




\section{Lemmas on \'etale localization}
\label{section-etale-localization}

\noindent
In this section we list some lemmas on \'etale localization which will be
useful later in this chapter. Please skip this section on a first reading.

\begin{lemma}
\label{lemma-lift-etale}
Let $i : Z \to X$ be a closed immersion of affine schemes.
Let $Z' \to Z$ be an \'etale morphism with $Z'$ affine.
Then there exists an \'etale morphism $X' \to X$ with $X'$
affine such that $Z' \cong Z \times_X X'$ as schemes over $Z$.
\end{lemma}

\begin{proof}
See
Algebra, Lemma \ref{algebra-lemma-lift-etale}.
\end{proof}

\begin{lemma}
\label{lemma-etale-flat-up-down}
Let $X \to T \to S$ be morphisms of schemes with $T \to S$ \'etale.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
Let $x \in X$ be a point. Then
$$
\mathcal{F}\text{ flat over }S\text{ at }x
\Leftrightarrow
\mathcal{F}\text{ flat over }T\text{ at }x
$$
In particular $\mathcal{F}$ is flat over $S$ if and only if $\mathcal{F}$
is flat over $T$.
\end{lemma}

\begin{proof}
As an \'etale morphism is a flat morphism (see
Morphisms, Lemma \ref{morphisms-lemma-etale-flat})
the implication ``$\Leftarrow$'' follows from
Algebra, Lemma \ref{algebra-lemma-composition-flat}.
For the converse assume that $\mathcal{F}$ is flat at $x$ over $S$.
Denote $\tilde x \in X \times_S T$ the point lying over $x$ in $X$
and over the image of $x$ in $T$ in $T$.
Then $(X \times_S T \to X)^*\mathcal{F}$ is flat at $\tilde x$ over $T$
via $\text{pr}_2 : X \times_S T \to T$, see
Morphisms, Lemma \ref{morphisms-lemma-base-change-module-flat}.
The diagonal $\Delta_{T/S} : T \to T \times_S T$ is an open immersion;
combine
Morphisms, Lemmas \ref{morphisms-lemma-diagonal-unramfied-morphism} and
\ref{morphisms-lemma-etale-smooth-unramified}.
So $X$ is identified with open subscheme of $X \times_S T$,
the restriction of $\text{pr}_2$ to this open is the given morphism $X \to T$,
the point $\tilde x$ corresponds to the point $x$ in this open, and
$(X \times_S T \to X)^*\mathcal{F}$ restricted to this open is $\mathcal{F}$.
Whence we see that $\mathcal{F}$ is flat at $x$ over $T$.
\end{proof}

\begin{lemma}
\label{lemma-etale-flat-up-down-local-ring}
Let $T \to S$ be an \'etale morphism. Let $t \in T$ with image $s \in S$.
Let $M$ be a $\mathcal{O}_{T, t}$-module. Then
$$
M\text{ flat over }\mathcal{O}_{S, s}
\Leftrightarrow
M\text{ flat over }\mathcal{O}_{T, t}.
$$
\end{lemma}

\begin{proof}
We may replace $S$ by an affine neighbourhood of $s$ and after that
$T$ by an affine neighbourhood of $t$.
Set $\mathcal{F} = (\text{Spec}(\mathcal{O}_{T, t}) \to T)_*\widetilde M$.
This is a quasi-coherent sheaf (see
Schemes, Lemma \ref{schemes-lemma-push-forward-quasi-coherent}
or argue directly)
on $T$ whose stalk at $t$ is $M$ (details omitted).
Apply
Lemma \ref{lemma-etale-flat-up-down}.
\end{proof}

\begin{lemma}
\label{lemma-finite-flat-weak-assassin-up-down}
Let $g : T \to S$ be a finite flat morphism of schemes.
Let $\mathcal{G}$ be a quasi-coherent $\mathcal{O}_S$-module.
Let $t \in T$ be a point with image $s \in S$. Then
$$
t \in \text{WeakAss}(g^*\mathcal{G})
\Leftrightarrow
s \in \text{WeakAss}(\mathcal{G})
$$
\end{lemma}

\begin{proof}
The implication ``$\Leftarrow$'' follows immediately from
Divisors, Lemma \ref{divisors-lemma-weakly-ass-pullback}.
Assume $t \in \text{WeakAss}(g^*\mathcal{G})$.
Let $\text{Spec}(A) \subset S$ be an affine open neighbourhood of $s$.
Let $\mathcal{G}$ be the quasi-coherent sheaf associated to the $A$-module $M$.
Let $\mathfrak p \subset A$ be the prime ideal corresponding to $s$.
As $g$ is finite flat we have $g^{-1}(\text{Spec}(A)) = \text{Spec}(B)$
for some finite flat $A$-algebra $B$. Note that
$g^*\mathcal{G}$ is the quasi-coherent $\mathcal{O}_{\text{Spec}(B)}$-module
associated to the $B$-module $M \otimes_A B$ and $g_*g^*\mathcal{G}$ is the
quasi-coherent $\mathcal{O}_{\text{Spec}(A)}$-module associated to the
$A$-module $M \otimes_A B$. By
Algebra, Lemma \ref{algebra-lemma-finite-flat-local}
we have $B_{\mathfrak p} \cong A_{\mathfrak p}^{\oplus n}$
for some integer $n \geq 0$. Note that $n \geq 1$ as we assumed there
exists at least one point of $T$ lying over $s$. Hence we see by
looking at stalks that
$$
s \in \text{WeakAss}(\mathcal{G})
\Leftrightarrow
s \in \text{WeakAss}(g_*g^*\mathcal{G})
$$
Now the assumption that $t \in \text{WeakAss}(g^*\mathcal{G})$
implies that $s \in \text{WeakAss}(g_*g^*\mathcal{G})$ by
Divisors, Lemma \ref{divisors-lemma-weakly-associated-finite}
and hence by the above $s \in  \text{WeakAss}(\mathcal{G})$.
\end{proof}

\begin{lemma}
\label{lemma-etale-weak-assassin-up-down}
Let $h : U \to S$ be an \'etale morphism of schemes.
Let $\mathcal{G}$ be a quasi-coherent $\mathcal{O}_S$-module.
Let $u \in U$ be a point with image $s \in S$. Then
$$
u \in \text{WeakAss}(h^*\mathcal{G})
\Leftrightarrow
s \in \text{WeakAss}(\mathcal{G})
$$
\end{lemma}

\begin{proof}
After replacing $S$ and $U$ by affine neighbourhoods of $s$ and $u$
we may assume that $g$ is a standard \'etale morphism of affines, see
Morphisms, Lemma \ref{morphisms-lemma-etale-locally-standard-etale}.
Thus we may assume $S = \text{Spec}(A)$ and
$X = \text{Spec}(A[x, 1/g]/(f))$, where $f$ is monic and $f'$
is invertible in $A[x, 1/g]$.
Note that $A[x, 1/g]/(f) = (A[x]/(f))_g$ is also the localization
of the finite free $A$-algebra $A[x]/(f)$. Hence we may think of
$U$ as an open subscheme of the scheme $T = \text{Spec}(A[x]/(f))$
which is finite locally free over $S$. This reduces us to 
Lemma \ref{lemma-finite-flat-weak-assassin-up-down}
above.
\end{proof}





\section{The local structure of a finite type module}
\label{section-local-structure-module}

\noindent
The key technical lemma that makes a lot of the arguments in this
chapter work is the geometric
Lemma \ref{lemma-elementary-devissage}.

\begin{lemma}
\label{lemma-sheaf-lives-on-subscheme}
Let $f : X \to S$ be a finite type morphism of affine schemes.
Let $\mathcal{F}$ be a finite type quasi-coherent $\mathcal{O}_X$-module.
Let $x \in X$ with image $s = f(x)$ in $S$.
Set $\mathcal{F}_s = \mathcal{F}|_{X_s}$.
Then there exist a closed immersion $i : Z \to X$ of finite presentation,
and a quasi-coherent finite type $\mathcal{O}_Z$-module $\mathcal{G}$
such that $i_*\mathcal{G} = \mathcal{F}$ and
$Z_s = \text{Supp}(\mathcal{F}_s)$.
\end{lemma}

\begin{proof}
Say the morphism $f : X \to S$ is given by the ring map
$A \to B$ and that $\mathcal{F}$ is the quasi-coherent sheaf
associated to the $B$-module $M$. By
Morphisms, Lemma \ref{morphisms-lemma-locally-finite-type-characterize}
we know that $A \to B$ is a finite type ring map, and by
Properties, Lemma \ref{properties-lemma-finite-type-module}
we know that $M$ is a finite $B$-module. In particular the
support of $\mathcal{F}$ is the closed subscheme of $\text{Spec}(B)$
cut out by the annihilator
$I = \{x \in B \mid xm = 0\ \forall m \in M\}$ of $M$, see
Algebra, Lemma \ref{algebra-lemma-support-closed}.
Let $\mathfrak q \subset B$ be the prime ideal corresponding to $x$
and let $\mathfrak p \subset A$ be the prime ideal corresponding to $s$.
Note that $X_s = \text{Spec}(B \otimes_A \kappa(\mathfrak p))$ and
that $\mathcal{F}_s$ is the quasi-coherent sheaf associated to the
$B \otimes_A \kappa(\mathfrak p)$ module $M \otimes_A \kappa(\mathfrak p)$. By
Divisors, Lemma \ref{divisors-lemma-support-finite-type}
the support of $\mathcal{F}_s$ is equal to
$V(I(B \otimes_A \kappa(\mathfrak p)))$. Since
$B \otimes_A \kappa(\mathfrak p)$ is of finite type over $\kappa(\mathfrak p)$
there exist finitely many elements $f_1, \ldots, f_m \in I$
such that
$$
I(B \otimes_A \kappa(\mathfrak p)) =
(f_1, \ldots, f_n)(B \otimes_A \kappa(\mathfrak p)).
$$
Denote $i : Z \to X$ the closed subscheme cut out by
$(f_1, \ldots, f_m)$, in a formula $Z = \text{Spec}(B/(f_1, \ldots, f_m))$.
Since $M$ is annihilated by $I$ we can think of $M$ as an
$B/(f_1, \ldots, f_m)$-module. In other words, $\mathcal{F}$ is the
pushforward of a finite type module on $Z$.
As $Z_s = \text{Supp}(\mathcal{F}_s)$ by construction, this
proves the lemma.
\end{proof}

\begin{lemma}
\label{lemma-elementary-devissage}
Let $f : X \to S$ be morphism of schemes which is locally of finite type.
Let $\mathcal{F}$ be a finite type quasi-coherent $\mathcal{O}_X$-module.
Let $x \in X$ with image $s = f(x)$ in $S$.
Set $\mathcal{F}_s = \mathcal{F}|_{X_s}$ and
$n = \dim_x(\text{Supp}(\mathcal{F}_s))$.
Then we can construct
\begin{enumerate}
\item elementary \'etale neighbourhoods $g : (X', x') \to (X, x)$,
$e : (S', s') \to (S, s)$,
\item a commutative diagram
$$
\xymatrix{
X \ar[dd]_f & X' \ar[dd] \ar[l]^g & Z' \ar[l]^i \ar[d]^\pi \\
& & Y' \ar[d]^h \\
S & S' \ar[l]_e & S' \ar@{=}[l]
}
$$
\item a point $z' \in Z'$ with $i(z') = x'$, $y' = \pi(z')$, $h(y') = s'$,
\item a finite type quasi-coherent $\mathcal{O}_{Z'}$-module $\mathcal{G}$,
\end{enumerate}
such that the following properties hold
\begin{enumerate}
\item $X'$, $Z'$, $Y'$, $S'$ are affine schemes,
\item $i$ is a closed immersion of finite presentation,
\item $i_*(\mathcal{G}) \cong g^*\mathcal{F}$,
\item $\pi$ is finite and $\pi^{-1}(\{y'\}) = \{z'\}$,
\item the extension $\kappa(s') \subset \kappa(y')$ is purely transcendental,
\item $h$ is smooth of relative dimension $n$
with geometrically integral fibres.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $V \subset S$ be an affine neighbourhood of $s$.
Let $U \subset f^{-1}(V)$ be an affine neighbourhood of $x$.
Then it suffices to prove the lemma for $f|_U : U \to V$ and
$\mathcal{F}|_U$. Hence in the rest of the proof we assume that
$X$ and $S$ are affine.

\medskip\noindent
First, suppose that $X_s = \text{Supp}(\mathcal{F}_s)$, in particular
$n = \dim_x(X_s)$. Apply
More on Morphisms,
Lemmas \ref{more-morphisms-lemma-local-local-structure-finite-type} and
\ref{more-morphisms-lemma-local-local-structure-finite-type-affine}.
This gives us a commutative diagram
$$
\xymatrix{
X \ar[dd] & X' \ar[l]^g \ar[d]^\pi \\
& Y' \ar[d]^h  \\
S & S' \ar[l]_e 
}
$$
and point $x' \in X'$. We set $Z' = X'$, $i = \text{id}$, and
$\mathcal{G} = g^*\mathcal{F}$ to obtain a solution in this case.

\medskip\noindent
In general choose a closed immersion $Z \to X$ and a sheaf
$\mathcal{G}$ on $Z$ as in
Lemma \ref{lemma-sheaf-lives-on-subscheme}.
Applying the result of the previous paragraph to $Z \to S$ and
$\mathcal{G}$ we obtain a diagram
$$
\xymatrix{
X \ar[dd]_f & Z \ar[l] \ar[dd]_{f|_Z} & Z' \ar[l]^g \ar[d]^\pi \\
& & Y' \ar[d]^h \\
S & S \ar@{=}[l] & S' \ar[l]_e
}
$$
and point $z' \in Z'$ satisfying all the required properties.
We will use
Lemma \ref{lemma-lift-etale}
to embed $Z'$ into a scheme \'etale over $X$. We cannot apply the lemma directly
as we want $X'$ to be a scheme over $S'$. Instead we
consider the morphisms
$$
\xymatrix{
Z' \ar[r] & Z \times_S S' \ar[r] & X \times_S S'
}
$$
The first morphism is \'etale by
Morphisms, Lemma \ref{morphisms-lemma-etale-permanence}.
The second is a closed immersion as a base change of a closed immersion.
Finally, as $X$, $S$, $S'$, $Z$, $Z'$ are all affine we may apply
Lemma \ref{lemma-lift-etale}
to get an \'etale morphism of affine schemes $X' \to X \times_S S'$ such that 
$$
Z' = (Z \times_S S') \times_{(X \times_S S')} X' = Z \times_X X'.
$$
As $Z \to X$ is a closed immersion of finite presentation, so is $Z' \to X'$.
Let $x' \in X'$ be the point corresponding to $z' \in Z'$.
Then the completed diagram
$$
\xymatrix{
X \ar[dd] & X' \ar[dd] \ar[l] & Z' \ar[l]^i \ar[d]^\pi \\
& & Y' \ar[d]^h \\
S & S' \ar[l]_e & S' \ar@{=}[l]
}
$$
is a solution of the original problem.
\end{proof}

\begin{lemma}
\label{lemma-devissage-finite-presentation}
Assumptions and notation as in
Lemma \ref{lemma-elementary-devissage}.
If $f$ is locally of finite presentation
then $\pi$ is of finite presentation.
In this case the following are equivalent
\begin{enumerate}
\item $\mathcal{F}$ is an $\mathcal{O}_X$-module of finite presentation
in a neighbourhood of $x$,
\item $\mathcal{G}$ is an $\mathcal{O}_{Z'}$-module of finite presentation
in a neighbourhood of $z'$, and
\item $\pi_*\mathcal{G}$ is an $\mathcal{O}_{Y'}$-module of
finite presentation in a neighbourhood of $y'$.
\end{enumerate}
Still assuming $f$ locally of finite presentation the following are
equivalent to each other
\begin{enumerate}
\item[(a)] $\mathcal{F}_x$ is an $\mathcal{O}_{X, x}$-module of finite
presentation,
\item[(b)] $\mathcal{G}_{z'}$ is an $\mathcal{O}_{Z', z'}$-module of
finite presentation, and
\item[(c)] $(\pi_*\mathcal{G})_{y'}$ is an $\mathcal{O}_{Y', y'}$-module
of finite presentation.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume $f$ locally of finite presentation. Then $Z' \to S$ is locally
of finite presentation as a composition of such, see
Morphisms, Lemma \ref{morphisms-lemma-composition-finite-presentation}.
Note that $Y' \to S$ is also locally of finite type as a composition
of a smooth and an \'etale morphism. Hence
Morphisms, Lemma \ref{morphisms-lemma-finite-presentation-permanence}
implies $\pi$ is locally of finite presentation.
Since $\pi$ is finite we conclude that it is also separated and
quasi-compact, hence $\pi$ is actually of finite presentation.

\medskip\noindent
To prove the equivalence of (1), (2), and (3) we also consider:
(4) $g^*\mathcal{F}$ is a $\mathcal{O}_{X'}$-module of finite presentation
in a neighbourhood of $x'$. The pull back of a module of finite presentation
is of finite presentation, see
Modules, Lemma \ref{modules-lemma-pullback-finite-presentation}.
Hence (1) $\Rightarrow$ (4).
The \'etale morphism $g$ is open, see
Morphisms, Lemma \ref{morphisms-lemma-etale-open}.
Hence for any open neighbourhood $U' \subset X'$ of $x'$, the image
$g(U')$ is an open neighbourhood of $x$ and the map
$\{U' \to g(U')\}$ is an \'etale covering. Thus (4) $\Rightarrow$ (1) by
Descent, Lemma \ref{descent-lemma-finite-presentation-descends}.
Using
Descent, Lemma \ref{descent-lemma-finite-finitely-presented-module}
and some easy topological arguments (see
More on Morphisms,
Lemma \ref{more-morphisms-lemma-finite-morphism-single-point-in-fibre})
we see that
(4) $\Leftrightarrow$ (2) $\Leftrightarrow$ (3).

\medskip\noindent
To prove the equivalence of (a), (b), (c) consider the ring maps
$$
\mathcal{O}_{X, x} \to
\mathcal{O}_{X', x'} \to
\mathcal{O}_{Z', z'} \leftarrow
\mathcal{O}_{Y', y'}
$$
The first ring map is faithfully flat. Hence
$\mathcal{F}_x$ is of finite presentation over $\mathcal{O}_{X, x}$
if and only if $g^*\mathcal{F}_{x'}$ is of finite presentation over
$\mathcal{O}_{X', x'}$, see
Algebra, Lemma \ref{algebra-lemma-descend-properties-modules}.
The second ring map is surjective (hence finite) and
finitely presented by assumption, hence
$g^*\mathcal{F}_{x'}$ is of finite presentation over $\mathcal{O}_{X', x'}$
if and only if $\mathcal{G}_{z'}$ is of finite presentation over
$\mathcal{O}_{Z', z'}$, see
Algebra, Lemma \ref{algebra-lemma-finite-finitely-presented-extension}.
Because $\pi$ is finite, of finite presentation, and
$\pi^{-1}(\{y'\}) = \{x'\}$ the ring homomorphism
$\mathcal{O}_{Y', y'} \leftarrow \mathcal{O}_{Z', z'}$ is finite
and of finite presentation, see
More on Morphisms,
Lemma \ref{more-morphisms-lemma-finite-morphism-single-point-in-fibre}.
Hence $\mathcal{G}_{z'}$ is of finite presentation over $\mathcal{O}_{Z', z'}$
if and only if $\pi_*\mathcal{G}_{y'}$ is of finite presentation over
$\mathcal{O}_{Y', y'}$, see
Algebra, Lemma \ref{algebra-lemma-finite-finitely-presented-extension}.
\end{proof}

\begin{lemma}
\label{lemma-devissage-flat}
Assumptions and notation as in
Lemma \ref{lemma-elementary-devissage}.
The following are equivalent
\begin{enumerate}
\item $\mathcal{F}$ is flat over $S$ in a neighbourhood of $x$,
\item $\mathcal{G}$ is flat over $S'$ in a neighbourhood of $z'$, and
\item $\pi_*\mathcal{G}$ is flat over $S'$ in a neighbourhood of $y'$.
\end{enumerate}
The following are equivalent also
\begin{enumerate}
\item[(a)] $\mathcal{F}_x$ is flat over $\mathcal{O}_{S, s}$,
\item[(b)] $\mathcal{G}_{z'}$ is flat over $\mathcal{O}_{S', s'}$, and
\item[(c)] $(\pi_*\mathcal{G})_{y'}$ is flat over $\mathcal{O}_{S', s'}$.
\end{enumerate}
\end{lemma}

\begin{proof}
To prove the equivalence of (1), (2), and (3) we also consider:
(4) $g^*\mathcal{F}$ is flat over $S$ in a neighbourhood of $x'$.
We will use
Lemma \ref{lemma-etale-flat-up-down}
to equate flatness over $S$ and $S'$ without further mention.
The \'etale morphism $g$ is flat and open, see
Morphisms, Lemma \ref{morphisms-lemma-etale-open}.
Hence for any open neighbourhood $U' \subset X'$ of $x'$, the image
$g(U')$ is an open neighbourhood of $x$ and the map
$U' \to g(U')$ is surjective and flat.
Thus (4) $\Leftrightarrow$ (1) by
Morphisms, Lemma \ref{morphisms-lemma-flat-permanence}.
Note that
$$
\Gamma(X', g^*\mathcal{F}) =
\Gamma(Z', \mathcal{G}) =
\Gamma(Y', \pi_*\mathcal{G})
$$
Hence the flatness of $g^*\mathcal{F}$, $\mathcal{G}$ and $\pi_*\mathcal{G}$
over $S'$ are all equivalent (this uses that $X'$, $Z'$, $Y'$, and
$S'$ are all affine). Some omitted topological arguments (compare
More on Morphisms,
Lemma \ref{more-morphisms-lemma-finite-morphism-single-point-in-fibre})
regarding affine neighbourhoods now show that
(4) $\Leftrightarrow$ (2) $\Leftrightarrow$ (3).

\medskip\noindent
To prove the equivalence of (a), (b), (c) consider the commutative diagram
of local ring maps
$$
\xymatrix{
\mathcal{O}_{X', x'} \ar[r]_\iota &
\mathcal{O}_{Z', z'} &
\mathcal{O}_{Y', y'} \ar[l]^\alpha &
\mathcal{O}_{S', s'} \ar[l]^\beta \\
\mathcal{O}_{X, x} \ar[u]^\gamma & & &
\mathcal{O}_{S, s} \ar[lll]_\varphi \ar[u]_\epsilon
}
$$
We will use
Lemma \ref{lemma-etale-flat-up-down-local-ring}
to equate flatness over $\mathcal{O}_{S, s}$ and $\mathcal{O}_{S', s'}$
without further mention.
The map $\gamma$ is faithfully flat. Hence
$\mathcal{F}_x$ is flat over $\mathcal{O}_{S, s}$
if and only if $g^*\mathcal{F}_{x'}$ is flat over
$\mathcal{O}_{S', s'}$, see
Algebra, Lemma \ref{algebra-lemma-flatness-descends-more-general}.
As $\mathcal{O}_{S', s'}$-modules the modules
$g^*\mathcal{F}_{x'}$, $\mathcal{G}_{z'}$, and
$\pi_*\mathcal{G}_{y'}$ are all isomorphic, see
More on Morphisms,
Lemma \ref{more-morphisms-lemma-finite-morphism-single-point-in-fibre}.
This finishes the proof.
\end{proof}









\section{One step d\'evissage}
\label{section-one-step-devissage}

\noindent
In this section we explain what is a one step d\'evissage of a
module. A one step d\'evissage exist \'etale locally on base and target.
We discuss base change, Zariski shrinking and \'etale localization of
a one step d\'evissage.

\begin{definition}
\label{definition-one-step-devissage}
Let $S$ be a scheme.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module of finite type.
Let $s \in S$ be a point.
A {\it one step d\'evissage of $\mathcal{F}/X/S$ over $s$}
is given by morphisms of schemes over $S$
$$
\xymatrix{
X & Z \ar[l]_i \ar[r]^\pi & Y
}
$$
and a quasi-coherent $\mathcal{O}_Z$-module $\mathcal{G}$ of finite type
such that
\begin{enumerate}
\item $X$, $S$, $Z$ and $Y$ are affine,
\item $i$ is a closed immersion of finite presentation,
\item $\mathcal{F} \cong i_*\mathcal{G}$,
\item $\pi$ is finite, and
\item the structure morphism $Y \to S$ is smooth with
geometrically irreducible fibres of
dimension $\dim(\text{Supp}(\mathcal{F}_s))$.
\end{enumerate}
In this case we say $(Z, Y, i, \pi, \mathcal{G})$ is a one step
d\'evissage of $\mathcal{F}/X/S$ over $s$.
\end{definition}

\begin{definition}
\label{definition-one-step-devissage-at-x}
Let $S$ be a scheme.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module of finite type.
Let $x \in X$ be a point with image $s$ in $S$.
A {\it one step d\'evissage of $\mathcal{F}/X/S$ at $x$}
is a system $(Z, Y, i, \pi, \mathcal{G}, z, y)$, where
$(Z, Y, i, \pi, \mathcal{G})$ is a one step d\'evissage of
$\mathcal{F}/X/S$ over $s$ and
\begin{enumerate}
\item $\dim_x(\text{Supp}(\mathcal{F}_s)) = \dim(\text{Supp}(\mathcal{F}_s))$,
\item $z \in Z$ is a point with $i(z) = x$ and $\pi(z) = y$,
\item we have $\pi^{-1}(\{y\}) = \{z\}$,
\item the extension $\kappa(s) \subset \kappa(y)$ is purely
transcendental.
\end{enumerate}
\end{definition}

\noindent
A one step d\'evissage of $\mathcal{F}/X/S$ at $x$ can only exist if
$X$ and $S$ are affine. Condition (1) assures us that $Y \to S$ has
relative dimension equal to $\dim_x(\text{Supp}(\mathcal{F}_s))$
via condition (5) of
Definition \ref{definition-one-step-devissage}.

\begin{lemma}[Reformulation of Lemma \ref{lemma-elementary-devissage}]
\label{lemma-elementary-devissage-variant}
Let $f : X \to S$ be morphism of schemes which is locally of finite type.
Let $\mathcal{F}$ be a finite type quasi-coherent $\mathcal{O}_X$-module.
Let $x \in X$ with image $s = f(x)$ in $S$.
Then there exists a commutative diagram of pointed schemes
$$
\xymatrix{
(X, x) \ar[d]_f & (X', x') \ar[l]^g \ar[d] \\
(S, s) & (S', s') \ar[l] \\
}
$$
such that $(S', s') \to (S, s)$ and $(X', x') \to (X, x)$
are elementary \'etale neighbourhoods, and such that
$g^*\mathcal{F}/X'/S'$ has a one step d\'evissage at $x'$.
\end{lemma}

\begin{proof}
This is immediate from
Definition \ref{definition-one-step-devissage-at-x}
and
Lemma \ref{lemma-elementary-devissage}.
\end{proof}

\begin{lemma}
\label{lemma-base-change-one-step}
Let $S$, $X$, $\mathcal{F}$, $s$ be as in
Definition \ref{definition-one-step-devissage}.
Let $(Z, Y, i, \pi, \mathcal{G})$ be a one step d\'evissage
of $\mathcal{F}/X/S$ over $s$.
Let $(S', s') \to (S, s)$ be any morphism of pointed schemes.
Given this data let $X', Z', Y', i', \pi'$ be the base
changes of $X, Z, Y, i, \pi$ via $S' \to S$.
Let $\mathcal{F}'$ be the pullback of $\mathcal{F}$ to $X'$
and let $\mathcal{G}'$ be the pullback of $\mathcal{G}$ to $Z'$.
If $S'$ is affine, then $(Z', Y', i', \pi', \mathcal{G}')$
is a one step d\'evissage of $\mathcal{F}'/X'/S'$ over $s'$.
\end{lemma}

\begin{proof}
Fibre products of affines are affine, see
Schemes, Lemma \ref{schemes-lemma-fibre-product-affines}.
Base change preserves
closed immersions,
morphisms of finite presentation,
finite morphisms,
smooth morphisms,
morphisms with geometrically irreducible fibres, and
morphisms of relative dimension $n$, see
Morphisms, Lemmas \ref{morphisms-lemma-base-change-closed-immersion},
\ref{morphisms-lemma-base-change-finite-presentation},
\ref{morphisms-lemma-base-change-finite},
\ref{morphisms-lemma-base-change-smooth}, 
\ref{morphisms-lemma-base-change-relative-dimension-d}, and
More on Morphisms, Lemma
\ref{more-morphisms-lemma-base-change-fibres-geometrically-irreducible}.
We have $i'_*\mathcal{G}' \cong \mathcal{F}'$ because pushforward
along the finite morphism $i$ commutes with base change, see
Coherent, Lemma \ref{coherent-lemma-affine-base-change}.
We have
$\dim(\text{Supp}(\mathcal{F}_s)) = \dim(\text{Supp}(\mathcal{F}'_{s'}))$
by
Morphisms, Lemma \ref{morphisms-lemma-dimension-fibre-after-base-change}
because
$$
\text{Supp}(\mathcal{F}_s) \times_s s' = \text{Supp}(\mathcal{F}'_{s'}).
$$
This proves the lemma.
\end{proof}

\begin{lemma}
\label{lemma-base-change-one-step-at-x}
Let $S$, $X$, $\mathcal{F}$, $x$, $s$ be as in
Definition \ref{definition-one-step-devissage-at-x}.
Let $(Z, Y, i, \pi, \mathcal{G}, z, y)$ be a one step d\'evissage
of $\mathcal{F}/X/S$ at $x$.
Let $(S', s') \to (S, s)$ be a morphism of pointed schemes
which induces an isomorphism $\kappa(s) = \kappa(s')$.
Let $(Z', Y', i', \pi', \mathcal{G}')$ be as constructed in
Lemma \ref{lemma-base-change-one-step}
and let $x' \in X'$ (resp.\ $z' \in Z'$, $y' \in Y'$) be the
unique point mapping to both $x \in X$ (resp.\ $z \in Z$, $y \in Y$)
and $s' \in S'$.
If $S'$ is affine, then $(Z', Y', i', \pi', \mathcal{G}', z', y')$
is a one step d\'evissage of $\mathcal{F}'/X'/S'$ at $x'$.
\end{lemma}

\begin{proof}
By
Lemma \ref{lemma-base-change-one-step}
$(Z', Y', i', \pi', \mathcal{G}')$ is a one step d\'evissage of
$\mathcal{F}'/X'/S'$ over $s'$. Properties (1) -- (4) of
Definition \ref{definition-one-step-devissage-at-x}
hold for $(Z', Y', i', \pi', \mathcal{G}', z', y')$
as the assumption that $\kappa(s) = \kappa(s')$ insures that the fibres
$X'_{s'}$, $Z'_{s'}$, and $Y'_{s'}$ are isomorphic to
$X_s$, $Z_s$, and $Y_s$.
\end{proof}

\begin{definition}
\label{definition-shrink}
Let $S$, $X$, $\mathcal{F}$, $x$, $s$ be as in
Definition \ref{definition-one-step-devissage-at-x}.
Let $(Z, Y, i, \pi, \mathcal{G}, z, y)$ be a one step d\'evissage
of $\mathcal{F}/X/S$ at $x$. Let us define a
{\it standard shrinking} of this situation to be
given by standard opens $S' \subset S$, $X' \subset X$, $Z' \subset Z$,
and $Y' \subset Y$ such that $s \in S'$, $x \in X'$, $z \in Z'$, and
$y \in Y'$ and such that
$$
(Z', Y', i|_{Z'}, \pi|_{Z'}, \mathcal{G}|_{Z'}, z, y)
$$
is a one step d\'evissage of $\mathcal{F}|_{X'}/X'/S'$ at $x$.
\end{definition}

\begin{lemma}
\label{lemma-shrink}
With assumption and notation as in
Definition \ref{definition-shrink}
we have:
\begin{enumerate}
\item
\label{item-shrink-base}
If $S' \subset S$ is a standard open neighbourhood of $s$, then
setting $X' = X_{S'}$, $Z' = Z_{S'}$ and $Y' = Y_{S'}$ we obtain a
standard shrinking.
\item
\label{item-shrink-on-Y}
Let $W \subset Y$ be a standard open neighbourhood of $y$.
Then there exists a standard shrinking with $Y' = W \times_S S'$.
\item
\label{item-shrink-on-X}
Let $U \subset X$ be an open neighbourhood of $x$.
Then there exists a standard shrinking with $X' \subset U$.
\end{enumerate}
\end{lemma}

\begin{proof}
Part (1) is immediate from
Lemma \ref{lemma-base-change-one-step-at-x}
and the fact that the inverse image of a standard open under a morphism
of affine schemes is a standard open, see
Algebra, Lemma \ref{algebra-lemma-spec-functorial}.

\medskip\noindent
Let $W \subset Y$ as in (2). Because $Y \to S$ is smooth it is open, see
Morphisms, Lemma \ref{morphisms-lemma-smooth-open}.
Hence we can find a standard open neighbourhood $S'$ of $s$
contained in the image of $W$. Then the fibres of $W_{S'} \to S'$
are nonempty open subschemes of the fibres of $Y \to S$ over $S'$
and hence geometrically irreducible too. Setting $Y' = W_{S'}$
and $Z' = \pi^{-1}(Y')$ we see that $Z' \subset Z$ is a standard open
neighbourhood of $z$. Let $\overline{h} \in \Gamma(Z, \mathcal{O}_Z)$
be a function such that $Z' = D(\overline{h})$. As $i : Z \to X$
is a closed immersion, we can find a function $h \in \Gamma(X, \mathcal{O}_X)$
such that $i^\sharp(h) = \overline{h}$. Take $X' = D(h) \subset X$.
In this way we obtain a standard shrinking as in (2).

\medskip\noindent
Let $U \subset X$ be as in (3). We may after shrinking $U$ assume that
$U$ is a standard open. By
More on Morphisms,
Lemma \ref{more-morphisms-lemma-finite-morphism-single-point-in-fibre}
there exists a standard open $W \subset Y$ neighbourhood of $y$ such
that $\pi^{-1}(W) \subset i^{-1}(U)$. Apply (2) to get a standard
shrinking $X', S', Z', Y'$ with $Y' = W_{S'}$. Since
$Z' \subset \pi^{-1}(W) \subset i^{-1}(U)$ we may replace $X'$ by
$X' \cap U$ (still a standard open as $U$ is also standard open)
without violating any of the conditions defining a standard shrinking.
Hence we win.
\end{proof}

\begin{lemma}
\label{lemma-elementary-etale-neighbourhood}
Let $S$, $X$, $\mathcal{F}$, $x$, $s$ be as in
Definition \ref{definition-one-step-devissage-at-x}.
Let $(Z, Y, i, \pi, \mathcal{G}, z, y)$ be a one step d\'evissage
of $\mathcal{F}/X/S$ at $x$. Let
$$
\xymatrix{
(Y, y) \ar[d] & (Y', y') \ar[l] \ar[d] \\
(S, s) & (S', s') \ar[l]
}
$$
be a commutative diagram of pointed schemes such that the horizontal
arrows are elementary \'etale neighbourhoods. Then there exists
a commutative diagram
$$
\xymatrix{
& & (X'', x'') \ar[lld] \ar[d] & (Z'', z'') \ar[l] \ar[lld] \ar[d] \\
(X, x) \ar[d] & (Z, z) \ar[l] \ar[d] &
(S'', s'') \ar[lld] & (Y'', y'') \ar[lld] \ar[l] \\
(S, s) & (Y, y) \ar[l]
}
$$
of pointed schemes with the following properties:
\begin{enumerate}
\item $(S'', s'') \to (S', s')$ is an elementary \'etale neighbourhood and
the morphism $S'' \to S$ is the composition $S'' \to S' \to S$,
\item $Y''$ is an open subscheme of $Y' \times_{S'} S''$,
\item $Z'' = Z \times_Y Y''$,
\item $(X'', x'') \to (X, x)$ is an elementary \'etale neighbourhood, and
\item $(Z'', Y'', i'', \pi'', \mathcal{G}'', z'', y'')$ is a one step
d\'evissage at $x''$ of the sheaf $\mathcal{F}''$.
\end{enumerate}
Here $\mathcal{F}''$ (resp.\ $\mathcal{G}''$) is the pullback of
$\mathcal{F}$ (resp.\ $\mathcal{G}$) via the morphism $X'' \to X$
(resp.\ $Z'' \to Z$) and $i'' : Z'' \to X''$ and $\pi'' : Z'' \to Y''$
are as in the diagram.
\end{lemma}

\begin{proof}
Let $(S'', s'') \to (S', s')$ be any elementary \'etale neighbourhood
with $S''$ affine. Let $Y'' \subset Y' \times_{S'} S''$ be any affine
open neighbourhood containing the point $y'' = (y', s'')$. Then we
obtain an affine $(Z'', z'')$ by (3). Moreover $Z_{S''} \to X_{S''}$
is a closed immersion and $Z'' \to Z_{S''}$ is an \'etale
morphism. Hence
Lemma \ref{lemma-lift-etale}
applies and we can find an \'etale morphism $X'' \to X_{S'}$ of affines
such that $Z'' \cong X'' \times_{X_{S'}} Z_{S'}$. Denote $i'' : Z'' \to X''$
the corresponding closed immersion. Setting $x'' = i''(z'')$ we obtain a
commutative diagram as in the lemma.
Properties (1), (2), (3), and (4) hold by construction.
Thus it suffices to show that (5) holds for a suitable choice of
$(S'', s'') \to (S', s')$ and $Y''$.

\medskip\noindent
We first list those properties which hold for any choice of
$(S'', s'') \to (S', s')$ and $Y''$ as in the first paragraph.
As we have $Z'' = X'' \times_X Z$ by construction we see that
$i''_*\mathcal{G}'' = \mathcal{F}''$ (with notation as in the
statement of the lemma), see
Coherent, Lemma \ref{coherent-lemma-affine-base-change}.
Set $n = \dim(\text{Supp}(\mathcal{F}_s)) = \dim_x(\text{Supp}(\mathcal{F}_s))$.
The morphism $Y'' \to S''$ is smooth of relative dimension $n$
(because $Y' \to S'$ is smooth of relative dimension $n$
as the composition $Y' \to Y_{S'} \to S'$ of an etale and
smooth morphism of relative dimension $n$ and because base change
preserves smooth morphisms of relative dimension $n$).
We have $\kappa(y'') = \kappa(y)$ and $\kappa(s) = \kappa(s'')$
hence $\kappa(y'')$ is a purely transcendental extension of $\kappa(s'')$.
The morphism of fibres $X''_{s''} \to X_s$ is an etale morphism of affine
schemes over $\kappa(s) = \kappa(s'')$ mapping the point $x''$ to the
point $x$ and pulling back $\mathcal{F}_s$ to $\mathcal{F}''_{s''}$.
Hence
$$
\dim(\text{Supp}(\mathcal{F}''_{s''})) =
\dim(\text{Supp}(\mathcal{F}_s)) = n =
\dim_x(\text{Supp}(\mathcal{F}_s)) =
\dim_{x''}(\text{Supp}(\mathcal{F}''_{s''}))
$$
because dimension is invariant under etale localization, see
Descent, Lemma \ref{descent-lemma-dimension-at-point-local}.
As $\pi'' : Z'' \to Y''$ is the base change of $\pi$ we see that
$\pi''$ is finite and as $\kappa(y) = \kappa(y'')$ we see that
$\pi^{-1}(\{y''\}) = \{z''\}$.

\medskip\noindent
At this point we have verified all the conditions of
Definition \ref{definition-one-step-devissage}
except we have not verfied that $Y'' \to S''$ has geometrically
irreducible fibres. Of course in general this is not going to be
true, and it is at this point that we will use that
$\kappa(s) \subset \kappa(y)$ is purely transcendental. Namely,
let $T \subset Y'_{s'}$ be the irreducible component of
$Y'_{s'}$ containing $y' = (y, s')$. Note that $T$ is an open subscheme
of $Y'_{s'}$ as this is a smooth scheme over $\kappa(s')$. By
Varieties,
Lemma \ref{varieties-lemma-geometrically-connected-if-connected-and-point}
we see that $T$ is geometrically connected because $\kappa(s') = \kappa(s)$
is algebraically closed in $\kappa(y') = \kappa(y)$.
As $T$ is smooth we see that $T$ is geometrically irreducible. Hence
More on Morphisms,
Lemma \ref{more-morphisms-lemma-normal-morphism-irreducible}
applies and we can find an elementary \'etale morphism
$(S'', s'') \to (S', s')$ and an affine open $Y'' \subset Y'_{S''}$
such that all fibres of $Y'' \to S''$ are geometrically irreducible
and such that $T = Y''_{s''}$. After shrinking (first $Y''$ and then $S''$)
we may assume that both $Y''$ and $S''$ are affine.
This finishes the proof of the lemma.
\end{proof}

\begin{lemma}
\label{lemma-existence-alpha}
Let $S$, $X$, $\mathcal{F}$, $s$ be as in
Definition \ref{definition-one-step-devissage}.
Let $(Z, Y, i, \pi, \mathcal{G})$ be a one step d\'evissage
of $\mathcal{F}/X/S$ over $s$.
Let $\xi \in Y_s$ be the (unique) generic point.
Then there exists an integer $r > 0$ and an $\mathcal{O}_Y$-module map
$$
\alpha : \mathcal{O}_Y^{\oplus r} \longrightarrow \pi_*\mathcal{G}
$$
such that
$$
\alpha :
\kappa(\xi)^{\oplus r}
\longrightarrow
(\pi_*\mathcal{G})_\xi \otimes_{\mathcal{O}_{Y, \xi}} \kappa(\xi)
$$
is an isomorphism. Moreover, in this case we have
$$
\dim(\text{Supp}(\text{Coker}(\alpha)_s)) < \dim(\text{Supp}(\mathcal{F}_s)).
$$
\end{lemma}

\begin{proof}
By assumption the schemes $S$ and $Y$ are affine.
Write $S = \text{Spec}(A)$ and $Y = \text{Spec}(B)$.
As $\pi$ is finite the $\mathcal{O}_Y$-module $\pi_*\mathcal{G}$
is a finite type quasi-coherent $\mathcal{O}_Y$-module.
Hence $\pi_*\mathcal{G} = \widetilde{N}$ for some finite $B$-module $N$.
Let $\mathfrak p \subset B$ be the prime ideal corresponding to $\xi$.
To obtain $\alpha$ set
$r = \dim_{\kappa(\mathfrak p)} N \otimes_B \kappa(\mathfrak p)$
and pick $x_1, \ldots, x_r \in N$ which form a basis of
$N \otimes_B \kappa(\mathfrak p)$. Take $\alpha : B^{\oplus r} \to N$
to be the map given by the formula $\alpha(b_1, \ldots, b_r) = \sum b_ix_i$.
It is clear that
$\alpha : \kappa(\mathfrak p)^{\oplus r} \to N \otimes_B \kappa(\mathfrak p)$
is an isomorphism as desired. Finally, suppose $\alpha$ is any map with this
property. Then $N' = \text{Coker}(\alpha)$ is a finite $B$-module
such that $N' \otimes \kappa(\mathfrak p) = 0$. By Nakayama's lemma
(Algebra, Lemma \ref{algebra-lemma-NAK})
we see that $N'_{\mathfrak p} = 0$. Since the fibre $Y_s$ is
geometrically irreducible of dimension $n$ with generic point $\xi$
and since we have just seen that $\xi$ is not in the support of
$\text{Coker}(\alpha)$ the last assertion of the lemma holds.
\end{proof}


\section{Complete d\'evissage}
\label{section-complete-devissage}

\noindent
In this section we explain what is a complete d\'evissage of a
module and prove that such exist. The material in this
section is mainly bookkeeping.

\begin{definition}
\label{definition-complete-devissage}
Let $S$ be a scheme.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module of finite type.
Let $s \in S$ be a point.
A {\it complete d\'evissage of $\mathcal{F}/X/S$ over $s$} is given by a
diagram
$$
\xymatrix{
X & Z_1 \ar[l]^{i_1} \ar[d]^{\pi_1} \\
& Y_1 & Z_2 \ar[l]^{i_2} \ar[d]^{\pi_2} \\
& & Y_2 & Z_3 \ar[l] \ar[d] \\
& & & ... & ... \ar[l] \ar[d] \\
& & & & Y_n
}
$$
of schemes over $S$, finite type quasi-coherent $\mathcal{O}_{Z_k}$-modules
$\mathcal{G}_k$, and $\mathcal{O}_{Y_k}$-module maps
$$
\alpha_k :
\mathcal{O}_{Y_k}^{\oplus r_k}
\longrightarrow
\pi_{k, *}\mathcal{G}_k,
\quad
k = 1, \ldots, n
$$
satisfying the following properties:
\begin{enumerate}
\item $(Z_1, Y_1, i_1, \pi_1, \mathcal{G}_1)$ is a one step
d\'evissage of $\mathcal{F}/X/S$ over $s$,
\item the map $\alpha_k$ induces an isomorphism
$$
\kappa(\xi_k)^{\oplus r_k} \longrightarrow
(\pi_{k, *}\mathcal{G}_k)_{\xi_k}
\otimes_{\mathcal{O}_{Y_k, \xi_k}} \kappa(\xi_k)
$$
where $\xi_k \in (Y_k)_s$ is the unique generic point,
\item for $k = 2, \ldots, n$ the system
$(Z_k, Y_k, i_k, \pi_k, \mathcal{G}_k)$
is a one step d\'evissage of $\text{Coker}(\alpha_{k - 1})/Y_{k - 1}/S$
over $s$,
\item $\text{Coker}(\alpha_n) = 0$.
\end{enumerate}
In this case we say that
$(Z_k, Y_k, i_k, \pi_k, \mathcal{G}_k, \alpha_k)_{k = 1, \ldots, n}$
is a complete d\'evissage of $\mathcal{F}/X/S$ over $s$.
\end{definition}

\begin{definition}
\label{definition-complete-devissage-at-x}
Let $S$ be a scheme.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module of finite type.
Let $x \in X$ be a point with image $s \in S$.
A {\it complete d\'evissage of $\mathcal{F}/X/S$ at $x$} is given by a
system
$$
(Z_k, Y_k, i_k, \pi_k, \mathcal{G}_k, \alpha_k, z_k, y_k)_{k = 1, \ldots, n}
$$
such that $(Z_k, Y_k, i_k, \pi_k, \mathcal{G}_k, \alpha_k)$ is a
complete d\'evissage of $\mathcal{F}/X/S$ over $s$, and such that
\begin{enumerate}
\item $(Z_1, Y_1, i_1, \pi_1, \mathcal{G}_1, z_1, y_1)$ is a one step
d\'evissage of $\mathcal{F}/X/S$ at $x$,
\item for $k = 2, \ldots, n$ the system
$(Z_k, Y_k, i_k, \pi_k, \mathcal{G}_k, z_k, y_k)$
is a one step d\'evissage of $\text{Coker}(\alpha_{k - 1})/Y_{k - 1}/S$
at $y_{k - 1}$.
\end{enumerate}
\end{definition}

\noindent
Again we remark that a complete d\'evissage can only exist if $X$ and
$S$ are affine.

\begin{lemma}
\label{lemma-base-change-complete}
Let $S$, $X$, $\mathcal{F}$, $s$ be as in
Definition \ref{definition-complete-devissage}.
Let $(S', s') \to (S, s)$ be any morphism of pointed schemes.
Let $(Z_k, Y_k, i_k, \pi_k, \mathcal{G}_k, \alpha_k)_{k = 1, \ldots, n}$
be a complete d\'evissage of $\mathcal{F}/X/S$ over $s$.
Given this data let $X', Z'_k, Y'_k, i'_k, \pi'_k$ be the base
changes of $X, Z_k, Y_k, i_k, \pi_k$ via $S' \to S$.
Let $\mathcal{F}'$ be the pullback of $\mathcal{F}$ to $X'$
and let $\mathcal{G}'_k$ be the pullback of $\mathcal{G}_k$ to $Z'_k$.
Let $\alpha'_k$ be the pullback of $\alpha_k$ to $Y'_k$.
If $S'$ is affine, then
$(Z'_k, Y'_k, i'_k, \pi'_k, \mathcal{G}'_k, \alpha'_k)_{k = 1, \ldots, n}$
is a complete d\'evissage of $\mathcal{F}'/X'/S'$ over $s'$.
\end{lemma}

\begin{proof}
By
Lemma \ref{lemma-base-change-one-step}
we know that the base change of a one step d\'evissage is a one step
d\'evissage. Hence it suffices to prove that formation of
$\text{Coker}(\alpha_k)$ commutes with base change and that
condition (2) of
Definition \ref{definition-complete-devissage}
is preserved by base change. The first is true as
$\pi'_{k, *}\mathcal{G}'_k$ is the pullback of
$\pi_{k, *}\mathcal{G}_k$ (by
Coherent, Lemma \ref{coherent-lemma-affine-base-change})
and because $\otimes$ is right exact. The second because
by the same token we have
$$
(\pi_{k, *}\mathcal{G}_k)_{\xi_k}
\otimes_{\mathcal{O}_{Y_k, \xi_k}} \kappa(\xi_k)
\otimes_{\kappa(\xi_k)} \kappa(\xi'_k)
\cong
(\pi'_{k, *}\mathcal{G}'_k)_{\xi'_k}
\otimes_{\mathcal{O}_{Y'_k, \xi'_k}} \kappa(\xi'_k)
$$
with obvious notation.
\end{proof}

\begin{lemma}
\label{lemma-base-change-complete-at-x}
Let $S$, $X$, $\mathcal{F}$, $x$, $s$ be as in
Definition \ref{definition-complete-devissage-at-x}.
Let $(S', s') \to (S, s)$ be a morphism of pointed schemes
which induces an isomorphism $\kappa(s) = \kappa(s')$. Let
$(Z_k, Y_k, i_k, \pi_k, \mathcal{G}_k, \alpha_k, z_k, y_k)_{k = 1, \ldots, n}$
be a complete d\'evissage of $\mathcal{F}/X/S$ at $x$.
Let
$(Z'_k, Y'_k, i'_k, \pi'_k, \mathcal{G}'_k, \alpha'_k)_{k = 1, \ldots, n}$
be as constructed in
Lemma \ref{lemma-base-change-complete}
and let $x' \in X'$ (resp.\ $z'_k \in Z'$, $y'_k \in Y'$) be the
unique point mapping to both $x \in X$ (resp.\ $z_k \in Z_k$, $y_k \in Y_k$)
and $s' \in S'$.
If $S'$ is affine, then
$(Z'_k, Y'_k, i'_k, \pi'_k, \mathcal{G}'_k, \alpha'_k,
z'_k, y'_k)_{k = 1, \ldots, n}$
is a complete d\'evissage of $\mathcal{F}'/X'/S'$ at $x'$.
\end{lemma}

\begin{proof}
Combine
Lemma \ref{lemma-base-change-complete}
and
Lemma \ref{lemma-base-change-one-step-at-x}.
\end{proof}

\begin{definition}
\label{definition-shrink-complete}
Let $S$, $X$, $\mathcal{F}$, $x$, $s$ be as in
Definition \ref{definition-complete-devissage-at-x}.
Consider a complete d\'evissage
$(Z_k, Y_k, i_k, \pi_k, \mathcal{G}_k, \alpha_k, z_k, y_k)_{k = 1, \ldots, n}$
of $\mathcal{F}/X/S$ at $x$. Let us define a
{\it standard shrinking} of this situation to be
given by standard opens $S' \subset S$, $X' \subset X$,
$Z'_k \subset Z_k$, and $Y'_k \subset Y_k$ such that $s_k \in S'$,
$x_k \in X'$, $z_k \in Z'$, and $y_k \in Y'$ and such that
$$
(Z'_k, Y'_k, i'_k, \pi'_k,
\mathcal{G}'_k, \alpha'_k, z_k, y_k)_{k = 1, \ldots, n}
$$
is a one step d\'evissage of $\mathcal{F}'/X'/S'$ at $x$ where
$\mathcal{G}'_k = \mathcal{G}_k|_{Z'_k}$ and
$\mathcal{F}' = \mathcal{F}|_{X'}$.
\end{definition}

\begin{lemma}
\label{lemma-shrink-complete}
With assumption and notation as in
Definition \ref{definition-shrink-complete}
we have:
\begin{enumerate}
\item
\label{item-shrink-base-complete}
If $S' \subset S$ is a standard open neighbourhood of $s$, then
setting $X' = X_{S'}$, $Z'_k = Z_{S'}$ and $Y'_k = Y_{S'}$ we obtain a
standard shrinking.
\item
\label{item-shrink-on-Y-complete}
Let $W \subset Y_n$ be a standard open neighbourhood of $y$.
Then there exists a standard shrinking with $Y'_n = W \times_S S'$.
\item
\label{item-shrink-on-X-complete}
Let $U \subset X$ be an open neighbourhood of $x$.
Then there exists a standard shrinking with $X' \subset U$.
\end{enumerate}
\end{lemma}

\begin{proof}
Part (1) is immediate from
Lemmas \ref{lemma-base-change-complete-at-x} and
\ref{lemma-shrink}.

\medskip\noindent
Proof of (2). For convenience denote $X = Y_0$. We apply
Lemma \ref{lemma-shrink} (\ref{item-shrink-on-Y})
to find a standard shrinking
$S', Y'_{n - 1}, Z'_n, Y'_n$
of the one step d\'evissage of $\text{Coker}(\alpha_{n - 1})/Y_{n - 1}/S$
at $y_{n - 1}$ with $Y'_n = W \times_S S'$. We may repeat this procedure
and find a standard shrinking
$S'', Y''_{n - 2}, Z''_{n - 1}, Y''_{n - 1}$
of the one step d\'evissage of $\text{Coker}(\alpha_{n - 2})/Y_{n - 2}/S$
at $y_{n - 2}$ with $Y''_{n - 1} = Y'_{n - 1} \times_S S''$.
We may continue in this manner until we obtain
$S^{(n)}, Y^{(n)}_0, Z^{(n)}_1, Y^{(n)}_1$.
At this point it is clear that we obtain our desired standard shrinking
by taking $S^{(n)}$, $X^{(n)}$, $Z_k^{(n - k)} \times_S S^{(n)}$, and
$Y_k^{(n - k)} \times_S S^{(n)}$ with the desired property.

\medskip\noindent
Proof of (3). We use induction on the length of the complete
d\'evissage. First we apply
Lemma \ref{lemma-shrink} (\ref{item-shrink-on-X})
to find a standard shrinking
$S', X', Z'_1, Y'_1$ 
of the one step d\'evissage of $\mathcal{F}/X/S$ at $x$
with $X' \subset U$. If $n = 1$, then we are done.
If $n > 1$, then by induction we can find a standard shrinking
$S''$, $Y''_1$, $Z''_k$, and $Y''_k$ of the complete d\'evissage
$(Z_k, Y_k, i_k, \pi_k, \mathcal{G}_k, \alpha_k, z_k, y_k)_{k = 2, \ldots, n}$
of $\text{Coker}(\alpha_1)/Y_1/S$ at $x$ such that
$Y''_1 \subset Y'_1$. Using
Lemma \ref{lemma-shrink} (\ref{item-shrink-on-Y})
we can find $S''' \subset S'$, $X''' \subset X'$, $Z'''_1$ and
$Y'''_1 = Y''_1 \times_S S'''$ which is a standard shrinking.
The solution to our problem is to take
$$
S''', X''', Z'''_1, Y'''_1, Z''_2 \times_S S''',
Y''_2 \times_S S''', \ldots, Z''_n \times_S S''', Y''_n \times_S S'''
$$
This ends the proof of the lemma.
\end{proof}

\begin{proposition}
\label{proposition-existence-complete-at-x}
Let $S$ be a scheme.
Let $X$ be locally of finite type over $S$.
Let $x \in X$ be a point with image $s \in S$.
There exists a commutative diagram
$$
\xymatrix{
(X, x) \ar[d] & (X', x') \ar[l]^g \ar[d] \\
(S, s) & (S', s') \ar[l]
}
$$
of pointed schemes such that the horizontal
arrows are elementary \'etale neighbourhoods
and such that $g^*\mathcal{F}/X'/S'$ has a complete
d\'evissage at $x$.
\end{proposition}

\begin{proof}
We prove this by induction on the integer
$d = \dim_x(\text{Supp}(\mathcal{F}_s))$.
By
Lemma \ref{lemma-elementary-devissage-variant}
there exists a diagram
$$
\xymatrix{
(X, x) \ar[d] & (X', x') \ar[l]^g \ar[d] \\
(S, s) & (S', s') \ar[l]
}
$$
of pointed schemes such that the horizontal
arrows are elementary \'etale neighbourhoods
and such that $g^*\mathcal{F}/X'/S'$ has a one step
d\'evissage $(Z_1, Y_1, i_1, \pi_1, \mathcal{G}_1)$ at $x'$.
By
Lemma \ref{lemma-existence-alpha}
we can find a map
$$
\alpha_1 :
\mathcal{O}_{Y_1}^{\oplus r_1}
\longrightarrow
\pi_{1, *}\mathcal{G}_1
$$
which induces an isomorphism of vector spaces over $\kappa(\xi_1)$
where $\xi_1 \in Y_1$ is the unique generic point of the fibre of
$Y_1$ over $s'$. Moreover, we know that
$\dim_{y_1}(\text{Supp}(\text{Coker}(\alpha_1)_{s'})) < d$.
It may happen that the stalk of $\text{Coker}(\alpha_1)_{s'}$
at $y_1$ is zero. In this case we may shrink $Y_1$ (by
Lemma \ref{lemma-shrink} (\ref{item-shrink-on-Y})
and assume that $\text{Coker}(\alpha_1) = 0$.





\end{proof}



\section{Localization and universally injective maps}
\label{section-localize-universally-injective}


\begin{lemma}
\label{lemma-homothety-spectrum}
Let $R \to S$ be a ring map.
Let $M$ be a $S$-module.
Assume
\begin{enumerate}
\item $R$ is a local ring with maximal ideal $\mathfrak m$,
\item $\overline{S} = S/\mathfrak m S$ is Noetherian, and
\item $\overline{M} = M/\mathfrak m_R M$ is a finite $\overline{S}$-module.
\end{enumerate}
Let $\Sigma \subset S$ be the multiplicative subset of elements which are not
a zero divisor on $\overline{M}$. Then $\Sigma^{-1}S$ is a semi-local ring
whose spectrum consists of primes $\mathfrak q \subset S$ contained in an
element of $\text{Ass}_S(\overline{M})$. Moreover, any maximal
ideal of $\Sigma^{-1}S$ corresponds to an associated prime of
$\overline{M}$ over $\overline{S}$.
\end{lemma}

\begin{proof}
Note that
$\text{Ass}_S(\overline{M}) = \text{Ass}_{\overline{S}}(\overline{M})$, see
Algebra, Lemma \ref{algebra-lemma-ass-quotient-ring}.
This is a finite set by
Algebra, Lemma \ref{algebra-lemma-finite-ass}.
Say $\{\mathfrak q_1, \ldots, \mathfrak q_r\} = \text{Ass}_S(\overline{M})$.
We have $\Sigma = S \setminus (\bigcup \mathfrak q_i)$ by
Algebra, Lemma \ref{algebra-lemma-ass-zero-divisors}.
By the description of $\text{Spec}(\Sigma^{-1}S)$ in
Algebra, Lemma \ref{algebra-lemma-spec-localization}
we see that the primes of $\Sigma^{-1}S$ correspond to the primes of
$S$ contained in one of the $\mathfrak q_i$.
Hence the maximal ideals of $\Sigma^{-1}S$ correspond one-to-one with the
maximal (w.r.t.\ inclusion) elements of the set
$\{\mathfrak q_1, \ldots, \mathfrak q_r\}$. This proves the lemma.
\end{proof}

\begin{lemma}
\label{lemma-homothety-universally-injective}
Assumption and notation as in
Lemma \ref{lemma-homothety-spectrum}.
Assume moreover that
\begin{enumerate}
\item $S$ is local and $R \to S$ is a local homomorphism,
\item $S$ is essentially of finite presentation over $R$,
\item $M$ is finitely presented over $S$, and
\item $M$ is flat over $R$.
\end{enumerate}
Then each $s \in \Sigma$ defines a
universally injective $R$-module map $s : M \to M$, and the
map $M \to \Sigma^{-1}M$ is $R$-universally injective.
\end{lemma}

\begin{proof}
By
Algebra, Lemma \ref{algebra-lemma-mod-injective-general}
the sequence $0 \to M \to M \to M/sM \to 0$ is exact and
$M/sM$ is flat over $R$. This implies that $s : M \to M$
is universally injective, see
Algebra, Lemma \ref{algebra-lemma-flat-tor-zero}.
The map $M \to \Sigma^{-1}M$ is universally injective as the directed
colimit of the maps $s : M \to M$.
\end{proof}

\begin{lemma}
\label{lemma-base-change-universally-flat-local}
Let $R \to S$ be a ring map.
Let $M$ be an $S$-module.
Let $S \to S'$ be a ring map.
Assume
\begin{enumerate}
\item $R \to S$ is a local homomorphism of local rings
\item $S$ is essentially of finite presentation over $R$,
\item $M$ is of finite presentation over $S$,
\item $M$ is flat over $R$,
\item $S \to S'$ is flat, and
\item the image of $\text{Spec}(S') \to \text{Spec}(S)$ contains
all primes $\mathfrak q$ of $S$ lying over $\mathfrak m_R$
such that $\mathfrak q$ is an associated prime of $M/\mathfrak m_R M$.
\end{enumerate}
Then $M \to M \otimes_R S'$ is $R$-universally injective.
\end{lemma}

\begin{proof}
Set $M' = M \otimes_R S'$. Consider the commutative diagram
$$
\xymatrix{
M \ar[d] \ar[r] & M' \ar[d] \\
\Sigma^{-1}M \ar[r] & \Sigma^{-1}M'
}
$$
where $\Sigma \subset S$ is the set of elements which are not a
zero divisor on $M/\mathfrak m_R M$. If we can show that the map
$M \to \Sigma^{-1}M'$ is universally injective, then $M \to M'$
is too (see
Algebra, Lemma \ref{algebra-lemma-universally-injective-permanence}).

\medskip\noindent
By
Lemma \ref{lemma-homothety-spectrum}
the ring $\Sigma^{-1}S$ is a semi-local ring whose maximal ideals
correspond to associated primes of $M/\mathfrak m_R M$.
Hence the image of
$\text{Spec}(\Sigma^{-1}S') \to \text{Spec}(\Sigma^{-1}S)$
contains all these maximal ideals by assumption. By
Algebra, Lemma \ref{algebra-lemma-ff-rings}
the ring map $\Sigma^{-1}S \to \Sigma^{-1}S'$ is faithfully flat.
Hence $\Sigma^{-1}M \to \Sigma^{-1}M'$, which is the map
$$
M \otimes_S \Sigma^{-1}S \longrightarrow M \otimes_S \Sigma^{-1}S'
$$
is universally injective, see
Algebra, Lemmas \ref{algebra-lemma-faithfully-flat-universally-injective} and
\ref{algebra-lemma-universally-injective-tensor}.
Finally, we apply
Lemma \ref{lemma-homothety-universally-injective}
to see that $M \to \Sigma^{-1}M$ is universally injective.
As the composition of universally injective module maps is universally
injective (see
Algebra, Lemma \ref{algebra-lemma-composition-universally-injective})
we conclude that $M \to \Sigma^{-1}M'$ is universally injective and we win.
\end{proof}

\begin{lemma}
\label{lemma-base-change-universally-flat}
Let $R \to S$ be a ring map.
Let $M$ be an $S$-module.
Let $S \to S'$ be a ring map.
Assume
\begin{enumerate}
\item $R \to S$ is of finite presentation and $M$ is of finite presentation
over $S$,
\item $M$ is flat over $R$,
\item $S \to S'$ is flat, and
\item the image of $\text{Spec}(S') \to \text{Spec}(S)$ contains
all primes $\mathfrak q$ such that $\mathfrak q$ is an associated prime
of $M \otimes_R \kappa(\mathfrak p)$ where $\mathfrak p$ is the inverse
image of $\mathfrak q$ in $R$.
\end{enumerate}
Then $M \to M \otimes_R S'$ is $R$-universally injective.
\end{lemma}

\begin{proof}
By
Algebra, Lemma \ref{algebra-lemma-universally-injective-check-stalks}
it suffices to show that $M_{\mathfrak q} \to (M \otimes_R S')_{\mathfrak q}$
is a $R_{\mathfrak p}$-universally injective for any prime $\mathfrak q$
of $S$ lying over $\mathfrak p$ in $R$. Thus we may apply
Lemma \ref{lemma-base-change-universally-flat-local}
to the ring maps
$R_{\mathfrak p} \to S_{\mathfrak q} \to S'_{\mathfrak q}$
and the module $M_{\mathfrak q}$.
\end{proof}

\noindent
The reader may want to compare the following lemma to
Algebra, Lemma \ref{algebra-lemma-mod-injective} and
Lemma \ref{algebra-lemma-mod-injective-general}.
In each case the conclusion is that the map $u : M \to N$ is
universally injective with flat cokernel.

\begin{lemma}
\label{lemma-universally-injective-local}
Let $(R, \mathfrak m)$ be a local ring. Let $u : M \to N$ be an $R$-module map.
If $M$ is a projective $R$-module, $N$ is a flat $R$-module, and
$\overline{u} : M/\mathfrak mM \to N/\mathfrak mN$ is injective
then $u$ is universally injective.
\end{lemma}

\begin{proof}
By
Algebra, Theorem \ref{algebra-theorem-projective-free-over-local-ring}
the module $M$ is free. If we show the result holds for every finitely
generated direct summand of $M$, then the lemma follows. Hence we may
assume that $M$ is finite free. Write $N = \text{colim}_i\ M_i$ as
a directed colimit of finite free modules, see
Algebra, Theorem \ref{algebra-theorem-lazard}.
Note that $u : M \to N$ factors through $N_i$ for some $i$ (as $M$ is finite
free). Denote $u_i : M \to N_i$ the corresponding $R$-module map.
As $\overline{u}$ is injective we see that
$\overline{u_i} : M/\mathfrak mM \to N_i/\mathfrak mN_i$ is
injective and remains injective on composing with the maps
$N_i/\mathfrak mN_i \to N_{i'}/\mathfrak mN_{i'}$ for all $i' \geq i$.
As $M$ and $N_{i'}$ are finite free over the local ring $R$ this implies
that $M \to N_{i'}$ is a split injection for all $i' \geq i$. Hence
for any $R$-module $Q$ we see that $M \otimes_R Q \to N_{i'} \otimes_R Q$
is injective for all $i' \geq i$. As $- \otimes_R Q$ commutes with
colimits we conclude that $M \otimes_R Q \to N_{i'} \otimes_R Q$
is injective as desired.
\end{proof}

\begin{lemma}
\label{lemma-invert-universally-injective}
Assumption and notation as in
Lemma \ref{lemma-homothety-spectrum}.
Assume moreover that $M$ is projective as an $R$-module.
Then each $s \in \Sigma$ defines a
universally injective $R$-module map $s : M \to M$, and the
map $M \to \Sigma^{-1}M$ is $R$-universally injective.
\end{lemma}

\begin{proof}
Pick $s \in \Sigma$. By
Lemma \ref{lemma-universally-injective-local}
the map $s : M \to M$ is universally injective.
The map $M \to \Sigma^{-1}M$ is universally injective as the directed
colimit of the maps $s : M \to M$.
\end{proof}






\section{Completion and Mittag-Leffler modules}
\label{section-completion-ML}

\begin{lemma}
\label{lemma-universally-injective-completion-direct-sum-into-product}
Let $R$ be a ring.
Let $I \subset R$ be an ideal.
Let $A$ be a set.
Assume $R$ is Noetherian and complete with respect to $I$. Then
$$
\left(\bigoplus\nolimits_{\alpha \in A} R\right)^\wedge
\longrightarrow
\prod\nolimits_{\alpha \in A} R
$$
of the $I$-adic completion of the direct sum into the
direct product is universally injective.
\end{lemma}

\begin{proof}
By definition an element $x$ of the left hand side is $x = (x_n)$ where
$x_n = (x_{n, \alpha}) \in \bigoplus\nolimits_{\alpha \in A} R/I^n$
such that $x_{n, \alpha} = x_{n + 1, \alpha} \bmod I^n$. 
As $R = R^\wedge$ we see that for any $\alpha$ there exists a $y_\alpha \in R$
such that $x_{n, \alpha} = y_\alpha \bmod I^n$. Note that for each $n$ there
are only finitely many $\alpha$ such that the elements $x_{n, \alpha}$ are
nonzero. Conversely, given $(y_\alpha) \in \prod_\alpha R$ such that for each
$n$ there are only finitely many $\alpha$ such that $y_{\alpha} \bmod I^n$
is nonzero, then this defines an element of the left hand side.
Hence we can think of an element of the left hand side as infinite
``convergent sums'' $\sum_\alpha y_\alpha$ with $y_\alpha \in R$
such that for each $n$ there are only finitely many $y_\alpha$
which are nonzero modulo $I^n$. The displayed map maps this element
to the element to $(y_\alpha)$ in the product.
In particular the map is injective.

\medskip\noindent
Let $Q$ be a finite $R$-module. We have to show that the map
$$
Q \otimes_R \left(\bigoplus\nolimits_{\alpha \in A} R\right)^\wedge
\longrightarrow
Q \otimes_R \left(\prod\nolimits_{\alpha \in A} R\right)
$$
is injective, see
Algebra, Theorem \ref{algebra-theorem-universally-exact-criteria}.
Choose a presentation $R^{\oplus k} \to R^{\oplus m} \to Q \to 0$
and denote $q_1, \ldots, q_m \in Q$ the corresponding generators for $Q$.
By Artin-Rees
(Algebra, Lemma \ref{algebra-lemma-Artin-Rees})
there exists a constant $c$ such that
$\text{Im}(R^{\oplus k} \to R^{\oplus m}) \cap (I^N)^{\oplus m}
\subset \text{Im}((I^{N - c})^{\oplus k} \to R^{\oplus m})$.
Let us contemplate the diagram
$$
\xymatrix{
\bigoplus_{l = 1}^k \left(\bigoplus\nolimits_{\alpha \in A} R\right)^\wedge
\ar[r] \ar[d] &
\bigoplus_{j = 1}^m \left(\bigoplus\nolimits_{\alpha \in A} R\right)^\wedge
\ar[r] \ar[d] &
Q \otimes_R \left(\bigoplus\nolimits_{\alpha \in A} R\right)^\wedge
\ar[r] \ar[d] &
0 \\
\bigoplus_{l = 1}^k \left(\prod\nolimits_{\alpha \in A} R\right)
\ar[r] &
\bigoplus_{j = 1}^m \left(\prod\nolimits_{\alpha \in A} R\right)
\ar[r] &
Q \otimes_R \left(\prod\nolimits_{\alpha \in A} R\right)
\ar[r] &
0
}
$$
with exact rows. Pick an element $\sum_j \sum_\alpha y_{j, \alpha}$ of
$\bigoplus_{j = 1, \ldots, m}
\left(\bigoplus\nolimits_{\alpha \in A} R\right)^\wedge$.
If this element maps to zero in the module
$Q \otimes_R \left(\prod\nolimits_{\alpha \in A} R\right)$,
then we see in particular that
$\sum_j q_j \otimes y_{j, \alpha} = 0$ in $Q$ for each $\alpha$.
Thus we can find an element
$(z_{1, \alpha}, \ldots, z_{k, \alpha}) \in \bigoplus_{l = 1, \ldots, k} R$
which maps to
$(y_{1, \alpha}, \ldots, y_{m, \alpha}) \in \bigoplus_{j = 1, \ldots, m} R$.
Moreover, if $y_{j, \alpha} \in I^{N_\alpha}$ for $j = 1, \ldots, m$, then
we may assume that $z_{l, \alpha} \in I^{N_\alpha - c}$ for
$l = 1, \ldots, k$.
Hence the sum $\sum_l \sum_\alpha z_{l, \alpha}$ is ``convergent'' and
defines an element of
$\bigoplus_{l = 1, \ldots, k}
\left(\bigoplus\nolimits_{\alpha \in A} R\right)^\wedge$
which maps to the element $\sum_j \sum_\alpha y_{j, \alpha}$ we started
out with. Thus the right vertical arrow is injective and we win.
\end{proof}

\begin{lemma}
\label{lemma-completed-direct-sum-ML}
Let $R$ be a ring. Let $I \subset R$ be an ideal. Let $A$ be a set.
Assume $R$ is Noetherian and complete with respect to $I$. The completion
$\left(\bigoplus\nolimits_{\alpha \in A} R\right)^\wedge$
is flat and Mittag-Leffler.
\end{lemma}

\begin{proof}
By
Lemma \ref{lemma-universally-injective-completion-direct-sum-into-product}
the map $\left(\bigoplus\nolimits_{\alpha \in A} R\right)^\wedge
\to \prod_{\alpha \in A} R$ is universally injective.
Thus, by
Algebra, Lemmas \ref{algebra-lemma-ui-flat-domain} and
\ref{algebra-lemma-pure-submodule-ML}
it suffices to show that $\prod_{\alpha \in A} R$ is flat and Mittag-Leffler.
By
Algebra, Proposition \ref{algebra-proposition-characterize-coherent}
(and
Algebra, Lemma \ref{algebra-lemma-Noetherian-coherent})
we see that $\prod_{\alpha \in A} R$ is flat.
Thus we conclude because a product of copies of $R$ is Mittag-Leffler, see
Algebra, Lemma \ref{algebra-lemma-product-over-Noetherian-ring}.
\end{proof}

\begin{lemma}
\label{lemma-lift-ML}
Let $R$ be a ring.
Let $I \subset R$ be an ideal.
Let $R \to S$ be a ring map, and $M$ an $S$-module.
Assume
\begin{enumerate}
\item $R$ is Noetherian and $I$-adically complete,
\item $R \to S$ is of finite type,
\item $M$ is a finite $S$-module,
\item $M$ is flat over $R$, and
\item $M/IM$ is a projective $R/I$-module.
\end{enumerate}
Then the $I$-adic completion $M^\wedge$ is a flat Mittag-Leffler
$R$-module.
\end{lemma}

\begin{proof}
We may write $S$ as a quotient of $R[x_1, \ldots, x_n]$, hence
we may assume $S = R[x_1, \ldots, x_n]$. Choose a surjection
$S^{\oplus m} \to M$. By
Algebra, Lemma \ref{algebra-lemma-split-completed-sequence}
the module $M^\wedge$ is a direct summand of the module
$(S^{\oplus m})^\wedge$. Hence it suffices to prove the lemma
in case $M = S = R[x_1, \ldots, x_n] \cong \bigoplus_{n \in \mathbf{N}} R$.
In this case the lemma follows from
Lemma \ref{lemma-completed-direct-sum-ML}.
\end{proof}

\begin{lemma}
\label{lemma-universally-injective-to-completion}
Let $R$ be a ring.
Let $I \subset R$ be an ideal.
Let $R \to S$ be a ring map, and $M$ an $S$-module.
Assume
\begin{enumerate}
\item $R$ is Noetherian,
\item $R \to S$ is of finite type,
\item $M$ is a finite $S$-module, and
\item for any finite $R$-module $Q$, any
$\mathfrak q \in \text{Ass}_S(Q \otimes_R M)$
satisfies $IS + \mathfrak q \not = S$.
\end{enumerate}
Then the map $M \to M^\wedge$ of $M$ into the $I$-adic completion of $M$
is universally injective as a map of $R$-modules.
\end{lemma}

\begin{proof}
We have to show that for any finite $R$-module $Q$ the map
$Q \otimes_R M \to Q \otimes_R M^\wedge$ is injective, see
Algebra, Theorem \ref{algebra-theorem-universally-exact-criteria}.
As there is a canonical map $Q \otimes_R M^\wedge \to (Q \otimes_R M)^\wedge$
it suffices to prove that the canonnical map
$Q \otimes_R M \to (Q \otimes_R M)^\wedge$ is injective.
Hence we may replace $M$ by $Q \otimes_R M$ and it suffices to prove the
injectivity for the map $M \to M^\wedge$.

\medskip\noindent
The ring $S$ is Noetherian, see
Algebra, Lemma \ref{algebra-lemma-Noetherian-permanence}.
The module $M^\wedge = \lim M/I^nM$ is also the $IS$-adic completion of $M$.
The kernel of the map is the module $K = \bigcap I^nM$.
For any prime $\mathfrak q$ of $S$ we have
$K_{\mathfrak q} \subset \bigcap I^nM_{\mathfrak q}$.
Let $\mathfrak q$ be an associated prime of $M$.
By the last assumption we see that there exists a prime
$\mathfrak q' \supset IS + \mathfrak q$. By the above and
Algebra, Lemma \ref{algebra-lemma-intersect-powers-ideal-module-zero}
we have $K_{\mathfrak q'} = 0$ which implies that $K_{\mathfrak q} = 0$.
Hence $K = 0$ as $M$ is a submodule of
$\prod_{\mathfrak q \in \text{Ass}(M)} M_{\mathfrak q}$, see
Algebra, Lemma \ref{algebra-lemma-zero-at-ass-zero}.
\end{proof}

\begin{lemma}
\label{lemma-universally-injective-to-completion-flat}
Let $R$ be a ring.
Let $I \subset R$ be an ideal.
Let $R \to S$ be a ring map, and $M$ an $S$-module.
Assume
\begin{enumerate}
\item $R$ is Noetherian,
\item $R \to S$ is of finite type,
\item $M$ is a finite $S$-module,
\item $M$ is flat over $R$, and
\item for any prime $\mathfrak q$ of $S$, lying over any $\mathfrak p$ in $R$
such that $\mathfrak q$ is an associated prime of
$M \otimes_R \kappa(\mathfrak p)$ we have $IS + \mathfrak q \not = S$.
\end{enumerate}
Then the map $M \to M^\wedge$ of $M$ into the $I$-adic completion of $M$
is universally injective as a map of $R$-modules.
\end{lemma}

\begin{proof}
This follows from
Lemma \ref{lemma-universally-injective-to-completion}
because
Algebra, Lemma \ref{algebra-lemma-bourbaki-fibres}
and
Remark \ref{algebra-remark-bourbaki}
guarantee that the set of associated primes of tensor products
$M \otimes_R Q$ are contained in the set of associated primes of
the modules $M \otimes_R \kappa(\mathfrak p)$.
\end{proof}




\section{Projective modules}
\label{section-projective}

\noindent
The following lemma can be used to prove projectivity by
Noetherian induction on the base, see
Lemma \ref{lemma-fibres-irreducible-flat-projective}.

\begin{lemma}
\label{lemma-flat-pure-over-complete-projective}
Let $R$ be a ring.
Let $I \subset R$ be an ideal.
Let $R \to S$ be a ring map, and $M$ an $S$-module.
Assume
\begin{enumerate}
\item $R$ is Noetherian and $I$-adically complete,
\item $R \to S$ is of finite type,
\item $M$ is a finite $S$-module,
\item $M$ is flat over $R$,
\item $M/IM$ is projective as a $R/I$-module, and
\item for any prime $\mathfrak q$ of $S$, lying over any $\mathfrak p$ in $R$
such that $\mathfrak q$ is an associated prime of
$M \otimes_R \kappa(\mathfrak p)$ we have $IS + \mathfrak q \not = S$.
\end{enumerate}
Then $M$ is projective as an $R$-module.
\end{lemma}

\begin{proof}
By
Lemma \ref{lemma-universally-injective-to-completion-flat}
the map $M \to M^\wedge$ is universally injective.
By
Lemma \ref{lemma-lift-ML}
the module $M^\wedge$ is Mittag-Leffler.
By
Algebra, Lemma \ref{algebra-lemma-pure-submodule-ML}
we conclude that $M$ is Mittag-Leffler.
Hence $M$ is countably generated, flat and Mittag-Leffler as an $R$-module,
whence projective by
Algebra, Lemma \ref{algebra-lemma-countgen-projective}.
\end{proof}

\begin{lemma}
\label{lemma-fibres-irreducible-flat-projective}
Let $R$ be a ring.
Let $R \to S$ be a ring map.
Assume
\begin{enumerate}
\item $R$ is Noetherian,
\item $R \to S$ is of finite type and flat, and
\item every fibre ring $S \otimes_R \kappa(\mathfrak p)$ is
geometrically integral over $\kappa(\mathfrak p)$.
\end{enumerate}
Then $S$ is projective as an $R$-module.
\end{lemma}

\begin{proof}
Consider the set
$$
\{I \subset R \mid S/IS\text{ not projective as }R/I\text{-module}\}
$$
We have to show this set is empty. To get a contradiction assume it is
nonempty. Then it contains a maximal element $I$.
Let $J = \sqrt{I}$ be its radical. If $I \not = J$, then
$S/JS$ is projective as a $R/J$-module, and $S/IS$ is flat over $R/I$
and $J/I$ is a nilpotent ideal in $R/I$. Applying
Algebra, Lemma \ref{algebra-lemma-lift-projective}
we see that $S/IS$ is a projective $R/I$-module, which is a contradiction.
Hence we may assume that $I$ is a radical ideal. In other words we
are reduced to proving the lemma in case $R$ is a reduced ring and
$S/IS$ is a projective $R/I$-module for every nonzero ideal $I$
of $R$.

\medskip\noindent
Assume $R$ is a reduced ring and $S/IS$ is a projective $R/I$-module
for every nonzero ideal $I$ of $R$. By generic flatness,
Algebra, Lemma \ref{algebra-lemma-generic-flatness-Noetherian}
(applied to a localization $R_g$ which is a domain) or the more general
Algebra, Lemma \ref{algebra-lemma-generic-flatness-reduced}
there exists a nonzero $f \in R$ such that $S_f$ is free as an
$R_f$-module. Denote $R^\wedge = \lim R/(f^n)$ the $(f)$-adic completion
of $R$. Note that the ring map
$$
R \longrightarrow R_f \times R^\wedge
$$
is a faithfully flat ring map, see
Algebra, Lemma \ref{algebra-lemma-completion-flat}.
Hence by faithfully flat descent of projectivity, see
Algebra, Theorem \ref{algebra-theorem-ffdescent-projectivity}
it suffices to prove that $S \otimes_R R^\wedge$ is a projective
$R^\wedge$-module. To see this we will use the criterion of
Lemma \ref{lemma-fibres-irreducible-flat-projective}.
First of all, note that $S/fS = (S \otimes_R R^\wedge)/f(S \otimes_R R^\wedge)$
is a projective $R/(f)$-module and that $S \otimes_R R^\wedge$ is flat
and of finite type over $R^\wedge$ as a base change of such.
Next, suppose that $\mathfrak p^\wedge$ is a prime ideal
of $R^\wedge$. Let $\mathfrak p \subset R$ be the corresponding prime
of $R$. As $R \to S$ has geometrically integral fibre rings, the
same is true for the fibre rings of any base change. Hence
$\mathfrak q^\wedge = \mathfrak p^\wedge(S \otimes_R R^\wedge)$,
is a prime ideals lying over $\mathfrak p^\wedge$
and it is the unique associated prime of
$S \otimes_R \kappa(\mathfrak p^\wedge)$. Thus we win if
$f(S \otimes_R R^\wedge) + \mathfrak q^\wedge \not = S \otimes_R R^\wedge$.
This is true because $\mathfrak p^\wedge + fR^\wedge \not = R^\wedge$
as $f$ lies in the radical of the $f$-adically complete ring $R^\wedge$
and because $R^\wedge \to S \otimes_R R^\wedge$ is surjective on spectra
as its fibres are nonempty (irreducible spaces are nonempty).
\end{proof}

\begin{lemma}
\label{lemma-fibres-irreducible-flat-projective-nonnoetherian}
Let $R$ be a ring. Let $R \to S$ be a ring map.
Assume
\begin{enumerate}
\item $R \to S$ is of finite presentation and flat, and
\item every fibre ring $S \otimes_R \kappa(\mathfrak p)$ is
geometrically integral over $\kappa(\mathfrak p)$.
\end{enumerate}
Then $S$ is projective as an $R$-module.
\end{lemma}

\begin{proof}
We can find a cocartesian diagram of rings
$$
\xymatrix{
S_0 \ar[r] & S \\
R_0 \ar[u] \ar[r] & R \ar[u]
}
$$
such that $R_0$ is of finite type over $\mathbf{Z}$, the map
$R_0 \to S_0$ is of finite type and flat with geometrically integral
fibres, see
More on Morphisms,
Lemmas \ref{more-morphisms-lemma-Noetherian-approximation-flat},
\ref{more-morphisms-lemma-Noetherian-approximation-geometrically-reduced},
\ref{more-morphisms-lemma-Noetherian-approximation-geometrically-irreducible},
and \ref{more-morphisms-lemma-Noetherian-approximation-combine}.
By
Lemma \ref{lemma-fibres-irreducible-flat-projective}
we see that $S_0$ is a projective $R_0$-module. Hence $S = S_0 \otimes_{R_0} R$
is a projective $R$-module, see
Algebra, Lemma \ref{algebra-lemma-ascend-properties-modules}.
\end{proof}

\begin{remark}
\label{remark-how-in-RG}
Lemma \ref{lemma-fibres-irreducible-flat-projective-nonnoetherian}
is a key step in the development of results in this chapter. The analogue
of this lemma in \cite{GruRay} is \cite[I Proposition 3.3.1]{GruRay}:
If $R \to S$ is smooth with geometrically integral fibres, then $S$
is projective as an $R$-module. This is a special case of
Lemma \ref{lemma-fibres-irreducible-flat-projective-nonnoetherian},
but as we will later improve on this lemma anyway, we do not gain much
from having a stronger result at this point.
We briefly sketch the proof of this as it is given in \cite{GruRay}.
\begin{enumerate}
\item First reduce to the case where $R$ is Noetherian as above.
\item Since projectivity descends through faithfully flat ring maps, see
Algebra, Theorem \ref{algebra-theorem-ffdescent-projectivity}
we may work locally in the fppf topology on $R$, hence we may assume
that $R \to S$ has a section $\sigma : S \to R$. (Just by the usual trick of
base changing to $S$.) Set $I = \text{Ker}(S \to R)$.
\item Localizing a bit more on $R$ we may assume that $I/I^2$ is a free
$R$-module and that the completion $S^\wedge$ of $S$ with respect to $I$
is isomorphic to $R[[t_1, \ldots, t_n]]$, see
Morphisms, Lemma \ref{morphisms-lemma-section-smooth-morphism}.
Here we are using that $R \to S$ is smooth.
\item To prove that $S$ is projective as an $R$-module, it suffices to
prove that $S$ is flat, countably generated and Mittag-Leffler as an
$R$-module, see
Algebra, Lemma \ref{algebra-lemma-countgen-projective}.
The first two properties are evident. Thus it suffices to prove that $S$
is Mittag-Leffler as an $R$-module. By
Algebra, Lemma \ref{algebra-lemma-power-series-ML}
the module $R[[t_1, \ldots, t_n]]$ is Mittag-Leffler over $R$. Hence
Algebra, Lemma \ref{algebra-lemma-pure-submodule-ML}
shows that it suffices to show that the
$S \to S^\wedge$ is universally injective as a map of $R$-modules.
\item Apply
Lemma \ref{lemma-base-change-universally-flat}
to see that $S \to S^\wedge$ is $R$-universally injective.
Namely, as $R \to S$ has geometrically integral fibres, any associated
point of any fibre ring is just the generic point of the fibre ring which
is in the image of $\text{Spec}(S^\wedge) \to \text{Spec}(S)$.
\end{enumerate}
There is an analogy between the proof as sketched just now, and the
development of the arguments leading to the proof of
Lemma \ref{lemma-fibres-irreducible-flat-projective-nonnoetherian}.
In both a completion plays an essential role, and both times the
assumption of having geometrically integral fibres assures one that the
map from $S$ to the completion of $S$ is $R$-universally injective.
\end{remark}













\section{Flat finite type modules}
\label{section-finite-type-flat}

\noindent
In some cases given a ring map $R \to S$ of finite presentation and
a finite $S$-module $N$ the flatness of $N$ over $R$ implies that $N$
is of finite presentation. In this section we collect a few results
of this nature.

\begin{lemma}
\label{lemma-induction-step}
Let $(R, \mathfrak m)$ be a local ring. Let $R \to S$ be a finitely presented
flat ring map with geometrically integral fibres. Write
$\mathfrak p = \mathfrak mS$. Let $\mathfrak q \subset S$ be a prime ideal
lying over $\mathfrak m$. Let $N$ be a finite $S$-module.
There exists $r \geq 0$ and an $S$-module map
$$
\alpha : S^{\oplus r} \longrightarrow N
$$
such that
$\alpha : \kappa(\mathfrak p)^{\oplus r} \to N \otimes_S \kappa(\mathfrak p)$
is an isomorphism. For any such $\alpha$ the following are equivalent:
\begin{enumerate}
\item $N_{\mathfrak q}$ is $R$-flat,
\item $\alpha$ is $R$-universally injective and
$\text{Coker}(\alpha)_{\mathfrak q}$ is $R$-flat,
\item $\alpha$ is injective and
$\text{Coker}(\alpha)_{\mathfrak q}$ is $R$-flat,
\item $\alpha_{\mathfrak p}$ is an isomorphism and
$\text{Coker}(\alpha)_{\mathfrak q}$ is $R$-flat, and
\item $\alpha_{\mathfrak q}$ is injective and
$\text{Coker}(\alpha)_{\mathfrak q}$ is $R$-flat.
\end{enumerate}
\end{lemma}

\begin{proof}
To obtain $\alpha$ set
$r = \dim_{\kappa(\mathfrak p)} N \otimes_S \kappa(\mathfrak p)$ and pick
$x_1, \ldots, x_r \in N$ which form a basis of
$N \otimes_S \kappa(\mathfrak p)$. Define
$\alpha(s_1, \ldots, s_r) = \sum s_i x_i$. This proves the existence.

\medskip\noindent
Fix an $\alpha$. The most interesting implication is
(1) $\Rightarrow$ (2) which we prove first. Assume (1).
Because $S/\mathfrak mS$ is a domain with fraction field $\kappa(\mathfrak p)$
we see that
$(S/\mathfrak mS)^{\oplus r} \to
N_{\mathfrak p}/\mathfrak mN_{\mathfrak p} = N \otimes_S \kappa(\mathfrak p)$
is injective. Hence by
Lemmas \ref{lemma-universally-injective-local} and
\ref{lemma-fibres-irreducible-flat-projective-nonnoetherian}.
the map $S^{\oplus r} \to N_{\mathfrak p}$ is $R$-universally injective.
It follows that $S^{\oplus r} \to N$ is $R$-universally injective, see
Algebra, Lemma \ref{algebra-lemma-universally-injective-permanence}.
Then also the localization $\alpha_{\mathfrak q}$ is $R$-universally
injective, see
Algebra, Lemma \ref{algebra-lemma-universally-injective-localize}.
We conclude that $\text{Coker}(\alpha)_{\mathfrak q}$ is $R$-flat by
Algebra, Lemma \ref{algebra-lemma-ui-flat-domain}.

\medskip\noindent
The implication (2) $\Rightarrow$ (3) is immediate. If (3) holds, then
$\alpha_{\mathfrak p}$ is injective as a localization of an injective
module map. By Nakayama's lemma
(Algebra, Lemma \ref{algebra-lemma-NAK})
$\alpha_{\mathfrak p}$ is surjective too. Hence (3) $\Rightarrow$ (4).
If (4) holds, then $\alpha_{\mathfrak p}$ is an isomorphism, so
$\alpha$ is injective as $S_{\mathfrak q} \to S_{\mathfrak p}$ is injective.
Namely, elements of $S \setminus \mathfrak p$ are nonzero divisors on $S$
by a combination of
Lemmas \ref{lemma-invert-universally-injective} and
\ref{lemma-fibres-irreducible-flat-projective-nonnoetherian}.
Hence (4) $\Rightarrow$ (5). Finally, if (5) holds, then
$N_{\mathfrak q}$ is $R$-flat as an extension of flat modules, see
Algebra, Lemma \ref{algebra-lemma-flat-ses}.
Hence (5) $\Rightarrow$ (1) and the proof is finished.
\end{proof}

\begin{proposition}
\label{proposition-finite-type-flat-at-point}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{F}$ be a quasi-coherent sheaf on $X$.
Let $x \in X$ with image $s \in S$.
Assume that
\begin{enumerate}
\item $f$ is locally of finite presentation,
\item $\mathcal{F}$ is of finite type, and
\item $\mathcal{F}$ is flat at $x$ over $S$.
\end{enumerate}
Then there exists an elementary \'etale neighbourhood $(S', s') \to (S, s)$
and an open subscheme
$$
V \subset X' = X \times_S \text{Spec}(\mathcal{O}_{S', s'})
$$
which contains the unique point of $X'$ mapping to $x$
such that the pullback of $\mathcal{F}$ to $V$ is an $\mathcal{O}_V$-module
of finite presentation and flat over $\mathcal{O}_{S', s'}$.
\end{proposition}

\begin{proof}
The problem is local around $x$ and $s$, hence we may assume that $X$
and $S$ are affine. During the proof we will finitely many times replace
$S$ by an elementary \'etale neighbourhood of $(S, s)$. The goal is then to find
(after such a replacement) an open
$V \subset X \times_S \text{Spec}(\mathcal{O}_{S, s})$
such that $\mathcal{F}|_V$ is flat over $S$ and finitely presented.
Hence it is clear that we may also assume that $S$ is a local scheme, i.e.,
the spectrum of a local ring.
We will prove the lemma by induction on the integer
$n = \dim_x(\text{Supp}(\mathcal{F}_s))$.

\medskip\noindent
We can choose
\begin{enumerate}
\item elementary \'etale neighbourhoods $g : (X', x') \to (X, x)$,
$e : (S', s') \to (S, s)$,
\item a commutative diagram
$$
\xymatrix{
X' \ar[d]_g & Z' \ar[l]^i \ar[r]_\pi & Y' \ar[r]_h & S' \ar[d]^e \\
X \ar[rrr]^f & & & S
}
$$
\item a point $z' \in Z'$ with $i(z') = x'$, $y' = \pi(z')$, $h(y') = s'$,
\item a finite type quasi-coherent $\mathcal{O}_{Z'}$-module $\mathcal{G}$,
\end{enumerate}
as in
Lemma \ref{lemma-elementary-devissage}.
Consider the base change of the commutative diagram above to
$\text{Spec}(\mathcal{O}_{S', s'})$. Since
$\text{Spec}(\mathcal{O}_{S', s'}) \times_S S' =
\text{Spec}(\mathcal{O}_{S', s'}) \amalg W$
where $W$ has empty fibre over the closed point
we see that we get a diagram as above with $S = S'$ local
satisfying all the conclusions of
Lemma \ref{lemma-elementary-devissage}.
By
Lemmas \ref{lemma-devissage-finite-presentation} and
\ref{lemma-devissage-flat}
the result for $Y' \to S$, the sheaf $\pi_*\mathcal{G}$, and the
point $y'$ implies the result for $X \to S$, $\mathcal{F}$ and $x$.
Hence we may assume that $S$ is local and $X \to S$ is a smooth morphism
of affines with geometrically irreducible fibres of dimension $n$.

\medskip\noindent
The base case of the induction: $n = 0$.
As $X \to S$ is smooth with geometrically
irredible fibres of dimension $0$ we see that $X \to S$ is an open
immersion, see
Descent, Lemma \ref{descent-lemma-universally-injective-etale-open-immersion}.
As $S$ is local and the closed point is in the image of $X \to S$
we conclude that $X = S$. Thus we see that $\mathcal{F}$ corresponds
to a finite flat $\mathcal{O}_{S, s}$ module. In this case the result
follows from
Algebra, Lemma \ref{algebra-lemma-finite-flat-local}
which tells us that $\mathcal{F}$ is in fact finite free.

\medskip\noindent
The induction step. Assume the result holds whenever the dimension
of the support in the closed fibre is $< n$. Write $S = \text{Spec}(A)$,
$X = \text{Spec}(B)$ and $\mathcal{F} = \widetilde{N}$ for some $B$-module
$N$. Note that $A$ is a local ring; denote its maximal ideal $\mathfrak m$.
Then $\mathfrak p = \mathfrak mB$ is the unique minimal prime lying over
$\mathfrak m$ as $X \to S$ has geometrically irreducible fibres. Finally,
let $\mathfrak q \subset B$ be the prime corresponding to $x$. By
Lemma \ref{lemma-induction-step}
we can choose a map
$$
\alpha : B^{\oplus r} \to N
$$
such that $\kappa(\mathfrak p)^{\oplus r} \to N \otimes_B \kappa(\mathfrak p)$
is an isomorphism. Moreover, as $N_{\mathfrak q}$ is $A$-flat the lemma
also shows that $\alpha$ is injective and that
$\text{Coker}(\alpha)_{\mathfrak q}$ is $A$-flat.
Set $Q = \text{Coker}(\alpha)$. Note that the support of $Q/\mathfrak mQ$
does not contain $\mathfrak p$. Hence it is certainly the case that
$\dim_{\mathfrak q}(\text{Supp}(Q/\mathfrak mQ)) < n$.
Combining everything we know about $Q$ we see
that the induction hypothesis applies to $Q$. It follows that there exists
an elementary \'etale morphism $(S', s) \to (S, s)$ such that the conclusion
holds for $Q \otimes_A A'$ over $B \otimes_A A'$ where
$A' = \mathcal{O}_{S', s'}$. After replacing $A$ by $A'$ we have an
exact sequence
$$
0 \to B^{\oplus r} \to N \to Q \to 0
$$
(here we use that $\alpha$ is injective as mentioned above)
of finite $B$-modules and we also get an element
$g \in B$, $g \not \in \mathfrak q$ such that
$Q_g$ is finitely presented over $B_g$ and flat over $A$. Since localization
is exact we see that
$$
0 \to B_g^{\oplus r} \to N_g \to Q_g \to 0
$$
is still exact. As $B_g$ and $Q_g$ are flat over $A$ we conlude that
$N_g$ is flat over $A$, see
Algebra, Lemma \ref{algebra-lemma-flat-ses},
and as $B_g$ and $Q_g$ are finitely presented over $B_g$ the same holds
for $N_g$, see
Algebra, Lemma \ref{algebra-lemma-extension}.
\end{proof}

\begin{lemma}
\label{lemma-finite-type-flat-at-point}
Let $f : X \to S$ be a morphism which is locally of finite presentation.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module of finite type.
If $x \in X$ and $\mathcal{F}$ is flat at $x$ over $S$, then
$\mathcal{F}_x$ is an $\mathcal{O}_{X, x}$-module of finite presentation.
\end{lemma}

\begin{proof}
Let $s = f(x)$. By
Proposition \ref{lemma-finite-type-flat-at-point}
there exists an elementary \'etale neighbourhood $(S', s') \to (S, s)$
such that the pullback of $\mathcal{F}$ to
$X \times_S \text{Spec}(\mathcal{O}_{S', s'})$ is of
finite presentation in a neighbourhood of the point $x' \in X_{s'} = X_s$
corresponding to $x$. The ring map
$$
\mathcal{O}_{X, x} \longrightarrow
\mathcal{O}_{X \times_S \text{Spec}(\mathcal{O}_{S', s'}), x'}
=
\mathcal{O}_{X \times_S S', x'}
$$
is flat and local as a localization of an \'etale ring map. Hence
$\mathcal{F}_x$ is of finite presentation over $\mathcal{O}_{X, x}$
by descent, see
Algebra, Lemma \ref{algebra-lemma-descend-properties-modules}
(and also that a flat local ring map is faithfully flat, see
Algebra, Lemma \ref{algebra-lemma-local-flat-ff}).
\end{proof}



\section{Flat finitely presented modules}
\label{section-finitely-presented-flat}

\noindent
In some cases given a ring map $R \to S$ of finite presentation and
a finitely presented $S$-module $N$ the flatness of $N$ over $R$ implies
that $N$ is projective as an $R$-module, at least after replacing $S$
by an \'etale extension. In this section we collect a some results
of this nature.

\begin{lemma}
\label{lemma-induction-step-fp}
Let $R$ be a ring. Let $R \to S$ be a finitely presented
flat ring map with geometrically integral fibres. Let
$\mathfrak q \subset S$ be a prime ideal lying over the prime
$\mathfrak r \subset R$. Set $\mathfrak p = \mathfrak r S$.
Let $N$ be a finitely presented $S$-module.
There exists $r \geq 0$ and an $S$-module map
$$
\alpha : S^{\oplus r} \longrightarrow N
$$
such that
$\alpha : \kappa(\mathfrak p)^{\oplus r} \to N \otimes_S \kappa(\mathfrak p)$
is an isomorphism. For any such $\alpha$ the following are equivalent:
\begin{enumerate}
\item $N_{\mathfrak q}$ is $R$-flat,
\item there exists an $f \in R$, $f \not \in \mathfrak r$ such that
$\alpha_f : S_f^{\oplus r} \to N_f$ is $R_f$-universally injective and
a $g \in S$, $g \not \in \mathfrak q$ such that $\text{Coker}(\alpha)_g$
is $R$-flat,
\item $\alpha_{\mathfrak r}$ is $R_{\mathfrak r}$-universally injective and
$\text{Coker}(\alpha)_{\mathfrak q}$ is $R$-flat
\item $\alpha_{\mathfrak r}$ is injective and
$\text{Coker}(\alpha)_{\mathfrak q}$ is $R$-flat,
\item $\alpha_{\mathfrak p}$ is an isomorphism and
$\text{Coker}(\alpha)_{\mathfrak q}$ is $R$-flat, and
\item $\alpha_{\mathfrak q}$ is injective and
$\text{Coker}(\alpha)_{\mathfrak q}$ is $R$-flat.
\end{enumerate}
\end{lemma}

\begin{proof}
To obtain $\alpha$ set
$r = \dim_{\kappa(\mathfrak p)} N \otimes_S \kappa(\mathfrak p)$ and pick
$x_1, \ldots, x_r \in N$ which form a basis of
$N \otimes_S \kappa(\mathfrak p)$. Define
$\alpha(s_1, \ldots, s_r) = \sum s_i x_i$. This proves the existence.

\medskip\noindent
Fix a choice of $\alpha$.
We may apply
Lemma \ref{lemma-induction-step}
to the map
$\alpha_{\mathfrak r} : S_{\mathfrak r}^{\oplus r} \to N_{\mathfrak r}$.
Hence we see that (1), (3), (4), (5), and (6) are all equivalent.
Since it is also clear that (2) implies (3) we see that all we have to
do is show that (1) implies (2).

\medskip\noindent
Assume (1). By openness of flatness, see
Algebra, Theorem \ref{algebra-theorem-openess-flatness},
the set
$$
U_1 = \{\mathfrak q' \subset S \mid N_{\mathfrak q'}\text{ is flat over }R\}
$$
is open in $\text{Spec}(S)$. It contains $\mathfrak q$ by assumption
and hence $\mathfrak p$. Because $S^{\oplus r}$ and $N$ are finitely presented
$S$-modules the set
$$
U_2 = \{\mathfrak q' \subset S \mid
\alpha_{\mathfrak q'}\text{ is an isomorphism}\}
$$
is open in $\text{Spec}(S)$, see
Algebra, Lemma \ref{algebra-lemma-map-between-finitely-presented}.
It contains $\mathfrak p$ by (5). As $R \to S$
is finitely presented and flat the map
$\Phi : \text{Spec}(S) \to \text{Spec}(R)$ is open, see
Algebra, Proposition \ref{algebra-proposition-fppf-open}.
For any prime $\mathfrak r' \in \Phi(U_1 \cap U_2)$ we see that
there exists a prime $\mathfrak q'$ lying over $\mathfrak r'$ such that
$N_{\mathfrak q'}$ is flat and such that $\alpha_{\mathfrak q'}$ is
an isomorphism, which implies that $\alpha \otimes \kappa(\mathfrak p')$
is an isomorphism where $\mathfrak p' = \mathfrak r' S$. Thus
$\alpha_{\mathfrak r'}$ is $R_{\mathfrak r'}$-universally injective
by the implication (1) $\Rightarrow$ (3).
Hence if we pick $f \in R$, $f \not \in \mathfrak r$ such that
$D(f) \subset \Phi(U_1 \cap U_2)$ then we conclude that
$\alpha_f$ is $R_f$-universally injective, see
Algebra, Lemma \ref{algebra-lemma-universally-injective-check-stalks}.
The same reasoning also shows that for any
$\mathfrak q' \in U_1 \cap \Phi^{-1}(\Phi(U_1 \cap U_2))$
the module $\text{Coker}(\alpha)_{\mathfrak q'}$ is $R$-flat.
Note that $\mathfrak q \in U_1 \cap \Phi^{-1}(\Phi(U_1 \cap U_2))$.
Hence we can find a $g \in S$, $g \not \in \mathfrak q$ such
that $D(g) \subset U_1 \cap \Phi^{-1}(\Phi(U_1 \cap U_2))$
and we win.
\end{proof}



\begin{lemma}
\label{lemma-weak-bourbaki}
Let $R \to S$ be a local map of local rings which is essentially of
finite presentation. Let $N$ be a finitely presented $S$-module flat over $R$.
Let $M$ be an $R$-module. Then the following are equivalent
\begin{enumerate}
\item $\mathfrak m_S \in \text{WeakAss}_S(M \otimes_R N)$
\item $\mathfrak m_R \in \text{WeakAss}_R(M)$ and
$\mathfrak m_{\overline{S}} \in
\text{Ass}_{\overline{S}}(\overline{N})$
\end{enumerate}
where $\overline{S} = S/\mathfrak m_R S$ and
$\overline{N} = N/\mathfrak m_R N$.
\end{lemma}

\begin{proof}
Suppose that
$\mathfrak m_{\overline{S}} \not \in \text{Ass}_{\overline{S}}(\overline{N})$.
Then
Lemma \ref{lemma-homothety-universally-injective}
assures us that there exists an element $s \in S$, $s \not \in \mathfrak m_S$
such that $s : N \to N$ is $R$-universally injective. In particular
we see that $s : M \otimes_R N \to M \otimes_R N$ is injective.
Clearly this implies that
$\mathfrak m_S \not \in \text{WeakAss}_S(M \otimes_R N)$.
We conclude that (1)
$\Rightarrow \mathfrak m_{\overline{S}} \in
\text{Ass}_{\overline{S}}(\overline{N})$.

\medskip\noindent
Thus we see that it suffices to prove the equivalence of
$\mathfrak m_S \in \text{WeakAss}_S(M \otimes_R N)$ and
$\mathfrak m_R \in \text{WeakAss}_R(M)$ under the additional
hypothesis that
$\mathfrak m_{\overline{S}} \in \text{Ass}_{\overline{S}}(\overline{N})$.
To be continued...
\end{proof}

\begin{lemma}
\label{lemma-bourbaki-finite-type-general-base}
Let $f : X \to S$ be a morphism which is locally of finite type.
Let $\mathcal{F}$ be a finite type quasi-coherent sheaf on $X$
which is flat over $Y$. Let $\mathcal{G}$ be a quasi-coherent sheaf on $Y$.
Then we have
$$
\text{WeakAss}_X(\mathcal{F} \otimes_{\mathcal{O}_X} f^*\mathcal{G}) =
\bigcup\nolimits_{s \in \text{WeakAss}_S(\mathcal{G})}
\text{Ass}_{X_s}(\mathcal{F}_s)
$$
\end{lemma}

\begin{proof}
Let $x \in X$ be a point with image $s = f(x) \in S$.
Note that the fibre $X_s$ is a locally Noetherian scheme.
Hence
$\text{Ass}_{X_s}(\mathcal{F}_s) = \text{WeakAss}_{X_s}(\mathcal{F}_s)$, see
Divisors, Lemma \ref{divisors-lemma-ass-weakly-ass}.
Our goal is to show $x \in LHS \Leftrightarrow x \in RHS$.
This question is local on $X$ and $S$. Hence we may assume that
$X$ and $S$ are affine. Choose a closed immersion $i : X \to \mathbf{A}^n_S$
over $S$. By
Divisors, Lemma \ref{divisors-lemma-weakly-associated-finite}
it suffices to prove the lemma for $i_*\mathcal{F}$ on $\mathbf{A}^n_S$.
Hence we may assume that $f$ is of finite presentation. By
Lemma \ref{lemma-etale-weak-assassin-up-down}
we may replace $S$ by an elementary \'etale neighbourhood of $s$.
Hence we may after performing such a base change assume there
exists an open subscheme
$$
V \subset X \times_S \text{Spec}(\mathcal{O}_{X, x})
$$
containing the unique point $x'$ of
$X \times_S \text{Spec}(\mathcal{O}_{X, x})$ over $x$
such that $\mathcal{F}|_V$ is an $\mathcal{O}_V$-module of finite
presentation and flat over $S$, see
Proposition \ref{lemma-finite-type-flat-at-point}.
Since (weakly) associated points are defined in terms of the stacks of
the quasi-coherent sheaf it is clear that we may replace
$S$ by $\text{Spec}(\mathcal{O}_{S, s})$, $X$ by $V$,
$x$ by $x'$, and $\mathcal{F}$ by $\mathcal{F}|_V$.
This reduces us to
Lemma \ref{lemma-weak-bourbaki}.
\end{proof}












\section{Relatively pure modules}
\label{section-pure}

\noindent
The notion of a pure module over a base was introduced in
\cite{GruRay} in a slightly different (but equivalent) form.
As motivation for this notion we present the following lemma.
Note the similarity with the condition on associated primes appearing in
Lemma \ref{lemma-universally-injective-to-completion-flat}.

\begin{lemma}
\label{lemma-explain-why-pure}
Let $R$ be a local ring with maximal ideal $\mathfrak m$.
Let $R \to S$ be a ring map. Let $M$ be an $S$-module.
Assume
\begin{enumerate}
\item $M$ is projective as an $R$-module, and
\item $S/\mathfrak mS$ is Noetherian and $M/\mathfrak mM$ is a finite
$S/\mathfrak mS$-module.
\end{enumerate}
Then for any prime $\mathfrak q \subset S$ lying over any
$\mathfrak p \subset R$ which is an associated prime of
$M \otimes_R \kappa(\mathfrak p)$ we have
$\mathfrak q + \mathfrak m S \not = S$.
\end{lemma}

\begin{proof}
Note that the hypotheses of
Lemmas \ref{lemma-homothety-spectrum} and
\ref{lemma-invert-universally-injective}
are satisfied. We will use the conclusions of these lemmas without further
mention. Let $\Sigma \subset S$ be the multiplicative set of elements
which are not zero divisors on $M/\mathfrak mM$. The map
$M \to \Sigma^{-1}M$ is $R$-universally injective. Hence we see that
any $\mathfrak q \subset S$ which is an associated prime of
$M \otimes_R \kappa(\mathfrak p)$ is also an associated prime of
$\Sigma^{-1}M \otimes_R \kappa(\mathfrak p)$. Clearly this implies that
$\mathfrak q$ corresponds to a prime of $\Sigma^{-1}S$.
Thus $\mathfrak q \subset \mathfrak q'$ where $\mathfrak q'$
corresponds to an associated prime of $M/\mathfrak mM$ and we win.
\end{proof}

\noindent
Suppose $f : X \to S$ is a finite type morphism of affine schemes and
$\mathcal{F}$ is a quasi-coherent module on $X$.
Consider an irreducible closed subscheme $Z \subset X$ whose generic point
$\xi \in Z$ is an element of $\text{Ass}_{X/S}(\mathcal{F})$.
It now follows from
Lemma \ref{lemma-explain-why-pure}
that if $f_*\mathcal{F}$ corresponds to a projective
$\mathcal{O}_S(S)$-module, then the image $f(Z) \subset S$ is a
closed subset. Loosely speaking: points in the relative assasin of
$\mathcal{F}$ over $S$ specialize to points in closed fibres.

\begin{lemma}
\label{lemma-separate}
Let $f : X \to S$ be a quasi-compact morphism of schemes.
Let $g : T \to S$ be a morphism of schemes.
Let $t \in T$ be a point and $Z \subset X_T$ be a closed
subscheme such that $Z \cap X_t = \emptyset$.
Then there exists an open neighbourhood
$V \subset T$ of $t$, a commutative diagram
$$
\xymatrix{
V \ar[d] \ar[r]_a & T' \ar[d]^b \\
T \ar[r]^g & S,
}
$$
and a closed subscheme $Z' \subset X_{T'}$ such that
\begin{enumerate}
\item the morphism $b : T' \to S$ is locally of finite presentation,
\item with $t' = a(t)$ we have $Z' \cap X_{t'} = \emptyset$, and
\item $Z \cap X_V$ maps into $Z'$ via the morphism $X_V \to X_{T'}$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $s = g(t)$. During the proof we may always replace $T$ by an
open neighbourhood of $t$. Hence we may also replace $S$ by an open
neighbourhood of $s$. Thus we may and do assume that $T$ and $S$ are affine.
Say $S = \text{Spec}(A)$, $T = \text{Spec}(B)$, $g$ is given by the
ring map $A \to B$, and $t$ correspond to the prime ideal
$\mathfrak q \subset B$.

\medskip\noindent
As $X \to S$ is quasi-compact and $S$ is affine we may write
$X = \bigcup_{i = 1, \ldots, n} U_i$ as a finite union of affine opens.
Write $U_i = \text{Spec}(C_i)$. In particular we have
$X_T = \bigcup_{i = 1, \ldots, n} U_{i, T} =
\bigcup_{i = 1, \ldots n} \text{Spec}(C_i \otimes_A B)$.
Let $I_i \subset C_i \otimes_A B$ be the ideal corresponding to the
closed subscheme $Z \cap U_{i, T}$. The condition that
$Z \cap X_t = \emptyset$ signifies that $I_i$ generates the
unit ideal in the ring
$$
C_i \otimes_A \kappa(\mathfrak q) =
(B \setminus \mathfrak q)^{-1}\left(
C_i \otimes_A B/\mathfrak q C_i \otimes_A B \right)
$$
Since $I_i (B \setminus \mathfrak q)^{-1}(C_i \otimes_A B) =
(B \setminus \mathfrak q)^{-1} I_i$ this means that $1 = x_i/g_i$
for some $x_i \in I_i$ and $g_i \in B$, $g_i \not \in \mathfrak q$.
Thus, clearing denominators we can find a relation of the form
$$
x_i + \sum\nolimits_j f_{i, j}c_{i, j} = g_i
$$
with $x_i \in I_i$, $f_{i, j} \in \mathfrak q$, $c_{i, j} \in C_i \otimes_A B$,
and $g_i \in B$, $g_i \not \in \mathfrak q$. After replacing $B$ by
$B_{g_1 \ldots g_n}$, i.e., after replacing $T$ by a smaller affine
neighbourhood of $t$, we may assume the equations read
$$
x_i + \sum\nolimits_j f_{i, j}c_{i, j} = 1
$$
with $x_i \in I_i$, $f_{i, j} \in \mathfrak q$, $c_{i, j} \in C_i \otimes_A B$.

\medskip\noindent
To finish the argument write $B$ as a colimit of finitely presented
$A$-algebras $B_\lambda$ over a directed partially ordered set $\Lambda$.
For each $\lambda$ set
$\mathfrak q_\lambda = (B_\lambda \to B)^{-1}(\mathfrak q)$.
For sufficiently large $\lambda \in \Lambda$ we can find
\begin{enumerate}
\item an element
$x_{i, \lambda} \in C_i \otimes_A B_\lambda$ which maps to $x_i$,
\item elements $f_{i, j, \lambda} \in \mathfrak q_{i, \lambda}$
mapping to $f_{i, j}$, and
\item elements $c_{i, j, \lambda} \in C_i \otimes_A B_\lambda$
mapping to $c_{i, j}$.
\end{enumerate}
After increasing $\lambda$ a bit more the equation
$$
x_{i, \lambda} + \sum\nolimits_j f_{i, j, \lambda}c_{i, j, \lambda} = 1
$$
will hold. Fix such a $\lambda$ and set $T' = \text{Spec}(B_\lambda)$.
Then $t' \in T'$ is the point corresponding to the prime $\mathfrak q_\lambda$.
Finally, let $Z' \subset X_{T'}$ be the scheme theoretic closure of
$Z \to X_T \to X_{T'}$. As $X_T \to X_{T'}$ is affine, we can compute $Z'$
on the affine open pieces $U_{i, T'}$ as the closed subscheme associated
to $\text{Ker}(C_i \otimes_A B_\lambda \to C_i \otimes_A B/I_i)$, see
Morphisms, Example \ref{morphisms-example-scheme-theoretic-image}.
Hence $x_{i, \lambda}$ is in the ideal defining $Z'$. Thus the last
displayed equation shows that $Z' \cap X_{t'}$ is empty.
\end{proof}

\begin{situation}
\label{situation-pre-pure}
Here $f : X \to S$ be a finite type morphism of schemes.
Let $\mathcal{F}$ be a finite type quasi-coherent $\mathcal{O}_X$-module
flat over $S$. Finally $s$ is a point of $S$.
\end{situation}

\noindent
In this situation consider a morphism $g : T \to S$ and a point $t \in T$
with $g(t) = s$. Denote $f_T : X_T \to T$ the base change of $f$, and
denote $\mathcal{F}_T$ the pullback of $\mathcal{F}$ to $X_T$ via the
projection morphism. Finally, consider a point $\xi \in X_T$. If
\begin{enumerate}
\item $f_T(\xi) \leadsto t$,
\item $\xi \in \text{Ass}_{X_T/T}(\mathcal{F}_T)$, and
\item $\overline{\{\xi\}} \cap X_t = \emptyset$.
\end{enumerate}
then we say that $(g : T \to S, t, \xi)$ gives an
{\it impurity of $\mathcal{F}$ above $s$}.

\begin{lemma}
\label{lemma-impure-finite-presentation}
In Situation \ref{situation-pre-pure}.
If there exists an impurity of $\mathcal{F}$ above $s$, then
there exists an impurity $(g : T \to S, t, \xi)$ with
$g$ locally of finite presentation and $t$ a closed point of
the fibre of $g$ above $s$.
\end{lemma}

\begin{proof}
Let $(g : T \to S, t, \xi)$ be any impurity of $\mathcal{F}$ above $s$.
We apply
Lemma \ref{lemma-separate}
to $t \in T$ and $Z = \overline{\{\xi\}}$ to obtain
$V \subset T$, $V \to T' \to S$ and $Z' \subset X_{T'}$.
As $f_T(\xi)$ specializes to $t$
we may replace $T$ by the open neighbourhood $V$ of $t$. Thus
we have a commutative diagram
$$
\xymatrix{
X_T \ar[d] \ar[r] &
X_{T'} \ar[d] \ar[r] &
X \ar[d] \\
T \ar[r] & T' \ar[r] & S
}
$$
where the composition of the arrows on the bottom row recovers the
original morphism $g : T \to S$. Let $\xi' \in X_{T'}$ denote the
image of $\xi$. By
Divisors, Lemma \ref{divisors-lemma-base-change-relative-assasin}
we see that $\xi' \in \text{Ass}_{X_{T'}/T'}(\mathcal{F}_{T'})$.
Moreover, by construction the closure of $\overline{\{\xi'\}}$
is contained in the closed subset $Z'$ which avoids the fibre
$X_{t'}$ where $t' \in T$ is the image of $t$. In this way we see
that $(T' \to S, t', \xi')$ is an impurity of $\mathcal{F}$ above $s$.

\medskip\noindent
Thus we may assume that $g : T \to S$ is locally of finite presentation.
Let $Z = \overline{\{\xi\}}$. By assumption $Z_t = \emptyset$. By
More on Morphisms, Lemma \ref{more-morphisms-lemma-empty-generic-fibre}
this means that $Z_{t'} = \emptyset$ for $t'$ in an open subset
of $\overline{\{t\}}$. Since the fibre of
$T \to S$ over $s$ is a Jacobson scheme, see
Morphisms, Lemma \ref{morphisms-lemma-ubiquity-Jacobson-schemes}
we find that there exist a closed point $t' \in \overline{\{t\}}$ such that
$Z_{t'} = \emptyset$ and we win.
\end{proof}







\section{Flattening stratification}
\label{section-flattening}

\noindent
If $f : X \to S$ is a proper, finitely presented morphism
of schemes then one can find a stratification of the base
over whose members the morphism $f$ is flat. It is not so hard
to find this stratification, but what is a bit tricky is to prove
that this stratification is characterized by a universal property.
In this section we discuss this and some of its variants.

\medskip\noindent
The first case is where the base is the spectrum of a complete
local Noetherian ring. In this case the closed stratum is defined
and satisfies the desired universal property even for a general
finite type morphism, provided we {\it only} look for flatness in
points lying over the closed point.

\begin{lemma}
\label{lemma-flattening-complete-noetherian}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{F}$ be a quasi-coherent sheaf on $X$.
Assume
\begin{enumerate}
\item $S = \text{Spec}(A)$ is the spectrum of a Noetherian complete
local ring $A$,
\item $f$ is of finite type, and
\item $\mathcal{F}$ is a finite type $\mathcal{O}_X$-module.
\end{enumerate}
Then there exists a closed subscheme $Z \subset S$ with the following
universal property: Given a morphism $S' \to S$ which corresponds to
a local homomorphism $A' \to A$ of local rings the following
are equivalent
\begin{enumerate}
\item[(a)] the pullback $\mathcal{F}'$ of $\mathcal{F}$ to
$X' = S' \times_S X$ is flat over $S'$ at all points $x' \in X'$
lying over the closed point of $S'$, and
\item[(b)] $S' \to S$ factors through $Z$.
\end{enumerate}
In particular, $Z$ is the largest closed subscheme of $S$ such that
$\mathcal{F}|_{X_Z}$ is flat over $Z$ at all points
of $X_Z$ lying over the closed point of $Z$.
\end{lemma}

\begin{proof}
As $f$ is of finite type it is quasi-compact. Hence $X$ is quasi-compact.
Choose a finite affine open covering $X = \bigcup X_i$.
Write $X_i = \text{Spec}(B_i)$ so that $A \to B_i$ is a finite type
ring map. Note that $\mathcal{F}|_{X_i}$ corresponds to a finite
$B_i$-module $M_i$. Set $Y = \coprod X_i = \text{Spec}(\prod B_i)$
and $\mathcal{G} = \widetilde{\prod M_i}$ on $Y$.
Now if $S' \to S$ is a morphism as in the lemma, then (a) holds
for $\mathcal{F}'$ relative to $X' \to S'$ if and only if (a) holds for
$\mathcal{G}'$ relative to $Y' \to S'$. Hence this
reduces us to the case where $X$ is affine.
In this case $Z$ exists by
Algebra,
Lemma \ref{algebra-lemma-flattening-complete-local-universal-property}.
(Hint: We strongly suggest the reader only read the construction of
$Z = \text{Spec}(A/I)$ in
Algebra, Lemma \ref{algebra-lemma-flattening-complete-local-noetherian}.)
\end{proof}





\input{chapters}


\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}
