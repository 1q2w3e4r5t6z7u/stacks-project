\input{preamble}

% OK, start here.
%
\begin{document}

\title{Moduli of Curves}

\maketitle

\phantomsection
\label{section-phantom}

\tableofcontents




\section{Introduction}
\label{section-introduction}

\noindent
In this chapter we discuss some of the familiar moduli stacks of curves.
A reference is the celebrated article of Deligne and Mumford, see \cite{DM}.




\section{Conventions and abuse of language}
\label{section-conventions}

\noindent
We continue to use the conventions and the abuse of language
introduced in
Properties of Stacks, Section \ref{stacks-properties-section-conventions}.
Unless otherwise mentioned our base scheme will be $\Spec(\mathbf{Z})$.







\section{The stack of curves}
\label{section-stack-curves}

\noindent
This section is the continuation of Quot, Section \ref{quot-section-curves}.
Let $\Curvesstack$ be the stack whose category of sections over a
scheme $S$ is the category of families of curves over $S$.
It is somewhat important to keep in mind that a
{\it family of curves} is a morphism $f : X \to S$ where $X$
is an algebraic space (!) and $f$ is flat, proper, of finite presentation
and of relative dimension $\leq 1$.
We already know that $\Curvesstack$ is an
algebraic stack over $\mathbf{Z}$, see Quot, Theorem
\ref{quot-theorem-curves-algebraic}.
If we did not allow algebraic spaces in the definition of
our stack, then this theorem would be false.

\medskip\noindent
Often base change is denoted by a subscript, but we cannot use
this notation for $\Curvesstack$ because $\Curvesstack_S$
is our notation for the fibre category over $S$.
This is why in Quot, Remark \ref{quot-remark-curves-base-change}
we used $B\text{-}\Curvesstack$ for the base change
$$
B\text{-}\Curvesstack = \Curvesstack \times B
$$
to the algebraic space $B$. The product on the right is over the
final object, i.e., over $\Spec(\mathbf{Z})$. The object on the left
is the stack classifying families of curves on the category of schemes
over $B$. In particular, if $k$ is a field, then
$$
k\text{-}\Curvesstack = \Curvesstack \times \Spec(k)
$$
is the moduli stack classifying families of curves on the category
of schemes over $k$.
Before we continue, here is a sanity check.

\begin{lemma}
\label{lemma-extend-curves-to-spaces}
Let $T \to B$ be a morphism of algebraic spaces. The category
$$
\Mor_B(T, B\text{-}\Curvesstack) = \Mor(T, \Curvesstack)
$$
is the category of families of curves over $T$.
\end{lemma}

\begin{proof}
A family of curves over $T$ is a morphism $f : X \to T$ of algebraic
spaces, which is flat, proper, of finite presentation, and has
relative dimension $\leq 1$ (Morphisms of Spaces, Definition
\ref{spaces-morphisms-definition-relative-dimension}).
This is exactly the same as the definition in
Quot, Situation \ref{quot-situation-curves}
except that $T$ the base is allowed to be an algebraic space.
Our default base category for algebraic stacks/spaces
is the category of schemes, hence the lemma does not follow
immediately from the definitions. Having said this, we encourage
the reader to skip the proof.

\medskip\noindent
By the product description of $B\text{-}\Curvesstack$ given above,
it suffices to prove the lemma in the absolute case. Choose a scheme
$U$ and a surjective \'etale morphism $p : U \to T$.
Let $R = U \times_T U$ with projections $s, t : R \to U$.

\medskip\noindent
Let $v : T \to \Curvesstack$ be a morphism. Then $v \circ p$
corresponds to a family of curves $X_U \to U$. The canonical
$2$-morphism $v \circ p \circ t \to v \circ p \circ s$
is an isomorphism $\varphi : X_U \times_{U, s} R \to X_U \times_{U, t} R$.
This isomorphism satisfies the cocycle condition on
$R \times_{s, t} R$.
By Bootstrap, Lemma \ref{bootstrap-lemma-descend-algebraic-space}
we obtain a morphism of algebraic spaces $X \to T$
whose pullback to $U$ is equal to $X_U$ compatible with $\varphi$.
Since $\{U \to T\}$ is an \'etale covering, we see that
$X \to T$ is flat, proper, of finite presentation by
Descent on Spaces, Lemmas
\ref{spaces-descent-lemma-descending-property-flat},
\ref{spaces-descent-lemma-descending-property-proper}, and
\ref{spaces-descent-lemma-descending-property-finite-presentation}.
Also $X \to T$ has relative dimension $\leq 1$ because this is
an \'etale local property. Hence $X \to T$ is a family of curves over $T$.

\medskip\noindent
Conversely, let $X \to T$ be a family of curves. Then the
base change $X_U$ determines a morphism $w : U \to \Curvesstack$
and the canonical isomorphism $X_U \times_{U, s} R \to X_U \times_{U, t} R$
determines a $2$-arrow $w \circ s \to w \circ t$ satisfying the
cocycle condition. Thus a morphism $v : T = [U/R] \to \Curvesstack$
by the universal property of the quotient $[U/R]$, see
Groupoids in Spaces, Lemma
\ref{spaces-groupoids-lemma-quotient-stack-2-coequalizer}.
(Actually, it is much easier in this case to go back to before
we introduced our abuse of language and direct construct
the functor $\Sch/T \to \Curvesstack$ which ``is'' the
morphsim $T \to \Curvesstack$.)

\medskip\noindent
We omit the verification that the constructions given above
extend to morphisms between objects and are mutually quasi-inverse.
\end{proof}






\section{The stack of polarized curves}
\label{section-polarized-curves}

\noindent
In this section we work out some of the material
discussed in Quot, Remark \ref{quot-remark-alternative-approach-curves}.
Consider the $2$-fibre product
$$
\xymatrix{
\Curvesstack \times_{\Spacesstack'_{fp, flat, proper}}
\Polarizedstack \ar[r] \ar[d] &
\Polarizedstack \ar[d] \\
\Curvesstack \ar[r] &
\Spacesstack'_{fp, flat, proper}
}
$$
We denote this $2$-fibre product by
$$
\textit{PolarizedCurves} =
\Curvesstack
\times_{\Spacesstack'_{fp, flat, proper}}
\Polarizedstack
$$
This fibre product parametrizes polarized curves, i.e., families
of curves endowed with a relatively ample invertible sheaf.
More precisely, an object of
$\textit{PolarizedCurves}$
is a pair $(X \to S, \mathcal{L})$ where
\begin{enumerate}
\item $X \to S$ is a morphism of schemes which is proper, flat,
of finite presentation, and has relative dimension $\leq 1$, and
\item $\mathcal{L}$ is an invertible $\mathcal{O}_X$-module
which is relatively ample on $X/S$.
\end{enumerate}
A morphism $(X' \to S', \mathcal{L}') \to (X \to S, \mathcal{L})$
between objects of
$\textit{PolarizedCurves}$
is given by a triple $(f, g, \varphi)$
where $f : X' \to X$ and $g : S' \to S$
are morphisms of schemes which fit into a commutative diagram
$$
\xymatrix{
X' \ar[d] \ar[r]_f & X \ar[d] \\
S' \ar[r]^g & S
}
$$
inducing an isomorphism $X' \to S' \times_S X$, in other words, the
diagram is cartesian, and $\varphi : f^*\mathcal{L} \to \mathcal{L}'$
is an isomorphism. Composition is defined in the obvious manner.

\begin{lemma}
\label{lemma-polarized-curves-in-polarized}
The morphism
$\textit{PolarizedCurves} \to
\Polarizedstack$ is an open and closed immersion.
\end{lemma}

\begin{proof}
This is true because the $1$-morphism
$\Curvesstack \to \Spacesstack'_{fp, flat, proper}$
is representable by open and closed immersions, see
Quot, Lemma \ref{quot-lemma-curves-open-and-closed-in-spaces}.
\end{proof}

\begin{lemma}
\label{lemma-polarized-curves-over-curves}
The morphism
$\textit{PolarizedCurves} \to \Curvesstack$
is smooth and surjective.
\end{lemma}

\begin{proof}
Surjective. Given a field $k$ and a proper algebraic space
$X$ over $k$ of dimension $\leq 1$, i.e., an object of $\Curvesstack$ over $k$.
By Spaces over Fields, Lemma
\ref{spaces-over-fields-lemma-codim-1-point-in-schematic-locus}
the algebraic space $X$ is a scheme. Hence $X$
is a proper scheme of dimension $\leq 1$ over $k$.
By Varieties, Lemma \ref{varieties-lemma-dim-1-proper-projective}
we see that $X$ is H-projective over $\kappa$.
In particular, there exists an ample invertible $\mathcal{O}_X$-module
$\mathcal{L}$ on $X$. Then $(X, \mathcal{L})$ is an object
of $\textit{PolarizedCurves}$ over
$k$ which maps to $X$.

\medskip\noindent
Smooth. Let $X \to S$ be an object of $\Curvesstack$, i.e., a
morphism $S \to \Curvesstack$. It is clear that
$$
\textit{PolarizedCurves}
\times_{\Curvesstack} S
\subset \Picardstack_{X/S}
$$
is the substack of objects $(T/S, \mathcal{L}/X_T)$ such that
$\mathcal{L}$ is ample on $X_T/T$. This is an open substack by
Descent on Spaces, Lemma \ref{spaces-descent-lemma-ample-in-neighbourhood}.
Since $\Picardstack_{X/S} \to S$ is smooth by
Moduli Stacks, Lemma \ref{moduli-lemma-pic-curves-smooth}
we win.
\end{proof}

\begin{lemma}
\label{lemma-etale-locally-scheme}
Let $X \to S$ be a family of curves.
Then there exists an \'etale covering $\{S_i \to S\}$
such that $X_i = X \times_S S_i$ is a scheme. We may even
assume $X_i$ is H-projective over $S_i$.
\end{lemma}

\begin{proof}
This is an immediate corrolary of
Lemma \ref{lemma-polarized-curves-over-curves}.
Namely, unwinding the definitions, this lemma gives there is a
surjective smooth morphism $S' \to S$ such that $X' = X \times_S S'$
comes endowed with an invertible $\mathcal{O}_{X'}$-module
$\mathcal{L}'$ which is ample on $X'/S'$.
Then we can refine the smooth covering $\{S' \to S\}$
by an \'etale covering $\{S_i \to S\}$, see
More on Morphisms, Lemma \ref{more-morphisms-lemma-etale-dominates-smooth}.
After replacing $S_i$ by a suitable open covering we may assume
$X_i \to S_i$ is H-projective, see
Morphisms, Lemmas \ref{morphisms-lemma-proper-ample-locally-projective} and
\ref{morphisms-lemma-characterize-locally-projective}
(this is also discussed in detail in
More on Morphisms, Section \ref{more-morphisms-section-projective}).
\end{proof}






\section{Properties of the stack of curves}
\label{section-properties}

\noindent
The following lemma isn't true for moduli of surfaces, see
Remark \ref{remark-boundedness-aut-does-not-work-surfaces}.

\begin{lemma}
\label{lemma-curves-diagonal-separated-fp}
The diagonal of $\Curvesstack$ is separated
and of finite presentation.
\end{lemma}

\begin{proof}
Recall that $\Curvesstack$ is a limit preserving algebraic stack, see
Quot, Lemma \ref{quot-lemma-curves-limits}.
By Limits of Stacks, Lemma \ref{stacks-limits-lemma-limit-preserving-diagonal}
this implies that
$\Delta : \Polarizedstack \to \Polarizedstack \times \Polarizedstack$
is limit preserving. Hence $\Delta$ is locally of finite presentation
by Limits of Stacks, Proposition
\ref{stacks-limits-proposition-characterize-locally-finite-presentation}.

\medskip\noindent
Let us prove that $\Delta$ is separated. To see this, it suffices to show
that given a scheme $U$ and two objects $Y \to U$ and $X \to U$ of
$\Curvesstack$ over $U$, the algebraic space
$$
\mathit{Isom}_U(Y, X)
$$
is separated. This we have seen in
Moduli Stacks, Lemmas \ref{moduli-lemma-Mor-s-lfp} and
\ref{moduli-lemma-Isom-in-Mor} that the target is
a separated algebraic space.

\medskip\noindent
To finish the proof we show that $\Delta$ is quasi-compact. Since
$\Delta$ is representable by algebraic spaces, it suffice to check
the base change of $\Delta$ by a surjective smooth morphism
$U \to \Curvesstack \times \Curvesstack$ is quasi-compact
(see for example Properties of Stacks, Lemma
\ref{stacks-properties-lemma-check-property-covering}).
We choose $U = \coprod U_i$ to be a disjoint union of affine opens
with a surjective smooth morphism
$$
U \longrightarrow
\textit{PolarizedCurves} \times \textit{PolarizedCurves}
$$
Then $U \to \Curvesstack \times \Curvesstack$ will be surjective
and smooth since $\textit{PolarizedCurves} \to \Curvesstack$
is surjective and smooth by Lemma \ref{lemma-polarized-curves-over-curves}.
Since $\textit{PolarizedCurves}$ is limit preserving
(by Artin's Axioms, Lemma \ref{artin-lemma-fibre-product-limit-preserving}
and Quot, Lemmas \ref{quot-lemma-curves-limits},
\ref{quot-lemma-polarized-limits}, and
\ref{quot-lemma-spaces-limits}), we
see that $\textit{PolarizedCurves} \to \Spec(\mathbf{Z})$ is locally of
finite presentation, hence $U_i \to \Spec(\mathbf{Z})$ is
locally of finite presentation
(Limits of Stacks, Proposition
\ref{stacks-limits-proposition-characterize-locally-finite-presentation}
and Morphisms of Stacks, Lemmas
\ref{stacks-morphisms-lemma-composition-finite-presentation} and
\ref{stacks-morphisms-lemma-smooth-locally-finite-presentation}).
In particular, $U_i$ is Noetherian affine. This reduces us to the
case discussed in the next paragraph.

\medskip\noindent
In this paragraph, given a Noetherian affine scheme $U$ and two objects
$(Y, \mathcal{N})$ and $(X, \mathcal{L})$
of $\textit{PolarizedCurves}$ over $U$, we show the algebraic space
$$
\mathit{Isom}_U(Y, X)
$$
is quasi-compact. Since the connected components of $U$ are open and closed
we may replace $U$ by these. Thus we may and do assume $U$ is connected.
Let $u \in U$ be a point. Let $Q$, $P$ be the Hilbert polynomials
of these families, i.e.,
$$
Q(n) = \chi(Y_u, \mathcal{N}_u^{\otimes n})
\quad\text{and}\quad
P(n) = \chi(X_u, \mathcal{L}_u^{\otimes n})
$$
see Varieties, Lemma \ref{varieties-lemma-numerical-polynomial-from-euler}.
Since $U$ is connected and since
the functions
$u \mapsto \chi(Y_u, \mathcal{N}_u^{\otimes n})$ and
$u \mapsto \chi(X_u, \mathcal{L}_u^{\otimes n})$
are locally constant (see 
Derived Categories of Schemes, Lemma
\ref{perfect-lemma-chi-locally-constant-geometric})
we see that we get the same Hilbert polynomial in every point of $U$.
Set
$$
\mathcal{M} = \text{pr}_1^*\mathcal{N}
\otimes_{\mathcal{O}_{Y \times_U X}} \text{pr}_2^*\mathcal{L}
$$
on $Y \times_U X$. Given $(f, \varphi) \in \mathit{Isom}_U(Y, X)(T)$
for some scheme $T$ over $U$ then for every $t \in T$ we have
\begin{align*}
\chi(Y_t, (\text{id} \times f)^*\mathcal{M}^{\otimes n})
& =
\chi(Y_t,
\mathcal{N}_t^{\otimes n} \otimes_{\mathcal{O}_{Y_t}}
f_t^*\mathcal{L}_t^{\otimes n}) \\
& =
n\deg(\mathcal{N}_t) + n\deg(f_t^*\mathcal{L}_t) +
\chi(Y_t, \mathcal{O}_{Y_t}) \\
& =
Q(n) + n\deg(\mathcal{L}_t) \\
& =
Q(n) + P(n) - P(0)
\end{align*}
by Riemann-Roch for proper curves, more precisely by
Varieties, Definition \ref{varieties-definition-degree-invertible-sheaf} and
Lemma \ref{varieties-lemma-degree-tensor-product}
and the fact that $f_t$ is an isomorphism.
Setting $P'(t) = Q(t) + P(t) - P(0)$ we find
$$
\mathit{Isom}_U(Y, X) =
\mathit{Isom}_U(Y, X) \cap \mathit{Mor}^{P', \mathcal{M}}_U(Y, X)
$$
The intersection is an intersection of open subspaces of
$\mathit{Mor}_U(Y, X)$, see
Moduli Stacks, Lemma \ref{moduli-lemma-Isom-in-Mor} and
Remark \ref{moduli-remark-Mor-numerical}.
Now $\mathit{Mor}^{P', \mathcal{M}}_U(Y, X)$
is a Noetherian algebraic space as it is of finite
presentation over $U$ by
Moduli Stacks, Lemma \ref{moduli-lemma-Mor-qc-over-base}.
Thus the intersection is a Noetherian algebraic space too
and the proof is finished.
\end{proof}

\begin{remark}
\label{remark-boundedness-aut-does-not-work-surfaces}
The boundedness argument in the proof of
Lemma \ref{lemma-curves-diagonal-separated-fp}
does not work for moduli of surfaces and in fact,
the result is wrong, for example because K3 surfaces
over fields can have infinite discrete automorphism groups.
The ``reason'' the argument does not work is that on a
projective surface $S$ over a field,
given ample invertible sheaves $\mathcal{N}$
and $\mathcal{L}$ with Hilbert polynomials $Q$ and $P$,
there is no a priori bound on the Hilbert polynomial
of $\mathcal{N} \otimes_{\mathcal{O}_S} \mathcal{L}$.
In terms of intersection theory, if $H_1$, $H_2$ are ample effective
Cartier divisors on $S$,
then there is no (upper) bound on the intersection number $H_1 \cdot H_2$
in terms of $H_1 \cdot H_1$ and $H_2 \cdot H_2$.
\end{remark}

\begin{lemma}
\label{lemma-curves-qs-lfp}
The morphism $\Curvesstack \to \Spec(\mathbf{Z})$ is quasi-separated and
locally of finite presentation.
\end{lemma}

\begin{proof}
To check $\Curvesstack \to \Spec(\mathbf{Z})$ is quasi-separated we have to
show that its diagonal is quasi-compact and quasi-separated.
This is immediate from Lemma \ref{lemma-curves-diagonal-separated-fp}.
To prove that $\Curvesstack \to \Spec(\mathbf{Z})$ is locally of finite
presentation, it suffices to show that $\Curvesstack$
is limit preserving, see Limits of Stacks, Proposition
\ref{stacks-limits-proposition-characterize-locally-finite-presentation}.
This is Quot, Lemma \ref{quot-lemma-curves-limits}.
\end{proof}






\section{Open substacks of the stack of curves}
\label{section-open}

\noindent
Below we will often characterize an open substack of $\Curvesstack$
by a propery $P$ of morphisms of algebraic spaces. To see that $P$
defines an open substack it suffices to check
\begin{enumerate}
\item[(o)] given a family of curves $f : X \to S$ there exists
a largest open subscheme $S' \subset S$ such that
$f|_{f^{-1}(S')} : f^{-1}(S') \to S'$ has $P$ and such that
formation of $S'$ commutes with arbitrary base change.
\end{enumerate}
Namely, suppose (o) holds. Choose a scheme $U$ and a surjective
smooth morphism $m : U \to \Curvesstack$. Let
$R = U \times_{\Curvesstack} U$ and denote $t, s : R \to U$
the projections. Recall that $\Curvesstack = [U/R]$ is a presentation,
see Algebraic Stacks, Lemma \ref{algebraic-lemma-stack-presentation} and
Definition \ref{algebraic-definition-presentation}.
By construction of $\Curvesstack$ as
the stack of curves, the morphism $m$ is the classifying morphism
for a family of curves $C \to U$. The $2$-commutativity
of the diagram
$$
\xymatrix{
R \ar[r]_s \ar[d]_t & U \ar[d] \\
U \ar[r] & \Curvesstack
}
$$
implies that $C \times_{U, s} R  \cong C \times_{U, t} R$
(isomorphism of families of curves over $R$). Let $W \subset U$
be the largest open subscheme such that
$f|_{f^{-1}(W)} : f^{-1}(W) \to W$ has $P$ as in (o).
Since formation of $W$ commutes with base change according to (o)
and by the isomorphism above we find that $s^{-1}(W) = t^{-1}(W)$.
Thus $W \subset U$ corresponds to an open substack
$$
\Curvesstack^P \subset \Curvesstack
$$
according to Properties of Stacks, Lemma
\ref{stacks-properties-lemma-immersion-presentation}.

\medskip\noindent
Continuing with the setup of the previous paragrpah, we claim
the open substack $\Curvesstack^P$ has the following two universal properties:
\begin{enumerate}
\item given a family of curves $X \to S$ the following are equivalent
\begin{enumerate}
\item the classifying morphism $S \to \Curvesstack$ factors through
$\Curvesstack^P$,
\item the morphism $X \to S$ has $P$,
\end{enumerate}
\item given $X$ a proper scheme over a field $k$ of dimension $\leq 1$
the following are equivalent
\begin{enumerate}
\item the classifying morphism $\Spec(k) \to \Curvesstack$ factors
through $\Curvesstack^P$,
\item the morphism $X \to \Spec(k)$ has $P$.
\end{enumerate}
\end{enumerate}
This follows by considering the $2$-fibre product
$$
\xymatrix{
T \ar[r]_p \ar[d]_q & U \ar[d] \\
S \ar[r] & \Curvesstack
}
$$
Observe that $T \to S$ is surjective and smooth as the base
change of $U \to \Curvesstack$. Thus the open $S' \subset S$
given by (o) is determined by its inverse image in $T$.
However, by the invariance under base change of these opens in (o) 
and because $X \times_S T \cong C \times_U T$ by the $2$-commutativity,
we find $q^{-1}(S') = p^{-1}(W)$ as opens of $T$.
This immediately implies (1). Part (2) is a special case of (1).

\medskip\noindent
Given two properties $P$ and $Q$ of morphisms of algebraic spaces,
supposing we already have esthablished $\Curvesstack^Q$ is
an open substack of $\Curvesstack$, then we can use exactly
the same method to prove openness of
$\Curvesstack^{Q, P} \subset \Curvesstack^Q$.
We omit a precise explanation.



\section{Curves with finite reduced automorphism groups}
\label{section-finite-aut}

\noindent
Let $X$ be a proper scheme over a field $k$ of dimension $\leq 1$, i.e.,
an object of $\Curvesstack$ over $k$.
By Lemma \ref{lemma-curves-diagonal-separated-fp}
the automorphism group algebraic space $\mathit{Aut}(X)$
is finite type and separated over $k$.
In particular, $\mathit{Aut}(X)$ is a group scheme, see
More on Groupoids in Spaces, Lemma
\ref{spaces-more-groupoids-lemma-group-space-scheme-locally-finite-type-over-k}.
If the characteristic of $k$ is zero, then $\mathit{Aut}(X)$
is reduced and even smooth over $k$ (Groupoids, Lemma
\ref{groupoids-lemma-group-scheme-characteristic-zero-smooth}).
However, in general $\mathit{Aut}(X)$ is not reduced, even
if $X$ is geometrically reduced.

\begin{example}[Non-reduced automorphism group]
\label{example-non-reduced}
Let $k$ be an algebraically closed field of characteristic $2$.
Set $Y = Z = \mathbf{P}^1_k$. Choose three pairwise distinct $k$-valued points
$a, b, c$ in $\mathbf{A}^1_k$. Thinking of
$\mathbf{A}^1_k \subset \mathbf{P}^1_k = Y = Z$ as an open subschemes,
we get a closed immersion
$$
T =  \Spec(k[t]/(t - a)^2) \amalg \Spec(k[t]/(t - b)^2)
\amalg \Spec(k[t]/(t - c)^2)
\longrightarrow
\mathbf{P}^1_k
$$
Let $X$ be the pushout in the diagram
$$
\xymatrix{
T \ar[r] \ar[d] & Y \ar[d] \\
Z \ar[r] & X
}
$$
Let $U \subset X$ be the affine open part which is the image of
$\mathbf{A}^1_k \amalg \mathbf{A}^1_k$. Then we have an equalizer
diagram
$$
\xymatrix{
\mathcal{O}_X(U) \ar[r] &
k[t] \times k[t] \ar@<1ex>[r] \ar@<-1ex>[r] &
k[t]/(t - a)^2 \times k[t]/(t - b)^2 \times k[t]/(t - c)^2
}
$$
Over the dual numbers $A = k[\epsilon]$ we have a nontrivial automorphism
of this equalizer diagram sending $t$ to $t + \epsilon$. We leave it to the
reader to see that this automorphism extends to an automorphism of $X$
over $A$. On the other hand, the reader easily shows that the
automorphism group of $X$ over $k$ is finite.
Thus $\mathit{Aut}(X)$ must be non-reduced.
\end{example}

\noindent
Let $X$ be a proper scheme over a field $k$ of dimension $\leq 1$, i.e.,
an object of $\Curvesstack$ over $k$. If $\mathit{Aut}(X)$
is geometrically reduced, then it need not be the case that
it has dimension $0$, even if $X$ is smooth and geometrically connected.

\begin{example}[Smooth positive dimensional automorphism group]
\label{example-pos-dim}
Let $k$ be an algebraically closed field. If $X$ is a smooth
genus $0$, resp.\ $1$ curve, then the automorphism group has
dimension $3$, resp.\ $1$. Namely, in the genus $0$ case we have
$X \cong \mathbf{P}^1_k$ by Algebraic Curves, Proposition
\ref{curves-proposition-projective-line}. Since
$$
\mathit{Aut}(\mathbf{P}^1_k) = \text{PGL}_{2, k}
$$
as functors we see that the dimension is $3$. On the other hand,
if the genus of $X$ is $1$, then we see that the map
$X = \underline{\Hilbfunctor}^1_{X/k} \to
\underline{\Picardfunctor}^1_{X/k}$ is an isomorphism, see
Picard Schemes of Curves, Lemma \ref{pic-lemma-picard-pieces}
and
Algebraic Curves, Theorem \ref{curves-theorem-curves-rational-maps}.
Thus $X$ has the structure of an abelian variety
(since $\underline{\Picardfunctor}^1_{X/k} \cong
\underline{\Picardfunctor}^0_{X/k}$).
In particular the (co)tangent bundle of $X$ are trivial
(Groupoids, Lemma \ref{groupoids-lemma-group-scheme-module-differentials}).
We conclude that $\dim_k H^0(X, T_X) = 1$ hence
$\dim \mathit{Aut}(X) \leq 1$. On the other hand, the translations
(viewing $X$ as a group scheme) provide a $1$-dimensional
piece of $\text{Aut}(X)$ and we conlude its dimension is indeed $1$.
\end{example}

\noindent
It turns out that there is an open substack of
$\Curvesstack$ parametrizing curves whose automorphism
group is geometrically reduced and finite.
Here is a precise statement.

\begin{lemma}
\label{lemma-DM-curves}
There exist an open substack $\Curvesstack^{DM} \subset \Curvesstack$
with the following properties
\begin{enumerate}
\item $\Curvesstack^{DM} \subset \Curvesstack$ is the maximal
open substack which is DM,
\item given a family of curves $X \to S$ the following are equivalent
\begin{enumerate}
\item the classifying morphism $S \to \Curvesstack$ factors through
$\Curvesstack^{DM}$,
\item the group algebraic space $\mathit{Aut}_S(X)$ is unramified over $S$,
\end{enumerate}
\item given $X$ a proper scheme over a field $k$ of dimension $\leq 1$
the following are equivalent
\begin{enumerate}
\item the classifying morphism $\Spec(k) \to \Curvesstack$ factors
through $\Curvesstack^{DM}$,
\item $\mathit{Aut}(X)$ is geometrically reduced over $k$ and
has dimension $0$,
\item $\mathit{Aut}(X) \to \Spec(k)$ is unramified.
\end{enumerate}
\end{enumerate}
\end{lemma}

\begin{proof}
The existence of an open substack with property (1) is
Morphisms of Stacks, Lemma \ref{stacks-morphisms-lemma-open-DM-locus}.
The points of this open substack are characterized by (3)(c) by
Morphisms of Stacks, Lemma \ref{stacks-morphisms-lemma-points-DM-locus}.
The equivalence of (3)(b) and (3)(c) is the statement that an
algebraic space $G$ which is locally of finite type, geometrically reduced,
and of dimension $0$ over a field $k$, is unramified over $k$.
First, $G$ is a scheme by Spaces over Fields, Lemma
\ref{spaces-over-fields-lemma-locally-finite-type-dim-zero}.
Then we can take an affine open in $G$ and observe
that it will be proper over $k$ and apply
Varieties, Lemma
\ref{varieties-lemma-proper-geometrically-reduced-global-sections}.
Minor details omitted.

\medskip\noindent
Part (2) is true because (3) holds. Namely, the morphism
$\mathit{Aut}_S(X) \to S$ is locally of finite type. Thus we can check whether
$\mathit{Aut}_S(X) \to S$ is unramified at all points of
$\mathit{Aut}_S(X)$ by checking on fibres at points of the scheme $S$, see
Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-where-unramified}.
But after base change to a point of $S$ we fall back into
the equivalence of (3)(a) and (3)(c).
\end{proof}





\section{Cohen-Macaulay curves}
\label{section-CM}

\noindent
There is an open substack of $\Curvesstack$ parametrizing
the Cohen-Macaulay ``curves''.

\begin{lemma}
\label{lemma-CM-curves}
There exist an open substack $\Curvesstack^{CM} \subset \Curvesstack$
such that
\begin{enumerate}
\item given a family of curves $X \to S$ the following are equivalent
\begin{enumerate}
\item the classifying morphism $S \to \Curvesstack$ factors
through $\Curvesstack^{CM}$,
\item the morphism $X \to S$ is Cohen-Macaulay,
\end{enumerate}
\item given a scheme $X$ proper over a field $k$ with $\dim(X) \leq 1$
the following are equivalent
\begin{enumerate}
\item the classifying morphism $\Spec(k) \to \Curvesstack$ factors
through $\Curvesstack^{CM}$,
\item $X$ is Cohen-Macaulay.
\end{enumerate}
\end{enumerate}
\end{lemma}

\begin{proof}
Let $f : X \to S$ be a family of curves. By
More on Morphisms of Spaces, Lemma
\ref{spaces-more-morphisms-lemma-flat-finite-presentation-CM-open}
the set
$$
W = \{x \in |X| : f \text{ is Cohen-Macaulay at }x\}
$$
is open in $|X|$ and formation of this open commutes with arbitrary
base change. Since $f$ is proper the subset
$$
S' = S \setminus f(|X| \setminus W)
$$
of $S$ is open and $X \times_S S' \to S'$ is Cohen-Macaulay.
Moreover, formation of $S'$ commutes with arbitrary base
change because this is true for $W$
Thus we get the open substack with the desired properties
by the method discussed in Section \ref{section-open}.
\end{proof}

\begin{lemma}
\label{lemma-CM-1-curves}
There exist an open substack $\Curvesstack^{CM, 1} \subset \Curvesstack$
such that
\begin{enumerate}
\item given a family of curves $X \to S$ the following are equivalent
\begin{enumerate}
\item the classifying morphism $S \to \Curvesstack$ factors
through $\Curvesstack^{CM, 1}$,
\item the morphism $X \to S$ is Cohen-Macaulay and has
relative dimension $1$ (Morphisms of Spaces, Definition
\ref{spaces-morphisms-definition-relative-dimension}),
\end{enumerate}
\item given a scheme $X$ proper over a field $k$ with $\dim(X) \leq 1$
the following are equivalent
\begin{enumerate}
\item the classifying morphism $\Spec(k) \to \Curvesstack$ factors
through $\Curvesstack^{CM, 1}$,
\item $X$ is Cohen-Macaulay and every irreducible component of $X$
has dimension $1$.
\end{enumerate}
\end{enumerate}
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-CM-curves} it is clear that we have
$\Curvesstack^{CM, 1} \subset \Curvesstack^{CM}$
if it exists. Let $f : X \to S$ be a family of curves
such that $f$ is a Cohen-Macaulay morphism. By
More on Morphisms of Spaces, Lemma
\ref{spaces-more-morphisms-lemma-lfp-CM-relative-dimension}
we have a decomposition
$$
X = X_0 \amalg X_1
$$
by open and closed subspaces such that $X_0 \to S$ has relative
dimension $0$ and $X_1 \to S$ has relative dimension $1$.
Since $f$ is proper the subset
$$
S' = S \setminus f(|X_0|)
$$
of $S$ is open and $X \times_S S' \to S'$ is Cohen-Macaulay
and has relative dimension $1$.
Moreover, formation of $S'$ commutes with arbitrary base
change because this is true for the decomposition above
(as relative dimension behaves well with respect to base
change, see Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-dimension-fibre-after-base-change}).
Thus we get the open substack with the desired properties
by the method discussed in Section \ref{section-open}.
\end{proof}







\section{Curves of a given genus}
\label{section-genus}

\noindent
The convention in the Stacks project is that the genus $g$ of a
proper $1$-dimensional scheme $X$ over a field $k$ is defined only
if $H^0(X, \mathcal{O}_X) = k$. In this case
$g = \dim_k H^1(X, \mathcal{O}_X)$.
See Algebraic Curves, Section \ref{curves-section-genus}.
The conditions needed to define the genus define an open substack
which is then a disjoint union of open substacks, one for each genus.

\begin{lemma}
\label{lemma-pre-genus-curves}
There exist an open substack $\Curvesstack^{h0, 1} \subset \Curvesstack$
such that
\begin{enumerate}
\item given a family of curves $f : X \to S$ the following are equivalent
\begin{enumerate}
\item the classifying morphism $S \to \Curvesstack$ factors
through $\Curvesstack^{h0, 1}$,
\item $f_*\mathcal{O}_X = \mathcal{O}_S$ and this continues to hold
after any base change and the fibres of $f$ have dimension $1$,
\end{enumerate}
\item given a scheme $X$ proper over a field $k$ with $\dim(X) \leq 1$
the following are equivalent
\begin{enumerate}
\item the classifying morphism $\Spec(k) \to \Curvesstack$ factors
through $\Curvesstack^{h0, 1}$,
\item $H^0(X, \mathcal{O}_X) = k$ and $\dim(X) = 1$.
\end{enumerate}
\end{enumerate}
\end{lemma}

\begin{proof}
Given a family of curves $X \to S$ the set of $s \in S$ where
$\kappa(s) = H^0(X_s, \mathcal{O}_{X_s})$
is open in $S$ by Derived Categories of Spaces, Lemma
\ref{spaces-perfect-lemma-jump-loci-geometric}.
Also, the set of points in $S$ where the fibre has
dimension $1$ is open by More on Morphisms of Spaces, Lemma
\ref{spaces-more-morphisms-lemma-dimension-fibres-proper-flat}.
Moreover, if $f : X \to S$ is a family of curves all of whose fibres
have dimension $1$ (and in particular $f$ is surjective), then
condition (1)(b) is equivalent to
$\kappa(s) = H^0(X_s, \mathcal{O}_{X_s})$ for every $s \in S$, see
Derived Categories of Spaces, Lemma \ref{spaces-perfect-lemma-proper-flat-h0}.
Thus we see that the lemma follows from the general discussion in
Section \ref{section-open}.
\end{proof}

\begin{lemma}
\label{lemma-pre-genus-in-CM-1}
We have $\Curvesstack^{h0, 1} \subset \Curvesstack^{CM, 1}$
as open substacks of $\Curvesstack$.
\end{lemma}

\begin{proof}
See Algebraic Curves, Lemma \ref{curves-lemma-automatic} and
Lemmas \ref{lemma-pre-genus-curves} and \ref{lemma-CM-1-curves}.
\end{proof}

\begin{lemma}
\label{lemma-genus}
Let $f : X \to S$ be a family of curves such that
$\kappa(s) = H^0(X_s, \mathcal{O}_{X_s})$ for all $s \in S$, i.e.,
the classifying morphism $S \to \Curvesstack$ factors
through $\Curvesstack^{h0, 1}$ (Lemma \ref{lemma-pre-genus-curves}). Then
\begin{enumerate}
\item $f_*\mathcal{O}_X = \mathcal{O}_S$ and this holds universally,
\item $R^1f_*\mathcal{O}_X$ is a finite locally free $\mathcal{O}_S$-module,
\item for any morphism $h : S' \to S$ if $f' : X' \to S'$ is the base change,
then $h^*(R^1f_*\mathcal{O}_X) = R^1f'_*\mathcal{O}_{X'}$.
\end{enumerate}
\end{lemma}

\begin{proof}
We apply Derived Categories of Spaces, Lemma
\ref{spaces-perfect-lemma-proper-flat-h0}.
This proves part (1). It also implies that locally on $S$
we can write $Rf_*\mathcal{O}_X = \mathcal{O}_S \oplus P$
where $P$ is perfect of tor amplitude in $[1, \infty)$.
Recall that formation of $Rf_*\mathcal{O}_X$ commutes
with arbitrary base change
(Derived Categories of Spaces, Lemma
\ref{spaces-perfect-lemma-flat-proper-perfect-direct-image-general}).
Thus for $s \in S$ we have
$$
H^i(P \otimes_{\mathcal{O}_S}^\mathbf{L} \kappa(s)) =
H^i(X_s, \mathcal{O}_{X_s})
\text{ for }i \geq 1
$$
This is zero unless $i = 1$ since $X_s$ is a $1$-dimensional
Noetherian scheme, see
Cohomology, Proposition \ref{cohomology-proposition-vanishing-Noetherian}.
Then $P = H^1(P)[-1]$ and $H^1(P)$ is finite locally free
for example by More on Algebra, Lemma
\ref{more-algebra-lemma-lift-perfect-from-residue-field}.
Since everything is compatible with base change we
also see that (3) holds.
\end{proof}

\begin{lemma}
\label{lemma-pre-genus-one-piece-per-genus}
There is a decomposition into open and closed substacks
$$
\Curvesstack^{h0, 1} = \coprod\nolimits_{g \geq 0} \Curvesstack_g
$$
where each $\Curvesstack_g$ is characterized as follows:
\begin{enumerate}
\item given a family of curves $f : X \to S$ the following are equivalent
\begin{enumerate}
\item the classifying morphism $S \to \Curvesstack$ factors
through $\Curvesstack_g$,
\item $f_*\mathcal{O}_X = \mathcal{O}_S$ and this continuous to hold
after arbitrary base change, the fibres of $f$ have dimension $1$, and
$R^1f_*\mathcal{O}_X$ is a locally free $\mathcal{O}_S$-module of rank $g$,
\end{enumerate}
\item given a scheme $X$ proper over a field $k$ with $\dim(X) \leq 1$
the following are equivalent
\begin{enumerate}
\item the classifying morphism $\Spec(k) \to \Curvesstack$ factors
through $\Curvesstack_g$,
\item $\dim(X) = 1$, $k = H^0(X, \mathcal{O}_X)$, and
the genus of $X$ is $g$.
\end{enumerate}
\end{enumerate}
\end{lemma}

\begin{proof}
We already have the existence of $\Curvesstack^{h0, 1}$ as an open
substack of $\Curvesstack$ characterized by the conditions of the
lemma not involving $R^1f_*$ or $H^1$, see Lemma \ref{lemma-pre-genus-curves}.
The existence of the decomposition into open and closed substacks
follows immediately from the discussion in Section \ref{section-open}
and Lemma \ref{lemma-genus}. This proves the characterization in (1).
The characterization in (2) follows from the definition of the
genus in Algebraic Curves, Definition \ref{curves-definition-genus}.
\end{proof}









\section{Geometrically reduced curves}
\label{section-geometrically-reduced}

\noindent
There is an open substack of $\Curvesstack$ parametrizing
the geometrically reduced ``curves''.

\begin{lemma}
\label{lemma-geometrically-reduced-curves}
There exist an open substack $\Curvesstack^{geomred} \subset \Curvesstack$
such that
\begin{enumerate}
\item given a family of curves $X \to S$ the following are equivalent
\begin{enumerate}
\item the classifying morphism $S \to \Curvesstack$ factors
through $\Curvesstack^{geomred}$,
\item the fibres of the morphism $X \to S$ are geometrically reduced
(More on Morphisms of Spaces, Definition
\ref{spaces-more-morphisms-definition-geometrically-reduced-fibre}),
\end{enumerate}
\item given a scheme $X$ proper over a field $k$ with $\dim(X) \leq 1$
the following are equivalent
\begin{enumerate}
\item the classifying morphism $\Spec(k) \to \Curvesstack$ factors
through $\Curvesstack^{geomred}$,
\item $X$ is geometrically reduced over $k$.
\end{enumerate}
\end{enumerate}
\end{lemma}

\begin{proof}
Let $f : X \to S$ be a family of curves. By
More on Morphisms of Spaces, Lemma
\ref{spaces-more-morphisms-lemma-geometrically-reduced-open}
the set
$$
E = \{s \in S : \text{the fibre of }X \to S\text{ at }s
\text{ is geometrically reduced}\}
$$
is open in $S$. Formation of this open commutes with arbitrary
base change by
More on Morphisms of Spaces, Lemma
\ref{spaces-more-morphisms-lemma-base-change-fibres-geometrically-reduced}.
Thus we get the open substack with the desired properties
by the method discussed in Section \ref{section-open}.
\end{proof}

\begin{lemma}
\label{lemma-geomred-in-CM}
We have $\Curvesstack^{geomred} \subset \Curvesstack^{CM}$
as open substacks of $\Curvesstack$.
\end{lemma}

\begin{proof}
This is true because a reduced Noetherian scheme of
dimension $\leq 1$ is Cohen-Macaulay. See
Algebra, Lemma \ref{algebra-lemma-criterion-reduced}.
\end{proof}






\section{Geometrically reduced and connected curves}
\label{section-geometrically-reduced-connected}

\noindent
There is an open substack of $\Curvesstack$ parametrizing
the geometrically reduced and connected ``curves''.
We will get rid of $0$-dimensional objects right away.

\begin{lemma}
\label{lemma-geometrically-reduced-connected-1-curves}
There exist an open substack $\Curvesstack^{grc, 1} \subset \Curvesstack$
such that
\begin{enumerate}
\item given a family of curves $X \to S$ the following are equivalent
\begin{enumerate}
\item the classifying morphism $S \to \Curvesstack$ factors
through $\Curvesstack^{grc, 1}$,
\item the geometric fibres of the morphism $X \to S$ are
reduced, connected, and have dimension $1$,
\end{enumerate}
\item given a scheme $X$ proper over a field $k$ with $\dim(X) \leq 1$
the following are equivalent
\begin{enumerate}
\item the classifying morphism $\Spec(k) \to \Curvesstack$ factors
through $\Curvesstack^{grc, 1}$,
\item $X$ is geometrically reduced, geometrically connected,
and has dimension $1$.
\end{enumerate}
\end{enumerate}
\end{lemma}

\begin{proof}
By Lemmas \ref{lemma-geometrically-reduced-curves},
\ref{lemma-geomred-in-CM}, \ref{lemma-CM-curves}, and \ref{lemma-CM-1-curves}
it is clear that we have
$$
\Curvesstack^{geomredcon}
\subset
\Curvesstack^{geomred} \cap \Curvesstack^{CM, 1}
$$
if it exists. Let $f : X \to S$ be a family of curves such that $f$ is
Cohen-Macaulay, has geometrically reduced fibres, and
has relative dimension $1$. By
More on Morphisms of Spaces, Lemma
\ref{spaces-more-morphisms-lemma-stein-factorization-etale}
in the Stein factorization
$$
X \to T \to S
$$
the morphism $T \to S$ is \'etale. This implies that
there is an open and closed subscheme $S' \subset S$
such that $X \times_S S' \to S'$ has geometrically
connected fibres (in the decomposition of
Morphisms, Lemma \ref{morphisms-lemma-finite-locally-free}
for the finite locally free morphism $T \to S$
this corresponds to $S_1$).
Formation of this open commutes with arbitrary base change
because the number of connected components of geometric
fibres is invariant under base change (it is also true
that the Stein factorization commutes with base change
in our particular case but we don't need this to conclude).
Thus we get the open substack with the desired properties
by the method discussed in Section \ref{section-open}.
\end{proof}

\begin{lemma}
\label{lemma-geomredcon-in-h0-1}
We have $\Curvesstack^{grc, 1} \subset \Curvesstack^{h0, 1}$
as open substacks of $\Curvesstack$. In particular, given
a family of curves $f : X \to S$
whose geometric fibres are reduced, connected and of dimension $1$, then
$R^1f_*\mathcal{O}_X$ is a finite locally free $\mathcal{O}_S$-module
whose formation commutes with arbitrary base change.
\end{lemma}

\begin{proof}
This follows from Varieties, Lemma
\ref{varieties-lemma-proper-geometrically-reduced-global-sections}
and Lemmas \ref{lemma-pre-genus-curves} and
\ref{lemma-geometrically-reduced-connected-1-curves}.
The final statement follows from Lemma \ref{lemma-genus}.
\end{proof}

\begin{lemma}
\label{lemma-one-piece-per-genus}
There is a decomposition into open and closed substacks
$$
\Curvesstack^{grc, 1} = \coprod\nolimits_{g \geq 0} \Curvesstack^{grc, 1}_g
$$
where each $\Curvesstack^{grc, 1}_g$ is characterized as follows:
\begin{enumerate}
\item given a family of curves $f : X \to S$ the following are equivalent
\begin{enumerate}
\item the classifying morphism $S \to \Curvesstack$ factors
through $\Curvesstack^{grc, 1}_g$,
\item the geometric fibres of the morphism $f : X \to S$ are
reduced, connected, of dimension $1$ and
$R^1f_*\mathcal{O}_X$ is a locally free $\mathcal{O}_S$-module
of rank $g$,
\end{enumerate}
\item given a scheme $X$ proper over a field $k$ with $\dim(X) \leq 1$
the following are equivalent
\begin{enumerate}
\item the classifying morphism $\Spec(k) \to \Curvesstack$ factors
through $\Curvesstack^{grc, 1}_g$,
\item $X$ is geometrically reduced, geometrically connected,
has dimension $1$, and has genus $g$.
\end{enumerate}
\end{enumerate}
\end{lemma}

\begin{proof}
First proof: set
$\Curvesstack^{grc, 1}_g = \Curvesstack^{grc, 1} \cap \Curvesstack_g$
and combine
Lemmas \ref{lemma-geomredcon-in-h0-1} and \ref{lemma-pre-genus-one-piece-per-genus}.
Second proof:
The existence of the decomposition into open and closed substacks
follows immediately from the discussion in Section \ref{section-open}
and Lemma \ref{lemma-genus}. This proves the characterization in (1).
The characterization in (2) follows as well since
the genus of a geometrically reduced and connected
proper $1$-dimensional scheme $X/k$ is defined
(Algebraic Curves, Definition \ref{curves-definition-genus} and
Varieties, Lemma
\ref{varieties-lemma-proper-geometrically-reduced-global-sections})
and is equal to $\dim_k H^1(X, \mathcal{O}_X)$.
\end{proof}







\section{Gorenstein curves}
\label{section-gorenstein}

\noindent
There is an open substack of $\Curvesstack$ parametrizing
the Gorenstein ``curves''.

\begin{lemma}
\label{lemma-gorenstein-curves}
There exist an open substack $\Curvesstack^{Gorenstein} \subset \Curvesstack$
such that
\begin{enumerate}
\item given a family of curves $X \to S$ the following are equivalent
\begin{enumerate}
\item the classifying morphism $S \to \Curvesstack$ factors
through $\Curvesstack^{Gorenstein}$,
\item the morphism $X \to S$ is Gorenstein,
\end{enumerate}
\item given a scheme $X$ proper over a field $k$ with $\dim(X) \leq 1$
the following are equivalent
\begin{enumerate}
\item the classifying morphism $\Spec(k) \to \Curvesstack$ factors
through $\Curvesstack^{Gorenstein}$,
\item $X$ is Gorenstein.
\end{enumerate}
\end{enumerate}
\end{lemma}

\begin{proof}
Let $f : X \to S$ be a family of curves. By
More on Morphisms of Spaces, Lemma
\ref{spaces-more-morphisms-lemma-flat-finite-presentation-gorenstein-open}
the set
$$
W = \{x \in |X| : f \text{ is Gorenstein at }x\}
$$
is open in $|X|$ and formation of this open commutes with arbitrary
base change. Since $f$ is proper the subset
$$
S' = S \setminus f(|X| \setminus W)
$$
of $S$ is open and $X \times_S S' \to S'$ is Gorenstein.
Moreover, formation of $S'$ commutes with arbitrary base
change because this is true for $W$
Thus we get the open substack with the desired properties
by the method discussed in Section \ref{section-open}.
\end{proof}

\begin{lemma}
\label{lemma-gorenstein-1-curves}
There exist an open substack
$\Curvesstack^{Gorenstein, 1} \subset \Curvesstack$ such that
\begin{enumerate}
\item given a family of curves $X \to S$ the following are equivalent
\begin{enumerate}
\item the classifying morphism $S \to \Curvesstack$ factors
through $\Curvesstack^{Gorenstein, 1}$,
\item the morphism $X \to S$ is Gorenstein and has
relative dimension $1$ (Morphisms of Spaces, Definition
\ref{spaces-morphisms-definition-relative-dimension}),
\end{enumerate}
\item given a scheme $X$ proper over a field $k$ with $\dim(X) \leq 1$
the following are equivalent
\begin{enumerate}
\item the classifying morphism $\Spec(k) \to \Curvesstack$ factors
through $\Curvesstack^{Gorenstein, 1}$,
\item $X$ is Gorenstein and every irreducible component of $X$
has dimension $1$.
\end{enumerate}
\end{enumerate}
\end{lemma}

\begin{proof}
Recall that a Gorenstein scheme is Cohen-Macaulay
(Duality for Schemes, Lemma \ref{duality-lemma-gorenstein-CM})
and that
a Gorenstein morphism is a Cohen-Macaulay morphism
(Duality for Schemes, Lemma \ref{duality-lemma-gorenstein-CM-morphism}.
Thus we can set
$\Curvesstack^{Gorenstein, 1}$ equal to the intersection
of $\Curvesstack^{Gorenstein}$ and $\Curvesstack^{CM, 1}$
inside of $\Curvesstack$ and use
Lemmas \ref{lemma-gorenstein-curves} and \ref{lemma-CM-1-curves}.
\end{proof}






\section{Local complete intersection curves}
\label{section-lci}

\noindent
There is an open substack of $\Curvesstack$ parametrizing
the local complete intersection ``curves''.

\begin{lemma}
\label{lemma-lci-curves}
There exist an open substack $\Curvesstack^{lci} \subset \Curvesstack$
such that
\begin{enumerate}
\item given a family of curves $X \to S$ the following are equivalent
\begin{enumerate}
\item the classifying morphism $S \to \Curvesstack$ factors through
$\Curvesstack^{lci}$,
\item $X \to S$ is a local complete intersection morphism, and
\item $X \to S$ is a syntomic morphism.
\end{enumerate}
\item given $X$ a proper scheme over a field $k$ of dimension $\leq 1$
the following are equivalent
\begin{enumerate}
\item the classifying morphism $\Spec(k) \to \Curvesstack$ factors
through $\Curvesstack^{lci}$,
\item $X$ is a local complete intersection over $k$.
\end{enumerate}
\end{enumerate}
\end{lemma}

\begin{proof}
Recall that being a syntomic morphism is the same as being flat and
a local complete intersection morphism, see
More on Morphisms of Spaces, Lemma \ref{spaces-more-morphisms-lemma-flat-lci}.
Thus (1)(b) is equivalent to (1)(c).
In Section \ref{section-open} we have seen
it suffices to show that given a family of curves
$f : X \to S$, there is an open subscheme $S' \subset S$
such that $S' \times_S X \to S'$ is a local complete intersection
morphism and such that formation of $S'$ commutes with arbitrary base change.
This follows from the more general
More on Morphisms of Spaces, Lemma \ref{spaces-more-morphisms-lemma-where-lci}.
\end{proof}




\section{Curves with isolated singularities}
\label{section-curves-isolated}

\noindent
We can look at the open substack of $\Curvesstack$
parametrizing ``curves'' with only a finite number of singular
points (these may correspond to $0$-dimensional components
in our setup).

\begin{lemma}
\label{lemma-isolated-sings-curves}
There exist an open substack
$\Curvesstack^{+} \subset \Curvesstack$
such that
\begin{enumerate}
\item given a family of curves $X \to S$ the following are equivalent
\begin{enumerate}
\item the classifying morphism $S \to \Curvesstack$ factors through
$\Curvesstack^{+}$,
\item the singular locus of $X \to S$ endowed
with any/some closed subspace structure is finite over $S$.
\end{enumerate}
\item given $X$ a proper scheme over a field $k$ of dimension $\leq 1$
the following are equivalent
\begin{enumerate}
\item the classifying morphism $\Spec(k) \to \Curvesstack$ factors
through $\Curvesstack^{+}$,
\item $X \to \Spec(k)$ is smooth except at finitely many points.
\end{enumerate}
\end{enumerate}
\end{lemma}

\begin{proof}
To prove the lemma it suffices to show that given a family of curves
$f : X \to S$, there is an open subscheme $S' \subset S$
such that the fibre of $S' \times_S X \to S'$ have property (2).
(Formation of the open will automatically commute with base change.)
By definition the locus $T \subset |X|$ of points where $X \to S$
is not smooth is closed. Let $Z \subset X$ be the closed subspace
given by the reduced induced algebraic space structure on $T$
(Properties of Spaces, Definition
\ref{spaces-properties-definition-reduced-induced-space}).
Now if $s \in S$ is a point where $Z_s$ is finite, then there
is an open neighbourhood $U_s \subset S$ of $s$ such that
$Z \cap f^{-1}(U_s) \to U_s$ is finite, see
More on Morphisms of Spaces, Lemma
\ref{spaces-more-morphisms-lemma-proper-finite-fibre-finite-in-neighbourhood}.
This proves the lemma.
\end{proof}




\section{The smooth locus of the stack of curves}
\label{section-smooth}

\noindent
The morphism
$$
\Curvesstack \longrightarrow \Spec(\mathbf{Z})
$$
is smooth over a maximal open substack, see
Morphisms of Stacks, Lemma \ref{stacks-morphisms-lemma-where-smooth}.
We want to give a criterion for when a curve is in this locus.
We will do this using a bit of deformation theory.

\medskip\noindent
Let $k$ be a field. Let $X$ be a proper scheme of dimension $\leq 1$ over $k$.
Choose a Cohen ring $\Lambda$ for $k$, see
Algebra, Lemma \ref{algebra-lemma-cohen-rings-exist}.
Then we are in the situation described in
Deformation Problems, Example \ref{examples-defos-example-schemes} and
Lemma \ref{examples-defos-lemma-schemes-RS}.
Thus we obtain a deformation category $\Deformationcategory_X$
on the category $\mathcal{C}_\Lambda$ of Artinian local
$\Lambda$-algebras with residue field $k$.

\begin{lemma}
\label{lemma-in-smooth-locus}
In the situation above the following are equivalent
\begin{enumerate}
\item the classifying morphism $\Spec(k) \to \Curvesstack$ factors
through the open where $\Curvesstack \to \Spec(\mathbf{Z})$ is smooth,
\item the deformation category $\Deformationcategory_X$ is unobstructed.
\end{enumerate}
\end{lemma}

\begin{proof}
Since $\Curvesstack \longrightarrow \Spec(\mathbf{Z})$ is locally
of finite presentation (Lemma \ref{lemma-curves-qs-lfp})
formation of the open substack where
$\Curvesstack \longrightarrow \Spec(\mathbf{Z})$ commutes with
flat base change
(Morphisms of Stacks, Lemma \ref{stacks-morphisms-lemma-where-smooth}).
Since the Cohen ring $\Lambda$ is flat over $\mathbf{Z}$,
we may work over $\Lambda$. In other words, we are trying to prove that
$$
\Lambda\text{-}\Curvesstack \longrightarrow \Spec(\Lambda)
$$
is smooth in an open neighbourhood of the point
$x_0 : \Spec(k) \to \Lambda\text{-}\Curvesstack$
defined by $X/k$ if and only if $\Deformationcategory_X$ is unobstructed.

\medskip\noindent
The lemma now follows from
Geometry of Stacks, Lemma \ref{stacks-geometry-lemma-characterize-smoothness}
and the equality
$$
\Deformationcategory_X =
\mathcal{F}_{\Lambda\text{-}\Curvesstack, k, x_0}
$$
This equality is not completely trivial to esthablish. Namely, on the left
hand side we have the deformation category classifying all flat deformations
$Y \to \Spec(A)$ of $X$ as a scheme over $A \in \Ob(\mathcal{C}_\Lambda)$.
On the right hand side we have the deformation category classifying all
flat morphisms $Y \to \Spec(A)$ with special fibre $X$
where $Y$ is an algebraic space and
$Y \to \Spec(A)$ is proper, of finite presentation, and of
relative dimension $\leq 1$. Since $A$ is Artinian, we find
that $Y$ is a scheme for example by Spaces over Fields, Lemma
\ref{spaces-over-fields-lemma-codim-1-point-in-schematic-locus}.
Thus it remains to show: a flat deformation $Y \to \Spec(A)$ of
$X$ as a scheme over an Artinian local ring $A$ with residue field $k$
is proper, of finite presentation, and of relative dimension $\leq 1$.
Relative dimension is defined in terms of fibres and hence holds
automatically for $Y/A$ since it holds for $X/k$.
The morphism $Y \to \Spec(A)$ is proper and locally of finite presentation
as this is true for $X \to \Spec(k)$, see
More on Morphisms, Lemma \ref{more-morphisms-lemma-deform-property}.
\end{proof}

\noindent
Here is a ``large'' open of the stack of curves which is contained
in the smooth locus.

\begin{lemma}
\label{lemma-big-smooth-part-curves}
The open substack
$$
\Curvesstack^{lci+} =
\Curvesstack^{lci} \cap \Curvesstack^{+}
\subset \Curvesstack
$$
has the following properties
\begin{enumerate}
\item $\Curvesstack^{lci+} \to \Spec(\mathbf{Z})$ is smooth,
\item given a family of curves $X \to S$ the following are equivalent
\begin{enumerate}
\item the classifying morphism $S \to \Curvesstack$ factors through
$\Curvesstack^{lci+}$,
\item $X \to S$ is a local complete intersection morphism and
the singular locus of $X \to S$ endowed with any/some closed subspace
structure is finite over $S$,
\end{enumerate}
\item given $X$ a proper scheme over a field $k$ of dimension $\leq 1$
the following are equivalent
\begin{enumerate}
\item the classifying morphism $\Spec(k) \to \Curvesstack$ factors
through $\Curvesstack^{lci+}$,
\item $X$ is a local complete intersection over $k$ and
$X \to \Spec(k)$ is smooth except at finitely many points.
\end{enumerate}
\end{enumerate}
\end{lemma}

\begin{proof}
If we can show that there is an open substack $\Curvesstack^{lci+}$
whose points are characterized by (2), then we see that
(1) holds by combining Lemma \ref{lemma-in-smooth-locus} with
Deformation Problems, Lemma \ref{examples-defos-lemma-curve-isolated-lci}.
Since
$$
\Curvesstack^{lci+} = \Curvesstack^{lci} \cap \Curvesstack^{+}
$$
inside $\Curvesstack$, we conclude by
Lemmas \ref{lemma-lci-curves} and \ref{lemma-isolated-sings-curves}.
\end{proof}




\section{Smooth curves}
\label{section-smooth-curves}

\noindent
The moduli stack of smooth curves defined as follows.

\begin{lemma}
\label{lemma-smooth-curves}
There exist an open substack $\Curvesstack^{smooth} \subset \Curvesstack$
such that
\begin{enumerate}
\item given a family of curves $f : X \to S$ the following are equivalent
\begin{enumerate}
\item $f$ is smooth of relative dimension $1$, and
\item the classifying morphism $S \to \Curvesstack$ factors
through $\Curvesstack^{smooth}$.
\end{enumerate}
\item given $X$ a scheme proper over a field $k$ with
$\dim(X) \leq 1$ the following are equivalent
\begin{enumerate}
\item the classifying morphism $\Spec(k) \to \Curvesstack$
factors through $\Curvesstack^{smooth}$,
\item $X$ is smooth.
\end{enumerate}
\end{enumerate}
\end{lemma}

\begin{proof}
To prove the lemma it suffices to show that given a family of curves
$f : X \to S$, there is an open subscheme $S' \subset S$
such that $S' \times_S X \to S'$ is smooth and such that the
formation of this open commutes with base change.
We know that there is a maximal open $U \subset X$ such
that $U \to S$ is smooth and that formation of $U$ commutes
with arbitrary base change, see
Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-where-smooth}.
If $T = |X| \setminus |U|$ then $f(T)$ is closed in $S$
as $f$ is proper.
Setting $S' = S \setminus f(T)$ finishes the proof.
\end{proof}

\begin{lemma}
\label{lemma-smooth-curves-smooth}
The morphism $\Curvesstack^{smooth} \to \Spec(\mathbf{Z})$ is smooth.
\end{lemma}

\begin{proof}
Follows immediately from the observation that
$\Curvesstack^{smooth} \subset \Curvesstack^{lci+}$
and Lemma \ref{lemma-big-smooth-part-curves}.
\end{proof}










\section{Nodal curves}
\label{section-nodal-curves}

\noindent
In algebraic geometry a special role is played by nodal curves.
We suggest the reader take a brief look at some of the discussion
in Algebraic Curves, Sections \ref{curves-section-nodal} and
\ref{curves-section-families-nodal}
and More on Morphisms of Spaces, Section
\ref{spaces-more-morphisms-section-families-nodal}.

\begin{lemma}
\label{lemma-nodal-curves}
There exist an open substack $\Curvesstack^{nodal} \subset \Curvesstack$
such that
\begin{enumerate}
\item given a family of curves $f : X \to S$ the following are equivalent
\begin{enumerate}
\item $f$ is at-worst-nodal of relative dimension $1$, and
\item the classifying morphism $S \to \Curvesstack$ factors
through $\Curvesstack^{nodal}$,
\end{enumerate}
\item given $X$ a scheme proper over a field $X$ with
$\dim(X) \leq 1$ the following are equivalent
\begin{enumerate}
\item the classifying morphism $\Spec(k) \to \Curvesstack$ factors
through $\Curvesstack^{nodal}$,
\item the singularities of $X$ are at-worst-nodal.
\end{enumerate}
\end{enumerate}
\end{lemma}

\begin{proof}
In fact, it suffices to show that given a family of curves
$f : X \to S$, there is an open subscheme $S' \subset S$
such that $S' \times_S X \to S'$ is at-worst-nodal of relative dimension $1$
and such that formation of $S'$ commutes with arbitrary base change.
By More on Morphisms of Spaces, Lemma
\ref{spaces-more-morphisms-lemma-locus-where-nodal}
there is a maximal open subspace $X' \subset X$ such
that $f|_{X'} : X' \to S$ is at-worst-nodal of relative dimension $1$.
Moreover, formation of $X'$ commutes with base change.
Hence we can take
$$
S' = S \setminus |f|(|X| \setminus |X'|)
$$
This is open because a proper morphism is universally closed by
definition.
\end{proof}

\begin{lemma}
\label{lemma-nodal-curves-smooth}
The morphism $\Curvesstack^{nodal} \to \Spec(\mathbf{Z})$ is smooth.
\end{lemma}

\begin{proof}
Follows immediately from the observation that
$\Curvesstack^{nodal} \subset \Curvesstack^{lci+}$
and Lemma \ref{lemma-big-smooth-part-curves}.
\end{proof}







\section{The relative dualizing sheaf}
\label{section-relative-dualizing}

\noindent
This section serves mainly
to introduce notation in the case of families of curves.
Most of the work has already been done in the chapter on duality.

\medskip\noindent
Let $f : X \to S$ be a family of curves. There exists an object
$\omega_{X/S}^\bullet$ in $D_\QCoh(\mathcal{O}_X)$,
called the {\it relative dualizing complex}, having the following
property: for every base change diagram
$$
\xymatrix{
X_U \ar[d]_{f'} \ar[r]_{g'} & X \ar[d]^f \\
U \ar[r]^g & S
}
$$
with $U = \Spec(A)$ affine the complex
$\omega_{X_U/U}^\bullet = L(g')^*\omega_{X/S}^\bullet$
represents the functor
$$
D_\QCoh(\mathcal{O}_{X_U}) \longrightarrow D(A),\quad
K \longmapsto R\Hom_T(Rf_*K, \mathcal{O}_T)
$$
More precisely, let $(\omega_{X/S}^\bullet, \tau)$
be the relative dualizing complex of the family as defined in
Duality for Spaces, Definition
\ref{spaces-duality-definition-relative-dualizing-proper-flat}.
Existence is shown in Duality for Spaces, Lemma
\ref{spaces-duality-lemma-existence-relative-dualizing}.
Moreover, formation of $(\omega_{X/S}^\bullet, \tau)$ commutes
with arbitrary base change (essentially by definition; a precise
reference is Duality for Spaces, Lemma
\ref{spaces-duality-lemma-base-change-relative-dualizing}).
From now on we will identify the base change of
$\omega_{X/S}^\bullet$ with the relative dualizing
complex of the base changed family without further mention.

\medskip\noindent
Let $\{S_i \to S\}$ be an \'etale covering with $S_i$ affine such that
$X_i = X \times_S S_i$ is a scheme, see Lemma \ref{lemma-etale-locally-scheme}.
By Duality for Spaces, Lemma \ref{spaces-duality-lemma-compare}
we find that $\omega_{X_i/S_i}^\bullet$ agrees with
the relative dualizing complex for the proper, flat, and
finitely presented morphism $f_i : X_i \to S_i$ of schemes
discussed in Duality for Schemes, Remark
\ref{duality-remark-relative-dualizing-complex}.
Thus to prove a property of $\omega_{X/S}^\bullet$
which is \'etale local, we may assume $X \to S$ is a morphism of schemes
and use the theory developped in the chapter on duality for schemes.
More generally, for any base change of $X$ which is a scheme,
the relative dualizing complex agrees with the
relative dualizing complex of Duality for Schemes, Remark
\ref{duality-remark-relative-dualizing-complex}.
From now on we will use this identification without further mention.

\medskip\noindent
In particular, let $\Spec(k) \to S$ be a morphism where $k$ is a field.
Denote $X_k$ the base change (this is a scheme by
Resolution of Surfaces Revisited, Lemma
\ref{spaces-resolve-lemma-projective-over-complete}).
Then $\omega_{X_k/k}^\bullet$ is isomorphic
to the complex $\omega_{X_k}^\bullet$ of
Algebraic Curves, Lemma \ref{curves-lemma-duality-dim-1}
(both represent the same functor and so we can use the Yoneda lemma,
but really this holds because of the remarks above).
We conclude that the cohomology sheaves
$H^i(\omega_{X_k/k}^\bullet)$
are nonzero only for $i = 0, -1$.
If $X_k$ is Cohen-Macaulay and equidimensional of dimension $1$,
then we only have $H^{-1}$ and if $X_k$ is in addition Gorenstein,
then $H^{-1}(\omega_{X_k/k})$ is invertible, see
Algebraic Curves, Lemmas \ref{curves-lemma-duality-dim-1-CM}
and \ref{curves-lemma-rr}.

\begin{lemma}
\label{lemma-CM-dualizing}
Let $X \to S$ be a family of curves with Cohen-Macaulay fibres
equidimensional of dimension $1$ (Lemma \ref{lemma-CM-1-curves}).
Then $\omega_{X/S}^\bullet = \omega_{X/S}[1]$ where $\omega_{X/S}$
is a pseudo-coherent $\mathcal{O}_X$-module flat over $S$ whose
formation commutes with arbitrary base change.
\end{lemma}

\begin{proof}
We urge the reader to deduce this directly from the discussion above
of what happens after base change to a field. Our proof will
use a somewhat cumbersome reduction to the Noetherian schemes case.

\medskip\noindent
Once we show $\omega_{X/S}^\bullet = \omega_{X/S}[1]$ with
$\omega_{X/S}$ flat over $S$, the statement on base change
will follow as we already know that formation of $\omega_{X/S}^\bullet$
commutes with arbitrary base change. Moreover, the pseudo-coherence
will be automatic as $\omega_{X/S}^\bullet$ is pseudo-coherent
by definition. Vanishing of the other cohomology sheaves and flatness 
may be checked \'etale locally. Thus we may assume $f : X \to S$
is a morphism of schemes with $S$ affine (see discussion above).
Write $S = \lim S_i$ as a cofiltered limit of affine schemes $S_i$
of finite type over $\mathbf{Z}$.
Since $\Curvesstack^{CM, 1}$ is locally of finite presentation over
$\mathbf{Z}$ (as an open substack of $\Curvesstack$, see
Lemmas \ref{lemma-CM-1-curves} and \ref{lemma-curves-qs-lfp}),
we can find an $i$ and a family
of curves $X_i \to S_i$ whose pullback is $X \to S$
(Limits of Stacks, Lemma
\ref{stacks-limits-lemma-representable-by-spaces-limit-preserving}).
After increasing $i$ if necessary we may assume $X_i$ is a scheme,
see Limits of Spaces, Lemma \ref{spaces-limits-lemma-limit-is-scheme}.
Since formation of $\omega_{X/S}^\bullet$ commutes with
arbitrary base change, we may replace $S$ by $S_i$.
Doing so we may and do assume $S_i$ is Noetherian.
Then $f$ is clearly a Cohen-Macaulay morphism
(More on Morphisms, Definition \ref{more-morphisms-definition-CM})
by our assumption on the fibres.
Also then $\omega_{X/S}^\bullet = f^!\mathcal{O}_S$
by the very construction of $f^!$ in
Duality for Schemes, Section \ref{duality-section-upper-shriek}.
Thus the lemma by Duality for Schemes, Lemma
\ref{duality-lemma-affine-flat-Noetherian-CM}.
\end{proof}

\begin{definition}
\label{definition-relative-dualizing-sheaf}
Let $f : X \to S$ be a family of curves with Cohen-Macaulay fibres
equidimensional of dimension $1$ (Lemma \ref{lemma-CM-1-curves}).
Then the $\mathcal{O}_X$-module
$$
\omega_{X/S} = H^{-1}(\omega_{X/S}^\bullet)
$$
studied in Lemma \ref{lemma-CM-dualizing}
is called the {\it relative dualizing sheaf} of $f$.
\end{definition}

\noindent
In the situation of Definition \ref{definition-relative-dualizing-sheaf}
the relative dualizing sheaf $\omega_{X/S}$ has the following property
(which moreover characterizes it locally on $S$):
for every base change diagram
$$
\xymatrix{
X_U \ar[d]_{f'} \ar[r]_{g'} & X \ar[d]^f \\
U \ar[r]^g & S
}
$$
with $U = \Spec(A)$ affine the module $\omega_{X_U/U} = (g')^*\omega_{X/S}$
represents the functor
$$
\QCoh(\mathcal{O}_{X_U}) \longrightarrow \text{Mod}_A,\quad
\mathcal{F} \longmapsto \Hom_A(H^1(X, \mathcal{F}), A)
$$
This follows immediately from the corresponding property of the relative
dualizing complex given above. In particular, if $A = k$ is a field,
then we recover the dualizing module of $X_k$ as introduced and studied in
Algebraic Curves, Lemmas \ref{curves-lemma-duality-dim-1},
\ref{curves-lemma-duality-dim-1-CM}, and \ref{curves-lemma-rr}.

\begin{lemma}
\label{lemma-gorenstein-dualizing}
Let $X \to S$ be a family of curves with Gorenstein fibres
equidimensional of dimension $1$ (Lemma \ref{lemma-gorenstein-1-curves}).
Then the relative dualizing sheaf $\omega_{X/S}$ is an
invertible $\mathcal{O}_X$-module whose
formation commutes with arbitrary base change.
\end{lemma}

\begin{proof}
This is true because the pullback of the relative dualizing module
to a fibre is invertible by the discussion above. Alternatively, you
can argue exactly as in the proof of
Lemma \ref{lemma-CM-dualizing} and deduce the result from
Duality for Schemes, Lemma
\ref{duality-lemma-affine-flat-Noetherian-gorenstein}.
\end{proof}






\section{Contraction morphisms}
\label{section-contracting}

\noindent
We urge the reader to familarize themselves with
Algebraic Curves, Section \ref{curves-section-contracting}
before continuing here.

\begin{lemma}
\label{lemma-contract-basic}
Let $f : X \to S$ be a family of curves. Let $s \in S$ be a point.
Let $h_0 : X_s \to Y_0$ be a morphism to a proper scheme $Y_0$ over $\kappa(s)$
such that $h_{0, *}\mathcal{O}_{X_s} = \mathcal{O}_{Y_0}$ and
$R^1h_{0, *}\mathcal{O}_{X_s} = 0$. Then there exist an elementary
\'etale neighbourhood $(U, u) \to (S, s)$, a family of curves $Y \to U$,
and a morphism $h : X_U \to Y$ over $U$ whose fibre in $u$
is isomorphic to $h_0$.
\end{lemma}

\begin{proof}
We first do some reductions; we urge the reader to skip ahead.
The question is local on $S$, hence we may assume $S$ is affine.
Write $S = \lim S_i$ as a cofiltered limit of affine schemes $S_i$
of finite type over $\mathbf{Z}$.
For some $i$ we can find a family of curves $X_i \to S_i$
whose base change is $X \to S$. This follows from
Lemma \ref{lemma-curves-qs-lfp} and Limits of Stacks, Lemma
\ref{stacks-limits-lemma-representable-by-spaces-limit-preserving}.
Let $s_i \in S_i$ be the image of $s$. Observe that
$\kappa(s) = \colim \kappa(s_i)$ and that $X_s$ is a scheme
(Resolution of Surfaces Revisited, Lemma
\ref{spaces-resolve-lemma-projective-over-complete}).
After increasing $i$ we may assume there exists a morphism
$h_{i, 0} : X_{i, s_i} \to Y_i$
of finite type schemes over $\kappa(s_i)$ whose base change to
$\kappa(s)$ is $h_0$, see
Limits, Lemma \ref{limits-lemma-descend-finite-presentation}.
After increasing $i$ we may assume $Y_i$ is proper over $\kappa(s_i)$, see
Limits, Lemma \ref{limits-lemma-eventually-proper}.
Let $g_{i, 0} : Y_0 \to Y_{i, 0}$ be the projection. Observe that
this is a faithfully flat morphism as the base change of
$\Spec(\kappa(s)) \to \Spec(\kappa(s_i))$.
By flat base change we have
$$
h_{0, *}\mathcal{O}_{X_s} = g_{i, 0}^*h_{i, 0, *}\mathcal{O}_{X_{i, s_i}}
\quad\text{and}\quad
R^1h_{0, *}\mathcal{O}_{X_s} = g_{i, 0}^*Rh_{i, 0, *}\mathcal{O}_{X_{i, s_i}}
$$
see Cohomology of Schemes, Lemma
\ref{coherent-lemma-flat-base-change-cohomology}.
By faithful flatness we see that $X_i \to S_i$, $s_i \in S_i$, and
$X_{i, s_i} \to Y_i$ satisfies all the assumptions of the lemma.
This reduces us to the case discussed in the next paragraph.

\medskip\noindent
Assume $S$ is affine of finite type over $\mathbf{Z}$.
Let $\mathcal{O}_{S, s}^h$ be the henselization of the local
ring of $S$ at $s$. Observe that $\mathcal{O}_{S, s}^h$ is a G-ring by
More on Algebra, Lemma \ref{more-algebra-lemma-henselization-G-ring} and
Proposition \ref{more-algebra-proposition-ubiquity-G-ring}.
Suppose we can construct a family of curves
$Y' \to \Spec(\mathcal{O}_{S, s}^h)$ and a morphism
$$
h' : X \times_S \Spec(\mathcal{O}_{S, s}^h) \longrightarrow Y'
$$
over $\Spec(\mathcal{O}_{S, s}^h)$ whose base change to the closed
point is $h_0$. This will be enough. Namely, first we use that
$$
\mathcal{O}_{S, s}^h = \colim_{(U, u)} \mathcal{O}_U(U)
$$
where the colimit is over the filtered category of 
elementary \'etale neighbourhoods (More on Morphisms, Lemma
\ref{more-morphisms-lemma-describe-henselization}).
Next, we use again that given $Y'$ we can descend it to
$Y \to U$ for some $U$ (see references given above).
Then we use
Limits, Lemma \ref{limits-lemma-descend-finite-presentation}
to descend $h'$ to some $h$. This reduces us to the case
discussed in the next paragraph.

\medskip\noindent
Assume $S = \Spec(\Lambda)$ where $(\Lambda, \mathfrak m, \kappa)$
is a henselian Noetherian local G-ring and $s$ is the closed point of $S$.
Recall that the map
$$
\Deformationcategory_{X_s \to Y_0} \to \Deformationcategory_{X_s}
$$
is an equivalence, see Deformation Problems, Lemma
\ref{examples-defos-lemma-schemes-morphisms-smooth-to-base}.
(This is the only important step in the proof; everything else
is technique.) Denote $\Lambda^\wedge$ the $\mathfrak m$-adic completion.
The pullbacks $X_n$ of $X$ to $\Lambda/\mathfrak m^{n + 1}$ define
a formal object $\xi$ of $\Deformationcategory_{X_s}$ over $\Lambda^\wedge$.
From the equivalence we obtain a formal object
$\xi'$ of $\Deformationcategory_{X_s \to Y_0}$ over $\Lambda^\wedge$.
Thus we obtain a huge commutative diagram
$$
\xymatrix{
\ldots \ar[r] &
X_n \ar[r] \ar[d] &
X_{n - 1} \ar[r] \ar[d] &
\ldots \ar[r] &
X_s \ar[d] \\
\ldots \ar[r] &
Y_n \ar[r] \ar[d] &
Y_{n - 1} \ar[r] \ar[d] &
\ldots \ar[r] &
Y_0 \ar[d] \\
\ldots \ar[r] &
\Spec(\Lambda/\mathfrak m^{n + 1}) \ar[r] &
\Spec(\Lambda/\mathfrak m^n) \ar[r] &
\ldots \ar[r] &
\Spec(\kappa)
}
$$
The formal object $(Y_n)$ comes from a family of curves
$Y' \to \Spec(\Lambda^\wedge)$ by
Quot, Lemma \ref{quot-lemma-curves-existence}.
By More on Morphisms of Spaces, Lemma
\ref{spaces-more-morphisms-lemma-algebraize-morphism}
we get a morphism $h' : X_{\Lambda^\wedge} \to Y'$ inducing
the given morphisms $X_n \to Y_n$ for all $n$
and in particular the given morphism $X_s \to Y_0$.

\medskip\noindent
To finish we do a standard algebraization/approximation argument.
First, we observe that we can find a finitely generated $\Lambda$-subalgebra
$\Lambda \subset A \subset \Lambda^\wedge$, a family of curves
$Y'' \to \Spec(A)$ and a morphism $h'' : X_A \to Y''$ over $A$
whose base change to $\Lambda^\wedge$ is $h'$.
This is true because $\Lambda^\wedge$ is the filtered colimit
of these rings $A$ and we can argue as before using
that $\Curvesstack$ is locally of finite presentation
(which gives us $Y''$ over $A$ by
Limits of Stacks, Lemma
\ref{stacks-limits-lemma-representable-by-spaces-limit-preserving})
and using 
Limits of Spaces, Lemma \ref{spaces-limits-lemma-descend-finite-presentation}
to descend $h'$ to some $h''$.
Then we can apply the approximation property for G-rings
(in the form of Smoothing Ring Maps, Theorem
\ref{smoothing-theorem-approximation-property})
to find a map $A \to \Lambda$ which induces the same map
$A \to \kappa$ as we obtain from $A \to \Lambda^\wedge$.
Base changing $h''$ to $\Lambda$ the proof is complete.
\end{proof}









\input{chapters}

\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}
