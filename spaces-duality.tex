\input{preamble}

% OK, start here.
%
\begin{document}

\title{Duality for Spaces}


\maketitle

\phantomsection
\label{section-phantom}

\tableofcontents

\section{Introduction}
\label{section-introduction}

\noindent
This chapter is the analogue of the corresponding chapter for
schemes, see Duality for Schemes, Section \ref{duality-section-introduction}.
The development is similar to the development in the papers
\cite{Neeman-Grothendieck}, \cite{LN},
\cite{Lipman-notes}, and \cite{Neeman-improvement}.




\section{Dualizing complexes on algebraic spaces}
\label{section-dualizing-spaces}

\noindent
Let $U$ be a locally Noetherian scheme. Let $\mathcal{O}_\etale$
be the structure sheaf of $U$ on the small \'etale site of $U$.
We will say an object $K \in D_\QCoh(\mathcal{O}_\etale)$ is
a dualizing complex on $U$ if $K = \epsilon^*(\omega_U^\bullet)$
for some dualizing complex $\omega_U^\bullet$ in the sense of
Duality for Schemes, Section \ref{duality-section-dualizing-schemes}.
Here $\epsilon^* : D_\QCoh(\mathcal{O}_U) \to D_\QCoh(\mathcal{O}_\etale)$
is the equivalence of Derived Categories of Spaces, Lemma
\ref{spaces-perfect-lemma-derived-quasi-coherent-small-etale-site}.
Most of the properties of $\omega_U^\bullet$ studied in
Duality for Schemes, Section \ref{duality-section-dualizing-schemes}
are inherited by $K$ via the discussion in
Derived Categories of Spaces, Sections
\ref{spaces-perfect-section-derived-quasi-coherent-etale} and
\ref{spaces-perfect-section-spell-out}.

\medskip\noindent
We define a dualizing complex on a locally Noetherian algebraic space
to be a complex which \'etale locally comes from a dualizing
complex on the corresponding scheme.

\begin{lemma}
\label{lemma-equivalent-definitions}
Let $S$ be a scheme. Let $X$ be a locally Noetherian algebraic space over $S$.
Let $K$ be an object of $D_\QCoh(\mathcal{O}_X)$. The following are equivalent
\begin{enumerate}
\item For every \'etale morphism $U \to X$ where $U$ is a scheme
the restriction $K|_U$ is a dualizing complex for $U$ (as discussed above).
\item There exists a surjective \'etale morphism $U \to X$ where $U$ is a
scheme such that $K|_U$ is a dualizing complex for $U$.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume $U \to X$ is surjective \'etale where $U$ is a scheme.
Let $V \to X$ be an \'etale morphism where $V$ is a scheme.
Then
$$
U \leftarrow U \times_X V \rightarrow V
$$
are \'etale morphisms of schemes with the arrow to $V$ surjective.
Hence we can use Duality for Schemes, Lemma \ref{duality-lemma-descent-ascent}
to see that if $K|_U$ is a dualizing complex for $U$, then
$K|_V$ is a dualizing complex for $V$.
\end{proof}

\begin{definition}
\label{definition-dualizing-scheme}
Let $S$ be a scheme.
Let $X$ be a locally Noetherian algebraic space over $S$.
An object $K$ of $D_\QCoh(\mathcal{O}_X)$ is called a
{\it dualizing complex} if $K$ satisfies the equivalent conditions of
Lemma \ref{lemma-equivalent-definitions}.
\end{definition}

\begin{lemma}
\label{lemma-affine-duality}
Let $A$ be a Noetherian ring and let $X = \Spec(A)$. Let
$\mathcal{O}_\etale$ be the structure sheaf of $X$ on the
small \'etale site of $X$. Let $K, L$ be objects of $D(A)$.
If $K \in D_{\textit{Coh}}(A)$ and $L$ has finite injective
dimension, then
$$
\epsilon^*\widetilde{R\Hom_A(K, L)} =
R\SheafHom_{\mathcal{O}_\etale}(\epsilon^*\widetilde{K},
\epsilon^*\widetilde{L})
$$
in $D(\mathcal{O}_\etale)$ where
$\epsilon : (X_\etale, \mathcal{O}_\etale) \to (X, \mathcal{O}_X)$
is as in Derived Categories of Spaces, Section
\ref{spaces-perfect-section-derived-quasi-coherent-etale}.
\end{lemma}

\begin{proof}
By Duality for Schemes, Lemma \ref{duality-lemma-affine-duality}
we have a canonical isomorphism
$$
\widetilde{R\Hom_A(K, L)} =
R\SheafHom_{\mathcal{O}_X}(\widetilde{K}, \widetilde{L})
$$
in $D(\mathcal{O}_X)$. There is a canonical map
$$
\epsilon^*R\Hom_{\mathcal{O}_X}(\widetilde{K}, \widetilde{L})
\longrightarrow
R\SheafHom_{\mathcal{O}_\etale}(\epsilon^*\widetilde{K},
\epsilon^*\widetilde{L})
$$
in $D(\mathcal{O}_\etale)$, see Cohomology on Sites, Remark
\ref{sites-cohomology-remark-prepare-fancy-base-change}.
We will show the left and right hand side of this arrow
have isomorphic cohomology sheaves, but we will omit the
verification that the isomorphism is given by this arrow.

\medskip\noindent
We may assume that $L$ is given by a finite complex $I^\bullet$
of injective $A$-modules. By induction on the length of $I^\bullet$
and compatibility of the constructions with distinguished triangles,
we reduce to the case that $L = I[0]$ where $I$ is an injective $A$-module.
Recall that the cohomology sheaves of
$R\SheafHom_{\mathcal{O}_\etale}(\epsilon^*\widetilde{K},
\epsilon^*\widetilde{L}))$
are the sheafifications of the presheaf sending $U$ \'etale
over $X$ to the $i$th ext group between the restrictions of
$\epsilon^*\widetilde{K}$ and $\epsilon^*\widetilde{L}$
to $U_\etale$. See
Cohomology on Sites, Lemma
\ref{sites-cohomology-lemma-section-RHom-over-U}.
If $U = \Spec(B)$ is affine, then this ext group
is equal to $\text{Ext}^i_B(K \otimes_A B, L \otimes_A B)$
by the equivalence of
Derived Categories of Spaces, Lemma
\ref{spaces-perfect-lemma-derived-quasi-coherent-small-etale-site} and
Derived Categories of Schemes, Lemma
\ref{perfect-lemma-affine-compare-bounded}
(this also uses the compatibilities detailed in
Derived Categories of Spaces, Remark
\ref{spaces-perfect-remark-match-total-direct-images}).
Since $A \to B$ is \'etale, we see that
$I \otimes_A B$ is an injective $B$-module
by Dualizing Complexes, Lemma \ref{dualizing-lemma-injective-goes-up}.
Hence we see that
\begin{align*}
\Ext^n_B(K \otimes_A B, I \otimes_A B)
& =
\Hom_B(H^{-n}(K \otimes_A B), I \otimes_A B) \\
& =
\Hom_{A_f}(H^{-n}(K) \otimes_A B, I \otimes_A B) \\
& =
\Hom_A(H^{-n}(K), I) \otimes_A B \\
& =
\text{Ext}^n_A(K, I) \otimes_A B
\end{align*}
The penultimate equality because $H^{-n}(K)$ is a finite $A$-module, see
More on Algebra, Remark
\ref{more-algebra-remark-pseudo-coherence-and-base-change-ext}.
Therefore the cohomology sheaves of the left and right hand
side of the equality in the lemma are the same.
\end{proof}

\begin{lemma}
\label{lemma-dualizing-spaces}
Let $S$ be a scheme. Let $X$ be a locally Noetherian algebraic space over $S$.
Let $K$ be a dualizing complex on $X$.
Then $K$ is an object of $D_{\textit{Coh}}(\mathcal{O}_X)$
and $D = R\SheafHom_{\mathcal{O}_X}(-, K)$ induces an anti-equivalence
$$
D :
D_{\textit{Coh}}(\mathcal{O}_X)
\longrightarrow
D_{\textit{Coh}}(\mathcal{O}_X)
$$
which comes equipped with a canonical isomorphism
$\text{id} \to D \circ D$. If $X$ is quasi-compact, then
$D$ exchanges $D^+_{\textit{Coh}}(\mathcal{O}_X)$ and
$D^-_{\textit{Coh}}(\mathcal{O}_X)$ and induces an equivalence
$D^b_{\textit{Coh}}(\mathcal{O}_X) \to D^b_{\textit{Coh}}(\mathcal{O}_X)$.
\end{lemma}

\begin{proof}
Let $U \to X$ be an \'etale morphism with $U$ affine. Say $U = \Spec(A)$ and
let $\omega_A^\bullet$ be a dualizing complex for $A$ corresponding to $K|_U$
as in Lemma \ref{lemma-equivalent-definitions} and
Duality for Schemes, Lemma \ref{duality-lemma-equivalent-definitions}.
By Lemma \ref{lemma-affine-duality} the diagram
$$
\xymatrix{
D_{\textit{Coh}}(A) \ar[r] \ar[d]_{R\Hom_A(-, \omega_A^\bullet)} &
D_{\textit{Coh}}(\mathcal{O}_\etale)
\ar[d]^{R\SheafHom_{\mathcal{O}_\etale}(-, K|_U)} \\
D_{\textit{Coh}}(A) \ar[r] &
D(\mathcal{O}_\etale)
}
$$
commutes where $\mathcal{O}_\etale$ is the structure sheaf of the
small \'etale site of $U$. Since formation of $R\SheafHom$ commutes
with restriction, we conclude that $D$ sends
$D_{\textit{Coh}}(\mathcal{O}_X)$ into
$D_{\textit{Coh}}(\mathcal{O}_X)$. Moreover, the canonical map
$$
L \longrightarrow
R\SheafHom_{\mathcal{O}_X}(R\SheafHom_{\mathcal{O}_X}(L, K), K)
$$
(Cohomology on Sites, Lemma \ref{sites-cohomology-lemma-internal-hom-evaluate})
is an isomorphism for all $L$ in $D_{\textit{Coh}}(\mathcal{O}_X)$
because this is true over all $U$ as above by
Dualizing Complexes, Lemma \ref{dualizing-lemma-dualizing}.
The statement on boundedness properties of the functor $D$
in the quasi-compact case also follows from the corresponding
statements of Dualizing Complexes, Lemma \ref{dualizing-lemma-dualizing}.
\end{proof}

\noindent
Let $(\mathcal{C}, \mathcal{O})$ be a ringed site.
We will say that an object $L$ of $D(\mathcal{O})$ is {\it invertible}
if for every object $U$ of $\mathcal{C}$
there is a covering $\{U_i \to U\}$ of $U$ in $\mathcal{C}$
such that $L|_{U_i} \cong \mathcal{O}_{U_i}[-n_i]$
for some integers $n_i$.

\medskip\noindent
Let $S$ be a scheme and let $X$ be an algebraic space over $S$.
If $L$ in $D(\mathcal{O}_X)$ is invertible, then there is a
disjoint union decomposition $X = \coprod_{n \in \mathbf{Z}} X_n$
such that $L|_{X_n}$ is an invertible module sitting in degree $n$.
In particular, it follows that $L = \bigoplus H^n(L)[-n]$
which gives a well defined complex of $\mathcal{O}_X$-modules
(with zero differentials) representing $L$.
Moreover, we see that $L$ is a perfect object of $D(\mathcal{O}_X)$.

\begin{lemma}
\label{lemma-dualizing-unique-spaces}
Let $S$ be a scheme.
Let $X$ be a locally Noetherian algebraic space over $S$.
If $K$ and $K'$ are dualizing complexes on $X$, then $K'$
is isomorphic to $K \otimes_{\mathcal{O}_X}^\mathbf{L} L$
for some invertible object $L$ of $D(\mathcal{O}_X)$.
\end{lemma}

\begin{proof}
Set
$$
L = R\SheafHom_{\mathcal{O}_X}(K, K')
$$
This is an invertible object of $D(\mathcal{O}_X)$, because affine locally
this is true. Use Lemma \ref{lemma-affine-duality} and
Dualizing Complexes, Lemma
\ref{dualizing-lemma-dualizing-unique} and its proof.
The evaluation map $L \otimes_{\mathcal{O}_X}^\mathbf{L} K \to K'$
is an isomorphism for the same reason.
\end{proof}

\begin{lemma}
\label{lemma-dimension-function-scheme}
Let $S$ be a scheme. Let $X$ be a locally Noetherian
quasi-separated algebraic space over $S$.
Let $\omega_X^\bullet$ be a dualizing complex on $X$. Then $X$ the function
$|X| \to \mathbf{Z}$ defined by
$$
x \longmapsto \delta(x)\text{ such that }
\omega_{X, \overline{x}}^\bullet[-\delta(x)]
\text{ is a normalized dualizing complex over }
\mathcal{O}_{X, \overline{x}}
$$
is a dimension function on $|X|$.
\end{lemma}

\begin{proof}
Let $U$ be a scheme and let $U \to X$ be a surjective \'etale morphism.
Let $\omega_U^\bullet$ be the dualizing complex on $U$ associated
to $\omega_X^\bullet|_U$.
If $u \in U$ maps to $x \in |X|$, then $\mathcal{O}_{X, \overline{x}}$
is the strict henselization of $\mathcal{O}_{U, u}$. By
Dualizing Complexes, Lemma \ref{dualizing-lemma-flat-unramified}
we see that if $\omega^\bullet$ is a normalized dualizing complex
for $\mathcal{O}_{U, u}$, then
$\omega^\bullet \otimes_{\mathcal{O}_{U, u}} \mathcal{O}_{X, \overline{x}}$
is a normalized dualizing complex for $\mathcal{O}_{X, \overline{x}}$.
Hence we see that the dimension function $U \to \mathbf{Z}$ of
Duality for Schemes, Lemma \ref{duality-lemma-dimension-function-scheme}
for the scheme $U$ and the complex
$\omega_U^\bullet$ is equal to the composition of $U \to |X|$ with $\delta$.
Using the specializations in $|X|$ lift to specializations in $U$
and that nontrivial specializations in $U$ map to
nontrivial specializations in $X$
(Decent Spaces, Lemmas \ref{decent-spaces-lemma-decent-specialization} and
\ref{decent-spaces-lemma-decent-no-specializations-map-to-same-point})
an easy topological argument shows that $\delta$ is a dimension function
on $|X|$.
\end{proof}






\section{Right adjoint of pushforward}
\label{section-twisted-inverse-image}

\noindent
This is the analogue of Duality for Schemes, Section
\ref{duality-section-twisted-inverse-image}.

\begin{lemma}
\label{lemma-twisted-inverse-image}
\begin{reference}
This is almost the same as \cite[Example 4.2]{Neeman-Grothendieck}.
\end{reference}
Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism between quasi-separated and quasi-compact
algebraic spaces over $S$. The functor $Rf_* : D_\QCoh(X) \to D_\QCoh(Y)$
has a right adjoint.
\end{lemma}

\begin{proof}
We will prove a right adjoint exists by verifying the hypotheses of
Derived Categories, Proposition \ref{derived-proposition-brown}.
First off, the category $D_\QCoh(\mathcal{O}_X)$ has direct sums, see
Derived Categories of Spaces, Lemma
\ref{spaces-perfect-lemma-quasi-coherence-direct-sums}.
The category $D_\QCoh(\mathcal{O}_X)$ is compactly generated by
Derived Categories of Spaces, Theorem
\ref{spaces-perfect-theorem-bondal-van-den-Bergh}.
Since $X$ and $Y$ are quasi-compact and quasi-separated, so is $f$, see
Morphisms of Spaces, Lemmas
\ref{spaces-morphisms-lemma-compose-after-separated} and
\ref{spaces-morphisms-lemma-quasi-compact-permanence}.
Hence the functor $Rf_*$ commutes with direct sums, see
Derived Categories of Spaces, Lemma
\ref{spaces-perfect-lemma-quasi-coherence-pushforward-direct-sums}.
This finishes the proof.
\end{proof}

\begin{lemma}
\label{lemma-twisted-inverse-image-bounded-below}
Notation and assumptions as in Lemma \ref{lemma-twisted-inverse-image}.
Let $a : D_\QCoh(\mathcal{O}_Y) \to D_\QCoh(\mathcal{O}_X)$ be the right
adjoint to $Rf_*$. Then $a$ maps
$D^+_\QCoh(\mathcal{O}_Y)$ into $D^+_\QCoh(\mathcal{O}_X)$.
\end{lemma}

\begin{proof}
By Derived Categories of Spaces, Lemma
\ref{spaces-perfect-lemma-quasi-coherence-direct-image}
the functor $Rf_*$ has finite cohomological dimension. In other words,
there exist an integer $N$ such that
$H^i(Rf_*L) = 0$ for $i \geq N + c$ if $H^j(L) = 0$ for $j \geq c$.
Say $K \in D^+_\QCoh(\mathcal{O}_Y)$ has $H^k(K) = 0$ for $k \leq c$.
Then
$$
\Hom_{D(\mathcal{O}_X)}(\tau_{\leq c - N}a(K), a(K)) =
\Hom_{D(\mathcal{O}_Y)}(Rf_*\tau_{\leq c - N}a(K), K) = 0
$$
by what we said above. Clearly, this implies that $a(K)$ is bounded below.
\end{proof}

\noindent
Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism of quasi-separated and quasi-compact
algebraic spaces over $S$.
Let $a$ denote the right adjoint to
$Rf_* : D_\QCoh(\mathcal{O}_X) \to D_\QCoh(\mathcal{O}_Y)$. For every
$K \in D_\QCoh(\mathcal{O}_Y)$ and $L \in D_\QCoh(\mathcal{O}_X)$
we obtain a canonical map
\begin{equation}
\label{equation-sheafy-trace}
Rf_*R\SheafHom_{\mathcal{O}_X}(L, a(K))
\longrightarrow
R\SheafHom_{\mathcal{O}_Y}(Rf_*L, K)
\end{equation}
Namely, this map is constructed as the composition
$$
Rf_*R\SheafHom_{\mathcal{O}_X}(L, a(K)) \to
R\SheafHom_{\mathcal{O}_Y}(Rf_*L, Rf_*a(K)) \to
R\SheafHom_{\mathcal{O}_Y}(Rf_*L, K)
$$
where the first arrow is 
Cohomology on Sites, Remark
\ref{sites-cohomology-remark-projection-formula-for-internal-hom}
and the second arrow is the counit $Rf_*a(K) \to K$ of the adjunction.

\begin{lemma}
\label{lemma-iso-on-RSheafHom}
Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism of quasi-compact and quasi-separated
algebraic spaces over $S$.
Let $a$ be the right adjoint to
$Rf_* : D_\QCoh(\mathcal{O}_X) \to D_\QCoh(\mathcal{O}_Y)$.
Then (\ref{equation-sheafy-trace})
$$
Rf_*R\SheafHom_{\mathcal{O}_X}(L, a(K))
\longrightarrow
R\SheafHom_{\mathcal{O}_Y}(Rf_*L, K)
$$
is an isomorphism for all $L \in D_\QCoh(\mathcal{O}_X)$ and
$K \in D_\QCoh(\mathcal{O}_Y)$.
\end{lemma}

\begin{proof}
Let $M \in D_\QCoh(\mathcal{O}_Y)$. Then we have the following
\begin{align*}
\Hom_Y(M, Rf_*R\SheafHom_{\mathcal{O}_X}(L, a(K)))
& =
\Hom_X(Lf^*M, R\SheafHom_{\mathcal{O}_X}(L, a(K))) \\
& =
\Hom_X(Lf^*M \otimes_{\mathcal{O}_X}^\mathbf{L} L, a(K)) \\
& =
\Hom_Y(Rf_*(Lf^*M \otimes_{\mathcal{O}_X}^\mathbf{L} L), K) \\
& =
\Hom_Y(M \otimes_{\mathcal{O}_Y}^\mathbf{L} Rf_*L, K) \\
& =
\Hom_Y(M, R\SheafHom_{\mathcal{O}_Y}(Rf_*L, K))
\end{align*}
The first equality holds by Cohomology on Sites, Lemma
\ref{sites-cohomology-lemma-adjoint}.
The second equality by Cohomology on Sites, Lemma
\ref{sites-cohomology-lemma-internal-hom}.
The third equality by construction of $a$.
The fourth equality by Derived Categories of Spaces, Lemma
\ref{spaces-perfect-lemma-cohomology-base-change} (this is the important step).
The fifth by Cohomology on Sites, Lemma
\ref{sites-cohomology-lemma-internal-hom}.
Thus the result holds by the Yoneda lemma.
\end{proof}

\begin{lemma}
\label{lemma-iso-global-hom}
Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism of quasi-separated and quasi-compact
algebraic spaces over $S$.
For all $L \in D_\QCoh(\mathcal{O}_X)$ and $K \in D_\QCoh(\mathcal{O}_Y)$
(\ref{equation-sheafy-trace}) induces an isomorphism
$R\Hom_X(L, a(K)) \to R\Hom_Y(Rf_*L, K)$ of global derived homs.
\end{lemma}

\begin{proof}
By construction (Cohomology on Sites, Section
\ref{sites-cohomology-section-global-RHom}) the complexes
$$
R\Hom_X(L, a(K)) =
R\Gamma(X, R\SheafHom_{\mathcal{O}_X}(L, a(K))) =
R\Gamma(Y, Rf_*R\SheafHom_{\mathcal{O}_X}(L, a(K)))
$$
and
$$
R\Hom_Y(Rf_*L, K) = R\Gamma(Y, R\SheafHom_{\mathcal{O}_X}(Rf_*L, a(K)))
$$
Thus the lemma is a consequence of Lemma \ref{lemma-iso-on-RSheafHom}.
\end{proof}









\section{Right adjoint of pushforward and base change, I}
\label{section-base-change-map}

\noindent
Let us define the base change map between right adjoints of pushforward.
Let $S$ be a scheme. Consider a cartesian diagram
\begin{equation}
\label{equation-base-change}
\vcenter{
\xymatrix{
X' \ar[r]_{g'} \ar[d]_{f'} & X \ar[d]^f \\
Y' \ar[r]^g & Y
}
}
\end{equation}
where $Y'$ and $X$ are {\bf Tor independent} over $Y$. Denote
$$
a  : D_\QCoh(\mathcal{O}_Y) \to D_\QCoh(\mathcal{O}_X)
\quad\text{and}\quad
a' : D_\QCoh(\mathcal{O}_{Y'}) \to D_\QCoh(\mathcal{O}_{X'})
$$
the right adjoints to $Rf_*$ and $Rf'_*$
(Lemma \ref{lemma-twisted-inverse-image}).
The base change map of
Cohomology on Sites, Remark \ref{sites-cohomology-remark-base-change}
gives a transformation of functors
$$
Lg^* \circ Rf_* \longrightarrow Rf'_* \circ L(g')^*
$$
on derived categories of sheaves with quasi-coherent cohomology.
Hence a transformation between the right adjoints in the opposite direction
$$
a \circ Rg_* \longleftarrow Rg'_* \circ a'
$$

\begin{lemma}
\label{lemma-flat-precompose-pus}
In diagram (\ref{equation-base-change}) the map
$a \circ Rg_* \leftarrow Rg'_* \circ a'$ is an isomorphism.
\end{lemma}

\begin{proof}
The base change map $Lg^* \circ Rf_* K \to Rf'_* \circ L(g')^*K$
is an isomorphism for every $K$ in $D_\QCoh(\mathcal{O}_X)$ by
Derived Categories of Spaces, Lemma
\ref{spaces-perfect-lemma-compare-base-change}
(this uses the assumption of Tor independence).
Thus the corresponding transformation between adjoint functors
is an isomorphism as well.
\end{proof}

\noindent
Then we can consider the
morphism of functors
$D_\QCoh(\mathcal{O}_Y) \to D_\QCoh(\mathcal{O}_{X'})$
given by the composition
\begin{equation}
\label{equation-base-change-map}
L(g')^* \circ a \to
L(g')^* \circ a \circ Rg_* \circ Lg^* \leftarrow
L(g')^* \circ Rg'_* \circ a' \circ Lg^* \to a' \circ Lg^*
\end{equation}
The first arrow comes from the adjunction map $\text{id} \to Rg_* Lg^*$
and the last arrow from the adjunction map $L(g')^*Rg'_* \to \text{id}$.
We need the assumption on Tor independence to invert the arrow
in the middle, see Lemma \ref{lemma-flat-precompose-pus}.
Alternatively, we can think of (\ref{equation-base-change-map}) by
adjointness of $L(g')^*$ and $R(g')_*$ as a natural transformation
$$
a \to a \circ Rg_* \circ Lg^* \leftarrow Rg'_* \circ a' \circ Lg^*
$$
were again the second arrow is invertible. If $M \in D_\QCoh(\mathcal{O}_X)$
and $K \in D_\QCoh(\mathcal{O}_Y)$
then on Yoneda functors this map is given by
\begin{align*}
\Hom_X(M, a(K))
& =
\Hom_Y(Rf_*M, K) \\
& \to
\Hom_Y(Rf_*M, Rg_* Lg^*K) \\
& =
\Hom_{Y'}(Lg^*Rf_*M, Lg^*K) \\
& \leftarrow
\Hom_{Y'}(Rf'_* L(g')^*M, Lg^*K) \\
& =
\Hom_{X'}(L(g')^*M, a'(Lg^*K)) \\
& =
\Hom_X(M, Rg'_*a'(Lg^*K))
\end{align*}
(were the arrow pointing left is invertible by the base
change theorem given in
Derived Categories of Spaces, Lemma
\ref{spaces-perfect-lemma-compare-base-change})
which makes things a little bit more explicit.

\medskip\noindent
In this section we first prove that the base change map satisfies
some natural compatibilities with regards to stacking squares as in
Cohomology on Sites, Remarks \ref{sites-cohomology-remark-compose-base-change}
and
\ref{sites-cohomology-remark-compose-base-change-horizontal} for the usual
base change map. We suggest the reader skip the rest of this section
on a first reading.

\begin{lemma}
\label{lemma-compose-base-change-maps}
Let $S$ be a scheme. Consider a commutative diagram
$$
\xymatrix{
X' \ar[r]_k \ar[d]_{f'} & X \ar[d]^f \\
Y' \ar[r]^l \ar[d]_{g'} & Y \ar[d]^g \\
Z' \ar[r]^m & Z
}
$$
of quasi-compact and quasi-separated algebraic spaces over $S$ where
both diagrams are cartesian and where $f$ and $l$
as well as $g$ and $m$ are Tor independent.
Then the maps (\ref{equation-base-change-map})
for the two squares compose to give the base
change map for the outer rectangle (see proof for a precise statement).
\end{lemma}

\begin{proof}
It follows from the assumptions that $g \circ f$ and $m$ are Tor
independent (details omitted), hence the statement makes sense.
In this proof we write $k^*$ in place of $Lk^*$ and $f_*$ instead
of $Rf_*$. Let $a$, $b$, and $c$ be the right adjoints of
Lemma \ref{lemma-twisted-inverse-image}
for $f$, $g$, and $g \circ f$ and similarly for the primed versions.
The arrow corresponding to the top square is the composition
$$
\gamma_{top} :
k^* \circ a \to k^* \circ a \circ l_* \circ l^*
\xleftarrow{\xi_{top}} k^* \circ k_* \circ a' \circ l^* \to a' \circ l^*
$$
where $\xi_{top} : k_* \circ a' \to a \circ l_*$
is an isomorphism (hence can be inverted)
and is the arrow ``dual'' to the base change map
$l^* \circ f_* \to f'_* \circ k^*$. The outer arrows come
from the canonical maps $1 \to l_* \circ l^*$ and $k^* \circ k_* \to 1$.
Similarly for the second square we have
$$
\gamma_{bot} :
l^* \circ b \to l^* \circ b \circ m_* \circ m^*
\xleftarrow{\xi_{bot}} l^* \circ l_* \circ b' \circ m^* \to b' \circ m^*
$$
For the outer rectangle we get
$$
\gamma_{rect} :
k^* \circ c \to k^* \circ c \circ m_* \circ m^*
\xleftarrow{\xi_{rect}} k^* \circ k_* \circ c' \circ m^* \to c' \circ m^*
$$
We have $(g \circ f)_* = g_* \circ f_*$ and hence
$c = a \circ b$ and similarly $c' = a' \circ b'$.
The statement of the lemma is that $\gamma_{rect}$
is equal to the composition
$$
k^* \circ c = k^* \circ a \circ b \xrightarrow{\gamma_{top}}
a' \circ l^* \circ b \xrightarrow{\gamma_{bot}}
a' \circ b' \circ m^* = c' \circ m^*
$$
To see this we contemplate the following diagram:
$$
\xymatrix{
& & k^* \circ a \circ b \ar[d] \ar[lldd] \\
& & k^* \circ a \circ l_* \circ l^* \circ b \ar[ld] \\
k^* \circ a \circ b \circ m_* \circ m^* \ar[r] &
k^* \circ a \circ l_* \circ l^* \circ b \circ m_* \circ m^* &
k^* \circ k_* \circ a' \circ l^* \circ b \ar[u]_{\xi_{top}} \ar[d] \ar[ld] \\
& k^*\circ k_* \circ a' \circ l^* \circ b \circ m_* \circ m^*
\ar[u]_{\xi_{top}} \ar[rd] &
a' \circ l^* \circ b \ar[d] \\
k^* \circ k_* \circ a' \circ b' \circ m^* \ar[uu]_{\xi_{rect}} \ar[ddrr] &
k^*\circ k_* \circ a' \circ l^* \circ l_* \circ b' \circ m^*
\ar[u]_{\xi_{bot}} \ar[l] \ar[dr] &
a' \circ l^* \circ b \circ m_* \circ m^* \\
& & a' \circ l^* \circ l_* \circ b' \circ m^* \ar[u]_{\xi_{bot}} \ar[d] \\
& & a' \circ b' \circ m^*
}
$$
Going down the right hand side we have the composition and going
down the left hand side we have $\gamma_{rect}$.
All the quadrilaterals on the right hand side of this diagram commute
by Categories, Lemma \ref{categories-lemma-properties-2-cat-cats}
or more simply the discussion preceding
Categories, Definition \ref{categories-definition-horizontal-composition}.
Hence we see that it suffices to show the diagram
$$
\xymatrix{
a \circ l_* \circ l^* \circ b \circ m_* &
a \circ b \circ m_* \ar[l] \\
k_* \circ a' \circ l^* \circ b \circ m_* \ar[u]_{\xi_{top}} & \\
k_* \circ a' \circ l^* \circ l_* \circ b' \ar[u]_{\xi_{bot}} \ar[r] &
k_* \circ a' \circ b' \ar[uu]_{\xi_{rect}}
}
$$
becomes commutative if we invert the arrows $\xi_{top}$, $\xi_{bot}$,
and $\xi_{rect}$ (note that this is different from asking the
diagram to be commutative). However, the diagram
$$
\xymatrix{
& a \circ l_* \circ l^* \circ b \circ m_* \\
a \circ l_* \circ l^* \circ l_* \circ b'
\ar[ru]^{\xi_{bot}} & &
k_* \circ a' \circ l^* \circ b \circ m_* \ar[ul]_{\xi_{top}} \\
& k_* \circ a' \circ l^* \circ l_* \circ b'
\ar[ul]^{\xi_{top}} \ar[ur]_{\xi_{bot}}
}
$$
commutes by Categories, Lemma \ref{categories-lemma-properties-2-cat-cats}.
Since the diagrams
$$
\vcenter{
\xymatrix{
a \circ l_* \circ l^* \circ b \circ m_* & a \circ b \circ m \ar[l] \\
a \circ l_* \circ l^* \circ l_* \circ b' \ar[u] &
a \circ l_* \circ b' \ar[l] \ar[u]
}
}
\quad\text{and}\quad
\vcenter{
\xymatrix{
a \circ l_* \circ l^* \circ l_* \circ b' \ar[r] & a \circ l_* \circ b' \\
k_* \circ a' \circ l^* \circ l_* \circ b' \ar[u] \ar[r] &
k_* \circ a' \circ b' \ar[u]
}
}
$$
commute (see references cited) and since the composition of
$l_* \to l_* \circ l^* \circ l_* \to l_*$ is the identity,
we find that it suffices to prove that
$$
k \circ a' \circ b' \xrightarrow{\xi_{bot}} a \circ l_* \circ b
\xrightarrow{\xi_{top}} a \circ b \circ m_*
$$
is equal to $\xi_{rect}$ (via the identifications $a \circ b = c$
and $a' \circ b' = c'$). This is the statement dual to
Cohomology on Sites, Remark \ref{sites-cohomology-remark-compose-base-change}
and the proof is complete.
\end{proof}

\begin{lemma}
\label{lemma-compose-base-change-maps-horizontal}
Let $S$ be a scheme. Consider a commutative diagram
$$
\xymatrix{
X'' \ar[r]_{g'} \ar[d]_{f''} & X' \ar[r]_g \ar[d]_{f'} & X \ar[d]^f \\
Y'' \ar[r]^{h'} & Y' \ar[r]^h & Y
}
$$
of quasi-compact and quasi-separated algebraic spaces over $S$ where
both diagrams are cartesian and where $f$ and $h$
as well as $f'$ and $h'$ are Tor independent.
Then the maps (\ref{equation-base-change-map})
for the two squares compose to give the base
change map for the outer rectangle (see proof for a precise statement).
\end{lemma}

\begin{proof}
It follows from the assumptions that $f$ and $h \circ h'$ are Tor
independent (details omitted), hence the statement makes sense.
In this proof we write $g^*$ in place of $Lg^*$ and $f_*$ instead
of $Rf_*$. Let $a$, $a'$, and $a''$ be the right adjoints of
Lemma \ref{lemma-twisted-inverse-image}
for $f$, $f'$, and $f''$. The arrow corresponding to the right
square is the composition
$$
\gamma_{right} :
g^* \circ a \to g^* \circ a \circ h_* \circ h^*
\xleftarrow{\xi_{right}} g^* \circ g_* \circ a' \circ h^* \to a' \circ h^*
$$
where $\xi_{right} : g_* \circ a' \to a \circ h_*$
is an isomorphism (hence can be inverted)
and is the arrow ``dual'' to the base change map
$h^* \circ f_* \to f'_* \circ g^*$. The outer arrows come
from the canonical maps $1 \to h_* \circ h^*$ and $g^* \circ g_* \to 1$.
Similarly for the left square we have
$$
\gamma_{left} :
(g')^* \circ a' \to (g')^* \circ a' \circ (h')_* \circ (h')^*
\xleftarrow{\xi_{left}}
(g')^* \circ (g')_* \circ a'' \circ (h')^* \to a'' \circ (h')^*
$$
For the outer rectangle we get
$$
\gamma_{rect} :
k^* \circ a \to
k^* \circ a \circ m_* \circ m^* \xleftarrow{\xi_{rect}}
k^* \circ k_* \circ a'' \circ m^* \to
a'' \circ m^*
$$
where $k = g \circ g'$ and $m = h \circ h'$.
We have $k^* = (g')^* \circ g^*$ and $m^* = (h')^* \circ h^*$.
The statement of the lemma is that $\gamma_{rect}$
is equal to the composition
$$
k^* \circ a =
(g')^* \circ g^* \circ a \xrightarrow{\gamma_{right}}
(g')^* \circ a' \circ h^* \xrightarrow{\gamma_{left}}
a'' \circ (h')^* \circ h^* = a'' \circ m^*
$$
To see this we contemplate the following diagram
$$
\xymatrix{
& (g')^* \circ g^* \circ a \ar[d] \ar[ddl] \\
& (g')^* \circ g^* \circ a \circ h_* \circ h^* \ar[ld] \\
(g')^* \circ g^* \circ a \circ h_* \circ (h')_* \circ (h')^* \circ h^* &
(g')^* \circ g^* \circ g_* \circ a' \circ h^*
\ar[u]_{\xi_{right}} \ar[d] \ar[ld] \\
(g')^* \circ g^* \circ g_* \circ a' \circ (h')_* \circ (h')^* \circ h^*
\ar[u]_{\xi_{right}} \ar[dr] &
(g')^* \circ a' \circ h^* \ar[d] \\
(g')^* \circ g^* \circ g_* \circ (g')_* \circ a'' \circ (h')^* \circ h^*
\ar[u]_{\xi_{left}} \ar[ddr] \ar[dr] &
(g')^* \circ a' \circ (h')_* \circ (h')^* \circ h^* \\
& (g')^*\circ (g')_* \circ a'' \circ (h')^* \circ h^*
\ar[u]_{\xi_{left}} \ar[d] \\
& a'' \circ (h')^* \circ h^*
}
$$
Going down the right hand side we have the composition and going
down the left hand side we have $\gamma_{rect}$.
All the quadrilaterals on the right hand side of this diagram commute
by Categories, Lemma \ref{categories-lemma-properties-2-cat-cats}
or more simply the discussion preceding
Categories, Definition \ref{categories-definition-horizontal-composition}.
Hence we see that it suffices to show that
$$
g_* \circ (g')_* \circ a'' \xrightarrow{\xi_{left}}
g_* \circ a' \circ (h')_* \xrightarrow{\xi_{right}}
a \circ h_* \circ (h')_*
$$
is equal to $\xi_{rect}$. This is the statement dual to
Cohomology, Remark \ref{cohomology-remark-compose-base-change-horizontal}
and the proof is complete.
\end{proof}

\begin{remark}
\label{remark-going-around}
Let $S$ be a scheme. Consider a commutative diagram
$$
\xymatrix{
X'' \ar[r]_{k'} \ar[d]_{f''} & X' \ar[r]_k \ar[d]_{f'} & X \ar[d]^f \\
Y'' \ar[r]^{l'} \ar[d]_{g''} & Y' \ar[r]^l \ar[d]_{g'} & Y \ar[d]^g \\
Z'' \ar[r]^{m'} & Z' \ar[r]^m & Z
}
$$
of quasi-compact and quasi-separated algebraic spaces over $S$ where
all squares are cartesian and where
$(f, l)$, $(g, m)$, $(f', l')$, $(g', m')$ are
Tor independent pairs of maps.
Let $a$, $a'$, $a''$, $b$, $b'$, $b''$ be the
right adjoints of Lemma \ref{lemma-twisted-inverse-image}
for $f$, $f'$, $f''$, $g$, $g'$, $g''$.
Let us label the squares of the diagram $A$, $B$, $C$, $D$
as follows
$$
\begin{matrix}
A & B \\
C & D
\end{matrix}
$$
Then the maps (\ref{equation-base-change-map})
for the squares are (where we use $k^* = Lk^*$, etc)
$$
\begin{matrix}
\gamma_A : (k')^* \circ a' \to a'' \circ (l')^* &
\gamma_B : k^* \circ a \to a' \circ l^* \\
\gamma_C : (l')^* \circ b' \to b'' \circ (m')^* &
\gamma_D : l^* \circ b \to b' \circ m^*
\end{matrix}
$$
For the $2 \times 1$ and $1 \times 2$ rectangles we have four further
base change maps
$$
\begin{matrix}
\gamma_{A + B} : (k \circ k')^* \circ a \to a'' \circ (l \circ l')^* \\
\gamma_{C + D} : (l \circ l')^* \circ b \to b'' \circ (m \circ m')^* \\
\gamma_{A + C} : (k')^* \circ (a' \circ b') \to (a'' \circ b'') \circ (m')^* \\
\gamma_{A + C} : k^* \circ (a \circ b) \to (a' \circ b') \circ m^*
\end{matrix}
$$
By Lemma \ref{lemma-compose-base-change-maps-horizontal} we have
$$
\gamma_{A + B} = \gamma_A \circ \gamma_B, \quad
\gamma_{C + D} = \gamma_C \circ \gamma_D
$$
and by Lemma \ref{lemma-compose-base-change-maps} we have
$$
\gamma_{A + C} = \gamma_C \circ \gamma_A, \quad
\gamma_{B + D} = \gamma_D \circ \gamma_B
$$
Here it would be more correct to write
$\gamma_{A + B} = (\gamma_A \star \text{id}_{l^*}) \circ
(\text{id}_{(k')^*} \star \gamma_B)$ with notation as in
Categories, Section \ref{categories-section-formal-cat-cat}
and similarly for the others. However, we continue the
abuse of notation used in the proofs of
Lemmas \ref{lemma-compose-base-change-maps} and
\ref{lemma-compose-base-change-maps-horizontal}
of dropping $\star$ products with identities as one can figure
out which ones to add as long as the source and target of the
transformation is known.
Having said all of this we find (a priori) two transformations
$$
(k')^* \circ k^* \circ a \circ b
\longrightarrow
a'' \circ b'' \circ (m')^* \circ m^*
$$
namely
$$
\gamma_C \circ \gamma_A \circ \gamma_D \circ \gamma_B =
\gamma_{A + C} \circ \gamma_{B + D}
$$
and
$$
\gamma_C \circ \gamma_D \circ \gamma_A \circ \gamma_B =
\gamma_{C + D} \circ \gamma_{A + B}
$$
The point of this remark is to point out that these transformations
are equal. Namely, to see this it suffices to show that
$$
\xymatrix{
(k')^* \circ a' \circ l^* \circ b \ar[r]_{\gamma_D} \ar[d]_{\gamma_A} &
(k')^* \circ a' \circ b' \circ m^* \ar[d]^{\gamma_A} \\
a'' \circ (l')^* \circ l^* \circ b \ar[r]^{\gamma_D} &
a'' \circ (l')^* \circ b' \circ m^*
}
$$
commutes. This is true by
Categories, Lemma \ref{categories-lemma-properties-2-cat-cats}
or more simply the discussion preceding
Categories, Definition \ref{categories-definition-horizontal-composition}.
\end{remark}








\section{Right adjoint of pushforward and base change, II}
\label{section-base-change-II}

\noindent
In this section we prove that the base change map of
Section \ref{section-base-change-map} is an isomorphism
in some cases.

\begin{lemma}
\label{lemma-more-base-change}
In diagram (\ref{equation-base-change}) assume
\begin{enumerate}
\item $g : Y' \to Y$ is a morphism of affine schemes,
\item $f : X \to Y$ is proper, and
\item $f$ and $g$ are Tor independent.
\end{enumerate}
Then the base change map (\ref{equation-base-change-map}) induces an
isomorphism
$$
L(g')^*a(K) \longrightarrow a'(Lg^*K)
$$
in the following cases
\begin{enumerate}
\item for all $K \in D_\QCoh(\mathcal{O}_X)$ if $f$
is flat of finite presentation,
\item for all $K \in D_\QCoh(\mathcal{O}_X)$ if $f$
is perfect and $Y$ Noetherian,
\item for $K \in D_\QCoh^+(\mathcal{O}_X)$ if $g$ has finite Tor dimension
and $Y$ Noetherian.
\end{enumerate}
\end{lemma}

\begin{proof}
Write $Y = \Spec(A)$ and $Y' = \Spec(A')$. As a base change of an affine
morphism, the morphism $g'$ is affine. Let $M$ be a perfect generator
for $D_\QCoh(\mathcal{O}_X)$, see Derived Categories of Spaces, Theorem
\ref{spaces-perfect-theorem-bondal-van-den-Bergh}. Then $L(g')^*M$ is a
generator for $D_\QCoh(\mathcal{O}_{X'})$, see
Derived Categories of Spaces, Remark
\ref{spaces-perfect-remark-pullback-generator}.
Hence it suffices to show that (\ref{equation-base-change-map})
induces an isomorphism
\begin{equation}
\label{equation-iso}
R\Hom_{X'}(L(g')^*M, L(g')^*a(K))
\longrightarrow
R\Hom_{X'}(L(g')^*M, a'(Lg^*K))
\end{equation}
of global hom complexes, see
Cohomology on Sites, Section \ref{sites-cohomology-section-global-RHom},
as this will imply the cone of $L(g')^*a(K) \to a'(Lg^*K)$
is zero.
The structure of the proof is as follows: we will first show that
these Hom complexes are isomorphic and in the last part of the proof
we will show that the isomorphism is induced by (\ref{equation-iso}).

\medskip\noindent
The left hand side. Because $M$ is perfect, the canonical map
$$
R\Hom_X(M, a(K)) \otimes^\mathbf{L}_A A'
\longrightarrow
R\Hom_{X'}(L(g')^*M, L(g')^*a(K))
$$
is an isomorphism by Derived Categories of Spaces, Lemma
\ref{spaces-perfect-lemma-affine-morphism-and-hom-out-of-perfect}.
We can combine this with the isomorphism
$R\Hom_Y(Rf_*M, K) = R\Hom_X(M, a(K))$
of Lemma \ref{lemma-iso-global-hom}
to get that the left hand side equals
$R\Hom_Y(Rf_*M, K) \otimes^\mathbf{L}_A A'$.

\medskip\noindent
The right hand side. Here we first use the isomorphism
$$
R\Hom_{X'}(L(g')^*M, a'(Lg^*K)) = R\Hom_{Y'}(Rf'_*L(g')^*M, Lg^*K)
$$
of Lemma \ref{lemma-iso-global-hom}. Then we use the base change
map $Lg^*Rf_*M \to Rf'_*L(g')^*M$ is an isomorphism by
Derived Categories of Spaces, Lemma
\ref{spaces-perfect-lemma-compare-base-change}.
Hence we may rewrite this as $R\Hom_{Y'}(Lg^*Rf_*M, Lg^*K)$.
Since $Y$, $Y'$ are affine and $K$, $Rf_*M$ are in $D_\QCoh(\mathcal{O}_Y)$
(Derived Categories of Spaces, Lemma
\ref{spaces-perfect-lemma-quasi-coherence-direct-image})
we have a canonical map
$$
\beta :
R\Hom_Y(Rf_*M, K) \otimes^\mathbf{L}_A A'
\longrightarrow
R\Hom_{Y'}(Lg^*Rf_*M, Lg^*K)
$$
in $D(A')$. This is the arrow
More on Algebra, Equation (\ref{more-algebra-equation-base-change-RHom})
where we have used Derived Categories of Schemes, Lemmas
\ref{perfect-lemma-affine-compare-bounded} and
\ref{perfect-lemma-quasi-coherence-internal-hom}
to translate back and forth into algebra.
\begin{enumerate}
\item If $f$ is flat and of finite presentation, the complex $Rf_*M$
is perfect on $Y$ by Derived Categories of Spaces, Lemma
\ref{spaces-perfect-lemma-flat-proper-perfect-direct-image-general}
and $\beta$ is an isomorphism by
More on Algebra, Lemma \ref{more-algebra-lemma-base-change-RHom} part (1).
\item If $f$ is perfect and $Y$ Noetherian, the complex $Rf_*M$
is perfect on $Y$ by More on Morphisms of Spaces, Lemma
\ref{spaces-more-morphisms-lemma-perfect-proper-perfect-direct-image}
and $\beta$ is an isomorphism as before.
\item If $g$ has finite tor dimension and $Y$ is Noetherian,
the complex $Rf_*M$ is pseudo-coherent on $Y$
(Derived Categories of Spaces, Lemmas
\ref{spaces-perfect-lemma-direct-image-coherent} and
\ref{spaces-perfect-lemma-identify-pseudo-coherent-noetherian})
and $\beta$ is an isomorphism by
More on Algebra, Lemma \ref{more-algebra-lemma-base-change-RHom} part (4).
\end{enumerate}
We conclude that we obtain the same answer as in the previous paragraph.

\medskip\noindent
In the rest of the proof we show that the identifications of
the left and right hand side of (\ref{equation-iso})
given in the second and third paragraph are in fact given by
(\ref{equation-iso}). To make our formulas manageable
we will use $(-, -)_X = R\Hom_X(-, -)$, use $- \otimes A'$
in stead of $- \otimes_A^\mathbf{L} A'$, and we will abbreviate
$g^* = Lg^*$ and $f_* = Rf_*$. Consider the following
commutative diagram
$$
\xymatrix{
((g')^*M, (g')^*a(K))_{X'} \ar[d] &
(M, a(K))_X \otimes A' \ar[l]^-\alpha \ar[d] &
(f_*M, K)_Y \otimes A' \ar@{=}[l] \ar[d] \\
((g')^*M, (g')^*a(g_*g^*K))_{X'} &
(M, a(g_*g^*K))_X \otimes A' \ar[l]^-\alpha &
(f_*M, g_*g^*K)_Y \otimes A' \ar@{=}[l] \ar@/_4pc/[dd]_{\mu'} \\
((g')^*M, (g')^*g'_*a'(g^*K))_{X'} \ar[u] \ar[d] &
(M, g'_*a'(g^*K))_X \otimes A' \ar[u] \ar[l]^-\alpha \ar[ld]^\mu &
(f_*M, K) \otimes A' \ar[d]^\beta \\
((g')^*M, a'(g^*K))_{X'} &
(f'_*(g')^*M, g^*K)_{Y'} \ar@{=}[l] \ar[r] &
(g^*f_*M, g^*K)_{Y'}
}
$$
The arrows labeled $\alpha$ are the maps from
Derived Categories of Spaces, Lemma
\ref{spaces-perfect-lemma-affine-morphism-and-hom-out-of-perfect}
for the diagram with corners $X', X, Y', Y$.
The upper part of the diagram is commutative as the horizontal arrows are
functorial in the entries.
The middle vertical arrows come from the invertible transformation
$g'_* \circ a' \to a \circ g_*$  of Lemma \ref{lemma-flat-precompose-pus}
and therefore the middle square is commutative.
Going down the left hand side is (\ref{equation-iso}).
The upper horizontal arrows provide the identifications used in the
second paragraph of the proof.
The lower horizontal arrows including $\beta$ provide the identifications
used in the third paragraph of the proof. Given $E \in D(A)$,
$E' \in D(A')$, and $c : E \to E'$ in $D(A)$ we will denote
$\mu_c : E \otimes A' \to E'$ the map induced by $c$
and the adjointness of restriction and base change;
if $c$ is clear we write $\mu = \mu_c$, i.e., we
drop $c$ from the notation. The map $\mu$ in the diagram is of this
form with $c$ given by the identification
$(M, g'_*a(g^*K))_X = ((g')^*M, a'(g^*K))_{X'}$
; the triangle involving $\mu$ is commutative by
Derived Categories of Spaces, Remark
\ref{spaces-perfect-remark-multiplication-map}.

\medskip\noindent
Observe that
$$
\xymatrix{
(M, a(g_*g^*K))_X &
(f_*M, g_* g^*K)_Y \ar@{=}[l] &
(g^*f_*M, g^*K)_{Y'} \ar@{=}[l] \\
(M, g'_* a'(g^*K))_X \ar[u] &
((g')^*M, a'(g^*K))_{X'} \ar@{=}[l] &
(f'_*(g')^*M, g^*K)_{Y'} \ar@{=}[l] \ar[u]
}
$$
is commutative by the very definition of the transformation
$g'_* \circ a' \to a \circ g_*$. Letting $\mu'$ be as above
corresponding to the identification
$(f_*M, g_*g^*K)_X = (g^*f_*M, g^*K)_{Y'}$, then the
hexagon commutes as well. Thus it suffices to show that
$\beta$ is equal to the composition of
$(f_*M, K)_Y \otimes A' \to (f_*M, g_*g^*K)_X \otimes A'$
and $\mu'$. To do this, it suffices to prove the two induced maps
$(f_*M, K)_Y \to (g^*f_*M, g^*K)_{Y'}$ are the same.
In other words, it suffices to show the diagram
$$
\xymatrix{
R\Hom_A(E, K) \ar[rr]_{\text{induced by }\beta} \ar[rd] & &
R\Hom_{A'}(E \otimes_A^\mathbf{L} A', K \otimes_A^\mathbf{L} A') \\
& R\Hom_A(E, K \otimes_A^\mathbf{L} A') \ar[ru]
}
$$
commutes for all $E, K \in D(A)$. Since this is how $\beta$ is constructed in
More on Algebra, Section \ref{more-algebra-section-base-change-RHom}
the proof is complete.
\end{proof}














\input{chapters}

\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}
