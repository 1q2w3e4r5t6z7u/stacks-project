\input{preamble}

% OK, start here.
%
\begin{document}

\title{More Algebra}


\maketitle

\phantomsection
\label{section-phantom}

\tableofcontents



\section{Introduction}
\label{section-introduction}

\noindent
In this chapter we prove some results in commutative algebra which
are less elementary than those in the first chapter on commutative
algebra, see
Algebra, Section \ref{algebra-section-introduction}.
A reference is \cite{MatCA}.







\section{Derived tensor product}
\label{section-computing-tor}

\noindent
Let $R$ be a ring. We denote $D(R)$ the derived category of the
abelian category $\text{Mod}_R$ of $R$-modules. Note that $\text{Mod}_R$
has enough projectives as every free $R$-module is projective.
Thus we can define the left derived functors of any additive functor
from $\text{Mod}_R$ to any abelian category. This implies in particular
to the functor $- \otimes_R M : \text{Mod}_R \to \text{Mod}_R$
whose right derived functors are the Tor functors $\text{Tor}_i^R(-, M)$, see
Algebra, Section \ref{algebra-section-tor}.
There is also a total right derived functor
\begin{equation}
\label{equation-derived-tensor-module}
-\otimes_R^{\mathbf{L}} M :
D^{-}(R)
\longrightarrow
D^{-}(R)
\end{equation}
which is denoted $-\otimes_R^{\mathbf{L}} M$. Its satellites are the
tor groups, i.e., we have
$H^{-p}(N \otimes_R^{\mathbf{L}} M) = \text{Tor}_p^R(N, M)$.

\medskip\noindent
A special situation occurs when we consider the tensor product with
an $R$-algebra $A$. In this case we think of $- \otimes_R A$
as a functor from $\text{Mod}_R$ to $\text{Mod}_A$. Hence the total
right derived functor
\begin{equation}
\label{equation-derived-tensor-algebra}
-\otimes_R^{\mathbf{L}} A :
D^{-}(R)
\longrightarrow
D^{-}(A)
\end{equation}
which is denoted $-\otimes_R^{\mathbf{L}} A$. Its satellites are the
tor groups, i.e., we have
$H^{-p}(N \otimes_R^{\mathbf{L}} A) = \text{Tor}_p^R(N, A)$.
In particular these Tor groups naturally have the structure of $A$-modules.

\medskip\noindent
We can construct the derived tensor product in greater generality.
Suppose $K^\bullet \in D^{-}(R)$.
Choose a projective resolution $P^\bullet \to K^\bullet$, see
Derived Categories, Section \ref{derived-section-projective-resolutions}.
We claim that the functor
$$
L^\bullet \longrightarrow \text{Tot}(L^\bullet \otimes_R P^\bullet)
$$
initially defined on $\text{Comp}(\text{Mod}_R)$ gives rise to a
functor $D(R) \to D(R)$ which we will eventually denote
$ - \otimes^{\mathbf{L}} K^\bullet$.

\begin{lemma}
\label{lemma-derived-tor-homotopy}
Let $R$ be a ring.
Let $P^\bullet$ be a complex of $R$-modules.
Let $\alpha, \beta : L^\bullet \to M^\bullet$ be homotopy equivalent
maps of complexes. Then $\alpha$ and $\beta$ induce homotopy equivalent
maps
$$
\text{Tot}(\alpha \otimes \text{id}_P),
\text{Tot}(\beta \otimes \text{id}_P) :
\text{Tot}(L^\bullet \otimes_R P^\bullet)
\longrightarrow
\text{Tot}(M^\bullet \otimes_R P^\bullet).
$$
In particular the construction
$L^\bullet \mapsto \text{Tot}(L^\bullet \otimes_R P^\bullet)$
defines an endo-functor of the homotopy category of complexes.
\end{lemma}

\begin{proof}
Say $\alpha = \beta + dh + hd$ for some homotopy $h$ defined by
$h^n : L^n \to M^{n - 1}$. Set
$$
H^n = \bigoplus\nolimits_{a + b = n} h^a \otimes \text{id}_{P^b} :
\bigoplus\nolimits_{a + b = n} L^a \otimes_R P^b
\longrightarrow
\bigoplus\nolimits_{a + b = n} M^{a - 1} \otimes_R P^b
$$
Then a straightforward computation shows that
$$
\text{Tot}(\alpha \otimes \text{id}_P) =
\text{Tot}(\beta \otimes \text{id}_P) + dH + Hd
$$
as maps $\text{Tot}(L^\bullet \otimes_R P^\bullet) \to
\text{Tot}(M^\bullet \otimes_R P^\bullet)$.
\end{proof}

\begin{lemma}
\label{lemma-derived-tor-exact}
Let $R$ be a ring.
Let $P^\bullet$ be a complex of $R$-modules.
The functor
$$
K(\text{Mod}_R) \longrightarrow K(\text{Mod}_R),\quad
L^\bullet \longmapsto \text{Tot}(L^\bullet \otimes_R P^\bullet)
$$
is an exact functor of triangulated categories.
\end{lemma}

\begin{proof}
By our definition of the triangulated structure on
$K(\text{Mod}_R)$ we have to check that our functor maps
a termwise split short exact sequence of complexes to a termwise
split short exact sequence of complexes. As the terms of
$\text{Tot}(L^\bullet \otimes_R P^\bullet)$ are direct sums
of the tensor products $L^a \otimes_R P^b$ this is clear.
\end{proof}

\begin{lemma}
\label{lemma-derived-tor-quasi-isomorphism}
Let $R$ be a ring. Let $P^\bullet$ be a bounded above complex of
flat $R$-modules. The functor
$$
K(\text{Mod}_R) \longrightarrow K(\text{Mod}_R),\quad
L^\bullet \longmapsto \text{Tot}(L^\bullet \otimes_R P^\bullet)
$$
transforms quasi-isomorphisms into quasi-isomorphisms and
acyclic complexes into acyclic complexes.
\end{lemma}

\begin{proof}
By
Lemma \ref{lemma-derived-tor-exact}
and taking the cone of a quasi-isomorphism we see that it suffices
to prove the statement on acyclic complexes.
Let $L^\bullet$ be an acyclic complex of $R$-modules.
Let $\xi \in H^n(\text{Tot}(L^\bullet \otimes_R P^\bullet))$.
We have to show that $\xi = 0$.
Since $\text{Tot}^n(L^\bullet \otimes_R P^\bullet)$ is a direct
sum with terms $L^a \otimes_R P^b$ we see that $\xi$ comes from
an element in $H^n(\text{Tot}(\tau_{\leq m}L^\bullet \otimes_R P^\bullet))$
for some $m \in \mathbf{Z}$. Hence we may assume that $L^\bullet$
is bounded above. In this case the spectral sequence of
Homology, Lemma \ref{homology-lemma-first-quadrant-ss}
has
$$
{}'E_1^{p, q} = H^p(L^\bullet \otimes_R P^q)
$$
which is zero as $P^q$ is flat and $L^\bullet$ acyclic. Hence
$H^*(\text{Tot}(L^\bullet \otimes_R P^\bullet)) = 0$.
\end{proof}

\begin{lemma}
\label{lemma-derived-tor-quasi-isomorphism-other-side}
Let $R$ be a ring. Let
$\alpha : P^\bullet \to Q^\bullet$ be a quasi-isomorphism of
bounded above complexes of flat $R$-modules. For every complex of $R$-modules
the induced map
$$
\text{Tot}(\text{id}_L \otimes \alpha) :
\text{Tot}(L^\bullet \otimes_R P^\bullet)
\longrightarrow
\text{Tot}(L^\bullet \otimes_R Q^\bullet)
$$
is a quasi-isomorphism.
\end{lemma}

\begin{proof}
Let $\xi \in H^n(\text{Tot}(L^\bullet \otimes_R P^\bullet))$ and assume
that it maps to zero in
$H^n(\text{Tot}(L^\bullet \otimes_R Q^\bullet))$.
Then, arguing as in the proof of
Lemma \ref{lemma-derived-tor-quasi-isomorphism},
we can find an integer $m$ such that $\xi$ comes from an element
$\xi_m \in H^n(\text{Tot}(\tau_{\leq m}L^\bullet \otimes_R P^\bullet))$
which maps to zero in
$H^n(\text{Tot}(\tau_{\leq m}L^\bullet \otimes_R Q^\bullet))$.
Thus to prove injectivity of the map we may work with
$\tau_{\leq m}L^\bullet$ which is bounded above.
Similarly for surjectivity. Thus we may assume that $L^\bullet$ is bounded
above. (Some details omitted.)

\medskip\noindent
If $L^\bullet$ is bounded above we may choose a projective resolution
$F^\bullet \to L^\bullet$. Then the maps
$\text{Tot}(F^\bullet \otimes_R P^\bullet) \to 
\text{Tot}(L^\bullet \otimes_R P^\bullet)$
and
$\text{Tot}(F^\bullet \otimes_R Q^\bullet) \to 
\text{Tot}(L^\bullet \otimes_R Q^\bullet)$
are quasi-isomorphisms by
Lemma \ref{lemma-derived-tor-quasi-isomorphism}.
Hence it suffices to see that
$\text{Tot}(F^\bullet \otimes_R P^\bullet) \to
\text{Tot}(F^\bullet \otimes_R Q^\bullet)$
is a quasi-isomorphism. And this follows from
Lemma \ref{lemma-derived-tor-quasi-isomorphism}
after flipping the $\otimes$-products.
\end{proof}

\noindent
Let $K^\bullet$ be an object of $D^{-}(R)$. 
Choose a projective resolution $P^\bullet \to K^\bullet$, see
Derived Categories, Section \ref{derived-section-projective-resolutions}.
In fact, it suffices to choose a resolution by a bounded above
complex of flat modules. By
Lemmas \ref{lemma-derived-tor-homotopy} and \ref{lemma-derived-tor-exact}
we obtain an exact functor of triangulated categories
$$
K(\text{Mod}_R) \longrightarrow K(\text{Mod}_R),\quad
L^\bullet \longmapsto \text{Tot}(L^\bullet \otimes_R P^\bullet)
$$
By
Lemma \ref{lemma-derived-tor-quasi-isomorphism}
this functor induces a functor $D(R) \to D(R)$ simply because
$D(R)$ is the localization of $K(\text{Mod}_R)$ at quasi-isomorphism.
By
Lemma \ref{lemma-derived-tor-quasi-isomorphism-other-side}
the resulting functor (up to isomorphism)
does not depend on the choice of the projective resolution.

\begin{definition}
\label{definition-derived-tor}
Let $R$ be a ring. Let $K^\bullet$ be an object of $D^{-}(R)$.
The {\it derived tensor product}
$$
- \otimes_R^{\mathbf{L}} K^\bullet : D(R) \longrightarrow D(R)
$$
is the exact functor of triangulated categories described above.
\end{definition}

\noindent
Thus at this point $K^\bullet \otimes_R^{\mathbf{L}} L^\bullet$
is defined whenever $L^\bullet$ is in $D^{-}(R)$.
Moreover, it is clear from our explicit constructions that
there is a canonical isomorphism
$$
K^\bullet \otimes_R^{\mathbf{L}} L^\bullet
\cong
L^\bullet \otimes_R^{\mathbf{L}} K^\bullet
$$
whenever both $L^\bullet$ and $K^\bullet$ are in $D^{-}(R)$.
Hence when we write $K^\bullet \otimes_R^{\mathbf{L}} L^\bullet$
we will usually be agnostic about which variable we are using to
define the derived tensor product with.







\section{Spectral sequences for Tor}
\label{section-spectral-sequence-tor}


\noindent
In this section we collect various spectral sequences that come up
when considering the Tor functors.

\begin{example}
\label{example-cohomology-complex-tensored}
Let $R$ be a ring. Let $K_\bullet$ be a bounded above chain complex
of $R$-modules. Let $M$ be an $R$-module. Then there is a
spectral sequencem with $E_2$-page
$$
\text{Tor}^R_i(H_j(K_\bullet), M)
\Rightarrow
H_{i + j}(K_\bullet \otimes^{\mathbf{L}}_R M)
$$
and another spectral sequence with $E_1$-page
$$
\text{Tor}^R_i(K_j, M)
\Rightarrow
H_{i + j}(K_\bullet \otimes^{\mathbf{L}}_R M)
$$
This follows from the dual to
Derived Categories, Lemma \ref{derived-lemma-two-ss-complex-functor}.
\end{example}

\begin{example}
\label{example-tor-base-change}
Consider a commutative diagram
$$
\xymatrix{
B \ar[r] & B' = B \otimes_A A' \\
A \ar[r] \ar[u] & A' \ar[u]
}
$$
and $B$-modules $M, N$. Set $M' = M \otimes_A A' = M \otimes_B B'$
and $N' = N \otimes_A A' = N \otimes_B B'$.
{\it Assume that $A \to B$ is flat and that $M$ and $N$ are $A$-flat.}
Then there is a spectral sequence
$$
\text{Tor}^A_i(\text{Tor}_j^B(M, N), A')
\Rightarrow
\text{Tor}^{B'}_{i + j}(M', N')
$$
The reason is as follows. Choose free resolution
$F_\bullet \to M$ as a $B$-module. As $B$ and $M$ are $A$-flat we see
that $F_\bullet \otimes_A A'$ is a free $B'$-resolution of $M'$.
Hence we see that the groups $\text{Tor}^{B'}_n(M', N')$ are
computed by the complex
$$
(F_\bullet \otimes_A A') \otimes_{B'} N' =
(F_\bullet \otimes_B N) \otimes_A A' =
(F_\bullet \otimes_B N) \otimes^{\mathbf{L}}_A A'
$$
the last equality because $F_\bullet \otimes_B N$ is a complex
of flat $A$-modules as $N$ is flat over $A$. Hence we obtain the
spectral sequence by applying the spectral sequence of
Example \ref{example-cohomology-complex-tensored}.
\end{example}





\section{Formal glueing of module categories}
\label{section-formal-glueing}

\noindent
Fix a noetherian scheme $X$, and a closed subscheme $Z$ with complement $U$. 
Our goal is to explain a result of Artin that describes how coherent sheaves on 
$X$ can be constructed (uniquely) from coherent sheaves on the formal 
completion of $X$ along $Z$, and those on $U$ with a suitable compatibility on 
the overlap.

\begin{definition}
\label{definition-f-power-torsion}
Let $R$ be a ring. Let $M$ be an $R$-module.
\begin{enumerate}
\item Let $I \subset R$ be an ideal. We say $M$ is an
{\it $I$-power torsion module} if for every $m \in M$ there exists an $n > 0$
such that $I^n m = 0$.
\item Let $f \in R$. We say $M$ is 
{\it an $f$-power torsion module} if for each 
$m \in M$, there exists an $n > 0$ such that $f^n m = 0$.
\end{enumerate}
\end{definition}

\noindent
Thus an $f$-power torsion module is the same thing as a $I$-power torsion
module for $I = (f)$. We sometimes use the notation
$M[I^n] = \{m \in M \mid I^nm = 0\}$ and $M[I^\infty] = \bigcup M[I^n]$
for an $R$-module $M$. Thus $M$ is $I$-power torsion if and only if
$M = M[I^\infty]$ if and only if $M = \bigcup M[I^n]$.

\begin{lemma}
\label{lemma-characterize-flatness-on-torsion}
Let $\varphi : R \to S$ be a ring map. Let $I \subset R$ be an ideal.
The following are equivalent
\begin{enumerate}
\item $\varphi$ is flat and $R/I \to S/IS$ is faithfully flat,
\item $\varphi$ is flat, and the map
$\text{Spec}(S/IS) \to \text{Spec}(R/I)$ is surjective.
\item $\varphi$ is flat, and the base change functor
$M \mapsto M \otimes_R S$ is faithful on modules annihilated by $I$, and
\item $\varphi$ is flat, and the base change functor
$M \mapsto M \otimes_R S$ is faithful on $I$-power torsion modules.
\end{enumerate}
\end{lemma}

\begin{proof}
If $R \to S$ is flat, then $R/I^n \to S/I^nS$ is flat for every $n$, see
Algebra, Lemma \ref{algebra-lemma-flat-base-change}.
Hence (1) and (2) are equivalent by
Algebra, Lemma \ref{algebra-lemma-ff-rings}.
The equivalence of (1) with (3) follows by identifying $I$-torsion
$R$-modules with $R/I$-modules, using that
$$
M \otimes_R S = M \otimes_{R/I} S/IS
$$ 
for $R$-modules $M$ annihilated by $I$, and
Algebra, Lemma \ref{algebra-lemma-easy-ff}.
The implication (4) $\Rightarrow$ (3) is immediate. Assume (3). We have
seen above that $R/I^n \to S/I^nS$ is flat, and by assumption it induces
a surjection on spectra, as $\text{Spec}(R/I^n) = \text{Spec}(R/I)$ and
similarly for $S$. Hence the base change functor is faithful on modules
annihilated by $I^n$. Since any $I$-power torsion module $M$ is the union
$M = \bigcup M_n$ where $M_n$ is annihilated by $I^n$ we see that the base
change functor is faithful on the category of all $I$-power torsion modules
(as tensor product commutes with colimits).
\end{proof}

\begin{lemma}
\label{lemma-I-power-torsion-presentation}
Let $R$ be a ring.
Let $I$ be an ideal of $R$.
Let $M$ be an $I$-power torsion module.
Then $M$ admits a resolution
$$
\ldots \to K_2 \to K_1 \to K_0 \to M \to 0
$$
with each $K_i$ a direct sum of copies of $R/I^n$ for $n$ variable.
\end{lemma}

\begin{proof}
There is a canonical surjection
$$
\oplus_{m \in M} R/I^{n_m} \to M \to 0
$$
where $n_m$ is the smallest positive integer such that $I^{n_m} \cdot m = 0$.
The kernel of the preceding surjection is also an $I$-power torsion module.
Proceeding inductively, we construct the desired resolution of $M$.
\end{proof}

\begin{lemma}
\label{lemma-neighbourhood-isomorphism}
Assume $(\varphi : R \to S, I)$ satisfies the equivalent conditions of
Lemma \ref{lemma-characterize-flatness-on-torsion}.
The following are equivalent
\begin{enumerate}
\item for any $I$-power torsion module $M$, the natural map
$M \to M \otimes_R S$ is an isomorphism, and
\item $R/I \to S/IS$ is an isomorphism.
\end{enumerate}
\end{lemma}

\begin{proof}
The implication (1) $\Rightarrow$ (2) is immediate.
Assume (2). First assume that $M$ is annihilated by $I$.
In this case, $M$ is an $R/I$-module. Hence, we have an isomorphism  
$$
M \otimes_R S = M \otimes_{R/I} S/IS = M \otimes_{R/I} R/I = M
$$
proving the claim. Next we prove by induction that $M \to M \otimes_R S$
is an isomorphism for any module $M$ is annihilated by $I^n$. Assume
the induction hypothesis holds for $n$ and assume $M$ is annihilated by
$I^{n + 1}$. Then we have a short exact sequence
$$
0 \to I^nM \to M \to M/I^nM \to 0
$$
and as $R \to S$ is flat this gives rise to a short exact sequence
$$
0 \to I^nM \otimes_R S \to M \otimes_R S \to M/I^nM \otimes_R S \to 0
$$
Using that the canonical map is an isomorphism for $M' = I^nM$ and
$M'' = M/I^nM$ (by induction hypothesis) we conclude the same thing is
true for $M$. Finally, suppose that $M$ is a general $I$-power torsion
module. Then $M = \bigcup M_n$ where $M_n$ is annihilated by $I^n$
and we conclude using that tensor products commute with colimits.
\end{proof}

\begin{lemma}
\label{lemma-torsion-free}
Let $R$ be a ring. Let $I$ be an ideal of $R$.
For any $R$-module $M$ set $M[I^n] = \{m \in M \mid I^nm = 0\}$.
If $I$ is finitely generated then the following are equivalent
\begin{enumerate}
\item $M[I] = 0$,
\item $M[I^n] = 0$ for all $n \geq 1$, and
\item if $I = (f_1, \ldots, f_t)$, then the map
$M \to \bigoplus M_{f_i}$ is injective.
\end{enumerate}
\end{lemma}

\begin{proof}
This follows from
Algebra, Lemma \ref{algebra-lemma-when-injective-covering}.
\end{proof}

\begin{lemma}
\label{lemma-divide-by-torsion}
Let $R$ be a ring. Let $I$ be an ideal of $R$. For any $R$-module $M$
set $M[I^\infty] = \bigcup_{n \geq 1} M[I^n]$.
If $I$ is finitely generated, then $(M/M[I^\infty])[I] = 0$.
\end{lemma}

\begin{proof}
Let $m \in M$. If $m$ maps to an element of $(M/M[I^\infty])[I]$
then $Im \subset M[I^\infty]$.
Write $I = (f_1, \ldots, f_t)$. Then we see that
$f_i m \in M[I^\infty]$, i.e., $I^{n_i}f_i m = 0$ for some $n_i > 0$.
Thus we see that $I^Nm = 0$ with $N = \sum n_i + 2$.
Hence $m$ maps to zero in $(M/M[I^\infty])$ which proves the lemma.
\end{proof}

\begin{lemma}
\label{lemma-neighbourhood-equivalence}
Assume $\varphi : R \to S$ is a flat ring map and $I \subset R$ is a
finitely generated ideal such that $R/I \to S/IS$ is an isomorphism. Then
\begin{enumerate}
\item for any $R$-module $M$ the map $M \to M \otimes_R S$ induces
an isomorphism
$M[I^\infty] \to (M \otimes_R S)[(IS)^\infty]$ of $I$-power
torsion submodules,
\item the natural map
$$
\text{Hom}_R(M, N) \longrightarrow \text{Hom}_S(M \otimes_R S, N \otimes_R S)
$$
is an isomorphism if either $M$ or $N$ is $I$-power torsion, and
\item the base change functor $M \mapsto M \otimes_R S$ defines an
equivalence of categories between $I$-power torsion modules
and $IS$-power torsion modules.
\end{enumerate}
\end{lemma}

\begin{proof}
Note that the equivalent conditions of both
Lemma \ref{lemma-characterize-flatness-on-torsion} and
Lemma \ref{lemma-neighbourhood-isomorphism}
are satisfied. We will use these without further mention.
We first prove (1). Let $M$ be any $R$-module.
Set $M' = M/M[I^\infty]$ and consider the exact sequence
$$
0 \to M[I^\infty] \to M \to M' \to 0
$$
As $M[I^\infty] = M[I^\infty] \otimes_R S$ we see that it suffices to
show that $(M' \otimes_R S)[(IS)^\infty] = 0$.
Write $I = (f_1, \ldots, f_t)$. By
Lemma \ref{lemma-divide-by-torsion}
we see that $M'[I^\infty] = 0$. Hence for every $n > 0$ the map
$$
M' \longrightarrow \bigoplus\nolimits_{i = 1, \ldots t} M',
\quad
x \longmapsto (f_1^n x, \ldots, f_t^n x)
$$
is injective. As $S$ is flat over $R$ also the corresponding map
$M' \otimes_R S \to \bigoplus_{i = 1, \ldots t} M' \otimes_R S$
is injective. This means that $(M' \otimes_R S)[I^n] = 0$ as desired.

\medskip\noindent
Next we prove (2). If $N$ is $I$-power torsion, then
$N \otimes_R S = N$ and the displayed map of (2) is an isomorphism by
Algebra, Lemma \ref{algebra-lemma-adjoint-tensor-restrict}.
If $M$ is $I$-power torsion, then the image of any map
$M \to N$ factors through $M[I^\infty]$ and the image of any map
$M \otimes_R S \to N \otimes_R S$ factors through
$(N \otimes_R S)[(IS)^\infty]$. Hence in this case
part (1) guarantees that we may replace $N$ by $N[I^\infty]$
and the result follows from the case where $N$ is $I$-power torsion
we just discussed.

\medskip\noindent
Next we prove (3). The functor is fully faithful by (2).
For essential surjectivity, we simply note that for any $IS$-power torsion
$S$-module $N$, the natural map $N \otimes_R S \to N$ is an isomorphism.
\end{proof}

\begin{lemma}
\label{lemma-naive-Koszul-complex}
Let $R$ be a ring. Let $I = (f_1, \ldots, f_n)$ be a finitely generated ideal
of $R$. Let $M$ be the $R$-module generated by elements
$e_1, \ldots, e_n$ subject to the relations $f_i e_j - f_j e_i = 0$.
There exists a short exact sequence
$$
0 \to K \to M \to I \to 0
$$
such that $K$ is annihilated by $I$.
\end{lemma}

\begin{proof}
This is just a truncation of the Koszul complex, see (insert future
reference here).
The map $M \to I$ is is determined by the rule $e_i \mapsto f_i$. If
$m = \sum a_i e_i$ is in the kernel of $M \to I$, i.e., $\sum a_i f_i = 0$,
then $f_j m = \sum f_j a_i e_i = (\sum f_i a_i) e_j = 0$.
\end{proof}

\begin{lemma}
\label{lemma-explicit-ext}
Let $R$ be a ring. Let $I = (f_1, \ldots, f_n)$ be a finitely generated ideal
of $R$. For any $R$-module $N$ set
$$
H_1(N, f_\bullet) =
\frac{\{(x_1, \ldots, x_n) \in N^{\oplus n} \mid f_i x_j = f_j x_i \}}
{\{f_1x, \ldots, f_nx) \mid x \in N\}}
$$
For any $R$-module $N$ there exists a canonical short exact sequence
$$
0 \to \text{Ext}_R(R/I, N) \to H_1(N, f_\bullet) \to \text{Hom}_R(K, N)
$$
where $K$ is as in
Lemma \ref{lemma-naive-Koszul-complex}.
\end{lemma}

\begin{proof}
The notation above indicates the $\text{Ext}$-groups in $\text{Mod}_R$
as defined in
Homology, Section \ref{homology-section-extensions}.
These are denoted $\text{Ext}_R(M, N)$. Using the long exact sequence of
Homology, Lemma \ref{homology-lemma-six-term-sequence-ext}
associated to the short exact sequence $0 \to I \to R \to R/I \to 0$
and the fact that $\text{Ext}_R(R, N) = 0$ we see that
$$
\text{Ext}_R(R/I, N) =
\text{Coker}(N \longrightarrow \text{Hom}(I, N))
$$
Using the short exact sequence of
Lemma \ref{lemma-naive-Koszul-complex}
we see that we get a complex
$$
N \to \text{Hom}(M, N) \to \text{Hom}_R(K, N)
$$
whose homology in the middle is canonically isomorphic to
$\text{Ext}_R(R/I, N)$. The proof of the lemma is now complete
as the cokernel of the first map
is canonically isomorphic to $H_1(N, f_\bullet)$.
\end{proof}

\begin{lemma}
\label{lemma-koszul-homology-annihilated}
Let $R$ be a ring. Let $I = (f_1, \ldots, f_n)$ be a finitely generated ideal
of $R$. For any $R$-module $N$ the Koszul homology group
$H_1(N, f_\bullet)$ defined in
Lemma \ref{lemma-explicit-ext}
is annihilated by $I$.
\end{lemma}

\begin{proof}
Let $(x_1, \ldots, x_n) \in N^{\oplus n}$ with $f_i x_j = f_j x_i$.
Then we have $f_i(x_1, \ldots, x_n) = (f_i x_i, \ldots, f_i x_n)$.
In other words $f_i$ annihilates $H_1(N, f_\bullet)$.
\end{proof}

\noindent
We can improve on the full faithfulness of
Lemma \ref{lemma-neighbourhood-equivalence}
by showing that $\text{Ext}$-groups whose source is $I$-power torsion
are insensitive to passing to $S$ as well. See
Remark \ref{remark-neighbourhood-extensions}
below for a more highbrow version of the following lemma.

\begin{lemma}
\label{lemma-neighbourhood-extensions}
Assume $\varphi : R \to S$ is a flat ring map and $I \subset R$ is a
finitely generated ideal such that $R/I \to S/IS$ is an isomorphism.
Let $M$, $N$ be $R$-modules. Assume $M$ is $I$-power torsion.
Given an short exact sequence
$$
0 \to N \otimes_R S \to \tilde E \to M \otimes_R S \to 0
$$
there exists a commutative diagram
$$
\xymatrix{
0 \ar[r] &
N \ar[r] \ar[d] &
E \ar[r] \ar[d] &
M \ar[r] \ar[d] &
0 \\
0 \ar[r] &
N \otimes_R S \ar[r] &
\tilde E \ar[r] &
M \otimes_R S \ar[r] &
0
}
$$
with exact rows.
\end{lemma}

\begin{proof}
As $M$ is $I$-power torsion we see that $M \otimes_R S = M$, see
Lemma \ref{lemma-neighbourhood-isomorphism}.
We will use this identification without further mention.
As $R \to S$ is flat, the base change functor is exact and we
obtain a functorial map of $\text{Ext}$-groups
$$
\text{Ext}_R(M, N)
\longrightarrow
\text{Ext}_S(M \otimes_R S, N \otimes_R S),
$$
see
Homology, Lemma \ref{homology-lemma-exact-functor-ext}.
The claim of the lemma is that this map is surjective when
$M$ is $I$-power torsion. In fact we will show that it is an
isomorphism. By
Lemma \ref{lemma-I-power-torsion-presentation}
we can find a surjection $M' \to M$ with $M'$ a direct sum of
modules of the form $R/I^n$. Using the long exact sequence of
Homology, Lemma \ref{homology-lemma-six-term-sequence-ext}
we see that it suffices to prove the lemma for $M'$.
Using compatibility of $\text{Ext}$ with direct sums (details omitted)
we reduce to the case where $M = R/I^n$ for some $n$.

\medskip\noindent
Let $f_1, \ldots, f_t$ be generators for $I^n$. By
Lemma \ref{lemma-explicit-ext}
we have a commutative diagram
$$
\xymatrix{
0 \ar[r] &
\text{Ext}_R(R/I^n, N) \ar[r] \ar[d] &
H_1(N, f_\bullet) \ar[r] \ar[d] &
\text{Hom}_R(K, N) \ar[d] \\
0 \ar[r] &
\text{Ext}_S(S/I^nS, N \otimes S) \ar[r] &
H_1(N \otimes S, f_\bullet) \ar[r] &
\text{Hom}_S(K \otimes S, N \otimes S)
}
$$
with exact rows where $K$ is as in
Lemma \ref{lemma-naive-Koszul-complex}.
Hence it suffices to prove that the two right vertical arrows are
isomorphisms. Since $K$ is annihilated by $I^n$ we see that
$\text{Hom}_R(K, N) = \text{Hom}_S(K \otimes_R S, N \otimes_R S)$ by
Lemma \ref{lemma-neighbourhood-equivalence}.
As $R \to S$ is flat we have
$H_1(N, f_\bullet) \otimes_R S = H_1(N \otimes_R S, f_\bullet)$.
As $H_1(N, f_\bullet)$ is annihilated by $I^n$, see
Lemma \ref{lemma-koszul-homology-annihilated}
we have $H_1(N, f_\bullet) \otimes_R S = H_1(N, f_\bullet)$ by
Lemma \ref{lemma-neighbourhood-isomorphism}.
\end{proof}

\begin{remark}
\label{remark-neighbourhood-extensions}
Assume $\varphi : R \to S$ is a flat ring map and $I \subset R$ is a
finitely generated ideal such that $R/I \to S/IS$ is an isomorphism.
Let $M$, $N$ be $R$-modules and assume $M$ is $I$-power torsion.
Then the canonical map
$$
\text{Ext}^i_R(M, N)
\longrightarrow
\text{Ext}^i_S(M \otimes_R S, N \otimes_R S)
$$
is an isomorphism for all $i$. We sketch a proof of this strengthening of
Lemma \ref{lemma-neighbourhood-extensions}.
Consider the Koszul complex $K_\bullet = K_\bullet(R, f_\bullet)$ which is
the complex
$$
0 \to \wedge^n R^n \to \wedge^{n-1} R^n \to
\ldots \to \wedge^i R^n \to \ldots \to R^n \to R \to 0
$$
where the last term $R$ is placed in degree $0$ with maps given by
$$
e_{j_1} \wedge \ldots \wedge e_{j_i}
\longmapsto
\sum\nolimits_{a = 1}^i (-1)^{i + 1} f_{j_a} e_{j_1} \wedge \ldots
\wedge \hat e_{j_a} \wedge \ldots \wedge e_{j_i}
$$
Then $H_0(K_\bullet) = R/I$ and every homology module $H_i(K_\bullet)$
is annihilated by $I$. Having said this, we prove the statement
on $\text{Ext}$-groups by induction on $i$. The case $i = 0$ is
Lemma \ref{lemma-neighbourhood-equivalence}.
Assume that the result holds for all $i \leq i_0$ and all modules
$N$, $M$ with $M$ being $I$-power torsion. Pick a pair of modules
$N$ and $M$ with $M$ being $I$-power torsion and let's prove that
the map
$\text{Ext}^{i_0 + 1}_R(M, N) \to
\text{Ext}^{i_0 + 1}_S(M \otimes_R S, N \otimes_R S)$
is an isomorphism. By
Lemma \ref{lemma-I-power-torsion-presentation}
and the long exact sequence of $\text{Ext}$-groups and compatibility of
$\text{Ext}$ with direct sums we reduce to the case that $M = R/I^n$.
Since $I^n$ is finitely generated we can choose finitely many generators
$f_1, \ldots, f_t \in I^n$ and consider the Koszul complex
$K_\bullet = K_\bullet(R, f_\bullet)$. Note that
$K_\bullet \otimes_R S = K_\bullet(S, f_\bullet)$.
As $K_\bullet$ is a finite complex of finite free $R$-modules we
see that the map
\begin{equation}
\label{equation-comparison}
\text{Hom}_R(K_\bullet, N) \otimes_R S
\longrightarrow
\text{Hom}_S(K_\bullet \otimes_R S, N \otimes_R S)
\end{equation}
is an isomorphism of complexes. As $R \to S$ is flat and using
Lemmas \ref{lemma-neighbourhood-equivalence}
we see that
$$
H_b(K_\bullet) = H_b(K_\bullet) \otimes_R S = H_b(K_\bullet \otimes_R S).
$$
Below we will use the spectral sequences
\begin{align*}
E(R)_2^{a, b} = \text{Ext}^a_R(H_b(K_\bullet), N)
& \Rightarrow
H^{a + b}(\text{Hom}_R(K_\bullet, N)), \\
E(S)_2^{a, b} = \text{Ext}^a_R(H_b(K_\bullet \otimes_R S), N \otimes_R S)
& \Rightarrow
H^{a + b}(\text{Hom}_R(K_\bullet \otimes_R S, N \otimes_R S))
\end{align*}
see (insert future reference here).
The first one combined with the fact that each $H_b(K_\bullet)$
is annihilated by $I^n$ implies that $H^c(\text{Hom}_R(K_\bullet, N))$
is annihilated by $I^{n(t + 1)}$. Hence using
Lemma \ref{lemma-neighbourhood-equivalence}
once more we see that
$$
H^c(\text{Hom}_R(K_\bullet, N)) =
H^c(\text{Hom}_R(K_\bullet, N)) \otimes_R S =
H^c(\text{Hom}_S(K_\bullet \otimes_R S, N \otimes_R S))
$$
because (\ref{equation-comparison}) is an isomorphism and $R \to S$ is flat.
Combined we see that the map $E(R)_r^{a, b} \to E(S)_r^{a, b}$ of spectral
sequences is an isomorphism for $r = 2$ and $a \leq i_0$ (induction hypothesis)
and an isomorphism on abutments in all degrees.
Then a formal argument on spectral sequences (insert future
reference here) implies that
$E(R)_2^{i_0 + 1, 0} \to E(R)_2^{i_0 + 1, 0}$
is an isomorphism as well, which is the result we wanted to prove.
This ends the sketch of the proof of the result on $\text{Ext}$-groups;
if we ever need to use this result in the stacks project we will put in
a detailed proof.
\end{remark}

\noindent
Let $R \to S$ be a ring map.
Let $f_1, \ldots, f_t \in R$ and $I = (f_1, \ldots, f_t)$.
Then for any $R$-module $M$ we can define a complex
\begin{equation}
\label{equation-glueing-complex}
0 \to M \xrightarrow{\alpha}
M \otimes_R S \times \prod M_{f_i} \xrightarrow{\beta}
\prod (M \otimes_R S)_{f_i}
\times
\prod M_{f_if_j}
\end{equation}
where $\alpha(m) = (m \otimes 1, m/1, \ldots, m/1)$ and
$$
\beta(m', m_1, \ldots, m_t) =
((m'/1 - m_1 \otimes 1, \ldots, m'/1 - m_t \otimes 1),
(m_1 - m_2, \ldots, m_{t - 1} - m_t).
$$
We would like to know when this complex is exact.

\begin{lemma}
\label{lemma-recover-module-from-glueing-data}
Assume $\varphi : R \to S$ is a flat ring map and
$I = (f_1, \ldots, f_t) \subset R$ is an ideal such that
$R/I \to S/IS$ is an isomorphism.
Let $M$ be an $R$-module. Then the
complex (\ref{equation-glueing-complex})
is exact.
\end{lemma}

\begin{proof}
Let $m \in M$. If $\alpha(m) = 0$, then $m \in M[I^\infty]$, see
Lemma \ref{lemma-torsion-free}. Pick $n$ such that $I^n m = 0$
and consider the map $\varphi : R/I^n \to M$.
If $m \otimes 1 = 0$, then $\varphi \otimes 1_S = 0$, hence
$\varphi = 0$ (see
Lemma \ref{lemma-neighbourhood-equivalence})
hence $m = 0$. In this way we see that $\alpha$ is injective.

\medskip\noindent
Let $(m', m'_1, \ldots, m'_t) \in \text{Ker}(\beta)$.
Write $m'_i = m_i/f_i^n$ for some $n > 0$ and $m_i \in M$.
We may, after possibly enlarging $n$ assume that
$f_i^n m' = m_i \otimes 1$ in $M \otimes_R S$ and
$f_j^nm_i - f_i^nm_j = 0$ in $M$.
In particular we see that
$(m_1, \ldots, m_t)$ defines an element $\xi$ of
$H_1(M, (f_1^n, \ldots, f_t^n))$.
Since $H_1(M, (f_1^n, \ldots, f_t^n))$ is annihilated by $I^{tn + 1}$ (see
Lemma \ref{lemma-koszul-homology-annihilated})
and since $R \to S$ is flat we see that
$$
H_1(M, (f_1^n, \ldots, f_t^n)) =
H_1(M, (f_1^n, \ldots, f_t^n)) \otimes_R S =
H_1(M \otimes_R S, (f_1^n, \ldots, f_t^n))
$$
by
Lemma \ref{lemma-neighbourhood-isomorphism}
The existence of $m'$ implies that $\xi$ maps to zero in the last group, i.e.,
the element $\xi$ is zero. Thus there exists an $m \in M$ such that
$m_i = f_i^n m$. Then $(m', m'_1, \ldots, m'_t) - \alpha(m)
= (m'', 0, \ldots, 0)$ for some $m'' \in (M \otimes_R S)[(IS)^\infty]$.
By
Lemma \ref{lemma-neighbourhood-equivalence}
we conclude that $m'' \in M[I^\infty]$ and we win.
\end{proof}

\begin{remark}
\label{remark-glueing-data}
In this remark we define a category of glueing data.
Let $R \to S$ be a ring map.
Let $f_1, \ldots, f_t \in R$ and $I = (f_1, \ldots, f_t)$.
Consider the category $\text{Glue}(R \to S, f_1, \ldots, f_t)$
as the category whose
\begin{enumerate}
\item objects are systems $(M', M_i, \alpha_i, \alpha_{ij})$, where
$M'$ is an $S$-module, $M_i$ is an $R_{f_i}$-module,
$\alpha_i : (M')_{f_i} \to M_i \otimes_R S$ is an isomorphism, and
$\alpha_{ij} : (M_i)_{f_j} \to (M_j)_{f_i}$ are isomorphisms
such that
\begin{enumerate}
\item $\alpha_{ij} \circ \alpha_i = \alpha_j$ as maps
$(M')_{f_if_j} \to (M_j)_{f_i}$, and
\item $\alpha_{jk} \circ \alpha_{ij} = \alpha_{ik}$ as maps
$(M_i)_{f_jf_k} \to (M_k)_{f_if_j}$ (cocycle condition).
\end{enumerate}
\item morphisms
$(M', M_i, \alpha_i, \alpha_{ij}) \to (N', N_i, \beta_i, \beta_{ij})$
are given by maps $\varphi' : M' \to N'$ and $\varphi_i : M_i \to N_i$
compatible with the given maps $\alpha_i, \beta_i, \alpha_{ij}, \beta_{ij}$.
\end{enumerate}
There is a canonical functor
$$
\text{Can} : \text{Mod}_R
\longrightarrow
\text{Glue}(R \to S, f_1, \ldots, f_t),
\quad
M \longmapsto (M \otimes_R S, M_{f_i}, \text{can}_i, \text{can}_{ij})
$$
where $\text{can}_i : (M \otimes_R S)_{f_i} \to M_{f_i} \otimes_R S$
and $\text{can}_{ij} : (M_{f_i})_{f_j} \to (M_{f_j})_{f_i}$
are the canonical isomorphisms. For any object
$\mathbf{M} = (M', M_i, \alpha_i, \alpha_{ij})$ of the category
$\text{Glue}(R \to S, f_1, \ldots, f_t)$ we define
$$
H^0(\mathbf{M}) =
\{(m', m_i) \mid \alpha_i(m') = m_i \otimes 1, \alpha_{ij}(m_i) = m_j\}
$$
in other words defined by the exact sequence
$$
0 \to H^0(\mathbf{M}) \to
M' \times \prod M_i \to
\prod M'_{f_i}
\times
\prod (M_i)_{f_j}
$$
similar to (\ref{equation-glueing-complex}).
We think of $H^0(\mathbf{M})$ as an $R$-module. Thus we also get a functor
$$
H^0 : 
\text{Glue}(R \to S, f_1, \ldots, f_t)
\longrightarrow
\text{Mod}_R
$$
Our next goal is to show that the functors
$\text{Can}$ and $H^0$ are sometimes quasi-inverse to each other.
\end{remark}

\begin{lemma}
\label{lemma-H0-inverse}
Assume $\varphi : R \to S$ is a flat ring map and
$I = (f_1, \ldots, f_t) \subset R$ is an ideal such that
$R/I \to S/IS$ is an isomorphism. Then the functor $H^0$
is a left quasi-inverse to the functor $\text{Can}$ of
Remark \ref{remark-glueing-data}.
\end{lemma}

\begin{proof}
This is a reformulation of
Lemma \ref{lemma-recover-module-from-glueing-data}.
\end{proof}

\begin{lemma}
\label{lemma-exact}
Assume $\varphi : R \to S$ is a flat ring map and let
$I = (f_1, \ldots, f_t) \subset R$ be an ideal.
Then $\text{Glue}(R \to S, f_1, \ldots, f_t)$ is an abelian category, and
the functor $\text{Can}$ is exact and commutes with arbitrary colimits.
\end{lemma}

\begin{proof}
Given a morphism
$(\varphi', \varphi_i) :
(M', M_i, \alpha_i, \alpha_{ij})
\to
(N', N_i, \beta_i, \beta_{ij})$
of the category $\text{Glue}(R \to S, f_1, \ldots, f_t)$
we see that its kernel exists and is equal to the object
$(\text{Ker}(\varphi'), \text{Ker}(\varphi_i), \alpha_i, \alpha_{ij})$
and its cokernel exists and is equal to the object
$(\text{Coker}(\varphi'), \text{Coker}(\varphi_i), \beta_i, \beta_{ij})$.
This works because $R \to S$ is flat, hence taking kernels/cokernels
commutes with $- \otimes_R S$. Details omitted.
The exactness follows from the $R$-flatness of $R_{f_i}$ and $S$, while
commuting with colimits follows as tensor products commute with colimits.
\end{proof}

\begin{lemma}
\label{lemma-equivalence-I-unit}
Let $\varphi : R \to S$ be a flat ring map and $(f_1, \ldots, f_t) = R$.
Then $\text{Can}$ and $H^0$ are quasi-inverse equivalences of categories
$$
\text{Mod}_R = \text{Glue}(R \to S, f_1, \ldots, f_t)
$$
\end{lemma}

\begin{proof}
Consider an object $\mathbf{M} = (M', M_i, \alpha_i, \alpha_{ij})$
of $\text{Glue}(R \to S, f_1, \ldots, f_t)$. By
Algebra, Lemma \ref{algebra-lemma-glue-modules}
there exists a unique module $M$ and isomorphisms
$M_{f_i} \to M_i$ which recover the glueing data $\alpha_{ij}$.
Then both $M'$ and $M \otimes_R S$ are $S$-modules
which recover the modules $M_i \otimes_R S$ upon localizing at $f_i$.
Whence there is a canonical isomorphism $M \otimes_R S \to M'$.
This shows that $\mathbf{M}$ is in the essential image of $\text{Can}$.
Combined with
Lemma \ref{lemma-H0-inverse}
the lemma follows.
\end{proof}

\begin{lemma}
\label{lemma-base-change-glue}
Let $\varphi : R \to S$ be a flat ring map and $I = (f_1, \ldots, f_t)$
and ideal. Let $R \to R'$ be a flat ring map, and set $S' = S \otimes_R R'$.
Then we obtain a commutative diagram of categories and functors
$$
\xymatrix{
\text{Mod}_R \ar[r]_-{\text{Can}} \ar[d]_{-\otimes_R R'} &
\text{Glue}(R \to S, f_1, \ldots, f_t) \ar[r]_-{H^0} \ar[d]^{-\otimes_R R'} &
\text{Mod}_R \ar[d]^{-\otimes_R R'} \\
\text{Mod}_{R'} \ar[r]^-{\text{Can}} &
\text{Glue}(R' \to S', f_1, \ldots, f_t) \ar[r]^-{H^0} &
\text{Mod}_{R'}
}
$$
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{proposition}
\label{proposition-equivalence}
Assume $\varphi : R \to S$ is a flat ring map and
$I = (f_1, \ldots, f_t) \subset R$ is an ideal such that
$R/I \to S/IS$ is an isomorphism. Then $\text{Can}$ and
$H^0$ are quasi-inverse equivalences of categories
$$
\text{Mod}_R = \text{Glue}(R \to S, f_1, \ldots, f_t)
$$
\end{proposition}

\begin{proof}
We have already seen that $H^0 \circ \text{Can}$ is isomorphic to the
identity functor, see
Lemma \ref{lemma-H0-inverse}.
Consider an object $\mathbf{M} = (M', M_i, \alpha_i, \alpha_{ij})$
of $\text{Glue}(R \to S, f_1, \ldots, f_t)$.
We get a natural morphism
$$
\Psi :
(H^0(\mathbf{M}) \otimes_R S, H^0(\mathbf{M})_{f_i},
\text{can}_i, \text{can}_{ij})
\longrightarrow
(M', M_i, \alpha_i, \alpha_{ij}).
$$
Namely, by definition $H^0(\mathbf{M})$ comes equipped with compatible
$R$-module maps $H^0(\mathbf{M}) \to M'$ and $H^0(\mathbf{M}) \to M_i$.
We have to show that this map is an isomorphism.

\medskip\noindent
Pick an index $i$ and set $R' = R_{f_i}$. Combining
Lemmas \ref{lemma-base-change-glue} and \ref{lemma-equivalence-I-unit}
we see that $\Psi \otimes_R R'$ is an isomorphism.
Hence the kernel, resp.\ cokernel of $\Psi$ is a system of the form
$(K, 0, 0, 0)$, resp.\ $(Q, 0, 0, 0)$. Note that
$H^0((K, 0, 0, 0)) = K$, that $H^0$ is left exact, and that by
construction $H^0(\Psi)$ is bijective. Hence we see $K = 0$, i.e.,
the kernel of $\Psi$ is zero.

\medskip\noindent
The conclusion of the above is that we obtain a short exact sequence
$$
0 \to H^0(\mathbf{M}) \otimes_R S \to M' \to Q \to 0
$$
and that $M_i = H^0(\mathbf{M})_{f_i}$.
Note that we may think of $Q$ as an $R$-module which is $I$-power
torsion so that $Q = Q \otimes_R S$. By
Lemma \ref{lemma-neighbourhood-extensions}
we see that there exists a commutative diagram
$$
\xymatrix{
0 \ar[r] &
H^0(\mathbf{M}) \ar[r] \ar[d] &
E \ar[r] \ar[d] &
Q \ar[r] \ar[d] &
0 \\
0 \ar[r] &
H^0(\mathbf{M}) \otimes_R S \ar[r] &
M' \ar[r] &
Q \ar[r] &
0
}
$$
with exact rows. This clearly determines an isomorphism
$\text{Can}(E) \to (M', M_i, \alpha_i, \alpha_{ij})$
in the category $\text{Glue}(R \to S, f_1, \ldots, f_t)$
and we win. (Of course, a posteriori we have $Q = 0$.)
\end{proof}

\noindent
Next, we specialize this very general proposition to get something
more useable. Namely, if $I = (f)$ is a principal ideal then the objects
of $\text{Glue}(R \to S, f)$ are simply triples $(M', M_1, \alpha_1)$
and there is {\it no} cocycle condition to check!

\begin{theorem}
\label{theorem-formal-glueing}
Let $R$ be a ring, and let $f \in R$.
Let $\varphi : R \to S$ be a flat ring map inducing an isomorphism
$R/fR \to S/fS$. Then the functor
$$
\text{Mod}_R
\longrightarrow
\text{Mod}_S \times_{\text{Mod}_{S_f}} \text{Mod}_{R_f},
\quad
M
\longmapsto
(M \otimes_R S, M_f, \text{can})
$$
is an equivalence.
\end{theorem}

\begin{proof}
The category appearing on the right side of the arrow
is the category of triples $(M', M_1, \alpha_1)$ where $M'$ is an
$S$-module, $M_1$ is a $R_f$-module, and
$\alpha_1 : M'_f \to M_1 \otimes_R S$ is a $S_f$-isomorphism, see
Categories, Example \ref{categories-example-2-fibre-product-categories}.
Hence this theorem is a special case of
Proposition \ref{proposition-equivalence}.
\end{proof}

\noindent
A useful special case of
Theorem \ref{theorem-formal-glueing}
is when $R$ is noetherian, and $S$ is a completion of $R$ at an
element $f$. The completion $R \to S$ is flat, and the functor
$M \mapsto M \otimes_R S$ can be identified with the $f$-adic
completion functor when $M$ is finitely generated. To state
this more precisely, let $\text{Mod}_{fg}(R)$ denote the category
of finitely generated $R$-modules.

\begin{proposition}
\label{proposition-formal-glueing}
Let $R$ be a noetherian ring.
Let $f \in R$ be an element.
Let $R^\wedge$ be the $f$-adic completion of $R$.
Then the functor $M \mapsto (M^\wedge, M_f, \text{can})$
defines an equivalence
$$
\text{Mod}_{fg}(R)
\longrightarrow
\text{Mod}_{fg}(R^\wedge)
\times_{\text{Mod}_{fg}(R^\wedge_f)} 
\text{Mod}_{fg}(R_f)
$$
\end{proposition}

\begin{proof}
The ring map $R \to R^\wedge$ is flat by
Algebra, Lemma \ref{algebra-lemma-completion-flat}.
It is clear that $R/fR = R^\wedge/fR^\wedge$.
By
Algebra, Lemma \ref{algebra-lemma-completion-tensor}
the completion of a finite $R$-module $M$ is equal to $M \otimes_R R^\wedge$.
Hence the displayed functor of the proposition is equal to the
functor occuring in
Theorem \ref{theorem-formal-glueing}.
In particular it is fully faithful. Let $(M_1, M_2, \psi)$ be an
object of the right hand side. By
Theorem \ref{theorem-formal-glueing}
there exists an $R$-module $M$ such that
$M_1 = M \otimes_R R^\wedge$ and $M_2 = M_f$. As $R \to R^\wedge \times R_f$
is faithfully flat we conclude from
Algebra, Lemma \ref{algebra-lemma-cover}
that $M$ is finitely generated, i.e., $M \in \text{Mod}_{fg}(R)$.
This proves the proposition.
\end{proof}

\begin{remark}
\label{remark-formal-glueing-algebras}
The equivalences of
Propostion \ref{proposition-equivalence},
Theorem \ref{theorem-formal-glueing}, and
Proposition \ref{proposition-formal-glueing}
preserve the $\otimes$-structures on either side.
Thus, it defines equivalences of various categories
built out of the pair $(\text{Mod}_R,\otimes)$, such as the category of 
$R$-algebras.
\end{remark}

\begin{remark}
\label{remark-topological-analogue}
Given a differential manifold $X$ with a compact closed submanifold $Z$
having complement $U$, specifying a sheaf on $X$ is the same as specifying 
a sheaf on $U$, a sheaf on an unspecified tubular neighbourhood $T$ of $Z$ in 
$X$, and an isomorphism between the two resulting sheaves along $T \cap U$.
Tubular neighbourhoods do not exist in algebraic geometry as such, but
results such as
Propostion \ref{proposition-equivalence},
Theorem \ref{theorem-formal-glueing}, and
Proposition \ref{proposition-formal-glueing}
allow us to work with formal neighbourhoods instead.
\end{remark}



\section{Auto-associated rings}
\label{section-auto-ass}

\noindent
Some of this material is in \cite{Autour}.

\begin{definition}
\label{definition-auto-ass}
A ring $R$ is said to be {\it auto-associated} if $R$ is local and its
maximal ideal $\mathfrak m$ is weakly associated to $R$.
\end{definition}

\begin{lemma}
\label{lemma-auto-ass-implies-P}
An auto-associated ring $R$ has the following property: (P)
Every proper finitely generated ideal $I \subset R$ has a nonzero
annihilator.
\end{lemma}

\begin{proof}
By assumption there exists a nonzero element $x \in R$ such that for every
$f \in \mathfrak m$ we have $f^n x = 0$. Say $I = (f_1, \ldots, f_r)$.
Then $x$ is in the kernel of $R \to \bigoplus R_{f_i}$. Hence we see
that there exists a nonzero $y \in R$ such that $f_i y = 0$ for all $i$, see
Algebra, Lemma \ref{algebra-lemma-when-injective-covering}.
As $y \in \text{Ann}_R(I)$ we win.
\end{proof}

\begin{lemma}
\label{lemma-P-universally-injective}
Let $R$ be a ring having property (P) of
Lemma \ref{lemma-auto-ass-implies-P}.
Let $u : N \to M$ be a homomorphism of projective $R$-modules.
Then $u$ is universally injective if and only if $u$ is injective.
\end{lemma}

\begin{proof}
Assume $u$ is injective. Our goal is to show $u$ is universally injective.
First we choose a module $Q$ such that $N \oplus Q$ is free. On considering
the map $N \oplus Q \to M \oplus Q$ we see that it suffices to prove
the lemma in case $N$ is free. In this case $N$ is a directed colimit of
finite free $R$-modules. Thus we reduce to the case that $N$ is a finite
free $R$-module, say $N = R^{\oplus n}$. We prove the lemma by induction
on $n$. The case $n = 0$ is trivial.

\medskip\noindent
Let $u : R^{\oplus n} \to M$ be an injective module map with $M$ projective.
Choose an $R$-module $Q$ such that $M \oplus Q$ is free. After replacing
$u$ by the composition $R^{\oplus n} \to M \to M \oplus Q$ we see that
we may assume that $M$ is free. Then we can find a direct summand
$R^{\oplus m} \subset M$ such that $u(R^{\oplus n}) \subset R^{\oplus m}$.
Hence we may assume that $M = R^{\oplus m}$.
In this case $u$ is given by a matrix $A = (a_{ij})$ so that
$u(x_1, \ldots, x_n) = (\sum x_i a_{i1}, \ldots, \sum x_i a_{im})$.
As $u$ is injective, in particular
$u(x, 0, \ldots, 0) = (xa_{11}, xa_{12}, \ldots, xa_{1m}) \not = 0$ if
$x \not = 0$, and as $R$ has property (P) we see that
$a_{11}R + a_{12}R + \ldots + a_{1m}R = R$. Hence see that
$R(a_{11}, \ldots, a_{1m}) \subset R^{\oplus m}$ is a direct summand
of $R^{\oplus m}$, in particular $R^{\oplus m}/R(a_{11}, \ldots, a_{1m})$
is a projective $R$-module. We get a commutative diagram
$$
\xymatrix{
0 \ar[r] &
R \ar[rr] \ar[d]^1 & & R^{\oplus n} \ar[r] \ar[d]^u &
R^{\oplus n - 1} \ar[r] \ar[d] & 0 \\
0 \ar[r] & R \ar[rr]^{(a_{11}, \ldots, a_{1m})} & &
R^{\oplus m} \ar[r] & R^{\oplus m}/R(a_{11}, \ldots, a_{1m}) \ar[r] & 0
}
$$
with split exact rows. Thus the right vertical arrow is injective
and we may apply the induction hypothesis to conclude that
the right verical arrow is universally injective. It follows that the
middle vertical arrow is universally injective.
\end{proof}

\begin{lemma}
\label{lemma-P-fPD-zero}
Let $R$ be a ring. The following are equivalent
\begin{enumerate}
\item $R$ has property (P) of
Lemma \ref{lemma-auto-ass-implies-P},
\item any injective map of projective $R$-modules is
universally injective,
\item if $u : N \to M$ is injective and $N$, $M$ are finite projective
$R$-modules then $\text{Coker}(u)$ is a finite projective $R$-module,
\item if $N \subset M$ and $N$, $M$ are finite projective as $R$-modules, then
$N$ is a direct summand of $M$, and
\item any injective map $R \to R^{\oplus n}$ is a split injection.
\end{enumerate}
\end{lemma}

\begin{proof}
The implication (1) $\Rightarrow$ (2) is
Lemma \ref{lemma-P-universally-injective}.
It is clear that (3) and (4) are equivalent.
We have (2) $\Rightarrow$ (3), (4) by
Algebra, Lemma \ref{algebra-lemma-universally-exact-split}.
Part (5) is a special case of (4).
Assume (5). Let $I = (a_1, \ldots, a_n)$ be a proper finitely generated
ideal of $R$. As $I \not = R$ we see that
$R \to R^{\oplus n}$, $x \mapsto (xa_1, \ldots, xa_n)$
is not a split injection. Hence it has a nonzero kernel and we conclude
that $\text{Ann}_R(I) \not = 0$. Thus (1) holds.
\end{proof}

\begin{example}
\label{example-auto-ass-weird-flat}
If the equivalent conditions of
Lemma \ref{lemma-P-fPD-zero}
hold, then it is not always the case that every injective map of
free $R$-modules is a split injection. For example suppose that
$R = k[x_1, x_2, x_3, \ldots]/(x_i^2)$. This is an auto-associated ring.
Consider the map of free $R$-modules
$$
u :
\bigoplus\nolimits_{i \geq 1} Re_i
\longrightarrow
\bigoplus\nolimits_{i \geq 1} Rf_i,\quad
e_i \longmapsto f_i - x_if_{i + 1}.
$$
For any integer $n$ the restriction of $u$ to
$\bigoplus_{i = 1, \ldots, n} Re_i$ is injective as the images
$u(e_1), \ldots, u(e_n)$ are $R$-linearly independent. Hence
$u$ is injective and hence universally injective by the lemma.
Since $u \otimes \text{id}_k$ is bijective we see that if
$u$ were a split injection then $u$ would be surjective. But $u$ is not
surjective because the inverse image of $f_1$ would be the element
$$
\sum\nolimits_{i \geq 0} x_1 \ldots x_ie_{i + 1} =
e_1 + x_1e_2 + x_1x_2e_3 + \ldots
$$
which is not an element of the direct sum. A side remark is that
$\text{Coker}(u)$ is a flat (because $u$ is universally injective),
countably generated $R$-module which is not projective (as $u$ is not
split), hence not Mittag-Leffler (see
Algebra, Lemma \ref{algebra-lemma-countgen-projective}).
\end{example}






\section{Flattening stratification}
\label{section-flattening}

\noindent
Let $R \to S$ be a ring map and let $N$ be an $S$-module.
For any $R$-algebra $R'$ we can consider the base changes
$S' = S \otimes_R R'$ and $M' = M \otimes_R R'$.
We say $R \to R'$ {\it flattens} $M$ if the module $M'$ is flat over $R'$.
We would like to understand the structure of the collection of ring maps
$R \to R'$ which flatten $M$. In particular we would like to know
if there exists a {\it universal flattening $R \to R_{univ}$ of $M$},
i.e., a ring map $R \to R_{univ}$ which flattens $M$ and has the property
that any ring map $R \to R'$ which flattens $M$ factors through
$R \to R_{univ}$. It turns out that such a universal solution usually
does not exist.

\medskip\noindent
We will discuss {\it universal flattenings} and
{\it flattening stratifications} in a scheme theoretic
setting $\mathcal{F}/X/S$ in
More on Flatness, Section \ref{flat-section-flattening}.
If the universal flattening $R \to R_{univ}$ exists then the
morphism of schemes $\text{Spec}(R_{univ}) \to \text{Spec}(R)$ is the
universal flattening of the quasi-coherent module
$\widetilde{M}$ on $\text{Spec}(S)$.

\medskip\noindent
In this and the next few sections we prove some basic algebra facts
related to this. The most basic result is perhaps the following.

\begin{lemma}
\label{lemma-intersection-flat}
Let $R$ be a ring. Let $M$ be an $R$-module. Let $I_1$, $I_2$ be ideals of $R$.
If $M/I_1M$ is flat over $R/I_1$ and $M/I_2M$ is flat over $R/I_2$,
then $M/(I_1 \cap I_2)M$ is flat over $R/(I_1 \cap I_2)$.
\end{lemma}

\begin{proof}
By replacing $R$ with $R/(I_1 \cap I_2)$ and $M$ by $M/(I_1 \cap I_2)M$
we may assume that $I_1 \cap I_2 = 0$. Let $J \subset R$ be an ideal.
To prove that $M$ is flat over $R$ we have to show that
$J \otimes_R M \to M$ is injective, see
Algebra, Lemma \ref{algebra-lemma-flat}.
By flatness of $M/I_1M$ over $R/I_1$ the map
$$
J/(J \cap I_1) \otimes_R M =
(J + I_1)/I_1 \otimes_{R/I_1} M/I_1M
\longrightarrow M/I_1M
$$
is injective. As $0 \to (J \cap I_1) \to J \to J/(J \cap I_1) \to 0$
is exact we obtain a diagram
$$
\xymatrix{
(J \cap I_1) \otimes_R M \ar[r] \ar[d] &
J \otimes_R M \ar[r] \ar[d] &
J/(J \cap I_1) \otimes_R M \ar[r] \ar[d] & 0 \\
M \ar@{=}[r] &
M \ar[r] &
M/I_1M
}
$$
hence it suffices to show that $(J \cap I_1) \otimes_R M \to M$ is
injective. Since $I_1 \cap I_2 = 0$ the ideal $J \cap I_1$
maps isomorphically to an ideal $J' \subset R/I_2$ and we see that
$(J \cap I_1) \otimes_R M = J' \otimes_{R/I_2} M/I_2M$. By flatness
of $M/I_2M$ over $R/I_2$ the map $J' \otimes_{R/I_2} M/I_2M \to M/I_2M$
is injective, which clearly implies that $(J \cap I_1) \otimes_R M \to M$ is
injective.
\end{proof}





\section{Flattening over an Artinian ring}
\label{section-flattening-artinian}

\noindent
A universal flattening exists when the base ring is an Artinian local
ring. It exists for an arbitrary module. Hence, as we will see later,
a flatting stratification exists when the base scheme is the spectrum
of an Artinian local ring.

\begin{lemma}
\label{lemma-flattening-artinian}
Let $R$ be an Artinian ring.
Let $M$ be an $R$-module.
Then there exists a smallest ideal $I \subset R$ such that
$M/IM$ is flat over $R/I$.
\end{lemma}

\begin{proof}
This follows directly from
Lemma \ref{lemma-intersection-flat}
and the Artinian property.
\end{proof}

\noindent
This ideal has the following universal property.

\begin{lemma}
\label{lemma-flattening-artinian-universal-property}
Let $R$ be an Artinian ring. Let $M$ be an $R$-module.
Let $I \subset R$ be the smallest ideal $I \subset R$ such that
$M/IM$ is flat over $R/I$.
Then $I$ has the following universal property:
For every ring map $\varphi : R \to R'$ we have
$$
R' \otimes_R M\text{ is flat over }R'
\Leftrightarrow
\text{we have }\varphi(I) = 0.
$$
\end{lemma}

\begin{proof}
Note that $I$ exists by
Lemma \ref{lemma-flattening-artinian}.
The implication $\Rightarrow$ follows from
Algebra, Lemma \ref{algebra-lemma-flat-base-change}.
Let $\varphi : R \to R'$ be such that $M \otimes_R R'$ is flat over $R'$.
Let $J = \text{Ker}(\varphi)$. By
Algebra,
Lemma \ref{algebra-lemma-descent-flatness-injective-map-artinian-rings}
and as $R' \otimes_R M = R' \otimes_{R/J} M/JM$ is
flat over $R'$ we conclude that $M/JM$ is flat over $R/J$.
Hence $I \subset J$ as desired.
\end{proof}











\section{Flattening over a closed subset of the base}
\label{section-flattening-local-base}

\noindent
Let $R \to S$ be a ring map.
Let $I \subset R$ be an ideal.
Let $M$ be an $S$-module.
In the following we will consider the following condition
\begin{equation}
\label{equation-flat-at-primes-over}
\forall \mathfrak q \in V(IS) \subset \text{Spec}(S) :
M_{\mathfrak q}\text{ is flat over }R.
\end{equation}
Geometrically, this means that $M$ is flat over $R$ along the inverse
image of $V(I)$ in $\text{Spec}(S)$.

\begin{lemma}
\label{lemma-base-change-flat-at-primes-over}
Let $R \to S$ be a ring map.
Let $I \subset R$ be an ideal.
Let $M$ be an $S$-module.
Let $R \to R'$ be a ring map and $IR' \subset I' \subset R'$ an ideal.
If (\ref{equation-flat-at-primes-over}) holds for
$(R \to S, I, M)$, then (\ref{equation-flat-at-primes-over})
holds for $(R' \to S \otimes_R R', I', M \otimes_R R')$.
\end{lemma}

\begin{proof}
Assume (\ref{equation-flat-at-primes-over}) holds for
$(R \to S, I \subset R, M)$.
Let $I'(S \otimes_R R') \subset \mathfrak q'$ be a prime of $S \otimes_R R'$.
Let $\mathfrak q \subset S$ be the corresponding prime of $S$.
Then $IS \subset \mathfrak q$. Note that $(M \otimes_R R')_{\mathfrak q'}$
is a localization of the base change $M_{\mathfrak q} \otimes_R R'$.
Hence $(M \otimes_R R')_{\mathfrak q'}$ is flat over $R'$ as a localization
of a flat module, see
Algebra, Lemmas \ref{algebra-lemma-flat-base-change} and
\ref{algebra-lemma-flat-localization}.
\end{proof}

\begin{lemma}
\label{lemma-flat-descent-flat-at-primes-over}
Let $R \to S$ be a ring map.
Let $I \subset R$ be an ideal.
Let $M$ be an $S$-module.
Let $R \to R'$ be a ring map and $IR' \subset I' \subset R'$ an ideal
such that
\begin{enumerate}
\item the map $V(I') \to V(I)$ induced by
$\text{Spec}(R') \to \text{Spec}(R)$ is surjective, and
\item $R'_{\mathfrak p'}$ is flat over $R$ for all primes
$\mathfrak p' \in V(I')$.
\end{enumerate}
If (\ref{equation-flat-at-primes-over}) holds for
$(R' \to S \otimes_R R', I', M \otimes_R R')$, then
(\ref{equation-flat-at-primes-over}) holds for $(R \to S, I, M)$.
\end{lemma}

\begin{proof}
Assume (\ref{equation-flat-at-primes-over}) holds for
$(R' \to S \otimes_R R', IR', M \otimes_R R')$. Pick a prime
$IS \subset \mathfrak q \subset S$. Let $I \subset \mathfrak p \subset R$
be the corresponding prime of $R$. By assumption there exists
a prime $\mathfrak p' \in V(I')$ of $R'$ lying over $\mathfrak p$ and
$R_{\mathfrak p} \to R'_{\mathfrak p'}$ is flat. Choose a prime
$\overline{\mathfrak q}' \subset
\kappa(\mathfrak q) \otimes_{\kappa(\mathfrak p)} \kappa(\mathfrak p')$
which corresponds to a prime $\mathfrak q' \subset S \otimes_R R'$ which
lies over $\mathfrak q$ and over $\mathfrak p'$. Note that
$(S \otimes_R R')_{\mathfrak q'}$ is a localization of
$S_{\mathfrak q} \otimes_{R_{\mathfrak p}} R'_{\mathfrak p'}$.
By assumption the module $(M \otimes_R R')_{\mathfrak q'}$ is
flat over $R'_{\mathfrak p'}$. Hence
Algebra, Lemma \ref{algebra-lemma-base-change-flat-up-down}
implies that $M_{\mathfrak q}$ is flat over $R_{\mathfrak p}$
which is what we wanted to prove.
\end{proof}

\begin{lemma}
\label{lemma-limit-preserving-flat-at-primes-over}
Let $R \to S$ be a ring map of finite presentation.
Let $M$ be an $S$-module of finite presentation.
Let $R' = \text{colim}_{\lambda \in \Lambda} R_\lambda$
be a directed colimit of $R$-algebras. Let $I_\lambda \subset R_\lambda$
be ideals such that $I_\lambda R_\mu \subset I_\mu$ for all $\mu \geq \lambda$
and set $I' = \text{colim}_\lambda\ I_\lambda$.
If (\ref{equation-flat-at-primes-over}) holds for
$(R' \to S \otimes_R R', I', M \otimes_R R')$, then there exists
a $\lambda \in \Lambda$ such that
(\ref{equation-flat-at-primes-over}) holds for
$(R_\lambda \to S \otimes_R R_\lambda, I_\lambda, M \otimes_R R_\lambda)$.
\end{lemma}

\begin{proof}
We are going to write $S_\lambda = S \otimes_R R_\lambda$,
$S' = S \otimes_R R'$, $M_\lambda = M \otimes_R R_\lambda$, and
$M' = M \otimes_R R'$.
The base change $S'$ is of finite presentation over $R'$ and
$M'$ is of finite presentation over $S'$ and similarly for the
versions with subscript $\lambda$, see
Algebra, Lemma \ref{algebra-lemma-base-change-finiteness}.
By
Algebra, Theorem \ref{algebra-theorem-openess-flatness}
the set
$$
U' = \{\mathfrak q' \in \text{Spec}(S') \mid
M'_{\mathfrak q'}\text{ is flat over }R'\}
$$
is open in $\text{Spec}(S')$. Note that $V(I'S')$ is a quasi-compact space
which is contained in $U'$ by assumption. Hence there exist finitely many
$g'_j \in S'$, $j = 1, \ldots, m$ such that $D(g'_j) \subset U'$ and such
that $V(I'S') \subset \bigcup D(g'_j)$.
Note that in particular $(M')_{g'_j}$ is a flat module over $R'$.

\medskip\noindent
We are going to pick increasingly large elements $\lambda \in \Lambda$.
First we pick it large enough so that we can find
$g_{j, \lambda} \in S_{\lambda}$ mapping to $g'_j$.
The inclusion $V(I'S') \subset \bigcup D(g'_j)$ means that
$I'S' + (g'_1, \ldots, g'_m) = S'$ which can be expressed as
$1 = \sum z_sh_s + \sum f_jg'_j$ for some $z_s \in I'$, $h_s, f_j \in S'$.
After increasing $\lambda$ we may assume such an equation holds in
$S_\lambda$. Hence we may assume that
$V(I_\lambda S_\lambda) \subset \bigcup D(g_{j, \lambda})$. By
Algebra, Lemma \ref{algebra-lemma-flat-finite-presentation-limit-flat}
we see that for some sufficiently large $\lambda$ the modules
$(M_\lambda)_{g_{j, \lambda}}$ are flat over $R_\lambda$.
In particular the module $M_\lambda$ is flat over $R_\lambda$
at all the primes lying over the ideal $I_\lambda$.
\end{proof}

\begin{lemma}
\label{lemma-flat-module-powers}
Let $R \to S$ be a ring map. Let $I \subset R$ be an ideal.
Let $M$ be an $S$-module. Assume
\begin{enumerate}
\item $R$ is a Noetherian ring,
\item $S$ is a Noetherian ring,
\item $M$ is a finite $S$-module, and
\item for each $n \geq 1$ the module $M/I^n M$ is flat over
$R/I^n$.
\end{enumerate}
Then (\ref{equation-flat-at-primes-over}) holds, i.e.,
for every $\mathfrak q \in V(IS)$
the localization $M_{\mathfrak q}$ is flat over $R$.
\end{lemma}

\begin{proof}
We are going to use
Algebra, Lemma \ref{algebra-lemma-variant-local-criterion-flatness}.
By assumption $M/IM$ is flat over $R/I$. Hence it suffices to check
that $\text{Tor}_1^R(M, R/I)$ is zero on localization at $\mathfrak q$. By
Algebra, Remark \ref{algebra-remark-Tor-ring-mod-ideal}
this Tor group is equal to $K = \text{Ker}(I \otimes_R M \to M)$.
We know for each $n \geq 1$ that the kernel
$\text{Ker}(I/I^n \otimes_{R/I^n} M/I^nM \to M/I^nM)$ is zero.
Since there is a module map
$I/I^n \otimes_{R/I^n} M/I^nM \to (I \otimes_R M)/I^{n - 1}(I \otimes_R M)$
we conclude that $K \subset I^{n - 1}(I \otimes_R M)$ for each $n$.
By the Artin-Rees lemma, and more precisely
Algebra, Lemma \ref{algebra-lemma-intersection-powers-ideal-module}
we conclude that $K_{\mathfrak q} = 0$, as desired.
\end{proof}









\section{Flattening over a closed subsets of source and base}
\label{section-flattening-local-source-base}

\noindent
In this section we slightly generalize the discussion in
Section \ref{section-flattening-local-base}.
We strongly suggest the reader first read and understand
that section.

\begin{situation}
\label{situation-flattening-general}
Let $R \to S$ be a ring map. Let $J \subset S$ be an ideal.
Let $M$ be an $S$-module.
\end{situation}

\noindent
In this situation, given an $R$-algebra $R'$ and an ideal $I' \subset R'$
we set $S' = S \otimes_R R'$ and $M' = M \otimes_R R'$.
We will consider the condition
\begin{equation}
\label{equation-flat-at-primes}
\forall \mathfrak q' \in V(I'S' + JS') \subset \text{Spec}(S') :
M'_{\mathfrak q'}\text{ is flat over }R'.
\end{equation}
Geometrically, this means that $M'$ is flat over $R'$ along the intersection
of the inverse image of $V(I')$ with the inverse image of $V(J)$.
Since $(R \to S, J, M)$ are fixed, condition (\ref{equation-flat-at-primes})
only depends on the pair $(R', I')$ where $R'$ is viewed as an $R$-algebra.

\begin{lemma}
\label{lemma-base-change-flat-at-primes}
In Situation \ref{situation-flattening-general}
let $R' \to R''$ be an $R$-algebra map.
Let $I' \subset R'$ and $I'R'' \subset I'' \subset R''$ be ideals.
If (\ref{equation-flat-at-primes}) holds for
$(R', I')$, then (\ref{equation-flat-at-primes})
holds for $(R'', I'')$.
\end{lemma}

\begin{proof}
Assume (\ref{equation-flat-at-primes}) holds for $(R', I')$.
Let $I''S'' + JS'' \subset \mathfrak q''$ be a prime of $S''$.
Let $\mathfrak q' \subset S'$ be the corresponding prime of $S'$.
Then both $I'S' \subset \mathfrak q'$ and $JS' \subset \mathfrak q'$
because the corresponding conditions hold for $\mathfrak q''$.
Note that $(M'')_{\mathfrak q''}$
is a localization of the base change $M'_{\mathfrak q'} \otimes_R R''$.
Hence $(M'')_{\mathfrak q''}$ is flat over $R''$ as a localization
of a flat module, see
Algebra, Lemmas \ref{algebra-lemma-flat-base-change} and
\ref{algebra-lemma-flat-localization}.
\end{proof}

\begin{lemma}
\label{lemma-flat-descent-flat-at-primes}
In Situation \ref{situation-flattening-general}
let $R' \to R''$ be an $R$-algebra map.
Let $I' \subset R'$ and $I'R'' \subset I'' \subset R''$ be ideals.
Assume
\begin{enumerate}
\item the map $V(I'') \to V(I')$ induced by
$\text{Spec}(R'') \to \text{Spec}(R')$ is surjective, and
\item $R''_{\mathfrak p''}$ is flat over $R'$ for all primes
$\mathfrak p'' \in V(I'')$.
\end{enumerate}
If (\ref{equation-flat-at-primes}) holds for
$(R'', I'')$, then (\ref{equation-flat-at-primes}) holds for $(R', I')$.
\end{lemma}

\begin{proof}
Assume (\ref{equation-flat-at-primes}) holds for $(R'', I'')$. Pick a prime
$I'S' + JS' \subset \mathfrak q' \subset S'$. Let
$I' \subset \mathfrak p' \subset R'$ be the corresponding prime of $R'$.
By assumption there exists a prime $\mathfrak p'' \in V(I'')$ of $R''$
lying over $\mathfrak p'$ and $R'_{\mathfrak p'} \to R''_{\mathfrak p''}$
is flat. Choose a prime
$\overline{\mathfrak q}'' \subset
\kappa(\mathfrak q') \otimes_{\kappa(\mathfrak p')} \kappa(\mathfrak p'')$.
This corresponds to a prime $\mathfrak q'' \subset S'' = S' \otimes_{R'} R''$
which lies over $\mathfrak q'$ and over $\mathfrak p''$. In particular
we see that $I''S'' \subset \mathfrak q''$ and that
$JS'' \subset \mathfrak q''$. Note that
$(S' \otimes_{R'} R'')_{\mathfrak q''}$ is a localization of
$S'_{\mathfrak q'} \otimes_{R'_{\mathfrak p'}} R''_{\mathfrak p''}$.
By assumption the module $(M' \otimes_{R'} R'')_{\mathfrak q''}$ is
flat over $R''_{\mathfrak p''}$. Hence
Algebra, Lemma \ref{algebra-lemma-base-change-flat-up-down}
implies that $M'_{\mathfrak q'}$ is flat over $R'_{\mathfrak p'}$
which is what we wanted to prove.
\end{proof}

\begin{lemma}
\label{lemma-limit-preserving-flat-at-primes}
In Situation \ref{situation-flattening-general}
assume $R \to S$ is essentially of finite presentation
and $M$ is an $S$-module of finite presentation. Let
$R' = \text{colim}_{\lambda \in \Lambda} R_\lambda$
be a directed colimit of $R$-algebras. Let $I_\lambda \subset R_\lambda$
be ideals such that $I_\lambda R_\mu \subset I_\mu$ for all
$\mu \geq \lambda$ and set $I' = \text{colim}_\lambda\ I_\lambda$.
If (\ref{equation-flat-at-primes}) holds for
$(R', I')$, then there exists a $\lambda \in \Lambda$ such that
(\ref{equation-flat-at-primes}) holds for $(R_\lambda, I_\lambda)$.
\end{lemma}

\begin{proof}
We first prove the lemma in case $R \to S$ is of finite presentation
and then we explain what needs to be changed in the general case.
We are going to write $S_\lambda = S \otimes_R R_\lambda$,
$S' = S \otimes_R R'$, $M_\lambda = M \otimes_R R_\lambda$, and
$M' = M \otimes_R R'$.
The base change $S'$ is of finite presentation over $R'$ and
$M'$ is of finite presentation over $S'$ and similarly for the
versions with subscript $\lambda$, see
Algebra, Lemma \ref{algebra-lemma-base-change-finiteness}.
By
Algebra, Theorem \ref{algebra-theorem-openess-flatness}
the set
$$
U' = \{\mathfrak q' \in \text{Spec}(S') \mid
M'_{\mathfrak q'}\text{ is flat over }R'\}
$$
is open in $\text{Spec}(S')$. Note that $V(I'S' + JS')$
is a quasi-compact space which is contained in $U'$ by assumption.
Hence there exist finitely many $g'_j \in S'$, $j = 1, \ldots, m$
such that $D(g'_j) \subset U'$ and such
that $V(I'S' + JS') \subset \bigcup D(g'_j)$.
Note that in particular $(M')_{g'_j}$ is a flat module over $R'$.

\medskip\noindent
We are going to pick increasingly large elements $\lambda \in \Lambda$.
First we pick it large enough so that we can find
$g_{j, \lambda} \in S_{\lambda}$ mapping to $g'_j$.
The inclusion $V(I'S' + JS') \subset \bigcup D(g'_j)$ means that
$I'S' + JS' + (g'_1, \ldots, g'_m) = S'$ which can be expressed as
$$
1 = \sum y_tk_t + \sum z_sh_s + \sum f_jg'_j
$$
for some $z_s \in I'$, $y_t \in J$, $k_t, h_s, f_j \in S'$.
After increasing $\lambda$ we may assume such an equation holds in
$S_\lambda$. Hence we may assume that
$V(I_\lambda S_\lambda + J S_\lambda) \subset \bigcup D(g_{j, \lambda})$. By
Algebra, Lemma \ref{algebra-lemma-flat-finite-presentation-limit-flat}
we see that for some sufficiently large $\lambda$ the modules
$(M_\lambda)_{g_{j, \lambda}}$ are flat over $R_\lambda$.
In particular the module $M_\lambda$ is flat over $R_\lambda$
at all the primes corresponding to points of
$V(I_\lambda S_\lambda + J S_\lambda)$.

\medskip\noindent
In the case that $S$ is essentially of finite presentation, we can write
$S = \Sigma^{-1}C$ where $R \to C$ is of finite presentation and
$\Sigma \subset C$ is a multiplicative subset. We can also write
$M = \Sigma^{-1}N$ for some finitely presented $C$-module $N$, see
Algebra, Lemma \ref{algebra-lemma-construct-fp-module}.
At this point we introduce $C_\lambda$, $C'$, $N_\lambda$, $N'$. Then in
the discussion above we obtain an open $U' \subset \text{Spec}(C')$
over which $N'$ is flat over $R'$. The assumption that
(\ref{equation-flat-at-primes}) is true means that $V(I'S' + JS')$ maps
into $U'$, because for a prime $\mathfrak q' \subset S'$, corresponding
to a prime $\mathfrak r' \subset C'$ we have
$M'_{\mathfrak q'} = N'_{\mathfrak r'}$. Thus we can find
$g'_j \in C'$ such that $\bigcup D(g'_j)$ contains the image of
$V(I'S' + JS')$. The rest of the proof is exactly the same as before.
\end{proof}

\begin{lemma}
\label{lemma-flat-module-powers-variant}
In Situation \ref{situation-flattening-general}.
Let $I \subset R$ be an ideal. Assume
\begin{enumerate}
\item $R$ is a Noetherian ring,
\item $S$ is a Noetherian ring,
\item $M$ is a finite $S$-module, and
\item for each $n \geq 1$ and any prime
$\mathfrak q \in V(J + IS)$ the module $(M/I^n M)_{\mathfrak q}$
is flat over $R/I^n$.
\end{enumerate}
Then (\ref{equation-flat-at-primes}) holds for $(R, I)$, i.e.,
for every prime $\mathfrak q \in V(J + IS)$
the localization $M_{\mathfrak q}$ is flat over $R$.
\end{lemma}

\begin{proof}
Let $\mathfrak q \in V(J + IS)$. Then
Lemma \ref{lemma-flat-module-powers}
applied to $R \to S_{\mathfrak q}$ and $M_{\mathfrak q}$
implies that $M_{\mathfrak q}$ is flat over $R$.
\end{proof}










\section{Flattening over a Noetherian complete local ring}
\label{section-flattening-Noetherian-complete-local}

\noindent
The following three lemmas give a completely algebraic proof of the existence
of the ``local'' flattening stratification when the base is a complete
local Noetherian ring $R$ and the given module is finite over a finite
type $R$-algebra $S$.

\begin{lemma}
\label{lemma-flattening-complete-local-noetherian}
Let $R \to S$ be a ring map.
Let $M$ be an $S$-module.
Assume
\begin{enumerate}
\item $(R, \mathfrak m)$ is a complete local Noetherian ring,
\item $S$ is a Noetherian ring, and
\item $M$ is finite over $S$.
\end{enumerate}
Then there exists an ideal $I \subset \mathfrak m$ such that
\begin{enumerate}
\item $(M/IM)_{\mathfrak q}$ is flat over $R/I$ for all
primes $\mathfrak q$ of $S/IS$ lying over $\mathfrak m$, and
\item if $J \subset R$ is an ideal such that $(M/JM)_{\mathfrak q}$
is flat over $R/J$ for all primes $\mathfrak q$ lying over
$\mathfrak m$, then $I \subset J$.
\end{enumerate}
In other words, $I$ is the smallest ideal of $R$ such that
(\ref{equation-flat-at-primes-over}) holds for
$(\overline{R} \to \overline{S}, \overline{\mathfrak m}, \overline{M})$
where $\overline{R} = R/I$, $\overline{S} = S/IS$,
$\overline{\mathfrak m} = \mathfrak m/I$ and $\overline{M} = M/IM$.
\end{lemma}

\begin{proof}
Let $J \subset R$ be an ideal. Apply
Lemma \ref{lemma-flat-module-powers}
to the module $M/JM$ over the ring $R/J$.
Then we see that $(M/JM)_{\mathfrak q}$
is flat over $R/J$ for all primes $\mathfrak q$ of $S/JS$
if and only if $M/(J + \mathfrak m^n)M$ is flat over
$R/(J + \mathfrak m^n)$ for all $n \geq 1$.
We will use this remark below.

\medskip\noindent
For every $n \geq 1$ the local ring $R/\mathfrak m^n$ is Artinian.
Hence, by
Lemma \ref{lemma-flattening-artinian}
there exists a smallest ideal $I_n \supset \mathfrak m^n$ such that
$M/I_nM$ is flat over $R/I_n$. It is clear that $I_{n + 1} + \mathfrak m^n$
is contains $I_n$ and applying
Lemma \ref{lemma-intersection-flat}
we see that $I_n = I_{n + 1} + \mathfrak m^n$. Since
$R = \lim_n\ R/\mathfrak m^n$ we see that $I = \lim_n\ I_n/\mathfrak m^n$
is an ideal in $R$ such that $I_n = I + \mathfrak m^n$ for all $n \geq 1$.
By the initial remarks of the proof we see that $I$ verifies (1)
and (2). Some details omitted.
\end{proof}

\begin{lemma}
\label{lemma-flattening-complete-local-noetherian-property-by-finite-type}
With notation $R \to S$, $M$, and $I$ and assumptions as in
Lemma \ref{lemma-flattening-complete-local-noetherian}.
Consider a local homomorphism of local rings
$\varphi : (R, \mathfrak m) \to (R', \mathfrak m')$
such that $R'$ is Noetherian. Then the following are equivalent
\begin{enumerate}
\item condition (\ref{equation-flat-at-primes-over}) holds
for $(R' \to S \otimes_R R', \mathfrak m', M \otimes_R R')$, and
\item $\varphi(I) = 0$.
\end{enumerate}
\end{lemma}

\begin{proof}
The implication (2) $\Rightarrow$ (1) follows from
Lemma \ref{lemma-base-change-flat-at-primes-over}.
Let $\varphi : R \to R'$ be as in the lemma satisfying (1).
We have to show that $\varphi(I) = 0$.
This is equivalent to the condition that $\varphi(I)R' = 0$.
By Artin-Rees in the Noetherian local ring $R'$ (see
Algebra, Lemma \ref{algebra-lemma-intersect-powers-ideal-module-zero})
this is equivalent to the condition that
$\varphi(I)R' + (\mathfrak m')^n = (\mathfrak m')^n$ for all $n > 0$.
Hence this is equivalent to the condition that the composition
$\varphi_n : R \to R' \to R'/(\mathfrak m')^n$ annihilates $I$ for each $n$.
Now assumption (1) for $\varphi$ implies assumption (1) for
$\varphi_n$ by
Lemma \ref{lemma-base-change-flat-at-primes-over}.
This reduces us to the case where $R'$ is Artinian local.

\medskip\noindent
Assume $R'$ Artinian. Let $J = \text{Ker}(\varphi)$. We have to show that
$I \subset J$. By the construction of $I$ in
Lemma \ref{lemma-flattening-complete-local-noetherian}
it suffices to show that $(M/JM)_{\mathfrak q}$ is flat over $R/J$
for every prime $\mathfrak q$ of $S/JS$ lying over $\mathfrak m$.
As $R'$ is Artinian, condition (1) signifies that $M \otimes_R R'$
is flat over $R'$. As $R'$ is Artinian and $R/J \to R'$ is a local
injective ring map, it follows that $R/J$ is Artinian
too. Hence the flatness of $M \otimes_R R' = M/JM \otimes_{R/J} R'$ over
$R'$ implies that $M/JM$ is flat over $R/J$ by
Algebra,
Lemma \ref{algebra-lemma-descent-flatness-injective-map-artinian-rings}.
This concludes the proof.
\end{proof}

\begin{lemma}
\label{lemma-flattening-complete-local-universal-property}
With notation $R \to S$, $M$, and $I$ and assumptions as in
Lemma \ref{lemma-flattening-complete-local-noetherian}.
In addition assume that $R \to S$ is of finite type.
Then for any local homomorphism of local rings
$\varphi : (R, \mathfrak m) \to (R', \mathfrak m')$
the following are equivalent
\begin{enumerate}
\item condition (\ref{equation-flat-at-primes-over}) holds
for $(R' \to S \otimes_R R', \mathfrak m', M \otimes_R R')$, and
\item $\varphi(I) = 0$.
\end{enumerate}
\end{lemma}

\begin{proof}
The implication (2) $\Rightarrow$ (1) follows from
Lemma \ref{lemma-base-change-flat-at-primes-over}.
Let $\varphi : R \to R'$ be as in the lemma satisfying (1).
As $R$ is Noetherian we see that $R \to S$ is of finite presentation
and $M$ is an $S$-module of finite presentation.
Write $R' = \text{colim}_\lambda\ R_\lambda$
as a directed colimit of local $R$-subalgebras $R_\lambda \subset R'$,
with maximal ideals $\mathfrak m_\lambda = R_\lambda \cap \mathfrak m'$
such that each $R_\lambda$ is essentially of finite type over $R$. By
Lemma \ref{lemma-limit-preserving-flat-at-primes-over}
we see that condition (\ref{equation-flat-at-primes-over}) holds for
$(R_\lambda \to S \otimes_R R_\lambda, \mathfrak m_\lambda,
M \otimes_R R_\lambda)$ for some $\lambda$. Hence
Lemma \ref{lemma-flattening-complete-local-noetherian-property-by-finite-type}
applies to the ring map $R \to R_\lambda$ and we see that
$I$ maps to zero in $R_\lambda$, a fortiori it maps to zero in $R'$.
\end{proof}




\section{Descent flatness along integral maps}
\label{section-descent-flatness-integral}

\noindent
First a few simple lemmas.

\begin{lemma}
\label{lemma-have-one-root}
Let $R$ be a ring. Let $P(T)$ be a monic polynomial with coefficients
in $R$. If there exists an $\alpha \in R$ such that $P(\alpha) = 0$, then
$P(T) = (T - \alpha)Q(T)$ for some monic polynomial $Q(T) \in R[T]$.
\end{lemma}

\begin{proof}
By induction on the degree of $P$. If $\deg(P) = 1$, then
$P(T) = T - \alpha$ and the result is true. If $\deg(P) > 1$, then
we can write $P(T) = (T - \alpha)Q(T) + r$ for some polynomial
$Q \in R[T]$ of degree $< \deg(P)$ and some $r \in R$ by long
division. By assumption $0 = P(\alpha) = (\alpha - \alpha)Q(\alpha) + r = r$
and we conclude that $r = 0$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-adjoin-one-root}
Let $R$ be a ring. Let $P(T)$ be a monic polynomial with coefficients
in $R$. There exists a finite free ring map $R \to R'$ such that
$P(T) = (T - \alpha)Q(T)$ for some $\alpha \in R'$ and some
monic polynomial $Q(T) \in R'[T]$.
\end{lemma}

\begin{proof}
Write $P(T) = T^d + a_1T^{d - 1} + \ldots + a_0$.
Set $R' = R[x]/(x^d + a_1x^{d - 1} + \ldots + a_0)$.
Set $\alpha$ equal to the congruence class of $x$.
Then it is clear that $P(\alpha) = 0$. Thus we win by
Lemma \ref{lemma-have-one-root}.
\end{proof}

\begin{lemma}
\label{lemma-finite-split}
Let $R \to S$ be a finite ring map.
There exists a finite free ring extension $R \subset R'$ such
that $S \otimes_R R'$ is a quotient of a ring of the form
$$
R'[T_1, \ldots, T_n]/(P_1(T_1), \ldots, P_n(T_n))
$$
with $P_i(T) = \prod_{j = 1, \ldots, d_i} (T - \alpha_{ij})$ for some
$\alpha_{ij} \in R'$.
\end{lemma}

\begin{proof}
Let $x_1, \ldots, x_n \in S$ be generators of $S$ over $R$.
For each $i$ we can choose a monic polynomial $P_i(T) \in R[T]$
such that $P(x_i) = 0$ in $S$, see
Algebra, Lemma \ref{algebra-lemma-finite-is-integral}.
Say $\deg(P_i) = d_i$. By
Lemma \ref{lemma-adjoin-one-root}
(applied $\sum d_i$ times) there exists a finite free ring
extension $R \subset R'$ such that each $P_i$ splits completely:
$$
P_i(T) = \prod\nolimits_{j = 1, \ldots, d_i} (T - \alpha_{ij})
$$
for certain $\alpha_{ik} \in R'$. Let
$R'[T_1, \ldots, T_n] \to S \otimes_R R'$ be the $R'$-algebra map
which maps $T_i$ to $x_i \otimes 1$. As this maps $P_i(T_i)$ to zero,
this induces the desired surjection.
\end{proof}

\begin{lemma}
\label{lemma-split-image}
Let $R$ be a ring.
Let $S = R[T_1, \ldots, T_n]/J$.
Assume $J$ contains elements of the form $P_i(T_i)$
with $P_i(T) = \prod_{j = 1, \ldots, d_i} (T - \alpha_{ij})$ for some
$\alpha_{ij} \in R$. For $\underline{k} = (k_1, \ldots, k_n)$
with $1 \leq k_i \leq d_i$ consider the ring map
$$
\Phi_{\underline{k}} : R[T_1, \ldots, T_n] \to R,
\quad
T_i \longmapsto \alpha_{ik_i}
$$
Set $J_{\underline{k}} = \Phi_{\underline{k}}(J)$.
Then the image of $\text{Spec}(S) \to \text{Spec}(R)$ is equal to
$V(\bigcap J_{\underline{k}})$.
\end{lemma}

\begin{proof}
This lemma proves itself. Hint:
$V(\bigcap J_{\underline{k}}) = \bigcup V(J_{\underline{k}})$.
\end{proof}

\noindent
The following result is due to Ferrand, see \cite{Ferrand}.

\begin{lemma}
\label{lemma-descent-flatness-injective-finite-Noetherian-rings}
Let $R \to S$ be a finite injective homomorphism of Noetherian rings.
Let $M$ be an $R$-module. If $M \otimes_R S$ is a flat $S$-module,
then $M$ is a flat $R$-module.
\end{lemma}

\begin{proof}
Let $M$ be an $R$-module such that $M \otimes_R S$ is flat over $S$. By
Algebra, Lemma \ref{algebra-lemma-flatness-descends}
in order to prove that $M$ is flat we may replace $R$ by any faithfully flat
ring extension. By
Lemma \ref{lemma-finite-split}
we can find a finite locally free ring extension $R \subset R'$ such
that $S' = S \otimes_R R' = R'[T_1, \ldots, T_n]/J$ for some ideal
$J \subset R'[T_1, \ldots, T_n]$ which contains the  elements of the form
$P_i(T_i)$ with $P_i(T) = \prod_{j = 1, \ldots, d_i} (T - \alpha_{ij})$
for some $\alpha_{ij} \in R'$. Note that $R'$ is Noetherian
and that $R' \subset S'$ is a finite extension of rings. Hence we may
replace $R$ by $R'$ and assume that $S$ has a presentation as in
Lemma \ref{lemma-split-image}.
Note that $\text{Spec}(S) \to \text{Spec}(R)$ is surjective, see
Algebra, Lemma \ref{algebra-lemma-integral-overring-surjective}.
Thus, using
Lemma \ref{lemma-split-image}
we conclude that $I = \bigcap J_{\underline{k}}$ is an ideal
such that $V(I) = \text{Spec}(R)$. This means that
$I \subset \sqrt{(0)}$, and since $R$ is Noetherian that $I$
is nilpotent. The maps $\Phi_{\underline{k}}$ induce commutative
diagrams
$$
\xymatrix{
S \ar[rr] & & R/J_{\underline{k}} \\
& R \ar[lu] \ar[ru]
}
$$
from which we conclude that $M/J_{\underline{k}}M$ is flat over
$R/J_{\underline{k}}$. By
Lemma \ref{lemma-intersection-flat}
we see that $M/IM$ is flat over $R/I$. Finally, applying
Algebra, Lemma \ref{algebra-lemma-lift-flatness}
we conclude that $M$ is flat over $R$.
\end{proof}

\begin{lemma}
\label{lemma-descent-flatness-injective-integral}
Let $R \to S$ be an injective integral ring map.
Let $M$ be a finitely presented module over $R[x_1, \ldots, x_n]$.
If $M \otimes_R S$ is flat over $S$, then $M$ is flat over $R$.
\end{lemma}

\begin{proof}
Choose a presentation
$$
R[x_1, \ldots, x_n]^{\oplus t} \to R[x_1, \ldots, x_n]^{\oplus r} \to M \to 0.
$$
Let's say that the first map is given by the $r \times t$-matrix
$T = (f_{ij})$ with $f_{ij} \in R[x_1, \ldots, x_n]$. Write
$f_{ij} = \sum f_{ij, I} x^I$ with $f_{ij, I} \in R$ (multi-index notation).
Consider diagrams
$$
\xymatrix{
R \ar[r] & S \\
R_\lambda \ar[u] \ar[r] & S_\lambda \ar[u]
}
$$
where $R_\lambda$ is a finitely generated $\mathbf{Z}$-subalgebra of
$R$ containing all $f_{ij, I}$ and $S_\lambda$ is a finite
$R_\lambda$-subalgebra of $S$. Let $M_\lambda$ be the finite
$R_\lambda[x_1, \ldots, x_n]$-module defined by a presentation
as above, using the same matrix $T$ but now viewed as a matrix
over $R_\lambda[x_1, \ldots, x_n]$. Note that $S$ is the directed colimit
of the $S_\lambda$ (details omitted). By
Algebra, Lemma \ref{algebra-lemma-flat-finite-presentation-limit-flat}
we see that for some $\lambda$ the module
$M_\lambda \otimes_{R_\lambda} S_\lambda$ is flat over $S_\lambda$. By
Lemma \ref{lemma-descent-flatness-injective-finite-Noetherian-rings}
we conclude that $M_\lambda$ is flat over $R_\lambda$. Since
$M = M_\lambda \otimes_{R_\lambda} R$ we win by
Algebra, Lemma \ref{algebra-lemma-flat-base-change}.
\end{proof}




\section{Torsion and flatness}
\label{section-torsion-flat}

\noindent
In this section we discuss the relationship between torsion and flatness.

\begin{definition}
\label{definition-torsion}
Let $R$ be a domain. Let $M$ be an $R$-module.
\begin{enumerate}
\item We say an element $x \in M$ is {\it torsion} if there exists
a nonzero $f \in R$ such that $fx = 0$.
\item We say $M$ is {\it torsion free} if the only torsion element of $M$
is $0$.
\end{enumerate}
\end{definition}

\begin{lemma}
\label{lemma-torsion}
Let $R$ be a domain. Let $M$ be an $R$-module.
The set of torsion elements of $M$ forms a submodule $M_{tors} \subset M$.
The quotient module $M/M_{tors}$ is torsion free.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-flat-torsion-free}
Let $R$ be a domain. Any flat $R$-module is torsion free.
\end{lemma}

\begin{proof}
If $x \in R$ is nonzero, then $x : R \to R$ is injective, and hence if $M$
is flat over $R$, then $x : M \to M$ is injective. Thus if $M$ is flat over
$R$, then $M$ is torsion free.
\end{proof}

\begin{lemma}
\label{lemma-valuation-ring-torsion-free-flat}
Let $A$ be a valuation ring.
An $A$-module $M$ is flat over $A$ if and only if $M$ is torsion free.
\end{lemma}

\begin{proof}
The implication ``flat $\Rightarrow$ torsion free'' is
Lemma \ref{lemma-flat-torsion-free}.
For the converse, assume $M$ is torsion free.
By the equational criterion of flatness (see
Algebra, Lemma \ref{algebra-lemma-flat-eq})
we have to show that every relation in $M$ is trivial. To do this assume that
$\sum_{i = 1, \ldots, n} a_i x_i = 0$ with $x_i \in M$ and $f_i \in A$.
After renumbering we may assume that $v(a_1) \leq v(a_i)$ for all $i$.
Hence we can write $a_i = a'_i a_1$ for some $a'_i \in A$. Note that
$a'_1 = 1$. As $A$ is torsion free we see that
$x_1 = - \sum_{i \geq 2} a'_i x_i$. Thus, if we choose
$y_i = x_i$, $i = 2, \ldots, n$ then
$$
x_1 = \sum\nolimits_{j \geq 2} -a'_j y_j,\quad
x_i = y_i, (i \geq 2)\quad
0 = a_1 \cdot (-a'_j) + a_j \cdot 1 (j \geq 2)
$$
shows that the relation was trivial (to be explicit the elements
$a_{ij}$ are defined by setting $a_{1j} = -a'_j$ and $a_{ij} = \delta_{ij}$
for $i, j \geq 2$).
\end{proof}






\section{Flatness and finiteness conditions}
\label{section-flat-finite}

\noindent
In this section we discuss some implications of the type
``flat $+$ finite type $\Rightarrow$ finite presentation''.
We will revisit this result in the chapter on flatness, see
More on Flatness, Section \ref{flat-section-introduction}.
A first result of this type was proved in
Algebra, Lemma \ref{algebra-lemma-finite-flat-module-finitely-presented}.

\begin{lemma}
\label{lemma-flat-finite-type-finite-presentation-local-module}
Let $R$ be a ring. Let $S = R[x_1, \ldots, x_n]$ be a polynomial
ring over $R$. Let $M$ be an $S$-module.
Assume
\begin{enumerate}
\item there exist finitely many primes $\mathfrak p_1, \ldots, \mathfrak p_m$
of $R$ such that the map $R \to \prod R_{\mathfrak p_j}$ is injective,
\item $M$ is a finite $S$-module,
\item $M$ flat over $R$, and
\item for every prime $\mathfrak p$ of $R$ the module $M_{\mathfrak p}$
is of finite presentation over $S_{\mathfrak p}$.
\end{enumerate}
Then $M$ is of finite presentation over $S$.
\end{lemma}

\begin{proof}
Choose a presentation
$$
0 \to K \to S^{\oplus r} \to M \to 0
$$
of $M$ as an $S$-module. Let $\mathfrak q$ be a prime ideal of $S$
lying over a prime $\mathfrak p$ of $R$. By assumption there exist
finitely many elements $k_1, \ldots, k_t \in K$ such that if we set
$K' = \sum Sk_j \subset K$ then
$K'_{\mathfrak p} = K_{\mathfrak p}$ and
$K'_{\mathfrak p_j} = K_{\mathfrak p_j}$ for $j = 1, \ldots, m$.
Setting $M' = S^{\oplus r}/K'$ we deduce that in particular
$M'_{\mathfrak q} = M_{\mathfrak q}$. By openness of flatness, see
Algebra, Theorem \ref{algebra-theorem-openess-flatness}
we conclude that there exists a $g \in S$, $g \not \in \mathfrak q$
such that $M'_g$ is flat over $R$. Thus $M'_g \to M_g$ is a surjective
map of flat $R$-modules. Consider the commutative diagram
$$
\xymatrix{
M'_g \ar[r] \ar[d] & M_g \ar[d] \\
\prod (M'_g)_{\mathfrak p_j} \ar[r] & \prod (M_g)_{\mathfrak p_j}
}
$$
The bottom arrow is an isomorphism by choice of $k_1, \ldots, k_t$.
The left vertical arrow is an injective map as
$R \to \prod R_{\mathfrak p_j}$ is injective and $M'_g$ is flat over $R$.
Hence the top horizontal arrow is injective, hence an isomorphism.
This proves that $M_g$ is of finite presentation over $S_g$.
We conclude by applying
Algebra, Lemma \ref{algebra-lemma-cover}.
\end{proof}

\begin{lemma}
\label{lemma-flat-finite-type-finite-presentation-local}
Let $R \to S$ be a ring homomorphism.
Assume
\begin{enumerate}
\item there exist finitely many primes
$\mathfrak p_1, \ldots, \mathfrak p_m$ of $R$ such that
the map $R \to \prod R_{\mathfrak p_j}$ is injective,
\item $R \to S$ is of finite type,
\item $S$ flat over $R$, and
\item for every prime $\mathfrak p$ of $R$ the ring $S_{\mathfrak p}$
is of finite presentation over $R_{\mathfrak p}$.
\end{enumerate}
Then $S$ is of finite presentation over $R$.
\end{lemma}

\begin{proof}
By assumption $S$ is a quotient of a polynomial ring over $R$.
Thus the result follows directly from
Lemma \ref{lemma-flat-finite-type-finite-presentation-local-module}.
\end{proof}

\begin{lemma}
\label{lemma-flat-graded-finite-type-finite-presentation-module}
Let $R$ be a ring.
Let $S = R[x_1, \ldots, x_n]$ be a graded polynomial algebra over $R$,
i.e., $\deg(x_i) > 0$ but not necessarily equal to $1$.
Let $M$ be a graded $S$-module.
Assume
\begin{enumerate}
\item $R$ is a local ring,
\item $M$ is a finite $S$-module, and
\item $M$ is flat over $R$.
\end{enumerate}
Then $M$ is finitely presented as an $S$-module.
\end{lemma}

\begin{proof}
Let $M = \bigoplus M_d$ be the grading on $M$.
Pick homogeneous generators $m_1, \ldots, m_r \in M$ of $M$.
Say $\deg(m_i) = d_i \in \mathbf{Z}$. This gives us a presentation
$$
0 \to K \to \bigoplus\nolimits_{i = 1, \ldots, r} S(-d_i) \to M \to 0
$$
which in each degree $d$ leads to the short exact sequence
$$
0 \to K_d \to \bigoplus\nolimits_{i = 1, \ldots, r} S_{d - d_i} \to
M_d \to 0.
$$
By assumption each $M_d$ is a finite flat $R$-module. By
Algebra, Lemma \ref{algebra-lemma-finite-flat-local}
this implies each $M_d$ is a finite free $R$-module. Hence
we see each $K_d$ is a finite $R$-module. Also each $K_d$ is flat
over $R$ by
Algebra, Lemma \ref{algebra-lemma-flat-ses}.
Hence we conclude that each $K_d$ is finite free by 
Algebra, Lemma \ref{algebra-lemma-finite-flat-local}
again.

\medskip\noindent
Let $\mathfrak m$ be the maximal ideal of $R$. By the flatness of $M$
over $R$ the short exact sequences above remain short exact after tensoring
with $\kappa = \kappa(\mathfrak m)$. As the ring $S \otimes_R \kappa$ is
Noetherian we see that there exist homogeneous elements
$k_1, \ldots, k_t \in K$ such that the images $\overline{k}_j$
generate $K \otimes_R \kappa$ over $S \otimes_R \kappa$. Say $\deg(k_j) = e_j$.
Thus for any $d$ the map
$$
\bigoplus\nolimits_{j = 1, \ldots, t} S_{d - e_j}
\longrightarrow
K_d
$$
becomes surjective after tensoring with $\kappa$. By
Nakayama's lemma
(Algebra, Lemma \ref{algebra-lemma-NAK})
this implies the map is surjective over $R$. Hence $K$ is generated
by $k_1, \ldots, k_t$ over $S$ and we win.
\end{proof}

\begin{lemma}
\label{lemma-flat-graded-finite-type-finite-presentation}
Let $R$ be a ring. Let $S = \bigoplus_{n \geq 0} S_n$ be a graded $R$-algebra.
Let $M = \bigoplus_{d \in \mathbf{Z}} M_d$ be a graded $S$-module.
Assume $S$ is finitely generated as an $R$-algebra, assume $S_0$ is a finite
$R$-algebra, and assume there exist finitely many primes
$\mathfrak p_j$, $i = 1, \ldots, m$ such that
$R \to \prod R_{\mathfrak p_j}$ is injective.
\begin{enumerate}
\item If $S$ is flat over $R$, then $S$ is a finitely presented $R$-algebra.
\item If $M$ is flat as an $R$-module and finite as an $S$-module,
then $M$ is finitely presented as an $S$-module.
\end{enumerate}
\end{lemma}

\begin{proof}
As $S$ is finitely generated as an $R$-algebra, it is finitely generated
as an $S_0$ algebra, say by homogeneous elements $t_1, \ldots, t_n \in S$
of degrees $d_1, \ldots, d_n > 0$. Set $P = R[x_1, \ldots, x_n]$ with
$\deg(x_i) = d_i$. The ring map $P \to S$, $x_i \to t_i$ is finite
as $S_0$ is a finite $R$-module. To prove (1) it suffices to prove
that $S$ is a finitely presented $P$-module.  To prove (2) it suffices
to prove that $M$ is a finitely presented $P$-module. Thus it suffices
to prove that if $S = P$ is a graded polynomial ring and $M$ is a finite
$S$-module flat over $R$, then $M$ is finitely presented as an $S$-module. By
Lemma \ref{lemma-flat-graded-finite-type-finite-presentation-module}
we see $M_{\mathfrak p}$ is a finitely presented $S_{\mathfrak p}$-module
for every prime $\mathfrak p$ of $R$. Thus the result follows from
Lemma \ref{lemma-flat-finite-type-finite-presentation-local-module}.
\end{proof}

\begin{remark}
\label{remark-when-does-condition-hold}
Let $R$ be a ring. When does $R$ satisfy the condition mentioned in
Lemmas \ref{lemma-flat-finite-type-finite-presentation-local-module},
\ref{lemma-flat-finite-type-finite-presentation-local}, and
\ref{lemma-flat-graded-finite-type-finite-presentation}?
This holds if
\begin{enumerate}
\item $R$ is local,
\item $R$ is Noetherian,
\item $R$ is a domain,
\item $R$ is a reduced ring with finitely many minimal primes, or
\item $R$ has finitely many weakly associated primes, see
Algebra, Lemma \ref{algebra-lemma-zero-at-weakly-ass-zero}.
\end{enumerate}
Thus these lemmas hold in all cases listed above.
\end{remark}

\noindent
The following lemma wil be improved below, see
Proposition \ref{proposition-flat-finite-type-finite-presentation-domain}.

\begin{lemma}
\label{lemma-flat-finite-type-valuation-ring-finite-presentation}
Let $A$ be a valuation ring. Let $A \to B$ be a ring map of finite type.
Let $M$ be a finite $B$-module.
\begin{enumerate}
\item If $B$ is flat over $A$, then $B$ is a finitely presented $A$-algebra.
\item If $M$ is flat as an $A$-module, then $M$ is finitely presented
as a $B$-module.
\end{enumerate}
\end{lemma}

\begin{proof}
We are going to use that an $A$-module is flat if and only if it is
torsion free, see
Lemma \ref{lemma-valuation-ring-torsion-free-flat}.
By
Algebra, Lemma \ref{algebra-lemma-homogenize}
we can find a graded $A$-algebra $S$ with $S_0 = A$ and generated
by finitely many elements in degree $1$, an element $f \in S_1$ and a
finite graded $S$-module $N$ such that $B \cong S_{(f)}$ and
$M \cong N_{(f)}$. If $M$ is torsion free, then we can take $N$ torsion
free by replacing it by $N/N_{tors}$, see
Lemma \ref{lemma-torsion}.
Similarly, if $B$ is torsion free, then we can take
$S$ torsion free by replacing it by $S/S_{tors}$.
Hence in case (1), we may apply
Lemma \ref{lemma-flat-graded-finite-type-finite-presentation}
to see that $S$ is a finitely presented
$A$-algebra, which implies that $B = S_{(f)}$ is a finitely
presented $A$-algebra. To see (2) we may first replace $S$ by
a graded polynomial ring, and then we may apply
Lemma \ref{lemma-flat-graded-finite-type-finite-presentation-module}
to conclude.
\end{proof}

\begin{lemma}
\label{lemma-helper-finite-type-flat-finite-presentation}
Let $R$ be a domain with fraction field $K$.
Let $S = R[x_1, \ldots, x_n]$ be a polynomial ring over $R$.
Let $M$ be a finite $S$-module. Assume that $M$ is flat over $R$.
If for every subring $R \subset R' \subset K$, $R \not = R'$
the module $M \otimes_R R'$ is finitely presented
over $S \otimes_R R'$, then $M$ is finitely presented over $S$.
\end{lemma}

\begin{proof}
Suppose that $f_1, \ldots, f_n \in R$ are elements which generate the
unit ideal. If $R \not = R_{f_i}$ for each $i = 1, \ldots, n$, then
we conclude that $M_{f_i}$ is finitely presented over
$S_{f_i}$ for each $i$, and hence $M$ is finitely presented over $S$ by
Algebra, Lemma \ref{algebra-lemma-cover}.
Thus we are done if such a sequence of elements exists.
Assume this is not the case. In particular, for every $x \in R$ we
have either $x \in R^*$, or $1 - x \in R^*$. This implies that $R$ is
local, see
Algebra, Lemma \ref{algebra-lemma-characterize-local-ring}.

\medskip\noindent
Choose a presentation
$$
0 \to K \to R[x_1, \ldots, x_n]^{\oplus r} \to M \to 0.
$$
Throughout the rest of the proof we will use that this sequence stays exact
after tensoring with any $R$-algebra, see
Algebra, Lemma \ref{algebra-lemma-flat-tor-zero}.
Let $R'$ be the integral closure of $R$ in its fraction field.
If $R \not = R'$, then we see that $M \otimes_R R'$ is finitely presented over
$R'[x_1, \ldots, x_n]$. In particular, the module $K \otimes_R R'$
is finitely generated. Thus we may pick $k_1, \ldots, k_t \in K$ such that
$k_1 \otimes 1, \ldots, k_t \otimes 1$ generate $K \otimes_R R'$.
Set $K' = \sum R[x_1, \ldots, x_n]k_i \subset K$. Set
$M' = R[x_1, \ldots, x_n]^{\oplus t}/K'$. Then $M'$ is a finitely presented
module over $R[x_1, \ldots, x_n]$ such that
$M' \otimes_R R' \cong M \otimes_R R'$ is flat over $R'$. By
Lemma \ref{lemma-descent-flatness-injective-integral}
we conclude that $M'$ is flat over $R$. Hence the surjective
map $M' \to M$ is also injective as $M'$ is torsion free, see
Lemma \ref{lemma-flat-torsion-free}.
In other words, $M' \cong M$ and we conclude that $M$ is finitely presented.
Thus we are done if $R$ is not a normal domain.
Assume this is not the case. This reduces us to the case where $R$ is
a normal local domain.

\medskip\noindent
Pick any pair of nonzero elements $x, y \in R$. Consider the inclusions
$R \subset R[x/y]$ and $R[y/x]$. As $R$ is a normal domain we get a short
exact sequence
$$
0 \to R \xrightarrow{(-1, 1)} R[x/y] \oplus R[y/x] \xrightarrow{(1, 1)}
R[x/y, y/x] \to 0
$$
see
Algebra, Lemma \ref{algebra-lemma-silly-normal}.
If $R \not = R[x/y]$ and $R \not = R[y/x]$ then we see that
$K \otimes_R R[x/y]$ and $K \otimes_R R[y/x]$ are finitely generated
as $R[x/y][x_1, \ldots, x_n]$ and $R[y/x][x_1, \ldots, x_n]$ modules.
Thus we can find $k_1, \ldots, k_t \in K$ such that the elements
$k_i \otimes 1$ generate
$K \otimes_R R[x/y]$ and $K \otimes_R R[y/x]$ as $R[x/y][x_1, \ldots, x_n]$
and $R[y/x][x_1, \ldots, x_n]$ modules.
Set $K' = \sum R[x_1, \ldots, x_n]k_i \subset K$. Tensoring the sequence
above with $K' \subset K$ we get the diagram
$$
\xymatrix{
 &
K' \ar[d] \ar[r] &
K' \otimes_R R[x/y] \oplus K' \otimes_R R[y/x] \ar[d] \ar[r] &
K' \otimes_R R[x/y, y/x] \ar[d] \ar[r] &
0 \\
0 \ar[r] &
K \ar[r] &
K \otimes_R R[x/y] \oplus K \otimes_R R[y/x] \ar[r] &
K \otimes_R R[x/y, y/x] \ar[r] &
0
}
$$
Now we know that the vertical arrows in the middle and on the right
are isomorphisms. The lower row is exact as $K$ is flat over $R$.
Hence the left vertical arrow is surjective, i.e., an isomorphism.
Thus we win if there exists a pair of nonzero elements such that
neither $x/y$ nor $y/x$ is an element of $R$. Assume this is not the case.
Then we know that $R \subset f.f.(R)$ is a normal local domain such
that for every $x \in f.f.(R)$ either $x \in R$, or $x^{-1} \in R$.
In other words, $R$ is a valuation ring, see
Algebra, Lemma \ref{algebra-lemma-x-or-x-inverse-valuation-ring}.
In this case $M$ is finitely presented by
Lemma \ref{lemma-flat-finite-type-valuation-ring-finite-presentation}
and we win.
\end{proof}

\noindent
The following result is a special case of results in \cite{GruRay}
which we discuss in great detail in
More on Flatness, Section \ref{flat-section-introduction}.

\begin{proposition}
\label{proposition-flat-finite-type-finite-presentation-domain}
Let $R$ be a domain.
Let $R \to S$ be a ring map of finite type.
Let $M$ be a finite $S$-module.
\begin{enumerate}
\item If $S$ is flat over $R$, then $S$ is a finitely presented $R$-algebra.
\item If $M$ is flat as an $R$-module, then $M$ is finitely presented
as a $S$-module.
\end{enumerate}
\end{proposition}

\begin{proof}
It suffices to prove part (2) in case $S = R[x_1, \ldots, x_n]$.
Choose a presentation
$$
0 \to K \to R[x_1, \ldots, x_n]^{\oplus r} \to M \to 0.
$$
Throughout the rest of the proof we will use that this sequence stays exact
after tensoring with any $R$-algebra, see
Algebra, Lemma \ref{algebra-lemma-flat-tor-zero}.
Let $L$ be the fraction field of $R$.
Consider the set
$$
\mathcal{R} = \{R' \mid
R \subset R' \subset L
\text{ and }
M \otimes_R R'
\text{ not of finite presentation over }
S \otimes_R R'\}
$$
We order $\mathcal{R}$ by inclusion. Suppose that
$\{R_i\}_{i \in I}$ is a totally ordered subset of $\mathcal{R}$.
Set $R_{\infty} = \bigcup_{i \in I} R_i$.
We claim that $R_\infty \in \mathcal{R}$.
Namely, if $M \otimes_R R_{\infty}$ is finitely presented over
$S \otimes_R R_\infty$, then $K \otimes_R R_\infty$ is finitely
generated, say by $k_1, \ldots, k_t$. Then for some $i\in I$
we have $k_1, \ldots, k_t \in K \otimes_R R_i$. For any
$i' \geq i$ set
$M_{i'} = R_i[x_1, \ldots, x_n]^{\oplus r}/\sum R_i[x_1, \ldots, x_n]k_i$.
By
Algebra, Lemma \ref{algebra-lemma-flat-finite-presentation-limit-flat}
we see that $M_{i'}$ is flat over $R_i$ for some sufficiently large
$i' \in I$. For such an $i'$ the surjective map
$M_{i'} \to M \otimes_R R_i$ is also injective as
$M_{i'}$ is torsion free. Hence we conclude that
$M \otimes_R R_i$ is finitely presented which is a contradiction.
In other words $R_\infty \in \mathcal{R}$.
This shows that Zorn's lemma applies to $\mathcal{R}$ if $\mathcal{R}$
is not empty. But
Lemma \ref{lemma-helper-finite-type-flat-finite-presentation}
shows that $\mathcal{R}$ does not have any maximal elements and the
proposition is proved.
\end{proof}




\section{Blowing up and flatness}
\label{section-blowup-flat}

\noindent
In this section we begin our discussion of results of the form: ``After a
blow up the strict transform becomes flat''.

\begin{definition}
\label{definition-strict-transform}
Let $R$ be a domain.
Let $M$ be an $R$-module.
Let $R \subset R'$ be an extension of domains.
The {\it strict transform of $M$ along $R \to R'$} is
the torsion free $R'$-module
$$
M' = (M \otimes_R R')/(M \otimes_R R')_{tors}.
$$
\end{definition}

\noindent
The following is a very weak version of flattening by blowing up, but
it is already sometimes a useful result.

\begin{lemma}
\label{lemma-flatten-on-affine-blowup}
Let $(R, \mathfrak m)$ be a local domain with fraction field $K$.
Let $S$ be a finite type $R$-algebra.
Let $M$ be a finite $S$-module.
For every valuation ring $A \subset K$ dominating $R$
there exists an ideal $I \subset \mathfrak m$ and a nonzero
element $a \in I$ such that
\begin{enumerate}
\item $I$ is finitely generated,
\item $A$ has center on $R[\frac{I}{a}]$,
\item the fibre ring of $R \to R[\frac{I}{a}]$ at $\mathfrak m$
is not zero, and
\item the strict transform $S_{I, a}$ of $S$ along $R \to R[\frac{I}{a}]$
is flat and of finite presentation over $R$, and the strict transform
$M_{I, a}$ of $M$ along $R \to R[\frac{I}{a}]$ is flat over $R$ and
finitely presented over $S_{I, a}$.
\end{enumerate}
\end{lemma}

\begin{proof}
Note that the assertion makes sense as $R[\frac{I}{a}]$
is a domain, and $R \to R[\frac{I}{a}]$ is injective, see
Algebra, Lemmas \ref{algebra-lemma-blowup-domain} and
\ref{algebra-lemma-blowup-dominant}.
Before we start the proof of the Lemma, note that there is
no loss in generality assuming that $S = R[x_1, \ldots, x_n]$
is a polynomial ring over $R$. We also fix a presentation
$$
0 \to K \to S^{\oplus r} \to M \to 0.
$$
Let $M_A$ be the strict transform of $M$ along $R \to A$. It is a finite
module over $S_A = A[x_1, \ldots, x_n]$. By
Lemma \ref{lemma-valuation-ring-torsion-free-flat}
we see that $M_A$ is flat over $A$. By
Lemma \ref{lemma-flat-finite-type-valuation-ring-finite-presentation}
we see that $M_A$ is finitely presented. Hence there exist finitely many
elements $k_1, \ldots, k_t \in S_A^{\oplus r}$ which generate the
kernel of the presentation $S_A^{\oplus r} \to M_A$ as
an $S_A$-module. For any choice of $a \in I \subset \mathfrak m$
satisfying (1), (2), and (3) we denote $M_{I, a}$ the strict transform of
$M$ along $R \to R[\frac{I}{a}]$. It is a finite module over
$S_{I, a} = R[\frac{I}{a}][x_1, \ldots, x_n]$. By
Algebra, Lemma \ref{algebra-lemma-valuation-ring-colimit-affine-blowups}
we have $A = \text{colim}_{I, a}\ R[\frac{I}{a}]$.
This implies that $S_A = \text{colim}\ S_{I, a}$ and
$M_A = \text{colim}_{I, a}\ M_{I, a}$.
Thus we may choose $a \in I \subset R$ such that
$k_1, \ldots, k_t$ are elements of $S_{I, a}^{\oplus r}$ and
map to zero in $M_{I, a}$. For any such pair $(I, a)$ we set
$$
M'_{I, a} = S_{I, a}^{\oplus r}/ \sum S_{I, a}k_j.
$$
Since $M_A = S_A^{\oplus r}/ \sum S_Ak_j$ we see that also
$M_A = \text{colim}_{I, a}\ M'_{I, a}$.
At this point we may apply
Algebra, Lemma \ref{algebra-lemma-flat-finite-presentation-limit-flat} (3)
to conclude that $M'_{I, a}$ is flat for some pair $(I, a)$.
(This lemma does not apply a priori to the system $M_{I, a}$
as the transition maps may not satisfy the assumptions of the lemma.)
Since flatness implies torsion free (
Lemma \ref{lemma-flat-torsion-free}),
we also conclude that $M'_{I, a} = M_{I, a}$ for such a pair and we win.
\end{proof}







\section{The Koszul complex}
\label{section-koszul}

\noindent
We define the Koszul complex as follows.

\begin{definition}
\label{definition-koszul}
Let $R$ be a ring. Let $\varphi : E \to R$ be an $R$-module map. The 
{\it Koszul complex} $K_\bullet(\varphi)$ associated to $\varphi$
is the commutative differential graded algebra defined as follows:
\begin{enumerate}
\item the underlying graded algebra is the exterior algebra
$K_\bullet(\varphi) = \wedge(E)$,
\item the differential $d : K_\bullet(\varphi) \to K_\bullet(\varphi)$
is the unique derivation such that $d(e) = \varphi(e)$ for all
$e \in E = K_1(\varphi)$.
\end{enumerate}
\end{definition}

\noindent
Explicitly, if $e_1 \wedge \ldots \wedge e_n$ is one of the generators of
degree $n$ in $K_\bullet(\varphi)$, then
$$
d(e_1 \wedge \ldots \wedge e_n) =
\sum\nolimits_{i = 1, \ldots, n} (-1)^{i + 1}
\varphi(e_i)e_1 \wedge \ldots \wedge \widehat{e_i} \wedge \ldots \wedge e_n.
$$
It is straightforward to see that this gives a well defined derivation
on the tensor algebra, which annihilates $e \wedge e$ and hence factors
through the exterior algebra.

\medskip\noindent
We often assume that $E$ is a finite free module, say $E = R^{\oplus n}$.
In this case the map $\varphi$ is given by a sequence of elements
$f_1, \ldots, f_n \in R$.

\begin{definition}
\label{definition-koszul-complex}
Let $R$ be a ring and let $f_1, \ldots, f_n \in R$. The
{\it Koszul complex on $f_1, \ldots, f_r$} is the Koszul complex
associated to the map $(f_1, \ldots, f_n) : R^{\oplus n} \to R$.
Notation $K_\bullet(f_\bullet)$, $K_\bullet(f_1, \ldots, f_n)$,
or $K_\bullet(R, f_\bullet)$.
\end{definition}

\noindent
Of course, if $E$ is finite locally free, then $K_\bullet(\varphi)$ is
locally on $\text{Spec}(R)$ isomorphic to a Koszul complex
$K_\bullet(f_1, \ldots, f_n)$.
This complex has many interesting formal properties.

\begin{lemma}
\label{lemma-functorial}
Let $\varphi : E \to R$ and $\varphi : E' \to R$ be an $R$-module maps.
Let $\psi : E \to E'$ be an $R$-module map such that
$\varphi' \circ \psi = \varphi$. Then $\psi$ induces a
homomorphism of differential graded algebras
$K_\bullet(\varphi) \to K_\bullet(\varphi')$.
\end{lemma}

\begin{proof}
This is immediate from the definitions.
\end{proof}

\begin{lemma}
\label{lemma-change-basis}
Let $f_1, \ldots, f_c \in R$ be a sequence.
Let $(x_{ij})$ be an invertible $c \times x$-matrix with
coefficients in $R$. Then the complexes
$K_\bullet(f_\bullet)$ and
$$
K_\bullet(\sum x_{1j}f_j, \sum x_{2j}f_j, \ldots, \sum x_{cj}f_j)
$$
are isomorphic.
\end{lemma}

\begin{proof}
Set $g_i = \sum x_{ij}f_j$.
The matrix $(x_{ij})$ gives an isomorphism $x : R^{\oplus c} \to R^{\oplus c}$
such that $(g_1, \ldots, g_c) \circ x = (f_1, \ldots, f_c)$.
Hence this follows from the functoriality of the Koszul complex
described in
Lemma \ref{lemma-functorial}.
\end{proof}

\begin{lemma}
\label{lemma-homotopy-koszul-abstract}
Let $R$ be a ring. Let $\varphi : E \to R$ be an $R$-module map.
Let $e \in E$ with image $f = \varphi(e)$ in $R$. Then
$$
f = de + ed
$$
as endomorphisms of $K_\bullet(\varphi)$.
\end{lemma}

\begin{proof}
This is true because $d(ea) = d(e)a - ed(a) = fa - ed(a)$.
\end{proof}

\noindent
In
Derived Categories, Section \ref{derived-section-cones}
we defined the cone of a morphism of cochain complexes.
The cone $C(f)_\bullet$ of a morphism of chain complexes
$f : A_\bullet \to B_\bullet$ is the complex $C(f)_\bullet$ given by
$C(f)_n = B_n \oplus A_{n - 1}$ and differential
\begin{equation}
\label{equation-differential-cone}
d_{C(f), n} =
\left(
\begin{matrix}
d_{B, n} & f^{n - 1} \\
0 & -d_{A, n - 1}
\end{matrix}
\right)
\end{equation}
It comes equipped with canonical morphisms of complexes
$i : B_\bullet \to C(f)_\bullet$ and
$p : C(f)_\bullet \to A_\bullet[-1]$
induced by the obvious maps $B_n \to C(f)_n \to A_{n - 1}$.

\begin{lemma}
\label{lemma-cone-koszul-abstract}
Let $R$ be a ring. Let $\varphi : E \to R$ be an $R$-module map.
Let $f \in R$. Set $E' = E \oplus R$ and define $\varphi' : E' \to R$
by $\varphi$ on $E$ and multiplication by $f$ on $R$.
The complex $K_\bullet(\varphi')$ is isomorphic to the
cone of the map of complexes
$$
f :
K_\bullet(\varphi)
\longrightarrow
K_\bullet(\varphi).
$$
\end{lemma}

\begin{proof}
Denote $e_0 \in E'$ the element $1 \in R \subset R \oplus E$.
By our definition of the cone above we see that
$$
C(f)_n = K_n(\varphi) \oplus K_{n - 1}(\varphi) =
\wedge^n(E) \oplus \wedge^{n - 1}(E) = \wedge^n(E')
$$
where in the last $=$ we map $(0, e_1 \wedge \ldots \wedge e_{n - 1})$
to $e_0 \wedge e_1 \wedge \ldots \wedge e_{n - 1}$ in $\wedge^n(E')$.
A computation shows that this isomorphism is compatible with
differentials. Namely, this is clear for elements of the first
summand as $\varphi'|_E = \varphi$ and $d_{C(f)}$ restricted to
the first summand is just $d_{K_\bullet(\varphi)}$.
On the other hand, if $e_1 \wedge \ldots \wedge e_{n - 1}$
is in the first summand, then
$$
d_{C(f)}(0, e_1 \wedge \ldots \wedge e_{n - 1}) =
fe_1 \wedge \ldots \wedge e_{n - 1}
- d_{K_\bullet(\varphi)}(e_1 \wedge \ldots \wedge e_{n - 1})
$$
and on the other hand
$$
\begin{matrix}
d_{K_\bullet(\varphi')}(e_0 \wedge e_1 \wedge \ldots \wedge e_{n - 1})
\hfill \\
= \sum\nolimits_{i = 0, \ldots, n - 1}
(-1)^i \varphi'(e_i)e_0 \wedge \ldots \wedge \widehat{e_i}
\wedge \ldots \wedge e_{n - 1} \hfill \\
= fe_1 \wedge \ldots \wedge e_{n - 1} +
\sum\nolimits_{i = 1, \ldots, n - 1}
(-1)^i \varphi(e_i)e_0 \wedge \ldots \wedge \widehat{e_i}
\wedge \ldots \wedge e_{n - 1} \hfill \\
= fe_1 \wedge \ldots \wedge e_{n - 1} -
e_0 \left(\sum\nolimits_{i = 1, \ldots, n - 1}
(-1)^{i + 1} \varphi(e_i)e_1 \wedge \ldots \wedge \widehat{e_i}
\wedge \ldots \wedge e_{n - 1}\right)
\end{matrix}
$$
which is the image of the result of the previous computation.
\end{proof}

\begin{lemma}
\label{lemma-cone-koszul}
Let $R$ be a ring. Let $f_1, \ldots, f_n$ be a sequence of elements
of $R$. The complex $K_\bullet(f_1, \ldots, f_n)$ is isomorphic to the
cone of the map of complexes
$$
f_n :
K_\bullet(f_1, \ldots, f_{n - 1})
\longrightarrow
K_\bullet(f_1, \ldots, f_{n - 1}).
$$
\end{lemma}

\begin{proof}
Special case of
Lemma \ref{lemma-cone-koszul-abstract}.
\end{proof}

\begin{lemma}
\label{lemma-cone-squared}
Let $R$ be a ring. Let $A_\bullet$ be a complex of $R$-modules.
Let $f, g \in R$. Let $C(f)_\bullet$ be the cone of
$f : A_\bullet \to A_\bullet$. Define similarly $C(g)_\bullet$ and
$C(fg)_\bullet$. Then $C(fg)_\bullet$ is homotopy equivalent to the
cone of a map
$$
C(f)_\bullet[1] \longrightarrow C(g)_\bullet
$$
\end{lemma}

\begin{proof}
We first prove this if $A_\bullet$ is the complex consisting of $R$ placed
in degree $0$. In this case the map we use is
$$
\xymatrix{
0 \ar[r] \ar[d] &
0 \ar[r] \ar[d] &
R \ar[r]^f \ar[d]^1 &
R \ar[r] \ar[d] & 0 \ar[d] \\
0 \ar[r] & R \ar[r]^g & R \ar[r] & 0 \ar[r] & 0
}
$$
The cone of this is the chain complex consisting of $R \oplus R$ placed in
degrees $1$ and $0$ and differential (\ref{equation-differential-cone})
$$
\left(
\begin{matrix}
g & 1 \\
0 & -f
\end{matrix}
\right) :
R^{\oplus 2} \longrightarrow R^{\oplus 2}
$$
We leave it to the reader to show this this chain complex is
homotopic to the complex $fg : R \to R$. In general we
write $C(f)_\bullet$ and $C(g)_\bullet$
as the total complex of the double complexes
$$
(R \xrightarrow{f} R) \otimes_R A_\bullet
\quad\text{and}\quad
(R \xrightarrow{g} R) \otimes_R A_\bullet
$$
and in this way we deduce the result from the special case discussed above.
Some details omitted.
\end{proof}

\begin{lemma}
\label{lemma-koszul-mult-abstract}
Let $R$ be a ring. Let $\varphi : E \to R$ be an $R$-module map.
Let $f, g \in R$. Set $E' = E \oplus R$ and define
$\varphi'_f, \varphi'_g, \varphi'_{fg} : E' \to R$
by $\varphi$ on $E$ and multiplication by $f, g, fg$ on $R$.
The complex $K_\bullet(\varphi'_{fg})$ is isomorphic to the
cone of a map of complexes
$$
f :
K_\bullet(\varphi'_f)[1]
\longrightarrow
K_\bullet(\varphi'_g).
$$
\end{lemma}

\begin{proof}
By
Lemma \ref{lemma-cone-koszul-abstract}
the complex $K_\bullet(\varphi'_f)$ is isomorphic to the cone of
multiplication by $f$ on $K_\bullet(\varphi)$ and similarly
for the other two cases. Hence the the lemma follows from
Lemma \ref{lemma-cone-squared}.
\end{proof}

\begin{lemma}
\label{lemma-koszul-mult}
Let $R$ be a ring. Let $f_1, \ldots, f_{n - 1}$ be a sequence of elements
of $R$. Let $f, g \in R$. The complex
$K_\bullet(f_1, \ldots, f_{n - 1}, fg)$
is homotopy equivalent to the cone of a map of complexes
$$
K_\bullet(f_1, \ldots, f_{n - 1}, f)[1]
\longrightarrow
K_\bullet(f_1, \ldots, f_{n - 1}, g)
$$
\end{lemma}

\begin{proof}
Special case of
Lemma \ref{lemma-koszul-mult-abstract}.
\end{proof}





\section{Koszul regular sequences}
\label{section-koszul-regular}

\noindent
Please take a look at
Algebra, Sections \ref{algebra-section-depth} and
\ref{algebra-section-quasi-regular}
before looking at this one.

\begin{definition}
\label{definition-koszul-regular-sequence}
Let $R$ be a ring.
A sequence of elements $f_1, \ldots, f_c$ of $R$ is called
{\it Koszul-regular} if $H_i(K_\bullet(f_1, \ldots, f_r)) = 0$ for
all $i \not = 0$.
A sequence of elements $f_1, \ldots, f_c$ of $R$ is called
{\it $H_1$-regular} if $H_1(K_\bullet(f_1, \ldots, f_r)) = 0$.
\end{definition}

\noindent
Clear a Koszul-regular sequence is $H_1$-regular. If $f = f_1 \in R$
is a length $1$ sequence then it is clear that the following are
all equivalent
\begin{enumerate}
\item $f$ is a regular sequence of length one,
\item $f$ is a Koszul-regular sequence of length one, and
\item $f$ is a $H_1$-regular sequence of length one.
\end{enumerate}
It is also clear that these imply that $f$ is a quasi-regular sequence
of length one. But there do exist quasi-regular sequences of length $1$
which are not regular sequences. Namely, let
$$
R = k[x, y_0, y_1, \ldots]/(xy_0, xy_1 - y_0, xy_2 - y_1, \ldots)
$$
and let $f$ be the image of $x$ in $R$. Then $f$ is a zero divisor, but
$\bigoplus_{n \geq 0} (f^n)/(f^{n + 1}) \cong k[x]$ is a polynomial ring.

\begin{lemma}
\label{lemma-regular-koszul-regular}
A regular sequence is Koszul-regular.
\end{lemma}

\begin{proof}
Let $f_1, \ldots, f_c$ be a regular sequence. Then $f_1$ is a nonzero
divisor in $R$. Hence
$$
0 \to K_\bullet(R, f_2, \ldots, f_c) \xrightarrow{f_1}
K_\bullet(R, f_2, \ldots, f_c) \to
K_\bullet(R/(f_1), \overline{f}_2, \ldots, \overline{f}_c) \to 0
$$
is a short exact sequence of complexes. By
Lemma \ref{lemma-cone-koszul}
the complex $K_\bullet(R, f_1, \ldots, f_c)$
is isomorphic to the cone of the first map. Hence
$K_\bullet(R/(f_1), \overline{f}_2, \ldots, \overline{f}_c)$
is quasi-isomorphic to $K_\bullet(R, f_1, \ldots, f_c)$.
As $\overline{f}_2, \ldots, \overline{f}_c$ is a regular sequence
in $R/(f_1)$ the result follows from the case $c = 1$ discussed above and
induction.
\end{proof}

\begin{lemma}
\label{lemma-mult-koszul-regular}
Let $f_1, \ldots, f_{c - 1} \in R$ be a sequence and $f, g \in R$.
\begin{enumerate}
\item If $f_1, \ldots, f_{c - 1}, f$ and $f_1, \ldots, f_{c - 1}, g$
are $H_1$-regular then $f_1, \ldots, f_{c - 1}, fg$ is an
$H_1$-regular sequence too.
\item If $f_1, \ldots, f_{c - 1}, f$ and $f_1, \ldots, f_{c - 1}, f$ are
Koszul-regular then $f_1, \ldots, f_{c - 1}, fg$ is a Koszul-regular
sequence too.
\end{enumerate}
\end{lemma}

\begin{proof}
By
Lemma \ref{lemma-koszul-mult}
we have exact sequences
$$
H_i(K_\bullet(f_1, \ldots, f_{c - 1}, f)) \to
H_i(K_\bullet(f_1, \ldots, f_{c - 1}, fg)) \to
H_i(K_\bullet(f_1, \ldots, f_{c - 1}, g))
$$
for all $i$.
\end{proof}

\begin{lemma}
\label{lemma-koszul-regular-flat-base-change}
Let $\varphi : R \to S$ be a flat ring map.
\begin{enumerate}
\item If $f_1, \ldots, f_r$ is a $H_1$-regular sequence in $R$, then
$\varphi(f_1), \ldots, \varphi(f_r)$ is a $H_1$-regular sequence in $S$.
\item If $f_1, \ldots, f_r$ is a Koszul-regular sequence in $R$, then
$\varphi(f_1), \ldots, \varphi(f_r)$ is a Koszul-regular sequence in $S$.
\end{enumerate}
\end{lemma}

\begin{proof}
This is true because
$K_\bullet(f_1, \ldots, f_r) \otimes_R S =
K_\bullet(\varphi(f_1), \ldots, \varphi(f_r))$.
\end{proof}

\begin{lemma}
\label{lemma-H1-regular-quasi-regular}
An $H_1$-regular sequence is quasi-regular.
\end{lemma}

\begin{proof}
Let $f_1, \ldots, f_c$ be an $H_1$-regular sequence.
Denote $J = (f_1, \ldots, f_c)$. The assumption means that we have
an exact sequence
$$
\wedge^2(R^c) \to R^{\oplus c} \to J \to 0
$$
where the first arrow is given by $e_i \wedge e_j \mapsto f_ie_j - f_je_i$.
In particular this implies that
$$
J/J^2 = J \otimes_R R/J = (R/J)^c
$$
is a finite free module. To finish the proof we have to prove
for every $n \geq 2$ the following: if
$$
\xi = \sum\nolimits_{|I| = n, I = (i_1, \ldots, i_c)}
a_I f_1^{i_1} \ldots f_c^{i_c} \in J^{n + 1}
$$
then $a_I \in J$ for all $I$. Note that $f_1, \ldots, f_{c - 1}, f_c^n$
is a $H_1$-regular sequence by
Lemma \ref{lemma-mult-koszul-regular}.
Hence we see that the required result holds for
the multi-index $I = (0, \ldots, 0, n)$. It turns out that we can
reduce the general case to this case as follows.

\medskip\noindent
Let $S = R[x_1, x_2, \ldots, x_c, 1/x_c]$.
Let $y_{ij} \in S$ be the entries of the inverse of the matrix $(x_{ij})$.
The ring map $R \to S$ is faithfully
flat, hence $f_1, \ldots, f_c$ is an $H_1$-regular sequence in $S$, see
Lemma \ref{lemma-koszul-regular-flat-base-change}.
By
Lemma \ref{lemma-change-basis}
we see that
$$
g_1 = f_1 - x_1/x_c f_c, \ldots
g_{c - 1} = f_{c - 1} - x_{c - 1}/x_c f_c,
g_c = (1/x_c)f_c
$$
is an $H_1$-regular sequence in $S$. Finally, note that our element
$\xi$ can be rewritten
$$
\xi = \sum\nolimits_{|I| = n, I = (i_1, \ldots, i_c)}
a_I (g_1 + x_c g_c)^{i_1} \ldots (g_{c - 1} + x_c g_c)^{i_{c - 1}}
(x_cg_c)^{i_c}
$$
and the coefficient of $g_c^n$ in this expression is
$$
\sum a_I x_1^{i_1} \ldots x_c^{i_c} \in JS.
$$
Since the monomials $x_1^{i_1} \ldots x_c^{i_c}$ form part of an $R$-basis
of $S$ over $R$ we conclude that $a_I \in J$ for all $I$ as desired.
\end{proof}






\section{Pseudo-coherent modules}
\label{section-pseudo-coherent}

\noindent
Suppose that $R$ is a ring. Recall that an $R$-module $M$ is of finite type
if there exists a surjection $R^{\oplus a} \to M$ and of finite presentation
if there exists a presentation
$R^{\oplus a_1} \to R^{\oplus a_0} \to M \to 0$.
Similarly, we can consider those $R$-modules for which there exists
a length $n$ resolution
\begin{equation}
\label{equation-pseudo-coherent}
R^{\oplus a_n} \to R^{\oplus a_{n - 1}} \to \ldots \to R^{\oplus a_0} \to
M \to 0
\end{equation}
by finite free $R$-modules. A module is called {\it pseudo-coherent}
of we can find such a resolution for every $n$. Here is the formal
definition.

\begin{definition}
\label{definition-pseudo-coherent}
Let $R$ be a ring. Denote $D(R)$ its derived category.
Let $m \in \mathbf{Z}$.
\begin{enumerate}
\item An object $K^\bullet$ of $D(R)$ is {\it $m$-pseudo-coherent}
if there exists a bounded complex $E^\bullet$ of finite free $R$-modules
and a morphism $\alpha : E^\bullet \to K^\bullet$ such that
$H^i(\alpha)$ is an isomorphism for $i > m$ and $H^m(\alpha)$
is surjective.
\item An object $K^\bullet$ of $D(R)$ is {\it pseudo-coherent}
if it is quasi-isomorphic to a bounded above complex of finite
free $R$-modules.
\item An $R$-module $M$ is called {\it $m$-pseudo-coherent} if
if $M[0]$ is an $m$-pseudo-coherent object of $D(R)$.
\item An $R$-module $M$ is called
{\it pseudo-coherent}\footnote{This clashes with what is meant by
a pseudo-coherent module in \cite{Bourbaki-CA}.}
if $M[0]$ is a pseudo-coherent object of $D(R)$.
\end{enumerate}
\end{definition}

\noindent
As usual we apply this terminology also to complexes of $R$-modules.
Since any morphism $E^\bullet \to K^\bullet$ in $D(R)$ is represented
by an actual map of complexes, see
Derived Categories, Lemma \ref{derived-lemma-morphisms-from-projective-complex},
there is no ambiguity.
It turns out that $K^\bullet$ is pseudo-coherent if and only if
$K^\bullet$ is $m$-pseudo-coherent for all $m \in \mathbf{Z}$, see
Lemma \ref{lemma-pseudo-coherent}.
Let us first relate this to the informal discussion above.

\begin{lemma}
\label{lemma-cone-pseudo-coherent}
Let $R$ be a ring and $m \in \mathbf{Z}$.
Let $(K^\bullet, L^\bullet, M^\bullet, f, g, h)$ be a distinguished
triangle in $D(R)$.
\begin{enumerate}
\item If $K^\bullet$ is $(m + 1)$-pseudo-coherent and
$L^\bullet$ is $m$-pseudo-coherent then $M^\bullet$ is
$m$-pseudo-coherent.
\item If $K^\bullet, M^\bullet$ are $m$-pseudo-coherent, then
$L^\bullet$ is $m$-pseudo-coherent.
\item If $L^\bullet$ is $(m + 1)$-pseudo-coherent and $M^\bullet$
is $m$-pseudo-coherent, then $K^\bullet$ is $(m + 1)$-pseudo-coherent.
\end{enumerate}
\end{lemma}

\begin{proof}
Proof of (1). Choose $\alpha : P^\bullet \to K^\bullet$
with $P^\bullet$ a bounded complex of finite free modules
such that $H^i(\alpha)$ is an isomorphism for $i > m + 1$ and
surjective for $i = m + 1$. We may replace $P^\bullet$ by
$\sigma_{\geq m + 1}P^\bullet$ and hence we may assume that $P^i = 0$
for $i < m + 1$. Choose $\beta : E^\bullet \to L^\bullet$ with $E^\bullet$
a bounded complex of finite free modules such that
$H^i(\beta)$ is an isomorphism for $i > m$ and
surjective for $i = m$. By
Derived Categories,
Lemma \ref{derived-lemma-lift-map}
we can find a map $\alpha : P^\bullet \to E^\bullet$ such that the diagram
$$
\xymatrix{
K^\bullet \ar[r] & L^\bullet \\
P^\bullet \ar[u] \ar[r]^\alpha & E^\bullet \ar[u]
}
$$
is commutative in $D(R)$. The cone $C(\alpha)^\bullet$ is a bounded
complex of finite free $R$-modules, and the commutativity of the
diagram implies that there exists a morphism of distinguished triangles
$$
(P^\bullet, E^\bullet, C(\alpha)^\bullet)
\longrightarrow
(K^\bullet, L^\bullet, M^\bullet).
$$
It follows from the induced map on long exact cohomology sequences and
Homology, Lemmas \ref{homology-lemma-four-lemma} and
\ref{homology-lemma-five-lemma}
that $C(\alpha)^\bullet \to M^\bullet$ induces an isomorpism
on cohomology in degrees $> m$ and a surjection in degree $m$.
Hence $M^\bullet$ is $m$-pseudo-coherent.

\medskip\noindent
Assertions (2) and (3) follow from (1) by rotating the distinguished
triangle.
\end{proof}

\begin{lemma}
\label{lemma-finite-cohomology}
Let $R$ be a ring. Let $K^\bullet$ be a complex of $R$-modules.
Let $m \in \mathbf{Z}$.
\begin{enumerate}
\item If $K^\bullet$ is $m$-pseudo-coherent and $H^i(K^\bullet) = 0$
for $i > m$, then $H^m(K^\bullet)$ is a finite type $R$-module.
\item If $K^\bullet$ is $m$-pseudo-coherent and $H^i(K^\bullet) = 0$
for $i > m + 1$, then $H^{m + 1}(K^\bullet)$ is a finitely presented
$R$-module.
\end{enumerate}
\end{lemma}

\begin{proof}
Proof of (1). Choose a bounded complex $E^\bullet$ of finite projective
$R$-modules and a map $\alpha : E^\bullet \to K^\bullet$ which induces
an isomorphism on cohomology in degrees $> m$ and a surjection in degree $m$.
It is clear that it suffices to prove the result for $E^\bullet$.
Let $n$ be the largest integer such that $E^n \not = 0$.
If $n = m$, then the result is clear.
If $n > m$, then $E^{n - 1} \to E^n$ is surjective as
$H^n(E^\bullet) = 0$. As $E^n$ is finite projective we see that
$E^{n - 1} = E' \oplus E^n$. Hence it suffices to prove the result
for the complex $(E')^\bullet$ which is the same as $E^\bullet$
except has $E'$ in degree $n - 1$ and $0$ in degree $n$.
We win by induction on $n$.

\medskip\noindent
Proof of (2). Choose a bounded complex $E^\bullet$ of finite projective
$R$-modules and a map $\alpha : E^\bullet \to K^\bullet$ which induces
an isomorphism on cohomology in degrees $> m$ and a surjection in degree $m$.
As in the proof of (1) we can reduce to the case that $E^i = 0$ for
$i > m + 1$. Then we see that
$H^{m + 1}(K^\bullet) \cong
H^{m + 1}(E^\bullet) = \text{Coker}(E^m \to E^{m + 1})$
which is of finite presentation.
\end{proof}

\begin{lemma}
\label{lemma-n-pseudo-module}
Let $R$ be a ring. Let $M$ be an $R$-module.
Then
\begin{enumerate}
\item $M$ is $0$-pseudo-coherent if and only if $M$ is a finite type
$R$-module,
\item $M$ is $(-1)$-pseudo-coherent if and only if $M$ is a finitely
presented $R$-module,
\item $M$ is $(-d)$-pseudo-coherent if and only if there exists a
resolution
$$
R^{\oplus a_d} \to R^{\oplus a_{d - 1}} \to \ldots \to R^{\oplus a_0} \to
M \to 0
$$
of length $d$, and
\item $M$ is pseudo-coherent if and only if there exists an
infinite resolution
$$
\ldots \to R^{\oplus a_1} \to R^{\oplus a_0} \to M \to 0
$$
by finite free $R$-modules.
\end{enumerate}
\end{lemma}

\begin{proof}
If $M$ is of finite type (resp.\ of finite presentation), then $M$
is $0$-pseudo-coherent (resp.\ $(-1)$-pseudo-coherent) as follows from the
discussion preceding
Definition \ref{definition-pseudo-coherent}.
Conversely, if $M$ is $0$-pseudo-coherent, then $M = H^0(M[0])$
is of finite type by
Lemma \ref{lemma-finite-cohomology}.
If $M$ is $(-1)$-pseudo-coherent, then it is $0$-pseudo-coherent hence
of finite type. Choose a surjection $R^{\oplus a} \to M$ and denote
$K = \text{Ker}(R^{\oplus a} \to M)$. By
Lemma \ref{lemma-cone-pseudo-coherent}
we see that $K$ is $0$-pseudo-coherent, hence of finite type, whence
$M$ is of finite presentation.

\medskip\noindent
To prove the third and fourth statement use
induction and an argument similar to the above (details omitted).
\end{proof}

\begin{lemma}
\label{lemma-pseudo-coherent}
Let $R$ be a ring. Let $K^\bullet$ be a complex of $R$-modules.
The following are equivalent
\begin{enumerate}
\item $K^\bullet$ is pseudo-coherent,
\item $K^\bullet$ is $m$-pseudo-coherent for every $m \in \mathbf{Z}$, and
\item $K^\bullet$ is quasi-isomorphic to a bounded above complex of finite
projective $R$-modules.
\end{enumerate}
\end{lemma}

\begin{proof}
We see that (1) $\Rightarrow$ (3) as a finite free module is a finite
projective $R$-module. Conversely, suppose $P^\bullet$ is a bounded
above complex of finite projective $R$-modules. Say $P^i = 0$ for
$i > n_0$. We choose a direct sum decompositions
$F^{n_0} = P^{n_0} \oplus C^{n_0}$ with $F^{n_0}$ a finite free
$R$-module, and inductively
$$
F^{n - 1} = P^{n - 1} \oplus C^n \oplus C^{n - 1}
$$
for $n \leq n_0$ with $F^{n_0}$ a finite free $R$-module. As a complex
$F^\bullet$ has maps $F^{n - 1} \to F^n$ which agree with $P^{n - 1} \to P^n$,
induce the identity $C^n \to C^n$, and are zero on $C^{n - 1}$. The map
$F^\bullet \to P^\bullet$ is a quasi-isomorphism (even a homotopy equivalence)
and hence (3) implies (1).

\medskip\noindent
Assume (1). Let $E^\bullet$ be a bounded above complex of finite free
$R$-modules and let $E^\bullet \to K^\bullet$ be a
quasi-isomorphism. Then the induced maps
$\sigma_{\geq m}E^\bullet \to K^\bullet$ from the stupid truncation
of $E^\bullet$ to $K^\bullet$ show that $K^\bullet$ is $m$-pseudo-coherent.
Hence (1) implies (2).

\medskip\noindent
Assume (2). We first apply (2) for $n = 0$ to obtain a
map of complexes $\alpha : F^\bullet \to K^\bullet$ where $F^\bullet$ is
bounded above, consists of finite free $R$-modules and such that
$H^i(\alpha)$ is an isomorphism for $i > 0$ and surjective for $i = 0$.
Note that these conditions remain satisfied after replacing $F^\bullet$
by $\sigma_{\geq 0}F^\bullet$. Picture
$$
\xymatrix{
& F^0 \ar[r] \ar[d]^\alpha & F^1 \ar[d]^\alpha \ar[r] & \ldots \\
K^{-1} \ar[r] & K^0 \ar[r] & K^1 \ar[r] & \ldots
}
$$
By induction on $n < 0$ we are going to extend $F^\bullet$ to a complex
$F^n \to F^{n + 1} \to \ldots \to F^{-1} \to F^0 \to \ldots$
of finite free $R$-modules and extend $\alpha$ such that $H^i(\alpha)$
is an isomorphism for $i > n$ and surjective for $i = n$.
By shifting it suffices to prove the induction step for $n = -1$.
By
Lemma \ref{lemma-finite-cohomology}
the kernel of $H^0(F^\bullet) = \text{Ker}(d_F^0) \to H^0(K^\bullet)$
is a finitely generated $R$-module. Hence we can choose a finite free
$R$-module $F^{-1}$ and a map $d_F^{-1} : F^{-1} \to F^0$ whose image
is this kernel. Then $\alpha(\text{Im}(d_F^{-1})) \subset
\text{Im}(d_K^{-1})$ and as $F^{-1}$ is projective we can a lift
$\alpha : F^{-1} \to K^{-1}$ fitting into the diagram
$$
\xymatrix{
F^{-1} \ar[d] \ar[r] &
F^0 \ar[r] \ar[d]^\alpha &
F^1 \ar[d]^\alpha \ar[r] & \ldots \\
K^{-1} \ar[r] & K^0 \ar[r] & K^1 \ar[r] & \ldots
}
$$
By
Lemma \ref{lemma-finite-cohomology}
the cokernel of $H^{-1}(F^\bullet) \to H^{-1}(K^\bullet)$
is a finitely generated $R$-module. Hence we can add a finite free
summand to $F^{-1}$ which is annihilated by $d_F^{-1}$ but
via $\alpha$ maps to generators of this cokernel.
This proves the lemma.
\end{proof}

\begin{lemma}
\label{lemma-two-out-of-three-pseudo-coherent}
Let $R$ be a ring. Let $(K^\bullet, L^\bullet, M^\bullet, f, g, h)$
be a distinguished triangle in $D(R)$. If two out of three of
$K^\bullet, L^\bullet, M^\bullet$ are
pseudo-coherent then the third is also pseudo-coherent.
\end{lemma}

\begin{proof}
Combine
Lemmas \ref{lemma-cone-pseudo-coherent} and \ref{lemma-pseudo-coherent}.
\end{proof}

\begin{lemma}
\label{lemma-recognize-pseudo-coherent}
Let $R$ be a ring. Let $K^\bullet$ be a complex of $R$-modules.
Let $m \in \mathbf{Z}$.
\begin{enumerate}
\item If $H^i(K^\bullet) = 0$ for all $i \geq m$, then
$K^\bullet$ is $m$-pseudo-coherent.
\item If $H^i(K^\bullet) = 0$ for $i > m$ and $H^m(K^\bullet)$ is
a finite $R$-module, then $K^\bullet$ is $m$-pseudo-coherent.
\item If $H^i(K^\bullet) = 0$ for $i > m + 1$, the module
$H^{m + 1}(K^\bullet)$ is of finite presentation, and
$H^m(K^\bullet)$ is of finite type, then $K^\bullet$ is
$m$-pseudo-coherent.
\end{enumerate}
\end{lemma}

\begin{proof}
It suffices to prove (3). Set $M = H^{m + 1}(K^\bullet)$.
Note that $\tau_{\geq m + 1}K^\bullet$ is quasi-isomorphic to
$M[- m - 1]$. By
Lemma \ref{lemma-n-pseudo-module}
we see that $M[- m - 1]$ is $m$-pseudo-coherent. Since we have
the distinguished triangle
$$
(\tau_{\leq m}K^\bullet, K^\bullet, \tau_{\geq m + 1}K^\bullet)
$$
by
Lemma \ref{lemma-cone-pseudo-coherent}
it suffices to prove that $\tau_{\leq m}K^\bullet$ is pseudo-coherent.
By assumption $H^m(\tau_{\leq m}K^\bullet)$ is a finite type $R$-module.
Hence we can find a finite free $R$-module $E$ and a map
$E \to \text{Ker}(d_K^m)$ such that the composition
$E \to \text{Ker}(d_K^m) \to H^m(\tau_{\leq m}K^\bullet)$ is surjective.
Then $E[-m] \to \tau_{\leq m}K^\bullet$ witnesses the fact
that $\tau_{\leq m}K^\bullet$ is $m$-pseudo-coherent.
\end{proof}

\begin{lemma}
\label{lemma-summands-pseudo-coherent}
Let $R$ be a ring. Let $m \in \mathbf{Z}$. If $K^\bullet \oplus L^\bullet$
is $m$-pseudo-coherent (resp.\ pseudo-coherent)
so are $K^\bullet$ and $L^\bullet$.
\end{lemma}

\begin{proof}
In this proof we drop the superscript ${}^\bullet$.
Assume that $K \oplus L$ is $m$-pseudo-coherent.
It is clear that $K, L \in D^{-}(R)$.
Note that there is a distinguished triangle
$$
(K \oplus L, K \oplus L, K \oplus L[1]) =
(K, K, 0) \oplus (L, L, L \oplus L[1])
$$
see
Derived Categories, Lemma \ref{derived-lemma-direct-sum-triangles}.
By
Lemma \ref{lemma-cone-pseudo-coherent}
we see that $L \oplus L[1]$ is $m$-pseudo-coherent.
Hence also $L[1] \oplus L[2]$ is $m$-pseudo-coherent.
By induction $L[n] \oplus L[n + 1]$ is $m$-pseudo-coherent.
By
Lemma \ref{lemma-recognize-pseudo-coherent}
we see that $L[n]$ is $m$-pseudo-coherent for large $n$.
Hence working backwards, using the distinguished triangles
$$
(L[n], L[n] \oplus L[n - 1], L[n - 1])
$$
we conclude that $L[n], L[n - 1], \ldots, L$ are $m$-pseudo-coherent
as desired. The pseudo-coherent case follows from this and
Lemma \ref{lemma-pseudo-coherent}.
\end{proof}

\begin{lemma}
\label{lemma-complex-pseudo-coherent-modules}
Let $R$ be a ring. Let $K^\bullet$ be a bounded above complex of
pseudo-coherent $R$-modules. Then $K^\bullet$ is pseudo-coherent.
\end{lemma}

\begin{proof}
It suffices to prove that $K^\bullet$ is $m$-pseudo-coherent for
all $m \in \mathbf{Z}$, see
Lemma \ref{lemma-pseudo-coherent}.
Then we may replace $K^\bullet$ by $\sigma_{\geq m}K^\bullet$
and assume that $K^\bullet$ is bounded.
In this case $K^\bullet$ is pseudo-coherent as each $K^i$ is pseudo-coherent
by induction on the length of the finite complex: use
Lemma \ref{lemma-two-out-of-three-pseudo-coherent}
and the stupid truncations.
\end{proof}

\begin{lemma}
\label{lemma-finite-push-pseudo-coherent}
Let $A \to B$ be a ring map. Assume that $B$ is pseudo-coherent as an
$A$-module. Let $K^\bullet$ be a complex of $B$-modules.
The following are equivalent
\begin{enumerate}
\item $K^\bullet$ is $m$-pseudo-coherent
as a complex of $B$-modules, and
\item $K^\bullet$ is $m$-pseudo-coherent
as a complex of $A$-modules.
\end{enumerate}
The same equivalence holds for pseudo-coherence.
\end{lemma}

\begin{proof}
Assume (1). Choose a bounded complex of finite free $B$-modules
$E^\bullet$ and a map $\alpha : E^\bullet \to K^\bullet$ which is
an isomorphism on cohomology in degrees $> m$ and a surjection in degree $m$.
Consider the distinguished triangle
$(E^\bullet, K^\bullet, C(\alpha)^\bullet)$. By
Lemma \ref{lemma-recognize-pseudo-coherent}
$C(\alpha)^\bullet$ is $m$-pseudo-coherent as a complex of
$A$-modules. Hence it suffices to prove that $E^\bullet$ is
pseudo-coherent as a complex of $A$-modules, which follows from
Lemma \ref{lemma-complex-pseudo-coherent-modules}.
The pseudo-coherent case of (1) $\Rightarrow$ (2) follows from this and
Lemma \ref{lemma-pseudo-coherent}.

\medskip\noindent
Assume $K^\bullet$ is $m$-pseudo-coherent as a complex of $A$-modules.
Let $n$ be the largest integer such that $H^n(K^\bullet) \not = 0$.
We will prove that $K^\bullet$ is $m$-pseudo-coherent as a complex
of $B$-modules by induction on $n - m$. The case $n < m$ follows from
Lemma \ref{lemma-recognize-pseudo-coherent}.
Choose a bounded complex of finite free $A$-modules $E^\bullet$ and a
map $\alpha : E^\bullet \to K^\bullet$ which is an isomorphism on
cohomology in degrees $> m$ and a surjection in degree $m$.
Consider the induced map of complexes
$$
\alpha \otimes 1 : E^\bullet \otimes_A B \to K^\bullet.
$$
Note that $C(\alpha \otimes 1)^\bullet$ is acyclic in degrees
$\geq n$ as
$H^n(E^\bullet \otimes_A B) = H^n(E^\bullet) \otimes_A B \to H^n(K^\bullet)$
is surjective by construction. On the other hand, $C(\alpha \otimes 1)^\bullet$
is $m$-pseudo-coherent as a complex of $A$-modules because
both $K^\bullet$ and $E^\bullet \otimes_A B$ (see
Lemma \ref{lemma-complex-pseudo-coherent-modules})
are so, see
Lemma \ref{lemma-cone-pseudo-coherent}.
Hence by induction we see that $C(\alpha \otimes 1)^\bullet$
is $m$-pseudo-coherent as a complex of $B$-modules. Finally
another application of
Lemma \ref{lemma-cone-pseudo-coherent}
shows that $K^\bullet$ is $m$-pseudo-coherent as a complex of $B$-modules
(as clearly $E^\bullet \otimes_A B$ is pseudo-coherent as a complex
of $B$-modules). The pseudo-coherent case
of (2) $\Rightarrow$ (1) follows from this and
Lemma \ref{lemma-pseudo-coherent}.
\end{proof}

\begin{lemma}
\label{lemma-pull-pseudo-coherent}
Let $A \to B$ be a ring map.
Let $K^\bullet$ be an $m$-pseudo-coherent (resp.\ pseudo-coherent)
complex of $A$-modules. Then $K^\bullet \otimes_A^{\mathbf{L}} B$
is an $m$-pseudo-coherent (resp.\ pseudo-coherent) complex of $B$-modules. 
\end{lemma}

\begin{proof}
First we note that the statement of the lemma makes sense as
$K^\bullet$ is bounded above and hence $K^\bullet \otimes_A^{\mathbf{L}} B$
is defined by Equation (\ref{equation-derived-tensor-algebra}).
Having said this, choose a bounded complex $E^\bullet$
of finite free $A$-modules and $\alpha : E^\bullet \to K^\bullet$
with $H^i(\alpha)$ an isomorphism for $i > m$ and surjective for
$i = m$. Then the cone $C(\alpha)^\bullet$ is acyclic in degrees
$\geq m$. Since $-\otimes_A^{\mathbf{L}} B$ is an exact functor
we get a distinguished triangle
$$
(E^\bullet \otimes_A^{\mathbf{L}} B, K^\bullet \otimes_A^{\mathbf{L}} B,
C(\alpha)^\bullet \otimes_A^{\mathbf{L}} B)
$$
of complexes of $B$-modules. By the dual to
Derived Categories, Lemma \ref{derived-lemma-negative-vanishing}
we see that $H^i(C(\alpha)^\bullet \otimes_A^{\mathbf{L}} B) = 0$
for $i \geq m$. Since $E^\bullet$ is a complex of projective $R$-modules
we see that $E^\bullet \otimes_A^{\mathbf{L}} B = E^\bullet \otimes_A B$
and hence
$$
E^\bullet \otimes_A B
\longrightarrow
K^\bullet \otimes_A^{\mathbf{L}} B
$$
is a morphism of complexes of $B$-modules that witnesses the
fact that $K^\bullet \otimes_A^{\mathbf{L}} B$ is $m$-pseudo-coherent.
The case of pseudo-coherent complexes follows from the case
of $m$-pseudo-coherent complexes via
Lemma \ref{lemma-pseudo-coherent}.
\end{proof}

\begin{lemma}
\label{lemma-glue-pseudo-coherent}
Let $R$ be a ring. Let $f_1, \ldots, f_r \in R$ be elements which
generate the unit ideal. Let $m \in \mathbf{Z}$. Let $K^\bullet$
be a complex of $R$-modules. If for each $i$ the complex
$K^\bullet \otimes_R R_{f_i}$ is $m$-pseudo-coherent
(resp.\ pseudo-coherent), then $K^\bullet$ is $m$-pseudo-coherent
(resp.\ pseudo-coherent).
\end{lemma}

\begin{proof}
We will use without further mention that $- \otimes_R R_{f_i}$ is
an exact functor and that therefore
$$
H^i(K^\bullet)_{f_i} =
H^i(K^\bullet) \otimes_R R_{f_i} = H^i(K^\bullet \otimes_R R_{f_i}).
$$
Assume $K^\bullet \otimes_R R_{f_i}$ is $m$-pseudo-coherent
for $i = 1, \ldots, r$. Let $n \in \mathbf{Z}$ be the largest
integer such that $H^n(K^\bullet \otimes_R R_{f_i})$ is nonzero
for some $i$. This implies in particular that $H^i(K^\bullet) = 0$
for $i > n$ (and that $H^n(K^\bullet) \not = 0$) see
Algebra, Lemma \ref{algebra-lemma-cover}.
We will prove the lemma by induction on $n - m$.
If $n < m$, then the lemma is true by
Lemma \ref{lemma-recognize-pseudo-coherent}.
If $n \geq m$, then $H^n(K^\bullet)_{f_i}$ is a finite $R_{f_i}$-module
for each $i$, hence $H^n(K^\bullet)$ is a finite $R$-module, see
Algebra, Lemma \ref{algebra-lemma-cover}.
Choose a finite free $R$-module $E$ and a surjection $E \to H^n(K^\bullet)$.
As $E$ is projective we can lift this to a map of complexes
$\alpha : E[-n] \to K^\bullet$. Then the cone $C(\alpha)^\bullet$ has
vanishing cohomology in degrees $\geq n$. On the other hand, the
complexes $C(\alpha)^\bullet \otimes_R R_{f_i}$ are $m$-pseudo-coherent
for each $i$, see
Lemma \ref{lemma-cone-pseudo-coherent}.
Hence by induction we see that $C(\alpha)^\bullet$ is $m$-pseudo-coherent
as a complex of $R$-modules. Applying
Lemma \ref{lemma-cone-pseudo-coherent}
once more we conclude.
\end{proof}








\section{Tor dimension}
\label{section-tor}

\noindent
Instead of resolving by projective modules we can look
at resolutions by flat modules. This leads to the following
concept.

\begin{definition}
\label{definition-tor-amplitude}
Let $R$ be a ring. Denote $D(R)$ its derived category.
Let $a, b \in \mathbf{Z}$.
\begin{enumerate}
\item An object $K^\bullet$ of $D(R)$ has
{\it tor-amplitude in $[a, b]$}
if $H^i(K^\bullet \otimes_R^\mathbf{L} M) = 0$ for all $R$-modules
$M$ and all $i \not \in [a, b]$.
\item An object $K^\bullet$ of $D(R)$ has {\it finite tor dimension}
if it has tor-amplitude in $[a, b]$ for some $a, b$.
\item An $R$-module $M$ has {\it tor dimension $\leq d$} if
if $M[0]$ as an object of $D(R)$ has tor-amplitude in $[-d, 0]$.
\item An $R$-module $M$ has {\it finite tor dimension}
if $M[0]$ as an object of $D(R)$ has finite tor dimension.
\end{enumerate}
\end{definition}

\noindent
We observe that if $K^\bullet$ has finite tor dimension,
then $K^\bullet \in D^b(R)$.

\begin{lemma}
\label{lemma-last-one-flat}
Let $R$ be a ring. Let $K^\bullet$ be a bounded above complex of
flat $R$-modules with tor-amplitude in $[a, b]$.
Then $\text{Coker}(d_K^{a - 1})$ is a flat $R$-module.
\end{lemma}

\begin{proof}
As $K^\bullet$ is a bounded above complex of flat modules we see
that $K^\bullet \otimes_R M = K^\bullet \otimes_R^{\mathbf{L}} M$.
Hence for every $R$-module $M$ the sequence
$$
K^{a - 2} \otimes_R M \to K^{a - 1} \otimes_R M \to K^a \otimes_R M
$$
is exact in the middle. Since
$K^{a - 2} \to K^{a - 1} \to K^a \to \text{Coker}(d_K^{a - 1}) \to 0$
is a flat resolution this implies that $\text{Tor}_1^R(F^a, M) = 0$
for all $R$-modules $M$. This means that
$\text{Coker}(d_K^a)$ is flat, see
Algebra, Lemma \ref{algebra-lemma-characterize-flat}.
\end{proof}

\begin{lemma}
\label{lemma-tor-amplitude}
Let $R$ be a ring. Let $K^\bullet$ be an object of $D(R)$.
Let $a, b \in \mathbf{Z}$. The following are equivalent
\begin{enumerate}
\item $K^\bullet$ has tor-amplitude in $[a, b]$.
\item $K^\bullet$ is quasi-isomorphic to a complex
$E^\bullet$ of flat $R$-modules with $E^i = 0$ for $i \not \in [a, b]$.
\end{enumerate}
In particular an $R$-module has tor dimension $0$ if and only if
it is a flat $R$-module.
\end{lemma}

\begin{proof}
If (2) holds, then we may compute
$K^\bullet \otimes_R^\mathbf{L} M = E^\bullet \otimes_R M$
and it is clear that (1) holds.
Assume that (1) holds. We may replace $K^\bullet$ by
a projective resolution. 
Let $n$ be the largest integer such that $K^n \not = 0$.
If $n > b$, then $K^{n - 1} \to K^n$ is surjective as
$H^n(K^\bullet) = 0$. As $K^n$ is projective we see that
$K^{n - 1} = K' \oplus K^n$. Hence it suffices to prove the result
for the complex $(K')^\bullet$ which is the same as $K^\bullet$
except has $K'$ in degree $n - 1$ and $0$ in degree $n$.
Thus, by induction on $n$, we reduce to the case that $K^\bullet$
is a complex of projective $R$-modules with $K^i = 0$ for $i > b$.

\medskip\noindent
Set $E^\bullet = \tau_{\geq a}K^\bullet$. Everything is clear except
that $E^a$ is flat which follows immediately from
Lemma \ref{lemma-last-one-flat}
and the definitions.
\end{proof}

\begin{lemma}
\label{lemma-cone-tor-amplitude}
Let $R$ be a ring and $m \in \mathbf{Z}$.
Let $(K^\bullet, L^\bullet, M^\bullet, f, g, h)$ be a distinguished
triangle in $D(R)$. Let $a, b \in \mathbf{Z}$.
\begin{enumerate}
\item If $K^\bullet$ has tor-amplitude in $[a + 1, b + 1]$ and
$L^\bullet$ has tor-amplitude in $[a, b]$ then $M^\bullet$ has
tor-amplitude in $[a, b]$.
\item If $K^\bullet, M^\bullet$ have tor-amplitude in $[a, b]$, then
$L^\bullet$ has tor-amplitude in $[a, b]$.
\item If $L^\bullet$ has tor-amplitude in $[a + 1, b + 1]$
and $M^\bullet$ has tor-amplitude in $[a, b]$, then
$K^\bullet$ has tor-amplitude in $[a + 1, b + 1]$.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted. Hint: This just follows from the long exact cohomology sequence
associated to a distinguished triangle and the fact that
$- \otimes_R^{\mathbf{L}} M$ preserves distinguished triangles.
The easiest one to prove is (2) and the others follow from it by
translation.
\end{proof}












\section{Perfect complexes}
\label{section-perfect}

\noindent
A perfect complex is a pseudo-coherent complex of finite tor dimension.
But we can also define the directly as follows.

\begin{definition}
\label{definition-perfect}
Let $R$ be a ring. Denote $D(R)$ the derived category of the abelian
category of $R$-modules.
\begin{enumerate}
\item An object $K$ of $D(R)$ is {\it perfect} if it is quasi-isomorphic
to a bounded complex of finite projective $R$-modules.
\item An $R$-module $M$ is {\it perfect} if $M[0]$ is a perfect object
in $D(R)$.
\end{enumerate}
\end{definition}

\begin{lemma}
\label{lemma-perfect}
Let $K^\bullet$ be an object of $D(R)$. The following are equivalent
\begin{enumerate}
\item $K^\bullet$ is perfect, and
\item $K^\bullet$ is pseudo-coherent and has finite tor dimension.
\end{enumerate}
In particular an $R$-module $M$ is perfect if and only if it has a finite
resolution by finite projective modules.
\end{lemma}

\begin{proof}
It is clear that (1) implies (2), see
Lemmas \ref{lemma-pseudo-coherent} and \ref{lemma-tor-amplitude}.
Assume (2). Choose a bounded above complex $F^\bullet$
of finite free $R$-modules and a quasi-isomorphism $F^\bullet \to K^\bullet$.
Assume that $K^\bullet$ has tor-amplitude in $[a, b]$.
Set $E^\bullet = \tau_{\geq a}F^\bullet$. Note that $E^i$ is finite free
except $E^a$ which is a finitely presented $R$-module.
By
Lemma \ref{lemma-last-one-flat}
$E^a$ is flat. Hence by
Algebra, Lemma \ref{algebra-lemma-finite-projective}
we see that $E^a$ is finite projective.

\medskip\noindent
To see the final statement of the lemma, suppose that $M$ is perfect.
By the equivalence of (1) and (2) we see that there exists a resolution
$F_\bullet \to M$ by finite free $R$-modules, see
Lemma \ref{lemma-n-pseudo-module}.
Then for $a \ll 0$ we see that $\tau_{\geq a}F^\bullet$ is
a finite complex of finite projective modules by the argument
given above. (Details omitted.)
\end{proof}









\section{Relatively finitely presented modules}
\label{section-relative-finite-presentation}

\noindent
Let $R$ be a ring. Let $A \to B$ be a finite map of finite type $R$-algebras.
Let $M$ be a finite $B$-module. In this case it is {\bf not true} that
$$
M\text{ of finite presentation over }B
\Leftrightarrow
M\text{ of finite presentation over }A
$$
A counter example is $R = k[x_1, x_2, x_3, \ldots]$, $A = R$, $B = R/(x_i)$,
and $M = B$. To ``fix'' this we introduce a relative notion of finite
presentation.

\begin{lemma}
\label{lemma-relatively-finitely-presented}
Let $R \to A$ be a ring map of finite type.
Let $M$ be an $A$-module.
The following are equivalent
\begin{enumerate}
\item for some presentation $\alpha : R[x_1, \ldots, x_n] \to A$
the module $M$ is a finitely presented $R[x_1, \ldots, x_n]$-module,
\item for all presentations $\alpha : R[x_1, \ldots, x_n] \to A$
the module $M$ is a finitely presented $R[x_1, \ldots, x_n]$-module, and
\item for any surjection $A' \to A$ where $A'$ is a finitely presented
$R$-algebra, the module $M$ is finitely presented as $A'$-module.
\end{enumerate}
In this case $M$ is a finitely presented $A$-module.
\end{lemma}

\begin{proof}
If $\alpha : R[x_1, \ldots, x_n] \to A$ and
$\beta : R[y_1, \ldots, y_m] \to A$ are presentations.
Choose $f_j \in R[x_1, \ldots, x_n]$ with $\alpha(f_j) = \beta(y_j)$
and $g_i \in R[y_1, \ldots, y_m]$ with $\beta(g_i) = \alpha(x_i)$.
Then we get a commutative diagram
$$
\xymatrix{
R[x_1, \ldots, x_n, y_1, \ldots, y_m]
\ar[d]^{x_i \mapsto g_i} \ar[rr]_-{y_j \mapsto f_j} & &
R[x_1, \ldots, x_n] \ar[d] \\
R[y_1, \ldots, y_m] \ar[rr] & & A
}
$$
Hence the equivalence of (1) and (2) follows by applying
Algebra, Lemmas \ref{algebra-lemma-finitely-presented-over-subring} and
\ref{algebra-lemma-finite-finitely-presented-extension}.
The equivalence of (2) and (3) follows by choosing a presentation
$A' = R[x_1, \ldots, x_n]/(f_1, \ldots, f_m)$ and using
Algebra, Lemma \ref{algebra-lemma-finite-finitely-presented-extension}
to show that $M$ is finitely presented as $A'$-module if and only if
$M$ is finitely presented as a $R[x_1, \ldots, x_n]$-module.
\end{proof}

\begin{definition}
\label{definition-relatively-finitely-presented}
Let $R \to A$ be a finite type ring map. Let $M$ be an $A$-module.
We say $M$ is {\it an $A$-module finitely presented relative to $R$}
if the equivalent conditions of
Lemma \ref{lemma-relatively-finitely-presented}
hold.
\end{definition}

\noindent
Note that if $R \to A$ is of finite presentation, then $M$ is an
$A$-module finitely presented relative to $R$ if and only if $M$
is a finitely presented $A$-module. It is equally clear that $A$ as
an $A$-module is finitely presented relative to $R$ if and only if
$A$ is of finite presentation over $R$.
Now we can formulate the result we were looking for.

\begin{lemma}
\label{lemma-finite-extension}
Let $R$ be a ring. Let $A \to B$ be a finite map of finite type $R$-algebras.
Let $M$ be a $B$-module. Then
$M$ is an $A$-module finitely presented relative to $R$
if and only if
$M$ is a $B$-module finitely presented relative to $R$.
\end{lemma}

\begin{proof}
Choose a surjection $R[x_1, \ldots, x_n] \to A$.
Choose $y_1, \ldots, y_m \in B$ which generate $B$ over $A$.
As $A \to B$ is finite each $y_i$ satisfies a monic equation with
coefficients in $A$. Hence we can find monic polynomials
$P_j(T) \in R[x_1, \ldots, x_n][T]$ such that $P_j(y_j) = 0$ in $B$.
Then we get a commutative diagram
$$
\xymatrix{
R[x_1, \ldots, x_n] \ar[d] \ar[r] &
R[x_1, \ldots, x_n, y_1, \ldots, y_m]/(P_j(y_j)) \ar[d] \\
A \ar[r] & B
}
$$
Since the top arrow is a finite and finitely presented ring map
we conclude by
Algebra, Lemma \ref{algebra-lemma-finite-finitely-presented-extension}
and the definition.
\end{proof}

\noindent
With this result in hand we see that the relative notion makes sense
and behaves well with regards to finite maps of rings of finite type
over $R$. It is also stable under localization, stable under
base change, and "glues" well.

\begin{lemma}
\label{lemma-localize-relative-finite-presentation}
Let $R$ be a ring, $f \in R$ an element, $R_f \to A$ is a finite type ring map,
$g \in A$, and $M$ an $A$-module. If $M$ of finite presentation relative
to $R_f$, then $M_g$ is an $A_g$-module of finite presentation relative
to $R$.
\end{lemma}

\begin{proof}
Choose a presentation $R_f[x_1, \ldots, x_n] \to A$. We write
$R_f = R[x_0]/(fx_0 - 1)$. Consider the presentation
$R[x_0, x_1, \ldots, x_n, x_{n + 1}] \to A_g$ which extends the given
map, maps $x_0$ to the image of $1/f$, and maps $x_{n + 1}$ to $1/g$.
Choose $g' \in R[x_0, x_1, \ldots, x_n]$ which maps to $g$ (this is
possible). Suppose that
$$
R_f[x_1, \ldots, x_n]^{\oplus s} \to
R_f[x_1, \ldots, x_n]^{\oplus t} \to M \to 0
$$
is a presentation of $M$ given by a matrix $(h_{ij})$. Pick
$h'_{ij} \in R[x_0, x_1, \ldots, x_n]$ which map to $h_{ij}$.
Then
$$
R[x_0, x_1, \ldots, x_n, x_{n + 1}]^{\oplus s + 2t} \to
R[x_0, x_1, \ldots, x_n, x_{n + 1}]^{\oplus t} \to M_g \to 0
$$
is a presentation of $M_f$.
Here the $t \times (s + 2t)$ matrix defining the map has a first
$t \times s$ block consisting of the matrix $h'_{ij}$, a second
$t \times t$ block which is $(x_0f - )I_t$, and a third block
which is $(x_{n + 1}g' - 1)I_t$.
\end{proof}

\begin{lemma}
\label{lemma-base-change-relative-finite-presentation}
Let $R \to A$ be a finite type ring map. Let $M$ be an $A$-module finitely
presented relative to $R$. For any ring map $R \to R'$ the
$A \otimes_R R'$-module $M \otimes_R R'$ is finitely presented relative
to $R'$.
\end{lemma}

\begin{proof}
Choose a surjection $R[x_1, \ldots, x_n] \to A$. Choose a presentation
$$
R[x_1, \ldots, x_n]^{\oplus s} \to
R[x_1, \ldots, x_n]^{\oplus t} \to M \to 0
$$
Then
$$
R'[x_1, \ldots, x_n]^{\oplus s} \to
R'[x_1, \ldots, x_n]^{\oplus t} \to M \otimes_R R' \to 0
$$
is a presentation of the base change and we win.
\end{proof}

\begin{lemma}
\label{lemma-composition-relative-finite-presentation}
Let $R \to A \to B$ be finite type ring maps. Let $M$ be a $B$-module.
If $M$ is finitely presented relative to $A$ and $A$ is of finite presentation
over $R$, then $M$ is finitely presented relative to $R$.
\end{lemma}

\begin{proof}
Choose a surjection $A[x_1, \ldots, x_n \to B$.
Choose a presentation
$$
A[x_1, \ldots, x_n]^{\oplus s} \to
A[x_1, \ldots, x_n]^{\oplus t} \to M \to 0
$$
given by a matrix $(h_{ij})$. Choose a presentation
$$
A = R[y_1, \ldots, y_m]/(g_1, \ldots, g_u).
$$
Choose $h'_{ij} \in R[y_1, \ldots, y_m, x_1, \ldots, x_n]$
mapping to $h_{ij}$. Then we obtain the presentation
$$
R[y_1, \ldots, y_m, x_1, \ldots, x_n]^{\oplus s + tu} \to
R[y_1, \ldots, y_m, x_1, \ldots, x_n]^{\oplus t} \to M \to 0
$$
where the $t \times (s + tu)$-matrix is given by a first $t \times s$ block
consisting of $h'_{ij}$ followed by $u$ blocks of size $t \times t$ given
by $g_iI_t$, $i = 1, \ldots, u$.
\end{proof}

\begin{lemma}
\label{lemma-glue-relative-finite-presentation}
Let $R \to A$ be a finite type ring map. Let $M$ be an $A$-module.
Let $f_1, \ldots, f_r \in A$ generate the unit ideal.
The following are equivalent
\begin{enumerate}
\item each $M_{f_i}$ is finitely presented relative to $R$, and
\item $M$ is finitely presented relative to $R$.
\end{enumerate}
\end{lemma}

\begin{proof}
The implication (2) $\Rightarrow$ (1) is in
Lemma \ref{lemma-localize-relative-finite-presentation}.
Assume (1). Write $1 = \sum f_ig_i$ in $A$.
Choose a surjection
$R[x_1, \ldots, x_n, y_1, \ldots, y_r, z_1, \ldots, z_r] \to A$.
such that $x_i$ maps to $f_i$ and $z_i$ maps to $g_i$. Then we
see that there exists a surjection
$$
P = R[x_1, \ldots, x_n, y_1, \ldots, y_r, z_1, \ldots, z_r]/(\sum y_iz_i - 1)
\longrightarrow
A.
$$
By
Lemma \ref{lemma-relatively-finitely-presented}
we see that $M_{f_i}$ is a finitely presented $A_{f_i}$-module, hence by
Algebra, Lemma \ref{algebra-lemma-cover}
we see that $M$ is a finitely presented $A$-module.
Hence $M$ is a finite $P$-module (with $P$ as above).
Choose a surjection $P^{\oplus t} \to M$.
We have to show that the kernel $K$ of this map is a finite
$P$-module. Since $P_{y_i}$ surjects onto
$A_{f_i}$ we see by
Lemma \ref{lemma-relatively-finitely-presented}
and
Algebra, Lemma \ref{algebra-lemma-finite-presentation-module-independent}
that the localization $K_{y_i}$ is a finitely generated
$P_{y_i}$-module. Choose elements
$k_{i, j} \in K$, $i = 1, \ldots, r$, $j = 1, \ldots, s_i$ such
that the images of $k_{i, j}$ in $K_{y_i}$ generate.
Set $K' \subset K$ equal to the $P$-module
generated by the elements $k_{i, j}$. Then $K/K'$ is a module
whose localization at $y_i$ is zero for all $i$. Since $(y_1, \ldots, y_r) = P$
we see that $K/K' = 0$ as desired.
\end{proof}










\section{Relatively pseudo-coherent modules}
\label{section-relative-pseudo-coherent}

\noindent
This section is the analogue of
Section \ref{section-relative-finite-presentation}
for pseudo-coherence.

\begin{lemma}
\label{lemma-pull-push}
Let $R$ be a ring. Let $K^\bullet$ be an object of $D^{-}(R)$.
Consider the $R$-algebra map $R[x] \to R$ which maps $x$ to zero. Then
$$
K^\bullet \otimes_{R[x]}^{\mathbf{L}} R \cong K^\bullet \oplus K^\bullet[1]
$$
in $D(R)$.
\end{lemma}

\begin{proof}
This is true because $0 \to R[x] \xrightarrow{x} R[x] \to R$
is a flat resolution of $R$ over $R[x]$ and the rule for computing
derived tensor products in
Section \ref{section-computing-tor}
and the fact that multiplication by $x$ on $K^\bullet$ is zero.
\end{proof}

\begin{lemma}
\label{lemma-add-variable-pseudo-coherent}
Let $R$ be a ring and $K^\bullet$ a complex of $R$-modules.
Let $m \in \mathbf{Z}$. Consider the $R$-algebra map $R[x] \to R$
which maps $x$ to zero. Then $K^\bullet$ is $m$-pseudo-coherent as
a complex of $R$-modules if and only if $K^\bullet$ is $m$-pseudo-coherent
as a complex of $R[x]$-modules.
\end{lemma}

\begin{proof}
This is a special case of
Lemma \ref{lemma-finite-push-pseudo-coherent}.
We also prove it in another way as follows.

\medskip\noindent
Note that $0 \to R[x] \to R[x] \to R \to 0$ is exact. Hence $R$ is
pseudo-coherent as an $R[x]$-module. Thus one implication of the lemma
follows from
Lemma \ref{lemma-finite-push-pseudo-coherent}.
To prove the other implication, assume that $K^\bullet$ is
$m$-pseudo-coherent as a complex of $R[x]$-modules. By
Lemma \ref{lemma-pull-pseudo-coherent}
we see that $K^\bullet \otimes^{\mathbf{L}}_{R[x]} R$ is
$m$-pseudo-coherent as a comples of $R$-modules. By
Lemma \ref{lemma-pull-push}
we see that $K^\bullet \oplus K^\bullet[1]$ is $m$-pseudo-coherent
as a complex of $R$-modules.
Finally, we conclude that $K^\bullet$ is $m$-pseudo-coherent
as a complex of $R$-modules from
Lemma \ref{lemma-summands-pseudo-coherent}.
\end{proof}

\begin{lemma}
\label{lemma-relatively-pseudo-coherent}
Let $R \to A$ be a ring map of finite type.
Let $K^\bullet$ be a complex of $A$-modules.
Let $m \in \mathbf{Z}$.
The following are equivalent
\begin{enumerate}
\item for some presentation $\alpha : R[x_1, \ldots, x_n] \to A$
the complex $K^\bullet$ is an $m$-pseudo-coherent complex of
$R[x_1, \ldots, x_n]$-modules,
\item for all presentations $\alpha : R[x_1, \ldots, x_n] \to A$
the complex $K^\bullet$ is an $m$-pseudo-coherent complex of
$R[x_1, \ldots, x_n]$-modules.
\end{enumerate}
In particular the same equivalence holds for pseudo-coherence.
\end{lemma}

\begin{proof}
If $\alpha : R[x_1, \ldots, x_n] \to A$ and
$\beta : R[y_1, \ldots, y_m] \to A$ are presentations.
Choose $f_j \in R[x_1, \ldots, x_n]$ with $\alpha(f_j) = \beta(y_j)$
and $g_i \in R[y_1, \ldots, y_m]$ with $\beta(g_i) = \alpha(x_i)$.
Then we get a commutative diagram
$$
\xymatrix{
R[x_1, \ldots, x_n, y_1, \ldots, y_m]
\ar[d]^{x_i \mapsto g_i} \ar[rr]_-{y_j \mapsto f_j} & &
R[x_1, \ldots, x_n] \ar[d] \\
R[y_1, \ldots, y_m] \ar[rr] & & A
}
$$
After a change of coordinates the ring homomorphism
$R[x_1, \ldots, x_n, y_1, \ldots, y_m] \to R[x_1, \ldots, x_n]$
is isomorphic to the ring homomorphism which maps
each $y_i$ to zero. Similarly for the left vertical map in the
diagram. Hence, by induction on the number of variables this lemma follows from
Lemma \ref{lemma-add-variable-pseudo-coherent}.
The pseudo-coherent case follows from this and
Lemma \ref{lemma-pseudo-coherent}.
\end{proof}

\begin{definition}
\label{definition-relatively-pseudo-coherent}
Let $R \to A$ be a finite type ring map.
Let $K^\bullet$ be a complex of $A$-modules.
Let $m \in \mathbf{Z}$.
\begin{enumerate}
\item We say $K^\bullet$ is {\it $m$-pseudo-coherent relative to $R$}
if the equivalent conditions of
Lemma \ref{lemma-relatively-pseudo-coherent}
hold.
\item We say $K^\bullet$ is {\it pseudo-coherent relative to $R$}
if $K^\bullet$ is $m$-pseudo-coherent relative to $R$ for all
$m \in \mathbf{Z}$.
\end{enumerate}
\end{definition}

\noindent
Part (2) means that $K^\bullet$ is pseudo-coherent as a complex
of $R[x_1, \ldots, x_n]$-modules for any surjection
$R[y_1, \ldots, y_m] \to A$, see
Lemma \ref{lemma-pseudo-coherent}.

\begin{lemma}
\label{lemma-finite-extension-pseudo-coherent}
Let $R$ be a ring. Let $A \to B$ be a finite map of finite type $R$-algebras.
Let $m \in \mathbf{Z}$. Let $K^\bullet$ be a complex of $B$-modules.
Then $K^\bullet$ is $m$-pseudo-coherent (resp.\ pseudo-coherent)
relative to $R$ if and only if $K^\bullet$ seen as a complex of $A$-modules
is $m$-pseudo-coherent (pseudo-coherent) relative to $R$.
\end{lemma}

\begin{proof}
Choose a surjection $R[x_1, \ldots, x_n] \to A$.
Choose $y_1, \ldots, y_m \in B$ which generate $B$ over $A$.
As $A \to B$ is finite each $y_i$ satisfies a monic equation with
coefficients in $A$. Hence we can find monic polynomials
$P_j(T) \in R[x_1, \ldots, x_n][T]$ such that $P_j(y_j) = 0$ in $B$.
Then we get a commutative diagram
$$
\xymatrix{
& R[x_1, \ldots, x_n, y_1, \ldots, y_m] \ar[d] \\
R[x_1, \ldots, x_n] \ar[d] \ar[r] &
R[x_1, \ldots, x_n, y_1, \ldots, y_m]/(P_j(y_j)) \ar[d] \\
A \ar[r] & B
}
$$
The top horizontal arrow and the top right vertial arrow
satisfy the assumptions of
Lemma \ref{lemma-finite-push-pseudo-coherent}.
Hence $K^\bullet$ is $m$-pseudo-coherent (resp.\ pseudo-coherent) as a complex
of $R[x_1, \ldots, x_n]$-modules if and only if $K^\bullet$ is
$m$-pseudo-coherent (resp.\ pseudo-coherent) as a complex of
$R[x_1, \ldots, x_n, y_1, \ldots, y_m]$-modules.
\end{proof}

\begin{lemma}
\label{lemma-localize-relative-pseudo-coherent}
Let $R$ be a ring, $f \in R$ an element, $R_f \to A$ is a finite type ring map,
$g \in A$, and $K^\bullet$ a complex of $A$-modules.
If $K^\bullet$ is $m$-pseudo-coherent (resp.\ pseudo-coherent)
relative to $R_f$, then $K^\bullet \otimes_A A_g$ is
$m$-pseudo-coherent (resp.\ pseudo-coherent) relative to $R$.
\end{lemma}

\begin{proof}
TO BE ADDED SOON.
\end{proof}
















\input{chapters}

\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}
