\input{preamble}

% OK, start here.
%
\begin{document}

\title{More Algebra}


\maketitle

\phantomsection
\label{section-phantom}

\tableofcontents



\section{Introduction}
\label{section-introduction}

\noindent
In this chapter we prove some results in commutative algebra which
are less elementary than those in the first chapter on commutative
algebra, see
Algebra, Section \ref{algebra-section-introduction}.
A reference is \cite{MatCA}.







\section{Formal glueing of module categories}
\label{section-formal-glueing}

\noindent
Fix a noetherian scheme $X$, and a closed subscheme $Z$ with complement $U$. 
Our goal is to explain a result of Artin that describes how coherent sheaves on 
$X$ can be constructed (uniquely) from coherent sheaves on the formal 
completion of $X$ along $Z$, and those on $U$ with a suitable compatibility on 
the overlap.

\begin{definition}
\label{definition-f-power-torsion}
Let $R$ be a ring. Let $M$ be an $R$-module.
\begin{enumerate}
\item Let $I \subset R$ be an ideal. We say $M$ is an
{\it $I$-power torsion module} if for every $m \in M$ there exists an $n > 0$
such that $I^n m = 0$.
\item Let $f \in R$. We say $M$ is 
{\it an $f$-power torsion module} if for each 
$m \in M$, there exists an $n > 0$ such that $f^n m = 0$.
\end{enumerate}
\end{definition}

\noindent
Thus an $f$-power torsion module is the same thing as a $I$-power torsion
module for $I = (f)$. We sometimes use the notation
$M[I^n] = \{m \in M \mid I^nm = 0\}$ and $M[I^\infty] = \bigcup M[I^n]$
for an $R$-module $M$. Thus $M$ is $I$-power torsion if and only if
$M = M[I^\infty]$ if and only if $M = \bigcup M[I^n]$.

\begin{lemma}
\label{lemma-characterize-flatness-on-torsion}
Let $\varphi : R \to S$ be a ring map. Let $I \subset R$ be an ideal.
The following are equivalent
\begin{enumerate}
\item $\varphi$ is flat and $R/I \to S/IS$ is faithfully flat,
\item $\varphi$ is flat, and the map
$\text{Spec}(S/IS) \to \text{Spec}(R/I)$ is surjective.
\item $\varphi$ is flat, and the base change functor
$M \mapsto M \otimes_R S$ is faithful on modules annihilated by $I$, and
\item $\varphi$ is flat, and the base change functor
$M \mapsto M \otimes_R S$ is faithful on $I$-power torsion modules.
\end{enumerate}
\end{lemma}

\begin{proof}
If $R \to S$ is flat, then $R/I^n \to S/I^nS$ is flat for every $n$, see
Algebra, Lemma \ref{algebra-lemma-flat-base-change}.
Hence (1) and (2) are equivalent by
Algebra, Lemma \ref{algebra-lemma-ff-rings}.
The equivalence of (1) with (3) follows by identifying $I$-torsion
$R$-modules with $R/I$-modules, using that
$$
M \otimes_R S = M \otimes_{R/I} S/IS
$$ 
for $R$-modules $M$ annihilated by $I$, and
Algebra, Lemma \ref{algebra-lemma-easy-ff}.
The implication (4) $\Rightarrow$ (3) is immediate. Assume (3). We have
seen above that $R/I^n \to S/I^nS$ is flat, and by assumption it induces
a surjection on spectra, as $\text{Spec}(R/I^n) = \text{Spec}(R/I)$ and
similarly for $S$. Hence the base change functor is faithful on modules
annihilated by $I^n$. Since any $I$-power torsion module $M$ is the union
$M = \bigcup M_n$ where $M_n$ is annihilated by $I^n$ we see that the base
change functor is faithful on the category of all $I$-power torsion modules
(as tensor product commutes with colimits).
\end{proof}

\begin{lemma}
\label{lemma-I-power-torsion-presentation}
Let $R$ be a ring.
Let $I$ be an ideal of $R$.
Let $M$ be an $I$-power torsion module.
Then $M$ admits a resolution
$$
\ldots \to K_2 \to K_1 \to K_0 \to M \to 0
$$
with each $K_i$ a direct sum of copies of $R/I^n$ for $n$ variable.
\end{lemma}

\begin{proof}
There is a canonical surjection
$$
\oplus_{m \in M} R/I^{n_m} \to M \to 0
$$
where $n_m$ is the smallest positive integer such that $I^{n_m} \cdot m = 0$.
The kernel of the preceding surjection is also an $I$-power torsion module.
Proceeding inductively, we construct the desired resolution of $M$.
\end{proof}

\begin{lemma}
\label{lemma-neighbourhood-isomorphism}
Assume $(\varphi : R \to S, I)$ satisfies the equivalent conditions of
Lemma \ref{lemma-characterize-flatness-on-torsion}.
The following are equivalent
\begin{enumerate}
\item for any $I$-power torsion module $M$, the natural map
$M \to M \otimes_R S$ is an isomorphism, and
\item $R/I \to S/IS$ is an isomorphism.
\end{enumerate}
\end{lemma}

\begin{proof}
The implication (1) $\Rightarrow$ (2) is immediate.
Assume (2). First assume that $M$ is annihilated by $I$.
In this case, $M$ is an $R/I$-module. Hence, we have an isomorphism  
$$
M \otimes_R S = M \otimes_{R/I} S/IS = M \otimes_{R/I} R/I = M
$$
proving the claim. Next we prove by induction that $M \to M \otimes_R S$
is an isomorphism for any module $M$ is annihilated by $I^n$. Assume
the induction hypothesis holds for $n$ and assume $M$ is annihilated by
$I^{n + 1}$. Then we have a short exact sequence
$$
0 \to I^nM \to M \to M/I^nM \to 0
$$
and as $R \to S$ is flat this gives rise to a short exact sequence
$$
0 \to I^nM \otimes_R S \to M \otimes_R S \to M/I^nM \otimes_R S \to 0
$$
Using that the canonical map is an isomorphism for $M' = I^nM$ and
$M'' = M/I^nM$ (by induction hypothesis) we conclude the same thing is
true for $M$. Finally, suppose that $M$ is a general $I$-power torsion
module. Then $M = \bigcup M_n$ where $M_n$ is annihilated by $I^n$
and we conclude using that tensor products commute with colimits.
\end{proof}

\begin{lemma}
\label{lemma-torsion-free}
Let $R$ be a ring. Let $I$ be an ideal of $R$.
For any $R$-module $M$ set $M[I^n] = \{m \in M \mid I^nm = 0\}$.
If $I$ is finitely generated then the following are equivalent
\begin{enumerate}
\item $M[I] = 0$,
\item $M[I^n] = 0$ for all $n \geq 1$, and
\item if $I = (f_1, \ldots, f_t)$, then the map
$M \to \bigoplus M_{f_i}$ is injective.
\end{enumerate}
\end{lemma}

\begin{proof}
This follows from
Algebra, Lemma \ref{algebra-lemma-when-injective-covering}.
\end{proof}

\begin{lemma}
\label{lemma-divide-by-torsion}
Let $R$ be a ring. Let $I$ be an ideal of $R$. For any $R$-module $M$
set $M[I^\infty] = \bigcup_{n \geq 1} M[I^n]$.
If $I$ is finitely generated, then $(M/M[I^\infty])[I] = 0$.
\end{lemma}

\begin{proof}
Let $m \in M$. If $m$ maps to an element of $(M/M[I^\infty])[I]$
then $Im \subset M[I^\infty]$.
Write $I = (f_1, \ldots, f_t)$. Then we see that
$f_i m \in M[I^\infty]$, i.e., $I^{n_i}f_i m = 0$ for some $n_i > 0$.
Thus we see that $I^Nm = 0$ with $N = \sum n_i + 2$.
Hence $m$ maps to zero in $(M/M[I^\infty])$ which proves the lemma.
\end{proof}

\begin{lemma}
\label{lemma-neighbourhood-equivalence}
Assume $\varphi : R \to S$ is a flat ring map and $I \subset R$ is a
finitely generated ideal such that $R/I \to S/IS$ is an isomorphism. Then
\begin{enumerate}
\item for any $R$-module $M$ the map $M \to M \otimes_R S$ induces
an isomorphism
$M[I^\infty] \to (M \otimes_R S)[(IS)^\infty]$ of $I$-power
torsion submodules,
\item the natural map
$$
\text{Hom}_R(M, N) \longrightarrow \text{Hom}_S(M \otimes_R S, N \otimes_R S)
$$
is an isomorphism if either $M$ or $N$ is $I$-power torsion, and
\item the base change functor $M \mapsto M \otimes_R S$ defines an
equivalence of categories between $I$-power torsion modules
and $IS$-power torsion modules.
\end{enumerate}
\end{lemma}

\begin{proof}
Note that the equivalent conditions of both
Lemma \ref{lemma-characterize-flatness-on-torsion} and
Lemma \ref{lemma-neighbourhood-isomorphism}
are satisfied. We will use these without further mention.
We first prove (1). Let $M$ be any $R$-module.
Set $M' = M/M[I^\infty]$ and consider the exact sequence
$$
0 \to M[I^\infty] \to M \to M' \to 0
$$
As $M[I^\infty] = M[I^\infty] \otimes_R S$ we see that it suffices to
show that $(M' \otimes_R S)[(IS)^\infty] = 0$.
Write $I = (f_1, \ldots, f_t)$. By
Lemma \ref{lemma-divide-by-torsion}
we see that $M'[I^\infty] = 0$. Hence for every $n > 0$ the map
$$
M' \longrightarrow \bigoplus\nolimits_{i = 1, \ldots t} M',
\quad
x \longmapsto (f_1^n x, \ldots, f_t^n x)
$$
is injective. As $S$ is flat over $R$ also the corresponding map
$M' \otimes_R S \to \bigoplus_{i = 1, \ldots t} M' \otimes_R S$
is injective. This means that $(M' \otimes_R S)[I^n] = 0$ as desired.

\medskip\noindent
Next we prove (2). If $N$ is $I$-power torsion, then
$N \otimes_R S = N$ and the displayed map of (2) is an isomorphism by
Algebra, Lemma \ref{algebra-lemma-adjoint-tensor-restrict}.
If $M$ is $I$-power torsion, then the image of any map
$M \to N$ factors through $M[I^\infty]$ and the image of any map
$M \otimes_R S \to N \otimes_R S$ factors through
$(N \otimes_R S)[(IS)^\infty]$. Hence in this case
part (1) guarantees that we may replace $N$ by $N[I^\infty]$
and the result follows from the case where $N$ is $I$-power torsion
we just discussed.

\medskip\noindent
Next we prove (3). The functor is fully faithful by (2).
For essential surjectivity, we simply note that for any $IS$-power torsion
$S$-module $N$, the natural map $N \otimes_R S \to N$ is an isomorphism.
\end{proof}

\begin{lemma}
\label{lemma-naive-Koszul-complex}
Let $R$ be a ring. Let $I = (f_1, \ldots, f_n)$ be a finitely generated ideal
of $R$. Let $M$ be the $R$-module generated by elements
$e_1, \ldots, e_n$ subject to the relations $f_i e_j - f_j e_i = 0$.
There exists a short exact sequence
$$
0 \to K \to M \to I \to 0
$$
such that $K$ is annihilated by $I$.
\end{lemma}

\begin{proof}
This is just a truncation of the Koszul complex, see (insert future
reference here).
The map $M \to I$ is is determined by the rule $e_i \mapsto f_i$. If
$m = \sum a_i e_i$ is in the kernel of $M \to I$, i.e., $\sum a_i f_i = 0$,
then $f_j m = \sum f_j a_i e_i = (\sum f_i a_i) e_j = 0$.
\end{proof}

\begin{lemma}
\label{lemma-explicit-ext}
Let $R$ be a ring. Let $I = (f_1, \ldots, f_n)$ be a finitely generated ideal
of $R$. For any $R$-module $N$ set
$$
H_1(N, f_\bullet) =
\frac{\{(x_1, \ldots, x_n) \in N^{\oplus n} \mid f_i x_j = f_j x_i \}}
{\{f_1x, \ldots, f_nx) \mid x \in N\}}
$$
For any $R$-module $N$ there exists a canonical short exact sequence
$$
0 \to \text{Ext}_R(R/I, N) \to H_1(N, f_\bullet) \to \text{Hom}_R(K, N)
$$
where $K$ is as in
Lemma \ref{lemma-naive-Koszul-complex}.
\end{lemma}

\begin{proof}
The notation above indicates the $\text{Ext}$-groups in $\text{Mod}_R$
as defined in
Homology, Section \ref{homology-section-extensions}.
These are denoted $\text{Ext}_R(M, N)$. Using the long exact sequence of
Homology, Lemma \ref{homology-lemma-six-term-sequence-ext}
associated to the short exact sequence $0 \to I \to R \to R/I \to 0$
and the fact that $\text{Ext}_R(R, N) = 0$ we see that
$$
\text{Ext}_R(R/I, N) =
\text{Coker}(N \longrightarrow \text{Hom}(I, N))
$$
Using the short exact sequence of
Lemma \ref{lemma-naive-Koszul-complex}
we see that we get a complex
$$
N \to \text{Hom}(M, N) \to \text{Hom}_R(K, N)
$$
whose homology in the middle is canonically isomorphic to
$\text{Ext}_R(R/I, N)$. The proof of the lemma is now complete
as the cokernel of the first map
is canonically isomorphic to $H_1(N, f_\bullet)$.
\end{proof}

\begin{lemma}
\label{lemma-koszul-homology-annihilated}
Let $R$ be a ring. Let $I = (f_1, \ldots, f_n)$ be a finitely generated ideal
of $R$. For any $R$-module $N$ the Koszul homology group
$H_1(N, f_\bullet)$ defined in
Lemma \ref{lemma-explicit-ext}
is annihilated by $I$.
\end{lemma}

\begin{proof}
Let $(x_1, \ldots, x_n) \in N^{\oplus n}$ with $f_i x_j = f_j x_i$.
Then we have $f_i(x_1, \ldots, x_n) = (f_i x_i, \ldots, f_i x_n)$.
In other words $f_i$ annihilates $H_1(N, f_\bullet)$.
\end{proof}

\noindent
We can improve on the full faithfulness of
Lemma \ref{lemma-neighbourhood-equivalence}
by showing that $\text{Ext}$-groups whose source is $I$-power torsion
are insensitive to passing to $S$ as well. See
Remark \ref{remark-neighbourhood-extensions}
below for a more highbrow version of the following lemma.

\begin{lemma}
\label{lemma-neighbourhood-extensions}
Assume $\varphi : R \to S$ is a flat ring map and $I \subset R$ is a
finitely generated ideal such that $R/I \to S/IS$ is an isomorphism.
Let $M$, $N$ be $R$-modules. Assume $M$ is $I$-power torsion.
Given an short exact sequence
$$
0 \to N \otimes_R S \to \tilde E \to M \otimes_R S \to 0
$$
there exists a commutative diagram
$$
\xymatrix{
0 \ar[r] &
N \ar[r] \ar[d] &
E \ar[r] \ar[d] &
M \ar[r] \ar[d] &
0 \\
0 \ar[r] &
N \otimes_R S \ar[r] &
\tilde E \ar[r] &
M \otimes_R S \ar[r] &
0
}
$$
with exact rows.
\end{lemma}

\begin{proof}
As $M$ is $I$-power torsion we see that $M \otimes_R S = M$, see
Lemma \ref{lemma-neighbourhood-isomorphism}.
We will use this identification without further mention.
As $R \to S$ is flat, the base change functor is exact and we
obtain a functorial map of $\text{Ext}$-groups
$$
\text{Ext}_R(M, N)
\longrightarrow
\text{Ext}_S(M \otimes_R S, N \otimes_R S),
$$
see
Homology, Lemma \ref{homology-lemma-exact-functor-ext}.
The claim of the lemma is that this map is surjective when
$M$ is $I$-power torsion. In fact we will show that it is an
isomorphism. By
Lemma \ref{lemma-I-power-torsion-presentation}
we can find a surjection $M' \to M$ with $M'$ a direct sum of
modules of the form $R/I^n$. Using the long exact sequence of
Homology, Lemma \ref{homology-lemma-six-term-sequence-ext}
we see that it suffices to prove the lemma for $M'$.
Using compatibility of $\text{Ext}$ with direct sums (details omitted)
we reduce to the case where $M = R/I^n$ for some $n$.

\medskip\noindent
Let $f_1, \ldots, f_t$ be generators for $I^n$. By
Lemma \ref{lemma-explicit-ext}
we have a commutative diagram
$$
\xymatrix{
0 \ar[r] &
\text{Ext}_R(R/I^n, N) \ar[r] \ar[d] &
H_1(N, f_\bullet) \ar[r] \ar[d] &
\text{Hom}_R(K, N) \ar[d] \\
0 \ar[r] &
\text{Ext}_S(S/I^nS, N \otimes S) \ar[r] &
H_1(N \otimes S, f_\bullet) \ar[r] &
\text{Hom}_S(K \otimes S, N \otimes S)
}
$$
with exact rows where $K$ is as in
Lemma \ref{lemma-naive-Koszul-complex}.
Hence it suffices to prove that the two right vertical arrows are
isomorphisms. Since $K$ is annihilated by $I^n$ we see that
$\text{Hom}_R(K, N) = \text{Hom}_S(K \otimes_R S, N \otimes_R S)$ by
Lemma \ref{lemma-neighbourhood-equivalence}.
As $R \to S$ is flat we have
$H_1(N, f_\bullet) \otimes_R S = H_1(N \otimes_R S, f_\bullet)$.
As $H_1(N, f_\bullet)$ is annihilated by $I^n$, see
Lemma \ref{lemma-koszul-homology-annihilated}
we have $H_1(N, f_\bullet) \otimes_R S = H_1(N, f_\bullet)$ by
Lemma \ref{lemma-neighbourhood-isomorphism}.
\end{proof}

\begin{remark}
\label{remark-neighbourhood-extensions}
Assume $\varphi : R \to S$ is a flat ring map and $I \subset R$ is a
finitely generated ideal such that $R/I \to S/IS$ is an isomorphism.
Let $M$, $N$ be $R$-modules and assume $M$ is $I$-power torsion.
Then the canonical map
$$
\text{Ext}^i_R(M, N)
\longrightarrow
\text{Ext}^i_S(M \otimes_R S, N \otimes_R S)
$$
is an isomorphism for all $i$. We sketch a proof of this strengthening of
Lemma \ref{lemma-neighbourhood-extensions}.
Consider the Koszul complex $K_\bullet = K_\bullet(R, f_\bullet)$ which is
the complex
$$
0 \to \wedge^n R^n \to \wedge^{n-1} R^n \to
\ldots \to \wedge^i R^n \to \ldots \to R^n \to R \to 0
$$
where the last term $R$ is placed in degree $0$ with maps given by
$$
e_{j_1} \wedge \ldots \wedge e_{j_i}
\longmapsto
\sum\nolimits_{a = 1}^i (-1)^{i + 1} f_{j_a} e_{j_1} \wedge \ldots
\wedge \hat e_{j_a} \wedge \ldots \wedge e_{j_i}
$$
Then $H_0(K_\bullet) = R/I$ and every homology module $H_i(K_\bullet)$
is annihilated by $I$. Having said this, we prove the statement
on $\text{Ext}$-groups by induction on $i$. The case $i = 0$ is
Lemma \ref{lemma-neighbourhood-equivalence}.
Assume that the result holds for all $i \leq i_0$ and all modules
$N$, $M$ with $M$ being $I$-power torsion. Pick a pair of modules
$N$ and $M$ with $M$ being $I$-power torsion and let's prove that
the map
$\text{Ext}^{i_0 + 1}_R(M, N) \to
\text{Ext}^{i_0 + 1}_S(M \otimes_R S, N \otimes_R S)$
is an isomorphism. By
Lemma \ref{lemma-I-power-torsion-presentation}
and the long exact sequence of $\text{Ext}$-groups and compatibility of
$\text{Ext}$ with direct sums we reduce to the case that $M = R/I^n$.
Since $I^n$ is finitely generated we can choose finitely many generators
$f_1, \ldots, f_t \in I^n$ and consider the Koszul complex
$K_\bullet = K_\bullet(R, f_\bullet)$. Note that
$K_\bullet \otimes_R S = K_\bullet(S, f_\bullet)$.
As $K_\bullet$ is a finite complex of finite free $R$-modules we
see that the map
\begin{equation}
\label{equation-comparison}
\text{Hom}_R(K_\bullet, N) \otimes_R S
\longrightarrow
\text{Hom}_S(K_\bullet \otimes_R S, N \otimes_R S)
\end{equation}
is an isomorphism of complexes. As $R \to S$ is flat and using
Lemmas \ref{lemma-neighbourhood-equivalence}
we see that
$$
H_b(K_\bullet) = H_b(K_\bullet) \otimes_R S = H_b(K_\bullet \otimes_R S).
$$
Below we will use the spectral sequences
\begin{align*}
E(R)_2^{a, b} = \text{Ext}^a_R(H_b(K_\bullet), N)
& \Rightarrow
H^{a + b}(\text{Hom}_R(K_\bullet, N)), \\
E(S)_2^{a, b} = \text{Ext}^a_R(H_b(K_\bullet \otimes_R S), N \otimes_R S)
& \Rightarrow
H^{a + b}(\text{Hom}_R(K_\bullet \otimes_R S, N \otimes_R S))
\end{align*}
see (insert future reference here).
The first one combined with the fact that each $H_b(K_\bullet)$
is annihilated by $I^n$ implies that $H^c(\text{Hom}_R(K_\bullet, N))$
is annihilated by $I^{n(t + 1)}$. Hence using
Lemma \ref{lemma-neighbourhood-equivalence}
once more we see that
$$
H^c(\text{Hom}_R(K_\bullet, N)) =
H^c(\text{Hom}_R(K_\bullet, N)) \otimes_R S =
H^c(\text{Hom}_S(K_\bullet \otimes_R S, N \otimes_R S))
$$
because (\ref{equation-comparison}) is an isomorphism and $R \to S$ is flat.
Combined we see that the map $E(R)_r^{a, b} \to E(S)_r^{a, b}$ of spectral
sequences is an isomorphism for $r = 2$ and $a \leq i_0$ (induction hypothesis)
and an isomorphism on abutments in all degrees.
Then a formal argument on spectral sequences (insert future
reference here) implies that
$E(R)_2^{i_0 + 1, 0} \to E(R)_2^{i_0 + 1, 0}$
is an isomorphism as well, which is the result we wanted to prove.
This ends the sketch of the proof of the result on $\text{Ext}$-groups;
if we ever need to use this result in the stacks project we will put in
a detailed proof.
\end{remark}

\noindent
Let $R \to S$ be a ring map.
Let $f_1, \ldots, f_t \in R$ and $I = (f_1, \ldots, f_t)$.
Then for any $R$-module $M$ we can define a complex
\begin{equation}
\label{equation-glueing-complex}
0 \to M \xrightarrow{\alpha}
M \otimes_R S \times \prod M_{f_i} \xrightarrow{\beta}
\prod (M \otimes_R S)_{f_i}
\times
\prod M_{f_if_j}
\end{equation}
where $\alpha(m) = (m \otimes 1, m/1, \ldots, m/1)$ and
$$
\beta(m', m_1, \ldots, m_t) =
((m'/1 - m_1 \otimes 1, \ldots, m'/1 - m_t \otimes 1),
(m_1 - m_2, \ldots, m_{t - 1} - m_t).
$$
We would like to know when this complex is exact.

\begin{lemma}
\label{lemma-recover-module-from-glueing-data}
Assume $\varphi : R \to S$ is a flat ring map and
$I = (f_1, \ldots, f_t) \subset R$ is an ideal such that
$R/I \to S/IS$ is an isomorphism.
Let $M$ be an $R$-module. Then the
complex (\ref{equation-glueing-complex})
is exact.
\end{lemma}

\begin{proof}
Let $m \in M$. If $\alpha(m) = 0$, then $m \in M[I^\infty]$, see
Lemma \ref{lemma-torsion-free}. Pick $n$ such that $I^n m = 0$
and consider the map $\varphi : R/I^n \to M$.
If $m \otimes 1 = 0$, then $\varphi \otimes 1_S = 0$, hence
$\varphi = 0$ (see
Lemma \ref{lemma-neighbourhood-equivalence})
hence $m = 0$. In this way we see that $\alpha$ is injective.

\medskip\noindent
Let $(m', m'_1, \ldots, m'_t) \in \text{Ker}(\beta)$.
Write $m'_i = m_i/f_i^n$ for some $n > 0$ and $m_i \in M$.
We may, after possibly enlarging $n$ assume that
$f_i^n m' = m_i \otimes 1$ in $M \otimes_R S$ and
$f_j^nm_i - f_i^nm_j = 0$ in $M$.
In particular we see that
$(m_1, \ldots, m_t)$ defines an element $\xi$ of
$H_1(M, (f_1^n, \ldots, f_t^n))$.
Since $H_1(M, (f_1^n, \ldots, f_t^n))$ is annihilated by $I^{tn + 1}$ (see
Lemma \ref{lemma-koszul-homology-annihilated})
and since $R \to S$ is flat we see that
$$
H_1(M, (f_1^n, \ldots, f_t^n)) =
H_1(M, (f_1^n, \ldots, f_t^n)) \otimes_R S =
H_1(M \otimes_R S, (f_1^n, \ldots, f_t^n))
$$
by
Lemma \ref{lemma-neighbourhood-isomorphism}
The existence of $m'$ implies that $\xi$ maps to zero in the last group, i.e.,
the element $\xi$ is zero. Thus there exists an $m \in M$ such that
$m_i = f_i^n m$. Then $(m', m'_1, \ldots, m'_t) - \alpha(m)
= (m'', 0, \ldots, 0)$ for some $m'' \in (M \otimes_R S)[(IS)^\infty]$.
By
Lemma \ref{lemma-neighbourhood-equivalence}
we conclude that $m'' \in M[I^\infty]$ and we win.
\end{proof}

\begin{remark}
\label{remark-glueing-data}
In this remark we define a category of glueing data.
Let $R \to S$ be a ring map.
Let $f_1, \ldots, f_t \in R$ and $I = (f_1, \ldots, f_t)$.
Consider the category $\text{Glue}(R \to S, f_1, \ldots, f_t)$
as the category whose
\begin{enumerate}
\item objects are systems $(M', M_i, \alpha_i, \alpha_{ij})$, where
$M'$ is an $S$-module, $M_i$ is an $R_{f_i}$-module,
$\alpha_i : (M')_{f_i} \to M_i \otimes_R S$ is an isomorphism, and
$\alpha_{ij} : (M_i)_{f_j} \to (M_j)_{f_i}$ are isomorphisms
such that
\begin{enumerate}
\item $\alpha_{ij} \circ \alpha_i = \alpha_j$ as maps
$(M')_{f_if_j} \to (M_j)_{f_i}$, and
\item $\alpha_{jk} \circ \alpha_{ij} = \alpha_{ik}$ as maps
$(M_i)_{f_jf_k} \to (M_k)_{f_if_j}$ (cocycle condition).
\end{enumerate}
\item morphisms
$(M', M_i, \alpha_i, \alpha_{ij}) \to (N', N_i, \beta_i, \beta_{ij})$
are given by maps $\varphi' : M' \to N'$ and $\varphi_i : M_i \to N_i$
compatible with the given maps $\alpha_i, \beta_i, \alpha_{ij}, \beta_{ij}$.
\end{enumerate}
There is a canonical functor
$$
\text{Can} : \text{Mod}_R
\longrightarrow
\text{Glue}(R \to S, f_1, \ldots, f_t),
\quad
M \longmapsto (M \otimes_R S, M_{f_i}, \text{can}_i, \text{can}_{ij})
$$
where $\text{can}_i : (M \otimes_R S)_{f_i} \to M_{f_i} \otimes_R S$
and $\text{can}_{ij} : (M_{f_i})_{f_j} \to (M_{f_j})_{f_i}$
are the canonical isomorphisms. For any object
$\mathbf{M} = (M', M_i, \alpha_i, \alpha_{ij})$ of the category
$\text{Glue}(R \to S, f_1, \ldots, f_t)$ we define
$$
H^0(\mathbf{M}) =
\{(m', m_i) \mid \alpha_i(m') = m_i \otimes 1, \alpha_{ij}(m_i) = m_j\}
$$
in other words defined by the exact sequence
$$
0 \to H^0(\mathbf{M}) \to
M' \times \prod M_i \to
\prod M'_{f_i}
\times
\prod (M_i)_{f_j}
$$
similar to (\ref{equation-glueing-complex}).
We think of $H^0(\mathbf{M})$ as an $R$-module. Thus we also get a functor
$$
H^0 : 
\text{Glue}(R \to S, f_1, \ldots, f_t)
\longrightarrow
\text{Mod}_R
$$
Our next goal is to show that the functors
$\text{Can}$ and $H^0$ are sometimes quasi-inverse to each other.
\end{remark}

\begin{lemma}
\label{lemma-H0-inverse}
Assume $\varphi : R \to S$ is a flat ring map and
$I = (f_1, \ldots, f_t) \subset R$ is an ideal such that
$R/I \to S/IS$ is an isomorphism. Then the functor $H^0$
is a left quasi-inverse to the functor $\text{Can}$ of
Remark \ref{remark-glueing-data}.
\end{lemma}

\begin{proof}
This is a reformulation of
Lemma \ref{lemma-recover-module-from-glueing-data}.
\end{proof}

\begin{lemma}
\label{lemma-exact}
Assume $\varphi : R \to S$ is a flat ring map and let
$I = (f_1, \ldots, f_t) \subset R$ be an ideal.
Then $\text{Glue}(R \to S, f_1, \ldots, f_t)$ is an abelian category, and
the functor $\text{Can}$ is exact and commutes with arbitrary colimits.
\end{lemma}

\begin{proof}
Given a morphism
$(\varphi', \varphi_i) :
(M', M_i, \alpha_i, \alpha_{ij})
\to
(N', N_i, \beta_i, \beta_{ij})$
of the category $\text{Glue}(R \to S, f_1, \ldots, f_t)$
we see that its kernel exists and is equal to the object
$(\text{Ker}(\varphi'), \text{Ker}(\varphi_i), \alpha_i, \alpha_{ij})$
and its cokernel exists and is equal to the object
$(\text{Coker}(\varphi'), \text{Coker}(\varphi_i), \beta_i, \beta_{ij})$.
This works because $R \to S$ is flat, hence taking kernels/cokernels
commutes with $- \otimes_R S$. Details omitted.
The exactness follows from the $R$-flatness of $R_{f_i}$ and $S$, while
commuting with colimits follows as tensor products commute with colimits.
\end{proof}

\begin{lemma}
\label{lemma-equivalence-I-unit}
Let $\varphi : R \to S$ be a flat ring map and $(f_1, \ldots, f_t) = R$.
Then $\text{Can}$ and $H^0$ are quasi-inverse equivalences of categories
$$
\text{Mod}_R = \text{Glue}(R \to S, f_1, \ldots, f_t)
$$
\end{lemma}

\begin{proof}
Consider an object $\mathbf{M} = (M', M_i, \alpha_i, \alpha_{ij})$
of $\text{Glue}(R \to S, f_1, \ldots, f_t)$. By
Algebra, Lemma \ref{algebra-lemma-glue-modules}
there exists a unique module $M$ and isomorphisms
$M_{f_i} \to M_i$ which recover the glueing data $\alpha_{ij}$.
Then both $M'$ and $M \otimes_R S$ are $S$-modules
which recover the modules $M_i \otimes_R S$ upon localizing at $f_i$.
Whence there is a canonical isomorphism $M \otimes_R S \to M'$.
This shows that $\mathbf{M}$ is in the essential image of $\text{Can}$.
Combined with
Lemma \ref{lemma-H0-inverse}
the lemma follows.
\end{proof}

\begin{lemma}
\label{lemma-base-change-glue}
Let $\varphi : R \to S$ be a flat ring map and $I = (f_1, \ldots, f_t)$
and ideal. Let $R \to R'$ be a flat ring map, and set $S' = S \otimes_R R'$.
Then we obtain a commutative diagram of categories and functors
$$
\xymatrix{
\text{Mod}_R \ar[r]_-{\text{Can}} \ar[d]_{-\otimes_R R'} &
\text{Glue}(R \to S, f_1, \ldots, f_t) \ar[r]_-{H^0} \ar[d]^{-\otimes_R R'} &
\text{Mod}_R \ar[d]^{-\otimes_R R'} \\
\text{Mod}_{R'} \ar[r]^-{\text{Can}} &
\text{Glue}(R' \to S', f_1, \ldots, f_t) \ar[r]^-{H^0} &
\text{Mod}_{R'}
}
$$
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{proposition}
\label{proposition-equivalence}
Assume $\varphi : R \to S$ is a flat ring map and
$I = (f_1, \ldots, f_t) \subset R$ is an ideal such that
$R/I \to S/IS$ is an isomorphism. Then $\text{Can}$ and
$H^0$ are quasi-inverse equivalences of categories
$$
\text{Mod}_R = \text{Glue}(R \to S, f_1, \ldots, f_t)
$$
\end{proposition}

\begin{proof}
We have already seen that $H^0 \circ \text{Can}$ is isomorphic to the
identity functor, see
Lemma \ref{lemma-H0-inverse}.
Consider an object $\mathbf{M} = (M', M_i, \alpha_i, \alpha_{ij})$
of $\text{Glue}(R \to S, f_1, \ldots, f_t)$.
We get a natural morphism
$$
\Psi :
(H^0(\mathbf{M}) \otimes_R S, H^0(\mathbf{M})_{f_i},
\text{can}_i, \text{can}_{ij})
\longrightarrow
(M', M_i, \alpha_i, \alpha_{ij}).
$$
Namely, by definition $H^0(\mathbf{M})$ comes equipped with compatible
$R$-module maps $H^0(\mathbf{M}) \to M'$ and $H^0(\mathbf{M}) \to M_i$.
We have to show that this map is an isomorphism.

\medskip\noindent
Pick an index $i$ and set $R' = R_{f_i}$. Combining
Lemmas \ref{lemma-base-change-glue} and \ref{lemma-equivalence-I-unit}
we see that $\Psi \otimes_R R'$ is an isomorphism.
Hence the kernel, resp.\ cokernel of $\Psi$ is a system of the form
$(K, 0, 0, 0)$, resp.\ $(Q, 0, 0, 0)$. Note that
$H^0((K, 0, 0, 0)) = K$, that $H^0$ is left exact, and that by
construction $H^0(\Psi)$ is bijective. Hence we see $K = 0$, i.e.,
the kernel of $\Psi$ is zero.

\medskip\noindent
The conclusion of the above is that we obtain a short exact sequence
$$
0 \to H^0(\mathbf{M}) \otimes_R S \to M' \to Q \to 0
$$
and that $M_i = H^0(\mathbf{M})_{f_i}$.
Note that we may think of $Q$ as an $R$-module which is $I$-power
torsion so that $Q = Q \otimes_R S$. By
Lemma \ref{lemma-neighbourhood-extensions}
we see that there exists a commutative diagram
$$
\xymatrix{
0 \ar[r] &
H^0(\mathbf{M}) \ar[r] \ar[d] &
E \ar[r] \ar[d] &
Q \ar[r] \ar[d] &
0 \\
0 \ar[r] &
H^0(\mathbf{M}) \otimes_R S \ar[r] &
M' \ar[r] &
Q \ar[r] &
0
}
$$
with exact rows. This clearly determines an isomorphism
$\text{Can}(E) \to (M', M_i, \alpha_i, \alpha_{ij})$
in the category $\text{Glue}(R \to S, f_1, \ldots, f_t)$
and we win. (Of course, a posteriori we have $Q = 0$.)
\end{proof}

\noindent
Next, we specialize this very general proposition to get something
more useable. Namely, if $I = (f)$ is a principal ideal then the objects
of $\text{Glue}(R \to S, f)$ are simply triples $(M', M_1, \alpha_1)$
and there is {\it no} cocycle condition to check!

\begin{theorem}
\label{theorem-formal-glueing}
Let $R$ be a ring, and let $f \in R$.
Let $\varphi : R \to S$ be a flat ring map inducing an isomorphism
$R/fR \to S/fS$. Then the functor
$$
\text{Mod}_R
\longrightarrow
\text{Mod}_S \times_{\text{Mod}_{S_f}} \text{Mod}_{R_f},
\quad
M
\longmapsto
(M \otimes_R S, M_f, \text{can})
$$
is an equivalence.
\end{theorem}

\begin{proof}
The category appearing on the right side of the arrow
is the category of triples $(M', M_1, \alpha_1)$ where $M'$ is an
$S$-module, $M_1$ is a $R_f$-module, and
$\alpha_1 : M'_f \to M_1 \otimes_R S$ is a $S_f$-isomorphism, see
Categories, Example \ref{categories-example-2-fibre-product-categories}.
Hence this theorem is a special case of
Proposition \ref{proposition-equivalence}.
\end{proof}

\noindent
A useful special case of
Theorem \ref{theorem-formal-glueing}
is when $R$ is noetherian, and $S$ is a completion of $R$ at an
element $f$. The completion $R \to S$ is flat, and the functor
$M \mapsto M \otimes_R S$ can be identified with the $f$-adic
completion functor when $M$ is finitely generated. To state
this more precisely, let $\text{Mod}_{fg}(R)$ denote the category
of finitely generated $R$-modules.

\begin{proposition}
\label{proposition-formal-glueing}
Let $R$ be a noetherian ring.
Let $f \in R$ be an element.
Let $R^\wedge$ be the $f$-adic completion of $R$.
Then the functor $M \mapsto (M^\wedge, M_f, \text{can})$
defines an equivalence
$$
\text{Mod}_{fg}(R)
\longrightarrow
\text{Mod}_{fg}(R^\wedge)
\times_{\text{Mod}_{fg}(R^\wedge_f)} 
\text{Mod}_{fg}(R_f)
$$
\end{proposition}

\begin{proof}
The ring map $R \to R^\wedge$ is flat by
Algebra, Lemma \ref{algebra-lemma-completion-flat}.
It is clear that $R/fR = R^\wedge/fR^\wedge$.
By
Algebra, Lemma \ref{algebra-lemma-completion-tensor}
the completion of a finite $R$-module $M$ is equal to $M \otimes_R R^\wedge$.
Hence the displayed functor of the proposition is equal to the
functor occuring in
Theorem \ref{theorem-formal-glueing}.
In particular it is fully faithful. Let $(M_1, M_2, \psi)$ be an
object of the right hand side. By
Theorem \ref{theorem-formal-glueing}
there exists an $R$-module $M$ such that
$M_1 = M \otimes_R R^\wedge$ and $M_2 = M_f$. As $R \to R^\wedge \times R_f$
is faithfully flat we conclude from
Algebra, Lemma \ref{algebra-lemma-cover}
that $M$ is finitely generated, i.e., $M \in \text{Mod}_{fg}(R)$.
This proves the proposition.
\end{proof}

\begin{remark}
\label{remark-formal-glueing-algebras}
The equivalences of
Propostion \ref{proposition-equivalence},
Theorem \ref{theorem-formal-glueing}, and
Proposition \ref{proposition-formal-glueing}
preserve the $\otimes$-structures on either side.
Thus, it defines equivalences of various categories
built out of the pair $(\text{Mod}_R,\otimes)$, such as the category of 
$R$-algebras.
\end{remark}

\begin{remark}
\label{remark-topological-analogue}
Given a differential manifold $X$ with a compact closed submanifold $Z$
having complement $U$, specifying a sheaf on $X$ is the same as specifying 
a sheaf on $U$, a sheaf on an unspecified tubular neighbourhood $T$ of $Z$ in 
$X$, and an isomorphism between the two resulting sheaves along $T \cap U$.
Tubular neighbourhoods do not exist in algebraic geometry as such, but
results such as
Propostion \ref{proposition-equivalence},
Theorem \ref{theorem-formal-glueing}, and
Proposition \ref{proposition-formal-glueing}
allow us to work with formal neighbourhoods instead.
\end{remark}



\section{Auto-associated rings}
\label{section-auto-ass}

\noindent
Some of this material is in \cite{Autour}.

\begin{definition}
\label{definition-auto-ass}
A ring $R$ is said to be {\it auto-associated} if $R$ is local and its
maximal ideal $\mathfrak m$ is weakly associated to $R$.
\end{definition}

\begin{lemma}
\label{lemma-auto-ass-implies-P}
An auto-associated ring $R$ has the following property: (P)
Every proper finitely generated ideal $I \subset R$ has a nonzero
annihilator.
\end{lemma}

\begin{proof}
By assumption there exists a nonzero element $x \in R$ such that for every
$f \in \mathfrak m$ we have $f^n x = 0$. Say $I = (f_1, \ldots, f_r)$.
Then $x$ is in the kernel of $R \to \bigoplus R_{f_i}$. Hence we see
that there exists a nonzero $y \in R$ such that $f_i y = 0$ for all $i$, see
Algebra, Lemma \ref{algebra-lemma-when-injective-covering}.
As $y \in \text{Ann}_R(I)$ we win.
\end{proof}

\begin{lemma}
\label{lemma-P-universally-injective}
Let $R$ be a ring having property (P) of
Lemma \ref{lemma-auto-ass-implies-P}.
Let $u : N \to M$ be a homomorphism of projective $R$-modules.
Then $u$ is universally injective if and only if $u$ is injective.
\end{lemma}

\begin{proof}
Assume $u$ is injective. Our goal is to show $u$ is universally injective.
First we choose a module $Q$ such that $N \oplus Q$ is free. On considering
the map $N \oplus Q \to M \oplus Q$ we see that it suffices to prove
the lemma in case $N$ is free. In this case $N$ is a directed colimit of
finite free $R$-modules. Thus we reduce to the case that $N$ is a finite
free $R$-module, say $N = R^{\oplus n}$. We prove the lemma by induction
on $n$. The case $n = 0$ is trivial.

\medskip\noindent
Let $u : R^{\oplus n} \to M$ be an injective module map with $M$ projective.
Choose an $R$-module $Q$ such that $M \oplus Q$ is free. After replacing
$u$ by the composition $R^{\oplus n} \to M \to M \oplus Q$ we see that
we may assume that $M$ is free. Then we can find a direct summand
$R^{\oplus m} \subset M$ such that $u(R^{\oplus n}) \subset R^{\oplus m}$.
Hence we may assume that $M = R^{\oplus m}$.
In this case $u$ is given by a matrix $A = (a_{ij})$ so that
$u(x_1, \ldots, x_n) = (\sum x_i a_{i1}, \ldots, \sum x_i a_{im})$.
As $u$ is injective, in particular
$u(x, 0, \ldots, 0) = (xa_{11}, xa_{12}, \ldots, xa_{1m}) \not = 0$ if
$x \not = 0$, and as $R$ has property (P) we see that
$a_{11}R + a_{12}R + \ldots + a_{1m}R = R$. Hence see that
$R(a_{11}, \ldots, a_{1m}) \subset R^{\oplus m}$ is a direct summand
of $R^{\oplus m}$, in particular $R^{\oplus m}/R(a_{11}, \ldots, a_{1m})$
is a projective $R$-module. We get a commutative diagram
$$
\xymatrix{
0 \ar[r] &
R \ar[rr] \ar[d]^1 & & R^{\oplus n} \ar[r] \ar[d]^u &
R^{\oplus n - 1} \ar[r] \ar[d] & 0 \\
0 \ar[r] & R \ar[rr]^{(a_{11}, \ldots, a_{1m})} & &
R^{\oplus m} \ar[r] & R^{\oplus m}/R(a_{11}, \ldots, a_{1m}) \ar[r] & 0
}
$$
with split exact rows. Thus the right vertical arrow is injective
and we may apply the induction hypothesis to conclude that
the right verical arrow is universally injective. It follows that the
middle vertical arrow is universally injective.
\end{proof}

\begin{lemma}
\label{lemma-P-fPD-zero}
Let $R$ be a ring. The following are equivalent
\begin{enumerate}
\item $R$ has property (P) of
Lemma \ref{lemma-auto-ass-implies-P},
\item any injective map of projective $R$-modules is
universally injective,
\item if $u : N \to M$ is injective and $N$, $M$ are finite projective
$R$-modules then $\text{Coker}(u)$ is a finite projective $R$-module,
\item if $N \subset M$ and $N$, $M$ are finite projective as $R$-modules, then
$N$ is a direct summand of $M$, and
\item any injective map $R \to R^{\oplus n}$ is a split injection.
\end{enumerate}
\end{lemma}

\begin{proof}
The implication (1) $\Rightarrow$ (2) is
Lemma \ref{lemma-P-universally-injective}.
It is clear that (3) and (4) are equivalent.
We have (2) $\Rightarrow$ (3), (4) by
Algebra, Lemma \ref{algebra-lemma-universally-exact-split}.
Part (5) is a special case of (4).
Assume (5). Let $I = (a_1, \ldots, a_n)$ be a proper finitely generated
ideal of $R$. As $I \not = R$ we see that
$R \to R^{\oplus n}$, $x \mapsto (xa_1, \ldots, xa_n)$
is not a split injection. Hence it has a nonzero kernel and we conclude
that $\text{Ann}_R(I) \not = 0$. Thus (1) holds.
\end{proof}

\begin{example}
\label{example-auto-ass-weird-flat}
If the equivalent conditions of
Lemma \ref{lemma-P-fPD-zero}
hold, then it is not always the case that every injective map of
free $R$-modules is a split injection. For example suppose that
$R = k[x_1, x_2, x_3, \ldots]/(x_i^2)$. This is an auto-associated ring.
Consider the map of free $R$-modules
$$
u :
\bigoplus\nolimits_{i \geq 1} Re_i
\longrightarrow
\bigoplus\nolimits_{i \geq 1} Rf_i,\quad
e_i \longmapsto f_i - x_if_{i + 1}.
$$
For any integer $n$ the restriction of $u$ to
$\bigoplus_{i = 1, \ldots, n} Re_i$ is injective as the images
$u(e_1), \ldots, u(e_n)$ are $R$-linearly independent. Hence
$u$ is injective and hence universally injective by the lemma.
Since $u \otimes \text{id}_k$ is bijective we see that if
$u$ were a split injection then $u$ would be surjective. But $u$ is not
surjective because the inverse image of $f_1$ would be the element
$$
\sum\nolimits_{i \geq 0} x_1 \ldots x_ie_{i + 1} =
e_1 + x_1e_2 + x_1x_2e_3 + \ldots
$$
which is not an element of the direct sum. A side remark is that
$\text{Coker}(u)$ is a flat (because $u$ is universally injective),
countably generated $R$-module which is not projective (as $u$ is not
split), hence not Mittag-Leffler (see
Algebra, Lemma \ref{algebra-lemma-countgen-projective}).
\end{example}






\section{Flattening stratification}
\label{section-flattening}

\noindent
We will discuss flattening stratifications for morphisms of schemes in
More on Flatness, Section \ref{flat-section-flattening}.
In this section we prove some basic algebra facts related to this.

\begin{lemma}
\label{lemma-intersection-flat}
Let $R$ be a ring. Let $M$ be an $R$-module. Let $I_1$, $I_2$ be ideals of $R$.
If $M/I_1M$ is flat over $R/I_1$ and $M/I_2M$ is flat over $R/I_2$,
then $M/(I_1 \cap I_2)M$ is flat over $R/(I_1 \cap I_2)$.
\end{lemma}

\begin{proof}
By replacing $R$ with $R/(I_1 \cap I_2)$ and $M$ by $M/(I_1 \cap I_2)M$
we may assume that $I_1 \cap I_2 = 0$. Let $J \subset R$ be an ideal.
To prove that $M$ is flat over $R$ we have to show that
$J \otimes_R M \to M$ is injective, see
Algebra, Lemma \ref{algebra-lemma-flat}.
By flatness of $M/I_1M$ over $R/I_1$ the map
$$
J/(J \cap I_1) \otimes_R M =
(J + I_1)/I_1 \otimes_{R/I_1} M/I_1M
\longrightarrow M/I_1M
$$
is injective. As $0 \to (J \cap I_1) \to J \to J/(J \cap I_1) \to 0$
is exact we obtain a diagram
$$
\xymatrix{
(J \cap I_1) \otimes_R M \ar[r] \ar[d] &
J \otimes_R M \ar[r] \ar[d] &
J/(J \cap I_1) \otimes_R M \ar[r] \ar[d] & 0 \\
M \ar@{=}[r] &
M \ar[r] &
M/I_1M
}
$$
hence it suffices to show that $(J \cap I_1) \otimes_R M \to M$ is
injective. Since $I_1 \cap I_2 = 0$ the ideal $J \cap I_1$
maps isomorphically to an ideal $J' \subset R/I_2$ and we see that
$(J \cap I_1) \otimes_R M = J' \otimes_{R/I_2} M/I_2M$. By flatness
of $M/I_2M$ over $R/I_2$ the map $J' \otimes_{R/I_2} M/I_2M \to M/I_2M$
is injective, which clearly implies that $(J \cap I_1) \otimes_R M \to M$ is
injective.
\end{proof}

\medskip\noindent
Let $R \to S$ be a ring map.
Let $I \subset R$ be an ideal.
Let $M$ be an $S$-module.
In the following we will consider the following condition
\begin{equation}
\label{equation-flat-at-primes-over}
\text{for every prime }\mathfrak q\text{ of }S\text{ containing }IS
\text{ the localization }M_{\mathfrak q}\text{ is flat over }R.
\end{equation}

\begin{lemma}
\label{lemma-base-change-flat-at-primes-over}
Let $R \to S$ be a ring map.
Let $I \subset R$ be an ideal.
Let $M$ be an $S$-module.
Let $R \to R'$ be a ring map.
If (\ref{equation-flat-at-primes-over}) holds for
$(R \to S, I, M)$, then (\ref{equation-flat-at-primes-over})
holds for $(R' \to S \otimes_R R', IR', M \otimes_R R')$.
\end{lemma}

\begin{proof}
Assume (\ref{equation-flat-at-primes-over}) holds for
$(R \to S, I \subset R, M)$.
Let $\mathfrak q'$ be a prime of $S \otimes_R R'$ lying over $IR'$.
Let $\mathfrak q \subset S$ be the corresponding prime of $S$.
Then $IS \subset \mathfrak q$. Note that $(M \otimes_R R')_{\mathfrak q'}$
is a localization of the base change $M_{\mathfrak q} \otimes_R R'$.
Hence $(M \otimes_R R')_{\mathfrak q'}$ is flat over $R'$ as a localization
of a flat module, see
Algebra, Lemmas \ref{algebra-lemma-flat-base-change} and
\ref{algebra-lemma-flat-localization}.
\end{proof}

\begin{lemma}
\label{lemma-flat-module-powers}
Let $R \to S$ be a ring map. Let $I \subset R$ be an ideal.
Let $M$ be an $S$-module. Assume
\begin{enumerate}
\item $R$ is a Noetherian ring,
\item $S$ is a Noetherian ring,
\item $M$ is a finite $S$-module, and
\item for each $n \geq 1$ the module $M/I^n M$ is flat over
$R/I^n$.
\end{enumerate}
Then (\ref{equation-flat-at-primes-over}) holds, i.e.,
for every prime $\mathfrak q$ of $S$ lying over $IS$
the localization $M_{\mathfrak q}$ is flat over $R$.
\end{lemma}

\begin{proof}
We are going to use
Algebra, Lemma \ref{algebra-lemma-variant-local-criterion-flatness}.
By assumption $M/IM$ is flat over $R/I$. Hence it suffices to check
that $\text{Tor}_1^R(M, R/I)$ is zero on localization at $\mathfrak q$. By
Algebra, Remark \ref{algebra-remark-Tor-ring-mod-ideal}
this Tor group is equal to $K = \text{Ker}(I \otimes_R M \to M)$.
We know for each $n \geq 1$ that the kernel
$\text{Ker}(I/I^n \otimes_{R/I^n} M/I^nM \to M/I^nM)$ is zero.
Since there is a module map
$I/I^n \otimes_{R/I^n} M/I^nM \to (I \otimes_R M)/I^{n - 1}(I \otimes_R M)$
we conclude that $K \subset I^{n - 1}(I \otimes_R M)$ for each $n$.
By the Artin-Rees lemma, and more precisely
Algebra, Lemma \ref{algebra-lemma-intersection-powers-ideal-module}
we conclude that $K_{\mathfrak q} = 0$, as desired.
\end{proof}

\begin{lemma}
\label{lemma-flattening-artinian}
Let $R$ be an Artinian ring.
Let $M$ be an $R$-module.
Then there exists a smallest ideal $I \subset R$ such that
$M/IM$ is flat over $R/I$.
\end{lemma}

\begin{proof}
This follows directly from
Lemma \ref{lemma-intersection-flat}
and the Artinian property.
\end{proof}

\noindent
This ideal has the following universal property.

\begin{lemma}
\label{lemma-flattening-artinian-universal-property}
Let $R$ be an Artinian ring. Let $M$ be an $R$-module.
Let $I \subset R$ be the smallest ideal $I \subset R$ such that
$M/IM$ is flat over $R/I$.
Then $I$ has the following universal property:
For every ring map $\varphi : R \to R'$ we have
$$
R' \otimes_R M\text{ is flat over }R'
\Leftrightarrow
\text{we have }\varphi(I) = 0.
$$
\end{lemma}

\begin{proof}
Note that $I$ exists by
Lemma \ref{lemma-flattening-artinian}.
The implication $\Rightarrow$ follows from
Algebra, Lemma \ref{algebra-lemma-flat-base-change}.
Let $\varphi : R \to R'$ be such that $M \otimes_R R'$ is flat over $R'$.
Let $J = \text{Ker}(\varphi)$. By
Algebra,
Lemma \ref{algebra-lemma-descent-flatness-injective-map-artinian-rings}
and as $R' \otimes_R M = R' \otimes_{R/J} M/JM$ is
flat over $R'$ we conclude that $M/JM$ is flat over $R/J$.
Hence $I \subset J$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-flattening-complete-local-noetherian}
Let $R \to S$ be a ring map.
Let $M$ be an $S$-module.
Assume
\begin{enumerate}
\item $(R, \mathfrak m)$ is a complete local Noetherian ring,
\item $S$ is a Noetherian ring, and
\item $M$ is finite over $S$.
\end{enumerate}
Then there exists an ideal $I \subset \mathfrak m$ such that
\begin{enumerate}
\item $(M/IM)_{\mathfrak q}$ is flat over $R/I$ for all
primes $\mathfrak q$ of $S/IS$ lying over $\mathfrak m$, and
\item if $J \subset R$ is an ideal such that $(M/JM)_{\mathfrak q}$
is flat over $R/J$ for all primes $\mathfrak q$ lying over
$\mathfrak m$, then $I \subset J$.
\end{enumerate}
In other words, $I$ is the smallest ideal of $R$ such that
(\ref{equation-flat-at-primes-over}) holds for
$(\overline{R} \to \overline{S}, \overline{\mathfrak m}, \overline{M})$
where $\overline{R} = R/I$, $\overline{S} = S/IS$,
$\overline{\mathfrak m} = \mathfrak m/I$ and $\overline{M} = M/IM$.
\end{lemma}

\begin{proof}
Let $J \subset R$ be an ideal. Apply
Lemma \ref{lemma-flat-module-powers}
to the module $M/JM$ over the ring $R/J$.
Then we see that $(M/JM)_{\mathfrak q}$
is flat over $R/J$ for all primes $\mathfrak q$ of $S/JS$
if and only if $M/(J + \mathfrak m^n)M$ is flat over
$R/(J + \mathfrak m^n)$ for all $n \geq 1$.
We will use this remark below.

\medskip\noindent
For every $n \geq 1$ the local ring $R/\mathfrak m^n$ is Artinian.
Hence, by
Lemma \ref{lemma-flattening-artinian}
there exists a smallest ideal $I_n \supset \mathfrak m^n$ such that
$M/I_nM$ is flat over $R/I_n$. It is clear that $I_{n + 1} + \mathfrak m^n$
is contains $I_n$ and applying
Lemma \ref{lemma-intersection-flat}
we see that $I_n = I_{n + 1} + \mathfrak m^n$. Since
$R = \lim_n\ R/\mathfrak m^n$ we see that $I = \lim_n\ I_n/\mathfrak m^n$
is an ideal in $R$ such that $I_n = I + \mathfrak m^n$ for all $n \geq 1$.
By the initial remarks of the proof we see that $I$ verifies (1)
and (2). Some details omitted.
\end{proof}

\begin{lemma}
\label{lemma-flattening-complete-local-noetherian-property-by-finite-type}
With notation $R \to S$, $M$, and $I$ and assumptions as in
Lemma \ref{lemma-flattening-complete-local-noetherian}.
Consider a local homomorphism of local rings
$\varphi : (R, \mathfrak m) \to (R', \mathfrak m')$
such that $R'$ is Noetherian. Then the following are equivalent
\begin{enumerate}
\item condition (\ref{equation-flat-at-primes-over}) holds
for $(R' \to S \otimes_R R', \mathfrak m', M \otimes_R R')$, and
\item $\varphi(I) = 0$.
\end{enumerate}
\end{lemma}

\begin{proof}
The implication (2) $\Rightarrow$ (1) follows from
Lemma \ref{lemma-base-change-flat-at-primes-over}.
Let $\varphi : R \to R'$ be as in the lemma satisfying (1).
We have to show that $\varphi(I) = 0$.
This is equivalent to the condition that $\varphi(I)R' = 0$.
By Artin-Rees in the Noetherian local ring $R'$ (see
Algebra, Lemma \ref{algebra-lemma-intersect-powers-ideal-module-zero})
this is equivalent to the condition that
$\varphi(I)R' + (\mathfrak m')^n = (\mathfrak m')^n$ for all $n > 0$.
Hence this is equivalent to the condition that the composition
$\varphi_n : R \to R' \to R'/(\mathfrak m')^n$ annihilates $I$ for each $n$.
Now assumption (1) for $\varphi$ implies assumption (1) for
$\varphi_n$ by
Lemma \ref{lemma-base-change-flat-at-primes-over}.
This reduces us to the case where $R'$ is Artininian.

\medskip\noindent
Assume $R'$ Artinian. Let $J = \text{Ker}(\varphi)$. We have to show that
$I \subset J$. By the construction of $I$ in
Lemma \ref{lemma-flattening-complete-local-noetherian}
it suffices to show that $(M/JM)_{\mathfrak q}$ is flat over $R/J$
for every prime $\mathfrak q$ of $S/JS$ lying over $\mathfrak m$.
As $R'$ is Artinian, condition (1) signifies that $M \otimes_R R'$
is flat over $R'$. As $R'$ is Artinian, it follows that $R/J$ is Artinian
too. Hence the flatness of $M \otimes_R R' = M/JM \otimes_{R/J} R'$ over
$R'$ implies that $M/JM$ is flat over $R/J$ by
Algebra,
Lemma \ref{algebra-lemma-descent-flatness-injective-map-artinian-rings}.
This concludes the proof.
\end{proof}

\begin{lemma}
\label{lemma-flattening-complete-local-universal-property}
With notation $R \to S$, $M$, and $I$ and assumptions as in
Lemma \ref{lemma-flattening-complete-local-noetherian}.
In addition assume that $R \to S$ is of finite type.
Then for any local homomorphism of local rings
$\varphi : (R, \mathfrak m) \to (R', \mathfrak m')$
the following are equivalent
\begin{enumerate}
\item condition (\ref{equation-flat-at-primes-over}) holds
for $(R' \to S \otimes_R R', \mathfrak m', M \otimes_R R')$, and
\item $\varphi(I) = 0$.
\end{enumerate}
\end{lemma}

\begin{proof}
The implication (2) $\Rightarrow$ (1) follows from
Lemma \ref{lemma-base-change-flat-at-primes-over}.
Let $\varphi : R \to R'$ be as in the lemma satisfying (1).
Let $J = \text{Ker}(\varphi)$. By the construction of $I$ in
Lemma \ref{lemma-flattening-complete-local-noetherian}
it suffices to show that $(M/JM)_{\mathfrak q}$ is flat over $R/J$
for every prime $\mathfrak q$ of $S/JS$ lying over $\mathfrak m$.
Hence we may replace $R$, $S$, $M$ by $R/J$, $S/JS$, $M/JM$.
In other words, we are given an injective homomorphism
$\varphi : R \to R'$ as in the lemma satisfying (1)
and our goal is to show that $M_{\mathfrak q}$ is flat over $R$
for all primes $\mathfrak q$ of $S$ lying over $\mathfrak m$.

\medskip\noindent
As $R$ is Noetherian we see that $R \to S$ is of finite presentation
and $M$ is an $S$-module of finite presentation. Hence the base change
$S' = S \otimes_R R'$ is of finite presentation over $R'$ and
$M' = M \otimes_R R' = M \otimes_S S'$ is of finite presentation over $S'$. By
Algebra, Theorem \ref{algebra-theorem-openess-flatness}
the set
$$
U' = \{\mathfrak q' \in \text{Spec}(S') \mid
M'_{\mathfrak q'}\text{ is flat over }R'\}
$$
is open in $\text{Spec}(S')$. Note that
$$
F' = \{\mathfrak q' \in \text{Spec}(S') \mid
\mathfrak q'\text{ lies over }\mathfrak m'\} =
\text{Spec}(S' \otimes_{R'} \kappa(\mathfrak m'))
$$
is a quasi-compact space which is contained in $U'$ by assumption.
Hence there exist finitely many $g'_i \in S'$, $i = 1, \ldots, n$
such that $D(g'_i) \subset U'$ and such that $F' \subset \bigcup D(g'_i)$.
Note that in particular $M'_{g'_i}$ is a flat module over $R'$.

\medskip\noindent
Choose $R_0$ with $R \subset R_0 \subset R'$ such that
$R_0$ is essentially of finite type over $R$, local with maximal
ideal $\mathfrak m_0 = R_0 \cap \mathfrak m'$, and such that there exist
$g_{0, i} \in S \otimes_R R_0$ mapping to the elements $g_i$ in
$S' = S \otimes_R R'$. After possibly increasing $R_0$ a bit we
may assume that $F_0 = \text{Spec}(S \otimes_R \kappa(\mathfrak m_0))$
is contained in $\bigcup D(g_{0, i})$.
Now we can write $R' = \text{colim}_\lambda\ R_\lambda$
as a directed colimit of $R_0$-subalgebras $R_\lambda$ of $R'$,
local with maximal ideal $\mathfrak m_\lambda = R_\lambda \cap \mathfrak m'$
which are essentially of finite type over $R$.
Write $S_\lambda = S \otimes_R R_\lambda$,
$M_\lambda = M \otimes_R R_\lambda$, and
$g_{\lambda, i}$ the image of $g_{0, i}$ in $S_\lambda$.
By
Algebra, Lemma \ref{algebra-lemma-flat-finite-presentation-limit-flat}
we see that for some sufficiently large $\lambda$ the modules
$(M_\lambda)_{g_{\lambda, i}}$ are flat over $R_\lambda$.
In particular the module $M_\lambda$ is flat over $R_\lambda$
at all the primes lying over the maximal ideal $\mathfrak m_\lambda$.
Hence
Lemma \ref{lemma-flattening-complete-local-noetherian-property-by-finite-type}
applies to the ring map $R \to R_\lambda$ and we see that
$I$ maps to zero in $R_\lambda$, a fortiori it maps to zero in $R'$.
\end{proof}




\section{Descent flatness along integral maps}
\label{section-descent-flatness-integral}

\noindent
First a few simple lemmas.

\begin{lemma}
\label{lemma-have-one-root}
Let $R$ be a ring. Let $P(T)$ be a monic polynomial with coefficients
in $R$. If there exists an $\alpha \in R$ such that $P(\alpha) = 0$, then
$P(T) = (T - \alpha)Q(T)$ for some monic polynomial $Q(T) \in R[T]$.
\end{lemma}

\begin{proof}
By induction on the degree of $P$. If $\deg(P) = 1$, then
$P(T) = T - \alpha$ and the result is true. If $\deg(P) > 1$, then
we can write $P(T) = (T - \alpha)Q(T) + r$ for some polynomial
$Q \in R[T]$ of degree $< \deg(P)$ and some $r \in R$ by long
division. By assumption $0 = P(\alpha) = (\alpha - \alpha)Q(\alpha) + r = r$
and we conclude that $r = 0$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-adjoin-one-root}
Let $R$ be a ring. Let $P(T)$ be a monic polynomial with coefficients
in $R$. There exists a finite free ring map $R \to R'$ such that
$P(T) = (T - \alpha)Q(T)$ for some $\alpha \in R'$ and some
monic polynomial $Q(T) \in R'[T]$.
\end{lemma}

\begin{proof}
Write $P(T) = T^d + a_1T^{d - 1} + \ldots + a_0$.
Set $R' = R[x]/(x^d + a_1x^{d - 1} + \ldots + a_0)$.
Set $\alpha$ equal to the congruence class of $x$.
Then it is clear that $P(\alpha) = 0$. Thus we win by
Lemma \ref{lemma-have-one-root}.
\end{proof}

\begin{lemma}
\label{lemma-finite-split}
Let $R \to S$ be a finite ring map.
There exists a finite free ring extension $R \subset R'$ such
that $S \otimes_R R'$ is a quotient of a ring of the form
$$
R'[T_1, \ldots, T_n]/(P_1(T_1), \ldots, P_n(T_n))
$$
with $P_i(T) = \prod_{j = 1, \ldots, d_i} (T - \alpha_{ij})$ for some
$\alpha_{ij} \in R'$.
\end{lemma}

\begin{proof}
Let $x_1, \ldots, x_n \in S$ be generators of $S$ over $R$.
For each $i$ we can choose a monic polynomial $P_i(T) \in R[T]$
such that $P(x_i) = 0$ in $S$, see
Algebra, Lemma \ref{algebra-lemma-finite-is-integral}.
Say $\deg(P_i) = d_i$. By
Lemma \ref{lemma-adjoin-one-root}
(applied $\sum d_i$ times) there exists a finite free ring
extension $R \subset R'$ such that each $P_i$ splits completely:
$$
P_i(T) = \prod\nolimits_{j = 1, \ldots, d_i} (T - \alpha_{ij})
$$
for certain $\alpha_{ik} \in R'$. Let
$R'[T_1, \ldots, T_n] \to S \otimes_R R'$ be the $R'$-algebra map
which maps $T_i$ to $x_i \otimes 1$. As this maps $P_i(T_i)$ to zero,
this induces the desired surjection.
\end{proof}

\begin{lemma}
\label{lemma-split-image}
Let $R$ be a ring.
Let $S = R[T_1, \ldots, T_n]/J$.
Assume $J$ contains elements of the form $P_i(T_i)$
with $P_i(T) = \prod_{j = 1, \ldots, d_i} (T - \alpha_{ij})$ for some
$\alpha_{ij} \in R$. For $\underline{k} = (k_1, \ldots, k_n)$
with $1 \leq k_i \leq d_i$ consider the ring map
$$
\Phi_{\underline{k}} : R[T_1, \ldots, T_n] \to R,
\quad
T_i \longmapsto \alpha_{ik_i}
$$
Set $J_{\underline{k}} = \Phi_{\underline{k}}(J)$.
Then the image of $\text{Spec}(S) \to \text{Spec}(R)$ is equal to
$V(\bigcap J_{\underline{k}})$.
\end{lemma}

\begin{proof}
This lemma proves itself. Hint:
$V(\bigcap J_{\underline{k}}) = \bigcup V(J_{\underline{k}})$.
\end{proof}

\noindent
The following result is due to Ferrand, see \cite{Ferrand}.

\begin{lemma}
\label{lemma-descent-flatness-injective-finite-Noetherian-rings}
Let $R \to S$ be a finite injective homomorphism of Noetherian rings.
Let $M$ be an $R$-module. If $M \otimes_R S$ is a flat $S$-module,
then $M$ is a flat $R$-module.
\end{lemma}

\begin{proof}
Let $M$ be an $R$-module such that $M \otimes_R S$ is flat over $S$. By
Algebra, Lemma \ref{algebra-lemma-flatness-descends}
in order to prove that $M$ is flat we may replace $R$ by any faithfully flat
ring extension. By
Lemma \ref{lemma-finite-split}
we can find a finite locally free ring extension $R \subset R'$ such
that $S' = S \otimes_R R' = R'[T_1, \ldots, T_n]/J$ for some ideal
$J \subset R'[T_1, \ldots, T_n]$ which contains the  elements of the form
$P_i(T_i)$ with $P_i(T) = \prod_{j = 1, \ldots, d_i} (T - \alpha_{ij})$
for some $\alpha_{ij} \in R'$. Note that $R'$ is Noetherian
and that $R' \subset S'$ is a finite extension of rings. Hence we may
replace $R$ by $R'$ and assume that $S$ has a presentation as in
Lemma \ref{lemma-split-image}.
Note that $\text{Spec}(S) \to \text{Spec}(R)$ is surjective, see
Algebra, Lemma \ref{algebra-lemma-integral-overring-surjective}.
Thus, using
Lemma \ref{lemma-split-image}
we conclude that $I = \bigcap J_{\underline{k}}$ is an ideal
such that $V(I) = \text{Spec}(R)$. This means that
$I \subset \sqrt{(0)}$, and since $R$ is Noetherian that $I$
is nilpotent. The maps $\Phi_{\underline{k}}$ induce commutative
diagrams
$$
\xymatrix{
S \ar[rr] & & R/J_{\underline{k}} \\
& R \ar[lu] \ar[ru]
}
$$
from which we conclude that $M/J_{\underline{k}}M$ is flat over
$R/J_{\underline{k}}$. By
Lemma \ref{lemma-intersection-flat}
we see that $M/IM$ is flat over $R/I$. Finally, applying
Algebra, Lemma \ref{algebra-lemma-lift-flatness}
we conclude that $M$ is flat over $R$.
\end{proof}

\begin{lemma}
\label{lemma-descent-flatness-injective-integral}
Let $R \to S$ be an injective integral ring map.
Let $M$ be a finitely presented module over $R[x_1, \ldots, x_n]$.
If $M \otimes_R S$ is flat over $S$, then $M$ is flat over $R$.
\end{lemma}

\begin{proof}
Choose a presentation
$$
R[x_1, \ldots, x_n]^{\oplus t} \to R[x_1, \ldots, x_n]^{\oplus r} \to M \to 0.
$$
Let's say that the first map is given by the $r \times t$-matrix
$T = (f_{ij})$ with $f_{ij} \in R[x_1, \ldots, x_n]$. Write
$f_{ij} = \sum f_{ij, I} x^I$ with $f_{ij, I} \in R$ (multi-index notation).
Consider diagrams
$$
\xymatrix{
R \ar[r] & S \\
R_\lambda \ar[u] \ar[r] & S_\lambda \ar[u]
}
$$
where $R_\lambda$ is a finitely generated $\mathbf{Z}$-subalgebra of
$R$ containing all $f_{ij, I}$ and $S_\lambda$ is a finite
$R_\lambda$-subalgebra of $S$. Let $M_\lambda$ be the finite
$R_\lambda[x_1, \ldots, x_n]$-module defined by a presentation
as above, using the same matrix $T$ but now viewed as a matrix
over $R_\lambda[x_1, \ldots, x_n]$. Note that $S$ is the directed colimit
of the $S_\lambda$ (details omitted). By
Algebra, Lemma \ref{algebra-lemma-flat-finite-presentation-limit-flat}
we see that for some $\lambda$ the module
$M_\lambda \otimes_{R_\lambda} S_\lambda$ is flat over $S_\lambda$. By
Lemma \ref{lemma-descent-flatness-injective-finite-Noetherian-rings}
we conclude that $M_\lambda$ is flat over $R_\lambda$. Since
$M = M_\lambda \otimes_{R_\lambda} R$ we win by
Algebra, Lemma \ref{algebra-lemma-flat-base-change}.
\end{proof}




\section{Torsion and flatness}
\label{section-torsion-flat}

\noindent
In this section we discuss the relationship between torsion and flatness.

\begin{definition}
\label{definition-torsion}
Let $R$ be a domain. Let $M$ be an $R$-module.
\begin{enumerate}
\item We say an element $x \in M$ is {\it torsion} if there exists
a nonzero $f \in R$ such that $fx = 0$.
\item We say $M$ is {\it torsion free} if the only torsion element of $M$
is $0$.
\end{enumerate}
\end{definition}

\begin{lemma}
\label{lemma-torsion}
Let $R$ be a domain. Let $M$ be an $R$-module.
The set of torsion elements of $M$ forms a submodule $M_{tors} \subset M$.
The quotient module $M/M_{tors}$ is torsion free.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-flat-torsion-free}
Let $R$ be a domain. Any flat $R$-module is torsion free.
\end{lemma}

\begin{proof}
If $x \in R$ is nonzero, then $x : R \to R$ is injective, and hence if $M$
is flat over $R$, then $x : M \to M$ is injective. Thus if $M$ is flat over
$R$, then $M$ is torsion free.
\end{proof}

\begin{lemma}
\label{lemma-valuation-ring-torsion-free-flat}
Let $A$ be a valuation ring.
An $A$-module $M$ is flat over $A$ if and only if $M$ is torsion free.
\end{lemma}

\begin{proof}
The implication ``flat $\Rightarrow$ torsion free'' is
Lemma \ref{lemma-flat-torsion-free}.
For the converse, assume $M$ is torsion free.
By the equational criterion of flatness (see
Algebra, Lemma \ref{algebra-lemma-flat-eq})
we have to show that every relation in $M$ is trivial. To do this assume that
$\sum_{i = 1, \ldots, n} a_i x_i = 0$ with $x_i \in M$ and $f_i \in A$.
After renumbering we may assume that $v(a_1) \leq v(a_i)$ for all $i$.
Hence we can write $a_i = a'_i a_1$ for some $a'_i \in A$. Note that
$a'_1 = 1$. As $A$ is torsion free we see that
$x_1 = - \sum_{i \geq 2} a'_i x_i$. Thus, if we choose
$y_i = x_i$, $i = 2, \ldots, n$ then
$$
x_1 = \sum\nolimits_{j \geq 2} -a'_j y_j,\quad
x_i = y_i, (i \geq 2)\quad
0 = a_1 \cdot (-a'_j) + a_j \cdot 1 (j \geq 2)
$$
shows that the relation was trivial (to be explicit the elements
$a_{ij}$ are defined by setting $a_{1j} = -a'_j$ and $a_{ij} = \delta_{ij}$
for $i, j \geq 2$).
\end{proof}






\section{Flatness and finiteness conditions}
\label{section-flat-finite}

\noindent
In this section we discuss implications of the type
``flat $+$ finite type $\Rightarrow$ finite presentation''.
A first result of this type was proved in
Algebra, Lemma \ref{algebra-lemma-finite-flat-module-finitely-presented}.

\begin{lemma}
\label{lemma-flat-finite-type-finite-presentation-local-module}
Let $R$ be a ring. Let $S = R[x_1, \ldots, x_n]$ be a polynomial\
ring over $R$. Let $M$ be an $S$-module.
Assume
\begin{enumerate}
\item there exist finitely many minimal primes
$\mathfrak p_1, \ldots, \mathfrak p_m$ of $R$ such that
the map $R \to \prod R_{\mathfrak p_j}$ is injective,
\item $M$ is a finite $S$-module,
\item $M$ flat over $R$, and
\item for every prime $\mathfrak p$ of $R$ the module $M_{\mathfrak p}$
is of finite presentation over $S_{\mathfrak p}$.
\end{enumerate}
Then $M$ is of finite presentation over $S$.
\end{lemma}

\begin{proof}
Choose a presentation
$$
0 \to K \to S^{\oplus r} \to M \to 0
$$
of $M$ as an $S$-module. Let $\mathfrak q$ be a prime ideal of $S$
lying over the prime $\mathfrak p$ of $R$. By assumption there exist
finitely many elements $k_1, \ldots, k_t \in K$ such that if we set
$K' = \sum Sk_j \subset K$ then
$K'_{\mathfrak p} = K_{\mathfrak p}$ and
$K'_{\mathfrak p_j} = K_{\mathfrak p_j}$ for $j = 1, \ldots, m$.
Setting $M' = S^{\oplus r}/K'$ we deduce that in particular
$M'_{\mathfrak q} = M_{\mathfrak q}$. By openness of flatness, see
Algebra, Theorem \ref{algebra-theorem-openess-flatness}
we conclude that there exists a $g \in S$, $g \not \in \mathfrak q$
such that $M'_g$ is flat over $R$. Thus now $M'_g \to M_g$ is a surjective
map of flat $R$-modules. Consider the commutative diagram
$$
\xymatrix{
M'_g \ar[r] \ar[d] & M_g \ar[d] \\
\prod (M'_g)_{\mathfrak p_j} \ar[r] & \prod (M_g)_{\mathfrak p_j}
}
$$
The bottom arrow is an isomorphism by choice of $k_1, \ldots, k_t$.
The left vertical arrow is an injective map as
$R \to \prod R_{\mathfrak p_j}$ is injective and $M'_g$ is flat over $R$.
Hence the top horizontal arrow is injective, hence an isomorphism.
This proves that $M_g$ is of finite presentation over $S_g$.
We conclude by applying
Algebra, Lemma \ref{algebra-lemma-cover}.
\end{proof}

\begin{lemma}
\label{lemma-flat-finite-type-finite-presentation-local}
Let $R \to S$ be a ring homomorphism.
Assume
\begin{enumerate}
\item there exist finitely many minimal primes
$\mathfrak p_1, \ldots, \mathfrak p_m$ of $R$ such that
the map $R \to \prod R_{\mathfrak p_j}$ is injective,
\item $R \to S$ is of finite type,
\item $S$ flat over $R$, and
\item for every prime $\mathfrak p$ of $R$ the ring $S_{\mathfrak p}$
is of finite presentation over $R_{\mathfrak p}$.
\end{enumerate}
Then $S$ is of finite presentation over $R$.
\end{lemma}

\begin{proof}
By assumption $S$ is a quotient of a polynomial ring over $R$.
Thus the result follows directly from
Lemma \ref{lemma-flat-finite-type-finite-presentation-local-module}.
\end{proof}

\begin{lemma}
\label{lemma-flat-graded-finite-type-finite-presentation-module}
Let $R$ be a ring.
Let $S = R[x_1, \ldots, x_n]$ be a graded polynomial algebra over $R$,
i.e., $\deg(x_i) > 0$ but not necessarily equal to $1$.
Let $M$ be a graded $S$-module.
Assume
\begin{enumerate}
\item $R$ is a local ring,
\item $M$ is a finite $S$-module, and
\item $M$ is flat over $R$.
\end{enumerate}
Then $M$ is finitely presented as an $S$-module.
\end{lemma}

\begin{proof}
Let $M = \bigoplus M_d$ be the grading on $M$.
Pick homogeneous generators $m_1, \ldots, m_r \in M$ of $M$.
Say $\deg(m_i) = d_i \in \mathbf{Z}$. This gives us a presentation
$$
0 \to K \to \bigoplus\nolimits_{i = 1, \ldots, r} S(-d_i) \to M \to 0
$$
which in each degree $d$ leads to the short exact sequence
$$
0 \to K_d \to \bigoplus\nolimits_{i = 1, \ldots, r} S_{d - d_i} \to
M_d \to 0.
$$
By assumption each $M_d$ is a finite flat $R$-module. By
Algebra, Lemma \ref{algebra-lemma-finite-flat-local}
this implies each $M_d$ is a finite free $R$-module. Hence
we see each $K_d$ is a finite $R$-module. Also each $K_d$ is flat
over $R$ by
Algebra, Lemma \ref{algebra-lemma-flat-ses}.
Hence we conclude that each $K_d$ is finite free by 
Algebra, Lemma \ref{algebra-lemma-finite-flat-local}
again.

\medskip\noindent
Let $\mathfrak m$ be the maximal ideal of $R$. By the flatness of $M$
over $R$ the short exact sequences above remain short exact after tensoring
with $\kappa = \kappa(\mathfrak m)$. As the ring $S \otimes_R \kappa$ is
Noetherian we see that there exist homogeneous elements
$k_1, \ldots, k_t \in K$ such that the images $\overline{k}_j$
generate $K \otimes_R \kappa$ over $S \otimes_R \kappa$. Say $\deg(k_j) = e_j$.
Thus for any $d$ the map
$$
\bigoplus\nolimits_{j = 1, \ldots, t} S_{d - e_j}
\longrightarrow
K_d
$$
becomes surjective after tensoring with $\kappa$. By
Nakayama's lemma
(Algebra, Lemma \ref{algebra-lemma-NAK})
this implies the map is surjective over $R$. Hence $K$ is generated
by $k_1, \ldots, k_t$ over $S$ and we win.
\end{proof}

\begin{lemma}
\label{lemma-flat-graded-finite-type-finite-presentation}
Let $R$ be a ring.
Let $S = \bigoplus S_n$ be a graded $R$-algebra.
Assume
\begin{enumerate}
\item $R$ is a local ring,
\item $S_0 = R$,
\item $S$ is finitely generated over $R$, and
\item $S$ is flat over $R$.
\end{enumerate}
Then $S$ is finitely presented as an $R$-algebra.
\end{lemma}

\begin{proof}
The assumptions imply that $S$ is a quotient of a graded polynomial
ring $R[x_1, \ldots, x_n]$ with $\deg(x_i) = d_i \in \mathbf{N}$.
Thus the result follows on applying
Lemma \ref{lemma-flat-graded-finite-type-finite-presentation-module}
with $M = S$.
\end{proof}

\noindent
The following lemma wil be improved below, see
Proposition \ref{proposition-flat-finite-type-finite-presentation-domain}.

\begin{lemma}
\label{lemma-flat-finite-type-valuation-ring-finite-presentation}
Let $A$ be a valuation ring. Let $A \to B$ be a ring map of finite type.
Let $M$ be a finite $B$-module.
\begin{enumerate}
\item If $B$ is flat over $A$, then $B$ is a finitely presented $A$-algebra.
\item If $M$ is flat as an $A$-module, then $M$ is finitely presented
as a $B$-module.
\end{enumerate}
\end{lemma}

\begin{proof}
We are going to use that an $A$-module is flat if and only if it is
torsion free, see
Lemma \ref{lemma-valuation-ring-torsion-free-flat}.
By
Algebra, Lemma \ref{algebra-lemma-homogenize}
we can find a graded $A$-algebra $S$ with $S_0 = A$ and generated
by finitely many elements in degree $1$, an element $f \in S_1$ and a
finite graded $S$-module $N$ such that $B \cong S_{(f)}$ and
$M \cong N_{(f)}$. If $M$ is torsion free, then we can take $N$ torsion
free by replacing it by $N/N_{tors}$, see
Lemma \ref{lemma-torsion}.
Similarly, if $B$ is torsion free, then we can take
$S$ torsion free by replacing it by $S/S_{tors}$.
Hence in case (1), we may apply
Lemma \ref{lemma-flat-graded-finite-type-finite-presentation}
to see that $S$ is a finitely presented
$A$-algebra, which implies that $B = S_{(f)}$ is a finitely
presented $A$-algebra. To see (2) we may first replace $S$ by
a graded polynomial ring, and then we may apply
Lemma \ref{lemma-flat-graded-finite-type-finite-presentation-module}
to conclude.
\end{proof}

\begin{lemma}
\label{lemma-helper-finite-type-flat-finite-presentation}
Let $R$ be a domain with fraction field $K$.
Let $S = R[x_1, \ldots, x_n]$ be a polynomial ring over $R$.
Let $M$ be a finite $S$-module. Assume that $M$ is flat over $R$.
If for every subring $R \subset R' \subset K$, $R \not = R'$
the module $M \otimes_R R'$ is finitely presented
over $S \otimes_R R'$, then $M$ is finitely presented over $S$.
\end{lemma}

\begin{proof}
Suppose that $f_1, \ldots, f_n \in R$ are elements which generate the
unit ideal. If $R \not = R_{f_i}$ for each $i = 1, \ldots, n$, then
we conclude that $M_{f_i}$ is finitely presented over
$S_{f_i}$ for each $i$, and hence $M$ is finitely presented over $S$ by
Algebra, Lemma \ref{algebra-lemma-cover}.
Thus we are done if such a sequence of elements exists.
Assume this is not the case. In particular, for every $x \in R$ we
have either $x \in R^*$, or $1 - x \in R^*$. This implies that $R$ is
local, see
Algebra, Lemma \ref{algebra-lemma-characterize-local-ring}.

\medskip\noindent
Choose a presentation
$$
0 \to K \to R[x_1, \ldots, x_n]^{\oplus r} \to M \to 0.
$$
Throughout the rest of the proof we will use that this sequence stays exact
after tensoring with any $R$-algebra, see
Algebra, Lemma \ref{algebra-lemma-flat-tor-zero}.
Let $R'$ be the integral closure of $R$ in its fraction field.
If $R \not = R'$, then we see that $M \otimes_R R'$ is finitely presented over
$R'[x_1, \ldots, x_n]$. In particular, the module $K \otimes_R R'$
is finitely generated. Thus we may pick $k_1, \ldots, k_t \in K$ such that
$k_1 \otimes 1, \ldots, k_t \otimes 1$ generate $K \otimes_R R'$.
Set $K' = \sum R[x_1, \ldots, x_n]k_i \subset K$. Set
$M' = R[x_1, \ldots, x_n]^{\oplus t}/K'$. Then $M'$ is a finitely presented
module over $R[x_1, \ldots, x_n]$ such that
$M' \otimes_R R' \cong M \otimes_R R'$ is flat over $R'$. By
Lemma \ref{lemma-descent-flatness-injective-integral}
we conclude that $M'$ is flat over $R$. Hence the surjective
map $M' \to M$ is also injective as $M'$ is torsion free, see
Lemma \ref{lemma-flat-torsion-free}.
In other words, $M' \cong M$ and we conclude that $M$ is finitely presented.
Thus we are done if $R$ is not a normal domain.
Assume this is not the case. This reduces us to the case where $R$ is
a normal local domain.

\medskip\noindent
Pick any pair of nonzero elements $x, y \in R$. Consider the inclusions
$R \subset R[x/y]$ and $R[y/x]$. As $R$ is a normal domain we get a short
exact sequence
$$
0 \to R \xrightarrow{(-1, 1)} R[x/y] \oplus R[y/x] \xrightarrow{(1, 1)}
R[x/y, y/x] \to 0
$$
see
Algebra, Lemma \ref{algebra-lemma-silly-normal}.
If $R \not = R[x/y]$ and $R \not = R[y/x]$ then we see that
$K \otimes_R R[x/y]$ and $K \otimes_R R[y/x]$ are finitely generated
as $R[x/y][x_1, \ldots, x_n]$ and $R[y/x][x_1, \ldots, x_n]$ modules.
Thus we can find $k_1, \ldots, k_t \in K$ such that the elements
$k_i \otimes 1$ generate
$K \otimes_R R[x/y]$ and $K \otimes_R R[y/x]$ as $R[x/y][x_1, \ldots, x_n]$
and $R[y/x][x_1, \ldots, x_n]$ modules.
Set $K' = \sum R[x_1, \ldots, x_n]k_i \subset K$. Tensoring the sequence
above with $K' \subset K$ we get the diagram
$$
\xymatrix{
 &
K' \ar[d] \ar[r] &
K' \otimes_R R[x/y] \oplus K' \otimes_R R[y/x] \ar[d] \ar[r] &
K' \otimes_R R[x/y, y/x] \ar[d] \ar[r] &
0 \\
0 \ar[r] &
K \ar[r] &
K \otimes_R R[x/y] \oplus K \otimes_R R[y/x] \ar[r] &
K \otimes_R R[x/y, y/x] \ar[r] &
0
}
$$
Now we know that the vertical arrows in the middle and on the right
are isomorphisms. The lower row is exact as $K$ is flat over $R$.
Hence the left vertical arrow is surjective, i.e., an isomorphism.
Thus we win if there exists a pair of nonzero elements such that
neither $x/y$ nor $y/x$ is an element of $R$. Assume this is not the case.
Then we know that $R \subset f.f.(R)$ is a normal local domain such
that for every $x \in f.f.(R)$ either $x \in R$, or $x^{-1} \in R$.
In other words, $R$ is a valuation ring, see
Algebra, Lemma \ref{algebra-lemma-x-or-x-inverse-valuation-ring}.
In this case $M$ is finitely presented by
Lemma \ref{lemma-flat-finite-type-valuation-ring-finite-presentation}
and we win.
\end{proof}

\noindent
The following result can be found in \cite{GruRay}.

\begin{proposition}
\label{proposition-flat-finite-type-finite-presentation-domain}
Let $R$ be a domain.
Let $R \to S$ be a ring map of finite type.
Let $M$ be a finite $S$-module.
\begin{enumerate}
\item If $S$ is flat over $R$, then $S$ is a finitely presented $R$-algebra.
\item If $M$ is flat as an $R$-module, then $M$ is finitely presented
as a $S$-module.
\end{enumerate}
\end{proposition}

\begin{proof}
It suffices to prove part (2) in case $S = R[x_1, \ldots, x_n]$.
Choose a presentation
$$
0 \to K \to R[x_1, \ldots, x_n]^{\oplus r} \to M \to 0.
$$
Throughout the rest of the proof we will use that this sequence stays exact
after tensoring with any $R$-algebra, see
Algebra, Lemma \ref{algebra-lemma-flat-tor-zero}.
Let $L$ be the fraction field of $R$.
Consider the set
$$
\mathcal{R} = \{R' \mid
R \subset R' \subset L
\text{ and }
M \otimes_R R'
\text{ not of finite presentation over }
S \otimes_R R'\}
$$
We order $\mathcal{R}$ by inclusion. Suppose that
$\{R_i\}_{i \in I}$ is a totally ordered subset of $\mathcal{R}$.
Set $R_{\infty} = \bigcup_{i \in I} R_i$.
We claim that $R_\infty \in \mathcal{R}$.
Namely, if $M \otimes_R R_{\infty}$ is finitely presented over
$S \otimes_R R_\infty$, then $K \otimes_R R_\infty$ is finitely
generated, say by $k_1, \ldots, k_t$. Then for some $i\in I$
we have $k_1, \ldots, k_t \in K \otimes_R R_i$. For any
$i' \geq i$ set
$M_{i'} = R_i[x_1, \ldots, x_n]^{\oplus r}/\sum R_i[x_1, \ldots, x_n]k_i$.
By
Algebra, Lemma \ref{algebra-lemma-flat-finite-presentation-limit-flat}
we see that $M_{i'}$ is flat over $R_i$ for some sufficiently large
$i' \in I$. For such an $i'$ the surjective map
$M_{i'} \to M \otimes_R R_i$ is also injective as
$M_{i'}$ is torsion free. Hence we conclude that
$M \otimes_R R_i$ is finitely presented which is a contradiction.
In other words $R_\infty \in \mathcal{R}$.
This shows that Zorn's lemma applies to $\mathcal{R}$ if $\mathcal{R}$
is not empty. But
Lemma \ref{lemma-helper-finite-type-flat-finite-presentation}
shows that $\mathcal{R}$ does not have any maximal elements and the
proposition is proved.
\end{proof}




\section{Blowing up and flatness}
\label{section-blowup-flat}

\noindent
In this section we begin our discussion of results of the form: ``After a
blow up the strict transform becomes flat''.

\begin{definition}
\label{definition-strict-transform}
Let $R$ be a domain.
Let $M$ be an $R$-module.
Let $R \subset R'$ be an extension of domains.
The {\it strict transform of $M$ along $R \to R'$} is
the torsion free $R'$-module
$$
M' = (M \otimes_R R')/(M \otimes_R R')_{tors}.
$$
\end{definition}

\noindent
The following is a very weak version of flattening by blowing up, but
it is already sometimes a useful result.

\begin{lemma}
\label{lemma-flatten-on-affine-blowup}
Let $(R, \mathfrak m)$ be a local domain with fraction field $K$.
Let $S$ be a finite type $R$-algebra.
Let $M$ be a finite $S$-module.
For every valuation ring $A \subset K$ dominating $R$
there exists an ideal $I \subset \mathfrak m$ and a nonzero
element $a \in I$ such that
\begin{enumerate}
\item $I$ is finitely generated,
\item $A$ has center on $R[\frac{I}{a}]$,
\item the fibre ring of $R \to R[\frac{I}{a}]$ at $\mathfrak m$
is not zero, and
\item the strict transform $S_{I, a}$ of $S$ along $R \to R[\frac{I}{a}]$
is flat and of finite presentation over $R$, and the strict transform
$M_{I, a}$ of $M$ along $R \to R[\frac{I}{a}]$ is flat over $R$ and
finitely presented over $S_{I, a}$.
\end{enumerate}
\end{lemma}

\begin{proof}
Note that the assertion makes sense as $R[\frac{I}{a}]$
is a domain, and $R \to R[\frac{I}{a}]$ is injective, see
Algebra, Lemmas \ref{algebra-lemma-blowup-domain} and
\ref{algebra-lemma-blowup-dominant}.
Before we start the proof of the Lemma, note that there is
no loss in generality assuming that $S = R[x_1, \ldots, x_n]$
is a polynomial ring over $R$. We also fix a presentation
$$
0 \to K \to S^{\oplus r} \to M \to 0.
$$
Let $M_A$ be the strict transform of $M$ along $R \to A$. It is a finite
module over $S_A = A[x_1, \ldots, x_n]$. By
Lemma \ref{lemma-valuation-ring-torsion-free-flat}
we see that $M_A$ is flat over $A$. By
Lemma \ref{lemma-flat-finite-type-valuation-ring-finite-presentation}
we see that $M_A$ is finitely presented. Hence there exist finitely many
elements $k_1, \ldots, k_t \in S_A^{\oplus r}$ which generate the
kernel of the presentation $S_A^{\oplus r} \to M_A$ as
an $S_A$-module. For any choice of $a \in I \subset \mathfrak m$
satisfying (1), (2), and (3) we denote $M_{I, a}$ the strict transform of
$M$ along $R \to R[\frac{I}{a}]$. It is a finite module over
$S_{I, a} = R[\frac{I}{a}][x_1, \ldots, x_n]$. By
Algebra, Lemma \ref{algebra-lemma-valuation-ring-colimit-affine-blowups}
we have $A = \text{colim}_{I, a}\ R[\frac{I}{a}]$.
This implies that $S_A = \text{colim}\ S_{I, a}$ and
$M_A = \text{colim}_{I, a}\ M_{I, a}$.
Thus we may choose $a \in I \subset R$ such that
$k_1, \ldots, k_t$ are elements of $S_{I, a}^{\oplus r}$ and
map to zero in $M_{I, a}$. For any such pair $(I, a)$ we set
$$
M'_{I, a} = S_{I, a}^{\oplus r}/ \sum S_{I, a}k_j.
$$
Since $M_A = S_A^{\oplus r}/ \sum S_Ak_j$ we see that also
$M_A = \text{colim}_{I, a}\ M'_{I, a}$.
At this point we may apply
Algebra, Lemma \ref{algebra-lemma-flat-finite-presentation-limit-flat} (3)
to conclude that $M'_{I, a}$ is flat for some pair $(I, a)$.
(This lemma does not apply a priori to the system $M_{I, a}$
as the transition maps may not satisfy the assumptions of the lemma.)
Since flatness implies torsion free (
Lemma \ref{lemma-flat-torsion-free}),
we also conclude that $M'_{I, a} = M_{I, a}$ for such a pair and we win.
\end{proof}

















\input{chapters}

\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}
