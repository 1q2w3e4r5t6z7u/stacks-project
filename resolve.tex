\input{preamble}

% OK, start here.
%
\begin{document}

\title{Resolution of Surfaces; UNDER CONSTRUCTION}


\maketitle

\phantomsection
\label{section-phantom}

\tableofcontents

\section{Introduction}
\label{section-introduction}

\noindent
This chapter discusses resolution of singularities of surfaces
following Lipman \cite{Lipman} and following the exposition
in \cite{Artin-Lipman}.





\section{A trace map in positive characteristic}
\label{section-trace}

\noindent
In this section $p$ will be a prime number. Let $R$ be an
$\mathbf{F}_p$-algebra. Let $M$ be an $R$-module and let $D : R \to M$ be a
derivation. Given an $a \in R$ set $A = R[x]/(x^p - a)$.
Define an $R$-linear map
$$
\text{Tr}_{x, D} : \Omega_{A/R} \longrightarrow M
$$
by the rule
$$
x^i\text{d}x \longmapsto
\left\{
\begin{matrix}
0 & \text{if} & 0 \leq i \leq p - 2, \\
D(a) & \text{if} & i = p - 1
\end{matrix}
\right.
$$
This makes sense as $\Omega_{A/R}$ is a free $R$-module with
basis $x^i\text{d}x$, $0 \leq i \leq p - 1$.
The following lemma implies that the trace map is well defined,
i.e., independent of the choice of the coordinate $x$.

\begin{lemma}
\label{lemma-trace-well-defined}
Let $\varphi : R[x]/(x^p - a) \to R[y]/(y^p - b)$ be an $R$-algebra
homomorphism. Then
$\text{Tr}_{x, D} = \text{Tr}_{y, D} \circ \varphi$.
\end{lemma}

\begin{proof}
Say $\varphi(x) = \lambda_0 + \lambda_1 y + \ldots + \lambda_{p - 1}y^{p - 1}$
with $\lambda_i \in R$. The condition that mapping $x$ to
$\lambda_0 + \lambda_1 y + \ldots + \lambda_{p - 1}y^{p - 1}$
induces an $R$-algebra homomorphism $R[x]/(x^p - a) \to R[y]/(y^p - b)$
is equivalent to the condition that
$$
a = \lambda_0^p + \lambda_1^p b + \ldots + \lambda_{p - 1}^pb^{p - 1}
$$
in the ring $R$. Consider the polynomial ring
$$
R_{univ} = \mathbf{F}_p[b, \lambda_0, \ldots, \lambda_{p - 1}]
$$
with the element
$a = \lambda_0^p + \lambda_1^p b + \ldots + \lambda_{p - 1}^pb^{p - 1}$
and
with its universal derivation given by
$$
D_{univ} = \text{d} :
R_{univ}
\longrightarrow
M_{univ} = \Omega_{R_{univ}/\mathbf{F}_p}
$$
Consider the universal algebra map
$\varphi_{univ} : R_{univ}[x]/(x^p - a) \to R_{univ}[y]/(y^p - b)$
given by mapping $x$ to
$\lambda_0 + \lambda_1 y + \ldots + \lambda_{p - 1}y^{p - 1}$.
We obtain a canonical maps
$$
R_{univ} \longrightarrow R,\quad
M_{univ} \longrightarrow M
$$
compatible with derivations by sending $b, \lambda_i$ to $b, \lambda_i$
and sending $\text{d}b, \text{d}\lambda_i$ to $D(b), D(\lambda_i)$.
By construction the maps
$$
R_{univ}[x]/(x^p - a) \to R[x]/(x^p - a),\quad
R_{univ}[y]/(y^p - b) \to R[y]/(y^p - b)
$$
are compatible with the trace maps. Hence it suffices to prove the
lemma for the map $\varphi_{univ}$. We will do this by evaluating
$\text{Tr}_{y, D}(\varphi(x)^i\text{d}\varphi(x))$ for $i = 0 , \ldots, p - 1$.

\medskip\noindent
The case $0 \leq i \leq p - 2$. Expand
$$
(\lambda_0 + \lambda_1 y + \ldots + \lambda_{p - 1}y^{p - 1})^i
(\lambda_1 + 2 \lambda_2 y + \ldots + (p - 1)\lambda_{p - 1}y^{p - 2})
$$
in the ring $R[y]/(y^p - b)$. We have to show that the coefficient
of $y^{p - 1}$ is zero. For this it suffices to show that
the expression above as a polynomial in $y$ has vanishing
coefficients in front of the powers $y^{pk - 1}$.
Then we write our polynomial as
$$
\frac{\text{d}}{(i + 1)\text{d}y}
(\lambda_0 + \lambda_1 y + \ldots + \lambda_{p - 1}y^{p - 1})^{i + 1}
$$
and indeed the coefficients of $y^{kp - 1}$ are all zero.

\medskip\noindent
The case $i = p - 1$. Expand
$$
(\lambda_0 + \lambda_1 y + \ldots + \lambda_{p - 1}y^{p - 1})^{p - 1}
(\lambda_1 + 2 \lambda_2 y + \ldots + (p - 1)\lambda_{p - 1}y^{p - 2})
$$
in the ring $R[y]/(y^p - b)$. To finish the proof we have to show that
the coefficient of $y^{p - 1}$ times $D(b)$ is $D(a)$. Here we use that
$R$ is $S/pS$ where
$S = \mathbf{Z}[b, \xi_j, \lambda_0, \ldots, \lambda_{p - 1}, \xi_{ij}]$.
Then the above, as a polynomial in $y$, is equal to
$$
\frac{\text{d}}{p\text{d}y}
(\lambda_0 + \lambda_1 y + \ldots + \lambda_{p - 1}y^{p - 1})^p
$$
Since $\frac{\text{d}}{\text{d}y}(y^{pk}) = pk y^{pk - 1}$
it suffices to understand the coefficients of $y^{pk}$ in the polynomial
$(\lambda_0 + \lambda_1 y + \ldots + \lambda_{p - 1}y^{p - 1})^p$
modulo $p$. The sum of these terms gives
$$
\lambda_0^p + \lambda_1^py^p + \ldots + \lambda_{p - 1}^py^{p(p - 1)}
\bmod p
$$
Whence we see that we obtain after applying the operator
$\frac{\text{d}}{p\text{d}y}$ and after reducing modulo $y^p - b$
the value
$$
\lambda_1^p + 2\lambda_2^pb + \ldots + (p - 1)\lambda_{p - 1}b^{p - 2}
$$
for the coefficient of $y^{p - 1}$ we wanted to compute. Now because
$a = \lambda_0^p + \lambda_1^p b + \ldots + \lambda_{p - 1}^pb^{p - 1}$
in $R$ we obtain that
$$
D(a) = (\lambda_1^p  + 2 \lambda_2^p b + \ldots +
(p - 1) \lambda_{p - 1}^p b^{p - 2}) D(b)
$$
in $R$. This proves that the coefficient of $y^{p - 1}$ is as desired.
\end{proof}

\begin{lemma}
\label{lemma-Noetherian-normal-domain-insep-extension}
Let $R$ be a Noetherian normal domain with fraction field $K$.
Let $a \in K$ be an element such that there exists a derivation
$D : R \to R$ with $D(a) \not = 0$. Then the integral closure
of $R$ in $L = K[x]/(x^p - a)$ is finite over $R$.
\end{lemma}

\begin{proof}
After replacing $x$ by $fx$ and $a$ by $f^pa$ for some $f \in R$
we may assume $a \in R$. Hence also $D(a) \in R$. We will show
by induction on $i \leq p - 1$ that if
$$
y = a_0 + a_1x + \ldots + a_i x^i,\quad a_j \in K
$$
is integral over $R$, then $D(a)^i a_j \in R$. Thus the integral
closure is contained in the finite $R$-module with basis
$D(a)^{-p + 1}x^j$, $j = 0, \ldots, p - 1$. Since $R$ is Noetherian
this proves the lemma.

\medskip\noindent
If $i = 0$, then $y = a_0$ is integral over $R$ if and only if $a_0 \in R$
and the statement is true. Suppose the statement holds for some $i < p - 1$
and suppose that
$$
y = a_0 + a_1x + \ldots + a_{i + 1} x^{i + 1},\quad a_j \in K
$$
is integral over $R$. Then
$$
y^p = a_0^p + a_1^p a + \ldots + a_{i + 1}^pa^{i + 1}
$$
is an element of $R$ (as it is in $K$ and integral over $R$). Applying
$D$ we obtain
$$
(a_1^p + 2a_2^p a + \ldots + (i + 1)a_{i + 1}^p a^i)D(a)
$$
is in $R$. Hence it follows that
$$
D(a)a_1 + 2D(a) a_2 x + \ldots + (i + 1)D(a) a_{i + 1} x^i
$$
is integral over $R$. By induction we find $D(a)^{i + 1}a_j \in R$
for $j = 1, \ldots, i + 1$. (Here we use that $1, \ldots, i + 1$
are invertible.) Hence $D(a)^{i + 1}a_0$ is also in $R$ because it
is the difference of $y$ and $\sum_{j > 0} D(a)^{i + 1}a_jx^j$ which
are integral over $R$ (since $x$ is integral over $R$ as $a \in R$).
\end{proof}






\section{Formal glueing of quasi-coherent modules}
\label{section-formal-glueing}

\noindent
This section is the analogue of
More on Algebra, Section \ref{more-algebra-section-formal-glueing}.
In the case of morphisms of schemes, the result can be found in
the paper by Joyet \cite{Joyet}; this is a good place to start reading.
For a discussion of applications to descent problems for stacks, see the
paper by Moret-Bailly \cite{MB}. In the case of an affine
morphism of schemes there is a statement in the appendix of the paper
\cite{Ferrand-Raynaud} but one needs to add the hypothesis
that the closed subscheme is cut out by a finitely generated
ideal (as in the paper by Joyet) since otherwise the result does not hold.
A generalization of this material to (higher) derived categories
with potential applications to nonflat situations
can be found in \cite[Section 5]{Bhatt-Algebraize}.

\medskip\noindent
We start with a lemma on abelian sheaves supported on closed subsets.

\begin{lemma}
\label{lemma-stalk-pushforward-with-support}
Let $S$ be a scheme. Let $f : Y \to X$ be a morphism of algebraic spaces
over $S$. Let $Z \subset X$ closed subspace such that $f^{-1}Z \to Z$ is
integral and universally injective. Let $\overline{y}$ be a geometric point
of $Y$ and $\overline{x} = f(\overline{y})$. We have
$$
(Rf_*Q)_{\overline{x}} = Q_{\overline{y}}
$$
in $D(\textit{Ab})$ for any object $Q$ of $D(Y_\etale)$ supported
on $|f^{-1}Z|$.
\end{lemma}

\begin{proof}
Consider the commutative diagram of algebraic spaces
$$
\xymatrix{
f^{-1}Z \ar[r]_{i'} \ar[d]_{f'} & Y \ar[d]_f \\
Z \ar[r]^i & X
}
$$
By Cohomology of Spaces, Lemma
\ref{spaces-cohomology-lemma-complexes-with-support-on-closed} we can write
$Q = Ri'_*K'$ for some object $K'$ of $D(f^{-1}Z_\etale)$.
By Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-integral-universally-injective-push-pull}
we have $K' = (f')^{-1}K$ with $K = Rf'_*K'$.
Then we have $Rf_*Q = Rf_*Ri'_*K' = Ri_*Rf'_*K' = Ri_*K$.
Let $\overline{z}$ be the geometric point of $Z$ corresponding
to $\overline{x}$ and let $\overline{z}'$ be the geometric point
of $f^{-1}Z$ corresponding to $\overline{y}$. We obtain
the result of the lemma as follows
$$
Q_{\overline{y}} = (Ri'_*K')_{\overline{y}} = K'_{\overline{z}'} =
(f')^{-1}K_{\overline{z}'} = K_{\overline{z}} = Ri_*K_{\overline{x}} =
Rf_*Q_{\overline{x}}
$$
The middle equality holds because of the description of the stalk
of a pullback given in
Properties of Spaces, Lemma \ref{spaces-properties-lemma-stalk-pullback}.
\end{proof}

\begin{lemma}
\label{lemma-stalk-formal-glueing}
Let $S$ be a scheme. Let $f : Y \to X$ be a morphism of algebraic spaces
over $S$. Let $Z \subset X$ closed subspace such that $f^{-1}Z \to Z$ is
integral and universally injective. Let $\overline{y}$ be a geometric point
of $Y$ and $\overline{x} = f(\overline{y})$. Let $\mathcal{G}$
be an abelian sheaf on $Y$. Then the map of two term complexes
$$
\left(f_*\mathcal{G}_{\overline{x}} \to
(f \circ j')_*(\mathcal{G}|_V)_{\overline{x}}\right)
\longrightarrow
\left(\mathcal{G}_{\overline{y}} \to j'_*(\mathcal{G}|_V)_{\overline{y}}\right)
$$
induces an isomorphism on kernels and an injection on cokernels.
Here $V = Y \setminus f^{-1}Z$ and $j' : V \to Y$ is the inclusion.
\end{lemma}

\begin{proof}
Choose a distinguished triangle
$$
\mathcal{G} \to Rj'_*\mathcal{G}|_V \to Q \to \mathcal{G}[1]
$$
n $D(Y_\etale)$. The cohomology sheaves of $Q$
are supported on $|f^{-1}Z|$. We apply $Rf_*$ and we obtain
$$
Rf_*\mathcal{G} \to Rf_*Rj'_*\mathcal{G}|_V \to Rf_*Q
\to Rf_*\mathcal{G}[1]
$$
Taking stalks at $\overline{x}$ we obtain an exact sequence
$$
0 \to
(R^{-1}f_*Q)_{\overline{x}} \to
f_*\mathcal{G}_{\overline{x}} \to
(f \circ j')_*(\mathcal{G}|_V)_{\overline{x}} \to
(R^0f_*Q)_{\overline{x}}
$$
We can compare this with the exact sequence
$$
0 \to
H^{-1}(Q)_{\overline{y}} \to
\mathcal{G}_{\overline{y}} \to
j'_*(\mathcal{G}|_V)_{\overline{y}} \to
H^0(Q)_{\overline{y}}
$$
Thus we see that the lemma follows because
$Q_{\overline{y}} = Rf_*Q_{\overline{x}}$ by
Lemma \ref{lemma-stalk-pushforward-with-support}.
\end{proof}

\begin{lemma}
\label{lemma-stalk-of-pushforward}
Let $S$ be a scheme. Let $X$ be an algebraic space over $S$.
Let $f : Y \to X$ be a quasi-compact and quasi-separated morphism.
Let $\overline{x}$ be a geometric point of $X$ and let
$\Spec(\mathcal{O}_{X, \overline{x}}) \to X$
be the canonical morphism. For a quasi-coherent module
$\mathcal{G}$ on $Y$ we have
$$
f_*\mathcal{G}_{\overline{x}} =
\Gamma(Y \times_X \Spec(\mathcal{O}_{X, \overline{x}}), p^*\mathcal{F})
$$
where $p : Y \times_X \Spec(\mathcal{O}_{X, \overline{x}}) \to Y$
is the projection.
\end{lemma}

\begin{proof}
Observe that $f_*\mathcal{G}_{\overline{x}} =
\Gamma(\Spec(\mathcal{O}_{X, \overline{x}}), h^*f_*\mathcal{G})$
where $h : \Spec(\mathcal{O}_{X, \overline{x}}) \to X$.
Hence the result is true because $h$ is flat so that
Cohomology of Spaces, Lemma
\ref{spaces-cohomology-lemma-flat-base-change-cohomology}
applies.
\end{proof}

\begin{lemma}
\label{lemma-stalk-of-module-with-support}
Let $S$ be a scheme. Let $X$ be an algebraic space over $S$.
Let $i : Z \to X$ be a closed immersion of finite presentation.
Let $Q \in D_\QCoh(\mathcal{O}_X)$ be supported on $|Z|$.
Let $\overline{x}$ be a geometric point of $X$ and let
$I_{\overline{x}} \subset \mathcal{O}_{X, \overline{x}}$ be the stalk of
the ideal sheaf of $Z$. Then the cohomology modules
$H^n(Q_{\overline{x}})$ are $I_{\overline{x}}$-power torsion
(see More on Algebra, Definition
\ref{more-algebra-definition-f-power-torsion}).
\end{lemma}

\begin{proof}
Choose an affine scheme $U$ and an \'etale morphism $U \to X$ such
that $\overline{x}$ lifts to a geometric point $\overline{u}$
of $U$. Then we can replace $X$ by $U$, $Z$ by $U \times_X Z$,
$Q$ by the restriction $Q|_U$, and $\overline{x}$ by $\overline{u}$.
Thus we may assume that $X = \Spec(A)$ is affine. Let $I \subset A$
be the ideal defining $Z$. Since $i : Z \to X$ is of finite presentation,
the ideal $I = (f_1, \ldots, f_r)$ is finitely generated.
The object $Q$ comes from a complex of $A$-modules $M^\bullet$, see
Derived Categories of Spaces, Lemma
\ref{spaces-perfect-lemma-derived-quasi-coherent-small-etale-site}
and
Derived Categories of Schemes, Lemma
\ref{perfect-lemma-affine-compare-bounded}.
Since the cohomology sheaves of $Q$ are supported on $Z$
we see that the localization $M^\bullet_f$ is acyclic for each $f \in I$.
Take $x \in H^p(M^\bullet)$. By the above we can find $n_i$ such
that $f_i^{n_i} x = 0$ in $H^p(M^\bullet)$ for each $i$.
Then with $n = \sum n_i$ we see that $I^n$ annihilates $x$.
Thus $H^p(M^\bullet)$ is $I$-power torsion. Since the ring
map $A \to \mathcal{O}_{X, \overline{x}}$ is flat and since
$I_{\overline{x}} = I\mathcal{O}_{X, \overline{x}}$ we conclude.
\end{proof}

\begin{lemma}
\label{lemma-formal-glueing-on-closed}
Let $S$ be a scheme. Let $f : Y \to X$ be a morphism of algebraic spaces
over $S$. Let $Z \subset X$ be a closed subspace. Assume $f^{-1}Z \to Z$
is an isomorphism and that $f$ is flat in every point of $f^{-1}Z$. For any
$Q$ in $D_\QCoh(\mathcal{O}_Y)$ supported on $|f^{-1}Z|$ we have
$Lf^*Rf_*Q = Q$.
\end{lemma}

\begin{proof}
We show the canonical map $Lf^*Rf_*Q \to Q$ is an isomorphism
by checking on stalks at $\overline{y}$. If $\overline{y}$ is not
in $f^{-1}Z$, then both sides are zero and the result is true.
Assume the image $\overline{x}$ of $\overline{y}$ is in $Z$.
By Lemma \ref{lemma-stalk-pushforward-with-support} we have
$Rf_*Q_{\overline{x}} = Q_{\overline{y}}$ and since $f$ is flat
at $\overline{y}$ we see that
$$
(Lf^*Rf_*Q)_{\overline{y}} =
(Rf_*Q)_{\overline{x}}
\otimes_{\mathcal{O}_{X, \overline{x}}}
\mathcal{O}_{Y, \overline{y}} =
Q_{\overline{y}} \otimes_{\mathcal{O}_{X, \overline{x}}}
\mathcal{O}_{Y, \overline{y}}
$$
Thus we have to check that the canonical map
$$
Q_{\overline{y}} \otimes_{\mathcal{O}_{X, \overline{x}}}
\mathcal{O}_{Y, \overline{y}}
\longrightarrow Q_{\overline{y}}
$$
is an isomorphism in the derived category. Let
$I_{\overline{x}} \subset \mathcal{O}_{X, \overline{x}}$ be the
stalk of the ideal sheaf defining $Z$. Since $Z \to X$ is locally of
finite presentation this ideal is finitely generated and the
cohomology groups of $Q_{\overline{y}}$
are $I_{\overline{y}} = I_{\overline{x}}\mathcal{O}_{Y, \overline{y}}$-power
torsion by Lemma \ref{lemma-stalk-of-module-with-support} applied to $Q$ on $Y$.
It follows that they are also $I_{\overline{x}}$-power torsion.
The ring map
$\mathcal{O}_{X, \overline{x}} \to \mathcal{O}_{Y, \overline{y}}$
is flat and induces an isomorphism after dividing by
$I_{\overline{x}}$ and $I_{\overline{y}}$ because we assumed
that $f^{-1}Z \to Z$ is an isomorphism. Hence we see that
the cohomology modules of
$Q_{\overline{y}} \otimes_{\mathcal{O}_{X, \overline{x}}}
\mathcal{O}_{Y, \overline{y}}$
are equal to the cohomology modules of $Q_{\overline{y}}$ by
More on Algebra, Lemma \ref{more-algebra-lemma-neighbourhood-isomorphism}
which finishes the proof.
\end{proof}

\begin{situation}
\label{situation-formal-glueing}
Here $S$ is a base scheme, $f : Y \to X$ is a quasi-compact
and quasi-separated morphism of algebraic spaces over $S$, and
$Z \to X$ is a closed immersion of finite presentation. We assume that
$f^{-1}(Z) \to Z$ is an isomorphism and that $f$ is flat in every
point $x \in |f^{-1}Z|$. We set $U = X \setminus Z$ and
$V = Y \setminus f^{-1}(Z)$.
Picture
$$
\xymatrix{
V \ar[r]_{j'} \ar[d]_{f|_V} & Y \ar[d]^f \\
U \ar[r]^j & X
}
$$
\end{situation}

\noindent
In Situation \ref{situation-formal-glueing} we define
$\textit{QCoh}(Y \to X, Z)$ as the category of
triples $(\mathcal{H}, \mathcal{G}, \varphi)$ where
$\mathcal{H}$ is a quasi-coherent sheaf of
$\mathcal{O}_U$-modules, $\mathcal{G}$ is a quasi-coherent sheaf
of $\mathcal{O}_Y$-modules, and
$\varphi : f^*\mathcal{H} \to \mathcal{G}|_V$ is an isomorphism
of $\mathcal{O}_V$-modules. There is a canonical
functor
\begin{equation}
\label{equation-formal-glueing-modules}
\QCoh(\mathcal{O}_X) \longrightarrow \textit{QCoh}(Y \to X, Z)
\end{equation}
which maps $\mathcal{F}$ to the system
$(\mathcal{F}|_U, f^*\mathcal{F}, can)$.
By analogy with the proof given in the affine case, we construct
a functor in the opposite direction. To an object
$(\mathcal{H}, \mathcal{G}, \varphi)$ we assign the $\mathcal{O}_X$-module
\begin{equation}
\label{equation-reverse}
\Ker(j_*\mathcal{H} \oplus f_*\mathcal{G} \to (f \circ j')_*\mathcal{G}|_V)
\end{equation}
Observe that $j$ and $j'$ are quasi-compact morphisms as
$Z \to X$ is of finite presentation. Hence $f_*$, $j_*$, and $(f \circ j')_*$
transform quasi-coherent modules into quasi-coherent modules
(Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-pushforward}).
Thus the module (\ref{equation-reverse}) is quasi-coherent.

\begin{lemma}
\label{lemma-adjoint}
In Situation \ref{situation-formal-glueing}.
The functor (\ref{equation-reverse}) is right adjoint to
the functor (\ref{equation-formal-glueing-modules}).
\end{lemma}

\begin{proof}
This follows easily from the adjointness of $f^*$ to $f_*$
and $j^*$ to $j_*$. Details omitted.
\end{proof}

\begin{lemma}
\label{lemma-reverse-commutes-with-flat-base-change}
In Situation \ref{situation-formal-glueing}.
Let $X' \to X$ be a flat morphism of algebraic spaces.
Set $Z' = X' \times_X Z$ and $Y' = X' \times_X Y$.
The pullbacks $\QCoh(\mathcal{O}_X) \to \QCoh(\mathcal{O}_{X'})$
and $\QCoh(Y \to X, Z) \to \QCoh(Y' \to X', Z')$ are compatible
with the functors (\ref{equation-reverse}) and
\ref{equation-formal-glueing-modules}).
\end{lemma}

\begin{proof}
This is true because pullback commutes with pullback and because
flat pullback commutes with pushforward along quasi-compact
and quasi-separated morphisms, see
Cohomology of Spaces, Lemma
\ref{spaces-cohomology-lemma-flat-base-change-cohomology}.
\end{proof}

\begin{proposition}
\label{proposition-formal-glueing-modules}
In Situation \ref{situation-formal-glueing} the functor
(\ref{equation-formal-glueing-modules}) is an equivalence
with quasi-inverse given by (\ref{equation-reverse}).
\end{proposition}

\begin{proof}
We first treat the special case where $X$ and $Y$ are affine schemes
and where the morphism $f$ is flat. Say $X = \Spec(R)$ and $Y = \Spec(S)$.
Then $f$ corresponds to a flat ring map $R \to S$. Moreover, $Z \subset X$
is cut out by a finitely generated ideal $I \subset R$. Choose generators
$f_1, \ldots, f_t \in I$. By the description of quasi-coherent modules
in terms of modules
(Schemes, Section \ref{schemes-section-quasi-coherent-affine}),
we see that the category $\textit{QCoh}(Y \to X, Z)$
is canonically equivalent to the category
$\text{Glue}(R \to S, f_1, \ldots, f_t)$
of More on Algebra, Remark \ref{more-algebra-remark-glueing-data}
such that the functors
(\ref{equation-formal-glueing-modules}) and (\ref{equation-reverse})
correspond to the functors $\text{Can}$ and $H^0$.
Hence the result follows from
More on Algebra, Proposition \ref{more-algebra-proposition-equivalence}
in this case.

\medskip\noindent
We return to the general case.
Let $\mathcal{F}$ be a quasi-coherent module on $X$.
We will show that
$$
\alpha :
\mathcal{F}
\longrightarrow
\Ker\left(j_*\mathcal{F}|_U \oplus f_*f^*\mathcal{F} \to
(f \circ j')_*f^*\mathcal{F}|_V\right)
$$
is an isomorphism. Let $(\mathcal{H}, \mathcal{G}, \varphi)$
be an object of $\QCoh(Y \to X, Z)$. We will show that
$$
\beta :
f^*\Ker\left(
j_*\mathcal{H} \oplus f_*\mathcal{G} \to (f \circ j')_*\mathcal{G}|_V
\right)
\longrightarrow
\mathcal{G}
$$
and
$$
\gamma :
j^*\Ker\left(
j_*\mathcal{H} \oplus f_*\mathcal{G} \to (f \circ j')_*\mathcal{G}|_V
\right)
\longrightarrow
\mathcal{H}
$$
are isomorphisms. To see these statements are true it suffices to
look at stalks. Let $\overline{y}$ be a geometric point of $Y$ mapping
to the geometric point $\overline{x}$ of $X$.

\medskip\noindent
Fix an object $(\mathcal{H}, \mathcal{G}, \varphi)$ of $\QCoh(Y \to X, Z)$.
By Lemma \ref{lemma-stalk-formal-glueing}
and a diagram chase (omitted) the canonical map
$$
\Ker(j_*\mathcal{H} \oplus f_*\mathcal{G} \to
(f \circ j')_*\mathcal{G}|_V)_{\overline{x}}
\longrightarrow
\Ker(
j_*\mathcal{H}_{\overline{x}} \oplus \mathcal{G}_{\overline{y}}
\to
j'_*\mathcal{G}_{\overline{y}}
)
$$
is an isomorphism.

\medskip\noindent
In particular, if $\overline{y}$ is a geometric point of $V$, then
we see that $j'_*\mathcal{G}_{\overline{y}} = \mathcal{G}_{\overline{y}}$
and hence that this kernel is equal to $\mathcal{H}_{\overline{x}}$.
This easily implies that $\alpha_{\overline{x}}$, $\beta_{\overline{x}}$,
and $\beta_{\overline{y}}$ are isomorphisms in this case.

\medskip\noindent
Next, assume that $\overline{y}$ is a point of $f^{-1}Z$.
Let $I_{\overline{x}} \subset \mathcal{O}_{X, \overline{x}}$,
resp.\ $I_{\overline{y}} \subset \mathcal{O}_{Y, \overline{y}}$
be the stalk of the ideal cutting out $Z$, resp.\ $f^{-1}Z$.
Then $I_{\overline{x}}$ is a finitely generated ideal,
$I_{\overline{y}} = I_{\overline{x}}\mathcal{O}_{Y, \overline{y}}$,
and $\mathcal{O}_{X, \overline{x}} \to \mathcal{O}_{Y, \overline{y}}$
is a flat local homomorphism inducing an isomorphism
$\mathcal{O}_{X, \overline{x}}/I_{\overline{x}} =
\mathcal{O}_{Y, \overline{y}}/I_{\overline{y}}$.
At this point we can bootstrap using the diagram of categories
$$
\xymatrix{
\QCoh(\mathcal{O}_X) \ar[r]_-{(\ref{equation-formal-glueing-modules})} \ar[d] &
\QCoh(Y \to X, Z) \ar[d] \ar@/_2pc/[l]^{(\ref{equation-reverse})} \\
\text{Mod}_{\mathcal{O}_{X, \overline{x}}} \ar[r]^-{\text{Can}} &
\text{Glue}(\mathcal{O}_{X, \overline{x}} \to \mathcal{O}_{Y, \overline{y}},
f_1, \ldots, f_t) \ar@/^2pc/[l]_{H^0}
}
$$
Namely, as in the first paragraph of the proof we identify
$$
\text{Glue}(\mathcal{O}_{X, \overline{x}} \to \mathcal{O}_{Y, \overline{y}},
f_1, \ldots, f_t)
=
\QCoh(\Spec(\mathcal{O}_{Y, \overline{y}}) \to
\Spec(\mathcal{O}_{X, \overline{x}}), V(I_{\overline{x}}))
$$
The right vertical functor is given by pullback, and it is clear that
the inner square is commutative. Our computation of the stalk of the
kernel in the third paragraph of the proof combined with
Lemma \ref{lemma-stalk-of-pushforward} implies that
the outer square (using the curved arrows) commutes. Thus we
conclude using the case of a flat morphism of affine schemes
which we handled in the first paragraph of the proof.
\end{proof}

\begin{lemma}
\label{lemma-derived-equivalent}
In Situation \ref{situation-formal-glueing} the functor
$Rf_*$ induces an equivalence between $D_{\QCoh, |f^{-1}Z|}(\mathcal{O}_Y)$
and $D_{\QCoh, |Z|}(\mathcal{O}_X)$ with quasi-inverse given by
$Lf^*$.
\end{lemma}

\begin{proof}
Since $f$ is quasi-compact and quasi-separated we see that $Rf_*$
defines a functor from $D_{\QCoh, |f^{-1}Z|}(\mathcal{O}_Y)$
to $D_{\QCoh, |Z|}(\mathcal{O}_X)$, see
Derived Categories of Spaces, Lemma
\ref{spaces-perfect-lemma-quasi-coherence-direct-image}.
By Derived Categories of Spaces, Lemma
\ref{spaces-perfect-lemma-quasi-coherence-pullback}
we see that $Lf^*$ maps $D_{\QCoh, |Z|}(\mathcal{O}_X)$
into $D_{\QCoh, |f^{-1}Z|}(\mathcal{O}_Y)$.
In Lemma \ref{lemma-formal-glueing-on-closed} we have seen that
$Lf^*Rf_*Q = Q$ for $Q$ in $D_{\QCoh, |f^{-1}Z|}(\mathcal{O}_Y)$.
By the dual of Derived Categories, Lemma
\ref{derived-lemma-fully-faithful-adjoint-kernel-zero}
to finish the proof it suffices to show that $Lf^*K = 0$
implies $K = 0$ for $K$ in $D_{\QCoh, |Z|}(\mathcal{O}_X)$.
This follows from the fact that $f$ is flat at all points of
$f^{-1}Z$ and the fact that $f^{-1}Z \to Z$ is surjective.
\end{proof}

\begin{lemma}
\label{lemma-dominate-by-fpqc-covering}
In Situation \ref{situation-formal-glueing} there exists an
fpqc covering $\{X_i \to X\}_{i \in I}$ refining the
family $\{U \to X, Y \to X\}$.
\end{lemma}

\begin{proof}
For the definition and general properties of fpqc coverings we refer to
Topologies, Section \ref{topologies-section-fpqc}. In particular, we can
first choose an \'etale covering $\{X_i \to X\}$ with $X_i$ affine and by
base changing $Y$, $Z$, and $U$ to each $X_i$ we reduce to the case where
$X$ is affine. In this case $U$ is quasi-compact and hence a finite union
$U = U_1 \cup \ldots \cup U_n$ of affine opens. 
Then $Z$ is quasi-compact hence also $f^{-1}Z$ is quasi-compact.
Thus we can choose an affine scheme $W$ and an \'etale morphism
$h : W \to Y$ such that $h^{-1}f^{-1}Z \to f^{-1}Z$ is surjective.
Say $W = \Spec(B)$ and $h^{-1}f^{-1}Z = V(J)$ where $J \subset B$
is an ideal of finite type.
By Pro-\'etale Cohomology, Lemma \ref{proetale-lemma-localization}
there exists a localization $B \to B'$ such that points of
$\Spec(B')$ correspond exactly to points of $W = \Spec(B)$
specializing to $h^{-1}f^{-1}Z = V(J)$. It follows that the
composition $\Spec(B') \to \Spec(B) = W \to Y \to X$ is flat
as by assumption $f : Y \to X$ is flat at all the points of $f^{-1}Z$. Then
$\{\Spec(B') \to X, U_1 \to X, \ldots, U_n \to X\}$
is an fpqc covering by
Topologies, Lemma \ref{topologies-lemma-recognize-fpqc-covering}.
\end{proof}




\section{Formal glueing of algebraic spaces}
\label{section-formal-glueing-spaces}

\noindent
In Situation \ref{situation-formal-glueing} we consider the category
$\textit{Spaces}(X \to Y, Z)$
of commutative diagrams of algebraic spaces over $S$ of the form
$$
\xymatrix{
U' \ar[d] & V' \ar[l] \ar[d] \ar[r] & Y' \ar[d] \\
U & V \ar[l] \ar[r] & Y
}
$$
where both squares are cartesian. There is a canonical functor
\begin{equation}
\label{equation-formal-glueing-spaces}
\textit{Spaces}/X \longrightarrow \textit{Spaces}(Y \to X, Z)
\end{equation}
which maps $X' \to X$ to the morphisms
$U \times_X X' \leftarrow V \times_X X' \rightarrow Y \times_X X'$.

\begin{lemma}
\label{lemma-equivalence-on-affine}
In Situation \ref{situation-formal-glueing} the functor
(\ref{equation-formal-glueing-spaces}) restricts to an
equivalence
\begin{enumerate}
\item from the category of algebraic spaces affine over $X$
to the full subcategory of $\textit{Spaces}(Y \to X, Z)$ consisting
of $(U' \leftarrow V' \rightarrow Y')$ with $U' \to U$, $V' \to V$,
and $Y' \to Y$ affine, and
\item from the category of closed immersions $X' \to X$
to the full subcategory of $\textit{Spaces}(Y \to X, Z)$ consisting
of $(U' \leftarrow V' \rightarrow Y')$ with $U' \to U$, $V' \to V$,
and $Y' \to Y$ closed immersions.
\end{enumerate}
\end{lemma}

\begin{proof}
The category of algebraic spaces affine over $X$ is equivalent to the
category of quasi-coherent sheaves $\mathcal{A}$ of $\mathcal{O}_X$-algebras.
The full subcategory of $\textit{Spaces}(Y \to X, Z)$ consisting of
$(U' \leftarrow V' \rightarrow Y')$ with $U' \to U$, $V' \to V$,
and $Y' \to Y$ affine is equivalent to the category of
algebra objects of $\QCoh(Y \to X, Z)$. In both cases this follows
from Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-affine-equivalence-algebras}
with quasi-inverse given by the relative spectrum construction
(Morphisms of Spaces, Definition
\ref{spaces-morphisms-definition-relative-spec})
which commutes with arbitrary base change. Thus part (1) of the
lemma follows from Proposition \ref{proposition-formal-glueing-modules}.

\medskip\noindent
Fully faithfulness in part (2) follows from part (1). For essential
surjectivity, we reduce by part (1) to proving that $X' \to X$
is a closed immersion if and only if both $U \times_X X' \to U$ and
$Y \times_X X' \to Y$ are closed immersions. By
Lemma \ref{lemma-dominate-by-fpqc-covering}
$\{U \to X, Y \to X\}$ can be refined by an fpqc covering.
Hence the result follows from
Descent on Spaces, Lemma
\ref{spaces-descent-lemma-descending-property-closed-immersion}.
\end{proof}

\begin{lemma}
\label{lemma-reflects-isomorphisms}
In Situation \ref{situation-formal-glueing} the functor
(\ref{equation-formal-glueing-spaces}) reflects isomorphisms.
\end{lemma}

\begin{proof}
By a formal argument with base change, this reduces to the following
question: A morphism $a : X' \to X$ of algebraic spaces such that
$U \times_X X' \to U$ and $Y \times_X X' \to Y$ are isomorphisms, is
an isomorphism. The family $\{U \to X, Y \to X\}$ can be refined by
an fpqc covering by Lemma \ref{lemma-dominate-by-fpqc-covering}.
Hence the result follows from
Descent on Spaces, Lemma
\ref{spaces-descent-lemma-descending-property-isomorphism}.
\end{proof}

\begin{lemma}
\label{lemma-fully-faithful-on-separated}
In Situation \ref{situation-formal-glueing} the functor
(\ref{equation-formal-glueing-spaces}) is fully faithful
on algebraic spaces separated over $X$. More precisely, it induces
a bijection
$$
\Mor_X(X'_1, X'_2)
\longrightarrow
\Mor_{\textit{Spaces}(Y \to X, Z)}(F(X'_1), F(X'_2))
$$
whenever $X'_2 \to X$ is separated.
\end{lemma}

\begin{proof}
Since $X'_2 \to X$ is separated, the graph $i : X'_1 \to X'_1 \times_X X'_2$
of a morphism $X'_1 \to X'_2$ over $X$ is a closed immersion, see
Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-semi-diagonal}.
Moreover a closed immersion $i : T \to X'_1 \times_X X'_2$ is the graph of a
morphism if and only if $\text{pr}_1 \circ i$ is an isomorphism.
The same is true for
\begin{enumerate}
\item the graph of a morphism $U \times_X X'_1 \to U \times_X X'_2$ over $U$,
\item the graph of a morphism $V \times_X X'_1 \to V \times_X X'_2$ over $V$,
and
\item the graph of a morphism $Y \times_X X'_1 \to Y \times_X X'_2$ over $Y$.
\end{enumerate}
Moreover, if morphisms as in (1), (2), (3) fit together to form a
morphism in the category $\textit{Spaces}(Y \to X, Z)$, then these
graphs fit together to give an object of
$\textit{Spaces}(Y \times_X (X'_1 \times_X X'_2) \to X'_1 \times_X X'_2,
Z \times_X (X'_1 \times_X X'_2))$
whose triple of morphisms are closed immersions. The proof is finished
by applying Lemmas \ref{lemma-equivalence-on-affine} and
\ref{lemma-reflects-isomorphisms}.
\end{proof}







\section{Coequalizers and glueing}
\label{section-coequalizer-glue}

\noindent
Let $X$ be a Noeterian algebraic space and $Z \to X$ a closed subscheme.
Let $X' \to X$ be the blowing up in $Z$. In this section we show that
$X$ can be recovered from $X'$, $Z_n$ and glueing data where $Z_n$
is the $n$th infinitesimal neighbourhood of $Z$ in $X$.

\begin{lemma}
\label{lemma-coequalizer}
Let $S$ be a scheme. Let
$$
\xymatrix{
Y \ar[rr]_g \ar[rd] & & X \ar[ld] \\
& B
}
$$
be a commutative diagram of algebraic spaces over $S$. Assume
$B$ Noeterian, $g$ proper and surjective, and $X \to B$ separated
of finite type. Let $R = Y \times_X Y$ with projection morphisms
$t, s : R \to Y$.  There exists a coequalizer $X'$ of $s, t : R \to Y$
in the category of algebraic spaces separated over $B$. The morphism
$X' \to X$ is a finite universal homeomorphism.
\end{lemma}

\begin{proof}
Denote $h : R \to X$ the given morphism. The sheaves
$$
g_*\mathcal{O}_Y
\quad\text{and}\quad
h_*\mathcal{O}_R
$$
are coherent $\mathcal{O}_X$-algebras
(Cohomology of Spaces, Lemma
\ref{spaces-cohomology-lemma-proper-pushforward-coherent}).
The $X$-morphisms $s$, $t$ induce $\mathcal{O}_X$-agebra maps
$s^\sharp, t^\sharp$ from the first to the second.
Set
$$
\mathcal{A} = \text{Equalizer}\left(s^\sharp, t^\sharp :
g_*\mathcal{O}_Y \longrightarrow h_*\mathcal{O}_R\right)
$$
Then $\mathcal{A}$ is a coherent $\mathcal{O}_X$-algebra and we
can define
$$
X' = \underline{\Spec}_X(\mathcal{A})
$$
as in Morphisms of Spaces, Definition
\ref{spaces-morphisms-definition-relative-spec}.
By Morphisms of Spaces, Remark
\ref{spaces-morphisms-remark-factorization-quasi-compact-quasi-separated}
and functoriality of the $\underline{\Spec}$ construction
there is a factorization
$$
Y \longrightarrow X' \longrightarrow X
$$
and the morphism $g' : Y \to X'$ equalizes $s$ and $t$.
Since $\mathcal{A}$ is a coherent $\mathcal{O}_X$-module it is clear that
$X' \to X$ is a finite morphism of algebraic spaces. Since the
surjective morphism $g : Y \to X$ factors through $X'$ we see that
$X' \to X$ is surjective.

\medskip\noindent
To check that $X' \to X$ is a universal homeomorphism, it suffices
to check that it is universally injective (as we've already seen that
it is universally surjective and universally closed). To check this it
suffices to check that $|X' \times_X U| \to |U|$ is injective, for all
$U \to X$ \'etale, see
More on Morphisms of Spaces, Lemma
\ref{spaces-more-morphisms-lemma-check-universally-injective}.
It suffices to check this in all cases where $U$ is an affine scheme
(minor detail omitted). Since the construction of $X'$
commutes with \'etale localization, we may replace $U$ by $X$.
Hence it suffices to check that $|X'| \to |X|$ is injective
when $X$ is moreover an affine scheme. First observe that
$|Y| \to |X'|$ is surjective, because $g' : Y \to X'$ is proper
by Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-universally-closed-permanence}
(hence the image is closed) and
$\mathcal{O}_{X'} \subset g'_*\mathcal{O}_Y$ by construction.
Thus if $x_1, x_2 \in |X'|$ map to the same point in $|X|$, then
we can lift $x_1, x_2$ to points $y_1, y_2 \in |Y|$ mapping to the
same point of $|X|$. Then we can find an $r \in |R|$ with
$s(r) = y_1$ and $t(r) = y_2$, see
Properties of Spaces, Lemma \ref{spaces-properties-lemma-points-cartesian}).
Since $g'$ coequalizes $s$ and $t$ we conclude that $x_1 = x_2$ as desired.

\medskip\noindent
To prove that $X'$ is the coequalizer, let $W \to B$ be a separated morphism
of algebraic spaces over $S$ and let $a : Y \to W$ be a morphism over $B$
which equalizes $s$ and $t$. We will show that $a$ factors in a unique manner
through the morphism $g' : Y \to X'$. We will first reduce this to the
case where $W \to B$ is separated of finite type by a limit argument
(we recommend the reader skip this argument). Since $Y$ is quasi-compact
we can find a quasi-compact open subspace $W' \subset W$ such that $a$
factors through $W'$. After replacing $W$ by $W'$ we may assume $W$ is
quasi-compact. By Limits of Spaces, Lemma
\ref{spaces-limits-lemma-relative-approximation}
we can write $W = \lim_{i \in I} W_i$ as a cofiltered limit with
affine transition morphisms with $W_i$ of finite type over $B$. After
shrinking $I$ we may assume $W_i \to B$ is separated as well, see
Limits of Spaces, Lemma \ref{spaces-limits-lemma-descend-separated-morphism}.
Since $W = \lim W_i$ we have $a = \lim a_i$ for some morphisms
$a_i : Y \to W_i$. If we can prove $a_i$ factors through $g'$
for all $i$, then the same thing is true for $a$.
This proves the reduction to the case of a finite type $W$.

\medskip\noindent
Assume we have $a : Y \to W$ equalizing $s$ and $t$ with $W \to B$ separated
and of finite type. Consider
$$
\Gamma \subset X \times_B W
$$
the scheme theoretic image of $(g, a) : Y \to X \times_B W$.
Since $g$ is proper we conclude $Y \to \Gamma$ is surjective and
the projection $p : \Gamma \to X$ is proper, see
Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-scheme-theoretic-image-is-proper}.
Since both $g$ and $a$ equalize $s$ and $t$, the morphism $Y \to \Gamma$
also equalizes $s$ and $t$.

\medskip\noindent
We claim that $p : \Gamma \to X$ is a universal homeomorphism.
As in the proof of the corresponding fact for $X' \to X$, it
suffices to show that $p$ is universally injective. By
More on Morphisms of Spaces, Lemma
\ref{spaces-more-morphisms-lemma-check-universally-injective}
it suffices to check $|\Gamma \times_X U| \to |U|$ is injective
for every $U \to X$ \'etale. It suffices to check this for
$U$ affine (minor details omitted). Taking scheme
theoretic image commutes with \'etale localization
(Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-quasi-compact-scheme-theoretic-image}).
Hence we may replace $X$ by $V$ and we conclude it suffices
to show that $|\Gamma| \to |X|$ is injective.
If $\gamma_1, \gamma_2 \in |\Gamma|$ map to the same point in $|X|$, then
we can lift $\gamma_1, \gamma_2$ to points $y_1, y_2 \in |Y|$ mapping to the
same point of $|X|$ (by surjectivity of $Y \to \Gamma$ we've seen above).
Then we can find an $r \in |R|$ with $s(r) = y_1$ and $t(r) = y_2$, see
Properties of Spaces, Lemma \ref{spaces-properties-lemma-points-cartesian}).
Since $Y \to \Gamma$ coequalizes $s$ and $t$ we conclude that
$\gamma_1 = \gamma_2$ as desired.

\medskip\noindent
As a proper universal homeomorphism the morphism $p$ is finite
(see for example More on Morphisms of Spaces, Lemma
\ref{spaces-more-morphisms-lemma-characterize-finite}).
We conclude that
$$
\Gamma = \underline{\Spec}(p_*\mathcal{O}_\Gamma).
$$
Since $Y \to \Gamma$ equalizes $s$ and $t$ the map
$p_*\mathcal{O}_\Gamma \to g_*\mathcal{O}_Y$ factors through
$\mathcal{A}$ and we obtain a morphism
$X' \to \Gamma$ by functoriality of the $\underline{\Spec}$ construction.
We can compose this morphism with the projection
$q : \Gamma \to W$ to get the desired morphism $X' \to W$.
We omit the proof of uniqueness of the factorization.
\end{proof}

\noindent
We will work in the following situation.

\begin{situation}
\label{situation-coequalizer-glue}
Let $S$ be a scheme. Let $X \to B$ be a separated finite type morphism of
algebraic spaces over $S$ with $B$ Noetherian. Let
$Z \to X$ be a closed immersion and let $U \subset X$ be the complementary
open subspace. Finally, let $f : X' \to X$ be a proper morphism of algebraic
spaces such that $f^{-1}(U) \to U$ is an isomorphism.
\end{situation}

\begin{lemma}
\label{lemma-coequalizer-glue}
In Situation \ref{situation-coequalizer-glue} let
$Y = X' \amalg Z$ and $R = Y \times_X Y$ with projections $t, s : R \to Y$.
There exists a coequalizer $X_1$ of $s, t : R \to Y$ in the category
of algebraic spaces separated over $B$. The morphism
$X_1 \to X$ is a finite universal homeomorphism, an isomorphism
over $U$ and $Z \to X$ lifts to $X_1$.
\end{lemma}

\begin{proof}
Existence of $X_1$ and the fact that $X_1 \to X$ is a finite
universal homeomorphism is a special case of Lemma \ref{lemma-coequalizer}.
The formation of $X_1$ commutes with \'etale localization on $X$
(see proof of Lemma \ref{lemma-coequalizer}).
Thus the morphisms $X_n \to X$ are isomorphisms over $U$.
It is immediate from the construction that $Z \to X$ lifts to $X_1$.
\end{proof}

\noindent
In Situation \ref{situation-coequalizer-glue} for $n \geq 1$ let
$Z_n \subset X$ be the $n$th order infinitesimal neighbourhood
of $Z$ in $X$, i.e., the closed subscheme defined by the $n$th
power of the sheaf of ideals cutting out $Z$. Consider $Y_n = X' \amalg Z_n$
and $R_n = Y_n \times_X Y_n$ and the coequalizer
$$
\xymatrix{
R_n \ar@<1ex>[r] \ar@<-1ex>[r] & Y_n \ar[r] & X_n \ar[r] & X
}
$$
as in Lemma \ref{lemma-coequalizer-glue}. The maps $Y_n \to Y_{n + 1}$
and $R_n \to R_{n + 1}$ induce morphisms
\begin{equation}
\label{equation-system-coequalizers}
X_1 \to X_2 \to X_3 \to \ldots \to X
\end{equation}
Each of these morphisms is a universal homeomorphism as the morphisms
$X_n \to X$ are universal homeomorphisms.

\begin{lemma}
\label{lemma-essentially-constant}
In (\ref{equation-system-coequalizers}) for all $n$ large enough, there
exists an $m$ such that $X_n \to X_{n + m}$ factors through a
closed immersion $X \to X_{n + m}$.
\end{lemma}

\begin{proof}
Let's look a bit more closely at the construction of $X_n$
and how it changes as we increase $n$. We have
$X_n = \underline{\Spec}(\mathcal{A}_n)$
where $\mathcal{A}_n$ is the equalizer of $s_n^\sharp$ and $t_n^\sharp$
going from $g_{n , *}\mathcal{O}_{Y_n}$ to $h_{n, *}\mathcal{O}_{R_n}$.
Here $g_n : Y_n = X' \amalg Z_n \to X$ and $h_n : R_n = Y_n \times_X Y_n \to X$
are the given morphisms. Let $\mathcal{I} \subset \mathcal{O}_X$ be the
coherent sheaf of ideals corresponding to $Z$. Then
$$
g_{n, *}\mathcal{O}_{Y_n} =
f_*\mathcal{O}_{X'} \times \mathcal{O}_X/\mathcal{I}^n
$$
Similarly, we have a decomposition
$$
R_n = X' \times_X X' \amalg X" \times_X Z_n \amalg Z_n \times_X Z_n
$$
Denote $f_n : X' \times_X Z_n \to X$ the restriction of $f$
and denote
$$
\mathcal{A} = \text{Equalizer}(
\xymatrix{
f_*\mathcal{O}_{X'} \ar@<1ex>[r] \ar@<-1ex>[r] &
(f \times f)_*\mathcal{O}_{X' \times_X X'}\
}
)
$$
Then we see that
$$
\mathcal{A}_n =
\text{Equalizer}(
\xymatrix{
\mathcal{A} \times \mathcal{O}_X/\mathcal{I}^n \ar@<1ex>[r] \ar@<-1ex>[r] &
f_{n, *}\mathcal{O}_{X' \times_X Z_n}
}
)
$$
We have canonical maps
$$
\mathcal{O}_X \to \ldots \to \mathcal{A}_3 \to \mathcal{A}_2 \to \mathcal{A}_1
$$
of coherent $\mathcal{O}_X$-algebras. The statement of the lemma means that
for $n$ large enough there exists an $m \geq 0$ such that the image of
$\mathcal{A}_{n + m} \to \mathcal{A}_n$ is isomorphic to $\mathcal{O}_X$.

\medskip\noindent
Since $X_n \to X$ is an isomorphism over $U$ we see that the kernel
of $\mathcal{O}_X \to \mathcal{A}_n$ is supported on $|Z|$.
Since $X$ is Noetherian, the sequence of kernels
$\mathcal{J}_n = \text{Ker}(\mathcal{O}_X \to \mathcal{A}_n)$ stabilizes
(Cohomology of Spaces, Lemma \ref{spaces-cohomology-lemma-acc-coherent}).
Say $\mathcal{J}_{n_0} = \mathcal{J}_{n_0 + 1} = \ldots = \mathcal{J}$.
By Cohomology of Spaces, Lemma
\ref{spaces-cohomology-lemma-power-ideal-kills-sheaf}
we find that $\mathcal{I}^t \mathcal{J} = 0$ for some $t \geq 0$.
On the other hand, there is an $\mathcal{O}_X$-algebra map
$\mathcal{A}_n \to \mathcal{O}_X/\mathcal{I}^n$
and hence $\mathcal{J} \subset \mathcal{I}^n$ for all $n$.
By Artin-Rees (Cohomology of Spaces, Lemma
\ref{spaces-cohomology-lemma-Artin-Rees}) we find that
$\mathcal{J} \cap \mathcal{I}^n \subset \mathcal{I}^{n - c}\mathcal{J}$
for some $c  \geq 0$ and all $n \gg 0$. We conclude that $\mathcal{J} = 0$.

\medskip\noindent
Pick $n \geq n_0$ as in the previous paragraph. Then
$\mathcal{O}_X \to \mathcal{A}_n$ is injective. Hence it now
suffices to find $m \geq 0$ such that the image of
$\mathcal{A}_{n + m} \to \mathcal{A}_n$ is equal
to the image of $\mathcal{O}_X$. Observe that $\mathcal{A}_n$
sits in a short exact sequence
$$
0 \to \Ker(\mathcal{A} \to f_{n, *}\mathcal{O}_{X' \times_X Z_n})
\to \mathcal{A}_n \to \mathcal{O}_X/\mathcal{I}^n \to 0
$$
and similarly for $\mathcal{A}_{n + m}$. Hence it suffices to show
$$
\Ker(\mathcal{A} \to f_{n + m, *}\mathcal{O}_{X' \times_X Z_{n + m}})
\subset
\Im(\mathcal{I}^n \to \mathcal{A})
$$
for some $m \geq 0$. To do this we may work \'etale locally on
$X$ and since $X$ is Noetherian we may assume that $X$ is
a Noetherian affine scheme. Say $X = \Spec(R)$ and $\mathcal{I}$
corresponds to the ideal $I \subset R$. Let $\mathcal{A} = \widetilde{A}$
for a finite $R$-algebra $A$. Let $f_*\mathcal{O}_{X'} = \widetilde{B}$
for a finite $R$-algebra $B$. Then $R \to A \subset B$ and these maps
become isomorphisms on inverting any element of $I$.

\medskip\noindent
Note that $f_{n, *}\mathcal{O}_{X' \times_X Z_n}$
is equal to $f_*(\mathcal{O}_{X'}/I^n\mathcal{O}_{X'})$
in the notation used in Cohomology of Spaces, Section
\ref{spaces-cohomology-section-theorem-formal-functions}.
By Cohomology of Spaces, Lemma
\ref{spaces-cohomology-lemma-ML-cohomology-powers-ideal}
we see that there exists a $c \geq 0$ such that
$$
\Ker(B \to \Gamma(X, f_*(\mathcal{O}_{X'}/I^{n + m + c}\mathcal{O}_{X'}))
$$
is contained in $I^{n + m}B$. On the other hand, as $R \to B$ is
finite and an isomorphism after inverting any element of $I$
we see that $I^{n + m}B \subset \Im(I^n \to B)$ for $m$ large enough
(can be chosen independent of $n$). This finishes the proof as $A \subset B$.
\end{proof}

\begin{remark}
\label{remark-essentially-constant}
The meaning of Lemma \ref{lemma-essentially-constant}
is the the system $X_1 \to X_2 \to X_3 \to \ldots$ is essentially
constant with value $X$. See Categories, Definition
\ref{categories-definition-essentially-constant-diagram}.
\end{remark}









\section{Formal schemes \`a la EGA}
\label{section-formal-schemes-EGA}

\noindent
In this section we review the construction of formal schemes in \cite{EGA}.
This notion, although very useful in algebraic geometry,
may not always be the correct to consider. Perhaps it is better to say
that in the setup of the theory a number choices are made, where for
different purposes others might work better. And indeed in the literature
one can find many different closely related theories
adapted to the problem the authors may want to consider. Still, one
of the major advantages of the theory as sketched here is that one
gets to work with definite geometric objects.

\medskip\noindent
Before we start we should point out an issue with the sheaf condition
for sheaves of topological rings or more generally sheaves of topological
abelian groups. Namely, the big categories
\begin{enumerate}
\item category of topological spaces,
\item category of topological abelian groups,
\item category of topological rings,
\item category of topological modules over a given topological ring,
\end{enumerate}
endowed with their natural forgetful functors to $\textit{Sets}$ are not
examples of types of algebraic structures as defined in
Sheaves, Section \ref{sheaves-section-algebraic-structures}.
Thus we cannot blithely use the machinery developed in that
chapter to them. On the other hand, each of the categories
listed above has products, so we can define the notion of a
sheaf as in Sheaves, Definition
\ref{sheaves-definition-sheaf-values-in-category}.
Moreover, products still commute with the forgetful functor
to $\textit{Sets}$ so the underlying presheaf of sets
of a sheaf of topological spaces (for example) is a sheaf of
sets. The key difference is that for an open covering
$U = \bigcup_{i \in I} U_i$ the diagram
$$
\xymatrix{
\mathcal{F}(U) \ar[r]
&
\prod\nolimits_{i\in I}
\mathcal{F}(U_i)
\ar@<1ex>[r] \ar@<-1ex>[r]
&
\prod\nolimits_{(i_0, i_1) \in I \times I}
\mathcal{F}(U_{i_0} \cap U_{i_1})
}
$$
has to be an equalizer diagram in the category of topological
spaces, groups, rings, modules, i.e., that the first map identifies
$\mathcal{F}(U)$ with a subspace of $\prod_{i \in I} \mathcal{F}(U_i)$
which is endowed with the product topology.
The stalk $\mathcal{F}_x$ of a sheaf $\mathcal{F}$
of topological spaces, abelian groups, rings, or modules
at a point $x \in X$ is defined as the colimit
$$
\mathcal{F}_x = \colim_{x\in U} \mathcal{F}(U)
$$
in the corresponding category, which is the same as taking
the colimit on the level of underlying sheaves of sets, groups,
rings, or modules but comes equipped with a topology (the colimit
topology).

\medskip\noindent
Let $f : X \to Y$ be a continuous map of topological spaces.
There is a functor $f_*$ from the category of sheaves of topological
spaces, abelian groups, rings, modules, to the corresponding category
of sheaves on $Y$ which is defined by setting
$f_*\mathcal{F}(V) = \mathcal{F}(f^{-1}V)$ as usual.
(We delay discussing the pullback in this setting till later.)
We define the notion of an $f$-map $\xi : \mathcal{G} \to \mathcal{F}$
between a sheaf of topoligical spaces $\mathcal{G}$ on $Y$ and
a sheaf of topological spaces $\mathcal{F}$ on $X$ in exactly the
same manner as in Sheaves, Definition \ref{sheaves-definition-f-map}
with the additional constraint that
$\xi_V : \mathcal{G}(V) \to \mathcal{F}(f^{-1}V)$ be continuous
for every open $V \subset Y$. We have
$$
\{f\text{-maps from }\mathcal{G}\text{ to }\mathcal{F}\} =
\text{Mor}_{\Sh(Y, \textit{Top})}(\mathcal{G}, f_*\mathcal{F})
$$
as in Sheaves, Lemma \ref{sheaves-lemma-f-map}. Similarly for
sheaves of topological abelian groups, rings, modules. Finally,
let $\xi : \mathcal{G} \to \mathcal{F}$ be an $f$-map as above.
Then given $x \in X$ with image $y = f(x)$ there is a continuous
map
$$
\xi_x : \mathcal{G}_y \longrightarrow \mathcal{F}_x
$$
of stalks defined in exactly the same manner as in the discussion
following Sheaves, Definition \ref{sheaves-definition-composition-f-maps}.

\medskip\noindent
Using the discussion above, we can define a category $LTRS$ of
``locally topologically ringed spaces''. An object is a pair
$(X, \mathcal{O}_X)$ consisting of a topological space
$X$ and a sheaf of topological rings $\mathcal{O}_X$ whose stalks
$\mathcal{O}_{X, x}$ are local rings (if one forgets about the topology).
A morphism $(X, \mathcal{O}_X) \to (Y, \mathcal{O}_Y)$ of
$LTRS$ is a pair $(f, f^\sharp)$ where $f : X \to Y$ is a continuous
map of topological spaces and $f^\sharp : \mathcal{O}_Y \to \mathcal{O}_X$
is an $f$-map such that for every $x \in X$ the induced map
$$
f^\sharp_x : \mathcal{O}_{Y, f(x)} \longrightarrow \mathcal{O}_{X, x}
$$
is a local homomorphism of local rings (forgetting about the topologies).
The composition works in exactly the same manner as composition of
morphisms of locally ringed spaces.

\medskip\noindent
Assume now that the topological space $X$ has a basis consisting
of quasi-compact opens. Given a sheaf $\mathcal{G}$ of sets, abelian groups,
rings, modules over a ring, one can endow $\mathcal{G}$ with
the structure of a sheaf of topological spaces, abelian groups,
rings, modules. Namely, if $U \subset X$ is quasi-compact open,
we endow $\mathcal{F}(U)$ with the discrete topology. If $U \subset X$
is arbitrary, then we choose an open covering $U = \bigcup_{i \in I} U_i$
by quasi-compact opens and we endow $\mathcal{F}(U)$ with
the induced topology from $\prod_{i \in I} \mathcal{F}(U_i)$
(as we should do according to our discussion above).
The reader may verify (omitted) that we obtain a sheaf of topological
spaces, groups, rings, modules in this fashion. Let us say
that a sheaf of topological spaces, groups, rings, modules is
{\it pseuod-discrete} if the topology on $\mathcal{F}(U)$ is
discrete for every quasi-compact open $U \subset X$. Then
the construction given above is an adjoint to the forgetful functor
and induces an equivalence between the category of sheaves
of sets and the category of pseudo-discrete sheaves of topological space
(similarly for groups, rings, modules).

\medskip\noindent
Grothendieck and Dieudonn\'e first define formal affine schemes.
These correspond to admissible topological rings $A$, see
More on Algebra, Definition \ref{more-algebra-definition-topological-ring}.
Namely, given $A$ one considers a fundamental system $I_\lambda$ of ideals
of definition for the ring $A$. (For example, we can consider the family
of all ideals of definition.) For each $\lambda$ we can consider the
scheme $\Spec(A/I_\lambda)$. For $I_\lambda \subset I_\mu$ the induced
morphism
$$
\Spec(A/I_\mu) \to \Spec(A/I_\lambda)
$$
is a thickening because $I_\mu^n \subset I_\lambda$ for some $n$.
Another way to see this, is to notice that the image of each of the
maps
$$
\Spec(A/I_\lambda) \to \Spec(A)
$$
is a homeomorphism onto the set of open prime ideals of $A$.
This motivates the definition
$$
\text{Spf}(A) = \{\text{open prime ideals }\mathfrak p \subset A\}
$$
endowed with the topology coming from $\Spec(A)$. For each $\lambda$
we can consider the structure sheaf $\mathcal{O}_{\Spec(A/I_\lambda}$
as a sheaf on $\text{Spf}(A)$. Let $\mathcal{O}_\lambda$ be the corresponding
pseudo-discrete sheaf of topological rings, see above.
Then we set
$$
\mathcal{O}_{\text{Spf}(A)} = \lim \mathcal{O}_\lambda
$$
where the limit is taken in the category of sheaves of topological rings.
The pair $(\text{Spf}(A), \mathcal{O}_{\text{Spf}(A)})$ is called the
{\it formal spectrum} of $A$.

\medskip\noindent
At this point one should check several things. The first is that
the stalks $\mathcal{O}_{\text{Spf}(A), x}$ are local rings
(forgetting about the topology). The second is that given
$f \in A$, for the corresponding open $D(f) \cap \text{Spf}(A)$
we have
$$
\Gamma(D(f) \cap \text{Spf}(A), \mathcal{O}_{\text{Spf}(A)})
= A_{\{f\}} = \lim (A/I_\lambda)_f
$$
as topological rings where $I_\lambda$ is a fundamental system of ideals
of definition as above. Moreover, the ring $A_{\{f\}}$ is admissible too and
$(\text{Spf}(A_f), \mathcal{O}_{\text{Spf}(A_{\{f\}})})$
is isomorphic to
$(D(f) \cap \text{Spf}(A),
\mathcal{O}_{\text{Spf}(A)}|_{D(f) \cap \text{Spf}(A)})$.
Finally, given a pair of admissible topological rings $A, B$
we have
\begin{equation}
\label{equation-morphisms-affine-formal-schemes}
\Mor_{LTRS}((\text{Spf}(B), \mathcal{O}_{\text{Spf}(B)}),
(\text{Spf}(A), \mathcal{O}_{\text{Spf}(A)}))
= \Hom_{cont}(A, B)
\end{equation}
where $LTRS$ is the category of ``locally topologically ringed spaces''
as defined above.

\medskip\noindent
Having said this, in \cite{EGA} a {\it formal scheme} is defined as a pair
$(\mathfrak X, \mathcal{O}_\mathfrak X)$ where $\mathfrak X$
is a topological space and $\mathcal{O}_\mathfrak X$ is a sheaf
of topological rings such that every point has an open neighbourhood
isomorphic (in $LTRS$) to an affine formal scheme.
A {\it morphism of formal schemes}
$f : (\mathfrak X, \mathcal{O}_\mathfrak X) \to
(\mathfrak Y, \mathcal{O}_\mathfrak Y)$
is a morphism in the category $LTRS$.

\medskip\noindent
Let $A$ be a ring endowed with the discrete topology. Then $A$ is
admissible and the formal scheme $\text{Spf}(A)$ is equal to
$\Spec(A)$. The structure sheaf $\mathcal{O}_{\text{Spf}(A)}$
is the pseudo-discrete sheaf of topological rings associated
to $\mathcal{O}_{\Spec(A)}$, in other words, its underlying
sheaf of rings is equal to $\mathcal{O}_{\Spec(A)}$ and the
ring $\mathcal{O}_{\text{Spf}(A)}(U) = \mathcal{O}_{\Spec(A)(U)}$
over a quasi-compact open $U$ has the discrete topology,
but not in general. Thus we can associate to every affine scheme
a formal affine scheme. In exactly the same manner we can start
with a general scheme $(X, \mathcal{O}_X)$ and associate to
it $(X, \mathcal{O}'_X)$ where $\mathcal{O}'_X$ is the
pseudo-discrete sheaf of topological rings whose underlying
sheaf of rings is $\mathcal{O}_X$. This construction is
compatible with morphisms and defines a functor
\begin{equation}
\label{equation-compare-schemes-formal-schemes}
\textit{Schemes} \longrightarrow \textit{Formal Schemes}
\end{equation}
It follows in a straightforward manner from
(\ref{equation-morphisms-affine-formal-schemes})
that this functor is fully faithful.

\begin{remark}[Sheafification of presheaves of topological spaces]
\label{remark-sheafification-of-presheaves-in-top}
\begin{reference}
\cite{Gray}
\end{reference}
In this remark we briefly discuss sheafification of presheaves
of topological spaces. The exact same arguments work for
presheaves of topological abelian groups, topological rings, and
topological modules (over a given topological ring). In order to
do this in the correct generality let us work over a site
$\mathcal{C}$. The reader who is interested in the case of (pre)sheaves
over a topological space $X$ should think of objects of $\mathcal{C}$
as the opens of $X$, of morphisms of $\mathcal{C}$ as inclusions of
opens, and of coverings in $\mathcal{C}$ as coverings in $X$, see
Sites, Example \ref{sites-example-site-topological}.
Let $\mathcal{F}$ be a presheaf of topological spaces on $\mathcal{C}$.
To produce the sheaficication, we need to show that the functor
$$
\mathcal{G}
\longmapsto
F(\mathcal{G}) =
\Mor_{\textit{PSh}(\mathcal{C}, \textit{Top})}(\mathcal{F}, \mathcal{G})
$$
is representable on the category $\Sh(\mathcal{C}, \textit{Top})$
of sheaves of topological spaces on $\mathcal{C}$. To prove this
We first claim that $\Sh(\mathcal{C}, \textit{Top})$ has limits
and that $F$ commutes with them. Namely, given a category $\mathcal{I}$
and a functor $i \mapsto \mathcal{G}_i$ into $\Sh(\mathcal{C}, \textit{Top})$
we simply define
$$
(\lim \mathcal{G}_i)(U) = \lim \mathcal{G}_i(U)
$$
where we take the limit in the category of toplogical spaces
(Topology, Lemma \ref{topology-lemma-limits}). This defines a sheaf
because limits commute with limits
(Categories, Lemma \ref{categories-lemma-colimits-commute})
and in particular products and equalizers (which are the
operations used in the sheaf axiom). Finally, a morphism
of presheaves from $\mathcal{F} \to \lim \mathcal{G}_i$ is
clearly the same thing as a compatible system of morphisms
$\mathcal{F} \to \mathcal{G}_i$. In other words, the object
$\lim \mathcal{G}_i$ is the limit in the category
of presheaves of topological spaces and a fortiori in the
category of sheaves of topological spaces.
Our second claim is that any morphism of presheaves
$\mathcal{F} \to \mathcal{G}$ with $\mathcal{G}$ an object of
$\Sh(\mathcal{C}, \textit{Top})$ factors through a subsheaf
$\mathcal{G}' \subset \mathcal{G}$ whose size is bounded.
Here we define the {\it size} $|\mathcal{H}|$
of a sheaf of topological spaces $\mathcal{H}$ to be the cardinal
$\sup_{U \in \Ob(\mathcal{C})} |\mathcal{H}(U)|$.
To prove our claim we let
$$
\mathcal{G}'(U) =
\left\{
\quad
s \in \mathcal{G}(U)
\quad \Big | \quad
\begin{matrix}
\text{there exists a covering }\{U_i \to U\}_{i \in I} \\
\text{such that }
s|_{U_i} \in \Im(\mathcal{F}(U_i) \to \mathcal{G}(U_i))
\end{matrix}
\quad
\right\}
$$
We endow $\mathcal{G}'(U)$ with the induced topology.
Then $\mathcal{G}'$ is a sheaf of topological spaces (details omitted)
and $\mathcal{G}' \to \mathcal{G}$ is a morphism through which
the given map $\mathcal{F} \to \mathcal{G}$ factors. Moreover,
the size of $\mathcal{G}'$ is bounded by some cardinal
$\kappa$ depending only on $\mathcal{C}$ and the presheaf $\mathcal{F}$
(hint: use that coverings in $\mathcal{C}$
form a set by our conventions). Putting everything together we set
$$
\mathcal{F}^\# = \lim_{\varphi : \mathcal{F} \to \mathcal{G}} \mathcal{G}
$$
Here we take the limit is over the category of arrows
$\varphi : \mathcal{F} \to \mathcal{G}$ of presheaves of topological
spaces where $\mathcal{G}$ is a sheaf of topological spaces
of size $|\mathcal{G}| \leq \kappa$.
There is a canonical arrow $\mathcal{F} \to \mathcal{F}^\#$ and
a straightforward argument (omitted) shows that $\mathcal{F}^\#$ represents
the functor $F$ defined above. Finally, let $p$ be a point of the
site $\mathcal{C}$ given by a functor $u : \mathcal{C} \to \textit{Sets}$,
see Sites, Definition \ref{sites-definition-point}.
For a topological space $M$ the presheaf defined by the rule
$$
U \mapsto \text{Map}(u(U), M) = \prod\nolimits_{x \in u(U)} M
$$
endowed with the product topology is a sheaf of topological spaces.
Hence the exact same argument as given in the proof of
Sites, Lemma \ref{sites-lemma-point-pushforward-sheaf} shows that
$\mathcal{F}_p = \mathcal{F}^\#_p$, in other words, sheafification
commutes with taking stalks at a point.
\end{remark}










\section{Restricted power series}
\label{section-approximation-pre}

\noindent
Let $A$ be a ring. Let $I \subset A$ be an ideal.
Let $A[x_1, \ldots, x_r]^\wedge$ denote the $I$-adic completion of the
polynomial ring. We think of elements of $A[x_1, \ldots, x_r]^\wedge$ as
power series
$$
f = \sum\nolimits_{E = (e_1, \ldots, e_r)} a_E x_1^{e_1} \ldots x_r^{e_r}
$$
in $x_1, \ldots, x_r$ with coefficients $a_E \in A^\wedge$ which tend
to zero in the $I$-adic topology. In other words, for any $t \geq 0$
all but a finite number of $a_E$ are in $I^t$.
For this reason elements of $A[x_1, \ldots, x_r]^\wedge$ are sometimes
called {\it restricted power series} and when $A$ is $I$-adically complete
the ring $A[x_1, \ldots, x_r]^\wedge$ is sometimes denoted
$A\{x_1, \ldots, x_r\}$ or $A\langle x_1, \ldots, x_r\rangle$.
We will refrain from using this notation.

\begin{remark}[Universal property restricted power series]
\label{remark-universal-property}
Let $A$ be a ring and $I \subset A$ be a finitely generated ideal.
Let $C$ be an $I$-adically complete $A$-algebra. Then any $A$-algebra
map $A[x_1, \ldots x_r] \to C$ extends uniquely to a continuous map
$A[x_1, \ldots, x_r]^\wedge \to C$ on restricted power series.
(This even works is $I$ is not finitely generated, but in that
case the restricted power series ring may not be $I$-adically
complete itself.)
\end{remark}

\noindent
Set $A_n = A/I^n$ so that the $I$-adic completion of $A$ is
$A^\wedge = \lim A_n$. Let $\mathcal{C}$ be the
category of systems $(B_n)_{n \in \mathbf{N}}$ where
\begin{enumerate}
\item $B_n$ is a finite type $A_n$-algebra, and
\item $B_{n + 1} \to B_n$ is an $A_{n + 1}$-algebra homomorphism which induces
an isomorphism $B_{n + 1}/I^nB_{n + 1} \to B_n$.
\end{enumerate}
Morphisms in $\mathcal{C}$ are given by systems of homomorphisms.
Let $\mathcal{C}'$ be the category of $A$-algebras $B$ which are
$I$-adically complete and such that $B/IB$ is of finite type over $A/I$.
There is a functor
\begin{equation}
\label{equation-from-complete-to-systems}
\mathcal{C}' \longrightarrow \mathcal{C},\quad
B \longmapsto (B/I^nB)
\end{equation}
Indeed, since $B/IB$ is of finite type over $A/I$ the ring maps
$A_n = A/I^n \to B/I^nB$ are of finite type
(apply Algeba, Lemma \ref{algebra-lemma-NAK}
to a ring map $A/I^n[x_1, \ldots, x_r] \to B/I^nB$
such that the images of $x_1, \ldots, x_r$ generate $B/IB$
over $A/I$).

\begin{lemma}
\label{lemma-topologically-finite-type}
Let $A$ be a ring and let $I \subset A$ be a finitely generated ideal.
The functor
$$
\mathcal{C} \longrightarrow \mathcal{C}',\quad
(B_n) \longmapsto B = \lim B_n
$$
is a quasi-inverse to (\ref{equation-from-complete-to-systems}).
The restricted power series rings are in $\mathcal{C}'$ and
any object of $\mathcal{C}'$ is of the form
$$
B = A[x_1, \ldots, x_r]^\wedge / J
$$
for some ideal $J \subset A[x_1, \ldots, x_r]^\wedge$.
\end{lemma}

\begin{proof}
Let $(B_n)$ be an object of $\mathcal{C}$. By
Algebra, Lemma \ref{algebra-lemma-limit-complete}
we see that $B = \lim B_n$ is $I$-adically complete
and $B/I^nB = B_n$. Hence we see that $B$ is an object of
$\mathcal{C}'$ and that we can recover the object $(B_n)$ 
by taking the quotients.
Conversely, if $B$ is an object of $\mathcal{C}'$, then
$B = \lim B/I^nB$ by assumption. Thus $B \mapsto (B/I^nB)$ is a quasi-inverse
to the functor of the lemma.

\medskip\noindent
Since $A[x_1, \ldots, x_r]^\wedge = \lim A_n[x_1, \ldots, x_r]$
it is an object of $\mathcal{C}'$ by the first statement of the lemma.
Finally, let $B$ be an object of $\mathcal{C}'$. Choose
$b_1, \ldots, b_r \in B$ whose images in $B/IB$ generate
$B/IB$ as an algebra over $A/I$. Since $B$ is $I$-adically
complete, the $A$-algebra map $A[x_1, \ldots, x_r] \to B$, $x_i \mapsto b_i$
extends to an $A$-algebra map $A[x_1, \ldots, x_r]^\wedge \to B$.
To finish the proof we have to show this map is surjective
which follows from Algebra, Lemma \ref{algebra-lemma-completion-generalities}
as our map $A[x_1, \ldots, x_r] \to B$ is surjective modulo $I$
and as $B = B^\wedge$.
\end{proof}

\noindent
We warn the reader that, in case $A$ is not Noetherian, the
quotient of an object of $\mathcal{C}'$ may not be an object
of $\mathcal{C}'$. See Examples, Lemma
\ref{examples-lemma-noncomplete-quotient}.
Next we show this does not happen when $A$ is Noetherian.

\begin{lemma}
\label{lemma-topologically-finite-type-Noetherian}
\begin{reference}
\cite[Proposition 7.5.5]{EGA1}
\end{reference}
Let $A$ be a Noetherian ring and let $I \subset A$ be an ideal. Then
\begin{enumerate}
\item every object of the category $\mathcal{C}'$, in particular the
restricted power series algebra $A[x_1, \ldots, x_r]^\wedge$, is Noetherian,
\item if $B$ is an object of $\mathcal{C}'$ and $J \subset B$ is an
ideal, then $B/J$ is an object of $\mathcal{C}'$.
\end{enumerate}
\end{lemma}

\begin{proof}
To see (1) by Lemma \ref{lemma-topologically-finite-type}
we reduce to the case of the restricted power series.
This case follows from
Algebra, Lemma \ref{algebra-lemma-completion-Noetherian-Noetherian}
as $A[x_1, \ldots, x_r]$ is Noetherian
(Algebra, Lemma \ref{algebra-lemma-Noetherian-permanence}).
Part (2) follows from Algebra, Lemma \ref{algebra-lemma-completion-tensor}
which tells us that ever finite $B$-module is
$IB$-adically complete.
\end{proof}

\noindent
Let $A$ be a Noetherian ring and let $I \subset A$ be a ideal.
Let $B$ be an object of $\mathcal{C}'$, i.e., $B$ is an $A$-algebra
which is $I$-adically complete such that $A/I \to B/IB$ is of finite type.
By Lemma \ref{lemma-topologically-finite-type-Noetherian} we can write
$$
B = A[x_1, \ldots, x_r]^\wedge / J
$$
for some finitely generated ideal $J$. For a choice of presentation as
above we define
\begin{equation}
\label{equation-NL}
\NL^\wedge_{B/A} = (J/J^2 \longrightarrow \bigoplus B\text{d}x_i)
\end{equation}
with terms sitting in degrees $-1$ and $0$
where the map sends the residue class of $g \in J$ to the differential
$\text{d}g = \sum (\partial g/\partial x_i) \text{d}x_i$. Here
the partial derivative is taken by thinking of $g$ as a power series.
The following lemma shows that $\NL^\wedge_{B/A}$ is well defined
in $D(B)$, i.e., independent of the chosen presentation, although this
could be shown directly by comparing presentations as in
Algebra, Section \ref{algebra-section-netherlander}.

\begin{lemma}
\label{lemma-NL-is-limit}
With $I \subset A \to B$ as above we have
$\NL^\wedge_{B/A} = R\lim \NL_{B_n/A_n}$ in $D(B)$.
\end{lemma}

\begin{proof}
In fact, the presentation $B = A[x_1, \ldots, x_r]^\wedge / J$
defines presentations
$$
B_n = B/I^nB = A_n[x_1, \ldots, x_r]/J_n
$$
where
$$
J_n = JA_n[x_1, \ldots, x_r] =
J/(J \cap I^nA[x_1, \ldots, x_r]^\wedge)
$$
By Artin-Rees (Algebra, Lemma \ref{algebra-lemma-Artin-Rees})
in the Noetherian ring $A[x_1, \ldots, x_r]^\wedge$
(Lemma \ref{lemma-topologically-finite-type-Noetherian})
we see that we have canonical surjections
$$
J/I^nJ \to J_n \to J/I^{n - c}J,\quad n \geq c
$$
for some $c \geq 0$.
It follows that $\lim J_n/J_n^2 = J/J^2$ as any finite
$A[x_1, \ldots, x_r]^\wedge$-module is $I$-adically complete
(Algebra, Lemma \ref{algebra-lemma-completion-tensor}).
Thus
$$
\NL^\wedge_{B/A} =
\lim (J_n/J_n^2 \longrightarrow \bigoplus B_n \text{d}x_i)
$$
(termwise limit)
and the transition maps in the system are termwise surjective.
The two term complex $J_n/J_n^2 \longrightarrow \bigoplus B_n \text{d}x_i$
represents $\NL_{B_n/A_n}$ by
Algebra, Section \ref{algebra-section-netherlander}.
It follows that $\NL^\wedge_{B/A}$ represents
$R\lim \NL_{B_n/A_n}$ in the derived category by
More on Algebra, Lemma \ref{more-algebra-lemma-compute-Rlim-modules}.
\end{proof}

\noindent
Maps in the derived category out of a complex such as (\ref{equation-NL})
are easy to understand by the result of the following lemma.

\begin{lemma}
\label{lemma-zero-in-derived}
Let $R$ be a ring. Let $M^\bullet$ be a two term complex
$M^{-1} \to M^0$ over $R$ with $M^0$ a projective $R$-module.
Let $K^\bullet$ be a complex with $K^i = 0$ for $i \leq -2$.
Then
\begin{enumerate}
\item $\Hom_{D(R)}(M^\bullet, K^\bullet) = \Hom_{K(R)}(M^\bullet, K^\bullet)$,
\item if $\varphi, \psi \in \text{End}_{D(R)}(M^\bullet)$
are zero on $H^i(M^\bullet)$, then $\varphi \circ \psi = 0$.
\end{enumerate}
\end{lemma}

\begin{proof}
Set $F^0 = M^0$.
Choose a free $R$-module $F^{-1}$ and a surjection $F^{-1} \to M^{-1}$.
Choose a free $R$-module $F^{-2}$ and a surjection
$F^{-2} \to \Ker(F^{-1} \to M^{-1})$. For $i \leq -3$ choose a
free $R$-module $F^i$ and a surjection $F^i \to \Ker(F^{i + 1} \to F^{i + 2})$.
Then $p : F^\bullet \to M^\bullet$ is a quasi-isomorphism. By
Derived Categories, Lemma \ref{derived-lemma-morphisms-from-projective-complex}
we have
$$
\Hom_{D(R)}(M^\bullet, K^\bullet) = \Hom_{K(R)}(F^\bullet, K^\bullet)
$$
But since $K^i = 0$ for $i \leq -2$ we see that any morphism of complexes
$F^\bullet \to K^\bullet$ factors through $p$. Similarly, any
homotopy $\{h^i : F^i \to K^{i - 1}\}$ factors through $p$.
In this way we see that (1) holds.

\medskip\noindent
To see (2) apply 
Derived Categories, Lemma \ref{derived-lemma-trick-vanishing-composition}
to see that $\varphi \circ \psi$ factors through $\tau_{\leq -2}M^\bullet = 0$.
\end{proof}

\noindent
In the following we will in particular study ring maps as
in the following lemma. Condition (\ref{item-condition-artin})
is one of the conditions used in \cite{ArtinII} to define
modifications.

\begin{lemma}
\label{lemma-equivalent-with-artin}
Let $A$ be a Noetherian ring and let $I \subset A$ be an ideal.
Let $B$ be an $I$-adically complete $A$-algebra with $A/I \to B/IB$
of finite type, i.e., an object of the category $\mathcal{C}'$.
The following are equivalent
\begin{enumerate}
\item
\label{item-zero-on-NL}
there exists a $c \geq 0$ such that multiplication by $a$
on $\NL^\wedge_{B/A}$ is zero in $D(B)$ for all $a \in I^c$,
\item
\label{item-zero-on-cohomology-NL}
there exits a $c \geq 0$ such that $H^i(\NL^\wedge_{B/A})$, $i = -1, 0$ is
annihilated by $I^c$,
\item
\label{item-zero-on-cohomology-NL-truncations}
there exists a $c \geq 0$ such that $H^i(\NL_{B_n/A_n})$, $i = -1, 0$ is
annihlated by $I^c$ for all $n \geq 1$,
\item
\label{item-condition-artin}
$B = A[x_1, \ldots, x_r]^\wedge/J$ and
for every $a \in I$ there exists a $c \geq 0$ such that
\begin{enumerate}
\item $a^c$ annihilates $H^0(\NL^\wedge_{B/A})$, and
\item there exist $f_1, \ldots, f_r \in J$ such that
$a^c J \subset (f_1, \ldots, f_r) + J^2$.
\end{enumerate}
\end{enumerate}
\end{lemma}

\begin{proof}
The equivalence of (1) and (2) follows from
Lemma \ref{lemma-zero-in-derived}.
The equivalence of (1) $+$ (2) and (3) follows from
Lemma \ref{lemma-NL-is-limit}. Some details omitted.

\medskip\noindent
Assume the equivalent conditions (1), (2), (3) holds and let
$B = A[x_1, \ldots, x_r]^\wedge/J$ be a presentation
(see Lemma \ref{lemma-topologically-finite-type}). Let $a \in I$.
Let $c$ be such that multplication by $a^c$ is zero on $\NL^\wedge_{B/A}$
which exists by (1). By Lemma \ref{lemma-zero-in-derived} there exists a
a map $\alpha : \bigoplus B\text{d}x_i \to J/J^2$ such that
$\text{d} \circ \alpha$ and $\alpha \circ \text{d}$ are both
multiplication by $a^c$. Let $f_i \in J$ be an element whose
class modulo $J^2$ is equal to $\alpha(\text{d}x_i)$.
Then we see that (\ref{item-condition-artin})(a), (b) hold.

\medskip\noindent
Assume (\ref{item-condition-artin}) holds. Say $I = (a_1, \ldots, a_t)$.
Let $c_i \geq 0$ be the integer such that (\ref{item-condition-artin})(a), (b)
hold for $a_i^{c_i}$. Then we see that $I^{\sum a_i}$ annihilates
$H^0(\NL^\wedge_{B/A})$. Moreover, consider the composition
$$
B^{\oplus r} \to J/J^2 \to \bigoplus B\text{d}x_i
$$
where the $i$th basis vector is mapped to the class of $f_i$ in $J/J^2$.
By (\ref{item-condition-artin})(a) and (b) the cokernel of the composition
is annihilated by $a^{2c}$. Thus this map is surjective after inverting
$a^c$, and hence an isomorphism (Algebra, Lemma \ref{algebra-lemma-fun}).
Thus the kernel of $B^{\oplus r} \to \bigoplus B\text{d}x_i$ is
$a$-power torsion, and hence
$H^{-1}(\NL^\wedge_{B/A}) = \Ker(J/J^2 \to \bigoplus B\text{d}x_i)$
is $a$-power torsion. Since $B$ is Noetherian
(Lemma \ref{lemma-topologically-finite-type-Noetherian}),
all modules including $H^{-1}(\NL^\wedge_{B/A})$ are finite.
Thus $a^d$ annihilates $H^{-1}(\NL^\wedge_{B/A})$ for some $d \geq 0$
and the proof is complete.
\end{proof}

\noindent
Base change. Let $\varphi : A_1 \to A_2$ be a ring map and let
$I_i \subset A_i$ be ideals such that $\varphi(I_1^c) \subset I_2$
for some $c \geq 1$. This induces ring maps
$A_{1, cn} = A_1/I_1^{cn} \to A_2/I_2^n = A_{2, n}$ for all $n \geq 1$.
Let $\mathcal{C}_i$, $\mathcal{C}_i'$ be the categories
of (\ref{equation-from-complete-to-systems}) for $(A_i, I_i)$.
There is a base change functor
\begin{equation}
\label{equation-base-change-systems}
\mathcal{C}_1 \longrightarrow \mathcal{C}_2,\quad
(B_n) \longmapsto (B_{cn} \otimes_{A_{1, cn}} A_{2, n})
\end{equation}
If $I_2$ is finitely generated, then there is a base change functor
\begin{equation}
\label{equation-base-change-complete}
\mathcal{C}_1' \longrightarrow \mathcal{C}_2',\quad
B \longmapsto (B \otimes_{A_1} A_2)^\wedge
\end{equation}
because in this case the completion is complete
(Algebra, Lemma \ref{algebra-lemma-hathat-finitely-generated}).
If $A_1$ and $A_2$ are Noetherian
the two base change functors agree via the functors
(\ref{equation-from-complete-to-systems})
which are equivalences by Lemma \ref{lemma-NL-is-limit}.

\medskip\noindent
Let $A$ be a Noetherian ring and $I \subset A$ an ideal.
Let $\mathfrak a \subset A$ be an ideal. Denote $\bar A = A/\mathfrak a$.
Let $\bar I \subset \bar A$ be an ideal such that
$I^c \bar A \subset \bar I$ and $\bar I^d \subset I\bar A$
for some $c, d \geq 1$. In this case the base change functor
(\ref{equation-base-change-complete}) from the category $\mathcal{C}'$
for $(A, I)$ to the category for $(\bar A, \bar I)$ is given by
$B \mapsto \bar B = B/\mathfrak aB$. Namely, we have
\begin{equation}
\label{equation-base-change-to-closed}
\bar B = (B \otimes_A \bar A)^\wedge = (B/\mathfrak a B)^\wedge =
B/\mathfrak a B
\end{equation}
the last equality because any finite $B$-module is $I$-adically complete by
Algebra, Lemma \ref{algebra-lemma-completion-tensor}
and if annihilated by $\mathfrak a$ also $\bar I$-adically complete by
Algebra, Lemma \ref{algebra-lemma-change-ideal-completion}.

\begin{lemma}
\label{lemma-zero-after-modding-out}
With $A, I, \mathfrak a$ and $B$ as above, suppose that multiplication
by $f \in B$ on $\NL^\wedge_{B/A}$ is zero in $D(B)$. Then multiplication by
the image $\bar f \in \bar B$ on $\NL^\wedge_{\bar B/\bar A}$ is zero
in $D(\bar B)$.
\end{lemma}

\begin{proof}
Choose a presentation $B = A[x_1, \ldots, x_r]^\wedge/J$.
Note that
$$
\bar A[x_1, \ldots, x_r]^\wedge =
A[x_1, \ldots, x_r]^\wedge/\mathfrak a A[x_1, \ldots, x_r]^\wedge
$$
where we use the $\bar I$-adic completion on the left hand side.
Set $\bar J = J \bar A[x_1, \ldots, x_r]^\wedge$. Then we get the
presentation
$$
\bar B = \bar A[x_1, \ldots, x_r]^\wedge/\bar J
$$
for $\bar B$ over $\bar A$. Consider the commutative diagram
$$
\xymatrix{
\NL^\wedge_{B/A} : \ar[d] &
J/J^2 \ar[r]_-{\text{d}} \ar[d] & \bigoplus B\text{d}x_i \ar[d] \\
\NL^\wedge_{\bar B/\bar A} : &
\bar J/\bar J^2 \ar[r] & \bigoplus \bar B\text{d}x_i
}
$$
The vertical arrows are surjective by our discussion above.
By Lemma \ref{lemma-zero-in-derived}
there is a map $\alpha : \bigoplus B\text{d}x_i \to J/J^2$
such that $f \text{id}_{\bigoplus B\text{d}x_i} = \text{d} \circ \alpha$ and
$f \text{id}_{J/J^2} = \alpha \circ \text{d}$. We define
$\bar\alpha : \bigoplus \bar B\text{d}x_i \to \bar J/\bar J^2$
by mapping $\text{d}x_i$ to the image of $\alpha(\text{d}x_i)$
in $\bar J/\bar J^2$. Because the vertical arrows are surjective
it follows that $\bar\alpha$ defines a homotopy between
multiplication by $\bar f$ and the zero map as desired.
\end{proof}

\begin{remark}[Linear approximation]
\label{remark-linear-approximation}
Let $A$ be a ring and $I \subset A$ be a finitely generated ideal.
Let $C$ be an $I$-adically complete $A$-algebra.
Let $\psi : A[x_1, \ldots, x_r]^\wedge \to C$ be a continuous
$A$-algebra map. Suppose given $\delta_i \in C$, $i = 1, \ldots, r$.
Then we can consider
$$
\psi' : A[x_1, \ldots, x_r]^\wedge \to C,\quad
x_i \longmapsto \psi(x_i) + \delta_i
$$
see Remark \ref{remark-universal-property}. Then we have
$$
\psi'(g) = \psi(g) + \sum \psi(\partial g/\partial x_i)\delta_i + \xi
$$
with error term $\xi \in (\delta_i\delta_j)$. This follows by
writing $g$ as a power series and working term by term. Convergence
is automatic as the coefficients of $g$ tend to zero.
Details omitted.
\end{remark}

\begin{lemma}
\label{lemma-fully-faithfulness}
Let $A$ be a Noetherian G-ring. Let $I \subset A$ be an ideal.
Let $B, C$ be finite type $A$-algebras. For any $A$-algebra map
$\varphi : B^\wedge \to C^\wedge$ of $I$-adic completions and any
$N \geq 1$ there exist
\begin{enumerate}
\item an \'etale ring map $C \to C'$ which induces
an isomorphism $C/IC \to C'/IC'$,
\item an $A$-algebra map $\varphi : B \to C'$
\end{enumerate}
such that $\varphi$ and $\psi$ agree modulo $I^N$
into $C^\wedge = (C')^\wedge$.
\end{lemma}

\begin{proof}
The statement of the lemma makes sense as $C \to C'$ is flat
(Algebra, Lemma \ref{algebra-lemma-etale}) hence induces an isomorphism
$C/I^nC \to C'/I^nC'$ for all $n$
(More on Algebra, Lemma \ref{more-algebra-lemma-neighbourhood-isomorphism})
and hence an isomorphism on completions.
Let $C^h$ be the henselization of the pair $(C, IC)$, see
More on Algebra, Lemma \ref{more-algebra-lemma-henselization}.
Then $C^h$ is the filtered colimit of the algebras $C'$
and the maps
$C \to C' \to C^h$ induce isomorphism on completions (More on Algebra,
Lemma \ref{more-algebra-lemma-henselization-Noetherian-pair}).
Thus it suffices to prove there exists an $A$-algebra map
$B \to C^h$ which is congruent to $\psi$ modulo $I^N$.
Write $B = A[x_1, \ldots, x_n]/(f_1, \ldots, f_m)$.
The ring map $\psi$ corresponds to elements
$\hat c_1, \ldots, \hat c_n \in C^\wedge$ with
$f_j(\hat c_1, \ldots, \hat c_n) = 0$ for $j = 1, \ldots, m$.
Namely, as $A$ is a Noetherian G-ring, so is $C$, see
More on Algebra, Proposition
\ref{more-algebra-proposition-finite-type-over-G-ring}.
Thus Smoothing Ring Maps,
Lemma \ref{smoothing-lemma-henselian-pair}
applies to give elements $c_1, \ldots, c_n \in C^h$ such
that $f_j(c_1, \ldots, c_n) = 0$ for $j = 1, \ldots, m$
and such that $\hat c_i - c_i \in I^NC^h$.
This determines the map $B \to C^h$ as desired.
\end{proof}










\section{Glueing rings along a principal ideal}
\label{section-approximation-principal}

\noindent
In this situation we prove some results about the categories
$\mathcal{C}$ and $\mathcal{C}'$ of Section \ref{section-approximation-pre}
in case $A$ is a Noetherian ring and $I = (a)$ is a principal
ideal.

\begin{lemma}
\label{lemma-get-morphism-nonzerodivisor}
Let $A$ be a Noetherian ring and $I = (a)$ a principal ideal.
Let $B$, $C$ be objects of the category $\mathcal{C}'$ of
Lemma \ref{lemma-topologically-finite-type-Noetherian}.
Let $c \geq 0$ be an integer such that
multiplication by $a^c$ on $\NL^\wedge_{B/A}$ is zero in $D(B)$.
Assume $a$ is a nonzerodivisor on $C$.
Let $n > 2c$. For any $A_n$-algebra map $\psi_n : B_n \to C_n$
there exists a morphism $\varphi : B \to C$ of $\mathcal{C}'$ such
that $\psi_n \bmod a^{n - c} = \varphi \bmod a^{n - c}$.
\end{lemma}

\begin{proof}
Choose a presentation $B = A[x_1, \ldots, x_r]^\wedge/J$. Choose
a lift
$$
\psi : A[x_1, \ldots, x_r]^\wedge \to C
$$
of $\psi_n$. Then $\psi(J) \subset a^nC$ and $\psi(J^2) \subset a^{2n}C$
which determines a linear map
$$
J/J^2 \longrightarrow a^nC/a^{2n}C,\quad g \longmapsto \psi(g)
$$
By assumption and Lemma \ref{lemma-zero-in-derived}
there is a $B$-module map
$\bigoplus B\text{d}x_i \to a^nC/a^{2n}C$,
$\text{d}x_i \mapsto \delta_i$ such that
$a^c \psi(g) = \sum \psi(\partial g/\partial x_i) \delta_i$
for all $g \in J$. Write $\delta_i = - a^c \delta'_i$ for some
$\delta'_i \in a^{n - c}C$. Since $a$ is a nonzerodivisor
on $C$ we see that $\psi(g) = - \sum \psi(\partial g/\partial x_i) \delta'_i$
in $C/a^{2n - c}C$.
Then we look at the map
$$
\psi' : A[x_1, \ldots, x_r]^\wedge \to C,\quad
x_i \longmapsto \psi(x_i) + \delta'_i
$$
A computation with power series (see Remark \ref{remark-linear-approximation})
shows that $\psi'(J) \subset a^{2n - 2c}C$. Since $n > 2c$
we see that $n' = 2n - 2c = n + (n - 2c) > n$. Thus we obtain a morphism
$\psi_{n'} : B_{n'} \to C_{n'}$ agreeing with $\psi_n$ modulo
$a^{n - c}$. Continuing in this fashion and taking a limit we
obtain the lemma.
\end{proof}

\begin{lemma}
\label{lemma-get-morphism-principal}
Let $A$ be a Noetherian ring and $I = (a)$ a principal ideal.
Let $B$, $C$ be objects of the category $\mathcal{C}'$ of
Lemma \ref{lemma-topologically-finite-type-Noetherian}.
Let $c \geq 0$ be an integer such that
multiplication by $a^c$ on $\NL^\wedge_{B/A}$ is zero in $D(B)$.
Let $d \geq 0$ be an integer such that
$C[a^\infty] \cap a^dC = 0$; such an integer always exists.
Let $n > \max(2c, c + d)$. For any $A_n$-algebra map $\psi_n : B_n \to C_n$
there exists a morphism $\varphi : B \to C$ of $\mathcal{C}'$ such
that $\psi_n \bmod a^{n - c} = \varphi \bmod a^{n - c}$.
\end{lemma}

\begin{proof}
Because $C$ is Noetherian we have $C[a^\infty] = C[a^e]$ for some
$e \geq 0$. By Artin-Rees there exists an integer $f$ such that
$a^nC \cap C[a^\infty] \subset a^{n - f}C[a^\infty]$ for all $n \geq f$.
Thus $d = e + f$ works.

\medskip\noindent
Let $C \to C'$ be the quotient of $C$ by $C[a^\infty]$. For $m > d$ the
diagram
$$
\xymatrix{
0 \ar[r] &
C[a^\infty] \ar[r] \ar[d] &
C \ar[r] \ar[d] & C' \ar[r] \ar[d] & 0 \\
0 \ar[r] &
C[a^\infty] \ar[r] &
C/a^m C \ar[r] & C'/a^m C' \ar[r] & 0
}
$$
has exact rows. Thus $C$ is the fibre product of $C'$ and
$C_m$ over $C'_m$. Thus the lemma now follows formally from
the lifting result of Lemma \ref{lemma-get-morphism-nonzerodivisor}.
\end{proof}










\section{Glueing rings along an ideal}
\label{section-approximation}

\noindent
Let $A$ be a Noetherian ring. Let $I \subset A$ be an ideal.
In this section we study $I$-adically complete $A$-algebras
which are, in some vague sense, \'etale over the complement of
$V(I)$ in $\Spec(A)$.

\begin{lemma}
\label{lemma-get-morphism-general}
Let $A$ be a Noetherian ring. Let $I \subset A$ be an ideal.
Let $t$ be the minimal number of generators for $I$.
Let $C$ be an object of the category $\mathcal{C}'$ of
Lemma \ref{lemma-topologically-finite-type-Noetherian}.
There exists an integer $d \geq 0$ depending only on
$I \subset A \to C$ with the following property: given
\begin{enumerate}
\item $c \geq 0$ and $B \in  \Ob(\mathcal{C}')$ such that for $a \in I^c$
multiplication by $a$ on $\NL^\wedge_{B/A}$ is zero in $D(B)$,
\item an integer $n > 2t\max(c, d)$,
\item an $A_n$-algebra map $\psi_n : B_n \to C_n$,
\end{enumerate}
there exists a morphism $\varphi : B \to C$ of $\mathcal{C}'$ such
that $\psi_n \bmod I^{m - c} = \varphi \bmod I^{m - c}$
with $m = \lfloor \frac{n}{t} \rfloor$.
\end{lemma}

\begin{proof}
We prove this lemma by induction on the number of generators of $I$.
Say $I = (a_1, \ldots, a_t)$. If $t = 0$, then $I = 0$ and there
is nothing to prove. If $t = 1$, then the lemma follows from
Lemma \ref{lemma-get-morphism-principal} because
$2\max(c, d) \geq \max(2c, c + d)$. Assume $t > 1$.

\medskip\noindent
Set $m = \lfloor \frac{n}{t} \rfloor$ as in the lemma.
Set $\bar A = A/(a_t^m)$. Consider the ideal
$\bar I = (\bar a_1, \ldots, \bar a_{t - 1})$ in $\bar A$.
Let $\bar C = C/(a_t^m)$ be the base change of $C$ for the
map $(A, I) \to (\bar A, \bar I)$, see (\ref{equation-base-change-to-closed}).
Let $\bar d$ be the integer for $\bar I \subset \bar A \to \bar C$
which exists by induction hypothesis.

\medskip\noindent
Let $d_1 \geq 0$ be the integer found in
Lemma \ref{lemma-get-morphism-principal} for the ring $B$
and the element $a_t \in A$.

\medskip\noindent
We claim the lemma holds with $d = \max(\bar d, d_1)$.
To see this, let $c, B, n, \psi_n$ be as in the lemma.

\medskip\noindent
Note that $\bar I \subset I\bar A$. Hence by
Lemma \ref{lemma-zero-after-modding-out}
multiplication by an element of $\bar I^c$
on the cotangent complex of $\bar B = B/(a_t^m)$
is zero in $D(\bar B)$. Also, we have
$$
\bar I^{n - m + 1} \supset I^n \bar A
$$
Thus $\psi_n$ gives rise to a map
$$
\bar \psi_{n - m + 1} : \bar B_{n - m + 1} \to \bar C_{n - m + 1}
$$
Since $n > 2t\max(c, d)$ and $d \geq \bar d$ we see that
$$
n - m + 1 \geq (t - 1)n/t > 2(t - 1)\max(c, d) \geq 2(t - 1)\max(c, \bar d)
$$
Hence we can find a morphism $\varphi_m : \bar B \to \bar C$
agreeing with $\bar \psi_{n - m + 1}$ modulo the ideal
$\bar I^{m' - c}$ where $m' = \lfloor \frac{n - m + 1}{t - 1} \rfloor$.

\medskip\noindent
Since $m \geq n/t > 2\max(c, d) \geq 2\max(c, d_1) \geq \max(2c, c+ d_1)$,
we can apply Lemma \ref{lemma-get-morphism-principal} for
the ring map $A \to B$ and the ideal $(a_t)$ to
find a morphism $\varphi : B \to C$ agreeing modulo
$a_t^{m - c}$ with $\varphi_m$.

\medskip\noindent
All in all we find $\varphi : B \to C$ which agrees with
$\psi_n$ modulo
$$
(a_t^{m - c}) + (a_1, \ldots, a_{t - 1})^{m' - c}
\subset I^{\min(m - c, m' - c)}
$$
We leave it to the reader to see that
$\min(m - c, m' - c) = m - c$. This concludes the proof.
\end{proof}

\noindent
In the following lemma we use Popescu's theorem to approximate
a given presentation, hence in the proof we need some assumption on the
Noetherian base ring $A$. It seems that at least some condition
is necessary, i.e., that the lemma does not hold without the
condition that $A$ be a G-ring.

\begin{lemma}
\label{lemma-approximate}
Let $A$ be a Noetherian G-ring. Let $I \subset A$ be an ideal.
Let $B$ be an object of the category $\mathcal{C}'$ of
Lemma \ref{lemma-topologically-finite-type-Noetherian}.
Let $c \geq 0$ be an integer such that for $a \in I^c$
multiplication by $a$ on $\NL^\wedge_{B/A}$ is zero in $D(B)$.
Then there exists a finite type $A$-algebra $C$ and an
isomorphism $B \cong C^\wedge$.
\end{lemma}

\begin{proof}
Choose a presentation $B = A[x_1, \ldots, x_r]^\wedge/J$.
Choose generators $g_1, \ldots, g_m \in J$.
Choose generators $k_1, \ldots, k_t$ of the module
of relations between $g_1, \ldots, g_m$, i.e., such that
$$
(A[x_1, \ldots, x_r]^\wedge)^{\oplus t} \xrightarrow{k_1, \ldots, k_t}
(A[x_1, \ldots, x_r]^\wedge)^{\oplus m} \xrightarrow{g_1, \ldots, g_m}
A[x_1, \ldots, x_r]^\wedge
$$
is exact in the middle. Write $k_i = (k_{i1}, \ldots, k_{im})$ so that we have
\begin{equation}
\label{equation-relations-straight-up}
\sum k_{ij}g_j = 0
\end{equation}
for $i = 1, \ldots, t$.
Let $I^c = (a_1, \ldots, a_s)$. For each $l \in \{1, \ldots, s\}$
we know that multiplication by $a_l$ on $\NL^\wedge_{B/A}$ is zero
in $D(B)$. By Lemma \ref{lemma-zero-in-derived} we can find a map
$\alpha_l : \bigoplus B\text{d}x_i \to J/J^2$ such that
$\text{d} \circ \alpha_l$ and $\alpha_l \circ \text{d}$ are both
multiplication by $a_l$. Pick an element $f_{l, i} \in J$ whose
class modulo $J^2$ is equal to $\alpha_l(\text{d}x_i)$.
Then we have for all $l = 1, \ldots, s$ and $i = 1, \ldots, r$ that
\begin{equation}
\label{equation-derivatives}
\sum\nolimits_{i'} (\partial f_{l, i}/ \partial x_{i'}) \text{d}x_{i'} =
a_l \text{d}x_i + \sum h_{l, i}^{j', i'} g_{j'} \text{d}x_{i'}
\end{equation}
for some $h_{l, i}^{j', i'} \in A[x_1, \ldots, x_r]^\wedge$.
We also have for $j = 1, \ldots, m$ and $l = 1, \ldots, s$ that
\begin{equation}
\label{equation-ci}
a_l g_j = \sum h_{l, j}^if_{l, i} + \sum h_{l, j}^{j', j''}g_{j'} g_{j''}
\end{equation}
for some $h_{l, j}^i$ and $h_{l, j}^{j', j''}$ in
$A[x_1, \ldots, x_r]^\wedge$. Of course, since $f_{l, i} \in J$
we can write for $l = 1, \ldots, s$ and $i = 1, \ldots, r$
\begin{equation}
\label{equation-in-ideal}
f_{l, i} = \sum h_{l, i}^jg_j
\end{equation}
for some $h_{l, i}^j$ in $A[x_1, \ldots, x_r]^\wedge$.

\medskip\noindent
Let $A[x_1, \ldots, x_r]^h$ be the henselization of the
pair $(A[x_1, \ldots, x_r], IA[x_1, \ldots, x_r])$, see
More on Algebra, Lemma \ref{more-algebra-lemma-henselization}.
Since $A$ is a Noetherian G-ring, so is $A[x_1, \ldots, x_r]$, see
More on Algebra, Proposition
\ref{more-algebra-proposition-finite-type-over-G-ring}.
Hence we have approximation for the map
$A[x_1, \ldots, x_r]^h \to A[x_1, \ldots, x_r]^\wedge$
with respect to the ideal generated by $I$, see
Smoothing Ring Maps, Lemma \ref{smoothing-lemma-henselian-pair}.
Choose a large integer $M$. Choose
$$
G_j, K_{ij}, F_{l, i}, H_{l, j}^i, H_{l, j}^{j', j''}, H_{l, i}^j
\in A[x_1, \ldots, x_r]^h
$$
such that analogues of equations (\ref{equation-relations-straight-up}),
(\ref{equation-ci}), and (\ref{equation-in-ideal})
hold for these elements in $A[x_1, \ldots, x_r]^h$, i.e.,
$$
\sum K_{ij}G_j = 0,\quad
a_l G_j = \sum H_{l, j}^iF_{l, i} +
\sum H_{l, j}^{j', j''} G_{j'} G_{j''},\quad
F_{l, i} = \sum H_{l, i}^j G_j
$$
and such that we have
$$
G_j - g_j, K_{ij} - k_{ij}, F_{l, i} - f_{l, i},
H_{l, j}^i - h_{l, j}^i, H_{l, j}^{j', j''} - h_{l, j}^{j', j''},
H_{l, i}^j - h_{l, i}^j
\in I^M A[x_1, \ldots, x_r]^h
$$
where we take liberty of thinking of $A[x_1, \ldots, x_r]^h$ as a
subring of $A[x_1, \ldots, x_r]^\wedge$.
Note that we cannot guarantee that the analogue of
(\ref{equation-derivatives}) holds
in $A[x_1, \ldots, x_r]^h$, because it is not a polynomial equation.
But since taking partial derivatives is $A$-linear, we do get
the analogue modulo $I^M$. More precisely, we see that
\begin{equation}
\label{equation-derivatives-analogue}
\sum\nolimits_{i'} (\partial F_{l, i}/ \partial x_{i'}) \text{d}x_{i'}
- a_l \text{d}x_i - \sum h_{l, i}^{j', i'} G_{j'} \text{d}x_{i'}
\in I^MA[x_1, \ldots, x_r]^\wedge
\end{equation}
for $l = 1, \ldots, s$ and $i = 1, \ldots, r$.

\medskip\noindent
With these choices, consider the ring
$$
C^h = A[x_1, \ldots, x_r]^h/(G_1, \ldots, G_r)
$$
and denote $C^\wedge$ its $I$-adic completion, namely
$$
C^\wedge = A[x_1, \ldots, x_r]^\wedge/J',\quad
J' = (G_1, \ldots, G_r)A[x_1, \ldots, x_r]^\wedge
$$
In the following paragraphs we esthablish the fact that $C^\wedge$
is isomorphic to $B$. Then in the final paragraph we deal with
show that $C^h$ comes from a finite type algebra
over $A$ as in the statement of the lemma.

\medskip\noindent
First consider the cokernel
$$
\Omega = \Coker(J'/(J')^2 \longrightarrow \bigoplus C^\wedge \text{d}x_i)
$$
This $C^\wedge$ module is generated by the images of the elements
$\text{d}x_i$. Since $F_{l, i} \in J'$ by the analogue of
(\ref{equation-in-ideal}) we see from
(\ref{equation-derivatives-analogue}) we see
that $a_l \text{d}x_i \in I^M\Omega$. As $I^c = (a_l)$ we see that
$I^c \Omega \subset I^M \Omega$. Since $M > c$ we conclude that
$I^c \Omega = 0$ by Algebra, Lemma \ref{algebra-lemma-NAK}.

\medskip\noindent
Next, consider the kernel
$$
H_1 = \Ker(J'/(J')^2 \longrightarrow \bigoplus C^\wedge \text{d}x_i)
$$
By the analogue of (\ref{equation-ci}) we see that
$a_l J' \subset (F_{l, i}) + (J')^2$. On the other hand, the
determinant $\Delta_l$ of the matrix $(\partial F_{l, i}/ \partial x_{i'})$
satisfies $\Delta_l = a_l^r \bmod I^M C^\wedge$ by
(\ref{equation-derivatives-analogue}). It follows that
$a_l^{r + 1} H_1 \subset I^M H_1$ (some details omitted; use
Algebra, Lemma \ref{algebra-lemma-matrix-left-inverse}).
Now $(a_1^{r + 1}, \ldots, a_s^{r + 1}) \supset I^{(sr + 1)c}$.
Hence $I^{(sr + 1)c}H_1 \subset I^M H_1$ and since $M > (sr + 1)c$
we conclude that $I^{(sr + 1)c}H_1 = 0$.

\medskip\noindent
By Lemma \ref{lemma-zero-in-derived}
we conclude that multiplication by an element
of $I^{2(sr + 1)c}$ on $\NL^\wedge_{C^\wedge/A}$ is zero
(note that the bound does not depend on $M$ or the choice
of the approximation, as long as $M$ is large enough).
Since $G_j - g_j$ is in the ideal generated by $I^M$
we see that there is an isomorphism
$$
\psi_M : C^\wedge/I^MC^\wedge \to B/I^MB
$$
As $M$ is large enough we can use
Lemma \ref{lemma-get-morphism-general}
with $d = d(I \subset A \to B)$,
with $C^\wedge$ playing the role of $B$,
with $2(rs + 1)c$ instead of $c$,
to find a morphism
$$
\psi : C^\wedge \longrightarrow B
$$
which agrees with $\psi_M$ modulo $I^{q - 2(rs + 1)c}$ where
$q$ is the quotent of $M$ by the number of generators of $I$.
We claim $\psi$ is an isomorphism. Since $C^\wedge$ and $B$
are $I$-adically complete the map $\psi$ is surjective
because it is surjective modulo $I$ (see
Algebra, Lemma \ref{algebra-lemma-completion-generalities}).
On the other hand, as $M$ is large enough we see that
$$
\text{Gr}_I(C^\wedge) \cong \text{Gr}_I(B)
$$
as graded $\text{Gr}_I(A[x_1, \ldots, x_r]^\wedge)$-modules
by More on Algebra, Lemma \ref{more-algebra-lemma-approximate-complex-graded}.
Since $\psi$ is compatible with this isomorphism as it
agrees with $\psi_M$ modulo $I$, this means that $\text{Gr}_I(\psi)$ is an
isomorphism. As $C^\wedge$ and $B$ are
$I$-adically complete, it follows that $\psi$ is an isomorphism.

\medskip\noindent
This paragraph serves to deal with the issue that $C^h$
is not of finite type over $A$. Namely, the ring
$A[x_1, \ldots, x_r]^h$ is a filtered colimit of
\'etale $A[x_1, \ldots, x_r]$ algebras $A'$ such that
$A/I[x_1, \ldots, x_r] \to A'/IA'$ is an isomorphism
(see proof of More on Algebra, Lemma \ref{more-algebra-lemma-henselization}).
Pick an $A'$ such that $G_1, \ldots, G_m$ are the
images of $G'_1, \ldots, G'_m \in A'$.
Setting $C = A'/(G'_1, \ldots, G'_m)$ we get the finite
type algebra we were looking for.
\end{proof}

\begin{lemma}
\label{lemma-approximate-by-etale-over-complement}
Let $A$ be a Noetherian G-ring. Let $I \subset A$ be an ideal.
Let $B$ be an $I$-adically complete $A$-algebra with $A/I \to B/IB$
of finite type. The equivalent conditions of
Lemma \ref{lemma-equivalent-with-artin} are also equivalent to
\begin{enumerate}
\item[(5)]
\label{item-algebraize}
there exists a finite type $A$-algebra $C$ with
$\Spec(C) \to \Spec(A)$ is \'etale over $\Spec(A) \setminus V(I)$
such that $B \cong C^\wedge$.
\end{enumerate}
\end{lemma}

\begin{proof}
First, assume conditions (1) -- (4) hold. Then there exists
a finite type $A$-algebra $C$ with such that $B \cong C^\wedge$
by Lemma \ref{lemma-approximate}. In other words, $B_n = C/I^nC$.
The naive cotangent complex $\NL_{C/A}$ is a complex of finite type
$C$-modules and hence $H^{-1}$ and $H^0$ are finite $C$-modules.
By assumption there exists a $c \geq 0$ such that
$H^{-1}/I^nH^{-1}$ and $H^0/I^nH^0$ are annihilated by $I^c$
for some $n$. By Nakayama's lemma this means that
$I^cH^{-1}$ and $I^cH^0$ are annihilated by an element of the
form $f = 1 + x$ with $x \in IC$. After inverting $f$
(which does not change the quotients $B_n = C/I^nC$)
we see that $\NL_{C/A}$ has cohomology annihilated by $I^c$. Thus
$A \to C$ is \'etale at any prime of $C$ not lying over $V(I)$
by the definition of \'etale ring maps, see
Algebra, Definition \ref{algebra-definition-etale}.

\medskip\noindent
Conversely, assume that $A \to C$ of finite type is given such that
$\Spec(C) \to \Spec(A)$ is \'etale over $\Spec(A) \setminus V(I)$.
Then for every $a \in I$ there exists an $c \geq 0$ such that
multiplication by $a^c$ is zero $\NL_{C/A}$.
Since $\NL^\wedge_{C^\wedge/A}$ is the derived completion of
$\NL_{C/A}$ (see Lemma \ref{lemma-NL-is-limit}) it follows that
$B = C^\wedge$ satisfies the equivalent conditions of
Lemma \ref{lemma-equivalent-with-artin}.
\end{proof}

\begin{lemma}
\label{lemma-finitely-many-maps-to-unramified}
Let $S$ be a Noetherian scheme. Let $X \to S$ be a quasi-compact unramified
morphism. Let $Y \to S$ be a morphism with $Y$ Noetherian. Then
$\Mor_S(Y, X)$ is a finite set.
\end{lemma}

\begin{proof}
Assume first $X \to S$ is separated (which is often the case in practice).
Since $Y$ is Noetherian it has finitely many connected components. Thus we
may assume $Y$ is connected. Choose a point $y \in Y$ with image $s \in S$.
Since $X \to S$ is unramified and quasi-compact
then fibre $X_s$ is finite, say $X_s = \{x_1, \ldots, x_n\}$
and $\kappa(s) \subset \kappa(x_i)$ is a finite field extension.
See Morphisms, Lemma \ref{morphisms-lemma-unramified-quasi-finite},
\ref{morphisms-lemma-residue-field-quasi-finite}, and
\ref{morphisms-lemma-quasi-finite}.
For each $i$ there are at most finitely many $\kappa(s)$-algebra
maps $\kappa(x_i) \to \kappa(y)$ (by elementary field theory).
Thus $\Mor_S(Y, X)$ is finite by
\'Etale Morphisms, Proposition \ref{etale-proposition-equality}.

\medskip\noindent
General case. There exists a nonempty open $U \subset X$ such
that $X_U \to U$ is finite (in particular separated), see
Morphisms, Lemma \ref{morphisms-lemma-generically-finite}
(the lemma applies since we've already seen above that a quasi-compact
unramified morphism is quasi-finite and since $X \to S$ is quasi-separated by
Morphisms, Lemma \ref{morphisms-lemma-finite-type-Noetherian-quasi-separated}).
Let $Z \subset S$ be the reduced closed subscheme supported on
the complement of $U$. By Noetherian induction, we see that
$\Mor_Z(Y_Z, X_Z)$ is finite (details omitted).
By the result of the first paragraph the set
$\Mor_U(Y_U, X_U)$ is finite. Thus it suffices to show that
$$
\Mor_S(Y, X) \longrightarrow \Mor_Z(Y_Z, X_Z) \times \Mor_U(Y_U, X_U)
$$
is injective. This follows from the fact that the set of points where
two morphisms $a, b : Y \to X$ agree is open in $Y$, due to the fact
that $\Delta : X \to X \times_S X$ is open, see
Morphisms, Lemma \ref{morphisms-lemma-diagonal-unramified-morphism}.
\end{proof}

\begin{lemma}
\label{lemma-fully-faithful-etale-over-complement}
Let $A$ be a Noetherian G-ring. Let $I \subset A$ be an ideal.
Let $C, B$ be finite type $A$-algebras. Assume
$\Spec(B) \to \Spec(A)$ is
\'etale over $\Spec(A) \setminus V(I)$. Then any $A$-algebra
map $C^\wedge \to B^\wedge$ of $I$-adic completions
comes from a unique $A$-algebra map
$$
C \longrightarrow B^h
$$
where $B^h$ is the henselization of the pair $(B, IB)$ as
in More on Algebra, Lemma \ref{more-algebra-lemma-henselization}.
Moreover, any $A$-algebra homomorphism $C \to B^h$ factors through
some \'etale $B$-algebra $B'$ such that $B/IB \to B'/IB'$ is an isomorphism.
\end{lemma}

\begin{proof}
Uniqueness follows from the fact that $B^h$ is a subring of
$B^\wedge$, see for example
More on Algebra, Lemma \ref{more-algebra-lemma-henselization-Noetherian-pair}.
The final assertion follows from the fact that $B^h$ is the filtered colimit
of these $B$-algebras $B'$, see proof of
More on Algebra, Lemma \ref{more-algebra-lemma-henselization}.
Having said this we now turn to the proof of existence.
By Lemma \ref{lemma-fully-faithfulness}
given $n \geq 1$ we can find a ring homomorphism $\varphi_n : C \to B^h$
agreeing with the given map $\psi : C^\wedge \to B^\wedge$ modulo
$I^n$. By Lemma \ref{lemma-finitely-many-maps-to-unramified}
there are infinitely many $n$ such that the restrictions
$\Spec(\varphi_n)|_{\Spec(B^h) \setminus V(IB^h)}$ are equal
(observe that $B^h$ is Noetherian by
More on Algebra, Lemma \ref{more-algebra-lemma-henselization-Noetherian-pair}).
This means there exists a sequence $n_1 < n_2 < n_3 < \ldots$
such that for every $a \in I$ the maps
$$
\varphi_{n_j} : C_a \longrightarrow B^h_a
$$
are the same. In other words, the maps $\varphi_{n_j}$
differ only on the $I$-power torsion of $C$. Since $C$ is
Noetherian we have $C[I^\infty] = C[I^c]$ for some $c \geq 0$.
By Algebra, Lemma \ref{algebra-lemma-Artin-Rees} we have
$I^{n_j}C \cap C[I^\infty] = I^{n_j - d}C[I^\infty]$ for some
$d \geq 0$ and all $j \gg 0$. Thus $I^{n_j}C \cap C[I^\infty] = 0$
for $j \gg 0$. Since $\varphi_{n_j}$ agrees with the given map
$\psi$ modulo $I^{n_j}C$ for all $j$ we see that the maps
$\varphi_{n_j}$ are all equal for all $j \gg 0$ and
that they agree with $\psi$ as maps into the completion.
\end{proof}

















\section{Modifications}
\label{section-modifications}

\noindent
Let $(A, \mathfrak m, \kappa)$ be a Noetherian local ring. We set
$S = \Spec(A)$ and $U = S \setminus \{\mathfrak m\}$. In this section
we will consider the category
\begin{equation}
\label{equation-modification}
\left\{
f : X \longrightarrow S
\quad \middle | \quad
\begin{matrix}
X\text{ is an algebraic space}\\
f\text{ is a proper morphism}\\
f^{-1}(U) \to U\text{ is an isomorphism}
\end{matrix}
\right\}
\end{equation}
A morphism from $X/S$ to $X'/S$ will be a morphism of algebraic spaces
$X \to X"$ compatible with the structure morphisms over $S$.

\begin{lemma}
\label{lemma-modification}
Let $(A, \mathfrak m, \kappa)$ be a $2$-dimensional Noetherian
local domain such that $U = \Spec(A) \setminus \{\mathfrak m\}$
is a normal scheme. Then any modification $f : X \to S$
(as in Spaces over Fields, Definition
\ref{spaces-over-fields-definition-modification})
is a morphism as in (\ref{equation-modification}).
\end{lemma}

\begin{proof}
Let $f : X \to S$ be a modification. We have to show that
$f^{-1}(U) \to U$ is an isomorphism. By
Spaces over Fields, Lemma
\ref{spaces-over-fields-lemma-modification-iso-over-open}
there exists a nonempty open $V \subset S$ such that $f^{-1}(V) \to V$
is an isomorphism. Since $X$ is integral we see that $f^{-1}(V)$ is
dense in $X$. Note that every closed point $u$ of $U$ has codimension
$1$, i.e., that $\dim(\mathcal{O}_{U, u}) = 1$. Thus we may apply
Spaces over Fields, Lemma \ref{spaces-over-fields-lemma-finite-in-codim-1}
to see that $f^{-1}(U) \to U$ is finite. In particular $f^{-1}(U)$ is a scheme.
Then $f^{-1}(U) \to U$ is an isomorphism, see
Morphisms, Lemma \ref{morphisms-lemma-finite-birational-over-normal}.
\end{proof}

\noindent
Let $A \to B$ be a local homomorphism of local Noetherian rings
such that $\mathfrak m_B = \sqrt{\mathfrak m_A B}$. Then base
change along the morphism $\Spec(B) \to \Spec(A)$ gives a functor
from the category (\ref{equation-modification}) for $A$
to the category (\ref{equation-modification}) for $B$.

\begin{lemma}
\label{lemma-fully-faithfulness-to-completion}
Let $A \to B$ be a local homomorphism of local Noetherian rings such that
\begin{enumerate}
\item $A \to B$ is flat,
\item $\mathfrak m_B = \mathfrak m_A B$, and
\item $\kappa(\mathfrak m_A) = \kappa(\mathfrak m_B)$
\end{enumerate}
(equivalently, $A \to B$ induces an isomorphism on completions, see
More on Algebra, Lemma \ref{more-algebra-lemma-flat-unramified}).
Then the base change functor from the category
(\ref{equation-modification}) for $A$ to the category
(\ref{equation-modification}) for $B$
is fully faithful.
\end{lemma}

\begin{proof}
Consider the diagram
$$
\xymatrix{
\Spec(B) \setminus \{\mathfrak m_B\} \ar[r] \ar[d] & \Spec(B) \ar[d] \\
U = \Spec(A) \setminus \{\mathfrak m_A\} \ar[r] & \Spec(A)
}
$$
This is a diagram as in Situation \ref{situation-formal-glueing}.
By Lemma \ref{lemma-fully-faithful-on-separated} the functor which
associates to an algebraic space
$X$ over $\Spec(A)$ the base changes to $U$ and $\Spec(B)$
glued along the base change to $\Spec(B) \setminus \{\mathfrak m_B\}$
is fully faithful. However, in our category the morphisms are always
the identity over the complement of the closed point, hence we
obtain the desired result.
\end{proof}

\begin{lemma}
\label{lemma-henselian}
Let $(A, \mathfrak m, \kappa)$ be a Noetherian local ring.
The category (\ref{equation-modification}) for $A$
is equivalent to the category (\ref{equation-modification})
for the henselization $A^h$ of $A$.
\end{lemma}

\begin{proof}
Fully faithfulness follows from
Lemma \ref{lemma-fully-faithfulness-to-completion}. We will prove the
base change functor from the category (\ref{equation-modification}) for $A$
to the category (\ref{equation-modification}) for the henselization $A^h$
is essentially surjective.

\medskip\noindent
Write $A^h = \colim A_i$ as a filtered colimit where the ring maps
$A \to A_i$ are \'etale and induce an isomorphism
$\kappa(\mathfrak m) \to A_i/\mathfrak m A_i$ (see proof of
Algebra, Lemma \ref{algebra-lemma-henselization} or
More on Algebra, Lemma \ref{more-algebra-lemma-henselization-local-ring}).
Set $S_i = \Spec(A_i)$.
If $X^h \to S^h = \Spec(A^h)$ is as in (\ref{equation-modification}),
then there exists an $i$ and a morphism $X_i \to S_i$ such that
$X^h = S^h \times_{S_i} X_i$, see
Limits of Spaces, Lemma \ref{spaces-limits-lemma-descend-finite-presentation}.
After increasing $i$ we may assume that $X_i \to S_i$ is
proper, see
Limits of Spaces, Lemma \ref{spaces-limits-lemma-eventually-proper}.
After further increasing $i$ we may assume that
$X_i \to S_i$ is an isomorphism over the open
$S_i \setminus V(\mathfrak m A_i)$, see
Limits of Spaces, Lemma \ref{spaces-limits-lemma-descend-isomorphism}.
Thus it suffices to solve the problem posed in the following paragraph.

\medskip\noindent
Let $A \to B$ be an \'etale ring map inducing an isomorphism
$\kappa(\mathfrak m) \to B/\mathfrak m B$ and let $g : Y \to \Spec(B)$
be a proper morphism of algebraic spaces such that
$$
g^{-1}\left(\Spec(B) \setminus V(\mathfrak m B)\right)
\longrightarrow
\Spec(B) \setminus V(\mathfrak m B)
$$
is an isomorphism.
We have to show that $Y \cong X \times_{\Spec(A)} \Spec(B)$
for some object $X \to \Spec(A)$ of the category (\ref{equation-modification})
over $A$. To do this we will use descent.
Consider the scheme $R = \Spec(B \otimes_A B)$ with its two morphisms
$s, t : R \to \Spec(B)$ and the diagonal morphism $e : \Spec(B) \to R$.
We claim there is a canonical isomorphism
$$
\varphi :
R \times_{s, \Spec(B)} Y
\longrightarrow
Y \times_{\Spec(B), t} R
$$
over $R$. Over the open subscheme $e(\Spec(B)) \subset R$ the two
pullbacks are the same because $s \circ e = t \circ e = \text{id}_{\Spec(B)}$
hence there is a canonical isomorphism. Because
$B/\mathfrak m B = A/\mathfrak m$ the scheme $R$ has a unique
point $r$ lying over $\mathfrak m \in \Spec(A)$ which is a closed point,
and the restriction of the two pullbacks to $R \setminus \{r\}$ both map
isomorphically to $R \setminus \{r\}$. Thus the isomorphism over
$e(\Spec(B))$ extends uniquely to an isomorphism over all of $R$.
In exactly the same way one verifies that $\varphi$ defines a descent
datum for $Y/B/A$ (Descent on Spaces, Definition
\ref{spaces-descent-definition-descent-datum}). Now since every
descent datum for algebraic spaces relative to an fppf covering
is effective by Bootstrap, Lemma \ref{bootstrap-lemma-descend-algebraic-space}.

\medskip\noindent
Thus we find a morphism of algebraic spaces $f : X \to \Spec(A)$
whose base change to $\Spec(B)$ is $Y \to \Spec(B)$. Since
$\Spec(B) \to \Spec(A)$ is surjective \'etale we see that $f$
is proper (Descent on Spaces, Lemma
\ref{spaces-descent-lemma-descending-property-proper}). As
$\Spec(B) \setminus V(\mathfrak m B) \to \Spec(A) \setminus V(\mathfrak m) = U$
is surjective \'etale we conclude that $f^{-1}(U) \to U$ is an
isomorphism (Descent on Spaces, Lemma
\ref{spaces-descent-lemma-descending-property-isomorphism})
Thus $f : X \to \Spec(A)$ is an
object of (\ref{equation-modification}) as desired.
\end{proof}

\begin{lemma}
\label{lemma-dominate-by-admissible-blowup}
Let $(A, \mathfrak m, \kappa)$ be a Noetherian local ring.
Let $f : X \to S$ be an object of (\ref{equation-modification}).
Then there exists a $U$-admissible blowup $S' \to S$
which dominates $X$.
\end{lemma}

\begin{proof}
Special case of More on Morphisms of Spaces,
Lemma \ref{spaces-more-morphisms-lemma-dominate-modification-by-blowup}.
\end{proof}

\noindent
Let $(A, \mathfrak m, \kappa)$ be a Noetherian local ring.
Let $A^\wedge$ be the completion of $A$. Set
$S^\wedge = \Spec(A^\wedge)$, $S = \Spec(A)$ and let
$U^\wedge \subset S^\wedge$, $U \subset S$
be the complement of the closed point. Picture
$$
\xymatrix{
U^\wedge \ar[r] \ar[d] & S^\wedge \ar[d] \\\
U \ar[r] & S
}
$$
This is a cartesian square of schemes.

\begin{lemma}
\label{lemma-descend-admissible-blowup}
With assumption and notation as above. If $Y \to S^\wedge$ is a
$U^\wedge$-admissible blowup, then there exists a $U$-admissible
blowup $X \to S$ such that $Y = X \times_S S^\wedge$.
\end{lemma}

\begin{proof}
By definition there exists an ideal $J \subset A^\wedge$ such that
$V(J) = \{\mathfrak m A^\wedge\}$ and such that $Y$ is the blowup
of $S^\wedge$ in the closed subscheme defined by $J$, see
Divisors, Definition \ref{divisors-definition-admissible-blowup}.
Since $A^\wedge$ is Noetherian this implies
$\mathfrak m^n A^\wedge \subset J$ for some $n$.
Since $A^\wedge/\mathfrak m^n A^\wedge = A/\mathfrak m^n$
we find an ideal $\mathfrak m^n \subset I \subset A$
such that $J = I A^\wedge$. Let $X \to S$ be the blowup in $I$.
Since $A \to A^\wedge$ is flat
we conclude that the base change of $X$ is $Y$ by
Divisors, Lemma \ref{divisors-lemma-flat-base-change-blowing-up}.
\end{proof}

\begin{lemma}
\label{lemma-closed-immersion-on-fibre}
Let $(A, \mathfrak m, \kappa)$ be a Noetherian local ring.
Let $g : X \to Y$ be a morphism in the category (\ref{equation-modification}).
If the induced morphism $X_\kappa \to Y_\kappa$ of special fibres is
a closed immersion, then $g$ is a closed immersion.
\end{lemma}

\begin{proof}
This is a special case of
More on Morphisms of Spaces, Lemma
\ref{spaces-more-morphisms-lemma-where-closed-immersion}.
\end{proof}

\begin{lemma}
\label{lemma-G-ring}
If $A$ is a G-ring, then the category (\ref{equation-modification})
for $A$ is equivalent to the category (\ref{equation-modification})
for the completion $A^\wedge$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-henselian} and
More on Algebra, Lemma \ref{more-algebra-lemma-henselization-G-ring}
we may assume that $A$ is henselian.
Fully faithfulness follows from
Lemma \ref{lemma-fully-faithfulness-to-completion}. We will prove the
base change functor from the category (\ref{equation-modification}) for $A$
to the category (\ref{equation-modification}) for the completion $A^\wedge$
is essentially surjective.

\medskip\noindent
Let $X \to \Spec(A^\wedge)$ be an object of the category
(\ref{equation-modification}) for the completion $A^\wedge$.
Denote $U^\wedge \subset \Spec(A^\wedge)$ the complement of
the closed point. By Lemma \ref{lemma-dominate-by-admissible-blowup}
we can find a $U^\wedge$-admissible blowup of $\Spec(A^\wedge)$
dominating $X$. By Lemma \ref{lemma-descend-admissible-blowup}
this is the base change of a $U$-admissible blow up $X'_0 \to \Spec(A)$.
In other words, we have a morphism
$$
f : X' \longrightarrow X
$$
over $A^\wedge$ where $X' = X'_0 \times_{\Spec(A)} \Spec(A^\wedge)$.
Let $R = X' \times_X X'$. Since $X \to \Spec(A')$ is separated, we
see that
$$
i : R \to X' \times_{\Spec(A^\wedge)} X' =
(X'_0 \times_{\Spec(A)} X'_0) \times_{\Spec(A)} \Spec(A^\wedge)
$$
is a closed immersion. Moreover, the restriction of $i$ to
$U^\wedge$ is an isomorphism, in fact, it is equal to the
base change of $X'_{0, U} \to X'_{0, U} \times_U X'_{0, U}$ to $U^\wedge$.
Hence we can apply Lemma \ref{lemma-equivalence-on-affine}
to see there exists a closed subscheme
$R_0 \subset X'_0 \times_{\Spec(A)} X'_0$ whose base change to
$\Spec(A^\wedge)$ is $R$. Picture
$$
\xymatrix{
R \ar@<1ex>[r] \ar@<-1ex>[r] \ar[d] &
X' \ar[r] \ar[d] &
X \ar[r] &
\Spec(A^\wedge) \ar[d] \\
R_0 \ar@<1ex>[r] \ar@<-1ex>[r] & X'_0 \ar[rr] & & \Spec(A^\wedge)
}
$$
we get the arrows by fully faithfulness of our functor.
Missing so far: $X_0$.

\medskip\noindent
Write $A^\wedge = \colim A_i$ as a filtered colimit of finite type
$A$-algebras $A_i$. The category of algebraic spaces of finite presentation
over $A^\wedge$ is the limit of the categories of algebraic spaces of
finite presentation over the $A_i$'s, see
Limits of Spaces, Lemma \ref{spaces-limits-lemma-descend-finite-presentation}.
Thus we can enlarge the commutative diagram above as follows
$$
\xymatrix{
R \ar@<1ex>[r] \ar@<-1ex>[r] \ar[d] &
X' \ar[r] \ar[d] &
X \ar[r] \ar[d] &
\Spec(A^\wedge) \ar[d]_a \\
R_{0, A_i} \ar@<1ex>[r] \ar@<-1ex>[r] \ar[d] &
X'_{0, A_i} \ar[r] \ar[d] &
X_i \ar[r] &
\Spec(A_i) \ar[d] \\
R_0 \ar@<1ex>[r] \ar@<-1ex>[r] & X'_0 \ar[rr] & & \Spec(A^\wedge)
}
$$
for a suitable $i$. Here $R_{0, A_i} = R_0 \times_{\Spec(A)} \Spec(A_i)$
and similarly for $X'_{0, A_i}$ (note that no matter how you ``descend''
$R'$, $X'$ to $A_i$ after increasing $i$ these algebraic spaces are isomorphic
to $R_{0, A_i}$, $X'_{0, A_i}$ by the result of the lemma cited above).
After enlarging $i$ we may further assume that
$X_i$ is proper over $\Spec(A_i)$ and that $X_i \to \Spec(A_i)$
is an isomorphism over $U_i = \Spec(A_i) \setminus V(\mathfrak m_A A_i)$, see
Limits of Spaces, Lemmas \ref{spaces-limits-lemma-eventually-proper} and
\ref{spaces-limits-lemma-descend-isomorphism}.

\medskip\noindent
Let $Z \subset X$ be the closed fibre. Since $X' \to X$ is an isomorphism
over $U^\wedge = X \setminus Z$ we are in
Situation \ref{situation-coequalizer-glue} over the base $\Spec(A^\wedge)$.
For $n \geq 1$ let $X_n \to X$ be the coequalizer of
$s_n, t_n : R_n \to Y_n = X' \coprod Z_n$ as in
(\ref{equation-system-coequalizers}). Finally, pick $m, n \geq 1$ as in
Lemma \ref{lemma-essentially-constant}.

\medskip\noindent
By Smoothing Ring Maps, Theorem \ref{smoothing-theorem-approximation-property}
we can find an $A$-valued point $b : \Spec(A) \to \Spec(A_i)$ arbitrarily
close to the given formal point $a : \Spec(A^\wedge) \to \Spec(A_i)$.
We pick it so close that $b$ and $a$ agree on
$\Spec(A/\mathfrak m^{n + m + 1})$.
Pulling back the middle horizontal row of the preceding diagram to
$\Spec(A)$ using $b$ we obtain
$$
\xymatrix{
R_0 \ar@<1ex>[r] \ar@<-1ex>[r] & X'_0 \ar[r] & X_b \ar[r] & \Spec(A)
}
$$
Base changing back to $\Spec(A^\wedge)$ we get a commutative diagram
$$
\xymatrix{
R \ar@<1ex>[r] \ar@<-1ex>[r] & X' \ar[r] & X_{b, A^\wedge} \ar[r] &
\Spec(A^\wedge)
}
$$
Moreover, the base change of this diagram to
$\Spec(A/\mathfrak m^{n + m + 1})$ is
isomorphic to the corresponding base change for the corresponding
diagram with $X$ instead of $X_{b, A^\wedge}$.
Let
$$
Z_t = X \times_{\Spec(A^\wedge)} \Spec(A/\mathfrak m^t) \cong
X_{b, A^\wedge} \times_{\Spec(A^\wedge)} \Spec(A/\mathfrak m^t)
\hookrightarrow X_{b, A^\wedge}
$$
be the corresponding closed immersion for $t \leq n + m$.
A computation (omitted) shows that the resulting morphism
$Y_{n + m} = X' \amalg Z_{n + m} \to X_{b, A^\wedge}$
equalizes $s_{n + m}$ and $t_{n + m}$.
Hence we obtain a morphism
$$
X_{n + m} \to X_{b, A^\wedge}
$$
Since $X_n \to X_{n + m}$ factors through $X$ (as a closed
subspace of $X_{n + m}$), we obtain in particular
a morphism $X \to X_{b, A^\wedge}$. By construction this
morphism induces an isomorphism on special fibres.
By Lemma \ref{lemma-closed-immersion-on-fibre} we
conclude that $X \to X_{b, A^\wedge}$ is a closed immersion.
(Warning: in general one cannot conclude that $X \to X_{b, A^\wedge}$
is an isomorphism at this point.)
We conclude that $X \to X_{b, A^\wedge}$ is the base change
of a closed immersion $X_0 \to X_b$ by applying
Lemma \ref{lemma-equivalence-on-affine}
once more (to the triple consisting of $X_b$, the special
fibre $Z \subset X_b$, and the flat affine morphism
$X_{b, A^\wedge} \to X_b$).
\end{proof}

\begin{lemma}
\label{lemma-projective-over-complete}
Let $(A, \mathfrak m, \kappa)$ be a complete Noetherian local ring.
Let $X$ be an algebraic space over $\Spec(A)$.
If $X \to \Spec(A)$ is proper and $\dim(X_\kappa) \leq 1$, then
$X$ is a scheme projective over $A$.
\end{lemma}

\begin{proof}
By Spaces over Fields, Lemma
\ref{spaces-over-fields-lemma-codim-1-point-in-schematic-locus}
the algebraic space $X_\kappa$ is a scheme. Hence $X_\kappa$
is a proper scheme of dimension $\leq 1$ over $\kappa$.
By Varieties, Lemma \ref{varieties-lemma-dim-1-proper-projective}
we see that $X_\kappa$ is H-projective over $\kappa$.
Let $\mathcal{L}$ be an ample invertible sheaf on $X_\kappa$.

\medskip\noindent
We are going to show that $\mathcal{L}$ lifts to a compatible system
$\{\mathcal{L}_n\}$ of
invertible sheaves on the $n$th infinitesimal neighbourhoods
$$
X_n = X \times_{\Spec(A)} \Spec(A/\mathfrak m^n)
$$
of $X_\kappa = X_1$. Recall that the \'etale sites of $X_\kappa$
and all $X_n$ are canonically equivalent, see
More on Morphisms of Spaces, Lemma
\ref{spaces-more-morphisms-lemma-thickening-equivalence}.
In the rest of the proof we do not distinguish between sheaves on $X_n$
and sheaves on $X_m$ or $X_\kappa$.
Suppose, given a lift $\mathcal{L}_n$ to $X_n$. We consider
the exact sequence
$$
1 \to
(1 + \mathfrak m^n\mathcal{O}_X/\mathfrak m^{n + 1}\mathcal{O}_X)^* \to
\mathcal{O}_{X_{n + 1}}^* \to \mathcal{O}_{X_n}^* \to 1
$$
of sheaves on $X_{n + 1}$. We have
$(1 + \mathfrak m^n\mathcal{O}_X/\mathfrak m^{n + 1}\mathcal{O}_X)^*
\cong \mathfrak m^n\mathcal{O}_X/\mathfrak m^{n + 1}\mathcal{O}_X$
as abelian sheaves on $X_{n + 1}$. The class of $\mathcal{L}_n$ in
$H^1(X_n, \mathcal{O}_{X_n}^*)$ (see
Cohomology on Sites, Lemma \ref{sites-cohomology-lemma-h1-invertible})
can be lifted to an element of $H^1(X_{n + 1}, \mathcal{O}_{X_{n + 1}}^*)$
if and only if the obstruction in
$H^2(X_{n + 1}, \mathfrak m^n\mathcal{O}_X/\mathfrak m^{n + 1}\mathcal{O}_X)$
is zero. Note that
$\mathfrak m^n\mathcal{O}_X/\mathfrak m^{n + 1}\mathcal{O}_X$
is a quasi-coherent $\mathcal{O}_{X_\kappa}$-module on $X_\kappa$.
Hence its \'etale cohomology agrees with its cohomology on the
scheme $X_\kappa$, see
Descent, Proposition \ref{descent-proposition-same-cohomology-quasi-coherent}.
However, as $X_\kappa$ is a Noetherian scheme of dimension $\leq 1$
this cohomology group vanishes (Cohomology, Proposition
\ref{cohomology-proposition-vanishing-Noetherian}).

\medskip\noindent
By Grothendieck's algebraization theorem
(Cohomology of Schemes, Theorem \ref{coherent-theorem-algebraization})
we find a projective morphism of schemes $Y \to \Spec(A)$ and a compatible
system of isomorphisms $X_n \to Y_n$. (Here we use the assumption
that $A$ is complete.) By
More on Morphisms of Spaces, Lemma
\ref{spaces-more-morphisms-lemma-algebraize-morphism}
we see that $X \cong Y$ and the proof is complete.
\end{proof}

\begin{lemma}
\label{lemma-modification-of-dim-2-is-projective-over-complete}
If $(A, \mathfrak m, \kappa)$ is a complete Noetherian local domain
of dimension $2$, then every modification of $\Spec(A)$ is projective over $A$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-projective-over-complete} it suffices to show that
the special fibre of any modification $X$ of $\Spec(A)$ has dimension
$\leq 1$. Let $U \to X$ be an \'etale morphism with $U$ affine.
Since $X \to \Spec(A)$ is a modification (Spaces over Fields, Definition
\ref{spaces-over-fields-definition-modification})
we see that a dense open of $U$ is \'etale over $A$.
In particular, every generic point $\eta$ of an irreducible component
$U'$ of $U$ maps to the generic point of $\Spec(A)$ and
$f.f.(A) \subset \kappa(\eta)$ is finite separable.
If $u \in U'$ is a closed point lying over $\mathfrak m \in \Spec(A)$,
then by the dimension formula we see that
$$
\dim(\mathcal{O}_{U', u}) \leq \dim(A) = 2,
$$
see Morphisms, Lemma \ref{morphisms-lemma-dimension-formula}.
Since $\eta \not \in U'_\kappa$, the dimension of $U'_\kappa$
can be at most $1$ as desired.
\end{proof}





\section{Quadratic transformations}
\label{section-quadratic}

\noindent
In this section we study what happens when we blow up a nonsingular point
on a surface. We hesitate the formally define such a morphism as a
{\it quadratic transformation} as on the one hand often other names are
used and on the other hand the phrase ``quadratic transformation'' is
sometimes used with a different meaning.

\begin{lemma}
\label{lemma-blowup}
Let $(A, \mathfrak m, \kappa)$ be a regular local ring of dimension $2$.
Let $f : X \to S = \Spec(A)$ be the blowing up of $A$ in $\mathfrak m$.
There is a closed immersion
$$
r : X \longrightarrow \mathbf{P}^1_S
$$
over $S$ such that $\mathcal{O}_X(1) = r^*\mathcal{O}_{\mathbf{P}^1_S}(1)$
and such that $r|_E : E \to \mathbf{P}^1_\kappa$ is an isomorphism.
\end{lemma}

\begin{proof}
As $A$ is regular of dimension $2$ we can write $\mathfrak m = (x, y)$.
Then $x$ and $y$ placed in degree $1$ generate the Rees algebra
$\bigoplus_{n \geq 0} \mathfrak m^n$ over $A$. Recall that
$X = \text{Proj}(\bigoplus_{n \geq 0} \mathfrak m^n)$, see
Divisors, Lemma \ref{divisors-lemma-blowing-up-affine}.
Thus the surjection
$$
A[T_0, T_1] \longrightarrow \bigoplus\nolimits_{n \geq 0} \mathfrak m^n,
\quad
T_0 \mapsto x,\ T_1 \mapsto y
$$
of graded $A$-algebras induces a closed immersion
$r : X \to \mathbf{P}^1_S = \text{Proj}(A[T_0, T_1])$
such that $\mathcal{O}_X(1) = r^*\mathcal{O}_{\mathbf{P}^1_S}(1)$, see
Constructions, Lemma
\ref{constructions-lemma-surjective-graded-rings-generated-degree-1-map-proj}.
To prove the final statement note that
$$
\left(\bigoplus\nolimits_{n \geq 0} \mathfrak m^n\right) \otimes_A \kappa =
\bigoplus\nolimits_{n \geq 0} \mathfrak m^n/\mathfrak m^{n + 1} \cong
\kappa[\overline{x}, \overline{y}]
$$
a polynomial algebra, see Algebra, Lemma \ref{algebra-lemma-regular-graded}.
This proves that the fibre of $X \to S$ over $\Spec(\kappa)$ is equal to
$\text{Proj}(\kappa[\overline{x}, \overline{y}]) = \mathbf{P}^1_\kappa$, see
Constructions, Lemma \ref{constructions-lemma-base-change-map-proj}.
Recall that $E$ is the closed subscheme of $X$ defined by
$\mathfrak m\mathcal{O}_X$, i.e., $E = X_\kappa$.
By our choice of the morphism $r$ we see that $r|_E$ in fact
produces the identification of $E = X_\kappa$ with the special
fibre of $\mathbf{P}^1_S \to S$.
\end{proof}

\begin{lemma}
\label{lemma-blowup-regular}
Let $(A, \mathfrak m, \kappa)$ be a regular local ring of dimension $2$.
Let $f : X \to S = \Spec(A)$ be the blowing up of $A$ in $\mathfrak m$.
Then $X$ is an irreducible regular scheme.
\end{lemma}

\begin{proof}
Observe that $X$ is integral by
Divisors, Lemma \ref{divisors-lemma-blow-up-integral-scheme}
and
Algebra, Lemma \ref{algebra-lemma-regular-domain}.
To see $X$ is regular it suffices to check that $\mathcal{O}_{X, x}$
is regular for closed points $x \in X$, see
Properties, Lemma \ref{properties-lemma-characterize-regular}.
Let $x \in X$ be a closed point. Since $f$ is proper $x$ maps to
$\mathfrak m$, i.e., $x$ is a point of the exceptional divisor $E$.
Then $E$ is an effective Cartier divisor and $E \cong \mathbf{P}^1_\kappa$.
Thus if $f \in \mathfrak m_x \subset \mathcal{O}_{X, x}$ is a local
equation for $E$, then
$\mathcal{O}_{X, x}/(f) \cong \mathcal{O}_{\mathbf{P}^1_\kappa, x}$.
Since $\mathbf{P}^1_\kappa$ is covered by two affine opens which are the
spectrum of a polynomial ring over $\kappa$, we see that
$\mathcal{O}_{\mathbf{P}^1_\kappa, x}$ is regular by
Algebra, Lemma \ref{algebra-lemma-dim-affine-space}.
We conclude by
Algebra, Lemma \ref{algebra-lemma-regular-mod-x}.
\end{proof}

\begin{lemma}
\label{lemma-cohomology-of-blowup}
Let $(A, \mathfrak m, \kappa)$ be a regular local ring of dimension $2$.
Let $f : X \to S = \Spec(A)$ be the blowing up of $A$ in $\mathfrak m$.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
\begin{enumerate}
\item $H^p(X, \mathcal{F}) = 0$ for $p \not \in \{0, 1\}$,
\item $H^1(X, \mathcal{O}_X(n)) = 0$ for $n \geq -1$,
\item $H^1(X, \mathcal{F}) = 0$ if $\mathcal{F}$ or $\mathcal{F}(1)$
is globally generated,
\item $H^0(X, \mathcal{O}_X(n)) = \mathfrak m^{\max(0, n)}$,
\item $\text{length}_A H^1(X, \mathcal{O}_X(n)) = -n(-n - 1)/2$
if $n < 0$.
\end{enumerate}
\end{lemma}

\begin{proof}
If $\mathfrak m = (x, y)$, then $X$ is covered by the spectra
of the affine blowup algebras $A[\frac{\mathfrak m}{x}]$ and
$A[\frac{\mathfrak m}{y}]$ because $x$ and $y$ placed in degree $1$
generate the Rees algebra $\bigoplus \mathfrak m^n$ over $A$.
See Divisors, Lemma \ref{divisors-lemma-blowing-up-affine} and
Constructions, Lemma \ref{constructions-lemma-proj-quasi-compact}.
Since $X$ is separated by
Constructions, Lemma \ref{constructions-lemma-proj-separated}
we see that cohomology of quasi-coherent sheaves vanishes in
degrees $\geq 2$ by Cohomology of Schemes, Lemma
\ref{coherent-lemma-vanishing-nr-affines}.

\medskip\noindent
Let $i : E \to X$ be the exceptional divisor, see
Divisors, Definition \ref{divisors-definition-blow-up}.
Recall that $\mathcal{O}_X(-E) = \mathcal{O}_X(1)$ is
$f$-relatively ample, see
Divisors, Lemma \ref{divisors-lemma-blowing-up-gives-effective-Cartier-divisor}.
Hence we know that $H^1(X, \mathcal{O}_X(-nE)) = 0$ for some $n > 0$,
see Cohomology of Schemes, Lemma \ref{coherent-lemma-kill-by-twisting}.
Consider the filtration
$$
\mathcal{O}_X(-nE) \subset \mathcal{O}_X(-(n - 1)E) \subset
\ldots \subset \mathcal{O}_X(-E) \subset \mathcal{O}_X \subset \mathcal{O}_X(E)
$$
The succesive quotients are the sheaves
$$
\mathcal{O}_X(-t E)/\mathcal{O}_X(-(t + 1)E) =
\mathcal{O}_X(t)/\mathcal{I}(t) =
i_*\mathcal{O}_E(t)
$$
where $\mathcal{I} = \mathcal{O}_X(-E)$ is the ideal sheaf of $E$.
By Lemma \ref{lemma-blowup} we have $E = \mathbf{P}^1_\kappa$ and
$\mathcal{O}_E(1)$ indeed corresponds to the usual Serre twist of
the structure sheaf on $\mathbf{P}^1$. Hence the cohomology
of $\mathcal{O}_E(t)$ vanishes in degree $1$ for $t \geq -1$, see
Cohomology of Schemes, Lemma
\ref{coherent-lemma-cohomology-projective-space-over-ring}.
Since this is equal to $H^1(X, i_*\mathcal{O}_E(t))$ (by
Cohomology of Schemes, Lemma \ref{coherent-lemma-relative-affine-cohomology})
we find that $H^1(X, \mathcal{O}_X(-(t + 1)E)) \to H^1(X, \mathcal{O}_X(-tE))$
is surjective for $t \geq -1$. Hence
$$
0 = H^1(X, \mathcal{O}_X(-nE))
\longrightarrow
H^1(X, \mathcal{O}_X(-tE)) = H^1(X, \mathcal{O}_X(t))
$$
is surjective for $t \geq -1$ which proves (2).

\medskip\noindent
Let $\mathcal{F}$ be globally generated. This means there exists
a short exact sequence
$$
0 \to \mathcal{G} \to \bigoplus\nolimits_{i \in I} \mathcal{O}_X
\to \mathcal{F} \to 0
$$
Note that $H^1(X, \bigoplus_{i \in I} \mathcal{O}_X) =
\bigoplus_{i \in I} H^1(X, \mathcal{O}_X)$ by
Cohomology, Lemma \ref{cohomology-lemma-quasi-separated-cohomology-colimit}.
By part (2) we have $H^1(X, \mathcal{O}_X) = 0$.
If $\mathcal{F}(1)$ is globally generated, then we can find a
surjection $\bigoplus_{i \in I} \mathcal{O}_X(-1) \to \mathcal{F}$
and argue in a similar fashion.
In other words, part (3) follows from part (2).

\medskip\noindent
For part (4) we note that for all $n$ large enough we have
$\Gamma(X, \mathcal{O}_X(n)) = \mathfrak m^n$, see
Cohomology of Schemes, Lemma \ref{coherent-lemma-recover-tail-graded-module}.
If $n \geq 0$, then we can use the short exact sequence
$$
0 \to \mathcal{O}_X(n) \to \mathcal{O}_X(n - 1) \to
i_*\mathcal{O}_E(n - 1) \to 0
$$
and the vanishing of $H^1$ for the sheaf on the left to get a commutative
diagram
$$
\xymatrix{
0 \ar[r] &
\mathfrak m^{\max(0, n)} \ar[r] \ar[d] &
\mathfrak m^{\max(0, n - 1)} \ar[r] \ar[d] &
\mathfrak m^{\max(0, n)}/\mathfrak m^{\max(0, n - 1)} \ar[r] \ar[d] & 0\\
0 \ar[r] &
\Gamma(X, \mathcal{O}_X(n)) \ar[r] &
\Gamma(X, \mathcal{O}_X(n - 1)) \ar[r] &
\Gamma(E, \mathcal{O}_E(n - 1)) \ar[r] & 0
}
$$
with exact rows. In fact, the rows are exact also for $n < 0$
because in this case the groups on the right are zero.
In the proof of Lemma \ref{lemma-blowup}
we have seen that the right vertical arrow is an isomorphism
(details omitted). Hence if the left vertical arrow is an isomorphism, so
is the middle one. In this way we see that (4) holds by
descending induction on $n$.

\medskip\noindent
Finally, we prove (5) by descending induction on $n$ and the sequences
$$
0 \to \mathcal{O}_X(n) \to \mathcal{O}_X(n - 1) \to
i_*\mathcal{O}_E(n - 1) \to 0
$$
Namely, for $n \geq -1$ we already know $H^1(X, \mathcal{O}_X(n)) = 0$.
Since
$$
H^1(X, i_*\mathcal{O}_E(-2)) =
H^1(E, \mathcal{O}_E(-2)) =
H^1(\mathbf{P}^1_\kappa, \mathcal{O}(-2)) \cong \kappa
$$
by Cohomology of Schemes, Lemma
\ref{coherent-lemma-cohomology-projective-space-over-ring}
which has length $1$ as an $A$-module, we conclude from the long exact
cohomology sequence that (5) holds for $n = -2$. And so on and so forth.
\end{proof}

\begin{lemma}
\label{lemma-blowup-improve}
Let $(A, \mathfrak m)$ be a regular local ring of dimension $2$.
Let $f : X \to S = \Spec(A)$ be the blowing up of $A$ in $\mathfrak m$.
Let $\mathfrak m^n \subset I \subset \mathfrak m$ be an ideal.
Let $d \geq 0$ be the largest integer such that
$$
I \mathcal{O}_X \subset \mathcal{O}_X(-dE)
$$
where $E$ is the exceptional divisor. Set
$\mathcal{I}' = I\mathcal{O}_X(dE) \subset \mathcal{O}_X$.
Then $d > 0$, the sheaf
$\mathcal{O}_X/\mathcal{I}'$ is supported in finitely many
closed points $x_1, \ldots, x_r$ of $X$, and
\begin{align*}
\text{length}_A(A/I)
& >
\text{length}_A \Gamma(X, \mathcal{O}_X/\mathcal{I}') \\
& \geq
\sum\nolimits_{i = 1, \ldots, r}
\text{length}_{\mathcal{O}_{X, x_i}}
(\mathcal{O}_{X, x_i}/\mathcal{I}'_{x_i})
\end{align*}
\end{lemma}

\begin{proof}
Since $I \subset \mathfrak m$ we see that every element of $I$
vanishes on $E$. Thus we see that $d \geq 1$. On the other hand, since
$\mathfrak m^n \subset I$ we see that $d \leq n$. Consider the
short exact sequence
$$
0 \to I\mathcal{O}_X \to \mathcal{O}_X \to \mathcal{O}_X/I\mathcal{O}_X \to 0
$$
Since $I\mathcal{O}_X$ is globally generated, we see that
$H^1(X, I\mathcal{O}_X) = 0$ by Lemma \ref{lemma-cohomology-of-blowup}.
Hence we obtain a surjection
$A/I \to \Gamma(X, \mathcal{O}_X/I\mathcal{O}_X)$. Consider the short exact
sequence
$$
0 \to
\mathcal{O}_X(-dE)/I\mathcal{O}_X \to
\mathcal{O}_X/I\mathcal{O}_X \to
\mathcal{O}_X/\mathcal{O}_X(-dE) \to 0
$$
By Divisors, Lemma \ref{divisors-lemma-codim-1-part}
we see that $\mathcal{O}_X(-dE)/I\mathcal{O}_X$ is supported in finitely many
closed points of $X$. In particular, this coherent sheaf has vanishing higher
cohomology groups (detail omitted). Thus in the following diagram
$$
\xymatrix{
& & A/I \ar[d] \\
0 \ar[r] &
\Gamma(X, \mathcal{O}_X(-dE)/I\mathcal{O}_X) \ar[r] &
\Gamma(X, \mathcal{O}_X/I\mathcal{O}_X) \ar[r] &
\Gamma(X, \mathcal{O}_X/\mathcal{O}_X(-dE)) \ar[r] & 0
}
$$
the bottom row is exact and the vertical arrow surjective. We have
$$
\text{length}_A \Gamma(X, \mathcal{O}_X(-dE)/I\mathcal{O}_X) <
\text{length}_A(A/I)
$$
since $\Gamma(X, \mathcal{O}_X/\mathcal{O}_X(-dE))$ is nonzero.
Namely, the image of $1 \in \Gamma(X, \mathcal{O}_X)$
is nonzero as $d > 0$.

\medskip\noindent
To finish the proof we translate the results above into the statements
of the lemma. Since
$\mathcal{O}_X(dE)$ is invertible we have
$$
\mathcal{O}_X/\mathcal{I}' =
\mathcal{O}_X(-dE)/I\mathcal{O}_X \otimes_{\mathcal{O}_X} \mathcal{O}_X(dE).
$$
Thus $\mathcal{O}_X/\mathcal{I}'$ and $\mathcal{O}_X(-dE)/I\mathcal{O}_X$
are supported in the same set of finitely many
closed points, say $x_1, \ldots, x_r \in E \subset X$.
Moreover we obtain
$$
\Gamma(X, \mathcal{O}_X(-dE)/I\mathcal{O}_X) =
\bigoplus \mathcal{O}_X(-dE)_{x_i}/I\mathcal{O}_{X, x_i}
\cong
\bigoplus \mathcal{O}_{X, x_i}/\mathcal{I}'_{x_i} =
\Gamma(X, \mathcal{O}_X/\mathcal{I}')
$$
because an invertible module over a local ring is trivial.
Thus we obtain the strict inequality. We also get the second because
$$
\text{length}_A(\mathcal{O}_{X, x_i}/\mathcal{I}'_{x_i}) \geq
\text{length}_{\mathcal{O}_{X, x_i}}(\mathcal{O}_{X, x_i}/\mathcal{I}'_{x_i})
$$
as is immediate from the definition of length.
\end{proof}



\section{Quadratic transformations of spaces}
\label{section-quadratic-spaces}

\noindent
Using the result above we can prove that blowups in points dominate
any modification of a regular $2$ dimensional algebraic space.

\medskip\noindent
Let $X$ be a decent algebraic space over some base scheme $S$.
Let $x \in |X|$ be a closed point. By
Decent Spaces, Lemma \ref{decent-spaces-lemma-decent-space-closed-point}
we can represent $x$ by a closed immersion $i : \Spec(k) \to X$.
Then the {\it blowing up of $X$ at $x$} means the blowing up of $X$
in the closed subspace $Z = i(\Spec(k)) \subset X$.

\begin{lemma}
\label{lemma-make-ideal-principal}
Let $S$ be a scheme. Let $X$ be a Noetherian algebraic space over $S$.
Let $T \subset |X|$ be a finite set of closed points $x$ such that
(1) $X$ is regular at $x$ and (2) the local ring of $X$ at $x$ has
dimension $2$. Let $\mathcal{I} \subset \mathcal{O}_X$ be a quasi-coherent
sheaf of ideals such that $\mathcal{O}_X/\mathcal{I}$ is supported on $T$.
Then there exists a sequence
$$
X_n \to X_{n - 1} \to \ldots \to X_1 \to X_0 = X
$$
where $X_{i + 1} \to X_i$ is the blowing up of $X_i$ at a closed
point $x_i$ lying above a point of $T$ such that
$\mathcal{I}\mathcal{O}_{X_n}$ is an invertible ideal sheaf.
\end{lemma}

\begin{proof}
Say $T = \{x_1, \ldots, x_r\}$. Pick an \'etale morphism
$U \to X$ where $U$ is a scheme with points $u_i \in U$ lying over
$x_i$. By Decent Spaces, Lemma
\ref{decent-spaces-lemma-decent-no-specializations-map-to-same-point}
the points $u_i$ are closed points. After shrinking $U$ we may
assume these are the only points of $U$ mapping to $T$.
The local rings
$\mathcal{O}_{U, u_i}$ are regular local of dimension $2$, see
Properties of Spaces, Definitions
\ref{spaces-properties-definition-regular-at-point} and
\ref{spaces-properties-definition-dimension-local-ring}.
Let $I_i \subset \mathcal{O}_{U, u_i}$ be the stalk of
$\mathcal{I}|_U$ at $u_i$. Set
$$
n_i = \text{length}_{\mathcal{O}_{U, u_i}}(\mathcal{O}_{U, u_i}/I_i)
$$
This is finite as $\mathcal{O}_X/\mathcal{I}$ is supported on $T$
and hence $\mathcal{O}_{U, u_i}/I_i$ has support equal to
$\{\mathfrak m_{u_i}\}$ (see Algebra, Lemma \ref{algebra-lemma-support-point}).
We are going to use induction on $\sum n_i$. If $n_i = 0$ for all
$i$, then $\mathcal{I} = \mathcal{O}_X$ and we are done.

\medskip\noindent
Suppose $n_i > 0$. Let $X' \to X$ be the blowing up of $X$ in $x_i$
(see discussion above the lemma). Since $U \to X$ is \'etale and $u_i$
is the unique point of $U$ lying over $x$ we see that $U' = U \times_X X'$
is the blowup of $U$ in $u_i$, see
Divisors on Spaces, Lemma
\ref{spaces-divisors-lemma-flat-base-change-blowing-up}.
Since $\Spec(\mathcal{O}_{U, u_i}) \to U$ is flat we see that
$U' \times_U \Spec(\mathcal{O}_{U, u_i})$ is the blowup of
the ring $\mathcal{O}_{U, u_i}$ in the maximal ideal. Hence
both squares in the commutative diagram
$$
\xymatrix{
\text{Proj}(\bigoplus\nolimits_{d \geq 0} \mathfrak m_{u_i}^d) \ar[r] \ar[d] &
U' \ar[d] \ar[r] & X' \ar[d] \\
\Spec(\mathcal{O}_{U, u_i}) \ar[r] & U \ar[r] & X
}
$$
are cartesian. Let $E \subset X'$, $E' \subset U'$,
$E'' \subset \text{Proj}(\bigoplus\nolimits_{d \geq 0} \mathfrak m_{u_i}^d)$
be the exceptional divisors. Let $d \geq 1$ be the integer found in
Lemma \ref{lemma-blowup-improve} for the ideal
$\mathcal{I}_i \subset \mathcal{O}_{U, u_i}$.
Since the horizontal arrows in the diagram are flat, since
$E'' \to E$ is surjective, and since $E''$ is the pullback of $E$, we see that
$$
\mathcal{I}\mathcal{O}_{X'} \subset \mathcal{O}_{X'}(-dE)
$$
(some details omitted).
Set $\mathcal{I}' = \mathcal{I}\mathcal{O}_{X'}(dE) \subset \mathcal{O}_{X'}$.
Then we see that $\mathcal{O}_{X'}/\mathcal{I}'$ is supported in finitely
many closed points $T' \subset |X'|$ because this holds over
$X \setminus \{x_i\}$ and for the pullback to
$\text{Proj}(\bigoplus\nolimits_{d \geq 0} \mathfrak m_{u_i}^d)$.
The final assertion of Lemma \ref{lemma-blowup-improve}
tells us that the sum of the lengths of the stalks
$\mathcal{O}_{U', u'}/\mathcal{I}'\mathcal{O}_{U', u'}$
for $u'$ lying over $u_i$ is $< n_i$. Hence the sum of the lengths
has decreased.

\medskip\noindent
By induction hypothesis, there exists a sequence
$$
X'_n \to \ldots \to X'_1 \to X'
$$
of blowups at closed points lying over $T'$ such that
$\mathcal{I}'\mathcal{O}_{X'_n}$ is invertible. Since
$\mathcal{I}'\mathcal{O}_{X'}(-dE) = \mathcal{I}\mathcal{O}_{X'}$, we see
that $\mathcal{I}\mathcal{O}_{X'_n} =
\mathcal{I}'\mathcal{O}_{X'_n}(-d(f')^{-1}E)$
where $f' : X'_n \to X'$ is the composition.
Note that $(f')^{-1}E$ is an effective Cartier divisor by
Divisors on Spaces, Lemma
\ref{spaces-divisors-lemma-blow-up-pullback-effective-Cartier}.
Thus we are done by
Divisors on Spaces, Lemma
\ref{spaces-divisors-lemma-sum-effective-Cartier-divisors}.
\end{proof}

\begin{lemma}
\label{lemma-dominate-by-blowing-up-in-points}
Let $S$ be a scheme. Let $X$ be a Noetherian algebraic space over $S$.
Let $T \subset |X|$ be a finite set of closed points $x$ such that
(1) $X$ is regular at $x$ and (2) the local ring of $X$ at $x$ has
dimension $2$. Let $f : Y \to X$ be a proper morphism of
algebraic spaces which is an isomorphism over $U = X \setminus T$.
Then there exists a sequence
$$
X_n \to X_{n - 1} \to \ldots \to X_1 \to X_0 = X
$$
where $X_{i + 1} \to X_i$ is the blowing up of $X_i$ at a closed
point $x_i$ lying above a point of $T$ and a factorization $X_n \to Y \to X$
of the composition.
\end{lemma}

\begin{proof}
By More on Morphisms of Spaces,
Lemma \ref{spaces-more-morphisms-lemma-dominate-modification-by-blowup} 
there exists a $U$-admissible blowup $X' \to X$ which dominates
$Y \to X$. Hence we may assume there exists an ideal sheaf
$\mathcal{I} \subset \mathcal{O}_X$ such that
$\mathcal{O}_X/\mathcal{I}$ is supported on $T$ and such that
$Y$ is the blowing up of $X$ in $\mathcal{I}$.
By Lemma \ref{lemma-make-ideal-principal} 
there exists a sequence
$$
X_n \to X_{n - 1} \to \ldots \to X_1 \to X_0 = X
$$
where $X_{i + 1} \to X_i$ is the blowing up of $X_i$ at a closed
point $x_i$ lying above a point of $T$ such that
$\mathcal{I}\mathcal{O}_{X_n}$ is an invertible ideal sheaf.
By the universal property of blowing up
(Divisors on Spaces, Lemma
\ref{spaces-divisors-lemma-universal-property-blowing-up})
we find the desired factorization.
\end{proof}










\section{Examples}
\label{section-examples}

\noindent
Some examples related to the results earlier in this chapter.

\begin{example}
\label{example-factorial}
\begin{reference}
\cite[4(c)]{Samuel-UFD}
\end{reference}
Let $k$ be a field. The ring $A = k[x, y, z]/(x^r + y^s + z^t)$
is a UFD for $r, s, t$ pairwise coprime integers. Namely, since
$x^r + y^s + z^t$ is irreducible $A$ is a domain. The element $z$
is a prime element, i.e., generates a prime ideal in $A$.
On the other hand, if $r = 1 + ers$ for some $e$, then
$$
A[1/z] \cong k[x', y', 1/z]
$$
where $x' = x/z^{es}$, $y' = y/z^{et}$ and $z = (x')^r + (y')^s$.
Thus $A[1/z]$ is a localization of a polynomial ring and hence
a UFD. It follows from an argument of Nagata that $A$ is a UFD.
See Algebra, Lemma \ref{algebra-lemma-invert-prime-elements}.
A similar argument can be given if $r$ is not congruent to $1$
modulo $rs$.
\end{example}

\begin{example}
\label{example-completion-not-factorial}
\begin{reference}
See \cite{Brieskorn} and \cite{Lipman-rational} for nonvanishing of
local Picard groups in general.
\end{reference}
The ring $A = \mathbf{C}[[x, y, z]]/(x^r + y^s + z^t)$
is not a UFD when $r < s < t$ are pairwise coprime integers
and not equal to $2, 3, 5$. For example consider the special
case $A = \mathbf{C}[[x, y, z]]/(x^2 + y^5 + z^7)$.
Consider the maps
$$
\psi_\zeta : \mathbf{C}[[x, y, z]]/(x^2 + y^5 + z^7) \to \mathbf{C}[[t]]
$$
given by
$$
x \mapsto t^7,\quad
y \mapsto t^3,\quad
z \mapsto -\zeta t^2(1 + t)^{1/7}
$$
where $\zeta$ is a $7$th root of unity. The kernel $\mathfrak p_\zeta$
of $\psi_\zeta$ is a height one prime, hence if $A$ is a UFD, then
it is principal, say given by $f_\zeta \in \mathbf{C}[[x, y, z]]$.
Note that $V(x^3 - y^7) = \bigcup V(\mathfrak p_\zeta)$
and $A/(x^3 - y^7)$ is reduced away from the closed point. Hence,
still assuming $A$ is a UFD, we would obtain
$$
\prod\nolimits_\zeta f_\zeta = u(x^3 - y^7) + a(x^2 + y^5 + z^7)
\quad\text{in}\quad
\mathbf{C}[[x, y, z]]
$$
for some unit $u \in \mathbf{C}[[x, y, z]]$ and some
element $a \in \mathbf{C}[[x, y, z]]$. After scaling by a constant
we may assume $u(0, 0, 0) = 1$. Note that the left hand side vanishes to
order $7$. Hence $a = - x \bmod \mathfrak m^2$. But then we get a term
$xy^5$ on the right hand side which does not occur on the left
hand side. A contradiction.
\end{example}

\begin{example}
\label{example-not-blow-up}
There exists an excellent $2$-dimensional Noetherian local ring
and a modification $X \to S = \Spec(A)$ which is not a scheme.
We sketch a construction. Let $X$ be a normal surface over $\mathbf{C}$
with a unique singular point $x \in X$. Assume that there exists a
resolution $\pi : X' \to X$ such that the exceptional fibre
$C = \pi^{-1}(x)_{red}$ is a smooth projective curve. Furthermore, assume
there exists a point $c \in C$ such that if $\mathcal{O}_C(nc)$
is in the image of $\text{Pic}(X') \to \text{Pic}(C)$, then $n = 0$.
Then we let $X'' \to X'$ be the blowing up in the nonsingular point $c$.
Let $C' \subset X''$ be the strict transform of $C$ and let $E \subset X''$
be the exceptional fibre. By Artin's results
(\cite{ArtinII}; use for example \cite{Mumford-topology}
to see that the normal bundle of $C'$ is negative)
we can blow down the curve $C'$ in $X''$ to obtain an algebraic space $X'''$.
Picture
$$
\xymatrix{
& X'' \ar[ld] \ar[rd] \\
X' \ar[rd] &  & X''' \ar[ld] \\
& X
}
$$
We claim that $X'''$ is not a scheme. This provides us with our example
because $X'''$ is a scheme if and only if the base change of $X'''$
to $A = \mathcal{O}_{X, x}$ is a scheme (details omitted).
If $X'''$ where a scheme, then the image of $C'$ in $X'''$ would
have an affine neighbourhood. The complement of this neighbourhood
would be an effective Cartier divisor on $X'''$ (because $X'''$ is
nonsingular apart from $1$ point). This effective Cartier divisor would
correspond to an effective Cartier divisor on $X''$
meeting $E$ and avoiding $C'$. Taking the image in $X'$ we obtain
an effective Cartier divisor meeting $C$ (set theoretically) in $c$.
This is impossible as no multiple of $c$ is the restriction of a Cartier
divisor by assumption.

\medskip\noindent
To finish we have to find such a singular surface $X$. We can just take
$X$ to be the affine surface given by
$$
x^3 + y^3 + z^3 + x^4 + y^4 + z^4 = 0
$$
in $\mathbf{A}^3_\mathbf{C} = \Spec(\mathbf{C}[x, y, z])$ and singular point
$(0, 0, 0)$. Then $(0, 0, 0)$ is the only singular point. Blowing up $X$
in the maximal ideal corresponding to $(0, 0, 0)$ we find three charts each
isomorphic to the smooth affine surface
$$
1 + s^3 + t^3 + x(1 + s^4 + t^4) = 0
$$
which is nonsingular with exceptional divisor $C$ given by $x = 0$. The reader
will recognize $C$ as an elliptic curve. Finally, the surface $X$ is rational
as projection from $(0, 0, 0)$ shows, or because in the equation for the
blow up we can solve for $x$. Finally, the Picard group of a nonsingular
rational surface is countable, whereas the Picard group of an elliptic
curve over the complex numbers is uncountable. Hence we can find a closed
point $c$ as indicated.
\end{example}








\input{chapters}

\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}
