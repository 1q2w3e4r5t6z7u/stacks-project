\input{preamble}

% OK, start here.
%
\begin{document}

\title{Resolution of Surfaces}


\maketitle

\phantomsection
\label{section-phantom}

\tableofcontents

\section{Introduction}
\label{section-introduction}

\noindent
This chapter discusses resolution of singularities of surfaces
following Lipman \cite{Lipman} and following the exposition
in \cite{Artin-Lipman}.





\section{A trace map in positive characteristic}
\label{section-trace}

\noindent
In this section $p$ will be a prime number. Let $R$ be an
$\mathbf{F}_p$-algebra. Given an $a \in R$ set $S = R[x]/(x^p - a)$.
Define an $R$-linear map
$$
\text{Tr}_x : \Omega_{S/R} \longrightarrow \Omega_R
$$
by the rule
$$
x^i\text{d}x \longmapsto
\left\{
\begin{matrix}
0 & \text{if} & 0 \leq i \leq p - 2, \\
\text{d}a & \text{if} & i = p - 1
\end{matrix}
\right.
$$
This makes sense as $\Omega_{S/R}$ is a free $R$-module with
basis $x^i\text{d}x$, $0 \leq i \leq p - 1$.
The following lemma implies that the trace map is well defined,
i.e., independent of the choice of the coordinate $x$.

\begin{lemma}
\label{lemma-trace-well-defined}
Let $\varphi : R[x]/(x^p - a) \to R[y]/(y^p - b)$ be an $R$-algebra
homomorphism. Then $\text{Tr}_x = \text{Tr}_y \circ \varphi$.
\end{lemma}

\begin{proof}
Say $\varphi(x) = \lambda_0 + \lambda_1 y + \ldots + \lambda_{p - 1}y^{p - 1}$
with $\lambda_i \in R$. The condition that mapping $x$ to
$\lambda_0 + \lambda_1 y + \ldots + \lambda_{p - 1}y^{p - 1}$
induces an $R$-algebra homomorphism $R[x]/(x^p - a) \to R[y]/(y^p - b)$
is equivalent to the condition that
$$
a = \lambda_0^p + \lambda_1^p b + \ldots + \lambda_{p - 1}^pb^{p - 1}
$$
in the ring $R$. Consider the polynomial ring
$$
R_{univ} = \mathbf{F}_p[b, \lambda_0, \ldots, \lambda_{p - 1}]
$$
with the element
$a = \lambda_0^p + \lambda_1^p b + \ldots + \lambda_{p - 1}^pb^{p - 1}$
Consider the universal algebra map
$\varphi_{univ} : R_{univ}[x]/(x^p - a) \to R_{univ}[y]/(y^p - b)$
given by mapping $x$ to
$\lambda_0 + \lambda_1 y + \ldots + \lambda_{p - 1}y^{p - 1}$.
We obtain a canonical map
$$
R_{univ} \longrightarrow R
$$
sending $b, \lambda_i$ to $b, \lambda_i$. By construction we get a
commutative diagram
$$
\xymatrix{
R_{univ}[x]/(x^p - a) \ar[r] \ar[d]_{\varphi_{univ}} &
R[x]/(x^p - a) \ar[d]^\varphi \\
R_{univ}[y]/(y^p - b) \ar[r] & R[y]/(y^p - b)
}
$$
and the horizontal arrows are compatible with the trace maps. Hence it
suffices to prove the lemma for the map $\varphi_{univ}$. Thus we may
assume $R = \mathbf{F}_p[b, \lambda_0, \ldots, \lambda_{p - 1}]$
is a polynomial ring. We will check the lemma holds in this case
by evaluating
$\text{Tr}_y(\varphi(x)^i\text{d}\varphi(x))$ for $i = 0 , \ldots, p - 1$.

\medskip\noindent
The case $0 \leq i \leq p - 2$. Expand
$$
(\lambda_0 + \lambda_1 y + \ldots + \lambda_{p - 1}y^{p - 1})^i
(\lambda_1 + 2 \lambda_2 y + \ldots + (p - 1)\lambda_{p - 1}y^{p - 2})
$$
in the ring $R[y]/(y^p - b)$. We have to show that the coefficient
of $y^{p - 1}$ is zero. For this it suffices to show that
the expression above as a polynomial in $y$ has vanishing
coefficients in front of the powers $y^{pk - 1}$.
Then we write our polynomial as
$$
\frac{\text{d}}{(i + 1)\text{d}y}
(\lambda_0 + \lambda_1 y + \ldots + \lambda_{p - 1}y^{p - 1})^{i + 1}
$$
and indeed the coefficients of $y^{kp - 1}$ are all zero.

\medskip\noindent
The case $i = p - 1$. Expand
$$
(\lambda_0 + \lambda_1 y + \ldots + \lambda_{p - 1}y^{p - 1})^{p - 1}
(\lambda_1 + 2 \lambda_2 y + \ldots + (p - 1)\lambda_{p - 1}y^{p - 2})
$$
in the ring $R[y]/(y^p - b)$. To finish the proof we have to show that
the coefficient of $y^{p - 1}$ times $\text{d}b$ is $\text{d}a$.
Here we use that $R$ is $S/pS$ where
$S = \mathbf{Z}[b, \lambda_0, \ldots, \lambda_{p - 1}]$.
Then the above, as a polynomial in $y$, is equal to
$$
\frac{\text{d}}{p\text{d}y}
(\lambda_0 + \lambda_1 y + \ldots + \lambda_{p - 1}y^{p - 1})^p
$$
Since $\frac{\text{d}}{\text{d}y}(y^{pk}) = pk y^{pk - 1}$
it suffices to understand the coefficients of $y^{pk}$ in the polynomial
$(\lambda_0 + \lambda_1 y + \ldots + \lambda_{p - 1}y^{p - 1})^p$
modulo $p$. The sum of these terms gives
$$
\lambda_0^p + \lambda_1^py^p + \ldots + \lambda_{p - 1}^py^{p(p - 1)}
\bmod p
$$
Whence we see that we obtain after applying the operator
$\frac{\text{d}}{p\text{d}y}$ and after reducing modulo $y^p - b$
the value
$$
\lambda_1^p + 2\lambda_2^pb + \ldots + (p - 1)\lambda_{p - 1}b^{p - 2}
$$
for the coefficient of $y^{p - 1}$ we wanted to compute. Now because
$a = \lambda_0^p + \lambda_1^p b + \ldots + \lambda_{p - 1}^pb^{p - 1}$
in $R$ we obtain that
$$
\text{d}a = (\lambda_1^p  + 2 \lambda_2^p b + \ldots +
(p - 1) \lambda_{p - 1}^p b^{p - 2}) \text{d}b
$$
in $R$. This proves that the coefficient of $y^{p - 1}$ is as desired.
\end{proof}

\begin{lemma}
\label{lemma-trace-higher}
Let $\mathbf{F}_p \subset \Lambda \subset R \subset S$ be ring extensions
and assume that $S$ is isomorphic to $R[x]/(x^p - a)$ for some $a \in R$.
Then there are canonical $R$-linear maps
$$
\text{Tr} :
\Omega^{t + 1}_{S/\Lambda}
\longrightarrow
\Omega_{R/\Lambda}^{t + 1}
$$
for $t \geq 0$ such that
$$
\eta_1 \wedge \ldots \wedge \eta_t \wedge x^i\text{d}x
\longmapsto
\left\{
\begin{matrix}
0 & \text{if} & 0 \leq i \leq p - 2, \\
\eta_1 \wedge \ldots \wedge \eta_t \wedge \text{d}a & \text{if} & i = p - 1
\end{matrix}
\right.
$$
for $\eta_i \in \Omega_{R/\Lambda}$ and such that $\text{Tr}$ annihilates the
image of
$S \otimes_R \Omega_{R/\Lambda}^{t + 1} \to \Omega_{S/\Lambda}^{t + 1}$.
\end{lemma}

\begin{proof}
For $t = 0$ we use the composition
$$
\Omega_{S/\Lambda} \to \Omega_{S/R} \to \Omega_R \to \Omega_{R/\Lambda}
$$
where the second map is Lemma \ref{lemma-trace-well-defined}.
There is an exact sequence
$$
H_1(L_{S/R}) \xrightarrow{\delta} \Omega_{R/\Lambda} \otimes_R S \to
\Omega_{S/\Lambda} \to \Omega_{S/R} \to 0
$$
(Algebra, Lemma \ref{algebra-lemma-exact-sequence-NL}).
The module $\Omega_{S/R}$ is free over $S$ with basis $\text{d}x$
and the module $H^1(L_{S/R})$ is free over $S$ with basis $x^p - a$
which $\delta$ maps to $-\text{d}a \otimes 1$ in
$\Omega_{R/\Lambda} \otimes_R S$. In particular, if we set
$$
M = \Coker(R \to \Omega_{R/\Lambda}, 1 \mapsto -\text{d}a)
$$
then we see that $\Coker(\delta) = M \otimes_R S$. We obtain a
canonical map
$$
\Omega^{t + 1}_{S/\Lambda} \to
\wedge_S^t(\Coker(\delta)) \otimes_S \Omega_{S/R} =
\wedge^t_R(M) \otimes_R \Omega_{S/R}
$$
Now, since the image of the map
$\text{Tr} : \Omega_{S/R} \to \Omega_{R/\lambda}$
of Lemma \ref{lemma-trace-well-defined} is contained in $R\text{d}a$ we
see that wedging with an element in the image annihilates $\text{d}a$.
Hence there is a canonical map
$$
\wedge^t_R(M) \otimes_R \Omega_{S/R} \to \Omega_{R/\Lambda}^{t + 1}
$$
mapping
$\overline{\eta}_1 \wedge \ldots \wedge \overline{\eta}_t \wedge \omega$
to $\eta_1 \wedge \ldots \wedge \eta_t \wedge \text{Tr}(\omega)$.
\end{proof}

\begin{lemma}
\label{lemma-trace-extends}
Let $S$ be a scheme over $\mathbf{F}_p$. Let $f : Y \to X$ be a finite morphism
of Noetherian normal integral schemes over $S$. Assume
\begin{enumerate}
\item the extension of function fields is purely inseparable of degree $p$, and
\item $\Omega_{X/S}$ is a coherent $\mathcal{O}_X$-module (for example
if $X$ is of finite type over $S$).
\end{enumerate}
For $i \geq 1$ there is a canonical map
$$
\text{Tr} : f_*\Omega^i_{Y/S} \longrightarrow (\Omega_{X/S}^i)^{**}
$$
whose stalk in the generic point of $X$ recovers the trace map of
Lemma \ref{lemma-trace-higher}.
\end{lemma}

\begin{proof}
The exact sequence $f^*\Omega_{X/S} \to \Omega_{Y/S} \to \Omega_{Y/X} \to 0$
shows that $\Omega_{Y/S}$ and hence $f_*\Omega_{Y/S}$ are coherent modules
as well. Thus it suffices to prove the trace map in the generic point
extends to stalks at $x \in X$ with $\dim(\mathcal{O}_{X, x}) = 1$, see
Divisors, Lemma \ref{divisors-lemma-describe-reflexive-hull}.
Thus we reduce to the case discussed in the next paragraph.

\medskip\noindent
Assume $X = \Spec(A)$ and $Y = \Spec(B)$ with $A$ a discrete valuation
ring and $B$ finite over $A$. Since the induced extension $K \subset L$
of fraction fields is purely inseparable, we see that $B$ is local too.
Hence $B$ is a discrete valuation ring too. Then either
\begin{enumerate}
\item $B/A$ has ramification index $p$ and hence $B = A[x]/(x^p - a)$
where $a \in A$ is a uniformizer, or
\item $\mathfrak m_B = \mathfrak m_A B$ and the residue field
$B/\mathfrak m_A B$ is purely inseparable of degree $p$ over
$\kappa_A = A/\mathfrak m_A$.
Choose any $x \in B$ whose residue class is not in $\kappa_A$
and then we'll have $B = A[x]/(x^p - a)$ where $a \in A$ is
a unit.
\end{enumerate}
Let $\Spec(\Lambda) \subset S$ be an affine open such that
$X$ maps into $\Spec(\Lambda)$. Then we can apply
Lemma \ref{lemma-trace-higher}
to see that the trace map extends to
$\Omega^i_{B/\Lambda} \to \Omega^i_{A/\Lambda}$
for all $i \geq 1$.
\end{proof}














\section{Modifications}
\label{section-modifications}

\noindent
Let $(A, \mathfrak m, \kappa)$ be a Noetherian local ring. We set
$S = \Spec(A)$ and $U = S \setminus \{\mathfrak m\}$. In this section
we will consider the category
\begin{equation}
\label{equation-modification}
\left\{
f : X \longrightarrow S
\quad \middle| \quad
\begin{matrix}
X\text{ is an algebraic space}\\
f\text{ is a proper morphism}\\
f^{-1}(U) \to U\text{ is an isomorphism}
\end{matrix}
\right\}
\end{equation}
A morphism from $X/S$ to $X'/S$ will be a morphism of algebraic spaces
$X \to X'$ compatible with the structure morphisms over $S$. In
Restricted Power Series, Section \ref{restricted-section-modifications}
we have seen that this category only depends on the completion of $A$
and we have proven some elementary properties of objects in this category.
In this section we specifically study cases where
$\dim(A) \leq 2$ or where the dimension of the closed fibre is at most $1$.

\begin{lemma}
\label{lemma-modification}
Let $(A, \mathfrak m, \kappa)$ be a $2$-dimensional Noetherian
local domain such that $U = \Spec(A) \setminus \{\mathfrak m\}$
is a normal scheme. Then any modification $f : X \to S$
(as in Spaces over Fields, Definition
\ref{spaces-over-fields-definition-modification})
is a morphism as in (\ref{equation-modification}).
\end{lemma}

\begin{proof}
Let $f : X \to S$ be a modification. We have to show that
$f^{-1}(U) \to U$ is an isomorphism. By
Spaces over Fields, Lemma
\ref{spaces-over-fields-lemma-modification-iso-over-open}
there exists a nonempty open $V \subset S$ such that $f^{-1}(V) \to V$
is an isomorphism. Since $X$ is integral we see that $f^{-1}(V)$ is
dense in $X$. Note that every closed point $u$ of $U$ has codimension
$1$, i.e., that $\dim(\mathcal{O}_{U, u}) = 1$. Thus we may apply
Spaces over Fields, Lemma \ref{spaces-over-fields-lemma-finite-in-codim-1}
to see that $f^{-1}(U) \to U$ is finite. In particular $f^{-1}(U)$ is a scheme.
Then $f^{-1}(U) \to U$ is an isomorphism, see
Morphisms, Lemma \ref{morphisms-lemma-finite-birational-over-normal}.
\end{proof}

\begin{lemma}
\label{lemma-closed-immersion-on-fibre}
Let $(A, \mathfrak m, \kappa)$ be a Noetherian local ring.
Let $g : X \to Y$ be a morphism in the category (\ref{equation-modification}).
If the induced morphism $X_\kappa \to Y_\kappa$ of special fibres is
a closed immersion, then $g$ is a closed immersion.
\end{lemma}

\begin{proof}
This is a special case of
More on Morphisms of Spaces, Lemma
\ref{spaces-more-morphisms-lemma-where-closed-immersion}.
\end{proof}

\begin{lemma}
\label{lemma-projective-over-complete}
Let $(A, \mathfrak m, \kappa)$ be a complete Noetherian local ring.
Let $X$ be an algebraic space over $\Spec(A)$.
If $X \to \Spec(A)$ is proper and $\dim(X_\kappa) \leq 1$, then
$X$ is a scheme projective over $A$.
\end{lemma}

\begin{proof}
By Spaces over Fields, Lemma
\ref{spaces-over-fields-lemma-codim-1-point-in-schematic-locus}
the algebraic space $X_\kappa$ is a scheme. Hence $X_\kappa$
is a proper scheme of dimension $\leq 1$ over $\kappa$.
By Varieties, Lemma \ref{varieties-lemma-dim-1-proper-projective}
we see that $X_\kappa$ is H-projective over $\kappa$.
Let $\mathcal{L}$ be an ample invertible sheaf on $X_\kappa$.

\medskip\noindent
We are going to show that $\mathcal{L}$ lifts to a compatible system
$\{\mathcal{L}_n\}$ of
invertible sheaves on the $n$th infinitesimal neighbourhoods
$$
X_n = X \times_{\Spec(A)} \Spec(A/\mathfrak m^n)
$$
of $X_\kappa = X_1$. Recall that the \'etale sites of $X_\kappa$
and all $X_n$ are canonically equivalent, see
More on Morphisms of Spaces, Lemma
\ref{spaces-more-morphisms-lemma-thickening-equivalence}.
In the rest of the proof we do not distinguish between sheaves on $X_n$
and sheaves on $X_m$ or $X_\kappa$.
Suppose, given a lift $\mathcal{L}_n$ to $X_n$. We consider
the exact sequence
$$
1 \to
(1 + \mathfrak m^n\mathcal{O}_X/\mathfrak m^{n + 1}\mathcal{O}_X)^* \to
\mathcal{O}_{X_{n + 1}}^* \to \mathcal{O}_{X_n}^* \to 1
$$
of sheaves on $X_{n + 1}$. We have
$(1 + \mathfrak m^n\mathcal{O}_X/\mathfrak m^{n + 1}\mathcal{O}_X)^*
\cong \mathfrak m^n\mathcal{O}_X/\mathfrak m^{n + 1}\mathcal{O}_X$
as abelian sheaves on $X_{n + 1}$. The class of $\mathcal{L}_n$ in
$H^1(X_n, \mathcal{O}_{X_n}^*)$ (see
Cohomology on Sites, Lemma \ref{sites-cohomology-lemma-h1-invertible})
can be lifted to an element of $H^1(X_{n + 1}, \mathcal{O}_{X_{n + 1}}^*)$
if and only if the obstruction in
$H^2(X_{n + 1}, \mathfrak m^n\mathcal{O}_X/\mathfrak m^{n + 1}\mathcal{O}_X)$
is zero. Note that
$\mathfrak m^n\mathcal{O}_X/\mathfrak m^{n + 1}\mathcal{O}_X$
is a quasi-coherent $\mathcal{O}_{X_\kappa}$-module on $X_\kappa$.
Hence its \'etale cohomology agrees with its cohomology on the
scheme $X_\kappa$, see
Descent, Proposition \ref{descent-proposition-same-cohomology-quasi-coherent}.
However, as $X_\kappa$ is a Noetherian scheme of dimension $\leq 1$
this cohomology group vanishes (Cohomology, Proposition
\ref{cohomology-proposition-vanishing-Noetherian}).

\medskip\noindent
By Grothendieck's algebraization theorem
(Cohomology of Schemes, Theorem \ref{coherent-theorem-algebraization})
we find a projective morphism of schemes $Y \to \Spec(A)$ and a compatible
system of isomorphisms $X_n \to Y_n$. (Here we use the assumption
that $A$ is complete.) By
More on Morphisms of Spaces, Lemma
\ref{spaces-more-morphisms-lemma-algebraize-morphism}
we see that $X \cong Y$ and the proof is complete.
\end{proof}

\begin{lemma}
\label{lemma-dimension-special-fibre}
Let $(A, \mathfrak m, \kappa)$ be a Noetherian local domain
of dimension $\geq 1$.
Let $f : X \to \Spec(A)$ be a morphism of algebraic spaces.
Assume one of the following conditions is satisfied
\begin{enumerate}
\item $f$ is a modification (Spaces over Fields, Definition
\ref{spaces-over-fields-definition-modification}),
\item $f$ is an alteration (Spaces over Fields, Definition
\ref{spaces-over-fields-definition-alteration}),
\item $f$ is locally of finite type, quasi-separated, $X$ is integral,
and there is exactly one point of $|X|$ mapping to the generic point
of $\Spec(A)$,
\item $f$ is locally of finite type, $X$ is decent, and the points
of $|X|$ mapping to the generic point of $\Spec(A)$ are
the generic points of irreducible components of $|X|$,
\item add more here.
\end{enumerate}
Then $\dim(X_\kappa) \leq \dim(A) - 1$.
\end{lemma}

\begin{proof}
Cases (1), (2), and (3) are special cases of (4). Choose an affine scheme
$U = \Spec(B)$ and an \'etale morphism $U \to X$. The ring map $A \to B$
is of finite type. We have to show that
$\dim(U_\kappa) \leq \dim(A) - 1$. Since $X$ is decent, the generic
points of irreducible components of $U$ are the points lying over
generic points of irreducible components of $|X|$, see
Decent Spaces, Lemma \ref{decent-spaces-lemma-decent-generic-points}.
Hence the fibre of $\Spec(B) \to \Spec(A)$ over $(0)$
is the (finite) set of minimal primes $\mathfrak q_1, \ldots, \mathfrak q_r$
of $B$. Thus $A_f \to B_f$ is finite for some nonzero $f \in A$
(Algebra, Lemma \ref{algebra-lemma-generically-finite}).
We conclude the field extensions $f.f.(A) \subset \kappa(\mathfrak q_i)$
are finite. Let $\mathfrak q \subset B$ be a prime lying over $\mathfrak m$.
Then
$$
\dim(B_\mathfrak q) = \max \dim((B/\mathfrak q_i)_{\mathfrak q})
\leq \dim(A)
$$
the inequality by the dimension formula for $A \subset B/\mathfrak q_i$, see
Algebra, Lemma \ref{algebra-lemma-dimension-formula}.
However, the dimension of $B_\mathfrak q/\mathfrak m B_\mathfrak q$
(which is the local ring of $U_\kappa$ at the corresponding point)
is at least one less because the minimal primes $\mathfrak q_i$
are not in $V(\mathfrak m)$. We conclude by
Properties, Lemma \ref{properties-lemma-dimension}.
\end{proof}

\begin{lemma}
\label{lemma-modification-of-dim-2-is-projective-over-complete}
If $(A, \mathfrak m, \kappa)$ is a complete Noetherian local domain
of dimension $2$, then every modification of $\Spec(A)$ is projective over $A$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-projective-over-complete} it suffices to show that
the special fibre of any modification $X$ of $\Spec(A)$ has dimension
$\leq 1$. This follows from Lemma \ref{lemma-dimension-special-fibre}.
\end{proof}





\section{Quadratic transformations}
\label{section-quadratic}

\noindent
In this section we study what happens when we blow up a nonsingular point
on a surface. We hesitate the formally define such a morphism as a
{\it quadratic transformation} as on the one hand often other names are
used and on the other hand the phrase ``quadratic transformation'' is
sometimes used with a different meaning.

\begin{lemma}
\label{lemma-blowup}
Let $(A, \mathfrak m, \kappa)$ be a regular local ring of dimension $2$.
Let $f : X \to S = \Spec(A)$ be the blowing up of $A$ in $\mathfrak m$.
There is a closed immersion
$$
r : X \longrightarrow \mathbf{P}^1_S
$$
over $S$ such that $\mathcal{O}_X(1) = r^*\mathcal{O}_{\mathbf{P}^1_S}(1)$
and such that $r|_E : E \to \mathbf{P}^1_\kappa$ is an isomorphism.
\end{lemma}

\begin{proof}
As $A$ is regular of dimension $2$ we can write $\mathfrak m = (x, y)$.
Then $x$ and $y$ placed in degree $1$ generate the Rees algebra
$\bigoplus_{n \geq 0} \mathfrak m^n$ over $A$. Recall that
$X = \text{Proj}(\bigoplus_{n \geq 0} \mathfrak m^n)$, see
Divisors, Lemma \ref{divisors-lemma-blowing-up-affine}.
Thus the surjection
$$
A[T_0, T_1] \longrightarrow \bigoplus\nolimits_{n \geq 0} \mathfrak m^n,
\quad
T_0 \mapsto x,\ T_1 \mapsto y
$$
of graded $A$-algebras induces a closed immersion
$r : X \to \mathbf{P}^1_S = \text{Proj}(A[T_0, T_1])$
such that $\mathcal{O}_X(1) = r^*\mathcal{O}_{\mathbf{P}^1_S}(1)$, see
Constructions, Lemma
\ref{constructions-lemma-surjective-graded-rings-generated-degree-1-map-proj}.
To prove the final statement note that
$$
\left(\bigoplus\nolimits_{n \geq 0} \mathfrak m^n\right) \otimes_A \kappa =
\bigoplus\nolimits_{n \geq 0} \mathfrak m^n/\mathfrak m^{n + 1} \cong
\kappa[\overline{x}, \overline{y}]
$$
a polynomial algebra, see Algebra, Lemma \ref{algebra-lemma-regular-graded}.
This proves that the fibre of $X \to S$ over $\Spec(\kappa)$ is equal to
$\text{Proj}(\kappa[\overline{x}, \overline{y}]) = \mathbf{P}^1_\kappa$, see
Constructions, Lemma \ref{constructions-lemma-base-change-map-proj}.
Recall that $E$ is the closed subscheme of $X$ defined by
$\mathfrak m\mathcal{O}_X$, i.e., $E = X_\kappa$.
By our choice of the morphism $r$ we see that $r|_E$ in fact
produces the identification of $E = X_\kappa$ with the special
fibre of $\mathbf{P}^1_S \to S$.
\end{proof}

\begin{lemma}
\label{lemma-blowup-regular}
Let $(A, \mathfrak m, \kappa)$ be a regular local ring of dimension $2$.
Let $f : X \to S = \Spec(A)$ be the blowing up of $A$ in $\mathfrak m$.
Then $X$ is an irreducible regular scheme.
\end{lemma}

\begin{proof}
Observe that $X$ is integral by
Divisors, Lemma \ref{divisors-lemma-blow-up-integral-scheme}
and
Algebra, Lemma \ref{algebra-lemma-regular-domain}.
To see $X$ is regular it suffices to check that $\mathcal{O}_{X, x}$
is regular for closed points $x \in X$, see
Properties, Lemma \ref{properties-lemma-characterize-regular}.
Let $x \in X$ be a closed point. Since $f$ is proper $x$ maps to
$\mathfrak m$, i.e., $x$ is a point of the exceptional divisor $E$.
Then $E$ is an effective Cartier divisor and $E \cong \mathbf{P}^1_\kappa$.
Thus if $f \in \mathfrak m_x \subset \mathcal{O}_{X, x}$ is a local
equation for $E$, then
$\mathcal{O}_{X, x}/(f) \cong \mathcal{O}_{\mathbf{P}^1_\kappa, x}$.
Since $\mathbf{P}^1_\kappa$ is covered by two affine opens which are the
spectrum of a polynomial ring over $\kappa$, we see that
$\mathcal{O}_{\mathbf{P}^1_\kappa, x}$ is regular by
Algebra, Lemma \ref{algebra-lemma-dim-affine-space}.
We conclude by
Algebra, Lemma \ref{algebra-lemma-regular-mod-x}.
\end{proof}

\begin{lemma}
\label{lemma-cohomology-of-blowup}
Let $(A, \mathfrak m, \kappa)$ be a regular local ring of dimension $2$.
Let $f : X \to S = \Spec(A)$ be the blowing up of $A$ in $\mathfrak m$.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
\begin{enumerate}
\item $H^p(X, \mathcal{F}) = 0$ for $p \not \in \{0, 1\}$,
\item $H^1(X, \mathcal{O}_X(n)) = 0$ for $n \geq -1$,
\item $H^1(X, \mathcal{F}) = 0$ if $\mathcal{F}$ or $\mathcal{F}(1)$
is globally generated,
\item $H^0(X, \mathcal{O}_X(n)) = \mathfrak m^{\max(0, n)}$,
\item $\text{length}_A H^1(X, \mathcal{O}_X(n)) = -n(-n - 1)/2$
if $n < 0$.
\end{enumerate}
\end{lemma}

\begin{proof}
If $\mathfrak m = (x, y)$, then $X$ is covered by the spectra
of the affine blowup algebras $A[\frac{\mathfrak m}{x}]$ and
$A[\frac{\mathfrak m}{y}]$ because $x$ and $y$ placed in degree $1$
generate the Rees algebra $\bigoplus \mathfrak m^n$ over $A$.
See Divisors, Lemma \ref{divisors-lemma-blowing-up-affine} and
Constructions, Lemma \ref{constructions-lemma-proj-quasi-compact}.
Since $X$ is separated by
Constructions, Lemma \ref{constructions-lemma-proj-separated}
we see that cohomology of quasi-coherent sheaves vanishes in
degrees $\geq 2$ by Cohomology of Schemes, Lemma
\ref{coherent-lemma-vanishing-nr-affines}.

\medskip\noindent
Let $i : E \to X$ be the exceptional divisor, see
Divisors, Definition \ref{divisors-definition-blow-up}.
Recall that $\mathcal{O}_X(-E) = \mathcal{O}_X(1)$ is
$f$-relatively ample, see
Divisors, Lemma \ref{divisors-lemma-blowing-up-gives-effective-Cartier-divisor}.
Hence we know that $H^1(X, \mathcal{O}_X(-nE)) = 0$ for some $n > 0$,
see Cohomology of Schemes, Lemma \ref{coherent-lemma-kill-by-twisting}.
Consider the filtration
$$
\mathcal{O}_X(-nE) \subset \mathcal{O}_X(-(n - 1)E) \subset
\ldots \subset \mathcal{O}_X(-E) \subset \mathcal{O}_X \subset \mathcal{O}_X(E)
$$
The successive quotients are the sheaves
$$
\mathcal{O}_X(-t E)/\mathcal{O}_X(-(t + 1)E) =
\mathcal{O}_X(t)/\mathcal{I}(t) =
i_*\mathcal{O}_E(t)
$$
where $\mathcal{I} = \mathcal{O}_X(-E)$ is the ideal sheaf of $E$.
By Lemma \ref{lemma-blowup} we have $E = \mathbf{P}^1_\kappa$ and
$\mathcal{O}_E(1)$ indeed corresponds to the usual Serre twist of
the structure sheaf on $\mathbf{P}^1$. Hence the cohomology
of $\mathcal{O}_E(t)$ vanishes in degree $1$ for $t \geq -1$, see
Cohomology of Schemes, Lemma
\ref{coherent-lemma-cohomology-projective-space-over-ring}.
Since this is equal to $H^1(X, i_*\mathcal{O}_E(t))$ (by
Cohomology of Schemes, Lemma \ref{coherent-lemma-relative-affine-cohomology})
we find that $H^1(X, \mathcal{O}_X(-(t + 1)E)) \to H^1(X, \mathcal{O}_X(-tE))$
is surjective for $t \geq -1$. Hence
$$
0 = H^1(X, \mathcal{O}_X(-nE))
\longrightarrow
H^1(X, \mathcal{O}_X(-tE)) = H^1(X, \mathcal{O}_X(t))
$$
is surjective for $t \geq -1$ which proves (2).

\medskip\noindent
Let $\mathcal{F}$ be globally generated. This means there exists
a short exact sequence
$$
0 \to \mathcal{G} \to \bigoplus\nolimits_{i \in I} \mathcal{O}_X
\to \mathcal{F} \to 0
$$
Note that $H^1(X, \bigoplus_{i \in I} \mathcal{O}_X) =
\bigoplus_{i \in I} H^1(X, \mathcal{O}_X)$ by
Cohomology, Lemma \ref{cohomology-lemma-quasi-separated-cohomology-colimit}.
By part (2) we have $H^1(X, \mathcal{O}_X) = 0$.
If $\mathcal{F}(1)$ is globally generated, then we can find a
surjection $\bigoplus_{i \in I} \mathcal{O}_X(-1) \to \mathcal{F}$
and argue in a similar fashion.
In other words, part (3) follows from part (2).

\medskip\noindent
For part (4) we note that for all $n$ large enough we have
$\Gamma(X, \mathcal{O}_X(n)) = \mathfrak m^n$, see
Cohomology of Schemes, Lemma \ref{coherent-lemma-recover-tail-graded-module}.
If $n \geq 0$, then we can use the short exact sequence
$$
0 \to \mathcal{O}_X(n) \to \mathcal{O}_X(n - 1) \to
i_*\mathcal{O}_E(n - 1) \to 0
$$
and the vanishing of $H^1$ for the sheaf on the left to get a commutative
diagram
$$
\xymatrix{
0 \ar[r] &
\mathfrak m^{\max(0, n)} \ar[r] \ar[d] &
\mathfrak m^{\max(0, n - 1)} \ar[r] \ar[d] &
\mathfrak m^{\max(0, n)}/\mathfrak m^{\max(0, n - 1)} \ar[r] \ar[d] & 0\\
0 \ar[r] &
\Gamma(X, \mathcal{O}_X(n)) \ar[r] &
\Gamma(X, \mathcal{O}_X(n - 1)) \ar[r] &
\Gamma(E, \mathcal{O}_E(n - 1)) \ar[r] & 0
}
$$
with exact rows. In fact, the rows are exact also for $n < 0$
because in this case the groups on the right are zero.
In the proof of Lemma \ref{lemma-blowup}
we have seen that the right vertical arrow is an isomorphism
(details omitted). Hence if the left vertical arrow is an isomorphism, so
is the middle one. In this way we see that (4) holds by
descending induction on $n$.

\medskip\noindent
Finally, we prove (5) by descending induction on $n$ and the sequences
$$
0 \to \mathcal{O}_X(n) \to \mathcal{O}_X(n - 1) \to
i_*\mathcal{O}_E(n - 1) \to 0
$$
Namely, for $n \geq -1$ we already know $H^1(X, \mathcal{O}_X(n)) = 0$.
Since
$$
H^1(X, i_*\mathcal{O}_E(-2)) =
H^1(E, \mathcal{O}_E(-2)) =
H^1(\mathbf{P}^1_\kappa, \mathcal{O}(-2)) \cong \kappa
$$
by Cohomology of Schemes, Lemma
\ref{coherent-lemma-cohomology-projective-space-over-ring}
which has length $1$ as an $A$-module, we conclude from the long exact
cohomology sequence that (5) holds for $n = -2$. And so on and so forth.
\end{proof}

\begin{lemma}
\label{lemma-blowup-improve}
Let $(A, \mathfrak m)$ be a regular local ring of dimension $2$.
Let $f : X \to S = \Spec(A)$ be the blowing up of $A$ in $\mathfrak m$.
Let $\mathfrak m^n \subset I \subset \mathfrak m$ be an ideal.
Let $d \geq 0$ be the largest integer such that
$$
I \mathcal{O}_X \subset \mathcal{O}_X(-dE)
$$
where $E$ is the exceptional divisor. Set
$\mathcal{I}' = I\mathcal{O}_X(dE) \subset \mathcal{O}_X$.
Then $d > 0$, the sheaf
$\mathcal{O}_X/\mathcal{I}'$ is supported in finitely many
closed points $x_1, \ldots, x_r$ of $X$, and
\begin{align*}
\text{length}_A(A/I)
& >
\text{length}_A \Gamma(X, \mathcal{O}_X/\mathcal{I}') \\
& \geq
\sum\nolimits_{i = 1, \ldots, r}
\text{length}_{\mathcal{O}_{X, x_i}}
(\mathcal{O}_{X, x_i}/\mathcal{I}'_{x_i})
\end{align*}
\end{lemma}

\begin{proof}
Since $I \subset \mathfrak m$ we see that every element of $I$
vanishes on $E$. Thus we see that $d \geq 1$. On the other hand, since
$\mathfrak m^n \subset I$ we see that $d \leq n$. Consider the
short exact sequence
$$
0 \to I\mathcal{O}_X \to \mathcal{O}_X \to \mathcal{O}_X/I\mathcal{O}_X \to 0
$$
Since $I\mathcal{O}_X$ is globally generated, we see that
$H^1(X, I\mathcal{O}_X) = 0$ by Lemma \ref{lemma-cohomology-of-blowup}.
Hence we obtain a surjection
$A/I \to \Gamma(X, \mathcal{O}_X/I\mathcal{O}_X)$. Consider the short exact
sequence
$$
0 \to
\mathcal{O}_X(-dE)/I\mathcal{O}_X \to
\mathcal{O}_X/I\mathcal{O}_X \to
\mathcal{O}_X/\mathcal{O}_X(-dE) \to 0
$$
By Divisors, Lemma \ref{divisors-lemma-codim-1-part}
we see that $\mathcal{O}_X(-dE)/I\mathcal{O}_X$ is supported in finitely many
closed points of $X$. In particular, this coherent sheaf has vanishing higher
cohomology groups (detail omitted). Thus in the following diagram
$$
\xymatrix{
& & A/I \ar[d] \\
0 \ar[r] &
\Gamma(X, \mathcal{O}_X(-dE)/I\mathcal{O}_X) \ar[r] &
\Gamma(X, \mathcal{O}_X/I\mathcal{O}_X) \ar[r] &
\Gamma(X, \mathcal{O}_X/\mathcal{O}_X(-dE)) \ar[r] & 0
}
$$
the bottom row is exact and the vertical arrow surjective. We have
$$
\text{length}_A \Gamma(X, \mathcal{O}_X(-dE)/I\mathcal{O}_X) <
\text{length}_A(A/I)
$$
since $\Gamma(X, \mathcal{O}_X/\mathcal{O}_X(-dE))$ is nonzero.
Namely, the image of $1 \in \Gamma(X, \mathcal{O}_X)$
is nonzero as $d > 0$.

\medskip\noindent
To finish the proof we translate the results above into the statements
of the lemma. Since
$\mathcal{O}_X(dE)$ is invertible we have
$$
\mathcal{O}_X/\mathcal{I}' =
\mathcal{O}_X(-dE)/I\mathcal{O}_X \otimes_{\mathcal{O}_X} \mathcal{O}_X(dE).
$$
Thus $\mathcal{O}_X/\mathcal{I}'$ and $\mathcal{O}_X(-dE)/I\mathcal{O}_X$
are supported in the same set of finitely many
closed points, say $x_1, \ldots, x_r \in E \subset X$.
Moreover we obtain
$$
\Gamma(X, \mathcal{O}_X(-dE)/I\mathcal{O}_X) =
\bigoplus \mathcal{O}_X(-dE)_{x_i}/I\mathcal{O}_{X, x_i}
\cong
\bigoplus \mathcal{O}_{X, x_i}/\mathcal{I}'_{x_i} =
\Gamma(X, \mathcal{O}_X/\mathcal{I}')
$$
because an invertible module over a local ring is trivial.
Thus we obtain the strict inequality. We also get the second because
$$
\text{length}_A(\mathcal{O}_{X, x_i}/\mathcal{I}'_{x_i}) \geq
\text{length}_{\mathcal{O}_{X, x_i}}(\mathcal{O}_{X, x_i}/\mathcal{I}'_{x_i})
$$
as is immediate from the definition of length.
\end{proof}

\begin{lemma}
\label{lemma-differentials-of-blowup}
Let $(A, \mathfrak m, \kappa)$ be a regular local ring of dimension $2$.
Let $f : X \to S = \Spec(A)$ be the blowing up of $A$ in $\mathfrak m$.
Then $\Omega_{X/S} = i_*\Omega_{E/\kappa}$, where $i : E \to X$
is the immersion of the exceptional divisor.
\end{lemma}

\begin{proof}
Writing $\mathbf{P}^1 = \mathbf{P}^1_S$, let
$r : X \to \mathbf{P}^1$ be as in Lemma \ref{lemma-blowup}.
Then we have an exact sequence
$$
\mathcal{C}_{X/\mathbf{P}^1} \to r^*\Omega_{\mathbf{P}^1/S} \to
\Omega_{X/S} \to 0
$$
see Morphisms, Lemma \ref{morphisms-lemma-differentials-relative-immersion}.
Since $\Omega_{\mathbf{P}^1/S}|_E = \Omega_{E/\kappa}$ by
Morphisms, Lemma \ref{morphisms-lemma-base-change-differentials}
it suffices to see that the first arrow defines a surjection
onto the kernel of the canonical map
$r^*\Omega_{\mathbf{P}^1/S} \to i_*\Omega_{E/\kappa}$.
This we can do locally. With notation as in the proof of
Lemma \ref{lemma-blowup} on an affine open of $X$ the morphism $f$
corresponds to the ring map
$$
A \to A[t]/(xt - y)
$$
where $x, y \in \mathfrak m$ are generators. Thus
$\text{d}(xt - y) = x\text{d}t$ and $y\text{d}t = t \cdot x \text{d}t$
which proves what we want.
\end{proof}



\section{Quadratic transformations of spaces}
\label{section-quadratic-spaces}

\noindent
Using the result above we can prove that blowups in points dominate
any modification of a regular $2$ dimensional algebraic space.

\medskip\noindent
Let $X$ be a decent algebraic space over some base scheme $S$.
Let $x \in |X|$ be a closed point. By
Decent Spaces, Lemma \ref{decent-spaces-lemma-decent-space-closed-point}
we can represent $x$ by a closed immersion $i : \Spec(k) \to X$.
Then the {\it blowing up of $X$ at $x$} means the blowing up of $X$
in the closed subspace $Z = i(\Spec(k)) \subset X$.

\begin{lemma}
\label{lemma-make-ideal-principal}
Let $S$ be a scheme. Let $X$ be a Noetherian algebraic space over $S$.
Let $T \subset |X|$ be a finite set of closed points $x$ such that
(1) $X$ is regular at $x$ and (2) the local ring of $X$ at $x$ has
dimension $2$. Let $\mathcal{I} \subset \mathcal{O}_X$ be a quasi-coherent
sheaf of ideals such that $\mathcal{O}_X/\mathcal{I}$ is supported on $T$.
Then there exists a sequence
$$
X_n \to X_{n - 1} \to \ldots \to X_1 \to X_0 = X
$$
where $X_{i + 1} \to X_i$ is the blowing up of $X_i$ at a closed
point $x_i$ lying above a point of $T$ such that
$\mathcal{I}\mathcal{O}_{X_n}$ is an invertible ideal sheaf.
\end{lemma}

\begin{proof}
Say $T = \{x_1, \ldots, x_r\}$. Pick an \'etale morphism
$U \to X$ where $U$ is a scheme with points $u_i \in U$ lying over
$x_i$. By Decent Spaces, Lemma
\ref{decent-spaces-lemma-decent-no-specializations-map-to-same-point}
the points $u_i$ are closed points. After shrinking $U$ we may
assume these are the only points of $U$ mapping to $T$.
The local rings
$\mathcal{O}_{U, u_i}$ are regular local of dimension $2$, see
Properties of Spaces, Definitions
\ref{spaces-properties-definition-regular-at-point} and
\ref{spaces-properties-definition-dimension-local-ring}.
Let $I_i \subset \mathcal{O}_{U, u_i}$ be the stalk of
$\mathcal{I}|_U$ at $u_i$. Set
$$
n_i = \text{length}_{\mathcal{O}_{U, u_i}}(\mathcal{O}_{U, u_i}/I_i)
$$
This is finite as $\mathcal{O}_X/\mathcal{I}$ is supported on $T$
and hence $\mathcal{O}_{U, u_i}/I_i$ has support equal to
$\{\mathfrak m_{u_i}\}$ (see Algebra, Lemma \ref{algebra-lemma-support-point}).
We are going to use induction on $\sum n_i$. If $n_i = 0$ for all
$i$, then $\mathcal{I} = \mathcal{O}_X$ and we are done.

\medskip\noindent
Suppose $n_i > 0$. Let $X' \to X$ be the blowing up of $X$ in $x_i$
(see discussion above the lemma). Since $U \to X$ is \'etale and $u_i$
is the unique point of $U$ lying over $x$ we see that $U' = U \times_X X'$
is the blowup of $U$ in $u_i$, see
Divisors on Spaces, Lemma
\ref{spaces-divisors-lemma-flat-base-change-blowing-up}.
Since $\Spec(\mathcal{O}_{U, u_i}) \to U$ is flat we see that
$U' \times_U \Spec(\mathcal{O}_{U, u_i})$ is the blowup of
the ring $\mathcal{O}_{U, u_i}$ in the maximal ideal. Hence
both squares in the commutative diagram
$$
\xymatrix{
\text{Proj}(\bigoplus\nolimits_{d \geq 0} \mathfrak m_{u_i}^d) \ar[r] \ar[d] &
U' \ar[d] \ar[r] & X' \ar[d] \\
\Spec(\mathcal{O}_{U, u_i}) \ar[r] & U \ar[r] & X
}
$$
are cartesian. Let $E \subset X'$, $E' \subset U'$,
$E'' \subset \text{Proj}(\bigoplus\nolimits_{d \geq 0} \mathfrak m_{u_i}^d)$
be the exceptional divisors. Let $d \geq 1$ be the integer found in
Lemma \ref{lemma-blowup-improve} for the ideal
$\mathcal{I}_i \subset \mathcal{O}_{U, u_i}$.
Since the horizontal arrows in the diagram are flat, since
$E'' \to E$ is surjective, and since $E''$ is the pullback of $E$, we see that
$$
\mathcal{I}\mathcal{O}_{X'} \subset \mathcal{O}_{X'}(-dE)
$$
(some details omitted).
Set $\mathcal{I}' = \mathcal{I}\mathcal{O}_{X'}(dE) \subset \mathcal{O}_{X'}$.
Then we see that $\mathcal{O}_{X'}/\mathcal{I}'$ is supported in finitely
many closed points $T' \subset |X'|$ because this holds over
$X \setminus \{x_i\}$ and for the pullback to
$\text{Proj}(\bigoplus\nolimits_{d \geq 0} \mathfrak m_{u_i}^d)$.
The final assertion of Lemma \ref{lemma-blowup-improve}
tells us that the sum of the lengths of the stalks
$\mathcal{O}_{U', u'}/\mathcal{I}'\mathcal{O}_{U', u'}$
for $u'$ lying over $u_i$ is $< n_i$. Hence the sum of the lengths
has decreased.

\medskip\noindent
By induction hypothesis, there exists a sequence
$$
X'_n \to \ldots \to X'_1 \to X'
$$
of blowups at closed points lying over $T'$ such that
$\mathcal{I}'\mathcal{O}_{X'_n}$ is invertible. Since
$\mathcal{I}'\mathcal{O}_{X'}(-dE) = \mathcal{I}\mathcal{O}_{X'}$, we see
that $\mathcal{I}\mathcal{O}_{X'_n} =
\mathcal{I}'\mathcal{O}_{X'_n}(-d(f')^{-1}E)$
where $f' : X'_n \to X'$ is the composition.
Note that $(f')^{-1}E$ is an effective Cartier divisor by
Divisors on Spaces, Lemma
\ref{spaces-divisors-lemma-blow-up-pullback-effective-Cartier}.
Thus we are done by
Divisors on Spaces, Lemma
\ref{spaces-divisors-lemma-sum-effective-Cartier-divisors}.
\end{proof}

\begin{lemma}
\label{lemma-dominate-by-blowing-up-in-points}
Let $S$ be a scheme. Let $X$ be a Noetherian algebraic space over $S$.
Let $T \subset |X|$ be a finite set of closed points $x$ such that
(1) $X$ is regular at $x$ and (2) the local ring of $X$ at $x$ has
dimension $2$. Let $f : Y \to X$ be a proper morphism of
algebraic spaces which is an isomorphism over $U = X \setminus T$.
Then there exists a sequence
$$
X_n \to X_{n - 1} \to \ldots \to X_1 \to X_0 = X
$$
where $X_{i + 1} \to X_i$ is the blowing up of $X_i$ at a closed
point $x_i$ lying above a point of $T$ and a factorization $X_n \to Y \to X$
of the composition.
\end{lemma}

\begin{proof}
By More on Morphisms of Spaces,
Lemma \ref{spaces-more-morphisms-lemma-dominate-modification-by-blowup} 
there exists a $U$-admissible blowup $X' \to X$ which dominates
$Y \to X$. Hence we may assume there exists an ideal sheaf
$\mathcal{I} \subset \mathcal{O}_X$ such that
$\mathcal{O}_X/\mathcal{I}$ is supported on $T$ and such that
$Y$ is the blowing up of $X$ in $\mathcal{I}$.
By Lemma \ref{lemma-make-ideal-principal} 
there exists a sequence
$$
X_n \to X_{n - 1} \to \ldots \to X_1 \to X_0 = X
$$
where $X_{i + 1} \to X_i$ is the blowing up of $X_i$ at a closed
point $x_i$ lying above a point of $T$ such that
$\mathcal{I}\mathcal{O}_{X_n}$ is an invertible ideal sheaf.
By the universal property of blowing up
(Divisors on Spaces, Lemma
\ref{spaces-divisors-lemma-universal-property-blowing-up})
we find the desired factorization.
\end{proof}






\section{Vanishing}
\label{section-vanishing}

\noindent
In this section we will often work in the following setting.

\begin{situation}
\label{situation-vanishing}
Here $(A, \mathfrak m, \kappa)$ be a local Noetherian normal domain of
dimension $2$. Let $s$ be the closed point of $S = \Spec(A)$ and
$U = S \setminus \{s\}$. Let $f : X \to \Spec(A)$ be a modification
(as in Spaces over Fields, Definition
\ref{spaces-over-fields-definition-modification}).
We denote $C_1, \ldots, C_r$ the irreducible
components of the special fibre $X_s$ of $f$.
\end{situation}

\noindent
By Lemma \ref{lemma-modification} the morphism $f$ defines an isomorphism
$f^{-1}(U) \to U$. The special fibre $X_s$ is proper over $\Spec(\kappa)$, has
dimension at most $1$ (Lemma \ref{lemma-dimension-special-fibre}), and
therefore is a scheme (Spaces over Fields, Lemma
\ref{spaces-over-fields-lemma-codim-1-point-in-schematic-locus}).
By Stein factorization (more precisely,
More on Morphisms of Spaces, Lemma
\ref{spaces-more-morphisms-lemma-geometrically-connected-fibres-towards-normal})
we have $f_*\mathcal{O}_X = \mathcal{O}_S$ and
the special fibre $X_s$ is geometrically connected over $\kappa$.
If $X_s$ has dimension $0$, then $f$ is finite
(More on Morphisms of Spaces, Lemma
\ref{spaces-more-morphisms-lemma-proper-finite-fibre-finite-in-neighbourhood})
and hence an isomorphism
(Morphisms, Lemma \ref{morphisms-lemma-finite-birational-over-normal}).
We will discard this uninteresting case and we conclude that $\dim(C_i) = 1$
for $i = 1, \ldots, r$. The schematic locus of $X$ contains every point
of codimension $1$ of $X$ (Spaces over Fields, Lemma
\ref{spaces-over-fields-lemma-codim-1-point-in-schematic-locus}),
in particular the generic point of $C_i$.

\medskip\noindent
The following lemma allows one to reduce to the case where $X$
is a scheme in many of the following lemmas.

\begin{lemma}
\label{lemma-dominate-by-scheme-modification}
In Situation \ref{situation-vanishing} there exists a morphism
$g : X' \to X$ such that $X'$ is an integral scheme,
projective over $A$, and $X' \to \Spec(A)$ is a modification
(an isomorphism over $U$).
\end{lemma}

\begin{proof}
We can find a morphism $X' \to X$ where $X' \to S$ is a $U$-admissible
blow up, see Restricted Power Series, Lemma
\ref{restricted-lemma-dominate-by-admissible-blowup}.
Then $X'$ satisfies all the conditions of the lemma.
\end{proof}

\begin{lemma}
\label{lemma-nice-meromorphic-function}
In Situation \ref{situation-vanishing} there exists a nonzero
$f \in \mathfrak m$ such that for every $i = 1, \ldots, r$ there exist
\begin{enumerate}
\item a closed point $x_i \in C_i$ in the schematic locus of $X$
with $x_i \not \in C_j$ for $j \not = i$,
\item a factorization $f = g_i f_i$ of $f$ in $\mathcal{O}_{X, x_i}$
such that $g_i \in \mathfrak m_{x_i}$ maps to a nonzero element
of $\mathcal{O}_{C_i, x_i}$.
\end{enumerate}
\end{lemma}

\begin{proof}
We will use the observations made following Situation \ref{situation-vanishing}
without further mention. Pick a closed point $x_i \in C_i$ contained in the
schematic locus of $X$ which is not in $C_j$ for $j \not = i$. Pick
$g_i \in \mathfrak m_{x_i}$ which maps to a nonzero element of
$\mathcal{O}_{C_i, x_i}$. Since the fraction field of $A$ is the
fraction field of $\mathcal{O}_{X_i, x_i}$ we can write
$g_i = a_i/b_i$ for some $a_i, b_i \in A$. Take $f = \prod a_i$.
\end{proof}

\begin{lemma}
\label{lemma-nontrivial-normal-bundle}
In Situation \ref{situation-vanishing} assume $X$ is normal.
If $Z \subset X$ is a nonempty effective Cartier divisor such that
$|Z| \subset |X_s|$, then the conormal sheaf of $Z$ is not trivial.
More precisely, there exists an $i$ such that $C_i \subset Z$
and $\deg(\mathcal{C}_{Z/X}|_{C_i}) > 0$.
\end{lemma}

\begin{proof}
We will use the observations made following Situation \ref{situation-vanishing}
without further mention. Let $f$ be a function as in
Lemma \ref{lemma-modification}. Let $\xi_i \in C_i$ be the generic point. Let
$\mathcal{O}_i$ be the local ring of $X$ at $\xi_i$. Then $\mathcal{O}_i$
is a discrete valuation ring. Let $e_i$ be the valuation of
$f$ in $\mathcal{O}_i$, so $e_i > 0$. Let $h_i \in \mathcal{O}_i$ be a local
equation for $Z$ and let $d_i$ be its valuation. Then $d_i \geq 0$.
Choose and fix $i$ with $d_i/e_i$ maximal (then $d_i > 0$ as
$Z$ is not empty). Replace $f$ by $f^{d_i}$ and $Z$ by $e_iZ$.
This is permissible, by the relation
$\mathcal{O}_X(e_i Z) = \mathcal{O}_X(Z)^{\otimes e_i}$,
the relation between the conormal sheaf and $\mathcal{O}_X(Z)$
(see Divisors on Spaces, Lemmas
\ref{spaces-divisors-lemma-invertible-sheaf-sum-effective-Cartier-divisors}
and \ref{spaces-divisors-lemma-conormal-effective-Cartier-divisor}, and
since the degree gets multiplied by $e_i$, see
Varieties, Lemma \ref{varieties-lemma-degree-tensor-product}.
Let $\mathcal{I}$ be the ideal sheaf of $Z$ so that
$\mathcal{C}_{Z/X} = \mathcal{I}|_Z$. Consider the image $\overline{f}$
of $f$ in $\Gamma(Z, \mathcal{O}_Z)$. By our choices above we see
that $\overline{f}$ vanishes in the generic points of irreducible
compoenents of $Z$ (these are all generic points of $C_j$ as $Z$ is
contained in the special fibre). On the other hand, $Z$ is $(S_1)$ by
Divisors on Spaces, Lemma
\ref{spaces-divisors-lemma-normal-effective-Cartier-divisor-S1}.
Thus the scheme $Z$ has no embedded associated points and
we conclude that $\overline{f} = 0$ (Divisors, Lemmas
\ref{divisors-lemma-S1-no-embedded} and
\ref{divisors-lemma-restriction-injective-open-contains-weakly-ass}).
Hence $f$ is a global section of $\mathcal{I}$
which generates $\mathcal{I}_{\xi_i}$ by construction.
Thus the image $s_i$ of $f$ in $\Gamma(C_i, \mathcal{I}|_{C_i})$ is nonzero.
However, our choice of $f$ guarantees that $s_i$ has a zero at $x_i$.
Hence the degree of $\mathcal{I}|_{C_i}$ is $>0$ by
Varieties, Lemma \ref{varieties-lemma-check-invertible-sheaf-trivial}.
\end{proof}

\begin{lemma}
\label{lemma-H1-injective}
In Situation \ref{situation-vanishing} assume $X$ is normal
and $A$ Nagata. The map
$$
H^1(X, \mathcal{O}_X) \longrightarrow H^1(f^{-1}(U), \mathcal{O}_X)
$$
is injective.
\end{lemma}

\begin{proof}
Let $0 \to \mathcal{O}_X \to \mathcal{E} \to \mathcal{O}_X \to 0$ be the
extension corresponding to a nontrivial element $\xi$ of
$H^1(X, \mathcal{O}_X)$
(Cohomology on Sites, Lemma \ref{sites-cohomology-lemma-h1-extensions}).
Let $\pi : P = \mathbf{P}(\mathcal{E}) \to X$
be the projective bundle associated to $\mathcal{E}$.
The surjection $\mathcal{E} \to \mathcal{O}_X$
defines a section $\sigma : X \to P$ whose conormal sheaf is
isomorphic to $\mathcal{O}_X$
(Divisors on Spaces, Lemma
\ref{spaces-divisors-lemma-conormal-sheaf-section-projective-bundle}).
If the restriction of $\xi$ to $f^{-1}(U)$ is trivial, then we get
a map $\mathcal{E}|_{f^{-1}(U)} \to \mathcal{O}_{f^{-1}(U)}$ splitting
the injection $\mathcal{O}_X \to \mathcal{E}$. This defines a second
section $\sigma' : f^{-1}(U) \to P$ disjoint from $\sigma$. Since $\xi$
is nontrivial we conclude that $\sigma'$ cannot extend to all of $X$
and be disjoint from $\sigma$. Let $X' \subset P$ be the
scheme theoretic image of $\sigma'$ (Morphisms of Spaces,
Definition \ref{spaces-morphisms-definition-scheme-theoretic-image}).
Picture
$$
\xymatrix{
& X' \ar[rd]_g \ar[r] & P \ar[d]_\pi \\
f^{-1}(U) \ar[ru]_{\sigma'} \ar[rr] & & X \ar@/_/[u]_\sigma
}
$$
The morphism $P \setminus \sigma(X) \to X$ is affine.
If $X' \cap \sigma(X) = \emptyset$, then $X' \to X$ is both affine
and proper, hence finite
(Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-finite-proper}),
hence an isomorphism (as $X$ is normal, see
Decent Spaces, Lemma \ref{decent-spaces-lemma-finite-birational-over-normal}).
This is impossible as mentioned above.

\medskip\noindent
Let $X^\nu$ be the normalization of $X'$ (as constructed in
Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-normalization}
using a surjective \'etale morphism $U' \to X'$ with $U'$ affine).
Since $A$ is Nagata, we see that $X^\nu \to X'$ is finite
(because the corresponding morphism $U^\nu \to U'$ is finite by
Morphisms, Lemmas \ref{morphisms-lemma-nagata-normalization} and
\ref{morphisms-lemma-ubiquity-nagata}). Let $Z \subset X^\nu$ be the
pullback of the effective Cartier divisor $\sigma(X) \subset P$.
By the above we see that $Z$ is not empty and is contained
in the closed fibre of $X^\nu \to S$.
Since $P \to X$ is smooth, we see that $\sigma(X)$ is an effective
Cartier divisor (check \'etale locally on $X$ and use
Divisors, Lemma \ref{divisors-lemma-section-smooth-regular-immersion}).
Hence $Z \subset X^\nu$ is an effective Cartier divisor too.
Since the conormal sheaf of $\sigma(X)$ in $P$ is $\mathcal{O}_X$, the
conormal sheaf of $Z$ in $X^\nu$ (which is a priori invertible)
is $\mathcal{O}_Z$ by More on Morphisms of Spaces, Lemma
\ref{spaces-more-morphisms-lemma-conormal-functorial-flat}.
This is impossible by
Lemma \ref{lemma-nontrivial-normal-bundle}
and the proof is complete.
\end{proof}

\begin{lemma}
\label{lemma-R1-injective}
In Situation \ref{situation-vanishing} assume $X$ is normal and $A$ Nagata.
Then
$$
\Hom_{D(A)}(\kappa[-1], Rf_*\mathcal{O}_X)
$$
is zero. This uses $D(A) = D_\QCoh(\mathcal{O}_S)$ to think of
$Rf_*\mathcal{O}_X$ as an object of $D(A)$.
\end{lemma}

\begin{proof}
By adjointness of $Rf_*$ and $Lf^*$ such a map is the same thing
as a map $\alpha : Lf^*\kappa[-1] \to \mathcal{O}_X$. Note that
$$
H^i(Lf^*\kappa[-1]) =
\left\{
\begin{matrix}
0 & \text{if} & i > 1 \\
\mathcal{O}_{X_s} & \text{if} & i = 1 \\
\text{some }\mathcal{O}_{X_s}\text{-module} & \text{if} & i \leq 0
\end{matrix}
\right.
$$
Since $\Hom(H^0(Lf^*\kappa[-1]), \mathcal{O}_X) = 0$ as $\mathcal{O}_X$
is torsion free, the spectral sequence for $\text{Ext}$
(Cohomology on Sites, Example
\ref{sites-cohomology-example-hom-complex-into-sheaf})
implies that
$\Hom_{D(\mathcal{O}_X)}(Lf^*\kappa[-1], \mathcal{O}_X)$ is equal to
$\text{Ext}^1_{\mathcal{O}_X}(\mathcal{O}_{X_s}, \mathcal{O}_X)$.
We conclude that
$\alpha : Lf^*\kappa[-1] \to \mathcal{O}_X$ is given by an extension
$$
0 \to \mathcal{O}_X \to \mathcal{E} \to \mathcal{O}_{X_s} \to 0
$$
By Lemma \ref{lemma-H1-injective} the pullback of this extension
via the surjection $\mathcal{O}_X \to \mathcal{O}_{X_s}$ is zero
(since this pullback is clearly split over $f^{-1}(U)$).
Thus $1 \in \mathcal{O}_{X_s}$ lifts to a global section $s$ of
$\mathcal{E}$. Multiplying $s$ by the ideal sheaf $\mathcal{I}$
of $X_s$ we obtain an $\mathcal{O}_X$-module map
$c_s : \mathcal{I} \to \mathcal{O}_X$. Applying $f_*$ we obtain
an $A$-linear map $f_*c_s : \mathfrak m \to A$. Since $A$ is
a Noetherian normal local domain this map is given by multplication
by an element $a \in A$. Changing $s$ into $s -  a$ we find that
$s$ is annihilated by $\mathcal{I}$ and the extension is trivial
as desired.
\end{proof}

\noindent
The Grauert-Riemenschneider vanishing of the next proposition is a formal
consequence of Lemma \ref{lemma-R1-injective} and the general theory of
duality. However, since we have sofar only developped this theory for
morphisms of schemes, we restrict ourselves to this case.

\begin{proposition}[Grauert-Riemenschneider]
\label{proposition-Grauert-Riemenschneider}
In Situation \ref{situation-vanishing} assume
\begin{enumerate}
\item $X$ is a normal scheme,
\item $A$ is Nagata and has a dualizing complex $\omega_A^\bullet$.
\end{enumerate}
Let $\omega_X$ be the dualizing module of $X$
(Dualizing Complexes, Example \ref{dualizing-example-proper-over-local}).
Then $R^1f_*\omega_X = 0$.
\end{proposition}

\begin{proof}
In this proof we will use the identification $D(A) = D_\QCoh(\mathcal{O}_S)$
to identify quasi-coherent $\mathcal{O}_S$-modules with $A$-modules.
Moreover, we may assume that $\omega_A^\bullet$ is normalized, see
Dualizing Complexes, Section \ref{dualizing-section-dualizing-local}.
Since $X$ is a Noetherian normal $2$-dimensional scheme
it is Cohen-Macaulay (Properties, Lemma
\ref{properties-lemma-normal-dimension-2-Cohen-Macaulay}).
Thus $\omega_X^\bullet = \omega_X[2]$ (Dualizing Complexes, Lemma
\ref{dualizing-lemma-dualizing-module-CM-scheme} and the
normalization in Dualizing Complexes, Example
\ref{dualizing-example-proper-over-local}).
If the proposition is false, then we can find a nonzero map
$R^1f_*\omega_X \to \kappa$. In other words we obtain a nonzero map
$\alpha : Rf_*\omega_X^\bullet \to \kappa[1]$.
Applying $R\Hom_A(-, \omega_A^\bullet)$ we get a nonzero map
$$
\beta : \kappa[-1] \longrightarrow Rf_*\mathcal{O}_X
$$
which is impossible by Lemma \ref{lemma-R1-injective}.
To see that $R\Hom_A(-, \omega_A^\bullet)$ does what we said, first
note that
$$
R\Hom_A(\kappa[1], \omega_A^\bullet) =
R\Hom_A(\kappa, \omega_A^\bullet)[-1] =
\kappa[-1]
$$
as $\omega_A^\bullet$ is normalized and we have
$$
R\Hom_A(Rf_*\omega_X^\bullet, \omega_A^\bullet) =
Rf_*R\SheafHom_{\mathcal{O}_X}(\omega_X^\bullet, \omega_X^\bullet) =
Rf_*\mathcal{O}_X
$$
The first equality by
Dualizing Complexes, Lemma \ref{dualizing-lemma-proper-noetherian-relative}
and the fact that $\omega_X^\bullet = f^!\omega_A^\bullet$
by construction, and the second equality because $\omega_X^\bullet$
is a dualizing complex for $X$ (which goes back to
Dualizing Complexes, Lemma \ref{dualizing-lemma-shriek-dualizing}).
\end{proof}





\section{Boundedness}
\label{section-bounded}

\noindent
In this section we begin the discussion which will lead to a reduction to
the case of rational singularities for $2$-dimensional schemes.

\begin{lemma}
\label{lemma-exact-sequence}
Let $(A, \mathfrak m, \kappa)$ be a Noetherian normal local domain
of dimension $2$. Consider a commutative diagram
$$
\xymatrix{
X' \ar[rd]_{f'} \ar[rr]_g & & X \ar[ld]^f \\
& \Spec(A)
}
$$
where $f$ and $f'$ are modifications as in Situation \ref{situation-vanishing}
and $X$ normal. Then we have a short exact sequence
$$
0 \to H^1(X, \mathcal{O}_X) \to H^1(X', \mathcal{O}_{X'}) \to
H^0(X, R^1g_*\mathcal{O}_{X'}) \to 0
$$
Also $\dim(\text{Supp}(R^1g_*\mathcal{O}_{X'})) = 0$
and $R^1g_*\mathcal{O}_{X'}$ is generated by global sections.
\end{lemma}

\begin{proof}
We will use the observations made following Situation \ref{situation-vanishing}
without further mention. As $X$ is normal and $g$ is dominant and
birational, we have $g_*\mathcal{O}_{X'} = \mathcal{O}_X$, see for
example More on Morphisms of Spaces, Lemma
\ref{spaces-more-morphisms-lemma-geometrically-connected-fibres-towards-normal}.
Since the fibres of $g$ have dimension $\leq 1$, we have
$R^pg_*\mathcal{O}_{X'} = 0$ for $p > 1$, see for example
Cohomology of Spaces, Lemma
\ref{spaces-cohomology-lemma-higher-direct-images-zero-above-dimension-fibre}.
The support of $R^1g_*\mathcal{O}_{X'}$ is contained in the set of points of
$|X|$ where the fibres of $g'$ have dimension $\geq 1$. Thus
it is contained in the set of images of those
irreducible components $C' \subset X'_s$ which map to points of $X_s$
which is a finite set of closed points
(recall that $X'_s \to X_s$ is a morphism of proper $1$-dimensional
schemes over $\kappa$). Then $R^1g_*\mathcal{O}_{X'}$ is globally
generated by
Cohomology of Schemes, Lemma \ref{coherent-lemma-coherent-support-dimension-0}.
Using the morphism $f : X \to S$ and the references above we find that
$H^p(X, \mathcal{F}) = 0$ for $p > 1$ for any coherent $\mathcal{O}_X$-module
$\mathcal{F}$. Hence the short exact sequence of the lemma is a consequence
of the Leray spectral sequence for $g$ and $\mathcal{O}_{X'}$, see
Cohomology on Sites, Lemma \ref{sites-cohomology-lemma-Leray}.
\end{proof}

\begin{lemma}
\label{lemma-bound-primes}
Let $A$ be a Noetherian local normal domain of dimension $2$.
For $f \in \mathfrak m$ nonzero denote
$\text{div}(f) = \sum n_i (\mathfrak p_i)$
the divisor associated to $f$ on the punctured spectrum of $A$.
We set $|f| = \sum n_i$. There exist integers $N$ and $M$
such that $|f + g| \leq M$ for all $g \in \mathfrak m^N$.
\end{lemma}

\begin{proof}
Pick $h \in \mathfrak m$ such that $f, h$ is a regular sequence in $A$
(this follows from Algebra, Lemmas \ref{algebra-lemma-criterion-normal} and
\ref{algebra-lemma-depth-drops-by-one}).
We will prove the lemma with $M = \text{length}_A(A/(f, h))$ and with
$N$ any integer such that $\mathfrak m^N \subset (f, h)$. Such
an integer $N$ exists because $\sqrt{(f, h)} = \mathfrak m$. Note that
$M = \text{length}_A(A/(f + g, h))$ for all $g \in \mathfrak m^N$
because $(f, h) = (f + g, h)$. This moreover implies that $f + g, h$
is a regular sequence in $A$ too, see
Algebra, Lemma \ref{algebra-lemma-reformulate-CM}.
Now suppose that $\text{div}(f + g ) = \sum m_j (\mathfrak q_j)$.
Then consider the map
$$
c : A/(f + g) \longrightarrow \prod A/\mathfrak q_j^{(m_j)}
$$
where $\mathfrak q_j^{(m_j)}$ is the symbolic power, see
Algebra, Section \ref{algebra-section-symbolic-power}.
Since $A$ is normal, we see that $A_{\mathfrak q_i}$ is
a discrete valuation ring and hence
$$
A_{\mathfrak q_i}/(f + g) =
A_{\mathfrak q_i}/\mathfrak q_i^{m_i} A_{\mathfrak q_i} =
(A/\mathfrak q_i^{(m_i)})_{\mathfrak q_i}
$$
Since $V(f + g, h) = \{\mathfrak m\}$ this implies that $c$ becomes
an isomorphism on inverting $h$ (small detail omitted). Since $h$ is a
nonzerodivisor on $A/(f + g)$ we see that the length of $A/(f + g, h)$
equals the Herbrand quotient $e_A(A/(f + g), 0, h)$
as defined in Chow Homology, Section
\ref{chow-section-periodic-complexes}).
Similarly the length of $A/(h, \mathfrak q_j^{(m_j)})$ equals
$e_A(A/\mathfrak q_j^{(m_j)}, 0, h)$. Then we have
\begin{align*}
M & = \text{length}_A(A/(f + g, h) \\
& =
e_A(A/(f + g), 0, h) \\
& =
\sum\nolimits_i e_A(A/\mathfrak q_j^{(m_j)}, 0, h) \\
& =
\sum\nolimits_i \sum\nolimits_{m = 0, \ldots, m_j - 1}
e_A(\mathfrak q_j^{(m)}/\mathfrak q_j^{(m + 1)}, 0, h)
\end{align*}
The equalities follow from Chow Homology, Lemma
\ref{chow-lemma-periodic-length} using in particular that
the cokernel of $c$ has finite length as discussed above.
It is straightforward to prove that
$e_A(\mathfrak q^{(m)}/\mathfrak q^{(m + 1)}, 0, h)$
is at least $1$ by Nakayama's lemma. This finishes the proof of the lemma.
\end{proof}

\begin{lemma}
\label{lemma-radical-element}
Let $A$ be a Noetherian local normal domain of dimension $2$.
Let $\mathfrak p_1, \ldots, \mathfrak p_r$ be pairwise distinct
primes of height $1$. There exists an element
$f \in \mathfrak p_1 \cap \ldots \cap \mathfrak p_r$ such
that $A/fA$ is reduced.
\end{lemma}

\begin{proof}
As a first approximation pick any nonzero
$f \in \mathfrak p_1 \cap \ldots \cap \mathfrak p_r$.
Pick integers $N$ and $M$ as in Lemma \ref{lemma-bound-primes}
adapted to $f$. Write
$$
\text{div}(f) =
\sum\nolimits_{i = 1, \ldots, s} (\mathfrak q_i) +
\sum\nolimits_{j = 1, \ldots, t} m_j (\mathfrak r_j)
$$
with $m_j > 1$ and with no equalities among the primes
$\mathfrak q_i$ and $\mathfrak r_j$ (in other words the set
$\{\mathfrak q_i, \mathfrak r_j\}$ has $r + s$ elements).
We have $r + \sum m_j \leq M$ is bounded among all $f$ in
$f + \mathfrak m^N$ hence we may assume
$f \in \mathfrak p_1 \cap \ldots \cap \mathfrak p_r$ is chosen with $s$
maximal. We claim that $t = 0$. If not, then we choose
$$
g \in
\mathfrak m^N \cap
\mathfrak q_1^2 \cap \ldots \cap \mathfrak q_s^2 \cap
\mathfrak r_1 \cap \ldots \cap \mathfrak r_t
\quad\text{and}\quad
g \not \in \mathfrak r_1^2 \cup \ldots \cup \mathfrak r_t^2
$$
First choose $g_0 \in \mathfrak m^N$,
$g_i \in \mathfrak q_i$ and $g'_i \in \mathfrak r_i$
and each not contained in any other of the primes
(using prime avoidance Algebra, Lemma \ref{algebra-lemma-silly})
and then take $g = g_0 g_1^2 \ldots g_s^2 g'_1 \ldots g'_t$.
Observe that $g \in \mathfrak p_1 \cap \ldots \cap \mathfrak p_r$
as $\{\mathfrak p_i\} \subset \{\mathfrak q_i, \mathfrak r_j\}$.
Now we note that
$$
\text{div}(f + g) = \sum\nolimits_{i = 1, \ldots, s} (\mathfrak q_i) +
\sum\nolimits_{j = 1, \ldots, t} (\mathfrak r_j) +
\sum e_k (\mathfrak s_k)
$$
for some height one primes
$\mathfrak s_k \not \in \{\mathfrak p_i, \mathfrak q_j, \mathfrak r_i\}$.
This is a contradiction with maximality of $s$ unless $t = 0$
which is what we wanted to show.
\end{proof}

\begin{lemma}
\label{lemma-divides-radical}
Let $(A, \mathfrak m, \kappa)$ be a Noetherian normal local domain
of dimension $2$. If $a \in \mathfrak m$ is nonzero, then there exists an
element $c \in A$ such that $A/cA$ is reduced and such that $a$ divides
$c^n$ for some $n$.
\end{lemma}

\begin{proof}
Let $\text{div}(a) = \sum_{i = 1, \ldots, r} n_i(\mathfrak p_i)$. Choose
$c \in \mathfrak p_1 \cap \ldots \cap \mathfrak p_r$ with $A/cA$
reduced, see Lemma \ref{lemma-radical-element}. For $n \geq \max(n_i)$
we see that $-\text{div}(a) + \text{div}(c^n)$
is an effective divisor (all coefficients
nonnegative). Thus $c^n/a \in A$ by Algebra, Lemma
\ref{algebra-lemma-normal-domain-intersection-localizations-height-1}.
\end{proof}

\begin{lemma}
\label{lemma-bound-a-torsion}
Let $(A, \mathfrak m, \kappa)$ be a Noetherian local normal Nagata domain
of dimension $2$. Let $a \in A$ be nonzero. There exists an integer $N$ such
that for every modification $f : X \to \Spec(A)$ with $X$ normal the
$A$-module
$$
M_{X, a} = \Coker(A \longrightarrow H^0(Z, \mathcal{O}_Z))
$$
where $Z \subset X$ is cut out by $a$ has length bounded by $N$.
\end{lemma}

\begin{proof}
By the short exact sequence
$
0 \to \mathcal{O}_X \xrightarrow{a} \mathcal{O}_X \to \mathcal{O}_Z \to 0
$
we see that
\begin{equation}
\label{equation-a-torsion}
M_{X, a} = H^1(X, \mathcal{O}_X)[a]
\end{equation}
Here $N[a] = \{n \in N \mid an = 0\}$ for an $A$-module $N$. Thus
if $a$ divides $b$, then $M_{X, a} \subset M_{X, b}$.
Suppose that for some $c \in A$ the modules $M_{X, c}$
have bounded length. Then for every $X$ we have an exact sequence
$$
0 \to M_{X, c} \to M_{X, c^2} \to M_{X, c}
$$
where the second arrow is given by multiplication by $c$. Hence we see that
$M_{X, c^2}$ has bounded length as well. Thus it suffices to find a $c \in A$
for which the lemma is true such that $a$ divides $c^n$ for some $n > 0$.
By Lemma \ref{lemma-divides-radical} we may assume $A/(a)$ is a reduced ring.

\medskip\noindent
Assume that $A/(a)$ is reduced. Let $A/(a) \subset B$ be the normalization
of $A/(a)$ in its quotient ring. Because $A$ is Nagata, we see that
$\text{Coker}(A \to B)$ is finite. We claim the length of this finite
module is a bound. To see this, consider $f : X \to \Spec(A)$ as in the lemma
and let $Z' \subset Z$ be the scheme theoretic closure of $Z \cap f^{-1}(U)$.
Then $Z' \to \Spec(A/(a))$ is finite because $\dim(A/(a)) = 1$,
so $Z" \to \Spec(A/(a))$ has finite fibres by
Lemma \ref{lemma-dimension-special-fibre}, so it is finite by
More on Morphisms of Spaces, Lemma
\ref{spaces-more-morphisms-lemma-proper-finite-fibre-finite-in-neighbourhood}.
Hence $Z' = \Spec(B')$ with $A/(a) \subset B' \subset B$.
On the other hand, we claim the map
$$
H^0(Z, \mathcal{O}_Z) \to H^0(Z', \mathcal{O}_{Z'})
$$
is injective. Namely, if $s \in H^09Z, \mathcal{O}_Z)$
is in the kernel, then
the restriction of $s$ to $f^{-1}(U) \cap Z$ is zero.
Hence the image of $s$ in $H^1(X, \mathcal{O}_X)$ vanishes in
$H^1(f^{-1}(U), \mathcal{O}_X)$. By Lemma \ref{lemma-H1-injective}
we see that $s$ comes from an element $\tilde s$ of $A$. But by
assumption $\tilde s$ maps to zero in $B'$ which implies that $s = 0$.
Putting everything together we see that
$M_{X, a}$ is a subquotient of $B'/A$, namely not every element
of $B'$ extends to a global section of $\mathcal{O}_Z$, but in
any case the length of $M_{X, a}$ is bounded by the length of $B/A$.
\end{proof}

\noindent
In some cases, resolution of singularities reduces to the case
of rational singularities.

\begin{definition}
\label{definition-reduce-to-rational}
Let $(A, \mathfrak m, \kappa)$ be a Noetherian local normal Nagata domain
of dimension $2$.
\begin{enumerate}
\item We say $A$ {\it defines a rational singularity} if for every
normal modification $X \to \Spec(A)$ we have $H^1(X, \mathcal{O}_X) = 0$.
\item We say that {\it reduction to rational singularities
is possible for $A$} if the length of the $A$-modules
$$
H^1(X, \mathcal{O}_X)
$$
is bounded for all modifications $X \to \Spec(A)$ with $X$ normal.
\end{enumerate}
\end{definition}

\noindent
The reason for this terminology is the following lemma.

\begin{lemma}
\label{lemma-reduce-to-rational}
Let $(A, \mathfrak m, \kappa)$ be a Noetherian local normal Nagata domain
of dimension $2$. If reduction to rational singularities is possible for $A$,
then there exists a modification $X \to \Spec(A)$ where $X$
is a normal scheme projective over $A$, such that for any
closed point $x \in X$ the local ring
$\mathcal{O}_{X, x}$ defines a rational singularity.
\end{lemma}

\begin{proof}
We choose an $X \to \Spec(A)$ which maximizes the length of
$H^1(X, \mathcal{O}_X)$. By Lemma \ref{lemma-exact-sequence}
for any further modification $g : X' \to X$ with $X'$ normal
we have $R^1g_*\mathcal{O}_{X'} = 0$ and
$H^1(X, \mathcal{O}_X) = H^1(X', \mathcal{O}_{X'})$.

\medskip\noindent
We first massage $X$ to turn it into a scheme projective over $A$.
Let $X' \to X$ be as in Lemma \ref{lemma-dominate-by-scheme-modification}
and let $X^\nu$ be the normalization of $X'$.
As $A$ is Nagata, the morphism $X^\nu \to X'$ is finite
(Morphisms, Lemma \ref{morphisms-lemma-nagata-normalization}).
Then $X^\nu \to S$ is projective
(More on Morphisms, Lemma \ref{more-morphisms-lemma-category-projective}).
Thus we may replace $X$ by $X^\nu$ and assume $X$ is a normal scheme
projective over $A$ with $H^1(X, \mathcal{O}_X)$ maximal.

\medskip\noindent
Let $X \to \Spec(A)$ be a modification with $X$ projective over $A$
and $H^1(X, \mathcal{O}_X)$ maximal (among all normal modifications).
Let $x \in X$ be a closed point. Let $Y \to \Spec(\mathcal{O}_{X, x})$
be a modification with $Y$ normal. We want to show that
$H^1(Y, \mathcal{O}_Y) = 0$. Arguing as in the second paragraph
we may assume $Y$ is a scheme. By
Limits, Lemma \ref{limits-lemma-modifications}
we can find a morphism of schemes $g : X' \to X$ which is an isomorphism
over $X \setminus \{x\}$ such that $X' \times_X \Spec(\mathcal{O}_{X, x})$
is isomorphic to $Y$. Then $g$ is a modification. By maximality
we have $R^1g_*\mathcal{O}_{X'} = 0$ (see first paragraph). Clearly
this means that $H^1(Y, \mathcal{O}_Y) = 0$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-go-up-separable}
Let $A \to B$ be a finite injective local ring map of Noetherian local normal
Nagata domains of dimension $2$. Assume that the induced extension of
fraction fields is separable. If reduction to rational singularities
is possible for $A$ then it is possible for $B$.
\end{lemma}

\begin{proof}
Let $n$ be the degree of the fraction field extension $K \subset L$.
Let $\text{Tr} : L \to K$ be the trace. Since the extension is finite
separable the trace pairing $(h, g) \mapsto \text{Tr}(fg)$ is a nondegenerate
quadratic form on $L$ over $K$.
Pick $b_1, \ldots, b_n \in B$ which form a basis of $L$ over $K$.
By the above $d = \det(\text{Tr}(b_ib_j)) \in A$ is nonzero.

\medskip\noindent
Let $Y \to \Spec(B)$ be a modification with $Y$ normal. We can find
a $U$-admissible blow up $X'$ of $\Spec(A)$ such that the strict transform
$Y'$ of $Y$ is finite over $X'$, see More on Morphisms of Spaces, Lemma
\ref{spaces-more-morphisms-lemma-finite-after-blowing-up}. Picture
$$
\xymatrix{
Y' \ar[d] \ar[r] & Y \ar[r] & \Spec(B) \ar[d] \\
X' \ar[rr] & & \Spec(A)
}
$$
After replacing $X'$ and $Y'$ by their normalizations we may assume that
$X'$ and $Y'$ are normal modifications of $\Spec(A)$ and $\Spec(B)$.
In this way we reduce to the case where there exists a commutative diagram
$$
\xymatrix{
Y \ar[d]_\pi \ar[r]_-g & \Spec(B) \ar[d] \\
X \ar[r]^-f & \Spec(A)
}
$$
with $X$ and $Y$ normal modifications of $\Spec(A)$ and $\Spec(B)$ and
$\pi$ finite.

\medskip\noindent
The trace map on $L$ over $K$ extends to a map of $\mathcal{O}_X$-modules
$\text{Tr} : \pi_*\mathcal{O}_Y \to \mathcal{O}_X$. Consider the map
$$
\Phi : \pi_*\mathcal{O}_Y \longrightarrow \mathcal{O}_X^{\oplus n},\quad
s \longmapsto (\text{Tr}(b_1s), \ldots, \text{Tr}(b_ns))
$$
This map is injective (because it is injective in the generic point)
and there is a map
$$
\mathcal{O}_X^{\oplus n} \longrightarrow \pi_*\mathcal{O}_Y,\quad
(s_1, \ldots, s_n) \longmapsto \sum b_i s_i
$$
whose composition with $\Phi$ has matrix $\text{Tr}(b_ib_j)$.
Hence the cokernel of $\Phi$ is annihilated by $d$. Thus we see that
we have an exact sequence
$$
H^0(X, \Coker(\Phi)) \to H^1(Y, \mathcal{O}_Y) \to
H^1(X, \mathcal{O}_X)^{\oplus n}
$$
Since the right hand side is bounded by assumption, it suffices to show
that the $d$-torsion in $H^1(Y, \mathcal{O}_Y)$ is bounded.
This is the content of Lemma \ref{lemma-bound-a-torsion} and
(\ref{equation-a-torsion}).
\end{proof}

\begin{lemma}
\label{lemma-regular-rational}
Let $A$ be a Nagata regular local ring of dimension $2$. Then $A$ defines
a rational singularity.
\end{lemma}

\begin{proof}
(The assumption that $A$ be Nagata is not necessary for this proof,
but we've only defined the notion of rational singularity in the
case of Nagata $2$-dimensional normal local domains.)
Let $X \to \Spec(A)$ be a modification. By
Lemma \ref{lemma-dominate-by-blowing-up-in-points}
we can dominate $X$ by a scheme $X_n$ which is the last in a sequence
$$
X_n \to X_{n - 1} \to \ldots \to X_1 \to X_0 = \Spec(A)
$$
of blowing ups in closed points. By Lemma \ref{lemma-blowup-regular}
the schemes $X_i$ are regular, in particular
normal (Algebra, Lemma \ref{algebra-lemma-regular-normal}).
By Lemma \ref{lemma-exact-sequence} we have
$H^1(X, \mathcal{O}_X) \subset H^1(X_n, \mathcal{O}_{X_n})$.
Thus it suffices to prove $H^1(X_n, \mathcal{O}_{X_n}) = 0$.
Using Lemma \ref{lemma-exact-sequence} again, we
see that it suffices to prove $R^1(X_i \to X_{i - 1})_*\mathcal{O}_{X_i} = 0$
for $i = 1, \ldots, n$. This follows from
Lemma \ref{lemma-cohomology-of-blowup}.
\end{proof}

\begin{remark}
\label{remark-dualizing-setup}
Let $X$ be an integral Noetherian normal scheme of dimension $2$.
In this case the following are equivalent
\begin{enumerate}
\item $X$ has a dualizing complex $\omega_X^\bullet$,
\item there is a coherent $\mathcal{O}_X$-module $\omega_X$ such that
$\omega_X[n]$ is a dualizing complex, where $n$ can be any integer.
\end{enumerate}
This follows from the fact that $X$ is Cohen-Macaulay
(Properties, Lemma \ref{properties-lemma-normal-dimension-2-Cohen-Macaulay}) and
Dualizing Complexes, Lemma \ref{dualizing-lemma-dualizing-module-CM-scheme}.
In this situation we will say that $\omega_X$ is a {\it dualizing module}
in accordance with
Dualizing Complexes, Section \ref{dualizing-section-dualizing-module}.
In particular, when $A$ is a Noetherian normal local domain of dimension
$2$, then we say {\it $A$ has a dualizing module $\omega_A$}
if the above is true. In this case, if $X \to \Spec(A)$ is a normal
modification and $X$ is a scheme, then $X$ has a dualizing module
too, see
Dualizing Complexes, Example \ref{dualizing-example-proper-over-local}.
In this situation we always denote $\omega_X$ the dualizing
module normalized with respect to $\omega_A$, i.e., such that
$\omega_X[2]$ is the dualizing complex normalized relative to
$\omega_A[2]$.
\end{remark}

\begin{lemma}
\label{lemma-bound-dualizing-implies-bound}
Let $A$ be a Nagata Noetherian local normal domain of dimension $2$
which has a dualizing complex $\omega_A^\bullet$.
If there exists a nonzero $d \in A$ such that for all
normal modifications $X \to \Spec(A)$ with $X$ a scheme
the cokernel of the trace map
$$
\Gamma(X, \omega_X) \to \omega_A
$$
is annihilated by $d$, then reduction to rational singularities
is possible for $A$.
\end{lemma}

\begin{proof}
Any modification of $\Spec(A)$ can be dominated by a modification
which is a scheme, see Lemma \ref{lemma-dominate-by-scheme-modification},
which we can normalize to obtain a normal modification
(using that $A$ is Nagata, see
Morphisms, Lemma \ref{morphisms-lemma-nagata-normalization}).
Thus by Lemma \ref{lemma-exact-sequence}
it suffices to bound the length of $H^1(X, \mathcal{O}_X)$
for normal modifications which are schemes.

\medskip\noindent
Let $X \to \Spec(A)$ be as in the statement.
Let $\omega_X$ be the dualizing module of $X$ as in the statement of
Grauert-Riemenschneider
(Proposition \ref{proposition-Grauert-Riemenschneider}).
The trace map is the map $Rf_*\omega_X \to \omega_A$ described
in Dualizing Complexes, Section \ref{section-trace}.
By Grauert-Riemenschneider we have $Rf_*\omega_X = f_*\omega_X$
thus the trace map indeed produces a map $\Gamma(X, \omega_X) \to \omega_A$.
By duality we have $Rf_*\omega_X = R\Hom_A(Rf_*\mathcal{O}_X, \omega_A)$
(this uses that $\omega_X[2]$ is the dualizing complex on $X$
normalized relative to $\omega_A[2]$,
see Dualizing Complexes, Lemma \ref{dualizing-lemma-duality-bootstrap}
or more directly Section \ref{dualizing-section-duality} or even more directly
Lemma \ref{dualizing-lemma-proper-noetherian-relative}).
The distinguished triangle
$$
A \to Rf_*\mathcal{O}_X \to R^1f_*\mathcal{O}_X[-1] \to A[1]
$$
is transformed by $R\Hom_A(-, \omega_A)$ into the short exact sequence
$$
0 \to f_*\omega_X \to \omega_A \to
\text{Ext}_A^2(R^1f_*\mathcal{O}_X, \omega_A) \to 0
$$
(and $\text{Ext}_A^i(R^1f_*\mathcal{O}_X, \omega_A) = 0$ for $i \not = 2$;
this will follow from the discussion below as well).
Since $R^1f_*\mathcal{O}_X$ is supported in $\{\mathfrak m\}$, the
local duality theorem tells us that
$$
\text{Ext}_A^2(R^1f_*\mathcal{O}_X, \omega_A) =
\text{Ext}_A^0(R^1f_*\mathcal{O}_X, \omega_A[2]) =
\Hom_A(R^1f_*\mathcal{O}_X, E)
$$
is the Matlis dual of $R^1f_*\mathcal{O}_X$ (and the other
ext groups are zero), see
Dualizing Complexes, Lemma \ref{dualizing-lemma-special-case-local-duality}.
By the equivalence of categories inherent in Matlis duality
(Dualizing Complexes, Proposition \ref{dualizing-proposition-matlis}),
if $R^1f_*\mathcal{O}_X$ is not annihilated by $d$,
then neither is the $\text{Ext}^2$ above. Hence we see that
$H^1(X, \mathcal{O}_X)$ is annihilated by $d$. Thus the required
boundedness follows from Lemma \ref{lemma-bound-a-torsion} and
(\ref{equation-a-torsion}).
\end{proof}

\begin{lemma}
\label{lemma-compare-differentials-dualizing}
Let $p$ be a prime number.
Let $A$ be a regular local ring of dimension $2$ and characteristic $p$.
Let $A_0 \subset A$ be a subring such that $\Omega_{A/A_0}$ is free
of rank $r < \infty$. Set $\omega_A = \Omega^r_{A/A_0}$. If $X \to \Spec(A)$
is the result of a sequence of blowings up in closed points, then
there exists a map
$$
\varphi_X : (\Omega^r_{X/\Spec(A_0)})^{**} \longrightarrow \omega_X
$$
extending the given identification in the generic point.
\end{lemma}

\begin{proof}
Suppose we have constructed the map
$\varphi_X : (\Omega^r_{X/A_0})^{**} \to \omega_X$
and suppose that $b : X' \to X$ is a blow up in a closed point.
Set $\Omega^r_X = (\Omega^r_{X/A_0})^{**}$ and
$\Omega^r_{X'} = (\Omega^r_{X'/A_0})^{**}$.
By the universal property of the dualizing module, a map
$\Omega^r_{X'} \to \omega_{X'}$ is the same thing as a map
$b_*\Omega^r_{X'} \to \omega_X$, see
Dualizing Complexes, Lemma \ref{dualizing-lemma-dualizing-module-proper-over-A}.
Thus in turn it suffices to produce a map
$$
b_*\Omega^r_{X'} \longrightarrow \Omega^r_X
$$
The sheaves $\Omega^r_{X'}$ and $\Omega^r_X$ are invertible, see
Divisors, Lemma \ref{divisors-lemma-reflexive-over-regular-dim-2}.
Consider the exact sequence
$$
b^*\Omega_{X/A_0} \to \Omega_{X'/A_0} \to \Omega_{X'/X} \to 0
$$
A local calculation shows that $\Omega_{X'/X}$ is isomorphic
to an invertible module on the exceptional divisor $E$, see
Lemma \ref{lemma-differentials-of-blowup}. It follows that
either
$$
\Omega^r_{X'} \cong (b^*\Omega^r_X)(E)
\quad\text{or}\quad
\Omega^r_{X'} \cong b^*\Omega^r_X
$$
see Divisors, Lemma \ref{divisors-lemma-wedge-product-ses}.
(The second possibility never happens in characteristic zero, but
can happen in characteristic $p$.) In both cases we see that
$b_*\Omega^r_{X'} = \Omega^r_X$ by Lemma \ref{lemma-cohomology-of-blowup}.
\end{proof}

\begin{lemma}
\label{lemma-go-up-degree-p}
Let $p$ be a prime number. Let $A$ be a complete regular local ring of
dimension $2$ and characteristic $p$. Let $K = f.f.(A) \subset L$ be a
degree $p$ inseparable extension and let $B \subset L$ be the integral
closure of $A$. Then reduction to rational singularities is possible for $B$.
\end{lemma}

\begin{proof}
We have $A = k[[x, y]]$. Write $L = K[x]/(x^p - f)$ for some $f \in A$
and denote $g \in B$ the congruence class of $x$, i.e., the element such
that $g^p = f$. By
More on Algebra, Lemma \ref{more-algebra-lemma-power-series-ring-subfields}
there exists a subfield $k^p \subset k' \subset k$ with
$p^e = [k : k'] < \infty$
such that $f$ is not contained in the fraction field $K_0$ of
$A_0 = k'[[x^p, y^p]] \subset A$. Then
$$
\Omega_{A/A_0} =
A \otimes_k \Omega_{k/k'} \oplus A \text{d}x \oplus A \text{d}y
$$
is finite free of rank $e + 2$. Set $\omega_A = \Omega^{e + 2}_{A/A_0}$.
Consider the canonical map
$$
\text{Tr} :
\Omega^{e + 2}_{B/A_0}
\longrightarrow
\Omega^{e + 2}_{A/A_0} = \omega_A
$$
of Lemma \ref{lemma-trace-extends}. By duality this determines a map
$$
c : \Omega^{e + 2}_{B/A_0} \to \omega_B = \Hom_A(B, \omega_A)
$$
Claim: the cokernel of $c$ is annilated by a nonzero element of $B$.

\medskip\noindent
Since $\text{d}f$ is nonzero in $\Omega_{A/A_0}$
(Algebra, Lemma \ref{algebra-lemma-derivative-zero-pth-power}) we can find
$\eta_1, \ldots, \eta_{e + 1} \in \Omega_{A/A_0}$ such that
$\theta = \eta_1 \wedge \ldots \wedge \eta_{e + 1} \wedge \text{d}f$ is
nonzero in $\omega_A = \Omega^{e + 2}_{A/A_0}$. To prove the claim we
will construct elements $\omega_i$ of $\Omega^{e + 2}_{B/A_0}$,
$i = 0, \ldots, p - 1$ which are mapped to
$\varphi_i \in \omega_B = \Hom_A(B, \omega_A)$
with $\varphi_i(g^j) = \delta_{ij}\theta$ for $j = 0, \ldots, p - 1$.
Since $\{1, g, \ldots, g^{p - 1}\}$ is a basis for $L/K$ this
proves the claim. We set
$\eta = \eta_1 \wedge \ldots \wedge \eta_{e + 1}$
so that $\theta = \eta \wedge \text{d}f$.
Set $\omega_i = \eta \wedge g^{p - 1 - i}\text{d}g$. Then
by construction we have
$$
\varphi_i(g^j) = \text{Tr}(g^j \eta \wedge g^{p - 1 - i}\text{d}g) =
\text{Tr}(\eta \wedge g^{p - 1 - i + j}\text{d}g) = \delta_{ij} \theta
$$
by the explicit description of the trace map in Lemma \ref{lemma-trace-higher}.

\medskip\noindent
Let $Y \to \Spec(B)$ be a normal modification. Exactly as in the proof of
Lemma \ref{lemma-go-up-separable} we can reduce to the case where $Y$
is finite over a modification $X$ of $\Spec(A)$. Arguing as in the proof
of Lemma \ref{lemma-regular-rational} we may even assume that $X = X_n$ where
$$
X_n \to X_{n - 1} \to \ldots \to X_1 \to X_0 = X
$$
is a sequence of blowing ups in closed points. By
Lemma \ref{lemma-trace-extends} we obtain the first arrow in
$$
\pi_*(\Omega^{e + 2}_{Y/A_0})
\xrightarrow{\text{Tr}}
(\Omega^{e + 2}_{X/A_0})^{**}
\xrightarrow{\varphi_X}
\omega_X
$$
and the second arrow is from
Lemma \ref{lemma-compare-differentials-dualizing}.
By duality this corresponds to a map
$$
c_Y : \Omega^{e + 2}_{Y/A_0} \longrightarrow \omega_Y
$$
extending the map $c$ above. Hence we see that the image of
$\Gamma(Y, \omega_Y) \to \omega_B$ contains the image of $c$.
By our claim we see that the cokernel is annihilated by
a fixed nonzero element of $B$. We conclude by
Lemma \ref{lemma-bound-dualizing-implies-bound}.
\end{proof}






\section{Rational singularities}
\label{section-rational-singularities}

\noindent
In this section we reduce from rational singular points to
Gorenstein rational singular points. See \cite{Lipman-rational} and
\cite{Mattuck}.

\begin{situation}
\label{situation-rational}
Here $(A, \mathfrak m, \kappa)$ be a local Noetherian normal domain of
dimension $2$ which defines a rational singularity. Let $s$ be the closed
point of $S = \Spec(A)$ and $U = S \setminus \{s\}$. Let $f : X \to \Spec(A)$
be a normal proper birational morphism of schemes.
We denote $C_1, \ldots, C_r$ the irreducible
components of the special fibre $X_s$ of $f$.
\end{situation}

\begin{lemma}
\label{lemma-globally-generated}
In Situation \ref{situation-rational}.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module. Then
\begin{enumerate}
\item $H^p(X, \mathcal{F}) = 0$ for $p \not \in \{0, 1\}$, and
\item $H^1(X, \mathcal{F}) = 0$ if $\mathcal{F}$ is globally generated.
\end{enumerate}
\end{lemma}

\begin{proof}
Part (1) follows from  Cohomology of Schemes, Lemma
\ref{coherent-lemma-higher-direct-images-zero-above-dimension-fibre}.
If $\mathcal{F}$ is globally generated, then there is a surjection
$\bigoplus_{i \in I} \mathcal{O}_X \to \mathcal{F}$. By part (1)
and the long exact sequence of cohomology this
induces a surjection on $H^1$. Since $H^1(X, \mathcal{O}_X) = 0$
as $S$ has a rational singularity, and since $H^1(X, -)$ commutes
with direct sums
(Cohomology, Lemma \ref{cohomology-lemma-quasi-separated-cohomology-colimit})
we conclude.
\end{proof}

\begin{lemma}
\label{lemma-sections-powers-I-rational}
In Situation \ref{situation-rational} assume
$E = X_s$ is an effective Cartier divisor.
Let $\mathcal{I}$ be the ideal sheaf of $E$. Then
$H^0(X, \mathcal{I}^n) = \mathfrak m^n$ and
$H^1(X, \mathcal{I}^n) = 0$.
\end{lemma}

\begin{proof}
We have $H^0(X, \mathcal{O}_X) = A$, see discussion following
Situation \ref{situation-vanishing}. Then
$\mathfrak m \subset H^0(X, \mathcal{I}) \subset H^0(X, \mathcal{O}_X)$.
The second inclusion is not an equality as $X_s \not = \emptyset$.
Thus $H^0(X, \mathcal{I}) = \mathfrak m$.
As $\mathcal{I}^n = \mathfrak m^n\mathcal{O}_X$ our
Lemma \ref{lemma-globally-generated} shows that $H^1(X, \mathcal{I}^n) = 0$.

\medskip\noindent
Choose generators $x_1, \ldots, x_{\mu + 1}$ of $\mathfrak m$. These define
global sections of $\mathcal{I}$ which generate it. Hence
a short exact sequence
$$
0 \to \mathcal{F} \to \mathcal{O}_X^{\oplus \mu + 1} \to \mathcal{I} \to 0
$$
Then $\mathcal{F}$ is a finite locally free $\mathcal{O}_X$-module
of rank $\mu$ and $\mathcal{F} \otimes \mathcal{I}$ is globally
generated by Constructions, Lemma
\ref{constructions-lemma-globally-generated-omega-twist-1}.
Hence $\mathcal{F} \otimes \mathcal{I}^n$
is globally generated for all $n \geq 1$. Thus for $n \geq 2$ we can
consider the exact sequence
$$
0 \to \mathcal{F} \otimes \mathcal{I}^{n - 1} \to
(\mathcal{I}^{n - 1})^{\oplus \mu + 1} \to
\mathcal{I}^n \to 0
$$
Applying the long exact sequence of cohomology using that
$H^1(X, \mathcal{F} \otimes \mathcal{I}^{n - 1}) = 0$ by
Lemma \ref{lemma-globally-generated}
we obtain that every
element of $H^0(X, \mathcal{I}^n)$ is of the form $\sum x_i a_i$
for some $a_i \in H^0(X, \mathcal{I}^{n - 1})$. This shows that
$H^0(X, \mathcal{I}^n) = \mathfrak m^n$ by induction.
\end{proof}

\begin{lemma}
\label{lemma-blow-up-normal-rational}
In Situation \ref{situation-rational} assume $A$ is Nagata. Then
the blow up of $\Spec(A)$ in $\mathfrak m$ is normal.
\end{lemma}

\begin{proof}
Let $X' \to \Spec(A)$ be the blow up, in other words
$$
X' = \text{Proj}(A \oplus \mathfrak m \oplus \mathfrak m^2 \oplus \ldots).
$$
is the Proj of the Rees algebra. This in particular shows that
$X'$ is integral and that $X' \to \Spec(A)$ is a projective
modification. Let $X$ be the normalization of $X'$.
Since $A$ is Nagata, we see that $\nu : X \to X'$ is finite
(Morphisms, Lemma \ref{morphisms-lemma-nagata-normalization}).
Let $E' \subset X'$ be the exceptional divisor and let $E \subset X$
be the inverse image. Let $\mathcal{I}' \subset \mathcal{O}_{X'}$
and $\mathcal{I} \subset \mathcal{O}_X$ be their ideal sheaves.
Recall that $\mathcal{I}' = \mathcal{O}_{X'}(1)$
(Divisors, Lemma \ref{divisors-lemma-blowing-up-projective}).
Observe that $\mathcal{I} = \nu^*\mathcal{I}'$ and that $E$ is an
effective Cartier divisor (Divisors, Lemma
\ref{divisors-lemma-pullback-effective-Cartier-defined}).
We are trying to show that $\nu$ is an isomorphism. As $\nu$ is finite,
it suffices to show that $\mathcal{O}_{X'} \to \nu_*\mathcal{O}_X$
is an isomorphism. If not, then we can find an $n \geq 0$ such that
$$
H^0(X', (\mathcal{I}')^n) \not =
H^0(X', (\nu_*\mathcal{O}_X) \otimes (\mathcal{I}')^n)
$$
for example because we can recover quasi-coherent $\mathcal{O}_{X'}$-modules
from their associated graded modules, see
Properties, Lemma \ref{properties-lemma-ample-quasi-coherent}.
By the projection formula we have
$$
H^0(X', (\nu_*\mathcal{O}_X) \otimes (\mathcal{I}')^n) =
H^0(X, \nu^*(\mathcal{I}')^n) =
H^0(X, \mathcal{I}^n) = \mathfrak m^n
$$
the last equality by Lemma \ref{lemma-sections-powers-I-rational}.
On the other hand, there is clearly an injection
$\mathfrak m^n \to H^0(X', (\mathcal{I}')^n)$. Since
$H^0(X', (\mathcal{I}')^n)$ is torsion free we conclude equality holds
for all $n$, hence $X = X'$.
\end{proof}

\begin{lemma}
\label{lemma-cohomology-blow-up-rational}
In Situation \ref{situation-rational} assume $A$ is Nagata.
Let $X$ be the blow up of $\Spec(A)$ in $\mathfrak m$. Let $E \subset X$
be the exceptional divisor. With $\mathcal{O}_X(1) = \mathcal{I}$ as
usual and $\mathcal{O}_E(1) = \mathcal{O}_X(1)|_E$ we have
\begin{enumerate}
\item $E$ is a proper Cohen-Macaulay curve over $\kappa$.
\item $\mathcal{O}_E(1)$ is very ample
\item $\deg(\mathcal{O}_E(1)) \geq 1$ and equality holds only if
$A$ is a regular local ring,
\item $H^1(E, \mathcal{O}_E(n)) = 0$ for $n \geq 0$, and
\item $H^0(E, \mathcal{O}_E(n)) = \mathfrak m^n/\mathfrak m^{n + 1}$
for $n \geq 0$.
\end{enumerate}
\end{lemma}

\begin{proof}
Since $\mathcal{O}_X(1)$ is very ample by construction, we see that
its restriction to the special fibre $E$ is very ample as well.
By Lemma \ref{lemma-blow-up-normal-rational} the scheme $X$ is normal.
Then $E$ is Cohen-Macaulay by
Divisors, Lemma \ref{divisors-lemma-normal-effective-Cartier-divisor-S1}.
Lemma \ref{lemma-sections-powers-I-rational} applies and we obtain
(4) and (5) from the exact sequences
$$
0 \to \mathcal{I}^{n + 1} \to \mathcal{I}^n \to i_*\mathcal{O}_E(n) \to 0
$$
and the long exact cohomology sequence. In particular, we see that
$$
\deg(\mathcal{O}_E(1)) = \chi(E, \mathcal{O}_E(1)) - \chi(E, \mathcal{O}_E) =
\dim(\mathfrak m/\mathfrak m^2) - 1
$$
by Varieties, Definition \ref{varieties-definition-degree-invertible-sheaf}.
Thus (3) follows as well.
\end{proof}

\begin{lemma}
\label{lemma-double-dual-rational}
In Situation \ref{situation-rational}. Let $M$ be a finite reflexive
$A$-module. Let $M \otimes_A \mathcal{O}_X$ denote the pullback of the
associated $\mathcal{O}_S$-module. Then $M \otimes_A \mathcal{O}_X$ maps
onto its double dual.
\end{lemma}

\begin{proof}
Let $\mathcal{F} = (M \otimes_A \mathcal{O}_X)^{**}$ be the double dual and
let $\mathcal{F}' \subset \mathcal{F}$ be the image of the evaluation map
$M \otimes_A \mathcal{O}_X \to \mathcal{F}$. Then we have a short exact
sequence
$$
0 \to \mathcal{F}' \to \mathcal{F} \to \mathcal{Q} \to 0
$$
Since $X$ is normal, the local rings $\mathcal{O}_{X, x}$ are discrete
valuation rings for points of codimension $1$ (see
Properties, Lemma \ref{properties-lemma-criterion-normal}).
Hence $\mathcal{Q}_x = 0$ for such points by
More on Algebra, Lemma \ref{more-algebra-lemma-cokernel-map-double-dual-dvr}.
Thus $\mathcal{Q}$ is supported in finitely many closed points and is
globally generated by
Cohomology of Schemes, Lemma \ref{coherent-lemma-coherent-support-dimension-0}.
We obtain the exact sequence
$$
0 \to H^0(X, \mathcal{F}') \to H^0(X, \mathcal{F}) \to H^0(X, \mathcal{Q}) \to 0
$$
because $\mathcal{F}'$ is generated by global sections
(Lemma \ref{lemma-globally-generated}).
Since $X \to \Spec(A)$ is an isomorphism over the complement of the
closed point, and since $M$ is reflexive, we see that the maps
$$
M \to H^0(X, \mathcal{F}') \to H^0(X, \mathcal{F})
$$
induce isomorphisms after localization at any nonmaximal prime of $A$.
Hence these maps are isomorphisms by More on Algebra, Lemma
\ref{more-algebra-lemma-check-isomorphism-via-depth-and-ass}
and the fact that reflexive modules over normal rings have property $(S_2)$
(More on Algebra, Lemma \ref{more-algebra-lemma-reflexive-over-normal}).
Thus we conclude that $\mathcal{Q} = 0$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-dualizing-blow-up-rational}
In Situation \ref{situation-rational} assume $A$ is Nagata, has a
dualizing complex $\omega_A^\bullet$, and is not regular.
Let $X$ be the blow up of $\Spec(A)$ in $\mathfrak m$. Let $\omega_X$
be the dualizing module of $X$
(Dualizing Complexes, Example \ref{dualizing-example-proper-over-local}).
Then
\begin{enumerate}
\item $H^1(X, \omega_X(n)) = 0$ for $n \geq 0$,
\item the trace map $H^0(X, \omega_X) \to \omega_A$ is an isomorphism,
\item $\omega_X$ is globally generated.
\end{enumerate}
\end{lemma}

\begin{proof}
We will use the results of Lemma \ref{lemma-cohomology-blow-up-rational}
without further mention. Observe that
$\omega_E = \omega_X|_E \otimes \mathcal{O}_E(-1)$
by Dualizing, Lemmas
\ref{dualizing-lemma-sheaf-with-exact-support-effective-Cartier} and
\ref{dualizing-lemma-twisted-inverse-image-closed}. Thus
$\omega_X|_E = \omega_E(1)$. Consider the short exact sequences
$$
0 \to \omega_X(n + 1) \to \omega_X(n) \to i_*\omega_E(n + 1) \to 0
$$
By Dualizing, Lemma \ref{dualizing-lemma-vanishing-twist}
we see that $H^1(E, \omega_E(n + 1)) = 0$ for $n \geq 0$.
Thus we see that the maps
$$
\ldots \to H^1(X, \omega_X(2)) \to H^1(X, \omega_X(1)) \to H^1(X, \omega_X)
$$
are surjective. Since $H^1(X, \omega_X(n))$ is zero for $n \gg 0$
(Cohomology of Schemes, Lemma \ref{coherent-lemma-kill-by-twisting})
we conclude that (1) holds.

\medskip\noindent
By Grauert-Riemenschneider
(Proposition \ref{proposition-Grauert-Riemenschneider}), we see that
$Rf_*\omega_X = f_*\omega_X$. By duality we have a short exact
sequence
$$
0 \to f_*\omega_X \to \omega_A \to
\text{Ext}^2_A(R^1f_*\mathcal{O}_X, \omega_A) \to 0
$$
(for example see proof of Lemma \ref{lemma-bound-dualizing-implies-bound})
and since $A$ defines a rational singularity we obtain
$f_*\omega_X = \omega_A$. Thus (2) holds.

\medskip\noindent
By Dualizing, Lemma
\ref{dualizing-lemma-tensor-omega-with-globally-generated-invertible}
we see that $\omega_X|_E = \omega_E \otimes \mathcal{O}_E(1)$
is globally generated. Since we seen above that
$H^1(X, \omega_X(1)) = 0$ the map $H^0(X, \omega_X) \to H^0(E, \omega_X|_E)$
is surjective. We conclude that $\omega_X$ is globally generated
hence (3) holds.
\end{proof}






\section{Examples}
\label{section-examples}

\noindent
Some examples related to the results earlier in this chapter.

\begin{example}
\label{example-factorial}
\begin{reference}
\cite[4(c)]{Samuel-UFD}
\end{reference}
Let $k$ be a field. The ring $A = k[x, y, z]/(x^r + y^s + z^t)$
is a UFD for $r, s, t$ pairwise coprime integers. Namely, since
$x^r + y^s + z^t$ is irreducible $A$ is a domain. The element $z$
is a prime element, i.e., generates a prime ideal in $A$.
On the other hand, if $r = 1 + ers$ for some $e$, then
$$
A[1/z] \cong k[x', y', 1/z]
$$
where $x' = x/z^{es}$, $y' = y/z^{et}$ and $z = (x')^r + (y')^s$.
Thus $A[1/z]$ is a localization of a polynomial ring and hence
a UFD. It follows from an argument of Nagata that $A$ is a UFD.
See Algebra, Lemma \ref{algebra-lemma-invert-prime-elements}.
A similar argument can be given if $r$ is not congruent to $1$
modulo $rs$.
\end{example}

\begin{example}
\label{example-completion-not-factorial}
\begin{reference}
See \cite{Brieskorn} and \cite{Lipman-rational} for nonvanishing of
local Picard groups in general.
\end{reference}
The ring $A = \mathbf{C}[[x, y, z]]/(x^r + y^s + z^t)$
is not a UFD when $r < s < t$ are pairwise coprime integers
and not equal to $2, 3, 5$. For example consider the special
case $A = \mathbf{C}[[x, y, z]]/(x^2 + y^5 + z^7)$.
Consider the maps
$$
\psi_\zeta : \mathbf{C}[[x, y, z]]/(x^2 + y^5 + z^7) \to \mathbf{C}[[t]]
$$
given by
$$
x \mapsto t^7,\quad
y \mapsto t^3,\quad
z \mapsto -\zeta t^2(1 + t)^{1/7}
$$
where $\zeta$ is a $7$th root of unity. The kernel $\mathfrak p_\zeta$
of $\psi_\zeta$ is a height one prime, hence if $A$ is a UFD, then
it is principal, say given by $f_\zeta \in \mathbf{C}[[x, y, z]]$.
Note that $V(x^3 - y^7) = \bigcup V(\mathfrak p_\zeta)$
and $A/(x^3 - y^7)$ is reduced away from the closed point. Hence,
still assuming $A$ is a UFD, we would obtain
$$
\prod\nolimits_\zeta f_\zeta = u(x^3 - y^7) + a(x^2 + y^5 + z^7)
\quad\text{in}\quad
\mathbf{C}[[x, y, z]]
$$
for some unit $u \in \mathbf{C}[[x, y, z]]$ and some
element $a \in \mathbf{C}[[x, y, z]]$. After scaling by a constant
we may assume $u(0, 0, 0) = 1$. Note that the left hand side vanishes to
order $7$. Hence $a = - x \bmod \mathfrak m^2$. But then we get a term
$xy^5$ on the right hand side which does not occur on the left
hand side. A contradiction.
\end{example}

\begin{example}
\label{example-not-blow-up}
There exists an excellent $2$-dimensional Noetherian local ring
and a modification $X \to S = \Spec(A)$ which is not a scheme.
We sketch a construction. Let $X$ be a normal surface over $\mathbf{C}$
with a unique singular point $x \in X$. Assume that there exists a
resolution $\pi : X' \to X$ such that the exceptional fibre
$C = \pi^{-1}(x)_{red}$ is a smooth projective curve. Furthermore, assume
there exists a point $c \in C$ such that if $\mathcal{O}_C(nc)$
is in the image of $\text{Pic}(X') \to \text{Pic}(C)$, then $n = 0$.
Then we let $X'' \to X'$ be the blowing up in the nonsingular point $c$.
Let $C' \subset X''$ be the strict transform of $C$ and let $E \subset X''$
be the exceptional fibre. By Artin's results
(\cite{ArtinII}; use for example \cite{Mumford-topology}
to see that the normal bundle of $C'$ is negative)
we can blow down the curve $C'$ in $X''$ to obtain an algebraic space $X'''$.
Picture
$$
\xymatrix{
& X'' \ar[ld] \ar[rd] \\
X' \ar[rd] &  & X''' \ar[ld] \\
& X
}
$$
We claim that $X'''$ is not a scheme. This provides us with our example
because $X'''$ is a scheme if and only if the base change of $X'''$
to $A = \mathcal{O}_{X, x}$ is a scheme (details omitted).
If $X'''$ where a scheme, then the image of $C'$ in $X'''$ would
have an affine neighbourhood. The complement of this neighbourhood
would be an effective Cartier divisor on $X'''$ (because $X'''$ is
nonsingular apart from $1$ point). This effective Cartier divisor would
correspond to an effective Cartier divisor on $X''$
meeting $E$ and avoiding $C'$. Taking the image in $X'$ we obtain
an effective Cartier divisor meeting $C$ (set theoretically) in $c$.
This is impossible as no multiple of $c$ is the restriction of a Cartier
divisor by assumption.

\medskip\noindent
To finish we have to find such a singular surface $X$. We can just take
$X$ to be the affine surface given by
$$
x^3 + y^3 + z^3 + x^4 + y^4 + z^4 = 0
$$
in $\mathbf{A}^3_\mathbf{C} = \Spec(\mathbf{C}[x, y, z])$ and singular point
$(0, 0, 0)$. Then $(0, 0, 0)$ is the only singular point. Blowing up $X$
in the maximal ideal corresponding to $(0, 0, 0)$ we find three charts each
isomorphic to the smooth affine surface
$$
1 + s^3 + t^3 + x(1 + s^4 + t^4) = 0
$$
which is nonsingular with exceptional divisor $C$ given by $x = 0$. The reader
will recognize $C$ as an elliptic curve. Finally, the surface $X$ is rational
as projection from $(0, 0, 0)$ shows, or because in the equation for the
blow up we can solve for $x$. Finally, the Picard group of a nonsingular
rational surface is countable, whereas the Picard group of an elliptic
curve over the complex numbers is uncountable. Hence we can find a closed
point $c$ as indicated.
\end{example}








\input{chapters}

\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}
