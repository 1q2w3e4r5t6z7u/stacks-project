\input{preamble}

% OK, start here.
%
\begin{document}

\title{Resolution of Surfaces; UNDER CONSTRUCTION}


\maketitle

\phantomsection
\label{section-phantom}

\tableofcontents

\section{Introduction}
\label{section-introduction}

\noindent
This chapter discusses resolution of singularities of surfaces
following Lipman \cite{Lipman} and following the exposition
in \cite{Artin-Lipman}.





\section{A trace map in positive characteristic}
\label{section-trace}

\noindent
In this section $p$ will be a prime number. Let $R$ be an
$\mathbf{F}_p$-algebra. Let $M$ be an $R$-module and let $D : R \to M$ be a
derivation. Given an $a \in R$ set $A = R[x]/(x^p - a)$.
Define an $R$-linear map
$$
\text{Tr}_{x, D} : \Omega_{A/R} \longrightarrow M
$$
by the rule
$$
x^i\text{d}x \longmapsto
\left\{
\begin{matrix}
0 & \text{if} & 0 \leq i \leq p - 2, \\
D(a) & \text{if} & i = p - 1
\end{matrix}
\right.
$$
This makes sense as $\Omega_{A/R}$ is a free $R$-module with
basis $x^i\text{d}x$, $0 \leq i \leq p - 1$.
The following lemma implies that the trace map is well defined,
i.e., independent of the choice of the coordinate $x$.

\begin{lemma}
\label{lemma-trace-well-defined}
Let $\varphi : R[x]/(x^p - a) \to R[y]/(y^p - b)$ be an $R$-algebra
homomorphism. Then
$\text{Tr}_{x, D} = \text{Tr}_{y, D} \circ \varphi$.
\end{lemma}

\begin{proof}
Say $\varphi(x) = \lambda_0 + \lambda_1 y + \ldots + \lambda_{p - 1}y^{p - 1}$
with $\lambda_i \in R$. The condition that mapping $x$ to
$\lambda_0 + \lambda_1 y + \ldots + \lambda_{p - 1}y^{p - 1}$
induces an $R$-algebra homomorphism $R[x]/(x^p - a) \to R[y]/(y^p - b)$
is equivalent to the condition that
$$
a = \lambda_0^p + \lambda_1^p b + \ldots + \lambda_{p - 1}^pb^{p - 1}
$$
in the ring $R$. Consider the polynomial ring
$$
R_{univ} = \mathbf{F}_p[b, \lambda_0, \ldots, \lambda_{p - 1}]
$$
with the element
$a = \lambda_0^p + \lambda_1^p b + \ldots + \lambda_{p - 1}^pb^{p - 1}$
and
with its universal derivation given by
$$
D_{univ} = \text{d} :
R_{univ}
\longrightarrow
M_{univ} = \Omega_{R_{univ}/\mathbf{F}_p}
$$
Consider the universal algebra map
$\varphi_{univ} : R_{univ}[x]/(x^p - a) \to R_{univ}[y]/(y^p - b)$
given by mapping $x$ to
$\lambda_0 + \lambda_1 y + \ldots + \lambda_{p - 1}y^{p - 1}$.
We obtain a canonical maps
$$
R_{univ} \longrightarrow R,\quad
M_{univ} \longrightarrow M
$$
compatible with derivations by sending $b, \lambda_i$ to $b, \lambda_i$
and sending $\text{d}b, \text{d}\lambda_i$ to $D(b), D(\lambda_i)$.
By construction the maps
$$
R_{univ}[x]/(x^p - a) \to R[x]/(x^p - a),\quad
R_{univ}[y]/(y^p - b) \to R[y]/(y^p - b)
$$
are compatible with the trace maps. Hence it suffices to prove the
lemma for the map $\varphi_{univ}$. We will do this by evaluating
$\text{Tr}_{y, D}(\varphi(x)^i\text{d}\varphi(x))$ for $i = 0 , \ldots, p - 1$.

\medskip\noindent
The case $0 \leq i \leq p - 2$. Expand
$$
(\lambda_0 + \lambda_1 y + \ldots + \lambda_{p - 1}y^{p - 1})^i
(\lambda_1 + 2 \lambda_2 y + \ldots + (p - 1)\lambda_{p - 1}y^{p - 2})
$$
in the ring $R[y]/(y^p - b)$. We have to show that the coefficient
of $y^{p - 1}$ is zero. For this it suffices to show that
the expression above as a polynomial in $y$ has vanishing
coefficients in front of the powers $y^{pk - 1}$.
Then we write our polynomial as
$$
\frac{\text{d}}{(i + 1)\text{d}y}
(\lambda_0 + \lambda_1 y + \ldots + \lambda_{p - 1}y^{p - 1})^{i + 1}
$$
and indeed the coefficients of $y^{kp - 1}$ are all zero.

\medskip\noindent
The case $i = p - 1$. Expand
$$
(\lambda_0 + \lambda_1 y + \ldots + \lambda_{p - 1}y^{p - 1})^{p - 1}
(\lambda_1 + 2 \lambda_2 y + \ldots + (p - 1)\lambda_{p - 1}y^{p - 2})
$$
in the ring $R[y]/(y^p - b)$. To finish the proof we have to show that
the coefficient of $y^{p - 1}$ times $D(b)$ is $D(a)$. Here we use that
$R$ is $S/pS$ where
$S = \mathbf{Z}[b, \xi_j, \lambda_0, \ldots, \lambda_{p - 1}, \xi_{ij}]$.
Then the above, as a polynomial in $y$, is equal to
$$
\frac{\text{d}}{p\text{d}y}
(\lambda_0 + \lambda_1 y + \ldots + \lambda_{p - 1}y^{p - 1})^p
$$
Since $\frac{\text{d}}{\text{d}y}(y^{pk}) = pk y^{pk - 1}$
it suffices to understand the coefficients of $y^{pk}$ in the polynomial
$(\lambda_0 + \lambda_1 y + \ldots + \lambda_{p - 1}y^{p - 1})^p$
modulo $p$. The sum of these terms gives
$$
\lambda_0^p + \lambda_1^py^p + \ldots + \lambda_{p - 1}^py^{p(p - 1)}
\bmod p
$$
Whence we see that we obtain after applying the operator
$\frac{\text{d}}{p\text{d}y}$ and after reducing modulo $y^p - b$
the value
$$
\lambda_1^p + 2\lambda_2^pb + \ldots + (p - 1)\lambda_{p - 1}b^{p - 2}
$$
for the coefficient of $y^{p - 1}$ we wanted to compute. Now because
$a = \lambda_0^p + \lambda_1^p b + \ldots + \lambda_{p - 1}^pb^{p - 1}$
in $R$ we obtain that
$$
D(a) = (\lambda_1^p  + 2 \lambda_2^p b + \ldots +
(p - 1) \lambda_{p - 1}^p b^{p - 2}) D(b)
$$
in $R$. This proves that the coefficient of $y^{p - 1}$ is as desired.
\end{proof}

\begin{lemma}
\label{lemma-Noetherian-normal-domain-insep-extension}
Let $R$ be a Noetherian normal domain with fraction field $K$.
Let $a \in K$ be an element such that there exists a derivation
$D : R \to R$ with $D(a) \not = 0$. Then the integral closure
of $R$ in $L = K[x]/(x^p - a)$ is finite over $R$.
\end{lemma}

\begin{proof}
After replacing $x$ by $fx$ and $a$ by $f^pa$ for some $f \in R$
we may assume $a \in R$. Hence also $D(a) \in R$. We will show
by induction on $i \leq p - 1$ that if
$$
y = a_0 + a_1x + \ldots + a_i x^i,\quad a_j \in K
$$
is integral over $R$, then $D(a)^i a_j \in R$. Thus the integral
closure is contained in the finite $R$-module with basis
$D(a)^{-p + 1}x^j$, $j = 0, \ldots, p - 1$. Since $R$ is Noetherian
this proves the lemma.

\medskip\noindent
If $i = 0$, then $y = a_0$ is integral over $R$ if and only if $a_0 \in R$
and the statement is true. Suppose the statement holds for some $i < p - 1$
and suppose that
$$
y = a_0 + a_1x + \ldots + a_{i + 1} x^{i + 1},\quad a_j \in K
$$
is integral over $R$. Then
$$
y^p = a_0^p + a_1^p a + \ldots + a_{i + 1}^pa^{i + 1}
$$
is an element of $R$ (as it is in $K$ and integral over $R$). Applying
$D$ we obtain
$$
(a_1^p + 2a_2^p a + \ldots + (i + 1)a_{i + 1}^p a^i)D(a)
$$
is in $R$. Hence it follows that
$$
D(a)a_1 + 2D(a) a_2 x + \ldots + (i + 1)D(a) a_{i + 1} x^i
$$
is integral over $R$. By induction we find $D(a)^{i + 1}a_j \in R$
for $j = 1, \ldots, i + 1$. (Here we use that $1, \ldots, i + 1$
are invertible.) Hence $D(a)^{i + 1}a_0$ is also in $R$ because it
is the difference of $y$ and $\sum_{j > 0} D(a)^{i + 1}a_jx^j$ which
are integral over $R$ (since $x$ is integral over $R$ as $a \in R$).
\end{proof}






\section{Formal glueing of quasi-coherent modules}
\label{section-formal-glueing}

\noindent
This section is the analogue of
More on Algebra, Section \ref{more-algebra-section-formal-glueing}.
In the case of morphisms of schemes, the result can be found in
the paper by Joyet \cite{Joyet}; this is a good place to start reading.
For a discussion of applications to descent problems for stacks, see the
paper by Moret-Bailly \cite{MB}. In the case of an affine
morphism of schemes there is a statement in the appendix of the paper
\cite{Ferrand-Raynaud} but one needs to add the hypothesis
that the closed subscheme is cut out by a finitely generated
ideal (as in the paper by Joyet) since otherwise the result does not hold.
A generalization of this material to (higher) derived categories
with potential applications to nonflat situations
can be found in \cite[Section 5]{Bhatt-Algebraize}.

\medskip\noindent
We start with a lemma on abelian sheaves supported on closed subsets.

\begin{lemma}
\label{lemma-stalk-pushforward-with-support}
Let $S$ be a scheme. Let $f : Y \to X$ be a morphism of algebraic spaces
over $S$. Let $Z \subset X$ closed subspace such that $f^{-1}Z \to Z$ is
integral and universally injective. Let $\overline{y}$ be a geometric point
of $Y$ and $\overline{x} = f(\overline{y})$. We have
$$
(Rf_*Q)_{\overline{x}} = Q_{\overline{y}}
$$
in $D(\textit{Ab})$ for any object $Q$ of $D(Y_\etale)$ supported
on $|f^{-1}Z|$.
\end{lemma}

\begin{proof}
Consider the commutative diagram of algebraic spaces
$$
\xymatrix{
f^{-1}Z \ar[r]_{i'} \ar[d]_{f'} & Y \ar[d]_f \\
Z \ar[r]^i & X
}
$$
By Cohomology of Spaces, Lemma
\ref{spaces-cohomology-lemma-complexes-with-support-on-closed} we can write
$Q = Ri'_*K'$ for some object $K'$ of $D(f^{-1}Z_\etale)$.
By Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-integral-universally-injective-push-pull}
we have $K' = (f')^{-1}K$ with $K = Rf'_*K'$.
Then we have $Rf_*Q = Rf_*Ri'_*K' = Ri_*Rf'_*K' = Ri_*K$.
Let $\overline{z}$ be the geometric point of $Z$ corresponding
to $\overline{x}$ and let $\overline{z}'$ be the geometric point
of $f^{-1}Z$ corresponding to $\overline{y}$. We obtain
the result of the lemma as follows
$$
Q_{\overline{y}} = (Ri'_*K')_{\overline{y}} = K'_{\overline{z}'} =
(f')^{-1}K_{\overline{z}'} = K_{\overline{z}} = Ri_*K_{\overline{x}} =
Rf_*Q_{\overline{x}}
$$
The middle equality holds because of the description of the stalk
of a pullback given in
Properties of Spaces, Lemma \ref{spaces-properties-lemma-stalk-pullback}.
\end{proof}

\begin{lemma}
\label{lemma-stalk-formal-glueing}
Let $S$ be a scheme. Let $f : Y \to X$ be a morphism of algebraic spaces
over $S$. Let $Z \subset X$ closed subspace such that $f^{-1}Z \to Z$ is
integral and universally injective. Let $\overline{y}$ be a geometric point
of $Y$ and $\overline{x} = f(\overline{y})$. Let $\mathcal{G}$
be an abelian sheaf on $Y$. Then the map of two term complexes
$$
\left(f_*\mathcal{G}_{\overline{x}} \to
(f \circ j')_*(\mathcal{G}|_V)_{\overline{x}}\right)
\longrightarrow
\left(\mathcal{G}_{\overline{y}} \to j'_*(\mathcal{G}|_V)_{\overline{y}}\right)
$$
induces an isomorphism on kernels and an injection on cokernels.
Here $V = Y \setminus f^{-1}Z$ and $j' : V \to Y$ is the inclusion.
\end{lemma}

\begin{proof}
Choose a distinguished triangle
$$
\mathcal{G} \to Rj'_*\mathcal{G}|_V \to Q \to \mathcal{G}[1]
$$
n $D(Y_\etale)$. The cohomology sheaves of $Q$
are supported on $|f^{-1}Z|$. We apply $Rf_*$ and we obtain
$$
Rf_*\mathcal{G} \to Rf_*Rj'_*\mathcal{G}|_V \to Rf_*Q
\to Rf_*\mathcal{G}[1]
$$
Taking stalks at $\overline{x}$ we obtain an exact sequence
$$
0 \to
(R^{-1}f_*Q)_{\overline{x}} \to
f_*\mathcal{G}_{\overline{x}} \to
(f \circ j')_*(\mathcal{G}|_V)_{\overline{x}} \to
(R^0f_*Q)_{\overline{x}}
$$
We can compare this with the exact sequence
$$
0 \to
H^{-1}(Q)_{\overline{y}} \to
\mathcal{G}_{\overline{y}} \to
j'_*(\mathcal{G}|_V)_{\overline{y}} \to
H^0(Q)_{\overline{y}}
$$
Thus we see that the lemma follows because
$Q_{\overline{y}} = Rf_*Q_{\overline{x}}$ by
Lemma \ref{lemma-stalk-pushforward-with-support}.
\end{proof}

\begin{lemma}
\label{lemma-stalk-of-pushforward}
Let $S$ be a scheme. Let $X$ be an algebraic space over $S$.
Let $f : Y \to X$ be a quasi-compact and quasi-separated morphism.
Let $\overline{x}$ be a geometric point of $X$ and let
$\Spec(\mathcal{O}_{X, \overline{x}}) \to X$
be the canonical morphism. For a quasi-coherent module
$\mathcal{G}$ on $Y$ we have
$$
f_*\mathcal{G}_{\overline{x}} =
\Gamma(Y \times_X \Spec(\mathcal{O}_{X, \overline{x}}), p^*\mathcal{F})
$$
where $p : Y \times_X \Spec(\mathcal{O}_{X, \overline{x}}) \to Y$
is the projection.
\end{lemma}

\begin{proof}
Observe that $f_*\mathcal{G}_{\overline{x}} =
\Gamma(\Spec(\mathcal{O}_{X, \overline{x}}), h^*f_*\mathcal{G})$
where $h : \Spec(\mathcal{O}_{X, \overline{x}}) \to X$.
Hence the result is true because $h$ is flat so that
Cohomology of Spaces, Lemma
\ref{spaces-cohomology-lemma-flat-base-change-cohomology}
applies.
\end{proof}

\begin{lemma}
\label{lemma-stalk-of-module-with-support}
Let $S$ be a scheme. Let $X$ be an algebraic space over $S$.
Let $i : Z \to X$ be a closed immersion of finite presentation.
Let $Q \in D_\QCoh(\mathcal{O}_X)$ be supported on $|Z|$.
Let $\overline{x}$ be a geometric point of $X$ and let
$I_{\overline{x}} \subset \mathcal{O}_{X, \overline{x}}$ be the stalk of
the ideal sheaf of $Z$. Then the cohomology modules
$H^n(Q_{\overline{x}})$ are $I_{\overline{x}}$-power torsion
(see More on Algebra, Definition
\ref{more-algebra-definition-f-power-torsion}).
\end{lemma}

\begin{proof}
Choose an affine scheme $U$ and an \'etale morphism $U \to X$ such
that $\overline{x}$ lifts to a geometric point $\overline{u}$
of $U$. Then we can replace $X$ by $U$, $Z$ by $U \times_X Z$,
$Q$ by the restriction $Q|_U$, and $\overline{x}$ by $\overline{u}$.
Thus we may assume that $X = \Spec(A)$ is affine. Let $I \subset A$
be the ideal defining $Z$. Since $i : Z \to X$ is of finite presentation,
the ideal $I = (f_1, \ldots, f_r)$ is finitely generated.
The object $Q$ comes from a complex of $A$-modules $M^\bullet$, see
Derived Categories of Spaces, Lemma
\ref{spaces-perfect-lemma-derived-quasi-coherent-small-etale-site}
and
Derived Categories of Schemes, Lemma
\ref{perfect-lemma-affine-compare-bounded}.
Since the cohomology sheaves of $Q$ are supported on $Z$
we see that the localization $M^\bullet_f$ is acyclic for each $f \in I$.
Take $x \in H^p(M^\bullet)$. By the above we can find $n_i$ such
that $f_i^{n_i} x = 0$ in $H^p(M^\bullet)$ for each $i$.
Then with $n = \sum n_i$ we see that $I^n$ annihilates $x$.
Thus $H^p(M^\bullet)$ is $I$-power torsion. Since the ring
map $A \to \mathcal{O}_{X, \overline{x}}$ is flat and since
$I_{\overline{x}} = I\mathcal{O}_{X, \overline{x}}$ we conclude.
\end{proof}

\begin{lemma}
\label{lemma-formal-glueing-on-closed}
Let $S$ be a scheme. Let $f : Y \to X$ be a morphism of algebraic spaces
over $S$. Let $Z \subset X$ be a closed subspace. Assume $f^{-1}Z \to Z$
is an isomorphism and that $f$ is flat in every point of $f^{-1}Z$. For any
$Q$ in $D_\QCoh(\mathcal{O}_Y)$ supported on $|f^{-1}Z|$ we have
$Lf^*Rf_*Q = Q$.
\end{lemma}

\begin{proof}
We show the canonical map $Lf^*Rf_*Q \to Q$ is an isomorphism
by checking on stalks at $\overline{y}$. If $\overline{y}$ is not
in $f^{-1}Z$, then both sides are zero and the result is true.
Assume the image $\overline{x}$ of $\overline{y}$ is in $Z$.
By Lemma \ref{lemma-stalk-pushforward-with-support} we have
$Rf_*Q_{\overline{x}} = Q_{\overline{y}}$ and since $f$ is flat
at $\overline{y}$ we see that
$$
(Lf^*Rf_*Q)_{\overline{y}} =
(Rf_*Q)_{\overline{x}}
\otimes_{\mathcal{O}_{X, \overline{x}}}
\mathcal{O}_{Y, \overline{y}} =
Q_{\overline{y}} \otimes_{\mathcal{O}_{X, \overline{x}}}
\mathcal{O}_{Y, \overline{y}}
$$
Thus we have to check that the canonical map
$$
Q_{\overline{y}} \otimes_{\mathcal{O}_{X, \overline{x}}}
\mathcal{O}_{Y, \overline{y}}
\longrightarrow Q_{\overline{y}}
$$
is an isomorphism in the derived category. Let
$I_{\overline{x}} \subset \mathcal{O}_{X, \overline{x}}$ be the
stalk of the ideal sheaf defining $Z$. Since $Z \to X$ is locally of
finite presentation this ideal is finitely generated and the
cohomology groups of $Q_{\overline{y}}$
are $I_{\overline{y}} = I_{\overline{x}}\mathcal{O}_{Y, \overline{y}}$-power
torsion by Lemma \ref{lemma-stalk-of-module-with-support} applied to $Q$ on $Y$.
It follows that they are also $I_{\overline{x}}$-module torsion.
The ring map
$\mathcal{O}_{X, \overline{x}} \to \mathcal{O}_{Y, \overline{y}}$
is flat and induces an isomorphism after dividing by
$I_{\overline{x}}$ and $I_{\overline{y}}$ because we assumed
that $f^{-1}Z \to Z$ is an isomorphism. Hence we see that
the cohomology modules of
$Q_{\overline{y}} \otimes_{\mathcal{O}_{X, \overline{x}}}
\mathcal{O}_{Y, \overline{y}}$
are equal to the cohomology modules of $Q_{\overline{y}}$ by
More on Algebra, Lemma \ref{more-algebra-lemma-neighbourhood-isomorphism}
which finishes the proof.
\end{proof}

\begin{situation}
\label{situation-formal-glueing}
Here $S$ is a base scheme, $f : Y \to X$ is a quasi-compact
and quasi-separated morphism of algebraic spaces over $S$, and
$Z \to X$ is a closed immersion of finite presentation. We assume that
$f^{-1}(Z) \to Z$ is an isomorphism and that $f$ is flat in every
point $x \in |f^{-1}Z|$. We set $U = X \setminus Z$ and
$V = Y \setminus f^{-1}(Z)$.
Picture
$$
\xymatrix{
V \ar[r]_{j'} \ar[d]_{f|_V} & Y \ar[d]^f \\
U \ar[r]^j & X
}
$$
\end{situation}

\noindent
In Situation \ref{situation-formal-glueing} we define
$\textit{QCoh}(Y \to X, Z)$ as the category of
triples $(\mathcal{H}, \mathcal{G}, \varphi)$ where
$\mathcal{H}$ is a quasi-coherent sheaf of
$\mathcal{O}_U$-modules, $\mathcal{G}$ is a quasi-coherent sheaf
of $\mathcal{O}_Y$-modules, and
$\varphi : f^*\mathcal{H} \to \mathcal{G}|_V$ is an isomorphism
of $\mathcal{O}_V$-modules. There is a canonical
functor
\begin{equation}
\label{equation-formal-glueing-modules}
\QCoh(\mathcal{O}_X) \longrightarrow \textit{QCoh}(Y \to X, Z)
\end{equation}
which maps $\mathcal{F}$ to the system
$(\mathcal{F}|_U, f^*\mathcal{F}, can)$.
By analogy with the proof given in the affine case, we construct
a functor in the opposite direction. To an object
$(\mathcal{H}, \mathcal{G}, \varphi)$ we assign the $\mathcal{O}_X$-module
\begin{equation}
\label{equation-reverse}
\Ker(j_*\mathcal{H} \oplus f_*\mathcal{G} \to (f \circ j')_*\mathcal{G}|_V)
\end{equation}
Observe that $j$ and $j'$ are quasi-compact morphisms as
$Z \to X$ is of finite presentation. Hence $f_*$, $j_*$, and $(f \circ j')_*$
transform quasi-coherent modules into quasi-coherent modules
(Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-pushforward}).
Thus the module (\ref{equation-reverse}) is quasi-coherent.

\begin{lemma}
\label{lemma-adjoint}
In Situation \ref{situation-formal-glueing}.
The functor (\ref{equation-reverse}) is the right adjoint to
the functor \ref{equation-formal-glueing-modules}).
\end{lemma}

\begin{proof}
This follows easily from the adjointness of $f^*$ to $f_*$
and $j^*$ to $j_*$. Details omitted.
\end{proof}

\begin{lemma}
\label{lemma-reverse-commutes-with-flat-base-change}
In Situation \ref{situation-formal-glueing}.
Let $X' \to X$ be a flat morphism of algebraic spaces.
Set $Z' = X' \times_X Z$ and $Y' = X' \times_X Y$.
The pullbacks $\QCoh(\mathcal{O}_X) \to \QCoh(\mathcal{O}_{X'})$
and $\QCoh(Y \to X, Z) \to \QCoh(Y' \to X', Z')$ are compatible
with the functors (\ref{equation-reverse}) and
\ref{equation-formal-glueing-modules}).
\end{lemma}

\begin{proof}
This is true because pullback commutes with pullback and because
flat pullback commutes with pushforward along quasi-compact
and quasi-separated morphisms, see
Cohomology of Spaces, Lemma
\ref{spaces-cohomology-lemma-flat-base-change-cohomology}.
\end{proof}

\begin{proposition}
\label{proposition-formal-glueing-modules}
In Situation \ref{situation-formal-glueing} the functor
(\ref{equation-formal-glueing-modules}) is an equivalence
with quasi-inverse given by (\ref{equation-reverse}).
\end{proposition}

\begin{proof}
We first treat the special case where $X$ and $Y$ are affine schemes
and where the morphism $f$ is flat. Say $X = \Spec(R)$ and $Y = \Spec(S)$.
Then $f$ corresponds to a flat ring map $R \to S$. Moreover, $Z \subset X$
is cut out by a finitely generated ideal $I \subset R$. Choose generators
$f_1, \ldots, f_t \in I$. By the description of quasi-coherent modules
in terms of modules
(Schemes, Section \ref{schemes-section-quasi-coherent-affine}),
we see that the category $\textit{QCoh}(Y \to X, Z)$
is canonically equivalent to the category
$\text{Glue}(R \to S, f_1, \ldots, f_t)$
of More on Algebra, Remark \ref{more-algebra-remark-glueing-data}
such that the functors
(\ref{equation-formal-glueing-modules}) and (\ref{equation-reverse})
correspond to the functors $\text{Can}$ and $H^0$.
Hence the result follows from
More on Algebra, Proposition \ref{more-algebra-proposition-equivalence}
in this case.

\medskip\noindent
We return to the general case.
Let $\mathcal{F}$ be a quasi-coherent module on $X$.
We will show that
$$
\alpha :
\mathcal{F}
\longrightarrow
\Ker\left(j_*\mathcal{F}|_U \oplus f_*f^*\mathcal{F} \to
(f \circ j')_*f^*\mathcal{F}|_V\right)
$$
is an isomorphism. Let $(\mathcal{H}, \mathcal{G}, \varphi)$
be an object of $\QCoh(Y \to X, Z)$. We will show that
$$
\beta :
f^*\Ker\left(
j_*\mathcal{H} \oplus f_*\mathcal{G} \to (f \circ j')_*\mathcal{G}|_V
\right)
\longrightarrow
\mathcal{G}
$$
and
$$
\gamma :
j^*\Ker\left(
j_*\mathcal{H} \oplus f_*\mathcal{G} \to (f \circ j')_*\mathcal{G}|_V
\right)
\longrightarrow
\mathcal{H}
$$
are isomorphisms. To see these statements are true it suffices to
look at stalks. Let $\overline{y}$ be a geometric point of $Y$ mapping
to the geometric point $\overline{x}$ of $X$.

\medskip\noindent
Fix an object $(\mathcal{H}, \mathcal{G}, \varphi)$ of $\QCoh(Y \to X, Z)$.
By Lemma \ref{lemma-stalk-formal-glueing}
and a diagram chase (omitted) the canonical map
$$
\Ker(j_*\mathcal{H} \oplus f_*\mathcal{G} \to
(f \circ j')_*\mathcal{G}|_V)_{\overline{x}}
\longrightarrow
\Ker(
j_*\mathcal{H}_{\overline{x}} \oplus \mathcal{G}_{\overline{y}}
\to
j'_*\mathcal{G}_{\overline{y}}
)
$$
is an isomorphism.

\medskip\noindent
In particular, if $\overline{y}$ is a geometric point of $V$, then
we see that $j'_*\mathcal{G}_{\overline{y}} = \mathcal{G}_{\overline{y}}$
and hence that this kernel is equal to $\mathcal{H}_{\overline{x}}$.
This easily implies that $\alpha_{\overline{x}}$, $\beta_{\overline{x}}$,
and $\beta_{\overline{y}}$ are isomorphisms in this case.

\medskip\noindent
Next, assume that $\overline{y}$ is a point of $f^{-1}Z$.
Let $I_{\overline{x}} \subset \mathcal{O}_{X, \overline{x}}$,
resp.\ $I_{\overline{y}} \subset \mathcal{O}_{Y, \overline{y}}$
be the stalk of the ideal cutting out $Z$, resp.\ $f^{-1}Z$.
Then $I_{\overline{x}}$ is a finitely generated ideal,
$I_{\overline{y}} = I_{\overline{x}}\mathcal{O}_{Y, \overline{y}}$,
and $\mathcal{O}_{X, \overline{x}} \to \mathcal{O}_{Y, \overline{y}}$
is a flat local homomorphism inducing an isomorphism
$\mathcal{O}_{X, \overline{x}}/I_{\overline{x}} =
\mathcal{O}_{Y, \overline{y}}/I_{\overline{y}}$.
At this point we can bootstrap using the diagram of categories
$$
\xymatrix{
\QCoh(\mathcal{O}_X) \ar[r]_-{(\ref{equation-formal-glueing-modules})} \ar[d] &
\QCoh(Y \to X, Z) \ar[d] \ar@/_2pc/[l]^{(\ref{equation-reverse})} \\
\text{Mod}_{\mathcal{O}_{X, \overline{x}}} \ar[r]^-{\text{Can}} &
\text{Glue}(\mathcal{O}_{X, \overline{x}} \to \mathcal{O}_{Y, \overline{y}},
f_1, \ldots, f_t) \ar@/^2pc/[l]_{H^0}
}
$$
Namely, as in the first paragraph of the proof we identify
$$
\text{Glue}(\mathcal{O}_{X, \overline{x}} \to \mathcal{O}_{Y, \overline{y}},
f_1, \ldots, f_t)
=
\QCoh(\Spec(\mathcal{O}_{Y, \overline{y}}) \to
\Spec(\mathcal{O}_{X, \overline{x}}), V(I_{\overline{x}}))
$$
The right vertical functor is given by pullback, and it is clear that
the inner square is commutative. Our computation of the stalk of the
kernel in the third paragraph of the proof combined with
Lemma \ref{lemma-stalk-of-pushforward} implies that
the outer square (using the curved arrows) commutes. Thus we
conclude using the case of a flat morphism of affine schemes
which we handled in the first paragraph of the proof.
\end{proof}

\begin{lemma}
\label{lemma-dominate-by-fpqc-covering}
In Situation \ref{situation-formal-glueing} there exists an
fpqc covering $\{X_i \to X\}_{i \in I}$ refining the
family $\{U \to X, Y \to X\}$.
\end{lemma}

\begin{proof}
For the definition and general properties of fpqc coverings we refer to
Topologies, Section \ref{topologies-section-fpqc}. In particular, we can
first choose an \'etale covering $\{X_i \to X\}$ with $X_i$ affine and by
base changing $Y$, $Z$, and $U$ to each $X_i$ we reduce to the case where
$X$ is affine. In this case $U$ is quasi-compact and hence a finite union
$U = U_1 \cup \ldots \cup U_n$ of affine opens. 
Then $Z$ is quasi-compact hence also $f^{-1}Z$ is quasi-compact.
Thus we can choose an affine scheme $W$ and an \'etale morphism
$h : W \to Y$ such that $h^{-1}f^{-1}Z \to f^{-1}Z$ is surjective.
Say $W = \Spec(B)$ and $h^{-1}f^{-1}Z = V(J)$ where $J \subset B$
is an ideal of finite type.
By Pro-\'etale Cohomology, Lemma \ref{proetale-lemma-localization}
there exists a localization $B \to B'$ such that points of
$\Spec(B')$ correspond exactly to points of $W = \Spec(B)$
specializing to $h^{-1}f^{-1}Z = V(J)$. It follows that the
composition $\Spec(B') \to \Spec(B) = W \to Y \to X$ is flat
as by assumption $f : Y \to X$ is flat at all the points of $f^{-1}Z$. Then
$\{\Spec(B') \to X, U_1 \to X, \ldots, U_n \to X\}$
is an fpqc covering by
Topologies, Lemma \ref{topologies-lemma-recognize-fpqc-covering}.
\end{proof}




\section{Formal glueing of algebraic spaces}
\label{section-formal-glueing-spaces}

\noindent
In Situation \ref{situation-formal-glueing} we consider the category
$\textit{Spaces}(X \to Y, Z)$
of commutative diagrams of algebraic spaces over $S$ of the form
$$
\xymatrix{
U' \ar[d] & V' \ar[l] \ar[d] \ar[r] & Y' \ar[d] \\
U & V \ar[l] \ar[r] & Y
}
$$
where both squares are cartesian. There is a canonical functor
\begin{equation}
\label{equation-formal-glueing-spaces}
\textit{Spaces}/X \longrightarrow \textit{Spaces}(Y \to X, Z)
\end{equation}
which maps $X' \to X$ to the morphisms
$U \times_X X' \leftarrow V \times_X X' \rightarrow Y \times_X X'$.

\begin{lemma}
\label{lemma-equivalence-on-affine}
In Situation \ref{situation-formal-glueing} the functor
(\ref{equation-formal-glueing-spaces}) restricts to an
equivalence
\begin{enumerate}
\item from the category of algebraic spaces affine over $X$
to the full subcategory of $\textit{Spaces}(Y \to X, Z)$ consisting
of $(U' \leftarrow V' \rightarrow Y')$ with $U' \to U$, $V' \to V$,
and $Y' \to Y$ affine, and
\item from the category of closed immersions $X' \to X$
to the full subcategory of $\textit{Spaces}(Y \to X, Z)$ consisting
of $(U' \leftarrow V' \rightarrow Y')$ with $U' \to U$, $V' \to V$,
and $Y' \to Y$ closed immersions.
\end{enumerate}
\end{lemma}

\begin{proof}
The category of algebraic spaces affine over $X$ is equivalent to the
category of quasi-coherent sheaves $\mathcal{A}$ of $\mathcal{O}_X$-algebras.
The full subcategory of $\textit{Spaces}(Y \to X, Z)$ consisting of
$(U' \leftarrow V' \rightarrow Y')$ with $U' \to U$, $V' \to V$,
and $Y' \to Y$ affine is equivalent to the category of
algebra objects of $\QCoh(Y \to X, Z)$. In both cases this follows
from Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-affine-equivalence-algebras}
with quasi-inverse given by the relative spectrum construction
(Morphisms of Spaces, Definition
\ref{spaces-morphisms-definition-relative-spec})
which commutes with arbitrary base change. Thus part (1) of the
lemma follows from Proposition \ref{proposition-formal-glueing-modules}.

\medskip\noindent
Fully faithfulness in part (2) follows from part (1). For essential
surjectivity, we reduce by part (1) to proving that $X' \to X$
is a closed immersion if and only if both $U \times_X X' \to U$ and
$Y \times_X X' \to Y$ are closed immersions. By
Lemma \ref{lemma-dominate-by-fpqc-covering}
$\{U \to X, Y \to X\}$ can be refined by an fpqc covering.
Hence the result follows from
Descent on Spaces, Lemma
\ref{spaces-descent-lemma-descending-property-closed-immersion}.
\end{proof}

\begin{lemma}
\label{lemma-reflects-isomorphisms}
In Situation \ref{situation-formal-glueing} the functor
(\ref{equation-formal-glueing-spaces}) reflects isomorphisms.
\end{lemma}

\begin{proof}
By a formal argument with base change, this reduces to the following
question: A morphism $a : X' \to X$ of algebraic spaces such that
$U \times_X X' \to U$ and $Y \times_X X' \to Y$ are isomorphisms, is
an isomorphism. The family $\{U \to X, Y \to X\}$ can be refined by
an fpqc covering by Lemma \ref{lemma-dominate-by-fpqc-covering}.
Hence the result follows from
Descent on Spaces, Lemma
\ref{spaces-descent-lemma-descending-property-isomorphism}.
\end{proof}

\begin{lemma}
\label{lemma-fully-faithful-on-separated}
In Situation \ref{situation-formal-glueing} the functor
(\ref{equation-formal-glueing-spaces}) is fully faithful
on algebraic spaces separated over $X$. More precisely, it induces
a bijection
$$
\Mor_X(X'_1, X'_2)
\longrightarrow
\Mor_{\textit{Spaces}(Y \to X, Z)}(F(X'_1), F(X'_2))
$$
whenever $X'_2 \to X$ is separated.
\end{lemma}

\begin{proof}
Since $X'_2 \to X$ is separated, the graph $i : X'_1 \to X'_1 \times_X X'_2$
of a morphism $X'_1 \to X'_2$ over $X$ is a closed immersion, see
Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-semi-diagonal}.
Moreover a closed immersion $i : T \to X'_1 \times_X X'_2$ is the graph of a
morphism if and only if $\text{pr}_1 \circ i$ is an isomorphism.
The same is true for
\begin{enumerate}
\item the graph of a morphism $U \times_X X'_1 \to U \times_X X'_2$ over $U$,
\item the graph of a morphism $V \times_X X'_1 \to V \times_X X'_2$ over $V$,
and
\item the graph of a morphism $Y \times_X X'_1 \to Y \times_X X'_2$ over $Y$.
\end{enumerate}
Moreover, if morphisms as in (1), (2), (3) fit together to form a
morphism in the category $\textit{Spaces}(Y \to X, Z)$, then these
graphs fit together to give an object of
$\textit{Spaces}(Y \times_X (X'_1 \times_X X'_2) \to X'_1 \times_X X'_2,
Z \times_X (X'_1 \times_X X'_2))$
whose triple of morphisms are closed immersions. The proof is finished
by applying Lemmas \ref{lemma-equivalence-on-affine} and
\ref{lemma-reflects-isomorphisms}.
\end{proof}






\section{Modifications}
\label{section-modifications}

\noindent
Let $(A, \mathfrak m, \kappa)$ be a Noetherian local ring. We set
$S = \Spec(A)$ and $U = S \setminus \{\mathfrak m\}$. In this section
we will consider the category
\begin{equation}
\label{equation-modification}
\left\{
f : X \longrightarrow S
\quad \middle | \quad
\begin{matrix}
X\text{ is an algebraic space}\\
f\text{ is a proper morphism}\\
f^{-1}(U) \to U\text{ is an isomorphism}
\end{matrix}
\right\}
\end{equation}
A morphism from $X/S$ to $X'/S$ will be a morphism of algebraic spaces
$X \to X"$ compatible with the structure morphisms over $S$.

\begin{lemma}
\label{lemma-modification}
Let $(A, \mathfrak m, \kappa)$ be a $2$-dimensional Noetherian
local domain such that $U = \Spec(A) \setminus \{\mathfrak m\}$
is a normal scheme. Then any modification $f : X \to S$
(as in Spaces over Fields, Definition
\ref{spaces-over-fields-definition-modification})
is a morphism as in (\ref{equation-modification}).
\end{lemma}

\begin{proof}
Let $f : X \to S$ be a modification. We have to show that
$f^{-1}(U) \to U$ is an isomorphism. By
Spaces over Fields, Lemma
\ref{spaces-over-fields-lemma-modification-iso-over-open}
there exists a nonempty open $V \subset S$ such that $f^{-1}(V) \to V$
is an isomorphism. Since $X$ is integral we see that $f^{-1}(V)$ is
dense in $X$. Note that every closed point $u$ of $U$ has codimension
$1$, i.e., that $\dim(\mathcal{O}_{U, u}) = 1$. Thus we may apply
Spaces over Fields, Lemma \ref{spaces-over-fields-lemma-finite-in-codim-1}
to see that $f^{-1}(U) \to U$ is finite. In particular $f^{-1}(U)$ is a scheme.
Then $f^{-1}(U) \to U$ is an isomorphism, see
Morphisms, Lemma \ref{morphisms-lemma-finite-birational-over-normal}.
\end{proof}

\noindent
Let $A \to B$ be a local homomorphism of local Noetherian rings
such that $\mathfrak m_B = \sqrt{\mathfrak m_A B}$. Then base
change along the morphism $\Spec(B) \to \Spec(A)$ gives a functor
from the category (\ref{equation-modification}) for $A$
to the category (\ref{equation-modification}) for $B$.

\begin{lemma}
\label{lemma-fully-faithfulness-to-completion}
Let $A \to B$ be a local homomorphism of local Noetherian rings such that
\begin{enumerate}
\item $A \to B$ is flat,
\item $\mathfrak m_B = \mathfrak m_A B$.
\end{enumerate}
(equivalently, $A \to B$ induces an isomorphism on completions).
Then the base change functor from the category
(\ref{equation-modification}) for $A$ to the category
(\ref{equation-modification}) for $B$
is fully faithful.
\end{lemma}

\begin{proof}
Consider the diagram
$$
\xymatrix{
\Spec(B) \setminus \{\mathfrak m_B\} \ar[r] \ar[d] & \Spec(B) \ar[d] \\
U = \Spec(A) \setminus \{\mathfrak m_A\} \ar[r] & \Spec(A)
}
$$
This is a diagram as in Situation \ref{situation-formal-glueing}.
By Lemma \ref{lemma-fully-faithful-on-separated} the functor which
associates to an algebraic space
$X$ over $\Spec(A)$ the base changes to $U$ and $\Spec(B)$
glued along the base change to $\Spec(B) \setminus \{\mathfrak m_B\}$
is fully faithful. However, in our category the morphisms are always
the identity over the complement of the closed point, hence we
obtain the desired result.
\end{proof}

\begin{lemma}
\label{lemma-henselian}
Let $(A, \mathfrak m, \kappa)$ be a Noetherian local ring.
The category (\ref{equation-modification}) for $A$
is equivalent to the category (\ref{equation-modification})
for the henselization $A^h$ of $A$.
\end{lemma}

\begin{proof}
Fully faithfulness follows from
Lemma \ref{lemma-fully-faithfulness-to-completion}. We will prove the
base change functor from the category (\ref{equation-modification}) for $A$
to the category (\ref{equation-modification}) for the henselization $A^h$
is essentially surjective.

\medskip\noindent
Write $A^h = \colim A_i$ as a filtered colimit where the ring maps
$A \to A_i$ are \'etale and induce an isomorphism
$\kappa(\mathfrak m) \to A_i/\mathfrak m A_i$ (see proof of
Algebra, Lemma \ref{algebra-lemma-henselization} or
More on Algebra, Lemma \ref{more-algebra-lemma-henselization-local-ring}).
Set $S_i = \Spec(A_i)$.
If $X^h \to S^h = \Spec(A^h)$ is as in (\ref{equation-modification}),
then there exists an $i$ and a morphism $X_i \to S_i$ such that
$X^h = S^h \times_{S_i} X_i$, see
Limits of Spaces, Lemma \ref{spaces-limits-lemma-descend-finite-presentation}.
After increasing $i$ we may assume that $X_i \to S_i$ is
proper, see
Limits of Spaces, Lemma \ref{spaces-limits-lemma-eventually-proper}.
After further increasing $i$ we may assume that
$X_i \to S_i$ is an isomorphism over the open
$S_i \setminus V(\mathfrak m A_i)$, see
Limits of Spaces, Lemma \ref{spaces-limits-lemma-descend-isomorphism}.
Thus it suffices to solve the problem posed in the following paragraph.

\medskip\noindent
Let $A \to B$ be an \'etale ring map inducing an isomorphism
$\kappa(\mathfrak m) \to B/\mathfrak m B$ and let $g : Y \to \Spec(B)$
be a proper morphism of algebraic spaces such that
$$
g^{-1}\left(\Spec(B) \setminus V(\mathfrak m B)\right)
\longrightarrow
\Spec(B) \setminus V(\mathfrak m B)
$$
is an isomorphism.
We have to show that $Y \cong X \times_{\Spec(A)} \Spec(B)$
for some object $X \to \Spec(A)$ of the category (\ref{equation-modification})
over $A$. To do this we will use descent.
Consider the scheme $R = \Spec(B \otimes_A B)$ with its two morphisms
$s, t : R \to \Spec(B)$ and the diagonal morphism $e : \Spec(B) \to R$.
We claim there is a canonical isomorphism
$$
\varphi :
R \times_{s, \Spec(B)} Y
\longrightarrow
Y \times_{\Spec(B), t} R
$$
over $R$. Over the open subscheme $e(\Spec(B)) \subset R$ the two
pullbacks are the same because $s \circ e = t \circ e = \text{id}_{\Spec(B)}$
hence there is a canonical isomorphism. Because
$B/\mathfrak m B = A/\mathfrak m$ the scheme $R$ has a unique
point $r$ lying over $\mathfrak m \in \Spec(A)$ which is a closed point,
and the restriction of the two pullbacks to $R \setminus \{r\}$ both map
isomorphically to $R \setminus \{r\}$. Thus the isomorphism over
$e(\Spec(B))$ extends uniquely to an isomorphism over all of $R$.
In exactly the same way one verifies that $\varphi$ defines a descent
datum for $Y/B/A$ (Descent on Spaces, Definition
\ref{spaces-descent-definition-descent-datum}). Now since every
descent datum for algebraic spaces relative to an fppf covering
is effective by Bootstrap, Lemma \ref{bootstrap-lemma-descend-algebraic-space}.

\medskip\noindent
Thus we find a morphism of algebraic spaces $f : X \to \Spec(A)$
whose base change to $\Spec(B)$ is $Y \to \Spec(B)$. Since
$\Spec(B) \to \Spec(A)$ is surjective \'etale we see that $f$
is proper (Descent on Spaces, Lemma
\ref{spaces-descent-lemma-descending-property-proper}). As
$\Spec(B) \setminus V(\mathfrak m B) \to \Spec(A) \setminus V(\mathfrak m) = U$
is surjective \'etale we conclude that $f^{-1}(U) \to U$ is an
isomorphism (Descent on Spaces, Lemma
\ref{spaces-descent-lemma-descending-property-isomorphism})
Thus $f : X \to \Spec(A)$ is an
object of (\ref{equation-modification}) as desired.
\end{proof}

\begin{lemma}
\label{lemma-dominate-by-admissible-blowup}
Let $(A, \mathfrak m, \kappa)$ be a Noetherian local ring.
Let $f : X \to S$ be an object of (\ref{equation-modification}).
Then there exists a $U$-admissible blowup $S' \to S$
which dominates $X$.
\end{lemma}

\begin{proof}
Special case of More on Morphisms of Spaces,
Lemma \ref{spaces-more-morphisms-lemma-dominate-modification-by-blowup}.
\end{proof}

\noindent
Let $(A, \mathfrak m, \kappa)$ be a Noetherian local ring.
Let $A^\wedge$ be the completion of $A$. Set
$S^\wedge = \Spec(A^\wedge)$, $S = \Spec(A)$ and let
$U^\wedge \subset S^\wedge$, $U \subset S$
be the complement of the closed point. Picture
$$
\xymatrix{
U^\wedge \ar[r] \ar[d] & S^\wedge \ar[d] \\\
U \ar[r] & S
}
$$
This is a cartesian square of schemes.

\begin{lemma}
\label{lemma-descend-admissible-blowup}
With assumption and notation as above. If $Y \to S^\wedge$ is a
$U^\wedge$-admissible blowup, then there exists a $U$-admissible
blowup $X \to S$ such that $Y = X \times_S S^\wedge$.
\end{lemma}

\begin{proof}
By definition there exists an ideal $J \subset A^\wedge$ such that
$V(J) = \{\mathfrak m A^\wedge\}$ and such that $Y$ is the blowup
of $S^\wedge$ in the closed subscheme defined by $J$, see
Divisors, Definition \ref{divisors-definition-admissible-blowup}.
Since $A^\wedge$ is Noetherian this implies
$\mathfrak m^n A^\wedge \subset J$ for some $n$.
Since $A^\wedge/\mathfrak m^n A^\wedge = A/\mathfrak m^n$
we find an ideal $\mathfrak m^n \subset I \subset A$
such that $J = I A^\wedge$. Let $X \to S$ be the blowup in $I$.
Since $A \to A^\wedge$ is flat
we conclude that the base change of $X$ is $Y$ by
Divisors, Lemma \ref{divisors-lemma-flat-base-change-blowing-up}.
\end{proof}

\begin{lemma}
\label{lemma-G-ring}
If $A$ is a G-ring, then the category (\ref{equation-modification})
for $A$ is equivalent to the category (\ref{equation-modification})
for the completion $A^\wedge$.
\end{lemma}

\begin{proof}
Omitted. Hint: Approximation and Lemma \ref{lemma-henselian}.
\end{proof}

\begin{lemma}
\label{lemma-projective-over-complete}
If $A$ is a complete Noetherian local domain of dimension $2$,
then every modification of $\Spec(A)$ is projective over $A$.
\end{lemma}

\begin{proof}
Omitted. Hints: Use that the special fibre is of dimension $1$,
hence a proper scheme, hence a projective scheme and lift the
ample invertible sheaf to thickenings and then use Grothendieck's
algebraization theorem.
\end{proof}






\section{Examples}
\label{section-examples}

\noindent
Some examples related to the results earlier in this chapter.

\begin{example}
\label{example-factorial}
\begin{reference}
\cite[4(c)]{Samuel-UFD}
\end{reference}
Let $k$ be a field. The ring $A = k[x, y, z]/(x^r + y^s + z^t)$
is a UFD for $r, s, t$ pairwise coprime integers. Namely, since
$x^r + y^s + z^t$ is irreducible $A$ is a domain. The element $z$
is a prime element, i.e., generates a prime ideal in $A$.
On the other hand, if $r = 1 + ers$ for some $e$, then
$$
A[1/z] \cong k[x', y', 1/z]
$$
where $x' = x/z^{es}$, $y' = y/z^{et}$ and $z = (x')^r + (y')^s$.
It follows from an argument of Nagata that $A$ is a UFD. Namely,
because $z$ is a prime element of $A$ the map $A \to A[1/z]$ maps
irreducible elements to irreducible elements or units and prime elements
to prime elements or units. Details omitted.
A similar argument can be given if $r$ is not congruent to $1$
modulo $rs$.
\end{example}

\begin{example}
\label{example-completion-not-factorial}
\begin{reference}
See \cite{Brieskorn} and \cite{Lipman-rational} for nonvanishing of
local Picard groups in general.
\end{reference}
The ring $A = \mathbf{C}[[x, y, z]]/(x^r + y^s + z^t)$
is not a UFD when $r < s < t$ are pairwise coprime integers
and not equal to $2, 3, 5$. For example consider the special
case $A = \mathbf{C}[[x, y, z]]/(x^2 + y^5 + z^7)$.
Consider the maps
$$
\psi_\zeta : \mathbf{C}[[x, y, z]]/(x^2 + y^5 + z^7) \to \mathbf{C}[[t]]
$$
given by
$$
x \mapsto t^7,\quad
y \mapsto t^3,\quad
z \mapsto -\zeta t^2(1 + t)^{1/7}
$$
where $\zeta$ is a $7$th root of unity. The kernel $\mathfrak p_\zeta$
of $\psi_\zeta$ is a height one prime, hence if $A$ is a UFD, then
it is principal, say given by $f_\zeta \in \mathbf{C}[[x, y, z]]$.
Note that $V(x^3 - y^7) = \bigcup V(\mathfrak p_\zeta)$
and $A/(x^3 - y^7)$ is reduced away from the closed point. Hence,
still assuming $A$ is a UFD, we would obtain
$$
\prod\nolimits_\zeta f_\zeta = u(x^3 - y^7) + a(x^2 + y^5 + z^7)
\quad\text{in}\quad
\mathbf{C}[[x, y, z]]
$$
for some unit $u \in \mathbf{C}[[x, y, z]]$ and some
element $a \in \mathbf{C}[[x, y, z]]$. After scaling by a constant
we may assume $u(0, 0, 0) = 1$. Note that the left hand side vanishes to
order $7$. Hence $a = - x \bmod \mathfrak m^2$. But then we get a term
$xy^5$ on the right hand side which does not occur on the left
hand side. A contradiction.
\end{example}

\begin{example}
\label{example-not-blow-up}
There exists an excellent $2$-dimensional Noetherian local ring
and a modification $X \to S = \Spec(A)$ which is not a scheme.
We sketch a construction. Let $X$ be a normal surface over $\mathbf{C}$
with a unique singular point $x \in X$. Assume that there exists a
resolution $\pi : X' \to X$ such that the exceptional fibre
$C = \pi^{-1}(x)_{red}$ is a smooth projective curve. Furthermore, assume
there exists a point $c \in C$ such that if $\mathcal{O}_C(nc)$
is in the image of $\text{Pic}(X') \to \text{Pic}(C)$, then $n = 0$.
Then we let $X'' \to X'$ be the blowing up in the nonsingular point $c$.
Let $C' \subset X''$ be the strict transform of $C$ and let $E \subset X''$
be the exceptional fibre. By Artin's results
(\cite{ArtinII}; use for example \cite{Mumford-topology}
to see that the normal bundle of $C'$ is negative)
we can blow down the curve $C'$ in $X''$ to obtain an algebraic space $X'''$.
Picture
$$
\xymatrix{
& X'' \ar[ld] \ar[rd] \\
X' \ar[rd] &  & X''' \ar[ld] \\
& X
}
$$
We claim that $X'''$ is not a scheme. This provides us with our example
because $X'''$ is a scheme if and only if the base change of $X'''$
to $A = \mathcal{O}_{X, x}$ is a scheme (details omitted).
If $X'''$ where a scheme, then the image of $C'$ in $X'''$ would
have an affine neighbourhood. The complement of this neighbourhood
would be an effective Cartier divisor on $X'''$ (because $X'''$ is
nonsingular apart from $1$ point). This effective Cartier divisor would
correspond to an effective Cartier divisor on $X''$
meeting $E$ and avoiding $C'$. Taking the image in $X'$ we obtain
an effective Cartier divisor meeting $C$ (set theoretically) in $c$.
This is impossible as no multiple of $c$ is the restriction of a Cartier
divisor by assumption.

\medskip\noindent
To finish we have to find such a singular surface $X$. We can just take
$X$ to be the affine surface given by
$$
x^3 + y^3 + z^3 + x^4 + y^4 + z^4 = 0
$$
in $\mathbf{A}^3_\mathbf{C} = \Spec(\mathbf{C}[x, y, z])$ and singular point
$(0, 0, 0)$. Then $(0, 0, 0)$ is the only singular point. Blowing up $X$
in the maximal ideal corresponding to $(0, 0, 0)$ we find three charts each
isomorphic to the smooth affine surface
$$
1 + s^3 + t^3 + x(1 + s^4 + t^4) = 0
$$
which is nonsingular with exceptional divisor $C$ given by $x = 0$. The reader
will recognize $C$ as an elliptic curve. Finally, the surface $X$ is rational
as projection from $(0, 0, 0)$ shows, or because in the equation for the
blow up we can solve for $x$. Finally, the Picard group of a nonsingular
rational surface is countable, whereas the Picard group of an elliptic
curve over the complex numbers is uncountable. Hence we can find a closed
point $c$ as indicated.
\end{example}








\input{chapters}

\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}
