\input{preamble}

% OK, start here.
%
\begin{document}

\title{More on Morphisms of Spaces}


\maketitle

\phantomsection
\label{section-phantom}

\tableofcontents

\section{Introduction}
\label{section-introduction}

\noindent
In this chapter we continue our study of properties of morphisms of algebraic
spaces. A fundamental reference is \cite{Kn}.





\section{Conventions}
\label{section-conventions}

\noindent
The standing assumption is that all schemes are contained in
a big fppf site $\textit{Sch}_{fppf}$. And all rings $A$ considered
have the property that $\text{Spec}(A)$ is (isomorphic) to an
object of this big site.

\medskip\noindent
Let $S$ be a scheme and let $X$ be an algebraic space over $S$.
In this chapter and the following we will write $X \times_S X$
for the product of $X$ with itself (in the category of algebraic
spaces over $S$), instead of $X \times X$.




\section{Morphisms of finite presentation}
\label{section-finite-presentation}

\noindent
In this section we generalize
Limits, Proposition
\ref{limits-proposition-characterize-locally-finite-presentation}
to morphisms of algebraic spaces.
The motivation for the following definition comes from
the proposition just cited.

\begin{definition}
\label{definition-locally-finite-presentation}
Let $S$ be a scheme.
\begin{enumerate}
\item A functor $F : (\textit{Sch}/S)_{fppf}^{opp} \to \textit{Sets}$
is said to be {\it locally of finite presentation} or {\it limit preserving} if
for every affine scheme $T$ over $S$ which is a limit $T = \text{lim}\ T_i$
of a directed inverse system of affine schemes $T_i$ over $S$, we have
$$
F(T) = \text{colim}\ F(T_i).
$$
We sometimes say that $F$ is {\it locally of finite presentation over $S$}.
\item Let $F, G : (\textit{Sch}/S)_{fppf}^{opp} \to \textit{Sets}$.
A transformation of functors $a : F \to G$
is {\it locally of finite presentation} if for every scheme $T$ over $S$
and every $y \in G(T)$ the functor
$$
F_y : (\textit{Sch}/T)_{fppf}^{opp} \longrightarrow \textit{Sets}, \quad
T'/T \longmapsto \{x \in F(T') \mid a(x) = y|_{T'}\}
$$
is locally of finite presentation over $T$. We sometimes say that
$F$ is {\it relatively limit preserving} over $G$.
\end{enumerate}
\end{definition}

\noindent
The functor $F_y$ of the definition is in some sense the fiber of
$a : F \to G$ over $y$, except that it is a presheaf on the big fppf
site of $T$. A formula for this functor is:
\begin{equation}
\label{equation-fibre-map-functors}
F_y =
F|_{(\textit{Sch}/T)_{fppf}}
{\times}_{G|_{(\textit{Sch}/T)_{fppf}}}
*
\end{equation}
Here $*$ is the final object in the category of (pre)sheaves
on $(\textit{Sch}/T)_{fppf}$ (see
Sites, Example \ref{sites-example-singleton-sheaf})
and the map $* \to G|_{(\textit{Sch}/T)_{fppf}}$ is given by $y$.
Note that if $j : (\textit{Sch}/T)_{fppf} \to (\textit{Sch}/S)_{fppf}$
is the localization functor, then the formula above becomes
$F_y = j^{-1}F \times_{j^{-1}G} *$ and $j_!F_y$ is just the fiber product
$F \times_{G, y} T$. (See
Sites, Section \ref{sites-section-localize},
for information on localization, and especially
Sites, Remark \ref{sites-remark-localize-presheaves}
for information on $j_!$ for presheaves.)

\medskip\noindent
At this point we temporarily have two definitions of what it means
for a morphism $X \to Y$ of algebraic spaces over $S$ to be locally of finite
presentation. Namely, one by
Morphisms of Spaces,
Definition \ref{spaces-morphisms-definition-locally-finite-presentation}
and one using that $X \to Y$ is a transformation of functors so that
Definition \ref{definition-locally-finite-presentation}
applies. We will show in
Proposition \ref{proposition-characterize-locally-finite-presentation}
that these two definitions agree.

\begin{lemma}
\label{lemma-composition-locally-finite-presentation}
Let $S$ be a scheme contained in $\textit{Sch}_{fppf}$.
Let $F, G, H : (\textit{Sch}/S)_{fppf}^{opp} \to \textit{Sets}$.
Let $a : F \to G$, $b : G \to H$ be transformations of functors.
If $a$ and $b$ are locally of finite presentation, then
$$
b \circ a : F \longrightarrow H
$$
is locally of finite presentation.
\end{lemma}

\begin{proof}
Let $T$ be a scheme over $S$. Let $z \in H(T)$.
We have to show that $F_z$ (notation as in
Definition \ref{definition-locally-finite-presentation}
is locally of finite presentation over $T$.
Let $T'$ be an affine scheme over $T$.
Suppose that $T' = \text{lim}\ T'_i$ is written as a limit of
a directed inverse system of affine schemes over $T$.
Finally, let $x \in F(T')$ with $b(a(x)) = z|_{T'}$.
By assumption on $b$ there exists an index $i$ and an
element $y_i \in G(T'_i)$ with $b(y_i) = z|_{T'_i}$ and
$y_i|_{T'} = a(x)$.
Then, by assumption on $a$, there exists an index $i' \geq i$
and an element $x_{i'} \in F(T'_{i'})$ with $a(x_{i'}) = y_i|_{T'_{i'}}$
and $x_{i'}|_{T'} = x$. It follows that $(b \circ a)(x_{i'}) = z|_{T'_{i'}}$
and $x_{i'}|_{T'} = x$. In this way we see that the map
$\text{colim}\ F_z(T'_i) \to F_z(T')$ is surjective.
We omit the proof of injectivity.
\end{proof}

\begin{lemma}
\label{lemma-base-change-locally-finite-presentation}
Let $S$ be a scheme contained in $\textit{Sch}_{fppf}$.
Let $F, G, H : (\textit{Sch}/S)_{fppf}^{opp} \to \textit{Sets}$.
Let $a : F \to G$, $b : H \to G$ be transformations of functors.
Consider the fibre product diagram
$$
\xymatrix{
H \times_{b, G, a} F \ar[r]_-{b'} \ar[d]_{a'} & F \ar[d]^a \\
H \ar[r]^b & G
}
$$
If $a$ is locally of finite presentation, then the base change $a'$ is
locally of finite presentation.
\end{lemma}

\begin{proof}
Omitted. Hint: This is formal.
\end{proof}

\begin{lemma}
\label{lemma-limit-fppf-topology}
Let $T$ be an affine scheme which is written as a limit
$T = \text{lim}_{i \in I}\ T_i$ of a directed inverse system of affine schemes.
\begin{enumerate}
\item Let $\mathcal{V} = \{V_j \to T\}_{j = 1, \ldots, m}$ be a standard fppf
covering of $T$, see
Topologies, Definition \ref{topologies-definition-standard-fppf}.
Then there exists an index $i$ and a standard fppf covering
$\mathcal{V}_i = \{V_{i, j} \to T_i\}_{j = 1, \ldots, m}$
whose base change $T \times_{T_i} \mathcal{V}_i$ to $T$
is isomorphic to $\mathcal{V}$.
\item Let $\mathcal{V}_i$, $\mathcal{V}'_i$ be a pair of standard
fppf coverings of $T_i$. If
$f : T \times_{T_i} \mathcal{V} \to T \times_{T_i} \mathcal{V}'_i$ is
a morphism of coverings of $T$, then there exists an index
$i' \geq i$ and a morphism
$f_{i'} : T_{i'} \times_{T_i} \mathcal{V} \to
T_{i'} \times_{T_i} \mathcal{V}'_i$
whose base change to $T$ is $f$.
\item If
$f, g : \mathcal{V} \to \mathcal{V}'_i$
are morphisms of standard fppf coverings of $T_i$ whose
base changes $f_T, g_T$ to $T$ are equal then there exists an
index $i' \geq i$ such that $f_{T_{i'}} = g_{T_{i'}}$.
\end{enumerate}
In other words, the category of standard fppf coverings of $T$ is
the colimit over $I$ of the categories of standard fppf coverings of $T_i$
\end{lemma}

\begin{proof}
By
Limits, Lemma \ref{limits-lemma-descend-finite-presentation}
the category of schemes of finite presentation over $T$ is the
colimit over $I$ of the categories of finite presentation over $T_i$. By
Limits, Lemmas \ref{limits-lemma-descend-affine-finite-presentation}
and \ref{limits-lemma-descend-flat-finite-presentation}
the same is true for category of schemes which are affine, flat and
of finite presentation over $T$.
To finish the proof of the lemma it suffices to show that if
$\{V_{j, i} \to T_i\}_{j = 1, \ldots, m}$ is a finite family of
flat finitely presented morphisms with $V_{j, i}$ affine, and the
base change $\coprod_j T \times_{T_i} V_{j, i} \to T$ is surjective,
then for some $i' \geq i$ the morphism
$\coprod T_{i'} \times_{T_i} V_{j, i} \to T_{i'}$ is surjective.
Denote $W_{i'} \subset T_{i'}$, resp.\ $W \subset T$ the image.
Of course $W = T$ by assumption.
Since the morphisms are flat and of finite presentation we see that
$W_i$ is a quasi-compact open of $T_i$, see
Morphisms, Lemma \ref{morphisms-lemma-fppf-open}.
Moreover, $W = T \times_{T_i} W_i$ (formation of image commutes
with base change). Hence by
Limits, Lemma \ref{limits-lemma-descend-opens}
we conclude that $W_{i'} = T_{i'}$ for some large enough $i'$
and we win.
\end{proof}

\begin{lemma}
\label{lemma-sheafify-finite-presentation}
Let $S$ be a scheme contained in $\textit{Sch}_{fppf}$.
Let $F : (\textit{Sch}/S)_{fppf}^{opp} \to \textit{Sets}$ be a functor.
If $F$ is locally of finite presentation over $S$ then its sheafification
$F^\#$ is locally of finite presentation over $S$.
\end{lemma}

\begin{proof}
Assume $F$ is locally of finite presentation.
It suffices to show that $F^+$ is locally of finite presentation, since
$F^\# = (F^+)^+$, see
Sites, Theorem \ref{sites-theorem-plus}.
Let $T$ be an affine scheme over $S$, and let $T = \lim T_i$ be written
as the directed limit of an inverse system of affine $S$ schemes.
Recall that $F^+(T)$ is the colimit of $\check H^0(\mathcal{V}, F)$
where the limit is over all coverings of $T$ in $(\textit{Sch}/S)_{fppf}$.
Any fppf covering of an affine scheme can be refined by a standard
fppf covering, see
Topologies, Lemma \ref{topologies-lemma-fppf-affine}.
Hence we can write
$$
F^+(T)
=
\text{colim}_{\mathcal{V}\text{ standard covering }T}\ 
\check H^0(\mathcal{V}, F).
$$
By
Lemma \ref{lemma-limit-fppf-topology}
we may rewrite this as
$$
\text{colim}_{i \in I}\ 
\text{colim}_{\mathcal{V}_i\text{ standard covering }T_i}\ 
\check H^0(T \times_{T_i}\mathcal{V}_i, F).
$$
(The order of the colimits is irrelevant by
Categories, Lemma \ref{categories-lemma-colimits-commute}.)
Given a standard fppf covering
$\mathcal{V}_i = \{V_j \to T_i\}_{j = 1, \ldots, m}$ of $T_i$ we see that
$$
T \times_{T_i} V_j = \text{lim}_{i' \geq i}\ T_{i'} \times_T V_j
$$
by 
Limits, Lemma \ref{limits-lemma-scheme-over-limit}, and similarly
$$
T \times_{T_i} (V_j \times_{T_i} V_{j'}) =
\text{lim}_{i' \geq i}\ T_{i'} \times_T (V_j \times_{T_i} V_{j'}).
$$
As the presheaf $F$ is locally of finite presentation this means that
$$
\check H^0(T \times_{T_i}\mathcal{V}_i, F)
=
\text{colim}_{i' \geq i}
\check H^0(T_{i'} \times_{T_i}\mathcal{V}_i, F).
$$
Hence the colimit expression for $F^+(T)$ above collapses to
$$
\text{colim}_{i \in I}\ 
\text{colim}_{\mathcal{V}\text{ standard covering }T_i}\ 
\check H^0(\mathcal{V}, F).
=
\text{colim}_{i \in I} F^+(T_i).
$$
In other words $F^+(T) = \text{colim}_i\ F^+(T_i)$ and hence
the lemma holds.
\end{proof}

\begin{lemma}
\label{lemma-sheaf-finite-presentation}
Let $S$ be a scheme. 
Let $F : (\textit{Sch}/S)_{fppf}^{opp} \to \textit{Sets}$ be a functor.
Assume that
\begin{enumerate}
\item $F$ is a sheaf, and
\item there exists an fppf covering $\{U_j \to S\}_{j \in J}$ such that
$F|_{(\textit{Sch}/U_j)_{fppf}}$ is locally of finite presentation.
\end{enumerate}
Then $F$ is locally of finite presentation.
\end{lemma}

\begin{proof}
Let $T$ be an affine scheme over $S$.
Let $I$ be a directed partially ordered set, and let
$T_i$ be an inverse system of affine schemes over $S$ such that
$T = \text{lim}\ T_i$. We have to show that the canonical
map $\text{colim}\ F(T_i) \to F(T)$ is bijective.

\medskip\noindent
Choose some $0 \in I$ and choose a standard fppf covering
$\{V_{0, k} \to T_{0}\}_{k = 1, \ldots, m}$ which refines
the pullback $\{U_j \times_S T_0 \to T_0\}$ of the given fppf covering of $S$.
For each $i \geq 0$ we set $V_{i, k} = T_i \times_{T_0} V_{0, k}$, and
we set $V_k = T \times_{T_0} V_{0, k}$. Note that
$V_k = \text{lim}_{i \geq 0}\ V_{i, k}$, see
Limits, Lemma \ref{limits-lemma-scheme-over-limit}.

\medskip\noindent
Suppose that $x, x' \in \text{colim}\ F(T_i)$ map to the same
element of $F(T)$. Say $x, x'$ are given by elements $x_i, x'_i \in F(T_i)$
for some $i \in I$ (we may choose the same $i$ for both as $I$ is directed).
By assumption (2) and the fact that $x_i, x'_i$ map to the same element
of $F(T)$ this implies that
$$
x_i|_{V_{i', k}} = x'_i|_{V_{i', k}}
$$
for some suitably large $i' \in I$. We can choose the same $i'$ for each
$k$ as $k \in \{1, \ldots, m\}$ ranges over a finite set.
Since $\{V_{i', k} \to T_{i'}\}$
is an fppf covering and $F$ is a sheaf this implies that
$x_i|_{T_{i'}} = x'_i|_{T_{i'}}$ as desired. This proves that the map
$\text{colim}\ F(T_i) \to F(T)$ is injective.

\medskip\noindent
To show surjectivity we argue in a similar fashion.
Let $x \in F(T)$. By assumption (2) for each $k$ we
can choose a $i$ such that $x|_{V_k}$ comes from an
element $x_{i, k} \in F(V_{i, k})$. As before we may choose a
single $i$ which works for all $k$. By the injectivity
proved above we see that
$$
x_{i, k}|_{V_{i', k} \times_{T_{i'}} V_{i', l}}
=
x_{i, l}|_{V_{i', k} \times_{T_{i'}} V_{i', l}}
$$
for some large enough $i'$. Hence by the sheaf condition of $F$
the elements $x_{i, k}|_{V_{i', k}}$ glue to an element $x_{i'} \in F(T_{i'})$
as desired.
\end{proof}

\begin{lemma}
\label{lemma-sheafify-finite-presentation-map}
Let $S$ be a scheme contained in $\textit{Sch}_{fppf}$.
Let $F, G : (\textit{Sch}/S)_{fppf}^{opp} \to \textit{Sets}$ be functors.
If $a : F \to G$ is a transformation which is locally of finite
presentation, then the induced transformation of sheaves
$F^\# \to G^\#$ is of finite presentation.
\end{lemma}

\begin{proof}
Suppose that $T$ is a scheme and $y \in G^\#(T)$.
We have to show the functor
$F^\#_y : (\textit{Sch}/T)_{fppf}^{opp} \to \textit{Sets}$
constructed from $F^\# \to G^\#$ and $y$ as in
Definition \ref{definition-locally-finite-presentation}
is locally of finite presentation.
By Equation (\ref{equation-fibre-map-functors})
we see that $F^\#_y$ is a sheaf. Choose an fppf covering
$\{V_j \to T\}_{j \in J}$ such that $y|_{V_j}$ comes from
an element $y_j \in F(V_j)$.
Note that the restriction of $F^\#$ to $(\textit{Sch}/V_j)_{fppf}$
is just $F^\#_{y_j}$. If we can show that $F^\#_{y_j}$ is
locally of finite presentation then
Lemma \ref{lemma-sheaf-finite-presentation}
garantees that $F^\#_y$ is locally of finite presentation and
we win. This reduces us to the case $y \in G(T)$.

\medskip\noindent
Let $y \in G(T)$. In this case we claim that $F^\#_y = (F_y)^\#$.
This follows from 
Equation (\ref{equation-fibre-map-functors}).
Thus this case follows from
Lemma \ref{lemma-sheafify-finite-presentation}.
\end{proof}

\begin{proposition}
\label{proposition-characterize-locally-finite-presentation}
Let $S$ be a scheme. Let $f : X \to Y$ be a morphism of algebraic
spaces over $S$. The following are equivalent:
\begin{enumerate}
\item The morphism $f$ is a morphism of algebraic spaces which is
locally of finite presentation, see
Morphisms of Spaces,
Definition \ref{spaces-morphisms-definition-locally-finite-presentation}.
\item The morphism $f : X \to Y$ is locally of finite presentation as
a transformation of functors, see
Definition \ref{definition-locally-finite-presentation}.
\end{enumerate}
\end{proposition}

\begin{proof}
Assume (1). Let $T$ be a scheme and let $y \in Y(T)$. We have to show that
$T \times_X Y$ is locally of finite presentation over $T$ in the sense of
Definition \ref{definition-locally-finite-presentation}.
Hence we are reduced to proving that if $X$ is an algebraic space which
is locally of finite presentation over $S$ as an algebraic space, then it
is locally of finite presentation as a functor
$X : (\textit{Sch}/S)_{fppf}^{opp} \to \textit{Sets}$.
To see this choose a presentation $X = U/R$, see
Spaces, Definition \ref{spaces-definition-presentation}.
It follows from
Morphisms of Spaces,
Definition \ref{spaces-morphisms-definition-locally-finite-presentation}
that both $U$ and $R$ are schemes which are locally of finite presentation
over $S$. Hence by
Limits, Proposition
\ref{limits-proposition-characterize-locally-finite-presentation}
we have
$$
U(T) = \text{colim}\ U(T_i),\quad
R(T) = \text{colim}\ R(T_i)
$$
whenever $T = \text{lim}_i\ T_i$ in $(\textit{Sch}/S)_{fppf}$. It follows
that the presheaf
$$
(\textit{Sch}/S)_{fppf}^{opp} \longrightarrow \textit{Sets},\quad
W \longmapsto U(W)/R(W)
$$
is locally of finite presentation. Hence by
Lemma \ref{lemma-sheafify-finite-presentation}
its sheafification $X = U/R$ is locally of finite presentation too.

\medskip\noindent
Assume (2). Choose a scheme $V$ and a surjective \'etale morphism
$V \to Y$. Next, choose a scheme $U$ and a surjective \'etale morphism
$U \to V \times_Y X$. By
Lemma \ref{lemma-base-change-locally-finite-presentation}
the transformation of functors $V \times_Y X \to V$ is locally of
finite presentation. By
Morphisms of Spaces,
Lemma \ref{spaces-morphisms-lemma-etale-locally-finite-presentation}
the morphism of algebraic spaces $U \to V \times_Y X$ is locally
of finite presentation, hence locally of finite presentation as
a transformation of functors by the first part of the proof. By
Lemma \ref{lemma-composition-locally-finite-presentation}
the composition $U \to V \times_Y X \to V$ is locally of
finite presentation as a transformation of functors. Hence
the morphism of schemes $U \to V$ is locally of finite presentation by
Limits, Proposition
\ref{limits-proposition-characterize-locally-finite-presentation}
(modulo a set theoretic remark, see last paragraph of the proof).
This means, by definition, that (1) holds.

\medskip\noindent
Set theoretic remark. Let $U \to V$ be a morphism of
$(\textit{Sch}/S)_{fppf}$. In the statement of
Limits, Proposition
\ref{limits-proposition-characterize-locally-finite-presentation}
we characterize $U \to V$ as being locally of finite presentation
if for {\it all} directed inverse systems $(T_i, f_{ii'})$ of affine schemes
over $V$ we have $U(T) = \text{colim}\ V(T_i)$, but in the current setting
we may only consider affine schemes $T_i$ over $V$ which are (isomorphic to)
an object of $(\textit{Sch}/S)_{fppf}$. So we have to make sure that there
are enough affines in $(\textit{Sch}/S)_{fppf}$ to make the proof work.
Inspecting the proof of (2) $\Rightarrow$ (1) of
Limits, Proposition
\ref{limits-proposition-characterize-locally-finite-presentation}
we see that the question reduces to the case that $U$ and $V$ are affine.
Say $U = \text{Spec}(A)$ and $V = \text{Spec}(B)$. By construction
of $(\textit{Sch}/S)_{fppf}$ the spectrum of any ring of cardinality
$\leq |B|$ is isomorphic to an object of $(\textit{Sch}/S)_{fppf}$.
Hence it suffices to observe that in the "only if" part of the proof of
Algebra, Lemma \ref{algebra-lemma-characterize-finite-presentation}
only $A$-algebras of cardinality $\leq |B|$ are used.
\end{proof}

\begin{remark}
\label{remark-limit-preserving}
Here is an important special case of
Proposition \ref{proposition-characterize-locally-finite-presentation}.
Let $S$ be a scheme. Let $X$ be an algebraic space over $S$.
Then $X$ is locally of finite presentation over $S$ if and only
if $X$, as a functor $(\textit{Sch}/S)^{opp} \to \textit{Sets}$,
is limit preserving. Compare with
Limits, Remark \ref{limits-remark-limit-preserving}.
\end{remark}











\section{Conormal sheaf of an immersion}
\label{section-conormal-sheaf}

\noindent
Let $S$ be a scheme. Let $i : Z \to X$ be a closed immersion of algebraic
spaces over $S$. Let $\mathcal{I} \subset \mathcal{O}_X$ be the corresponding
quasi-coherent sheaf of ideals, see
Morphisms of Spaces,
Lemma \ref{spaces-morphisms-lemma-closed-immersion-ideals}.
Consider the short exact sequence
$$
0 \to \mathcal{I}^2 \to \mathcal{I} \to \mathcal{I}/\mathcal{I}^2 \to 0
$$
of quasi-coherent sheaves on $X$. Since the sheaf $\mathcal{I}/\mathcal{I}^2$
is annihilated by $\mathcal{I}$ it corresponds to a sheaf on $Z$ by
Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-i-star-equivalence}.
This quasi-coherent $\mathcal{O}_Z$-module is the
{\it conormal sheaf of $Z$ in $X$} and is often denoted
$\mathcal{I}/\mathcal{I}^2$ by the abuse of notation mentioned in
Morphisms of Spaces,
Section \ref{spaces-morphisms-section-closed-immersions-quasi-coherent}.

\medskip\noindent
In case $i : Z \to X$ is a (locally closed) immersion we define the
conormal sheaf of $i$ as the conormal sheaf of the closed
immersion $i : Z \to X \setminus \partial Z$, see
Morphisms of Spaces, Remark \ref{spaces-morphisms-remark-immersion}.
It is often denoted
$\mathcal{I}/\mathcal{I}^2$ where $\mathcal{I}$ is the ideal sheaf
of the closed immersion $i : Z \to X \setminus \partial Z$.

\begin{definition}
\label{definition-conormal-sheaf}
Let $i : Z \to X$ be an immersion. The {\it conormal sheaf
$\mathcal{C}_{Z/X}$ of $Z$ in $X$} or the {\it conormal sheaf of $i$}
is the quasi-coherent $\mathcal{O}_Z$-module $\mathcal{I}/\mathcal{I}^2$
described above.
\end{definition}

\noindent
In \cite[IV Definition 16.1.2]{EGA} this sheaf is denoted
$\mathcal{N}_{Z/X}$. We will not follow this convention since we would
like to reserve the notation $\mathcal{N}_{Z/X}$
for the {\it normal sheaf of the immersion}. It is defined as
$$
\mathcal{N}_{Z/X} =
\textit{Hom}_{\mathcal{O}_Z}(\mathcal{C}_{Z/X}, \mathcal{O}_Z) =
\textit{Hom}_{\mathcal{O}_Z}(\mathcal{I}/\mathcal{I}^2, \mathcal{O}_Z)
$$
provided the conormal sheaf is of finite presentation (otherwise the
normal sheaf may not even be quasi-coherent). We will come back to the
normal sheaf later (insert future reference here).

\begin{lemma}
\label{lemma-etale-conormal}
Let $S$ be a scheme. Let $i : Z \to X$ be an immersion.
Let $\varphi : U \to X$ be an \'etale morphism where $U$ is a scheme.
Set $Z_U = U \times_X Z$ which is a locally closed subscheme of $U$.
Then
$$
\mathcal{C}_{Z/X}|_U = \mathcal{C}_{Z_U/U}
$$
canonically and functorially in $U$.
\end{lemma}

\begin{proof}
Let $T \subset X$ be a closed subspace such that $i$ defines a closed
immersion into $X \setminus T$.
Let $\mathcal{I}$ be the quasi-coherent sheaf of ideals on
$X \setminus T$ defining $Z$. Then the lemma just states that
$\mathcal{I}|_{U \setminus \varphi^{-1}(T)}$ is the sheaf of ideals of
the immersion $Z' \to U \setminus \varphi^{-1}(T)$.
This is clear from the construction of $\mathcal{I}$ in
Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-closed-immersion-ideals}.
\end{proof}

\begin{lemma}
\label{lemma-conormal-functorial}
Let $S$ be a scheme. Let
$$
\xymatrix{
Z \ar[r]_i \ar[d]_f & X \ar[d]^g \\
Z' \ar[r]^{i'} & X'
}
$$
be a commutative diagram of algebraic spaces over $S$.
Assume $i$, $i'$ immersions. There is a canonical map
of $\mathcal{O}_Z$-modules
$$
f^*\mathcal{C}_{Z'/X'}
\longrightarrow
\mathcal{C}_{Z/X}
$$
\end{lemma}

\begin{proof}
First find open subspaces $U' \subset X'$ and $U \subset X$ such that
$g(U) \subset U'$ and such that $i(Z) \subset U$ and $i(Z') \subset U'$
are closed (proof existence omitted). Replacing $X$ by $U$ and $X'$ by
$U'$ we may assume that $i$ and $i'$ are closed immersions.
Let $\mathcal{I}' \subset \mathcal{O}_{X'}$ and
$\mathcal{I} \subset \mathcal{O}_X$ be the quasi-coherent sheaves of
ideals associated to $i'$ and $i$, see
Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-closed-immersion-ideals}.
Consider the composition
$$
g^{-1}\mathcal{I}' \to g^{-1}\mathcal{O}_{X'}
\xrightarrow{g^\sharp} \mathcal{O}_X \to
\mathcal{O}_X/\mathcal{I} = i_*\mathcal{O}_Z
$$
Since $g(i(Z)) \subset Z'$ we conclude this composition is zero (see
statement on factorizations in
Morphisms of Spaces,
Lemma \ref{spaces-morphisms-lemma-closed-immersion-ideals}).
Thus we obtain a commutative diagram
$$
\xymatrix{
0 \ar[r] &
\mathcal{I} \ar[r] &
\mathcal{O}_X \ar[r] &
i_*\mathcal{O}_Z \ar[r] &
0 \\
0 \ar[r] &
g^{-1}\mathcal{I}' \ar[r] \ar[u] &
g^{-1}\mathcal{O}_{X'} \ar[r] \ar[u] &
g^{-1}i'_*\mathcal{O}_{Z'} \ar[r] \ar[u] &
0
}
$$
The lower row is exact since $g^{-1}$ is an exact functor.
By exactness we also see that
$(g^{-1}\mathcal{I}')^2 = g^{-1}((\mathcal{I}')^2)$.
Hence the diagram induces a map
$g^{-1}(\mathcal{I}'/(\mathcal{I}')^2) \to \mathcal{I}/\mathcal{I}^2$.
Pulling back (using $i^{-1}$ for example) to $Z$ we obtain
$i^{-1}g^{-1}(\mathcal{I}'/(\mathcal{I}')^2) \to \mathcal{C}_{Z/X}$.
Since $i^{-1}g^{-1} = f^{-1}(i')^{-1}$ this gives a map
$f^{-1}\mathcal{C}_{Z'/X'} \to \mathcal{C}_{Z/X}$, which induces
the desired map.
\end{proof}

\begin{lemma}
\label{lemma-conormal-functorial-more}
Let $S$ be a scheme. The conormal sheaf of
Definition \ref{definition-conormal-sheaf}, and its functoriality of
Lemma \ref{lemma-conormal-functorial}
satisfy the following properties:
\begin{enumerate}
\item If $Z \to X$ is an immersion of schemes over $S$, then the conormal
sheaf agrees with the one from
Morphisms, Definition \ref{morphisms-definition-conormal-sheaf}.
\item If in
Lemma \ref{lemma-conormal-functorial}
all the spaces are schemes, then the map
$f^*\mathcal{C}_{Z'/X'} \to \mathcal{C}_{Z/X}$ is the same
as the one constructed in
Morphisms, Lemma \ref{morphisms-lemma-conormal-functorial}.
\item Given a commutative diagram
$$
\xymatrix{
Z \ar[r]_i \ar[d]_f & X \ar[d]^g \\
Z' \ar[r]^{i'} \ar[d]_{f'} & X' \ar[d]^{g'} \\
Z'' \ar[r]^{i''} & X''
}
$$
then the map $(f' \circ f)^*\mathcal{C}_{Z''/X''} \to \mathcal{C}_{Z/X}$
is the same as the composition of
$f^*\mathcal{C}_{Z'/X'} \to \mathcal{C}_{Z/X}$
with the pullback by $f$ of
$(f')^*\mathcal{C}_{Z''/X''} \to \mathcal{C}_{Z'/X'}$
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted. Note that Part (1) is a special case of
Lemma \ref{lemma-etale-conormal}.
\end{proof}

\begin{lemma}
\label{lemma-conormal-functorial-flat}
Let $S$ be a scheme. Let
$$
\xymatrix{
Z \ar[r]_i \ar[d]_f & X \ar[d]^g \\
Z' \ar[r]^{i'} & X'
}
$$
be a fibre product diagram of algebraic spaces over $S$. Assume
$i$, $i'$ immersions. Then the canonical map
$f^*\mathcal{C}_{Z'/X'} \to \mathcal{C}_{Z/X}$ of
Lemma \ref{lemma-conormal-functorial}
is surjective. If $g$ is flat, then it is an isomorphism.
\end{lemma}

\begin{proof}
Choose a commutative diagram
$$
\xymatrix{
U \ar[r] \ar[d] & X \ar[d] \\
U' \ar[r] & X'
}
$$
where $U$, $U'$ are schemes and the horizontal arrows are surjective
and \'etale, see
Spaces, Lemma \ref{spaces-lemma-lift-morphism-presentations}.
Then using
Lemmas \ref{lemma-etale-conormal} and \ref{lemma-conormal-functorial-more}
we see that the question reduces to the case of a morphism of schemes.
In the schemes case this is
Morphisms, Lemma \ref{morphisms-lemma-conormal-functorial-flat}.
\end{proof}





\section{Sheaf of differentials of a morphism}
\label{section-sheaf-differentials}

\noindent
We suggest the reader take a look at the corresponding section
in the chapter on commutative algebra
(Algebra, Section \ref{algebra-section-differentials}),
the corresponding section in the chapter on morphism of schemes
(Morphisms, Section \ref{morphisms-section-sheaf-differentials})
as well as
Modules on Sites, Section \ref{sites-modules-section-differentials}.
We first show that the notion of sheaf of differentials for a
morphism of schemes agrees with the corresponding morphism of
small \'etale (ringed) sites.

\medskip\noindent
To clearly state the following lemma we temporarily go back to
denoting $\mathcal{F}^a$ the sheaf of $\mathcal{O}_{X_{\acute{e}tale}}$-modules
associated to a quasi-coherent $\mathcal{O}_X$-module $\mathcal{F}$
on the scheme $X$, see
Descent, Definition \ref{descent-definition-structure-sheaf}.

\begin{lemma}
\label{lemma-match-modules-differentials}
Let $f : X \to Y$ be a morphism of schemes. Let
$f_{small} : X_{\acute{e}tale} \to Y_{\acute{e}tale}$ be the associated
morphism of small \'etale sites, see
Descent, Remark \ref{descent-remark-change-topologies-ringed-sites}.
Then there is a canonical isomorphism
$$
(\Omega_{X/Y})^a = \Omega_{X_{\acute{e}tale}/Y_{\acute{e}tale}}
$$
compatible with universal derivations. Here the first module
is the sheaf on $X_{\acute{e}tale}$ associated
to the quasi-coherent $\mathcal{O}_X$-module $\Omega_{X/Y}$, see
Morphisms, Definition \ref{morphisms-definition-sheaf-differentials},
and the second module is the one from
Modules on Sites,
Definition \ref{sites-modules-definition-module-differentials}.
\end{lemma}

\begin{proof}
Let $h : U \to X$ be an \'etale morphism. In this case the natural map
$h^*\Omega_{X/Y} \to \Omega_{U/Y}$ is an isomorphism. Combine
Morphisms, Lemma \ref{morphisms-lemma-triangle-differentials-smooth}
with the fact that $\Omega_{U/X} = 0$ (an \'etale morphism $U \to X$
is a smooth morphism of schemes such that $\Omega_{U/X} = 0$,
see discussion surrounding
Morphisms, Definition \ref{morphisms-definition-etale}).
This means that there is a natural $\mathcal{O}_{Y_{\acute{e}tale}}$-derivation
$$
\text{d}^a : \mathcal{O}_{X_{\acute{e}tale}} \longrightarrow (\Omega_{X/Y})^a
$$
since we have just seen that the value of $(\Omega_{X/Y})^a$ on any object
$U$ of $X_{\acute{e}tale}$ is canonically identified with
$\Gamma(U, \Omega_{U/Y})$. By the universal property of
$\text{d}_{X/Y} :
\mathcal{O}_{X_{\acute{e}tale}}
\to
\Omega_{X_{\acute{e}tale}/Y_{\acute{e}tale}}$
there is a unique $\mathcal{O}_{X_{\acute{e}tale}}$-linear map
$c : \Omega_{X_{\acute{e}tale}/Y_{\acute{e}tale}} \to (\Omega_{X/Y})^a$
such that
$\text{d}^a = c \circ \text{d}_{X/Y}$.

\medskip\noindent
Conversely, suppose that $\mathcal{F}$ is an
$\mathcal{O}_{X_{\acute{e}tale}}$-module
and $D : \mathcal{O}_{X_{\acute{e}tale}} \to \mathcal{F}$ is a
$\mathcal{O}_{Y_{\acute{e}tale}}$-derivation. Then we can simply restrict
$D$ to the small Zariski site $X_{Zar}$ of $X$. Since sheaves on $X_{Zar}$
agree with sheaves on $X$, see
Descent, Remark \ref{descent-remark-Zarsiki-site-space},
we see that $D|_{X_{Zar}} : \mathcal{O}_X \to \mathcal{F}|_{X_{Zar}}$
is just a ``usual'' $Y$-derivation. Hence we obtain a map
$\psi : \Omega_{X/Y} \longrightarrow \mathcal{F}|_{X_{Zar}}$
such that $D|_{X_{Zar}} = \psi \circ \text{d}$. In particular, if we
apply this with $\mathcal{F} = \Omega_{X_{\acute{e}tale}/Y_{\acute{e}tale}}$
we obtain a map
$$
c' :
\Omega_{X/Y}
\longrightarrow
\Omega_{X_{\acute{e}tale}/Y_{\acute{e}tale}}|_{X_{Zar}}
$$
Denote $\text{id}_{\acute{e}tale, Zar} : X_{\acute{e}tale} \to X_{Zar}$
the morphism of ringed sites discussed in
Descent, Remark \ref{descent-remark-change-topologies-ringed-sites}.
Since the restriction functor $\mathcal{F} \mapsto \mathcal{F}|_{X_{Zar}}$
is equal to $\text{id}_{\acute{e}tale, Zar, *}$, since
$\text{id}_{\acute{e}tale, Zar}^*$ is left adjoint to
$\text{id}_{\acute{e}tale, Zar, *}$ and since
$(\Omega_{X/Y})^a = \text{id}_{\acute{e}tale, Zar}^*\Omega_{X/Y}$
we see that $c'$ is adjoint to a map
$$
c'' :
(\Omega_{X/Y})^a
\longrightarrow
\Omega_{X_{\acute{e}tale}/Y_{\acute{e}tale}}.
$$
We claim that $c''$ and $c'$ are mutually inverse.
This claim finishes the proof of the lemma.
To see this it is enough to show that $c''(\text{d}(f)) = \text{d}_{X/Y}(f)$
and $c(\text{d}_{X/Y}(f)) = \text{d}(f)$ if $f$ is a local section of
$\mathcal{O}_X$ over an open of $X$. We omit the verification.
\end{proof}

\noindent
This clears the way for the following definition. For an alternative, see
Remark \ref{remark-alternative}.

\begin{definition}
\label{definition-sheaf-differentials}
Let $S$ be a scheme. Let $f : X \to Y$ be a morphism of algebraic spaces
over $S$. The {\it sheaf of differentials $\Omega_{X/Y}$ of $X$ over $Y$}
is sheaf of differentials
(Modules on Sites,
Definition \ref{sites-modules-definition-sheaf-differentials})
for the morphism of ringed topoi
$$
(f_{small}, f^\sharp) :
(X_{\acute{e}tale}, \mathcal{O}_X)
\to
(Y_{\acute{e}tale}, \mathcal{O}_Y)
$$
of
Properties of Spaces,
Lemma \ref{spaces-properties-lemma-morphism-ringed-topoi}.
The {\it universal $Y$-derivation} will be denoted
$\text{d}_{X/Y} : \mathcal{O}_X \to \Omega_{X/Y}$.
\end{definition}

\noindent
By
Lemma \ref{lemma-match-modules-differentials}
this does not conflict with the already existing
notion in case $X$ and $Y$ are representable. From now on, if $X$ and $Y$
are representable, we no longer distinguish between the sheaf of differentials
defined above and the one defined in
Morphisms, Definition \ref{morphisms-definition-sheaf-differentials}.
We want to relate this to the usual modules of differentials for
morphisms of schemes. Here is the key lemma.

\begin{lemma}
\label{lemma-localize-differentials}
Let $S$ be a scheme. Let $f : X \to Y$ be a morphism of algebraic spaces
over $S$. Consider any commutative diagram
$$
\xymatrix{
U \ar[d]_a \ar[r]_\psi & V \ar[d]^b \\
X \ar[r]^f & Y
}
$$
where the vertical arrows are \'etale morphisms of algebraic spaces. Then
$$
\Omega_{X/Y}|_{U_{\acute{e}tale}} = \Omega_{U/V}
$$
In particular, if $U$, $V$ are schemes, then this is equal to the usual
sheaf of differentials of the morphism of schemes $U \to V$.
\end{lemma}

\begin{proof}
By
Properties of Spaces, Lemma \ref{spaces-properties-lemma-etale-morphism-topoi}
and Equation (\ref{spaces-properties-equation-restrict})
we may think of the restriction of a sheaf on $X_{\acute{e}tale}$ to
$U_{\acute{e}tale}$ as the pullback by $a_{small}$. Similarly for $b$. By
Modules on Sites, Lemma \ref{sites-modules-lemma-localize-differentials}
we have
$$
\Omega_{X/Y}|_{U_{\acute{e}tale}} =
\Omega_{\mathcal{O}_{U_{\acute{e}tale}}/
a_{small}^{-1}f_{small}^{-1}\mathcal{O}_{Y_{\acute{e}tale}}}
$$
Since $a_{small}^{-1}f_{small}^{-1}\mathcal{O}_{Y_{\acute{e}tale}}
= \psi_{small}^{-1}b_{small}^{-1}\mathcal{O}_{Y_{\acute{e}tale}}
= \psi_{small}^{-1}\mathcal{O}_{V_{\acute{e}tale}}$ we see that the lemma holds.
\end{proof}

\begin{lemma}
\label{lemma-module-differentials-quasi-coherent}
Let $S$ be a scheme. Let $f : X \to Y$ be a morphism of algebraic spaces
over $S$. Then $\Omega_{X/Y}$ is a quasi-coherent $\mathcal{O}_X$-module.
\end{lemma}

\begin{proof}
Choose a diagram as in
Lemma \ref{lemma-localize-differentials}
with $a$ and $b$ surjective and $U$ and $V$ schemes.
Then we see that $\Omega_{X/Y}|_U = \Omega_{U/V}$ which is
quasi-coherent by
Morphisms, Definition \ref{morphisms-definition-sheaf-differentials}.
Hence we conclude that $\Omega_{X/Y}$ is quasi-coherent by
Properties of Spaces,
Lemma \ref{spaces-properties-lemma-characterize-quasi-coherent}.
\end{proof}

\begin{remark}
\label{remark-alternative}
Now that we know that $\Omega_{X/Y}$ is quasi-coherent we can attempt
to construct it in another manner. For example we can use the result of
Properties of Spaces,
Section \ref{spaces-properties-section-quasi-coherent-presentation}
to construct the sheaf of differentials by glueing.
For example if $Y$ is a scheme and if $U \to X$ is a surjective \'etale morphism
from a scheme towards $X$, then we see that $\Omega_{U/Y}$ is
a quasi-coherent $\mathcal{O}_U$-module, and since $s, t : R \to U$
are \'etale we get an isomorphism
$$
\alpha : s^*\Omega_{U/Y} \to \Omega_{R/Y} \to t^*\Omega_{U/Y}
$$
by using
Morphisms, Lemma \ref{morphisms-lemma-triangle-differentials-smooth}.
You check that this satisfies the cocycle condition and you're done.
If $Y$ is not a scheme, then you define $\Omega_{U/Y}$ as the cokernel
of the map $(U \to Y)^*\Omega_{Y/S} \to \Omega_{U/S}$, and proceed as
before. This two step process is a little bit ugly. Another possibility
is to glue the sheaves $\Omega_{U/V}$ for any diagram as in
Lemma \ref{lemma-localize-differentials}
but this is not very elegant either. Both approaches will work however, and
will give a slightly more elementary construction of the sheaf of
differentials.
\end{remark}

\begin{lemma}
\label{lemma-functoriality-differentials}
Let $S$ be a scheme. Let
$$
\xymatrix{
X' \ar[d] \ar[r]_f & X \ar[d] \\
Y' \ar[r] & Y
}
$$
be a commutative diagram of algebraic spaces. The map
$f^\sharp : \mathcal{O}_X \to f_*\mathcal{O}_{X'}$ composed with the map
$f_*\text{d}_{X'/Y'} : f_*\mathcal{O}_{X'} \to f_*\Omega_{X'/Y'}$ is a
$Y$-derivation. Hence we obtain a canonical map of $\mathcal{O}_X$-modules
$\Omega_{X/Y} \to f_*\Omega_{X'/Y'}$, and by
adjointness of $f_*$ and $f^*$ a
canonical $\mathcal{O}_{X'}$-module homomorphism
$$
c_f : f^*\Omega_{X/Y} \longrightarrow \Omega_{X'/Y'}.
$$
It is uniquely characterized by the property that
$f^*\text{d}_{X/Y}(t)$ mapsto $\text{d}_{X'/Y'}(f^* t)$
for any local section $t$ of $\mathcal{O}_X$.
\end{lemma}

\begin{proof}
This is a special case of
Module on Sites, Lemma \ref{sites-modules-lemma-functoriality-differentials}.
\end{proof}

\begin{lemma}
\label{lemma-check-functoriality-differentials}
Let $S$ be a scheme. Let
$$
\xymatrix{
X'' \ar[d] \ar[r]_g & X' \ar[d] \ar[r]_f & X \ar[d] \\
Y'' \ar[r] & Y' \ar[r] & Y
}
$$
be a commutative diagram of algebraic spaces over $S$. Then we have
$$
c_{f \circ g} = c_g \circ g^* c_f
$$
as maps $(f \circ g)^*\Omega_{X/Y} \to \Omega_{X''/Y''}$.
\end{lemma}

\begin{proof}
Omitted. Hint: Use the characterization of $c_f, c_g, c_{f \circ g}$
in terms of the effect these maps have on local sections.
\end{proof}

\begin{lemma}
\label{lemma-triangle-differentials}
Let $S$ be a scheme.
Let $f : X \to Y$, $g : Y \to B$ be morphisms of algebraic spaces over $S$.
Then there is a canonical exact sequence
$$
f^*\Omega_{Y/B} \to \Omega_{X/B} \to \Omega_{X/Y} \to 0
$$
where the maps come from applications of
Lemma \ref{lemma-functoriality-differentials}.
\end{lemma}

\begin{proof}
Follows from the schemes version, see
Morphisms, Lemma \ref{morphisms-lemma-triangle-differentials},
of this result via \'etale localization, see
Lemma \ref{lemma-localize-differentials}.
\end{proof}

\begin{lemma}
\label{lemma-immersion-differentials}
Let $S$ be a scheme. If $X \to Y$ is an immersion
of algebraic spaces over $S$ then $\Omega_{X/S}$ is zero.
\end{lemma}

\begin{proof}
Follows from the schemes version, see
Morphisms, Lemma \ref{morphisms-lemma-immersion-differentials},
of this result via \'etale localization, see
Lemma \ref{lemma-localize-differentials}.
\end{proof}

\begin{lemma}
\label{lemma-differentials-relative-immersion}
Let $S$ be a scheme. Let $B$ be an algebraic space over $S$.
Let $i : Z \to X$ be an immersion of algebraic spaces over $B$.
There is a canonical exact sequence
$$
\mathcal{C}_{Z/X} \to i^*\Omega_{X/B} \to \Omega_{Z/B} \to 0
$$
where the first arrow is induced by $\text{d}_{X/B}$
and the second arrow comes from
Lemma \ref{lemma-functoriality-differentials}.
\end{lemma}

\begin{proof}
This is the algebraic spaces version of
Morphisms, Lemma \ref{morphisms-lemma-differentials-relative-immersion}
and will be a consequence of that lemma by
\'etale localization, see
Lemmas \ref{lemma-localize-differentials} and
\ref{lemma-etale-conormal}.
However, we should make sure we can define the first arrow globally.
Hence we explain the meaning of ``induced by $\text{d}_{X/B}$'' here.
Namely, we may assume that $i$ is a closed immersion after replacing $X$
by an open subspace. Let $\mathcal{I} \subset \mathcal{O}_X$
be the quasi-coherent sheaf of ideals corresponding to $Z \subset X$.
Then $\text{d}_{X/S} : \mathcal{I} \to \Omega_{X/S}$
maps the subsheaf $\mathcal{I}^2 \subset \mathcal{I}$ to
$\mathcal{I}\Omega_{X/S}$. Hence it induces a map
$\mathcal{I}/\mathcal{I}^2 \to \Omega_{X/S}/\mathcal{I}\Omega_{X/S}$
which is $\mathcal{O}_X/\mathcal{I}$-linear.
By
Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-i-star-equivalence}
this corresponds to a map $\mathcal{C}_{Z/X} \to i^*\Omega_{X/S}$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-differentials-relative-immersion-section}
Let $S$ be a scheme. Let $B$ be an algebraic space over $S$.
Let $i : Z \to X$ be an immersion of schemes over $B$, and
assume $i$ (\'etale locally) has a left inverse. Then the canonical
sequence
$$
0 \to \mathcal{C}_{Z/X} \to i^*\Omega_{X/B} \to \Omega_{Z/B} \to 0
$$
of
Lemma \ref{lemma-differentials-relative-immersion}
is (\'etale locally) split exact.
\end{lemma}

\begin{proof}
Clarification: we claim that if $g : X \to Z$ is a left inverse of $i$,
then $i^*c_g$ is a right inverse of the map
$i^*\Omega_{X/B} \to \Omega_{Z/B}$.
Having said this, the result follows from the corresponding result for
morphisms of schemes by \'etale localization, see
Lemmas \ref{lemma-localize-differentials} and
\ref{lemma-etale-conormal}.
\end{proof}

\begin{lemma}
\label{lemma-base-change-differentials}
Let $S$ be a scheme.
Let $X \to Y$ be a morphism of algebraic spaces over $S$.
Let $g : Y' \to Y$ be a morphism of algebraic spaces over $S$.
Let $X' = X_{Y'}$ be the base change of $X$.
Denote $g' : X' \to X$ the projection.
Then the map
$$
(g')^*\Omega_{X/Y} \to \Omega_{X'/Y'}
$$
of
Lemma \ref{lemma-functoriality-differentials}
is an isomorphism.
\end{lemma}

\begin{proof}
Follows from the schemes version, see
Morphisms, Lemma \ref{morphisms-lemma-base-change-differentials}
and \'etale localization, see
Lemma \ref{lemma-localize-differentials}.
\end{proof}

\begin{lemma}
\label{lemma-differential-product}
Let $S$ be a scheme.
Let $f : X \to B$ and $g : Y \to B$ be morphisms of algebraic spaces
over $S$ with the same target.
Let $p : X \times_B Y \to X$ and $q : X \times_B Y \to Y$ be the
projection morphisms. The maps from
Lemma \ref{lemma-functoriality-differentials}
$$
p^*\Omega_{X/S} \oplus q^*\Omega_{Y/S}
\longrightarrow
\Omega_{X \times_S Y/S}
$$
give an isomorphism.
\end{lemma}

\begin{proof}
Follows from the schemes version, see
Morphisms, Lemma \ref{morphisms-lemma-differential-product}
and \'etale localization, see
Lemma \ref{lemma-localize-differentials}.
\end{proof}

\begin{lemma}
\label{lemma-finite-type-differentials}
Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism of algebraic spaces over $S$.
If $f$ is locally of finite type, then $\Omega_{X/Y}$ is
a finite type $\mathcal{O}_X$-module.
\end{lemma}

\begin{proof}
Follows from the schemes version, see
Morphisms, Lemma \ref{morphisms-lemma-finite-type-differentials}
and \'etale localization, see
Lemma \ref{lemma-localize-differentials}.
\end{proof}

\begin{lemma}
\label{lemma-finite-presentation-differentials}
Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism of algebraic spaces over $S$.
If $f$ is locally of finite type, then $\Omega_{X/Y}$ is
an $\mathcal{O}_X$-module of finite presentation.
\end{lemma}

\begin{proof}
Follows from the schemes version, see
Morphisms, Lemma \ref{morphisms-lemma-finite-presentation-differentials}
and \'etale localization, see
Lemma \ref{lemma-localize-differentials}.
\end{proof}














\section{Topological invariance of an \'etale site}
\label{section-topological-invariance}

\noindent
We show that the site $X_{spaces, \acute{e}tale}$ is a
``topological invariant''.
We will prove later that actually also $X_{\acute{e}tale}$, which
consists of the representable objects in $X_{spaces, \acute{e}tale}$,
is a topological invariant too (insert future reference here).

\begin{theorem}
\label{theorem-topological-invariance}
Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism of algebraic spaces over $S$.
Assume $f$ is integral, universally injective and surjective.
The functor
$$
V \longmapsto V_X = X \times_Y V
$$
defines an equivalence of categories
$Y_{spaces, \acute{e}tale} \to X_{spaces, \acute{e}tale}$.
\end{theorem}

\begin{proof}
The morphism $f$ is representable and a universal homeomorphism, see
Morphisms of Spaces,
Section \ref{spaces-morphisms-section-universal-homeomorphisms}.

\medskip\noindent
We first prove that the functor is faithful.
Suppose that $V', V$ are objects of $Y_{spaces, \acute{e}tale}$ and
that $a, b : V' \to V$ are distinct morphisms over $Y$.
Since $V', V$ are \'etale over $Y$ the equalizer
$$
E =  V' \times_{(a, b), V \times_Y V, \Delta_{V/Y}} V
$$
of $a, b$ is \'etale over $Y$ also. Hence $E \to V'$ is an \'etale monomorphism
(i.e., an open immersion) which is an isomorphism if and only if it is
surjective. Since $X \to Y$ is a universal homeomorphism we see that this
is the case if and only if $E_X = V'_X$, i.e., if and only if $a_X = b_X$.

\medskip\noindent
Next, we prove that the functor is fully faithful.
Suppose that $V', V$ are objects of $Y_{spaces, \acute{e}tale}$ and
that $c : V'_X \to V_X$ is a morphism over $X$. We want to construct
a morphism $a : V' \to V$ over $Y$ such that $a_X = c$.
Let $a' : V'' \to V'$ be a surjective \'etale morphism such that $V''$ is
a separated algebraic space. If we can construct a morphism
$a'' : V'' \to V$ such that $a''_X = c \circ a'_X$, then the two compositions
$$
V'' \times_{V'} V'' \xrightarrow{\text{pr}_i} V'' \xrightarrow{a''} V
$$
will be equal by the faithfulness of the functor proved in the first
paragraph. Hence $a''$ will factor through a unique morphism
$a : V' \to V$ as $V'$ is (as a sheaf) the quotient of $V''$ by
the equivalence relation $V'' \times_{V'} V''$. Hence we may assume that
$V'$ is separated. In this case the graph
$$
\Gamma_c \subset (V' \times_Y V)_X
$$
is open and closed (details omitted). Since $X \to Y$ is a universal
homeomorphism, there exists an open and closed subspace
$\Gamma \subset V' \times_Y V$ such that $\Gamma_X = \Gamma_c$.
The projection $\Gamma \to V'$ is an \'etale morphism whose base
change to $X$ is an isomorphism. Hence $\Gamma \to V'$ is \'etale,
universally injective, and surjective, so an isomorphism by
Morphisms of Spaces,
Lemma \ref{spaces-morphisms-lemma-etale-universally-injective-open}.
Thus $\Gamma$ is the graph of a morphism $a : V' \to V$ as desired.

\medskip\noindent
Finally, we prove that the functor is essentially surjective.
Suppose that $U$ is an object of $X_{spaces, \acute{e}tale}$.
We have to find an object $V$ of $Y_{spaces, \acute{e}tale}$
such that $V_X \cong U$. Let $U' \to U$ be a surjective \'etale morphism
such that $U' \cong V'_X$ and $U' \times_U U' \cong V''_X$
for some objects $V'', V'$ of $Y_{spaces, \acute{e}tale}$.
Then by fully faithfulness of the functor we obtain morphisms
$s, t : V'' \to V'$ with $t_X = \text{pr}_0$ and $s_X = \text{pr}_1$
as morphisms $U' \times_U U' \to U'$. Using that
$(\text{pr}_0, \text{pr}_1) : U' \times_U U' \to U' \times_S U'$
is an \'etale equivalence relation, and that $U' \to V'$ and
$U' \times_U U' \to V''$ are universally injective and surjective
we deduce that
$(t, s) : V'' \to V' \times_S V'$ is an \'etale equivalence relation.
Then the quotient $V = V'/V''$ (see
Spaces, Theorem \ref{spaces-theorem-presentation})
is an algebraic space $V$ over $Y$. There is a morphism
$V' \to V$ such that $V'' = V' \times_V V'$. Thus we obtain a morphism
$V \to Y$ (see
Descent and Algebraic Spaces,
Lemma \ref{spaces-descent-lemma-fppf-universal-effective-epimorphisms}).
On base change to $X$ we see that we have a morphism $U' \to V_X$
and a compatibe isomorphism $U' \times_{V_X} U' = U' \times_U U'$, which
implies that $V_X \cong U$ (by the lemma just cited once more).

\medskip\noindent
Pick a scheme $W$ and a surjective \'etale morphism $W \to Y$.
Pick a scheme $U'$ and a surjective \'etale morphism $U' \to U \times_X W_X$.
Note that $U'$ and $U' \times_U U'$ are schemes \'etale over $X$ whose
structure morphism to $X$ factors through the scheme $W_X$.
Hence by
\'Etale Cohomology,
Theorem \ref{etale-cohomology-theorem-topological-invariance}
there exist schemes $V', V''$ \'etale over $W$ whose base change to
$W_X$ is isomorphic to respectively $U'$ and $U' \times_U U'$.
This finishes the proof.
\end{proof}

\begin{remark}
\label{remark-topological-invariance-etale-site}
A universal homeomorphism of algebraic spaces need not be representable, see
Morphisms of Spaces,
Example \ref{spaces-morphisms-example-universal-homeomorphism}.
The argument in the proof of
Theorem \ref{theorem-topological-invariance}
above cannot be used in this case. In fact we do not know whether given
a universal homeomorphism of algebraic spaces
$f : X \to Y$ the categories $X_{spaces, \acute{e}tale}$
and $Y_{spaces, \acute{e}tale}$ are equivalent.
If you do, please email
\href{mailto:stacks.project@gmail.com}{stacks.project@gmail.com}.
\end{remark}








\section{Thickenings}
\label{section-thickenings}

\noindent
The following terminology may not be completely standard, but it is convenient.

\begin{definition}
\label{definition-thickening}
Thickenings. Let $S$ be a scheme.
\begin{enumerate}
\item We say an algebraic space $X'$ is a {\it thickening} of an algebraic
space $X$ if $X$ is a closed subspace of $X'$ and the associated topological
spaces are equal.
\item We say $X'$ is a {\it first order thickening} of $X$ if
$X$ is a closed subspace of $X'$ and the quasi-coherent sheaf of ideals
$\mathcal{I} \subset \mathcal{O}_{X'}$ defining $X$ has square zero.
\item Given two thickenings $X \subset X'$ and $Y \subset Y'$ a
{\it morphism of thickenings} is a morphism $f' : X' \to Y'$ such that
$f(X) \subset Y$, i.e., such that $f'|_X$ factors through the closed
subspace $Y$. In this situation we set $f = f'|_X : X \to Y$ and we say
that $(f, f') : (X \subset X') \to (Y \subset Y')$ is a morphism of
thickenings.
\item Let $B$ be an algebraic space. We similarly define
{\it thickenings over $B$}, and
{\it morphisms of thickenings over $B$}. This means that the spaces
$X, X', Y, Y'$ above are algebraic spaces endowed with a structure
morphism to $B$, and that the morphisms
$X \to X'$, $Y \to Y'$ and $f' : X' \to Y'$ are morphisms over $B$.
\end{enumerate}
\end{definition}

\noindent
The fundamental equivalence.
Note that if $X \subset X'$ is a thickening, then $X \to X'$
is integral and universally bijective. This implies that
\begin{equation}
\label{equation-equivalence-etale-spaces}
X_{spaces, \acute{e}tale} = X'_{spaces, \acute{e}tale}
\end{equation}
via the pullback functor, see
Theorem \ref{theorem-topological-invariance}.
Hence we may think of $\mathcal{O}_{X'}$ as a sheaf on
$X_{spaces, \acute{e}tale}$. Thus a canonical equivalence
of locally ringed topoi
\begin{equation}
\label{equation-fundamental-equivalence}
(\textit{Sh}(X'_{spaces, \acute{e}tale}), \mathcal{O}_{X'})
\cong
(\textit{Sh}(X_{spaces, \acute{e}tale}), \mathcal{O}_{X'})
\end{equation}
Below we will frequently combine this with the fully faithfulness result of
Properties of Spaces, Theorem \ref{spaces-properties-theorem-fully-faithful}.
For example the closed immersion $i_X : X \to X'$ corresponds
to the surjective map $i_X^\sharp : \mathcal{O}_{X'} \to \mathcal{O}_X$.

\medskip\noindent
Let $S$ be a scheme, and let $B$ be an algebraic space over $S$.
Let $(f, f') : (X \subset X') \to (Y \subset Y')$ be a morphism of
thickenings over $B$. Note that the diagram of continuous functors
$$
\xymatrix{
X_{spaces, \acute{e}tale} &
Y_{spaces, \acute{e}tale} \ar[l] \\
X'_{spaces, \acute{e}tale} \ar[u] &
Y'_{spaces, \acute{e}tale} \ar[u] \ar[l]
}
$$
is commutative and the vertical arrows are equivalences. Hence
$f_{spaces, \acute{e}tale}$, $f_{small}$,
$f'_{spaces, \acute{e}tale}$, and $f'_{small}$
all define the same morphism of topoi. Thus we may think of
$$
(f')^\sharp :
f_{spaces, \acute{e}tale}^{-1}\mathcal{O}_{Y'}
\longrightarrow
\mathcal{O}_{X'}
$$
as a map of sheaves of $\mathcal{O}_B$-algebras fitting into the commutative
diagram
$$
\xymatrix{
f_{spaces, \acute{e}tale}^{-1}\mathcal{O}_Y \ar[r]_-{f^\sharp} \ar[r] &
\mathcal{O}_X \\
f_{spaces, \acute{e}tale}^{-1}\mathcal{O}_{Y'} \ar[r]^-{(f')^\sharp}
\ar[u]^{i_Y^\sharp} &
\mathcal{O}_{X'} \ar[u]_{i_X^\sharp}
}
$$
Here $i_X : X \to X'$ and $i_Y : Y \to Y'$ are the names of the given
closed immersions.

\begin{lemma}
\label{lemma-first-order-thickening-maps}
Let $S$ be a scheme. Let $B$ be an algebraic space over $S$.
Let $X \subset X'$ and $Y \subset Y'$ be thickenings
of algebraic spaces over $B$. Let $f : X \to Y$ be a morphism of algebraic
spaces over $B$. Given any map of $\mathcal{O}_B$-algebras
$$
\alpha : f_{spaces, \acute{e}tale}^{-1}\mathcal{O}_{Y'} \to \mathcal{O}_{X'}
$$
such that
$$
\xymatrix{
f_{spaces, \acute{e}tale}^{-1}\mathcal{O}_Y \ar[r]_-{f^\sharp} \ar[r] &
\mathcal{O}_X \\
f_{spaces, \acute{e}tale}^{-1}\mathcal{O}_{Y'} \ar[r]^-\alpha
\ar[u]^{i_Y^\sharp} &
\mathcal{O}_{X'} \ar[u]_{i_X^\sharp}
}
$$
commutes, there exists a unique morphism of $(f, f')$ of
thickenings over $B$ such that $\alpha = (f')^\sharp$.
\end{lemma}

\begin{proof}
To find $f'$, by
Properties of Spaces, Theorem \ref{spaces-properties-theorem-fully-faithful},
all we have to do is show that the morphism of ringed topoi
$$
(f_{spaces, \acute{e}tale}, \alpha) :
(\textit{Sh}(X_{spaces, \acute{e}tale}), \mathcal{O}_{X'})
\longrightarrow
(\textit{Sh}(Y_{spaces, \acute{e}tale}), \mathcal{O}_{Y'})
$$
is a morphism of locally ringed topoi. This follows directly
from the definition of morphisms of locally ringed topoi
(Modules on Sites,
Definition \ref{sites-modules-definition-morphism-locally-ringed-topoi}),
the fact that $(f, f^\sharp)$ is a morphism of locally ringed topoi
(Properties of Spaces,
Lemma \ref{spaces-properties-lemma-morphism-locally-ringed}),
that $\alpha$ fits into the given commutative diagram, and
the fact that the kernels of $i_X^\sharp$ and $i_Y^\sharp$ are
locally nilpotent. Finally, the fact that $f' \circ i_X = i_Y \circ f$
follows from the commutativity of the diagram and another application of
Properties of Spaces, Theorem \ref{spaces-properties-theorem-fully-faithful}.
We omit the verification that $f'$ is a morphism over $B$.
\end{proof}

\begin{lemma}
\label{lemma-open-subspace-thickening}
Let $S$ be a scheme. Let $X \subset X'$ be a thickening
of algebraic spaces over $S$. For any open subspace $U \subset X$ there
exists a unique open subspace $U' \subset X'$ such that
$U = X \times_{X'} U'$.
\end{lemma}

\begin{proof}
Let $U' \to X'$ be the object of $X'_{spaces, \acute{e}tale}$
corresponding to the object $U \to X$ of $X_{spaces, \acute{e}tale}$
via (\ref{equation-equivalence-etale-spaces}). The morphism
$U' \to X'$ is \'etale and universally injective, hence an open immersion, see
Morphisms of Spaces,
Lemma \ref{spaces-morphisms-lemma-etale-universally-injective-open}.
\end{proof}

\noindent
Finite order thickenings. Any local section of the kernel
$\mathcal{I} = \text{Ker}(i_X^\sharp)$ of this surjection is nilpotent.
Let us say that $X \subset X'$ is a {\it finite order thickening}
if the ideal sheaf $\mathcal{I}$ is ``globally'' nilpotent, i.e.,
if there exists an $n \geq 0$ such that $\mathcal{I}^{n + 1} = 0$.
Technically the class of finite order thickenings $X \subset X'$
is much easier to handle than the general case.
Namely, in this case we have a filtration
$$
0 \subset \mathcal{I}^n \subset \mathcal{I}^{n - 1} \subset
\ldots \subset \mathcal{I} \subset \mathcal{O}_{X'}
$$
and we see that $X'$ is filtered by closed subspaces
$$
X = X_0 \subset X_1 \subset \ldots \subset X_{n - 1} \subset X_{n + 1} = X'
$$
such that each pair $X_i \subset X_{i + 1}$ is a first order thickening
over $B$. Using simple induction arguments many results proved for first order
thickenings can be rephrased as results on finite order thickenings.

\begin{lemma}
\label{lemma-first-order-thickening-surjective}
Let $S$ be a scheme. Let $X \subset X'$ be a finite order thickening
of algebraic spaces over $S$. Let $U$ be an affine object of
$X_{spaces, \acute{e}tale}$. Then
$$
\Gamma(U, \mathcal{O}_{X'}) \to \Gamma(U, \mathcal{O}_X)
$$
is surjective where we think of $\mathcal{O}_{X'}$ as a sheaf on
$X_{spaces, \acute{e}tale}$ via (\ref{equation-fundamental-equivalence}).
\end{lemma}

\begin{proof}
We may assume that $X \subset X'$ is a first order thickening by the
principle explained above. Denote $\mathcal{I}$ the kernel of the surjection
$\mathcal{O}_{X'} \to \mathcal{O}_X$. As $\mathcal{I}$ is a quasi-coherent
$\mathcal{O}_{X'}$-module and since $\mathcal{I}^2 = 0$ by the definition
of a first order thickening we may apply
Morphism of Spaces, Lemma \ref{spaces-morphisms-lemma-i-star-equivalence}
to see that $\mathcal{I}$ is a quasi-coherent $\mathcal{O}_X$-module.
Hence the lemma follows from the long exact cohomology sequence
associated to the short exact sequence
$$
0 \to \mathcal{I} \to \mathcal{O}_{X'} \to \mathcal{O}_X \to 0
$$
and the fact that $H^1_{\acute{e}tale}(U, \mathcal{I}) = 0$ as
$\mathcal{I}$ is quasi-coherent, see
Descent, Proposition \ref{descent-proposition-same-cohomology-quasi-coherent}
and
Coherent, Lemma \ref{coherent-lemma-quasi-coherent-affine-cohomology-zero}.
\end{proof}

\begin{lemma}
\label{lemma-first-order-thickening-scheme}
Let $S$ be a scheme. Let $X \subset X'$ be a finite order thickening
of algebraic spaces over $S$. If $X$ is (representable by) a scheme,
then so is $X'$.
\end{lemma}

\begin{proof}
It suffices to prove this when $X'$ is a first order thickening of $X$. By
Properties of Spaces, Lemma \ref{spaces-properties-lemma-subscheme}
there is a largest open subspace of $X'$ which is a scheme. Thus we have
to show that every point $x$ of $|X'| = |X|$ is contained in an open subspace of
$X'$ which is a scheme. Using
Lemma \ref{lemma-open-subspace-thickening}
we may replace $X \subset X'$ by $U \subset U'$ with $x \in U$ and $U$
an affine scheme. Hence we may assume that $X$ is affine.
Thus we reduce to the case discussed in the next paragraph.

\medskip\noindent
Assume $X \subset X'$ is a first order thickening where $X$ is an affine
scheme. Set $A = \Gamma(X, \mathcal{O}_X)$ and
$A' = \Gamma(X', \mathcal{O}_{X'})$. By
Lemma \ref{lemma-first-order-thickening-surjective}
the map $A \to A'$ is surjective. The kernel $I$ is an ideal of square zero. By
Properties of Spaces,
Lemma \ref{spaces-properties-lemma-morphism-to-affine-scheme}
we obtain a canonical morphism $f : X' \to \text{Spec}(A')$ which fits
into the following commutative diagram
$$
\xymatrix{
X \ar@{=}[d] \ar[r] &  X' \ar[d]^f \\
\text{Spec}(A) \ar[r] & \text{Spec}(A')
}
$$
Because the horizontal arrows are thickenings it is clear that $f$ is
universally injective and surjective. Hence it suffices to show that
$f$ is \'etale, since then
Morphisms of Spaces,
Lemma \ref{spaces-morphisms-lemma-etale-universally-injective-open}
will imply that $f$ is an isomorphism.

\medskip\noindent
To prove that $f$ is \'etale choose an affine scheme $U'$ and an
\'etale morphism $U' \to X'$. It suffices to show that
$U' \to X' \to \text{Spec}(A')$ is \'etale, see
Properties of Spaces, Definition \ref{spaces-properties-definition-etale}.
Write $U' = \text{Spec}(B')$. Set $U = X \times_{X'} U'$. Since $U$
is a closed subspace of $U'$, it is a closed subscheme, hence
$U = \text{Spec}(B)$ with $B' \to B$ surjective. Denote
$J = \text{Ker}(B' \to B)$ and note that $J = \Gamma(U, \mathcal{I})$
where $\mathcal{I} = \text{Ker}(\mathcal{O}_{X'} \to \mathcal{O}_X)$
on $X_{spaces, \acute{e}tale}$ as in the proof of
Lemma \ref{lemma-first-order-thickening-surjective}.
The morphism $U' \to X' \to \text{Spec}(A')$ induces a commutative
diagram
$$
\xymatrix{
0 \ar[r] &
J \ar[r] &
B' \ar[r] &
B \ar[r] & 0 \\
0 \ar[r] &
I \ar[r] \ar[u] &
A' \ar[r] \ar[u] &
A \ar[r] \ar[u] & 0
}
$$
Now, since $\mathcal{I}$ is a quasi-coherent $\mathcal{O}_X$-module
we have $\mathcal{I} = (\widetilde I)^a$, see
Descent, Definition \ref{descent-definition-structure-sheaf}
for notation and
Descent, Proposition \ref{descent-proposition-equivalence-quasi-coherent}
for why this is true. Hence we see that $J = I \otimes_A B$.
Finally, note that $A \to B$ is \'etale as $U \to X$ is \'etale as
the base change of the \'etale morphism $U' \to X'$.
We conclude that $A' \to B'$ is \'etale by
Algebra, Lemma \ref{algebra-lemma-lift-etale-infinitesimal}.
\end{proof}

\noindent
The following lemma will be superseded by the more general
(insert future reference here).

\begin{lemma}
\label{lemma-first-order-thickening-equivalence}
Let $S$ be a scheme. Let $X \subset X'$ be a first order thickening
of algebraic spaces over $S$. The functor
$$
V' \longmapsto V = X \times_{X'} V'
$$
defines an equivalence of categories
$X'_{\acute{e}tale} \to X_{\acute{e}tale}$.
\end{lemma}

\begin{proof}
The functor $V' \mapsto V$ defines an equivalence of categories
$X'_{spaces, \acute{e}tale} \to X_{spaces, \acute{e}tale}$, see
Theorem \ref{theorem-topological-invariance}.
Thus it suffices to show that $V$ is a scheme if and only if $V'$ is
a scheme. This is the content of
Lemma \ref{lemma-first-order-thickening-scheme}.
\end{proof}

\noindent
First order thickening are described as follows.

\begin{lemma}
\label{lemma-first-order-thickening}
Let $S$ be a scheme.
Let $f : X \to B$ be a morphism of algebraic spaces over $S$.
Consider a short exact sequence
$$
0 \to \mathcal{I} \to \mathcal{A} \to \mathcal{O}_X \to 0
$$
of sheaves on $X_{\acute{e}tale}$ where $\mathcal{A}$ is a sheaf of
$f^{-1}\mathcal{O}_B$-algebras, $\mathcal{A} \to \mathcal{O}_X$ is a surjection
of sheaves of $f^{-1}\mathcal{O}_B$-algebras, and $\mathcal{I}$ is its kernel.
If
\begin{enumerate}
\item $\mathcal{I}$ is an ideal of square zero in $\mathcal{A}$, and
\item $\mathcal{I}$ is quasi-coherent as an $\mathcal{O}_X$-module
\end{enumerate}
then there exists a first order thickening
$X \subset X'$ over $B$ and an isomorphism
$\mathcal{O}_{X'} \to \mathcal{A}$ of $f^{-1}\mathcal{O}_B$-algebras
compatible with the surjections to $\mathcal{O}_X$.
\end{lemma}

\begin{proof}
In this proof we redo some of the arguments used in the
proofs of
Lemmas \ref{lemma-first-order-thickening-surjective} and
\ref{lemma-first-order-thickening-scheme}.
We first handle the case $B = S = \text{Spec}(\mathbf{Z})$.
Let $U$ be an affine scheme, and let $U \to X$ be \'etale.
Then
$$
0 \to \mathcal{I}(U) \to \mathcal{A}(U) \to \mathcal{O}_X(U) \to 0
$$
is exact as $H^1(U_{\acute{e}tale}, \mathcal{I}) = 0$ as
$\mathcal{I}$ is quasi-coherent, see
Descent, Proposition \ref{descent-proposition-same-cohomology-quasi-coherent}
and
Coherent, Lemma \ref{coherent-lemma-quasi-coherent-affine-cohomology-zero}.
If $V \to U$ is a morphism of affine objects of $X_{spaces, \acute{e}tale}$
then
$$
\mathcal{I}(V) = \mathcal{I}(U) \otimes_{\mathcal{O}_X(U)} \mathcal{O}_X(V)
$$
since $\mathcal{I}$ is a quasi-coherent $\mathcal{O}_X$-module, see
Descent, Proposition \ref{descent-proposition-equivalence-quasi-coherent}.
Hence $\mathcal{A}(U) \to \mathcal{A}(V)$ is an
\'etale ring map, see
Algebra, Lemma \ref{algebra-lemma-lift-etale-infinitesimal}.
Hence we see that
$$
U \longmapsto U' = \text{Spec}(\mathcal{A}(U))
$$
is a functor from $X_{affine, \acute{e}tale}$ to the category of affine
schemes and \'etale morphisms. In fact, we claim that this functor can
be extended to a functor $U \mapsto U'$ on all of $X_{\acute{e}tale}$.
To see this, if $U$ is an object of $X_{\acute{e}tale}$, note that
$$
0 \to \mathcal{I}|_{U_{Zar}} \to \mathcal{A}|_{U_{Zar}} \to
\mathcal{O}_X|_{U_{Zar}} \to 0
$$
and $\mathcal{I}|_{U_{Zar}}$ is a quasi-coherent sheaf on $U$, see
Descent,
Proposition \ref{descent-proposition-equivalence-quasi-coherent-functorial}.
Hence by
More on Morphisms, Lemma \ref{more-morphisms-lemma-first-order-thickening}
we obtain a first order thickening $U \subset U'$ of schemes such that
$\mathcal{O}_{U'}$ is isomorphic to $\mathcal{A}|_{U_{Zar}}$. It is clear that
this construction is compatible with the construction for affines above.

\medskip\noindent
Choose a presentation $X = U/R$, see
Spaces, Definition \ref{spaces-definition-presentation}
so that $s, t : R \to U$ define an \'etale equivalence relation.
Applying the functor above we obtain an \'etale equivalence
relation $s', t' : R' \to U'$ in schemes. Consider the algebraic space
$X' = U'/R'$ (see
Spaces, Theorem \ref{spaces-theorem-presentation}).
The morphism $X = U/R \to U'/R' = X'$ is a first order thickening.
Consider $\mathcal{O}_{X'}$ viewed as a sheaf on $X_{\acute{e}tale}$.
By construction we have an isomorphism
$$
\gamma :
\mathcal{O}_{X'}|_{U_{\acute{e}tale}}
\longrightarrow
\mathcal{A}|_{U_{\acute{e}tale}}
$$
such that $s^{-1}\gamma$ agrees with $t^{-1}\gamma$ on $R_{\acute{e}tale}$.
Hence by
Properties of Spaces, Lemma \ref{spaces-properties-lemma-descent-sheaf}
this implies that $\gamma$ comes from a unique isomorphism
$\mathcal{O}_{X'} \to \mathcal{A}$ as desired.

\medskip\noindent
To handle the case of a general base algebraic space $B$, we first
construct $X'$ as an algebraic space over $\mathbf{Z}$ as above.
Then we use the isomorphism $\mathcal{O}_{X'} \to \mathcal{A}$ to
define $f^{-1}\mathcal{O}_B \to \mathcal{O}_{X'}$. According to
Lemma \ref{lemma-first-order-thickening-maps}
this defines a morphism $X' \to B$ compatible with the given morphism
$X \to B$ and we are done.
\end{proof}







\section{First order infinitesimal neighbourhood}
\label{section-first-order-infinitesimal-neighbourhood}

\noindent
A natural construction of first order thickenings is the following.
Suppose that $i : Z \to X$ be an immersion of algebraic spaces. Choose an
open subspace $U \subset X$ such that $i$ identifies $Z$ with a closed
subspace $Z \subset U$ (see
Morphisms of Spaces, Remark \ref{spaces-morphisms-remark-immersion}).
Let $\mathcal{I} \subset \mathcal{O}_U$ be the
quasi-coherent sheaf of ideals defining $Z$ in $U$, see
Morphisms of Spaces,
Lemma \ref{spaces-morphisms-lemma-closed-immersion-ideals}.
Then we can consider
the closed subspace $Z' \subset U$ defined by the quasi-coherent sheaf
of ideals $\mathcal{I}^2$.

\begin{definition}
\label{definition-first-order-infinitesimal-neighbourhood}
Let $i : Z \to X$ be an immersion of algebraic spaces. The
{\it first order infinitesimal neighbourhood} of $Z$ in $X$ is
the first order thickening $Z \subset Z'$ over $X$ described above.
\end{definition}

\noindent
This thickening has the following universal property (which will assuage
any fears that the construction above depends on the choice of the open
$U$).

\begin{lemma}
\label{lemma-first-order-infinitesimal-neighbourhood}
Let $i : Z \to X$ be an immersion of algebraic spaces.
The first order infinitesimal neighbourhood $Z'$ of $Z$ in $X$
has the following universal property:
Given any commutative diagram
$$
\xymatrix{
Z \ar[d]_i & T \ar[l]^a \ar[d] \\
X & T' \ar[l]_b
}
$$
where $T \subset T'$ is a first order thickening over $X$, there exists
a unique morphism $(a', a) : (T \subset T') \to (Z \subset Z')$ of
thickenings over $X$.
\end{lemma}

\begin{proof}
Let $U \subset X$ be the open subspace used in the construction of $Z'$,
i.e., an open such that $Z$ is identified with a closed subspace of $U$
cut out by the quasi-coherent sheaf of ideals $\mathcal{I}$.
Since $|T| = |T'|$ we see that $|b|(|T'|) \subset |U|$. Hence we can
think of $b$ as a morphism into $U$, see
Properties of Spaces,
Lemma \ref{spaces-properties-lemma-factor-through-open-subspace}.
Let $\mathcal{J} \subset \mathcal{O}_{T'}$
be the square zero quasi-coherent sheaf of ideals cutting out $T$.
By the commutativity of the diagram we have $b|_T = i \circ a$ where
$i : Z \to U$ is the closed immersion. We conclude that
$b^\sharp(b^{-1}\mathcal{I}) \subset \mathcal{J}$ by
Morphisms of Spaces,
Lemma \ref{spaces-morphisms-lemma-closed-immersion-ideals}.
As $T'$ is a first order thickening of $T$ we see that $\mathcal{J}^2 = 0$
hence $b^\sharp(b^{-1}(\mathcal{I}^2)) = 0$. By
Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-closed-immersion-ideals}
this implies that $b$ factors through $Z'$. Letting $a' : T' \to Z'$
be this factorization we win.
\end{proof}

\begin{lemma}
\label{lemma-infinitesimal-neighbourhood-conormal}
Let $i : Z \to X$ be an immersion of algebraic spaces.
Let $Z \subset Z'$ be the first order infinitesimal neighbourhood
of $Z$ in $X$. Then the diagram
$$
\xymatrix{
Z \ar[r] \ar[d] & Z' \ar[d] \\
Z \ar[r] & X
}
$$
induces a map of conormal sheaves
$\mathcal{C}_{Z/X} \to \mathcal{C}_{Z/Z'}$ by
Lemma \ref{lemma-conormal-functorial}.
This map is an isomorphism.
\end{lemma}

\begin{proof}
This is clear from the construction of $Z'$ above.
\end{proof}





\section{Formally smooth, \'etale, unramified transformations}
\label{section-formally-smooth-etale-unramified}

\noindent
Recall that a ring map $R \to A$ is called
{\it formally smooth}, resp.\ {\it formally \'etale},
resp.\ {\it formally unramified}
(see Algebra, Definition \ref{algebra-definition-formally-smooth},
resp.\ Definition \ref{algebra-definition-formally-etale},
resp.\ Definition \ref{algebra-definition-formally-unramified})
if for every commutative solid diagram
$$
\xymatrix{
A \ar[r] \ar@{-->}[rd] & B/I \\
R \ar[r] \ar[u] & B \ar[u]
}
$$
where $I \subset B$ is an ideal of square zero, there
exists a, resp.\ exists a unique, resp.\ exists at most one dotted
arrow which makes the diagram commute. This motivates
the following analogue for morphisms of algebraic spaces, and more
generally functors.

\begin{definition}
\label{definition-formally-smooth-etale-unramified}
Let $S$ be a scheme.
Let $a : F \to G$ be a transformation of functors
$F, G : (\textit{Sch}/S)_{fppf}^{opp} \to \textit{Sets}$.
Consider commutative solid diagrams of the form
$$
\xymatrix{
F \ar[d]_a & T \ar[d]^i \ar[l] \\
G & T' \ar[l] \ar@{-->}[lu]
}
$$
where $T$ and $T'$ are affine schemes and $i$ is a closed immersion
defined by an ideal of square zero.
\begin{enumerate}
\item We say $a$ is {\it formally smooth} if given any solid
diagram as above there exists a dotted arrow making the diagram
commute\footnote{This is just one possible definition that one can
make here. Another slightly weaker condition would be to require that
the dotted arrow exists fppf locally on $T'$. This weaker notion
has in some sense better formal properties.}.
\item We say $a$ is {\it formally \'etale} if given any solid
diagram as above there exists exactly one dotted arrow making the diagram
commute.
\item We say $a$ is {\it formally unramified} if given any solid
diagram as above there exists at most one dotted arrow making the diagram
commute.
\end{enumerate}
\end{definition}

\begin{lemma}
\label{lemma-formally-etale-is-combination}
Let $S$ be a scheme.
Let $a : F \to G$ be a transformation of functors
$F, G : (\textit{Sch}/S)_{fppf}^{opp} \to \textit{Sets}$.
Then $a$ is formally \'etale if and only if $a$ is both formally
smooth and formally unramified.
\end{lemma}

\begin{proof}
Formal from the definition.
\end{proof}

\begin{lemma}
\label{lemma-composition-formally-smooth-etale-unramified}
Composition.
\begin{enumerate}
\item A composition of formally smooth transformations of functors is formally
smooth.
\item A composition of formally \'etale transformations of functors is formally
\'etale.
\item A composition of formally unramified transformations of functors is
formally unramified.
\end{enumerate}
\end{lemma}

\begin{proof}
This is formal.
\end{proof}

\begin{lemma}
\label{lemma-base-change-formally-smooth-etale-unramified}
Let $S$ be a scheme contained in $\textit{Sch}_{fppf}$.
Let $F, G, H : (\textit{Sch}/S)_{fppf}^{opp} \to \textit{Sets}$.
Let $a : F \to G$, $b : H \to G$ be transformations of functors.
Consider the fibre product diagram
$$
\xymatrix{
H \times_{b, G, a} F \ar[r]_-{b'} \ar[d]_{a'} & F \ar[d]^a \\
H \ar[r]^b & G
}
$$
\begin{enumerate}
\item If $a$ is formally smooth, then the base change $a'$ is
formally smooth.
\item If $a$ is formally \'etale, then the base change $a'$ is
formally \'etale.
\item If $a$ is formally unramified, then the base change $a'$ is
formally unramified.
\end{enumerate}
\end{lemma}

\begin{proof}
This is formal.
\end{proof}

\begin{lemma}
\label{lemma-representable-property-formally-property}
Let $S$ be a scheme.
Let $F, G : (\textit{Sch}/S)_{fppf}^{opp} \to \textit{Sets}$.
Let $a : F \to G$ be a representable tranformation of functors.
\begin{enumerate}
\item If $a$ is smooth then $a$ is formally smooth.
\item If $a$ is \'etale, then $a$ is formally \'etale.
\item If $a$ is unramified, then $a$ is formally unramified.
\end{enumerate}
\end{lemma}

\begin{proof}
Consider a solid commutative diagram
$$
\xymatrix{
F \ar[d]_a & T \ar[d]^i \ar[l] \\
G & T' \ar[l] \ar@{-->}[lu]
}
$$
as in
Definition \ref{definition-formally-smooth-etale-unramified}.
Then $F \times_G T'$ is a scheme smooth (resp.\ \'etale, resp.\ unramified)
over $T'$. Hence by
More on Morphisms, Lemma \ref{more-morphisms-lemma-smooth-formally-smooth}
(resp.\ Lemma \ref{more-morphisms-lemma-etale-formally-etale}, 
resp.\ Lemma \ref{more-morphisms-lemma-unramified-formally-unramified})
we can fill in (resp.\ uniquely fill in, resp.\ fill in in at most
one way) the dotted arrow in the diagram
$$
\xymatrix{
F \times_G T' \ar[d] & T \ar[d]^i \ar[l] \\
T' & T' \ar[l] \ar@{-->}[lu]
}
$$
an hence we also obtain the corresponding assertion in the first diagram.
\end{proof}

\begin{lemma}
\label{lemma-etale-on-top}
Let $S$ be a scheme contained in $\textit{Sch}_{fppf}$.
Let $F, G, H : (\textit{Sch}/S)_{fppf}^{opp} \to \textit{Sets}$.
Let $a : F \to G$, $b : G \to H$ be transformations of functors.
Assume that $a$ is representable, surjective, and \'etale.
\begin{enumerate}
\item If $b$ is formally smooth, then $b \circ a$ is formally smooth.
\item If $b$ is formally \'etale, then $b \circ a$ is formally \'etale.
\item If $b$ is formally unramified, then $b \circ a$ is formally unramified.
\end{enumerate}
Conversely, consider a solid commutative diagram
$$
\xymatrix{
G \ar[d]_b & T \ar[d]^i \ar[l] \\
H & T' \ar[l] \ar@{-->}[lu]
}
$$
with $T'$ an affine scheme over $S$
and $i : T \to T'$ a closed immersion defined by an ideal of square zero.
\begin{enumerate}
\item[(4)] If $b \circ a$ is formally smooth, then for every $t \in T$
there exists an \'etale morphism of affines $U' \to T'$ and a morphism
$U' \to G$ such that
$$
\xymatrix{
G \ar[d]_b & T \ar[l] & T \times_{T'} U' \ar[d] \ar[l]\\
H & T' \ar[l] & U' \ar[llu] \ar[l]
}
$$
commutes and $t$ is in the image of $U' \to T'$.
\item[(5)] If $b \circ a$ is formally unramified, then there exists at most
one dotted arrow in the diagram above, i.e., $b$ is formally unramified.
\item[(6)] If $b \circ a$ is formally \'etale, then there exists exactly one
dotted arrow in the diagram above, i.e., $b$ is formally \'etale.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume $b$ is formally smooth (resp.\ formally \'etale,
resp.\ formally unramified). Since an \'etale morphism is both
smooth and unramified we see that $a$ is representable and smooth
(resp.\ \'etale, resp. unramified). Hence parts (1), (2) and (3)
follow from a combination of
Lemma \ref{lemma-representable-property-formally-property}
and
Lemma \ref{lemma-composition-formally-smooth-etale-unramified}.

\medskip\noindent
Assume that $b \circ a$ is formally smooth. Consider a diagram
as in the statement of the lemma. Let $W = F \times_G T$.
By assumption $W$ is a scheme surjective \'etale over $T$. By
\'Etale Morphisms of Schemes, Theorem \ref{etale-theorem-remarkable-equivalence}
there exists a scheme $W'$ \'etale over $T'$ such that $W = T \times_{T'} W'$.
Choose an affine open subscheme $U' \subset W'$ such that $t$ is in
the image of $U' \to T'$. Because $b \circ a$ is formally
smooth we see that the exist morphisms $U' \to F$ such that
$$
\xymatrix{
F \ar[d]_{b \circ a} & W \ar[l] & T \times_{T'} U' \ar[d] \ar[l]\\
H & T' \ar[l] & U' \ar[llu] \ar[l]
}
$$
commutes. Taking the composition $U' \to F \to G$ gives a
map as in part (5) of the lemma.

\medskip\noindent
Assume that $f, g : T' \to G$ are two dotted arrows fitting into the
diagram of the lemma. Let $W = F \times_G T$.
By assumption $W$ is a scheme surjective \'etale over $T$. By
\'Etale Morphisms of Schemes, Theorem \ref{etale-theorem-remarkable-equivalence}
there exists a scheme $W'$ \'etale over $T'$ such that $W = T \times_{T'} W'$.
Since $a$ is formally \'etale the compositions
$$
W' \to T' \xrightarrow{f} G
\quad\text{and}\quad
W' \to T' \xrightarrow{g} G
$$
lift to morphisms $f', g' : W' \to F$ (lift on affine opens and glue by
uniqueness). Now if $b \circ a : F \to H$ is formally unramified, then
$f' = g'$ and hence $f = g$ as $W' \to T'$ is an \'etale covering. This proves
part (6) of the lemma.

\medskip\noindent
Assume that $b \circ a$ is formally \'etale. Then by part (4) we
can \'etale locally on $T'$ find a dotted arrow fitting into the diagram
and by part (5) this dotted arrow is unique. Hence we may glue the
local solutions to get assertion (6). Some details omitted.
\end{proof}

\begin{remark}
\label{remark-tempting}
It is tempting to think that in the situation of
Lemma \ref{lemma-etale-on-top}
we have
``$b$ formally smooth'' $\Leftrightarrow$ ``$b \circ a$ formally smooth''.
However, this is likely not true in general.
\end{remark}

\begin{lemma}
\label{lemma-formally-permanence}
Let $S$ be a scheme.
Let $F, G, H : (\textit{Sch}/S)_{fppf}^{opp} \to \textit{Sets}$.
Let $a : F \to G$, $b : G \to H$ be transformations of functors.
Assume $b$ is formally unramified.
\begin{enumerate}
\item If $b \circ a$ is formally unramified then $a$ is formally unramified.
\item If $b \circ a$ is formally \'etale then $a$ is formally \'etale.
\item If $b \circ a$ is formally smooth then $a$ is formally smooth.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $T \subset T'$ be a closed immersion of affine schemes defined by an ideal
of square zero. Let $g' : T' \to G$ and $f : T \to F$ be given such that
$g'|_T = a \circ f$. Because $b$ is formally unramified, there is a one
to one correspondence between
$$
\{f' : T' \to F \mid f = f'|_T\text{ and }a \circ f' = g'\}
$$
and
$$
\{f' : T' \to F \mid f = f'|_T\text{ and }b \circ a \circ f' = b \circ g'\}.
$$
From this the lemma follows formally.
\end{proof}








\section{Formally unramified morphisms}
\label{section-formally-unramified}

\noindent
In this section we work out what it means that a morphism of algebraic spaces
is formally unramified.

\begin{definition}
\label{definition-formally-unramified}
Let $S$ be a scheme. A morphism $f : X \to Y$ of algebraic spaces over $S$
is said to be {\it formally unramified} if it is formally unramified as a
transformation of functors as in
Definition \ref{definition-formally-smooth-etale-unramified}.
\end{definition}

\noindent
We will not restate the results proved in the more general setting of
formally unramified transformations of functors in
Section \ref{section-formally-smooth-etale-unramified}.
It turns out we can characterize this property in terms of vanishing of the
module of relative differentials, see
Lemma \ref{lemma-characterize-formally-unramified}.

\begin{lemma}
\label{lemma-formally-unramified}
Let $S$ be a scheme. Let $f : X \to Y$ be a morphism of algebraic spaces over
$S$. The following are equivalent:
\begin{enumerate}
\item $f$ is formally unramified,
\item for every diagram
$$
\xymatrix{
U \ar[d] \ar[r]_\psi & V \ar[d] \\
X \ar[r]^f & Y
}
$$
where $U$ and $V$ are schemes and the vertical arrows are \'etale
the morphism of schemes $\psi$ is formally unramified (as in
More on Morphisms,
Definition \ref{more-morphisms-definition-formally-unramified}), and
\item for one such diagram with surjective vertical arrows the morphism
$\psi$ is formally unramified.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume $f$ is formally unramified. By
Lemma \ref{lemma-representable-property-formally-property}
the morphisms $U \to X$ and $V \to Y$ are formally unramified. Thus by
Lemma \ref{lemma-composition-formally-smooth-etale-unramified}
the composition $U \to Y$ is formally unramified. Then it follows from
Lemma \ref{lemma-formally-permanence}
that $U \to V$ is formally unramified. Thus (1) implies (2). And (2)
implies (3) trivially

\medskip\noindent
Assume given a diagram as in (3). By
Lemma \ref{lemma-representable-property-formally-property}
the morphism $V \to Y$ is formally unramified. Thus by
Lemma \ref{lemma-composition-formally-smooth-etale-unramified}
the composition $U \to Y$ is formally unramified. Then it follows from
Lemma \ref{lemma-etale-on-top}
that $X \to Y$ is formally unramified, i.e., (1) holds.
\end{proof}

\begin{lemma}
\label{lemma-formally-unramified-not-affine}
Let $S$ be a scheme.
If $f : X \to Y$ is a formally unramified morphism of algebraic spaces
over $S$, then given any solid commutative diagram
$$
\xymatrix{
X \ar[d]_f & T \ar[d]^i \ar[l] \\
S & T' \ar[l] \ar@{-->}[lu]
}
$$
where $T \subset T'$ is a first order thickening of algebraic spaces
over $S$ there exists at most one dotted arrow making the diagram commute.
In other words, in
Definition \ref{definition-formally-unramified}
the condition that $T$ be an affine scheme may be dropped.
\end{lemma}

\begin{proof}
This is true because there exists a surjective \'etale morphism
$U' \to T'$ where $U'$ is a disjoint union of affine schemes (see
Properties of spaces,
Lemma \ref{spaces-properties-lemma-cover-by-union-affines})
and a morphism $T' \to X$ is determined by its restriction to $U'$.
\end{proof}

\begin{lemma}
\label{lemma-composition-formally-unramified}
A composition of formally unramified morphisms is formally unramified.
\end{lemma}

\begin{proof}
This is formal.
\end{proof}

\begin{lemma}
\label{lemma-base-change-formally-unramified}
A base change of a formally unramified morphism is formally unramified.
\end{lemma}

\begin{proof}
This is formal.
\end{proof}








\begin{lemma}
\label{lemma-characterize-formally-unramified}
Let $S$ be a scheme. Let $f : X \to Y$ be a morphism of algebraic spaces over
$S$. The following are equivalent:
\begin{enumerate}
\item $f$ is formally unramified, and
\item $\Omega_{X/Y} = 0$.
\end{enumerate}
\end{lemma}

\begin{proof}
This is a combination of
Lemma \ref{lemma-formally-unramified},
More on Morphisms,
Lemma \ref{more-morphisms-lemma-formally-unramified-differentials},
and
Lemma \ref{lemma-localize-differentials}.
\end{proof}

\begin{lemma}
\label{lemma-unramified-formally-unramified}
Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism of algebraic spaces over $S$.
The following are equivalent:
\begin{enumerate}
\item The morphism $f$ is unramified,
\item the morphism $f$ is locally of finite type and $\Omega_{X/Y} = 0$, and
\item the morphism $f$ is locally of finite type and formally unramified.
\end{enumerate}
\end{lemma}

\begin{proof}
Choose a diagram
$$
\xymatrix{
U \ar[d] \ar[r]_\psi & V \ar[d] \\
X \ar[r]^f & Y
}
$$
where $U$ and $V$ are schemes and the vertical arrows are \'etale and
surjective. Then we see
\begin{align*}
f\text{ unramified}
& \Leftrightarrow
\psi\text{ unramified} \\
& \Leftrightarrow
\psi\text{ locally finite type and }\Omega_{U/V} = 0 \\
& \Leftrightarrow
f\text{ locally finite type and }\Omega_{X/Y} = 0 \\
& \Leftrightarrow
f\text{ locally finite type and formally unramified}
\end{align*}
Here we have used 
Morphisms, Lemma \ref{morphisms-lemma-unramified-omega-zero} and
Lemma \ref{lemma-characterize-formally-unramified}.
\end{proof}

\begin{lemma}
\label{lemma-universally-injective-unramified}
Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism of algebraic spaces over $S$.
The following are equivalent:
\begin{enumerate}
\item $f$ is unramified and a monomorphism,
\item $f$ is unramified and universally injective,
\item $f$ is locally of finite type and a monomorphism,
\item $f$ is universally injective, locally of finite type, and
formally unramfied.
\end{enumerate}
Moreover, in this case $f$ is also representable, separated, and
locally quasi-finite.
\end{lemma}

\begin{proof}
We have seen in
Lemma \ref{lemma-unramified-formally-unramified}
that being formally unramified and locally of finite type is the same thing
as being unramified.
Hence (4) is equivalent to (2).
A monomorphism is certainly formally unramified hence (3) implies (4).
It is clear that (1) implies (3). Finally, if (2) holds, then
$\Delta : X \to X \times_Y X$ is both an open immersion
(Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-diagonal-unramfied-morphism})
and surjective
(Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-universally-injective})
hence an isomorphism, i.e., $f$ is a monomorphism. In this way we see that
(2) implies (1).
Finally, we see that $f$ is representable, separated, and locally
quasi-finite by
Morphisms of Spaces, Lemmas
\ref{spaces-morphisms-lemma-monomorphism-loc-finite-type-loc-quasi-finite} and
\ref{spaces-morphisms-lemma-locally-quasi-finite-separated-representable}.
\end{proof}






\section{Universal first order thickenings}
\label{section-universal-thickening}

\noindent
Let $S$ be a scheme.
Let $h : Z \to X$ be a morphism of algebraic spaces over $S$.
A {\it universal first order thickening} of $Z$ over $X$ is a
first order thickening $Z \subset Z'$ over $X$ such that given
any first order thickening $T \subset T'$
over $X$ and a solid commutative diagram
\begin{equation}
\label{equation-universal-first-order-thickening}
\vcenter{
\xymatrix{
& Z \ar[ld] & & T \ar[rd] \ar[ll]^a \\
Z' \ar[rrd] & & & & T' \ar@{..>}[llll]_{a'} \ar[lld]^b \\
 & & X
}
}
\end{equation}
there exists a unique dotted arrow making the diagram commute.
Note that in this situation $(a, a') : (T \subset T') \to (Z \subset Z')$
is a morphism of thickenings over $X$. Thus if a universal first order
thickening exists, then it is unique up to unique isomorphism.
In general a universal first order thickening
does not exist, but if $h$ is formally unramified then it does.
Before we prove this, let us show that a universal first order thickening
in the category of schemes is a universal first order thickening in the
category of algebraic spaces.

\begin{lemma}
\label{lemma-check-universal-first-order-thickening}
Let $S$ be a scheme.
Let $h : Z \to X$ be a morphism of algebraic spaces over $S$.
Let $Z \subset Z'$ be a first order thickening over $X$.
The following are equivalent
\begin{enumerate}
\item $Z \subset Z'$ is a universal first order thickening,
\item for any diagram (\ref{equation-universal-first-order-thickening})
with $T'$ a scheme a unique dotted arrow exists making the diagram commute, and
\item for any diagram (\ref{equation-universal-first-order-thickening})
with $T'$ an affine scheme a unique dotted arrow exists making the
diagram commute.
\end{enumerate}
\end{lemma}

\begin{proof}
The implications (1) $\Rightarrow$ (2) $\Rightarrow$ (3) are formal.
Assume (3) a assume given an arbitrary diagram
(\ref{equation-universal-first-order-thickening}).
Choose a presentation $T' = U'/R'$, see
Spaces, Definition \ref{spaces-definition-presentation}.
We may assume that $U' = \coprod U'_i$ is a disjoint union
of affines, so $R' = U' \times_{T'} U' = \coprod_{i, j} U'_i \times_T' U'_j$.
For each pair $(i, j)$ choose an affine open covering
$U'_i \times_T' U'_j = \bigcup_k R'_{ijk}$. Denote $U_i, R_{ijk}$
the fibre products with $T$ over $T'$. Then each
$U_i \subset U'_i$ and $R_{ijk} \subset R'_{ijk}$
is a first order thickening of affine schemes.
Denote $a_i : U_i \to Z$, resp.\ $a_{ijk} : R_{ijk} \to Z$
the composition of $a : T \to Z$ with the morphism
$U_i \to T$, resp.\ $R_{ijk} \to T$.
By (3) applied to $a_i : U_i \to Z$
we obtain unique morphisms $a'_i : U'_i \to Z'$.
By (3) applied to $a_{ijk}$ we see that the two compositions
$R'_{ijk} \to R'_i \to Z'$ and $R'_{ijk} \to R'_j \to Z'$
are equal. Hence $a' = \coprod a'_i : U' = \coprod U'_i \to Z'$
descends to the quotient sheaf $T' = U'/R'$ and we win.
\end{proof}

\begin{lemma}
\label{lemma-universal-thickening-over-formally-etale}
Let $S$ be a scheme.
Let $Z \to Y \to X$ be morphisms of algebraic spaces over $S$.
If $Z \subset Z'$ is a universal first order thickening of
$Z$ over $Y$ and $Y \to X$ is formally \'etale, then $Z \subset Z'$ is
a universal first order thickening of $Z$ over $X$.
\end{lemma}

\begin{proof}
This is formal. Namely, by
Lemma \ref{lemma-check-universal-first-order-thickening}
it suffices to consider solid commutative diagrams
(\ref{equation-universal-first-order-thickening})
with $T'$ an affine scheme. The composition
$T \to Z \to Y$ lifts uniquely to $T' \to Y$ as $Y \to X$ is
assumed formally \'etale. Hence the fact that
$Z \subset Z'$ is a universal first order thickening over $Y$
produces the desired morphism $a' : T' \to Z'$.
\end{proof}

\begin{lemma}
\label{lemma-etale-morphism-of-universal-thickenings}
Let $S$ be a scheme.
Let $Z \to Y \to X$ be morphisms of algebraic spaces over $S$.
Assume $Z \to Y$ is \'etale.
\begin{enumerate}
\item If $Y \subset Y'$ is a universal first order thickening of
$Y$ over $X$, then the unique \'etale morphism $Z' \to Y'$ such
that $Z = Y \times_{Y'} Z'$ (see
Theorem \ref{theorem-topological-invariance})
is a universal first order thickening of $Z$ over $X$.
\item If $Z \to Y$ is surjective and
$(Z \subset Z') \to (Y \subset Y')$ is an \'etale morphism
of first order thickenings over $X$ and $Z'$ is a universal first
order thickening of $Z$ over $X$, then $Y'$ is a universal first
order thickening of $Y$ over $X$.
\end{enumerate}
\end{lemma}

\begin{proof}
Proof of (1). By
Lemma \ref{lemma-check-universal-first-order-thickening}
it suffices to consider solid commutative diagrams
(\ref{equation-universal-first-order-thickening})
with $T'$ an affine scheme. The composition
$T \to Z \to Y$ lifts uniquely to $T' \to Y'$ as $Y'$ is
the universal first order thickening. Then the fact that
$Z' \to Y'$ is \'etale implies that $T' \to Y'$ lifts to the
desired morphism $a' : T' \to Z'$.

\medskip\noindent
Proof of (2). Let $T \subset T'$ be a first order thickening over
$X$ and let $a : T \to Y$ be a morphism. Set $W = T \times_Y Z$
and denote $c : W \to Z$ the projection
Let $W' \to T'$ be the unique \'etale morphism such that
$W = T \times_{T'} W'$, see
Theorem \ref{theorem-topological-invariance}.
Note that $W' \to T'$ is surjective as $Z \to Y$ is surjective.
By assumption we obtain a unique morphism $c' : W' \to Z'$
over $X$ restricting to $c$ on $W$. By uniqueness the two restrictions
of $c'$ to $W' \times_{T'} W'$ are equal (as the two restrictions of
$c$ to $W \times_T W$ are equal). Hence $c'$ descends to a unique
morphism $a' : T' \to Y'$ and we win.
\end{proof}

\begin{lemma}
\label{lemma-universal-thickening}
Let $S$ be a scheme.
Let $h : Z \to X$ be a formally unramified morphism of algebraic
spaces over $S$.
There exists a universal first order thickening $Z \subset Z'$ of
$Z$ over $X$.
\end{lemma}

\begin{proof}
Choose any commutative diagram
$$
\xymatrix{
V \ar[d] \ar[r] & U \ar[d] \\
Z \ar[r] & X
}
$$
where $V$ and $U$ are schemes and the vertical arrows are \'etale.
Note that $V \to U$ is a formally unramified morphism of schemes, see
Lemma \ref{lemma-formally-unramified}.
Combining
Lemma \ref{lemma-check-universal-first-order-thickening}
and
More on Morphisms, Lemma \ref{more-morphisms-lemma-universal-thickening}
we see that a universal first order thickening $V \subset V'$
of $V$ over $U$ exists. By
Lemma \ref{lemma-universal-thickening-over-formally-etale} part (1)
$V'$ is a universal first order thickening of $V$ over $X$.

\medskip\noindent
Fix a scheme $U$ and a surjective \'etale morphism $U \to X$.
The argument above shows that for any $V \to Z$ \'etale with $V$
a scheme such that $V \to Z \to X$ factors through $U$ a
universal first order thickening $V \subset V'$ of $V$ over $X$
exists (but does not depend on the chosen factorization of $V \to X$
through $U$). Now we may choose $V$ such that $V \to Z$ is surjective
\'etale (see
Spaces, Lemma \ref{spaces-lemma-lift-morphism-presentations}).
Then $R = V \times_Z V$ a scheme \'etale over $Z$ such that
$R \to X$ factors through $U$ also.
Hence we obtain universal first order thickenings
$V \subset V'$ and $R \subset R'$ over $X$.
As $V \subset V'$ is a universal first order thickening,
the two projections $s, t : R \to V$ lift to morphisms
$s', t': R' \to V'$. By
Lemma \ref{lemma-etale-morphism-of-universal-thickenings}
as $R'$ is the universal first order thickening of $R$ over $X$
these morphisms are \'etale.
Then $(t', s') : R' \to V'$ is an \'etale equivalence relation
and we can set $Z' = V'/R'$. Since $V' \to Z'$ is surjective \'etale
and $v'$ is the universal first order thickening of $V$ over $X$
we conclude from
Lemma \ref{lemma-universal-thickening-over-formally-etale} part (2)
that $Z'$ is a universal first order thickening of $Z$ over $X$.
\end{proof}

\begin{definition}
\label{definition-universal-thickening}
Let $S$ be a scheme.
Let $h : Z \to X$ be a formally unramified morphism of
algebraic spaces over $S$.
\begin{enumerate}
\item The {\it universal first order thickening} of $Z$ over $X$
is the thickening $Z \subset Z'$ constructed in
Lemma \ref{lemma-universal-thickening}.
\item The {\it conormal sheaf of $Z$ over $X$} is the conormal sheaf
of $Z$ in its universal first order thickening $Z'$ over $X$.
\end{enumerate}
We often denote the conormal sheaf $\mathcal{C}_{Z/X}$ in this situation.
\end{definition}

\noindent
Thus we see that there is a short exact sequence of sheaves
$$
0 \to \mathcal{C}_{Z/X} \to \mathcal{O}_{Z'} \to \mathcal{O}_Z \to 0
$$
on $Z_{\acute{e}tale}$ and $\mathcal{C}_{Z/X}$ is a quasi-coherent
$\mathcal{O}_Z$-module. The following lemma proves that there is no
conflict between this definition and the definition in case $Z \to X$
is an immersion.

\begin{lemma}
\label{lemma-immersion-universal-thickening}
Let $S$ be a scheme.
Let $i : Z \to X$ be an immersion of algebraic spaces over $S$. Then
\begin{enumerate}
\item $i$ is formally unramified,
\item the universal first order thickening of $Z$ over $X$ is the first order
infinitesimal neighbourhood of $Z$ in $X$ of
Definition \ref{definition-first-order-infinitesimal-neighbourhood},
\item the conormal sheaf of $i$ in the sense of
Definition \ref{definition-conormal-sheaf}
agrees with the conormal sheaf of $i$ in the sense of
Defintion \ref{definition-universal-thickening}.
\end{enumerate}
\end{lemma}

\begin{proof}
An immersion of algebraic spaces is by definition a representable morphism.
Hence by
Morphisms, Lemmas \ref{morphisms-lemma-open-immersion-unramified} and
\ref{morphisms-lemma-closed-immersion-unramified}
an immersion is unramified (via the abstract principle of
Spaces, Lemma
\ref{spaces-lemma-representable-transformations-property-implication}).
Hence it is formally unramified by
Lemma \ref{lemma-unramified-formally-unramified}.
The other assertions follow by combining
Lemmas \ref{lemma-first-order-infinitesimal-neighbourhood} and
\ref{lemma-infinitesimal-neighbourhood-conormal}
and the definitions.
\end{proof}

\begin{lemma}
\label{lemma-universal-thickening-unramfied}
Let $S$ be a scheme.
Let $Z \to X$ be a formally unramified morphism of algebraic spaces over $S$.
Then the universal first order thickening $Z'$ is formally
unramified over $X$.
\end{lemma}

\begin{proof}
Let $T \subset T'$ be a first order thickening of affine schemes over $X$.
Let
$$
\xymatrix{
Z' \ar[d] & T \ar[l]^c \ar[d] \\
X & T' \ar[l] \ar[lu]^{a, b}
}
$$
be a commutative diagram. Set $T_0 = c^{-1}(Z) \subset T$ and
$T'_a = a^{-1}(Z)$ (scheme theoretically).
Since $Z'$ is a first order thickening of $Z$, we see that $T'$
is a first order thickening of $T'_a$. Moreover, since $c = a|_T$ we see that
$T_0 = T \cap T'_a$ (scheme theoretically). As $T'$ is a first order
thickening of $T$ it follows that $T'_a$
is a first order thickening of $T_0$. Now $a|_{T'_a}$ and $b|_{T'_a}$
are morphisms of $T'_a$ into $Z'$ over $X$ which agree on $T_0$ as
morphisms into $Z$. Hence by the universal property of $Z'$ we conclude that
$a|_{T'_a} = b|_{T'_a}$. Thus $a$ and $b$ are morphism from
the first order thickening $T'$ of $T'_a$ whose restrictions to
$T'_a$ agree as morphisms into $Z$. Thus using the universal property of
$Z'$ once more we conclude that $a = b$. In other words, the defining
property of a formally unramfied morphism holds for $Z' \to X$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-universal-thickening-functorial}
Let $S$ be a scheme
Consider a commutative diagram of algebraic spaces over $S$
$$
\xymatrix{
Z \ar[r]_h \ar[d]_f & X \ar[d]^g \\
W \ar[r]^{h'} & Y
}
$$
with $h$ and $h'$ formally unramified. Let $Z \subset Z'$ be the universal
first order thickening of $Z$ over $X$. Let $W \subset W'$ be the universal
first order thickening of $W$ over $Y$. There exists a canonical morphism
$(f, f') : (Z, Z') \to (W, W')$ of thickenings over $Y$ which fits into
the following commutative diagram
$$
\xymatrix{
& & & Z' \ar[ld] \ar[d]^{f'} \\
Z \ar[rr] \ar[d]_f \ar[rrru] & & X \ar[d] & W' \ar[ld] \\
W \ar[rrru]|!{[rr];[rruu]}\hole \ar[rr] & & Y
}
$$
In particular the morphism $(f, f')$ of thickenings induces a morphism
of conormal sheaves $f^*\mathcal{C}_{W/Y} \to \mathcal{C}_{Z/X}$.
\end{lemma}

\begin{proof}
The first assertion is clear from the universal property of $W'$.
The induced map on conormal sheaves is the map of
Lemma \ref{lemma-conormal-functorial}
applied to $(Z \subset Z') \to (W \subset W')$.
\end{proof}

\begin{lemma}
\label{lemma-universal-thickening-fibre-product}
Let $S$ be a scheme. Let
$$
\xymatrix{
Z \ar[r]_h \ar[d]_f & X \ar[d]^g \\
W \ar[r]^{h'} & Y
}
$$
be a fibre product diagram of algebraic spaces over $S$ with
$h'$ formally unramfied. Then $h$ is formally unramified and if
$W \subset W'$ is the universal first order thickening of $W$ over $Y$,
then $Z = X \times_Y W \subset X \times_Y W'$ is the universal
first order thickening of $Z$ over $X$. In particular the canonical map
$f^*\mathcal{C}_{W/Y} \to \mathcal{C}_{Z/X}$ of
Lemma \ref{lemma-universal-thickening-functorial}
is surjective.
\end{lemma}

\begin{proof}
The morphism $h$ is formally unramified by
Lemma \ref{lemma-base-change-formally-unramified}.
It is clear that $X \times_Y W'$ is a first order thickening.
It is straightforward to check that it has the universal property
because $W'$ has the universal property (by mapping properties of
fibre products). See
Lemma \ref{lemma-conormal-functorial-flat}
for why this implies that the map of conormal sheaves is surjective.
\end{proof}

\begin{lemma}
\label{lemma-universal-thickening-fibre-product-flat}
Let $S$ be a scheme. Let
$$
\xymatrix{
Z \ar[r]_h \ar[d]_f & X \ar[d]^g \\
W \ar[r]^{h'} & Y
}
$$
be a fibre product diagram of algebraic spaces over $S$ with
$h'$ formally unramfied and $g$ flat. In this case the corresponding
map $Z' \to W'$ of universal first order thickenings is flat, and
$f^*\mathcal{C}_{W/Y} \to \mathcal{C}_{Z/X}$ is an isomorphism.
\end{lemma}

\begin{proof}
Flatness is preserved under base change, see
Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-base-change-flat}.
Hence the first statement follows from the description of $W'$ in
Lemma \ref{lemma-universal-thickening-fibre-product}.
It is clear that $X \times_Y W'$ is a first order thickening.
It is straightforward to check that it has the universal property
because $W'$ has the universal property (by mapping properties of
fibre products). See
Lemma \ref{lemma-conormal-functorial-flat}
for why this implies that the map of conormal sheaves is an isomorphism.
\end{proof}

\begin{lemma}
\label{lemma-universal-thickening-localize}
Taking the universal first order thickenings commutes with \'etale
localization. More precisely, let $h : Z \to X$ be a formally unramified
morphism of algebraic spaces over a base scheme $S$.
Let
$$
\xymatrix{
V \ar[d] \ar[r] & U \ar[d] \\
Z \ar[r] & X
}
$$
be a commutative diagram with \'etale vertical arrows.
Let $Z'$ be the universal first order thickening of $Z$ over $X$.
Then $V \to U$ is formally unramfied and the universal first
order thickening $V'$ of $V$ over $U$ is \'etale over $Z'$.
In particular, $\mathcal{C}_{Z/X}|_V = \mathcal{C}_{V/U}$.
\end{lemma}

\begin{proof}
The first statement is
Lemma \ref{lemma-formally-unramified}.
The compatibility of universal first order thickenings is
a consequence of
Lemmas \ref{lemma-universal-thickening-over-formally-etale} and
\ref{lemma-etale-morphism-of-universal-thickenings}.
\end{proof}

\begin{lemma}
\label{lemma-differentials-universally-unramified}
Let $S$ be a scheme. Let $B$ be an algebraic space over $S$.
Let $h : Z \to X$ be a formally unramified morphism of algebraic spaces
over $B$. Let $Z \subset Z'$ be the universal first order thickening of $Z$
over $X$ with structure morphism $h' : Z' \to X$. The canonical map
$$
\text{d}h' : (h')^*\Omega_{X/B} \to \Omega_{Z'/B}
$$
induces an isomorphism
$h^*\Omega_{X/B} \to \Omega_{Z'/B} \otimes \mathcal{O}_Z$.
\end{lemma}

\begin{proof}
The map $c_{h'}$ is the map defined in
Lemma \ref{lemma-functoriality-differentials}.
If $i : Z \to Z'$ is the given closed immersion, then
$i^*c_{h'}$ is a map
$h^*\Omega_{X/S} \to \Omega_{Z'/S} \otimes \mathcal{O}_Z$.
Checking that it is an isomorphism reduces to the case of schemes
by \'etale localization, see
Lemma \ref{lemma-universal-thickening-localize}
and
Lemma \ref{lemma-localize-differentials}.
In this case the result is
More on Morphisms,
Lemma \ref{more-morphisms-lemma-differentials-universally-unramified}.
\end{proof}

\begin{lemma}
\label{lemma-universally-unramified-differentials-sequence}
Let $S$ be a scheme. Let $B$ be an algebraic space over $S$.
Let $h : Z \to X$ be a formally unramified morphism of algebraic
spaces over $B$.
There is a canonical exact sequence
$$
\mathcal{C}_{Z/X} \to h^*\Omega_{X/B} \to \Omega_{Z/B} \to 0.
$$
The first arrow is induced by $\text{d}_{Z'/B}$ where
$Z'$ is the universal first order neighbourhood of $Z$ over $X$.
\end{lemma}

\begin{proof}
We know that there is a canonical exact sequence
$$
\mathcal{C}_{Z/Z'} \to
\Omega_{Z'/S} \otimes \mathcal{O}_Z \to
\Omega_{Z/S} \to 0.
$$
see
Lemma \ref{lemma-differentials-relative-immersion}.
Hence the result follows on applying
Lemma \ref{lemma-differentials-universally-unramified}.
\end{proof}

















\section{Formally \'etale morphisms}
\label{section-formally-etale}

\noindent
In this section we work out what it means that a morphism of algebraic spaces
is formally \'etale.

\begin{definition}
\label{definition-formally-etale}
Let $S$ be a scheme. A morphism $f : X \to Y$ of algebraic spaces over $S$
is said to be {\it formally \'etale} if it is formally \'etale as a
transformation of functors as in
Definition \ref{definition-formally-smooth-etale-unramified}.
\end{definition}

\noindent
We will not restate the results proved in the more general setting of
formally \'etale transformations of functors in
Section \ref{section-formally-smooth-etale-unramified}.

\begin{lemma}
\label{lemma-formally-etale}
Let $S$ be a scheme. Let $f : X \to Y$ be a morphism of algebraic spaces over
$S$. The following are equivalent:
\begin{enumerate}
\item $f$ is formally \'etale,
\item for every diagram
$$
\xymatrix{
U \ar[d] \ar[r]_\psi & V \ar[d] \\
X \ar[r]^f & Y
}
$$
where $U$ and $V$ are schemes and the vertical arrows are \'etale
the morphism of schemes $\psi$ is formally \'etale (as in
More on Morphisms,
Definition \ref{more-morphisms-definition-formally-etale}), and
\item for one such diagram with surjective vertical arrows the morphism
$\psi$ is formally \'etale.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume $f$ is formally \'etale. By
Lemma \ref{lemma-representable-property-formally-property}
the morphisms $U \to X$ and $V \to Y$ are formally \'etale. Thus by
Lemma \ref{lemma-composition-formally-smooth-etale-unramified}
the composition $U \to Y$ is formally \'etale. Then it follows from
Lemma \ref{lemma-formally-permanence}
that $U \to V$ is formally \'etale. Thus (1) implies (2). And (2)
implies (3) trivially

\medskip\noindent
Assume given a diagram as in (3). By
Lemma \ref{lemma-representable-property-formally-property}
the morphism $V \to Y$ is formally \'etale. Thus by
Lemma \ref{lemma-composition-formally-smooth-etale-unramified}
the composition $U \to Y$ is formally \'etale. Then it follows from
Lemma \ref{lemma-etale-on-top}
that $X \to Y$ is formally \'etale, i.e., (1) holds.
\end{proof}















\section{Formally smooth morphisms}
\label{section-formally-smooth}

\noindent
In this section we introduce the notion of a formally smooth morphism
$X \to Y$ of algebraic spaces. Such a morphism is
characterized by the property that $T$-valued points of $X$ lift
to inifinitesimal thickenings of $T$ provided $T$ is affine.
The main result is that a morphism which is formally smooth and
locally of finite presentation is smooth, see
Lemma \ref{lemma-smooth-formally-smooth}.
It turns out that this criterion is often easier to use than the
Jacobian criterion.

\begin{definition}
\label{definition-formally-smooth}
Let $S$ be a scheme. A morphism $f : X \to Y$ of algebraic spaces over $S$
is said to be {\it formally smooth} if it is formally smooth as a
transformation of functors as in
Definition \ref{definition-formally-smooth-etale-unramified}.
\end{definition}

\noindent
We will not restate the results proved in the more general setting of
formally smooth transformations of functors in
Section \ref{section-formally-smooth-etale-unramified}.

\begin{lemma}
\label{lemma-action-by-derivations}
Let $S$ be a scheme. Consider a commutative diagram of morphisms of
algebraic spaces
$$
\xymatrix{
T \ar[r]_a \ar[d]_i & X \ar[d]^f \\
T' \ar[r] & Y
}
$$
over $S$. Assume $i : T \to T'$ is a closed immersion defined by an
ideal $\mathcal{I} \subset \mathcal{O}_{T'}$ of square zero.
\begin{enumerate}
\item For $W'$ \'etale over $T'$ the rule
$$
\mathcal{F}(W') =
\{a' \in \text{Mor}_Y(W', X) \text{ such that }
a'|_{T \times_{T'} W'} = a|_{T \times_{T'} W'}\}
$$
defines a sheaf of sets $\mathcal{F}$ on $T'_{spaces, \acute{e}tale}$.
\item There is an action of the sheaf
$$
\mathcal{H}
=
i_*\textit{Hom}_{\mathcal{O}_T}(a^*\Omega_{X/Y}, i^*\mathcal{I})
$$
on the sheaf $\mathcal{F}$.
\item Moreover, the action
$\mathcal{H}(W') \times \mathcal{F}(W') \to \mathcal{F}(W')$
is simply transitive for any object $W'$ of $T'_{spaces, \acute{e}tale}$
such that $\mathcal{F}(W') \not = \emptyset$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $\{W'_j \to W'\}_{j \in J}$ be a covering of $T'_{spaces, \acute{e}tale}$.
Let $a'_j : W'_j \to X$ be elements of $\mathcal{F}(W'_j)$ such that
$a'_j|_{W'_j \times_{W'} W'_{j'}} = a'_{j'}|_{W'_j \times_{W'} W'_{j'}}$.
In this situation
$$
\xymatrix{
\coprod_{j, j'} W'_j \times_{W'} W'_{j'}
\ar@<1ex>[r]  \ar@<-1ex>[r] &
\coprod_j W'_j \ar[r] &
W'
}
$$
is a coequalizer diagram of sheaves on $(\textit{Sch}/S)_{fppf}$.
Hence the morphisms $a'_j$ give rise to a unique morphism $a' : W' \to X$
because $X$ is a sheaf. Then $a' \in \mathcal{F}(W')$ (we omit the
verification). Hence $\mathcal{F}$ is a sheaf.

\medskip\noindent
Since $\mathcal{F}$ and $\mathcal{H}$ are sheaves it is enough to construct
the maps $\mathcal{H}(W') \times \mathcal{F}(W') \to \mathcal{F}(W')$
locally on $T'_{spaces, \acute{e}tale}$. Namely, it is enough to find a set
of objects $\mathcal{S} \subset \text{Ob}(T'_{spaces, \acute{e}tale})$
such that
\begin{enumerate}
\item[(i)] every object of $T'_{spaces, \acute{e}tale}$ has a covering by
objects of $\mathcal{S}$,
\item[(ii)] for every $W' \in \mathcal{S}$ we have an action
$\mathcal{H}(W') \times \mathcal{F}(W') \to \mathcal{F}(W')$, and
\item[(iii)] the actions are compatible with restriction mappings for
morphisms between elements of $\mathcal{S}$.
\end{enumerate}
We omit the proof that this suffices to define the action globally
(this should be added somewhere in the chapter on sites and sheaves).
Let us define the set of objects $\mathcal{S}$ we are going to use.
Choose a commutative diagram
$$
\xymatrix{
X \ar[d]^f & U \ar[l]^\psi \ar[d] \\
Y & V \ar[l]
}
$$
where $U$ and $V$ are schemes and the morphisms $U \to X$ and $V \to Y$
are \'etale. We define $\mathcal{S}$ to be the set of objects $W'$ of
$T'_{spaces, \acute{e}tale}$ which are schemes, and such that the composition
$T \times_{T'} W' \to T \to X$ factors through $U$.

\medskip\noindent
Let us verify points (i), (ii), and (iii). For part (i) we note that
any object $W'$ has an \'etale covering by schemes, hence we may assume $W'$ is
a scheme. The fibre product $(T \times_{T'} W') \times_X U$
is a scheme surjective and \'etale over $T \times_{T'} W'$. By
\'Etale Morphisms of Schemes, Theorem \ref{etale-theorem-remarkable-equivalence}
there exists a surjective \'etale morphism of schemes $W'' \to W'$ such that
$T \times_{T'} W'' \cong T \times_{T'} W'$.
Thus $\{W'' \to W'\}$ is the covering we are looking for.
This proves (i).

\medskip\noindent
To prove (ii) choose $W' \in \mathcal{S}$ and $a' : W' \to X$ an element
of $\mathcal{F}(W')$ and
$$
\theta :
a^*\Omega_{X/Y}|_{T \times_{T'} W'}
\longrightarrow
i^*\mathcal{I}|_{T \times_{T'} W'}
$$
an element of $\mathcal{H}(W')$. Denote $W = T \times_{T'} W'$.
Note that $\mathcal{I}_W = i^*\mathcal{I}|_W$ is just the ideal
defining the closed subscheme $W \subset W'$.
By assumption $W' \in \mathcal{S}$ there exists a morphism
$\tilde a : W \to U$ such that the solid diagram
$$
\xymatrix{
W \ar[r]_{\tilde a} \ar[d] & U \ar[d] \\
W' \ar[r]^{a'} \ar@{..>}[ru] & X
}
$$
is commutative. This implies the dotted arrow $\tilde a' : W' \to U$
exists because $W' \times_X U \to W'$ is \'etale and has a section over the
closed subscheme $W \subset W'$, see
\'Etale Morphisms of Schemes,
Theorem \ref{etale-theorem-remarkable-equivalence}.
Let $\tilde \theta : (\tilde a)^*\Omega_{U/V} \to \mathcal{I}_W$
be the map $\theta$ composed with the isomorphism
$\Omega_{X/Y}|_U \cong \Omega_{U/V}$ pulled back via $\tilde a$.
Finally we can define $\theta \cdot a'$ as
$\psi \circ (\tilde\theta \cdot \tilde a')$ where
$\tilde\theta \cdot \tilde a'$ is as defined in 
More Morphisms, Lemma \ref{more-morphisms-lemma-action-by-derivations}.

\medskip\noindent
Actually, we still have to show that the construction does not
depend on the choice of the morphism $\tilde a' : W' \to U$
(and also the morphism $\tilde a$) chosen above. To see this suppose
we have two choices, say $\tilde a'_1, \tilde a'_2$. In this case
we get a morphism
$$
(\tilde a'_1, \tilde a'_2) :
W'
\longrightarrow
U \times_X U
$$
At this point we can use
More on Morphisms,
Lemma \ref{more-morphisms-lemma-action-by-derivations-etale-localization}
for the two diagrams ($i = 1, 2$)
$$
\xymatrix{
W \ar[r] \ar[d] & W' \ar[rr]_-{(\tilde a_1', \tilde a_2')} \ar[d] & &
U \times_X U \ar[dd] \ar[ld]^{\text{pr}_i} \\
W \ar[r] & W' \ar[r]_{\tilde a_i'} & U \ar[d] & \\
& & V & V \times_Y V \ar[l]_-{\text{pr}_i}
}
$$
to conclude that
$$
(\tilde \theta \cdot \tilde a'_1, \tilde \theta \cdot \tilde a'_2)
=
\theta_{U \times_X U} \cdot (\tilde a'_1, \tilde a'_2)
$$
as morphisms from $W'$ to $U \times_X U$, where $\theta_{U \times_X U}$
is the composition
$$
\xymatrix{
(a_1, a_2)^*\Omega_{U \times_X U/V \times_Y V}
\ar@{=}[r] &
a^*\Omega_{X/Y}|_W \ar[r]^-{\theta} &
\mathcal{I}_W
}
$$
The reason this works is that, allthough a priori there are two
$\theta_{U \times_X U}$ coming from the two diagrams (by the procedure
explained in the lemma cited) these are the same since they
both come from $\theta$, namely, they are the map given above (some details
omitted). Hence we conclude that
$(\tilde \theta \cdot \tilde a'_1, \tilde \theta \cdot \tilde a'_2)$
is a morphism into $U \times_X U$, i.e., the compositions
$\psi \circ (\tilde \theta \cdot \tilde a'_1)$ and
$\psi \circ (\tilde \theta \cdot \tilde a'_2)$ agree. This finishes
the proof of (ii) above.

\medskip\noindent
In a similar manner one shows that (iii) holds (using
More on Morphisms,
Lemma \ref{more-morphisms-lemma-action-by-derivations-etale-localization}
once more). Details omitted.

\medskip\noindent
The proof of (3) is omitted. Hint: Reduce to the schemes case by
argueing similarly to the above.
\end{proof}

\begin{lemma}
\label{lemma-smooth-formally-smooth}
(Infinitesimal lifting criterion)
Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism of algebraic spaces over $S$.
The following are equivalent:
\begin{enumerate}
\item The morphism $f$ is smooth.
\item The morphism $f$ is locally of finite presentation, and
formally smooth as a transformation of functors.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted. See the
\href{http://math.columbia.edu/algebraic_geometry/%
stacks-git/documentation/todo-list}{todo list}
for an explanation of what needs to be done to fix this omission.
\end{proof}








\section{Openness of the flat locus}
\label{section-open-flat}

\noindent
This section is analogue of
More on Morphisms, Section \ref{more-morphisms-section-open-flat}.
Note that we have defined the notion of flatness for quasi-coherent
modules on algebraic spaces in
Morphisms of Spaces, Section \ref{spaces-morphisms-section-flat-modules}.

\begin{theorem}
\label{theorem-openess-flatness}
Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism of algebraic spaces over $S$.
Let $\mathcal{F}$ be a quasi-coherent sheaf on $X$.
Assume $f$ is locally of finite presentation and that
$\mathcal{F}$ is an $\mathcal{O}_X$-module which is
locally of finite presentation. Then
$$
\{x \in |X| : \mathcal{F}\text{ is flat over }Y\text{ at }x\}
$$
is open in $|X|$.
\end{theorem}

\begin{proof}
Choose a commutative diagram
$$
\xymatrix{
U \ar[d]_p \ar[r]_\alpha &
V \ar[d]^q \\
X \ar[r]^a & Y
}
$$
with $U$, $V$ schemes and $p$, $q$ surjective and \'etale as in
Spaces, Lemma \ref{spaces-lemma-lift-morphism-presentations}.
By
More on Morphisms, Theorem \ref{more-morphisms-theorem-openess-flatness}
the set
$U' = \{u \in |U| : p^*\mathcal{F}\text{ is flat over }V\text{ at }u\}$
is open in $U$. By
Morphisms of Spaces, Definition \ref{spaces-morphisms-definition-flat-module}
the image of $U'$ in $|X|$ is the set
of the theorem. Hence we are done because the map $|U| \to |X|$ is
open, see
Properties of Spaces, Lemma \ref{spaces-properties-lemma-topology-points}.
\end{proof}

\begin{lemma}
\label{lemma-flat-locus-base-change}
Let $S$ be a scheme. Let
$$
\xymatrix{
X' \ar[r]_{g'} \ar[d]_{f'} & X \ar[d]^f \\
Y' \ar[r]^g & Y
}
$$
be a cartesian diagram of algebraic spaces over $S$.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
Assume $g$ is flat, $f$ is locally of finite presentation,
and $\mathcal{F}$ is locally of finite presentation.
Then
$$
\{x' \in |X'| : (g')^*\mathcal{F}\text{ is flat over }Y'\text{ at }x'\}
$$
is the inverse image of the open subset of
Theorem \ref{theorem-openess-flatness}
under the continuous map $|g'| : |X'| \to |X|$.
\end{lemma}

\begin{proof}
This follows from
Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-base-change-module-flat}.
\end{proof}












\section{Crit\`ere de platitude par fibres}
\label{section-criterion-flat-fibres}

\noindent
Let $S$ be a scheme. Consider a commutative diagram of algebraic spaces
over $S$
$$
\xymatrix{
X \ar[rr]_f \ar[dr]_g & & Y \ar[dl]^h \\
& Z
}
$$
and a quasi-coherent $\mathcal{O}_X$-module $\mathcal{F}$.
Given a point $x \in |X|$ we consider the question as to whether
$\mathcal{F}$ is flat over $Y$ at $x$. If $\mathcal{F}$ is flat
over $Z$ at $x$, then the theorem below states this question is
intimately related to the question of whether the restriction of
$\mathcal{F}$ to the fibre of $X \to Z$ over $g(x)$
is flat over the fibre of $Y \to Z$ over $g(x)$. To make sense
out of this we offer the following preliminary lemma.

\begin{lemma}
\label{lemma-flat-on-fibres-at-point}
In the situation above the following are equivalent
\begin{enumerate}
\item Pick a geometric point $\overline{x}$ of $X$ lying over $x$.
Set $\overline{y} = f \circ \overline{x}$ and
$\overline{z} = g \circ \overline{x}$. Then the module
$\mathcal{F}_{\overline{x}}/
\mathfrak m_{\overline{z}}\mathcal{F}_{\overline{x}}$
is flat over
$\mathcal{O}_{Y, \overline{y}}/
\mathfrak m_{\overline{z}}\mathcal{O}_{Y, \overline{y}}$.
\item Pick a morphism $x : \text{Spec}(K) \to X$ in the equivalence class of
$x$. Set $z = g \circ x$, $X_z = \text{Spec}(K) \times_{z, Z} X$,
$Y_z = \text{Spec}(K) \times_{z, Z} Y$, and $\mathcal{F}_z$ the pullback
of $\mathcal{F}$ to $X_z$. Then $\mathcal{F}_z$ is flat at $x$ over
$Y_z$ (as defined in Morphisms of Spaces,
Definition \ref{spaces-morphisms-definition-flat-module}).
\item Pick a commutative diagram
$$
\xymatrix{
& & & U \ar[llld]_a \ar[rr] \ar[dr] & & V \ar[llld]_>>>>>>>b \ar[dl] \\
X \ar[rr]_f \ar[dr]_g & & Y \ar[dl]^h &  & W \ar[llld]_c \\
& Z
}
$$
where $U, V, W$ are schemes, and $a, b, c$ are \'etale,
and a point $u \in U$ mapping to $x$. Let $w \in W$ be the image of
$u$. Let $\mathcal{F}_w$ be the pullback of $\mathcal{F}$ to
the fibre $U_w$ of $U \to W$ at $w$. Then $\mathcal{F}_w$
is flat over $V_w$ at $u$.
\end{enumerate}
\end{lemma}

\begin{proof}
Note that in (2) the morphism $x : \text{Spec}(K) \to X$ defines a
$K$-rational point of $X_z$, hence the statement makes sense. Moreover,
note that we can always choose a diagram as in (3) by: first choosing
a scheme $W$ and a surjective \'etale morphism $W \to Z$, then choosing
a scheme $V$ and a surjective etale morphism $V \to W \times_Z Y$, and
finally choosing a scheme $U$ and a surjective \'etale morphism
$U \to V \times_Y X$. Having made these choices we set $U \to W$ equal
to the composition $U \to V \to W$ and we can pick a point $u \in U$ mapping
to $x$ because the morphism $U \to X$ is surjective.

\medskip\noindent
Suppose given both a diagram as in (3) and a geometric point
$\overline{x} : \text{Spec}(k) \to X$ as in (1). By
Properies of Spaces, Lemma \ref{spaces-properties-lemma-geometric-lift-to-usual}
we can choose a geometric point $\overline{u} : \text{Spec}(k) \to U$
lying over $u$ such that $\overline{x} = a \circ \overline{u}$.
Denote $\overline{v} : \text{Spec}(k) \to V$ and
$\overline{w} : \text{Spec}(k) \to W$ the induced geometric points of
$V$ and $W$. In this setting we know that
$\mathcal{O}_{X, \overline{x}} = \mathcal{O}_{U, u}^{sh}$
and similarly for $Y$ and $Z$, see
Properties of Spaces,
Lemma \ref{spaces-properties-lemma-describe-etale-local-ring}.
In the same vein we have
$$
\mathcal{F}_{\overline{x}} =
(a^*\mathcal{F})_u \otimes_{\mathcal{O}_{U, u}}
\mathcal{O}_{U, u}^{sh}
$$
see
Properties of Spaces, Lemma \ref{spaces-properties-lemma-stalk-quasi-coherent}.
Note that the stalk of $\mathcal{F}_w$ at $u$ is given by
$$
(\mathcal{F}_w)_u = (a^*\mathcal{F})_u/\mathfrak m_w(a^*\mathcal{F})_u
$$
and the local ring of $V_w$ at $v$ is given by
$$
\mathcal{O}_{V_w, v} = \mathcal{O}_{V, v}/\mathfrak m_w\mathcal{O}_{V, v}.
$$
Since $\mathfrak m_{\overline{z}} =
\mathfrak m_w \mathcal{O}_{Z, \overline{z}} =
\mathfrak m_w \mathcal{O}_{W, w}^{sh}$
we see that
\begin{align*}
\mathcal{F}_{\overline{x}}/
\mathfrak m_{\overline{z}}\mathcal{F}_{\overline{x}} & =
(a^*\mathcal{F})_u \otimes_{\mathcal{O}_{U, u}}
\mathcal{O}_{X, \overline{x}}/
\mathfrak m_{\overline{z}}\mathcal{O}_{X, \overline{x}} \\
& = 
(\mathcal{F}_w)_u \otimes_{\mathcal{O}_{U_w, u}}
\mathcal{O}_{U, u}^{sh}/\mathfrak m_w\mathcal{O}_{U, u}^{sh} \\
& = (\mathcal{F}_w)_u \otimes_{\mathcal{O}_{U_w, u}}
\mathcal{O}_{U_w, \overline{u}}^{sh} \\
& = (\mathcal{F}_w)_{\overline{u}}
\end{align*}
the penultimate equality by
Algebra, Lemma \ref{algebra-lemma-quotient-strict-henselization}
and the last equality by
Properties of Spaces, Lemma \ref{spaces-properties-lemma-stalk-quasi-coherent}.
The same arguments applied to the structure sheaves of $V$ and $Y$
show that
$$
\mathcal{O}_{V_w, \overline{v}}^{sh} =
\mathcal{O}_{V, v}^{sh}/\mathfrak m_w \mathcal{O}_{V, v}^{sh} =
\mathcal{O}_{Y, \overline{y}}/
\mathfrak m_{\overline{z}}\mathcal{O}_{Y, \overline{y}}.
$$
OK, and now we can use
Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-flat-at-point}
to see that (1) is equivalent to (3).

\medskip\noindent
Finally we prove the equivalence of (2) and (3).
To do this we pick a field extension $\tilde K$ of $K$ and
and a morphism $\tilde x : \text{Spec}(\tilde K) \to U$ which
lies over $u$ (this is possible because $u \times_{X, x} \text{Spec}(K)$
is a nonempty scheme). Set $\tilde z : \text{Spec}(\tilde K) \to U \to W$
be the composition. We obtain a commutative diagram
$$
\xymatrix{
& & & U_w \times_w \tilde z \ar[llld]_a \ar[rr] \ar[dr] & &
V_w \times_w \tilde z \ar[llld]_>>>>>>>b \ar[dl] \\
X_z \ar[rr]_f \ar[dr]_g & & Y_z \ar[dl]^h &  & \tilde z \ar[llld]_c \\
& z
}
$$
where $z = \text{Spec}(K)$ and $w = \text{Spec}(\kappa(w))$. Now it
is clear that $\mathcal{F}_w$ and $\mathcal{F}_z$ pull back to the
same module on $U_w \times_w \tilde z$. This leads to a commutative
diagram
$$
\xymatrix{
X_z \ar[d] & U_w \times_w \tilde z \ar[l] \ar[d] \ar[r] & U_w \ar[d] \\
Y_z & V_w \times_w \tilde z \ar[l] \ar[r] & V_w
}
$$
both of whose squares are cartesian and whose bottom horizontal
arrows are flat: the lower left horizontal arrow is the composition
of the morphism $Y \times_Z \tilde z \to Y \times_Z z = Y_z$ (base change
of a flat morphism), the \'etale morphism
$V \times_Z \tilde z \to Y \times_Z \tilde z$, and
the \'etale morphism $V \times_W \tilde z \to V \times_Z \tilde z$.
Thus it follows from
Morphisms of Spaces,
Lemma \ref{spaces-morphisms-lemma-base-change-module-flat}
that
$$
\mathcal{F}_z\text{ flat at }x\text{ over }Y_z
\Leftrightarrow
\mathcal{F}|_{U_w \times_w \tilde z}
\text{ flat at }\tilde x\text{ over }V_w \times_w \tilde z
\Leftrightarrow
\mathcal{F}_w\text{ flat at }u\text{ over }V_w
$$
and we win.
\end{proof}

\begin{definition}
\label{definition-module-flat-on-fibre}
Let $S$ be a scheme. Let $X \to Y \to Z$ be morphisms of algebraic
spaces over $S$. Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
Let $x \in |X|$ be a point and denote $z \in |Z|$ its image.
\begin{enumerate}
\item We say {\it the restriction of $\mathcal{F}$ to its fibre over $z$
is flat at $x$ over the fibre of $Y$ over $z$} if the equivalent conditions of
Lemma \ref{lemma-flat-on-fibres-at-point}
are satisfied.
\item We say {\it the fibre of $X$ over $z$ is flat at $x$ over the fibre of
$Y$ over $z$} if the quivalent conditions of
Lemma \ref{lemma-flat-on-fibres-at-point}
holds with $\mathcal{F} = \mathcal{O}_X$.
\item We say {\it the fibre of $X$ over $z$ is flat over the fibre of $Y$
over $z$} if for all $x \in |X|$ lying over $z$ the fibre of $X$ over $z$
is flat at $x$ over the fibre of $Y$ over $z$
\end{enumerate}
\end{definition}

\noindent
With this definition in hand we can state the criterion as follows.
(We leave the Noetherian version for later; insert future reference here.)

\begin{theorem}
\label{theorem-criterion-flatness-fibre}
Let $S$ be a scheme.
Let $f : X \to Y$ and $Y \to Z$ be a morphisms of algebraic spaces over $S$.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
Assume
\begin{enumerate}
\item $X$ is locally of finite presentation over $Z$,
\item $\mathcal{F}$ an $\mathcal{O}_X$-module of finite presentation, and
\item $Y$ is locally of finite type over $Z$.
\end{enumerate}
Let $x \in |X|$ and let $y \in |Y|$ and $z \in |Z|$ be the images of
$x$. If $\mathcal{F}_{\overline{x}} \not = 0$, then the following are
equivalent:
\begin{enumerate}
\item $\mathcal{F}$ is flat over $Z$ at $x$ and
the restriction of $\mathcal{F}$ to its fibre over $z$
is flat at $x$ over the fibre of $Y$ over $z$, and
\item $Y$ is flat over $Z$ at $y$ and $\mathcal{F}$ is
flat over $Y$ at $x$.
\end{enumerate}
Moreover, the set of points $x$ where (1) and (2) hold is open in
$\text{Supp}(\mathcal{F})$.
\end{theorem}

\begin{proof}
Choose a diagram as in
Lemma \ref{lemma-flat-on-fibres-at-point} part (3).
It follows from the definitions that this reduces to the
corresponding theorem for the morphisms of schemes
$U \to V \to W$, the quasi-coherent sheaf $a^*\mathcal{F}$,
and the point $u \in U$. Thus the theorem follows from the
corresponding result for schemes which is
More on Morphisms,
Theorem \ref{more-morphisms-theorem-criterion-flatness-fibre}.
\end{proof}

\begin{lemma}
\label{lemma-morphism-between-flat}
Let $S$ be a scheme.
Let $f : X \to Y$ and $Y \to Z$ be a morphism of algebraic spaces over $S$.
Assume
\begin{enumerate}
\item $X$ is locally of finite presentation over $Z$,
\item $X$ is flat over $Z$,
\item for every $z \in |Z|$ the fibre of $X$ over $z$
is flat over the fibre of $Y$ over $z$, and
\item $Y$ is locally of finite type over $Z$.
\end{enumerate}
Then $f$ is flat. If $f$ is also surjective, then $Y$ is flat over $Z$.
\end{lemma}

\begin{proof}
This is a special case of
Theorem \ref{theorem-criterion-flatness-fibre}.
\end{proof}

\begin{lemma}
\label{lemma-base-change-criterion-flatness-fibre}
Let $S$ be a scheme. Let $f : X \to Y$ and $Y \to Z$ be morphisms of
algebraic spaces over $S$. Let $\mathcal{F}$ be a quasi-coherent
$\mathcal{O}_X$-module.
Assume
\begin{enumerate}
\item $X$ is locally of finite presentation over $Z$,
\item $\mathcal{F}$ an $\mathcal{O}_X$-module of finite presentation,
\item $\mathcal{F}$ is flat over $Z$, and
\item $Y$ is locally of finite type over $Z$.
\end{enumerate}
Then the set
$$
A = \{x \in |X| : \mathcal{F} \text{ flat at }x \text{ over }Y\}.
$$
is open in $|X|$ and its formation commutes with arbitrary base change:
If $Z' \to Z$ is a morphism of algebraic spaces, and $A'$ is the set of
points of $X' = X \times_Z Z'$ where $\mathcal{F}' = \mathcal{F} \times_Z Z'$
is flat over $Y' = Y \times_Z Z'$, then $A'$ is the inverse image of
$A$ under the continuous map $|X'| \to |X|$.
\end{lemma}

\begin{proof}
One way to prove this is to translate the proof as given in
More on Morphisms, Lemma \ref{more-morphisms-lemma-morphism-between-flat}
into the category of algebraic spaces. Instead we will prove this
by reducing to the case of schemes instead. Namely, choose a diagram as in
Lemma \ref{lemma-flat-on-fibres-at-point} part (3)
such that $a$, $b$, and $c$ are surjective.
It follows from the definitions that this reduces to the
corresponding theorem for the morphisms of schemes
$U \to V \to W$, the quasi-coherent sheaf $a^*\mathcal{F}$,
and the point $u \in U$. The only minor point to make is that
given a morphism of algebraic spaces $Z' \to Z$ we choose a scheme
$W'$ and a surjective \'etale morphism $W' \to W \times_Z Z'$.
Then we set $U' = W' \times_W U$ and $V' = W' \times_W V$.
We write $a', b', c'$ for the morphisms from $U', V', W'$ to
$X', Y', Z'$. In this case $A$, resp.\ $A'$ are images of the open
subsets of $U$, resp.\ $U'$ associated to
$a^*\mathcal{F}$, resp.\ $(a')^*\mathcal{F}'$.
This indeed does reduce the lemma to
More on Morphisms, Lemma \ref{more-morphisms-lemma-morphism-between-flat}.
\end{proof}

\begin{lemma}
\label{lemma-base-change-flatness-fibres}
Let $S$ be a scheme.
Let $f : X \to Y$ and $Y \to Z$ be a morphism of algebraic spaces over $S$.
Assume
\begin{enumerate}
\item $X$ is locally of finite presentation over $Z$,
\item $X$ is flat over $Z$, and
\item $Y$ is locally of finite type over $Z$.
\end{enumerate}
Then the set
$$
\{x \in |X| : X\text{ flat at }x \text{ over }Y\}.
$$
is open in $|X|$ and its formation commutes with arbitrary base change
$Z' \to Z$.
\end{lemma}

\begin{proof}
This is a special case of
Lemma \ref{lemma-base-change-criterion-flatness-fibre}.
\end{proof}













\section{The structure of quasi-finite morphisms}
\label{section-structure-quasi-finite}


\begin{lemma}
\label{lemma-characterize-closed-immersion}
Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism of algebraic spaces over $S$.
The following are equivalent:
\begin{enumerate}
\item $f$ is a closed immersion,
\item $f$ is universally closed, unramified, and a monomorphism,
\item $f$ is universally closed, unramified, and universally injective,
\item $f$ is universally closed, locally of finite type, and a monomorphism,
\item $f$ is universally closed, universally injective, locally of
finite type, and formally unramfied.
\end{enumerate}
\end{lemma}

\begin{proof}
The equivalence of (2) -- (5) follows immediately from
Lemma \ref{lemma-universally-injective-unramified}.
Moreover, if (2) -- (5) are satisfied then $f$ is representable.
Similarly, if (1) is satified then $f$ is representable.
Hence the result follows from the case of schemes, see
More on Morphisms,
Lemma \ref{more-morphisms-lemma-characterize-closed-immersion}.
\end{proof}







\input{chapters}

\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}
