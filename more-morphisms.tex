\input{preamble}

% OK, start here.
%
\begin{document}

\title{More on Morphisms}


\maketitle

\phantomsection
\label{section-phantom}

\tableofcontents

\section{Introduction}
\label{section-introduction}

\noindent
In this chapter we continue our study of properties of morphisms of schemes.
A fundamental reference is \cite{EGA}.









\section{Formally smooth morphisms}
\label{section-formally-smooth}

\noindent
Mike Artin's position on differential criteria of smoothness (e.g.,
Morphisms, Lemma \ref{morphisms-lemma-smooth-at-point}) is that they are
basically useless (in practice). It turns out that it is
often possible to prove that a morphism $X \to S$ is smooth by considering
infinitesimal deformations of $T$-valued points of $X$ over $S$. In this
section we introduce to relevant terminology and we show that this leads
to the same notion as before in the case of morphisms which are locally
of finite presentation, see Lemma \ref{lemma-smooth-formally-smooth}.

\medskip\noindent
Recall that a ring map $R \to A$ is called {\it formally smooth}
(see Algebra, Definition \ref{algebra-definition-formally-smooth})
if for every commutative solid diagram
$$
\xymatrix{
A \ar[r] \ar@{-->}[rd] & B/I \\
R \ar[r] \ar[u] & B \ar[u]
}
$$
where $I \subset B$ is an ideal of square zero, a dotted
arrow exists which makes the diagram commute. This motivates
the following analogue for morphisms of schemes.

\begin{definition}
\label{definition-formally-smooth}
Let $f : X \to S$ be a morphism of schemes.
We say $f$ is {\it formally smooth} if given any solid commutative diagram
$$
\xymatrix{
X \ar[d]_f & T \ar[d]^i \ar[l] \\
S & T' \ar[l] \ar@{-->}[lu]
}
$$
where $T$ and $T'$ are affine and $i$ is a closed immersion defined
by an ideal of square zero there exists a dotted arrow making the diagram
commute.
\end{definition}

\begin{lemma}
\label{lemma-composition-formally-smooth}
A composition of formally smooth morphisms is formally smooth.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-base-change-formally-smooth}
A base change of a formally smooth morphism is formally smooth.
\end{lemma}

\begin{proof}
Omitted, but see Algebra, Lemma \ref{algebra-lemma-base-change-fs}
for the algebraic version.
\end{proof}

\begin{lemma}
\label{lemma-formally-smooth-on-opens}
Let $f : X \to S$ be a morphism of schemes.
Let $U \subset X$ and $V \subset S$ be open subschemes such that
$f(U) \subset V$. If $f$ is formally smooth, so is $f|_U : U \to V$.
\end{lemma}

\begin{proof}
Consider a solid diagram
$$
\xymatrix{
U \ar[d]_{f|_U} & T \ar[d]^i \ar[l]^a \\
V & T' \ar[l] \ar@{-->}[lu]
}
$$
as in Definition \ref{definition-formally-smooth}. If $f$ is formally
smooth, then there exists an $S$-morphism $a' : T' \to X$ such that
$a'|_T = a$. Since the underlying sets of $T$ and $T'$ are the same
we see that $a'$ is a morphism into $U$ (see Schemes, Section
\ref{schemes-section-open-immersion}). And it clearly is a $V$-morphism
as well. Hence the dotted arrow above as desired.
\end{proof}

\begin{lemma}
\label{lemma-affine-formally-smooth}
Let $f : X \to S$ be a morphism of schemes.
Assume $X$ and $S$ are affine.
Then $f$ is formally smooth if and only if
$\mathcal{O}_S(S) \to \mathcal{O}_X(X)$ is a formally smooth
ring map.
\end{lemma}

\begin{proof}
This is immediate from the definitions
(Definition \ref{definition-formally-smooth} and
Algebra, Definition \ref{algebra-definition-formally-smooth})
by the equivalence of categories of rings and affine schemes,
see
Schemes, Lemma \ref{schemes-lemma-category-affine-schemes}.
\end{proof}

\noindent
To prove more we need a preliminary lemma.

\medskip\noindent
Let $i : T \to T'$ be a closed immersion defined by an ideal of
square zero. Note that the underlying topological spaces defined
by $T$ and $T'$ are identified via $i$. We will use the following
abuse of language in this section. Given an open $U \subset T$ we
let $U' \subset T'$ denote the corresponding open of $T'$, and
conversely of course. Note that we often think of $U$ and $U'$ as
schemes (by the abuse of language introduced in Schemes,
Section \ref{schemes-section-open-immersion}). And then we think of $U$ as
a closed subscheme of $U'$ (also defined by an ideal of square zero).
Using this identification we have a short exact sequence
$$
0 \to \mathcal{I} \to \mathcal{O}_{T'} \to \mathcal{O}_T \to 0
$$
of quasi-coherent $\mathcal{O}_{T'}$-modules
where $\mathcal{I}^2 = 0$. This in particular gives $\mathcal{I}$
the structure of a $\mathcal{O}_T$-module, see
Morphisms, Section \ref{morphisms-section-closed-immersions-quasi-coherent}.

\begin{lemma}
\label{lemma-action-by-derivations}
Let $S$ be a scheme. Let $i : T \to T'$ be a closed immersion of
schemes over $S$ defined by an ideal $\mathcal{I}$ of square zero
(notation as above). Let $X$ be a scheme over $S$ and let
$a : T \to X$ be a morphism of schemes over $S$.
\begin{enumerate}
\item The rule
$$
U \mapsto \{a' \in \text{Mor}_S(U', X) \text{ such that } a'|_U = a|_U\}
$$
defines a sheaf of sets $\mathcal{F}$ on $T$.
\item There is an action of the sheaf
$$
\mathcal{H} = \textit{Hom}_{\mathcal{O}_T}(a^*\Omega^1_{X/S}, \mathcal{I})
$$
on the sheaf $\mathcal{F}$.
\item Moreover, the action
$\mathcal{H}(U) \times \mathcal{F}(U) \to \mathcal{F}(U)$
is simply transitive for any open $U \subset T$ such that
$\mathcal{F}(U) \not = \emptyset$.
\end{enumerate}
\end{lemma}

\begin{proof}
The restriction mapping $\mathcal{F}(U) \to \mathcal{F}(V)$ for
$V \subset U \subset T$
of $\mathcal{F}$ is really the restriction map $a' \mapsto a'|_{V'}$.
With this definition in place it is clear that $\mathcal{F}$ is a
sheaf since morphisms are defined locally. This proves the first assertion.

\medskip\noindent
Let us define the action. Let $U \subset T$ be open. Let
$(a', (a')^\sharp) : U' \to X$ be an element of $\mathcal{F}(U)$.
Since $a' = a$ on underlying topological spaces we may as well
write this element as $(a|_U, (a')^\sharp)$. We think of $(a')^\sharp$
as a map
$$
(a')^\sharp : (a|_U)^{-1}\mathcal{O}_X \longrightarrow \mathcal{O}_{U'}.
$$
Let $\theta : a^*\Omega_{X/S}|_U \to \mathcal{I}|_U$ be an element of
$\mathcal{H}(U)$. We can think of $\theta$ also as a
$a^{-1}\mathcal{O}_X$-linear map
$\theta : a^{-1}\Omega_{X/S}|_U \to \mathcal{I}|_U$.
We define
$\theta \cdot (a, (a')^\sharp) = (a, (a'')^\sharp)$ where
$$
(a'')^\sharp = (a')^\sharp + \theta \circ a^{-1} \text{d}_{X/S} :
(a|_U)^{-1}\mathcal{O}_X \longrightarrow \mathcal{O}_{U'}.
$$
This makes sense since $\text{d}_{X/S} : \mathcal{O}_X \to \Omega_{X/S}$.
We have to check the following
\begin{enumerate}
\item $(a'')^\sharp$ is a homomorphism of sheaves of rings,
\item it is a homomorphism of sheaves of $p^{-1}\mathcal{O}_S$-algebras
where $p : T \to S$ is the structure morphism, and
\item $(a'')^\sharp \bmod \mathcal{I}$ is equal to $(a|_U)^\sharp$.
\end{enumerate}
One way to check these assertions is to argue as in the proof of
Morphisms, Lemma \ref{morphisms-lemma-double-structure-gives-derivation}
(and we encourage the reader to do so).

\medskip\noindent
Another possibility is to translate the above into algebra by choosing
an affine open covering $U = \bigcup U_i$ such that $a(U_i)$ is
contained in an affine open $W_i \subset X$ which in turn maps into an
affine open $V_i \subset S$. It is enough to prove the three assertions
on sections of the corresponding sheaves over each affine, and hence it
is enough to prove the three assertions
when $X = \text{Spec}(A)$, $U' = T' = \text{Spec}(B)$,
$U = T = \text{Spec}(B/I)$ and $S = \text{Spec}(R)$. In this case
we have a commutative diagram
$$
\xymatrix{
A \ar[r]_a \ar[rd]_{a'} & B/I \\
R \ar[r] \ar[u] & B \ar[u]
}
$$
and $\theta : \Omega_{A/R} \to I$ is $A$-linear. We have to check that
$$
a'' = a' + \theta \circ \text{d}_{A/R}
$$
is an $R$-algebra map from $A \to B$ which agrees with $a$ as a map into
$B/I$. This is proved using the Leibniz rule for the derivation
$D = \theta \circ \text{d}_{A/R}$ exactly as in the proof of the aforementioned
Morphisms, Lemma \ref{morphisms-lemma-double-structure-gives-derivation}.
This proves (2).

\medskip\noindent
Proof of (3). Consider a pair $a', a'' \in \mathcal{F}(U)$.
We have to show there exists a unique $\theta$ such that
$\theta \cdot a' = a''$. Let us first prove this in the algebraic
situation described above. Suppose given therefore two
commutative diagrams
$$
\xymatrix{
A \ar[r]_a \ar[rd]_{a'} & B/I \\
R \ar[r] \ar[u] & B \ar[u]
}
\quad \text{and} \quad
\xymatrix{
A \ar[r]_a \ar[rd]_{a''} & B/I \\
R \ar[r] \ar[u] & B \ar[u]
}
$$
The difference $D = a'' - a'$ is a map from $A$ to $I$ (obviously).
All we have to show that it is an $R$-derivation, since then it will
be of the form $D = \theta \circ \text{d}_{A/r}$ for some unique
$\theta$. It is clear that $D(r) = 0$ for $r \in R$ since both $a'$
and $a''$ are $R$-algebra homomorphsms. Finally
$$
D(xy) =
a''(xy) - a'(xy) = a''(x) a''(y) - a'(x) a'(y) =
a''(x)D(y) + D(x) a'(y).
$$
Since $a'$ and $a''$ agree with $a$ as maps into $B/I$ we see that
this is equal to $a(x) D(y) + D(x) a(y)$ as desired.

\medskip\noindent
One can use this algebraic result and a suitable choice of affine
open coverings to prove (3). A more global argument would be the following.
Suppose that $(a|_U, (a')^\sharp)$ and $(a|_U, (a'')^\sharp)$ are
two elements of $\mathcal{F}(U)$. Consider the difference
$$
D = (a'')^\sharp - (a')^\sharp : 
(a|_U)^{-1}\mathcal{O}_X \longrightarrow \mathcal{O}_{U'}.
$$
Since $(a')^\sharp$ and $(a'')^\sharp$ are equal to $(a|_U)^\sharp$
after composing with the map $\mathcal{O}_{U'} \to \mathcal{O}_{U}$
we see that $D : (a|_U)^{-1}\mathcal{O}_X \to \mathcal{I}|_U$.
Arguing in exactly the same way as before we see that this is
a $p^{-1}\mathcal{O}_S$-derivation.
Thinking of $D$ as a map $\mathcal{O}_X \to (a|_U)_*(\mathcal{I}|_U)$
by adjunction it is still a $q^{-1}\mathcal{O}_S$-derivation
where $q : X \to S$ is the structure morphism.
Hence it is of the form
$\theta \circ \text{d}_{X/S}$ for some unique
$\theta : \Omega_{X/S} \to (a|_U)_*(\mathcal{I}|_U)$.
Using adjunction again we obtain a $\theta$ as desired.
\end{proof}

\noindent
The following lemma is the main result of this section. It is a victory of the
functorial point of view in that it implies (combined with 
Limits,
Proposition \ref{limits-proposition-characterize-locally-finite-presentation})
that we can recognize whether a morphism $f : X \to S$ is smooth in terms of
``simple'' properties of the functor $h_X : \textit{Sch}/S \to \textit{Sets}$.

\begin{lemma}
\label{lemma-smooth-formally-smooth}
(Infinitesimal lifting criterion)
Let $f : X \to S$ be a morphism of schemes.
The following are equivalent:
\begin{enumerate}
\item The morphism $f$ is smooth, and
\item the morphism $f$ is locally of finite presentation and
formally smooth.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume $f : X \to S$ is locally of finite presentation and formally smooth.
Consider a pair of affine opens $\text{Spec}(A) = U \subset X$ and
$\text{Spec}(R) = V \subset S$
such that $f(U) \subset V$. By Lemma \ref{lemma-formally-smooth-on-opens}
we see that $U \to V$ is formally smooth. By Lemma
\ref{lemma-affine-formally-smooth} we see that $R \to A$ is formally
smooth. By
Morphisms, Lemma \ref{morphisms-lemma-locally-finite-presentation-characterize}
we see that $R \to A$ is of finite presentation.
By Algebra, Lemma \ref{algebra-lemma-formally-smooth-smooth}
we see that $R \to A$ is smooth.
Hence by the definition of a smooth morphism we see that $X \to S$ is smooth.

\medskip\noindent
Conversely, assume that $f : X \to S$ is smooth. Consider a solid commutative
diagram
$$
\xymatrix{
X \ar[d]_f & T \ar[d]^i \ar[l]^a \\
S & T' \ar[l] \ar@{-->}[lu]
}
$$
where $T$ and $T'$ are affine and $i$ is a closed immersion defined
by an ideal of square zero. We will show the dotted arrow exists thereby
proving that $f$ is formally smooth.

\medskip\noindent
Let $\mathcal{F}$ be the sheaf of sets, and $\mathcal{H}$ be the sheaf
of $\mathcal{O}_T$-modules on $T$ introduced
in Lemma \ref{lemma-action-by-derivations}. Our goal is simply
to show that $\mathcal{F}(T) \not = \emptyset$. In other words we
are trying to show that $\mathcal{F}$ is a trivial $\mathcal{H}$-torsor
on $T$ (see Cohomology, Section \ref{cohomology-section-h1-torsors}).
There are two steps: (I) To show that $\mathcal{F}$ is a torsor
we have to show that $\mathcal{F}$ is a torsor we have to show
that $\mathcal{F}_t \not = \emptyset$ for all $t \in T$ (see
Cohomology, Definition \ref{cohomology-definition-torsor}).
(II) To show that $\mathcal{F}$ is the trivial torsor it suffices
to show that $H^1(T, \mathcal{H}) = 0$ (see
Cohomology, Lemma \ref{cohomology-lemma-torsors-h1} --
we may use either cohomology
of $\mathcal{H}$ as an abelian sheaf or as an $\mathcal{O}_T$-module,
see Cohomology, Lemma \ref{cohomology-lemma-modules-abelian}).

\medskip\noindent
First we prove (I). To see this, for every $t \in T$ we can
choose an affine open $U \subset T$ neighbourhood of $t$
such that $a(U)$ is contained
in an affine open $\text{Spec}(A) = W \subset X$
which maps to an affine open $\text{Spec}(R) = V \subset S$.
By Morphisms, Lemma \ref{morphisms-lemma-smooth-characterize}
the ring map $R \to A$ is smooth.
Hence by Algebra, Lemma \ref{algebra-lemma-formally-smooth-smooth}
the ring map $R \to A$ is formally smooth.
Lemma \ref{lemma-affine-formally-smooth}
in turn implies that $W \to V$ is formally smooth.
Hence we can lift $a|_U : U \to W$ to a $V$-morphism
$a' : U' \to W \subset X$ showing that $\mathcal{F}(U) \not = \emptyset$.

\medskip\noindent
Finally we prove (II).
By Morphisms, Lemma \ref{morphisms-lemma-finite-presentation-differentials}
we see that $\Omega_{X/S}$ is of finite presentation
(it is even finite locally free by
Morphisms, Lemma \ref{morphisms-lemma-smooth-omega-finite-locally-free}).
Hence $a^*\Omega_{X/S}$ is of finite presentation (see
Modules, Lemma \ref{modules-lemma-pullback-finite-presentation}).
Hence the sheaf
$\mathcal{H} = \textit{Hom}_{\mathcal{O}_T}(a^*\Omega^1_{X/S}, \mathcal{I})$
is quasi-coherent by the discussion in
Schemes, Section \ref{schemes-section-quasi-coherent}.
Thus by
Coherent, Lemma \ref{coherent-lemma-quasi-coherent-affine-cohomology-zero}
we have $H^1(X, \mathcal{H}) = 0$ as desired.
\end{proof}













\section{Formally unramified morphisms}
\label{section-formally-unramified}

\noindent
Recall that a ring map $R \to A$ is called {\it formally unramified}
(see Algebra, Definition \ref{algebra-definition-formally-unramified})
if for every commutative solid diagram
$$
\xymatrix{
A \ar[r] \ar@{-->}[rd] & B/I \\
R \ar[r] \ar[u] & B \ar[u]
}
$$
where $I \subset B$ is an ideal of square zero, at most one dotted
arrow exists which makes the diagram commute. This motivates
the following analogue for morphisms of schemes.

\begin{definition}
\label{definition-formally-unramified}
Let $f : X \to S$ be a morphism of schemes.
We say $f$ is {\it formally unramified} if given any solid commutative diagram
$$
\xymatrix{
X \ar[d]_f & T \ar[d]^i \ar[l] \\
S & T' \ar[l] \ar@{-->}[lu]
}
$$
where $T$ and $T'$ are affine and $i$ is a closed immersion defined
by an ideal of square zero there exists at most one
dotted arrow making the diagram commute.
\end{definition}

\noindent
Here is a characterization in terms of the sheaf of differentials.

\begin{lemma}
\label{lemma-formally-unramified-differentials}
Let $f : X \to S$ be a morphism of schemes.
Then $f$ is formally unramified if and only if $\Omega_{X/S} = 0$.
\end{lemma}

\begin{proof}
We recall some of the arguments of
Morphisms, Section \ref{morphisms-section-sheaf-differentials}.
Let $U \subset X \times_S X$ be an open such that
$\Delta : X \to X \times_S X$ induces a closed immersion into $U$.
Let $\mathcal{J} \subset \mathcal{O}_U$ be the ideal sheaf of this
closed immersion. Let $X' \subset U$ be the closed subscheme
defined by the quasi-coherent sheaf of ideals $\mathcal{J}^2$.
Consider the two morphisms $p_1, p_2 : X' \to X$ induced by
the two projections $X \times_S X \to X$.
Note that $p_1$ and $p_2$ agree when composed with $\Delta : X \to X'$
and that $X \to X'$ is a closed immersion defined by a an ideal
whose square is zero. Moreover there is a short exact sequence
$$
0 \to \mathcal{J}/\mathcal{J}^2 \to \mathcal{O}_{X'} \to \mathcal{O}_X \to 0
$$
and $\Omega_{X/S} = \mathcal{J}/\mathcal{J}^2$ is generated by the local
sections $p_1^\sharp(f) - p_2^\sharp(f)$ for $f$ a local section of
$\mathcal{O}_X$.

\medskip\noindent
Suppose that $f : X \to S$ is formally unramified.
By assumption this means that $p_1 = p_2$ when restricted to any
affine open $T' \subset X'$. Hence $p_1 = p_2$. By what was said above
we conclude that $\Omega_{X/S} = 0$.

\medskip\noindent
Conversely, suppose that $\Omega_{X/S} = 0$.
Then it is clear from Lemma \ref{lemma-action-by-derivations}
that there is always at most one morphism fitting into the diagram of
Definition \ref{definition-formally-unramified}.
\end{proof}

\begin{lemma}
\label{lemma-composition-formally-unramified}
A composition of formally unramified morphisms is formally unramified.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-base-change-formally-unramified}
A base change of a formally unramified morphism is formally unramified.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-formally-unramified-on-opens}
Let $f : X \to S$ be a morphism of schemes.
Let $U \subset X$ and $V \subset S$ be open subschemes such that
$f(U) \subset V$. If $f$ is formally unramified, so is $f|_U : U \to V$.
\end{lemma}

\begin{proof}
Consider a solid diagram
$$
\xymatrix{
U \ar[d]_{f|_U} & T \ar[d]^i \ar[l]^a \\
V & T' \ar[l] \ar@{-->}[lu]
}
$$
as in Definition \ref{definition-formally-unramified}. If $f$ is formally
ramified, then there exists at most one
$S$-morphism $a' : T' \to X$ such that $a'|_T = a$.
Hence clearly there exists at most one such morphism into $U$.
\end{proof}

\begin{lemma}
\label{lemma-affine-formally-unramified}
Let $f : X \to S$ be a morphism of schemes.
Assume $X$ and $S$ are affine.
Then $f$ is formally unramified if and only if
$\mathcal{O}_S(S) \to \mathcal{O}_X(X)$ is a formally unramified
ring map.
\end{lemma}

\begin{proof}
This is immediate from the definitions
(Definition \ref{definition-formally-unramified} and
Algebra, Definition \ref{algebra-definition-formally-unramified})
by the equivalence of categories of rings and affine schemes,
see
Schemes, Lemma \ref{schemes-lemma-category-affine-schemes}.
\end{proof}

\begin{lemma}
\label{lemma-unramified-formally-unramified}
Let $f : X \to S$ be a morphism of schemes.
The following are equivalent:
\begin{enumerate}
\item The morphism $f$ is unramified, and
\item the morphism $f$ is locally of finite presentation and
formally unramified.
\end{enumerate}
\end{lemma}

\begin{proof}
Use Lemma \ref{lemma-formally-unramified-differentials} and
Morphisms, Lemma \ref{morphisms-lemma-unramified-omega-zero}.
\end{proof}













\section{Formally etale morphisms}
\label{section-formally-etale}

\noindent
Recall that a ring map $R \to A$ is called {\it formally etale}
(see Algebra, Definition \ref{algebra-definition-formally-etale})
if for every commutative solid diagram
$$
\xymatrix{
A \ar[r] \ar@{-->}[rd] & B/I \\
R \ar[r] \ar[u] & B \ar[u]
}
$$
where $I \subset B$ is an ideal of square zero, there exists
exactly one dotted arrow which makes the diagram commute. This motivates
the following analogue for morphisms of schemes.

\begin{definition}
\label{definition-formally-etale}
Let $f : X \to S$ be a morphism of schemes.
We say $f$ is {\it formally etale} if given any solid commutative diagram
$$
\xymatrix{
X \ar[d]_f & T \ar[d]^i \ar[l] \\
S & T' \ar[l] \ar@{-->}[lu]
}
$$
where $T$ and $T'$ are affine and $i$ is a closed immersion defined
by an ideal of square zero there exists exactly one
dotted arrow making the diagram commute.
\end{definition}

\noindent
This in particular garantees that $\Omega_{X/S}$ is zero since
this is the case for formally unramified morphisms.

\begin{lemma}
\label{lemma-formally-etale-unramfied-smooth}
Let $f : X \to S$ be a morphism of schemes.
Then $f$ is formally etale if and only if
$f$ is formally smooth and formally unramified.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-composition-formally-etale}
A composition of formally etale morphisms is formally etale.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-base-change-formally-etale}
A base change of a formally etale morphism is formally etale.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-formally-etale-on-opens}
Let $f : X \to S$ be a morphism of schemes.
Let $U \subset X$ and $V \subset S$ be open subschemes such that
$f(U) \subset V$. If $f$ is formally etale, so is $f|_U : U \to V$.
\end{lemma}

\begin{proof}
Combine Lemmas \ref{lemma-formally-etale-unramfied-smooth},
\ref{lemma-formally-smooth-on-opens}, and
\ref{lemma-formally-unramified-on-opens}.
\end{proof}

\begin{lemma}
\label{lemma-affine-formally-etale}
Let $f : X \to S$ be a morphism of schemes.
Assume $X$ and $S$ are affine.
Then $f$ is formally etale if and only if
$\mathcal{O}_S(S) \to \mathcal{O}_X(X)$ is a formally etale
ring map.
\end{lemma}

\begin{proof}
This is immediate from the definitions
(Definition \ref{definition-formally-etale} and
Algebra, Definition \ref{algebra-definition-formally-etale})
by the equivalence of categories of rings and affine schemes,
see
Schemes, Lemma \ref{schemes-lemma-category-affine-schemes}.
\end{proof}

\begin{lemma}
\label{lemma-etale-formally-etale}
Let $f : X \to S$ be a morphism of schemes.
The following are equivalent:
\begin{enumerate}
\item The morphism $f$ is etale, and
\item the morphism $f$ is locally of finite presentation and
formally etale.
\end{enumerate}
\end{lemma}

\begin{proof}
Formally etale is the same as formally smooth and formally unramified
(see Lemma \ref{lemma-formally-etale-unramfied-smooth}).
Being etale is the same as being smooth and unramified
(see Morphisms, Lemma \ref{morphisms-lemma-etale-smooth-unramified}).
Hence this follows from Lemmas \ref{lemma-smooth-formally-smooth}
and \ref{lemma-unramified-formally-unramified}.
\end{proof}












\section{Smoothness over a Noetherian base}
\label{section-smooth-Noetherian}

\noindent
It turns out that if the base is Noetherian then we can get away with
less in the formulation of formal smoothness. In some sense the following
lemmas are the beggining of deformation theory.

\begin{lemma}
\label{lemma-lifting-along-artinian-at-point}
Let $f : X \to S$ be a morphism of schemes.
Let $x \in X$.
Assume that $S$ is locally Noetherian and $f$ locally of finite type.
The following are equivalent:
\begin{enumerate}
\item $f$ is smooth at $x$,
\item for every solid commutative diagram
$$
\xymatrix{
X \ar[d]_f & \text{Spec}(B) \ar[d]^i \ar[l]^-\alpha \\
S & \text{Spec}(B') \ar[l]_-{\beta} \ar@{-->}[lu]
}
$$
where $B' \to B$ is a surjection of local rings with
$\text{Ker}(B' \to B)$ of square zero, and $\alpha$ mapping the
closed point of $\text{Spec}(B)$ to $x$ there exists
a dotted arrow making the diagram commute,
\item same as in (2) but with $B' \to B$ ranging over small
extensions (see Algebra, Definition \ref{algebra-definition-small-extension}),
and
\item same as in (2) but with $B' \to B$ ranging over small
extensions such that $\alpha$ induces an isomorphism
$\kappa(x) \to \kappa(\mathfrak m)$ where $\mathfrak m \subset B$
is the maximal ideal.
\end{enumerate}
\end{lemma}

\begin{proof}
Choose an affine neighbourhood $V \subset S$ of $f(x)$ and choose an
affine neighbourhood $U \subset X$ of $x$ such that $f(U) \subset V$.
For any ``test'' diagram as in (2) the morphism $\alpha$ will map
$\text{Spec}(B)$ into $U$ and the morphism $\beta$ will map $\text{Spec}(B')$
into $V$ (see Schemes, Section \ref{schemes-section-points}).
Hence the lemma reduces to the morphism $f|_U : U \to V$ of affines.
(Indeed, $V$ is Noetherian and $f|_U$ is of finite type, see
Properties, Lemma \ref{properties-lemma-locally-Noetherian} and
Morphisms, Lemma \ref{morphisms-lemma-locally-finite-type-characterize}.)
In this affine case the lemma is identical to
Algebra, Lemma \ref{algebra-lemma-smooth-test-artinian}.
\end{proof}

\noindent
Sometimes it is useful to know that one only needs to check the
lifting criterion for small extensions ``centered'' at points
of finite type (see
Morphisms, Section \ref{morphisms-section-points-finite-type}).

\begin{lemma}
\label{lemma-lifting-along-artinian}
Let $f : X \to S$ be a morphism of schemes.
Let $x \in X$.
Assume that $S$ is locally Noetherian and $f$ locally of finite type.
The following are equivalent:
\begin{enumerate}
\item $f$ is smooth,
\item for every solid commutative diagram
$$
\xymatrix{
X \ar[d]_f & \text{Spec}(B) \ar[d]^i \ar[l]^-\alpha \\
S & \text{Spec}(B') \ar[l]_-{\beta} \ar@{-->}[lu]
}
$$
where $B' \to B$ is a small extension of Artinian local rings
and $\beta$ of finite type (!) there exists a dotted arrow making
the diagram commute.
\end{enumerate}
\end{lemma}

\begin{proof}
If $f$ is smooth, then the infinitesimal lifting criterion
(Lemma \ref{lemma-smooth-formally-smooth}) says
$f$ is formally smooth and (2) holds.

\medskip\noindent
Assume (2). The set of points $x \in X$ where $f$ is not smooth
forms a closed subset $T$ of $X$. By the discussion in Morphisms,
Section \ref{morphisms-section-points-finite-type}, if $T \not = \emptyset$
there exists a point $x \in T \subset X$ such that the morphism
$$
\text{Spec}(\kappa(x)) \to X \to S
$$
is of finite type (namely, pick any point $x$ of $T$ which is closed
in an affine open of $X$). By
Morphisms, Lemma \ref{morphisms-lemma-artinian-finite-type} given any
local Artinian ring $B'$ with residue field $\kappa(x)$ then any
morphism $\beta : \text{Spec}(B') \to S$ is of finite type. Thus
we see that all the diagrams used in
Lemma \ref{lemma-lifting-along-artinian-at-point} (4) correspond
to diagrams as in the current lemma (2). Whence $X \to S$ is smooth
a $x$ a contradiction.
\end{proof}






\section{Openness of the flat locus}
\label{section-open-flat}

\noindent
This result takes some work to prove, and (perhaps)
deserves its own section. Here it is.

\begin{theorem}
\label{theorem-openess-flatness}
Let $S$ be a scheme.
Let $f : X \to S$ be a morphism which is locally of finite presentation.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module which is
locally of finite presentation. Then
$$
U = \{x \in X \mid \mathcal{F}\text{ is flat over }S\text{ at }x\}
$$
is open in $X$.
\end{theorem}

\begin{proof}
We may test for openness locally on $X$ hence we may assume
that $f$ is a morphism of affine schemes. In this case the
theorem is exacly Algebra, Theorem \ref{algebra-theorem-openess-flatness}.
\end{proof}




\section{Crit\`ere de platitude par fibres}
\label{section-criterion-flat-fibres}

\noindent
Consider a commutative diagram of schemes (right hand diagram)
$$
\xymatrix{
X \ar[rr]_f \ar[dr] & & Y \ar[dl] \\
& S
}
\quad
\xymatrix{
X_s \ar[rr]_{f_s} \ar[rd] & & Y_s \ar[dl] \\
& \text{Spec}(\kappa(s))
}
$$
and a quasi-coherent $\mathcal{O}_X$-module $\mathcal{F}$.
Given a point $x \in X$ lying over $s \in S$ with image $y = f(x)$
we consider the question as to whether $\mathcal{F}$ is flat
over $Y$ at $x$. If $\mathcal{F}$ is flat over $S$ at $x$, then
the theorem states this question is intimately related to the
question of whether the restriction of $\mathcal{F}$ to the fibre
$$
\mathcal{F}_s = (X_s \to X)^*\mathcal{F}
$$
is flat over $Y_s$ at $x$. There are two versions, a Noetherian
version and a version on schemes which are locally of finite
presentation over the base.

\begin{theorem}
\label{theorem-criterion-flatness-fibre-Noetherian}
Let $S$ be a scheme. Let $X$, $Y$ be $S$-schemes.
Let $f : X \to Y$ be a morphism over $S$.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
Let $x \in X$. Set $y = f(x)$ and $s \in S$ the image of $x$ in $S$.
Assume $S$, $X$, $Y$ locally Noetherian,
$\mathcal{F}$ coherent, and $\mathcal{F}_x \not = 0$.
Then the following are equivalent:
\begin{enumerate}
\item $\mathcal{F}$ is flat over $S$ at $x$, and
$\mathcal{F}_s$ is flat over $Y_s$ at $x$, and
\item $Y$ is flat over $S$ at $y$ and $\mathcal{F}$ is
flat over $Y$ at $x$.
\end{enumerate}
\end{theorem}

\begin{proof}
The implication (1) $\Rightarrow$ (2) is
Algebra, Lemma \ref{algebra-lemma-criterion-flatness-fibre-Noetherian}.
The implication (2) $\Rightarrow$ (1) follows from
Algebra, Lemmas \ref{algebra-lemma-composition-flat}
and \ref{algebra-lemma-flat-base-change}.
\end{proof}

\noindent
Here is the non-Noetherian version.

\begin{theorem}
\label{theorem-criterion-flatness-fibre}
Let $S$ be a scheme. Let $X$, $Y$ be $S$-schemes.
Let $f : X \to Y$ be a morphism over $S$.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
Let $x \in X$. Set $y = f(x)$ and $s \in S$ the image of $x$ in $S$.
Assume $X$, $Y$ locally of finite presentation over $S$,
$\mathcal{F}$ of finite presentation, and $\mathcal{F}_x \not = 0$.
Then the following are equivalent:
\begin{enumerate}
\item $\mathcal{F}$ is flat over $S$ at $x$, and
$\mathcal{F}_s$ is flat over $Y_s$ at $x$, and
\item $Y$ is flat over $S$ at $y$ and $\mathcal{F}$ is
flat over $Y$ at $x$.
\end{enumerate}
Moreover, the set of points $x$ where this holds is open in $X$.
\end{theorem}

\begin{proof}
The implication (1) $\Rightarrow$ (2) is
Algebra, Lemma \ref{algebra-lemma-criterion-flatness-fibre}.
The implication (2) $\Rightarrow$ (1) follows from
Algebra, Lemmas \ref{algebra-lemma-composition-flat}
and \ref{algebra-lemma-flat-base-change}.
The openness follows from Theorem \ref{theorem-openess-flatness}
applied to both the set of points where $\mathcal{F}$ is flat over $Y$
and the set of points where $\mathcal{F}$ is flat over $S$.
\end{proof}

\noindent
These theorems are often used in the following simplified forms.
We give only the global statements -- of course there are also pointwise
versions.

\begin{lemma}
\label{lemma-morphism-between-flat-Noetherian}
Let $S$ be a scheme.
Let $X$, $Y$ be $S$-schemes.
Let $f : X \to Y$ be a morphism over $S$.
Assume
\begin{enumerate}
\item $S$, $X$, $Y$ are locally Noetherian,
\item $X$ is flat over $S$,
\item for every $s \in S$ the restriction of $f$ to the
fibre $f_s : X_s \to Y_s$ is flat.
\end{enumerate}
Then $f$ is flat, and $Y$ is flat over $S$.
\end{lemma}

\begin{proof}
This is a special case of
Theorem \ref{theorem-criterion-flatness-fibre-Noetherian}.
\end{proof}

\begin{lemma}
\label{lemma-morphism-between-flat}
Let $S$ be a scheme.
Let $X$, $Y$ be $S$-schemes.
Let $f : X \to Y$ be a morphism over $S$.
Assume
\begin{enumerate}
\item $X$, $Y$ are locally of finite presentation over $S$,
\item $X$ is flat over $S$,
\item for every $s \in S$ the restriction of $f$ to the
fibre $f_s : X_s \to Y_s$ is flat.
\end{enumerate}
Then $f$ is flat, and $Y$ is flat over $S$.
\end{lemma}

\begin{proof}
This is a special case of
Theorem \ref{theorem-criterion-flatness-fibre}.
\end{proof}












\section{Normal morphisms}
\label{section-normal}

\noindent
In the article \cite{DM} of Deligne and Mumford the notion of a normal
morphism is mentioned. This is just one in a series of types\footnote{
The other types are coprof $\leq k$, Cohen-Macaulay, $(S_k)$,
regular, $(R_k)$, and reduced. See \cite[IV Definition 6.8.1.]{EGA}.}
of morphisms that can all be defined similarly. Over time we will add
these in their own sections as needed.

\begin{definition}
\label{definition-normal}
Let $f : X \to Y$ be a morphism of schemes.
Assume that all the fibres $X_y$ are locally Noetherian schemes.
\begin{enumerate}
\item Let $x \in X$, and $y = f(x)$. We say that $f$ is {\it normal at $x$}
if $f$ is flat at $x$, and the scheme $X_y$ is geometrically
normal at $x$ over $\kappa(y)$ (see
Varieties, Definition \ref{varieties-definition-geometrically-normal}).
\item We say $f$ is a {\it normal morphism} if $f$ is normal
at every point of $X$.
\end{enumerate}
\end{definition}

\noindent
So the condition that the morphism $X \to Y$ is normal
is stronger than just requiring all
the fibres to be normal locally Noetherian schemes.

\begin{lemma}
\label{lemma-normal}
Let $f : X \to Y$ be a morphism of schemes.
Assume all fibres of $f$ are locally Noetherian.
The following are equivalent
\begin{enumerate}
\item $f$ is normal, and
\item $f$ is flat and its fibres are geometrically normal schemes.
\end{enumerate}
\end{lemma}

\begin{proof}
This follows directly from the definitions.
\end{proof}

\noindent
We want to show that this notion is local on the source and target
for the smooth topology. First we deal with the property of having
locally Noetherian fibres.

\begin{lemma}
\label{lemma-locally-Noetherian-fibres-fppf-local-source-and-target}
The property $\mathcal{P}(f)=$``the fibres of $f$ are locally Noetherian''
is local in the fppf topology on the source and the target.
\end{lemma}

\begin{proof}
Let $f : X \to Y$ be a morphism of schemes.
Let $\{\varphi_i : Y_i \to Y\}_{i \in I}$ be an fppf covering of $Y$.
Denote $f_i : X_i \to Y_i$ the base change of $f$ by $\varphi_i$.
Let $i \in I$ and let $y_i \in Y_i$ be a point.
Set $y = \varphi_i(y_i)$. Note that
$$
X_{i, y_i} = \text{Spec}(\kappa(y_i)) \times_{\text{Spec}(\kappa(y))} X_y.
$$
Moreover, as $\varphi_i$ is of finite presentation the field extension
$\kappa(y) \subset \kappa(y_i)$ is finitely generated.
Hence in this situation we have that $X_y$ is locally Noetherian if and
only if $X_{i, y_i}$ is locally Noetherian, see
Varieties, Lemma \ref{varieties-lemma-locally-Noetherian-base-change}.
This fact implies locality on the target.

\medskip\noindent
Let $\{X_i \to X\}$ be an fppf covering of $X$.
Let $y \in Y$. In this case $\{X_{i, y} \to X_y\}$ is an
fppf covering of the fibre. Hence the locality on the source
follows from Descent, Lemma \ref{descent-lemma-Noetherian-local-fppf}.
\end{proof}

\begin{lemma}
\label{lemma-normal-fppf-local-source-and-target}
The property
$\mathcal{P}(f)=$``the fibres of $f$ are locally Noetherian and $f$ is normal''
is local in the fppf topology on the target and
local in the smooth topology on the source.
\end{lemma}

\begin{proof}
We have
$\mathcal{P}(f) =
\mathcal{P}_1(f) \wedge \mathcal{P}_2(f) \wedge \mathcal{P}_3(f)$
where
$\mathcal{P}_1(f)=$``the fibres of $f$ are locally Noetherian'',
$\mathcal{P}_2(f)=$``$f$ is flat'', and
$\mathcal{P}_3(f)=$``the fibres of $f$ are geometrically normal''.
We have already seen that $\mathcal{P}_1$ and $\mathcal{P}_2$
are local in the fppf topology on the source and the target, see
Lemma \ref{lemma-locally-Noetherian-fibres-fppf-local-source-and-target},
and Descent, Lemmas \ref{descent-lemma-descending-property-flat} and
\ref{descent-lemma-flat-fpqc-local-source}. Thus we have to deal
with $\mathcal{P}_3$.

\medskip\noindent
Let $f : X \to Y$ be a morphism of schemes.
Let $\{\varphi_i : Y_i \to Y\}_{i \in I}$ be an fpqc covering of $Y$.
Denote $f_i : X_i \to Y_i$ the base change of $f$ by $\varphi_i$.
Let $i \in I$ and let $y_i \in Y_i$ be a point.
Set $y = \varphi_i(y_i)$. Note that
$$
X_{i, y_i} = \text{Spec}(\kappa(y_i)) \times_{\text{Spec}(\kappa(y))} X_y.
$$
Hence in this situation we have that $X_y$ is geometrically normal if and
only if $X_{i, y_i}$ is geometrically normal, see
Varieties, Lemma \ref{varieties-lemma-geometrically-normal-upstairs}.
This fact implies $\mathcal{P}_3$ is fpqc local on the target.

\medskip\noindent
Let $\{X_i \to X\}$ be a smooth covering of $X$.
Let $y \in Y$. In this case $\{X_{i, y} \to X_y\}$ is a
smooth covering of the fibre. Hence the locality of $\mathcal{P}_3$
for the smooth topology on the source follows from
Descent, Lemma \ref{descent-lemma-normal-local-smooth}.
Combining the above the lemma follows.
\end{proof}

















\section{Etale neighbourhoods and etale localization}
\label{section-etale-neighbourhoods}

\noindent
It turns out that some properties of morphisms are easier to study
after doing an etale base change. It is convenient to introduce the
following terminology.

\begin{definition}
\label{definition-etale-neighbourhood}
Let $S$ be a scheme. Let $s \in S$ be a point.
An {\it etale neighbourhood of $(S, s)$} is a
pair $(U, u)$ together with an etale morphism
of schemes $\varphi : U \to S$ such that $\varphi(u) = s$.
A {\it morphism of etale neighbourhoods} $f : (V, v) \to (U, u)$
of $(S, s)$ is simply a morphism of $S$-schemes $f : V \to U$ such
that $f(v) = u$.
\end{definition}

\noindent
If $f : (V, v) \to (U, u)$ is a morphism of etale
neighbourhoods, then $f$ is automatically etale, see
Morphisms, Lemma \ref{morphisms-lemma-etale-permanence}.
Hence it turns $(V, v)$ into an etale neighbourhood of
$(U, u)$. Of course, since the composition of etale morphisms
is etale (Morphisms, Lemma \ref{morphisms-lemma-composition-etale})
we see that conversely any etale neighbourhood $(V, v)$ of
$(U, u)$ is an etale neighbourhood of $(S, s)$ as well.
We also remark that if $U \subset S$ is an open neighbourood
of $s$, then $(U, s) \to (S, s)$ is an etale neighbourhood.
This follows from the fact that an open immersion is
etale (Morphisms, Lemma \ref{morphisms-lemma-open-immersion-etale}).
We will use these remarks without further mention throughout this
section.

\medskip\noindent
Note that $\kappa(s) \subset \kappa(u)$ is a finite separable extension
if $(U, u) \to (S, s)$ is an etale neighbourhood,
see Morphisms, Lemma \ref{morphisms-lemma-etale-at-point}.

\begin{lemma}
\label{lemma-realize-presecribed-residue-field-extension-etale}
Let $S$ be a scheme.
Let $s \in S$.
Let $\kappa(s) \subset k$ be a finite separable field extension.
Then there exists an etale neighbourhood $(U, u) \to (S, s)$
such that the field extension $\kappa(s) \subset \kappa(u)$ is
isomorphic to $\kappa(s) \subset k$.
\end{lemma}

\begin{proof}
We may assume $S$ is affine.
In this case the lemma follows from
Algebra, Lemma \ref{algebra-lemma-make-etale-map-prescribed-residue-field}.
\end{proof}

\noindent
Let us translate some of the statements obtained in the algebra chapter
into the language of schemes.

\begin{lemma}
\label{lemma-dominate-etale-neighbourhood-finite-flat}
Let $S$ be a scheme. Let $s \in S$.
Let $f : (U, u) \to (S, s)$ be an etale neighbourhood.
There exists an affine open neighbourhood $s \in V \subset S$
and a surjective, finite locally free morphism $\pi : T \to V$
such that for every $t \in \pi^{-1}(s)$ there exists an
open neighbourhood $t \in W_t \subset T$ and a commutative
diagram
$$
\xymatrix{
T \ar[d]^\pi & W_t \ar[l] \ar[rr]_{h_t} \ar[rd] & & U \ar[dl] \\
V \ar[rr] & & S
}
$$
with $h_t(t) = u$.
\end{lemma}

\begin{proof}
The problem is local on $S$ hence we may replace $S$ by any
open neighbourhood of $s$.
We may also replace $U$ by an open neighbourhood of $u$.
Hence, by Morphisms, Lemma \ref{morphisms-lemma-etale-locally-standard-etale}
we may assume that
$U \to S$ is a standard etale morphism of affine schemes.
In this case the lemma (with $V = S$) follows from
Algebra, Lemma \ref{algebra-lemma-standard-etale-finite-flat-Zariski}.
\end{proof}

\begin{lemma}
\label{lemma-dominate-etale-affine-finite-flat}
Let $f : U \to S$ be a surjective etale morphism of affine schemes.
There exists a surjective, finite locally free morphism
$\pi : T \to S$ and a finite open covering
$T = T_1 \cup \ldots \cup T_n$ such that each
$T_i \to S$ factors through $U \to S$. Diagram:
$$
\xymatrix{
& \coprod T_i  \ar[rd] \ar[ld] & \\
T \ar[rd]^\pi & & U \ar[ld]_f \\
& S &
}
$$
where the south-west arrow is a Zariski-covering.
\end{lemma}

\begin{proof}
This is a restatement of
Algebra, Lemma \ref{algebra-lemma-etale-finite-flat-zariski}.
\end{proof}

\begin{remark}
\label{remark-topologies}
In terms of topologies the lemmas above mean the following.
Let $S$ be any scheme. Let $\{f_i : U_i \to S\}$ be an etale covering
of $S$. There exists a Zariski open covering $S = \bigcup V_j$,
for each $j$ a finite locally free, surjective morphism
$W_j \to V_j$, and for each $j$ a Zariski open covering
$\{W_{j, k} \to W_j\}$ such that the family
$\{W_{j, k} \to S\}$ refines the given etale covering
$\{f_i : U_i \to S\}$. What does this mean in practice?
Well, for example, suppose we have a descend problem which we
know how to solve for Zariski coverings and for fppf coverings
of the form $\{\pi : T \to S\}$ with $\pi$ finite locally free
and surjective. Then this descend problem has an affirmative
answer for etale coverings as well. This trick was used by
Gabber in his proof that $\text{Br}(X) = \text{Br}'(X)$
for an affine scheme $X$, see \cite{Hoobler}.
\end{remark}

\noindent
Now we come to a series of lemmas around the theme
``quasi-finite morphisms become finite after etale localization''.
The general idea is the following. Suppose given a morphism
of schemes $f : X \to S$ and a point $s \in S$. Let
$\varphi : (U, u) \to (S, s)$ be an etale neighbourhood of $s$ in $S$.
Consider the fibre product $X_U = U \times_S X$ and the
basic diagram
\begin{equation}
\label{equation-basic-diagram}
\xymatrix{
V \ar[r] \ar[dr] & X_U \ar[d] \ar[r] & X \ar[d]^f \\
& U \ar[r]^\varphi & S
}
\end{equation}
where $V \subset X_U$ is open.
Is there some standard model for the morphism $f_U : X_U \to U$, or for
the morphism $V \to U$ for suitable opens $V$?
Of course the answer is no in general. But for quasi-finite morphisms
we can say something.

\begin{lemma}
\label{lemma-etale-makes-quasi-finite-finite-at-point}
Let $f : X \to S$ be a morphism of schemes.
Let $x \in X$. Set $s = f(x)$.
Assume that
\begin{enumerate}
\item $f$ is locally of finite type, and
\item $x \in X_s$ is isolated\footnote{In the presence of (1)
this means that $f$ is
quasi-finite at $x$, see
Morphisms, Lemma \ref{morphisms-lemma-quasi-finite-at-point-characterize}.}.
\end{enumerate}
Then there exist
\begin{enumerate}
\item[(a)] an etale neighbourhood $(U, u) \to (S, s)$
with $\kappa(s) = \kappa(u)$,
\item[(b)] an open subscheme $V \subset X_U$
(see \ref{equation-basic-diagram})
\end{enumerate}
such that
\begin{enumerate}
\item[(\romannumeral1)] $V \to U$ is a finite morphism,
\item[(\romannumeral2)] there is a unique point $v$ of $V$
mapping to $u$ in $U$, and
\item[(\romannumeral3)] the point $v$ maps to $x$
under the morphism $X_U \to X$, inducing $\kappa(x) = \kappa(v)$.
\end{enumerate}
Moreover, for any etale neighbourhood $(U', u') \to (U, u)$
with $\kappa(u) = \kappa(u')$ the triple $(U', u', V')$
with $V' = U' \times_U V \subset X_{U'}$ satisfies the properties
(\romannumeral1), (\romannumeral2), and (\romannumeral3) as well.
\end{lemma}

\begin{proof}
Let $Y \subset X$, $W \subset S$ be affine opens such that
$f(Y) \subset W$ and such that $x \in Y$. Note that $x$ is
also an isolated point of the fibre of the morphism $f|_Y : Y \to W$.
If we can prove the theorem for $f|_Y : Y \to W$, then the
theorem follows for $f$. Hence we reduce to the case where
$f$ is a morphism of affine schemes. This case is
Algebra, Lemma \ref{algebra-lemma-etale-makes-quasi-finite-finite-one-prime}.
\end{proof}

\noindent
In the preceding and following lemma we do not assume that the morphism
$f$ is separated. This means that the opens $V$, $V_i$ created
in them are not necessarily closed in $X_U$. Moreover, if we choose
the neighbourhood $U$ to be affine, then each $V_i$ is affine, but
the intersections $V_i \cap V_j$ need not be affine (in the nonseparated
case).

\begin{lemma}
\label{lemma-etale-makes-quasi-finite-finite-multiple-points}
Let $f : X \to S$ be a morphism of schemes.
Let $x_1, \ldots, x_n \in X$ be points having the same image $s$ in $S$.
Assume that
\begin{enumerate}
\item $f$ is locally of finite type, and
\item $x_i \in X_s$ is isolated for $i = 1, \ldots, n$.
\end{enumerate}
Then there exist
\begin{enumerate}
\item[(a)] an etale neighbourhood $(U, u) \to (S, s)$
with $\kappa(s) = \kappa(u)$,
\item[(b)] for each $i$ an open subscheme $V_i \subset X_U$,
\end{enumerate}
such that for each $i$ we have
\begin{enumerate}
\item[(\romannumeral1)] $V_i \to U$ is a finite morphism,
\item[(\romannumeral2)] there is a unique point $v_i$ of $V_i$
mapping to $u$ in $U$, and
\item[(\romannumeral3)] the point $v_i$ maps to $x_i$ in $X$ and
$\kappa(x_i) = \kappa(v_i)$.
\end{enumerate}
\end{lemma}

\begin{proof}
We will use induction on $n$.
Namely, suppose $(U,u) \to (S, s)$ and $V_i \subset X_U$,
$i = 1, \ldots, n - 1$ work for $x_1, \ldots, x_{n - 1}$. Since
$\kappa(s) = \kappa(u)$ the fibre $(X_U)_u = X_s$. Hence there
exists a unique point $x'_n \in X_u \subset X_U$ corresponding to
$x_n \in X_s$. Also $x'_n$ is isolated in $X_u$. Hence by
Lemma \ref{lemma-etale-makes-quasi-finite-finite-at-point} there
exists an etale neighbourhood $(U', u') \to (U, u)$
and an open $V_n \subset X_{U'}$ which works for $x'_n$ and hence
for $x_n$.
By the final assertion of
Lemma \ref{lemma-etale-makes-quasi-finite-finite-at-point}
the open subschemes $V'_i = U'\times_U V_i$ for $i = 1, \ldots, n - 1$ still
work with respect to $x_1, \ldots, x_{n - 1}$. Hence we win.
\end{proof}

\noindent
If we allow a nontrivial field extension
$\kappa(s) \subset \kappa(u)$, then we can
split the points as follows.

\begin{lemma}
\label{lemma-etale-makes-quasi-finite-finite-multiple-points-variant}
Let $f : X \to S$ be a morphism of schemes.
Let $x_1, \ldots, x_n \in X$ be points having the same image $s$ in $S$.
Assume that
\begin{enumerate}
\item $f$ is locally of finite type, and
\item $x_i \in X_s$ is isolated for $i = 1, \ldots, n$.
\end{enumerate}
Then there exist
\begin{enumerate}
\item[(a)] an etale neighbourhood $(U, u) \to (S, s)$,
\item[(b)] for each $i$ an integer $m_i$ and
open subschemes $V_{i, j} \subset X_U$, $j = 1, \ldots, m_j$
\end{enumerate}
such that we have
\begin{enumerate}
\item[(\romannumeral1)] each $V_{i, j} \to U$ is a finite morphism,
\item[(\romannumeral2)] there is a unique point $v_{i, j}$ of $V_{i, j}$
mapping to $u$ in $U$ with $\kappa(u) \subset \kappa(v_{i, j})$
finite purely inseparable, and
\item[(\romannumeral3)] the points $v_{i, j}$ map to $x_i$ in $X$ and
no other points of $(X_U)_u$ map to $x_i$.
\end{enumerate}
\end{lemma}

\begin{proof}
This proof is a variant of the proof of
Algebra, Lemma \ref{algebra-lemma-etale-makes-quasi-finite-finite-variant}
in the language of schemes.
By Morphisms, Lemma \ref{morphisms-lemma-quasi-finite-at-point-characterize}
the morphism $f$ is quasi-finite at each of the points $x_i$.
Hence $\kappa(s) \subset \kappa(x_i)$ is finite for each $i$
(Morphisms, Lemma \ref{morphisms-lemma-residue-field-quasi-finite}).
For each $i$, let $\kappa(s) \subset L_i \subset \kappa(x_i)$
be the subfield such that $L_i/\kappa(s)$ is separable, and
$\kappa(x_i)/L_i$ is purely inseparable. Choose a finite Galois
extension $\kappa(s) \subset L$ such that there exist
$\kappa(s)$-embeddings $L_i \to L$ for $i = 1, \ldots, n$.
Choose an etale neighbourhood $(U, u) \to (S, s)$ such that
$L \cong \kappa(u)$ as $\kappa(s)$-extensions
(Lemma \ref{lemma-realize-presecribed-residue-field-extension-etale}).

\medskip\noindent
Let $y_{i, j}$, $j = 1, \ldots, m_i$ be the points of $X_U$
lying over $x_i \in X$ and $u \in U$. By
Schemes, Lemma \ref{schemes-lemma-points-fibre-product}
these points $y_{i, j}$ correspond exactly to the primes in the rings
$\kappa(u) \otimes_{\kappa(s)} \kappa(x_i)$. This also
explains why there are finitely many; in fact
$m_i = [L_i : \kappa(s)]$ but we do not need this.
By our choice of
$L$ (and elementary field theory)
we see that $\kappa(u) \subset \kappa(y_{i, j})$ is
finite purely inseparable for each pair $i, j$.
Also, by Morphisms, Lemma \ref{morphisms-lemma-base-change-quasi-finite}
for example, the morphism
$X_U \to U$ is quasi-finite at the points $y_{i, j}$ for
all $i, j$.

\medskip\noindent
Apply Lemma \ref{lemma-etale-makes-quasi-finite-finite-multiple-points}
to the morphism $X_U \to U$, the point $u \in U$
and the points $y_{i, j} \in (X_U)_u$. This gives an etale neighbourhood
$(U', u') \to (U, u)$ with $\kappa(u) = \kappa(u')$ and
opens $V_{i, j} \subset X_{U'}$ with the properties
(\romannumeral1), (\romannumeral2), and (\romannumeral3)
of that lemma. We claim that the etale neighbourhood
$(U', u') \to (S, s)$ and the opens $V_{i, j} \subset X_{U'}$
are a solution to the problem posed by the lemma.
We omit the verifications.
\end{proof}

\begin{lemma}
\label{lemma-etale-splits-off-quasi-finite-part-technical}
Let $f : X \to S$ be a morphism of schemes.
Let $s \in S$. Let $x_1, \ldots, x_n \in X_s$. Assume that
\begin{enumerate}
\item $f$ is locally of finite type,
\item $f$ is separated, and
\item $x_1, \ldots, x_n$ are pairwise distinct isolated points of $X_s$.
\end{enumerate}
Then there exists an etale neighbourhood $(U, u) \to (S, s)$
with $\kappa(s) = \kappa(u)$ and a decomposition
$$
U \times_S X = W \coprod V_1 \coprod \ldots \coprod V_n
$$
into open and closed subschemes such that the morphisms
$V_i \to U$ are finite, the fibres of $V_i \to U$ over $u$ are
singletons $\{v_i\}$, each $v_i$ maps to $x_i$ with
$\kappa(x_i) = \kappa(v_i)$, and the fibre of $W \to U$
over $u$ contains no points mapping to any of the $x_i$.
\end{lemma}

\begin{proof}
Choose $(U, u) \to (S, s)$ and $V_i \subset X_U$ as in
Lemma \ref{lemma-etale-makes-quasi-finite-finite-multiple-points}.
Since $X_U \to U$ is separated and $V_i \to U$ is finite
hence proper we see that $V_i \subset X_U$ is closed.
Hence $V_i \cap V_j$ is a closed subset of $V_i$ which
does not contain $v_i$. Hence the image of $V_i \cap V_j$
in $U$ is a closed set (because $V_i \to U$ proper) not
containing $u$. After shrinking $U$ we may therefore assume
that $V_i \cap V_j = \emptyset$ for all $i, j$. This gives the
decomposition as in the lemma.
\end{proof}

\noindent
Here is the variant where we reduce to purely inseparable
field extensions.

\begin{lemma}
\label{lemma-etale-splits-off-quasi-finite-part-technical-variant}
Let $f : X \to S$ be a morphism of schemes.
Let $s \in S$. Let $x_1, \ldots, x_n \in X_s$. Assume that
\begin{enumerate}
\item $f$ is locally of finite type,
\item $f$ is separated, and
\item $x_1, \ldots, x_n$ are pairwise distinct isolated points of $X_s$.
\end{enumerate}
Then there exists an etale neighbourhood $(U, u) \to (S, s)$
and a decomposition
$$
U \times_S X =
W \coprod
\coprod\nolimits_{i, j}
V_{i, j}
$$
into open and closed subschemes such that the morphisms
$V_{i, j} \to U$ are finite, the fibres of $V_{i, j} \to U$ over $u$ are
singletons $\{v_{i, j}\}$, each $v_{i, j}$ maps to $x_i$,
$\kappa(u) \subset \kappa(v_{i, j})$ is purely inseparable,
and the fibre of $W \to U$ over $u$ contains no points mapping
to any of the $x_i$.
\end{lemma}

\begin{proof}
This is proved in exactly the same way as the proof of
Lemma \ref{lemma-etale-splits-off-quasi-finite-part-technical} except that it
uses Lemma \ref{lemma-etale-makes-quasi-finite-finite-multiple-points-variant}
instead of Lemma \ref{lemma-etale-makes-quasi-finite-finite-multiple-points}.
\end{proof}

\noindent
The following version may be a little easier to parse.

\begin{lemma}
\label{lemma-etale-splits-off-quasi-finite-part}
Let $f : X \to S$ be a morphism of schemes.
Let $s \in S$. Assume that
\begin{enumerate}
\item $f$ is locally of finite type,
\item $f$ is separated, and
\item $X_s$ has at most finitely many isolated points.
\end{enumerate}
Then there exists an etale neighbourhood $(U, u) \to (S, s)$
with $\kappa(s) = \kappa(u)$ and a decomposition
$$
U \times_S X = W \coprod V
$$
into open and closed subschemes such that the morphisms
$V \to U$ is finite, and the fibre $W_u$ of the
morphism $W \to U$ contains no isolated points.
In particular, if $f^{-1}(s)$ is a finite set, then $W_u = \emptyset$.
\end{lemma}

\begin{proof}
This is clear from
Lemma \ref{lemma-etale-splits-off-quasi-finite-part-technical}
by choosing $x_1, \ldots, x_n$ the complete set of
isolated points of $X_s$ and setting $V = \bigcup V_i$.
\end{proof}







\section{Application to the structure of (quasi-)finite morphisms}
\label{section-application-etale-neighbourhoods}

\noindent
We can use the existence of good etale neighbourhoods to prove
some fundamental facts about quasi-finite morphisms.

\begin{lemma}
\label{lemma-normalization-smooth-localization}
(Normalization commutes with smooth base change.) Let
$$
\xymatrix{
Y_U \ar[r] \ar[d] & Y \ar[d]_f \\
U \ar[r]^\varphi & X
}
$$
be a fibre square in the category of schemes.
Assume $f$ is quasi-compact and quasi-separated,
and $\varphi : U \to X$ is a smooth morphism.
Let $Y \to X' \to X$ be the normalization of $X$ in $Y$.
Let $Y_U \to (X_U)' \to U$ be the normalization of $U$ in $Y_U$.
Then $(X_U)' \cong U \times_X X'$.
\end{lemma}

\begin{proof}
Denote $f_U : Y_U \to U$ the base change of $f$.
By definition we have
$X' = \underline{\text{Spec}}_X(\mathcal{A})$ and
$(X_U)' = \underline{\text{Spec}}_U(\mathcal{A}')$, where
$\mathcal{A} \subset f_*\mathcal{O}_Y$ is the integral closure of
$\mathcal{O}_X$ and $\mathcal{A}' \subset (f_U)_*\mathcal{O}_{Y_U}$
is the integral closure of $\mathcal{O}_U$.
By Coherent, Lemma \ref{coherent-lemma-flat-base-change-cohomology}
we know that $(f_U)_*\mathcal{O}_{Y_U}$ is the same as
$\varphi^*(f_*\mathcal{O}_Y)$.
Let $\text{Spec}(C) \subset U$, $\text{Spec}(R) \subset X$ be
affine opens with $\varphi(\text{Spec}(C)) \subset \text{Spec}(R)$.
Hence $R \to C$ is a smooth ring map, see
Morphisms, Lemma \ref{morphisms-lemma-smooth-characterize}.
Write
$$
f_*\mathcal{O}_Y|_{\text{Spec}(R)} = \widetilde{B}
\quad\text{and}\quad
(f_U)_*\mathcal{O}_{Y_U}|_{\text{Spec}(C)} = \widetilde{B'}.
$$
By the above we have $B' = C \otimes_R B$. Let $A \subset B$ be
the integral closure of $R$ in $B$ and let $A' \subset B'$ be the
integral closure of $C$ in $B'$. Then we have
$$
\mathcal{A}|_{\text{Spec}(R)} = \widetilde{A}
\quad\text{and}\quad
\mathcal{A}'|_{\text{Spec}(C)} = \widetilde{A'},
$$
see Morphisms, Lemma \ref{morphisms-lemma-integral-closure}.
Hence the lemma is reduced to proving that $C \otimes_R A \cong A'$.
This is the content of
Algebra, Lemma \ref{algebra-lemma-integral-closure-commutes-smooth}.
\end{proof}

\begin{lemma}
\label{lemma-finite-type-separated}
Let $f : X \to S$ be a morphism of schemes.
Assume $f$ is of finite type and separated.
Let $S'$ be the normalization of $S$ in $X$, see
Morphisms, Definition \ref{morphisms-definition-normalization-X-in-Y}.
Picture:
$$
\xymatrix{
X \ar[rd]_f \ar[rr]_{f'} & & S' \ar[ld]^\nu \\
& S &
}
$$
Then there exists an open subscheme $U' \subset S'$ such that
\begin{enumerate}
\item $(f')^{-1}(U') \to U'$ is an isomorphism, and
\item $(f')^{-1}(U') \subset X$ is the set of points at which
$f$ is quasi-finite.
\end{enumerate}
\end{lemma}

\begin{proof}
By Morphisms, Lemma \ref{morphisms-lemma-quasi-finite-points-open}
the subset $U \subset X$ of points where $f$ is quasi-finite is open,
and $U \to S$ is locally quasi-finite. Let $x \in U$.
We want to show that
\begin{enumerate}
\item[(a)] there exists an open neighbourhood $V'' \subset X'$
of $f'(x)$ such that the morphism
$f'|_{(f')^{-1}(V'')} : (f')^{-1}(V'') \to V''$ is an isomorphism.
\end{enumerate}
This will prove the lemma since it will imply that $U' = f(U)$
is open, $f^{-1}(U') = U$ and that $f'|_U : U \to U'$ is an isomorphism.

\medskip\noindent
Let $s = f(x)$. Choose an etale neighbourhood $(T, t) \to (S, s)$ such that
$\kappa(s) = \kappa(t)$ and a decomposition
$$
X_T = V \coprod W
$$
into open and closed subschemes where $V \to T$ is finite, and such that
$V$ has a unique point $v \in V$ in the fibre over $t$ which maps to $x$,
and the fibre of $W \to T$ over $t$ contains no point mapping to $x$.
We can do this according to
Lemma \ref{lemma-etale-splits-off-quasi-finite-part-technical}.
Denote $f_T : X_T \to T$ (resp.\ $f'_T$) the base change of $f$
(resp.\ $f'$). According to
Lemma \ref{lemma-normalization-smooth-localization} the factorization
$$
X_T \xrightarrow{f'_T} T \times_S S' \longrightarrow T
$$
is the normalization of $T$ in $X_T$. On the other hand, since $X_T$
is a disjoint union of two schemes over $T$, we see that the normalization
of $T$ in $X_T$ is the morphism
$$
X_T = V \coprod W \longrightarrow V' \coprod W' \longrightarrow T
$$
where $V'$ is the normalization of $T$ in $V$ and $W'$ is the normalization
of $T$ in $W$
(Morphisms, Lemma \ref{morphisms-lemma-normalization-in-disjoint-union}).
However, since $V \to T$ is finite we see that $V \to V'$ is an isomorphism
(Morphisms, Lemmas \ref{morphisms-lemma-finite-integral}
and \ref{morphisms-lemma-normalization-in-integral}).
Also, $(f'_T)^{-1}(V') = V$. In other words, we have shown the following
\begin{enumerate}
\item[($\alpha$)] there exists an open neighbourhood $V' \subset X'_T$
of $f'_T(v)$ such that the restriction
$(f'_T)^{-1}(V') \to V'$ is an isomorphism.
\end{enumerate}
We will show that property $(\alpha)$ implies property (a) above.
Since $T \to S$ is etale we see that $X'_T \to X'$ is etale
(Morphisms, Lemma \ref{morphisms-lemma-base-change-etale}).
Hence also $V' \to X'$ is etale, in particular open
(Morphisms, Lemmas \ref{morphisms-lemma-fppf-open},
\ref{morphisms-lemma-etale-locally-finite-presentation}
and \ref{morphisms-lemma-etale-flat}). Denote
$V'' \subset X'$ the image. Note that
$$
(f'_T)^{-1}(V') = V' \times_{X'} X = V' \times_{V''} (f')^{-1}(V'')
$$
Hence the restriction $f'|_{(f')^{-1}(V'')} : (f')^{-1}(V'') \to V''$
is a morphism whose base change to $V'$ is an isomorphism. Since
$\{V' \to V''\}$ is an etale covering, we see that
$f'|_{(f')^{-1}(V'')} : (f')^{-1}(V'') \to V''$ is an isomorphism also,
by Descent, Lemma \ref{descent-lemma-descending-property-isomorphism}.
This proves (a) and we are done.
\end{proof}

\begin{lemma}
\label{lemma-quasi-finite-separated-quasi-affine}
Let $f : X \to S$ be a morphism of schemes.
Assume $f$ is quasi-finite and separated.
Let $S'$ be the normalization of $S$ in $X$, see
Morphisms, Definition \ref{morphisms-definition-normalization-X-in-Y}.
Picture:
$$
\xymatrix{
X \ar[rd]_f \ar[rr]_{f'} & & S' \ar[ld]^\nu \\
& S &
}
$$
Then $f'$ is a quasi-compact open immersion and $\nu$ is integral.
In particular $f$ is quasi-affine.
\end{lemma}

\begin{proof}
This follows from Lemma \ref{lemma-finite-type-separated}. Namely, by
that lemma there exists an open suscheme $U' \subset S'$ such that
$(f')^{-1}(U') = X$ (!) and $X \to U'$ is an isomorphism! In other
words, $f'$ is an open immersion. Note that $f'$ is quasi-compact as
$f$ is quasi-compact and $\nu : S' \to S$ is separated
(Schemes, Lemma \ref{schemes-lemma-quasi-compact-permanence}).
It follows that $f$ is quasi-affine by
Morphisms, Lemma \ref{morphisms-lemma-characterize-quasi-affine}.
\end{proof}

\begin{lemma}
\label{lemma-characterize-finite}
Let $f : X \to S$ be a morphism of schemes.
The following are equivalent:
\begin{enumerate}
\item $f$ is finite,
\item $f$ is proper with finite fibres.
\item $f$ is universally closed, separated, locally of finite type
and has finite fibres.
\end{enumerate}
\end{lemma}

\begin{proof}
We have (1) implies (2) by
Morphisms, Lemmas \ref{morphisms-lemma-finite-proper},
\ref{morphisms-lemma-quasi-finite},
and \ref{morphisms-lemma-finite-quasi-finite}.
By definition (2) implies (3).

\medskip\noindent
Assume (3). Pick $s \in S$. By
Morphisms, Lemma \ref{morphisms-lemma-finite-fibre} we
see that all the finitely many points of $X_s$ are isolated in $X_s$.
Choose an etale neighbourhood $(U, u) \to (S, s)$
and decomposition $X_U = V \coprod W$ as in
Lemma \ref{lemma-etale-splits-off-quasi-finite-part}.
Note that $W_u = \emptyset$ because all points of $X_s$ are isolated.
Since $f$ is universally closed we see that
the image of $W$ in $U$ is a closed set not containing $u$.
After shrinking $U$ we may assume that $W = \emptyset$.
In other words we see that $X_U = V$ is finite over $U$.
Since $s \in S$ was arbitrary
this means there exists a family $\{U_i \to S\}$
of etale morphisms whose images cover $S$ such that
the base changes $X_{U_i} \to U_i$ are finite.
Note that $\{U_i \to S\}$ is an etale covering,
see Topologies, Definition \ref{topologies-definition-etale-covering}.
Hence it is an fpqc covering, see
Topologies, Lemma \ref{topologies-lemma-zariski-etale-fppf-fpqc}.
Hence we conclude $f$ is finite by
Descent, Lemma \ref{descent-lemma-descending-property-finite}.
\end{proof}

\noindent
As a consequence we have the following useful result.

\begin{lemma}
\label{lemma-proper-finite-fibre-finite-in-neighbourhood}
Let $f : X \to S$ be a morphism of schemes.
Let $s \in S$.
Assume that $f$ is proper and $f^{-1}(\{s\})$ is a finite set.
Then there exists an open neighbourhood $V \subset S$ of $s$
such that $f|_{f^{-1}(V)} : f^{-1}(V) \to V$ is finite.
\end{lemma}

\begin{proof}
The morphism $f$ is quasi-finite at all the points of $f^{-1}(\{s\})$
by Morphisms, Lemma \ref{morphisms-lemma-finite-fibre}.
By Morphisms, Lemma \ref{morphisms-lemma-quasi-finite-points-open} the
set of points at which $f$ is quasi-finite is an open $U \subset X$.
Let $Z = X \setminus U$. Then $s \not \in f(Z)$. Since $f$ is proper
the set $f(Z) \subset S$ is closed. Choose any open neighbourhood
$V \subset S$ of $s$ with $Z \cap V = \emptyset$. Then
$f^{-1}(V) \to V$ is locally quasi-finite and proper.
Hence it is quasi-finite
(Morphisms, Lemma \ref{morphisms-lemma-quasi-finite-locally-quasi-compact}),
hence has finite fibres
(Morphisms, Lemma \ref{morphisms-lemma-quasi-finite}), hence
is finite by Lemma \ref{lemma-characterize-finite}.
\end{proof}






\section{Descending separated locally quasi-finite morphisms}
\label{section-separated-locally-quasi-finite}

\noindent
In this section we show that ``separated locally quasi-finite morphisms
satisfy descent for fppf-coverings''. See Descent, Definition
\ref{descent-definition-descending-types-morphisms} for terminology.
This is in the marvellous
(for many reasons) paper by Raynaud and Gruson hidden in the proof
of \cite[Lemma 5.7.1]{GruRay}. Here is the formal statement.

\begin{lemma}
\label{lemma-separated-locally-quasi-finite-morphisms-fppf-descend}
Let $S$ be a scheme.
Let $\{X_i \to S\}_{i\in I}$ be an fppf covering, see
Topologies, Definition \ref{topologies-definition-fppf-covering}.
Let $(V_i/X_i, \varphi_{ij})$ be a descent datum
relative to $\{X_i \to S\}$. If each morphism
$V_i \to X_i$ is separated and locally quasi-finite,
then the descent datum is effective.
\end{lemma}

\begin{proof}
Being separated and being locally quasi-finite
are properties of morphisms of schemes
which are preserved under any base change, see
Schemes, Lemma \ref{schemes-lemma-separated-permanence} and
Morphisms, Lemma \ref{morphisms-lemma-base-change-quasi-finite}.
Hence Descent, Lemma \ref{descent-lemma-descending-types-morphisms}
applies and it suffices to prove the statement of the lemma
in case the fppf-covering is given by a single
$\{X \to S\}$ flat surjective morphism of finite presentation of affines.
Say $X = \text{Spec}(A)$ and $S = \text{Spec}(R)$ so
that $R \to A$ is a faithfully flat ring map.
Let $(V, \varphi)$ be a descent datum relative to $X$ over $S$
and assume that $\pi : V \to X$ is separated and
locally quasi-finite.

\medskip\noindent
Let $W^1 \subset V$ be any affine open.
Consider $W = \text{pr}_1(\varphi(W^1 \times_S X)) \subset V$.
Here is a picture
$$
\xymatrix{
W^1 \times_S X \ar[rrrrr] \ar[ddd] \ar[rd]
& & & & &
\varphi(W^1 \times_S X) \ar[ddd] \ar[ld] \\
& V \times_S X \ar[rrr]^\varphi \ar[rd] \ar[dd]
& & &
X \times_S V \ar[ld] \ar[dd] & \\
& &
X \times_S X \ar[r]^1 \ar[d]_{\text{pr}_0}
&
X \times_S X \ar[d]^{\text{pr}_1}
& & \\
W^1 \ar[r] &
V \ar[r] &
X &
X &
V \ar[l] &
W \ar[l]
}
$$
Ok, and now since $X \to S$ is flat and of finite presentation it
is universally open (Morphisms, Lemma \ref{morphisms-lemma-fppf-open}).
Hence we conclude that $W$ is open. Moreover, it is
also clearly the case that $W$ is quasi-compact, and
$W^1 \subset W$. Moreover, we note that
$\varphi(W \times_S X) = X \times_S W$ by the cocycle
condition for $\varphi$. Hence we obtain a new descent datum
$(W, \varphi')$ by restricting $\varphi$ to $W \times_S X$.
Note that the morphism $W \to X$ is quasi-compact, separated
and locally quasi-finite. This implies that it is
separated and quasi-finite by definition. Hence it is quasi-affine by
Lemma \ref{lemma-quasi-finite-separated-quasi-affine}.
Thus by
Descent, Lemma \ref{descent-lemma-quasi-affine}
we see that the descent datum
$(W, \varphi')$ is effective.

\medskip\noindent
In other words, we find that there exists an open covering
$V = \bigcup W_i$ by quasi-compact opens $W_i$ which are
stable for the descent morphism $\varphi$.
Moreover, for each such quasi-compact open $W \subset V$
the corresponding descent data $(W, \varphi')$ is effective.
It is an exercise to show this means the
original descent datum is effective by glueing the
schemes obtained from descending the opens $W_i$ (details omitted).
\end{proof}












\input{chapters}

\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}
