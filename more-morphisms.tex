\input{preamble}

% OK, start here.
%
\begin{document}

\title{More on Morphisms}


\maketitle

\phantomsection
\label{section-phantom}

\tableofcontents

\section{Introduction}
\label{section-introduction}

\noindent
In this chapter we continue our study of properties of morphisms of schemes.
A fundamental reference is \cite{EGA}.






\section{Thickenings}
\label{section-thickenings}

\noindent
The following terminology may not be completely standard, but it is convenient.

\begin{definition}
\label{definition-thickening}
Thickenings. 
\begin{enumerate}
\item We say a scheme $X'$ is a {\it thickening} of a scheme $X$ if
$X$ is a closed subscheme of $X'$ and the underlying topological spaces
are equal.
\item We say a scheme $X'$ is a {\it first order thickening} of a scheme $X$ if
$X$ is a closed subscheme of $X'$ and the quasi-coherent sheaf of ideals
$\mathcal{I} \subset \mathcal{O}_{X'}$ defining $X$ has square zero.
\item Given two thickenings $X \subset X'$ and $Y \subset Y'$ a
{\it morphism of thickenings} is a morphism $f' : X' \to Y'$ such that
$f(X) \subset Y$, i.e., such that $f'|_X$ factors through the closed
subscheme $Y$. In this situation we set $f = f'|_X : X \to Y$ and we say
that $(f, f') : (X \subset X') \to (Y \subset Y')$ is a morphism of
thickenings.
\item Let $S$ be a scheme. We similarly define {\it thickenings over $S$}, and
{\it morphisms of thickenings over $S$}. This means that the schemes
$X, X', Y, Y'$ above are schemes over $S$, and that the morphisms
$X \to X'$, $Y \to Y'$ and $f' : X' \to Y'$ are morphisms over $S$.
\end{enumerate}
\end{definition}

\noindent
First order thickening are described as follows (see
Morphisms, Lemma \ref{morphisms-lemma-double-structure-gives-derivation}).

\begin{lemma}
\label{lemma-first-order-thickening}
Let $X$ be a scheme over a base $S$. Consider a short exact sequence
$$
0 \to \mathcal{I} \to \mathcal{A} \to \mathcal{O}_X \to 0
$$
of sheaves on $X$ where $\mathcal{A}$ is a sheaf of
$f^{-1}\mathcal{O}_S$-algebras,
$\mathcal{A} \to \mathcal{O}_X$ is a surjection
of sheaves of $f^{-1}\mathcal{O}_S$-algebras, and $\mathcal{I}$ is its kernel.
If
\begin{enumerate}
\item $\mathcal{I}$ is an ideal of square zero in $\mathcal{A}$, and
\item $\mathcal{I}$ is quasi-coherent as an $\mathcal{O}_X$-module
\end{enumerate}
then $X' = (X, \mathcal{A})$ is a scheme and $X \to X'$ is a first
order thickening over $S$. Moreover, any first order thickening over
$S$ is of this form.
\end{lemma}

\begin{proof}
It is clear that $X'$ is a locally ringed space. Let $U = \text{Spec}(B)$
be an affine open of $X$. Set $A = \Gamma(U, \mathcal{A})$. Note that
since $H^1(U, \mathcal{I}) = 0$ (see
Coherent, Lemma \ref{coherent-lemma-quasi-coherent-affine-cohomology-zero})
the map $A \to B$ is surjective. By assumption the kernel
$I = \mathcal{I}(U)$ is an ideal of square zero in the ring $A$.
By
Schemes, Lemma \ref{schemes-lemma-morphism-into-affine}
there is a canonical morphism of locally ringed spaces
$$
(U, \mathcal{A}|_U) \longrightarrow \text{Spec}(A)
$$
coming from the map $B \to \Gamma(U, \mathcal{A})$. Since this morphism
fits into the commutative diagram
$$
\xymatrix{
(U, \mathcal{O}_X|_U) \ar[d] \ar[r] & \text{Spec}(B) \ar[d] \\
(U, \mathcal{A}|_U) \ar[r] & \text{Spec}(A)
}
$$
we see that it is a homeomorphism on underlying topological spaces.
Thus to see that it is an isomorphism, it suffices to check it induces
an isomorphism on the local rings.
For $u \in U$ corresponding to the prime $\mathfrak p \subset A$
we obtain a commutative diagram of short exact sequences
$$
\xymatrix{
0 \ar[r] &
I_{\mathfrak p} \ar[r] \ar[d] &
A_{\mathfrak p} \ar[r] \ar[d] &
B_{\mathfrak p} \ar[r] \ar[d] & 0 \\
0 \ar[r] &
\mathcal{I}_u \ar[r] &
\mathcal{A}_u \ar[r] &
\mathcal{O}_{X, u} \ar[r] & 0.
}
$$
The left and right vertical arrows are isomorphisms because
$\mathcal{I}$ and $\mathcal{O}_X$ are quasi-coherent sheaves.
Hence also the middle map is an isomorphism. Hence every point
of $X' = (X, \mathcal{A})$ has an affine neighbourhood and $X'$ is a
scheme as desired.
\end{proof}




\section{First order infinitesimal neighbourhood}
\label{section-first-order-infinitesimal-neighbourhood}

\noindent
A natural construction of first order thickenings is the following.
Suppose that $i : Z \to X$ be an immersion of schemes. Choose an
open subscheme $U \subset X$ such that $i$ identifies $Z$ with a closed
subscheme $Z \subset U$. Let $\mathcal{I} \subset \mathcal{O}_U$ be the
quasi-coherent sheaf of ideals defining $Z$ in $U$. Then we can consider
the closed subscheme $Z' \subset U$ defined by the quasi-coherent sheaf
of ideals $\mathcal{I}^2$.

\begin{definition}
\label{definition-first-order-infinitesimal-neighbourhood}
Let $i : Z \to X$ be an immersion of schemes. The
{\it first order infinitesimal neighbourhood} of $Z$ in $X$ is
the first order thickening $Z \subset Z'$ over $X$ described above.
\end{definition}

\noindent
This thickening has the following universal property (which will assuage
any fears that the construction above depends on the choice of the open
$U$).

\begin{lemma}
\label{lemma-first-order-infinitesimal-neighbourhood}
Let $i : Z \to X$ be an immersion of schemes. The first order infinitesimal
neighbourhood $Z'$ of $Z$ in $X$ has the following universal property:
Given any commutative diagram
$$
\xymatrix{
Z \ar[d]_i & T \ar[l]^a \ar[d] \\
X & T' \ar[l]_b
}
$$
where $T \subset T'$ is a first order thickening over $X$, there exists
a unique morphism $(a', a) : (T \subset T') \to (Z \subset Z')$ of
thickenings over $X$.
\end{lemma}

\begin{proof}
Let $U \subset X$ be the open used in the construction of $Z'$, i.e., an
open such that $Z$ is identified with a closed subscheme of $U$ cut out by
the quasi-coherent sheaf of ideals $\mathcal{I}$.
Since $|T| = |T'|$ we see that $b(T') \subset U$. Hence we can
think of $b$ as a morphism into $U$. Let $\mathcal{J} \subset \mathcal{O}_{T'}$
be the ideal cutting out $T$. Since $b(T) \subset Z$ by the diagram above
we see that $b^\sharp(b^{-1}\mathcal{I}) \subset \mathcal{J}$. As
$T'$ is a first order thickening of $T$ we see that $\mathcal{J}^2 = 0$
hence $b^\sharp(b^{-1}(\mathcal{I}^2)) = 0$. By
Schemes, Lemma \ref{schemes-lemma-characterize-closed-subspace}
this implies that $b$ factors through $Z'$. Denote $a' : T' \to Z'$
this factorization and everything is clear.
\end{proof}

\begin{lemma}
\label{lemma-infinitesimal-neighbourhood-conormal}
Let $i : Z \to X$ be an immersion of schemes. Let $Z \subset Z'$ be
the first order infinitesimal neighbourhood of $Z$ in $X$.
Then the diagram
$$
\xymatrix{
Z \ar[r] \ar[d] & Z' \ar[d] \\
Z \ar[r] & X
}
$$
induces a map of conormal sheaves $\mathcal{C}_{Z/X} \to \mathcal{C}_{Z/Z'}$ by
Morphisms of Schemes, Lemma \ref{morphisms-lemma-conormal-functorial}.
This map is an isomorphism.
\end{lemma}

\begin{proof}
This is clear from the construction of $Z'$ above.
\end{proof}
















\section{Formally unramified morphisms}
\label{section-formally-unramified}

\noindent
Recall that a ring map $R \to A$ is called {\it formally unramified}
(see Algebra, Definition \ref{algebra-definition-formally-unramified})
if for every commutative solid diagram
$$
\xymatrix{
A \ar[r] \ar@{-->}[rd] & B/I \\
R \ar[r] \ar[u] & B \ar[u]
}
$$
where $I \subset B$ is an ideal of square zero, at most one dotted
arrow exists which makes the diagram commute. This motivates
the following analogue for morphisms of schemes.

\begin{definition}
\label{definition-formally-unramified}
Let $f : X \to S$ be a morphism of schemes.
We say $f$ is {\it formally unramified} if given any solid commutative diagram
$$
\xymatrix{
X \ar[d]_f & T \ar[d]^i \ar[l] \\
S & T' \ar[l] \ar@{-->}[lu]
}
$$
where $T \subset T'$ is a first order thickening of affine schemes over $S$
there exists at most one dotted arrow making the diagram commute.
\end{definition}

\noindent
We first prove some formal lemmas, i.e., lemmas which can be proved by
drawing the corresponding diagrams.

\begin{lemma}
\label{lemma-formally-unramified-not-affine}
If $f : X \to S$ is a formally unramified morphism, then given
any solid commutative diagram
$$
\xymatrix{
X \ar[d]_f & T \ar[d]^i \ar[l] \\
S & T' \ar[l] \ar@{-->}[lu]
}
$$
where $T \subset T'$ is a first order thickening of schemes over $S$
there exists at most one dotted arrow making the diagram commute.
In other words, in
Definition \ref{definition-formally-unramified}
the condition that $T$ be affine may be dropped.
\end{lemma}

\begin{proof}
This is true because a morphism is determined by its restrictions
to affine opens.
\end{proof}

\begin{lemma}
\label{lemma-composition-formally-unramified}
A composition of formally unramified morphisms is formally unramified.
\end{lemma}

\begin{proof}
This is formal.
\end{proof}

\begin{lemma}
\label{lemma-base-change-formally-unramified}
A base change of a formally unramified morphism is formally unramified.
\end{lemma}

\begin{proof}
This is formal.
\end{proof}

\begin{lemma}
\label{lemma-formally-unramified-on-opens}
Let $f : X \to S$ be a morphism of schemes.
Let $U \subset X$ and $V \subset S$ be open such that
$f(U) \subset V$. If $f$ is formally unramified, so is $f|_U : U \to V$.
\end{lemma}

\begin{proof}
Consider a solid diagram
$$
\xymatrix{
U \ar[d]_{f|_U} & T \ar[d]^i \ar[l]^a \\
V & T' \ar[l] \ar@{-->}[lu]
}
$$
as in Definition \ref{definition-formally-unramified}. If $f$ is formally
ramified, then there exists at most one
$S$-morphism $a' : T' \to X$ such that $a'|_T = a$.
Hence clearly there exists at most one such morphism into $U$.
\end{proof}

\begin{lemma}
\label{lemma-affine-formally-unramified}
Let $f : X \to S$ be a morphism of schemes.
Assume $X$ and $S$ are affine.
Then $f$ is formally unramified if and only if
$\mathcal{O}_S(S) \to \mathcal{O}_X(X)$ is a formally unramified
ring map.
\end{lemma}

\begin{proof}
This is immediate from the definitions
(Definition \ref{definition-formally-unramified} and
Algebra, Definition \ref{algebra-definition-formally-unramified})
by the equivalence of categories of rings and affine schemes,
see
Schemes, Lemma \ref{schemes-lemma-category-affine-schemes}.
\end{proof}

\noindent
Here is a characterization in terms of the sheaf of differentials.

\begin{lemma}
\label{lemma-formally-unramified-differentials}
Let $f : X \to S$ be a morphism of schemes.
Then $f$ is formally unramified if and only if $\Omega_{X/S} = 0$.
\end{lemma}

\begin{proof}
We give two proofs.

\medskip\noindent
First proof. It suffices to show that $\Omega_{X/S}$ is zero on the members of
an affine open covering of $X$. Choose an affine open $U \subset X$
with $f(U) \subset V$ where $V \subset S$ is an affine open of $S$. By
Lemma \ref{lemma-formally-unramified-on-opens}
the restriction $f_U : U \to V$ is formally unramified. By
Morphisms, Lemma \ref{morphisms-lemma-differentials-affine}
we see that $\Omega_{X/S}|_U$ is the quasi-coherent sheaf associated to
the $\mathcal{O}_X(U)$-module $\Omega_{\mathcal{O}_X(U)/\mathcal{O}_S(V)}$. By
Lemma \ref{lemma-affine-formally-unramified}
we see that $\mathcal{O}_S(V) \to \mathcal{O}_X(U)$ is a formally unramified
ring map. Hence by
Algebra, Lemma \ref{algebra-lemma-characterize-formally-unramified}
we conclude that $\Omega_{X/S}|_U = 0$ as desired.

\medskip\noindent
Second proof. We recall some of the arguments of
Morphisms, Section \ref{morphisms-section-sheaf-differentials}.
Let $U \subset X \times_S X$ be an open such that
$\Delta : X \to X \times_S X$ induces a closed immersion into $U$.
Let $\mathcal{J} \subset \mathcal{O}_U$ be the ideal sheaf of this
closed immersion. Let $X' \subset U$ be the closed subscheme
defined by the quasi-coherent sheaf of ideals $\mathcal{J}^2$.
Consider the two morphisms $p_1, p_2 : X' \to X$ induced by
the two projections $X \times_S X \to X$.
Note that $p_1$ and $p_2$ agree when composed with $\Delta : X \to X'$
and that $X \to X'$ is a closed immersion defined by a an ideal
whose square is zero. Moreover there is a short exact sequence
$$
0 \to \mathcal{J}/\mathcal{J}^2 \to \mathcal{O}_{X'} \to \mathcal{O}_X \to 0
$$
and $\Omega_{X/S} = \mathcal{J}/\mathcal{J}^2$. Moreover,
$\mathcal{J}/\mathcal{J}^2$ is generated by the local
sections $p_1^\sharp(f) - p_2^\sharp(f)$ for $f$ a local section of
$\mathcal{O}_X$.

\medskip\noindent
Suppose that $f : X \to S$ is formally unramified.
By assumption this means that $p_1 = p_2$ when restricted to any
affine open $T' \subset X'$. Hence $p_1 = p_2$. By what was said above
we conclude that $\Omega_{X/S} = \mathcal{J}/\mathcal{J}^2 = 0$.

\medskip\noindent
Conversely, suppose that $\Omega_{X/S} = 0$. Then $X' = X$. Take any pair
of morphisms $f'_1, f'_2 : T' \to X$ fitting as dotted arrows in
the diagram of
Definition \ref{definition-formally-unramified}.
This gives a morphism $(f'_1, f'_2) : T' \to X \times_S X$.
Since $f'_1|_T = f'_2|_T$ and $|T| =|T'|$ we see that the image of $T'$
under $(f'_1, f'_2)$ is contained in the open $U$ chosen above. Since
$(f'_1, f'_2)(T) \subset \Delta(X)$ and since $T$ is defined by an ideal
of square zero in $T'$ we see that $(f'_1, f'_2)$ factors through $X'$.
As $X' = X$ we conclude $f_1' = f'_2$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-unramified-formally-unramified}
Let $f : X \to S$ be a morphism of schemes.
The following are equivalent:
\begin{enumerate}
\item The morphism $f$ is unramified (resp.\ G-unramified), and
\item the morphism $f$ is locally of finite type (resp.\ locally of finite
presentation) and formally unramified.
\end{enumerate}
\end{lemma}

\begin{proof}
Use Lemma \ref{lemma-formally-unramified-differentials} and
Morphisms, Lemma \ref{morphisms-lemma-unramified-omega-zero}.
\end{proof}

\begin{lemma}
\label{lemma-universally-injective-unramified}
Let $f : X \to S$ be a morphism of schemes.
The following are equivalent:
\begin{enumerate}
\item $f$ is unramified and a monomorphism,
\item $f$ is unramified and universally injective,
\item $f$ is locally of finite type and a monomorphism,
\item $f$ is universally injective, locally of finite type, and
formally unramfied.
\end{enumerate}
\end{lemma}

\begin{proof}
We have seen in
Lemma \ref{lemma-unramified-formally-unramified}
that being formally unramified and locally of finite type is the same thing
as being unramified.
Hence (4) is equivalent to (2).
A monomorphism is certainly formally unramified hence (3) implies (4).
It is clear that (1) implies (3). Finally, if (2) holds, then
$\Delta : X \to X \times_S X$ is both an open immersion
(Morphisms, Lemma \ref{morphisms-lemma-diagonal-unramfied-morphism})
and surjective
(Morphisms, Lemma \ref{morphisms-lemma-universally-injective})
hence an isomorphism, i.e., $f$ is a monomorphism. In this way we see that
(2) implies (1).
\end{proof}








\section{Universal first order thickenings}
\label{section-universal-thickening}

\noindent
Let $h : Z \to X$ be a morphism of schemes. A {\it universal first order
thickening} of $Z$ over $X$ is a first order thickening $Z \subset Z'$
over $X$ such that given any first order thickening $T \subset T'$
over $X$ and a solid commutative diagram
$$
\xymatrix{
& Z \ar[ld] & & T \ar[rd] \ar[ll]^a \\
Z' \ar[rrd] & & & & T' \ar@{..>}[llll]_{a'} \ar[lld]^b \\
 & & X
}
$$
there exists a unique dotted arrow making the diagram commute.
Note that in this situation $(a, a') : (T \subset T') \to (Z \subset Z')$
is a morphism of thickenings over $X$. Thus if a universal first order
thickening exists, then it is unique up to unique isomorphism.
In general a universal first order thickening
does not exist, but if $h$ is formally unramified then it does.

\begin{lemma}
\label{lemma-universal-thickening}
Let $h : Z \to X$ be a formally unramified morphism of schemes.
There exists a universal first order thickening $Z \subset Z'$ of
$Z$ over $X$.
\end{lemma}

\begin{proof}
During this proof we will say $Z \subset Z'$ is a universal first order
thickening of $Z$ over $X$ if it satisfies the condition of the lemma.
We will construct the universal first order thickening $Z \subset Z'$ over $X$
by glueing, starting with the affine case which is
Algebra, Lemma \ref{algebra-lemma-universal-thickening}.
We begin with some general remarks.

\medskip\noindent
If a universal first order thickening of $Z$ over $X$ exists, then it is unique
up to unique isomorphism. Moreover, suppose that $V \subset Z$ and
$U \subset X$ are open subschemes such that $h(V) \subset U$. Let
$Z \subset Z'$ be a universal first order thickening of $Z$ over $X$.
Let $V' \subset Z'$ be the open subscheme such that $V = Z \cap V'$.
Then we claim that $V \subset V'$ is the universal first order thickening of
$V$ over $U$. Namely, suppose given any diagram
$$
\xymatrix{
V \ar[d]_h & T \ar[l]^a \ar[d] \\
U & T' \ar[l]_b
}
$$
where $T \subset T'$ is a first order thickening over $U$. By the universal
property of $Z'$ we obtain $(a, a') : (T \subset T') \to (Z \subset Z')$.
But since we have equality $|T| = |T'|$ of underlying topological spaces
we see that $a'(T') \subset V'$. Hence we may think of $(a, a')$
as a morphism of thickenings $(a, a') : (T \subset T') \to (V \subset V')$
over $U$. Uniqueness is clear also. In a completely similar manner one proves
that if $h(Z) \subset U$ and $Z \subset Z'$ is a universal first order
thickening over $U$, then $Z \subset Z'$ is a universal first order thickening
over $X$.

\medskip\noindent
Before we glue affine pieces let us show that the lemma holds if
$Z$ and $X$ are affine. Say $X = \text{Spec}(R)$ and $Z = \text{Spec}(S)$. By
Algebra, Lemma \ref{algebra-lemma-universal-thickening}
there exists a first order thickening $Z \subset Z'$ over $X$
which has the universal property of the lemma for diagrams
$$
\xymatrix{
Z \ar[d]_h & T \ar[l]^a \ar[d] \\
X & T' \ar[l]_b
}
$$
where $T, T'$ are affine. Given a general diagram we can choose an affine
open covering $T' = \bigcup T'_i$ and we obtain morphisms
$a'_i : T'_i \to Z'$ over $X$ such that $a'_i|_{T_i} = a|_{T_i}$.
By uniqueness we see that $a'_i$ and $a'_j$ agree on any affine open
of $T'_i \cap T'_j$. Hence the morphisms $a'_i$ glue to a global morphism
$a' : T' \to Z'$ over $X$ as desired. Thus the lemma holds if $X$ and $Z$
are affine.

\medskip\noindent
Choose an affine open covering $Z = \bigcup Z_i$ such that each $Z_i$
maps into an affine open $U_i$ of $X$. By
Lemma \ref{lemma-formally-unramified-on-opens}
the morphisms $Z_i \to U_i$ are formally unramified.
Hence by the affine case we obtain universal first order thickenings
$Z_i \subset Z_i'$ over $U_i$. By the general remarks above
$Z_i \subset Z_i'$ is also a universal first order thickening of
$Z_i$ over $X$. Let $Z'_{i, j} \subset Z'_i$ be the open subscheme
such that $Z_i \cap Z_j = Z'_{i, j} \cap Z_i$. By the general remarks
we see that both $Z'_{i, j}$ and $Z'_{j, i}$ are universal first
order thickenings of $Z_i \cap Z_j$ over $X$. Thus, by 
the first of our general remarks, we see that there is a canonical isomorphism
$\varphi_{ij} : Z'_{i, j} \to Z'_{j, i}$ inducing the identity on
$Z_i \cap Z_j$. We claim that these morphisms satisfy the cocycle condition of
Schemes, Section \ref{schemes-section-glueing-schemes}.
(Verification omitted. Hint: Use that $Z'_{i, j} \cap Z'_{i, k}$ is the
universal first order thickening of $Z_i \cap Z_j \cap Z_k$ which determines
it up to unique isomorphism by what was said above.)
Hence we can use the results of
Schemes, Section \ref{schemes-section-glueing-schemes}
to get a first order thickengin $Z \subset Z'$ over $X$ which the property
that the open subscheme $Z'_i \subset Z'$ with $Z_i = Z'_i \cap Z$
is a universal first order thickening of $Z_i$ over $X$.

\medskip\noindent
It turns out that this implies formally that $Z'$ is a universal first order
thickening of $Z$ over $X$. Namely, we have the universal property for any
diagram
$$
\xymatrix{
Z \ar[d]_h & T \ar[l]^a \ar[d] \\
X & T' \ar[l]_b
}
$$
where $a(T)$ is contained in some $Z_i$. Given a general diagram we can
choose an open covering $T' = \bigcup T'_i$ such that $a(T_i) \subset Z_i$.
We obtain morphisms $a'_i : T'_i \to Z'$ over $X$ such that
$a'_i|_{T_i} = a|_{T_i}$. We see that $a'_i$ and $a'_j$ necassarily agree
on $T'_i \cap T'_j$ since both $a'_i|_{T'_i \cap T'_j}$ and
$a'_j|_{T'_i \cap T'_j}$ are solutions of the problem of mapping into the
universal first oder thickening $Z'_i \cap Z'_j$ of $Z_i \cap Z_j$ over $X$.
Hence the morphisms $a'_i$ glue to a global morphism
$a' : T' \to Z'$ over $X$ as desired. This finishes the proof.
\end{proof}

\begin{definition}
\label{definition-universal-thickening}
Let $h : Z \to X$ be a formally unramified morphism of schemes.
\begin{enumerate}
\item The {\it universal first order thickening} of $Z$ over $X$
is the thickening $Z \subset Z'$ constructed in
Lemma \ref{lemma-universal-thickening}.
\item The {\it conormal sheaf of $Z$ over $X$} is the conormal sheaf
of $Z$ in its universal first order thickening $Z'$ over $X$.
\end{enumerate}
We often denote the conormal sheaf $\mathcal{C}_{Z/X}$ in this situation.
\end{definition}

\noindent
Thus we see that there is a short exact sequence of sheaves
$$
0 \to \mathcal{C}_{Z/X} \to \mathcal{O}_{Z'} \to \mathcal{O}_Z \to 0
$$
on $Z$.
The following lemma proves that there is no conflict between this definition
and the definition in case $Z \to X$ is an immersion.

\begin{lemma}
\label{lemma-immersion-universal-thickening}
Let $i : Z \to X$ be an immersion of schemes. Then
\begin{enumerate}
\item $i$ is formally unramified,
\item the universal first order thickening of $Z$ over $X$ is the first order
infinitesimal neighbourhood of $Z$ in $X$ of
Definition \ref{definition-first-order-infinitesimal-neighbourhood}, and
\item the conormal sheaf of $i$ in the sense of
Morphisms, Definition \ref{morphisms-definition-conormal-sheaf}
agrees with the conormal sheaf of $i$ in the sense of
Defintion \ref{definition-universal-thickening}.
\end{enumerate}
\end{lemma}

\begin{proof}
By
Morphisms, Lemmas \ref{morphisms-lemma-open-immersion-unramified} and
\ref{morphisms-lemma-closed-immersion-unramified}
an immersion is unramified, hence formally unramified by
Lemma \ref{lemma-unramified-formally-unramified}.
The other assertions follow by combining
Lemmas \ref{lemma-first-order-infinitesimal-neighbourhood} and
\ref{lemma-infinitesimal-neighbourhood-conormal}
and the definitions.
\end{proof}

\begin{lemma}
\label{lemma-universal-thickening-unramfied}
Let $Z \to X$ be a formally unramified morphism of schemes.
Then the universal first order thickening $Z'$ is formally
unramified over $X$.
\end{lemma}

\begin{proof}
There are two proofs. The first is to show that $\Omega_{Z'/X} = 0$
by working affine locally and applying
Algebra, Lemma \ref{algebra-lemma-differentials-universal-thickening}.
Then
Lemma \ref{lemma-formally-unramified-differentials}
implies what we want.
The second is a direct argument as follows.

\medskip\noindent
Let $T \subset T'$ be a first order thickening. Let
$$
\xymatrix{
Z' \ar[d] & T \ar[l]^c \ar[d] \\
X & T' \ar[l] \ar[lu]^{a, b}
}
$$
be a commutative diagram. Consider two morphisms $a, b : T' \to Z'$
fitting into the diagram. Set $T_0 = c^{-1}(Z) \subset T$ and
$T'_a = a^{-1}(Z)$ (scheme theoretically).
Since $Z'$ is a first order thickening of $Z$, we see that $T'$
is a first order thickening of $T'_a$. Moreover, since $c = a|_T$ we see that
$T_0 = T \cap T'_a$ (scheme theoretically). As $T'$ is a first order
thickening of $T$ it follows that $T'_a$
is a first order thickening of $T_0$. Now $a|_{T'_a}$ and $b|_{T'_a}$
are morphisms of $T'_a$ into $Z'$ over $X$ which agree on $T_0$ as
morphisms into $Z$. Hence by the universal property of $Z'$ we conclude that
$a|_{T'_a} = b|_{T'_a}$. Thus $a$ and $b$ are morphism from
the first order thickening $T'$ of $T'_a$ whose restrictions to
$T'_a$ agree as morphisms into $Z$. Thus using the universal property of
$Z'$ once more we conclude that $a = b$. In other words, the defining
property of a formally unramfied morphism holds for $Z' \to X$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-universal-thickening-functorial}
Consider a commutative diagram of schemes
$$
\xymatrix{
Z \ar[r]_h \ar[d]_f & X \ar[d]^g \\
W \ar[r]^{h'} & Y
}
$$
with $h$ and $h'$ formally unramified. Let $Z \subset Z'$ be the universal
first order thickening of $Z$ over $X$. Let $W \subset W'$ be the universal
first order thickening of $W$ over $Y$. There exists a canonical morphism
$(f, f') : (Z, Z') \to (W, W')$ of thickenings over $Y$ which fits into
the following commutative diagram
$$
\xymatrix{
& & & Z' \ar[ld] \ar[d]^{f'} \\
Z \ar[rr] \ar[d]_f \ar[rrru] & & X \ar[d] & W' \ar[ld] \\
W \ar[rrru]|!{[rr];[rruu]}\hole \ar[rr] & & Y
}
$$
In particular the morphism $(f, f')$ of thickenings induces a morphism
of conormal sheaves $f^*\mathcal{C}_{W/Y} \to \mathcal{C}_{Z/X}$.
\end{lemma}

\begin{proof}
The first assertion is clear from the universal property of $W'$.
The induced map on conormal sheaves is the map of
Morphisms, Lemma \ref{morphisms-lemma-conormal-functorial}
applied to $(Z \subset Z') \to (W \subset W')$.
\end{proof}

\begin{lemma}
\label{lemma-universal-thickening-fibre-product}
Let
$$
\xymatrix{
Z \ar[r]_h \ar[d]_f & X \ar[d]^g \\
W \ar[r]^{h'} & Y
}
$$
be a fibre product diagram in the category of schemes with
$h'$ formally unramfied. Then $h$ is formally unramified and if
$W \subset W'$ is the universal first order thickening of $W$ over $Y$,
then $Z = X \times_Y W \subset X \times_Y W'$ is the universal
first order thickening of $Z$ over $X$. In particular the canonical map
$f^*\mathcal{C}_{W/Y} \to \mathcal{C}_{Z/X}$ of
Lemma \ref{lemma-universal-thickening-functorial}
is surjective.
\end{lemma}

\begin{proof}
The morphism $h$ is formally unramified by
Lemma \ref{lemma-base-change-formally-unramified}.
It is clear that $X \times_Y W'$ is a first order thickening.
It is straightforward to check that it has the universal property
because $W'$ has the universal property (by mapping properties of
fibre products). See
Morphisms, Lemma \ref{morphisms-lemma-conormal-functorial-flat}
for why this implies that the map of conormal sheaves is surjective.
\end{proof}

\begin{lemma}
\label{lemma-universal-thickening-fibre-product-flat}
Let
$$
\xymatrix{
Z \ar[r]_h \ar[d]_f & X \ar[d]^g \\
W \ar[r]^{h'} & Y
}
$$
be a fibre product diagram in the category of schemes with
$h'$ formally unramfied and $g$ flat. In this case the corresponding
map $Z' \to W'$ of universal first order thickenings is flat, and
$f^*\mathcal{C}_{W/Y} \to \mathcal{C}_{Z/X}$ is an isomorphism.
\end{lemma}

\begin{proof}
Flatness is preserved under base change, see
Morphisms, Lemma \ref{morphisms-lemma-base-change-flat}.
Hence the first statement follows from the description of
$W'$ in Lemma \ref{lemma-universal-thickening-fibre-product}.
It is clear that $X \times_Y W'$ is a first order thickening.
It is straightforward to check that it has the universal property
because $W'$ has the universal property (by mapping properties of
fibre products). See
Morphisms, Lemma \ref{morphisms-lemma-conormal-functorial-flat}
for why this implies that the map of conormal sheaves is an isomorphism.
\end{proof}

\begin{lemma}
\label{lemma-universal-thickening-localize}
Taking the universal first order thickenings commutes with taking opens.
More precisely, let $h : Z \to X$ be a formally unramified morphism of schemes.
Let $V \subset Z$, $U \subset X$ be opens such that $h(V) \subset U$.
Let $Z'$ be the universal first order thickening of $Z$ over $X$.
Then $h|_V : V \to U$ is formally unramfied and the universal first
order thickening of $V$ over $U$ is the open subscheme $V' \subset Z'$
such that $V = Z \cap V'$. In particular,
$\mathcal{C}_{Z/X}|_V = \mathcal{C}_{V/U}$.
\end{lemma}

\begin{proof}
The first statement is
Lemma \ref{lemma-formally-unramified-on-opens}.
The compatibility of universal thickenings can be deduced from the proof of
Lemma \ref{lemma-universal-thickening},
or from
Algebra, Lemma \ref{algebra-lemma-universal-thickening-localize}
or deduced from
Lemma \ref{lemma-universal-thickening-fibre-product-flat}.
\end{proof}

\begin{lemma}
\label{lemma-differentials-universally-unramified}
Let $h : Z \to X$ be a formally unramified morphism of schemes over $S$.
Let $Z \subset Z'$ be the universal first order thickening of $Z$
over $X$ with structure morphism $h' : Z' \to X$. The canonical map
$$
c_{h'} : (h')^*\Omega_{X/S} \longrightarrow \Omega_{Z'/S}
$$
induces an isomorphism
$h^*\Omega_{X/S} \to \Omega_{Z'/S} \otimes \mathcal{O}_Z$.
\end{lemma}

\begin{proof}
The map $c_{h'}$ is the map defined in
Morphisms, Lemma \ref{morphisms-lemma-functoriality-differentials}.
If $i : Z \to Z'$ is the given closed immersion, then
$i^*c_{h'}$ is a map
$h^*\Omega_{X/S} \to \Omega_{Z'/S} \otimes \mathcal{O}_Z$.
Checking that it is an isomorphism reduces to the affine case
by localization, see
Lemma \ref{lemma-universal-thickening-localize}
and
Morphisms, Lemma \ref{morphisms-lemma-differentials-restrict-open}.
In this case the result is
Algebra, Lemma \ref{algebra-lemma-differentials-universal-thickening}.
\end{proof}

\begin{lemma}
\label{lemma-universally-unramified-differentials-sequence}
Let $h : Z \to X$ be a formally unramified morphism of schemes over $S$.
There is a canonical exact sequence
$$
\mathcal{C}_{Z/X} \to h^*\Omega_{X/S} \to \Omega_{Z/S} \to 0.
$$
The first arrow is induced by $\text{d}_{Z'/S}$ where
$Z'$ is the universal first order neighbourhood of $Z$ over $X$.
\end{lemma}

\begin{proof}
We know that there is a canonical exact sequence
$$
\mathcal{C}_{Z/Z'} \to
\Omega_{Z'/S} \otimes \mathcal{O}_Z \to
\Omega_{Z/S} \to 0.
$$
see
Morphisms, Lemma \ref{morphisms-lemma-differentials-relative-immersion}.
Hence the result follows on applying
Lemma \ref{lemma-differentials-universally-unramified}.
\end{proof}










\section{Formally \'etale morphisms}
\label{section-formally-etale}

\noindent
Recall that a ring map $R \to A$ is called {\it formally \'etale}
(see Algebra, Definition \ref{algebra-definition-formally-etale})
if for every commutative solid diagram
$$
\xymatrix{
A \ar[r] \ar@{-->}[rd] & B/I \\
R \ar[r] \ar[u] & B \ar[u]
}
$$
where $I \subset B$ is an ideal of square zero, there exists
exactly one dotted arrow which makes the diagram commute. This motivates
the following analogue for morphisms of schemes.

\begin{definition}
\label{definition-formally-etale}
Let $f : X \to S$ be a morphism of schemes.
We say $f$ is {\it formally \'etale} if given any solid commutative diagram
$$
\xymatrix{
X \ar[d]_f & T \ar[d]^i \ar[l] \\
S & T' \ar[l] \ar@{-->}[lu]
}
$$
where $T \subset T'$ is a first order thickening of affine schemes over $S$
there exists exactly one dotted arrow making the diagram commute.
\end{definition}

\noindent
It is clear that a formally \'etale morphism is formally unramified.
Hence if $f : X \to S$ is formally \'etale, then $\Omega_{X/S}$ is zero, see
Lemma \ref{lemma-formally-unramified-differentials}.

\begin{lemma}
\label{lemma-formally-etale-not-affine}
If $f : X \to S$ is a formally \'etale morphism, then given
any solid commutative diagram
$$
\xymatrix{
X \ar[d]_f & T \ar[d]^i \ar[l] \\
S & T' \ar[l] \ar@{-->}[lu]
}
$$
where $T \subset T'$ is a first order thickening of schemes over $S$
there exists exactly one dotted arrow making the diagram commute.
In other words, in
Definition \ref{definition-formally-etale}
the condition that $T$ be affine may be dropped.
\end{lemma}

\begin{proof}
Let $T' = \bigcup T'_i$ be an affine open covering, and let
$T_i = T \cap T'_i$. Then we get morphisms $a'_i : T'_i \to X$ fitting
into the diagram. By uniqueness we see that $a'_i$ and $a'_j$ agree on
any affine open subscheme of $T'_i \cap T'_j$. Hence $a'_i$ and
$a'_j$ agree on $T'_i \cap T'_j$. Thus we see that the morphisms $a'_i$
glue to a global morphism $a' : T' \to X$. The uniqueness of
$a'$ we have seen in
Lemma \ref{lemma-formally-unramified-not-affine}.
\end{proof}

\begin{lemma}
\label{lemma-composition-formally-etale}
A composition of formally \'etale morphisms is formally \'etale.
\end{lemma}

\begin{proof}
This is formal.
\end{proof}

\begin{lemma}
\label{lemma-base-change-formally-etale}
A base change of a formally \'etale morphism is formally \'etale.
\end{lemma}

\begin{proof}
This is formal.
\end{proof}

\begin{lemma}
\label{lemma-formally-etale-on-opens}
Let $f : X \to S$ be a morphism of schemes.
Let $U \subset X$ and $V \subset S$ be open subschemes such that
$f(U) \subset V$. If $f$ is formally \'etale, so is $f|_U : U \to V$.
\end{lemma}

\begin{proof}
Consider a solid diagram
$$
\xymatrix{
U \ar[d]_{f|_U} & T \ar[d]^i \ar[l]^a \\
V & T' \ar[l] \ar@{-->}[lu]
}
$$
as in Definition \ref{definition-formally-etale}. If $f$ is formally
ramified, then there exists exactly one $S$-morphism $a' : T' \to X$
such that $a'|_T = a$. Since $|T'| = |T|$ we conclude that $a'(T') \subset U$
which gives our unique morphism from $T'$ into $U$.
\end{proof}

\begin{lemma}
\label{lemma-characterize-formally-etale}
Let $f : X \to S$ be a morphism of schemes.
The following are equivalent:
\begin{enumerate}
\item $f$ is formally \'etale,
\item $f$ is formally unramified and the universal first order thickening
of $X$ over $S$ is equal to $X$,
\item $f$ is formally unramified and $\mathcal{C}_{X/S} = 0$, and
\item $\Omega_{X/S} = 0$ and $\mathcal{C}_{X/S} = 0$.
\end{enumerate}
\end{lemma}

\begin{proof}
Actually, the last assertion only make sense because $\Omega_{X/S} = 0$
implies that $\mathcal{C}_{X/S}$ is defined via
Lemma \ref{lemma-formally-unramified-differentials}
and
Definition \ref{definition-universal-thickening}.
This also makes it clear that (3) and (4) are equivalent.

\medskip\noindent
Either of the assumptions (1), (2), and (3) imply that $f$ is formally
unramified. Hence we may assume $f$ is formally unramified. The equivalence
of (1), (2), and (3) follow from the universal property of the universal
first order thickening $X'$ of $X$ over $S$ and the fact that
$X = X' \Leftrightarrow \mathcal{C}_{X/S} = 0$ since
after all by definition $\mathcal{C}_{X/S} = \mathcal{C}_{X/X'}$
is the ideal sheaf of $X$ in $X'$.
\end{proof}

\begin{lemma}
\label{lemma-unramified-flat-formally-etale}
An unramified flat morphism is formally \'etale.
\end{lemma}

\begin{proof}
Say $X \to S$ is unramified and flat. Then $\Delta : X \to X \times_S X$
is an open immersion, see
Morphisms, Lemma \ref{morphisms-lemma-diagonal-unramfied-morphism}.
We have to show that $\mathcal{C}_{X/S}$ is zero.
Consider the two projections $p, q : X \times_S X \to X$.
As $f$ is formally unramified (see
Lemma \ref{lemma-unramified-formally-unramified}),
$q$ is formally unramified (see
Lemma \ref{lemma-base-change-formally-unramified}).
As $f$ is flat, $p$ is flat, see
Morphisms, Lemma \ref{morphisms-lemma-base-change-flat}.
Hence $p^*\mathcal{C}_{X/S} = \mathcal{C}_q$ by
Lemma \ref{lemma-universal-thickening-fibre-product-flat}
where $\mathcal{C}_q$ denotes the conormal sheaf of the formally
unramified morphism $q : X \times_S X \to X$.
But $\Delta(X) \subset X \times_S X$ is an open subscheme
which maps isomorphically to $X$ via $q$. Hence by
Lemma \ref{lemma-universal-thickening-localize}
we see that $\mathcal{C}_q|_{\Delta(X)} = \mathcal{C}_{X/X} = 0$.
In other words, the pullback of $\mathcal{C}_{X/S}$ to $X$ via
the identity morphism is zero, i.e., $\mathcal{C}_{X/S} = 0$.
\end{proof}

\begin{lemma}
\label{lemma-affine-formally-etale}
Let $f : X \to S$ be a morphism of schemes.
Assume $X$ and $S$ are affine.
Then $f$ is formally \'etale if and only if
$\mathcal{O}_S(S) \to \mathcal{O}_X(X)$ is a formally \'etale
ring map.
\end{lemma}

\begin{proof}
This is immediate from the definitions
(Definition \ref{definition-formally-etale} and
Algebra, Definition \ref{algebra-definition-formally-etale})
by the equivalence of categories of rings and affine schemes,
see
Schemes, Lemma \ref{schemes-lemma-category-affine-schemes}.
\end{proof}

\begin{lemma}
\label{lemma-etale-formally-etale}
Let $f : X \to S$ be a morphism of schemes.
The following are equivalent:
\begin{enumerate}
\item The morphism $f$ is \'etale, and
\item the morphism $f$ is locally of finite presentation and
formally \'etale.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume $f$ is \'etale.
An \'etale morphism is locally of finite presentation, flat and unramified, see
Morphisms, Section \ref{morphisms-section-etale}.
Hence $f$ is locally of finite presentation and formally \'etale, see
Lemma \ref{lemma-unramified-flat-formally-etale}.

\medskip\noindent
Conversely, suppose that $f$ is locally of finite presentation and
formally \'etale. Being \'etale is local in the Zariski topology on
$X$ and $S$, see
Morphisms, Lemma \ref{morphisms-lemma-etale-characterize}.
By
Lemma \ref{lemma-formally-etale-on-opens}
we can cover $X$ by affine opens $U$ which map into affine opens
$V$ such that $U \to V$ is formally \'etale (and of finite presentation, see
Morphisms,
Lemma \ref{morphisms-lemma-locally-finite-presentation-characterize}).
By
Lemma \ref{lemma-affine-formally-etale}
we see that the ring maps $\mathcal{O}(V) \to \mathcal{O}(U)$ are
formally \'etale (and of finite presentation).
We win by
Algebra, Lemma \ref{algebra-lemma-formally-etale-etale}.
(We will give another proof of this implication when we discuss
formally smooth morphisms.)
\end{proof}













\section{Infinitesimal deformations of maps}
\label{section-action-by-derivations}

\noindent
In this section we explain how a derivation can be used to
infinitesimally move a map. Throughout this section we use that
a sheaf on a thickening $X'$ of $X$ can be seen as a sheaf on $X$.

\begin{lemma}
\label{lemma-difference-derivation}
Let $S$ be a scheme.
Let $X \subset X'$ and $Y \subset Y'$ be two first order thickenings
over $S$. Let $(a, a'), (b, b') : (X \subset X') \to (Y \subset Y')$
be two morphisms of thickenings over $S$. Assume that
\begin{enumerate}
\item $a = b$, and
\item the two maps $a^*\mathcal{C}_{Y/Y'} \to \mathcal{C}_{X/X'}$
(Morphisms, Lemma \ref{morphisms-lemma-conormal-functorial})
are equal.
\end{enumerate}
Then the map $(a')^\sharp - (b')^\sharp$ factors as
$$
\mathcal{O}_{Y'} \to \mathcal{O}_Y \xrightarrow{D}
a_*\mathcal{C}_{X/X'} \to a_*\mathcal{O}_{X'}
$$
where $D$ is an $\mathcal{O}_S$-derivation.
\end{lemma}

\begin{proof}
Instead of working on $Y$ we work on $X$. The advantage is that the pullback
functor $a^{-1}$ is exact. Using (1) and (2) we obtain a commutive diagram
with exact rows
$$
\xymatrix{
0 \ar[r] &
\mathcal{C}_{X/X'} \ar[r] &
\mathcal{O}_{X'} \ar[r] &
\mathcal{O}_X \ar[r] & 0 \\
0 \ar[r] &
a^{-1}\mathcal{C}_{Y/Y'} \ar[r] \ar[u] &
a^{-1}\mathcal{O}_{Y'}
\ar[r] \ar@<1ex>[u]^{(a')^\sharp} \ar@<-1ex>[u]_{(b')^\sharp} &
a^{-1}\mathcal{O}_Y \ar[r] \ar[u] & 0
}
$$
Now it is a general fact that in such a situation the difference of the
$\mathcal{O}_S$-algebra maps $(a')^\sharp$ and $(b')^\sharp$ is an
$\mathcal{O}_S$-derivation from $a^{-1}\mathcal{O}_Y$ to $\mathcal{C}_{X/X'}$.
By adjointness of the functors $a^{-1}$ and $a_*$ this is the same
thing as an $\mathcal{O}_S$-derivation from
$\mathcal{O}_Y$ into $a_*\mathcal{C}_{X/X'}$. Some details omitted.
\end{proof}

\noindent
Note that in the situation of the lemma above we may write
$D$ as
\begin{equation}
\label{equation-D}
D = \text{d}_{Y/S} \circ \theta
\end{equation}
where $\theta$ is an $\mathcal{O}_Y$-linear map
$\theta : \Omega_{Y/S} \to a_*\mathcal{C}_{X/X'}$.
Of course, then by adjunction again we may view $\theta$ as an
$\mathcal{O}_X$-linear map
$\theta : a^*\Omega_{Y/S} \to \mathcal{C}_{X/X'}$.

\begin{lemma}
\label{lemma-action-by-derivations}
Let $S$ be a scheme.
Let $(a, a') : (X \subset X') \to (Y \subset Y')$
be a morphism of first order thickenings over $S$.
Let
$$
\theta : a^*\Omega_{Y/S} \to \mathcal{C}_{X/X'}
$$
be an $\mathcal{O}_X$-linear map. Then there exists a unique morphism of pairs
$(b, b') : (X \subset X') \to (Y \subset Y')$ such that
(1) and (2) of
Lemma \ref{lemma-difference-derivation}
hold and the derivation $D$ and $\theta$ are related by
Equation (\ref{equation-D}).
\end{lemma}

\begin{proof}
We simply set $b = a$ and we define $(b')^\sharp$ to be the map
$$
(a')^\sharp + D : a^{-1}\mathcal{O}_{Y'} \to \mathcal{O}_{X'}
$$
where $D$ is as in Equation (\ref{equation-D}). We omit the verification
that $(b')^\sharp$ is a map of sheaves of $\mathcal{O}_S$-algebras and
that (1) and (2) of
Lemma \ref{lemma-difference-derivation}
hold. Equation (\ref{equation-D}) holds by construction.
\end{proof}

\begin{lemma}
\label{lemma-sheaf}
Let $S$ be a scheme.
Let $X \subset X'$ and $Y \subset Y'$ be first order thickenings
over $S$. Assume given a morphism $a : X \to Y$ and a map
$A : a^*\mathcal{C}_{Y/Y'} \to \mathcal{C}_{X/X'}$ of
$\mathcal{O}_X$-modules. For an open subscheme $U' \subset X'$
consider morphisms $a' : U' \to Y'$ such that
\begin{enumerate}
\item $a'$ is a morphism over $S$,
\item $a'|_U = a|_U$, and
\item the induced map
$a^*\mathcal{C}_{Y/Y'}|_U \to \mathcal{C}_{X/X'}|_U$
is the restriction of $A$ to $U$.
\end{enumerate}
Here $U = X \cap U'$. Then the rule
\begin{equation}
\label{equation-sheaf}
U' \mapsto
\{a' : U' \to Y'\text{ such that (1), (2), (3) hold.}\}
\end{equation}
defines a sheaf of sets on $X'$.
\end{lemma}

\begin{proof}
Denote $\mathcal{F}$ the rule of the lemma.
The restriction mapping $\mathcal{F}(U') \to \mathcal{F}(V')$ for
$V' \subset U' \subset X'$
of $\mathcal{F}$ is really the restriction map $a' \mapsto a'|_{V'}$.
With this definition in place it is clear that $\mathcal{F}$ is a
sheaf since morphisms are defined locally.
\end{proof}

\noindent
In the following lemma we identify sheaves on $X$ and any thickening
of $X$.

\begin{lemma}
\label{lemma-action-sheaf}
Same notation and assumptions as in Lemma \ref{lemma-sheaf}.
There is an action of the sheaf
$$
\textit{Hom}_{\mathcal{O}_X}(a^*\Omega_{Y/S}, \mathcal{C}_{X/X'})
$$
on the sheaf (\ref{equation-sheaf}). Moreover, the action
is simply transitive for any open $U' \subset X'$ over which the sheaf
(\ref{equation-sheaf}) has a section.
\end{lemma}

\begin{proof}
This is a combination of
Lemmas \ref{lemma-difference-derivation},
\ref{lemma-action-by-derivations},
and \ref{lemma-sheaf}.
\end{proof}

\begin{remark}
\label{remark-special-case}
A special case of
Lemmas \ref{lemma-difference-derivation},
\ref{lemma-action-by-derivations},
\ref{lemma-sheaf}, and
\ref{lemma-action-sheaf}
is where $Y = Y'$. In this case the map $A$ is always zero.
The sheaf of
Lemma \ref{lemma-sheaf}
is just given by the rule
$$
U' \mapsto
\{a' : U' \to Y\text{ over }S\text{ with } a'|_U = a|_U\}
$$
and we act on this by the sheaf
$\textit{Hom}_{\mathcal{O}_X}(a^*\Omega_{Y/S}, \mathcal{C}_{X/X'})$.
The action of a local section $\theta$ on $a'$ is sometimes indicated by
$\theta \cdot a'$. Note that this means nothing else than the fact
that $(a')^\sharp$ and $(\theta \cdot a')^\sharp$ differ by a derivation
$D$ which is related to $\theta$ by Equation (\ref{equation-D}).
\end{remark}

\begin{lemma}
\label{lemma-omega-deformation}
Let $S$ be a scheme. Let $X \subset X'$ be a first order thickening over
$S$. Let $Y$ be a scheme over $S$. Let
$a', b' : X' \to Y$ be two morphisms over $S$ with
$a = a'|_X = b'|_X$. This gives rise to a commutative diagram
$$
\xymatrix{
X \ar[r] \ar[d]_a & X' \ar[d]^{(b', a')} \\
Y \ar[r]^-{\Delta_{Y/S}} & Y \times_S Y
}
$$
Since the horizontal arrows are immersions with conormal sheaves
$\mathcal{C}_{X/X'}$ and $\Omega_{Y/S}$, by
Morphisms, Lemma \ref{morphisms-lemma-conormal-functorial},
we obtain a map $\theta : a^*\Omega_{Y/S} \to \mathcal{C}_{X/X'}$.
Then this $\theta$ and the derivation $D$ of
Lemma \ref{lemma-difference-derivation}
are related by Equation (\ref{equation-D}).
\end{lemma}

\begin{proof}
Omitted. Hint: The equality may be checked on affine opens where it
comes from the following computation. If $f$ is a local section of
$\mathcal{O}_Y$, then $1 \otimes f - f \otimes 1$ is a local section
of $\mathcal{C}_{Y/(Y \times_S Y)}$ corresponding to $\text{d}_{Y/S}(f)$.
It is mapped to the local section $(a')^\sharp(f) - (b')^\sharp(f) = D(f)$
of $\mathcal{C}_{X/X'}$. In other words, $\theta(\text{d}_{Y/S}(f)) = D(f)$.
\end{proof}

\noindent
For later purposes we need a result that roughly states that the
construction of
Lemma \ref{lemma-action-by-derivations}
is compatible with \'etale localization.

\begin{lemma}
\label{lemma-sheaf-differentials-etale-localization}
Let
$$
\xymatrix{
X_1 \ar[d] & X_2 \ar[l]^f \ar[d] \\
S_1 & S_2 \ar[l]
}
$$
be a commutative diagram of schemes with $X_2 \to X_1$ and $S_2 \to S_1$
\'etale. Then the map $c_f : f^*\Omega_{X_1/S_1} \to \Omega_{X_2/S_2}$ of
Morphisms, Lemma \ref{morphisms-lemma-functoriality-differentials}
is an isomorphism.
\end{lemma}

\begin{proof}
We recall that an \'etale morphism $U \to V$ is a smooth morphism
with $\Omega_{U/V} = 0$. Using this we see that
Morphisms, Lemma \ref{morphisms-lemma-triangle-differentials}
implies $\Omega_{X_2/S_2} = \Omega_{X_2/S_1}$ and
Morphisms, Lemma \ref{morphisms-lemma-triangle-differentials-smooth}
implies that the map $f^*\Omega_{X_1/S_1} \to \Omega_{X_2/S_1}$
(for the morphism $f$ seen as a morphism over $S_1$)
is an isomorphism. Hence the lemma follows.
\end{proof}

\begin{lemma}
\label{lemma-action-by-derivations-etale-localization}
Consider a commutative diagram of schemes
$$
\xymatrix{
T_2 \ar[r] \ar[d]_h & T_2' \ar[rr]_{a_2'} \ar[d]^{h'} & &
X_2 \ar[dd] \ar[ld]^f \\
T_1 \ar[r] & T_1' \ar[r]_{a_1'} & X_1 \ar[d] & \\
& & S_1 & S_2 \ar[l]
}
$$
and assume that
\begin{enumerate}
\item $i_1 : T_1 \to T_1'$ is a first order thickening,
\item $i_2 : T_2 \to T_2'$ is a first order thickening, and
\item $X_2 \to X_1$ and $S_2 \to S_1$ are \'etale.
\end{enumerate}
Write $a_i = a'_i \circ i_k$ for $k = 1, 2$.
For any $\mathcal{O}_{T_1}$-linear map
$\theta_1 : a_1^*\Omega_{X_1/S_1} \to \mathcal{C}_{T_1/T'_1}$ let
$\theta_2$ be the composition
$$
\xymatrix{
a_2^*\Omega_{X_2/S_2} \ar@{=}[r] &
h^*a_1^*\Omega_{X_1/S_1} \ar[r]^-{h^*\theta_1} &
h^*\mathcal{C}_{T_1/T'_1} \ar[r] &
\mathcal{C}_{T_2/T'_2}
}
$$
(equality sign is explained in the proof). Then the diagram
$$
\xymatrix{
T_2' \ar[rr]_{\theta_2 \cdot a_2'} \ar[d] & & X_2 \ar[d] \\
T_1' \ar[rr]^{\theta_1 \cdot a_1'} & & X_1
}
$$
commutes where the actions $\theta_2 \cdot a_2'$ and $\theta_1 \cdot a_1'$
are as in
Remark \ref{remark-special-case}.
\end{lemma}

\begin{proof}
The equality sign comes from the identification
$f^*\Omega_{X_1/S_1} = \Omega_{X_2/S_2}$ of
Lemma \ref{lemma-sheaf-differentials-etale-localization}.
Namely, using this we have
$a_2^*\Omega_{X_2/S_2} = a_2^*f^*\Omega_{X_1/S_1} =
h^*a_1^*\Omega_{X_1/S_1}$ because $f \circ a_2 = a_1 \circ h$.
Having said this, the commutativity of the diagram may be checked
on affine opens. Hence we may assume the schemes in the initial
big diagram are affine. Thus we obtain a commutative diagram of rings
$$
\xymatrix{
B_2/I_2 & B_2 \ar[l] & &
A_2 \ar[ll]^{a_2'} \\
B_1/I_1 \ar[u] & B_1 \ar[u]^{h'} \ar[l] & A_1 \ar[l]^{a_1'} \ar[ru]_f &
\\
& & R_1 \ar[r] \ar[u] & R_2 \ar[uu]
}
$$
with $I_1^2 = 0$ and $I_2^2 = 0$ and moreover with the property that
$A_2 \otimes_{A_1} \Omega_{A_1/R_1} \to \Omega_{A_2/R_2}$ is an
isomorphism. Then $\theta_1 : B_1/I_1 \otimes_{A_1} \Omega_{A_1/R_1} \to I_1$
is $B_1$-linear. This gives an $R_1$-derivation
$D_1 = \theta_1 \circ \text{d}_{A_1/R_1} : A_1 \to I_1$.
In a similar way we see that
$\theta_2 : B_2/I_2 \otimes_{A_2} \Omega_{A_2/R_2} \to I_2$
gives rise to a $R_2$-derivation
$D_2 = \theta_2 \circ \text{d}_{A_2/R_2} : A_2 \to I_2$.
The construction of $\theta_2$ implies the following compatibility between
$\theta_1$ and $\theta_2$: for every $x \in A_1$ we have
$$
h'(D_1(x)) = D_2(f(x))
$$
as elements of $I_2$. Now by the construction of the action in
Lemma \ref{lemma-action-by-derivations}
and
Remark \ref{remark-special-case}
we know that $\theta_1 \cdot a_1'$ corresponds to the ring map
$a_1' + D_1 : A_1 \to B_1$ and $\theta_2 \cdot a_2'$ corresponds
to the ring map $a_2' + D_2 : A_2 \to B_2$. By the displayed equality
above we obtain that $h' \circ (a_1' + D_1) = (a_2' + D_2) \circ f$
as desired.
\end{proof}

\begin{remark}
\label{remark-tiny-improvement}
Lemma \ref{lemma-action-by-derivations-etale-localization}
can be improved in the following way.
Suppose that we have a commutative diagram of schemes as in
Lemma \ref{lemma-action-by-derivations-etale-localization}
but we do not assume that $X_2 \to X_1$
and $S_2 \to S_1$ are \'etale. Next, suppose we have
$\theta_1 : a_1^*\Omega_{X_1/S_1} \to \mathcal{I}_1$
and
$\theta_2 : a_2^*\Omega_{X_2/S_2} \to \mathcal{I}_2$
such that for a local section $t$ of $\mathcal{O}_{X_1}$ we have
$(h')^*\theta_1(a_1^*(\text{d}_{X_1/S_1}(t))) =
\theta_2(a_2^*(\text{d}_{X_2/S_2}(f^*t)))$, i.e., such that
$$
\xymatrix{
f_*\mathcal{O}_{X_2} \ar[rr]_{f_*D_2} & &
f_*a_{2, *}\mathcal{C}_{T_2/T_2'} \\
\mathcal{O}_{X_1} \ar[rr]^{D_1} \ar[u]^{f^\sharp} & &
a_{1, *}\mathcal{C}_{T_1/T_1'} \ar[u]_{\text{induced by }(h')^\sharp} 
}
$$
is commutative where $D_i$ corresponds to $\theta_i$ as in
Equation (\ref{equation-D}). Then we have the conclusion of
Lemma \ref{lemma-action-by-derivations-etale-localization}.
The importance of the condition that both $X_2 \to X_1$ and
$S_2 \to S_1$ are \'etale is that it allows us to construct a $\theta_2$
from $\theta_1$.
\end{remark}






\section{Infinitesimal deformations of schemes}
\label{section-deform}

\noindent
The following simple lemma is often a covenient tool to check whether
an infinitesimal deformation of a map is flat.

\begin{lemma}
\label{lemma-deform}
Let $(f, f') : (X \subset X') \to (S \subset S')$ be a morphism
of first order thickenings. Assume that $f$ is flat.
Then the following are equivalent
\begin{enumerate}
\item $f'$ is flat and $X = S \times_{S'} X'$, and
\item the canonical map $f^*\mathcal{C}_{S/S'} \to \mathcal{C}_{X/X'}$
is an isomorphism.
\end{enumerate}
\end{lemma}

\begin{proof}
As the problem is local on $X'$ we may assume that $X, X', S, S'$
are affine schemes. Say $S' = \text{Spec}(A')$, $X' = \text{Spec}(B')$,
$S = \text{Spec}(A)$, $X = \text{Spec}(B)$ with $A = A'/I$ and $B = B'/J$
for some square zero ideals. Then we obtain the following commutative
diagram
$$
\xymatrix{
0 \ar[r] &
J \ar[r] &
B' \ar[r] &
B \ar[r] & 0 \\
0 \ar[r] &
I \ar[r] \ar[u] &
A' \ar[r] \ar[u] &
A \ar[r] \ar[u] & 0
}
$$
with exact rows. The canonical map of the lemma is the map
$$
I \otimes_A B = I \otimes_{A'} B' \longrightarrow J.
$$
The assumption that $f$ is flat signifies that $A \to B$ is flat.

\medskip\noindent
Assume (1). Then $A' \to B'$ is flat and $J = IB'$. Flatness implies
$\text{Tor}_1^{A'}(B', A) = 0$ (see
Algebra, Lemma \ref{algebra-lemma-characterize-flat}).
This means $I \otimes_{A'} B' \to B'$ is injective (see
Algebra, Remark \ref{algebra-remark-Tor-ring-mod-ideal}).
Hence we see that $I \otimes_A B \to J$ is an isomorphism.

\medskip\noindent
Assume (2). Then it follows that $J = IB'$, so that $X = S \times_{S'} X'$.
Moreover, we get $\text{Tor}_1^{A'}(B', A'/I) = 0$ by reversing the
implications in the previous paragraph. Hence $B'$ is flat over $A'$ by
Algebra, Lemma \ref{algebra-lemma-what-does-it-mean}.
\end{proof}







\section{Formally smooth morphisms}
\label{section-formally-smooth}

\noindent
Michael Artin's position on differential criteria of smoothness (e.g.,
Morphisms, Lemma \ref{morphisms-lemma-smooth-at-point}) is that they are
basically useless (in practice). In this section we introduce the
notion of a formally smooth morphism $X \to S$. Such a morphism is
characterized by the property that $T$-valued points of $X$ lift
to inifinitesimal thickenings of $T$ provided $T$ is affine.
The main result is that a morphism which is formally smooth and
locally of finite presentation is smooth, see
Lemma \ref{lemma-smooth-formally-smooth}.
It turns out that this criterion is often easier to use than the
differential criteria mentioned above.

\medskip\noindent
Recall that a ring map $R \to A$ is called {\it formally smooth}
(see Algebra, Definition \ref{algebra-definition-formally-smooth})
if for every commutative solid diagram
$$
\xymatrix{
A \ar[r] \ar@{-->}[rd] & B/I \\
R \ar[r] \ar[u] & B \ar[u]
}
$$
where $I \subset B$ is an ideal of square zero, a dotted
arrow exists which makes the diagram commute. This motivates
the following analogue for morphisms of schemes.

\begin{definition}
\label{definition-formally-smooth}
Let $f : X \to S$ be a morphism of schemes.
We say $f$ is {\it formally smooth} if given any solid commutative diagram
$$
\xymatrix{
X \ar[d]_f & T \ar[d]^i \ar[l] \\
S & T' \ar[l] \ar@{-->}[lu]
}
$$
where $T \subset T'$ is a first order thickening of affine schemes over $S$
there exists a dotted arrow making the diagram commute.
\end{definition}

\noindent
In the cases of formally unramified and formally \'etale morphisms
the condition that $T'$ be affine could be dropped, see
Lemmas \ref{lemma-formally-unramified-not-affine} and
\ref{lemma-formally-etale-not-affine}.
This is no longer true in the case of formally smooth morphisms.
In fact, a slightly more natural condition would be that we should be
able to fill in the dotted arrow Zariski locally on $T'$. In fact, analyzing
the proof of
Lemma \ref{lemma-smooth-formally-smooth}
shows that this would be equivalent to the definition as it currently
stands.

\begin{lemma}
\label{lemma-composition-formally-smooth}
A composition of formally smooth morphisms is formally smooth.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-base-change-formally-smooth}
A base change of a formally smooth morphism is formally smooth.
\end{lemma}

\begin{proof}
Omitted, but see Algebra, Lemma \ref{algebra-lemma-base-change-fs}
for the algebraic version.
\end{proof}

\begin{lemma}
\label{lemma-formally-etale-unramfied-smooth}
Let $f : X \to S$ be a morphism of schemes.
Then $f$ is formally \'etale if and only if
$f$ is formally smooth and formally unramified.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-formally-smooth-on-opens}
Let $f : X \to S$ be a morphism of schemes.
Let $U \subset X$ and $V \subset S$ be open subschemes such that
$f(U) \subset V$. If $f$ is formally smooth, so is $f|_U : U \to V$.
\end{lemma}

\begin{proof}
Consider a solid diagram
$$
\xymatrix{
U \ar[d]_{f|_U} & T \ar[d]^i \ar[l]^a \\
V & T' \ar[l] \ar@{-->}[lu]
}
$$
as in Definition \ref{definition-formally-smooth}. If $f$ is formally
smooth, then there exists an $S$-morphism $a' : T' \to X$ such that
$a'|_T = a$. Since the underlying sets of $T$ and $T'$ are the same
we see that $a'$ is a morphism into $U$ (see Schemes, Section
\ref{schemes-section-open-immersion}). And it clearly is a $V$-morphism
as well. Hence the dotted arrow above as desired.
\end{proof}

\begin{lemma}
\label{lemma-affine-formally-smooth}
Let $f : X \to S$ be a morphism of schemes.
Assume $X$ and $S$ are affine.
Then $f$ is formally smooth if and only if
$\mathcal{O}_S(S) \to \mathcal{O}_X(X)$ is a formally smooth
ring map.
\end{lemma}

\begin{proof}
This is immediate from the definitions
(Definition \ref{definition-formally-smooth} and
Algebra, Definition \ref{algebra-definition-formally-smooth})
by the equivalence of categories of rings and affine schemes,
see
Schemes, Lemma \ref{schemes-lemma-category-affine-schemes}.
\end{proof}

\noindent
The following lemma is the main result of this section. It is a victory of the
functorial point of view in that it implies (combined with 
Limits,
Proposition \ref{limits-proposition-characterize-locally-finite-presentation})
that we can recognize whether a morphism $f : X \to S$ is smooth in terms of
``simple'' properties of the functor $h_X : \textit{Sch}/S \to \textit{Sets}$.

\begin{lemma}
\label{lemma-smooth-formally-smooth}
(Infinitesimal lifting criterion)
Let $f : X \to S$ be a morphism of schemes.
The following are equivalent:
\begin{enumerate}
\item The morphism $f$ is smooth, and
\item the morphism $f$ is locally of finite presentation and
formally smooth.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume $f : X \to S$ is locally of finite presentation and formally smooth.
Consider a pair of affine opens $\text{Spec}(A) = U \subset X$ and
$\text{Spec}(R) = V \subset S$
such that $f(U) \subset V$. By Lemma \ref{lemma-formally-smooth-on-opens}
we see that $U \to V$ is formally smooth. By Lemma
\ref{lemma-affine-formally-smooth} we see that $R \to A$ is formally
smooth. By
Morphisms, Lemma \ref{morphisms-lemma-locally-finite-presentation-characterize}
we see that $R \to A$ is of finite presentation.
By Algebra, Lemma \ref{algebra-lemma-formally-smooth-smooth}
we see that $R \to A$ is smooth.
Hence by the definition of a smooth morphism we see that $X \to S$ is smooth.

\medskip\noindent
Conversely, assume that $f : X \to S$ is smooth. Consider a solid commutative
diagram
$$
\xymatrix{
X \ar[d]_f & T \ar[d]^i \ar[l]^a \\
S & T' \ar[l] \ar@{-->}[lu]
}
$$
as in Definition \ref{definition-formally-smooth}.
We will show the dotted arrow exists thereby
proving that $f$ is formally smooth.

\medskip\noindent
Let $\mathcal{F}$ be the sheaf of sets on $T'$ of
Lemma \ref{lemma-sheaf},
see also
Remark \ref{remark-special-case}.
Let
$$
\mathcal{H} =
\textit{Hom}_{\mathcal{O}_T}(a^*\Omega_{X/S}, \mathcal{C}_{T/T'})
$$
be the sheaf of $\mathcal{O}_T$-modules on $T$ introduced in
Lemma \ref{lemma-action-sheaf}. Our goal is simply
to show that $\mathcal{F}(T) \not = \emptyset$. In other words we
are trying to show that $\mathcal{F}$ is a trivial $\mathcal{H}$-torsor
on $T$ (see Cohomology, Section \ref{cohomology-section-h1-torsors}).
There are two steps: (I) To show that $\mathcal{F}$ is a torsor
we have to show that $\mathcal{F}_t \not = \emptyset$ for all $t \in T$ (see
Cohomology, Definition \ref{cohomology-definition-torsor}).
(II) To show that $\mathcal{F}$ is the trivial torsor it suffices
to show that $H^1(T, \mathcal{H}) = 0$ (see
Cohomology, Lemma \ref{cohomology-lemma-torsors-h1} --
we may use either cohomology
of $\mathcal{H}$ as an abelian sheaf or as an $\mathcal{O}_T$-module,
see Cohomology, Lemma \ref{cohomology-lemma-modules-abelian}).

\medskip\noindent
First we prove (I). To see this, for every $t \in T$ we can
choose an affine open $U \subset T$ neighbourhood of $t$
such that $a(U)$ is contained
in an affine open $\text{Spec}(A) = W \subset X$
which maps to an affine open $\text{Spec}(R) = V \subset S$.
By Morphisms, Lemma \ref{morphisms-lemma-smooth-characterize}
the ring map $R \to A$ is smooth.
Hence by Algebra, Lemma \ref{algebra-lemma-formally-smooth-smooth}
the ring map $R \to A$ is formally smooth.
Lemma \ref{lemma-affine-formally-smooth}
in turn implies that $W \to V$ is formally smooth.
Hence we can lift $a|_U : U \to W$ to a $V$-morphism
$a' : U' \to W \subset X$ showing that $\mathcal{F}(U) \not = \emptyset$.

\medskip\noindent
Finally we prove (II).
By Morphisms, Lemma \ref{morphisms-lemma-finite-presentation-differentials}
we see that $\Omega_{X/S}$ is of finite presentation
(it is even finite locally free by
Morphisms, Lemma \ref{morphisms-lemma-smooth-omega-finite-locally-free}).
Hence $a^*\Omega_{X/S}$ is of finite presentation (see
Modules, Lemma \ref{modules-lemma-pullback-finite-presentation}).
Hence the sheaf
$\mathcal{H} =
\textit{Hom}_{\mathcal{O}_T}(a^*\Omega_{X/S}, \mathcal{C}_{T/T'})$
is quasi-coherent by the discussion in
Schemes, Section \ref{schemes-section-quasi-coherent}.
Thus by
Coherent, Lemma \ref{coherent-lemma-quasi-coherent-affine-cohomology-zero}
we have $H^1(T, \mathcal{H}) = 0$ as desired.
\end{proof}






































\section{Smoothness over a Noetherian base}
\label{section-smooth-Noetherian}

\noindent
It turns out that if the base is Noetherian then we can get away with
less in the formulation of formal smoothness. In some sense the following
lemmas are the beggining of deformation theory.

\begin{lemma}
\label{lemma-lifting-along-artinian-at-point}
Let $f : X \to S$ be a morphism of schemes.
Let $x \in X$.
Assume that $S$ is locally Noetherian and $f$ locally of finite type.
The following are equivalent:
\begin{enumerate}
\item $f$ is smooth at $x$,
\item for every solid commutative diagram
$$
\xymatrix{
X \ar[d]_f & \text{Spec}(B) \ar[d]^i \ar[l]^-\alpha \\
S & \text{Spec}(B') \ar[l]_-{\beta} \ar@{-->}[lu]
}
$$
where $B' \to B$ is a surjection of local rings with
$\text{Ker}(B' \to B)$ of square zero, and $\alpha$ mapping the
closed point of $\text{Spec}(B)$ to $x$ there exists
a dotted arrow making the diagram commute,
\item same as in (2) but with $B' \to B$ ranging over small
extensions (see Algebra, Definition \ref{algebra-definition-small-extension}),
and
\item same as in (2) but with $B' \to B$ ranging over small
extensions such that $\alpha$ induces an isomorphism
$\kappa(x) \to \kappa(\mathfrak m)$ where $\mathfrak m \subset B$
is the maximal ideal.
\end{enumerate}
\end{lemma}

\begin{proof}
Choose an affine neighbourhood $V \subset S$ of $f(x)$ and choose an
affine neighbourhood $U \subset X$ of $x$ such that $f(U) \subset V$.
For any ``test'' diagram as in (2) the morphism $\alpha$ will map
$\text{Spec}(B)$ into $U$ and the morphism $\beta$ will map $\text{Spec}(B')$
into $V$ (see Schemes, Section \ref{schemes-section-points}).
Hence the lemma reduces to the morphism $f|_U : U \to V$ of affines.
(Indeed, $V$ is Noetherian and $f|_U$ is of finite type, see
Properties, Lemma \ref{properties-lemma-locally-Noetherian} and
Morphisms, Lemma \ref{morphisms-lemma-locally-finite-type-characterize}.)
In this affine case the lemma is identical to
Algebra, Lemma \ref{algebra-lemma-smooth-test-artinian}.
\end{proof}

\noindent
Sometimes it is useful to know that one only needs to check the
lifting criterion for small extensions ``centered'' at points
of finite type (see
Morphisms, Section \ref{morphisms-section-points-finite-type}).

\begin{lemma}
\label{lemma-lifting-along-artinian}
Let $f : X \to S$ be a morphism of schemes.
Let $x \in X$.
Assume that $S$ is locally Noetherian and $f$ locally of finite type.
The following are equivalent:
\begin{enumerate}
\item $f$ is smooth,
\item for every solid commutative diagram
$$
\xymatrix{
X \ar[d]_f & \text{Spec}(B) \ar[d]^i \ar[l]^-\alpha \\
S & \text{Spec}(B') \ar[l]_-{\beta} \ar@{-->}[lu]
}
$$
where $B' \to B$ is a small extension of Artinian local rings
and $\beta$ of finite type (!) there exists a dotted arrow making
the diagram commute.
\end{enumerate}
\end{lemma}

\begin{proof}
If $f$ is smooth, then the infinitesimal lifting criterion
(Lemma \ref{lemma-smooth-formally-smooth}) says
$f$ is formally smooth and (2) holds.

\medskip\noindent
Assume (2). The set of points $x \in X$ where $f$ is not smooth
forms a closed subset $T$ of $X$. By the discussion in Morphisms,
Section \ref{morphisms-section-points-finite-type}, if $T \not = \emptyset$
there exists a point $x \in T \subset X$ such that the morphism
$$
\text{Spec}(\kappa(x)) \to X \to S
$$
is of finite type (namely, pick any point $x$ of $T$ which is closed
in an affine open of $X$). By
Morphisms, Lemma \ref{morphisms-lemma-artinian-finite-type} given any
local Artinian ring $B'$ with residue field $\kappa(x)$ then any
morphism $\beta : \text{Spec}(B') \to S$ is of finite type. Thus
we see that all the diagrams used in
Lemma \ref{lemma-lifting-along-artinian-at-point} (4) correspond
to diagrams as in the current lemma (2). Whence $X \to S$ is smooth
a $x$ a contradiction.
\end{proof}








\section{Pseudo-coherent morphisms}
\label{section-pseudo-coherent}

\noindent
Avoid reading this section at all cost.
If you need some of this material, first take a look at the
corresponding algebra sections, see
More on Algebra, Sections \ref{more-algebra-section-pseudo-coherent},
\ref{more-algebra-section-relative-pseudo-coherent}, and
\ref{more-algebra-section-pseudo-coherent-perfect-ring-map}.
For now the only thing you need to know is that a ring map
$A \to B$ is pseudo-coherent if and only if $B = A[x_1, \ldots, x_n]/I$
and $B$ as an $A[x_1, \ldots, x_n]$-module has a resolution by
finite free $A[x_1, \ldots, x_n]$-modules.

\begin{lemma}
\label{lemma-pseudo-coherent}
Let $f : X \to S$ be a morphism of schemes which is locally of finite type.
The following are equivalent
\begin{enumerate}
\item there exist an affine open covering $S = \bigcup V_j$ and for each $j$
an affine open covering $f^{-1}(V_j) = \bigcup U_{ji}$ such that
$\mathcal{O}_S(V_j) \to \mathcal{O}_X(U_{ij})$ is a pseudo-coherent
ring map, and
\item for every pair of affine opens $U \subset X$, $V \subset S$
such that $f(U) \subset V$ the ring map
$\mathcal{O}_S(V) \to \mathcal{O}_X(U)$ is pseudo-coherent.
\end{enumerate}
\end{lemma}

\begin{proof}
To see this it suffices to check conditions (1)(a), (b), (c) of
Morphisms, Defintion \ref{morphisms-definition-property-local}
for the property of being a pseudo-coherent ring map.
These properties follow from
More on Algebra,
Lemmas \ref{more-algebra-lemma-base-change-relative-pseudo-coherent}
(because a localization is flat),
\ref{more-algebra-lemma-localize-relative-pseudo-coherent}, and
\ref{more-algebra-lemma-glue-relative-pseudo-coherent}.
\end{proof}

\begin{definition}
\label{definition-pseudo-coherent}
A morphism of schemes $f : X \to S$ is called {\it pseudo-coherent} 
if the equivalent conditions of
Lemma \ref{lemma-pseudo-coherent}
are satisfied. In this case we also say that $X$ is pseudo-coherent
over $S$.
\end{definition}

\noindent
Beware that a base change of a pseudo-coherent morphism is not
pseudo-coherent in general.

\begin{lemma}
\label{lemma-flat-base-change-pseudo-coherent}
A flat base change of a pseudo-coherent morphism is pseudo-coherent.
\end{lemma}

\begin{proof}
This translates into the following algebra result:
Let $A \to B$ be a pseudo-coherent ring map.
Let $A \to A'$ be flat. Then $A' \to B \otimes_A A'$ is
pseudo-coherent. This follows from the more general
More on Algebra,
Lemma \ref{more-algebra-lemma-base-change-relative-pseudo-coherent}.
\end{proof}

\begin{lemma}
\label{lemma-composition-pseudo-coherent}
A composition of pseudo-coherent morphisms of schemes is
pseudo-coherent.
\end{lemma}

\begin{proof}
This translates into the following algebra result:
If $A \to B \to C$ are composable pseudo-coherent ring maps
then $A \to C$ is pseudo-coherent. This follows from either
More on Algebra,
Lemma \ref{more-algebra-lemma-pull-relative-pseudo-coherent}
or
More on Algebra,
Lemma \ref{more-algebra-lemma-composition-relative-pseudo-coherent}.
\end{proof}

\begin{lemma}
\label{lemma-permanence-pseudo-coherent}
Let $f : X \to Y$ be a morphism of schemes pseudo-coherent
over a base scheme $S$. Then $f$ is pseudo-coherent.
\end{lemma}

\begin{proof}
This translates into the following algebra result:
If $R \to A \to B$ are composable ring maps
and $R \to A$, $R \to B$ pseudo-coherent, then
$R \to B$ is pseudo-coherent. This follows from
More on Algebra,
Lemma \ref{more-algebra-lemma-composition-relative-pseudo-coherent}.
\end{proof}

\begin{lemma}
\label{lemma-Noetherian-pseudo-coherent}
Let $f : X \to S$ be a morphism of schemes.
If $S$ is locally Noetherian, then $f$ is pseudo-coherent if
and only if $f$ is locally of finite type.
\end{lemma}

\begin{proof}
This translates into the following algebra result:
If $R \to A$ is a finite type ring map with $R$ Noetherian, then
$R \to A$ is pseudo-coherent if and only if $R \to A$ is of finite type.
To see this, note that a pseudo-coherent ring map is of finite type by
definition. Conversely, if $R \to A$ is of finite type, then
we can write $A = R[x_1, \ldots, x_n]/I$ and it follows from
More on Algebra,
Lemma \ref{more-algebra-lemma-Noetherian-pseudo-coherent}
that $A$ is pseudo-coherent as an $R[x_1, \ldots, x_n]$-module, i.e.,
$R \to A$ is a pseudo-coherent ring map.
\end{proof}






\section{Perfect morphisms}
\label{section-perfect}

\noindent
In order to understand the material in this
section you have to understand the material of the section
on pseudo-coherent morphisms just a little bit.
For now the only thing you need to know is that a ring map
$A \to B$ is perfect if and only if it is pseudo-coherent
and $B$ has finite tor dimension as an $A$-module.

\begin{lemma}
\label{lemma-perfect}
Let $f : X \to S$ be a morphism of schemes which is locally of finite type.
The following are equivalent
\begin{enumerate}
\item there exist an affine open covering $S = \bigcup V_j$ and for each $j$
an affine open covering $f^{-1}(V_j) = \bigcup U_{ji}$ such that
$\mathcal{O}_S(V_j) \to \mathcal{O}_X(U_{ij})$ is a perfect
ring map, and
\item for every pair of affine opens $U \subset X$, $V \subset S$
such that $f(U) \subset V$ the ring map
$\mathcal{O}_S(V) \to \mathcal{O}_X(U)$ is perfect.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume (1) and let $U, V$ be as in (2).
It follows from
Lemma \ref{lemma-pseudo-coherent}
that $\mathcal{O}_S(V) \to \mathcal{O}_X(U)$ is pseudo-coherent.
Hence it suffices to prove that the property of a ring map
being "of finite tor dimension" satisfies
conditions (1)(a), (b), (c) of
Morphisms, Defintion \ref{morphisms-definition-property-local}.
These properties follow from
More on Algebra,
Lemmas \ref{more-algebra-lemma-flat-push-tor-amplitude},
\ref{more-algebra-lemma-flat-base-change-finite-tor-dimension}, and
\ref{more-algebra-lemma-glue-tor-amplitude}.
Some details omitted.
\end{proof}

\begin{definition}
\label{definition-perfect}
A morphism of schemes $f : X \to S$ is called {\it perfect} 
if the equivalent conditions of
Lemma \ref{lemma-pseudo-coherent}
are satisfied. In this case we also say that $X$ is pseudo-coherent
over $S$.
\end{definition}

\noindent
Beware that a base change of a perfect morphism is not
perfect in general.

\begin{lemma}
\label{lemma-flat-base-change-perfect}
A flat base change of a perfect morphism is perfect.
\end{lemma}

\begin{proof}
This translates into the following algebra result:
Let $A \to B$ be a perfect ring map.
Let $A \to A'$ be flat. Then $A' \to B \otimes_A A'$ is
perfect. This result for pseudo-coherent ring maps we have seen in
Lemma \ref{lemma-flat-base-change-pseudo-coherent}.
The corresponding fact for finite tor dimension follows from
More on Algebra,
Lemma \ref{more-algebra-lemma-flat-base-change-finite-tor-dimension}.
\end{proof}

\begin{lemma}
\label{lemma-composition-perfect}
A composition of perfect morphisms of schemes is perfect.
\end{lemma}

\begin{proof}
This translates into the following algebra result:
If $A \to B \to C$ are composable perfect ring maps
then $A \to C$ is perfect. We have seen this is the case for
pseudo-coherent in
Lemma \ref{lemma-composition-pseudo-coherent}
and its proof. By assumption there exist integers $n$, $m$ such
that $B$ has tor dimension $\leq n$ over $A$ and $C$ has tor dimension
$\leq m$ over $B$. Then for any $A$-module $M$ we have
$$
M \otimes_A^{\mathbf{L}} C =
(M \otimes_A^{\mathbf{L}} B) \otimes_B^{\mathbf{L}} C
$$
and the spectral sequence of
More on Algebra, Lemma \ref{more-algebra-example-tor}
shows that $\text{Tor}^A_p(M, C) = 0$ for $p > n + m$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-flat-finite-presentation-perfect}
A morphism which is flat and locally of finite presentation is perfect.
\end{lemma}

\begin{proof}
See
More on Algebra,
Lemma \ref{more-algebra-lemma-flat-finite-presentation-perfect}.
\end{proof}

\begin{lemma}
\label{lemma-regular-target-perfect}
Let $f : X \to S$ be a morphism of schemes.
Assume $S$ is regular and $f$ is locally of finite type.
Then $f$ is perfect.
\end{lemma}

\begin{proof}
See
More on Algebra, Lemma \ref{more-algebra-lemma-regular-perfect-ring-map}.
\end{proof}










\section{Openness of the flat locus}
\label{section-open-flat}

\noindent
This result takes some work to prove, and (perhaps)
deserves its own section. Here it is.

\begin{theorem}
\label{theorem-openess-flatness}
Let $S$ be a scheme.
Let $f : X \to S$ be a morphism which is locally of finite presentation.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module which is
locally of finite presentation. Then
$$
U = \{x \in X \mid \mathcal{F}\text{ is flat over }S\text{ at }x\}
$$
is open in $X$.
\end{theorem}

\begin{proof}
We may test for openness locally on $X$ hence we may assume
that $f$ is a morphism of affine schemes. In this case the
theorem is exactly
Algebra, Theorem \ref{algebra-theorem-openess-flatness}.
\end{proof}

\begin{lemma}
\label{lemma-flat-locus-base-change}
Let $S$ be a scheme.
Let
$$
\xymatrix{
X' \ar[r]_{g'} \ar[d]_{f'} & X \ar[d]^f \\
S' \ar[r]^g & S
}
$$
be a cartesian diagram of schemes.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
Let $x' \in X'$ with images
$x = g'(x')$ and $s' = g'(x')$.
\begin{enumerate}
\item If $\mathcal{F}$ is flat over $S$ at $x$, then
$(g')^*\mathcal{F}$ is flat over $S'$ at $x'$.
\item If $g$ is flat at $s'$ and $(g')^*\mathcal{F}$ is flat over $S'$ at
$x'$, then $\mathcal{F}$ is flat over $S$ at $x$.
\end{enumerate}
In particular, if $g$ is flat, $f$ is locally of finite presentation,
and $\mathcal{F}$ is locally of finite presentation,
then formation of the open subset of
Theorem \ref{theorem-openess-flatness}
commutes with base change.
\end{lemma}

\begin{proof}
Consider the commutative diagram of local rings
$$
\xymatrix{
\mathcal{O}_{X', x'} & \mathcal{O}_{X, x} \ar[l] \\
\mathcal{O}_{S', s'} \ar[u] & \mathcal{O}_{S, s} \ar[l] \ar[u]
}
$$
Note that $\mathcal{O}_{X', x'}$
is a localization of
$\mathcal{O}_{X, x} \otimes_{\mathcal{O}_{S, s}} \mathcal{O}_{S', s'}$,
and that $((g')^*\mathcal{F})_{x'}$ is equal to
$\mathcal{F}_x \otimes_{\mathcal{O}_{X, x}} \mathcal{O}_{X', x'}$.
Hence the lemma follows from
Algebra, Lemma \ref{algebra-lemma-base-change-flat-up-down}.
\end{proof}






\section{Crit\`ere de platitude par fibres}
\label{section-criterion-flat-fibres}

\noindent
Consider a commutative diagram of schemes (left hand diagram)
$$
\xymatrix{
X \ar[rr]_f \ar[dr] & & Y \ar[dl] \\
& S
}
\quad
\xymatrix{
X_s \ar[rr]_{f_s} \ar[rd] & & Y_s \ar[dl] \\
& \text{Spec}(\kappa(s))
}
$$
and a quasi-coherent $\mathcal{O}_X$-module $\mathcal{F}$.
Given a point $x \in X$ lying over $s \in S$ with image $y = f(x)$
we consider the question as to whether $\mathcal{F}$ is flat
over $Y$ at $x$. If $\mathcal{F}$ is flat over $S$ at $x$, then
the theorem states this question is intimately related to the
question of whether the restriction of $\mathcal{F}$ to the fibre
$$
\mathcal{F}_s = (X_s \to X)^*\mathcal{F}
$$
is flat over $Y_s$ at $x$. There are two versions, a Noetherian
version and a version on schemes which are locally of finite
presentation over the base.

\begin{theorem}
\label{theorem-criterion-flatness-fibre-Noetherian}
Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism of schemes over $S$.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
Let $x \in X$. Set $y = f(x)$ and $s \in S$ the image of $x$ in $S$.
Assume $S$, $X$, $Y$ locally Noetherian,
$\mathcal{F}$ coherent, and $\mathcal{F}_x \not = 0$.
Then the following are equivalent:
\begin{enumerate}
\item $\mathcal{F}$ is flat over $S$ at $x$, and
$\mathcal{F}_s$ is flat over $Y_s$ at $x$, and
\item $Y$ is flat over $S$ at $y$ and $\mathcal{F}$ is
flat over $Y$ at $x$.
\end{enumerate}
\end{theorem}

\begin{proof}
Consider the ring maps
$$
\mathcal{O}_{S, s} \longrightarrow
\mathcal{O}_{Y, y} \longrightarrow \mathcal{O}_{X, x}
$$
and the module $\mathcal{F}_x$. The stalk of $\mathcal{F}_s$ at $x$
is the module $\mathcal{F}_x/\mathfrak m_s \mathcal{F}_x$ and
the local ring of $Y_s$ at $y$ is
$\mathcal{O}_{Y, y}/\mathfrak m_s \mathcal{O}_{Y, y}$.
Thus the implication (1) $\Rightarrow$ (2) is
Algebra, Lemma \ref{algebra-lemma-criterion-flatness-fibre-Noetherian}.
If (2) holds, then the first ring map is faithfully flat
and $\mathcal{F}_x$ is flat over $\mathcal{O}_{Y, y}$ so by
Algebra, Lemma \ref{algebra-lemma-composition-flat}
we see that $\mathcal{F}_x$ is flat over $\mathcal{O}_{S, s}$.
Moreover, $\mathcal{F}_x/\mathfrak m_s \mathcal{F}_x$ is the
base change of the flat module $\mathcal{F}_x$ by
$\mathcal{O}_{Y, y} \to \mathcal{O}_{Y, y}/\mathfrak m_s \mathcal{O}_{Y, y}$,
hence flat by
Algebra, Lemma \ref{algebra-lemma-flat-base-change}.
\end{proof}

\noindent
Here is the non-Noetherian version.

\begin{theorem}
\label{theorem-criterion-flatness-fibre}
Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism of schemes over $S$.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
Assume
\begin{enumerate}
\item $X$ is locally of finite presentation over $S$,
\item $\mathcal{F}$ an $\mathcal{O}_X$-module of finite presentation, and
\item $Y$ is locally of finite type over $S$.
\end{enumerate}
Let $x \in X$. Set $y = f(x)$ and let $s \in S$ be the image of $x$ in $S$.
If $\mathcal{F}_x \not = 0$, then the following are equivalent:
\begin{enumerate}
\item $\mathcal{F}$ is flat over $S$ at $x$, and
$\mathcal{F}_s$ is flat over $Y_s$ at $x$, and
\item $Y$ is flat over $S$ at $y$ and $\mathcal{F}$ is
flat over $Y$ at $x$.
\end{enumerate}
Moreover, the set of points $x$ where (1) and (2) hold is open in
$\text{Supp}(\mathcal{F})$.
\end{theorem}

\begin{proof}
Consider the ring maps
$$
\mathcal{O}_{S, s} \longrightarrow
\mathcal{O}_{Y, y} \longrightarrow \mathcal{O}_{X, x}
$$
and the module $\mathcal{F}_x$. The stalk of $\mathcal{F}_s$ at $x$
is the module $\mathcal{F}_x/\mathfrak m_s \mathcal{F}_x$ and
the local ring of $Y_s$ at $y$ is
$\mathcal{O}_{Y, y}/\mathfrak m_s \mathcal{O}_{Y, y}$.
Thus the implication (1) $\Rightarrow$ (2) is
Algebra, Lemma \ref{algebra-lemma-criterion-flatness-fibre-fp-over-ft}.
If (2) holds, then the first ring map is faithfully flat
and $\mathcal{F}_x$ is flat over $\mathcal{O}_{Y, y}$ so by
Algebra, Lemma \ref{algebra-lemma-composition-flat}
we see that $\mathcal{F}_x$ is flat over $\mathcal{O}_{S, s}$.
Moreover, $\mathcal{F}_x/\mathfrak m_s \mathcal{F}_x$ is the
base change of the flat module $\mathcal{F}_x$ by
$\mathcal{O}_{Y, y} \to \mathcal{O}_{Y, y}/\mathfrak m_s \mathcal{O}_{Y, y}$,
hence flat by
Algebra, Lemma \ref{algebra-lemma-flat-base-change}.

\medskip\noindent
By
Morphisms, Lemma \ref{morphisms-lemma-finite-presentation-permanence}
the morphism $f$ is locally of finite presentation.
Consider the set
\begin{equation}
\label{equation-open}
U = \{x \in X \mid \mathcal{F} \text{ flat at }x
\text{ over both }Y\text{ and }S\}.
\end{equation}
This set is open in $X$ by
Theorem \ref{theorem-openess-flatness}.
Note that if $x \in U$, then $\mathcal{F}_s$ is flat at
$x$ over $Y_s$ as a base change of a flat module under the
morphism $Y_s \to Y$, see
Morphisms, Lemma \ref{morphisms-lemma-base-change-module-flat}.
Hence at every point of $U \cap \text{Supp}(\mathcal{F})$
condition (1) is satisfied. On the other hand, it is
clear that if $x \in \text{Supp}(\mathcal{F})$ satisfies
(1) and (2), then $x \in U$. Thus the open set we are
looking for is $U \cap \text{Supp}(\mathcal{F})$.
\end{proof}

\noindent
These theorems are often used in the following simplified forms.
We give only the global statements -- of course there are also pointwise
versions.

\begin{lemma}
\label{lemma-morphism-between-flat-Noetherian}
Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism of schemes over $S$.
Assume
\begin{enumerate}
\item $S$, $X$, $Y$ are locally Noetherian,
\item $X$ is flat over $S$,
\item for every $s \in S$ the morphism
$f_s : X_s \to Y_s$ is flat.
\end{enumerate}
Then $f$ is flat. If $f$ is also surjective, then $Y$ is flat over $S$.
\end{lemma}

\begin{proof}
This is a special case of
Theorem \ref{theorem-criterion-flatness-fibre-Noetherian}.
\end{proof}

\begin{lemma}
\label{lemma-morphism-between-flat}
Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism of schemes over $S$.
Assume
\begin{enumerate}
\item $X$ is locally of finite presentation over $S$,
\item $X$ is flat over $S$,
\item for every $s \in S$ the morphism
$f_s : X_s \to Y_s$ is flat, and
\item $Y$ is locally of finite type over $S$.
\end{enumerate}
Then $f$ is flat. If $f$ is also surjective, then $Y$ is flat over $S$.
\end{lemma}

\begin{proof}
This is a special case of
Theorem \ref{theorem-criterion-flatness-fibre}.
\end{proof}

\begin{lemma}
\label{lemma-base-change-criterion-flatness-fibre}
Let $S$ be a scheme. Let $f : X \to Y$ be a morphism of schemes over $S$.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
Assume
\begin{enumerate}
\item $X$ is locally of finite presentation over $S$,
\item $\mathcal{F}$ an $\mathcal{O}_X$-module of finite presentation,
\item $\mathcal{F}$ is flat over $S$, and
\item $Y$ is locally of finite type over $S$.
\end{enumerate}
Then the set
$$
U = \{x \in X \mid \mathcal{F} \text{ flat at }x \text{ over }Y\}.
$$
is open in $X$ and its formation commutes with arbitrary base change:
If $S' \to S$ is a morphism of schemes, and $U'$ is the set of points
of $X' = X \times_S S'$ where $\mathcal{F}' = \mathcal{F} \times_S S'$
is flat over $Y' = Y \times_S S'$, then $U' = U \times_S S'$.
\end{lemma}

\begin{proof}
By
Morphisms, Lemma \ref{morphisms-lemma-finite-presentation-permanence}
the morphism $f$ is locally of finite presentation.
Hence $U$ is open by
Theorem \ref{theorem-openess-flatness}.
Because we have assumed that $\mathcal{F}$ is flat over $S$ we see that
Theorem \ref{theorem-criterion-flatness-fibre}
implies
$$
U = \{x \in X \mid \mathcal{F}_s \text{ flat at }x \text{ over }Y_s\}.
$$
where $s$ always denotes the image of $x$ in $S$. (This description also
works trivially when $\mathcal{F}_x = 0$.) Moreover, the assumptions
of the lemma remain in force for the morphism $f' : X' \to Y'$
and the sheaf $\mathcal{F}'$. Hence $U'$ has a similar description.
In other words, it suffices to prove that given
$s' \in S'$ mapping to $s \in S$ we have
$$
\{x' \in X'_{s'} \mid
\mathcal{F}'_{s'} \text{ flat at }x' \text{ over }Y'_{s'}\}
$$
is the inverse image of the corresponding locus in $X_s$.
This is true by
Lemma \ref{lemma-flat-locus-base-change}
because in the cartesian diagram
$$
\xymatrix{
X'_{s'} \ar[d] \ar[r] & X_s \ar[d] \\
Y'_{s'} \ar[r] & Y_s
}
$$
the horizontal morphisms are flat as they are base changes by the flat
morphism $\text{Spec}(\kappa(s')) \to \text{Spec}(\kappa(s))$.
\end{proof}

\begin{lemma}
\label{lemma-base-change-flatness-fibres}
Let $S$ be a scheme. Let $f : X \to Y$ be a morphism of schemes over $S$.
Assume
\begin{enumerate}
\item $X$ is locally of finite presentation over $S$,
\item $X$ is flat over $S$, and
\item $Y$ is locally of finite type over $S$.
\end{enumerate}
Then the set
$$
U = \{x \in X \mid X\text{ flat at }x \text{ over }Y\}.
$$
is open in $X$ and its formation commutes with arbitrary base change.
\end{lemma}

\begin{proof}
This is a special case of
Lemma \ref{lemma-base-change-criterion-flatness-fibre}.
\end{proof}






\section{Normal morphisms}
\label{section-normal}

\noindent
In the article \cite{DM} of Deligne and Mumford the notion of a normal
morphism is mentioned. This is just one in a series of types\footnote{
The other types are coprof $\leq k$, Cohen-Macaulay, $(S_k)$,
regular, $(R_k)$, and reduced. See \cite[IV Definition 6.8.1.]{EGA}.}
of morphisms that can all be defined similarly. Over time we will add
these in their own sections as needed.

\begin{definition}
\label{definition-normal}
Let $f : X \to Y$ be a morphism of schemes.
Assume that all the fibres $X_y$ are locally Noetherian schemes.
\begin{enumerate}
\item Let $x \in X$, and $y = f(x)$. We say that $f$ is {\it normal at $x$}
if $f$ is flat at $x$, and the scheme $X_y$ is geometrically
normal at $x$ over $\kappa(y)$ (see
Varieties, Definition \ref{varieties-definition-geometrically-normal}).
\item We say $f$ is a {\it normal morphism} if $f$ is normal
at every point of $X$.
\end{enumerate}
\end{definition}

\noindent
So the condition that the morphism $X \to Y$ is normal
is stronger than just requiring all
the fibres to be normal locally Noetherian schemes.

\begin{lemma}
\label{lemma-normal}
Let $f : X \to Y$ be a morphism of schemes.
Assume all fibres of $f$ are locally Noetherian.
The following are equivalent
\begin{enumerate}
\item $f$ is normal, and
\item $f$ is flat and its fibres are geometrically normal schemes.
\end{enumerate}
\end{lemma}

\begin{proof}
This follows directly from the definitions.
\end{proof}

\begin{lemma}
\label{lemma-smooth-normal}
A smooth morphism is normal.
\end{lemma}

\begin{proof}
Let $f : X \to Y$ be a smooth morphism.
As $f$ is locally of finite presentation, see
Morphisms, Lemma \ref{morphisms-lemma-smooth-locally-finite-presentation}
the fibres $X_y$ are locally of finite type over a field, hence
locally Noetherian. Moreover, $f$ is flat, see
Morphisms, Lemma \ref{morphisms-lemma-smooth-flat}.
Finally, the fibres $X_y$ are smooth over a field (by
Morphisms, Lemma \ref{morphisms-lemma-base-change-smooth})
and hence geometrically normal by
Varieties, Lemma \ref{varieties-lemma-smooth-geometrically-normal}.
Thus $f$ is normal by
Lemma \ref{lemma-normal}.
\end{proof}

\noindent
We want to show that this notion is local on the source and target
for the smooth topology. First we deal with the property of having
locally Noetherian fibres.

\begin{lemma}
\label{lemma-locally-Noetherian-fibres-fppf-local-source-and-target}
The property $\mathcal{P}(f)=$``the fibres of $f$ are locally Noetherian''
is local in the fppf topology on the source and the target.
\end{lemma}

\begin{proof}
Let $f : X \to Y$ be a morphism of schemes.
Let $\{\varphi_i : Y_i \to Y\}_{i \in I}$ be an fppf covering of $Y$.
Denote $f_i : X_i \to Y_i$ the base change of $f$ by $\varphi_i$.
Let $i \in I$ and let $y_i \in Y_i$ be a point.
Set $y = \varphi_i(y_i)$. Note that
$$
X_{i, y_i} = \text{Spec}(\kappa(y_i)) \times_{\text{Spec}(\kappa(y))} X_y.
$$
Moreover, as $\varphi_i$ is of finite presentation the field extension
$\kappa(y) \subset \kappa(y_i)$ is finitely generated.
Hence in this situation we have that $X_y$ is locally Noetherian if and
only if $X_{i, y_i}$ is locally Noetherian, see
Varieties, Lemma \ref{varieties-lemma-locally-Noetherian-base-change}.
This fact implies locality on the target.

\medskip\noindent
Let $\{X_i \to X\}$ be an fppf covering of $X$.
Let $y \in Y$. In this case $\{X_{i, y} \to X_y\}$ is an
fppf covering of the fibre. Hence the locality on the source
follows from Descent, Lemma \ref{descent-lemma-Noetherian-local-fppf}.
\end{proof}

\begin{lemma}
\label{lemma-normal-fppf-local-source-and-target}
The property
$\mathcal{P}(f)=$``the fibres of $f$ are locally Noetherian and $f$ is normal''
is local in the fppf topology on the target and
local in the smooth topology on the source.
\end{lemma}

\begin{proof}
We have
$\mathcal{P}(f) =
\mathcal{P}_1(f) \wedge \mathcal{P}_2(f) \wedge \mathcal{P}_3(f)$
where
$\mathcal{P}_1(f)=$``the fibres of $f$ are locally Noetherian'',
$\mathcal{P}_2(f)=$``$f$ is flat'', and
$\mathcal{P}_3(f)=$``the fibres of $f$ are geometrically normal''.
We have already seen that $\mathcal{P}_1$ and $\mathcal{P}_2$
are local in the fppf topology on the source and the target, see
Lemma \ref{lemma-locally-Noetherian-fibres-fppf-local-source-and-target},
and Descent, Lemmas \ref{descent-lemma-descending-property-flat} and
\ref{descent-lemma-flat-fpqc-local-source}. Thus we have to deal
with $\mathcal{P}_3$.

\medskip\noindent
Let $f : X \to Y$ be a morphism of schemes.
Let $\{\varphi_i : Y_i \to Y\}_{i \in I}$ be an fpqc covering of $Y$.
Denote $f_i : X_i \to Y_i$ the base change of $f$ by $\varphi_i$.
Let $i \in I$ and let $y_i \in Y_i$ be a point.
Set $y = \varphi_i(y_i)$. Note that
$$
X_{i, y_i} = \text{Spec}(\kappa(y_i)) \times_{\text{Spec}(\kappa(y))} X_y.
$$
Hence in this situation we have that $X_y$ is geometrically normal if and
only if $X_{i, y_i}$ is geometrically normal, see
Varieties, Lemma \ref{varieties-lemma-geometrically-normal-upstairs}.
This fact implies $\mathcal{P}_3$ is fpqc local on the target.

\medskip\noindent
Let $\{X_i \to X\}$ be a smooth covering of $X$.
Let $y \in Y$. In this case $\{X_{i, y} \to X_y\}$ is a
smooth covering of the fibre. Hence the locality of $\mathcal{P}_3$
for the smooth topology on the source follows from
Descent, Lemma \ref{descent-lemma-normal-local-smooth}.
Combining the above the lemma follows.
\end{proof}









\section{Cohen-Macaulay morphisms}
\label{section-CM}

\noindent
See Section \ref{section-normal} for a discussion.
Note that, as pointed out in
Algebra, Section \ref{algebra-section-geometrically-CM}
and
Varieties, Section \ref{varieties-section-CM}
``geometrically Cohen-Macaulay'' is the same as plain Cohen-Macaulay.

\begin{definition}
\label{definition-CM}
Let $f : X \to Y$ be a morphism of schemes.
Assume that all the fibres $X_y$ are locally Noetherian schemes.
\begin{enumerate}
\item Let $x \in X$, and $y = f(x)$. We say that $f$ is
{\it Cohen-Macaulay at $x$} if $f$ is flat at $x$, and the
local ring of the scheme $X_y$ at $x$ is Cohen-Macaulay.
\item We say $f$ is a {\it Cohen-Macaulay morphism} if $f$ is
Cohen-Macaulay at every point of $X$.
\end{enumerate}
\end{definition}

\noindent
Here is a translation.

\begin{lemma}
\label{lemma-CM}
Let $f : X \to Y$ be a morphism of schemes.
Assume all fibres of $f$ are locally Noetherian.
The following are equivalent
\begin{enumerate}
\item $f$ is Cohen-Macaulay, and
\item $f$ is flat and its fibres are Cohen-Macaulay schemes.
\end{enumerate}
\end{lemma}

\begin{proof}
This follows directly from the definitions.
\end{proof}

\begin{lemma}
\label{lemma-base-change-CM}
Let $f : X \to Y$ be a morphism of schemes.
Assume that all the fibres $X_y$ are locally Noetherian schemes.
Let $Y' \to Y$ be locally of finite type. Let $f' : X' = X_{Y'} \to Y$
be the base change of $f$.
Let $x' \in X'$ be a point with image $x \in X$.
\begin{enumerate}
\item If $f$ is Cohen-Macaulay at $x$, then the base change
$f' : X' \to Y'$ is Cohen-Macaulay at $x'$.
\item If $Y' \to Y$ is flat at $f'(x')$ and $f'$ is Cohen-Macaulay at
$x'$, then $f$ is Cohen-Macaulay at $x$.
\end{enumerate}
\end{lemma}

\begin{proof}
Note that the assumption on $Y' \to Y$ means that for $y' \in Y'$
mapping to $y \in Y$ the field extension $\kappa(y) \subset \kappa(y')$
is finitely generated. Hence also all the fibres
$X'_{y'} = (X_y)_{\kappa(y')}$ are locally Noetherian, see
Varieties, Lemma \ref{varieties-lemma-locally-Noetherian-base-change}.
Thus the lemma makes sense. Set $y' = f'(x')$ and $y = f(x)$.
Hence we get the following commutative diagram of local rings
$$
\xymatrix{
\mathcal{O}_{X', x'} & \mathcal{O}_{X, x} \ar[l] \\
\mathcal{O}_{Y', y'} \ar[u] & \mathcal{O}_{Y, y} \ar[l] \ar[u]
}
$$
where the upper left corner is a localization of the tensor product
of the upper right and lower left corners over the lower right corner.

\medskip\noindent
Assume $f$ is Cohen-Macaulay at $x$.
The flatness of $\mathcal{O}_{Y, y} \to \mathcal{O}_{X, x}$
implies the flatness of $\mathcal{O}_{Y', y'} \to \mathcal{O}_{X', x'}$, see
Algebra, Lemma \ref{algebra-lemma-base-change-flat-up-down}.
The fact that $\mathcal{O}_{X, x}/\mathfrak m_y\mathcal{O}_{X, x}$
is Cohen-Macaulay implies that
$\mathcal{O}_{X', x'}/\mathfrak m_{y'}\mathcal{O}_{X', x'}$, see
Varieties, Lemma \ref{varieties-lemma-CM-base-change}. Hence we see that $f'$
is Cohen-Macaulay at $x'$.

\medskip\noindent
Assume $Y' \to Y$ is flat at $y'$ and $f'$ is Cohen-Macaulay at
$x'$. The flatness of $\mathcal{O}_{Y', y'} \to \mathcal{O}_{X', x'}$
and $\mathcal{O}_{Y, y} \to \mathcal{O}_{Y', y'}$ implies the flatness
of $\mathcal{O}_{Y, y} \to \mathcal{O}_{X, x}$, see
Algebra, Lemma \ref{algebra-lemma-base-change-flat-up-down}.
The fact that $\mathcal{O}_{X', x'}/\mathfrak m_{y'}\mathcal{O}_{X', x'}$
is Cohen-Macaulay implies that
$\mathcal{O}_{X, x}/\mathfrak m_y\mathcal{O}_{X, x}$, see
Varieties, Lemma \ref{varieties-lemma-CM-base-change}. Hence we see that $f$
is Cohen-Macaulay at $x$.
\end{proof}

\begin{lemma}
\label{lemma-flat-finite-presentation-CM-open}
Let $f : X \to S$ be a flat morphism of finite presentation.
Let
$$
W = \{x \in X \mid f\text{ is Cohen-Macaulay at }x\}
$$
Then
\begin{enumerate}
\item we have
$$
W = \{x \in X \mid \mathcal{O}_{X_{f(x)}, x}\text{ is Cohen-Macaulay}\},
$$
\item $W$ is open in $X$,
\item $W$ dense in every fibre of $X \to S$,
\item the formation of W commutes with arbitrary base change of $f$:
For any morphism $g : S' \to S$, consider
the base change $f' : X' \to S'$ of $f$ and the
projection $g' : X' \to X$. Then the corresponding
set $W'$ for the morphism $f'$ is equal to $W' = (g')^{-1}(W)$.
\end{enumerate}
\end{lemma}

\begin{proof}
As $f$ is flat with locally Noetherian fibres the equality in (1) holds
by definition. Parts (2) and (3) follow from
Algebra, Lemma \ref{algebra-lemma-generic-CM-flat-finite-presentation}.
Part (4) follows either from
Algebra, Lemma \ref{algebra-lemma-CM-locus-commutes-base-change}
or
Varieties, Lemma \ref{varieties-lemma-CM-base-change}.
\end{proof}

\begin{lemma}
\label{lemma-flat-finite-presentation-pieces-given-relative-dimension}
Let $f : X \to S$ be a flat morphism of finite presentation.
For $d \geq 0$ there exist opens $U_d \subset X$ with the following
properties
\begin{enumerate}
\item $W = \bigcup_{d \geq 0} U_d$ is dense in every fibre of $f$, and
\item $U_d \to S$ is of relative dimension $d$ (see
Morphisms, Definition \ref{morphisms-definition-relative-dimension-d}).
\end{enumerate}
\end{lemma}

\begin{proof}
This follows by combining
Lemma \ref{lemma-flat-finite-presentation-CM-open}
with
Morphisms, Lemma
\ref{morphisms-lemma-flat-finite-presentation-CM-fibres-relative-dimension}.
\end{proof}

\begin{lemma}
\label{lemma-flat-finite-presentation-specialization-dimension}
Let $f : X \to S$ be a flat morphism of finite presentation.
Suppose $x' \leadsto x$ is a specialization of points of $X$
with image $s' \leadsto s$ in $S$. If $x$ is a generic point of an
irreducible component of $X_s$ then $\dim_{x'}(X_{s'}) = \dim_x(X_s)$.
\end{lemma}

\begin{proof}
The point $x$ is contained in $U_d$ for some $d$, where $U_d$ as in
Lemma \ref{lemma-flat-finite-presentation-pieces-given-relative-dimension}.
\end{proof}

\begin{lemma}
\label{lemma-CM-local-source-and-target}
The property
$\mathcal{P}(f)=$``the fibres of $f$ are locally Noetherian and $f$ is
Cohen-Macaulay'' is local in the fppf topology on the target and
local in the syntomic topology on the source.
\end{lemma}

\begin{proof}
We have
$\mathcal{P}(f) =
\mathcal{P}_1(f) \wedge \mathcal{P}_2(f)$
where
$\mathcal{P}_1(f)=$``$f$ is flat'', and
$\mathcal{P}_2(f)=$``the fibres of $f$ are locally Noetherian
and Cohen-Macaulay''.
We know that $\mathcal{P}_1$ is
local in the fppf topology on the source and the target, see
Descent, Lemmas \ref{descent-lemma-descending-property-flat} and
\ref{descent-lemma-flat-fpqc-local-source}. Thus we have to deal
with $\mathcal{P}_2$.

\medskip\noindent
Let $f : X \to Y$ be a morphism of schemes.
Let $\{\varphi_i : Y_i \to Y\}_{i \in I}$ be an fppf covering of $Y$.
Denote $f_i : X_i \to Y_i$ the base change of $f$ by $\varphi_i$.
Let $i \in I$ and let $y_i \in Y_i$ be a point.
Set $y = \varphi_i(y_i)$. Note that
$$
X_{i, y_i} = \text{Spec}(\kappa(y_i)) \times_{\text{Spec}(\kappa(y))} X_y.
$$
and that $\kappa(y) \subset \kappa(y_i)$ is a finitely generated field
extension. Hence if $X_y$ is locally Noetherian, then
$X_{i, y_i}$ is locally Noetherian, see
Varieties, Lemma \ref{varieties-lemma-locally-Noetherian-base-change}.
And if in addition $X_y$ is Cohen-Macaulay,
then $X_{i, y_i}$ is Cohen-Macaulay, see
Varieties, Lemma \ref{varieties-lemma-CM-base-change}.
Thus $\mathcal{P}_2$ is fppf local on the target.

\medskip\noindent
Let $\{X_i \to X\}$ be a syntomic covering of $X$.
Let $y \in Y$. In this case $\{X_{i, y} \to X_y\}$ is a
syntomic covering of the fibre. Hence the locality of $\mathcal{P}_2$
for the syntomic topology on the source follows from
Descent, Lemma \ref{descent-lemma-CM-local-syntomic}.
Combining the above the lemma follows.
\end{proof}






\section{Slicing Cohen-Macaulay morphisms}
\label{section-slicing-CM}

\noindent
The results in this section eventually lead to the assertion that
the fppf topology is the same as the
``finitely presented, flat, quasi-finite'' topology.

\begin{lemma}
\label{lemma-slice-given-element}
Let $f : X \to S$ be a morphism of schemes.
Let $x \in X$ be a point with image $s \in S$.
Let $h \in \mathfrak m_x \subset \mathcal{O}_{X, x}$.
Assume
\begin{enumerate}
\item $f$ is locally of finite presentation,
\item $f$ is flat at $x$, and
\item the image $\overline{h}$ of $h$ in
$\mathcal{O}_{X_s, x} = \mathcal{O}_{X, x}/\mathfrak m_s\mathcal{O}_{X, x}$
is a nonzero divisor.
\end{enumerate}
Then there exists an affine open neighbourhood $U \subset X$ of $x$
such that $h$ comes from $h \in \Gamma(U, \mathcal{O}_U)$ and such
that $D = V(h)$ is an effective Cartier divisor in $U$ with $x \in D$ and
$D \to S$ flat and of finite presentation.
\end{lemma}

\begin{proof}
We are going to prove this by reducing to the Noetherian case.
By openness of flatness (see
Theorem \ref{theorem-openess-flatness})
we may assume, after replacing $X$ by an
open neighbourhood of $x$, that $X \to S$ is flat.
We may also assume that $X$ and $S$ are affine.
After possible shrinking $X$ a bit we may assume that there exists
an $h \in \Gamma(X, \mathcal{O}_X)$ which maps to our given $h$.

\medskip\noindent
We may write $S = \text{Spec}(A)$ and we may write $A = \text{colim}_i\ A_i$
as a directed colimit of finite type $\mathbf{Z}$ algebras.
Then by
Algebra, Lemma \ref{algebra-lemma-flat-finite-presentation-limit-flat}
or
Limits, Lemmas \ref{limits-lemma-descend-finite-presentation},
\ref{limits-lemma-descend-affine-finite-presentation}, and
\ref{limits-lemma-descend-finite-presentation}
we can find a cartesian diagram
$$
\xymatrix{
X \ar[r] \ar[d]_f & X_0 \ar[d]^{f_0} \\
S \ar[r] & S_0
}
$$
with $f_0$ flat and of finite presentation, $X_0$ affine, and
$S_0$ affine and Noetherian. Let $x_0 \in X_0$, resp.\ $s_0 \in S_0$
be the image of $x$, resp.\ $s$. We may also assume there exists an element
$h_0 \in \Gamma(X_0, \mathcal{O}_{X_0})$ which restricts to $h$ on $X$.
(If you used the algebra reference above then this is clear; if you used
the references to the chapter on limits then this follows from
Lemma \ref{limits-lemma-descend-finite-presentation}
by thinking of $h$ as a morphism $X \to \mathbf{A}^1_S$.)
Note that $\mathcal{O}_{X_s, x}$ is a localization of
$\mathcal{O}_{(X_0)_{s_0}, x_0} \otimes_{\kappa(s_0)} \kappa(s)$, so that
$\mathcal{O}_{(X_0)_{s_0}, x_0} \to \mathcal{O}_{X_s, x}$ is a flat
local ring map, in particular faithfully flat. Hence the image
$\overline{h}_0 \in \mathcal{O}_{(X_0)_{s_0}, x_0}$
is contained in $\mathfrak m_{(X_0)_{s_0}, x_0}$ and is a nonzero divisor.
We claim that after replacing $X_0$ by a principal open neighbourhood of
$x_0$ the element $h_0$ is a nonzero divisor in
$B_0 = \Gamma(X_0, \mathcal{O}_{X_0})$ such that $B_0/h_0B_0$ is flat
over $A_0 = \Gamma(S_0, \mathcal{O}_{S_0})$.
If so then
$$
0 \to B_0 \xrightarrow{h_0} B_0 \to B_0/h_0B_0 \to 0
$$
is a short exact sequence of flat $A_0$-modules. Hence this remains exact
on tensoring with $A$ (by
Algebra, Lemma \ref{algebra-lemma-flat-tor-zero})
and the lemma follows.

\medskip\noindent
It remains to prove the claim above. The corresponding algebra statement
is the following (we drop the subscript ${}_0$ here):
Let $A \to B$ be a flat, finite type ring map of Noetherian rings.
Let $\mathfrak q \subset B$ be a prime lying over $\mathfrak p \subset A$.
Assume $h \in \mathfrak q$ maps to a nonzero divisor in
$B_{\mathfrak q}/\mathfrak p B_{\mathfrak q}$.
Goal: show that after possible replacing $B$ by $B_g$ for some
$g \in B$, $g \not \in \mathfrak q$ the element $h$ becomes a nonzero divisor
and $B/hB$ becomes flat over $A$. By
Algebra, Lemma \ref{algebra-lemma-grothendieck}
we see that $h$ is a nonzero divisor in $B_{\mathfrak q}$ and that
$B_{\mathfrak q}/hB_{\mathfrak q}$ is flat over $A$.
By openess of flatness, see
Algebra, Theorem \ref{algebra-theorem-openess-flatness}
or
Theorem \ref{theorem-openess-flatness}
we see that $B/hB$ is flat over $A$ after replacing $B$ by $B_g$ for some
$g \in B$, $g \not \in \mathfrak q$. Finally, let
$I = \{b \in B \mid hb = 0\}$ be the annihilator of $h$. Then
$IB_{\mathfrak q} = 0$ as $h$ is a nonzero divisor in $B_{\mathfrak q}$.
Also $I$ is finitely generated as $B$ is Noetherian.
Hence there exists a $g \in B$, $g \not \in \mathfrak q$ such that $IB_g = 0$.
After replacing $B$ by $B_g$ we see that $h$ is a nonzero divisor.
\end{proof}

\begin{lemma}
\label{lemma-slice-once}
Let $f : X \to S$ be a morphism of schemes.
Let $x \in X$ be a point with image $s \in S$.
Assume
\begin{enumerate}
\item $f$ is locally of finite presentation,
\item $f$ is flat at $x$, and
\item $\mathcal{O}_{X_s, x}$ has $\text{depth} \geq 1$.
\end{enumerate}
Then there exists an affine open neighbourhood $U \subset X$ of $x$
and an effective Cartier divisor $D \subset U$ containing $x$ such that
$D \to S$ is flat and of finite presentation.
\end{lemma}

\begin{proof}
Pick any $h \in \mathfrak m_x \subset \mathcal{O}_{X, x}$ which
maps to a nonzero divisor in $\mathcal{O}_{X_s, x}$ and apply
Lemma \ref{lemma-slice-given-element}.
\end{proof}

\noindent
The subscheme $Z$ constructed in the following lemma is really a complete
intersection in an affine open neighbourhood of $x$. If we ever need this
we will explicitly formulate a separate lemma stating this fact.

\begin{lemma}
\label{lemma-slice-CM}
Let $f : X \to S$ be a morphism of schemes.
Let $x \in X$ be a point with image $s \in S$.
Assume
\begin{enumerate}
\item $f$ is locally of finite presentation,
\item $f$ is Cohen-Macaulay at $x$, and
\item $x$ is a closed point of $X_s$.
\end{enumerate}
Then there exists an immersion $Z \to X$ containing $x$ such that
\begin{enumerate}
\item $Z \to S$ is flat and of finite presentation,
\item $Z \to S$ is locally quasi-finite, and
\item $Z_s = \{x\}$ set theoretically.
\end{enumerate}
\end{lemma}

\begin{proof}
We may and do replace $S$ by an affine open neighbourhoof of $s$.
We will prove the lemma for affine $S$ by induction on $d = \dim_x(X_s)$.

\medskip\noindent
The case $d = 0$. In this case we show that we may take $Z$ to be
an open neighbourhood of $x$. Namely, if $d = 0$, then $X \to S$
is quasi-finite at $x$, see
Morphisms, Lemma \ref{morphisms-lemma-locally-quasi-finite-rel-dimension-0}.
Hence there exists an affine open neighbourhood $U \subset X$ such
that $U \to S$ is quasi-finite, see
Morphisms, Lemma \ref{morphisms-lemma-quasi-finite-points-open}.
Thus after replacing $X$ by $U$ we see that the fibre $X_s$ is a finite
discrete set. Hence after replacing $X$ by a further affine open neigbourhood
of $X$ we see that that $f^{-1}(\{s\}) = \{x\}$ (because the topology
on $X_s$ is induced from the topology on $X$, see
Schemes, Lemma \ref{schemes-lemma-fibre-topological}).
This proves the lemma in this case.

\medskip\noindent
Next, assume $d > 0$. Note that because $x$ is a closed point of its
fibre the extension $\kappa(s) \subset \kappa(x)$ is finite (by the
Hilbert Nullstellensatz, see
Morphisms, Lemma \ref{morphisms-lemma-closed-point-fibre-locally-finite-type}).
Thus we see
$$
\text{depth}(\mathcal{O}_{X_s, x}) = \dim(\mathcal{O}_{X_s, x}) = d > 0
$$
the first equality as $\mathcal{O}_{X_s, x}$ is Cohen-Macaulay and
the second by
Morphisms, Lemma \ref{morphisms-lemma-dimension-fibre-at-a-point}.
Thus we may apply
Lemma \ref{lemma-slice-once}
to find a diagram
$$
\xymatrix{
D \ar[r] \ar[rrd] & U \ar[r] \ar[rd] & X \ar[d] \\
& & S
}
$$
with $x \in D$. Note that
$\mathcal{O}_{D_s, x} = \mathcal{O}_{X_s, x}/(\overline{h})$ for some
nonzero divisor $\overline{h}$, see
Divisors, Lemma \ref{divisors-lemma-relative-Cartier}.
Hence $\mathcal{O}_{D_s, x}$ is Cohen-Macaulay of dimension
one less than the dimension of $\mathcal{O}_{X_s, x}$, see
Algebra, Lemma \ref{algebra-lemma-reformulate-CM}
for example. Thus the morphism $D \to S$ is flat,
locally of finite presentation, and Cohen-Macaulay at $x$ with
$\dim_x(D_s) = \dim_x(X_s) - 1 = d - 1$. By induction hypothesis
we can find an immersion $Z \to D$ as desired, which finishes the proof.
\end{proof}

\begin{lemma}
\label{lemma-qf-fp-flat-neighbourhood-dominates-fppf}
Let $f : X \to S$ be a flat morphism of schemes which is
locally of finite presentation Let $s \in S$ be a point in the image of $f$.
Then there exists a commutative diagram
$$
\xymatrix{
S' \ar[rr] \ar[rd]_g & & X \ar[ld]^f \\
& S
}
$$
where $g : S' \to S$ is flat, locally of finite presentation,
locally quasi-finite, and $s \in g(S')$.
\end{lemma}

\begin{proof}
The fibre $X_s$ is not empty by assumption. Hence there exists a closed
point $x \in X_s$ where $f$ is Cohen-Macaulay, see
Lemma \ref{lemma-flat-finite-presentation-CM-open}.
Apply
Lemma \ref{lemma-slice-CM}
and set $S' = S$.
\end{proof}

\noindent
The following lemma shows that sheaves for the fppf topology are
the same thing as sheaves for the
``quasi-finite, flat, finite presentation'' toplogy.

\begin{lemma}
\label{lemma-qf-fp-flat-dominates-fppf}
Let $S$ be a scheme. Let $\mathcal{U} = \{S_i \to S\}_{i \in I}$ be an fppf
covering of $S$, see
Topologies, Definition \ref{topologies-definition-smooth-covering}.
Then there exists an fppf covering $\mathcal{V} = \{T_j \to S\}_{j \in J}$
which refines (see
Sites, Definition \ref{sites-definition-morphism-coverings})
$\mathcal{U}$ such that each $T_j \to S$ is locally quasi-finite.
\end{lemma}

\begin{proof}
For every $s \in S$ there exists an $i \in I$ such that $s$ is in
the image of $S_i \to S$. By
Lemma \ref{lemma-qf-fp-flat-neighbourhood-dominates-fppf}
we can find a morphism $g_s : T_s \to S$ such that $s \in g_s(T)_s$
which is flat, locally of finite presentation and locally quasi finite
and such that $g_s$ factors through $S_i \to S$. Hence
$\{T_s \to S\}$ is the desired covering of $S$ that refines $\mathcal{U}$.
\end{proof}



\section{Generic fibres}
\label{section-generic}

\noindent
Some results on the relationship between generic fibres and
nearby fibres.

\begin{lemma}
\label{lemma-empty-generic-fibre}
Let $f : X \to Y$ be a finite type morphism of schemes. Assume
$Y$ irreducible with generic point $\eta$. If $X_\eta = \emptyset$
then there exists a nonempty open $V \subset Y$ such that
$X_V = V \times_Y X = \emptyset$.
\end{lemma}

\begin{proof}
Follows immediately from the more general
Morphisms,
Lemma \ref{morphisms-lemma-quasi-compact-generic-point-not-in-image}.
\end{proof}

\begin{lemma}
\label{lemma-nonempty-generic-fibre}
Let $f : X \to Y$ be a finite type morphism of schemes. Assume
$Y$ irreducible with generic point $\eta$. If $X_\eta \not = \emptyset$
then there exists a nonempty open $V \subset Y$ such that
$X_V = V \times_Y X \to V$ is surjective.
\end{lemma}

\begin{proof}
This follows, upon taking affine opens, from
Algebra, Lemma \ref{algebra-lemma-characterize-image-finite-type}.
(Of course it also follows from generic flatness.)
\end{proof}

\begin{lemma}
\label{lemma-nowhere-dense-generic-fibre}
Let $f : X \to Y$ be a finite type morphism of schemes. Assume
$Y$ irreducible with generic point $\eta$.
If $Z \subset X$ is a closed subset with $Z_\eta$ nowhere dense
in $X_\eta$, then there exists a nonempty open $V \subset Y$ such
that $Z_y$ is nowhere dense in $X_y$ for all $y \in V$.
\end{lemma}

\begin{proof}
Let $Y' \subset Y$ be the reduction of $Y$.
Set $X' = Y' \times_Y X$ and $Z' = Y' \times_Y Z$.
As $Y' \to Y$ is a universal homeomorphism by
Morphisms, Lemma \ref{morphisms-lemma-reduction-universal-homeomorphism}
we see that it suffices to prove the lemma for $Z' \subset X' \to Y'$.
Thus we may assume that $Y$ is integral, see
Properties, Lemma \ref{properties-lemma-characterize-integral}.
By
Morphisms, Proposition \ref{morphisms-proposition-generic-flatness}
there exists a nonempty affine open $V \subset Y$ such that
$X_V \to V$ and $Z_V \to Z$ are flat and of finite presentation.
We claim that $V$ works.
Pick $y \in V$. If $Z_y$ has a nonempty interior, then $Z_y$ contains
a generic point $\xi$ of an irreducible component of $X_y$.
Note that $\eta \leadsto f(\xi)$. Since $Z_V \to V$ is flat we can
choose a specialization $\xi' \leadsto \xi$, $\xi' \in Z$ 
with $f(\xi') = \eta$, see
Morphisms, Lemma \ref{morphisms-lemma-generalizations-lift-flat}.
By
Lemma \ref{lemma-flat-finite-presentation-specialization-dimension}
we see that
$$
\dim_{\xi'}(Z_\eta) = \dim_{\xi}(Z_y) = \dim_{\xi}(X_y) = \dim_{\xi'}(X_\eta).
$$
Hence some irreducible component of $Z_\eta$ passing through $\xi'$ has
dimension $\dim_{\xi'}(X_\eta)$ which contradicts the assumption that
$Z_\eta$ is nowhere dense in $X_\eta$ and we win.
\end{proof}

\begin{lemma}
\label{lemma-scheme-theoretically-dense-generic-fibre}
Let $f : X \to Y$ be a finite type morphism of schemes.
Assume $Y$ irreducible with generic point $\eta$.
Let $U \subset X$ be an open subscheme such that $U_\eta$ is
scheme theoretically dense in $X_\eta$.
Then there exists a nonempty open $V \subset Y$ such
that $U_y$ is scheme theoretically dense in $X_y$ for all $y \in V$.
\end{lemma}

\begin{proof}
Let $Y' \subset Y$ be the reduction of $Y$.
Let $X' = Y' \times_Y X$ and $U' = Y' \times_Y U$.
As $Y' \to Y$ induces a bijection on points, and as
$U' \to U$ and $X' \to X$ induce isomorphisms of scheme theoretic fibres,
we may replace $Y$ by $Y'$ and $X$ by $X'$.
Thus we may assume that $Y$ is integral, see
Properties, Lemma \ref{properties-lemma-characterize-integral}.
We may also replace $Y$ by a nonempty affine open. In other words we
may assume that $Y = \text{Spec}(A)$ where $A$ is a domain with fraction
field $K$.

\medskip\noindent
As $f$ is of finite type we see that $X$ is quasi-compact.
Write $X = X_1 \cup \ldots \cup X_n$ for some affine opens $X_i$. By
Morphisms, Definition \ref{morphisms-definition-scheme-theoretically-dense}
we see that $U_i = X_i \cap U$ is an open subscheme of $X_i$ such that
$U_{i, \eta}$ is scheme theoretically dense in $X_{i, \eta}$.
Thus it suffices to prove the result for the pairs $(X_i, U_i)$,
in other words we may assume that $X$ is affine.

\medskip\noindent
Write $X = \text{Spec}(B)$. Note that $B_K$ is Noetherian as it is a
finite type $K$-algebra. Hence $U_\eta$ is quasi-compact. Thus we can
find finitely many $g_1, \ldots, g_m \in B$ such that $D(g_j) \subset U$
and such that $U_\eta = D(g_1)_\eta \cup \ldots \cup D(g_m)_\eta$.
The fact that $U_\eta$ is scheme theoretically dense in
$X_\eta$ means that $B_K \to \bigoplus_j (B_K)_{g_j}$
is injective, see
Morphisms, Example \ref{morphisms-example-scheme-theoretic-closure}.
By
Algebra, Lemma \ref{algebra-lemma-when-injective-covering}
this is equivalent to the injectivity of
$B_K \to \bigoplus\nolimits_{j = 1, \ldots, m} B_K$,
$b \mapsto (g_1b, \ldots, g_mb)$. Let $M$ be the cokernel of this
map over $A$, i.e., such that we have an exact sequence
$$
0 \to I \to B \xrightarrow{(g_1, \ldots, g_m)}
\bigoplus\nolimits_{j = 1, \ldots, m} B \to M \to 0
$$
After replacing $A$ by $A_h$ for some nonzero $h$ we may assume that $B$
is a flat, finitely presented $A$-algebra, and that $M$
is flat over $A$, see
Algebra, Lemma \ref{algebra-lemma-generic-flatness}.
The flatness of $B$ over $A$ implies that $B$ is torsion free as an
$A$-module, see
More on Algebra, Lemma \ref{more-algebra-lemma-flat-torsion-free}.
Hence $B \subset B_K$. By assumption $I_K = 0$ which implies that $I = 0$
(as $I \subset B \subset B_K$ is a subset of $I_K$). Hence now
we have a short exact sequence
$$
0 \to B \xrightarrow{(g_1, \ldots, g_m)}
\bigoplus\nolimits_{j = 1, \ldots, m} B \to M \to 0
$$
with $M$ flat over $A$. Hence for every homomorphism $A \to \kappa$ where
$\kappa$ is a field, we obtain a short exact sequence
$$
0 \to B \otimes_A \kappa \xrightarrow{(g_1 \otimes 1, \ldots, g_m \otimes 1)}
\bigoplus\nolimits_{j = 1, \ldots, m} B \otimes_A \kappa \to
M \otimes_A \kappa \to 0
$$
see
Algebra, Lemma \ref{algebra-lemma-flat-tor-zero}.
Reversing the arguments above
this means that $\bigcup D(g_j \otimes 1)$ is scheme
theoretically dense in $\text{Spec}(B \otimes_A \kappa)$.
As $\bigcup D(g_j \otimes 1) = \bigcup D(g_j)_\kappa \subset U_\kappa$
we obtain that $U_\kappa$ is scheme theoretically dense in $X_\kappa$
which is what we wanted to prove.
\end{proof}

\noindent
Suppose given a morphism of schemes $f : X \to Y$ and
a point $y \in Y$. Recally that the fibre $X_y$ is homeomorphic
to the subset $f^{-1}(\{y\})$ of $X$ with induced topology, see
Schemes, Lemma \ref{schemes-lemma-fibre-topological}.
Suppose given a closed subset $T(y) \subset X_y$.
Let $T$ be the closure of $T(y)$ in $X$.
Endow $T$ with the induced reduced scheme structure.
Then $T$ is a closed subscheme of $X$ with the property
that $T_y = T(y)$ set-theoretically. In fact $T$ is the smallest
closed subscheme of $X$ with this property. Thus it is ``harmless''
to denote a closed subset of $X_y$ by $T_y$ if we so desire.
In the following lemma we apply this to the generic fibre of $f$.

\begin{lemma}
\label{lemma-cover-generic-fibre-neighbourhood}
Let $f : X \to Y$ be a finite type morphism of schemes. Assume
$Y$ irreducible with generic point $\eta$. Let
$X_\eta = Z_{1, \eta} \cup \ldots \cup Z_{n, \eta}$ be a covering of
the generic fibre by closed subsets of $X_\eta$.
Let $Z_i$ be the closure of $Z_{i, \eta}$ in $X$ (see discussion above).
Then there exists a nonempty open $V \subset Y$ such
that $X_y = Z_{1, y} \cup \ldots \cup Z_{n, y}$ for all $y \in V$.
\end{lemma}

\begin{proof}
If $Y$ is Noetherian then $U = X \setminus (Z_1 \cup \ldots \cup Z_n)$
is of finite type over $Y$ and we can directly apply
Lemma \ref{lemma-empty-generic-fibre}
to get that $U_V = \emptyset$ for a nonempty open $V \subset Y$.
In general we argue as follows. As the question is topological
we may replace $Y$ by its reduction. Thus $Y$ is integral, see
Properties, Lemma \ref{properties-lemma-characterize-integral}.
After shrinking $Y$ we may assume that $X \to Y$ is flat, see
Morphisms, Proposition \ref{morphisms-proposition-generic-flatness}.
In this case every point $x$ in $X_y$ is a specialization of a point
$x' \in X_\eta$ by
Morphisms, Lemma \ref{morphisms-lemma-generalizations-lift-flat}.
As the $Z_i$ are closed in $X$ and cover the generic fibre this
implies that $X_y = \bigcup Z_{i, y}$ for $y \in Y$ as desired.
\end{proof}

\noindent
The following lemma says that generic fibres of morphisms whose source is
reduced are reduced.

\begin{lemma}
\label{lemma-reduction-generic-fibre}
Let $f : X \to Y$ be a morphism of schemes. Let $\eta \in Y$ be a generic
point of an irreducible component of $Y$. Then
$(X_\eta)_{red} = (X_{red})_\eta$.
\end{lemma}

\begin{proof}
Choose an affine neighbourhood $\text{Spec}(A) \subset Y$ of $\eta$.
Choose an affine open $\text{Spec}(B) \subset X$ mapping into $\text{Spec}(A)$
via the morphism $f$. Let $\mathfrak p \subset A$ be the minimal prime
corresponding to $\eta$. Let $B_{red}$ be the quotient of $B$ by
$\sqrt{(0)}$. The algebraic content of the lemma is that
$B_{red} \otimes_A \kappa(\mathfrak p)$ is reduced. To prove this, suppose
that $x \in B_{red} \otimes_A \kappa(\mathfrak p)$ is nilpotent. Say
$x^n = 0$ for some $n > 0$.
Pick an $f \in A$, $f \not \in \mathfrak p$ such that
$fx$ is the image of $y \in B_{red}$. Then $gy^n \in \mathfrak pB_{red}$ for
some $g \in A$, $g \not \in \mathfrak p$. By
Algebra, Lemma \ref{algebra-lemma-minimal-prime-reduced-ring}
we see that $\mathfrak pA_{\mathfrak p}$ is locally nilpotent. By
Algebra, Lemma \ref{algebra-lemma-locally-nilpotent}
we see that $\mathfrak p(B_{red})_{\mathfrak p}$ is locally nilpotent.
Hence we conclude that $gy^n$ is nilpotent in $(B_{red})_{\mathfrak p}$.
Thus there exists a $h \in A$, $h \not \in \mathfrak p$ and an $m > 0$
such that $h(gy^n)^m = 0$ in $B_{red}$. This implies that
$hgy$ is nilpotent in $B_{red}$, i.e., that $hgy = 0$. Of course this
means that $x = 0$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-make-generic-fibre-geometrically-reduced}
Let $f : X \to Y$ be a morphism of schemes.
Assume that $Y$ is irreducible and $f$ is of finite type.
There exists a diagram
$$
\xymatrix{
X' \ar[d]_{f'} \ar[r]_{g'} & X_V \ar[r] \ar[d] & X \ar[d]^f \\
Y' \ar[r]^g & V \ar[r] & Y
}
$$
where
\begin{enumerate}
\item $V$ is a nonempty open of $Y$,
\item $X_V = V \times_Y X$,
\item $g : Y' \to V$ is a finite universal homeomorphism,
\item $X' = (Y' \times_Y X)_{red} = (Y' \times_V X_V)_{red}$,
\item $g'$ is a finite universal homeomorphism,
\item $Y'$ is an integral affine scheme,
\item $f'$ is flat and of finite presentation, and
\item the generic fibre of $f'$ is geometrically reduced.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $V = \text{Spec}(A)$ be a nonempty affine open of $Y$.
By assumption the radical of $A$ is a prime ideal $\mathfrak p$.
Let $K = f.f(A/\mathfrak p)$ be the fraction field.
Let $p$ be the characteristic of $K$ if positive and $1$
if the characteristic is zero. By
Varieties, Lemma \ref{varieties-lemma-finite-extension-geometrically-reduced}
there exists a finite purely inseparable field extension
$K \subset K'$ such that $X_{K'}$ is geometrically reduced over $K'$.
Choose elements $x_1, \ldots, x_n \in K'$ which generate $K'$ over
$K$ and such that some $p$-power of $x_i$ is in $A/\mathfrak p$.
Let $A' \subset K'$ be the finite $A$-subalgebra of $K'$ generated by
$x_1, \ldots, x_n$. Note that $A'$ is a domain with fraction field $K'$. By
Algebra, Lemma \ref{algebra-lemma-p-ring-map}
we see that $A \to A'$ is a universal homeomorphism.
Set $Y' = \text{Spec}(A')$. Set $X' = (Y' \times_Y X)_{red}$.
The generic fibre of $X' \to Y'$ is $(X_K)_{red}$ by
Lemma \ref{lemma-reduction-generic-fibre}
which is geometrically reduced by construction.
Note that $X' \to X_V$ is a finite universal homeomorphism as the
composition of the reduction morphism $X' \to Y' \times_Y X$ (see
Morphisms, Lemma \ref{morphisms-lemma-reduction-universal-homeomorphism})
and the base change of $g$.
At this point all of the properties of the lemma hold except for
possibly (7). This can be achieved by shrinking $Y'$ and hence $V$, see
Morphisms, Proposition \ref{morphisms-proposition-generic-flatness}.
\end{proof}

\begin{lemma}
\label{lemma-make-components-generic-fibre-geometrically-irreducible}
Let $f : X \to Y$ be a morphism of schemes.
Assume that $Y$ is irreducible and $f$ is of finite type.
There exists a diagram
$$
\xymatrix{
X' \ar[d]_{f'} \ar[r]_{g'} & X_V \ar[r] \ar[d] & X \ar[d]^f \\
Y' \ar[r]^g & V \ar[r] & Y
}
$$
where
\begin{enumerate}
\item $V$ is a nonempty open of $Y$,
\item $X_V = V \times_Y X$,
\item $g : Y' \to V$ is surjective finite \'etale,
\item $X' = Y' \times_Y X = Y' \times_V X_V$,
\item $g'$ is surjective finite \'etale,
\item $Y'$ is an irreducible affine scheme, and
\item all irreducible components of the generic fibre of $f'$
are geometrically irreducible.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $V = \text{Spec}(A)$ be a nonempty affine open of $Y$.
By assumption the radical of $A$ is a prime ideal $\mathfrak p$.
Let $K = f.f(A/\mathfrak p)$ be the fraction field. By
Varieties, Lemma
\ref{varieties-lemma-finite-extension-geometrically-irreducible-components}
there exists a finite separable field extension
$K \subset K'$ such that all irreducible components of $X_{K'}$ are
geometrically irreducible over $K'$.
Choose an element $\alpha \in K'$ which generates $K'$ over
$K$, see
Algebra, Lemma \ref{algebra-lemma-finite-separable}.
Let $P(T) \in K[T]$ be the minimal polynomial for $\alpha$ over $K$.
After replacing $\alpha$ by $f \alpha$ for some
$f \in A$, $f \not \in \mathfrak p$
we may assume that there exists a monic polynomial
$T^d + a_1T^{d - 1} + \ldots + a_d \in A[T]$ which maps to
$P(T) \in K[T]$ under the map $A[T] \to K[T]$.
Set $A' = A[T]/(P)$. Then $A \to A'$ is a finite free ring map
such that there exists a unique prime $\mathfrak q$ lying over
$\mathfrak p$, such that
$K = \kappa(\mathfrak p) \subset \kappa(\mathfrak q) = K'$
is finite separable, and such that $\mathfrak pA'_{\mathfrak q}$
is the maximal ideal of $A'_{\mathfrak q}$.
Hence $g : Y' = \text{Spec}(A') \to V = \text{Spec}(A)$
is \'etale at $\mathfrak q$, see
Algebra, Lemma \ref{algebra-lemma-characterize-etale}.
This means that there exists an open $W \subset \text{Spec}(A')$ such
that $g|_W : W \to \text{Spec}(A)$ is \'etale.
Since $g$ is finite and since $\mathfrak q$ is the only point lying over
$\mathfrak p$ we see that $Z = g(Y' \setminus W)$ is a closed subset of $V$
not containing $\mathfrak p$. Hence after replacing $V$ by a principal
affine open of $V$ which does not meet $Z$ we obtain that $g$ is finite
\'etale.
\end{proof}

\begin{lemma}
\label{lemma-common-open}
Let $S$ be an integral scheme with generic point $\eta$.
Let $f : X \to S$ and $g : Y \to S$ be morphisms of schemes such that
\begin{enumerate}
\item $f$, $g$ are locally of finite type,
\item $X_\eta$, $Y_\eta$ are integral with generic points $x$, $y$, and
\item $\kappa(x) \cong \kappa(y)$ as $\kappa(\eta)$-extensions.
\end{enumerate}
Then there exist open subschemes $x \in U \subset X$, $y \in V \subset Y$
and an $S$-isomorphism $U \to V$ which induces the given isomorphism of
residue fields.
\end{lemma}

\begin{proof}
The question is local around the points $\eta$, $x$, $y$. Hence we may replace
$S$, $X$, $Y$ by affine neighbourhoods of $\eta$, $x$, $y$ and hence reduce
to the case that $S$, $X$, $Y$ are affine. Say
$S = \text{Spec}(R)$ and $X = \text{Spec}(A)$, $Y = \text{Spec}(B)$. By
Algebra, Lemma \ref{algebra-lemma-generic-flatness}
we may also assume that $A$ and $B$ are flat and of finite presentation
over $R$. Denote $K = f.f.(R)$. The rings $A$, $B$ are torsion free
as $R$-modules because $A$, $B$ are flat over $R$, see
More on Algebra, Lemma \ref{more-algebra-lemma-flat-torsion-free}.
Since $A \otimes_R K$ and $B \otimes_R K$ are domains by assumption it follows
that $A$ and $B$ are domains. Set $L = f.f.(A)$ and $M = f.f.(B)$.
Let $\varphi : L \to M$ be the given isomorphism of $K$-extensions.

\medskip\noindent
Choose elements $x_1, \ldots, x_n \in A$ which generate $A$ as an
$R$-algebra, and choose elements $y_1, \ldots, y_m \in B$ which generate
$B$ as an $R$-algebra. Write $\varphi(x_i) = b_i/b$ for some
$b, b_i \in B$. In other words, $b$ is a common denominatior for the
elements $\varphi(x_i) \in M = f.f.(B)$.
Similarly, write $\varphi^{-1}(y_j) = a_j/a$ for some
$a, a_j \in A$. Note that $\varphi(a) \in B_b$ because $a$ can be written
as a polynomial in the $x_i$. Similarly we have $\varphi^{-1}(b) \in A_a$.
Thus $\varphi$ gives an isomorphism
$$
A_a \longrightarrow B_b
$$
of $R$-algebras and the lemma is proven.
\end{proof}







\section{Relative assassins}
\label{section-assassin}

\begin{lemma}
\label{lemma-relative-assassin-in-neighbourhood}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
Let $\xi \in \text{Ass}_{X/S}(\mathcal{F})$ and set
$Z = \overline{\{\xi\}} \subset X$.
If $f$ is locally of finite type and $\mathcal{F}$ is a
finite type $\mathcal{O}_X$-module, then there exists a nonempty
open $V \subset Z$ such that for every $s \in f(V)$ the generic
points of $V_s$ are elements of $\text{Ass}_{X/S}(\mathcal{F})$.
\end{lemma}

\begin{proof}
We may replace $S$ by an affine open neighbourhood of $f(\xi)$
and $X$ by an affine open neighbourhood of $\xi$. Hence we may assume
$S = \text{Spec}(A)$, $X = \text{Spec}(B)$ and that $f$ is given by
the finite type ring map $A \to B$, see
Morphisms, Lemma \ref{morphisms-lemma-locally-finite-type-characterize}.
Moreover, we may write $\mathcal{F} = \widetilde{M}$ for some finite
$B$-module $M$, see
Properties, Lemma \ref{properties-lemma-finite-type-module}.
Let $\mathfrak q \subset B$ be the prime corresponding to $\xi$ and
let $\mathfrak p \subset A$ be the corresponding prime of $A$.
By assumption $\mathfrak q \in \text{Ass}_B(M \otimes_A \kappa(\mathfrak p))$,
see
Algebra, Remark \ref{algebra-remark-bourbaki}
and
Divisors, Lemma \ref{divisors-lemma-associated-affine-open}.
With this notation $Z = V(\mathfrak q) \subset \text{Spec}(B)$.
In particular $f(Z) \subset V(\mathfrak p)$. Hence clearly it suffices to
prove the lemma after replacing $A$, $B$, and $M$ by
$A/\mathfrak pA$, $B/\mathfrak pB$, and $M/\mathfrak pM$.
In other words we may assume that $A$ is a domain with fraction field
$K$ and $\mathfrak q \subset B$ is an associated prime of $M \otimes_A K$.

\medskip\noindent
At this point we can use generic flatness. Namely, by
Algebra, Lemma \ref{algebra-lemma-generic-flatness}
there exists a nonzero $g \in A$ such that $M_g$ is flat
as an $A_g$-module. After replacing $A$ by $A_g$ we may assume that
$M$ is flat as an $A$-module.

\medskip\noindent
In this case, by
Algebra, Lemma \ref{algebra-lemma-post-bourbaki}
we see that $\mathfrak q$ is also an associated prime of $M$.
Hence we obtain an injective $B$-module map $B/\mathfrak q \to M$.
Let $Q$ be the cokernel so that we obtain a short exact sequence
$$
0 \to B/\mathfrak q \to M \to Q \to 0
$$
of finite $B$-modules. After applying generic flatness
Algebra, Lemma \ref{algebra-lemma-generic-flatness}
once more, this time to the $B$-module $Q$, we may assume that $Q$
is a flat $A$-module. In particular we may assume the short exact
sequence above is universally injective, see
Algebra, Lemma \ref{algebra-lemma-flat-tor-zero}.
In this situation
$(B/\mathfrak q) \otimes_A \kappa(\mathfrak p')
\subset M \otimes_A \kappa(\mathfrak p')$
for any prime $\mathfrak p'$ of $A$. The lemma follows as a minimal
prime $\mathfrak q'$ of the support of
$(B/\mathfrak q) \otimes_A \kappa(\mathfrak p')$
is an associated prime of $(B/\mathfrak q) \otimes_A \kappa(\mathfrak p')$ by
Divisors, Lemma \ref{divisors-lemma-minimal-support-in-ass}.
\end{proof}

\begin{lemma}
\label{lemma-bad-case}
Let $f : X \to Y$ be a morphism of schemes. Let $\mathcal{F}$ be a
quasi-coherent $\mathcal{O}_X$-module. Let $U \subset X$ be an open
subscheme. Assume
\begin{enumerate}
\item $f$ is of finite type,
\item $\mathcal{F}$ is of finite type,
\item $Y$ is irreducible with generic point $\eta$, and
\item $\text{Ass}_{X_\eta}(\mathcal{F}_\eta)$ is not contained in $U_\eta$.
\end{enumerate}
Then there exists a nonempty open subscheme $V \subset Y$ such that
for all $y \in V$ the set $\text{Ass}_{X_y}(\mathcal{F}_y)$ is not
contained in $U_y$.
\end{lemma}

\begin{proof}
Let $\xi \in \text{Ass}_{X_\eta}(\mathcal{F}_\eta)$ be a point
which is not contained in $U_\eta$. Set $Z = \overline{\{\xi\}}$.
By assumption $U \cap Z$ is not dense in the irreducible scheme $Z_\eta$.
Hence by
Lemma \ref{lemma-nowhere-dense-generic-fibre}
after replacing $Y$ by a nonempty open we may assume that $U_y \cap Z_y$
is nowhere dense in $Z_y$. On the other hand, by
Lemma \ref{lemma-relative-assassin-in-neighbourhood}
there exists a nonempty open $V \subset Z$ such that every
generic point of $V_y$ is an associated point of $\mathcal{F}_y$. By
Lemma \ref{lemma-nonempty-generic-fibre}
the set $f(V)$ contains a nonempty open subset of $Y$ and we win.
\end{proof}

\begin{lemma}
\label{lemma-good-case}
Let $f : X \to Y$ be a morphism of schemes. Let $\mathcal{F}$ be a
quasi-coherent $\mathcal{O}_X$-module. Let $U \subset X$ be an open
subscheme. Assume
\begin{enumerate}
\item $f$ is of finite type,
\item $\mathcal{F}$ is of finite type,
\item $Y$ is irreducible with generic point $\eta$, and
\item $\text{Ass}_{X_\eta}(\mathcal{F}_\eta) \subset U_\eta$.
\end{enumerate}
Then there exists a nonempty open subscheme $V \subset Y$ such that
for all $y \in V$ we have $\text{Ass}_{X_y}(\mathcal{F}_y) \subset U_y$.
\end{lemma}

\begin{proof}
(This proof is the same as the proof of
Lemma \ref{lemma-scheme-theoretically-dense-generic-fibre}.
We urge the reader to read that proof first.)
Since the statement is about fibres it is clear that we may replace
$Y$ by its reduction. Hence we may assume that $Y$ is integral, see
Properties, Lemma \ref{properties-lemma-characterize-integral}.
We may also assume that $Y = \text{Spec}(A)$ is affine. Then $A$
is a domain with fraction field $K$.

\medskip\noindent
As $f$ is of finite type we see that $X$ is quasi-compact.
Write $X = X_1 \cup \ldots \cup X_n$ for some affine opens $X_i$
and set $\mathcal{F}_i = \mathcal{F}|_{X_i}$. By
assumption the generic fibre of $U_i = X_i \cap U$ contains
$\text{Ass}_{X_{i, \eta}}(\mathcal{F}_{i, \eta})$.
Thus it suffices to prove the result for the triples
$(X_i, \mathcal{F}_i, U_i)$,
in other words we may assume that $X$ is affine.

\medskip\noindent
Write $X = \text{Spec}(B)$. Let $N$ be a finite $B$-module such that
$\mathcal{F} = \widetilde{N}$.
Note that $B_K$ is Noetherian as it is a
finite type $K$-algebra. Hence $U_\eta$ is quasi-compact. Thus we can
find finitely many $g_1, \ldots, g_m \in B$ such that $D(g_j) \subset U$
and such that $U_\eta = D(g_1)_\eta \cup \ldots \cup D(g_m)_\eta$.
Since $\text{Ass}_{X_\eta}(\mathcal{F}_\eta) \subset U_\eta$
we see that $N_K \to \bigoplus_j (N_K)_{g_j}$ is injective. By
Algebra, Lemma \ref{algebra-lemma-when-injective-covering}
this is equivalent to the injectivity of
$N_K \to \bigoplus\nolimits_{j = 1, \ldots, m} N_K$,
$n \mapsto (g_1n, \ldots, g_mn)$. Let $I$ and $M$ be the kernel and
cokernel of this map over $A$, i.e., such that we have an exact sequence
$$
0 \to I \to N \xrightarrow{(g_1, \ldots, g_m)}
\bigoplus\nolimits_{j = 1, \ldots, m} N \to M \to 0
$$
After replacing $A$ by $A_h$ for some nonzero $h$ we may assume that
$B$ is a flat, finitely presented $A$-algebra and that
both $M$ and $N$ are flat over $A$, see
Algebra, Lemma \ref{algebra-lemma-generic-flatness}.
The flatness of $N$ over $A$ implies that $N$ is torsion free as an
$A$-module, see
More on Algebra, Lemma \ref{more-algebra-lemma-flat-torsion-free}.
Hence $N \subset N_K$. By construction $I_K = 0$ which implies that $I = 0$
(as $I \subset N \subset N_K$ is a subset of $I_K$). Hence now
we have a short exact sequence
$$
0 \to N \xrightarrow{(g_1, \ldots, g_m)}
\bigoplus\nolimits_{j = 1, \ldots, m} N \to M \to 0
$$
with $M$ flat over $A$. Hence for every homomorphism $A \to \kappa$ where
$\kappa$ is a field, we obtain a short exact sequence
$$
0 \to N \otimes_A \kappa \xrightarrow{(g_1 \otimes 1, \ldots, g_m \otimes 1)}
\bigoplus\nolimits_{j = 1, \ldots, m} N \otimes_A \kappa \to
M \otimes_A \kappa \to 0
$$
see
Algebra, Lemma \ref{algebra-lemma-flat-tor-zero}.
Reversing the arguments above
this means that $\bigcup D(g_j \otimes 1)$ contains
$\text{Ass}_{B \otimes_A \kappa}(N \otimes_A \kappa)$.
As $\bigcup D(g_j \otimes 1) = \bigcup D(g_j)_\kappa \subset U_\kappa$
we obtain that $U_\kappa$ contains
$\text{Ass}_{X \otimes \kappa}(\mathcal{F} \otimes \kappa)$
which is what we wanted to prove.
\end{proof}

\begin{lemma}
\label{lemma-base-change-assassin-in-U}
Let $f : X \to S$ be a morphism which is locally of finite type.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module
of finite type. Let $U \subset X$ be an open subscheme.
Let $g : S' \to S$ be a morphism of schemes, let
$f' : X' = X_{S'} \to S'$ be the base change of $f$,
let $g' : X' \to X$ be the projection, set
$\mathcal{F}' = (g')^*\mathcal{F}$, and set
$U' = (g')^{-1}(U)$. Finally, let $s' \in S'$ with image $s = g(s')$.
In this case
$$
\text{Ass}_{X_s}(\mathcal{F}_s) \subset U_s
\Leftrightarrow
\text{Ass}_{X'_{s'}}(\mathcal{F}'_{s'}) \subset U'_{s'}.
$$
\end{lemma}

\begin{proof}
This follows immediately from
Divisors, Lemma \ref{divisors-lemma-base-change-relative-assassin}.
See also
Divisors, Remark \ref{divisors-remark-base-change-relative-assassin}.
\end{proof}

\begin{lemma}
\label{lemma-relative-assassin-constructible}
Let $f : X \to Y$ be a morphism of finite presentation.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module
of finite presentation. Let $U \subset X$ be an open subscheme
such that $U \to Y$ is quasi-compact. Then the set
$$
E = \{y \in Y \mid \text{Ass}_{X_y}(\mathcal{F}_y) \subset U_y\}
$$
is locally constructible in $Y$.
\end{lemma}

\begin{proof}
Let $y \in Y$. We have to show that there exists an open neighbourhood
$V$ of $y$ in $Y$ such that $E \cap V$ is constructible in $V$. Thus we may
assume that $Y$ is affine. Write $Y = \text{Spec}(A)$ and
$A = \text{colim}\ A_i$ as a directed limit of finite type
$\mathbf{Z}$-algebras. By
Limits, Lemma \ref{limits-lemma-descend-finite-presentation}
we can find an $i$ and a morphism $f_i : X_i \to \text{Spec}(A_i)$ of
finite presentation whose base change to $Y$ recovers $f$.
After possibly increasing $i$ we may assume there exists a
quasi-coherent $\mathcal{O}_{X_i}$-module $\mathcal{F}_i$ of finite
presentation whose pullback to $X$ is isomorphic to $\mathcal{F}$, see
Limits, Lemma \ref{limits-lemma-descend-modules-finite-presentation}.
After possibly increasing $i$ one more time we may assume there exists
an open subscheme $U_i \subset X_i$ whose inverse image in $X$
is $U$, see
Limits, Lemma \ref{limits-lemma-descend-opens}.
By
Lemma \ref{lemma-base-change-assassin-in-U}
it suffices to prove the lemma for $f_i$. Thus we reduce to
the case where $Y$ is the spectrum of a Noetherian ring.

\medskip\noindent
We will use the criterion of
Topology, Lemma \ref{topology-lemma-characterize-constructible-Noetherian}
to prove that $E$ is constructible in case $Y$ is a Noetherian scheme.
To see this let $Z \subset Y$ be an irreducible closed subscheme.
We have to show that $E \cap Z$ either contains a nonempty open subset
or is not dense in $Z$. This follows from
Lemmas \ref{lemma-bad-case} and
\ref{lemma-good-case}
applied to the base change $(X, \mathcal{F}, U) \times_Y Z$ over $Z$.
\end{proof}











\section{Reduced fibres}
\label{section-reduced}

\begin{lemma}
\label{lemma-nonreduced-in-neighbourhood}
Let $f : X \to Y$ be a morphism of schemes. Assume $Y$ irreducible with
generic point $\eta$ and $f$ of finite type. If $X_\eta$ is nonreduced,
then there exists a nonempty open $V \subset Y$
such that for all $y \in V$ the fibre $X_y$ is nonreduced.
\end{lemma}

\begin{proof}
Let $Y' \subset Y$ be the reduction of $Y$. Let $X' \to Y'$
be the base change of $f$. Note that $Y' \to Y$
induces a bijection on points and that $X' \to X$ identifies fibres.
Hence we may assume that $Y'$ is reduced, i.e., integral, see
Properties, Lemma \ref{properties-lemma-characterize-integral}.
We may also replace $Y$ by an affine open. Hence we may assume that
$Y = \text{Spec}(A)$ with $A$ a domain. Denote $K = f.f.(A)$ the
fraction field of $A$.
Pick an affine open $\text{Spec}(B) = U \subset X$ and a section
$h_\eta \in \Gamma(U_\eta, \mathcal{O}_{U_\eta}) = B_K$
which is nonzero and nilpotent.
After shrinking $Y$ we may assume that $h$ comes from
$h \in \Gamma(U, \mathcal{O}_U) = B$. After shrinking $Y$ a bit
more we may assume that $h$ is nilpotent. Let
$I = \{b \in B \mid hb = 0\}$ be the annihilator of $h$.
Then $C = B/I$ is a finite type $A$-algebra whose generic fiber
$(B/I)_K$ is nonzero (as $h_\eta \not = 0$). We apply
generic flatness to $A \to C$ and $A \to B/hB$, see
Algebra, Lemma \ref{algebra-lemma-generic-flatness},
and we obtain a $g \in A$, $g \not = 0$ such that $C_g$ is free as
an $A_g$-module and $(B/hB)_g$ is flat as an $A_g$-module.
Replace $Y$ by $D(g) \subset Y$. Now we have the short exact sequence
$$
0 \to C \to B \to B/hB \to 0.
$$
with $B/hB$ flat over $A$ and with $C$ nonzero free as an $A$-module.
It follows that for any homomorphism $A \to \kappa$ to a field
the ring $C \otimes_A \kappa$ is nonzero and the sequence
$$
0 \to C \otimes_A \kappa \to B \otimes_A \kappa \to
B/hB \otimes_A \kappa \to 0
$$
is exact, see
Algebra, Lemma \ref{algebra-lemma-flat-tor-zero}.
Note that
$B/hB \otimes_A \kappa = (B \otimes_A \kappa) / h(B \otimes_A \kappa)$
by right exactness of tensor product. Thus we conclude that
multiplication by $h$ is not zero on $B \otimes_A \kappa$.
This clearly means that for any point $y \in Y$ the element $h$
restricts to a nonzero element of $U_y$, whence $X_y$ is nonreduced.
\end{proof}

\begin{lemma}
\label{lemma-base-change-fibres-geometrically-reduced}
Let $f : X \to Y$ be a morphism of schemes.
Let $g : Y' \to Y$ be any morphism, and denote
$f' : X' \to Y'$ the base change of $f$.
Then
\begin{align*}
\{y' \in Y' \mid X'_{y'}\text{ is geometrically reduced}\} \\
= g^{-1}(\{y \in Y \mid X_y\text{ is geometrically reduced}\}).
\end{align*}
\end{lemma}

\begin{proof}
This comes down to the statement that for $y' \in Y'$ with image
$y \in Y$ the fibre $X'_{y'} = X_y \times_y y'$ is geometrically
reduced over $\kappa(y')$ if and only if $X_y$ is geometrically
reduced over $\kappa(y)$. This follows from
Varieties, Lemma \ref{varieties-lemma-geometrically-reduced-upstairs}.
\end{proof}

\begin{lemma}
\label{lemma-not-geometrically-reduced-in-neighbourhood}
Let $f : X \to Y$ be a morphism of schemes. Assume $Y$ irreducible with
generic point $\eta$ and $f$ of finite type. If $X_\eta$ is not
geometrically reduced, then there exists a nonempty open $V \subset Y$
such that for all $y \in V$ the fibre $X_y$ is not geometrically reduced.
\end{lemma}

\begin{proof}
Apply
Lemma \ref{lemma-make-generic-fibre-geometrically-reduced}
to get
$$
\xymatrix{
X' \ar[d]_{f'} \ar[r]_{g'} & X_V \ar[r] \ar[d] & X \ar[d]^f \\
Y' \ar[r]^g & V \ar[r] & Y
}
$$
with all the properties mentioned in that lemma.
Let $\eta'$ be the generic point of $Y'$.
Consider the morphism $X' \to X_{Y'}$ (which is the reduction
morphism) and the resulting morphism of generic fibres
$X'_{\eta'} \to X_{\eta'}$.
Since $X'_{\eta'}$ is geometrically reduced, and $X_\eta$
is not this cannot be an isomorphism, see
Varieties, Lemma \ref{varieties-lemma-geometrically-reduced-upstairs}.
Hence $X_{\eta'}$ is nonreduced. Hence by
Lemma \ref{lemma-nonreduced-in-neighbourhood}
the fibres of $X_{Y'} \to Y'$ are nonreduced at all points $y' \in V'$
of a nonempty open $V' \subset Y'$. Since $g : Y' \to V$ is a homeomorphism
Lemma \ref{lemma-base-change-fibres-geometrically-reduced}
proves that $g(V')$ is the open we are looking for.
\end{proof}

\begin{lemma}
\label{lemma-geometrically-reduced-generic-fibre}
Let $f : X \to Y$ be a morphism of schemes.
Assume
\begin{enumerate}
\item $Y$ is irreducible with generic point $\eta$,
\item $X_\eta$ is geometrically reduced, and
\item $f$ is of finite type.
\end{enumerate}
Then there exists a nonempty open subscheme $V \subset Y$
such that $X_V \to V$ has geometrically reduced fibres.
\end{lemma}

\begin{proof}
Let $Y' \subset Y$ be the reduction of $Y$. Let $X' \to Y'$
be the base change of $f$. Note that $Y' \to Y$
induces a bijection on points and that $X' \to X$ identifies fibres.
Hence we may assume that $Y'$ is reduced, i.e., integral, see
Properties, Lemma \ref{properties-lemma-characterize-integral}.
We may also replace $Y$ by an affine open. Hence we may assume that
$Y = \text{Spec}(A)$ with $A$ a domain. Denote $K = f.f.(A)$ the
fraction field of $A$. After shrinking $Y$ a bit we may also assume that
$X \to Y$ is flat and of finite presentation, see
Morphisms, Proposition \ref{morphisms-proposition-generic-flatness}.

\medskip\noindent
As $X_\eta$ is geometrically reduced there exists an open dense
subset $V \subset X_\eta$ such that $V \to \text{Spec}(K)$ is smooth, see
Varieties, Lemma \ref{varieties-lemma-geometrically-reduced-dense-smooth-open}.
Let $U \subset X$ be the set of points where $f$ is smooth. By
Morphisms, Lemma \ref{morphisms-lemma-set-points-where-fibres-smooth}
we see that $V \subset U_\eta$. Thus the generic fibre of $U$ is dense
in the generic fibre of $X$. Since $X_\eta$ is reduced, it follows
that $U_\eta$ is scheme theoretically dense in $X_\eta$, see
Morphisms, Lemma \ref{morphisms-lemma-reduced-scheme-theoretically-dense}.
We note that as $U \to Y$ is smooth all the fibres of $U \to Y$
are geometrically reduced. Thus it suffices to show that, after
shrinking $Y$, for all $y \in Y$ the scheme $U_y$ is scheme theoretically
dense in $X_y$, see
Morphisms, Lemma \ref{morphisms-lemma-reduced-subscheme-closure}.
This follows from
Lemma \ref{lemma-scheme-theoretically-dense-generic-fibre}.
\end{proof}

\begin{lemma}
\label{lemma-geometrically-reduced-constructible}
Let $f : X \to Y$ be a morphism of finite presentation.
Then the set
$$
E = \{y \in Y \mid X_y\text{ is geometrically reduced}\}
$$
is locally constructible in $Y$.
\end{lemma}

\begin{proof}
Let $y \in Y$. We have to show that there exists an open neighbourhood
$V$ of $y$ in $Y$ such that $E \cap V$ is constructible in $V$. Thus we may
assume that $Y$ is affine. Write $Y = \text{Spec}(A)$ and
$A = \text{colim}\ A_i$ as a directed limit of finite type
$\mathbf{Z}$-algebras. By
Limits, Lemma \ref{limits-lemma-descend-finite-presentation}
we can find an $i$ and a morphism $f_i : X_i \to \text{Spec}(A_i)$ of
finite presentation whose base change to $Y$ recovers $f$. By
Lemma \ref{lemma-base-change-fibres-geometrically-reduced}
it suffices to prove the lemma for $f_i$. Thus we reduce to
the case where $Y$ is the spectrum of a Noetherian ring.

\medskip\noindent
We will use the criterion of
Topology, Lemma \ref{topology-lemma-characterize-constructible-Noetherian}
to prove that $E$ is constructible in case $Y$ is a Noetherian scheme.
To see this let $Z \subset Y$ be an irreducible closed subscheme.
We have to show that $E \cap Z$ either contains a nonempty open subset
or is not dense in $Z$. If $X_\xi$ is geometrically reduced, then
Lemma \ref{lemma-geometrically-reduced-generic-fibre}
(applied to the morphism $X_Z \to Z$)
implies that all fibres $X_y$ are geometrically reduced
for a nonempty open $V \subset Z$.
If $X_\xi$ is not geometrically reduced, then
Lemma \ref{lemma-not-geometrically-reduced-in-neighbourhood}
(applied to the morphism $X_Z \to Z$)
implies that all fibres $X_y$ are geometrically reduced
for a nonempty open $V \subset Z$. Thus we win.
\end{proof}








\section{Irreducible components of fibres}
\label{section-irreducible}

\begin{lemma}
\label{lemma-irreducible-components-in-neighbourhood}
Let $f : X \to Y$ be a morphism of schemes. Assume $Y$ irreducible with
generic point $\eta$ and $f$ of finite type. If $X_\eta$ has $n$
irreducible components, then there exists a nonempty open $V \subset Y$
such that for all $y \in V$ the fibre $X_y$ has at least $n$
irreducible components.
\end{lemma}

\begin{proof}
As the question is purely topological we may replace $X$ and $Y$ by
their reductions. In particular this implies that $Y$ is integral, see
Properties, Lemma \ref{properties-lemma-characterize-integral}.
Let $X_\eta = X_{1, \eta} \cup \ldots \cup X_{n, \eta}$
be the decomposition of $X_\eta$ into irreducible components.
Let $X_i \subset X$ be the reduced closed subscheme whose generic
fibre is $X_{i, \eta}$. Note that $Z_{i, j} = X_i \cap X_j$
is a closed subset of $X_i$ whose generic fibre $Z_{i, j, \eta}$
is nowhere dense in $X_{i, \eta}$. Hence after shrinking $Y$ we may
assume that $Z_{i, j, y}$
is nowhere dense in $X_{i, y}$ for every $y \in Y$, see
Lemma \ref{lemma-nowhere-dense-generic-fibre}.
After shrinking $Y$ some more we may assume that
$X_y = \bigcup X_{i, y}$ for $y \in Y$, see
Lemma \ref{lemma-cover-generic-fibre-neighbourhood}.
Moreover, after shrinking $Y$ we may assume that each $X_i \to Y$
is flat and of finite presentation, see
Morphisms, Proposition \ref{morphisms-proposition-generic-flatness}.
The morphisms $X_i \to Y$ are open, see
Morphisms, Lemma \ref{morphisms-lemma-fppf-open}.
Thus there exists an open neighbourhood $V$ of $\eta$ which is contained
in $f(X_i)$ for each $i$.
For each $y \in V$ the schemes $X_{i, y}$ are
nonempty closed subsets of $X_y$, we have $X_y = \bigcup X_{i, y}$
and the intersections $Z_{i, j, y} = X_{i, y} \cap X_{j, y}$
are not dense in $X_{i, y}$. Clearly this implies that
$X_y$ has at least $n$ irreducible components.
\end{proof}

\begin{lemma}
\label{lemma-base-change-fibres-geometrically-irreducible}
Let $f : X \to Y$ be a morphism of schemes.
Let $g : Y' \to Y$ be any morphism, and denote
$f' : X' \to Y'$ the base change of $f$.
Then
\begin{align*}
\{y' \in Y' \mid X'_{y'}\text{ is geometrically irreducible}\} \\
= g^{-1}(\{y \in Y \mid X_y\text{ is geometrically irreducible}\}).
\end{align*}
\end{lemma}

\begin{proof}
This comes down to the statement that for $y' \in Y'$ with image
$y \in Y$ the fibre $X'_{y'} = X_y \times_y y'$ is geometrically
irreducible over $\kappa(y')$ if and only if $X_y$ is geometrically
irreducible over $\kappa(y)$. This follows from
Varieties,
Lemma \ref{varieties-lemma-geometrically-irreducible-check-after-extension}.
\end{proof}

\begin{lemma}
\label{lemma-base-change-fibres-nr-geometrically-irreducible-components}
Let $f : X \to Y$ be a morphism of schemes. Let
$$
n_{X/Y} : Y \to \{0, 1, 2, 3, \ldots, \infty\}
$$
be the function which associates to $y \in Y$ the number of irreducible
components of $(X_y)_K$ where $K$ is a separably closed extension
of $\kappa(y)$. This is well defined and if $g : Y' \to Y$ is a morphism
then
$$
n_{X'/Y'} = n_{X/Y} \circ g
$$
where $X' \to Y'$ is the base change of $f$.
\end{lemma}

\begin{proof}
Suppose that $y' \in Y'$ has image $y \in Y$.
Suppose $K \supset \kappa(y)$ and $K' \supset \kappa(y')$ are separably
closed extensions. Then we may choose a commutative diagram
$$
\xymatrix{
K \ar[r] & K'' & K' \ar[l] \\
\kappa(y) \ar[u] \ar[rr] & & \kappa(y') \ar[u]
}
$$
of fields. The result follows as the morphisms of schemes
$$
\xymatrix{
(X'_{y'})_{K'} &
(X'_{y'})_{K''} = (X_y)_{K''} \ar[l] \ar[r] &
(X_y)_K
}
$$
induce bijections between irreducible components, see
Varieties,
Lemma \ref{varieties-lemma-separably-closed-field-irreducible-components}.
\end{proof}

\begin{lemma}
\label{lemma-irreducible-polynomial-over-domain}
Let $A$ be a domain with fraction field $K$.
Let $P \in A[x_1, \ldots, x_n]$.
Denote $\overline{K}$ the algebraic closure of $K$.
Assume $P$ is irreducible in $\overline{K}[x_1, \ldots, x_n]$.
Then there exists a $f \in A$ such that
$P^\varphi \in \kappa[x_1, \ldots, x_n]$ is irreducible for all
homomorphisms $\varphi : A_f \to \kappa$ into fields.
\end{lemma}

\begin{proof}
There exists an automorphism $\Psi$ of $A[x_1, \ldots, x_n]$ over $A$
such that $\Psi(P) = ax_n^d +$ lower order terms in $x_n$ with
$a \not = 0$, see
Algebra, Lemma \ref{algebra-lemma-helper-polynomial}.
We may replace $P$ by $\Psi(P)$ and we may replace $A$ by $A_a$.
Thus we may assume that $P$ is monic in $x_n$ of degree $d > 0$.
For $i = 1, \ldots, n - 1$ let $d_i$ be the degree of $P$ in $x_i$.
Note that this implies that $P^\varphi$ is monic of degree $d$ in $x_n$
and has degree $\leq d_i$ in $x_i$ for every homomorphism
$\varphi : A \to \kappa$ where $\kappa$ is a field.
Thus if $P^\varphi$ is reducible, then we can write
$$
P^\varphi = Q_1 Q_2
$$
with $Q_1, Q_2$ monic of degree $e_1, e_2 \geq 0$ in $x_n$ with
$e_1 + e_2 = d$ and having degree $\leq d_i$ in $x_i$ for
$i = 1, \ldots, n - 1$. In other words we can write
\begin{equation}
\label{equation-factors}
Q_j = x_n^{e_j} + \sum\nolimits_{0 \leq l < e_j}
\left( \sum\nolimits_{L \in \mathcal{L}} a_{j, l, L} x^L \right) x_n^l
\end{equation}
where the sum is over the set $\mathcal{L}$ of multi-indices $L$
of the form $L = (l_1, \ldots, l_{n - 1})$ with $0 \leq l_i \leq d_i$.
For any $e_1, e_2 \geq 0$ with $e_1 + e_2 = d$ we consider the $A$-algebra
$$
B_{e_1, e_2} =
A[\{a_{1, l, L}\}_{0 \leq l < e_1, L \in \mathcal{L}},
\{a_{2, l, L}\}_{0 \leq l < e_2, L \in \mathcal{L}}]/(\text{relations})\
$$
where the $(\text{relations})$ is the ideal generated by the coefficients
of the polynomial
$$
P - Q_1Q_2 \in
A[\{a_{1, l, L}\}_{0 \leq l < e_1, L \in \mathcal{L}},
\{a_{2, l, L}\}_{0 \leq l < e_2, L \in \mathcal{L}}][x_1, \ldots, x_n]
$$
with $Q_1$ and $Q_2$ defined as in (\ref{equation-factors}). OK, and
the assumption that $P$ is irreducible over $\overline{K}$ implies that
there does not exist any $A$-algebra homomorphism
$B_{e_1, e_2} \to \overline{K}$. By the Hilbert Nullstellensatz, see
Algebra, Theorem \ref{algebra-theorem-nullstellensatz}
this means that $B_{e_1, e_2} \otimes_A K = 0$.
As $B_{e_1, e_2}$ is a finitely generated $A$-algebra this signifies that
we can find an $f_{e_1, e_2} \in A$ such that
$(B_{e_1, e_2})_{f_{e_1, e_2}} = 0$. By construction this means that
if $\varphi : A_{f_{e_1, e_2}} \to \kappa$ is a homomorphism to a field,
then $P^\varphi$ does not have a factorization $P^\varphi = Q_1 Q_2$
with $Q_1$ of degree $e_1$ in $x_n$ and $Q_2$ of degree $e_2$ in $x_n$.
Thus taking
$f = \prod_{e1, e_2 \geq 0, e_1 + e_2 = d} f_{e_1, e_2}$ we win.
\end{proof}

\begin{lemma}
\label{lemma-geometrically-irreducible-generic-fibre}
Let $f : X \to Y$ be a morphism of schemes.
Assume
\begin{enumerate}
\item $Y$ is irreducible with generic point $\eta$,
\item $X_\eta$ is geometrically irreducible, and
\item $f$ is of finite type.
\end{enumerate}
Then there exists a nonempty open subscheme $V \subset Y$
such that $X_V \to V$ has geometrically irreducible fibres.
\end{lemma}

\begin{proof}%
[First proof of Lemma \ref{lemma-geometrically-irreducible-generic-fibre}]
We give two proofs of the lemma. These are essentially equivalent;
the second is more self contained but a bit longer.
Choose a diagram
$$
\xymatrix{
X' \ar[d]_{f'} \ar[r]_{g'} & X_V \ar[r] \ar[d] & X \ar[d]^f \\
Y' \ar[r]^g & V \ar[r] & Y
}
$$
as in
Lemma \ref{lemma-make-generic-fibre-geometrically-reduced}.
Note that the generic fibre of $f'$ is the reduction of the
geometric fibre of $f$ (see
Lemma \ref{lemma-reduction-generic-fibre})
and hence is geometrically irreducible.
Suppose that the lemma holds for the morphism $f'$. Then after shrinking
$V$ all the fibres of $f'$ are geometrically irreducible.
As $X' = (Y' \times_V X_V)_{red}$ this implies that all the fibres
of $Y' \times_V X_V$ are geometrically irreducible. Hence by
Lemma \ref{lemma-base-change-fibres-geometrically-irreducible}
all the fibres of $X_V \to V$ are geometrically irreducible and
we win. In this way we see that we may assume that the generic
fibre is geometrically reduced as well as geometrically irreducible
and we may assume $Y = \text{Spec}(A)$ with $A$ a domain.

\medskip\noindent
Let $x \in X_\eta$ be the generic point. As $X_\eta$ is geometrically
irreducible and reduced we see that $L = \kappa(x)$ is a finitely generated
extension of $K = \kappa(\eta) = f.f.(A)$ which is geometrically reduced and
geometrically irreducible, see
Varieties, Lemmas \ref{varieties-lemma-geometrically-reduced-at-point} and
\ref{varieties-lemma-geometrically-irreducible-function-field}.
In particular the field extension $K \subset L$ is separable, see
Algebra, Lemma \ref{algebra-lemma-characterize-separable-field-extensions}.
Hence we can find $x_1, \ldots, x_{r + 1} \in L$ which generate $L$
over $K$ and such that $x_1, \ldots, x_r$ is a transcendence basis for
$L$ over $K$, see
Algebra, Lemma
\ref{algebra-lemma-generating-finitely-generated-separable-field-extensions}.
Let $P \in K(x_1, \ldots, x_r)[T]$ be the minimal polynomial for
$x_{r + 1}$. Clearing denominators we may assume that
$P$ has coefficients in $A[x_1, \ldots, x_r]$.
Note that as $L$ is geometrically reduced and geometrically irreducible
over $K$, the polynomial $P$ is irreducible in
$\overline{K}[x_1, \ldots, x_r, T]$ where $\overline{K}$ is the
algebraic closure of $K$. Denote
$$
B' = A[x_1, \ldots, x_{r + 1}]/(P(x_{r + 1}))
$$
and set $X' = \text{Spec}(B')$. By construction the fraction field of $B'$
is isomorphic to $L = \kappa(x)$ as $K$-extensions. Hence there exists an
open $U \subset X$, and open $U' \subset X'$ and a $Y$-isomorphism
$U \to U'$, see
Lemma \ref{lemma-common-open}.
Here is a diagram:
$$
\xymatrix{
X \ar[rd] &
U \ar[l] \ar@{=}[r] \ar[d] &
U' \ar[r] \ar[d] &
X' \ar[ld] \ar@{=}[r] & \text{Spec}(B') \\
& Y \ar@{=}[r] & Y &
}
$$
Note that $U_\eta \subset X_\eta$ and $U'_\eta \subset X'_\eta$ are
dense opens. Thus after shrinking $Y$ by applying
Lemma \ref{lemma-nowhere-dense-generic-fibre}
we obtain that $U_y$ is dense in $X_y$ and $U'_y$ is dense in $X'_y$
for all $y \in Y$. Thus it suffices to prove the lemma for
$X' \to Y$ which is the content of
Lemma \ref{lemma-irreducible-polynomial-over-domain}.
\end{proof}

\begin{proof}%
[Second proof of Lemma \ref{lemma-geometrically-irreducible-generic-fibre}]
Let $Y' \subset Y$ be the reduction of $Y$. Let $X' \to X$ be the reduction
of $X$. Note that $X' \to X  \to Y$ factors through $Y'$, see
Schemes, Lemma \ref{schemes-lemma-map-into-reduction}.
As $Y' \to Y$ and $X' \to X$ are universal
homeomorphisms by
Morphisms, Lemma \ref{morphisms-lemma-reduction-universal-homeomorphism}
we see that it suffices to prove the lemma for $X' \to Y'$. Thus
we may assume that $X$ and $Y$ are reduced. In particular $Y$ is integral, see
Properties, Lemma \ref{properties-lemma-characterize-integral}.
Thus by
Morphisms, Proposition \ref{morphisms-proposition-generic-flatness}
there exists a nonempty affine open $V \subset Y$ such that $X_V \to V$ is
flat and of finite presentation. After replacing $Y$ by $V$ we may
assume, in addition to (1), (2), (3) that $Y$ is integral affine, $X$
is reduced, and $f$ is flat and of finite presentation. In particular
$f$ is universally open, see
Morphisms, Lemma \ref{morphisms-lemma-fppf-open}.

\medskip\noindent
Pick a nonempty affine open $U \subset X$. Then $U \to Y$ is flat and of
finite presentation with geometrically irreducible generic fibre.
The complement $X_\eta \setminus U_\eta$ is nowhere dense. Thus after
shrinking $Y$ we may assume $U_y \subset X_y$ is open dense for all
$y \in Y$, see
Lemma \ref{lemma-nowhere-dense-generic-fibre}.
Thus we may replace $X$ by $U$ and we reduce to the
case where $Y$ is integral affine and $X$ is reduced affine, flat and of finite
presentation over $Y$ with geometrically irreducible generic fibre $X_\eta$.

\medskip\noindent
Write $X = \text{Spec}(B)$ and $Y = \text{Spec}(A)$. Then $A$ is a domain,
$B$ is reduced, $A \to B$ is flat of finite presentation, and $B_K$ is
geometrically irreducible over $K = f.f.(A)$. In particular we see that
$B_K$ is a domain. Let $L = f.f.(B_K)$ be its fraction field. Note that
$L$ is a finitely generated field extension of $K$ as $B$ is an $A$-algebra
of finite presentation. Let $K \subset K'$ be a finite purely inseparable
extension such that $(L \otimes_K K')_{red}$ is a separably generated field
extension, see
Algebra, Lemma \ref{algebra-lemma-make-separable}.
Choose $x_1, \ldots, x_n \in K'$ which generate the field extension
$K'$ over $K$, and such that $x_i^{q_i} \in A$ for some prime power
$q_i$ (proof existence $x_i$ omitted). Let $A'$ be the $A$-subalgebra
of $K'$ generated by $x_1, \ldots, x_n$. Then $A'$ is a finite
$A$-subalgebra $A' \subset K'$ whose fraction field is $K'$. Note that
$\text{Spec}(A') \to \text{Spec}(A)$ is a universal homeomorphism, see
Algebra, Lemma \ref{algebra-lemma-p-ring-map}.
Hence it suffices to prove the result after base changing to $\text{Spec}(A')$.
We are going to replace $A$ by $A'$ and $B$ by $(B \otimes_A A')_{red}$
to arrive at the situation where $L$ is a separably generated field extension
of $K$. Of course it may happen that $(B \otimes_A A')_{red}$ is no longer
flat, or of finite presentation over $A'$, but this can be remedied by
replacing $A'$ by  $A'_f$ for a suitable $f \in A'$, see
Algebra, Lemma \ref{algebra-lemma-generic-flatness}.

\medskip\noindent
At this point we know that $A$ is a domain, $B$ is reduced, $A \to B$
is flat and of finite presentation, $B_K$ is a domain, and
$L = f.f.(B_K)$ is a separably generated field extension of $K = f.f.(A)$. By
Algebra, Lemma
\ref{algebra-lemma-generating-finitely-generated-separable-field-extensions}
we may write $L = K(x_1, \ldots, x_{r + 1})$
where $x_1, \ldots, x_r$ are algebraically independent over $K$, and
$x_{r + 1}$ is separable over $K(x_1, \ldots, x_r)$. After clearing
denominators we may assume that the minimal polynomial
$P \in K(x_1, \ldots, x_r)[T]$ of $x_{r + 1}$ over $K(x_1, \ldots, x_r)$
has coefficients in $A[x_1, \ldots, x_r]$. Note that since
$L/K$ is separable and since $L$ is geometrically irreducible over
$K$, the polynomial $P$ is irreducible over the algebraic closure
$\overline{K}$ of $K$. Denote
$$
B' = A[x_1, \ldots, x_{r + 1}]/(P(x_{r + 1})).
$$
By construction the fraction fields of $B$ and $B'$ are isomorphic as
$K$-extensions. Hence there exists an isomorphism of $A$-algebras
$B_h \cong B'_{h'}$ for suitable $h \in B$ and $h' \in B'$, see
Lemma \ref{lemma-common-open}.
In other words $X$ and $X' = \text{Spec}(B')$ have a common affine open $U$.
Here is a diagram:
$$
\xymatrix{
X = \text{Spec}(B) \ar[rd] &
U \ar[l] \ar[r] \ar[d] &
\text{Spec}(B') = X' \ar[ld] \\
& Y = \text{Spec}(A) &
}
$$
After shrinking $Y$ once more (by applying
Lemma \ref{lemma-nowhere-dense-generic-fibre}
to $Z = X \setminus U$ in $X$ and $Z' = X' \setminus U$ in $X'$)
we see that $U_y$ is dense in $X_y$ and $U_y$ is dense in $X'_y$
for all $y \in Y$. Thus it suffices to prove the lemma for
$X' \to Y$ which is the content of
Lemma \ref{lemma-irreducible-polynomial-over-domain}.
\end{proof}

\begin{lemma}
\label{lemma-nr-geom-irreducible-components-good}
Let $f : X \to Y$ be a morphism of schemes. Let
$n_{X/Y}$ be the function on $Y$ counting the numbers of geometrically
irreducible components of fibres of $f$ introduced in
Lemma \ref{lemma-base-change-fibres-nr-geometrically-irreducible-components}.
Assume $f$ of finite type.
Let $y \in Y$ be a point. Then there exists a nonempty open
$V \subset \overline{\{y\}}$ such that $n_{X/Y}|_V$ is constant.
\end{lemma}

\begin{proof}
Let $Z$ be the reduced induced scheme structure on $\overline{\{y\}}$.
Let $f_Z : X_Z \to Z$ be the base change of $f$. Clearly it suffices to prove
the lemma for $f_Z$ and the generic point of $Z$. Hence we may assume that
$Y$ is an integral scheme, see
Properties, Lemma \ref{properties-lemma-characterize-integral}.
Our goal in this case is to produce a nonempty open $V \subset Y$ such that
$n_{X/Y}|_V$ is constant.

\medskip\noindent
We apply
Lemma \ref{lemma-make-components-generic-fibre-geometrically-irreducible}
to $f : X \to Y$ and we get $g : Y' \to V \subset Y$. As $g : Y' \to V$ is
surjective finite \'etale, in particular open (see
Morphisms, Lemma \ref{morphisms-lemma-etale-open}),
it suffices to prove that there exists an open $V' \subset Y'$
such that $n_{X'/Y'}|_{V'}$ is constant, see
Lemma \ref{lemma-base-change-fibres-nr-geometrically-irreducible-components}.
Thus we see that we may assume that all irreducible components of
the generic fibre $X_\eta$ are geometrically irreducible over $\kappa(\eta)$.

\medskip\noindent
At this point suppose that
$X_\eta = X_{1, \eta} \bigcup \ldots \bigcup X_{n, \eta}$
is the decomposition of the generic fibre into
(geometrically) irreducible components.
In particular $n_{X/Y}(\eta) = n$.
Let $X_i$ be the closure of
$X_{i, \eta}$ in $X$. After shrinking $Y$ we may assume that
$X = \bigcup X_i$, see
Lemma \ref{lemma-cover-generic-fibre-neighbourhood}.
After shrinking $Y$ some more we see that each fibre of
$f$ has at least $n$ irreducible components, see
Lemma \ref{lemma-irreducible-components-in-neighbourhood}.
Hence $n_{X/Y}(y) \geq n$ for all $y \in Y$.
After shrinking $Y$ some more we obtain that $X_{i, y}$
is geometrically irreducible for each $i$ and all $y \in Y$, see
Lemma \ref{lemma-geometrically-irreducible-generic-fibre}.
Since $X_y = \bigcup X_{i, y}$
this shows that $n_{X/Y}(y) \leq n$ and finishes the proof.
\end{proof}

\begin{lemma}
\label{lemma-nr-geom-irreducible-components-constructible}
Let $f : X \to Y$ be a morphism of schemes. Let
$n_{X/Y}$ be the function on $Y$ counting the numbers of geometrically
irreducible components of fibres of $f$ introduced in
Lemma \ref{lemma-base-change-fibres-nr-geometrically-irreducible-components}.
Assume $f$ of finite presentation. Then the level sets
$$
E_n = \{y \in Y \mid n_{X/Y}(y) = n\}
$$
of $n_{X/Y}$ are locally constructible in $Y$.
\end{lemma}

\begin{proof}
Fix $n$. Let $y \in Y$. We have to show that there exists an open neighbourhood
$V$ of $y$ in $Y$ such that $E_n \cap V$ is constructible in $V$. Thus we may
assume that $Y$ is affine. Write $Y = \text{Spec}(A)$ and
$A = \text{colim}\ A_i$ as a directed limit of finite type
$\mathbf{Z}$-algebras. By
Limits, Lemma \ref{limits-lemma-descend-finite-presentation}
we can find an $i$ and a morphism $f_i : X_i \to \text{Spec}(A_i)$ of
finite presentation whose base change to $Y$ recovers $f$. By
Lemma \ref{lemma-base-change-fibres-nr-geometrically-irreducible-components}
it suffices to prove the lemma for $f_i$. Thus we reduce to
the case where $Y$ is the spectrum of a Noetherian ring.

\medskip\noindent
We will use the criterion of
Topology, Lemma \ref{topology-lemma-characterize-constructible-Noetherian}
to prove that $E_n$ is constructible in case $Y$ is a Noetherian scheme.
To see this let $Z \subset Y$ be an irreducible closed subscheme.
We have to show that $E_n \cap Z$ either contains a nonempty open subset
or is not dense in $Z$. Let $\xi \in Z$ be the generic point. Then
Lemma \ref{lemma-nr-geom-irreducible-components-good}
shows that $n_{X/Y}$ is constant in a neighbourhood of $\xi$ in $Z$.
This clearly implies what we want.
\end{proof}













\section{Connected components of fibres}
\label{section-connected}

\begin{lemma}
\label{lemma-connected-components-in-neighbourhood}
Let $f : X \to Y$ be a morphism of schemes. Assume $Y$ irreducible with
generic point $\eta$ and $f$ of finite type. If $X_\eta$ has $n$
connected components, then there exists a nonempty open $V \subset Y$
such that for all $y \in V$ the fibre $X_y$ has at least $n$
connected components.
\end{lemma}

\begin{proof}
As the question is purely topological we may replace $X$ and $Y$ by
their reductions. In particular this implies that $Y$ is integral, see
Properties, Lemma \ref{properties-lemma-characterize-integral}.
Let $X_\eta = X_{1, \eta} \cup \ldots \cup X_{n, \eta}$
be the decomposition of $X_\eta$ into connected components.
Let $X_i \subset X$ be the reduced closed subscheme whose generic
fibre is $X_{i, \eta}$. Note that $Z_{i, j} = X_i \cap X_j$
is a closed subset of $X$ whose generic fibre $Z_{i, j, \eta}$ is empty.
Hence after shrinking $Y$ we may assume that $Z_{i, j} = \emptyset$, see
Lemma \ref{lemma-empty-generic-fibre}.
After shrinking $Y$ some more we may assume that
$X_y = \bigcup X_{i, y}$ for $y \in Y$, see
Lemma \ref{lemma-cover-generic-fibre-neighbourhood}.
Moreover, after shrinking $Y$ we may assume that each $X_i \to Y$
is flat and of finite presentation, see
Morphisms, Proposition \ref{morphisms-proposition-generic-flatness}.
The morphisms $X_i \to Y$ are open, see
Morphisms, Lemma \ref{morphisms-lemma-fppf-open}.
Thus there exists an open neighbourhood $V$ of $\eta$ which is contained
in $f(X_i)$ for each $i$.
For each $y \in V$ the schemes $X_{i, y}$ are
nonempty closed subsets of $X_y$, we have $X_y = \bigcup X_{i, y}$
and the intersections $Z_{i, j, y} = X_{i, y} \cap X_{j, y}$
are empty! Clearly this implies that
$X_y$ has at least $n$ connected components.
\end{proof}

\begin{lemma}
\label{lemma-base-change-fibres-geometrically-connected}
Let $f : X \to Y$ be a morphism of schemes.
Let $g : Y' \to Y$ be any morphism, and denote
$f' : X' \to Y'$ the base change of $f$.
Then
\begin{align*}
\{y' \in Y' \mid X'_{y'}\text{ is geometrically connected}\} \\
= g^{-1}(\{y \in Y \mid X_y\text{ is geometrically connected}\}).
\end{align*}
\end{lemma}

\begin{proof}
This comes down to the statement that for $y' \in Y'$ with image
$y \in Y$ the fibre $X'_{y'} = X_y \times_y y'$ is geometrically
connected over $\kappa(y')$ if and only if $X_y$ is geometrically connected
over $\kappa(y)$. This follows from
Varieties,
Lemma \ref{varieties-lemma-geometrically-connected-check-after-extension}.
\end{proof}

\begin{lemma}
\label{lemma-base-change-fibres-nr-geometrically-connected-components}
Let $f : X \to Y$ be a morphism of schemes. Let
$$
n_{X/Y} : Y \to \{0, 1, 2, 3, \ldots, \infty\}
$$
be the function which associates to $y \in Y$ the number of connected
components of $(X_y)_K$ where $K$ is a separably closed extension
of $\kappa(y)$. This is well defined and if $g : Y' \to Y$ is a morphism
then
$$
n_{X'/Y'} = n_{X/Y} \circ g
$$
where $X' \to Y'$ is the base change of $f$.
\end{lemma}

\begin{proof}
Suppose that $y' \in Y'$ has image $y \in Y$.
Suppose $K \supset \kappa(y)$ and $K' \supset \kappa(y')$ are separably
closed extensions. Then we may choose a commutative diagram
$$
\xymatrix{
K \ar[r] & K'' & K' \ar[l] \\
\kappa(y) \ar[u] \ar[rr] & & \kappa(y') \ar[u]
}
$$
of fields. The result follows as the morphisms of schemes
$$
\xymatrix{
(X'_{y'})_{K'} &
(X'_{y'})_{K''} = (X_y)_{K''} \ar[l] \ar[r] &
(X_y)_K
}
$$
induce bijections between connected components, see
Varieties,
Lemma \ref{varieties-lemma-separably-closed-field-connected-components}.
\end{proof}

\begin{lemma}
\label{lemma-geometrically-connected-generic-fibre}
Let $f : X \to Y$ be a morphism of schemes.
Assume
\begin{enumerate}
\item $Y$ is irreducible with generic point $\eta$,
\item $X_\eta$ is nonempty and geometrically connected, and
\item $f$ is of finite type.
\end{enumerate}
Then there exists a nonempty open subscheme $V \subset Y$
such that $X_V \to V$ has nonempty geometrically connected fibres.
\end{lemma}

\begin{proof}
Choose a diagram
$$
\xymatrix{
X' \ar[d]_{f'} \ar[r]_{g'} & X_V \ar[r] \ar[d] & X \ar[d]^f \\
Y' \ar[r]^g & V \ar[r] & Y
}
$$
as in
Lemma \ref{lemma-make-components-generic-fibre-geometrically-irreducible}.
Note that the generic fibre of $f'$ is nonempty and geometrically connected
(for example by
Lemma \ref{lemma-base-change-fibres-nr-geometrically-connected-components}).
Suppose that the lemma holds for the morphism $f'$. This means that
there exists a nonempty open $W \subset Y'$ such that every fibre of
$X' \to Y'$ over $W$ is nonempty and geometrically connected.
Then, as $g$ is an open morphism by
Morphisms, Lemma \ref{morphisms-lemma-etale-open}
all the fibres of $f$ at point of the nonempty open $V = g(W)$ are
nonempty and geometrically connected, see
Lemma \ref{lemma-base-change-fibres-nr-geometrically-connected-components}.
In this way we see that we may assume that the irreducible
components of the generic fibre $X_\eta$ are geometrically irreducible.

\medskip\noindent
Let $Y'$ be the reduction of $Y$, and set $X' = Y' \times_Y X$.
Then it suffices to prove the lemma for the morphism $X' \to Y'$
(for example by
Lemma \ref{lemma-base-change-fibres-nr-geometrically-connected-components}
once again). Since the generic fibre of $X' \to Y'$ is the same as the
generic fibre of $X \to Y$ we see that we may assume that $Y$ is
irreducible and reduced (i.e., integral, see
Properties, Lemma \ref{properties-lemma-characterize-integral})
and that the irreducible
components of the generic fibre $X_\eta$ are geometrically irreducible.

\medskip\noindent
At this point suppose that
$X_\eta = X_{1, \eta} \bigcup \ldots \bigcup X_{n, \eta}$
is the decomposition of the generic fibre into
(geometrically) irreducible components.
Let $X_i$ be the closure of $X_{i, \eta}$ in $X$.
After shrinking $Y$ we may assume that
$X = \bigcup X_i$, see
Lemma \ref{lemma-cover-generic-fibre-neighbourhood}.
Let $Z_{i, j} = X_i \cap X_j$.
Let
$$
\{1, \ldots, n\} \times \{1, \ldots, n\} = I \coprod J
$$
where $(i, j) \in I$ if $Z_{i, j, \eta} = \emptyset$ and
$(i, j) \in J$ if $Z_{i, j, \eta} \not = \emptyset$.
After shrinking $Y$ we may assume that $Z_{i, j} = \emptyset$
for all $(i, j) \in I$, see
Lemma \ref{lemma-empty-generic-fibre}.
After shrinking $Y$ we obtain that $X_{i, y}$
is geometrically irreducible for each $i$ and all $y \in Y$, see
Lemma \ref{lemma-geometrically-irreducible-generic-fibre}.
After shrinking $Y$ some more we achieve the situation where
each $Z_{i, j} \to Y$ is flat and of finite presentation for
all $(i, j) \in J$, see
Morphisms, Proposition \ref{morphisms-proposition-generic-flatness}.
This means that $f(Z_{i, j}) \subset Y$ is open, see
Morphisms, Lemma \ref{morphisms-lemma-fppf-open}.
We claim that
$$
V  = \bigcap\nolimits_{(i, j) \in J} f(Z_{i, j})
$$
works, i.e., that $X_y$ is geometrically connected for each
$y \in V$. Namely, the fact that $X_\eta$ is connected implies that
the equivalence relation generated by the pairs in $J$ has only
one equivalence class. Now if $y \in V$ and $K \supset \kappa(y)$
is a separably closed extension, then the irreducible components
of $(X_y)_K$ are the fibres $(X_{i, y})_K$. Moreover, we see by
construction and $y \in V$ that $(X_{i, y})_K$ meets $(X_{j, y})_K$
if and only $(i, j) \in J$. Hence the remark on equivalence classes
shows that $(X_y)_K$ is connected and we win.
\end{proof}

\begin{lemma}
\label{lemma-nr-geom-connected-components-good}
Let $f : X \to Y$ be a morphism of schemes. Let
$n_{X/Y}$ be the function on $Y$ counting the numbers of geometrically
connected components of fibres of $f$ introduced in
Lemma \ref{lemma-base-change-fibres-nr-geometrically-connected-components}.
Assume $f$ of finite type.
Let $y \in Y$ be a point. Then there exists a nonempty open
$V \subset \overline{\{y\}}$ such that $n_{X/Y}|_V$ is constant.
\end{lemma}

\begin{proof}
Let $Z$ be the reduced induced scheme structure on $\overline{\{y\}}$.
Let $f_Z : X_Z \to Z$ be the base change of $f$. Clearly it suffices to prove
the lemma for $f_Z$ and the generic point of $Z$. Hence we may assume that
$Y$ is an integral scheme, see
Properties, Lemma \ref{properties-lemma-characterize-integral}.
Our goal in this case is to produce a nonempty open $V \subset Y$ such that
$n_{X/Y}|_V$ is constant.

\medskip\noindent
We apply
Lemma \ref{lemma-make-components-generic-fibre-geometrically-irreducible}
to $f : X \to Y$ and we get $g : Y' \to V \subset Y$. As $g : Y' \to V$ is
surjective finite \'etale, in particular open (see
Morphisms, Lemma \ref{morphisms-lemma-etale-open}),
it suffices to prove that there exists an open $V' \subset Y'$
such that $n_{X'/Y'}|_{V'}$ is constant, see
Lemma \ref{lemma-base-change-fibres-nr-geometrically-irreducible-components}.
Thus we see that we may assume that all irreducible components of
the generic fibre $X_\eta$ are geometrically irreducible over $\kappa(\eta)$.
By
Varieties, Lemma
\ref{varieties-lemma-irreducible-components-geometrically-irreducible}
this implies that also the connected components of $X_\eta$ are
geometrically connected.

\medskip\noindent
At this point suppose that
$X_\eta = X_{1, \eta} \bigcup \ldots \bigcup X_{n, \eta}$
is the decomposition of the generic fibre into
(geometrically) connected components.
In particular $n_{X/Y}(\eta) = n$.
Let $X_i$ be the closure of
$X_{i, \eta}$ in $X$. After shrinking $Y$ we may assume that
$X = \bigcup X_i$, see
Lemma \ref{lemma-cover-generic-fibre-neighbourhood}.
After shrinking $Y$ some more we see that each fibre of
$f$ has at least $n$ connected components, see
Lemma \ref{lemma-connected-components-in-neighbourhood}.
Hence $n_{X/Y}(y) \geq n$ for all $y \in Y$.
After shrinking $Y$ some more we obtain that $X_{i, y}$
is geometrically connected for each $i$ and all $y \in Y$, see
Lemma \ref{lemma-geometrically-connected-generic-fibre}.
Since $X_y = \bigcup X_{i, y}$
this shows that $n_{X/Y}(y) \leq n$ and finishes the proof.
\end{proof}

\begin{lemma}
\label{lemma-nr-geom-connected-components-constructible}
Let $f : X \to Y$ be a morphism of schemes. Let
$n_{X/Y}$ be the function on $Y$ counting the numbers of geometrically
connected components of fibres of $f$ introduced in
Lemma \ref{lemma-base-change-fibres-nr-geometrically-connected-components}.
Assume $f$ of finite presentation. Then the level sets
$$
E_n = \{y \in Y \mid n_{X/Y}(y) = n\}
$$
of $n_{X/Y}$ are locally constructible in $Y$.
\end{lemma}

\begin{proof}
Fix $n$. Let $y \in Y$. We have to show that there exists an open neighbourhood
$V$ of $y$ in $Y$ such that $E_n \cap V$ is constructible in $V$. Thus we may
assume that $Y$ is affine. Write $Y = \text{Spec}(A)$ and
$A = \text{colim}\ A_i$ as a directed limit of finite type
$\mathbf{Z}$-algebras. By
Limits, Lemma \ref{limits-lemma-descend-finite-presentation}
we can find an $i$ and a morphism $f_i : X_i \to \text{Spec}(A_i)$ of
finite presentation whose base change to $Y$ recovers $f$. By
Lemma \ref{lemma-base-change-fibres-nr-geometrically-connected-components}
it suffices to prove the lemma for $f_i$. Thus we reduce to
the case where $Y$ is the spectrum of a Noetherian ring.

\medskip\noindent
We will use the criterion of
Topology, Lemma \ref{topology-lemma-characterize-constructible-Noetherian}
to prove that $E_n$ is constructible in case $Y$ is a Noetherian scheme.
To see this let $Z \subset Y$ be an irreducible closed subscheme.
We have to show that $E_n \cap Z$ either contains a nonempty open subset
or is not dense in $Z$. Let $\xi \in Z$ be the generic point. Then
Lemma \ref{lemma-nr-geom-connected-components-good}
shows that $n_{X/Y}$ is constant in a neighbourhood of $\xi$ in $Z$.
This clearly implies what we want.
\end{proof}

\begin{lemma}
\label{lemma-connected-flat-over-dvr}
Let $f : X \to S$ be a morphism of schemes.
Assume that
\begin{enumerate}
\item $S$ is the spectrum of a discrete valuation ring,
\item $f$ is flat,
\item $X$ is connected,
\item the closed fibre $X_s$ is reduced.
\end{enumerate}
Then the generic fibre $X_\eta$ is connected.
\end{lemma}

\begin{proof}
Write $Y = \text{Spec}(R)$ and let $\pi \in R$ be a uniformizer.
To get a contradiction assume that $X_\eta$ is disconnected.
This means there exists a nontrivial idempotent
$e \in \Gamma(X_\eta, \mathcal{O}_{X_\eta})$.
Let $U = \text{Spec}(A)$ be any affine open in $X$.
Note that $\pi$ is a nonzero divisor on $A$ as $A$ is flat over $R$, see
More on Algebra, Lemma \ref{more-algebra-lemma-flat-torsion-free}
for example. Then $e|_{U_\eta}$ corresponds to an element $e \in A[1/\pi]$.
Let $z \in A$ be an element such that $e = z/\pi^n$ with $n \geq 0$ minimal.
Note that $z^2 = \pi^nz$. This means that $z \bmod \pi A$ is nilpotent
if $n > 0$. By assumption $A/\pi A$ is reduced, and hence minimality of
$n$ implies $n = 0$. Thus we conclude that $e \in A$! In other words
$e \in \Gamma(X, \mathcal{O}_X)$. As $X$ is connected it follows
that $e$ is a trivial idempotent which is a contradiction.
\end{proof}







\section{Connected components meeting a section}
\label{section-connected-components}

\noindent
The results in this section are in particular applicable to a group scheme
$G \to S$ and its neutral section $e : S \to G$.

\begin{situation}
\label{situation-connected-along-section}
Here $f : X \to Y$ be a morphism of schemes, and
$s : Y \to X$ is a section of $f$.
For every $y \in Y$ we denote $X^0_y$ the connected component of $X_y$
containing $s(y)$. Finally, we set $X^0 = \bigcup_{y \in Y} X^0_y$.
\end{situation}

\begin{lemma}
\label{lemma-base-change-connected-along-section}
Let $f : X \to Y$, $s : Y \to X$ be as in
Situation \ref{situation-connected-along-section}.
If $g : Y' \to Y$ is any morphism, consider the base change diagram
$$
\xymatrix{
X' \ar[r]_{g'} \ar[d]^{f'} & X \ar[d]_f \\
Y' \ar@/^1pc/[u]^{s'} \ar[r]^g & Y \ar@/_1pc/[u]_s
}
$$
so that we obtain $(X')^0 \subset X'$.
Then $(X')^0 = (g')^{-1}(X^0)$.
\end{lemma}

\begin{proof}
Let $y' \in Y'$ with image $y \in Y$. We may think of
$X^0_y$ as a closed subscheme of $X_y$, see for example
Morphisms,
Definition \ref{morphisms-definition-scheme-structure-connected-component}.
As $s(y) \in X^0_y$ we conclude from
Varieties, Lemma
\ref{varieties-lemma-geometrically-connected-if-connected-and-point}
that $X_y^0$ is a geometrically connected scheme over $\kappa(y)$.
Hence $X_y^0 \times_y y' \to X'_{y'}$ is a connected closed subscheme
which contains $s'(y')$. Thus $X_y^0 \times_y y' \subset (X'_{y'})^0$.
The other inclusion $X_y^0 \times_y y' \supset (X'_{y'})^0$ is clear
as the image of $(X'_{y'})^0$ in $X_y$ is a connected subset of $X_y$ which
contains $s(y)$.
\end{proof}

\begin{lemma}
\label{lemma-connected-along-section-good}
Let $f : X \to Y$, $s : Y \to X$ be as in
Situation \ref{situation-connected-along-section}.
Assume $f$ of finite type. Let $y \in Y$ be a point.
Then there exists a nonempty open $V \subset \overline{\{y\}}$ such that
the inverse image of $X^0$ in the base change $X_V$ is open and closed in
$X_V$.
\end{lemma}

\begin{proof}
Let $Z \subset Y$ be the induced reduced closed subscheme
structure on $\overline{\{y\}}$. Let $f_Z : X_Z \to Z$ and $s_Z : Z \to X_Z$
be the base changes of $f$ and $s$. By
Lemma \ref{lemma-base-change-connected-along-section}
we have $(X_Z)^0 = (X^0)_Z$. Hence it suffices to prove the lemma for
the morphism $X_Z \to Z$ and the point $x \in X_Z$ which maps to the generic
point of $Z$. In other words we have reduced the problem to the case
where $Y$ is an integral scheme (see
Properties, Lemma \ref{properties-lemma-characterize-integral})
with generic point $\eta$. Our goal is to show that after shrinking
$Y$ the subset $X^0$ becomes an open and closed subset of $X$.

\medskip\noindent
Note that the scheme $X_\eta$ is of finite type over a field, hence Noetherian.
Thus its connected components are open as well as closed. Hence we may write
$X_\eta = X_\eta^0 \coprod T_\eta$ for some open and closed subset
$T_\eta$ of $X_\eta$. Next, let $T \subset X$ be the closure of $T_\eta$
and let $X^{00} \subset X$ be the closure of $X_\eta^0$. Note that
$T_\eta$, resp.\ $X^0_\eta$ is the generic fibre of $T$, resp.\ $X^{00}$,
see discussion preceding
Lemma \ref{lemma-cover-generic-fibre-neighbourhood}.
Moreover, that lemma implies that after shrinking $Y$ we may assume that
$X = X^{00} \cup T$ (set theoretically).
Note that $(T \cap X^{00})_\eta = T_\eta \cap X^0_\eta = \emptyset$.
Hence after shrinking $Y$ we may assume that $T \cap X^{00} = \emptyset$, see
Lemma \ref{lemma-empty-generic-fibre}.
In particular $X^{00}$ is open in $X$. Note that $X^0_\eta$ is connected
and has a rational point, namely $s(\eta)$, hence it is geometrically
connected, see
Varieties,
Lemma \ref{varieties-lemma-geometrically-connected-if-connected-and-point}.
Thus after shrinking $Y$ we may assume that all fibres of $X^{00} \to Y$
are geometrically connected, see
Lemma \ref{lemma-geometrically-connected-generic-fibre}.
At this point it follows that the fibres $X^{00}_y$ are
open, closed, and connected subsets of $X_y$ containing $\sigma(y)$.
It follows that $X^0 = X^{00}$ and we win.
\end{proof}

\begin{lemma}
\label{lemma-connected-along-section-locally-constructible}
Let $f : X \to Y$, $s : Y \to X$ be as in
Situation \ref{situation-connected-along-section}.
If $f$ is of finite presentation then $X^0$ is locally constructible
in $X$.
\end{lemma}

\begin{proof}
Let $x \in X$. We have to show that there exists an open neighbourhood
$U$ of $x$ such that $X^0 \cap U$ is constructible in $U$.
This reduces us to the case where $Y$ is affine.
Write $Y = \text{Spec}(A)$ and $A = \text{colim} A_i$ as a directed
limit of finite type $\mathbf{Z}$-algebras. By
Limits, Lemma \ref{limits-lemma-descend-finite-presentation}
we can find an $i$ and a morphism $f_i : X_i \to \text{Spec}(A_i)$ of
finite presentation, endowed with a section $s_i : \text{Spec}(A_i) \to X_i$
whose base change to $Y$ recovers $f$ and the section $s$. By
Lemma \ref{lemma-base-change-connected-along-section}
it suffices to prove the lemma for $f_i, s_i$. Thus we reduce to
the case where $Y$ is the spectrum of a Noetherian ring.

\medskip\noindent
Assume $Y$ is a Noetherian affine scheme. Since $f$ is of finite presentation,
i.e., of finite type, we see that $X$ is a Noetherian scheme too, see
Morphisms, Lemma \ref{morphisms-lemma-finite-type-noetherian}.
In order to prove the lemma in
this case it suffices to show that for every irreducible closed subset
$Z \subset X$ the intersection $Z \cap X^0$ either contains a nonempty
open of $Z$ or is not dense in $Z$, see
Topology, Lemma \ref{topology-lemma-characterize-constructible-Noetherian}.
Let $x \in Z$ be the generic point, and let $y = f(x)$. By
Lemma \ref{lemma-connected-along-section-good}
there exists a nonempty open subset $V \subset \overline{\{y\}}$ such
that $X^0 \cap X_V$ is open and closed in $X_V$. Since
$f(Z) \subset \overline{\{y\}}$ and $f(x) = y \in V$ we see that
$W = f^{-1}(V) \cap Z$ is a nonempty open subset of $Z$. It follows that
$X^0 \cap W$ is open and closed in $W$. Since $W$ is irreducible
we see that $X^0 \cap W$ is either empty or equal to $W$.
This proves the lemma.
\end{proof}

\begin{lemma}
\label{lemma-connected-along-section-open-neighbourhood}
Let $f : X \to Y$, $s : Y \to X$ be as in
Situation \ref{situation-connected-along-section}.
Let $y \in Y$ be a point.
Assume
\begin{enumerate}
\item $f$ is of finite presentation and flat, and
\item the fibre $X_y$ is geometrically reduced.
\end{enumerate}
Then $X^0$ is a neighbourhood of $X^0_y$ in $X$.
\end{lemma}

\begin{proof}
We may replace $Y$ with an affine open neighbourhood of $y$.
Write $Y = \text{Spec}(A)$ and $A = \text{colim} A_i$ as a directed
limit of finite type $\mathbf{Z}$-algebras. By
Limits, Lemma \ref{limits-lemma-descend-finite-presentation}
we can find an $i$ and a morphism $f_i : X_i \to \text{Spec}(A_i)$ of
finite presentation, endowed with a section $s_i : \text{Spec}(A_i) \to X_i$
whose base change to $Y$ recovers $f$ and the section $s$.
After possibly increasing $i$ we may also assume that $f_i$ is flat, see
Limits, Lemma \ref{limits-lemma-descend-flat-finite-presentation}.
Let $y_i$ be the image of $y$ in $Y_i$. Note that
$X_y = (X_{i, y_i}) \times_{y_i} y$. Hence $X_{i, y_i}$ is geometrically
reduced, see
Varieties, Lemma \ref{varieties-lemma-geometrically-reduced-upstairs}.
By
Lemma \ref{lemma-base-change-connected-along-section}
it suffices to prove the lemma for the system $f_i, s_i, y_i \in Y_i$.
Thus we reduce to the case where $Y$ is the spectrum of a Noetherian ring.

\medskip\noindent
Assume $Y$ is the spectrum of a Noetherian ring.
Since $f$ is of finite presentation,
i.e., of finite type, we see that $X$ is a Noetherian scheme too, see
Morphisms, Lemma \ref{morphisms-lemma-finite-type-noetherian}.
Let $x \in X^0$ be a point lying over $y$. By
Topology, Lemma \ref{topology-lemma-construcible-neighbourhood-Noetherian}
it suffices to prove that for any irreducible closed $Z \subset X$
passing through $x$ the intersection $X^0 \cap Z$ is dense in $Z$.
In particular it suffices to prove that the generic point $x' \in Z$
is in $X^0$. By
Properties, Lemma \ref{properties-lemma-locally-Noetherian-specialization-dvr}
we can find a discrete valuation ring $R$ and a morphism
$\text{Spec}(R) \to X$ which maps the special point to $x$ and
the generic point to $x'$. We are going to think of $\text{Spec}(R)$
as a scheme over $Y$ via the composition $\text{Spec}(R) \to X \to Y$. By
Lemma \ref{lemma-base-change-connected-along-section}
we have that $(X_R)^0$ is the inverse image of $X^0$.
By construction we have a second section $t : \text{Spec}(R) \to X_R$
(besides the base change $s_R$ of $s$)
of the structure morphism $X_R \to \text{Spec}(R)$ such that
$t(\eta_R)$ is a point of $X_R$ which maps to $x'$ and
$t(0_R)$ is a point of $X_R$ which maps to $x$. Note that
$t(0_R)$ is in $(X_R)^0$ and that $t(\eta_R) \leadsto t(0_R)$.
Thus it suffices to prove that this implies that $t(\eta_R) \in (X_R)^0$.
Hence it suffices to prove the lemma in the case where $Y$
is the spectrum of a discrete valuation ring and $y$ its closed point.

\medskip\noindent
Assume $Y$ is the spectrum of a discrete valuation ring and $y$ is its closed
point. Our goal is to prove that $X^0$ is a neighbourhood of $X^0_y$.
Note that $X^0_y$ is open and closed in $X_y$ as $X_y$ has finitely
many irreducible components. Hence the complement $C = X_y \setminus X_y^0$
is closed in $X$. Thus $U = X \setminus C$ is an open neighbourhood of
$X^0_y$ and $U^0 = X^0$. Hence it suffices to prove the result for the
morphism $U \to Y$. In other words, we may assume that
$X_y$ is connected. Suppose that $X$ is disconnected, say
$X = X_1 \amalg \ldots \amalg X_n$ is a decomposition into connected
components. Then $s(Y)$ is completely contained in one of the $X_i$.
Say $s(Y) \subset X_1$. Then $X^0 \subset X_1$. Hence we may replace
$X$ by $X_1$ and assume that $X$ is connected. At this point
Lemma \ref{lemma-connected-flat-over-dvr}
implies that $X_\eta$ is connected, i.e., $X^0 = X$ and we win.
\end{proof}

\begin{lemma}
\label{lemma-connected-along-section-open}
Let $f : X \to Y$, $s : Y \to X$ be as in
Situation \ref{situation-connected-along-section}.
Assume
\begin{enumerate}
\item $f$ is of finite presentation and flat, and
\item all fibres of $f$ are geometrically reduced.
\end{enumerate}
Then $X^0$ is open in $X$.
\end{lemma}

\begin{proof}
This is an immediate consequence of
Lemma \ref{lemma-connected-along-section-open-neighbourhood}.
\end{proof}






\section{Dimension of fibres}
\label{section-dimension}

\begin{lemma}
\label{lemma-dimension-in-neighbourhood}
Let $f : X \to Y$ be a morphism of schemes. Assume $Y$ irreducible with
generic point $\eta$ and $f$ of finite type. If $X_\eta$ has dimension $n$,
then there exists a nonempty open $V \subset Y$
such that for all $y \in V$ the fibre $X_y$ has dimension $n$.
\end{lemma}

\begin{proof}
Let $Z = \{x \in X \mid \dim_x(X_{f(x)}) > n \}$. By
Morphisms, Lemma \ref{morphisms-lemma-openness-bounded-dimension-fibres}
this is a closed subset of $X$. By assumption $Z_\eta = \emptyset$.
Hence by
Lemma \ref{lemma-empty-generic-fibre}
we may shrink $Y$ and assume that $Z = \emptyset$. Let
$Z' = \{x \in X \mid \dim_x(X_{f(x)}) > n - 1 \} =
\{x \in X \mid \dim_x(X_{f(x)}) = n\}$. As before this is a closed subset
of $X$. By assumption we have $Z'_\eta \not = \emptyset$. Hence after
shrinking $Y$ we may assume that $Z' \to Y$ is surjective, see
Lemma \ref{lemma-nonempty-generic-fibre}.
Hence we win.
\end{proof}

\begin{lemma}
\label{lemma-base-change-dimension-fibres}
Let $f : X \to Y$ be a morphism of finite type. Let
$$
n_{X/Y} : Y \to \{0, 1, 2, 3, \ldots, \infty\}
$$
be the function which associates to $y \in Y$ the dimension of $X_y$.
If $g : Y' \to Y$ is a morphism then
$$
n_{X'/Y'} = n_{X/Y} \circ g
$$
where $X' \to Y'$ is the base change of $f$.
\end{lemma}

\begin{proof}
This follows from
Morphisms, Lemma \ref{morphisms-lemma-dimension-fibre-after-base-change}.
\end{proof}

\begin{lemma}
\label{lemma-dimension-fibres-constructible}
Let $f : X \to Y$ be a morphism of schemes. Let
$n_{X/Y}$ be the function on $Y$ giving the dimension of fibres of $f$
introduced in
Lemma \ref{lemma-base-change-dimension-fibres}.
Assume $f$ of finite presentation. Then the level sets
$$
E_n = \{y \in Y \mid n_{X/Y}(y) = n\}
$$
of $n_{X/Y}$ are locally constructible in $Y$.
\end{lemma}

\begin{proof}
Fix $n$. Let $y \in Y$. We have to show that there exists an open neighbourhood
$V$ of $y$ in $Y$ such that $E_n \cap V$ is constructible in $V$. Thus we may
assume that $Y$ is affine. Write $Y = \text{Spec}(A)$ and
$A = \text{colim}\ A_i$ as a directed limit of finite type
$\mathbf{Z}$-algebras. By
Limits, Lemma \ref{limits-lemma-descend-finite-presentation}
we can find an $i$ and a morphism $f_i : X_i \to \text{Spec}(A_i)$ of
finite presentation whose base change to $Y$ recovers $f$. By
Lemma \ref{lemma-base-change-dimension-fibres}
it suffices to prove the lemma for $f_i$. Thus we reduce to
the case where $Y$ is the spectrum of a Noetherian ring.

\medskip\noindent
We will use the criterion of
Topology, Lemma \ref{topology-lemma-characterize-constructible-Noetherian}
to prove that $E_n$ is constructible in case $Y$ is a Noetherian scheme.
To see this let $Z \subset Y$ be an irreducible closed subscheme.
We have to show that $E_n \cap Z$ either contains a nonempty open subset
or is not dense in $Z$. Let $\xi \in Z$ be the generic point. Then
Lemma \ref{lemma-dimension-in-neighbourhood}
shows that $n_{X/Y}$ is constant in a neighbourhood of $\xi$ in $Z$.
This implies what we want.
\end{proof}









\section{Limit arguments}
\label{section-limits}

\noindent
Some lemmas involving limits of schemes, and Noetherian approximation.
We stick mostly to the affine case. Some of these lemmas are special
cases of lemmas in the chapter on limits.

\begin{lemma}
\label{lemma-Noetherian-approximation}
Let $f : X \to S$ be a morphism of affine schemes, which is of finite
presentation. Then there exists a cartesian diagram
$$
\xymatrix{
X_0 \ar[d]_{f_0} & X \ar[l]^g \ar[d]^f \\
S_0 & S \ar[l]
}
$$
such that
\begin{enumerate}
\item $X_0$, $S_0$ are affine schemes,
\item $S_0$ of finite type over $\mathbf{Z}$,
\item $f_0$ is finite of finite type.
\end{enumerate}
\end{lemma}

\begin{proof}
Write $S = \text{Spec}(A)$ and $X = \text{Spec}(B)$.
As $f$ is of finite presentation we see that
$B$ is of finite presentation as an $A$-algebra, see
Morphisms,
Lemma \ref{morphisms-lemma-locally-finite-presentation-characterize}.
Thus the lemma follows from
Algebra, Lemma \ref{algebra-lemma-limit-module-finite-presentation}.
\end{proof}

\begin{lemma}
\label{lemma-Noetherian-approximation-module}
Let $f : X \to S$ be a morphism of affine schemes, which is of finite
presentation. Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module
of finite presentation. Then there exists a diagram as in
Lemma \ref{lemma-Noetherian-approximation}
such that there exists a coherent $\mathcal{O}_{X_0}$-module $\mathcal{F}_0$
with $g^*\mathcal{F}_0 = \mathcal{F}$.
\end{lemma}

\begin{proof}
Write $S = \text{Spec}(A)$, $X = \text{Spec}(B)$, and
$\mathcal{F} = \widetilde{M}$. As $f$ is of finite presentation we see that
$B$ is of finite presentation as an $A$-algebra, see
Morphisms,
Lemma \ref{morphisms-lemma-locally-finite-presentation-characterize}.
As $\mathcal{F}$ is of finite presentation over $\mathcal{O}_X$ we see that
$M$ is of finite presentation as a $B$-module, see
Properties, Lemma \ref{properties-lemma-finite-presentation-module}.
Thus the lemma follows from
Algebra, Lemma \ref{algebra-lemma-limit-module-finite-presentation}.
\end{proof}

\begin{lemma}
\label{lemma-Noetherian-approximation-flat-module}
Let $f : X \to S$ be a morphism of affine schemes, which is of finite
presentation. Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module
of finite presentation and flat over $S$. Then we may choose a diagram as in
Lemma \ref{lemma-Noetherian-approximation-module}
and sheaf $\mathcal{F}_0$ such that in addition $\mathcal{F}_0$
is flat over $S_0$.
\end{lemma}

\begin{proof}
Write $S = \text{Spec}(A)$, $X = \text{Spec}(B)$, and
$\mathcal{F} = \widetilde{M}$. As $f$ is of finite presentation we see that
$B$ is of finite presentation as an $A$-algebra, see
Morphisms,
Lemma \ref{morphisms-lemma-locally-finite-presentation-characterize}.
As $\mathcal{F}$ is of finite presentation over $\mathcal{O}_X$ we see that
$M$ is of finite presentation as a $B$-module, see
Properties, Lemma \ref{properties-lemma-finite-presentation-module}.
As $\mathcal{F}$ is flat over $S$ we see that $M$ is flat over $A$, see
Morphisms, Lemma \ref{morphisms-lemma-flat-module-characterize}.
Thus the lemma follows from
Algebra, Lemma \ref{algebra-lemma-flat-finite-presentation-limit-flat}.
\end{proof}

\begin{lemma}
\label{lemma-Noetherian-approximation-flat}
Let $f : X \to S$ be a morphism of affine schemes, which is of finite
presentation and flat. Then there exists a diagram as in
Lemma \ref{lemma-Noetherian-approximation}
such that in addition $f_0$ is flat.
\end{lemma}

\begin{proof}
This is a special case of
Lemma \ref{lemma-Noetherian-approximation-flat-module}.
\end{proof}

\begin{lemma}
\label{lemma-Noetherian-approximation-smooth}
Let $f : X \to S$ be a morphism of affine schemes, which is smooth.
Then there exists a diagram as in
Lemma \ref{lemma-Noetherian-approximation}
such that in addition $f_0$ is smooth.
\end{lemma}

\begin{proof}
Write $S = \text{Spec}(A)$, $X = \text{Spec}(B)$, and
as $f$ is smooth we see that $B$ is smooth as an $A$-algebra, see
Morphisms,
Lemma \ref{morphisms-lemma-smooth-characterize}.
Hence the lemma follows from
Algebra, Lemma \ref{algebra-lemma-finite-presentation-fs-Noetherian}
and the fact that a ring map is smooth if and only if it is
formally smooth and of finite presentation, see
Algebra, Lemmas \ref{algebra-lemma-smooth-formally-smooth} and
\ref{algebra-lemma-formally-smooth-smooth}.
\end{proof}

\begin{lemma}
\label{lemma-Noetherian-approximation-geometrically-reduced}
Let $f : X \to S$ be a morphism of affine schemes, which is 
of finite presentation with geometrically reduced fibres.
Then there exists a diagram as in
Lemma \ref{lemma-Noetherian-approximation}
such that in addition $f_0$ has geometrically reduced fibres.
\end{lemma}

\begin{proof}
Apply
Lemma \ref{lemma-Noetherian-approximation}
to get a cartesian diagram
$$
\xymatrix{
X_0 \ar[d]_{f_0} & X \ar[l]^g \ar[d]^f \\
S_0 & S \ar[l]_h
}
$$
of affine schemes with $X_0 \to S_0$ a finite type morphism of
schemes of finite type over $\mathbf{Z}$. By
Lemma \ref{lemma-geometrically-reduced-constructible}
the set $E \subset S_0$ of points where the fibre of
$f_0$ is geometrically reduced is a constructible subset. By
Lemma \ref{lemma-base-change-fibres-geometrically-reduced}
we have $h(S) \subset E$. Write $S_0 = \text{Spec}(A_0)$ and
$S = \text{Spec}(A)$. Write $A = \text{colim}_i\ A_i$ as a
direct colimit of finite type $A_0$-algebras. By
Limits, Lemma \ref{limits-lemma-limit-contained-in-constructible}
we see that $\text{Spec}(A_i) \to S_0$ has image contained in $E$
for some $i$. After replacing $S_0$ by $\text{Spec}(A_i)$ and
$X_0$ by $X_0 \times_{S_0} \text{Spec}(A_i)$ we see that
all fibres of $f_0$ are geometrically reduced.
\end{proof}

\begin{lemma}
\label{lemma-Noetherian-approximation-geometrically-irreducible}
Let $f : X \to S$ be a morphism of affine schemes, which is 
of finite presentation with geometrically irreducible fibres.
Then there exists a diagram as in
Lemma \ref{lemma-Noetherian-approximation}
such that in addition $f_0$ has geometrically irreducible fibres.
\end{lemma}

\begin{proof}
Apply
Lemma \ref{lemma-Noetherian-approximation}
to get a cartesian diagram
$$
\xymatrix{
X_0 \ar[d]_{f_0} & X \ar[l]^g \ar[d]^f \\
S_0 & S \ar[l]_h
}
$$
of affine schemes with $X_0 \to S_0$ a finite type morphism of
schemes of finite type over $\mathbf{Z}$. By
Lemma \ref{lemma-nr-geom-irreducible-components-constructible}
the set $E \subset S_0$ of points where the fibre of
$f_0$ is geometrically irreducible is a constructible subset. By
Lemma \ref{lemma-base-change-fibres-geometrically-irreducible}
we have $h(S) \subset E$. Write $S_0 = \text{Spec}(A_0)$ and
$S = \text{Spec}(A)$. Write $A = \text{colim}_i\ A_i$ as a
direct colimit of finite type $A_0$-algebras. By
Limits, Lemma \ref{limits-lemma-limit-contained-in-constructible}
we see that $\text{Spec}(A_i) \to S_0$ has image contained in $E$
for some $i$. After replacing $S_0$ by $\text{Spec}(A_i)$ and
$X_0$ by $X_0 \times_{S_0} \text{Spec}(A_i)$ we see that
all fibres of $f_0$ are geometrically irreducible.
\end{proof}

\begin{lemma}
\label{lemma-Noetherian-approximation-geometrically-connected}
Let $f : X \to S$ be a morphism of affine schemes, which is 
of finite presentation with geometrically connected fibres.
Then there exists a diagram as in
Lemma \ref{lemma-Noetherian-approximation}
such that in addition $f_0$ has geometrically connected fibres.
\end{lemma}

\begin{proof}
Apply
Lemma \ref{lemma-Noetherian-approximation}
to get a cartesian diagram
$$
\xymatrix{
X_0 \ar[d]_{f_0} & X \ar[l]^g \ar[d]^f \\
S_0 & S \ar[l]_h
}
$$
of affine schemes with $X_0 \to S_0$ a finite type morphism of
schemes of finite type over $\mathbf{Z}$. By
Lemma \ref{lemma-nr-geom-connected-components-constructible}
the set $E \subset S_0$ of points where the fibre of
$f_0$ is geometrically connected is a constructible subset. By
Lemma \ref{lemma-base-change-fibres-geometrically-connected}
we have $h(S) \subset E$. Write $S_0 = \text{Spec}(A_0)$ and
$S = \text{Spec}(A)$. Write $A = \text{colim}_i\ A_i$ as a
direct colimit of finite type $A_0$-algebras. By
Limits, Lemma \ref{limits-lemma-limit-contained-in-constructible}
we see that $\text{Spec}(A_i) \to S_0$ has image contained in $E$
for some $i$. After replacing $S_0$ by $\text{Spec}(A_i)$ and
$X_0$ by $X_0 \times_{S_0} \text{Spec}(A_i)$ we see that
all fibres of $f_0$ are geometrically connected.
\end{proof}

\begin{lemma}
\label{lemma-Noetherian-approximation-dimension-d}
Let $d \geq 0$ be an integer.
Let $f : X \to S$ be a morphism of affine schemes, which is 
of finite presentation all of whose fibres have dimension $d$.
Then there exists a diagram as in
Lemma \ref{lemma-Noetherian-approximation}
such that in addition all fibres of $f_0$ have dimension $d$.
\end{lemma}

\begin{proof}
Apply
Lemma \ref{lemma-Noetherian-approximation}
to get a cartesian diagram
$$
\xymatrix{
X_0 \ar[d]_{f_0} & X \ar[l]^g \ar[d]^f \\
S_0 & S \ar[l]_h
}
$$
of affine schemes with $X_0 \to S_0$ a finite type morphism of
schemes of finite type over $\mathbf{Z}$. By
Lemma \ref{lemma-dimension-fibres-constructible}
the set $E \subset S_0$ of points where the fibre of
$f_0$ has dimension $d$ is a constructible subset. By
Lemma \ref{lemma-base-change-dimension-fibres}
we have $h(S) \subset E$. Write $S_0 = \text{Spec}(A_0)$ and
$S = \text{Spec}(A)$. Write $A = \text{colim}_i\ A_i$ as a
direct colimit of finite type $A_0$-algebras. By
Limits, Lemma \ref{limits-lemma-limit-contained-in-constructible}
we see that $\text{Spec}(A_i) \to S_0$ has image contained in $E$
for some $i$. After replacing $S_0$ by $\text{Spec}(A_i)$ and
$X_0$ by $X_0 \times_{S_0} \text{Spec}(A_i)$ we see that
all fibres of $f_0$ have dimension $d$.
\end{proof}

\begin{lemma}
\label{lemma-Noetherian-approximation-standard-syntomic}
Let $f : X \to S$ be a morphism of affine schemes, which is 
standard syntomic (see
Morphisms, Definition \ref{morphisms-definition-syntomic}).
Then there exists a diagram as in
Lemma \ref{lemma-Noetherian-approximation}
such that in addition $f_0$ is standard syntomic.
\end{lemma}

\begin{proof}
This lemma is an improvement of the awkward
Algebra,
Lemma \ref{algebra-lemma-relative-global-complete-intersection-Noetherian}.
Write $X = \text{Spec}(B)$ and $S = \text{Spec}(A)$.
By assumption we may write $B = A[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$
such that every nonzero fibre ring of $A \to B$ has dimension $n - c$.
Let $A_0 \subset A$ be a finite type $\mathbf{Z}$-subalgebra
such that the coefficients of the polynomials $f_j$ are contained in 
$A_0$. Set $B_0 = A_0[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$.
Let
$$
E = \{\mathfrak p_0 \subset A_0 \mid
\dim(B_0 \otimes_{A_0} \kappa(\mathfrak p_0) = n - c \}
$$
By
Lemma \ref{lemma-dimension-fibres-constructible}
the set $E$ is constructible. By assumption and
Lemma \ref{lemma-base-change-dimension-fibres}
the morphism $\text{Spec}(A) \to \text{Spec}(A_0)$ has image contained in $E$.
Write $A = \text{colim}_i\ A_i$ as a
direct colimit of finite type $A_0$-algebras. By
Limits, Lemma \ref{limits-lemma-limit-contained-in-constructible}
we see that $\text{Spec}(A_i) \to \text{Spec}(A_0)$ has image contained in $E$
for some $i$. After replacing $A_0$ by $A_i$ and
$B_0$ by $B_0 \otimes_{A_0} A_i$ we see that
all nonempty fibre rings of $A_0 \to B_0$ have dimension $n - c$.
Hence $A_0 \to B_0$ is a relative global complete intersection.
\end{proof}

\begin{lemma}
\label{lemma-Noetherian-approximation-combine}
(Noetherian approximation and combining properties.)
Let $P$, $Q$ be properties of morphisms of schemes which are stable
under base change. Let $f : X \to S$ be a morphism of finite presentation
of affine schemes. Assume we can find cartesian diagrams
$$
\vcenter{
\xymatrix{
X_1 \ar[d]_{f_1} & X \ar[l] \ar[d]^f \\
S_1 & S \ar[l]
}
}
\quad\text{and}\quad
\vcenter{
\xymatrix{
X_2 \ar[d]_{f_2} & X \ar[l] \ar[d]^f \\
S_2 & S \ar[l]
}
}
$$
of affine schemes, with $S_1$, $S_2$ of finite type over $\mathbf{Z}$
and $f_1$, $f_2$ of finite type such that $f_1$ has property $P$
and $f_2$ has property $Q$. Then we can find a cartesian diagram
$$
\xymatrix{
X_0 \ar[d]_{f_0} & X \ar[l] \ar[d]^f \\
S_0 & S \ar[l]
}
$$
of affine schemes with $S_0$ of finite type over $\mathbf{Z}$
and $f_0$ of finite type such that $f_0$ has both property $P$ and
property $Q$.
\end{lemma}

\begin{proof}
The given pair of diagrams correspond to cocartesian diagrams of rings
$$
\vcenter{
\xymatrix{
B_1 \ar[r] & B \\
A_1 \ar[u] \ar[r] & A \ar[u]
}
}
\quad\text{and}\quad
\vcenter{
\xymatrix{
B_2 \ar[r] & B \\
A_2 \ar[u] \ar[r] & A \ar[u]
}
}
$$
Let $A_0 \subset A$ be a finite type $\mathbf{Z}$-subalgebra of $A$
containing the image of both $A_1 \to A$ and $A_2 \to A$. Such a subalgebra
exists because by assumption both $A_1$ and $A_2$ are of finite type over
$\mathbf{Z}$. Note that the rings $B_{0, 1} = B_1 \otimes_{A_1} A_0$
and $B_{0, 2} = B_2 \otimes_{A_2} A_0$ are finite type $A_0$-algebras
with the property that
$B_{0, 1} \otimes_{A_0} A \cong B \cong B_{0, 2} \otimes_{A_0} A$
as $A$-algebras. As $A$ is the directed colimit of its finite type
$A_0$-subalgebras, by
Limits, Lemma \ref{limits-lemma-descend-finite-presentation}
we may assume after enlarging $A_0$ that there exists an isomorphism
$B_{0, 1} \cong B_{0, 2}$ as $A_0$-algebras. Since properties $P$ and $Q$
are assumed stable under base change we conclude that setting
$S_0 = \text{Spec}(A_0)$ and
$$
X_0 = X_1 \times_{S_1} S_0 =
\text{Spec}(B_{0, 1}) \cong \text{Spec}(B_{0, 2}) = X_2 \times_{S_2} S_0
$$
works.
\end{proof}












\section{\'Etale neighbourhoods}
\label{section-etale-neighbourhoods}

\noindent
It turns out that some properties of morphisms are easier to study
after doing an \'etale base change. It is convenient to introduce the
following terminology.

\begin{definition}
\label{definition-etale-neighbourhood}
Let $S$ be a scheme. Let $s \in S$ be a point.
\begin{enumerate}
\item An {\it \'etale neighbourhood of $(S, s)$} is a
pair $(U, u)$ together with an \'etale morphism
of schemes $\varphi : U \to S$ such that $\varphi(u) = s$.
\item A {\it morphism of \'etale neighbourhoods} $f : (V, v) \to (U, u)$
of $(S, s)$ is simply a morphism of $S$-schemes $f : V \to U$ such
that $f(v) = u$.
\item An {\it elementary \'etale neighbourhood} is an \'etale neighbourhood
$\varphi : (U, u) \to (S, s)$ such that $\kappa(s) = \kappa(u)$.
\end{enumerate}
\end{definition}

\noindent
If $f : (V, v) \to (U, u)$ is a morphism of \'etale
neighbourhoods, then $f$ is automatically \'etale, see
Morphisms, Lemma \ref{morphisms-lemma-etale-permanence}.
Hence it turns $(V, v)$ into an \'etale neighbourhood of
$(U, u)$. Of course, since the composition of \'etale morphisms
is \'etale (Morphisms, Lemma \ref{morphisms-lemma-composition-etale})
we see that conversely any \'etale neighbourhood $(V, v)$ of
$(U, u)$ is an \'etale neighbourhood of $(S, s)$ as well.
We also remark that if $U \subset S$ is an open neighbourood
of $s$, then $(U, s) \to (S, s)$ is an \'etale neighbourhood.
This follows from the fact that an open immersion is
\'etale (Morphisms, Lemma \ref{morphisms-lemma-open-immersion-etale}).
We will use these remarks without further mention throughout this
section.

\medskip\noindent
Note that $\kappa(s) \subset \kappa(u)$ is a finite separable extension
if $(U, u) \to (S, s)$ is an \'etale neighbourhood,
see Morphisms, Lemma \ref{morphisms-lemma-etale-at-point}.

\begin{lemma}
\label{lemma-realize-presecribed-residue-field-extension-etale}
Let $S$ be a scheme.
Let $s \in S$.
Let $\kappa(s) \subset k$ be a finite separable field extension.
Then there exists an \'etale neighbourhood $(U, u) \to (S, s)$
such that the field extension $\kappa(s) \subset \kappa(u)$ is
isomorphic to $\kappa(s) \subset k$.
\end{lemma}

\begin{proof}
We may assume $S$ is affine.
In this case the lemma follows from
Algebra, Lemma \ref{algebra-lemma-make-etale-map-prescribed-residue-field}.
\end{proof}

\begin{lemma}
\label{lemma-etale-neighbourhoods-not-quite-filtered}
Let $S$ be a scheme, and let $s$ be a geometric point of $S$.
The category of \'etale neighborhoods has the following properties:
\begin{enumerate}
\item Let $(U_i, u_i)_{i=1, 2}$ be two \'etale neighborhoods of
$s$ in $S$. Then there exists a third \'etale neighborhood
$(U, u)$ and morphisms
$(U, u) \to (U_i, u_i)$, $i = 1, 2$.
\item Let $h_1, h_2: (U, u) \to (U', u')$ be two
morphisms between \'etale neighborhoods of $s$.
Assume $h_1$, $h_2$ induce the same map $\kappa(u') \to \kappa(u)$ of residue
fields. Then there exist an \'etale neighborhood $(U'', u'')$ and a morphism
$h : (U'', u'') \to (U, u)$
which equalizes $h_1$ and $h_2$, i.e., such that
$h_1 \circ h = h_2 \circ h$.
\end{enumerate}
\end{lemma}

\begin{proof}
For part (1), consider the fibre product $U = U_1 \times_S U_2$.
It is \'etale over both $U_1$ and $U_2$ because \'etale morphisms are
preserved under base change, see
Morphisms, Lemma \ref{morphisms-lemma-base-change-etale}.
There is a point of $U$ mapping to both $u_1$ and $u_2$ for example
by the description of points of a fibre product in
Schemes, Lemma \ref{schemes-lemma-points-fibre-product}.
For part (2), define $U''$ as the fibre product
$$
\xymatrix{
U'' \ar[r] \ar[d] & U \ar^{(h_1,h_2)}[d] \\
U' \ar^-\Delta[r] & U' \times_S U'.
}
$$
Since $h_1$ and $h_2$ induce the same map of residue fields
$\kappa(u') \to \kappa(u)$ there exists a point $u'' \in U''$
lying over $u'$ with $\kappa(u'') = \kappa(u')$.
In particular $U'' \not = \emptyset$.
Moreover, since $U'$ is \'etale over $S$, so is the fibre product
$U'\times_S U'$ (see
Morphisms, Lemmas \ref{morphisms-lemma-base-change-etale} and
\ref{morphisms-lemma-composition-etale}).
Hence the vertical arrow $(h_1, h_2)$ is \'etale by
Morphisms, Lemma \ref{morphisms-lemma-etale-permanence}.
Therefore $U''$ is \'etale over $U'$ by base change, and hence also
\'etale over $S$ (because compositions of \'etale morphisms are \'etale).
Thus $(U'', u'')$ is a solution to the problem.
\end{proof}

\begin{lemma}
\label{lemma-elementary-etale-neighbourhoods}
Let $S$ be a scheme, and let $s$ be a geometric point of $S$.
The category of elementary \'etale neighborhoods of $(S, s)$
is cofiltered (see
Categories, Definition \ref{categories-definition-codirected}).
\end{lemma}

\begin{proof}
This is immediate from the definitions and
Lemma \ref{lemma-etale-neighbourhoods-not-quite-filtered}.
\end{proof}

\begin{lemma}
\label{lemma-describe-henselization}
Let $S$ be a scheme. Let $s \in S$. Then we have
$$
\mathcal{O}_{S, s}^h =
\text{colim}_{(U, u)}\ \mathcal{O}(U)
$$
where the colimit is over the filtered category which is opposite to the
category of elementary \'etale neighbourhoods $(U, u)$ of $(S, s)$.
\end{lemma}

\begin{proof}
Let $\text{Spec}(A) \subset S$ be an affine neighbourhood of $s$.
Let $\mathfrak p \subset A$ be the prime ideal corresponding to $s$.
With these choices we have canonical isomorphisms
$\mathcal{O}_{S, s} = A_{\mathfrak p}$ and $\kappa(s) = \kappa(\mathfrak p)$.
A cofinal system of elementary \'etale neighbourhoods is given by those
elementary \'etale neighbourhoods $(U, u)$ such that $U$ is affine and
$U \to S$ factors through $\text{Spec}(A)$. In other words, we see that
the right hand side is equal to $\text{colim}_{(B, \mathfrak q)}\ B$
where the colimit is over \'etale $A$-algebras $B$ endowed with a prime
$\mathfrak q$ lying over $\mathfrak p$ with
$\kappa(\mathfrak p) = \kappa(\mathfrak q)$.
Thus the lemma follows from
Algebra, Lemma \ref{algebra-lemma-henselization-different}.
\end{proof}




\section{Slicing smooth morphisms}
\label{section-etale-over-smooth}

\noindent
In this section we explain a result that roughly states that
smooth coverings of a scheme $S$ can be refined by \'etale coverings.
The technique to prove this relies on a slicing argument.

\begin{lemma}
\label{lemma-slice-smooth-given-element}
Let $f : X \to S$ be a morphism of schemes.
Let $x \in X$ be a point with image $s \in S$.
Let $h \in \mathfrak m_x \subset \mathcal{O}_{X, x}$.
Assume
\begin{enumerate}
\item $f$ is smooth at $x$, and
\item the image $\text{d}\overline{h}$ of $\text{d}h$ in
$$
\Omega_{X_s/s, x} \otimes_{\mathcal{O}_{X_s, x}} \kappa(x) =
\Omega_{X/S, x} \otimes_{\mathcal{O}_{X, x}} \kappa(x)
$$
is nonzero.
\end{enumerate}
Then there exists an affine open neighbourhood $U \subset X$ of $x$
such that $h$ comes from $h \in \Gamma(U, \mathcal{O}_U)$ and such
that $D = V(h)$ is an effective Cartier divisor in $U$ with $x \in D$ and
$D \to S$ smooth.
\end{lemma}

\begin{proof}
AS $f$ is smooth at $x$ we may assume, after replacing $X$ by an open
neighbourhood of $x$ that $f$ is smooth. In particular we see that
$f$ is flat and locally of finite presentation. By
Lemma \ref{lemma-slice-given-element}
we already know there exists an open neighbourhood $U \subset X$ of $x$
such that $h$ comes from $h \in \Gamma(U, \mathcal{O}_U)$ and such
that $D = V(h)$ is an effective Cartier divisor in $U$ with $x \in D$ and
$D \to S$ flat and of finite presentation. By
Morphisms, Lemma \ref{morphisms-lemma-differentials-relative-immersion}
we have a short exact sequence
$$
\mathcal{C}_{D/U} \to i^*\Omega_{U/S} \to \Omega_{D/S} \to 0
$$
where $i : D \to U$ is the closed immersion and $\mathcal{C}_{D/U}$
is the conormal sheaf of $D$ in $U$. As $D$ is an effective Cartier
divisor cut out by $h \in \Gamma(U, \mathcal{O}_U)$ we see that
$\mathcal{C}_{D/U} = h \cdot \mathcal{O}_S$. Since $U \to S$ is smooth
the sheaf $\Omega_{U/S}$ is finite locally free, hence its pullback
$i^*\Omega_{U/S}$ is finite locally free also. The first arrow of
the sequence maps the free generator $h$ to the section $\text{d}h|_D$
of $i^*\Omega_{U/S}$ which has nonzero value in the fibre
$\Omega_{U/S, x} \otimes \kappa(x)$ by assumption. By right exactness
of $\otimes \kappa(x)$ we conclude that
$$
\dim_{\kappa(x)} \left( \Omega_{D/S, x} \otimes \kappa(x) \right)
=
\dim_{\kappa(x)} \left( \Omega_{U/S, x} \otimes \kappa(x) \right) - 1.
$$
By
Morphisms, Lemma \ref{morphisms-lemma-smooth-at-point}
we see that $\Omega_{U/S, x} \otimes \kappa(x)$ can be generated by
at most $\dim_x(U_s)$ elements. By the displayed formula we see that
$\Omega_{D/S, x} \otimes \kappa(x)$ can be generated by at most
$\dim_x(U_s) - 1$ elements. Note that
$\dim_x(D_s) = \dim_x(U_s) - 1$ for example because
$\dim(\mathcal{O}_{D_s, x}) = \dim(\mathcal{O}_{U_s, x}) - 1$ by
Algebra, Lemma \ref{algebra-lemma-one-equation}
(also $D_s \subset U_s$ is effective Cartier, see
Divisors, Lemma \ref{divisors-lemma-relative-Cartier})
and then using
Morphisms, Lemma \ref{morphisms-lemma-dimension-fibre-at-a-point}.
Thus we conclude that $\Omega_{D/S, x} \otimes \kappa(x)$ can be generated
by at most $\dim_x(D_s)$ elements and we conclude that $D \to S$
is smooth at $x$ by
Morphisms, Lemma \ref{morphisms-lemma-smooth-at-point}
again. After shrinking $U$ we get that $D \to S$ is smooth and we win.
\end{proof}

\begin{lemma}
\label{lemma-slice-smooth-once}
Let $f : X \to S$ be a morphism of schemes.
Let $x \in X$ be a point with image $s \in S$.
Assume
\begin{enumerate}
\item $f$ is smooth at $x$, and
\item the map
$$
\Omega_{X_s/s, x} \otimes_{\mathcal{O}_{X_s, x}} \kappa(x)
\longrightarrow
\Omega_{\kappa(x)/\kappa(s)}
$$
has a nonzero kernel.
\end{enumerate}
Then there exists an affine open neighbourhood $U \subset X$ of $x$
and an effective Cartier divisor $D \subset U$ containing $x$ such that
$D \to S$ is smooth.
\end{lemma}

\begin{proof}
Write $k = \kappa(s)$ and $R = \mathcal{O}_{X_s, x}$.
Denote $\mathfrak m$ the maximal ideal of $R$ and
$\kappa = R/\mathfrak m$ so that $\kappa = \kappa(x)$.
As formation of modules of differentials commutes with localization (see
Algebra, Lemma \ref{algebra-lemma-differentials-localize})
we have $\Omega_{X_s/s, x} = \Omega_{R/k}$. By
Algebra, Lemma \ref{algebra-lemma-differential-seq}
there is an exact sequence
$$
\mathfrak m/\mathfrak m^2 \xrightarrow{\text{d}}
\Omega_{R/k} \otimes_R \kappa \to
\Omega_{\kappa/k} \to 0.
$$
Hence if (2) holds, there exists an element $\overline{h} \in \mathfrak m$
such that $\text{d}\overline{h}$ is nonzero. Choose a lift
$h \in \mathcal{O}_{X, x}$ of $\overline{h}$ and apply
Lemma \ref{lemma-slice-smooth-given-element}.
\end{proof}

\begin{remark}
\label{remark-necessary-condition-slice-smooth}
The second condition in
Lemma \ref{lemma-slice-smooth-once}
is necessary even if $x$ is a closed point of a positive
dimensional fibre. An example is the following: Let $k$ be a field
of characteristic $p > 0$ which is imperfect. Let $a \in k$ be an
element which is not a $p$th power. Let
$\mathfrak m = (x, y^p - a) \subset k[x, y]$. This corresponds to a closed
point $w$ of $X = \mathbf{A}^2_k$. Set $S = \mathbf{A}^1_k$ and
let $f : X \to S$ be the morphism corresponding to $k[x] \to k[x, y]$.
Then there does not exist any commutative diagram
$$
\xymatrix{
S' \ar[rr]_h \ar[rd]_g & & X \ar[ld]^f \\
& S
}
$$
with $g$ \'etale and $w$ in the image of $h$. This is clear as the residue
field extension $\kappa(f(w)) \subset \kappa(w)$ is purely inseparable,
but for any $s' \in S'$ with $g(s') = f(w)$ the extension
$\kappa(f(w)) \subset \kappa(s')$ would be separable.
\end{remark}

\noindent
If you assume the residue field extension is separble then the
phenomenon of
Remark \ref{remark-necessary-condition-slice-smooth}
does not happen. Here is the precise result.

\begin{lemma}
\label{lemma-slice-smooth-once-separable-residue-field-extension}
Let $f : X \to S$ be a morphism of schemes.
Let $x \in X$ be a point with image $s \in S$.
Assume
\begin{enumerate}
\item $f$ is smooth at $x$,
\item the residue field extension $\kappa(s) \subset \kappa(x)$
is separable, and
\item $x$ is not a generic point of $X_s$.
\end{enumerate}
Then there exists an affine open neighbourhood $U \subset X$ of $x$
and an effective Cartier divisor $D \subset U$ containing $x$ such that
$D \to S$ is smooth.
\end{lemma}

\begin{proof}
Write $k = \kappa(s)$ and $R = \mathcal{O}_{X_s, x}$.
Denote $\mathfrak m$ the maximal ideal of $R$ and
$\kappa = R/\mathfrak m$ so that $\kappa = \kappa(x)$.
As formation of modules of differentials commutes with localization (see
Algebra, Lemma \ref{algebra-lemma-differentials-localize})
we have $\Omega_{X_s/s, x} = \Omega_{R/k}$. By assumption (2) and
Algebra, Lemma \ref{algebra-lemma-computation-differential}
the map 
$$
\text{d} :
\mathfrak m/\mathfrak m^2
\longrightarrow
\Omega_{R/k} \otimes_R \kappa(\mathfrak m)
$$
is injective. Assumption (3) implies that
$\mathfrak m/\mathfrak m^2 \not = 0$.
Thus there exists an element $\overline{h} \in \mathfrak m$
such that $\text{d}\overline{h}$ is nonzero. Choose a lift
$h \in \mathcal{O}_{X, x}$ of $\overline{h}$ and apply
Lemma \ref{lemma-slice-smooth-given-element}.
\end{proof}

\noindent
The subscheme $Z$ constructed in the following lemma is really a complete
intersection in an affine open neighbourhood of $x$. If we ever need this
we will explicitly formulate a separate lemma stating this fact.

\begin{lemma}
\label{lemma-slice-smooth}
Let $f : X \to S$ be a morphism of schemes.
Let $x \in X$ be a point with image $s \in S$.
Assume
\begin{enumerate}
\item $f$ is smooth at $x$, and
\item $x$ is a closed point of $X_s$ and $\kappa(s) \subset \kappa(x)$
is separable.
\end{enumerate}
Then there exists an immersion $Z \to X$ containing $x$ such that
\begin{enumerate}
\item $Z \to S$ is \'etale, and
\item $Z_s = \{x\}$ set theoretically.
\end{enumerate}
\end{lemma}

\begin{proof}
We may and do replace $S$ by an affine open neighbourhoof of $s$.
We may and do replace $X$ by an affine open neighbourhood of $x$
such that $X \to S$ is smooth.
We will prove the lemma for smooth morphisms of affines
by induction on $d = \dim_x(X_s)$.

\medskip\noindent
The case $d = 0$. In this case we show that we may take $Z$ to be
an open neighbourhood of $x$. Namely, if $d = 0$, then $X \to S$
is quasi-finite at $x$, see
Morphisms, Lemma \ref{morphisms-lemma-locally-quasi-finite-rel-dimension-0}.
Hence there exists an affine open neighbourhood $U \subset X$ such
that $U \to S$ is quasi-finite, see
Morphisms, Lemma \ref{morphisms-lemma-quasi-finite-points-open}.
Thus after replacing $X$ by $U$ we see that
$X$ is quasi-finite and smooth over $S$, hence
smooth of relative dimension $0$ over $S$, hence
\'etale over $S$. Moreover, the fibre $X_s$ is a finite
discrete set. Hence after replacing $X$ by a further affine open neigbourhood
of $X$ we see that that $f^{-1}(\{s\}) = \{x\}$ (because the topology
on $X_s$ is induced from the topology on $X$, see
Schemes, Lemma \ref{schemes-lemma-fibre-topological}).
This proves the lemma in this case.

\medskip\noindent
Next, assume $d > 0$. Note that because $x$ is a closed point of its
fibre the extension $\kappa(s) \subset \kappa(x)$ is finite (by the
Hilbert Nullstellensatz, see
Morphisms, Lemma \ref{morphisms-lemma-closed-point-fibre-locally-finite-type}).
Thus we see $\Omega_{\kappa(x)/\kappa(s)} = 0$ as this holds for
algebraic separable field extensions.
Thus we may apply
Lemma \ref{lemma-slice-smooth-once}
to find a diagram
$$
\xymatrix{
D \ar[r] \ar[rrd] & U \ar[r] \ar[rd] & X \ar[d] \\
& & S
}
$$
with $x \in D$. Note that
$\dim_x(D_s) = \dim_x(X_s) - 1$ for example because
$\dim(\mathcal{O}_{D_s, x}) = \dim(\mathcal{O}_{X_s, x}) - 1$ by
Algebra, Lemma \ref{algebra-lemma-one-equation}
(also $D_s \subset X_s$ is effective Cartier, see
Divisors, Lemma \ref{divisors-lemma-relative-Cartier})
and then using
Morphisms, Lemma \ref{morphisms-lemma-dimension-fibre-at-a-point}.
Thus the morphism $D \to S$ is smooth with
$\dim_x(D_s) = \dim_x(X_s) - 1 = d - 1$. By induction hypothesis
we can find an immersion $Z \to D$ as desired, which finishes the proof.
\end{proof}

\begin{lemma}
\label{lemma-etale-neighbourhood-dominates-smooth}
Let $f : X \to S$ be a smooth morphism of schemes.
Let $s \in S$ be a point in the image of $f$.
Then there exists an \'etale neighbourhood $(S', s') \to (S, s)$
and a $S$-morphism $S' \to X$.
\end{lemma}

\begin{proof}%
[First proof of Lemma \ref{lemma-etale-neighbourhood-dominates-smooth}]
By assumption $X_s \not = \emptyset$. By
Varieties, Lemma \ref{varieties-lemma-smooth-separable-closed-points-dense}
there exists a closed point $x \in X_s$ such that $\kappa(x)$
is a finite separable field extension of $\kappa(s)$.
Hence by
Lemma \ref{lemma-slice-smooth}
there exists an immersion $Z \to X$ such that $Z \to S$ is \'etale and such
that $x \in Z$. Take $(S' , s') = (Z, x)$.
\end{proof}

\begin{proof}%
[Second proof of Lemma \ref{lemma-etale-neighbourhood-dominates-smooth}]
Pick an point $x \in X$ with $f(x) = s$.
Choose a diagram
$$
\xymatrix{
X \ar[d] & U \ar[l] \ar[d] \ar[r]_-\pi & \mathbf{A}^d_V \ar[ld] \\
Y & V \ar[l]
}
$$
with $\pi$ \'etale, $x \in U$ and $V = \text{Spec}(R)$ affine, see
Morphisms, Lemma \ref{morphisms-lemma-smooth-etale-over-affine-space}.
In particular $s \in V$. The morphism
$\pi : U \to \mathbf{A}^d_V$ is open, see
Morphisms, Lemma \ref{morphisms-lemma-etale-open}.
Thus $W = \pi(V) \cap \mathbf{A}^d_s$ is a nonempty open subset of
$\mathbf{A}^d_s$. Let $w \in W$ be a point with $\kappa(s) \subset \kappa(w)$
finite separable, see
Varieties, Lemma \ref{varieties-lemma-affine-space-over-field}.
By
Algebra, Lemma \ref{algebra-lemma-dim-affine-space}
there exist $d$ elements
$\overline{f}_1, \ldots, \overline{f}_d \in \kappa(s)[x_1, \ldots, x_d]$
which generate the maximal ideal corresponding to $w$ in
$\kappa(s)[x_1, \ldots, x_n]$.
After replacing $R$ by a principal localization
we may assume there are $f_1, \ldots, f_d \in R[x_1, \ldots, x_d]$
which map to 
$\overline{f}_1, \ldots, \overline{f}_d \in \kappa(s)[x_1, \ldots, x_d]$.
Consider the $R$-algebra
$$
R' = R[x_1, \ldots, x_d]/(f_1, \ldots, f_d)
$$
and set $S' = \text{Spec}(R')$. By construction we have a closed
immersion $j : S' \to \mathbf{A}^d_V$ over $V$.
By construction the fibre of $S' \to V$ over $s$ is a single
point $s'$ whose residue field is finite separable over $\kappa(s)$.
Let $\mathfrak q' \subset R'$ be the corresponding prime. By
Algebra, Lemma \ref{algebra-lemma-localize-relative-complete-intersection}
we see that $(R')_g$ is a relative global complete intersection over $R$
for some $g \in R'$, $g \not \in \mathfrak q$.
Thus $S' \to V$ is flat and of finite presentation in a
neighbourhood of $s'$, see
Algebra, Lemma \ref{algebra-lemma-relative-global-complete-intersection}.
By construction the scheme theoretic fibre
of $S' \to V$ over $s$ is $\text{Spec}(\kappa(s'))$. Hence it follows from
Morphisms, Lemma \ref{morphisms-lemma-etale-at-point}
that $S' \to S$ is \'etale at $s'$. Set
$$
S'' = U \times_{\pi, \mathbf{A}^d_V, j} S'.
$$
By construction there exists a point $s'' \in S''$ which maps to
$s'$ via the projection $p : S'' \to S'$. Note that $p$ is \'etale
as the base change of the \'etale morphism $\pi$, see
Morphisms, Lemma \ref{morphisms-lemma-base-change-etale}.
Choose a small affine neighbourhood $S''' \subset S''$ of $s''$
which maps into the nonempty open neighbourhood of $s' \in S'$
where the morphism $S' \to S$ is \'etale. Then the \'etale neighbourhood
$(S''', s'') \to (S, s)$ is a solution to the problem posed by the lemma.
\end{proof}

\noindent
The following lemma shows that sheaves for the smooth topology are
the same thing as sheaves for the \'etale topology.

\begin{lemma}
\label{lemma-etale-dominates-smooth}
Let $S$ be a scheme. Let $\mathcal{U} = \{S_i \to S\}_{i \in I}$ be a smooth
covering of $S$, see
Topologies, Definition \ref{topologies-definition-smooth-covering}.
Then there exists an \'etale covering $\mathcal{V} = \{T_j \to S\}_{j \in J}$
(see
Topologies, Definition \ref{topologies-definition-etale-covering})
which refines (see
Sites, Definition \ref{sites-definition-morphism-coverings})
$\mathcal{U}$.
\end{lemma}

\begin{proof}
For every $s \in S$ there exists an $i \in I$ such that $s$ is in
the image of $S_i \to S$. By
Lemma \ref{lemma-etale-neighbourhood-dominates-smooth}
we can find an \'etale morphism $g_s : T_s \to S$ such that $s \in g_s(T)_s$
and such that $g_s$ factors through $S_i \to S$. Hence
$\{T_s \to S\}$ is an \'etale covering of $S$ that refines $\mathcal{U}$.
\end{proof}




\section{Finite free locally dominates \'etale}
\label{section-finite-free-over-etale}

\noindent
In this section we explain a result that roughly states that
\'etale coverings of a scheme $S$ can be refined by Zariski coverings
of finite locally free covers of $S$.

\begin{lemma}
\label{lemma-dominate-etale-neighbourhood-finite-flat}
Let $S$ be a scheme. Let $s \in S$.
Let $f : (U, u) \to (S, s)$ be an \'etale neighbourhood.
There exists an affine open neighbourhood $s \in V \subset S$
and a surjective, finite locally free morphism $\pi : T \to V$
such that for every $t \in \pi^{-1}(s)$ there exists an
open neighbourhood $t \in W_t \subset T$ and a commutative
diagram
$$
\xymatrix{
T \ar[d]^\pi & W_t \ar[l] \ar[rr]_{h_t} \ar[rd] & & U \ar[dl] \\
V \ar[rr] & & S
}
$$
with $h_t(t) = u$.
\end{lemma}

\begin{proof}
The problem is local on $S$ hence we may replace $S$ by any
open neighbourhood of $s$.
We may also replace $U$ by an open neighbourhood of $u$.
Hence, by Morphisms, Lemma \ref{morphisms-lemma-etale-locally-standard-etale}
we may assume that
$U \to S$ is a standard \'etale morphism of affine schemes.
In this case the lemma (with $V = S$) follows from
Algebra, Lemma \ref{algebra-lemma-standard-etale-finite-flat-Zariski}.
\end{proof}

\begin{lemma}
\label{lemma-dominate-etale-affine-finite-flat}
Let $f : U \to S$ be a surjective \'etale morphism of affine schemes.
There exists a surjective, finite locally free morphism
$\pi : T \to S$ and a finite open covering
$T = T_1 \cup \ldots \cup T_n$ such that each
$T_i \to S$ factors through $U \to S$. Diagram:
$$
\xymatrix{
& \coprod T_i  \ar[rd] \ar[ld] & \\
T \ar[rd]^\pi & & U \ar[ld]_f \\
& S &
}
$$
where the south-west arrow is a Zariski-covering.
\end{lemma}

\begin{proof}
This is a restatement of
Algebra, Lemma \ref{algebra-lemma-etale-finite-flat-zariski}.
\end{proof}

\begin{remark}
\label{remark-topologies}
In terms of topologies the lemmas above mean the following.
Let $S$ be any scheme. Let $\{f_i : U_i \to S\}$ be an \'etale covering
of $S$. There exists a Zariski open covering $S = \bigcup V_j$,
for each $j$ a finite locally free, surjective morphism
$W_j \to V_j$, and for each $j$ a Zariski open covering
$\{W_{j, k} \to W_j\}$ such that the family
$\{W_{j, k} \to S\}$ refines the given \'etale covering
$\{f_i : U_i \to S\}$. What does this mean in practice?
Well, for example, suppose we have a descend problem which we
know how to solve for Zariski coverings and for fppf coverings
of the form $\{\pi : T \to S\}$ with $\pi$ finite locally free
and surjective. Then this descend problem has an affirmative
answer for \'etale coverings as well. This trick was used by
Gabber in his proof that $\text{Br}(X) = \text{Br}'(X)$
for an affine scheme $X$, see \cite{Hoobler}.
\end{remark}




\section{\'Etale localization of quasi-finite morphisms}
\label{section-etale-localization}

\noindent
Now we come to a series of lemmas around the theme
``quasi-finite morphisms become finite after \'etale localization''.
The general idea is the following. Suppose given a morphism
of schemes $f : X \to S$ and a point $s \in S$. Let
$\varphi : (U, u) \to (S, s)$ be an \'etale neighbourhood of $s$ in $S$.
Consider the fibre product $X_U = U \times_S X$ and the
basic diagram
\begin{equation}
\label{equation-basic-diagram}
\vcenter{
\xymatrix{
V \ar[r] \ar[dr] & X_U \ar[d] \ar[r] & X \ar[d]^f \\
& U \ar[r]^\varphi & S
}
}
\end{equation}
where $V \subset X_U$ is open.
Is there some standard model for the morphism $f_U : X_U \to U$, or for
the morphism $V \to U$ for suitable opens $V$?
Of course the answer is no in general. But for quasi-finite morphisms
we can say something.

\begin{lemma}
\label{lemma-etale-makes-quasi-finite-finite-at-point}
Let $f : X \to S$ be a morphism of schemes.
Let $x \in X$. Set $s = f(x)$.
Assume that
\begin{enumerate}
\item $f$ is locally of finite type, and
\item $x \in X_s$ is isolated\footnote{In the presence of (1)
this means that $f$ is
quasi-finite at $x$, see
Morphisms, Lemma \ref{morphisms-lemma-quasi-finite-at-point-characterize}.}.
\end{enumerate}
Then there exist
\begin{enumerate}
\item[(a)] an elementary \'etale neighbourhood $(U, u) \to (S, s)$,
\item[(b)] an open subscheme $V \subset X_U$
(see \ref{equation-basic-diagram})
\end{enumerate}
such that
\begin{enumerate}
\item[(\romannumeral1)] $V \to U$ is a finite morphism,
\item[(\romannumeral2)] there is a unique point $v$ of $V$
mapping to $u$ in $U$, and
\item[(\romannumeral3)] the point $v$ maps to $x$
under the morphism $X_U \to X$, inducing $\kappa(x) = \kappa(v)$.
\end{enumerate}
Moreover, for any elementary \'etale neighbourhood $(U', u') \to (U, u)$
setting $V' = U' \times_U V \subset X_{U'}$ the triple $(U', u', V')$
satisfies the properties
(\romannumeral1), (\romannumeral2), and (\romannumeral3) as well.
\end{lemma}

\begin{proof}
Let $Y \subset X$, $W \subset S$ be affine opens such that
$f(Y) \subset W$ and such that $x \in Y$. Note that $x$ is
also an isolated point of the fibre of the morphism $f|_Y : Y \to W$.
If we can prove the theorem for $f|_Y : Y \to W$, then the
theorem follows for $f$. Hence we reduce to the case where
$f$ is a morphism of affine schemes. This case is
Algebra, Lemma \ref{algebra-lemma-etale-makes-quasi-finite-finite-one-prime}.
\end{proof}

\noindent
In the preceding and following lemma we do not assume that the morphism
$f$ is separated. This means that the opens $V$, $V_i$ created
in them are not necessarily closed in $X_U$. Moreover, if we choose
the neighbourhood $U$ to be affine, then each $V_i$ is affine, but
the intersections $V_i \cap V_j$ need not be affine (in the nonseparated
case).

\begin{lemma}
\label{lemma-etale-makes-quasi-finite-finite-multiple-points}
Let $f : X \to S$ be a morphism of schemes.
Let $x_1, \ldots, x_n \in X$ be points having the same image $s$ in $S$.
Assume that
\begin{enumerate}
\item $f$ is locally of finite type, and
\item $x_i \in X_s$ is isolated for $i = 1, \ldots, n$.
\end{enumerate}
Then there exist
\begin{enumerate}
\item[(a)] an elementary \'etale neighbourhood $(U, u) \to (S, s)$,
\item[(b)] for each $i$ an open subscheme $V_i \subset X_U$,
\end{enumerate}
such that for each $i$ we have
\begin{enumerate}
\item[(\romannumeral1)] $V_i \to U$ is a finite morphism,
\item[(\romannumeral2)] there is a unique point $v_i$ of $V_i$
mapping to $u$ in $U$, and
\item[(\romannumeral3)] the point $v_i$ maps to $x_i$ in $X$ and
$\kappa(x_i) = \kappa(v_i)$.
\end{enumerate}
\end{lemma}

\begin{proof}
We will use induction on $n$.
Namely, suppose $(U,u) \to (S, s)$ and $V_i \subset X_U$,
$i = 1, \ldots, n - 1$ work for $x_1, \ldots, x_{n - 1}$. Since
$\kappa(s) = \kappa(u)$ the fibre $(X_U)_u = X_s$. Hence there
exists a unique point $x'_n \in X_u \subset X_U$ corresponding to
$x_n \in X_s$. Also $x'_n$ is isolated in $X_u$. Hence by
Lemma \ref{lemma-etale-makes-quasi-finite-finite-at-point} there
exists an elementary \'etale neighbourhood $(U', u') \to (U, u)$
and an open $V_n \subset X_{U'}$ which works for $x'_n$ and hence
for $x_n$.
By the final assertion of
Lemma \ref{lemma-etale-makes-quasi-finite-finite-at-point}
the open subschemes $V'_i = U'\times_U V_i$ for $i = 1, \ldots, n - 1$ still
work with respect to $x_1, \ldots, x_{n - 1}$. Hence we win.
\end{proof}

\noindent
If we allow a nontrivial field extension $\kappa(s) \subset \kappa(u)$, i.e.,
general \'etale neighbourhoods, then we can split the points as follows.

\begin{lemma}
\label{lemma-etale-makes-quasi-finite-finite-multiple-points-var}
Let $f : X \to S$ be a morphism of schemes.
Let $x_1, \ldots, x_n \in X$ be points having the same image $s$ in $S$.
Assume that
\begin{enumerate}
\item $f$ is locally of finite type, and
\item $x_i \in X_s$ is isolated for $i = 1, \ldots, n$.
\end{enumerate}
Then there exist
\begin{enumerate}
\item[(a)] an \'etale neighbourhood $(U, u) \to (S, s)$,
\item[(b)] for each $i$ an integer $m_i$ and
open subschemes $V_{i, j} \subset X_U$, $j = 1, \ldots, m_i$
\end{enumerate}
such that we have
\begin{enumerate}
\item[(\romannumeral1)] each $V_{i, j} \to U$ is a finite morphism,
\item[(\romannumeral2)] there is a unique point $v_{i, j}$ of $V_{i, j}$
mapping to $u$ in $U$ with $\kappa(u) \subset \kappa(v_{i, j})$
finite purely inseparable,
\item[(\romannumeral4)] if $v_{i,j} = v_{i', j'}$, then $i = i'$ and
$j = j'$, and
\item[(\romannumeral3)] the points $v_{i, j}$ map to $x_i$ in $X$ and
no other points of $(X_U)_u$ map to $x_i$.
\end{enumerate}
\end{lemma}

\begin{proof}
This proof is a variant of the proof of
Algebra, Lemma \ref{algebra-lemma-etale-makes-quasi-finite-finite-variant}
in the language of schemes.
By Morphisms, Lemma \ref{morphisms-lemma-quasi-finite-at-point-characterize}
the morphism $f$ is quasi-finite at each of the points $x_i$.
Hence $\kappa(s) \subset \kappa(x_i)$ is finite for each $i$
(Morphisms, Lemma \ref{morphisms-lemma-residue-field-quasi-finite}).
For each $i$, let $\kappa(s) \subset L_i \subset \kappa(x_i)$
be the subfield such that $L_i/\kappa(s)$ is separable, and
$\kappa(x_i)/L_i$ is purely inseparable. Choose a finite Galois
extension $\kappa(s) \subset L$ such that there exist
$\kappa(s)$-embeddings $L_i \to L$ for $i = 1, \ldots, n$.
Choose an \'etale neighbourhood $(U, u) \to (S, s)$ such that
$L \cong \kappa(u)$ as $\kappa(s)$-extensions
(Lemma \ref{lemma-realize-presecribed-residue-field-extension-etale}).

\medskip\noindent
Let $y_{i, j}$, $j = 1, \ldots, m_i$ be the points of $X_U$
lying over $x_i \in X$ and $u \in U$. By
Schemes, Lemma \ref{schemes-lemma-points-fibre-product}
these points $y_{i, j}$ correspond exactly to the primes in the rings
$\kappa(u) \otimes_{\kappa(s)} \kappa(x_i)$. This also
explains why there are finitely many; in fact
$m_i = [L_i : \kappa(s)]$ but we do not need this.
By our choice of
$L$ (and elementary field theory)
we see that $\kappa(u) \subset \kappa(y_{i, j})$ is
finite purely inseparable for each pair $i, j$.
Also, by Morphisms, Lemma \ref{morphisms-lemma-base-change-quasi-finite}
for example, the morphism
$X_U \to U$ is quasi-finite at the points $y_{i, j}$ for
all $i, j$.

\medskip\noindent
Apply Lemma \ref{lemma-etale-makes-quasi-finite-finite-multiple-points}
to the morphism $X_U \to U$, the point $u \in U$
and the points $y_{i, j} \in (X_U)_u$. This gives an \'etale neighbourhood
$(U', u') \to (U, u)$ with $\kappa(u) = \kappa(u')$ and
opens $V_{i, j} \subset X_{U'}$ with the properties
(\romannumeral1), (\romannumeral2), and (\romannumeral3)
of that lemma. We claim that the \'etale neighbourhood
$(U', u') \to (S, s)$ and the opens $V_{i, j} \subset X_{U'}$
are a solution to the problem posed by the lemma.
We omit the verifications.
\end{proof}

\begin{lemma}
\label{lemma-etale-splits-off-quasi-finite-part-technical}
Let $f : X \to S$ be a morphism of schemes.
Let $s \in S$. Let $x_1, \ldots, x_n \in X_s$. Assume that
\begin{enumerate}
\item $f$ is locally of finite type,
\item $f$ is separated, and
\item $x_1, \ldots, x_n$ are pairwise distinct isolated points of $X_s$.
\end{enumerate}
Then there exists an elementary \'etale neighbourhood $(U, u) \to (S, s)$
and a decomposition
$$
U \times_S X = W \coprod V_1 \coprod \ldots \coprod V_n
$$
into open and closed subschemes such that the morphisms
$V_i \to U$ are finite, the fibres of $V_i \to U$ over $u$ are
singletons $\{v_i\}$, each $v_i$ maps to $x_i$ with
$\kappa(x_i) = \kappa(v_i)$, and the fibre of $W \to U$
over $u$ contains no points mapping to any of the $x_i$.
\end{lemma}

\begin{proof}
Choose $(U, u) \to (S, s)$ and $V_i \subset X_U$ as in
Lemma \ref{lemma-etale-makes-quasi-finite-finite-multiple-points}.
Since $X_U \to U$ is separated
(Morphisms, Lemma \ref{schemes-lemma-separated-permanence})
and $V_i \to U$ is finite hence proper
(Morphisms, Lemma \ref{morphisms-lemma-finite-proper})
we see that $V_i \subset X_U$ is closed by
Morphisms, Lemma \ref{morphisms-lemma-image-proper-scheme-closed}.
Hence $V_i \cap V_j$ is a closed subset of $V_i$ which
does not contain $v_i$. Hence the image of $V_i \cap V_j$
in $U$ is a closed set (because $V_i \to U$ proper) not
containing $u$. After shrinking $U$ we may therefore assume
that $V_i \cap V_j = \emptyset$ for all $i, j$. This gives the
decomposition as in the lemma.
\end{proof}

\noindent
Here is the variant where we reduce to purely inseparable
field extensions.

\begin{lemma}
\label{lemma-etale-splits-off-quasi-finite-part-technical-variant}
Let $f : X \to S$ be a morphism of schemes.
Let $s \in S$. Let $x_1, \ldots, x_n \in X_s$. Assume that
\begin{enumerate}
\item $f$ is locally of finite type,
\item $f$ is separated, and
\item $x_1, \ldots, x_n$ are pairwise distinct isolated points of $X_s$.
\end{enumerate}
Then there exists an \'etale neighbourhood $(U, u) \to (S, s)$
and a decomposition
$$
U \times_S X =
W \coprod
\ \coprod\nolimits_{i = 1, \ldots, n}
\ \coprod\nolimits_{j = 1, \ldots, m_i}
V_{i, j}
$$
into open and closed subschemes such that the morphisms
$V_{i, j} \to U$ are finite, the fibres of $V_{i, j} \to U$ over $u$ are
singletons $\{v_{i, j}\}$, each $v_{i, j}$ maps to $x_i$,
$\kappa(u) \subset \kappa(v_{i, j})$ is purely inseparable,
and the fibre of $W \to U$ over $u$ contains no points mapping
to any of the $x_i$.
\end{lemma}

\begin{proof}
This is proved in exactly the same way as the proof of
Lemma \ref{lemma-etale-splits-off-quasi-finite-part-technical} except that it
uses Lemma \ref{lemma-etale-makes-quasi-finite-finite-multiple-points-var}
instead of Lemma \ref{lemma-etale-makes-quasi-finite-finite-multiple-points}.
\end{proof}

\noindent
The following version may be a little easier to parse.

\begin{lemma}
\label{lemma-etale-splits-off-quasi-finite-part}
Let $f : X \to S$ be a morphism of schemes.
Let $s \in S$. Assume that
\begin{enumerate}
\item $f$ is locally of finite type,
\item $f$ is separated, and
\item $X_s$ has at most finitely many isolated points.
\end{enumerate}
Then there exists an elementary \'etale neighbourhood $(U, u) \to (S, s)$
and a decomposition
$$
U \times_S X = W \coprod V
$$
into open and closed subschemes such that the morphisms
$V \to U$ is finite, and the fibre $W_u$ of the
morphism $W \to U$ contains no isolated points.
In particular, if $f^{-1}(s)$ is a finite set, then $W_u = \emptyset$.
\end{lemma}

\begin{proof}
This is clear from
Lemma \ref{lemma-etale-splits-off-quasi-finite-part-technical}
by choosing $x_1, \ldots, x_n$ the complete set of
isolated points of $X_s$ and setting $V = \bigcup V_i$.
\end{proof}







\section{Application to the structure of quasi-finite morphisms}
\label{section-application-etale-neighbourhoods}

\noindent
We can use the existence of good \'etale neighbourhoods to prove
some fundamental facts about quasi-finite morphisms.

\begin{lemma}
\label{lemma-normalization-smooth-localization}
(Normalization commutes with smooth base change.) Let
$$
\xymatrix{
Y_U \ar[r] \ar[d] & Y \ar[d]^f \\
U \ar[r]^\varphi & X
}
$$
be a fibre square in the category of schemes.
Assume $f$ is quasi-compact and quasi-separated,
and $\varphi : U \to X$ is a smooth morphism.
Let $Y \to X' \to X$ be the normalization of $X$ in $Y$.
Let $Y_U \to (X_U)' \to U$ be the normalization of $U$ in $Y_U$.
Then $(X_U)' \cong U \times_X X'$.
\end{lemma}

\begin{proof}
Denote $f_U : Y_U \to U$ the base change of $f$.
By definition we have
$X' = \underline{\text{Spec}}_X(\mathcal{A})$ and
$(X_U)' = \underline{\text{Spec}}_U(\mathcal{A}')$, where
$\mathcal{A} \subset f_*\mathcal{O}_Y$ is the integral closure of
$\mathcal{O}_X$ and $\mathcal{A}' \subset (f_U)_*\mathcal{O}_{Y_U}$
is the integral closure of $\mathcal{O}_U$.
By Coherent, Lemma \ref{coherent-lemma-flat-base-change-cohomology}
we know that $(f_U)_*\mathcal{O}_{Y_U}$ is the same as
$\varphi^*(f_*\mathcal{O}_Y)$.
Let $\text{Spec}(C) \subset U$, $\text{Spec}(R) \subset X$ be
affine opens with $\varphi(\text{Spec}(C)) \subset \text{Spec}(R)$.
Hence $R \to C$ is a smooth ring map, see
Morphisms, Lemma \ref{morphisms-lemma-smooth-characterize}.
Write
$$
f_*\mathcal{O}_Y|_{\text{Spec}(R)} = \widetilde{B}
\quad\text{and}\quad
(f_U)_*\mathcal{O}_{Y_U}|_{\text{Spec}(C)} = \widetilde{B'}.
$$
By the above we have $B' = C \otimes_R B$. Let $A \subset B$ be
the integral closure of $R$ in $B$ and let $A' \subset B'$ be the
integral closure of $C$ in $B'$. Then we have
$$
\mathcal{A}|_{\text{Spec}(R)} = \widetilde{A}
\quad\text{and}\quad
\mathcal{A}'|_{\text{Spec}(C)} = \widetilde{A'},
$$
see Morphisms, Lemma \ref{morphisms-lemma-integral-closure}.
Hence the lemma is reduced to proving that $C \otimes_R A \cong A'$.
This is the content of
Algebra, Lemma \ref{algebra-lemma-integral-closure-commutes-smooth}.
\end{proof}

\begin{lemma}
\label{lemma-finite-type-separated}
Let $f : X \to S$ be a morphism of schemes.
Assume $f$ is of finite type and separated.
Let $S'$ be the normalization of $S$ in $X$, see
Morphisms, Definition \ref{morphisms-definition-normalization-X-in-Y}.
Picture:
$$
\xymatrix{
X \ar[rd]_f \ar[rr]_{f'} & & S' \ar[ld]^\nu \\
& S &
}
$$
Then there exists an open subscheme $U' \subset S'$ such that
\begin{enumerate}
\item $(f')^{-1}(U') \to U'$ is an isomorphism, and
\item $(f')^{-1}(U') \subset X$ is the set of points at which
$f$ is quasi-finite.
\end{enumerate}
\end{lemma}

\begin{proof}
By Morphisms, Lemma \ref{morphisms-lemma-quasi-finite-points-open}
the subset $U \subset X$ of points where $f$ is quasi-finite is open,
and $U \to S$ is locally quasi-finite. Let $x \in U$.
We want to show that
\begin{enumerate}
\item[(a)] there exists an open neighbourhood $V'' \subset X'$
of $f'(x)$ such that the morphism
$f'|_{(f')^{-1}(V'')} : (f')^{-1}(V'') \to V''$ is an isomorphism.
\end{enumerate}
This will prove the lemma since it will imply that $U' = f(U)$
is open, $f^{-1}(U') = U$ and that $f'|_U : U \to U'$ is an isomorphism.

\medskip\noindent
Let $s = f(x)$. Choose an elementary \'etale neighbourhood $(T, t) \to (S, s)$
and a decomposition
$$
X_T = V \coprod W
$$
into open and closed subschemes where $V \to T$ is finite, and such that
$V$ has a unique point $v \in V$ in the fibre over $t$ which maps to $x$,
and the fibre of $W \to T$ over $t$ contains no point mapping to $x$.
We can do this according to
Lemma \ref{lemma-etale-splits-off-quasi-finite-part-technical}.
Denote $f_T : X_T \to T$ (resp.\ $f'_T$) the base change of $f$
(resp.\ $f'$). According to
Lemma \ref{lemma-normalization-smooth-localization} the factorization
$$
X_T \xrightarrow{f'_T} T \times_S S' \longrightarrow T
$$
is the normalization of $T$ in $X_T$. On the other hand, since $X_T$
is a disjoint union of two schemes over $T$, we see that the normalization
of $T$ in $X_T$ is the morphism
$$
X_T = V \coprod W \longrightarrow V' \coprod W' \longrightarrow T
$$
where $V'$ is the normalization of $T$ in $V$ and $W'$ is the normalization
of $T$ in $W$
(Morphisms, Lemma \ref{morphisms-lemma-normalization-in-disjoint-union}).
However, since $V \to T$ is finite we see that $V \to V'$ is an isomorphism
(Morphisms, Lemmas \ref{morphisms-lemma-finite-integral}
and \ref{morphisms-lemma-normalization-in-integral}).
Also, $(f'_T)^{-1}(V') = V$. In other words, we have shown the following
\begin{enumerate}
\item[($\alpha$)] there exists an open neighbourhood $V' \subset X'_T$
of $f'_T(v)$ such that the restriction
$(f'_T)^{-1}(V') \to V'$ is an isomorphism.
\end{enumerate}
We will show that property $(\alpha)$ implies property (a) above.
Since $T \to S$ is \'etale we see that $X'_T \to X'$ is \'etale
(Morphisms, Lemma \ref{morphisms-lemma-base-change-etale}).
Hence also $V' \to X'$ is \'etale, in particular open
(Morphisms, Lemmas \ref{morphisms-lemma-fppf-open},
\ref{morphisms-lemma-etale-locally-finite-presentation}
and \ref{morphisms-lemma-etale-flat}). Denote
$V'' \subset X'$ the image. Note that
$$
(f'_T)^{-1}(V') = V' \times_{X'} X = V' \times_{V''} (f')^{-1}(V'')
$$
Hence the restriction $f'|_{(f')^{-1}(V'')} : (f')^{-1}(V'') \to V''$
is a morphism whose base change to $V'$ is an isomorphism. Since
$\{V' \to V''\}$ is an \'etale covering, we see that
$f'|_{(f')^{-1}(V'')} : (f')^{-1}(V'') \to V''$ is an isomorphism also,
by Descent, Lemma \ref{descent-lemma-descending-property-isomorphism}.
This proves (a) and we are done.
\end{proof}

\begin{lemma}
\label{lemma-quasi-finite-separated-quasi-affine}
Let $f : X \to S$ be a morphism of schemes.
Assume $f$ is quasi-finite and separated.
Let $S'$ be the normalization of $S$ in $X$, see
Morphisms, Definition \ref{morphisms-definition-normalization-X-in-Y}.
Picture:
$$
\xymatrix{
X \ar[rd]_f \ar[rr]_{f'} & & S' \ar[ld]^\nu \\
& S &
}
$$
Then $f'$ is a quasi-compact open immersion and $\nu$ is integral.
In particular $f$ is quasi-affine.
\end{lemma}

\begin{proof}
This follows from Lemma \ref{lemma-finite-type-separated}. Namely, by
that lemma there exists an open suscheme $U' \subset S'$ such that
$(f')^{-1}(U') = X$ (!) and $X \to U'$ is an isomorphism! In other
words, $f'$ is an open immersion. Note that $f'$ is quasi-compact as
$f$ is quasi-compact and $\nu : S' \to S$ is separated
(Schemes, Lemma \ref{schemes-lemma-quasi-compact-permanence}).
It follows that $f$ is quasi-affine by
Morphisms, Lemma \ref{morphisms-lemma-characterize-quasi-affine}.
\end{proof}

\begin{lemma}
\label{lemma-quasi-finite-separated-pass-through-finite}
Let $f : X \to S$ be a morphism of schemes.
Assume $f$ is quasi-finite and separated and assume that
$S$ is quasi-compact and quasi-separated. Then there exists
a factorization
$$
\xymatrix{
X \ar[rd]_f \ar[rr]_j & & T \ar[ld]^\pi \\
& S &
}
$$
where $j$ is a quasi-compact open immersion and $\pi$ is finite.
\end{lemma}

\begin{proof}
Let $X \to S' \to S$ be as in the conclusion of
Lemma \ref{lemma-quasi-finite-separated-quasi-affine}.
By
Properties, Lemma \ref{properties-lemma-algebra-directed-colimit-finite-type}
we can write
$\nu_*\mathcal{O}_{S'} = \text{colim}_\lambda\ \mathcal{A}_\lambda$ as a
directed colimit of quasi-coherent $\mathcal{O}_X$-sub algebras
$\mathcal{A}_\lambda$ of finite type. Set
$T_\lambda = \underline{\text{Spec}}_S(\mathcal{A}_\lambda)$.
Since $\mathcal{A}_\lambda$ is a quasi-coherent $\mathcal{O}_X$-algebra
of finite type contained in the integral $\mathcal{O}_X$-algebra
$\nu_*\mathcal{O}_{S'}$, we see that in fact $\mathcal{A}_\lambda$
is finite as an $\mathcal{O}_X$-module, see
Algebra, Lemma \ref{algebra-lemma-characterize-finite-in-terms-of-integral}.
Hence $\pi_\lambda : T_\lambda \to S$ is a finite morphism for each $\lambda$.
Note that the transition morphisms $T_\lambda \to T_{\lambda}$ are affine
and that $S' = \text{lim}_\lambda\ T_\lambda$.

\medskip\noindent
As $S$ is quasi-compact we may choose a finite
affine open covering $S = \bigcup_{i = 1, \ldots, n} V_i$.
As $f'$ is quasi-compact, we can for each $i$ choose a finite
number of elements $h_{ij} \in \Gamma(\nu^{-1}(V_i), \mathcal{O}_{S'})$
such that
$$
f'(X) \cap \nu^{-1}(V_i) = \bigcup\nolimits D(h_{ij}).
$$
Let $X_{ij} \subset X$ denote the affine open subscheme mapping isomorphically
to $D(h_{ij})$. Since $X \to S$ is of finite type we see that
$$
\Gamma(V_i, \mathcal{O}_S) \to
\Gamma(X_{ij}, \mathcal{O}_X) =
\Gamma(D(h_{ij}), \mathcal{O}_{S'}) =
\Gamma(\nu^{-1}(V_i), \mathcal{O}_{S'})_{h_{ij}}
$$
is a finite type ring map, see
Morphisms, Lemma \ref{morphisms-lemma-locally-finite-type-characterize}.
Choose finitely many $a_{ijk} \in \Gamma(\nu^{-1}(V_i), \mathcal{O}_{S'})$
which together with $h_{ij}^{-1}$ generate $\Gamma(X_{ij}, \mathcal{O}_X)$
as an $\Gamma(V_i, \mathcal{O}_S)$-algebra. Now, pick $\lambda$ so large
that there exist
$$
A_{ijk}, H_{ij} \in \Gamma(\pi_\lambda^{-1}(V_i), \mathcal{O}_{T_\lambda})
$$
mapping to the elements $a_{ijk}, h_{ij}$ chosen above. Let
$U_\lambda \subset T_\lambda$ be the union of the standard affine opens
$D(H_{ij})$ determined by the $H_{ij}$ inside $\pi_\lambda^{-1}(V_i)$.
By construction the morphism $X \to T_\lambda$ factors through
$U_\lambda$. By construction the morphism $X \to T_\lambda$ is a closed
immersion, because the ring maps on the affine opens $X_{ij} \to D(H_{ij})$
are surjective by construction. Hence $X \to T_\lambda$ is a locally closed
immersion. (In fact this morphism will be an open immersion for sufficiently
large $\lambda$ but we don't need this.) By
Morphisms, Lemma \ref{morphisms-lemma-factor-quasi-compact-immersion}
we can factor this as $X \to T \to T_\lambda$ where the first arrow
is an open immersion and the second a closed immersion. Thus we win.
\end{proof}

\begin{lemma}
\label{lemma-characterize-finite}
Let $f : X \to S$ be a morphism of schemes.
The following are equivalent:
\begin{enumerate}
\item $f$ is finite,
\item $f$ is proper with finite fibres.
\item $f$ is universally closed, separated, locally of finite type
and has finite fibres.
\end{enumerate}
\end{lemma}

\begin{proof}
We have (1) implies (2) by
Morphisms, Lemmas \ref{morphisms-lemma-finite-proper},
\ref{morphisms-lemma-quasi-finite},
and \ref{morphisms-lemma-finite-quasi-finite}.
By definition (2) implies (3).

\medskip\noindent
Assume (3). Pick $s \in S$. By
Morphisms, Lemma \ref{morphisms-lemma-finite-fibre} we
see that all the finitely many points of $X_s$ are isolated in $X_s$.
Choose an elementary \'etale neighbourhood $(U, u) \to (S, s)$
and decomposition $X_U = V \coprod W$ as in
Lemma \ref{lemma-etale-splits-off-quasi-finite-part}.
Note that $W_u = \emptyset$ because all points of $X_s$ are isolated.
Since $f$ is universally closed we see that
the image of $W$ in $U$ is a closed set not containing $u$.
After shrinking $U$ we may assume that $W = \emptyset$.
In other words we see that $X_U = V$ is finite over $U$.
Since $s \in S$ was arbitrary
this means there exists a family $\{U_i \to S\}$
of \'etale morphisms whose images cover $S$ such that
the base changes $X_{U_i} \to U_i$ are finite.
Note that $\{U_i \to S\}$ is an \'etale covering,
see Topologies, Definition \ref{topologies-definition-etale-covering}.
Hence it is an fpqc covering, see
Topologies,
Lemma \ref{topologies-lemma-zariski-etale-smooth-syntomic-fppf-fpqc}.
Hence we conclude $f$ is finite by
Descent, Lemma \ref{descent-lemma-descending-property-finite}.
\end{proof}

\begin{lemma}
\label{lemma-characterize-closed-immersion}
Let $f : X \to S$ be a morphism of schemes.
The following are equivalent:
\begin{enumerate}
\item $f$ is a closed immersion,
\item $f$ is universally closed, unramified, and a monomorphism,
\item $f$ is universally closed, unramified, and universally injective,
\item $f$ is universally closed, locally of finite type, and a monomorphism,
\item $f$ is universally closed, universally injective, locally of
finite type, and formally unramfied.
\end{enumerate}
\end{lemma}

\begin{proof}
The equivalence of (2) -- (5) follows immediately from
Lemma \ref{lemma-universally-injective-unramified}.
Let $f : X \to S$ be a universally closed monomorphism which is locally
of finite type. Then $f$ is separated, see
Schemes, Lemma \ref{schemes-lemma-monomorphism-separated}
and has finite fibres. Hence by
Lemma \ref{lemma-characterize-finite}
$f$ is finite. Then by
Morphisms, Lemma \ref{morphisms-lemma-finite-monomorphism-closed}
$f$ is a closed immersion.
We omit the proof of (1) $\Rightarrow$ (2).
\end{proof}


\noindent
As a consequence we have the following two useful results.

\begin{lemma}
\label{lemma-proper-finite-fibre-finite-in-neighbourhood}
Let $f : X \to S$ be a morphism of schemes.
Let $s \in S$.
Assume that $f$ is proper and $f^{-1}(\{s\})$ is a finite set.
Then there exists an open neighbourhood $V \subset S$ of $s$
such that $f|_{f^{-1}(V)} : f^{-1}(V) \to V$ is finite.
\end{lemma}

\begin{proof}
The morphism $f$ is quasi-finite at all the points of $f^{-1}(\{s\})$
by Morphisms, Lemma \ref{morphisms-lemma-finite-fibre}.
By Morphisms, Lemma \ref{morphisms-lemma-quasi-finite-points-open} the
set of points at which $f$ is quasi-finite is an open $U \subset X$.
Let $Z = X \setminus U$. Then $s \not \in f(Z)$. Since $f$ is proper
the set $f(Z) \subset S$ is closed. Choose any open neighbourhood
$V \subset S$ of $s$ with $Z \cap V = \emptyset$. Then
$f^{-1}(V) \to V$ is locally quasi-finite and proper.
Hence it is quasi-finite
(Morphisms, Lemma \ref{morphisms-lemma-quasi-finite-locally-quasi-compact}),
hence has finite fibres
(Morphisms, Lemma \ref{morphisms-lemma-quasi-finite}), hence
is finite by Lemma \ref{lemma-characterize-finite}.
\end{proof}

\begin{lemma}
\label{lemma-quasi-finite-finite-over-dense-open}
Let $f : Y \to X$ be a quasi-finite morphism.
There exists a dense open $U \subset X$ such that
$f|_{f^{-1}(U)} : f^{-1}(U) \to U$ is finite.
\end{lemma}

\begin{proof}
If $U', U'' \subset X$ are opens such that the restrictions
$f|_{f^{-1}(U')} : f^{-1}(U') \to U'$ and
$f|_{f^{-1}(U'')} : f^{-1}(U'') \to U''$ are finite,
then for $U = U' \cup U''$ the restriction $f|_{f^{-1}(U)} : f^{-1}(U) \to U$
is finite, see
Morphisms, Lemma \ref{morphisms-lemma-finite-local}.
Thus the problem is local on $X$ and we may assume that $X$ is affine.

\medskip\noindent
Assume $X$ is affine.
Write $Y = \bigcup_{j = 1, \ldots, m} V_j$ with $V_j$ affine.
This is possible since $f$ is quasi-finite and hence
in particular quasi-compact. Each $V_j \to X$ is quasi-finite
and separated. Let $\eta \in X$ be a generic point of an irreducible
component of $X$. We see from
Morphisms, Lemmas
\ref{morphisms-lemma-quasi-finite} and \ref{morphisms-lemma-generically-finite}
that there exists an open neighbourhood $\eta \in U_\eta$ such that
$f^{-1}(U_\eta) \cap V_j \to U_\eta$ is finite. We may choose $U_\eta$ such
that it works for each $j = 1, \ldots, m$.
Note that the collection of generic points of $X$ is dense in $X$.
Thus we see there exists a dense open $W = \bigcup_\eta U_\eta$
such that each $f^{-1}(W) \cap V_j \to W$ is finite.
It suffices to show that there exists a dense open $U \subset W$
such that $f|_{f^{-1}(U)} : f^{-1}(U) \to U$ is finite.
Thus we may replace $X$ by an affine open subscheme of $W$ and
assume that each $V_j \to X$ is finite.

\medskip\noindent
Assume $X$ is affine, $Y = \bigcup_{j = 1, \ldots, m} V_j$ with $V_j$ affine,
and the restrictions $f|_{V_j} : V_j \to X$ are finite.
Set
$$
\Delta_{ij} =
\Big(\overline{V_i \cap V_j} \setminus V_i \cap V_j\Big) \cap V_j.
$$
This is a nowhere dense closed subset of $V_j$ because it is the boundary
of the open subset $V_i \cap V_j$ in $V_j$. By
Morphisms, Lemma \ref{morphisms-lemma-image-nowhere-dense-finite}
the image $f(\Delta_{ij})$ is a nowhere dense closed subset of $X$. By
Topology, Lemma \ref{topology-lemma-nowhere-dense}
the union $T = \bigcup f(\Delta_{ij})$ is a nowhere dense closed
subset of $X$. Thus $U = X \setminus T$ is a dense open subset of $X$.
We claim that $f|_{f^{-1}(U)} : f^{-1}(U) \to U$ is finite.
To see this let $U' \subset U$ be an affine open.
Set $Y' = f^{-1}(U') = U' \times_X Y$,
$V_j' = Y' \cap V_j = U' \times_X V_j$. Consider the restriction
$$
f' = f|_{Y'} : Y' \longrightarrow U'
$$
of $f$. This morphism now has the property that
$Y' = \bigcup_{j = 1, \ldots, m} V'_j$ is an affine open covering,
each $V'_j \to U'$ is finite, and $V_i' \cap V_j'$ is (open and) closed
both in $V'_i$ and $V'_j$. Hence $V_i' \cap V_j'$ is affine, and the map
$$
\mathcal{O}(V'_i) \otimes_{\mathbf{Z}} \mathcal{O}(V'_j)
\longrightarrow
\mathcal{O}(V'_i \cap V'_j)
$$
is surjective. This implies that $Y'$ is separated, see
Schemes, Lemma \ref{schemes-lemma-characterize-separated}.
Finally, consider the commutative diagram
$$
\xymatrix{
\coprod_{j = 1, \ldots, m} V'_j \ar[rd] \ar[rr] & & Y' \ar[ld] \\
& U' &
}
$$
The south-east arrow is finite, hence proper, the horizontal arrow is
surjective, and the south-west arrow is separated. Hence by
Morphisms, Lemma \ref{morphisms-lemma-image-proper-is-proper}
we conclude that $Y' \to U'$ is proper. Since it is also quasi-finite,
we see that it is finite by Lemma \ref{lemma-characterize-finite},
and we win.
\end{proof}











\section{Application to morphisms with connected fibres}
\label{section-application-geometrically-connected}

\noindent
In this section we prove some lemmas that produce morphisms all of
whose fibres are geometrically connected or geometrically integral.
This will be useful in our study of the local structure of morphisms
of finite type later.

\begin{lemma}
\label{lemma-descent-connected-fibres}
Consider a diagram of morphisms of schemes
$$
\xymatrix{
Z \ar[r]_{\sigma} \ar[rd] & X \ar[d] \\
& Y
}
$$
an a point $y \in Y$. Assume
\begin{enumerate}
\item $X \to Y$ is of finite presentation and flat,
\item $Z \to Y$ is finite locally free,
\item $Z_y \not = \emptyset$,
\item all fibres of $X \to Y$ are geometrically reduced, and
\item $X_y$ is geometrically connected over $\kappa(y)$.
\end{enumerate}
Then there exists an open $X^0 \subset X$ such that $X^0_y = X_y$
and such that all fibres of $X^0 \to Y$ are geometrically connected.
\end{lemma}

\begin{proof}
In this proof we will use that flat, finite presentation, finite locally
free are properties that are preserved under base change and composition.
We will also use that a finite locally free morphism is both open and
closed. You can find these facts as
Morphisms, Lemmas
\ref{morphisms-lemma-base-change-flat},
\ref{morphisms-lemma-base-change-finite-presentation},
\ref{morphisms-lemma-base-change-finite-locally-free},
\ref{morphisms-lemma-composition-flat},
\ref{morphisms-lemma-composition-finite-presentation},
\ref{morphisms-lemma-composition-finite-locally-free},
\ref{morphisms-lemma-fppf-open}, and
\ref{morphisms-lemma-finite-proper}.

\medskip\noindent
Note that $X_Z \to Z$ is flat morphism of finite presentation
which has a section $s$ coming from $\sigma$. Let $X_Z^0$ denote
the subset of $X_Z$ defined in
Situation \ref{situation-connected-along-section}.
By
Lemma \ref{lemma-connected-along-section-open}
it is an open subset of $X_Z$.

\medskip\noindent
The pullback $X_{Z \times_Y Z}$ of $X$ to $Z \times_Y Z$ comes equipped
with two sections $s_0, s_1$, namely the base changes of $s$ by
$\text{pr}_0, \text{pr}_1 : Z \times_Y Z \to Z$. The construction of
Situation \ref{situation-connected-along-section}
gives two subsets $(X_{Z \times_Y Z})_{s_0}^0$ and
$(X_{Z \times_Y Z})_{s_1}^0$. By
Lemma \ref{lemma-base-change-connected-along-section}
these are the inverse images of $X_Z^0$ under the morphisms
$1_X \times \text{pr}_0, 1_X \times \text{pr}_1 : X_{Z \times_Y Z} \to X_Z$.
In particular these subsets are open.

\medskip\noindent
Let $(Z \times_Y Z)_y = \{z_1, \ldots, z_n\}$.
As $X_y$ is geometrically connected, we see that the fibres of
$(X_{Z \times_Y Z})_{s_0}^0$ and $(X_{Z \times_Y Z})_{s_1}^0$
over each $z_i$ agree (being equal to the whole fibre). Another
way to say this is that
$$
s_0(z_i) \in (X_{Z \times_Y Z})_{s_1}^0
\quad\text{and}\quad
s_1(z_i) \in (X_{Z \times_Y Z})_{s_0}^0.
$$
Since the sets $(X_{Z \times_Y Z})_{s_0}^0$ and $(X_{Z \times_Y Z})_{s_1}^0$
are open in $X_{Z \times_Y Z}$ there exists an open neighbourhood
$W \subset Z \times_Y Z$ of $(Z \times_Y Z)_y$ such that
$$
s_0(W) \subset (X_{Z \times_Y Z})_{s_1}^0
\quad\text{and}\quad
s_1(W) \subset (X_{Z \times_Y Z})_{s_0}^0.
$$
Then it follows directly from the construction in
Situation \ref{situation-connected-along-section}
that
$$
p^{-1}(W) \cap (X_{Z \times_Y Z})_{s_0}^0
=
p^{-1}(W) \cap (X_{Z \times_Y Z})_{s_1}^0
$$
where $p : X_{Z \times_Y Z} \to Z \times_W Z$ is the projection.
Because $Z \times_Y Z \to Y$ is finite locally free, hence open and closed,
there exists an open neighbourhood $V \subset Y$ of $y$ such that
$q^{-1}(V) \subset W$, where $q : Z \times_Y Z \to Y$ is the
structure morphism. To prove the lemma we may replace $Y$ by $V$
(because an empty topological space is connected). After we do this
we see that $X_Z^0 \subset Y_Z$ is an open such that
$$
(1_X \times \text{pr}_0)^{-1}(X_Z^0) =
(1_X \times \text{pr}_1)^{-1}(X_Z^0).
$$
This means that the image $X^0 \subset X$ of $X_Z^0$ is an open such
that $(X_Z \to X)^{-1}(X^0) = X_Z^0$, see
Descent, Lemma \ref{descent-lemma-open-fpqc-covering}.
At this point it is clear that $X^0$ is the desired open subscheme.
\end{proof}

\begin{lemma}
\label{lemma-fibre-geometrically-connected-reduced}
Let $h : Y \to S$ be a morphism of schemes.
Let $s \in S$ be a point.
Let $T \subset Y_s$ be an open subscheme.
Assume
\begin{enumerate}
\item $h$ is flat and of finite presentation,
\item all fibres of $h$ are geometrically reduced, and
\item $T$ is geometrically connected over $\kappa(s)$.
\end{enumerate}
Then we can find an elementary \'etale neighbourhood $(S', s') \to (S, s)$
and an open $V \subset Y_{S'}$ such that
\begin{enumerate}
\item[(a)] all fibres of $V \to S'$ are geometrically connected,
\item[(b)] $V_{s'} = T \times_s s'$.
\end{enumerate}
\end{lemma}

\begin{proof}
The problem is clearly local on $S$, hence we may replace $S$ by an
affine open neighbourhood of $s$.
The topology on $Y_s$ is induced from the topology on $X$, see
Schemes, Lemma \ref{schemes-lemma-fibre-topological}.
Hence we can find a quasi-compact open $V \subset Y$ such that $V_s = T$.
The restriction of $h$ to $V$ is quasi-compact (as $S$ affine and $V$
quasi-compact), quasi-separated, locally of finite presentation, and
flat hence flat of finite presentation.
Thus after replacing $Y$ by $V$ we may assume, in addition
to (1) and (2) that $Y_s = T$ and $S$ affine.

\medskip\noindent
Pick a point $y \in Y_s$ such that $h$ is Cohen-Macaulay at $y$, see
Lemma \ref{lemma-flat-finite-presentation-CM-open}.
By
Lemma \ref{lemma-slice-CM}
there exists a diagram
$$
\xymatrix{
Z \ar[r] \ar[rd] & Y \ar[d] \\
& S
}
$$
such that $Z \to S$ is flat, locally of finite presentation, locally
quasi-finite with $Z_s = \{z\}$. Apply
Lemma \ref{lemma-etale-makes-quasi-finite-finite-at-point}
to find an elementary neighbourhood $(S', s') \to (S, s)$ and an open
$Z' \subset Z_{S'} = S' \times_S Z$ with $Z' \to S'$ finite with a unique
point $z' \in Z'$ lying over $s$. Note that $Z' \to S'$ is also
locally of finite presentation and flat (as an open of the base change
of $Z \to S$), hence $Z' \to S'$ is finite locally free, see
Morphisms, Lemma \ref{morphisms-lemma-finite-flat}.
Note that $Y_{S'} \to S'$ is flat and of finite presentation
with geometrically reduced fibres as a base change of $h$.
Also $Y_{s'} = Y_s$ is geometrically connected.
To finish the proof apply
Lemma \ref{lemma-descent-connected-fibres}
to $Z' \to Y_{S'}$ over $S'$.
\end{proof}

\begin{lemma}
\label{lemma-normal-morphism-irreducible}
Let $h : Y \to S$ be a morphism of schemes.
Let $s \in S$ be a point.
Let $T \subset Y_s$ be an open subscheme.
Assume
\begin{enumerate}
\item $h$ is of finite presentation,
\item $h$ is normal, and
\item $T$ is geometrically irreducible over $\kappa(s)$.
\end{enumerate}
Then we can find an elementary \'etale neighbourhood $(S', s') \to (S, s)$
and an open $V \subset Y_{S'}$ such that
\begin{enumerate}
\item[(a)] all fibres of $V \to S'$ are geometrically integral,
\item[(b)] $V_{s'} = T \times_s s'$.
\end{enumerate}
\end{lemma}

\begin{proof}
Apply
Lemma \ref{lemma-fibre-geometrically-connected-reduced}
to find an elementary \'etale neighbourhood $(S', s') \to (S, s)$ and
an open $V \subset Y_{S'}$ such that all fibres of
$V \to S'$ are geometrically integral and $V_{s'} = T \times_s s'$.
Note that $V \to S'$ is open, see
Morphisms, Lemma \ref{morphisms-lemma-fppf-open}
Hence after replacing $S'$ by the image of $V \to S'$ we see that
all fibres of $V \to S'$ are nonempty. As $V$ is an open of the
base change of $h$ all fibres of $V \to S'$ are geometrically normal, see
Lemma \ref{lemma-normal}.
In particular, they are geometrically reduced. To finish the proof
we have to show they are geometrically irreducible. But, if $t \in S'$
then $V_t$ is of finite type over $\kappa(t)$ and hence
$V_t \times_{\kappa(t)} \overline{\kappa(t)}$ is of finite type
over $\overline{\kappa(t)}$ hence Noetherian. By choice of $S' \to S$
the scheme $V_t \times_{\kappa(t)} \overline{\kappa(t)}$ is connected.
Hence $V_t \times_{\kappa(t)} \overline{\kappa(t)}$ is irreducible by
Properties, Lemma \ref{properties-lemma-normal-Noetherian}
and we win.
\end{proof}








\section{Application to the structure of finite type morphisms}
\label{section-application-finite-type}

\noindent
The result in this section can be found in \cite{GruRay}.
Loosely stated it says that a finite type morphism is \'etale
locally on the source and target the composition of a finite
morphism by a smooth morphism with geometrically connected fibres
of relative dimension equal to the fibre dimension of the original
morphism.

\begin{lemma}
\label{lemma-local-structure-finite-type}
Let $f : X \to S$ be a morphism. Let $x \in X$ and set $s = f(x)$.
Assume that $f$ is locally of finite type and that $n = \dim_x(X_s)$.
Then there exists a commutative diagram
$$
\xymatrix{
X \ar[dd] & X' \ar[l]^g \ar[d]^\pi & x \ar@{|->}[dd] &
x' \ar@{|->}[l]  \ar@{|->}[d] \\
& Y \ar[d]^h & & y \ar@{|->}[d] \\
S \ar@{=}[r] & S & s & s \ar@{=}[l]
}
$$
and a point $x' \in X'$ with $g(x') = x$ such that with $y = \pi(x')$
we have
\begin{enumerate}
\item $h : Y \to S$ is smooth of relative dimension $n$,
\item $g : (X', x') \to (X, x)$ is an elementary \'etale neighbourhood,
\item $\pi$ is finite, and $\pi^{-1}(\{y\}) = \{x'\}$, and
\item $\kappa(y)$ is a purely transcendental extension of $\kappa(s)$.
\end{enumerate}
Moreover, if $f$ is locally of finite presentation then $\pi$ is
of finite presentation.
\end{lemma}

\begin{proof}
The problem is local on $X$ and $S$, hence we may assume that $X$ and
$S$ are affine. By
Algebra, Lemma \ref{algebra-lemma-refined-quasi-finite-over-polynomial-algebra}
after replacing $X$ by a standard open neighbourhood of $x$ in $X$
we may assume there is a factorization
$$
\xymatrix{
X \ar[r]^\pi & \mathbf{A}^n_S \ar[r] & S
}
$$
such that $\pi$ is quasi-finite and such that $\kappa(\pi(x))$
is purely transcendental over $\kappa(s)$. By
Lemma \ref{lemma-etale-makes-quasi-finite-finite-at-point}
there exists an elementary \'etale neighbourhood
$$
(Y, y) \to (\mathbf{A}^n_S, \pi(x))
$$
and an open $X' \subset X \times_{\mathbf{A}^n_S} Y$ which contains a
unique point $x'$ lying over $y$ such that $X' \to Y$ is finite.
This proves (1) -- (4) hold. For the final assertion, use
Morphisms, Lemma \ref{morphisms-lemma-finite-presentation-permanence}.
\end{proof}

\begin{lemma}
\label{lemma-local-local-structure-finite-type}
Let $f : X \to S$ be a morphism. Let $x \in X$ and set $s = f(x)$.
Assume that $f$ is locally of finite type and that $n = \dim_x(X_s)$.
Then there exists a commutative diagram
$$
\xymatrix{
X \ar[dd] & X' \ar[l]^g \ar[d]^\pi & x \ar@{|->}[dd] &
x' \ar@{|->}[l] \ar@{|->}[d] \\
& Y' \ar[d]^h & & y' \ar@{|->}[d] \\
S & S' \ar[l]_e & s & s' \ar@{|->}[l]
}
$$
and a point $x' \in X'$ with $g(x') = x$ such that with $y' = \pi(x')$,
$s' = h(y')$ we have
\begin{enumerate}
\item $h : Y' \to S'$ is smooth of relative dimension $n$,
\item all fibres of $Y' \to S'$ are geometrically integral,
\item $g : (X', x') \to (X, x)$ is an elementary \'etale neighbourhood,
\item $\pi$ is finite, and $\pi^{-1}(\{y'\}) = \{x'\}$,
\item $\kappa(y')$ is a purely transcendental extension of $\kappa(s')$, and
\item $e : (S', s') \to (S, s)$ is an elementary \'etale neighbourhood.
\end{enumerate}
Moreover, if $f$ is locally of finite presentation, then $\pi$ is
of finite presentation.
\end{lemma}

\begin{proof}
The question is local on $S$, hence we may replace $S$ by an affine open
neighbourhood of $s$. Next, we apply
Lemma \ref{lemma-local-structure-finite-type}
to get a commutative diagram
$$
\xymatrix{
X \ar[dd] & X' \ar[l]^g \ar[d]^\pi & x \ar@{|->}[dd] &
x' \ar@{|->}[l] \ar@{|->}[d] \\
& Y \ar[d]^h & & y \ar@{|->}[d] \\
S \ar@{=}[r] & S & s & s \ar@{=}[l]
}
$$
where $h$ is smooth of relative dimension $n$ and $\kappa(y)$ is
a purely transcendental extension of $\kappa(s)$. Since the question is
local on $X$ also, we may replace $Y$ by an affine neighbourhood of $y$
(and $X'$ by the inverse image of this under $\pi$). As $S$ is affine
this guarantees that $Y \to S$ is quasi-compact, separated and smooth,
in particular of finite presentation.
Let $T$ be the connected component of $Y_s$ containing $y$.
As $Y_s$ is Noetherian we see that $T$ is open.
We also see that $T$ is geometrically connected over $\kappa(s)$ by
Varieties,
Lemma \ref{varieties-lemma-geometrically-connected-if-connected-and-point}.
Since $T$ is also smooth over $\kappa(s)$ it is geometrically normal, see
Varieties, Lemma \ref{varieties-lemma-smooth-geometrically-normal}.
We conclude that $T$ is geometrically irreducible over $\kappa(s)$ (as a
connected Noetherian normal scheme is irreducible, see
Properties, Lemma \ref{properties-lemma-normal-Noetherian}).
Finally, note that the smooth morphism $h$ is normal by
Lemma \ref{lemma-smooth-normal}.
At this point we have verified all assumption of
Lemma \ref{lemma-normal-morphism-irreducible}
hold for the morphism $h : Y \to S$ and open $T \subset Y_s$.
As a result of applying
Lemma \ref{lemma-normal-morphism-irreducible}
we obtain $e : S' \to S$, $s' \in S'$, $Y'$ as
in the commutative diagram
$$
\xymatrix{
X \ar[dd] & X' \ar[l]^g \ar[d]^\pi & X' \times_Y Y' \ar[l] \ar[d] &
x \ar@{|->}[dd] & x' \ar@{|->}[l] \ar@{|->}[d] &
(x', s') \ar@{|->}[l] \ar@{|->}[d] \\
& Y \ar[d]^h & Y' \ar[d] \ar[l] & & y \ar@{|->}[d] &
(y, s') \ar@{|->}[l] \ar@{|->}[d] \\
S \ar@{=}[r] & S & S' \ar[l]_e & s & s \ar@{=}[l] & s' \ar@{|->}[l]
}
$$
where $e : (S', s') \to (S, s)$ is an elementary \'etale neighbourhood,
and where $Y' \subset Y_{S'}$ is an open neighbourhood all of whose fibres
over $S'$ are geometrically irreducible, such that $Y'_{s'} = T$ via
the identification $Y_s = Y_{S', s'}$. Let $(y, s') \in Y'$ be the point
corresponding to $y \in T$; this is also the unique point of $Y \times_S S'$
lying over $y$ with residue field equal to $\kappa(y)$ which maps to $s'$
in $S'$. Similarly, let $(x', s') \in X' \times_Y Y' \subset X' \times_S S'$
be the unique point over $x'$ with residue field equal to $\kappa(x')$
lying over $s'$. Then the outer part of this diagram is a solution to the
problem posed in the lemma. Some minor details omitted.
\end{proof}

\begin{lemma}
\label{lemma-local-local-structure-finite-type-affine}
Assumption and notation as in
Lemma \ref{lemma-local-local-structure-finite-type}.
In addition to properties (1) -- (6) we may also arrange it so that
\begin{enumerate}
\item[(7)] $S'$, $Y'$, $X'$ are affine.
\end{enumerate}
\end{lemma}

\begin{proof}
Note that if $Y'$ is affine, then $X'$ is affine as $\pi$ is finite.
Choose an affine open neighbourhood $U' \subset S'$ of $s'$.
Choose an affine open neighbourhood $V' \subset h^{-1}(U')$ of $y'$.
Let $W' = h(V')$. This is an open neighbourhood of $s'$ in $S'$, see
Morphisms, Lemma \ref{morphisms-lemma-smooth-open},
contained in $U'$. Choose an affine open neighbourhood $U'' \subset W'$
of $s'$. Then $h^{-1}(U'') \cap V'$ is affine because it is equal to
$U'' \times_{U'} V'$. By construction
$h^{-1}(U'') \cap V' \to U''$ is a surjective smooth morphism whose
fibres are (nonempty) open subschemes of geometrically integral fibres
of $Y' \to S'$, and hence geometrically integral. Thus we may replace
$S'$ by $U''$ and $Y'$ by $h^{-1}(U'') \cap V'$.
\end{proof}

\noindent
The significance of the property $\pi^{-1}(\{y'\}) = \{x'\}$ is partially
explained by the following lemma.

\begin{lemma}
\label{lemma-finite-morphism-single-point-in-fibre}
Let $\pi : X \to Y$ be a finite morphism.
Let $x \in X$ with $y = \pi(x)$ such that $\pi^{-1}(\{y\}) = \{x\}$.
Then
\begin{enumerate}
\item For every neighbourhood $U \subset X$ of $x$ in $X$, there
exists a neighbourhood $V \subset Y$ of $y$ such that
$\pi^{-1}(V) \subset U$.
\item The ring map $\mathcal{O}_{Y, y} \to \mathcal{O}_{X, x}$
is finite.
\item If $\pi$ is of finite presentation, then
$\mathcal{O}_{Y, y} \to \mathcal{O}_{X, x}$ is of finite presentation.
\item For any quasi-coherent $\mathcal{O}_X$-module $\mathcal{F}$
we have $\mathcal{F}_x = \pi_*\mathcal{F}_y$ as
$\mathcal{O}_{Y, y}$-modules.
\end{enumerate}
\end{lemma}

\begin{proof}
The first assertion is purely topological; use that
$\pi$ is a continuous and closed map such that $\pi^{-1}(\{y\}) = \{x\}$.
To prove the second and third parts we may assume
$X = \text{Spec}(B)$ and $Y = \text{Spec}(A)$. Then
$A \to B$ is a finite ring map and $y$ corresponds to a prime
$\mathfrak p$ of $A$ such that there exists a unique prime $\mathfrak q$ of
$B$ lying over $\mathfrak p$. Then
$B_{\mathfrak q} = B_{\mathfrak p}$, see
Algebra, Lemma \ref{algebra-lemma-unique-prime-over-localize-below}.
In other words, the map $A_{\mathfrak p} \to B_{\mathfrak q}$
is equal to the map $A_{\mathfrak p} \to B_{\mathfrak p}$ you get
from localizing $A \to B$ at $\mathfrak p$.
Thus (2) and (3) follow from simple properties of localization
(some details omitted). For the final statement, suppose that
$\mathcal{F} = \widetilde M$ for some $B$-module $M$.
Then $\mathcal{F} = M_{\mathfrak q}$ and
$\pi_*\mathcal{F}_y = M_{\mathfrak p}$. By the above these
localizations agree. Alternatively you can use part (1) and
the definition of stalks to see that $\mathcal{F}_x = \pi_*\mathcal{F}_y$
directly.
\end{proof}






\section{Application to the fppf topology}
\label{section-application-fppf}

\noindent
We can use the above \'etale localization techniques to prove the
following result describing the fppf topology as being equal to
the topology ``generated by'' Zariski coverings and by coverings of the
form $\{f : T \to S\}$ where $f$ is surjective finite locally free.

\begin{lemma}
\label{lemma-dominate-fppf}
Let $S$ be a scheme. Let $\{S_i \to S\}_{i \in I}$ be an fppf covering.
Then there exist
\begin{enumerate}
\item a Zariski open covering $S = \bigcup U_j$,
\item surjective finite locally free morphisms $W_j \to U_j$,
\item Zariski open coverings $W_j = \bigcup_k W_{j, k}$,
\item surjective finite locally free morphisms $T_{j, k} \to W_{j, k}$
\end{enumerate}
such that the fppf covering $\{T_{j, k} \to S\}$ refines the given
covering $\{S_i \to S\}$.
\end{lemma}

\begin{proof}
We may assume that each $S_i \to S$ is locally quasi-finite, see
Lemma \ref{lemma-qf-fp-flat-dominates-fppf}.

\medskip\noindent
Fix a point $s \in S$. Pick an $i \in I$ and a point
$s_i \in S_i$ mapping to $s$. Choose an elementary \'etale neighbourhood
$(S', s) \to (S, s)$ such that there exists an open
$$
S_i \times_S S'  \supset V
$$
which contains a unique point $v \in V$ mapping to $s \in S'$
and such that $V \to S'$ is finite, see
Lemma \ref{lemma-etale-makes-quasi-finite-finite-at-point}.
Then $V \to S'$ is finite locally free, because it is finite
and because $S_i \times_S S' \to S'$ is flat and locally of finite presentation
as a base change of the morphism $S_i \to S$, see
Morphisms, Lemmas \ref{morphisms-lemma-base-change-finite-presentation},
\ref{morphisms-lemma-base-change-flat}, and
\ref{morphisms-lemma-finite-flat}.
Hence $V \to S'$ is open, and after shrinking $S'$
we may assume that $V \to S'$ is surjective finite locally free.
Since we can do this for every point of $S$ we conclude that
$\{S_i \to S\}$ can be refined by a covering of the form
$\{V_a \to S\}_{a \in A}$ where each $V_a \to S$ factors as
$V_a \to S'_a \to S$ with $S'_a \to S$ \'etale.

\medskip\noindent
By
Remark \ref{remark-topologies}
there exists a Zariski open covering $S = \bigcup U_j$,
for each $j$ a finite locally free, surjective morphism
$W_j \to U_j$, and for each $j$ a Zariski open covering
$\{W_{j, k} \to W_j\}$ such that the family
$\{W_{j, k} \to S\}$ refines the \'etale covering
$\{S'_a \to S\}$, i.e., for each pair $j, k$ there exists
an $a(j, k)$ and a factorization $W_{j, K} \to S'_a \to S$
of the morphism $W_{j, K} \to S$. Set
$T_{j, k} = W_{j, k} \times_{S'_a} V_a$ and everything is clear.
\end{proof}








\section{Closed points in fibres}
\label{section-closed-points-fibres}

\noindent
Some of the material in this section is taken from the preprint
\cite{Osserman-Payne}.

\begin{lemma}
\label{lemma-locally-principal-vertical}
Let $f : X \to S$ be a morphism of schemes.
Let $Z \subset X$ be a closed subscheme.
Let $s \in S$.
Assume
\begin{enumerate}
\item $S$ is irreducible with generic point $\eta$,
\item $X$ is irreducible,
\item $f$ is dominant,
\item $f$ is locally of finite type,
\item $\dim(X_s) \leq \dim(X_\eta)$,
\item $Z$ is locally principal in $X$, and
\item $Z_\eta = \emptyset$.
\end{enumerate}
Then the fibre $Z_s$ is (set theoretically) a union of
irreducible components of $X_s$.
\end{lemma}

\begin{proof}
Let $X_{red}$ denote the reduction of $X$. Then $Z \cap X_{red}$ is
a locally principal closed subscheme of $X_{red}$, see
Divisors, Lemma \ref{divisors-lemma-pullback-locally-principal}.
Hence we may assume that $X$ is reduced. In other words $X$ is integral, see
Properties, Lemma \ref{properties-lemma-characterize-integral}.
In this case the morphism $X \to S$ factors through $S_{red}$, see
Schemes, Lemma \ref{schemes-lemma-map-into-reduction}.
Thus we may replace $S$ by $S_{red}$ and assume that $S$ is integral too.

\medskip\noindent
The assertion that $f$ is dominant signifies that the generic point of $X$
is mapped to $\eta$, see
Morphisms,
Lemma \ref{morphisms-lemma-dominant-finite-number-irreducible-components}.
Moreover, the scheme $X_\eta$ is an integral scheme which is locally of
finite type over the field $\kappa(\eta)$. Hence
$d = \dim(X_\eta) \geq 0$ is equal to $\dim_\xi(X_\eta)$ for
every point $\xi$ of $X_\eta$, see
Algebra, Lemmas \ref{algebra-lemma-dimension-spell-it-out} and
\ref{algebra-lemma-dimension-at-a-point-finite-type-over-field}.
In view of 
Morphisms, Lemma \ref{morphisms-lemma-openness-bounded-dimension-fibres}
and condition (5) we conclude that $\dim_x(X_s) = d$
for every $x \in X_s$.

\medskip\noindent
In the Noetherian case the assertion can be proved as follows.
If the lemma does not holds there exists $x \in Z_s$ which is a generic
point of an irreducible component of $Z_s$ but not a generic point
of any irreducible component of $X_s$. Then we see that
$\dim_x(Z_s) \leq d - 1$, because $\dim_x(X_s) = d$ and in a neighbourhood
of $x$ in $X_s$ the closed subscheme $Z_s$ does not contain any of the
irreducible components of $X_s$. Hence after replacing $X$ by an
open neighbourhood of $x$ we may assume that
$\dim_z(Z_{f(z)}) \leq d - 1$ for all $z \in Z$, see
Morphisms, Lemma \ref{morphisms-lemma-openness-bounded-dimension-fibres}.
Let $\xi' \in Z$ be a generic point of an irreducible component of $Z$
and set $s' = f(\xi)$. As $Z \not = X$ is locally principal we see that
$\dim(\mathcal{O}_{X, \xi}) = 1$, see
Algebra, Lemma \ref{algebra-lemma-minimal-over-1}
(this is where we use $X$ is Noetherian).
Let $\xi \in X$ be the generic point of $X$ and
let $\xi_1$ be a generic point of any irreducible component
of $X_{s'}$ which contains $\xi'$. Then we see that we have
the specializations
$$
\xi \leadsto \xi_1 \leadsto \xi'.
$$
As $\dim(\mathcal{O}_{X, \xi}) = 1$ one of the two specializations
has to be an equality.
By assumption $s' \not = \eta$, hence the first specialization
is not an equality.
Hence $\xi' = \xi_1$ is a generic point of an irreducible component of
$X_{s'}$. Applying
Morphisms, Lemma \ref{morphisms-lemma-openness-bounded-dimension-fibres}
one more time this implies
$\dim_{\xi'}(Z_{s'}) = \dim_{\xi'}(X_{s'}) \geq \dim(X_\eta) = d$
which gives the desired contradiction.

\medskip\noindent
In the general case we reduce to the Noetherian case as follows.
If the lemma is false then there exists a point
$x \in X$ lying over $s$ such that $x$ is a generic point of an
irreducible component of $Z_s$, but
not a generic point of any of the irreducible components of $X_s$.
Let $U \subset S$ be an affine neighbourhood of $s$ and let
$V \subset X$ be an affine neighbourhood of $x$ with $f(V) \subset U$.
Write $U = \text{Spec}(A)$ and $V = \text{Spec}(B)$ so that $f|_V$
is given by a ring map $A \to B$. Let $\mathfrak q \subset B$,
resp.\ $\mathfrak p \subset A$ be the prime corresponding to $x$, resp.\ $s$.
After possibly shrinking $V$ we may assume $Z \cap V$ is cut out by
some element $g \in B$. Denote $K = f.f.(A)$. What we know at this point
is the following:
\begin{enumerate}
\item $A \subset B$ is a finitely generated extension of domains,
\item the element $g \otimes 1$ is invertible in $B \otimes_A K$,
\item $d = \dim(B \otimes_A K) = \dim(B \otimes_A \kappa(\mathfrak p))$,
\item $g \otimes 1$ is not a unit of $B \otimes_A \kappa(\mathfrak p)$, and
\item $g \otimes 1$ is not in any of the minimal primes of
$B \otimes_A \kappa(\mathfrak p)$.
\end{enumerate}
We are seeking a contradiction.

\medskip\noindent
Pick elements $x_1, \ldots, x_n \in B$ which generate $B$ over $A$.
For a finitely generated $\mathbf{Z}$-algebra $A_0 \subset A$
let $B_0 \subset B$ be the $A_0$-subalgebra generated by
$x_1, \ldots, x_n$, denote $K_0 = f.f.(A_0)$, and set
$\mathfrak p_0 = A_0 \cap \mathfrak p$.
We claim that when $A_0$ is large enough then (1) -- (5) also hold for
the system $(A_0 \subset B_0, g, \mathfrak p_0)$.

\medskip\noindent
We prove each of the conditions in turn. Part (1) holds by construction.
For part (2) write $(g \otimes 1) h = 1$ for some
$h \otimes 1/a \in B \otimes_A K$. Write
$g = \sum a_I x^I$, $h = \sum a'_I x^I$ (multi-index notation)
for some coefficients $a_I, a'_I \in A$. As soon as $A_0$ contains
$a$ and the $a_I, a'_I$ then (2) holds because
$B_0 \otimes_{A_0} K_0 \subset B \otimes_A K$ (as localizations of the
injective map $B_0 \to B$).
To achieve (3) consider the exact sequence
$$
0 \to I \to A[X_1, \ldots, X_n] \to B \to 0
$$
which defines $I$ where the second map sends $X_i$ to $x_i$. Since $\otimes$
is right exact we see that $I \otimes_A K$, respectively
$I \otimes_A \kappa(\mathfrak p)$ is the kernel of the surjection
$K[X_1, \ldots, X_n] \to B \otimes_A K$, respectively
$\kappa(\mathfrak p)[X_1, \ldots, X_n] \to B \otimes_A \kappa(\mathfrak p)$.
As a polynomial ring over a field is Noetherian
there exist finitely many elements $h_j \in I$, $j = 1, \ldots, m$
which generate $I \otimes_A K$ and $I \otimes_A \kappa(\mathfrak p)$.
Write $h_j = \sum a_{j, I}X^I$. As soon as
$A_0$ contains all $a_{j, I}$ we get to the situation where
$$
B_0 \otimes_{A_0} K_0 \otimes_{K_0} K = B \otimes_A K
\quad\text{and}\quad
B_0 \otimes_{A_0} \kappa(\mathfrak p_0)
\otimes_{\kappa(\mathfrak p_0)} \kappa(\mathfrak p)
=
B \otimes_A \kappa(\mathfrak p).
$$
By either
Morphisms, Lemma \ref{morphisms-lemma-dimension-fibre-after-base-change}
or
Algebra, Lemma \ref{algebra-lemma-dimension-preserved-field-extension}
we see that the dimension equalities of (3) are satisfied.
Part (4) is immediate. As
$B_0 \otimes_{A_0} \kappa(\mathfrak p_0) \subset
B \otimes_A \kappa(\mathfrak p)$ each minimal prime of
$B_0 \otimes_{A_0} \kappa(\mathfrak p_0)$ lies under a minimal
prime of $B \otimes_A \kappa(\mathfrak p)$ by
Algebra, Lemma \ref{algebra-lemma-image-dense-generic-points}.
This implies that (5) holds.
In this way we reduce the problem to the Noetherian case which we
have dealt with above.
\end{proof}

\noindent
Here is an algebraic application of the lemma above.
The fourth assumption of the lemma holds if $A \to B$ is flat, see
Lemma \ref{lemma-equality-dimensions}.

\begin{lemma}
\label{lemma-horizontal}
Let $A \to B$ be a local homomorphism of local rings, and
$g \in \mathfrak m_B$. Assume
\begin{enumerate}
\item $A$ and $B$ are domains and $A \subset B$,
\item $B$ is essentially of finite type over $A$,
\item $g$ is not contained in any minimal prime over $\mathfrak m_AB$, and
\item $\dim(B/\mathfrak m_AB) +
\text{trdeg}_{\kappa(\mathfrak m_A)}(\kappa(\mathfrak m_B)) =
\text{trdeg}_A(B)$.
\end{enumerate}
Then $A \subset B/gB$, i.e., the generic point of $\text{Spec}(A)$
is in the image of the morphism $\text{Spec}(B/gB) \to \text{Spec}(A)$.
\end{lemma}

\begin{proof}
Note that the two assertions are equivalent by
Algebra, Lemma \ref{algebra-lemma-image-dense-generic-points}.
To start the proof let $C$ be an $A$-algebra of finite type
and $\mathfrak q$ a prime of $C$ such that $B = C_{\mathfrak q}$.
Of course we may assume that $C$ is a domain and that $g \in C$.
After replacing $C$ by a localization we see that
$\dim(C/\mathfrak m_AC) = \dim(B/\mathfrak m_AB) +
\text{trdeg}_{\kappa(\mathfrak m_A)}(\kappa(\mathfrak m_B))$, see
Morphisms, Lemma \ref{morphisms-lemma-dimension-fibre-at-a-point}.
Setting $K = f.f.(A)$ we see by the same reference that
$\dim(C \otimes_A K) = \text{trdeg}_A(B)$. Hence assumption
(4) means that the generic and closed fibres of the morphism
$\text{Spec}(C) \to \text{Spec}(A)$ have the same dimension.

\medskip\noindent
Suppose that the lemma is false. Then $(B/gB) \otimes_A K = 0$.
This means that $g \otimes 1$ is invertible in $B \otimes_A K
= C_{\mathfrak q} \otimes_A K$. As $C_{\mathfrak q}$ is a limit
of principal localizations we conclude that $g \otimes 1$
is invertible in $C_h \otimes_A K$ for some
$h \in C$, $h \not \in \mathfrak q$. Thus after replacing $C$
by $C_h$ we may assume that $(C/gC) \otimes_A K = 0$.
We do one more replacement of $C$ to make sure that the minimal
primes of $C/\mathfrak m_AC$ correspond one-to-one with the minimal
primes of $B/\mathfrak m_AB$. At this point we apply
Lemma \ref{lemma-locally-principal-vertical}
to $X = \text{Spec}(C) \to \text{Spec}(A) = S$ and the locally closed
subscheme $Z = \text{Spec}(C/gC)$. Since $Z_K = \emptyset$ we see that
$Z \otimes \kappa(\mathfrak m_A)$ has to contain an irreducible
component of
$X \otimes \kappa(\mathfrak m_A) = \text{Spec}(C/\mathfrak m_AC)$.
But this contradicts the assumption that $g$ is not contained
in any prime minimal over $\mathfrak m_AB$. The lemma follows.
\end{proof}

\begin{lemma}
\label{lemma-equality-dimensions}
Let $A \to B$ be a local homomorphism of local rings. Assume
\begin{enumerate}
\item $A$ and $B$ are domains and $A \subset B$,
\item $B$ is essentially of finite type over $A$, and
\item $B$ is flat over $A$.
\end{enumerate}
Then we have
$$
\dim(B/\mathfrak m_AB) +
\text{trdeg}_{\kappa(\mathfrak m_A)}(\kappa(\mathfrak m_B)) =
\text{trdeg}_A(B).
$$
\end{lemma}

\begin{proof}
Let $C$ be an $A$-algebra of finite type and $\mathfrak q$ a prime of $C$
such that $B = C_{\mathfrak q}$. We may assume $C$ is a domain.
We have
$\dim_{\mathfrak q}(C/\mathfrak m_AC) = \dim(B/\mathfrak m_AB) +
\text{trdeg}_{\kappa(\mathfrak m_A)}(\kappa(\mathfrak m_B))$, see
Morphisms, Lemma \ref{morphisms-lemma-dimension-fibre-at-a-point}.
Setting $K = f.f.(A)$ we see by the same reference that
$\dim(C \otimes_A K) = \text{trdeg}_A(B)$.
Thus we are really trying to prove that
$\dim_{\mathfrak q}(C/\mathfrak m_AC) = \dim(C \otimes_A K)$.
Choose a valuation ring $A'$ in $K$ dominating $A$, see
Algebra, Lemma \ref{algebra-lemma-dominate}.
Set $C' = C \otimes_A A'$.
Choose a prime $\mathfrak q'$ of $C'$ lying over $\mathfrak q$; such a
prime exists because
$$
C'/\mathfrak m_{A'}C' =
C/\mathfrak m_AC \otimes_{\kappa(\mathfrak m_A)} \kappa(\mathfrak m_{A'})
$$
which proves that $C/\mathfrak m_AC \to C'/\mathfrak m_{A'}C'$ is faithfully
flat. This also proves that
$\dim_{\mathfrak q}(C/\mathfrak m_AC) =
\dim_{\mathfrak q'}(C'/\mathfrak m_{A'}C')$, see
Algebra,
Lemma \ref{algebra-lemma-dimension-at-a-point-preserved-field-extension}.
Note that $B' = C'_{\mathfrak q'}$ is a localization of $B \otimes_A A'$.
Hence $B'$ is flat over $A'$. The generic fibre $B' \otimes_{A'} K$
is a localization of $B \otimes_A K$. Hence $B'$ is a domain.
If we prove the lemma for $A' \subset B'$, then we get the equality
$\dim_{\mathfrak q'}(C'/\mathfrak m_{A'}C') = \dim(C' \otimes_{A'} K)$
which implies the desired equality
$\dim_{\mathfrak q}(C/\mathfrak m_AC) = \dim(C \otimes_A K)$
by what was said above. This reduces the
lemma to the case where $A$ is a valuation ring.

\medskip\noindent
Let $A \subset B$ be as in the lemma with $A$ a valuation ring.
As before write $B = C_{\mathfrak q}$ for some domain $C$ of finite
type over $A$. By
Algebra,
Lemma \ref{algebra-lemma-finite-type-domain-over-valuation-ring-dim-fibres}
we obtain $\dim(C/\mathfrak m_AC) = \dim(C \otimes_A K)$ and we win.
\end{proof}

\begin{lemma}
\label{lemma-closed-point-nearby-fibre}
Let $f : X \to S$ be a morphism of schemes.
Let $x \leadsto x'$ be a specialization of points in $X$.
Set $s = f(x)$ and $s' = f(x')$.
Assume
\begin{enumerate}
\item $x'$ is a closed point of $X_{s'}$, and
\item $f$ is locally of finite type.
\end{enumerate}
Then the set
$$
\{x_1 \in X
\text{ such that }
f(x_1) = s
\text{ and }
x_1\text{ is closed in }X_s
\text{ and }
x \leadsto x_1 \leadsto x'
\}
$$
is dense in the closure of $x$ in $X_s$.
\end{lemma}

\begin{proof}
We apply
Schemes, Lemma \ref{schemes-lemma-points-specialize}
to the specialization $x \leadsto x'$.
This produces a morphism $\varphi : \text{Spec}(B) \to X$
where $B$ is a valuation ring such that $\varphi$ maps the
generic point to $x$ and the closed point to $x'$. We may also
assume that $\kappa(x) = f.f.(B)$.
Let $A = B \cap \kappa(s)$. Note that this is a valuation ring (see
Algebra, Lemma \ref{algebra-lemma-valuation-ring-cap-field})
which dominates the image of $\mathcal{O}_{S, s'} \to \kappa(s)$.
Consider the commutative diagram
$$
\xymatrix{
\text{Spec}(B) \ar[rd] \ar[r] &
X_A \ar[d] \ar[r] & X \ar[d] \\
& \text{Spec}(A) \ar[r] & S
}
$$
The generic (resp.\ closed) point of $B$ maps to a point $x_A$
(resp.\ $x'_A$) of $X_A$ lying over the generic (resp.\ closed)
point of $\text{Spec}(A)$. Note that $x'_A$ is a closed point
of the special fibre of $X_A$ by
Morphisms,
Lemma \ref{morphisms-lemma-base-change-closed-point-fibre-locally-finite-type}.
Note that the generic fibre of $X_A \to \text{Spec}(A)$ is isomorphic
to $X_s$. Thus we have reduced the lemma to the case where $S$ is
the spectrum of a valuation ring, $s = \eta \in S$ is the generic point, and
$s' \in S$ is the closed point.

\medskip\noindent
We will prove the lemma by induction on $\dim_x(X_\eta)$.
If $\dim_x(X_\eta) = 0$, then there are no other points of $X_\eta$
specializing to $x$ and $x$ is closed in its fibre, see
Morphisms, Lemma \ref{morphisms-lemma-quasi-finite-at-point-characterize},
and the result holds. Assume $\dim_x(X_\eta) > 0$.

\medskip\noindent
Let $X' \subset X$ be the reduced induced scheme structure on
the irreducible closed subscheme $\overline{\{x\}}$ of $X$, see
Schemes, Definition \ref{schemes-definition-reduced-induced-scheme}.
To prove the lemma we may replace $X$ by $X'$ as this only decreases
$\dim_x(X_\eta)$. Hence we may also assume that $X$ is an integral scheme
and that $x$ is its generic point. In addition, we may replace $X$ by an
affine neighbourhood of $x'$. Thus we have $X = \text{Spec}(B)$ where
$A \subset B$ is a finite type extension of domains. Note that in
this case $\dim_x(X_\eta) = \dim(X_\eta) = \dim(X_{s'})$, and that in fact
$X_{s'}$ is equidimensional, see
Algebra,
Lemma \ref{algebra-lemma-finite-type-domain-over-valuation-ring-dim-fibres}.

\medskip\noindent
Let $W \subset X_\eta$ be a proper closed subset (this is the
subset we want to ``avoid''). As $X_s$ is of finite type over a field
we see that $W$ has finitely many irreducible components
$W = W_1 \cup \ldots \cup W_n$. Let
$\mathfrak q_j \subset B$, $j = 1, \ldots, r$
be the corresponding prime ideals. Let $\mathfrak q \subset B$
be the maximal ideal corresponding to the point $x'$.
Let $\mathfrak p_1, \ldots, \mathfrak p_s \subset B$ be the
minimal primes lying over $\mathfrak m_AB$. There are finitely
many as these correspond to the irreducible components of the
Noetherian scheme $X_{s'}$. Moreover, each of these irreducible
components has dimension $> 0$ (see above) hence we see that
$\mathfrak p_i \not = \mathfrak q$ for all $i$.
Now, pick an element $g \in \mathfrak q$ such that
$g \not \in \mathfrak q_j$ for all $j$ and $g \not \in \mathfrak p_i$
for all $i$, see
Algebra, Lemma \ref{algebra-lemma-silly}.
Denote $Z \subset X$ the locally principal closed subscheme defined by $h$.
Let $Z_\eta = Z_{1, \eta} \cup \ldots \cup Z_{n, \eta}$, $n \geq 0$
be the decomposition of the generic fibre of $Z$ into irreducible
components (finitely many as the generic fibre is Noetherian).
Denote $Z_i \subset X$ the closure of $Z_{i, \eta}$.
After replacing $X$ by a smaller affine neighbourhood
we may assume that $x \in Z_i$ for each $i = 1, \ldots, n$.
By construction $Z \cap X_{s'}$ does not contain any irreducible
component of $X_{s'}$. Hence by
Lemma \ref{lemma-locally-principal-vertical}
we conclude that $Z_\eta \not = \emptyset$! In other words
$n \geq 1$. Letting $x_1 \in Z_1$ be the generic point we see
that $x_1 \leadsto x'$ and $f(x_1) = \eta$.
Also, by construction $Z_{1, \eta} \cap W_j \subset W_j$
is a proper closed subset. Hence every irreducible component of
$Z_{1, \eta} \cap W_j$ has codimension $\geq 2$ in $X_\eta$
whereas $\text{codim}(Z_{1, \eta}, X_\eta) = 1$ by
Algebra, Lemma \ref{algebra-lemma-minimal-over-1}.
Thus $W \cap Z_{1, \eta}$ is a proper closed subset.
At this point we see that the induction hypothesis applies to
$Z_1 \to S$ and the specialization $x_1 \leadsto x'$.
This produces a closed point $x_2$ of $Z_{1, \eta}$ not contained
in $W$ which specializes to $x'$. Thus we obtain
$x \leadsto x_2 \leadsto x'$, the point $x_2$ is closed in $X_\eta$,
and $x_2 \not \in W$ as desired.
\end{proof}

\begin{remark}
\label{remark-full-specialization-sequence}
The proof of 
Lemma \ref{lemma-closed-point-nearby-fibre}
actually shows that there exists a sequence of specializations
$$
x \leadsto x_1 \leadsto x_2 \leadsto \ldots \leadsto x_d \leadsto x'
$$
where all $x_i$ are in the fibre $X_s$, each specialization is
immediate, and $x_d$ is a closed point of $X_s$. The integer
$d = \text{trdeg}_{\kappa(s)}(\kappa(x)) = \dim(\overline{\{x\}})$
where the closure is taken in $X_s$. Moreover, the points
$x_i$ can be chosen to avoid any closed subset of $X_s$ which
does not contain the point $x$.
\end{remark}

\noindent
Examples, Section \ref{examples-section-topology-finite-type}
shows that the following lemma is false if $A$ is not assumed
Noetherian.

\begin{lemma}
\label{lemma-quasi-finite-quasi-section-meeting-nearby-open}
Let $\varphi : A \to B$ be a local ring map of local rings.
Let $V \subset \text{Spec}(B)$ be a nonempty open subscheme
which contains at least one prime not lying over $\mathfrak m_A$.
Assume $A$ is Noetherian, $\varphi$ essentially of finite type, and
$A/\mathfrak m_A \subset B/\mathfrak m_B$ is finite.
Then there exists a $\mathfrak q \in V$,
$\mathfrak m_A \not = \mathfrak q \cap A$ such that
$A \to B/\mathfrak q$ is the localization of a quasi-finite ring map.
\end{lemma}

\begin{proof}
Since $A$ is Noetherian and $A \to B$ is essentially of finite type,
we know that $B$ is Noetherian too. By
Properties, Lemma \ref{properties-lemma-complement-closed-point-Jacobson}
the topological space $\text{Spec}(B) \setminus \{\mathfrak m_B\}$
is Jacobson. Hence we can choose a closed point $\mathfrak q$
which is contained in the nonempty open
$$
V \setminus \{\mathfrak q \subset B \mid \mathfrak m_A = \mathfrak q \cap A\}.
$$
(Nonempty by assumption, open because $\{\mathfrak m_A\}$ is a closed
subset of $\text{Spec}(A)$.)
Then $\text{Spec}(B/\mathfrak q)$ has two points, namely $\mathfrak m_B$
and $\mathfrak q$ and $\mathfrak q$ does not lie over $\mathfrak m_A$.
Write $B/\mathfrak q = C_{\mathfrak m}$ for some finite type $A$-algebra
$C$ and prime ideal $\mathfrak m$. Then $A \to C$ is quasi-finite at
$\mathfrak m$ by
Algebra, Lemma \ref{algebra-lemma-isolated-point-fibre} (3).
Hence by
Algebra, Lemma \ref{algebra-lemma-quasi-finite-open}
we see that after replacing $C$ by a principal localization the ring
map $A \to C$ is quasi-finite.
\end{proof}

\begin{lemma}
\label{lemma-quasi-finite-quasi-section-meeting-nearby-open-X}
Let $f : X \to S$ be a morphism of schemes.
Let $x \in X$ with image $s \in S$.
Let $U \subset X$ be an open subscheme.
Assume $f$ locally of finite type, $S$ locally Noetherian, $x$ a closed
point of $X_s$, and assume there exists a point $x' \in U$ with
$x' \leadsto x$ and $f(x') \not = s$. Then there exists a closed
subscheme $Z \subset X$ such that (a) $x \in Z$, (b) $f|_Z : Z \to S$ is
quasi-finite at $x$, and (c) there exists a $z \in Z$, $z \in U$,
$z \leadsto x$ and $f(z) \not = s$.
\end{lemma}

\begin{proof}
This is a reformulation of
Lemma \ref{lemma-quasi-finite-quasi-section-meeting-nearby-open}.
Namely, set $A = \mathcal{O}_{S, s}$ and $B = \mathcal{O}_{X, x}$.
Denote $V \subset \text{Spec}(B)$ the inverse image of $U$.
The ring map $f^\sharp : A \to B$ is essentially of finite type.
By assumption there exists at least one point of $V$ which does not
map to the closed point of $\text{Spec}(A)$. Hence all the assumptions of
Lemma \ref{lemma-quasi-finite-quasi-section-meeting-nearby-open}
hold and we obtain a prime $\mathfrak q \subset B$ which does not
lie over $\mathfrak m_A$ and such that $A \to B/\mathfrak q$ is
the localization of a quasi-finite ring map. Let $z \in X$ be the
image of the point $\mathfrak q$ under the canonical
morphism $\text{Spec}(B) \to X$. Set $Z = \overline{\{z\}}$
with the induced reduced scheme structure. As $z \leadsto x$
we see that $x \in Z$ and $\mathcal{O}_{Z, x} = B/\mathfrak q$.
By construction $Z \to S$ is quasi-finite at $x$.
\end{proof}

\begin{remark}
\label{remark-alternative-closed-point-nearby-fibre}
We can use
Lemma \ref{lemma-quasi-finite-quasi-section-meeting-nearby-open}
or its variant
Lemma \ref{lemma-quasi-finite-quasi-section-meeting-nearby-open-X}
to give an alternative proof of
Lemma \ref{lemma-closed-point-nearby-fibre}
in case $S$ is locally Noetherian.
Here is a rough sketch.
Namely, first replace $S$ by
the spectrum of the local ring at $s'$. Then we may use induction
on $\dim(S)$. The case $\dim(S) = 0$ is trivial because then $s' = s$.
Replace $X$ by the reduced induced scheme structure on $\overline{\{x\}}$.
Apply
Lemma \ref{lemma-quasi-finite-quasi-section-meeting-nearby-open-X}
to $X \to S$ and $x' \mapsto s'$ and any nonempty
open $U \subset X$ containing $x$. This gives us a closed subscheme
$x' \in Z \subset X$ a point $z \in Z$
such that $Z \to S$ is quasi-finite at $x'$ and such that $f(z) \not = s'$.
Then $z$ is a closed point of $X_{f(z)}$, and $z \leadsto x'$.
As $f(z) \not = s'$ we see $\dim(\mathcal{O}_{S, f(z)}) < \dim(S)$.
Since $x$ is the generic point of $X$ we see $x \leadsto z$, hence
$s = f(x) \leadsto f(z)$.
Apply the induction hypothesis to $s \leadsto f(z)$ and $z \mapsto f(z)$
to win.
\end{remark}

\begin{lemma}
\label{lemma-change-hypotheses}
Suppose that $f : X \to S$ is locally of finite type, $S$ locally Noetherian,
$x \in X$ a closed point of its fibre $X_s$, and $U \subset X$ an open
subscheme such that $U \cap X_s = \emptyset$ and $x \in \overline{U}$, then
the conclusions of
Lemma \ref{lemma-quasi-finite-quasi-section-meeting-nearby-open-X}
hold.
\end{lemma}

\begin{proof}
Namely, we can reduce this to the cited lemma as follows: First we
replace $X$ and $S$ by affine neighbourhoods of $x$ and $s$. Then $X$ is
Noetherian, in particular $U$ is quasi-compact (see
Morphisms, Lemma \ref{morphisms-lemma-finite-type-noetherian}
and
Topology, Lemmas \ref{topology-lemma-Noetherian} and
\ref{topology-lemma-Noetherian-quasi-compact}).
Hence there exists a specialization $x' \leadsto x$ with $x' \in U$ (see
Morphisms, Lemma \ref{morphisms-lemma-reach-points-scheme-theoretic-image}).
Note that $f(x') \not = s$. Thus we see all hypotheses of the lemma
are satisfied and we win.
\end{proof}



\section{Stein factorization}
\label{section-stein-factorization}

\noindent
Stein factorization is the statement that a proper morphism $f : X \to S$
with $f_*\mathcal{O}_X = \mathcal{O}_S$ has connected fibres.

\begin{lemma}
\label{lemma-stein-universally-closed}
Let $S$ be a scheme.
Let $f : X \to S$ be a universally closed, quasi-compact and
quasi-separated morphism.
There exists a factorization
$$
\xymatrix{
X \ar[rr]_{f'} \ar[rd]_f & & S' \ar[dl]^\pi \\
& S &
}
$$
with the following properties:
\begin{enumerate}
\item the morphism $f'$ is universally closed, quasi-compact, quasi-separated
and surjective,
\item the morphism $\pi : S' \to S$ is integral,
\item we have $f'_*\mathcal{O}_X = \mathcal{O}_{S'}$,
\item we have $S' = \underline{\text{Spec}}_S(f_*\mathcal{O}_X)$, and
\item $S'$ is the normalization of $S$ in $X$, see
Morphisms, Definition \ref{morphisms-definition-normalization-X-in-Y}.
\end{enumerate}
\end{lemma}

\begin{proof}
We just define $S'$ as the normalization of $S$ in $X$, so (5) and (2) hold
automatically. By
Morphisms, Lemma \ref{morphisms-lemma-normalization-in-universally-closed}
we see that (4) holds. The morphism $f'$ is universally closed by
Morphisms, Lemma \ref{morphisms-lemma-image-proper-scheme-closed}.
It is quasi-compact by
Schemes, Lemma \ref{schemes-lemma-quasi-compact-permanence}
and quasi-separated by
Schemes, Lemma \ref{schemes-lemma-compose-after-separated}.

\medskip\noindent
To show the remaining statements we may assume the base scheme $S$ is affine,
say $S = \text{Spec}(R)$. Then $S' = \text{Spec}(A)$ with
$A = \Gamma(X, \mathcal{O}_X)$ an integral $R$-algebra.
Thus it is clear that $f'_*\mathcal{O}_X$
is $\mathcal{O}_{S'}$ (because $f'_*\mathcal{O}_X$ is quasi-coherent,
by schemes, Lemma \ref{schemes-lemma-push-forward-quasi-coherent},
and hence equal to $\widetilde{A}$). This proves (3).

\medskip\noindent
Let us show that $f'$ is surjective. As $f'$ is universally closed (see above)
the image of $f'$ is a closed subset
$V(I) \subset S' = \text{Spec}(A)$. Pick $h \in I$. Then
$h|_X = f^\sharp(h)$ is a global section of the structure sheaf of
$X$ which vanishes at every point. As $X$ is quasi-compact this means
that $h|_X$ is a nilpotent section, i.e., $h^n|X = 0$ for some $n > 0$.
But $A = \Gamma(X, \mathcal{O}_X)$, hence $h^n = 0$.
In other words $I$ is contained in the radical ideal of $A$ and we conclude
that $V(I) = S'$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-characterize-geometrically-connected-fibres}
Let $f : X \to S$ be a morphism of schemes.
Let $s \in S$. Then $X_s$ is geometrically connected, if and
only if for every \'etale neighbourhood $(U, u) \to (S, s)$
the base change $X_U \to U$ as connected fibre $X_u$.
\end{lemma}

\begin{proof}
If $X_s$ is geometrically connected, then any base change of it is connected.
On the other hand, suppose that $X_s$ is not geometrically connected.
Then by
Varieties, Lemma
\ref{varieties-lemma-characterize-geometrically-disconnected}
we see that $X_s \times_{\text{Spec}(\kappa(s)} \text{Spec}(k)$ is
disconnected for some
finite separable field extension $\kappa(s) \subset k$. By
Lemma \ref{lemma-realize-presecribed-residue-field-extension-etale}
there exists an affine \'etale neighbourhood $(U, u) \to (S, s)$ such that
$\kappa(s) \subset \kappa(u)$ is identified with $\kappa(s) \subset k$.
In this case $X_u$ is disconnected.
\end{proof}

\begin{theorem}
\label{theorem-stein-factorization-Noetherian}
(Stein factorization -- Noetherian case)
Let $S$ be a locally Noetherian scheme.
Let $f : X \to S$ be a proper morphism.
There exists a factorization
$$
\xymatrix{
X \ar[rr]_{f'} \ar[rd]_f & & S' \ar[dl]^\pi \\
& S &
}
$$
with the following properties:
\begin{enumerate}
\item the morphism $f'$ is proper, surjective
with geometrically connected fibres,
\item the morphism $\pi : S' \to S$ is finite,
\item we have $f'_*\mathcal{O}_X = \mathcal{O}_{S'}$,
\item we have $S' = \underline{\text{Spec}}_S(f_*\mathcal{O}_X)$, and
\item $S'$ is the normalization of $S$ in $X$, see
Morphisms, Definition \ref{morphisms-definition-normalization-X-in-Y}.
\end{enumerate}
\end{theorem}

\begin{proof}
Let $f = \pi \circ f'$ be the factorization of
Lemma \ref{lemma-stein-universally-closed}. Note that besides the
conclusions of Lemma \ref{lemma-stein-universally-closed} we
also have that $f'$ is separated
(Schemes, Lemma \ref{schemes-lemma-compose-after-separated})
and finite type
(Morphisms, Lemma \ref{morphisms-lemma-permanence-finite-type}).
Hence $f'$ is proper. By
Coherent, Lemma \ref{coherent-lemma-proper-pushforward-coherent}
we see that $f_*\mathcal{O}_X$ is a coherent $\mathcal{O}_S$-module.
Hence we see that $\pi$ is finite, i.e., (2) holds.

\medskip\noindent
This proves all but the most interesting assertion, namely that
all the fibres of $f'$ are geometrically connected.
It is clear from the discussion above that we may replace $S$ by $S'$,
and we may therefore assume that $S$ is Noetherian, affine,
$f : X \to S$ is proper, and $f_*\mathcal{O}_X = \mathcal{O}_S$.
Let $s \in S$ be a point of $S$. We have to show that $X_s$ is
geometrically connected. By Lemma
\ref{lemma-characterize-geometrically-connected-fibres}
we see that it suffices to show $X_u$ is connected
for every \'etale neighbourhood $(U, u) \to (S, s)$.
We may assume $U$ is affine. Thus $U$ is Noetherian
(Morphisms, Lemma \ref{morphisms-lemma-finite-type-noetherian}),
the base change $f_U : X_U \to U$ is proper
(Morphisms, Lemma \ref{morphisms-lemma-base-change-proper}),
and that also $(f_U)_*\mathcal{O}_{X_U} = \mathcal{O}_U$
(Coherent, Lemma \ref{coherent-lemma-flat-base-change-cohomology}).
Hence after replacing
$(f : X \to S, s)$ by the base change $(f_U : X_U \to U, u)$
it suffices to prove that the fibre $X_s$ is connected.

\medskip\noindent
At this point we apply the theorem on formal functions,
more precisely Coherent, Lemma \ref{coherent-lemma-formal-functions-stalk}.
It tells us that
$$
\mathcal{O}^\wedge_{S, s} =
\text{lim}_n\ H^0(X_n, \mathcal{O}_{X_n})
$$
where $X_n$ is the $n$th infinitesimal neighbourhood of $X_s$.
Since the underlying topological space of $X_n$ is equal to that
of $X_s$ we see that if $X_s = T_1 \coprod T_2$ is a disjoint union
of nonempty open and closed subschemes, then similarly
$X_n = T_{1, n} \coprod T_{2, n}$ for all $n$. And this in turn means
$H^0(X_n, \mathcal{O}_{X_n})$ contains a nontrivial idempotent $e_{1, n}$,
namely the function which is identically $1$ on $T_{1, n}$ and
identically $0$ on $T_{2, n}$. It is clear that $e_{1, n + 1}$
restricts to $e_{1, n}$ on $X_n$. Hence $e_1 = \lim e_{1, n}$
is a nontrivial idempotent of the limit. This contradicts the fact
that $\mathcal{O}^\wedge_{S, s}$ is a local ring. Thus the
assumption was wrong, i.e., $X_s$ is connected, and we win.
\end{proof}

\begin{lemma}
\label{lemma-stein-projective}
Let $(R, \mathfrak m, \kappa)$ be a local ring.
Let $X \subset \mathbf{P}^n_R$ be a closed subscheme.
Assume that $R = \Gamma(X, \mathcal{O}_X)$. Then the special fibre
$X_k$ is geometrically connected.
\end{lemma}

\begin{proof}
Let $R \to R'$ be a flat local ring map so that the residue field of
$R'$ is algebraically closed, see
Algebra, Lemma \ref{algebra-lemma-flat-local-given-residue-field}.
By Coherent, Lemma \ref{coherent-lemma-flat-base-change-cohomology}
we have
$\Gamma(X_{R'}, \mathcal{O}_{X_{R'}}) = R'$.
Hence we may assume that the residue field of $R$ is algebraically
closed. This reduces us to just proving that $X_k$ is connected.
(We could also have used
Lemma \ref{lemma-characterize-geometrically-connected-fibres} for this.)

\medskip\noindent
Suppose, to get a contradiction,
that $X_k = T_1 \coprod T_2$ for some closed and open subschemes
$T_i \subset X_k$. By
Constructions, Lemma \ref{constructions-lemma-closed-in-projective-space}
we can write
$$
X = \text{Proj}(R[T_0, \ldots, T_n]/I)
$$
for some graded ideal $I \subset R[T_0, \ldots, T_n]$.
We may write $R = \text{colim}_\alpha\ R_\alpha$ as a directed
colimit of Noetherian local rings $R_\alpha$, see
Algebra, Lemma \ref{algebra-lemma-limit-no-condition-local}.
Let $k_\alpha$ be the residue field of $R_\alpha$.
Let $I_\alpha = R_\alpha[T_0, \ldots, T_n] \cap I$ (or more precisely
the inverse image). Then $I = \text{colim}_\alpha\ I_\alpha$. Let
$X_\alpha = \text{Proj}(R_\alpha[T_0, \ldots, T_n]/I_\alpha)$.
Warning: because $I$ may not be finitely generated it may be
that the natural morphism
$$
X \longrightarrow X_\alpha \times_{\text{Spec}(R_\alpha)} \text{Spec}(R)
$$
is never an isomorphism!
The image $\overline{I} \subset k[T_0, \ldots, T_n]$ of $I$ is finitely
generated as $k[T_0, \ldots, T_n]$ is a Noetherian ring.
Hence for all large enough $\alpha$ the image
$\overline{I}_\alpha \subset k_\alpha[T_0, \ldots, T_n]$
of $I_\alpha$ is such that
$\overline{I}_\alpha k[T_0, \ldots, T_n] = \overline{I}$.
Let $J_1, J_2 \subset k[T_0, \ldots, T_n]$ be graded ideals such
that $T_i = \text{Proj}(k[T_0, \ldots, T_n]/J_i)$, see
Constructions, Lemma \ref{constructions-lemma-closed-in-projective-space}
again. Since $R = \text{colim}_\alpha\ R_\alpha$, also
$k = \text{colim}_\alpha\ k_\alpha$.
Thus for all large enough $\alpha$ there exist ideals
$J_{\alpha, 1}, J_{\alpha, 2} \subset k_\alpha[T_0, \ldots, T_n]$
such that $J_{\alpha, i} k[T_0, \ldots, T_n] = J_i$.
Combining these observations, we see that there exists
an $\alpha$ such that
\begin{enumerate}
\item the morphism $X_\alpha \to \text{Spec}(R_\alpha)$
has the property that
$$
X_\alpha \times_{\text{Spec}(R_\alpha)} \text{Spec}(k)
=
(X_\alpha)_{k_\alpha} \times_{\text{Spec}(k_\alpha)} \text{Spec}(k)
=
X_k,
$$
and
\item there exists a decomposition
$(X_\alpha)_{k_\alpha} = T_{\alpha, 1} \coprod T_{\alpha, 2}$ such
that $(T_{\alpha, i})_k = T_i$.
\end{enumerate}
By the Noetherian case (Theorem \ref{theorem-stein-factorization-Noetherian})
this means there exists a factorization
$$
X_\alpha \longrightarrow
\text{Spec}(R') \longrightarrow
\text{Spec}(R_\alpha)
$$
with $R_\alpha \to R'$ finite and $X_\alpha \to \text{Spec}(R')$
having geometrically connected fibres. Let $t_i \in T_i$
be a point, let $t_{\alpha, i} \in T_{\alpha, i}$ be the image points,
and let $\mathfrak m_i \subset R'$ be the corresponding maximal
ideals. Then $\mathfrak m_1 \not = \mathfrak m_2$ by the connectedness
of the fibres. This implies that $X \to \text{Spec}(R)$ factors as
$$
X \longrightarrow
\text{Spec}(R \otimes_{R_\alpha} R') \longrightarrow
\text{Spec}(R)
$$
Because $t_1$ and $t_2$ map to distinct points in $\text{Spec}(R')$
we see that $t_1$ and $t_2$ must also map to distinct points in
$\text{Spec}(R \otimes_{R_\alpha} R')$. Hence there exists an
element $f \in R \otimes_{R_\alpha} R'$ such that
$f|_X$ is zero in $t_1$ and not in $t_2$ (or vice versa).
This clearly contradicts
the assumption that $R = \Gamma(X, \mathcal{O}_X)$ and we win.
\end{proof}

\begin{theorem}
\label{theorem-stein-factorization-general}
(Stein factorization -- general case)
Let $S$ be a scheme.
Let $f : X \to S$ be a proper morphism.
There exists a factorization
$$
\xymatrix{
X \ar[rr]_{f'} \ar[rd]_f & & S' \ar[dl]^\pi \\
& S &
}
$$
with the following properties:
\begin{enumerate}
\item the morphism $f'$ is proper, surjective
with geometrically connected fibres,
\item the morphism $\pi : S' \to S$ is integral,
\item we have $f'_*\mathcal{O}_X = \mathcal{O}_{S'}$,
\item we have $S' = \underline{\text{Spec}}_S(f_*\mathcal{O}_X)$, and
\item $S'$ is the normalization of $S$ in $X$, see
Morphisms, Definition \ref{morphisms-definition-normalization-X-in-Y}.
\end{enumerate}
\end{theorem}

\begin{proof}
We may apply Lemma \ref{lemma-stein-universally-closed} to get the
morphism $f' : X \to S'$. 
Note that besides the
conclusions of Lemma \ref{lemma-stein-universally-closed} we
also have that $f'$ is separated
(Schemes, Lemma \ref{schemes-lemma-compose-after-separated})
and finite type
(Morphisms, Lemma \ref{morphisms-lemma-permanence-finite-type}).
Hence $f'$ is proper. At this point we have proved all of the
statements except for the statement
that $f'$ has geometrically connected fibres.

\medskip\noindent
To prove this we may assume that $S = \text{Spec}(R)$ is affine.
Use Limits, Lemma \ref{limits-lemma-chow-finite-type}
to choose a diagram
$$
\xymatrix{
X \ar[rd]_f & X' \ar[d] \ar[l]^\pi \ar[r] & \mathbf{P}^n_R \ar[dl] \\
& S = \text{Spec}(R) &
}
$$
where $X' \to \mathbf{P}^n_S$ is an immersion, and $\pi : X' \to X$ is proper
and surjective. Thus $X' \to S$ is proper, hence $X' \to \mathbf{P}^n_R$ is
a closed immersion. (See
Morphisms, Lemmas \ref{morphisms-lemma-composition-proper}
and \ref{morphisms-lemma-image-proper-scheme-closed}
and Schemes, Lemma \ref{schemes-lemma-immersion-when-closed}).
Set $A = \Gamma(X, \mathcal{O}_X)$, and
$A' = \Gamma(X', \mathcal{O}_{X'})$. Then $S' = \text{Spec}(A)$.
Consider the diagram
\begin{equation}
\label{equation-stein-general}
\xymatrix{
X \ar[d]_{f'} & X' \ar[l]^\pi \ar[d]_g \ar[r] & \mathbf{P}^n_{A'} \ar[dl] \\
\text{Spec}(A) & \text{Spec}(A') \ar[l]
}
\end{equation}
Here $\pi$ is surjective and proper, the vertical arrows are proper and
surjective, the right horizontal arrow is a closed immersion, and
$\text{Spec}(A') \to \text{Spec}(A)$ is integral (see arguments above).
Let $\mathfrak p \subset A$ be a prime, corresponding to a point
$p \in \text{Spec}(A)$. Let $X_p$ be the fibre. We have to show that
$X_p$ is geometrically connected. By
Lemma \ref{lemma-characterize-geometrically-connected-fibres}
it suffices to show
that for every \'etale ring map $A \to B$ and a prime $\mathfrak q$ of $B$
lying over $\mathfrak p$ the fibre of $X_B$ over $\mathfrak q$
is connected. As an \'etale ring map is flat, we see from
Coherent, Lemma \ref{coherent-lemma-flat-base-change-cohomology}
that we have
$$
\Gamma(X_B, \mathcal{O}_{X_B}) = B,
$$
and similarly
$$
\Gamma(X' \times_{\text{Spec}(A)} \text{Spec}(B), \mathcal{O}) = 
\Gamma(X' \times_{\text{Spec}(A')} \text{Spec}(B \otimes_A A'), \mathcal{O}) =
B \otimes_A A'.
$$
This means that everything we said above about the diagram
(\ref{equation-stein-general}) also holds for that diagram base changed
to $B$ (some verifications omitted).
Hence we may replace $A$ by $B$ and we reduce to proving that
$X_p$ is connected.

\medskip\noindent
Consider the scheme $X'_p = \pi^{-1}(f')^{-1}(p)$.
It is proper over $\kappa(p)$, hence Noetherian, and hence has finitely
many connected components. The morphism $g$ is surjective, hence any
point $p'$ of $\text{Spec}(A')$ lying over $p$ is the image
of a point of $X'_p$. On the other hand, there are no specializations
among the points of $\text{Spec}(A')$ lying over $p$, see
Morphisms, Lemma \ref{morphisms-lemma-integral-fibres}.
Hence the map
$$
X'_p \longrightarrow \{p' \in \text{Spec}(A') \mid p' \text{ lies over } p\}
$$
is surjective and constant on connected components. Thus we see
there are finitely many points $p_1', \ldots, p_n' \in \text{Spec}(A')$
of $\text{Spec}(A')$ lying over $p$.
Let $\mathfrak p_1', \ldots, \mathfrak p_n'$ be the corresponding
primes of $A'$, i.e., those lying over $\mathfrak p$.
Let $A'' \subset A'$ be a finitely generated $A$-subalgebra such that
the primes $A'' \cap \mathfrak p_i'$ are pairwise distinct.
Such an $A'' \subset A'$ exists; argument omitted.
As $A \subset A'$ is integral, this implies that $A''$ is finite over $A$, see
Algebra, Lemma \ref{algebra-lemma-characterize-finite-in-terms-of-integral}.
Note that that $\mathfrak p_1' \cap A'', \ldots, \mathfrak p_n' \cap A''$
are the only primes of $A''$ lying over $\mathfrak p$ as
$\text{Spec}(A') \to \text{Spec}(A'')$ is surjective, see
Algebra, Lemma \ref{algebra-lemma-integral-overring-surjective}.
By
Algebra, Lemma \ref{algebra-lemma-etale-makes-quasi-finite-finite}
there exists an \'etale ring map $A \to B$ and a prime $\mathfrak q$ lying
over $\mathfrak p$ such that $\kappa(\mathfrak p) = \kappa(\mathfrak q)$
and $B \otimes_A A'' = B_1'' \times \ldots \times B_n''$
decomposes into algebras $B_i''$ finite over $B$ each with a single prime
lying over $\mathfrak q$. Hence also
$B \otimes_A A' = B_1' \times \ldots \times B_n'$
decomposes into algebras $B_i'$ integral over $B$ each with a single prime
lying over $\mathfrak q$ (namely by taking $B_i' = B_i'' \otimes_{A''} A'$).
After base changing the sitatuation to $B$ as above, we see that we may assume
$\text{Spec}(A') = V_1 \coprod \ldots \coprod V_n$
each with a single point $p_i' \in V_i$ lying over $p$.

\medskip\noindent
Let $X_i' \subset X'$ be the inverse image of $V_i$.
Note that
$$
X'_p = \coprod X'_{i, p} = \coprod X'_{p_i'}.
$$
Since $\Gamma(X', \mathcal{O}_{X'}) = A'$, and since $X'$
is a closed subscheme of $\mathbf{P}^n_{A'}$ we may apply
Lemma \ref{lemma-stein-projective} to
we see that $g : X' \to \text{Spec}(A')$ has geometrically connected fibres.
Hence each $X'_{i, p} = X'_{p_i'}$ is connected!
Hence, if $T \subset X_p$ is open and closed, then
$\pi^{-1}(T) \subset X'_p$ is a disjoint union
$\pi^{-1}(T) = \coprod_{i \in I} X'_{i, p}$ for some subset
$I \subset \{1, \ldots, n\}$. Let $J = I^c \subset \{1, \ldots, n\}$
be the complement. Set
$$
X_I = \bigcup\nolimits_{i \in I} \pi(X'_i),
\quad\text{and}\quad
X_J = \bigcup\nolimits_{j \in J} \pi(X'_j).
$$
These are closed subsets whose union is $X$ and
which do not meet in the special fibre $X_p$.
Since $f' : X \to \text{Spec}(A)$ is proper hence closed we see that
$f'(X_I \cap X_J)$ is a closed subset of $\text{Spec}(A)$ which
does not meet $p$. Hence after replacing $A$ by $A_g$ for some $g \in A$,
$g \not \in \mathfrak p$ (i.e., doing a base change with $B = A_g$ as
above) we see that $X_I \cap X_J = \emptyset$.
Thus we conclude that $X_I$ and $X_J$ are open and closed in $X$, and
$$
\Gamma(X, \mathcal{O}_X) = 
\Gamma(X_I, \mathcal{O}_{X_I}) \times
\Gamma(X_J, \mathcal{O}_{X_J}).
$$
If $I$ and $J$ are both nonempty then we see that $\Gamma(X, \mathcal{O}_X)$
contains an idempotent which cannot be the image of an idempotent in $A$!
This contradicts the assumption that $A = \Gamma(X, \mathcal{O}_X)$, hence
either $I = \emptyset$ or $J = \emptyset$. In other words, either
$T = X_p$ or $T = \emptyset$ , i.e., $X_p$ is connected as desired.
\end{proof}



















\section{Descending separated locally quasi-finite morphisms}
\label{section-separated-locally-quasi-finite}

\noindent
In this section we show that ``separated locally quasi-finite morphisms
satisfy descent for fppf-coverings''. See Descent, Definition
\ref{descent-definition-descending-types-morphisms} for terminology.
This is in the marvellous
(for many reasons) paper by Raynaud and Gruson hidden in the proof
of \cite[Lemma 5.7.1]{GruRay}.
It can also be found in \cite{Murre-representation}, and
\cite[Expos\'e X, Lemma 5.4]{SGA3}
under the additional
hypothesis that the morphism is locally of finite presentation.
Here is the formal statement.

\begin{lemma}
\label{lemma-separated-locally-quasi-finite-morphisms-fppf-descend}
Let $S$ be a scheme.
Let $\{X_i \to S\}_{i\in I}$ be an fppf covering, see
Topologies, Definition \ref{topologies-definition-fppf-covering}.
Let $(V_i/X_i, \varphi_{ij})$ be a descent datum
relative to $\{X_i \to S\}$. If each morphism
$V_i \to X_i$ is separated and locally quasi-finite,
then the descent datum is effective.
\end{lemma}

\begin{proof}
Being separated and being locally quasi-finite
are properties of morphisms of schemes
which are preserved under any base change, see
Schemes, Lemma \ref{schemes-lemma-separated-permanence} and
Morphisms, Lemma \ref{morphisms-lemma-base-change-quasi-finite}.
Hence Descent, Lemma \ref{descent-lemma-descending-types-morphisms}
applies and it suffices to prove the statement of the lemma
in case the fppf-covering is given by a single
$\{X \to S\}$ flat surjective morphism of finite presentation of affines.
Say $X = \text{Spec}(A)$ and $S = \text{Spec}(R)$ so
that $R \to A$ is a faithfully flat ring map.
Let $(V, \varphi)$ be a descent datum relative to $X$ over $S$
and assume that $\pi : V \to X$ is separated and
locally quasi-finite.

\medskip\noindent
Let $W^1 \subset V$ be any affine open.
Consider $W = \text{pr}_1(\varphi(W^1 \times_S X)) \subset V$.
Here is a picture
$$
\xymatrix{
W^1 \times_S X \ar[rrrrr] \ar[ddd] \ar[rd]
& & & & &
\varphi(W^1 \times_S X) \ar[ddd] \ar[ld] \\
& V \times_S X \ar[rrr]^\varphi \ar[rd] \ar[dd]
& & &
X \times_S V \ar[ld] \ar[dd] & \\
& &
X \times_S X \ar[r]^1 \ar[d]_{\text{pr}_0}
&
X \times_S X \ar[d]^{\text{pr}_1}
& & \\
W^1 \ar[r] &
V \ar[r] &
X &
X &
V \ar[l] &
W \ar[l]
}
$$
Ok, and now since $X \to S$ is flat and of finite presentation it
is universally open (Morphisms, Lemma \ref{morphisms-lemma-fppf-open}).
Hence we conclude that $W$ is open. Moreover, it is
also clearly the case that $W$ is quasi-compact, and
$W^1 \subset W$. Moreover, we note that
$\varphi(W \times_S X) = X \times_S W$ by the cocycle
condition for $\varphi$. Hence we obtain a new descent datum
$(W, \varphi')$ by restricting $\varphi$ to $W \times_S X$.
Note that the morphism $W \to X$ is quasi-compact, separated
and locally quasi-finite. This implies that it is
separated and quasi-finite by definition. Hence it is quasi-affine by
Lemma \ref{lemma-quasi-finite-separated-quasi-affine}.
Thus by
Descent, Lemma \ref{descent-lemma-quasi-affine}
we see that the descent datum
$(W, \varphi')$ is effective.

\medskip\noindent
In other words, we find that there exists an open covering
$V = \bigcup W_i$ by quasi-compact opens $W_i$ which are
stable for the descent morphism $\varphi$.
Moreover, for each such quasi-compact open $W \subset V$
the corresponding descent data $(W, \varphi')$ is effective.
It is an exercise to show this means the
original descent datum is effective by glueing the
schemes obtained from descending the opens $W_i$ (details omitted).
\end{proof}
























\input{chapters}

\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}
