\input{preamble}

% OK, start here.
%
\begin{document}

\title{More \'Etale Cohomology}


\maketitle

\phantomsection
\label{section-phantom}

\tableofcontents


\section{Introduction}
\label{section-introduction}

\noindent
This chapter is the second in a series of chapter on the \'etale cohomology
of schemes. To read the first chapter, please visit
\'Etale Cohomology, Section \ref{etale-cohomology-section-introduction}.

\medskip\noindent
The split with the previous chapter is roughly speaking that anything
concerning ``shriek functors'' (cohomology with compact support and
its right adjoint) and anything using this material goes into this chapter.










\section{Sections with compact support}
\label{section-compact-support}

\noindent
A reference for this section is \cite[Exposee XVII, Section 6]{SGA4}.
Let $f : X \to Y$ be a morphism of schemes which is separated and
locally of finite type. In this section we define a functor
$f_! : \textit{Ab}(X_\etale) \to \textit{Ab}(Y_\etale)$
by taking $f_!\mathcal{F} \subset f_*\mathcal{F}$
to be the subsheaf of sections which have proper support relative to $Y$
(suitably defined).

\medskip\noindent
Warning: The functor $f_!$ is the zeroth cohomology sheaf of a functor
$Rf_!$ on the derived category (insert future reference), but
$Rf_!$ is not the derived functor of $f_!$.

\begin{lemma}
\label{lemma-f-shriek-separated}
Let $f : X \to Y$ be a morphism of schemes which is locally of finite type.
Let $\mathcal{F}$ be an abelian sheaf on $X_\etale$. The rule
$$
Y_\etale \longrightarrow \textit{Ab},\quad
V \longmapsto \{s \in f_*\mathcal{F}(V) = \mathcal{F}(X_V) \mid
\text{Supp}(s) \subset X_V \text{ is proper over }V\}
$$
is an abelian subsheaf of $f_*\mathcal{F}$.
\end{lemma}

\noindent
Warning: This sheaf isn't the ``correct one'' if $f$ is not separated.

\begin{proof}
Recall that the support of a section is closed
(\'Etale Cohomology, Lemma \ref{etale-cohomology-lemma-support-section-closed})
hence the material in
Cohomology of Schemes, Section \ref{coherent-section-proper-over-base}
applies. By the lemma above and
Cohomology of Schemes, Lemma \ref{coherent-lemma-union-closed-proper-over-base}
we find that our subset of $f_*\mathcal{F}(V)$ is a subgroup.
By Cohomology of Schemes, Lemma
\ref{coherent-lemma-base-change-closed-proper-over-base}
we see that our rule defines a sub presheaf.
Finally, suppose that we have $s \in f_*\mathcal{F}(V)$
and an \'etale covering $\{V_i \to V\}$ such that
$s|_{V_i}$ has support proper over $V_i$.
Observe that the support of $s|_{V_i}$ is the inverse
image of the support of $s|_V$ (use the characterization
of the support in terms of stalks and
\'Etale Cohomology, Lemma \ref{etale-cohomology-lemma-stalk-pullback}).
Whence the support of $s$ is proper of $V$ by
Descent, Lemma \ref{descent-lemma-descending-property-proper-over-base}.
This proves that our rule satisfies the sheaf condition.
\end{proof}

\begin{lemma}
\label{lemma-separated-etale-shriek}
Let $j : U \to X$ be a separated \'etale morphism. Let $\mathcal{F}$
be an abelian sheaf on $U_\etale$. The image of the injective map
$j_!\mathcal{F} \to j_*\mathcal{F}$ of
\'Etale Cohomology, Lemma
\ref{etale-cohomology-lemma-shriek-into-star-separated-etale}
is the subsheaf of Lemma \ref{lemma-f-shriek-separated}.
\end{lemma}

\noindent
An alternative would be to move this lemma later and prove this
using the descrition of the stalks of both sheaves.

\begin{proof}
The construction of $j_!\mathcal{F} \to j_*\mathcal{F}$ in the proof of
\'Etale Cohomology, Lemma
\ref{etale-cohomology-lemma-shriek-into-star-separated-etale}
is via the construction of a map
$j_{p!}\mathcal{F} \to j_*\mathcal{F}$ of presheaves
whose image is clearly contained in the subsheaf of
Lemma \ref{lemma-f-shriek-separated}.
Hence since $j_!\mathcal{F}$ is the sheafification of
$j_{p!}\mathcal{F}$ we conclude the image of
$j_!\mathcal{F} \to j_*\mathcal{F}$ is contained in
this subsheaf. Conversely, let $s \in j_*\mathcal{F}(V)$
have support $Z$ proper over $V$. Then $Z \to V$ is
finite with closed image $Z' \subset V$, see
More on Morphisms, Lemma \ref{more-morphisms-lemma-characterize-finite}.
The restriction of $s$ to $V \setminus Z'$ is zero and hence
contained in the image of $j_!\mathcal{F} \to j_*\mathcal{F}$.
On the other hand, if $v \in Z'$, then we can find
an \'etale neighbourhood
$(V', v') \to (V, v)$ such that we have a decomposition
$U_{V'} = W \amalg U'_1 \amalg \ldots \amalg U'_n$
into open and closed subschemes with $U'_i \to V'$ an isomorphism
and with $T_{V'} \subset U'_1 \amalg \ldots \amalg U'_n$, see
\'Etale Morphisms, Lemma \ref{etale-lemma-etale-etale-local-technical}.
Inverting the isomorphisms $U'_i \to V'$
we obtain $n$ morphisms $\varphi'_i : V' \to U$
and sections $s'_i$ over $V'$ by pulling back $s$.
Then the section $\sum (\varphi'_i, s'_i)$ of
$j_{p!}\mathcal{F}$ over $V'$, see formula for $j_{p!}\mathcal{F}(V')$
in proof of \'Etale Cohomology, Lemma
\ref{etale-cohomology-lemma-shriek-into-star-separated-etale},
maps to the restriction of $s$ to $V'$ by construction.
We conclude that $s$ is \'etale locally in the image
of $j_!\mathcal{F} \to j_*\mathcal{F}$ and the proof is complete.
\end{proof}

\begin{definition}
\label{definition-f-shriek-separated}
Let $f : X \to Y$ be a morphism of schemes which is separated (!) and
locally of finite type. Let $\mathcal{F}$ be an abelian sheaf on
$X_\etale$. The subsheaf $f_!\mathcal{F} \subset f_*\mathcal{F}$
constructed in Lemma \ref{lemma-f-shriek-separated} is called the
{\it direct image with compact support}.
\end{definition}

\noindent
By Lemma \ref{lemma-separated-etale-shriek}
this does not conflict with
\'Etale Cohomology, Definition \ref{etale-cohomology-definition-extension-zero}
as we have agreement when both definitions apply.
Before extending the definition to more general morphisms we prove
some basic lemmas about this notion.

\begin{lemma}
\label{lemma-f-shriek-composition}
Let $f : X \to Y$ and $g : Y \to Z$ be composable morphisms of
schemes which are separated and locally of finite type. Let
$\mathcal{F}$ be an abelian sheaf on $X_\etale$.
Then $g_!f_!\mathcal{F} = (g \circ f)_!\mathcal{F}$
as subsheaves of $(g \circ f)_*\mathcal{F}$.
\end{lemma}

\begin{proof}
We strongly urge the reader to prove this for themselves.
Let $W \in Z_\etale$ and
$s \in (g \circ f)_*\mathcal{F}(W) = \mathcal{F}(X_W)$.
Denote $T \subset X_W$ the support of $s$; this is a closed
subset. Observe that $s$ is a section of $(g \circ f)_!\mathcal{F}$
if and only if $T$ is proper over $W$. We have
$f_!\mathcal{F} \subset f_*\mathcal{F}$ and hence
$g_!f_!\mathcal{F} \subset g_!f_*\mathcal{F} \subset g_*f_*\mathcal{F}$.
On the other hand, $s$ is a section of $g_!f_!\mathcal{F}$ if and only
if (a) $T$ is proper over $Y_W$ and (b) the support $T'$ of $s$
viewed as section of $f_!\mathcal{F}$ is proper over $W$.
If (a) holds, then the image of $T$ in $Y_W$ is closed and since
$f_!\mathcal{F} \subset f_*\mathcal{F}$ we see that
$T' \subset Y_W$ is the image of $T$ (details omitted; look at stalks).

\medskip\noindent
The conclusion is that we have to show a closed subset $T \subset X_W$
is proper over $W$ if and only if $T$ is proper over $Y_W$
and the image of $T$ in $Y_W$ is proper over $W$. Let us endow $T$
with the reduced induced closed subscheme structure.
If $T$ is proper over $W$, then $T \to Y_W$ is proper by
Morphisms, Lemma \ref{morphisms-lemma-image-proper-scheme-closed}
and the image of $T$ in $Y_W$ is proper over $W$ by
Cohomology of Schemes, Lemma
\ref{coherent-lemma-functoriality-closed-proper-over-base}.
Conversely, if $T$ is proper over $Y_W$
and the image of $T$ in $Y_W$ is proper over $W$,
then the morphism $T \to W$ is proper as a composition
of proper morphisms (here we endow the closed image of $T$
in $Y_W$ with its reduced induced scheme structure to turn the
question into one about morphisms of schemes), see
Morphisms, Lemma \ref{morphisms-lemma-composition-proper}.
\end{proof}

\begin{lemma}
\label{lemma-proper-f-shriek}
Let $f : X \to Y$ be a proper morphism of schemes.
Then $f_! = f_*$.
\end{lemma}

\begin{proof}
Immediate from the construction of $f_!$.
\end{proof}

\begin{lemma}
\label{lemma-compactify-f-shriek-separated}
Let $Y$ be a scheme. Let $j : X \to \overline{X}$ be an open
immersion of schemes over $Y$ with $\overline{X}$ proper over $Y$.
Denote $f : X \to Y$
and $\overline{f} : \overline{X} \to Y$ the structure morphisms.
Then $f_!\mathcal{F} = \overline{f}_*j_!\mathcal{F}$
for $\mathcal{F} \in \textit{Ab}(X_\etale)$.
\end{lemma}

\begin{proof}
Follows immediately from
Lemmas \ref{lemma-f-shriek-composition} and \ref{lemma-proper-f-shriek}.
\end{proof}

\begin{remark}[Covariance with respect to open embeddings]
\label{remark-covariance-f-shriek-separated}
Let $f : X \to Y$ be morphism of schemes which is separated and
locally of finite type. Let $\mathcal{F}$ be an abelian sheaf on $X_\etale$.
Let $X' \subset X$ be an open subscheme and denote $f' : X' \to Y$
the restriction of $f$. Denoting $j : X' \to X$ the inclusion morphism,
we obtain a canonical map
$$
f'_!(\mathcal{F}|_{X'}) =
f'_!(j^{-1}\mathcal{F}) = f_!j_!j^{-1}\mathcal{F}
\longrightarrow
f_!\mathcal{F}
$$
where we have used the identification $f'_! = f_!j_!$ of
Lemma \ref{lemma-f-shriek-composition}
and the adjunction map $j_!j^{-1}\mathcal{F} \to \mathcal{F}$ for the adjoint
pair $j_!, j^{-1}$. Below we give a direct construction of this map.

\medskip\noindent
Let $V \in Y_\etale$ and consider a section
$s' \in f'_*\mathcal{F}|_{X'}(V) = \mathcal{F}(X' \times_Y V)$
with support $Z'$ proper over $V$. Then we have an open covering
of $X \times_Y V$ given by $X' \times_Y V$ and $X \times_Y V \setminus Z'$
as $Z'$ is closed in $X \times_Y V$ as well,
see for example Cohomology of Schemes, Lemma
\ref{coherent-lemma-functoriality-closed-proper-over-base}.
Thus there is a unique section $s \in \mathcal{F}(X \times_Y V)$
whose restriction to $X' \times_Y V$ is $s'$ and whose restriction
to $X \times_Y V \setminus Z'$ is zero. This construction is
compatible with restriction maps and induces an injective map of sheaves
$f'_!(\mathcal{F}|_{X'}) \to f_!\mathcal{F}$. In fact, it is
clear that we obtain a commutative diagram
$$
\xymatrix{
f'_!(\mathcal{F}|_{X'}) \ar[r] \ar[d] &
f_!\mathcal{F} \ar[d] \\
f'_*(\mathcal{F}|_{X'}) &
f_*\mathcal{F} \ar[l]
}
$$
functorial in $\mathcal{F}$.
\end{remark}

\begin{lemma}
\label{lemma-colim-f-shriek-separated}
Let $f : X \to Y$ be morphism of schemes which is separated and
locally of finite type. Let $I$ be a nonempty set and for $i \in I$
let $U_i \subset X$ be open such that $X = \bigcup U_i$ and
for all $i, j \in I$ there exists a $k$ with $U_i \cup U_j \subset U_k$.
Denote $f_i : U_i \to Y$ the restriction of $f$.
Then
$$
f_!\mathcal{F} = \colim_{i \in I} f_{i, !}(\mathcal{F}|_{U_i})
$$
functorially in $\mathcal{F} \in \textit{Ab}(X_\etale)$
where the transition maps are the ones constructed in
Remark \ref{remark-covariance-f-shriek-separated}.
\end{lemma}

\begin{proof}
It suffices to show that the canonical map from
right to left is a bijection when evaluated on a quasi-compact
object $V$ of $Y_\etale$.
Observe that the colimit on the right hand side is directed
and has injective transition maps.
Thus we can use
Sites, Lemma \ref{sites-lemma-directed-colimits-sections}
to evaluate the colimit. Hence, the statement comes down
to the observation that a closed subset $Z \subset X_V$ proper over $V$
is quasi-compact and hence is contained in $U_{i, V}$ for some $i$.
\end{proof}

\begin{lemma}
\label{lemma-base-change-f-shriek-separated}
Consider a cartesian square
$$
\xymatrix{
X' \ar[r]_{g'} \ar[d]_{f'} & X \ar[d]^f \\
Y' \ar[r]^g & Y
}
$$
of schemes with $f$ separated and locally of finite type.
For any abelian sheaf $\mathcal{F}$ on $X_\etale$ we have
$f'_!(g')^{-1}\mathcal{F} = g^{-1}f_!\mathcal{F}$.
\end{lemma}

\begin{proof}
In great generality there is a pullback map
$g^{-1}f_*\mathcal{F} \to f'_*(g')^{-1}\mathcal{F}$, see
Sites, Section \ref{sites-section-pullback}.
We claim that this map sends $g^{-1}f_!\mathcal{F}$
into the subsheaf $f'_!(g')^{-1}\mathcal{F}$
and induces the isomorphism in the lemma.
This claim is local in the \'etale topology of $Y'$.
Hence we may assume that $Y$ is affine.

\medskip\noindent
First, assume $X$ is quasi-compact as well. By More on Flatness, Theorem
\ref{flat-theorem-nagata} there exists a compactification\footnote{Appealing
to this theorem can be avoided by using Chow's lemma and h descent instead.}
$X \subset \overline{X}$ over $Y$. Then we have
$f_! = \overline{f}_* \circ j_!$ by
Lemma \ref{lemma-compactify-f-shriek-separated}.
Both $\overline{f}$ and $j_!$ commute with arbitrary base change
by \'Etale Cohomology, Lemmas
\ref{etale-cohomology-lemma-proper-base-change-f-star} and
\ref{etale-cohomology-lemma-shriek-base-change}.
This proves the result in this case.

\medskip\noindent
General case where $Y$ is affine. Consider the set $X_i \subset X$, $i \in I$
of all quasi-compact open subschemes of $X$. Then $X = \bigcup X_i$ and for
$i, j \in I$ we have $X_i \cup X_j = X_k$ for some $k \in I$.
For each $i \in I$ consider the fibre product
$$
\xymatrix{
X'_i \ar[r]_{g'_i} \ar[d]_{f'_i} & X_i \ar[d]^{f_i} \\
Y' \ar[r]^g & Y
}
$$
For notational convenience let us write
$\mathcal{F}' = (g')^{-1}\mathcal{F}$,
$\mathcal{F}_i = \mathcal{F}|_{X_i}$ and
$\mathcal{F}'_i = \mathcal{F}'|_{X'_i} = (g'_i)^{-1}\mathcal{F}_i$.
It follows from Lemma \ref{lemma-colim-f-shriek-separated} that we have
$$
f_!\mathcal{F} = \colim_{i \in I} f_{i, !}(\mathcal{F}_i)
\quad\text{and}\quad
f'_!\mathcal{F}' = \colim_{i \in I} f'_{i, !}(\mathcal{F}'_i)
$$
Now the base change map above and the base change map
for the last displayed cartesian square 
fit into commutative diagrams
$$
\vcenter{
\xymatrix{
g^{-1}f_*\mathcal{F} \ar[r] \ar[d] &
f'_*\mathcal{F}' \ar[d] \\
g^{-1}f_{i, *}\mathcal{F}_i  \ar[r] &
f'_{i, *}\mathcal{F}'_i
}
}
\quad\text{and}\quad
\vcenter{
\xymatrix{
g^{-1}f_{i, *}\mathcal{F}_i  \ar[r] \ar[d] &
f'_{i, *}\mathcal{F}'_i \ar[d] \\
g^{-1}f_{i', *}\mathcal{F}_{i'}  \ar[r] &
f'_{i', *}\mathcal{F}'_{i'}
}
}
$$
if $X_{i'} \subset X_i$. Using the claim for each $i$, the right
hand commutative diagrams guarantee that the base change isomorphisms
$g^{-1}f_{i, !}\mathcal{F}_i  \to f'_{i, !}\mathcal{F}'_i$
are compatible for varying $i \in I$. Then we can prove the claim
as follows: any local section of $g^{-1}f_!\mathcal{F}$
is locally a section of $g^{-1}f_{i, !}\mathcal{F}$ for some $i$
and hence is mapped to a section of
$f'_{i, !}\mathcal{F}'_i \subset f'_!\mathcal{F}' \subset f'_*\mathcal{F}'$.
This proves the first part of the claim. This then produces a map
$g^{-1}f_!\mathcal{F} \to f'_!\mathcal{F}'$ compatible with the
colimit presentations of source and target given above.
Since for each term the base change map is an isomorphism, we conclude.
(Observe that $g^{-1}$ commutes with colimits as a left adjoint.)
\end{proof}

\begin{lemma}
\label{lemma-f-shriek-separated-direct-sums}
Let $f : X \to Y$ be a morphism of schemes which is separated and
locally of finite type. Then functor $f_!$ commutes with direct sums.
\end{lemma}

\begin{proof}
Let $\mathcal{F} = \bigoplus \mathcal{F}_i$. To show that the map
$\bigoplus f_!\mathcal{F}_i \to f_!\mathcal{F}$ is an isomorphism,
it suffices to show that these sheaves have the same sections over
a quasi-compact object $V$ of $Y_\etale$. Replacing $Y$ by $V$
it suffices to show
$H^0(Y, f_!\mathcal{F}) \subset H^0(X, \mathcal{F})$
is equal to
$\bigoplus H^0(Y, f_!\mathcal{F}_i)
\subset \bigoplus H^0(X, \mathcal{F}_i)
\subset H^0(X, \bigoplus \mathcal{F}_i)$.
In this case, by writing $X$ as the union of its quasi-compact opens
and using Lemma \ref{lemma-colim-f-shriek-separated}
we reduce to the case where $X$ is quasi-compact as well.
Then $H^0(X, \mathcal{F}) = \bigoplus H^0(X, \mathcal{F}_i)$
by \'Etale Cohomology, Theorem \ref{etale-cohomology-theorem-colimit}.
Looking at supports of sections the reader easily concludes.
\end{proof}

\begin{lemma}
\label{lemma-lqf-f-shriek-separated-colimits}
Let $f : X \to Y$ be a morphism of schemes which is separated and
locally quasi-finite. Then
\begin{enumerate}
\item for $\mathcal{F}$ in $\textit{Ab}(X_\etale)$ and a geometric
point $\overline{y} : \Spec(k) \to Y$ we have
$$
(f_!\mathcal{F})_{\overline{y}} =
\bigoplus\nolimits_{f(\overline{x}) = \overline{y}} \mathcal{F}_{\overline{x}}
$$
functorially in $\mathcal{F}$, and
\item the functor $f_!$ is exact.
\end{enumerate}
\end{lemma}

\begin{proof}
The functor $f_!$ is left exact by construction. Right exactness may
be checked on stalks
(\'Etale Cohomology, Theorem \ref{etale-cohomology-theorem-exactness-stalks}).
Thus it suffices to prove part (1).

\medskip\noindent
Let $\overline{y} : \Spec(k) \to Y$ be a geometric point.
The scheme $X_{\overline{y}}$ has a discrete underlying
topological space
(Morphisms, Lemma \ref{morphisms-lemma-locally-quasi-finite-fibres})
and all the residue fields at the points are equal to $k$
(as finite extensions of $k$). Hence
$\{\overline{x} : \Spec(k) \to X : f(\overline{x}) = \overline{y}\}$
is equal to the set of points of $X_{\overline{y}}$.
The stalk at $\overline{y}$ is the pullback by $\overline{y}$.
Hence by Lemma \ref{lemma-base-change-f-shriek-separated}
we see that the stalk of $f_!\mathcal{F}$ at $\overline{y}$
can be identified with the subgroup of sections of
$\mathcal{F}|_{X_{\overline{y}}}$ whose support is finite.
On the other hand, the stalk of $\mathcal{F}|_{X_{\overline{y}}}$
at the point corresponding to $\overline{x}$ is equal to
$\mathcal{F}_{\overline{x}}$. Thus the subgroup of sections of
$\mathcal{F}|_{X_{\overline{y}}}$ whose support is finite
is equal to
$\bigoplus_{f(\overline{x}) = \overline{y}} \mathcal{F}_{\overline{x}}$
as desired.
\end{proof}









\section{Sections with finite support}
\label{section-finite-support}

\noindent
In this section we extend the construction of
Section \ref{section-compact-support} to not necessarily
separated locally quasi-finite morphisms.

\begin{lemma}
\label{lemma-section-support-in-locally-closed-pre}
Let $X$ be a scheme. Let $\mathcal{F}$ be an abelian sheaf on $X_\etale$.
Let $\varphi : U' \to U$ be a morphism of $X_\etale$. Let $Z' \subset U'$ be a
closed subscheme such that $Z' \to U' \to U$ is a closed immersion
with image $Z \subset U$. Then there is a canonical bijection
$$
\{s \in \mathcal{F}(U) \mid \text{Supp}(s) \subset Z\} =
\{s' \in \mathcal{F}(U') \mid \text{Supp}(s') \subset Z'\}
$$
which is given by restriction if $\varphi^{-1}(Z) = Z'$.
\end{lemma}

\begin{proof}
Consider the closed subscheme $Z'' = \varphi^{-1}(Z)$ of $U'$.
Then $Z' \subset Z''$ is closed because $Z'$ is closed in $U'$.
On the other hand, $Z' \to Z''$ is an \'etale morphism
(as a morphism between schemes \'etale over $Z$) and hence
open. Thus $Z'' = Z' \amalg T$ for some closed subset $T$.
The open covering $U' = (U' \setminus T) \cup (U' \setminus Z')$
shows that
$$
\{s' \in \mathcal{F}(U') \mid \text{Supp}(s') \subset Z'\} =
\{s' \in \mathcal{F}(U' \setminus T) \mid \text{Supp}(s') \subset Z'\}
$$
and the \'etale covering $\{U' \setminus T \to U, U \setminus Z \to U\}$
shows that
$$
\{s \in \mathcal{F}(U) \mid \text{Supp}(s) \subset Z\} =
\{s' \in \mathcal{F}(U' \setminus T) \mid \text{Supp}(s') \subset Z'\}
$$
This finishes the proof.
\end{proof}

\begin{lemma}
\label{lemma-section-support-in-locally-closed}
Let $X$ be a scheme. Let $Z \subset X$ be a locally closed subscheme.
Let $\mathcal{F}$ be an abelian sheaf on $X_\etale$. Given
$U, U' \subset X$ open containing $Z$ as a closed subscheme,
there is a canonical bijection
$$
\{s \in \mathcal{F}(U) \mid \text{Supp}(s) \subset Z\} =
\{s \in \mathcal{F}(U') \mid \text{Supp}(s) \subset Z\}
$$
which is given by restriction if $U' \subset U$.
\end{lemma}

\begin{proof}
Since $Z$ is a closed subscheme of $U \cap U'$, it suffices to
prove the lemma when $U' \subset U$. Then it is a special case
of Lemma \ref{lemma-section-support-in-locally-closed-pre}.
\end{proof}

\noindent
Let us introduce a bit of nonstandard notation which will stand us
in good stead for the rest of this section. Namely, in the situation
of Lemma \ref{lemma-section-support-in-locally-closed} above, let us denote
$$
H_Z(\mathcal{F}) = \{s \in \mathcal{F}(U) \mid \text{Supp}(s) \subset Z\}
$$
where $U \subset X$ is any choice of open subscheme containing $Z$ as a closed
subscheme. The reader who is troubled by the lack of precision this entails
may choose $U = X \setminus \partial Z$ where
$\partial Z = \overline{Z}\setminus Z$ is the ``boundary'' of $Z$ in $X$.
However, in many of the arguments below the flexibility of choosing
different opens will play a role. Here are some properties of this
construction:
\begin{enumerate}
\item
\label{item-inclusion}
If $Z \subset Z'$ are locally closed subschemes of $X$ and $Z$ is
closed in $Z'$, then there is a natural injective map
$$
H_Z(\mathcal{F}) \to H_{Z'}(\mathcal{F}).
$$
\item
\label{item-pullback}
If $f : Y \to X$ is a morphism of schemes and $Z \subset X$ is a locally
closed subscheme, then there is a natural
pullback map $f^* : H_Z(\mathcal{F}) \to H_{f^{-1}Z}(f^{-1}\mathcal{F})$.
\end{enumerate}
It will be convenient to extend our notation to the following situation:
suppose that we have $W \in X_\etale$ and a locally closed subscheme
$Z \subset W$. Then we will denote
$$
H_Z(\mathcal{F}) =
\{s \in \mathcal{F}(U) \mid \text{Supp}(s) \subset Z\} =
H_Z(\mathcal{F}|_{W_\etale})
$$
where $U \subset W$ is any choice of open subscheme containing $Z$
as a closed subscheme, exactly as above\footnote{In fact,
Lemma \ref{lemma-section-support-in-locally-closed-pre}
shows, given $Z$ over $X$ which is isomorphic to a locally closed
subscheme of some object $W$ of $X_\etale$, that
the choice of $W$ is irrelevant.}.

\medskip\noindent
Let $f : X \to Y$ be a locally quasi-finite morphism of schemes.
Let $\mathcal{F}$ be an abelian sheaf on $X_\etale$. Given $V$ in
$Y_\etale$ denote $X_V = X \times_Y V$ the base change. We are going
to consider the group of finite formal sums
\begin{equation}
\label{equation-formal-sum}
s = \sum\nolimits_{i = 1, \ldots, n} (Z_i, s_i)
\end{equation}
where $Z_i \subset X_V$ is a locally closed subscheme such that the
morphism $Z_i \to V$ is finite\footnote{Since $f$ is locally quasi-finite,
the morphism $Z_i \to V$ is finite if and only if it is proper.}
and where $s_i \in H_{Z_i}(\mathcal{F})$.
We are going to consider these formal sums modulo the
following relations
\begin{enumerate}
\item
\label{item-sum}
$(Z, s) + (Z, s') = (Z, s + s')$,
\item
\label{item-sub}
$(Z, s) = (Z', s)$ if $Z \subset Z'$.
\end{enumerate}
Observe that the second relation makes sense: since $Z \to V$ is finite
and $Z' \to V$ is separated, the inclusion $Z \to Z'$ is closed and we
can use the map discussed in (\ref{item-inclusion}).

\medskip\noindent
Let us denote $f_{p!}\mathcal{F}(V)$ the quotient of the abelian
group of formal sums (\ref{equation-formal-sum}) by these relations.
The first relation tells us that $f_{p!}\mathcal{F}(V)$ is a quotient
of the direct sum of the abelian groups $H_Z(\mathcal{F})$
over all locally closed subschemes $Z \subset X_V$ finite over $V$.
The second relation tells us that we are really taking the colimit
\begin{equation}
\label{equation-colimit-definition}
f_{p!}\mathcal{F}(V) = \colim_Z H_Z(\mathcal{F})
\end{equation}
This formula will be a convenient abstract way to think about
our construction.

\medskip\noindent
Next, we observe that there is a natural way to turn this construction
into a presheaf $f_{p!}\mathcal{F}$ of abelian groups on $Y_\etale$.
Namely, given $V' \to V$ in $Y_\etale$ we obtain the base change morphism
$X_{V'} \to X_V$. If $Z \subset X_V$ is a locally closed subscheme
finite over $V$, then the scheme theoretic inverse image $Z' \subset X_{V'}$
is finite over $V'$. Moreover, if $U \subset X_V$ is an open such
that $Z$ is closed in $U$, then the inverse image $U' \subset X_{V'}$
is an open such that $Z'$ is closed in $U'$. Hence the restriction
mapping $\mathcal{F}(U) \to \mathcal{F}(U')$ of $\mathcal{F}$
sends $H_Z(\mathcal{F})$ into $H_{Z'}(\mathcal{F})$; this is a specical
case of the functoriality discussed in (\ref{item-pullback}) above.
Clearly, these maps are compatible with inclusions
$Z_1 \subset Z_2$ of such locally closed subschemes of $X_V$ and
we obtain a map
$$
f_{p!}\mathcal{F}(V) = \colim_Z H_Z(\mathcal{F})
\longrightarrow
\colim_{Z'} H_{Z'}(\mathcal{F}) =
f_{p!}\mathcal{F}(V')
$$
These maps indeed turn $f_{p!}\mathcal{F}$ into a presheaf of abelian
groups on $Y_\etale$. We omit the details.

\medskip\noindent
A final observation is that the construction of $f_{p!}\mathcal{F}$
is functorial in $\mathcal{F}$ in $\textit{Ab}(X_\etale)$.
We conclude that given a locally quasi-finite morphism $f : X \to Y$
we have constructed a functor
$$
f_{p!} :
\textit{Ab}(X_\etale)
\longrightarrow
\textit{PAb}(Y_\etale)
$$
from the category of abelian sheaves on $X_\etale$ to the category
of abelian presheaves on $Y_\etale$. Before we define $f_!$ as the
sheafification of this functor, let us check that it agrees with
the construction in Section \ref{section-compact-support}
and with the construction in
\'Etale cohomology, Section \ref{etale-cohomology-section-extension-by-zero}
when both apply.

\begin{lemma}
\label{lemma-finite-support-f-shriek-separated}
Let $f : X \to Y$ be a separated and locally quasi-finite morphism
of schemes. Functorially in $\mathcal{F} \in \textit{Ab}(X_\etale)$
there is a canonical isomorphism(!)
$$
f_{p!}\mathcal{F} \longrightarrow f_!\mathcal{F}
$$
of abelian presheaves which identifies the sheaf
$f_!\mathcal{F}$ of Definition \ref{definition-f-shriek-separated}
with the presheaf $f_{p!}\mathcal{F}$ constructed above.
\end{lemma}

\begin{proof}
Let $V$ be an object of $Y_\etale$. If $Z \subset X_V$ is locally closed
and finite over $V$, then, since $f$ is separated, we see that
the morphism $Z \to X_V$ is a closed immersion. Moreover, if
$Z_i$, $i = 1, \ldots, n$ are closed subschemes of $X_V$ finite
over $V$, then $Z_1 \cup \ldots \cup Z_n$ (scheme theoretic union)
is a closed subscheme finite over $V$. Hence in this case the colimit
(\ref{equation-colimit-definition}) defining $f_{p!}\mathcal{F}(V)$
is directed and we find that $f_{!p}\mathcal{F}(V)$ is simply equal
to the set of sections of $\mathcal{F}(X_V)$ whose support is finite over $V$.
Since any closed subset of $X_V$ which is proper over $V$ is
actually finite over $V$ (as $f$ is locally quasi-finite)
we conclude that this is equal to $f_!\mathcal{F}(V)$
by its very definition.
\end{proof}

\begin{lemma}
\label{lemma-finite-support-stalk}
Let $f : X \to Y$ be a morphism of schemes which is locally quasi-finite.
Let $\overline{y} : \Spec(k) \to Y$ be a geometric point.
Functorially in $\mathcal{F}$ in $\textit{Ab}(X_\etale)$ we have
$$
(f_{p!}\mathcal{F})_{\overline{y}} =
\bigoplus\nolimits_{f(\overline{x}) = \overline{y}} \mathcal{F}_{\overline{x}}
$$
\end{lemma}

\begin{proof}
Recall that the stalk at $\overline{y}$ of a presheaf is defined by the
usual colimit over \'etale neighbourhoods $(V, \overline{v})$
of $\overline{y}$, see \'Etale Cohomology, Definition
\ref{etale-cohomology-definition-stalk}. Accordingly
suppose $s = \sum_{i = 1, \ldots, n} (Z_i, s_i)$ as in
(\ref{equation-formal-sum}) is an element of $f_{p!}\mathcal{F}(V)$
where $(V, \overline{v})$ is an \'etale neighbourhood of $\overline{y}$.
Then since
$$
X_{\overline{y}} = (X_V)_{\overline{v}} \supset Z_{i, \overline{v}}
$$
and since $s_i$ is a section of $\mathcal{F}$ on an open neighbourhood
of $Z_i$ in $X_V$ we can send $s$ to
$$
\sum\nolimits_{i = 1, \ldots, n} 
\sum\nolimits_{\overline{x} \in Z_{i, \overline{v}}}
\left(\text{class of }s_i\text{ in }\mathcal{F}_{\overline{x}}\right)
\quad\in\quad
\bigoplus\nolimits_{f(\overline{x}) = \overline{y}} \mathcal{F}_{\overline{x}}
$$
We omit the verification that this is compatible with restriction
maps and that the relations (\ref{item-sum}) $(Z, s) + (Z, s') - (Z, s + s')$
and (\ref{item-sub}) $(Z, s) - (Z', s)$ if $Z \subset Z'$ are sent to zero.
Thus we obtain a map
$$
(f_{p!}\mathcal{F})_{\overline{y}}
\longrightarrow
\bigoplus\nolimits_{f(\overline{x}) = \overline{y}} \mathcal{F}_{\overline{x}}
$$

\medskip\noindent
Let us prove this arrow is surjective. For this it suffices to pick
an $\overline{x}$ with $f(\overline{x}) = \overline{y}$ and prove that
an element $s$ in the summand $\mathcal{F}_{\overline{x}}$ is in the
image. Let $s$ correspond to the element $s \in \mathcal{F}(U)$
where $(U, \overline{u})$ is an \'etale neighbourhood of $\overline{x}$.
Since $f$ is locally quasi-finite, the morphism $U \to Y$
is locally quasi-finite too. By More on Morphisms, Lemma
\ref{more-morphisms-lemma-etale-makes-quasi-finite-finite-multiple-points-var}
we can find an \'etale neighbourhood $(V, \overline{v})$ of
$\overline{y}$, an open subscheme
$$
W \subset U \times_Y V,
$$
and a geometric point $\overline{w}$ mapping to $\overline{u}$ and
$\overline{v}$ such that $W \to V$ is finite and $\overline{w}$ is the
only geometric point of $W$ mapping to $\overline{v}$. (We omit the translation
between the language of geometric points we are currently using and the
language of points and residue field extensions used in the
statement of the lemma.) Observe that $W \to X_V = X \times_Y V$
is \'etale. Choose an affine open neighbourhood $W' \subset X_V$
of the image $\overline{w}'$ of $\overline{w}$. Since $\overline{w}$
is the only point of $W$ over $\overline{v}$ and since $W \to V$
is closed, after replacing $V$ by an open neighbourhood of $\overline{v}$,
we may assume $W \to X_V$ maps into $W'$. Then $W \to W'$ is finite and
\'etale and there is a unique geometric point $\overline{w}$ of $W$
lying over $\overline{w}'$. It follows that $W \to W'$ is an open immersion
over an open neighbourhood of $\overline{w}'$ in $W'$, see
\'Etale Morphisms, Lemma \ref{etale-lemma-finite-etale-one-point}.
Shrinking $V$ and $W'$ we may assume $W \to W'$ is an isomorphism.
Thus $s$ may be viewed as a section $s'$ of $\mathcal{F}$ over
the open subscheme $W' \subset X_V$ which is finite over $V$.
Hence by definition $(W', s')$ defines an element of $j_{p!}\mathcal{F}(V)$
which maps to $s$ as desired.

\medskip\noindent
Let us prove the arrow is injective. To do this, let
$s = \sum_{i = 1, \ldots, n} (Z_i, s_i)$ as in (\ref{equation-formal-sum})
be an element of $f_{p!}\mathcal{F}(V)$ where $(V, \overline{v})$ is an
\'etale neighbourhood of $\overline{y}$. Assume $s$ maps to zero
under the map constructed above. First, after replacing
$(V, \overline{v})$ by an \'etale neighbourhood of itself,
we may assume there exist decompositions
$Z_i = Z_{i, 1} \amalg \ldots \amalg Z_{i, m_i}$ into open and closed
subschemes such that each $Z_{i, j}$ has exactly one geometric point
over $\overline{v}$. Say under the obvious direct sum decomposition
$$
H_{Z_i}(\mathcal{F}) = \bigoplus H_{Z_{i, j}}(\mathcal{F})
$$
the element $s_i$ corresponds to $\sum s_{i, j}$. We may use relations
(\ref{item-sum}) and (\ref{item-sub}) to replace $s$ by
$\sum_{i = 1, \ldots, n} \sum_{j = 1, \ldots, m_i} (Z_{i, j}, s_{i, j})$.
In other words, we may assume $Z_i$ has a unique geometric point
lying over $\overline{v}$. Let $\overline{x}_1, \ldots, \overline{x}_m$
be the geometric points of $X$ over $\overline{y}$ corresponding to
the geometric points of our $Z_i$ over $\overline{v}$; note that for
one $j \in \{1, \ldots, m\}$ there may be multiple indices $i$ for which
$\overline{x}_j$ corresponds to a point of $Z_i$.
By More on Morphisms, Lemma
\ref{more-morphisms-lemma-etale-makes-quasi-finite-finite-multiple-points-var}
applied to both $X_V \to V$
after replacing $(V, \overline{v})$ by an \'etale neighbourhood of itself
we may assume there exist open subschemes
$$
W_j \subset X \times_Y V,\quad j = 1, \ldots, m
$$
and a geometric point $\overline{w}_j$ of $W_j$ mapping to $\overline{x}_j$ and
$\overline{v}$ such that $W_j \to V$ is finite and $\overline{w}_j$ is the
only geometric point of $W_j$ mapping to $\overline{v}$.
After shrinking $V$ we may assume $Z_i \subset W_j$ for some $j$
and we have the map $H_{Z_i}(\mathcal{F}) \to H_{W_j}(\mathcal{F})$.
Thus by the relation (\ref{item-sub})
we see that our element is equivalent to an element of the form
$$
\sum\nolimits_{j = 1, \ldots, m} (W_j, t_j)
$$
for some $t_j \in H_{W_j}(\mathcal{F})$. Clearly, this element is mapped
simply to the class of $t_j$ in the summand $\mathcal{F}_{\overline{x}_j}$.
Since $s$ maps to zero, we find that $t_j$ maps to zero in
$\mathcal{F}_{\overline{x}_j}$. This implies that $t_j$ restricts
to zero on an open neighbourhood of $\overline{w}_j$ in $W_j$, see
\'Etale Cohomology, Lemma \ref{etale-cohomology-lemma-zero-over-image}.
Shrinking $V$ once more we obtain $t_j = 0$ for all $j$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-finite-support-etale-shriek}
Let $f = j : U \to X$ be an \'etale of schemes. Denote $j_{p!}$
the construction of \'Etale Cohomology, Equation
(\ref{etale-cohomology-equation-j-p-shriek})
and denote $f_{p!}$ the construction above. Functorially in
$\mathcal{F} \in \textit{Ab}(X_\etale)$ there is a canonical map
$$
j_{p!}\mathcal{F} \longrightarrow f_{p!}\mathcal{F}
$$
of abelian presheaves which identifies the sheaf
$j_!\mathcal{F} = (j_{p!}\mathcal{F})^\#$ of \'Etale Cohomology,
Definition \ref{etale-cohomology-definition-extension-zero}
with $(f_{p!}\mathcal{F})^\#$.
\end{lemma}

\begin{proof}
Please read the proof of \'Etale Cohomology, Lemma
\ref{etale-cohomology-lemma-shriek-into-star-separated-etale}
before reading the proof of this lemma.
Let $V$ be an object of $X_\etale$. Recall that
$$
j_{p!}\mathcal{F}(V) =
\bigoplus\nolimits_{\varphi : V \to U} \mathcal{F}(V \xrightarrow{\varphi} U)
$$
Given $\varphi$ we obtain an open subscheme
$Z_\varphi \subset U_V = U \times_X V$, namely,
the image of the graph of $\varphi$. Via $\varphi$
we obtain an isomorphism $V \to Z_\varphi$ over $U$
and we can think of an element
$$
s_\varphi \in \mathcal{F}(V \xrightarrow{\varphi} U) =
\mathcal{F}(Z_\varphi) = H_{Z_\varphi}(\mathcal{F})
$$
as a section of $\mathcal{F}$ over $Z_{\varphi}$. Since
$Z_\varphi \subset U_V$ is open, we actually have
$H_{Z_\varphi}(\mathcal{F}) = \mathcal{F}(Z_\varphi)$
and we can think of $s_\varphi$ as an element of $H_{Z_\varphi}(\mathcal{F})$.
Having said this, our map $j_{p!}\mathcal{F} \to f_{p!}\mathcal{F}$
is defined by the rule
$$
\sum\nolimits_{i = 1, \ldots, n} s_{\varphi_i}
\longmapsto
\sum\nolimits_{i = 1, \ldots, n} (Z_{\varphi_i}, s_{\varphi_i})
$$
with right hand side a sum as in (\ref{equation-formal-sum}).
We omit the verification that this is compatible with restriction
mappings and functorial in $\mathcal{F}$.

\medskip\noindent
To finish the proof, we claim that this map is compatible with the
identifications of stalks given in
Lemma \ref{lemma-finite-support-stalk} and
\'Etale Cohomology, Proposition
\ref{etale-cohomology-proposition-describe-jshriek}.
We omit the details.
\end{proof}

\begin{definition}
\label{definition-f-shriek-lqf}
Let $f : X \to Y$ be a locally quasi-finite morphism of schemes.
We define the {\it direct image with compact support} to be the
functor
$$
f_! : \textit{Ab}(X_\etale) \longrightarrow \textit{Ab}(Y_\etale)
$$
defined by the formula $f_!\mathcal{F} = (f_{p!}\mathcal{F})^\#$,
i.e., $f_!\mathcal{F}$ is the sheafification of the presheaf
$f_{p!}\mathcal{F}$ constructed above.
\end{definition}

\noindent
By Lemma \ref{lemma-finite-support-f-shriek-separated}
this does not conflict with Definition \ref{definition-f-shriek-separated}
(when both definitions apply) and by
Lemma \ref{lemma-finite-support-etale-shriek}
this does not conflict with
\'Etale Cohomology, Definition \ref{etale-cohomology-definition-extension-zero}
(when both definitions apply).

\begin{lemma}
\label{lemma-lqf-f-shriek-stalk}
Let $f : X \to Y$ be a locally quasi-finite morphism of schemes. Then
\begin{enumerate}
\item for $\mathcal{F}$ in $\textit{Ab}(X_\etale)$ and a geometric
point $\overline{y} : \Spec(k) \to Y$ we have
$$
(f_!\mathcal{F})_{\overline{y}} =
\bigoplus\nolimits_{f(\overline{x}) = \overline{y}} \mathcal{F}_{\overline{x}}
$$
functorially in $\mathcal{F}$, and
\item the functor $f_! : \textit{Ab}(X_\etale) \to \textit{Ab}(Y_\etale)$
is exact and commutes with direct sums.
\end{enumerate}
\end{lemma}

\begin{proof}
The formula for the stalks is immediate (and in fact equivalent) to
Lemma \ref{lemma-finite-support-stalk}.
The exactness of the functor follows immediately from this
and the fact that exactness may be checked on stalks, see
\'Etale Cohomology, Theorem \ref{etale-cohomology-theorem-exactness-stalks}.
\end{proof}

\begin{remark}[Covariance with respect to open embeddings]
\label{remark-covariance-lqf-f-shriek}
Let $f : X \to Y$ be locally quasi-finite morphism of schemes. Let
$\mathcal{F}$ be an abelian sheaf on $X_\etale$.
Let $X' \subset X$ be an open subscheme and denote $f' : X' \to Y$
the restriction of $f$. Denote $\mathcal{F}' = \mathcal{F}|_{X'_\etale}$.
We claim there is a canonical map
$$
f'_!\mathcal{F}' \longrightarrow f_!\mathcal{F}
$$
In fact, we will construct a map $f'_{p!}\mathcal{F}' \to f_{p!}\mathcal{F}$
as follows. Let $V \in Y_\etale$ and consider a section
$s' = \sum_{i = 1, \ldots, n} (Z'_i, s'_i)$ as in
(\ref{equation-formal-sum}) defining an element of $f'_{p!}\mathcal{F}'(V)$.
Then $Z'_i \subset X'_V$ may also be viewed as a locally closed subscheme
of $X_V$ and clearly we have $H_{Z'_i}(\mathcal{F}') = H_{Z'_i}(\mathcal{F})$.
We will map $s'$ to the exact same sum
$s = \sum_{i = 1, \ldots, n} (Z'_i, s'_i)$
but now viewed as an element of $f_{p!}\mathcal{F}(V)$.
We omit the verification that this construction is compatible with
restriction mappings and functorial in $\mathcal{F}$.
This construction has the following properties:
\begin{enumerate}
\item The map $f'_!\mathcal{F}' \to f_!\mathcal{F}$ is compatible with
the description of stalks given in Lemma \ref{lemma-lqf-f-shriek-stalk}.
\item If $X'' \subset X'$ is another open, then the composition of
$f''_!\mathcal{F}'' \to f'_!\mathcal{F}' \to f_!\mathcal{F}$
is the map $f''_!\mathcal{F}'' \to f_!\mathcal{F}$ for the
inclusion $X'' \subset X$. In fact, this already holds for the
maps of presheaves defined above.
\item The map $f'_!\mathcal{F}' \to f_!\mathcal{F}$ is injective
(because we can check on stalks).
\item The map $f'_!\mathcal{F}' \to f_!\mathcal{F}$ just constructed
is the same as the map given in
Remark \ref{remark-covariance-f-shriek-separated}
in case $f$ is separated.
\end{enumerate}
\end{remark}

\begin{lemma}
\label{lemma-lqf-colimit-f-shriek}
Let $f : X \to Y$ be a locally quasi-finite morphism of schemes.
Let $X = \bigcup_{i \in I} X_i$ be an open covering. Then there
exists an exact complex
$$
\ldots \to
\bigoplus\nolimits_{i_0, i_1, i_2} f_{i_0i_1i_2, !}
\mathcal{F}|_{X_{i_0i_1i_2}} \to
\bigoplus\nolimits_{i_0, i_1} f_{i_0i_1, !} \mathcal{F}|_{X_{i_0i_1}} \to
\bigoplus\nolimits_{i_0} f_{i_0, !} \mathcal{F}|_{X_{i_0}}
\to f_!\mathcal{F} \to 0
$$
functorial in $\mathcal{F} \in \textit{Ab}(X_\etale)$, see
proof for details.
\end{lemma}

\begin{proof}
Here as usual we set $X_{i_0 \ldots i_p} = X_{i_0} \cap \ldots \cap X_{i_p}$
and we denote $f_{i_0 \ldots i_p}$ the restriction of $f$ to
$X_{i_0 \ldots i_p}$. The maps in the complex are the maps
constructed in Remark \ref{remark-covariance-lqf-f-shriek}
with sign rules as in the {\v C}ech complex.
Exactness follows easily from the description of stalks in
Lemma \ref{lemma-lqf-f-shriek-stalk}. Details omitted.
\end{proof}

\begin{remark}[Alternative construction]
\label{remark-alternative-lqf-f-shriek}
Lemma \ref{lemma-lqf-colimit-f-shriek}
gives an alternative construction of the functor $f_!$
for locally quasi-finite morphisms $f$.
Namely, given a locally quasi-finite morphism $f : X \to Y$ of schemes
we can choose an open covering $X = \bigcup_{i \in I} X_i$
such that each $f_i : X_i \to Y$ is separated. For example choose
an affine open covering of $X$. Then we
can define $f_!\mathcal{F}$ as the cokernel of the penultimate map
of the complex of the lemma, i.e.,
$$
f_!\mathcal{F} = \Coker\left(
\bigoplus\nolimits_{i_0, i_1} f_{i_0i_1, !} \mathcal{F}|_{X_{i_0i_1}} \to
\bigoplus\nolimits_{i_0} f_{i_0, !} \mathcal{F}|_{X_{i_0}}
\right)
$$
where we can use the construction of $f_{i_0, !}$ and
$f_{i_0i_1, !}$ in Section \ref{section-compact-support}
because the morphisms $f_{i_0}$ and $f_{i_0 i_1}$ are separated.
One can then compute the stalks of $f_!$ (using the separated
case, namely Lemma \ref{lemma-lqf-f-shriek-separated-colimits})
and obtain the result of Lemma \ref{lemma-lqf-f-shriek-stalk}.
Having done so all the other results of this section can be
deduced from this as well.
\end{remark}

\begin{lemma}
\label{lemma-lqf-base-change-f-shriek}
Consider a cartesian square
$$
\xymatrix{
X' \ar[r]_{g'} \ar[d]_{f'} & X \ar[d]^f \\
Y' \ar[r]^g & Y
}
$$
of schemes with $f$ locally quasi-finite. For any abelian sheaf $\mathcal{F}$
on $X_\etale$ we have $f'_!(g')^{-1}\mathcal{F} = g^{-1}f_!\mathcal{F}$.
\end{lemma}

\begin{proof}[First proof]
We will explicitly construct a map
$$
f_{p!}\mathcal{F} \longrightarrow g_*f'_{p!}(g')^{-1}\mathcal{F}
$$
of abelian presheaves on $Y'_\etale$. Since pushforward commutes
with sheafification, we obtain a map
$f_!\mathcal{F} \to g_*f'_!(g')^{-1}\mathcal{F}$.
This map in turn is adjoint to a map
$g^{-1}f_!\mathcal{F} \to f'_!(g')^{-1}\mathcal{F}$.

\medskip\noindent
Construction of the map. Let $V \in Y_\etale$ and consider a section
$s = \sum_{i = 1, \ldots, n} (Z_i, s_i)$ as in
(\ref{equation-formal-sum}) defining an element of $f_{p!}\mathcal{F}(V)$.
The value of $g_*f'_{p!}(g')^{-1}\mathcal{F}$ at $V$ is
$f'_{p!}(g')^{-1}\mathcal{F}(V')$ where $V' = V \times_Y Y'$.
Denote $Z'_i \subset X'_{V'}$ the base change of $Z_i$ to $V'$.
By (\ref{item-pullback}) there is a pullback map
$H_{Z_i}(\mathcal{F}) \to H_{Z'_i}((g')^{-1}\mathcal{F})$.
Denoting $s'_i \in H_{Z'_i}((g')^{-1}\mathcal{F})$ we send
$s$ to $s' = \sum_{i = 1, \ldots, n} (Z'_i, s'_i)$ as in
(\ref{equation-formal-sum}) defining an element of
$f'_{p!}(g')^{-1}\mathcal{F}(V')$. We omit the verification
that this construction is compatible with restriction
mappings and functorial in $\mathcal{F}$.

\medskip\noindent
Let $\overline{y}' : \Spec(k) \to Y'$ be a geometric point with image
$\overline{y} = g \circ \overline{y}'$ in $Y$. Observe that
$X'_{\overline{y}'} = X_{\overline{y}}$ by transitivity of
fibre products. Then $g'$ produces a bijection
$\{f'(\overline{x}') = \overline{y}'\} \to \{f(\overline{x}) = \overline{y}\}$
and if $\overline{x}'$ maps to $\overline{x}$, then
$((g')^{-1}\mathcal{F})_{\overline{x}'} = \mathcal{F}_{\overline{x}}$
by \'Etale Cohomology, Lemma \ref{etale-cohomology-lemma-stalk-pullback}.
Similarly, we have
$(g^{-1}f_!\mathcal{F})_{\overline{y}'} = f_!\mathcal{F}_{\overline{y}}$.
By Lemma \ref{lemma-lqf-f-shriek-stalk} we conclude that
the source and target of the map in the lemma have the same
stalks. It follows from the construction that our map is
compatible with the description of stalks (details omitted)
and hence we obtain that it is an isomorphism.
\end{proof}

\begin{proof}[Second proof]
The lemma is true if $f$ is separated by
Lemma \ref{lemma-base-change-f-shriek-separated}.
In general, choose an an open covering $X = \bigcup_{i \in I} X_i$
such that each $f_i : X_i \to Y$ is separated, see
Remark \ref{remark-alternative-lqf-f-shriek}. Then we get
$$
f_!\mathcal{F} = \Coker\left(
\bigoplus\nolimits_{i_0, i_1} f_{i_0i_1, !} \mathcal{F}|_{X_{i_0i_1}} \to
\bigoplus\nolimits_{i_0} f_{i_0, !} \mathcal{F}|_{X_{i_0}}
\right)
$$
functorially in $\mathcal{F}$ by Lemma \ref{lemma-lqf-colimit-f-shriek}.
Then we may consider the cartesian diagrams
$$
\vcenter{
\xymatrix{
X'_i \ar[r]_{g'_i} \ar[d]_{f'_i} & X_i \ar[d]^{f_i} \\
Y' \ar[r]^g & Y
}
}
\quad\text{and}\quad
\vcenter{
\xymatrix{
X'_{ii'} \ar[r]_{g'_{ii'}} \ar[d]_{f'_{ii'}} &
X_{ii'} \ar[d]^{f_{ii'}} \\
Y' \ar[r]^g & Y
}
}
$$
and using the isomorphisms $g^{-1}f_{i, !} \to f'_{i, !}(g'_i)^{-1}$ as well
as $g^{-1}f_{ii', !} \to f'_{ii', !}(g'_{ii'})^{-1}$ we can define an
isomorphism
$$
\xymatrix{
g^{-1}\Coker\left(
\bigoplus\nolimits_{i_0, i_1} f_{i_0i_1, !} \mathcal{F}|_{X_{i_0i_1}} \to
\bigoplus\nolimits_{i_0} f_{i_0, !} \mathcal{F}|_{X_{i_0}}
\right) \ar[d] \\
\Coker\left(
\bigoplus\nolimits_{i_0, i_1}
f'_{i_0i_1, !}(g')^{-1}\mathcal{F}|_{X'_{i_0i_1}} \to
\bigoplus\nolimits_{i_0}
f'_{i_0, !}(g')^{-1}\mathcal{F}|_{X'_{i_0}}
\right)
}
$$
functorial in $\mathcal{F}$. Using Lemma \ref{lemma-lqf-colimit-f-shriek}
once more we see that this corresponds to an
isomorphism $g^{-1}f_!\mathcal{F} \to f'_!(g')^{-1}\mathcal{F}$
functorial in $\mathcal{F}$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-lqf-shriek-composition}
Let $f : X \to Y$ and $g : Y \to Z$ be composable locally quasi-finite
morphisms of schemes. Then there is a canonical isomorphism of functors
$g_! \circ f_! = (g \circ f)_!$. Given a third locally quasi-finite
morphism $h : Z \to T$ the diagram
$$
\xymatrix{
(h \circ g \circ f)_! \ar[r] \ar[d] &
(h \circ g)_! \circ f_! \ar[d] \\
h_! \circ (g \circ f)_! \ar[r] &
h_! \circ g_! \circ f_!
}
$$
commutes.
\end{lemma}

\begin{proof}
If $f$ and $g$ are separated, then this is a special case of
Lemma \ref{lemma-f-shriek-composition}.

\medskip\noindent
Assume only $g$ is separated. Choose an open covering
$X = \bigcup X_i$ such that the restrictions $f_i : X_i \to Y$
are separated. By Lemma \ref{lemma-lqf-colimit-f-shriek}
we get an exact sequence
$$
\bigoplus\nolimits_{i_0, i_1} f_{i_0i_1, !} \mathcal{F}|_{X_{i_0i_1}} \to
\bigoplus\nolimits_{i_0} f_{i_0, !} \mathcal{F}|_{X_{i_0}}
\to f_!\mathcal{F} \to 0
$$
Applying the exact functor $g_!$ we obtain the exact sequence
$$
\bigoplus\nolimits_{i_0, i_1} g_!f_{i_0i_1, !} \mathcal{F}|_{X_{i_0i_1}} \to
\bigoplus\nolimits_{i_0} g_!f_{i_0, !} \mathcal{F}|_{X_{i_0}}
\to g_!f_!\mathcal{F} \to 0
$$
Using the case where both morphisms are separated we can rewrite this as
$$
\bigoplus\nolimits_{i_0, i_1} h_{i_0i_1, !} \mathcal{F}|_{X_{i_0i_1}} \to
\bigoplus\nolimits_{i_0} h_{i_0, !} \mathcal{F}|_{X_{i_0}}
\to g_!f_!\mathcal{F} \to 0
$$
where $h = g \circ f$ and $h_{i_0}$, $h_{i_0i_1}$ are the restrictions
of $h$ to $X_{i_0}$ and $X_{i_0i_1}$. Then by
Lemma \ref{lemma-lqf-colimit-f-shriek}
again we see that the cokernel of the first arrow is
$h_!\mathcal{F}$\footnote{We omit the argument showing that the map
$h_{i_0i_1, !} \mathcal{F}|_{X_{i_0i_1}} \to h_{i_0, !} \mathcal{F}|_{X_{i_0}}$
of Remark \ref{remark-covariance-lqf-f-shriek} agrees with the map
$g_!f_{i_0i_1, !} \mathcal{F}|_{X_{i_0i_1}} \to
g_!f_{i_0, !} \mathcal{F}|_{X_{i_0}}$
coming from $g_!$ applied to the map
$f_{i_0i_1, !} \mathcal{F}|_{X_{i_0i_1}} \to f_{i_0, !} \mathcal{F}|_{X_{i_0}}$
of Remark \ref{remark-covariance-lqf-f-shriek}. To see this use
that these maps are compatible with the description of stalks given
in Lemma \ref{lemma-lqf-f-shriek-stalk}.} which gives us the desired
isomorphism.

\medskip\noindent
Proof in the general case. Choose an open covering $Y = \bigcup Y_i$ such that
the restriction $g_i : Y_i \to Z$ of $g$ is separated. Set $X_i = f^{-1}(Y_i)$
and denote $f_i : X_i \to Y_i$ the restriction of $f$. Also denote
$h = g \circ f$ and $h_i : X_i \to Z$ the restriction of $h$.
By Lemma \ref{lemma-lqf-colimit-f-shriek}
we get an exact sequence
$$
\bigoplus\nolimits_{i_0, i_1} g_{i_0i_1, !} f_!\mathcal{F}|_{Y_{i_0i_1}} \to
\bigoplus\nolimits_{i_0} g_{i_0, !} f_!\mathcal{F}|_{Y_{i_0}}
\to g_!f_!\mathcal{F} \to 0
$$
Since formation of $f_!$ is local on the base (in fact \'etale local on
the base by its very construction) we can write
$f_!\mathcal{F}|_{Y_{i_0i_1}} = f_{i_0i_1, !}\mathcal{F}|_{X_{i_0i_1}}$
and
$f_!\mathcal{F}|_{Y_{i_0}} = f_{i_0, !}\mathcal{F}|_{X_{i_0}}$.
Thus the exact sequence above can be rewritten as
$$
\bigoplus\nolimits_{i_0, i_1} g_{i_0i_1, !}
f_{i_0i_1, !}\mathcal{F}|_{X_{i_0i_1}} \to
\bigoplus\nolimits_{i_0} g_{i_0, !} f_{i_0, !}\mathcal{F}|_{X_{i_0}}
\to g_!f_!\mathcal{F} \to 0
$$
Using the case where the second morphism is separated proved above
we can rewrite this as
$$
\bigoplus\nolimits_{i_0, i_1} h_{i_0i_1, !}\mathcal{F}|_{X_{i_0i_1}} \to
\bigoplus\nolimits_{i_0} h_{i_0, !}\mathcal{F}|_{X_{i_0}}
\to g_!f_!\mathcal{F} \to 0
$$
and we conclude as before.

\medskip\noindent
We omit the proof of commutativity of the square of the lemma; hint:
it follows because our isomorphisms are compatible with the description
of stalks of the direct images with compact supports given in
Lemma \ref{lemma-lqf-f-shriek-stalk}.
\end{proof}










\section{Upper shriek for locally quasi-finite morphisms}
\label{section-duality-locally-quasi-finite}

\noindent
For a locally quasi-finite morphism $f : X \to Y$ of schemes, the
functor $f_! : \textit{Ab}(X_\etale) \to \textit{Ab}(Y_\etale)$ commutes
with direct sums and is exact, see Lemma \ref{lemma-lqf-f-shriek-stalk}.
This suggests that it has a right adjoint which we will denote $f^!$.

\medskip\noindent
Warning: This functor is the non-derived version!

\begin{lemma}
\label{lemma-lqf-f-upper-shriek}
Let $f : X \to Y$ be a locally quasi-finite morphism of schemes. The functor
$f_! : \textit{Ab}(X_\etale) \to \textit{Ab}(Y_\etale)$
has a right adjoint
$f^! : \textit{Ab}(Y_\etale) \to \textit{Ab}(X_\etale)$.
Moreover, we have $f^!(\overline{y}_*A) =
\prod_{f(\overline{x}) = \overline{y}} \overline{x}_*A$.
\end{lemma}

\begin{proof}
Let $E \subset \Ob(\textit{Ab}(Y_\etale))$ be the class consisting of
products of skyscraper sheaves. We claim that
\begin{enumerate}
\item every $\mathcal{G}$ in $\textit{Ab}(Y_\etale)$ is a subsheaf
of an element of $E$, and
\item for every $\mathcal{G} \in E$ there exists an object
$\mathcal{H}$ of $\textit{Ab}(X_\etale)$ such that
$\Hom(f_!\mathcal{F}, \mathcal{G}) = \Hom(\mathcal{F}, \mathcal{H})$
functorially in $\mathcal{F}$.
\end{enumerate}
Once the claim has been verified, the dual of
Homology, Lemma \ref{homology-lemma-partially-defined-adjoint}
produces the adjoint functor $f^!$.

\medskip\noindent
Part (1) is true because we can map $\mathcal{G}$ to the sheaf
$\prod \overline{y}_*\mathcal{G}_{\overline{y}}$ where the
product is over all geometric points of $Y$. This is an injection by
\'Etale Cohomology, Theorem \ref{etale-cohomology-theorem-exactness-stalks}.
(This is the first step in the Godement resolution when
done in the setting of abelian sheaves on topological spaces.)

\medskip\noindent
Part (2) and the final statement of the lemma can be seen as follows.
Suppose that
$\mathcal{G} = \prod \overline{y}_*A_{\overline{y}}$
for some abelian groups $A_{\overline{y}}$. Then
$$
\Hom(f_!\mathcal{F}, \mathcal{G}) =
\prod \Hom(f_!\mathcal{F}, \overline{y}_*A_{\overline{y}})
$$
Thus it suffices to find abelian sheaves $\mathcal{H}_{\overline{y}}$
on $X_\etale$ representing the functors
$\mathcal{F} \mapsto \Hom(f_!\mathcal{F}, \overline{y}_*A_{\overline{y}})$
and to take $\mathcal{H} = \prod \mathcal{H}_{\overline{y}}$.
This reduces us to the case $\mathcal{H} = \overline{y}_*A$
for some fixed geometric point $\overline{y} : \Spec(k) \to Y$
and some fixed abelian group $A$. We claim that in this case
$\mathcal{H} = \prod_{f(\overline{x}) = \overline{y}} \overline{x}_*A$ works.
This will finish the proof of the lemma.
Namely, we have
$$
\Hom(f_!\mathcal{F}, \overline{y}_*A) =
\Hom_{\textit{Ab}}((f_!\mathcal{F})_{\overline{y}}, A) =
\Hom_{\textit{Ab}}(\bigoplus\nolimits_{f(\overline{x}) = \overline{y}}
\mathcal{F}_{\overline{x}}, A)
$$
by the description of stalks in
Lemma \ref{lemma-lqf-f-shriek-stalk}
on the one hand and on the other hand we have
$$
\Hom(\mathcal{F}, \mathcal{H}) =
\prod\nolimits_{f(\overline{x}) = \overline{y}}
\Hom(\mathcal{F}, \overline{x}_*A) =
\prod\nolimits_{f(\overline{x}) = \overline{y}}
\Hom_{\textit{Ab}}(\mathcal{F}_{\overline{x}}, A)
$$
We leave it to the reader to identify these as functors of $\mathcal{F}$.
\end{proof}

\begin{lemma}
\label{lemma-etale-upper-shriek}
Let $j : U \to X$ be an \'etale morphism. Then $j^! = j^{-1}$.
\end{lemma}

\begin{proof}
This is true because $j_!$ as defined in
Section \ref{section-finite-support}
agrees with $j_!$ as defined in \'Etale Cohomology, Section
\ref{etale-cohomology-section-extension-by-zero}, see
Lemma \ref{lemma-finite-support-etale-shriek}. Finally, in
\'Etale Cohomology, Section \ref{etale-cohomology-section-extension-by-zero}
the functor $j_!$ is defined
as the left adjoint of $j^{-1}$ and hence we conclude by
uniqueness of adjoint functors.
\end{proof}

\begin{lemma}
\label{lemma-upper-shriek-restriction}
Let $f : X \to Y$ and $g : Y \to Z$ be separated and locally quasi-finite
morphisms. There is a canonical isomorphism $(g \circ f)^! \to f^! \circ g^!$.
Given a third locally quasi-finite morphism $h : Z \to T$
the diagram
$$
\xymatrix{
(h \circ g \circ f)^! \ar[r] \ar[d] &
f^! \circ (h \circ g)^! \ar[d] \\
(g \circ f)^! \circ h^! \ar[r] & f^! \circ g^! \circ h^!
}
$$
commutes.
\end{lemma}

\begin{proof}
By uniqueness of adjoint functors, this immediately translates
into the corresponding (dual) statement for the functors $f_!$.
See Lemma \ref{lemma-lqf-shriek-composition}.
\end{proof}

\begin{lemma}
\label{lemma-upper-shriek-restriction-etale}
Let $j : U \to X$ and $j' : V \to U$ be \'etale morphisms.
The isomorphism $(j \circ j')^{-1} = (j')^{-1} \circ j^{-1}$
and the isomorphism $(j \circ j')^! = (j')^! \circ j^!$ of
Lemma \ref{lemma-upper-shriek-restriction}
agree via the isomorphism of Lemma \ref{lemma-etale-upper-shriek}.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{remark}
\label{remark-pointed-sets}
The material in this section can be generalized to sheaves of pointed sets.
Namely, for a site $\mathcal{C}$ denote $\Sh^*(\mathcal{C})$ the category of
sheaves of pointed sets. The constructions in this and the preceding section
apply, mutatis mutandis, to sheaves of pointed sets. Thus given a locally
quasi-finite morphism $f : X \to Y$ of schemes we obtain
an adjoint pair of functors
$$
f_! : \Sh^*(X_\etale) \longrightarrow \Sh^*(Y_\etale)
\quad\text{and}\quad
f^! : \Sh^*(Y_\etale) \longrightarrow \Sh^*(X_\etale)
$$
such that for every geometric point $\overline{y}$ of $Y$ there are
isomorphisms
$$
(f_!\mathcal{F})_{\overline{y}} =
\coprod\nolimits_{f(\overline{x}) = \overline{y}}
\mathcal{F}_{\overline{x}}
$$
(coproduct taken in the category of pointed sets) functorial in
$\mathcal{F} \in \Sh^*(X_\etale)$ and isomorphisms
$$
f^!(\overline{y}_*S) =
\prod\nolimits_{f(\overline{x}) = \overline{y}}
\overline{x}_*S
$$
functorial in the pointed set $S$. If
$F : \textit{Ab}(X_\etale) \to \Sh^*(X_\etale)$ and
$F : \textit{Ab}(Y_\etale) \to \Sh^*(Y_\etale)$
denote the forgetful functors, compatibility between the constructions
will guarantee the existence of canonical maps
$$
f_!F(\mathcal{F}) \longrightarrow F(f_!\mathcal{F})
$$
functorial in $\mathcal{F} \in \textit{Ab}(X_\etale)$ and
$$
F(f^!\mathcal{G}) \longrightarrow f^!F(\mathcal{G})
$$
functorial in $\mathcal{G} \in \textit{Ab}(Y_\etale)$
which produce the obvious maps on stalks, resp.\ skyscraper sheaves.
In fact, the transformation $F \circ f^! \to f^! \circ F$ is an isomorphism
(because $f^!$ commutes with products).
\end{remark}







\section{Derived upper shriek for locally quasi-finite morphisms}
\label{section-derived-duality-locally-quasi-finite}

\noindent
We can take the derived versions of the functors in
Section \ref{section-duality-locally-quasi-finite}
and obtain the following.

\begin{lemma}
\label{lemma-lqf-shriek-derived}
Let $f : X \to Y$ be a locally quasi-finite morphism of schemes. The functors
$f_!$ and $f^!$ of Definition \ref{definition-f-shriek-lqf} and
Lemma \ref{lemma-lqf-f-upper-shriek}
induce adjoint functors $f_! : D(X_\etale) \to D(Y_\etale)$
and $Rf^! : D(Y_\etale) \to D(X_\etale)$ on derived categories.
\end{lemma}

\noindent
In the separated case the functor $f_!$ is defined in
Section \ref{section-compact-support}.

\begin{proof}
This follows immediately from
Derived Categories, Lemma \ref{derived-lemma-derived-adjoint-functors},
the fact that $f_!$ is exact (Lemma \ref{lemma-lqf-f-shriek-stalk})
and hence $Lf_! = f_!$
and the fact that we have enough K-injective complexes of abelian sheaves
on $Y_\etale$ so that $Rf^!$ is defined.
\end{proof}





















\input{chapters}

\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}
