\input{preamble}

% OK, start here.
%
\begin{document}

\title{The Cotangent Complex; UNDER CONSTRUCTION}


\maketitle

\phantomsection
\label{section-phantom}

\tableofcontents

\section{Introduction}
\label{section-introduction}

\noindent
The goal of this chapter is to construct the cotangent complex of a
morphism of schemes and of a morphism of algebraic spaces.
Some references are the notes \cite{quillenhomology}, the paper
\cite{quillencohomology}, and the books
\cite{Andre} and \cite{cotangent}.





\section{Derived lower shriek}
\label{section-derived-lower-shriek}

\noindent
In this section we work out some special cases of the situation
discussed in Cohomology on Sites, Section
\ref{sites-cohomology-section-derived-lower-shriek}.
We make sure that we have equality between lower shriek on modules
and sheaves of abelian groups. We encourage the reader to skip
this section on a first reading.

\begin{situation}
\label{situation-fibred-category}
Here $(\mathcal{D}, \mathcal{O}_\mathcal{D})$ be a ringed site
and $p : \mathcal{C} \to \mathcal{D}$ is a fibred category. We endow
$\mathcal{C}$ with the topology inherited from $\mathcal{D}$
(Stacks, Section \ref{stacks-section-topology}). We denote
$\pi : \Sh(\mathcal{C}) \to \Sh(\mathcal{D})$ the morphism of
topoi associated to $p$
(Stacks, Lemma \ref{stacks-lemma-topology-inherited-functorial}).
We set $\mathcal{O}_\mathcal{C} = \pi^{-1}\mathcal{O}_\mathcal{D}$
so that we obtain a morphism of ringed topoi
$$
\pi :
(\Sh(\mathcal{C}), \mathcal{O}_\mathcal{C})
\longrightarrow
(\Sh(\mathcal{D}), \mathcal{O}_\mathcal{D})
$$
\end{situation}

\begin{lemma}
\label{lemma-fibred-category-with-object}
Assumptions and notation as in Situation \ref{situation-fibred-category}.
For $U \in \Ob(\mathcal{C})$ consider the induced morphism
of topoi
$$
\pi_U : \Sh(\mathcal{C}/U) \longrightarrow \Sh(\mathcal{D}/p(U))
$$
Then there exists a morphism of topoi
$$
\sigma : \Sh(\mathcal{D}/p(U)) \to \Sh(\mathcal{C}/U)
$$
such that $\pi_U \circ \sigma = \text{id}$ and $\sigma^{-1} = \pi_{U, *}$.
\end{lemma}

\begin{proof}
Observe that $\pi_U$ is the restriction of $\pi$ to the localizations, see
Sites, Lemma \ref{sites-lemma-localize-cocontinuous}.
For an object $V \to p(U)$ of $\mathcal{D}/p(U)$ denote
$V \times_{p(U)} U \to U$ the strongly cartesian morphism of $\mathcal{C}$
over $\mathcal{D}$ which exists as $p$ is a fibred category.
The functor
$$
v : \mathcal{D}/p(U) \to \mathcal{C}/U,\quad
V/p(U) \mapsto V \times_{p(U)} U/U
$$
is continuous by the definition of the topology on $\mathcal{C}$.
Moreover, it is a right adjoint to $p$ by the definition of strongly
cartesian morphisms. Hence we are in the situation discussed in
Sites, Section \ref{sites-section-cocontinuous-adjoint}
and we see that the sheaf $\pi_{U, *}\mathcal{F}$
is equal to $V \mapsto \mathcal{F}(V \times_{p(U)} U)$
(see especially Sites, Lemma
\ref{sites-lemma-have-functor-other-way-morphism}).

\medskip\noindent
But here we have more. Namely, the functor $v$
is also cocontinuous (as all morphisms in coverings of $\mathcal{C}$ 
are strongly cartesian). Hence $v$ defines a morphism $\sigma$ as
indicated in the lemma. The equality $\sigma^{-1} = \pi_{U, *}$
is immediate from the definition. Since $\pi_U^{-1}\mathcal{G}$
is given by the rule $U'/U \mapsto \mathcal{G}(p(U')/p(U))$
it follows that $\sigma^{-1} \circ \pi_U^{-1} = \text{id}$
which proves the equality
$\pi_U \circ \sigma = \text{id}$.
\end{proof}

\begin{situation}
\label{situation-morphism-fibred-categories}
Let $(\mathcal{D}, \mathcal{O}_\mathcal{D})$ be a ringed site.
Let $u : \mathcal{C}' \to \mathcal{C}$ be a $1$-morphism of fibred
categories over $\mathcal{D}$
(Categories, Definition \ref{categories-definition-fibred-categories-over-C}).
Endow $\mathcal{C}$ and $\mathcal{C}'$ with their inherited topologies
(Stacks, Definition \ref{stacks-definition-topology-inherited})
and let
$\pi : \Sh(\mathcal{C}) \to \Sh(\mathcal{D})$,
$\pi' : \Sh(\mathcal{C}') \to \Sh(\mathcal{D})$, and
$g : \Sh(\mathcal{C}') \to \Sh(\mathcal{C})$
be the corresponding morphisms of topoi
(Stacks, Lemma \ref{stacks-lemma-topology-inherited-functorial}).
Set $\mathcal{O}_\mathcal{C} = \pi^{-1}\mathcal{O}_\mathcal{D}$
and $\mathcal{O}_{\mathcal{C}'} = (\pi')^{-1}\mathcal{O}_\mathcal{D}$.
Observe that $g^{-1}\mathcal{O}_\mathcal{C} = \mathcal{O}_{\mathcal{C}'}$
so that
$$
\xymatrix{
(\Sh(\mathcal{C}'), \mathcal{O}_{\mathcal{C}'}) \ar[rd]_{\pi'} \ar[rr]_g & &
(\Sh(\mathcal{C}), \mathcal{O}_\mathcal{C}) \ar[ld]^\pi \\
& (\Sh(\mathcal{D}), \mathcal{O}_\mathcal{D})
}
$$
is a commutative diagram of morphisms of ringed topoi.
\end{situation}

\begin{lemma}
\label{lemma-morphism-fibred-categories-with-object}
Assumptions and notation as in
Situation \ref{situation-morphism-fibred-categories}.
For $U' \in \Ob(\mathcal{C}')$ set $U = u(U')$ and $V = p'(U')$ and
consider the induced morphisms of ringed topoi
$$
\xymatrix{
(\Sh(\mathcal{C}'/U'), \mathcal{O}_{U'}) \ar[rd]_{\pi'_{U'}} \ar[rr]_{g'} & &
(\Sh(\mathcal{C}), \mathcal{O}_U) \ar[ld]^{\pi_U} \\
& (\Sh(\mathcal{D}/V), \mathcal{O}_V)
}
$$
Then there exists a morphism of topoi
$$
\sigma' : \Sh(\mathcal{D}/V) \to \Sh(\mathcal{C}'/U'),
$$
such that setting $\sigma = g' \circ \sigma'$ we have
$\pi'_{U'} \circ \sigma' = \text{id}$, $\pi_U \circ \sigma = \text{id}$,
$(\sigma')^{-1} = \pi'_{U', *}$, and $\sigma^{-1} = \pi_{U, *}$.
\end{lemma}

\begin{proof}
Let $v' : \mathcal{D}/V \to \mathcal{C}'/U'$ be the functor constructed
in the proof of Lemma \ref{lemma-fibred-category-with-object} starting
with $p' : \mathcal{C}' \to \mathcal{D}'$ and the object $U'$.
Since $u$ is a $1$-morphism of fibred categories over $\mathcal{D}$
it transforms strongly cartesian morphisms into strongly cartesian morphisms,
hence the functor $v = u \circ v'$ is the functor of
the proof of Lemma \ref{lemma-fibred-category-with-object}
relative to $p : \mathcal{C} \to \mathcal{D}$ and $U$. Thus our lemma
follows from that lemma.
\end{proof}

\begin{lemma}
\label{lemma-properties-lower-shriek-fibred-category}
Assumption and notation as in
Situation \ref{situation-morphism-fibred-categories}.
\begin{enumerate}
\item There are left adjoints
$g_! : \textit{Mod}(\mathcal{O}_{\mathcal{C}'}) \to
\textit{Mod}(\mathcal{O}_\mathcal{C})$ and
$g_!^{\textit{Ab}} : \textit{Ab}(\mathcal{C}') \to \textit{Ab}(\mathcal{C})$
to $g^* = g^{-1}$ on modules and on abelian sheaves.
\item The diagram
$$
\xymatrix{
\textit{Mod}(\mathcal{O}_{\mathcal{C}'}) \ar[d] \ar[r]_{g_!} &
\textit{Mod}(\mathcal{O}_\mathcal{C}) \ar[d] \\
\textit{Ab}(\mathcal{C}') \ar[r]^{g_!^{\textit{Ab}}} &
\textit{Ab}(\mathcal{C})
}
$$
commutes.
\item There are left adjoints
$Lg_! : D(\mathcal{O}_{\mathcal{C}'}) \to D(\mathcal{O}_\mathcal{C})$
and
$Lg_!^{\textit{Ab}} : D(\mathcal{C}') \to D(\mathcal{C})$
to $g^* = g^{-1}$ on derived categories of modules and abelian sheaves.
\item The diagram
$$
\xymatrix{
D(\mathcal{O}_{\mathcal{C}'}) \ar[d] \ar[r]_{Lg_!} &
D(\mathcal{O}_\mathcal{C}) \ar[d] \\
D(\mathcal{C}') \ar[r]^{Lg_!^{\textit{Ab}}} &
D(\mathcal{C})
}
$$
commutes.
\end{enumerate}
\end{lemma}

\begin{proof}
The functor $u$ is continuous and cocontinuous
Stacks, Lemma \ref{stacks-lemma-topology-inherited-functorial}.
Hence the existence of the functors $g_!$, $g_!^{\textit{Ab}}$,
$Lg_!$, and $Lg_!^{\textit{Ab}}$ can be found in
Modules on Sites, Sections
\ref{sites-modules-section-exactness-lower-shriek} and
\ref{sites-modules-section-lower-shriek-modules}
and
Cohomology on Sites, Section
\ref{sites-cohomology-section-derived-lower-shriek}.

\medskip\noindent
To prove (2) it suffices to show that the canonical map
$$
g_!^{\textit{Ab}}j_{U'!}\mathcal{O}_{U'} \to j_{u(U')!}\mathcal{O}_{u(U')}
$$
is an isomorphism for all objects $U'$ of $\mathcal{C}'$, see
Modules on Sites, Remark \ref{sites-modules-remark-when-shriek-equal}.
Similarly, to prove (4) it suffices to show that the canonical map
$$
Lg_!^{\textit{Ab}}j_{U'!}\mathcal{O}_{U'} \to j_{u(U')!}\mathcal{O}_{u(U')}
$$
is an isomorphism in $D(\mathcal{C})$ for all objects $U'$ of
$\mathcal{C}'$, see Cohomology on Sites, Remark
\ref{sites-cohomology-remark-when-derived-shriek-equal}.
This will also imply the previous formula hence this is what we will show.

\medskip\noindent
We will use that for a localization morphism $j$ the
functors $j_!$ and $j_!^{\textit{Ab}}$ agree (see
Modules on Sites, Remark \ref{sites-modules-remark-localize-shriek-equal})
and that $j_!$ is exact
(Modules on Sites, Lemma \ref{sites-modules-lemma-extension-by-zero-exact}).
Let us adopt the notation of
Lemma \ref{lemma-morphism-fibred-categories-with-object}.
Since $Lg_!^{\textit{Ab}} \circ j_{U'!} = j_{U!} \circ L(g')^{\textit{Ab}}_!$
(by commutativity of Sites, Lemma \ref{sites-lemma-localize-cocontinuous}
and uniqueness of adjoint functors) it suffices to prove that
$L(g')^{\textit{Ab}}_!\mathcal{O}_{U'} = \mathcal{O}_U$. Using the
results of
Lemma \ref{lemma-morphism-fibred-categories-with-object}
we have for any object $E$ of $D(\mathcal{C}/u(U'))$ the following
sequence of equalities
\begin{align*}
\Hom_{D(\mathcal{C}/U)}(L(g')_!^{\textit{Ab}}\mathcal{O}_{U'}, E)
& =
\Hom_{D(\mathcal{C}'/U')}(\mathcal{O}_{U'}, (g')^{-1}E) \\
& =
\Hom_{D(\mathcal{C}'/U')}((\pi'_{U'})^{-1}\mathcal{O}_V, (g')^{-1}E) \\
& =
\Hom_{D(\mathcal{D}/V)}(\mathcal{O}_V, R\pi'_{U', *}(g')^{-1}E) \\
& =
\Hom_{D(\mathcal{D}/V)}(\mathcal{O}_V, (\sigma')^{-1}(g')^{-1}E) \\
& =
\Hom_{D(\mathcal{D}/V)}(\mathcal{O}_V, \sigma^{-1}E) \\
& =
\Hom_{D(\mathcal{D}/V)}(\mathcal{O}_V, \pi_{U, *}E) \\
& =
\Hom_{D(\mathcal{C}/U)}(\pi_U^{-1}\mathcal{O}_V, E) \\
& =
\Hom_{D(\mathcal{C}/U)}(\mathcal{O}_U, E)
\end{align*}
By Yoneda's lemma we conclude.
\end{proof}

\begin{remark}
\label{remark-morphism-fibred-categories}
Assumptions and notation as in
Situation \ref{situation-morphism-fibred-categories}.
Let $\mathcal{F}$ be an abelian sheaf on $\mathcal{C}$,
let $\mathcal{F}'$ be an abelian sheaf on $\mathcal{C}'$,
and let $t : \mathcal{F}' \to g^{-1}\mathcal{F}$ be a map.
Then we obtain a canonical map
$$
L\pi'_!(\mathcal{F}') \longrightarrow L\pi_!(\mathcal{F})
$$
by using the adjoint $g_!\mathcal{F}' \to \mathcal{F}$ of $t$,
the map $Lg_!(\mathcal{F}') \to g_!\mathcal{F}'$, and the
equality $L\pi'_! = L\pi_! \circ Lg_!$.
\end{remark}

\begin{lemma}
\label{lemma-compute-pi-shriek}
Assumptions and notation as in
Situation \ref{situation-fibred-category}.
For $\mathcal{F}$ in $\textit{Ab}(\mathcal{C})$
the sheaf $\pi_!\mathcal{F}$ is the
sheaf associated the presheaf
$$
V \longmapsto \colim_{\mathcal{C}_V^{opp}} \mathcal{F}|_{\mathcal{C}_V}
$$
with restriction maps as indicated in the proof.
\end{lemma}

\begin{proof}
Denote $\mathcal{H}$ be the rule of the lemma.
For a morphism $h : V' \to V$ of $\mathcal{D}$ there is a
pullback functor $h^* : \mathcal{C}_V \to \mathcal{C}_{V'}$ of fibre
categories (Categories, Definition
\ref{categories-definition-pullback-functor-fibred-category}).
Moreover for $U \in \Ob(\mathcal{C}_V)$ there is a
strongly cartesian morphism $h^*U \to U$ covering $h$.
Restriction along these strongly cartesian morphisms defines a
transformation of functors
$$
\mathcal{F}|_{\mathcal{C}_V}
\longrightarrow
\mathcal{F}|_{\mathcal{C}_{V'}} \circ h^*.
$$
Hence a map $\mathcal{H}(V) \to \mathcal{H}(V')$ between colimits, see
Categories, Lemma \ref{categories-lemma-functorial-colimit}.

\medskip\noindent
To prove the lemma we show that
$$
\Mor_{\textit{PSh}(\mathcal{D})}(\mathcal{H}, \mathcal{G}) =
\Mor_{\textit{Sh}(\mathcal{C})}(\mathcal{F}, \pi^{-1}\mathcal{G})
$$
for every sheaf $\mathcal{G}$ on $\mathcal{C}$. An element of the
left hand side is a compatible system of maps
$\mathcal{F}(U) \to \mathcal{G}(p(U))$ for all $U$ in $\mathcal{C}$.
Since $\pi^{-1}\mathcal{G}(U) = \mathcal{G}(p(U))$ by our choice
of topology on $\mathcal{C}$ we see the same thing is true for the
right hand side and we win.
\end{proof}





\section{Homology on categories}
\label{section-homology}

\noindent
In the case of a category over a point we will baptize the left derived
lower shriek functors the homology functors.

\begin{example}[Category over point]
\label{example-category-to-point}
Let $\mathcal{C}$ be a category. Endow $\mathcal{C}$ with the chaotic
topology (Sites, Example \ref{sites-example-indiscrete}). Thus
presheaves and sheaves agree on $\mathcal{C}$.
The functor $p : \mathcal{C} \to *$ where $*$ is the category with a single
object and a single morphism is cocontinuous and continuous. Let
$\pi : \Sh(\mathcal{C}) \to \Sh(*)$ be the corresponding morphism
of topoi. Let $B$ be a ring. We endow $*$ with the sheaf of rings $B$
and $\mathcal{C}$ with $\mathcal{O}_\mathcal{C} = \pi^{-1}B$ which
we will often denote $\underline{B}$. In this way
$$
\pi : (\Sh(\mathcal{C}), \underline{B}) \to (*, B)
$$
is an example of Situation \ref{situation-fibred-category}
and
Lemma \ref{lemma-properties-lower-shriek-fibred-category}
applies to $\pi$ so we do not need to distinguish between $\pi_!$ on
modules or abelian sheaves. By
Lemma \ref{lemma-compute-pi-shriek} we see that
$\pi_!\mathcal{F} = \colim_{\mathcal{C}^{opp}} \mathcal{F}$.
Thus $L_n\pi_!$ is the $n$th left derived functor of taking colimits.
In the following, we write
$$
H_n(\mathcal{C}, \mathcal{F}) = L_n\pi_!(\mathcal{F})
$$
and we will name this the {\it $n$th homology group of $\mathcal{F}$}
on $\mathcal{C}$.
\end{example}

\begin{example}[Computing homology]
\label{example-left-derived-colimits}
In Example \ref{example-category-to-point} we can compute
the functors $H_n(\mathcal{C}, -)$ as follows. Let
$\mathcal{F} \in \Ob(\textit{Ab}(\mathcal{C}))$.
Consider the chain complex
$$
K_\bullet(\mathcal{F}) :
\ \ldots \to
\bigoplus\nolimits_{U_2 \to U_1 \to U_0} \mathcal{F}(U_0)
\to
\bigoplus\nolimits_{U_1 \to U_0} \mathcal{F}(U_0)
\to
\bigoplus\nolimits_{U_0} \mathcal{F}(U_0)
$$
where the transition maps are given by
$$
(U_2 \to U_1 \to U_0, s)
\longmapsto
(U_1 \to U_0, s) - (U_2 \to U_0, s) + (U_2 \to U_1, s|_{U_1})
$$
and similarly in other degrees. By construction
$$
H_0(\mathcal{C}, \mathcal{F}) =
\colim_{\mathcal{C}^{opp}} \mathcal{F} =
H_0(K_\bullet(\mathcal{F})),
$$
see Categories, Lemma \ref{categories-lemma-colimits-coproducts-coequalizers}.
The construction of $K_\bullet(\mathcal{F})$ is functorial in $\mathcal{F}$
and transforms short exact sequences of $\textit{Ab}(\mathcal{C})$ into
short exact sequences of complexes. Thus the sequence of functors
$\mathcal{F} \mapsto H_n(K_\bullet(\mathcal{F}))$ forms a $\delta$-functor, see
Homology, Definition \ref{homology-definition-cohomological-delta-functor} and
Lemma \ref{homology-lemma-long-exact-sequence-cochain}.
For $\mathcal{F} = j_{U!}\mathbf{Z}_U$ the complex $K_\bullet(\mathcal{F})$
is the complex associated to the free $\mathbf{Z}$-module on the simplicial
set $X_\bullet$ with terms
$$
X_n = \coprod\nolimits_{U_n \to \ldots \to U_1 \to U_0}
\Mor_\mathcal{C}(U_0, U)
$$
This simplicial set is homotopy equivalent to the constant simplicial
set on a singleton $\{*\}$. Namely, the map $X_\bullet \to \{*\}$
is obvious, the map $\{*\} \to X_n$ is given
by mapping $*$ to $(U \to \ldots \to U, \text{id}_U)$, and the
maps
$$
h_{n, i} : X_n \longrightarrow X_n
$$
(Simplicial, Lemma \ref{simplicial-lemma-relations-homotopy})
defining the homotopy between the two maps $X_\bullet \to X_\bullet$
are given by the rule
$$
h_{n, i} :
(U_n \to \ldots \to U_0, f)
\longmapsto
(U_n \to \ldots \to U_i \to U \to \ldots \to U, \text{id})
$$
for $i > 0$ and $h_{n, 0} = \text{id}$. Verifications omitted.
This implies that $K_\bullet(j_{U!}\mathbf{Z}_U)$ has trivial
cohomology in negative degrees
(by the functoriality of
Simplicial, Remark \ref{simplicial-remark-homotopy-better}
and the result of
Simplicial, Lemma \ref{simplicial-lemma-homotopy-s-N}).
Thus $K_\bullet(\mathcal{F})$ computes the left derived functors
$H_n(\mathcal{C}, -)$ of $H_0(\mathcal{C}, -)$
for example by (the duals of)
Homology, Lemma \ref{homology-lemma-efface-implies-universal}
and
Derived Categories, Lemma \ref{derived-lemma-right-derived-delta-functor}.
\end{example}

\begin{example}
\label{example-morphism-categories}
Let $u : \mathcal{C}' \to \mathcal{C}$ be a functor.
Endow $\mathcal{C}'$ and $\mathcal{C}$ with the chaotic
topology as in Example \ref{example-category-to-point}.
The functors $u$, $\mathcal{C}' \to *$, and $\mathcal{C} \to *$
where $*$ is the category with a single object and a single morphism
are cocontinuous and continuous. Let
$g : \Sh(\mathcal{C}') \to \Sh(\mathcal{C})$,
$\pi' : \Sh(\mathcal{C}') \to \Sh(*)$, and
$\pi : \Sh(\mathcal{C}) \to \Sh(*)$,
be the corresponding morphisms of topoi.
Let $B$ be a ring. We endow $*$ with the sheaf of rings $B$ and
$\mathcal{C}'$, $\mathcal{C}$ with the constant sheaf $\underline{B}$.
In this way
$$
\xymatrix{
(\Sh(\mathcal{C}'), \underline{B}) \ar[rd]_{\pi'} \ar[rr]_g & &
(\Sh(\mathcal{C}), \underline{B}) \ar[ld]^\pi \\
& (\Sh(*), B)
}
$$
is an example of Situation \ref{situation-morphism-fibred-categories}.
Thus
Lemma \ref{lemma-properties-lower-shriek-fibred-category}
applies to $g$ so we do not need to distinguish between $g_!$ on
modules or abelian sheaves. In particular
Remark \ref{remark-morphism-fibred-categories}
produces canonical maps
$$
H_n(\mathcal{C}', \mathcal{F}')
\longrightarrow
H_n(\mathcal{C}, \mathcal{F})
$$
whenever we have $\mathcal{F}$ in $\textit{Ab}(\mathcal{C})$,
$\mathcal{F}'$ in $\textit{Ab}(\mathcal{C}')$,
and a map $t : \mathcal{F}' \to g^{-1}\mathcal{F}$. In terms of the
computation of homology given in
Example \ref{example-left-derived-colimits}
we see that these maps come from a map of complexes
$$
K_\bullet(\mathcal{F}') \longrightarrow K_\bullet(\mathcal{F})
$$
given by the rule
$$
(U'_n \to \ldots \to U'_0, s') \longmapsto
(u(U'_n) \to \ldots \to u(U'_0), t(s'))
$$
with obvious notation.
\end{example}

\begin{remark}
\label{remark-map-evaluation-to-derived}
Notation and assumptions as in Example \ref{example-category-to-point}.
Let $\mathcal{F}^\bullet$ be a bounded complex of abelian sheaves on
$\mathcal{C}$. For any object $U$ of $\mathcal{C}$ there is a canonical
map
$$
\mathcal{F}^\bullet(U) \longrightarrow L\pi_!(\mathcal{F}^\bullet)
$$
in $D(\textit{Ab})$. If $\mathcal{F}^\bullet$ is a complex of
$\underline{B}$-modules then this map is in $D(B)$. To prove this, note
that we compute $L\pi_!(\mathcal{F}^\bullet)$ by taking a quasi-isomorphism
$\mathcal{P}^\bullet \to \mathcal{F}^\bullet$ where $\mathcal{P}^\bullet$
is a complex of projectives. However, since the topology is chaotic
this means that $\mathcal{F}^\bullet(U) \to \mathcal{P}^\bullet(U)$
is a quasi-isomorphism hence can be inverted in
$D(\textit{Ab})$, resp.\ $D(B)$. Composing with the canonical map
$\mathcal{P}^\bullet(U) \to \pi_!(\mathcal{P}^\bullet)$ (coming from
the computation of $\pi_!$ as a colimit) we obtain the desired arrow.
\end{remark}

\begin{lemma}
\label{lemma-initial-final}
Notation and assumptions as in Example \ref{example-category-to-point}.
If $\mathcal{C}$ has either an initial or a final object, then
$L\pi_! \circ \pi^{-1} = \text{id}$ on $D(\textit{Ab})$, resp.\ $D(B)$.
\end{lemma}

\begin{proof}
If $\mathcal{C}$ has an initial object, then $\pi_!$ is computed by
evaluating on this object and the statement is clear. If $\mathcal{C}$
has a final object, then $R\pi_*$ is computed by evaluating on this
object, hence $R\pi_* \circ \pi^{-1} \cong \text{id}$ on
$D(\textit{Ab})$, resp.\ $D(B)$. This implies that
$\pi^{-1} : D(\textit{Ab}) \to D(\mathcal{C})$,
resp.\ $\pi^{-1} : D(B) \to D(\underline{B})$ is fully faithful, see
Categories, Lemma \ref{categories-lemma-adjoint-fully-faithful}.
Then the same lemma implies that $L\pi_! \circ \pi^{-1} = \text{id}$
as desired.
\end{proof}

\begin{lemma}
\label{lemma-change-of-rings}
Notation and assumptions as in Example \ref{example-category-to-point}.
Let $B \to B'$ be a ring map. Consider the commutative diagram
of ringed topoi
$$
\xymatrix{
(\Sh(\mathcal{C}), \underline{B}) \ar[d]_\pi &
(\Sh(\mathcal{C}), \underline{B'}) \ar[d]^{\pi'} \ar[l]^h \\
(*, B) & (*, B') \ar[l]_f
}
$$
Then $L\pi_! \circ Lh^* = Lf^* \circ L\pi'_!$.
\end{lemma}

\begin{proof}
Both functors are right adjoint to the obvious functor
$D(B') \to D(\underline{B})$.
\end{proof}

\begin{lemma}
\label{lemma-compute-by-cosimplicial-resolution}
Notation and assumptions as in Example \ref{example-category-to-point}.
Let $U_\bullet$ be a cosimplicial object in $\mathcal{C}$ such that
for every $U \in \Ob(\mathcal{C})$ the simplicial set
$\Mor_\mathcal{C}(U_\bullet, U)$
is homotopy equivalent to the constant simplical set on a singleton. Then
$$
L\pi_!(\mathcal{F}) = \mathcal{F}(U_\bullet)
$$
in $D(\textit{Ab})$, resp.\ $D(B)$ functorially in $\mathcal{F}$ in
$\textit{Ab}(\mathcal{C})$, resp.\ $\textit{Mod}(\underline{B})$.
\end{lemma}

\begin{proof}
As $L\pi_!$ agrees for modules and abelian sheaves by
Lemma \ref{lemma-properties-lower-shriek-fibred-category}
it suffices to prove this when $\mathcal{F}$ is an abelian sheaf.
For $U \in \Ob(\mathcal{C})$ the abelian sheaf $j_{U!}\mathbf{Z}_U$
is a projective object of $\textit{Ab}(\mathcal{C})$ since
$\Hom(j_{U!}\mathbf{Z}_U, \mathcal{F}) = \mathcal{F}(U)$
and taking sections is an exact functor as the topology is chaotic.
Every abelian sheaf is a quotient of a direct sum of $j_{U!}\mathbf{Z}_U$
by Modules on Sites, Lemma \ref{sites-modules-lemma-module-quotient-flat}.
Thus we can compute $L\pi_!(\mathcal{F})$ by choosing a resolution
$$
\ldots \to \mathcal{G}^{-1} \to \mathcal{G}^0 \to \mathcal{F} \to 0
$$
whose terms are direct sums of sheaves of the form above and taking
$L\pi_!(\mathcal{F}) = \pi_!(\mathcal{G}^\bullet)$. Consider the
double complex
$A^{\bullet, \bullet} = \mathcal{G}^\bullet(U_\bullet)$.
The map $\mathcal{G}^0 \to \mathcal{F}$ gives a map of complexes
$A^{0, \bullet} \to \mathcal{F}(U_\bullet)$.
Since $\pi_!$ is computed by taking the colimit over
$\mathcal{C}^{opp}$ (Lemma \ref{lemma-compute-pi-shriek})
we see that the two compositions
$\mathcal{G}^m(U_1) \to \mathcal{G}^m(U_0) \to \pi_!\mathcal{G}^m$
are equal. Thus we obtain a canonical map of complexes
$$
\text{Tot}(A^{\bullet, \bullet})
\longrightarrow
\pi_!(\mathcal{G}^\bullet) = L\pi_!(\mathcal{F})
$$
To prove the lemma it suffices to show that the complexes
$$
\ldots \to \mathcal{G}^m(U_1) \to \mathcal{G}^m(U_0) \to
\pi_!\mathcal{G}^m \to 0
$$
are exact, see Homology, Lemma
\ref{homology-lemma-double-complex-gives-resolution}.
Since the sheaves $\mathcal{G}^m$ are direct sums of the sheaves
$j_{U!}\mathbf{Z}_U$ we reduce to $\mathcal{G} = j_{U!}\mathbf{Z}_U$.
The complex $j_{U!}\mathbf{Z}_U(U_\bullet)$
is the complex of abelian groups associated to the free
$\mathbf{Z}$-module on the simplicial set
$\Mor_\mathcal{C}(U_\bullet, U)$ which we assumed to be homotopy
equivalent to a singleton. We conclude that
$$
j_{U!}\mathbf{Z}_U(U_\bullet) \to \mathbf{Z}
$$
is a homotopy equivalence of abelian groups hence a quasi-isomorphism
(Simplicial, Remark \ref{simplicial-remark-homotopy-better} and
Lemma \ref{simplicial-lemma-homotopy-s-N}). This finishes the proof
since $\pi_!j_{U!}\mathbf{Z}_U = \mathbf{Z}$
as was shown in the proof of
Lemma \ref{lemma-properties-lower-shriek-fibred-category}.
\end{proof}

\begin{lemma}
\label{lemma-get-it-now}
Notation and assumptions as in Example \ref{example-morphism-categories}.
If there exists a cosimplicial object $U'_\bullet$ of $\mathcal{C}'$
such that Lemma \ref{lemma-compute-by-cosimplicial-resolution}
applies to both $U'_\bullet$ in $\mathcal{C}'$
and $u(U'_\bullet)$ in $\mathcal{C}$, then we have
$L\pi'_! \circ g^{-1} = L\pi_!$ as functors
$D(\mathcal{C}) \to D(\textit{Ab})$,
resp.\ $D(\mathcal{C}, \underline{B}) \to D(B)$.
\end{lemma}

\begin{proof}
Follows immediately from
Lemma \ref{lemma-compute-by-cosimplicial-resolution}
and the fact that $g^{-1}$ is given by precomposing with $u$.
\end{proof}

\begin{lemma}
\label{lemma-product-categories}
Let $\mathcal{C}_i$, $i = 1, 2$ be categories. Let
$u_i : \mathcal{C}_1 \times \mathcal{C}_2 \to \mathcal{C}_i$ be the
projection functors. Let $B$ be a ring. Let
$g_i : (\Sh(\mathcal{C}_1 \times \mathcal{C}_2), \underline{B}) \to
(\Sh(\mathcal{C}_i), \underline{B})$ be the corresponding morphisms
of ringed topoi, see Example \ref{example-morphism-categories}. For
$K_i \in D(\mathcal{C}_i, B)$ we have
$$
L(\pi_1 \times \pi_2)_!(
g_1^{-1}K_1 \otimes_{\underline{B}}^\mathbf{L} g_2^{-1}K_2)
=
L\pi_{1, !}(K_1) \otimes_B^\mathbf{L} L\pi_{2, !}(K_2)
$$
in $D(B)$ with obvious notation.
\end{lemma}

\begin{proof}
As both sides commute with colimits, it suffices to prove this for
$K_1 = j_{U!}\underline{B}_U$ and $K_2 = j_{V!}\underline{B}_V$
for $U \in \Ob(\mathcal{C}_1)$ and $V \in \Ob(\mathcal{C}_2)$.
See construction of $L\pi_!$ in Cohomology on Sites, Lemma
\ref{sites-cohomology-lemma-existence-derived-lower-shriek}.
In this case
$$
g_1^{-1}K_1 \otimes_{\underline{B}}^\mathbf{L} g_2^{-1}K_2 =
g_1^{-1}K_1 \otimes_{\underline{B}} g_2^{-1}K_2 =
j_{(U, V)!}\underline{B}_{(U, V)}
$$
Verification omitted. Hence the result follows as both the left and
the right hand side of the formula of the lemma evaluate to $B$, see
construction of $L\pi_!$ in
Cohomology on Sites, Lemma
\ref{sites-cohomology-lemma-existence-derived-lower-shriek}.
\end{proof}

\begin{lemma}
\label{lemma-eilenberg-zilber}
Notation and assumptions as in Example \ref{example-category-to-point}.
If there exists a cosimplicial object $U_\bullet$ of $\mathcal{C}$
such that Lemma \ref{lemma-compute-by-cosimplicial-resolution}
applies, then
$$
L\pi_!(K_1 \otimes^\mathbf{L}_{\underline{B}} K_2) =
L\pi_!(K_1) \otimes^\mathbf{L}_B L\pi_!(K_2)
$$
for all $K_i \in D(\underline{B})$.
\end{lemma}

\begin{proof}
Consider the diagram of categories and functors
$$
\xymatrix{
& & \mathcal{C} \\
\mathcal{C} \ar[r]^-u &
\mathcal{C} \times \mathcal{C} \ar[rd]^{u_2} \ar[ru]_{u_1} \\
& & \mathcal{C}
}
$$
where $u$ is the diagonal functor and $u_i$ are the projection functors.
This gives morphisms of ringed topoi $g$, $g_1$, $g_2$.
For any object $(U_1, U_2)$ of $\mathcal{C}$ we have
$$
\Mor_{\mathcal{C} \times \mathcal{C}}(u(U_\bullet), (U_1, U_2)) =
\Mor_\mathcal{C}(U_\bullet, U_1) \times \Mor_\mathcal{C}(U_\bullet, U_2)
$$
which is homotopy equivalent to a point by
Simplicial, Lemma \ref{simplicial-lemma-products-homotopy}.
Thus Lemma \ref{lemma-get-it-now} gives
$L\pi_!(g^{-1}K) = L(\pi \times \pi)_!(K)$ for any $K$ in
$D(\mathcal{C} \times \mathcal{C}, B)$.
Take $K = g_1^{-1}K_1 \otimes_B^\mathbf{L} g_2^{-1}K_2$.
Then $g^{-1}K = K_1 \otimes^\mathbf{L}_{\underline{B}} K_2$
because $g^{-1} = g^* = Lg^*$ commutes with derived tensor product
(Cohomology on Sites, Lemma
\ref{sites-cohomology-lemma-pullback-tensor-product}
-- a site with chaotic topology has enough points).
To finish we apply Lemma \ref{lemma-product-categories}.
\end{proof}

\begin{remark}[Simplicial modules]
\label{remark-simplicial-modules}
Let $\mathcal{C} = \Delta$ and let $B$ be any ring. This is a special
case of Example \ref{example-category-to-point} where the assumptions
of Lemma \ref{lemma-compute-by-cosimplicial-resolution} hold.
Namely, let $U_\bullet$ be the cosimplicial object of $\Delta$ given by
the identity functor. To verify the condition we have to show that for
$[m] \in \Ob(\Delta)$ the simplicial set
$\Delta[m] : n \mapsto \Mor_\Delta([n], [m])$ is homotopy equivalent
to a point. This is explained in
Simplicial, Example \ref{simplicial-example-simplex-contractible}.

\medskip\noindent
In this situation the category $\textit{Mod}(\underline{B})$
is just the category of simplicial $B$-modules and the
functor $L\pi_!$ sends a simplicial $B$-module $M_\bullet$ to its associated
complex $s(M_\bullet)$ of $B$-modules. Thus the results above can be
reinterpreted in terms of results on simplicial modules. For example
a special case of Lemma \ref{lemma-eilenberg-zilber} is:
if $M_\bullet$, $M'_\bullet$ are flat simplicial
$B$-modules, then the complex $s(M_\bullet \otimes_B M'_\bullet)$ is
quasi-isomorphic to the total complex associated to the double complex
$s(M_\bullet) \otimes_B s(M'_\bullet)$.
(Hint: use flatness to convert from derived tensor products to usual
tensor products.)
This is a special case of the Eilenberg-Zilber theorem
which can be found in \cite{Eilenberg-Zilber}.
\end{remark}

\begin{lemma}
\label{lemma-O-homology-B-homology-general}
Notation and assumptions as in Example \ref{example-category-to-point}.
Assume there exists a cosimplicial object $U_\bullet$ in $\mathcal{C}$ as in
Lemma \ref{lemma-compute-by-cosimplicial-resolution}.
Let $\mathcal{O} \to \underline{B}$ be a map of sheaves of rings
such that $L\pi_!\mathcal{O} \to L\pi_!\underline{B}$ is an isomorphism.
For any $\mathcal{O}$-module $\mathcal{F}$ we have
$$
L\pi_!(\mathcal{F}) =
L\pi_!(\mathcal{F} \otimes_\mathcal{O}^\mathbf{L} \underline{B})
$$
in $D(\textit{Ab})$.
\end{lemma}

\begin{proof}
Note: in this proof $L\pi_!$ denotes the left derived functor
of $\pi_!$ on abelian sheaves. We will prove
$L\pi_!(K) = L\pi_!(K \otimes_\mathcal{O}^\mathbf{L} \underline{B})$
for all objects $K$ of $D(\mathcal{O})$.
Since $L\pi_!$ commutes with colimits, it suffices
to prove this for bounded above complexes of $\mathcal{O}$-modules
(compare with argument of
Derived Categories, Proposition \ref{derived-proposition-left-derived-exists}
or just stick to bounded above complexes).
Every such complex is quasi-isomorphic to a bounded above complex
whose terms are direct sums of $j_{U!}\mathcal{O}_U$ with
$U \in \Ob(\mathcal{C})$, see
Modules on Sites, Lemma \ref{sites-modules-lemma-module-quotient-flat}.
Thus it suffices to prove the lemma
for $j_{U!}\mathcal{O}_U$. By assumption
$$
S_\bullet = \Mor_\mathcal{C}(U_\bullet, U)
$$
is a simplicial set homotopy equivalent to the constant simplicial
set on a singleton. Set $P_n = \mathcal{O}(U_n)$.
Observe that the complex associated to the simplicial
abelian group
$$
X_\bullet : n \longmapsto \bigoplus\nolimits_{s \in S_n} P_n
$$
computes $L\pi_!(j_{U!}\mathcal{O}_U)$. Since $j_{U!}\mathcal{O}_U$ is
a flat $\mathcal{O}$-module we have
$j_{U!}\mathcal{O}_U \otimes^\mathbf{L}_\mathcal{O} \underline{B} =
j_{U!}\underline{B}_U$ and $L\pi_!$ of this is computed by the complex
associated to the simplicial abelian group
$$
Y_\bullet : n \longmapsto \bigoplus\nolimits_{s \in S_n} B
$$
As the rule which to a simplicial set $T_\bullet$ associated the simplicial
abelian group with terms $\bigoplus_{t \in T_n} P_n$ is a functor, we see
that $X_\bullet \to P_\bullet$ is a homotopy equivalence of simplicial
abelian groups. Similarly, the rule which to a simplicial set
$T_\bullet$ associates the simplicial abelian group with terms
$\bigoplus_{t \in T_n} B$ is a functor. Hence $Y_\bullet \to B$
is a homotopy equivalence of simplicial abelian groups.
By assumption $P_\bullet \to B$ is a quasi-isomorphism
(since $P_\bullet$ computes $L\pi_!\mathcal{O}$ by
Lemma \ref{lemma-compute-by-cosimplicial-resolution}).
We conclude that $X_\bullet$ and $Y_\bullet$ are quasi-isomorphic as desired.
\end{proof}







\section{Cohomology on a category}
\label{section-cohomology}

\noindent
In the situation of Example \ref{example-category-to-point}
in addition to the derived functor $L\pi_!$, we also have the functor
$R\pi_*$. For an abelian sheaf $\mathcal{F}$ on $\mathcal{C}$
we have $H_n(\mathcal{C}, \mathcal{F}) = H^{-n}(L\pi_!\mathcal{F})$
and $H^n(\mathcal{C}, \mathcal{F}) = H^n(R\pi_*\mathcal{F})$.

\begin{example}[Computing cohomology]
\label{example-right-derived-limits}
In Example \ref{example-category-to-point} we can compute
the functors $H^n(\mathcal{C}, -)$ as follows. Let
$\mathcal{F} \in \Ob(\textit{Ab}(\mathcal{C}))$.
Consider the cochain complex
$$
K^\bullet(\mathcal{F}) :
\prod\nolimits_{U_0} \mathcal{F}(U_0)
\to
\prod\nolimits_{U_0 \to U_1} \mathcal{F}(U_0)
\to
\prod\nolimits_{U_0 \to U_1 \to U_2} \mathcal{F}(U_0)
\to \ldots
$$
where the transition maps are given by
$$
(s_{U_0 \to U_1})
\longmapsto
((U_0 \to U_1 \to U_2) \mapsto s_{U_0 \to U_1} - s_{U_0 \to U_2}
+ s_{U_1 \to U_2}|_{U_0})
$$
and similarly in other degrees. By construction
$$
H^0(\mathcal{C}, \mathcal{F}) =
\lim_{\mathcal{C}^{opp}} \mathcal{F} =
H^0(K^\bullet(\mathcal{F})),
$$
see Categories, Lemma \ref{categories-lemma-limits-products-equalizers}.
The construction of $K^\bullet(\mathcal{F})$ is functorial in $\mathcal{F}$
and transforms short exact sequences of $\textit{Ab}(\mathcal{C})$ into
short exact sequences of complexes. Thus the sequence of functors
$\mathcal{F} \mapsto H^n(K^\bullet(\mathcal{F}))$ forms a $\delta$-functor, see
Homology, Definition \ref{homology-definition-cohomological-delta-functor} and
Lemma \ref{homology-lemma-long-exact-sequence-cochain}.
For an object $U$ of $\mathcal{C}$ denote $p_U : \Sh(*) \to \Sh(\mathcal{C})$
the corresponding point with $p_U^{-1}$ equal to evaluation at $U$, see
Sites, Example \ref{sites-example-indiscrete-points}.
Let $A$ be an abelian group and set $\mathcal{F} = p_{U, *}A$. In this case
the complex $K^\bullet(\mathcal{F})$ is the complex with terms
$\text{Map}(X_n, A)$ where
$$
X_n = \coprod\nolimits_{U_0 \to \ldots \to U_{n - 1} \to U_n}
\Mor_\mathcal{C}(U, U_0)
$$
This simplicial set is homotopy equivalent to the constant simplicial
set on a singleton $\{*\}$. Namely, the map $X_\bullet \to \{*\}$
is obvious, the map $\{*\} \to X_n$ is given
by mapping $*$ to $(U \to \ldots \to U, \text{id}_U)$, and the
maps
$$
h_{n, i} : X_n \longrightarrow X_n
$$
(Simplicial, Lemma \ref{simplicial-lemma-relations-homotopy})
defining the homotopy between the two maps $X_\bullet \to X_\bullet$
are given by the rule
$$
h_{n, i} :
(U_0 \to \ldots \to U_n, f)
\longmapsto
(U \to \ldots \to U \to U_i \to \ldots \to U_n, \text{id})
$$
for $i > 0$ and $h_{n, 0} = \text{id}$. Verifications omitted.
Since $\text{Map}(-, A)$ is a contravariant functor, implies that
$K^\bullet(p_{U, *}A)$ has trivial cohomology in positive degrees
(by the functoriality of
Simplicial, Remark \ref{simplicial-remark-homotopy-better}
and the result of
Simplicial, Lemma \ref{simplicial-lemma-homotopy-s-Q}).
This implies that $K^\bullet(\mathcal{F})$ is acyclic in positive
degrees also if $\mathcal{F}$ is a product of sheaves of the form
$p_{U, *}A$. As every abelian sheaf on $\mathcal{C}$ embeds
into such a product we conclude that $K^\bullet(\mathcal{F})$
computes the left derived functors
$H^n(\mathcal{C}, -)$ of $H^0(\mathcal{C}, -)$
for example by
Homology, Lemma \ref{homology-lemma-efface-implies-universal}
and
Derived Categories, Lemma \ref{derived-lemma-right-derived-delta-functor}.
\end{example}

\begin{example}[Computing Exts]
\label{example-computing-exts}
In Example \ref{example-category-to-point} assume we are moreover given
a sheaf of rings $\mathcal{O}$ on $\mathcal{C}$. Let
$\mathcal{F}$, $\mathcal{G}$ be $\mathcal{O}$-modules.
Consider the complex $K^\bullet(\mathcal{G}, \mathcal{F})$
with degree $n$ term
$$
\prod\nolimits_{U_0 \to U_1 \to \ldots \to U_n}
\Hom_{\mathcal{O}(U_n)}(\mathcal{G}(U_n), \mathcal{F}(U_0))
$$
and transition map given by
$$
(\varphi_{U_0 \to U_1})
\longmapsto
((U_0 \to U_1 \to U_2) \mapsto
\varphi_{U_0 \to U_1} \circ \rho^{U_2}_{U_1}
- \varphi_{U_0 \to U_2}
+ \rho^{U_1}_{U_0} \circ \varphi_{U_1 \to U_2}
$$
and similarly in other degrees. Here the $\rho$'s indicate restriction maps.
By construction
$$
\Hom_\mathcal{O}(\mathcal{G}, \mathcal{F}) =
H^0(K^\bullet(\mathcal{G}, \mathcal{F}))
$$
for all pairs of $\mathcal{O}$-modules $\mathcal{F}, \mathcal{G}$.
The assignment
$(\mathcal{G}, \mathcal{F}) \mapsto K^\bullet(\mathcal{G}, \mathcal{F})$
is a bifunctor which transforms direct sums in the first variable into
products and commutes with products in the second variable.
We claim that
$$
\text{Ext}^i_\mathcal{O}(\mathcal{G}, \mathcal{F}) =
H^i(K^\bullet(\mathcal{G}, \mathcal{F}))
$$
for $i \geq 0$ provided either
\begin{enumerate}
\item $\mathcal{G}(U)$ is a projective $\mathcal{O}(U)$-module
for all $U \in \Ob(\mathcal{C})$, or
\item $\mathcal{F}(U)$ is an injective $\mathcal{O}(U)$-module
for all $U \in \Ob(\mathcal{C})$.
\end{enumerate}
Namely, case (1) the functor $K^\bullet(\mathcal{G}, -)$
is an exact functor from the category of $\mathcal{O}$-modules
to the category of cochain complexes of abelian groups.
Thus, arguing as in Remark \ref{example-right-derived-limits},
it suffices to show that $K^\bullet(\mathcal{G}, \mathcal{F})$
is acyclic in positive degrees when $\mathcal{F}$ is $p_{U, *}A$
for an $\mathcal{O}(U)$-module $A$.
Choose a short exact sequence
\begin{equation}
\label{equation-split}
0 \to \mathcal{G}' \to \bigoplus j_{U_i!}\mathcal{O}_{U_i} \to
\mathcal{G} \to 0
\end{equation}
see Modules on Sites, Lemma \ref{sites-modules-lemma-module-quotient-flat}.
Since (1) holds for the middle and right sheaves, it also holds for
$\mathcal{G}'$ and evaluating (\ref{equation-split})
on an object of $\mathcal{C}$
gives a split exact sequence of modules.
We obtain a short exact sequence of complexes
$$
0 \to
K^\bullet(\mathcal{G}, \mathcal{F}) \to
\prod K^\bullet(j_{U_i!}\mathcal{O}_{U_i}, \mathcal{F}) \to
K^\bullet(\mathcal{G}', \mathcal{F}) \to 0
$$
for any $\mathcal{F}$, in particular $\mathcal{F} = p_{U, *}A$.
On $H^0$ we obtain
$$
0 \to \Hom(\mathcal{G}, p_{U, *}A) \to
\Hom(\prod j_{U_i!}\mathcal{O}_{U_i}, p_{U, *}A) \to
\Hom(\mathcal{G}', p_{U, *}A) \to 0
$$
which is exact as
$\Hom(\mathcal{H}, p_{U, *}A) = \Hom_{\mathcal{O}(U)}(\mathcal{H}(U), A)$
and the sequence of sections of (\ref{equation-split}) over $U$ is split exact.
Thus we can use dimension shifting to see that it suffices to prove
$K^\bullet(j_{U'!}\mathcal{O}_{U'}, p_{U, *}A)$ is acyclic in positive
degrees for all $U, U' \in \Ob(\mathcal{C})$. In this case
$K^n(j_{U'!}\mathcal{O}_{U'}, p_{U, *}A)$ is equal to
$$
\prod\nolimits_{U \to U_0 \to U_1 \to \ldots \to U_n \to U'} A
$$
In other words, $K^\bullet(j_{U'!}\mathcal{O}_{U'}, p_{U, *}A)$
is the complex with terms $\text{Map}(X_\bullet, A)$ where
$$
X_n = \coprod\nolimits_{U_0 \to \ldots \to U_{n - 1} \to U_n}
\Mor_\mathcal{C}(U, U_0) \times \Mor_\mathcal{C}(U_n, U')
$$
This simplicial set is homotopy equivalent to the constant simplicial
set on a singleton $\{*\}$ as can be proved in exactly the same way
as the corresponding statement in Remark \ref{example-right-derived-limits}.
This finishes the proof of the claim.

\medskip\noindent
The argument in case (2) is similar (but dual).
\end{example}









\section{Calculating derived lower shriek}
\label{section-calculate}

\noindent
In this section we apply the results from
Section \ref{section-homology}
to compute
$L\pi_!$ in Situation \ref{situation-fibred-category} and
$Lg_!$ in Situation \ref{situation-morphism-fibred-categories}.

\begin{lemma}
\label{lemma-compute-left-derived-pi-shriek-pre}
Assumptions and notation as in Situation \ref{situation-fibred-category}.
For $\mathcal{F}$ in $\textit{PAb}(\mathcal{C})$ and $n \geq 0$
consider the abelian sheaf $L_n(\mathcal{F})$ on $\mathcal{D}$
which is the sheaf associated to the presheaf
$$
V \longmapsto H_n(\mathcal{C}_V, \mathcal{F}|_{\mathcal{C}_V})
$$
with restriction maps as indicated in the proof. Then
$L_n(\mathcal{F}) = L_n(\mathcal{F}^\#)$.
\end{lemma}

\begin{proof}
For a morphism $h : V' \to V$ of $\mathcal{D}$ there is a
pullback functor $h^* : \mathcal{C}_V \to \mathcal{C}_{V'}$ of fibre
categories (Categories, Definition
\ref{categories-definition-pullback-functor-fibred-category}).
Moreover for $U \in \Ob(\mathcal{C}_V)$ there is a
strongly cartesian morphism $h^*U \to U$ covering $h$.
Restriction along these strongly cartesian morphisms defines a
transformation of functors
$$
\mathcal{F}|_{\mathcal{C}_V}
\longrightarrow
\mathcal{F}|_{\mathcal{C}_{V'}} \circ h^*.
$$
By Example \ref{example-morphism-categories}
we obtain the desired restriction map
$$
H_n(\mathcal{C}_V, \mathcal{F}|_{\mathcal{C}_V})
\longrightarrow
H_n(\mathcal{C}_{V'}, \mathcal{F}|_{\mathcal{C}_{V'}})
$$
Let us denote $L_{n, p}(\mathcal{F})$ this presheaf, so that
$L_n(\mathcal{F}) = L_{n, p}(\mathcal{F})^\#$.
The canonical map $\gamma : \mathcal{F} \to \mathcal{F}^+$
(Sites, Theorem \ref{sites-theorem-plus})
defines a canonical
map $L_{n, p}(\mathcal{F}) \to L_{n, p}(\mathcal{F}^+)$.
We have to prove this map becomes an isomorphism after sheafification.

\medskip\noindent
Let us use the computation of homology given in
Example \ref{example-left-derived-colimits}. Denote
$K_\bullet(\mathcal{F}|_{\mathcal{C}_V})$ the complex associated to
the restriction of $\mathcal{F}$ to the fibre category $\mathcal{C}_V$.
By the remarks above we obtain a presheaf $K_\bullet(\mathcal{F})$
of complexes
$$
V \longmapsto K_\bullet(\mathcal{F}|_{\mathcal{C}_V})
$$
whose cohomology presheaves are the presheaves $L_{n, p}(\mathcal{F})$.
Thus it suffices to show that
$$
K_\bullet(\mathcal{F}) \longrightarrow K_\bullet(\mathcal{F}^+)
$$
becomes an isomorphism on sheafification.

\medskip\noindent
Injectivity. Let $V$ be an object of $\mathcal{D}$ and let
$\xi \in K_n(\mathcal{F})(V)$ be an element which maps
to zero in $K_n(\mathcal{F}^+)(V)$. We have to show there exists a
covering $\{V_j \to V\}$ such that $\xi|_{V_j}$ is zero in
$K_n(\mathcal{F})(V_j)$. We write
$$
\xi = \sum (U_{i, n + 1} \to \ldots \to U_{i, 0}, \sigma_i)
$$
with $\sigma_i \in \mathcal{F}(U_{i, 0})$. We arrange it so that
each sequence of morphisms $U_n \to \ldots \to U_0$ of $\mathcal{C}_V$
occurs are most once. Since the sums in the definition
of the complex $K_\bullet$ are direct sums, the only way this can map
to zero in $K_\bullet(\mathcal{F}^+)(V)$ is if all $\sigma_i$ map
to zero in $\mathcal{F}^+(U_{i, 0})$. By construction of
$\mathcal{F}^+$ there exist coverings $\{U_{i, 0, j} \to U_{i, 0}\}$
such that $\sigma_i|_{U_{i, 0, j}}$ is zero. By our construction of
the topology on $\mathcal{C}$ we can write $U_{i, 0, j} \to U_{i, 0}$
as the pullback (Categories, Definition
\ref{categories-definition-pullback-functor-fibred-category})
of some morphisms $V_{i, j} \to V$ and moreover each
$\{V_{i, j} \to V\}$ is a covering. Choose a covering
$\{V_j \to V\}$ dominating each of the coverings $\{V_{i, j} \to V\}$.
Then it is clear that $\xi|_{V_j} = 0$.

\medskip\noindent
Surjectivity. Proof omitted. Hint: Argue as in the proof of
injectivity.
\end{proof}

\begin{lemma}
\label{lemma-compute-left-derived-pi-shriek}
Assumptions and notation as in Situation \ref{situation-fibred-category}.
For $\mathcal{F}$ in $\textit{Ab}(\mathcal{C})$ and $n \geq 0$
the sheaf $L_n\pi_!(\mathcal{F})$ is equal to the sheaf
$L_n(\mathcal{F})$ constructed in
Lemma \ref{lemma-compute-left-derived-pi-shriek-pre}.
\end{lemma}

\begin{proof}
Consider the sequence of functors $\mathcal{F} \mapsto L_n(\mathcal{F})$
from $\textit{PAb}(\mathcal{C}) \to \textit{Ab}(\mathcal{C})$.
Since for each $V \in \Ob(\mathcal{D})$ the sequence of functors
$H_n(\mathcal{C}_V, - )$ forms a $\delta$-functor
so do the functors $\mathcal{F} \mapsto L_n(\mathcal{F})$.
Our goal is to show these form a universal $\delta$-functor.
In order to do this we construct some abelian presheaves
on which these functors vanish.

\medskip\noindent
For $U' \in \Ob(\mathcal{C})$ consider the abelian presheaf
$\mathcal{F}_{U'} = j_{U'!}^{\textit{PAb}}\mathbf{Z}_{U'}$
(Modules on Sites, Remark \ref{sites-modules-remark-localize-presheaves}).
Recall that
$$
\mathcal{F}_{U'}(U) =
\bigoplus\nolimits_{\Mor_\mathcal{C}(U, U')} \mathbf{Z}
$$
If $U$ lies over $V = p(U)$ in $\mathcal{D})$ and $U'$ lies over $V' = p(U')$
then any morphism $a : U \to U'$ factors uniquely as $U \to h^*U' \to U'$
where $h = p(a) : V \to V'$ (see
Categories, Definition
\ref{categories-definition-pullback-functor-fibred-category}).
Hence we see that
$$
\mathcal{F}_{U'}|_{\mathcal{C}_V}
=
\bigoplus\nolimits_{h \in \Mor_\mathcal{D}(V, V')}
j_{h^*U'!}\mathbf{Z}_{h^*U'}
$$
where $j_{h^*U'} : \Sh(\mathcal{C}_V/h^*U') \to \Sh(\mathcal{C}_V)$
is the localization morphism. The sheaves $j_{h^*U'!}\mathbf{Z}_{h^*U'}$
have vanishing higher homology groups (see
Example \ref{example-left-derived-colimits}).
We conclude that $L_n(\mathcal{F}_{U'}) = 0$ for all $n > 0$ and all $U'$.
It follows that any abelian presheaf $\mathcal{F}$ is a quotient
of an abelian presheaf $\mathcal{G}$ with $L_n(\mathcal{G}) = 0$ for
all $n > 0$ (Modules on Sites, Lemma
\ref{sites-modules-lemma-module-quotient-flat}).
Since $L_n(\mathcal{F}) = L_n(\mathcal{F}^\#)$ we see
that the same thing is true for abelian sheaves. Thus
the sequence of functors $L_n(-)$ is a universal delta functor
on $\textit{Ab}(\mathcal{C})$
(Homology, Lemma \ref{homology-lemma-efface-implies-universal}).
Since we have agreement with
$H^{-n}(L\pi_!(-))$ for $n = 0$ by
Lemma \ref{lemma-compute-pi-shriek}
we conclude by uniqueness of universal $\delta$-functors
(Homology, Lemma \ref{homology-lemma-uniqueness-universal-delta-functor})
and
Derived Categories, Lemma \ref{derived-lemma-right-derived-delta-functor}.
\end{proof}

\begin{lemma}
\label{lemma-compute-left-derived-g-shriek}
Assumptions and notation as in
Situation \ref{situation-morphism-fibred-categories}.
For an abelian sheaf $\mathcal{F}'$ on $\mathcal{C}'$ the sheaf
$L_ng_!(\mathcal{F}')$ is the sheaf associated to the presheaf
$$
U \longmapsto H_n(\mathcal{I}_U, \mathcal{F}'_U)
$$
For notation and restriction maps see proof.
\end{lemma}

\begin{proof}
Say $p(U) = V$. The category $\mathcal{I}_U$ is the category of pairs
$(U', \varphi)$ where $\varphi : U \to u(U')$ is a morphism of $\mathcal{C}$
with $p(\varphi) = \text{id}_V$, i.e., $\varphi$ is a morphism of the
fibre category $\mathcal{C}_V$. Morphisms
$(U'_1, \varphi_1) \to (U'_2, \varphi_2)$ are given by morphisms
$a : U'_1 \to U'_2$ of the fibre category $\mathcal{C}'_V$ such that
$\varphi_2 = u(a) \circ \varphi_1$. The presheaf $\mathcal{F}'_U$ sends
$(U', \varphi)$ to $\mathcal{F}'(U')$.
We will construct the restriction mappings below.

\medskip\noindent
Choose a factorization
$$
\xymatrix{
\mathcal{C}' \ar@<1ex>[r]^{u'} &
\mathcal{C}'' \ar[r]^{u''} \ar@<1ex>[l]^w & \mathcal{C}
}
$$
of $u$ as in
Categories, Lemma \ref{categories-lemma-ameliorate-morphism-fibred-categories}.
Then $g_! = g''_! \circ g'_!$ and similarly for derived functors.
On the other hand, the functor $g'_!$ is exact, see
Modules on Sites, Lemma \ref{sites-modules-lemma-have-left-adjoint}.
Thus we get $Lg_!(\mathcal{F}') = Lg''_!(\mathcal{F}'')$ where
$\mathcal{F}'' = g'_!\mathcal{F}'$. Note that
$\mathcal{F}'' = h^{-1}\mathcal{F}'$ where
$h : \Sh(\mathcal{C}'') \to \Sh(\mathcal{C}')$ is the morphism of topoi
associated to $w$, see
Sites, Lemma \ref{sites-lemma-have-left-adjoint}.
The functor $u''$ turns $\mathcal{C}''$ into a fibred category
over $\mathcal{C}$, hence
Lemma \ref{lemma-compute-left-derived-pi-shriek}
applies to the computation of $L_ng''_!$. The result follows as the
construction of $\mathcal{C}''$ in the proof of
Categories, Lemma \ref{categories-lemma-ameliorate-morphism-fibred-categories}
shows that the fibre category $\mathcal{C}''_U$ is equal to
$\mathcal{I}_U$. Moreover, $h^{-1}\mathcal{F}'|_{\mathcal{C}''_U}$
is given by the rule described above
(as $w$ is continuous and cocontinuous by
Stacks, Lemma \ref{stacks-lemma-topology-inherited-functorial}
so we may apply
Sites, Lemma \ref{sites-lemma-when-shriek}).
\end{proof}







\section{The cotangent complex of a ring map}
\label{section-cotangent-ring-map}

\noindent
Let $A$ be a ring. Let $\textit{Alg}_A$ be the category of $A$-algebras.
Consider the pair of adjoint functors $(F, i)$ where
$i : \textit{Alg}_A \to \textit{Sets}$ is the forgetful functor and
$F : \textit{Sets} \to \textit{Alg}_A$ assigns to a set $E$ the polynomial
algebra $A[E]$ on $E$ over $A$. Let $X_\bullet$ be the simplicial object of
$\text{Fun}(\textit{Alg}_A, \textit{Alg}_A)$ constructed in
Simplicial, Section \ref{simplicial-section-standard}.

\medskip\noindent
Consider an $A$-algebra $B$. Denote $P_\bullet = X_\bullet(B)$ the resulting
simplicial $A$-algebra. Recall that $P_0 = A[B]$, $P_1 = A[A[B]]$, and so on.
In particular each term $P_n$ is a polynomial $A$-algebra.
Recall also that there is an augmentation
$$
\epsilon : P_\bullet \longrightarrow B
$$
where we view $B$ as a constant simplicial $A$-algebra.

\begin{definition}
\label{definition-standard-resolution}
Let $A \to B$ be a ring map. The {\it standard resolution of $B$ over $A$}
is the augmentation $\epsilon : P_\bullet \to A$ with terms
$$
P_0 = A[B],\quad P_1 = A[A[B]],\quad \ldots
$$
and maps as constructed above.
\end{definition}

\noindent
It will turn out that we can use the standard resolution
to compute left derived functors in certain settings.

\begin{definition}
\label{definition-cotangent-complex-ring-map}
The {\it cotangent complex} $L_{B/A}$ of a ring map $A \to B$
is the complex of $B$-modules associated to the simplicial $B$-module
$$
\Omega_{P_\bullet/A} \otimes_{P_\bullet, \epsilon} B
$$
where $\epsilon : P_\bullet \to B$ is the standard resolution
of $B$ over $A$.
\end{definition}

\noindent
In Simplicial, Section \ref{simplicial-section-complexes} we associate a
chain complex to a simplicial module, but here we work with cochain complexes.
Thus the term $L_{B/A}^{-n}$ in degree $-n$ is the $B$-module
$\Omega_{P_n/A} \otimes_{P_n, \epsilon_n} B$ and $L_{B/A}^m = 0$
for $m > 0$.

\begin{remark}
\label{remark-variant-cotangent-complex}
Let $A \to B$ be a ring map. Let $\mathcal{A}$ be the category of
arrows $\psi : C \to B$ of $A$-algebras and let $\mathcal{S}$ be
the category of maps $E \to B$ where $E$ is a set. There are adjoint
functors $i : \mathcal{A} \to \mathcal{S}$ (the forgetful functor)
and $F : \mathcal{S} \to \mathcal{A}$ which sends $E \to B$ to
$A[E] \to B$. Let $X_\bullet$ be the simplicial object of
$\text{Fun}(\mathcal{A}, \mathcal{A})$ constructed in
Simplicial, Section \ref{simplicial-section-standard}.
The diagram
$$
\xymatrix{
\mathcal{A} \ar[d] \ar[r] & \mathcal{S} \ar@<1ex>[l] \ar[d] \\
\textit{Alg}_A \ar[r] & \textit{Sets} \ar@<1ex>[l]
}
$$
commutes. It follows that $X_\bullet(\text{id}_B : B \to B)$
is equal to the standard resolution of $B$ over $A$.
\end{remark}

\begin{lemma}
\label{lemma-colimit-cotangent-complex}
Let $A_i \to B_i$ be a system of ring maps over a directed index
set $I$. Then $\colim L_{A_i/B_i} = L_{\colim A_i/\colim B_i}$.
\end{lemma}

\begin{proof}
This is true because the forgetful functor
$i : A\textit{-Alg} \to \textit{Sets}$ and its adjoint
$F : \textit{Sets} \to A\textit{-Alg}$ commute with filtered colimits.
Moreover, the functor $B/A \mapsto \Omega_{B/A}$ does as well
(Algebra, Lemma \ref{algebra-lemma-colimit-differentials}).
\end{proof}





\section{Simplicial resolutions and derived lower shriek}
\label{section-compute-L-pi-shriek}

\noindent
Let $A \to B$ be a ring map. Consider the category of $A$-algebra maps
$\alpha : P \to B$ where $P$ is a polynomial algebra over $A$
(in some set\footnote{It suffices to consider sets of cardinality
at most the cardinality of $B$.} of variables).
Let $\mathcal{C} = \mathcal{C}_{B/A}$ denote the {\bf opposite}
of this category. The reason for
taking the opposite is that we want to think of objects
$(P, \alpha)$ as corresponding to the diagram of affine schemes
$$
\xymatrix{
\Spec(B) \ar[d] \ar[r] & \Spec(P) \ar[ld] \\
\Spec(A)
}
$$
We endow $\mathcal{C}$ with the chaotic topology
(Sites, Example \ref{sites-example-indiscrete}), i.e., we endow
$\mathcal{C}$ with the structure of a site where coverings are given by
identities so that all presheaves are sheaves.
Moreover, we endow $\mathcal{C}$ with two sheaves of rings. The first
is the sheaf $\mathcal{O}$ which sends to object $(P, \alpha)$ to $P$.
Then second is the constant sheaf $B$, which we will denote
$\underline{B}$. We obtain the following diagram of morphisms of
ringed topoi
\begin{equation}
\label{equation-pi}
\vcenter{
\xymatrix{
(\Sh(\mathcal{C}), \underline{B}) \ar[r]_i \ar[d]_\pi &
(\Sh(\mathcal{C}), \mathcal{O}) \\
(\Sh(*), B)
}
}
\end{equation}
The morphism $i$ is the identity on underlying topoi and
$i^\sharp : \mathcal{O} \to \underline{B}$ is the obvious map.
The map $\pi$ is as in Example \ref{example-category-to-point}.
An important role will be played in the following
by the derived functors
$
Li^* : D(\mathcal{O}) \longrightarrow D(\underline{B})
$
left adjoint to $Ri_* = i_* : D(\underline{B}) \to D(\mathcal{O})$ and
$
L\pi_! : D(\underline{B}) \longrightarrow D(B)
$
left adjoint to $\pi^* = \pi^{-1} : D(B) \to D(\underline{B})$.

\begin{lemma}
\label{lemma-identify-pi-shriek}
With notation as above let $P_\bullet$ be a simplicial $A$-algebra
endowed with an augmentation $\epsilon : P_\bullet \to B$.
Assume each $P_n$ is a polynomial algebra over $A$ and $\epsilon$
is a trivial Kan fibration on underlying simplicial sets. Then
$$
L\pi_!(\mathcal{F}) = \mathcal{F}(P_\bullet, \epsilon)
$$
in $D(\textit{Ab})$, resp.\ $D(B)$ functorially in $\mathcal{F}$ in
$\textit{Ab}(\mathcal{C})$, resp.\ $\textit{Mod}(\underline{B})$.
\end{lemma}

\begin{proof}
We will use the criterion of
Lemma \ref{lemma-compute-by-cosimplicial-resolution} to prove this.
Given an object $U = (Q, \beta)$ of $\mathcal{C}$ we have to show that
$$
S_\bullet = \Mor_\mathcal{C}((Q, \beta), (P_\bullet, \epsilon))
$$
is homotopy equivalent to a singleton.
Write $Q = A[E]$ for some set $E$ (this is possible by our choice of
the category $\mathcal{C}$). We see that
$$
S_\bullet = \Mor_{\textit{Sets}}((E, \beta|_E), (P_\bullet, \epsilon))
$$
Let $*$ be the constant simplicial set on a singleton. For $b \in B$
let $F_{b, \bullet}$ be the simplicial set defined by the cartesian
diagram
$$
\xymatrix{
F_{b, \bullet} \ar[r] \ar[d] & P_\bullet \ar[d]_\epsilon \\
{*} \ar[r]^b & B
}
$$
With this notation $S_\bullet = \prod_{e \in E} F_{\beta(e), \bullet}$.
Since we assumed $\epsilon$ is a trival Kan fibration we see that
$F_{b, \bullet} \to *$ is a trivial Kan fibration
(Simplicial, Lemma \ref{simplicial-lemma-trivial-kan-base-change}).
Thus $S_\bullet \to *$ is a trivial Kan fibration
(Simplicial, Lemma \ref{simplicial-lemma-product-trivial-kan}).
Therefore $S_\bullet$ is homotopy equivalent to $*$
(Simplicial, Lemma \ref{simplicial-lemma-trivial-kan-homotopy}).
\end{proof}

\noindent
In particular, we can use the standard resolution of $B$ over $A$
to compute derived lower shriek.

\begin{lemma}
\label{lemma-pi-shriek-standard}
Let $A \to B$ be a ring map. Let $\epsilon : P_\bullet \to B$
be the standard resolution of $B$ over $A$. Let $\pi$ be as in
(\ref{equation-pi}). Then
$$
L\pi_!(\mathcal{F}) = \mathcal{F}(P_\bullet, \epsilon)
$$
in $D(\textit{Ab})$, resp.\ $D(B)$ functorially in $\mathcal{F}$ in
$\textit{Ab}(\mathcal{C})$, resp.\ $\textit{Mod}(\underline{B})$.
\end{lemma}

\begin{proof}[First proof]
We will apply Lemma \ref{lemma-identify-pi-shriek}.
Since the terms $P_n$ are polynomial algebras we see the first
assumption of that lemma is satisfied. We give two proofs of the second
assumption. By
Simplicial, Lemma \ref{simplicial-lemma-standard-simplicial-homotopy}
the map $\epsilon$ is a homotopy equivalence of underlying
simplicial sets. By
Simplicial, Lemma \ref{simplicial-lemma-homotopy-equivalence}
this implies $\epsilon$ induces a quasi-isomorphism of associated
complexes of abelian groups. By
Simplicial, Lemma \ref{simplicial-lemma-qis-simplicial-abelian-groups}
this implies that $\epsilon$ is a trivial Kan fibration of underlying
simplicial sets.
\end{proof}

\begin{proof}[Second proof]
We will use the criterion of
Lemma \ref{lemma-compute-by-cosimplicial-resolution}.
Let $U = (Q, \beta)$ be an object of $\mathcal{C}$.
We have to show that
$$
S_\bullet = \Mor_\mathcal{C}((Q, \beta), (P_\bullet, \epsilon))
$$
is homotopy equivalent to a singleton. Write $Q = A[E]$ for some set $E$
(this is possible by our choice of the category $\mathcal{C}$). Using the
notation of Remark \ref{remark-variant-cotangent-complex} we see that
$$
S_\bullet = \Mor_\mathcal{S}((E \to B), i(P_\bullet \to B))
$$
By Simplicial, Lemma \ref{simplicial-lemma-standard-simplicial-homotopy}
the map $i(P_\bullet \to B) \to i(B \to B)$ is a homotopy equivalence
in $\mathcal{S}$. Hence $S_\bullet$ is homotopy equivalent to
$$
\Mor_\mathcal{S}((E \to B), (B \to B)) = \{*\}
$$
as desired.
\end{proof}

\begin{lemma}
\label{lemma-compute-cotangent-complex}
Let $A \to B$ be a ring map.  Let $\pi$ and $i$ be as in (\ref{equation-pi}).
There is a canonical isomorphism
$$
L_{B/A} = L\pi_!(Li^*\Omega_{\mathcal{O}/A}) =
L\pi_!(i^*\Omega_{\mathcal{O}/A}) =
L\pi_!(\Omega_{\mathcal{O}/A} \otimes_\mathcal{O} \underline{B})
$$
in $D(B)$.
\end{lemma}

\begin{proof}
For an object $\alpha : P \to B$ of the category $\mathcal{C}$
the module $\Omega_{P/A}$ is a free $P$-module. Thus
$\Omega_{\mathcal{O}/A}$ is a flat $\mathcal{O}$-module. Hence
$Li^*\Omega_{\mathcal{O}/A} = i^*\Omega_{\mathcal{O}/A}$ is the sheaf
of $\underline{B}$-modules which associates to $\alpha : P \to A$ the
$B$-module $\Omega_{P/A} \otimes_{P, \alpha} B$.
By Lemma \ref{lemma-pi-shriek-standard}
we see that the right hand side is computed by
the value of this sheaf on the standard resolution which is our
definition of the left hand side
(Definition \ref{definition-cotangent-complex-ring-map}).
\end{proof}

\begin{lemma}
\label{lemma-pi-lower-shriek-constant-sheaf}
If $A \to B$ is a ring map, then $L\pi_!(\pi^{-1}M) = M$
with $\pi$ as in (\ref{equation-pi}).
\end{lemma}

\begin{proof}
This follows from Lemma \ref{lemma-identify-pi-shriek} which tells us
$L\pi_!(\pi^{-1}M)$ is computed by $(\pi^{-1}M)(P_\bullet, \epsilon)$
which is the constant simplicial object on $M$.
\end{proof}

\begin{lemma}
\label{lemma-identify-H0}
If $A \to B$ is a ring map, then $H^0(L_{B/A}) = \Omega_{B/A}$.
\end{lemma}

\begin{proof}
We will prove this by a direct calculation.
We will use the identification of Lemma \ref{lemma-compute-cotangent-complex}.
There is clearly a map from $\Omega_{\mathcal{O}/A} \otimes \underline{B}$
to the constant sheaf with value $\Omega_{B/A}$. Thus this map induces
a map
$$
H^0(L_{B/A}) = H^0(L\pi_!(\Omega_{\mathcal{O}/A} \otimes \underline{B}))
= \pi_!(\Omega_{\mathcal{O}/A} \otimes \underline{B}) \to \Omega_{B/A}
$$
By choosing an object $P \to B$ of $\mathcal{C}_{B/A}$ with $P \to B$
surjective we see that this map is surjective (by
Algebra, Lemma \ref{algebra-lemma-differential-surjective}).
To show that it is injective, suppose that $P \to B$ is an object
of $\mathcal{C}_{B/A}$ and that $\xi \in \Omega_{P/A} \otimes_P B$
is an element which maps to zero in $\Omega_{B/A}$.
We first choose factorization $P \to P' \to B$ such that $P' \to B$
is surjective and $P'$ is a polynomial algebra over $A$.
We may replace $P$ by $P'$. If $B = P/I$, then the kernel
$\Omega_{P/A} \otimes_P B \to \Omega_{B/A}$ is the image of
$I/I^2$ (Algebra, Lemma \ref{algebra-lemma-differential-seq}).
Say $\xi$ is the image of $f \in I$.
Then we consider the two maps $a, b : P' = P[x] \to P$, the first of which
maps $x$ to $0$ and the second of which maps $x$ to $f$ (in both
cases $P[x] \to B$ maps $x$ to zero). We see that $\xi$ and $0$
are the image of $\text{d}x \otimes 1$ in $\Omega_{P'/A} \otimes_{P'} B$.
Thus $\xi$ and $0$ have the same image in the colimit (see
Example \ref{example-category-to-point})
$\pi_!(\Omega_{\mathcal{O}/A} \otimes \underline{B})$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-pi-lower-shriek-polynomial-algebra}
If $B$ is a polynomial algebra over the ring $A$, then
with $\pi$ as in (\ref{equation-pi}) we have that
$\pi_!$ is exact and $\pi_!\mathcal{F} = \mathcal{F}(B \to B)$.
\end{lemma}

\begin{proof}
This follows from Lemma \ref{lemma-identify-pi-shriek} which tells us
the constant simplicial algebra on $B$ can be used to compute $L\pi_!$.
\end{proof}

\begin{lemma}
\label{lemma-cotangent-complex-polynomial-algebra}
If $B$ is a polynomial algebra over the ring $A$, then
$L_{B/A}$ is quasi-isomorphic to $\Omega_{B/A}[0]$.
\end{lemma}

\begin{proof}
Immediate from
Lemma \ref{lemma-compute-cotangent-complex} and
\ref{lemma-pi-lower-shriek-polynomial-algebra}.
\end{proof}





\section{Constructing a resolution}
\label{section-polynomial}

\noindent
In the Noetherian finite type case we can construct a ``small'' simplicial
resolution for finite type ring maps.

\begin{lemma}
\label{lemma-polynomial}
Let $A$ be a Noetherian ring. Let $A \to B$ be a finite type ring map.
Let $\mathcal{A}$ be the category of $A$-algebra maps $C \to B$. Let
$n \geq 0$ and let $P_\bullet$ be a simplical object of $\mathcal{A}$
such that
\begin{enumerate}
\item $P_\bullet \to B$ is a trivial Kan fibration of simplicial sets,
\item $P_k$ is finite type over $A$ for $k \leq n$,
\item $P_\bullet = \text{cosk}_n \text{sk}_n P_\bullet$ as simplicial
objects of $\mathcal{A}$.
\end{enumerate}
Then $P_{n + 1}$ is a finite type $A$-algebra.
\end{lemma}

\begin{proof}
Although the proof we give of this lemma is straightforward, it is a bit
messy. To clarify the idea we explain what happens for low $n$ before giving
the proof in general. For example, if $n = 0$, then (3) means that
$P_1 = P_0 \times_B P_0$. Since the ring map $P_0 \to B$ is surjective, this
is of finite type over $A$ by
More on Algebra, Lemma \ref{more-algebra-lemma-fibre-product-finite-type}.

\medskip\noindent
If $n = 1$, then (3) means that
$$
P_2 = \{(f_0, f_1, f_2) \in P_1^3 \mid
d_0f_0 = d_0f_1,\ d_1f_0 = d_0f_2,\ d_1f_1 = d_1f_2 \}
$$
where the equalities take place in $P_0$. Observe that the triple
$$
(d_0f_0, d_1f_0, d_1f_1) = (d_0f_1, d_0f_2, d_1f_2)
$$
is an element of the fibre product $P_0 \times_B P_0 \times_B P_0$ over $B$
because the maps $d_i : P_1 \to P_0$ are morphisms over $B$. Thus we get
a map
$$
\psi : P_2 \longrightarrow P_0 \times_B P_0 \times_B P_0
$$
The fibre of $\psi$ over an element
$(g_0, g_1, g_2) \in P_0 \times_B P_0 \times_B P_0$
is the set of triples $(f_0, f_1, f_2)$ of $1$-simplices
with $(d_0, d_1)(f_0) = (g_0, g_1)$, $(d_0, d_1)(f_1) = (g_0, g_2)$,
and $(d_0, d_1)(f_2) = (g_1, g_2)$. As $P_\bullet \to B$ is a trivial
Kan fibration the map $(d_0, d_1) : P_1 \to P_0 \times_B P_0$ is
surjective. Thus we see that $P_2$ fits into the cartesian diagram
$$
\xymatrix{
P_2 \ar[d] \ar[r] & P_1^3 \ar[d] \\
P_0 \times_B P_0 \times_B P_0 \ar[r] & (P_0 \times_B P_0)^3
}
$$
By More on Algebra, Lemma \ref{more-algebra-lemma-formal-consequence}
we conclude. The general case is similar, but requires a bit more notation.

\medskip\noindent
The case $n > 1$. By Simplicial, Lemma \ref{simplicial-lemma-cosk-above-object}
the condition $P_\bullet = \text{cosk}_n \text{sk}_n P_\bullet$
implies the same thing is true in the category of simplicial
$A$-algebras and hence in the category of sets (as the forgetful
functor from $A$-algebras to sets commutes with limits). Thus
$$
P_{n + 1} =
\Mor(\Delta[n + 1], P_\bullet) =
\Mor(\text{sk}_n \Delta[n + 1], \text{sk}_n P_\bullet)
$$
by Simplicial, Lemma \ref{simplicial-lemma-simplex-map} and
Equation (\ref{simplicial-equation-cosk}). We will prove by induction
on $1 \leq k < m \leq n + 1$ that the ring
$$
Q_{k, m} = \Mor(\text{sk}_k \Delta[m], \text{sk}_k P_\bullet)
$$
is of finite type over $A$. The case $k = 1$, $1 < m \leq n + 1$
is entirely similar to the discussion above in the case $n = 1$.
Namely, there is a cartesian diagram
$$
\xymatrix{
Q_{1, m} \ar[d] \ar[r] & P_1^N \ar[d] \\
P_0 \times_B \ldots \times_B P_0 \ar[r] & (P_0 \times_B P_0)^N
}
$$
where $N = {m + 1 \choose 2}$. We conclude as before.

\medskip\noindent
Let $1 \leq k_0 \leq n$ and assume $Q_{k, m}$ is of finite type
over $A$ for all $1 \leq k \leq k_0$ and $k < m \leq n + 1$.
For $k_0 + 1 < m \leq n + 1$ we claim there is a cartesian square
$$
\xymatrix{
Q_{k_0 + 1, m} \ar[d] \ar[r] & P_{k_0 + 1}^N \ar[d] \\
Q_{k_0, m} \ar[r] & Q_{k_0, k_0 + 1}^N
}
$$
where $N$ is the number of nondegerate $(k_0 + 1)$-simplices
of $\Delta[m]$. Namely, to see this is true, think of an element of
$Q_{k_0 + 1, m}$ as a function $f$ from the $(k_0 + 1)$-skeleton
of $\Delta[m]$ to $P_\bullet$. We can restrict $f$ to the $k_0$-skeleton
which gives the left vertical map of the diagram. We can also restrict
to each nondegenerate $(k_0 + 1)$-simplex which gives the top horizontal
arrow. Moreover, to give such an $f$ is the same thing as giving its
restriction to $k_0$-skeleton and to each nondegenerate
$(k_0 + 1)$-face, provided these agree on the overlap, and this
is exactly the content of the diagram. Moreover, the fact that
$P_\bullet \to B$ is a trivial Kan fibration implies that
the map
$$
P_{k_0} \to Q_{k_0, k_0 + 1} = \Mor(\partial \Delta[k_0 + 1], P_\bullet)
$$
is surjective as every map $\partial \Delta[k_0 + 1] \to B$ can be extended
to $\Delta[k_0 + 1] \to B$ for $k_0 \geq 1$ (small argument about constant
simplicial sets omitted). Since by induction hypothesis the rings
$Q_{k_0, m}$, $Q_{k_0, k_0 + 1}$ are finite type $A$-algebras, so is
$Q_{k_0 + 1, m}$ by
More on Algebra, Lemma \ref{more-algebra-lemma-formal-consequence}
once more.
\end{proof}

\begin{proposition}
\label{proposition-polynomial}
Let $A$ be a Noetherian ring. Let $A \to B$ be a finite type ring map.
There exists a simplicial $A$-algebra $P_\bullet$ with an augmentation
$\epsilon : P_\bullet \to B$ such that each $P_n$ is a polynomial algebra
of finite type over $A$ and such that $\epsilon$ is a trivial
Kan fibration of simplicial sets.
\end{proposition}

\begin{proof}
Let $\mathcal{A}$ be the category of $A$-algebra maps $C \to B$.
In this proof our simplicial objects and skelet and coskelet
functors will be taken in this category.

\medskip\noindent
Choose a polynomial algebra $P_0$ of finite type over $A$ and a surjection
$P_0 \to B$. As a first approximation we take
$P_\bullet = \text{cosk}_0(P_0)$. In other words, $P_\bullet$ is the simplicial
$A$-algebra with terms $P_n = P_0 \times_A \ldots \times_A P_0$.
(In the final paragraph of the proof this simplicial object will
be denoted $P^0_\bullet$.) By
Simplicial, Lemma \ref{simplicial-lemma-cosk-minus-one-equivalence}
the map $P_\bullet \to B$ is a trivial Kan fibration of simplicial sets.
Also, observe that $P_\bullet = \text{cosk}_0 \text{sk}_0 P_\bullet$.

\medskip\noindent
Suppose for some $n \geq 0$ we have constructed $P_\bullet$
(in the final paragraph of the proof this will be $P^n_\bullet$)
such that
\begin{enumerate}
\item[(a)] $P_\bullet \to B$ is a trivial Kan fibration of simplicial sets,
\item[(b)] $P_k$ is a finitely generated polynomial algebra for
$0 \leq k \leq n$, and
\item[(c)] $P_\bullet = \text{cosk}_n \text{sk}_n P_\bullet$
\end{enumerate}
By Lemma \ref{lemma-polynomial}
we can find a finitely generated polynomial algebra $Q$ over $A$
and a surjection $Q \to P_{n + 1}$. Since $P_n$ is a polynomial algebra
the $A$-algebra maps $s_i : P_n \to P_{n + 1}$ lift to maps
$s'_i : P_n \to Q$. Set $d'_j : Q \to P_n$ equal to the composition of
$Q \to P_{n + 1}$ and $d_j : P_{n + 1} \to P_n$.
We obtain a truncated simplicial object $P'_\bullet$ of $\mathcal{A}$
by setting $P'_k = P_k$ for $k \leq n$ and $P'_{n + 1} = Q$ and morphisms
$d'_i = d_i$ and $s'_i = s_i$ in degrees $k \leq n - 1$ and using the
morphisms $d'_j$ and $s'_i$ in degree $n$. Extend this to a full simplicial
object $P'_\bullet$ of $\mathcal{A}$ using $\text{cosk}_{n + 1}$. By
functoriality of the coskelet functors there is a morphism
$P'_\bullet \to P_\bullet$ of simplical objects extending the
given morphism of $(n + 1)$-truncated simplicial objects.
(This morphism will be denoted $P^{n + 1}_\bullet \to P^n_\bullet$
in the final paragraph of the proof.)

\medskip\noindent
Note that conditions (b) and (c) are satisfied for $P'_\bullet$ with $n$
replaced by $n + 1$. We claim the map $P'_\bullet \to P_\bullet$ satisfies
assumptions (1), (2), (3), and (4) of
Simplicial, Lemmas \ref{simplicial-lemma-section}
with $n + 1$ instead of $n$. Conditions (1) and (2) hold by construction.
By Simplicial, Lemma \ref{simplicial-lemma-cosk-above-object}
we see that we have
$P_\bullet = \text{cosk}_{n + 1}\text{sk}_{n + 1}P_\bullet$
and
$P'_\bullet = \text{cosk}_{n + 1}\text{sk}_{n + 1}P'_\bullet$
not only in $\mathcal{A}$ but also in the category of $A$-algebras,
whence in the category of sets (as the forgetful functor from $A$-algebras
to sets commutes with all limits). This proves (3) and (4). Thus the lemma
applies and $P'_\bullet \to P_\bullet$ is a trivial Kan fibration. By
Simplicial, Lemma \ref{simplicial-lemma-trivial-kan-composition}
we conclude that $P'_\bullet \to B$ is a trivial Kan fibration and (a)
holds as well.

\medskip\noindent
To finish the proof we take the inverse limit $P_\bullet = \lim P^n_\bullet$
of the sequence of simplicial algebras
$$
\ldots \to P^2_\bullet \to P^1_\bullet \to P^0_\bullet
$$
constructed above. The map $P_\bullet \to B$ is a trivial Kan fibration by
Simplicial, Lemma \ref{simplicial-lemma-limit-trivial-kan}.
However, the construction above stabilizes in each degree
to a fixed finitely generated polynomial algebra as desired.
\end{proof}

\begin{lemma}
\label{lemma-pi-shriek-finite}
Let $A$ be a Noetherian ring. Let $A \to B$ be a finite type ring map.
Let $\pi$, $\underline{B}$ be as in (\ref{equation-pi}).
If $\mathcal{F}$ is an $\underline{B}$-module such that
$\mathcal{F}(P, \alpha)$ is a finite $B$-module for all
$\alpha : P = A[x_1, \ldots, x_n] \to B$, then the cohomology modules
of $L\pi_!(\mathcal{F})$ are finite $B$-modules.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-identify-pi-shriek} and
Proposition \ref{proposition-polynomial}
we can compute $L\pi_!(\mathcal{F})$ by a complex
constructed out of the values of $\mathcal{F}$ on finite type
polynomial algebras.
\end{proof}

\begin{lemma}
\label{lemma-cotangent-finite}
Let $A$ be a Noetherian ring. Let $A \to B$ be a finite type ring map.
Then $H^n(L_{B/A})$ is a finite $B$-module for all $n \in \mathbf{Z}$.
\end{lemma}

\begin{proof}
Apply Lemmas \ref{lemma-compute-cotangent-complex} and
\ref{lemma-pi-shriek-finite}.
\end{proof}

\begin{remark}
\label{remark-resolution}
Let $A \to B$ be any ring map. The proof of
Proposition \ref{proposition-polynomial}
shows that there exists a simplicial $A$-algebra $P_\bullet$
with an augmentation $\epsilon : P_\bullet \to B$ such that each $P_n$
is a polynomial algebra (on some set) over $A$ such that $\epsilon$
is a trivial Kan fibration of simplicial sets.
Let us call such a pair $(P_\bullet, \epsilon)$ a
{\it resolution} of $B$ over $A$. Of course, we have seen in
the proof of Lemma \ref{lemma-pi-shriek-standard}
that the standard resolution of $B$ over $A$ is a resolution
(so that this terminology doesn't lead to a conflict).
But we can prove the existence of resolutions without appealing
to the computations in
Simplicial, Section \ref{simplicial-section-standard}.
Moreover, for {\it any} choice of resolution we have a canonical
isomorphism
$L_{B/A} = \Omega_{P_\bullet/A} \otimes_{P_\bullet, \epsilon} B$
in $D(B)$ by
Lemmas \ref{lemma-identify-pi-shriek} and
\ref{lemma-compute-cotangent-complex}.
\end{remark}

\begin{lemma}
\label{lemma-O-homology-B-homology}
Let $A \to B$ be a ring map. Let $\pi$, $\mathcal{O}$, $\underline{B}$
be as in (\ref{equation-pi}). For any $\mathcal{O}$-module $\mathcal{F}$
we have
$$
L\pi_!(\mathcal{F}) = L\pi_!(Li^*\mathcal{F}) =
L\pi_!(\mathcal{F} \otimes_\mathcal{O}^\mathbf{L} \underline{B})
$$
in $D(\textit{Ab})$.
\end{lemma}

\begin{proof}
This follows from the more general
Lemma \ref{lemma-O-homology-B-homology-general}.
Namely, choose a resolution $P_\bullet$ (see
Remark \ref{remark-resolution}) of $B$ over $A$.
This gives a cosimplicial object $U_\bullet$ of $\mathcal{C}_{B/A}$
as in Lemma \ref{lemma-compute-by-cosimplicial-resolution}
(compare with proof of Lemma \ref{lemma-identify-pi-shriek}).
Moreover, $P_\bullet \to B$ induces a quasi-isomorphism on associated
complexes of abelian groups (for example by
Simplicial, Lemmas \ref{simplicial-lemma-trivial-kan-homotopy} and
\ref{simplicial-lemma-homotopy-equivalence})
hence $L\pi_!\mathcal{O} = B$. On the other hand $L\pi_!\underline{B}$
is computed by $\underline{B}(U_\bullet) = B$.
Thus all the assumptions of Lemma \ref{lemma-O-homology-B-homology-general}
are satisfied and we are done with the proof.
\end{proof}

\begin{lemma}
\label{lemma-apply-O-B-comparison}
Let $A \to B$ be a ring map. Let $\pi$, $\mathcal{O}$, $\underline{B}$
be as in (\ref{equation-pi}). We have
$$
L\pi_!(\mathcal{O}) = L\pi_!(\underline{B}) = B
\quad\text{and}\quad
L_{B/A} = L\pi_!(\Omega_{\mathcal{O}/A} \otimes_\mathcal{O} \underline{B}) =
L\pi_!(\Omega_{\mathcal{O}/A})
$$
in $D(\textit{Ab})$.
\end{lemma}

\begin{proof}
This is just an application of Lemma \ref{lemma-O-homology-B-homology}
(and the first equality on the right is
Lemma \ref{lemma-compute-cotangent-complex}).
\end{proof}

\noindent
Here is a special case of the fundamental triangle that is easy to prove.

\begin{lemma}
\label{lemma-special-case-triangle}
Let $A \to B \to C$ be ring maps. If $B$ is a polynomial algebra over
$A$, then there is a distinguished triangle 
$L_{B/A} \otimes_B^\mathbf{L} C \to L_{C/A} \to L_{C/B} \to
L_{B/A} \otimes_B^\mathbf{L} C[1]$ in $D(C)$.
\end{lemma}

\begin{proof}
We will use the observations of Remark \ref{remark-resolution}
without further mention. Choose a resolution $\epsilon : P_\bullet \to C$
of $C$ over $B$ (for example the standard resolution). Since $B$ is a
polynomial algebra over $A$ we see that $P_\bullet$ is also a resolution of
$C$ over $A$. Hence $L_{C/A}$ is computed by
$\Omega_{P_\bullet/A} \otimes_{P_\bullet, \epsilon} C$
and $L_{C/B}$ is computed by
$\Omega_{P_\bullet/B} \otimes_{P_\bullet, \epsilon} C$.
Since for each $n$ we have the short exact sequence
$0 \to \Omega_{B/A} \otimes_B P_n \to \Omega_{P_n/A} \to \Omega_{P_n/B}$
(Algebra, Lemma \ref{algebra-lemma-ses-formally-smooth})
and since $L_{B/A} = \Omega_{B/A}[0]$
(Lemma \ref{lemma-cotangent-complex-polynomial-algebra})
we obtain the result.
\end{proof}






\section{Functoriality}
\label{section-functoriality}

\noindent
In this section we consider a commutative square
\begin{equation}
\label{equation-commutative-square}
\vcenter{
\xymatrix{
B \ar[r] & B' \\
A \ar[u] \ar[r] & A' \ar[u]
}
}
\end{equation}
of ring maps. We claim there is a canonical $B$-linear map of complexes
$$
L_{B/A} \longrightarrow L_{B'/A'}
$$
associated to this diagram. Namely, if $P_\bullet \to B$ is the
standard resolution of $B$ over $A$ and $P'_\bullet \to B'$ is the
standard resoluton of $B'$ over $A'$, then there is a canonical map
$P_\bullet \to P'_\bullet$
of simplicial $A$-algebras compatible with the augmentations
$P_\bullet \to B$ and $P'_\bullet \to B'$. This can be seen in terms
of the construction of standard resolutions in
Simplicial, Section \ref{simplicial-section-standard}
but in the special case at hand it probably suffices to say simply
that the maps
$$
P_0 = A[B] \longrightarrow A'[B'] = P'_0,\quad
P_1 = A[A[B]] \longrightarrow A'[A'[B']] = P'_1,
$$
and so on are given by the given maps $A \to A'$ and $B \to B'$.
The desired map $L_{B/A} \to L_{B'/A'}$ then comes from the associated
maps $\Omega_{P_n/A} \to \Omega_{P'_n/A'}$.

\medskip\noindent
Another description of the functoriality map can be given as follows.
Let $\mathcal{C} = \mathcal{C}_{B/A}$ and $\mathcal{C}' = \mathcal{C}_{B'/A}'$
be the categories considered in Section \ref{section-compute-L-pi-shriek}.
There is a functor
$$
u : \mathcal{C} \longrightarrow \mathcal{C}',\quad
(P, \alpha) \longmapsto (P \otimes_A A', c \circ (\alpha \otimes 1))
$$
where $c : B \otimes_A A' \to B'$ is the obvious map. As discussed in
Example \ref{example-morphism-categories} we obtain a morphism of topoi
$g : \Sh(\mathcal{C}) \to \Sh(\mathcal{C}')$ and a commutative
diagram of maps of ringed topoi
\begin{equation}
\label{equation-double-square}
\vcenter{
\xymatrix{
(\Sh(\mathcal{C}), \underline{B}) \ar[d]_\pi &
(\Sh(\mathcal{C}'), \underline{B'}) \ar[d]_\pi \ar[l]^h \ar[r]_g &
(\Sh(\mathcal{C}), \underline{B'}) \ar[d]_{\pi'} \\
(\Sh(*), B) &
(\Sh(*), B') \ar[l]_f \ar[r] &
(\Sh(*), B')
}
}
\end{equation}
Here $h$ is the identity on underlying topoi and given by the ring map
$B \to B'$ on sheaves of rings. 
By Remark \ref{remark-morphism-fibred-categories}
given $\mathcal{F}$ on $\mathcal{C}$ and $\mathcal{F}'$ on $\mathcal{C}'$
and a transformation $t : \mathcal{F} \to g^{-1}\mathcal{F}'$
we obtain a canonical map $L\pi_!(\mathcal{F}) \to L\pi'_!(\mathcal{F}')$.
If we apply this to the sheaves
$$
\mathcal{F} : (P, \alpha) \mapsto \Omega_{P/A} \otimes_P B,\quad
\mathcal{F}' : (P', \alpha') \mapsto \Omega_{P'/A'} \otimes_{P'} B',
$$
and the transformation $t$ given by the canonical maps
$$
\Omega_{P/A} \otimes_P B \longrightarrow
\Omega_{P \otimes_A A'/A'} \otimes_{P \otimes_A A'} B'
$$
to get a canonical map
$$
L\pi_!(\Omega_{\mathcal{O}/A} \otimes_\mathcal{O} \underline{B})
\longrightarrow
L\pi'_!(\Omega_{\mathcal{O}'/A'} \otimes_{\mathcal{O}'} \underline{B'})
$$
By Lemma \ref{lemma-compute-cotangent-complex} this gives
$L_{B/A} \to L_{B'/A'}$. We omit the verification that this map
agrees with the map defined above in terms of simplicial
resolutions.

\begin{lemma}
\label{lemma-flat-base-change}
Assume (\ref{equation-commutative-square}) induces a quasi-isomorphism
$B \otimes_A^\mathbf{L} A' = B'$. Then, with notation as in
(\ref{equation-double-square}) and
$\mathcal{F}' \in \textit{Ab}(\mathcal{C}')$,
we have $L\pi_!(g^{-1}\mathcal{F}') = L\pi'_!(\mathcal{F}')$.
\end{lemma}

\begin{proof}
We will apply Lemma \ref{lemma-get-it-now}. Let $P_\bullet \to B$ be a
resolution, see Remark \ref{remark-resolution}. If we can show that
$u(P_\bullet) = P_\bullet \otimes_A A' \to B'$ is a quasi-isomorphism, then
we will be done by
Simplicial, Lemma \ref{simplicial-lemma-qis-simplicial-abelian-groups}
and Lemma \ref{lemma-identify-pi-shriek}.

\medskip\noindent
The complex of $A$-modules $s(P_\bullet)$ associated to $P_\bullet$
(viewed as a simplicial $A$-module) is a free $A$-module resolution of $B$.
Namely, $P_n$ is a free $A$-module and $s(P_\bullet) \to B$ is a
quasi-isomorphism (for example by
Simplicial, Lemmas \ref{simplicial-lemma-trivial-kan-homotopy} and
\ref{simplicial-lemma-homotopy-equivalence}).
Thus $B \otimes_A^\mathbf{L} A'$ is computed by
$s(P_\bullet) \otimes_A A' = s(P_\bullet \otimes_A A')$.
Therefore the assumption of the lemma signifies that
$\epsilon' : P_\bullet \otimes_A A' \to B'$ is a quasi-isomorphism.
\end{proof}

\noindent
The following lemma in particular applies when $A \to A'$ is flat
and $B' = B \otimes_A A'$ (flat base change).

\begin{lemma}
\label{lemma-flat-base-change-cotangent-complex}
If (\ref{equation-commutative-square}) induces a quasi-isomorphism
$B \otimes_A^\mathbf{L} A' = B'$, then the functoriality map
induces an isomorphism
$$
L_{B/A} \otimes_B^\mathbf{L} B' \longrightarrow L_{B'/A'}
$$
\end{lemma}

\begin{proof}
We will use the notation introduced in Equation (\ref{equation-double-square}).
We have
$$
L_{B/A} \otimes_B^\mathbf{L} B' =
L\pi_!(\Omega_{\mathcal{O}/A} \otimes_\mathcal{O} \underline{B})
\otimes_B^\mathbf{L} B' =
L\pi_!(Lh^*(\Omega_{\mathcal{O}/A} \otimes_\mathcal{O} \underline{B}))
$$
the first equality by Lemma \ref{lemma-compute-cotangent-complex}
and the second by Lemma \ref{lemma-change-of-rings}.
Since $\Omega_{\mathcal{O}/A}$ is a flat $\mathcal{O}$-module,
we see that $\Omega_{\mathcal{O}/A} \otimes_\mathcal{O} \underline{B}$
is a flat $\underline{B}$-module. Thus
$Lh^*(\Omega_{\mathcal{O}/A} \otimes_\mathcal{O} \underline{B}) =
\Omega_{\mathcal{O}/A} \otimes_\mathcal{O} \underline{B'}$
which is equal to
$g^{-1}(\Omega_{\mathcal{O}'/A'} \otimes_{\mathcal{O}'} \underline{B'})$
by inspection.
we conclude by Lemma \ref{lemma-flat-base-change}
and the fact that $L_{B'/A'}$ is computed by
$L\pi'_!(\Omega_{\mathcal{O}'/A'} \otimes_{\mathcal{O}'} \underline{B'})$.
\end{proof}

\begin{remark}
\label{remark-homotopy-triangle}
Suppose that we are given a square (\ref{equation-commutative-square})
such that there exists an arrow $\kappa : B \to A'$ making the diagram
commute:
$$
\xymatrix{
B \ar[r]_\beta \ar[rd]_\kappa & B' \\
A \ar[u] \ar[r]^\alpha & A' \ar[u]
}
$$
In this case we claim the functoriality map $P_\bullet \to P'_\bullet$
is homotopic to the composition $P_\bullet \to B \to A' \to P'_\bullet$.
Namely, using $\kappa$ the functoriality map factors as
$$
P_\bullet \to P_{A'/A', \bullet} \to P'_\bullet
$$
where $P_{A'/A', \bullet}$ is the standard resolution of $A'$ over $A'$.
Since $A'$ is the polynomial algebra on the empty set over $A'$ we
see from Simplicial, Lemma \ref{simplicial-lemma-standard-simplicial-homotopy}
that the augmentation $\epsilon_{A'/A'} : P_{A'/A', \bullet} \to A'$
is a homotopy equivalence of simplicial rings. Observe that the homotopy
inverse map $c : A' \to P_{A'/A', \bullet}$ constructed in the proof of
that lemma is just the structure morphism, hence
we conclude what we want because the two compositions
$$
\xymatrix{
P_\bullet \ar[r] &
P_{A'/A', \bullet} \ar@<1ex>[rr]^{\text{id}}
\ar@<-1ex>[rr]_{c \circ \epsilon_{A'/A'}} & &
P_{A'/A', \bullet} \ar[r] &
P'_\bullet
}
$$
are the two maps discussed above and these are homotopic
(Simplicial, Remark \ref{simplicial-remark-homotopy-pre-post-compose}).
Since the second map $P_\bullet \to P'_\bullet$ induces the zero
map $\Omega_{P_\bullet/A} \to \Omega_{P'_\bullet/A'}$ we conclude
that the functoriality map $L_{B/A} \to L_{B'/A'}$ is homotopic
to zero in this case.
\end{remark}

\begin{lemma}
\label{lemma-cotangent-complex-product}
Let $A \to B$ and $A \to C$ be ring maps.
Then the map $L_{B \times C/A} \to L_{B/A} \oplus L_{C/A}$ is
an isomorphism in $D(B \times C)$.
\end{lemma}

\begin{proof}
Although this lemma can be deduced from the fundamental triangle
we will give a direct and elementary proof of this now.
Factor the ring map $A \to B \times C$ as $A \to A[x] \to B \times C$
where $x \mapsto (1, 0)$. By Lemma \ref{lemma-special-case-triangle}
we have a distinguished triangle
$$
L_{A[x]/A} \otimes_{A[x]}^\mathbf{L} (B \times C) \to L_{B \times C/A} \to
L_{B \times C/A[x]} \to L_{A[x]/A} \otimes_{A[x]}^\mathbf{L} (B \times C)[1]
$$
in $D(B \times C)$. Similarly we have the distinguished triangles
$$
\begin{matrix}
L_{A[x]/A} \otimes_{A[x]}^\mathbf{L} B \to L_{B/A} \to L_{B/A[x]}
\to L_{A[x]/A} \otimes_{A[x]}^\mathbf{L} B[1] \\
L_{A[x]/A} \otimes_{A[x]}^\mathbf{L} C \to L_{C/A} \to L_{C/A[x]}
\to L_{A[x]/A} \otimes_{A[x]}^\mathbf{L} C[1]
\end{matrix}
$$
Thus it suffices to prove the result for $B \times C$ over $A[x]$.
Note that $A[x] \to A[x, x^{-1}]$ is flat, that
$(B \times C) \otimes_{A[x]} A[x, x^{-1}] = B \otimes_{A[x]} A[x, x^{-1}]$,
and that $C \otimes_{A[x]} A[x, x^{-1}] = 0$.
Thus by base change (Lemma \ref{lemma-flat-base-change-cotangent-complex})
the map $L_{B \times C/A[x]} \to L_{B/A[x]} \oplus L_{C/A[x]}$
becomes an isomorphism after inverting $x$.
In the same way one shows that the map becomes an isomorphism after
inverting $x - 1$. This proves the lemma.
\end{proof}




\section{The fundamental triangle}
\label{section-triangle}

\noindent
In this section we consider a sequence of ring maps $A \to B \to C$.
It is our goal to show that this triangle gives rise to a distinguished
triangle
\begin{equation}
\label{equation-triangle}
L_{B/A} \otimes_B^\mathbf{L} C \to L_{C/A} \to L_{C/B} \to
L_{B/A} \otimes_B^\mathbf{L} C[1]
\end{equation}
in $D(C)$. This will be proved in Proposition \ref{proposition-triangle}.
For an alternative approach see Remark \ref{remark-triangle}.

\medskip\noindent
Consider the category $\mathcal{C}_{C/B/A}$
wich is the {\bf opposite} of the category whose objects are
$(P \to B, Q \to C)$ where
\begin{enumerate}
\item $P$ is a polynomial algebra over $A$,
\item $P \to B$ is an $A$-algebra homomorphism,
\item $Q$ is a polynomial algebra over $P$, and
\item $Q \to C$ is a $P$-algebra-homomorphism.
\end{enumerate}
We take the opposite as we want to think of $(P \to B, Q \to C)$
as corresponding to the commutative diagram
$$
\xymatrix{
\Spec(C) \ar[d] \ar[r] & \Spec(Q) \ar[d] \\
\Spec(B) \ar[d] \ar[r] & \Spec(P) \ar[dl] \\
\Spec(A)
}
$$
Let $\mathcal{C}_{B/A}$, $\mathcal{C}_{C/A}$, $\mathcal{C}_{C/B}$
be the categories considered in Section \ref{section-compute-L-pi-shriek}.
There are functors
$$
\begin{matrix}
u_1 : \mathcal{C}_{C/B/A} \to \mathcal{C}_{B/A}, &
(P \to B, Q \to C) \mapsto (P \to B) \\
u_2 : \mathcal{C}_{C/B/A} \to \mathcal{C}_{C/A}, &
(P \to B, Q \to C) \mapsto (Q \to C) \\
u_3 : \mathcal{C}_{C/B/A} \to \mathcal{C}_{C/B}, &
(P \to B, Q \to C) \mapsto (Q \otimes_P B \to C)
\end{matrix}
$$
These functors induce corresponding morphisms of topoi $g_i$.
Let us denote $\mathcal{O}_i = g_i^{-1}\mathcal{O}$ so that we
get morphisms of ringed topoi
\begin{equation}
\label{equation-three-maps}
\begin{matrix}
g_1 : (\Sh(\mathcal{C}_{C/B/A}), \mathcal{O}_1)
\longrightarrow (\Sh(\mathcal{C}_{B/A}), \mathcal{O}) \\
g_2 : (\Sh(\mathcal{C}_{C/B/A}), \mathcal{O}_2)
\longrightarrow (\Sh(\mathcal{C}_{C/A}), \mathcal{O}) \\
g_3 : (\Sh(\mathcal{C}_{C/B/A}), \mathcal{O}_3)
\longrightarrow (\Sh(\mathcal{C}_{C/B}), \mathcal{O})
\end{matrix}
\end{equation}
Let us denote
$\pi : \Sh(\mathcal{C}_{C/B/A}) \to \Sh(*)$,
$\pi_1 : \Sh(\mathcal{C}_{B/A}) \to \Sh(*)$,
$\pi_2 : \Sh(\mathcal{C}_{C/A}) \to \Sh(*)$, and
$\pi_3 : \Sh(\mathcal{C}_{C/B}) \to \Sh(*)$,
so that $\pi = \pi_i \circ g_i$.
We will obtain our distinguished triangle from the identification
of the cotangent complex in Lemma \ref{lemma-compute-cotangent-complex}
and the following lemmas.

\begin{lemma}
\label{lemma-triangle-ses}
With notation as in (\ref{equation-three-maps}) set
$$
\begin{matrix}
\Omega_1 = \Omega_{\mathcal{O}/A} \otimes_\mathcal{O} \underline{B}
\text{ on }\mathcal{C}_{B/A} \\
\Omega_2 = \Omega_{\mathcal{O}/A} \otimes_\mathcal{O} \underline{C}
\text{ on }\mathcal{C}_{C/A} \\
\Omega_3 = \Omega_{\mathcal{O}/B} \otimes_\mathcal{O} \underline{C}
\text{ on }\mathcal{C}_{C/B}
\end{matrix}
$$
Then we have a canonical short exact sequence of sheaves
of $\underline{C}$-modules
$$
0 \to g_1^{-1}\Omega_1 \otimes_{\underline{B}} \underline{C} \to
g_2^{-1}\Omega_2 \to
g_3^{-1}\Omega_3 \to 0
$$
on $\mathcal{C}_{C/B/A}$.
\end{lemma}

\begin{proof}
Recall that $g_i^{-1}$ is gotten by simply precomposing with $u_i$.
Given an object $U = (P \to B, Q \to C)$ we have a split
short exact sequence
$$
0 \to \Omega_{P/A} \otimes Q \to \Omega_{Q/A} \to \Omega_{Q/P} \to 0
$$
for example by Algebra, Lemma \ref{algebra-lemma-ses-formally-smooth}.
Tensoring with $C$ over $Q$ we obtain a short exact sequence
$$
0 \to \Omega_{P/A} \otimes C \to \Omega_{Q/A} \otimes C \to
\Omega_{Q/P} \otimes C \to 0
$$
We have $\Omega_{P/A} \otimes C = \Omega_{P/A} \otimes B \otimes C$
whence this is the value of
$g_1^{-1}\Omega_1 \otimes_{\underline{B}} \underline{C}$
on $U$. The module $\Omega_{Q/A} \otimes C$ is the value of
$g_2^{-1}\Omega_2$ on $U$.
We have $\Omega_{Q/P} \otimes C = \Omega_{Q \otimes_P B/B} \otimes C$
by Algebra, Lemma \ref{algebra-lemma-differentials-base-change}
hence this is the value of
$g_3^{-1}\Omega_3$ on $U$. Thus the short exact sequence of the
lemma comes from assigning to $U$ the last displayed short exact
sequence.
\end{proof}

\begin{lemma}
\label{lemma-polynomial-on-top}
With notation as in (\ref{equation-three-maps})
suppose that $C$ is a polynomial algebra over $B$. Then
$L\pi_!(g_3^{-1}\mathcal{F}) = L\pi_{3, !}\mathcal{F} = \pi_{3, !}\mathcal{F}$
for any abelian sheaf $\mathcal{F}$ on $\mathcal{C}_{C/B}$
\end{lemma}

\begin{proof}
Write $C = B[E]$ for some set $E$. Choose a resolution
$P_\bullet \to B$ of $B$ over $A$. For every $n$ consider
the object $U_n = (P_n \to B, P_n[E] \to C)$ of $\mathcal{C}_{C/B/A}$.
Then $U_\bullet$ is a cosimplicial object of $\mathcal{C}_{C/B/A}$.
Note that $u_3(U_\bullet)$ is the constant cosimplicial
object of $\mathcal{C}_{C/B}$ with value $(C \to C)$.
We will prove that the object $U_\bullet$ of $\mathcal{C}_{C/B/A}$
satisfies the hypotheses of
Lemma \ref{lemma-compute-by-cosimplicial-resolution}.
This implies the lemma as it shows that $L\pi_!(g_3^{-1}\mathcal{F})$
is computed by the constant simplicial abelian group
$\mathcal{F}(C \to C)$ which is the value of
$L\pi_{3, !}\mathcal{F} = \pi_{3, !}\mathcal{F}$ by
Lemma \ref{lemma-pi-lower-shriek-polynomial-algebra}.

\medskip\noindent
Let $U = (\beta : P \to B, \gamma : Q \to C)$ be an object of
$\mathcal{C}_{C/B/A}$. We may write $P = A[S]$ and $Q = A[S \amalg T]$
by the definition of our category $\mathcal{C}_{C/B/A}$. We have to show that
$$
\Mor_{\mathcal{C}_{C/B/A}}(U_\bullet, U)
$$
is homotopy equivalent to a singleton simplicial set $*$. Observe that this
simplicial set is the product
$$
\prod\nolimits_{s \in S} F_s \times \prod\nolimits_{t \in T} F'_t
$$
where $F_s$ is the corresponding simplicial set for
$U_s = (A[\{s\}] \to B, A[\{s\}] \to C)$
and $F'_t$ is the corresponding simplicial set for
$U_t = (A \to B, A[\{t\}] \to C)$. Namely, the object $U$
is the product $\prod U_s \times \prod U_t$ in $\mathcal{C}_{C/B/A}$.
It suffices each $F_s$ and $F'_t$ is homotopy equivalent to $*$, see
Simplicial, Lemma \ref{simplicial-lemma-products-homotopy}.
The case of $F_s$ follows as $P_\bullet \to B$ is a trivial Kan
fibration (as a resolution) and $F_s$ is the fibre of this map over
$\beta(s)$. (Use Simplicial, Lemmas
\ref{simplicial-lemma-trivial-kan-base-change} and
\ref{simplicial-lemma-trivial-kan-homotopy}).
The case of $F'_t$ is more interesting. Here we are saying that
the fibre of
$$
P_\bullet[E] \longrightarrow C = B[E]
$$
over $\gamma(t) \in C$ is homotopy equivalent to a point. In fact we
will show this map is a trivial Kan fibration. Namely,
$P_\bullet \to B$ is a trivial can fibration. For any ring $R$
we have
$$
R[E] =
\colim_{\Sigma \subset \text{Map}(E, \mathbf{Z}_{\geq 0})\text{ finite}}
\prod\nolimits_{I \in \Sigma} R
$$
(filtered colimit). Thus the displayed map of simplicial sets is a
filtered colimit of trivial Kan fibrations, whence a trivial Kan fibration
by Simplicial, Lemma \ref{simplicial-lemma-filtered-colimit-trivial-kan}.
\end{proof}

\begin{lemma}
\label{lemma-triangle-compute-lower-shriek}
With notation as in (\ref{equation-three-maps}) we have
$Lg_{i, !} \circ g_i^{-1} = \text{id}$ for $i = 1, 2, 3$
and hence also $L\pi_! \circ g_i^{-1} = L\pi_{i, !}$ for
$i = 1, 2, 3$.
\end{lemma}

\begin{proof}
Proof for $i = 1$. We claim the functor $\mathcal{C}_{C/B/A}$
is a fibred category over $\mathcal{C}_{B/A}$
Namely, suppose given $(P \to B, Q \to C)$
and a morphism $(P' \to B) \to (P \to B)$ of $\mathcal{C}_{B/A}$.
Recall that this means we have an $A$-algebra homomorphism
$P \to P'$ compatible with maps to $B$. Then we set $Q' = Q \otimes_P P'$
with induced map to $C$ and the morphism
$$
(P' \to B, Q' \to C) \longrightarrow (P \to B, Q \to C)
$$
in $\mathcal{C}_{C/B/A}$ (note reversal arrows again) is strongly cartesian
in $\mathcal{C}_{C/B/A}$ over $\mathcal{C}_{B/A}$. Moreover, observe
that the fibre category of $u_1$ over $P \to B$ is the category
$\mathcal{C}_{C/P}$. Let $\mathcal{F}$ be an abelian sheaf on
$\mathcal{C}_{B/A}$. Since we have a fibred category we may apply
Lemma \ref{lemma-compute-left-derived-pi-shriek}.
Thus $L_ng_{1, !}g_1^{-1}\mathcal{F}$ is the (pre)sheaf
which assigns to $U \in \Ob(\mathcal{C}_{B/A})$ the $n$th homology of
$g_1^{-1}\mathcal{F}$ restricted to the fibre category over $U$.
Since these restrictions are constant the desired result follows from
Lemma \ref{lemma-pi-lower-shriek-constant-sheaf}
via our identifications of fibre categories above.

\medskip\noindent
The case $i = 2$.
We claim $\mathcal{C}_{C/B/A}$ is a fibred category over $\mathcal{C}_{C/A}$
is a fibred category. Namely, suppose given $(P \to B, Q \to C)$
and a morphism $(Q' \to C) \to (Q \to C)$ of $\mathcal{C}_{C/A}$.
Recall that this means we have a $B$-algebra homomorphism
$Q \to Q'$ compatible with maps to $C$. Then
$$
(P \to B, Q' \to C) \longrightarrow (P \to B, Q \to C)
$$
is strongly cartesian in $\mathcal{C}_{C/B/A}$ over $\mathcal{C}_{C/A}$.
Note that the fibre category of $u_2$ over $Q \to C$ has an final
(beware reversal arrows) object, namely, $(A \to B, Q \to C)$. Let
$\mathcal{F}$ be an abelian sheaf on $\mathcal{C}_{C/A}$.
Since we have a fibred category we may apply
Lemma \ref{lemma-compute-left-derived-pi-shriek}.
Thus $L_ng_{2, !}g_2^{-1}\mathcal{F}$ is the (pre)sheaf
which assigns to $U \in \Ob(\mathcal{C}_{C/A})$ the $n$th homology of
$g_1^{-1}\mathcal{F}$ restricted to the fibre category over $U$.
Since these restrictions are constant the desired result follows from
Lemma \ref{lemma-initial-final}
because the fibre categories all have final objects.

\medskip\noindent
The case $i = 3$. In this case we will apply
Lemma \ref{lemma-compute-left-derived-g-shriek}
to $u = u_3 : \mathcal{C}_{C/B/A} \to \mathcal{C}_{C/B}$
and $\mathcal{F}' = g_3^{-1}\mathcal{F}$ for some abelian sheaf
$\mathcal{F}$ on $\mathcal{C}_{C/B}$.
Suppose $U = (\overline{Q} \to C)$ is an object of $\mathcal{C}_{C/B}$.
Then $\mathcal{I}_U = \mathcal{C}_{\overline{Q}/B/A}$ (again beware
of reversal of arrows). The sheaf $\mathcal{F}'_U$ is given by the
rule $(P \to B, Q \to \overline{Q}) \mapsto \mathcal{F}(Q \otimes_P B \to C)$.
In other words, this sheaf is the pullback of a sheaf
on $\mathcal{C}_{\overline{Q}/C}$ via the morphism
$\Sh(\mathcal{C}_{\overline{Q}/B/A}) \to \Sh(\mathcal{C}_{\overline{Q}/B})$.
Thus Lemma \ref{lemma-polynomial-on-top} shows that
$H_n(\mathcal{I}_U, \mathcal{F}'_U) = 0$ for $n > 0$
and equal to $\mathcal{F}(\overline{Q} \to C)$ for $n = 0$.
The aforementioned Lemma \ref{lemma-compute-left-derived-g-shriek}
implies that $Lg_{3, !}(g_3^{-1}\mathcal{F}) = \mathcal{F}$ and
the proof is done.
\end{proof}

\begin{proposition}
\label{proposition-triangle}
Let $A \to B \to C$ be ring maps. There is a canonical distinguished
triangle
$$
L_{B/A} \otimes_B^\mathbf{L} C \to L_{C/A} \to L_{C/B} \to
L_{B/A} \otimes_B^\mathbf{L} C[1]
$$
in $D(C)$.
\end{proposition}

\begin{proof}
Consider the short exact sequence of sheaves of
Lemma \ref{lemma-triangle-ses}
and apply the derived functor $L\pi_!$ to obtain a distinguished
triangle
$$
L\pi_!(g_1^{-1}\Omega_1 \otimes_{\underline{B}} \underline{C}) \to
L\pi_!(g_2^{-1}\Omega_2) \to
L\pi_!(g_3^{-1}\Omega_3) \to
L\pi_!(g_1^{-1}\Omega_1 \otimes_{\underline{B}} \underline{C})[1]
$$
in $D(C)$. Using Lemmas \ref{lemma-triangle-compute-lower-shriek} and
\ref{lemma-compute-cotangent-complex}
we see that the second and third terms agree with $L_{C/A}$ and $L_{C/B}$
and the first one equals
$$
L\pi_{1, !}(\Omega_1 \otimes_{\underline{B}} \underline{C}) =
L\pi_{1, !}(\Omega_1) \otimes_B^\mathbf{L} C =
L_{B/A} \otimes_B^\mathbf{L} C
$$
The first equality by Lemma \ref{lemma-change-of-rings}
(and flatness of $\Omega_1$ as a sheaf of modules over $\underline{B}$)
and the second by Lemma \ref{lemma-compute-cotangent-complex}.
\end{proof}

\begin{remark}
\label{remark-triangle}
We sketch an alternative, perhaps simpler, proof of the existence of
the fundamental triangle.
Let $A \to B \to C$ be ring maps and assume that $B \to C$ is injective.
Let $P_\bullet \to B$ be the standard resolution of $B$ over $A$ and
let $Q_\bullet \to C$ be the standard resolution of $C$ over $B$.
Picture
$$
\xymatrix{
P_\bullet: &
A[A[A[B]]] \ar[d]
\ar@<2ex>[r]
\ar@<0ex>[r]
\ar@<-2ex>[r]
&
A[A[B]] \ar[d]
\ar@<1ex>[r]
\ar@<-1ex>[r]
\ar@<1ex>[l]
\ar@<-1ex>[l]
&
A[B] \ar[d] \ar@<0ex>[l] \ar[r] &
B \\
Q_\bullet: &
A[A[A[C]]]
\ar@<2ex>[r]
\ar@<0ex>[r]
\ar@<-2ex>[r]
&
A[A[C]]
\ar@<1ex>[r]
\ar@<-1ex>[r]
\ar@<1ex>[l]
\ar@<-1ex>[l]
&
A[C] \ar@<0ex>[l] \ar[r] &
C
}
$$
Observe that since $B \to C$ is injective, the ring $Q_n$ is a
polynomial algebra over $P_n$ for all $n$. Hence we obtain a cosimplicial
object in $\mathcal{C}_{C/B/A}$ (beware reversal arrows).
Now set $\overline{Q}_\bullet = Q_\bullet \otimes_{P_\bullet} B$.
The key to the proof of Proposition \ref{proposition-triangle}
is to show that $\overline{Q}_\bullet$ is a resolution of $C$ over $B$.
This follows from Lemma \ref{lemma-O-homology-B-homology-general}
applied to $\mathcal{C} = \Delta$, $\mathcal{O} = P_\bullet$, and
$\mathcal{F} = Q_\bullet$ (this uses that $Q_n$ is flat over $P_n$;
see Remark \ref{remark-simplicial-modules} to relate simplicial modules
to sheaves). The key fact implies that the distinguished triangle of
Proposition \ref{proposition-triangle}
is the distinguished triangle associated to the short exact sequence
of simplicial $C$-modules
$$
0 \to
\Omega_{P_\bullet/A} \otimes_{P_\bullet} C \to
\Omega_{Q_\bullet/A} \otimes_{Q_\bullet} C \to
\Omega_{\overline{Q}_\bullet/B} \otimes_{\overline{Q}_\bullet} C \to 0
$$
which is deduced from the short exact sequences
$0 \to \Omega_{P_n/A} \otimes_{P_n} Q_n \to \Omega_{Q_n/A} \to
\Omega_{Q_n/P_n} \to 0$ of
Algebra, Lemma \ref{algebra-lemma-ses-formally-smooth}.
Namely, by Remark \ref{remark-resolution} and the key fact the complex on the
right hand side represents $L_{C/B}$ in $D(C)$.

\medskip\noindent
If $B \to C$ is not injective, then we can use the above to get a
fundamental triangle for $A \to B \to B \times C$. Since
$L_{B \times C/B} \to L_{B/B} \oplus L_{C/B}$ and
$L_{B \times C/A} \to L_{B/A} \oplus L_{C/A}$
are quasi-isomorphism in $D(B \times C)$
(Lemma \ref{lemma-cotangent-complex-product})
this induces the desired distinguished triangle in $D(C)$
by tensoring with the flat ring map $B \times C \to C$.
\end{remark}

\begin{remark}
\label{remark-explicit-map}
Let $A \to B \to C$ be ring maps with $B \to C$ injective.
Recall the notation $P_\bullet$, $Q_\bullet$, $\overline{Q}_\bullet$ of
Remark \ref{remark-triangle}.
Let $R_\bullet$ be the standard resolution of $C$ over $B$.
In this remark we explain how to get the canonical identification
of $\Omega_{\overline{Q}_\bullet/B} \otimes_{\overline{Q}_\bullet} C$
with $L_{C/B} = \Omega_{R_\bullet/B} \otimes_{R_\bullet} C$.
Let $S_\bullet \to B$ be the standard resolution of $B$ over $B$.
Note that the functoriality map $S_\bullet \to R_\bullet$ identifies
$R_n$ as a polynomial algebra over $S_n$ because $B \to C$ is injective.
For example in degree $0$ we have the map $B[B] \to B[C]$, in degree
$1$ the map $B[B[B]] \to B[B[C]]$, and so on. Thus
$\overline{R}_\bullet = R_\bullet \otimes_{S_\bullet} B$
is a simplicial polynomial algebra
over $B$ as well and it follows (as in Remark \ref{remark-triangle})
from Lemma \ref{lemma-O-homology-B-homology-general}
that $\overline{R}_\bullet \to C$ is a resolution. Since we have
a commutative diagram
$$
\xymatrix{
Q_\bullet \ar[r] & R_\bullet \\
P_\bullet \ar[u] \ar[r] & S_\bullet \ar[u] \ar[r] & B
}
$$
we obtain a canonical map
$\overline{Q}_\bullet = Q_\bullet \otimes_{P_\bullet} B \to
\overline{R}_\bullet$. Thus the maps
$$
L_{C/B} = \Omega_{R_\bullet/B} \otimes_{R_\bullet} C
\longrightarrow
\Omega_{\overline{R}_\bullet/B} \otimes_{\overline{R}_\bullet} C
\longleftarrow
\Omega_{\overline{Q}_\bullet/B} \otimes_{\overline{Q}_\bullet} C
$$
are quasi-isomorphsms (Remark \ref{remark-resolution}) and composing
one with the inverse of the other gives the desired identification.
\end{remark}





\section{Localization and \'etale ring maps}
\label{section-localization}

\noindent
In this section we study what happens if we localize our rings.
Let $A \to A' \to B$ be ring maps such that $B = B \otimes_A^\mathbf{L} A'$.
This happens for example if $A' = S^{-1}A$ is the localization of $A$
at a multiplicative subset $S \subset A$. In this
case for an abelian sheaf $\mathcal{F}'$ on $\mathcal{C}_{B/A'}$
the homology of $g^{-1}\mathcal{F}'$ over $\mathcal{C}_{B/A}$ agrees with
the homology of $\mathcal{F}'$ over $\mathcal{C}_{B/A'}$, see
Lemma \ref{lemma-flat-base-change} for a precise statement.

\begin{lemma}
\label{lemma-localize-at-bottom}
Let $A \to A' \to B$ be ring maps such that $B = B \otimes_A^\mathbf{L} A'$.
Then $L_{B/A} = L_{B/A'}$ in $D(B)$.
\end{lemma}

\begin{proof}
According to the discussion above (i.e., using
Lemma \ref{lemma-flat-base-change})
and Lemma \ref{lemma-compute-cotangent-complex}
we have to show that the sheaf given
by the rule $(P \to B) \mapsto \Omega_{P/A} \otimes_P B$ on $\mathcal{C}_{B/A}$
is the pullback of the sheaf given by the rule
$(P \to B) \mapsto \Omega_{P/A'} \otimes_P B$.
The pullback functor $g^{-1}$ is given by precomposing with the
functor $u : \mathcal{C}_{B/A} \to \mathcal{C}_{B/A'}$,
$(P \to B) \mapsto (P \otimes_A A' \to B)$.
Thus we have to show that
$$
\Omega_{P/A} \otimes_P B =
\Omega_{P \otimes_A A'/A'} \otimes_{(P \otimes_A A')} B
$$
By Algebra, Lemma \ref{algebra-lemma-differentials-base-change}
the right hand side is equal to
$$
(\Omega_{P/A} \otimes_A A') \otimes_{(P \otimes_A A')} B
$$
Since $P$ is a polynomial algebra over $A$ the module
$\Omega_{P/A}$ is free and the equality is obvious.
\end{proof}

\begin{lemma}
\label{lemma-derived-diagonal}
Let $A \to B$ be a ring map such that $B = B \otimes_A^\mathbf{L} B$.
Then $L_{B/A} = 0$ in $D(B)$.
\end{lemma}

\begin{proof}
This is true because $L_{B/A} = L_{B/B} = 0$ by
Lemmas \ref{lemma-localize-at-bottom} and
\ref{lemma-cotangent-complex-polynomial-algebra}.
\end{proof}

\begin{lemma}
\label{lemma-bootstrap}
Let $A \to B$ be a ring map such that $\text{Tor}^A_i(B, B) = 0$ for $i > 0$
and such that $L_{B/B \otimes_A B} = 0$.
Then $L_{B/A} = 0$ in $D(B)$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-flat-base-change-cotangent-complex} we see that
$L_{B/A} \otimes_B^\mathbf{L} (B \otimes_A B) = L_{B \otimes_A B/B}$.
Now we use the distinguished triangle (\ref{equation-triangle})
$$
L_{B \otimes_A B/B} \otimes^\mathbf{L}_{(B \otimes_A B)} B \to
L_{B/B} \to L_{B/B \otimes_A B} \to
L_{B \otimes_A B/B} \otimes^\mathbf{L}_{(B \otimes_A B)} B[1]
$$
associated to the ring maps $B \to B \otimes_A B \to B$ and the vanishing of
$L_{B/B}$ (Lemma \ref{lemma-cotangent-complex-polynomial-algebra}) and
$L_{B/B \otimes_A B}$ (assumed) to see that
$$
0 =
L_{B \otimes_A B/B} \otimes^\mathbf{L}_{(B \otimes_A B)} B =
L_{B/A} \otimes_B^\mathbf{L} (B \otimes_A B)
\otimes^\mathbf{L}_{(B \otimes_A B)} B = L_{B/A}
$$
as desired.
\end{proof}

\begin{lemma}
\label{lemma-when-zero}
The cotangent complex $L_{B/A}$ is zero in each of the following cases:
\begin{enumerate}
\item $A \to B$ and $B \otimes_A B \to B$ are flat,
\item $A \to B$ is a flat epimorphism of rings,
\item $B = S^{-1}A$ for some multiplicative subset $S \subset A$,
\item $A \to B$ is unramified and flat,
\item $A \to B$ is \'etale, and
\item add more here.
\end{enumerate}
\end{lemma}

\begin{proof}
In case (1) we may apply
Lemma \ref{lemma-derived-diagonal}
to the surjective flat ring map $B \otimes_A B \to B$
to conclude that $L_{B \otimes_A B/B} = 0$ and then we use
Lemma \ref{lemma-bootstrap}
to conclude. The other cases are each special cases of (1).
\end{proof}

\begin{lemma}
\label{lemma-localize-on-top}
Let $A \to B \to C$ be ring maps such that $L_{C/B} = 0$.
Then $L_{C/A} = L_{B/A} \otimes_B^\mathbf{L} C$.
\end{lemma}

\begin{proof}
This is a trivial consequence of 
the distinguished triangle (\ref{equation-triangle}).
\end{proof}

\begin{lemma}
\label{lemma-localize}
Let $A \to B$ be ring maps and $S \subset A$, $T \subset B$ multiplicative
subsets such that $S$ maps into $T$.
Then $L_{T^{-1}B/S^{-1}A} = L_{B/A} \otimes_B T^{-1}B$
in $D(T^{-1}B)$.
\end{lemma}

\begin{proof}
Lemma \ref{lemma-localize-on-top} shows that
$L_{T^{-1}B/A} = L_{B/A} \otimes_B T^{-1}B$
and Lemma \ref{lemma-localize-at-bottom}
shows that $L_{T^{-1}B/A} = L_{T^{-1}B/S^{-1}A}$.
\end{proof}





\section{Smooth ring maps}
\label{section-smooth}

\noindent
Let $C \to B$ be a surjection of rings with kernel $I$. Let us call such
a ring map ``weakly quasi-regular'' if $I/I^2$ is a flat $B$-module and
$\text{Tor}_*^C(B, B)$ is the exterior algebra on $I/I^2$.
The generalization to ``smooth ring maps'' of what is done in
Lemma \ref{lemma-when-zero} for ``\'etale ring maps'' is to look
at flat ring maps $A \to B$ such that the multiplication map
$B \otimes_A B \to B$ is weakly quasi-regular. For the moment we just stick to
smooth ring maps.

\begin{lemma}
\label{lemma-when-projective}
If $A \to B$ is a smooth ring map, then $L_{B/A} = \Omega_{B/A}[0]$.
\end{lemma}

\begin{proof}
We have the agreement in cohomological degree $0$ by
Lemma \ref{lemma-identify-H0}.
Thus it suffices to prove the other cohomology groups
are zero. It suffices to prove this locally on $\Spec(B)$ as
$L_{B_g/A} = (L_{B/A})_g$ for $g \in B$ by Lemma \ref{lemma-localize-on-top}.
Thus we may assume that $A \to B$ is standard smooth
(Algebra, Lemma \ref{algebra-lemma-smooth-syntomic}), i.e.,
that we can factor $A \to B$ as
$A \to A[x_1, \ldots, x_n] \to B$ with $A[x_1, \ldots, x_n] \to B$
\'etale. In this case Lemmas \ref{lemma-when-zero} and
Lemma \ref{lemma-localize-on-top} show that
$L_{B/A} = L_{A[x_1, \ldots, x_n]/A} \otimes B$
whence the conclusion by
Lemma \ref{lemma-cotangent-complex-polynomial-algebra}.
\end{proof}





\section{Comparison with the naive cotangent complex}
\label{section-surjections}

\noindent
The naive cotangent complex was introduced in
Algebra, Section \ref{algebra-section-netherlander}.

\begin{remark}
\label{remark-make-map}
Let $A \to B$ be a ring map.  Working on $\mathcal{C}_{B/A}$ as in
Section \ref{section-compute-L-pi-shriek} let
$\mathcal{J} \subset \mathcal{O}$ be the kernel of
$\mathcal{O} \to \underline{B}$. Note that $L\pi_!(\mathcal{J}) = 0$ by
Lemma \ref{lemma-apply-O-B-comparison}. Set
$\Omega =  \Omega_{\mathcal{O}/A} \otimes_\mathcal{O} \underline{B}$
so that
$L_{B/A} = L\pi_!(\Omega)$ (Lemma \ref{lemma-compute-cotangent-complex}).
Thus complex $\mathcal{J} \to \Omega$
has $L\pi_!(\mathcal{J} \to \Omega)$ equal to $L_{B/A}$.
Thus, for any object $U = (P \to B)$ of $\mathcal{C}_{B/A}$ we obtain a map
\begin{equation}
\label{equation-comparison-map-A}
(J \to \Omega_{P/A} \otimes_P B) \longrightarrow L_{B/A}
\end{equation}
where $J = \text{Ker}(P \to B)$ in $D(A)$, see
Remark \ref{remark-map-evaluation-to-derived}.
Continuing in this manner, note that
$L\pi_!(\mathcal{J} \otimes_\mathcal{O}^\mathbf{L} \underline{B}) =
L\pi_!(\mathcal{O}) = 0$ by
Lemma \ref{lemma-O-homology-B-homology}.
Since $\text{Tor}_0^\mathcal{O}(\mathcal{J}, \underline{B}) =
\mathcal{J}/\mathcal{J}^2$
the spectral sequence
$$
H_p(\mathcal{C}_{B/A}, \text{Tor}_q^\mathcal{O}(\mathcal{J}, \underline{B}))
\Rightarrow 
H_{p + q}(\mathcal{C}_{B/A},
\mathcal{J} \otimes_\mathcal{O}^\mathbf{L} \underline{B}) = 0
$$
(dual of
Derived Categories, Lemma \ref{derived-lemma-two-ss-complex-functor})
implies that
$H_0(\mathcal{C}_{B/A}, \mathcal{J}/\mathcal{J}^2) = 0$
and $H_1(\mathcal{C}_{B/A}, \mathcal{J}/\mathcal{J}^2) = 0$.
It follows that the complex of $\underline{B}$-modules
$\mathcal{J}/\mathcal{J}^2 \to \Omega$ satisfies
$\tau_{\geq -1}L\pi_!(\mathcal{J}/\mathcal{J}^2 \to \Omega) =
\tau_{\geq -1}L_{B/A}$.
Thus, for any object $U = (P \to B)$ of $\mathcal{C}_{B/A}$ we obtain a map
\begin{equation}
\label{equation-comparison-map}
(J/J^2 \to \Omega_{P/A} \otimes_P B) \longrightarrow \tau_{\geq -1}L_{B/A}
\end{equation}
in $D(B)$, see Remark \ref{remark-map-evaluation-to-derived}.
\end{remark}

\noindent
The first case is where we have a surjection of rings.

\begin{lemma}
\label{lemma-surjection}
Let $A \to B$ be a surjective ring map with kernel $I$.
Then $H^0(L_{B/A}) = 0$ and $H^{-1}(L_{B/A}) = I/I^2$.
This isomorphism comes from the map (\ref{equation-comparison-map})
for the object $(A \to B)$ of $\mathcal{C}_{B/A}$.
\end{lemma}

\begin{proof}
We will show below (using the surjectivity of $A \to B$)
that there exists a short exact sequence
$$
0 \to \pi^{-1}(I/I^2) \to \mathcal{J}/\mathcal{J}^2 \to \Omega \to 0
$$
of sheaves on $\mathcal{C}_{B/A}$. Taking $L\pi_!$ and
the associated long exact sequence of homology, and using the
vanishing of $H_1(\mathcal{C}_{B/A}, \mathcal{J}/\mathcal{J}^2)$ and
$H_0(\mathcal{C}_{B/A}, \mathcal{J}/\mathcal{J}^2)$
(Remark \ref{remark-make-map}) we obtain what we want using
Lemma \ref{lemma-pi-lower-shriek-constant-sheaf}.

\medskip\noindent
What is left is to verify the local statement mentioned above.
For every object $U = (P \to B)$ of $\mathcal{C}_{B/A}$
we can choose an isomorphism $P = A[E]$ such that the map
$P \to B$ maps each $e \in E$ to zero. Then
$J = \mathcal{J}(U) \subset P = \mathcal{O}(U)$
is equal to $J = IP + (e; e \in E)$. The value on $U$ of the short sequence
of sheaves above is the sequence
$$
0 \to I/I^2 \to J/J^2 \to \Omega_{P/A} \otimes_P B \to 0
$$
Verification omitted (hint: the only tricky point is that
$IP \cap J^2 = IJ$; which follows for example from
More on Algebra, Lemma \ref{more-algebra-lemma-conormal-sequence-H1-regular}).
\end{proof}

\begin{lemma}
\label{lemma-relation-with-naive-cotangent-complex}
Let $A \to B$ be a ring map. Then $\tau_{\geq -1}L_{B/A}$
is canonically quasi-isomorphic to the naive cotangent complex.
\end{lemma}

\begin{proof}
Consider $P = A[B] \to B$ with kernel $I$. The naive cotangent
complex $NL_{B/A}$ of $B$ over $A$ is the complex
$I/I^2 \to \Omega_{P/A} \otimes_P B$,
see Algebra, Definition \ref{algebra-definition-naive-cotangent-complex}.
Observe that in (\ref{equation-comparison-map}) we have already
constructed a canonical map
$$
c : NL_{B/A} \longrightarrow \tau_{\geq -1}L_{B/A}
$$
Consider the distinguished triangle (\ref{equation-triangle})
$$
L_{P/A} \otimes_P^\mathbf{L} B \to L_{B/A} \to L_{B/P} \to 
(L_{P/A} \otimes_P^\mathbf{L} B)[1]
$$
associated to the ring maps $A \to A[B] \to B$. We know that
$L_{P/A} = \Omega_{P/A}[0] = NL_{P/A}$ in $D(P)$
(Lemma \ref{lemma-cotangent-complex-polynomial-algebra}
and
Algebra, Lemma \ref{algebra-lemma-NL-polynomial-algebra})
and that
$\tau_{\geq -1}L_{B/P} = I/I^2[1] = NL_{B/P}$ in $D(B)$
(Lemma \ref{lemma-surjection} and
Algebra, Lemma \ref{algebra-lemma-NL-surjection}).
To show $c$ is a quasi-isomorphism it suffices by
Algebra, Lemma \ref{algebra-lemma-exact-sequence-NL}
and the long exact cohomology sequence associated to the
distinguished triangle
to show that the maps $L_{P/A} \to L_{B/A} \to L_{B/P}$ are compatible
on cohomology groups with the corresponding maps
$NL_{P/A} \to NL_{B/A} \to NL_{B/P}$
of the naive cotangent complex. We omit the verification.
\end{proof}




\section{A spectral sequence of Quillen}
\label{section-spectral-sequence}

\noindent
In this section we discuss a spectral sequence relating derived
tensor product to the cotangent complex.

\begin{lemma}
\label{lemma-vanishing-symmetric-powers}
Notation and assumptions as in Example \ref{example-category-to-point}.
Assume $\mathcal{C}$ has a cosimplicial object as in
Lemma \ref{lemma-compute-by-cosimplicial-resolution}.
Let $\mathcal{F}$ be a flat $\underline{B}$-module such that
$H_0(\mathcal{C}, \mathcal{F}) = 0$.
Then $H_l(\mathcal{C}, \text{Sym}_{\underline{B}}^k(\mathcal{F})) = 0$
for $l < k$.
\end{lemma}

\begin{proof}
We drop the subscript ${}_{\underline{B}}$ from tensor products, wedge powers,
and symmetric powers. We will prove the lemma by induction on $k$.
The cases $k = 0, 1$ follow from the assumptions. If $k > 1$ consider
the exact complex
$$
\ldots \to
\wedge^2\mathcal{F} \otimes \text{Sym}^{k - 2}\mathcal{F} \to
\mathcal{F} \otimes \text{Sym}^{k - 1}\mathcal{F} \to
\text{Sym}^k\mathcal{F} \to 0
$$
with differentials as in the Koszul complex. If we think of this as a
resolution of $\text{Sym}^k\mathcal{F}$, then this gives a first quadrant
spectral sequence
$$
E_1^{p, q} =
H_p(\mathcal{C},
\wedge^{q + 1}\mathcal{F} \otimes \text{Sym}^{k - q - 1}\mathcal{F})
\Rightarrow
H_{p + q}(\mathcal{C}, \text{Sym}^k(\mathcal{F}))
$$
By Lemma \ref{lemma-eilenberg-zilber} we have
$$
L\pi_!(\wedge^{q + 1}\mathcal{F} \otimes \text{Sym}^{k - q - 1}\mathcal{F}) =
L\pi_!(\wedge^{q + 1}\mathcal{F}) \otimes_B^\mathbf{L}
L\pi_!(\text{Sym}^{k - q - 1}\mathcal{F}))
$$
It follows (from the construction of derived tensor products) that
the induction hypothesis combined with the vanishing
of $H_0(\mathcal{C}, \wedge^{q + 1}(\mathcal{F})) = 0$ will prove what we want.
This is true because $\wedge^{q + 1}(\mathcal{F})$ is a quotient
of $\mathcal{F}^{\otimes q + 1}$ and
$H_0(\mathcal{C}, \mathcal{F}^{\otimes q + 1})$
is a quotient of $H_0(\mathcal{C}, \mathcal{F})^{\otimes q + 1}$
which is zero.
\end{proof}

\begin{remark}
\label{remark-first-homology-symmetric-power}
In the situation of Lemma \ref{lemma-vanishing-symmetric-powers}
one can show that
$H_k(\mathcal{C}, \text{Sym}^k(\mathcal{F})) =
\wedge^k_B(H_1(\mathcal{C}, \mathcal{F}))$.
Namely, it can be deduced from the proof that
$H_k(\mathcal{C}, \text{Sym}^k(\mathcal{F}))$ is the $S_k$-coinvariants
of
$$
H^{-k}(L\pi_!(\mathcal{F}) \otimes_B^\mathbf{L}
L\pi_!(\mathcal{F}) \otimes_B^\mathbf{L}
\ldots \otimes_B^\mathbf{L} L\pi_!(\mathcal{F})) =
H_1(\mathcal{C}, \mathcal{F})^{\otimes k}
$$
Thus our claim is that this action is given by the usual action
of $S_k$ on the tensor product multiplied by the sign character.
To prove this one has to work through the sign conventions
in the definition of the total complex associated to a
multi-complex. We omit the verification.
\end{remark}

\begin{lemma}
\label{lemma-map-tors-zero}
Let $A$ be a ring. Let $P = A[E]$ be a polynomial ring.
Set $I = (e \in E) \subset P$. The maps
$\text{Tor}_i^P(A, I^{n + 1}) \to \text{Tor}_i^P(A, I^n)$
are zero for all $i$ and $n$.
\end{lemma}

\begin{proof}
Denote $x_e \in P$ the variable corresponding to $e \in E$.
A free resolution of $A$ over $P$ is given by the Koszul complex
$K_\bullet$ on the $x_e$. Here $K_i$ has basis given by wedges
$e_1 \wedge \ldots \wedge e_i$, $e_1, \ldots, e_i \in E$ and $d(e) = x_e$.
Thus $K_\bullet \otimes_P I^n = I^nK_\bullet$ computes
$\text{Tor}_i^P(A, I^n)$. Observe that everything is graded
with $\deg(x_e) = 1$, $\deg(e) = 1$, and $\deg(a) = 0$ for $a \in A$.
Suppose $\xi \in I^{n + 1}K_i$ is a cocycle homogeneous of degree $m$.
Note that $m \geq i + 1 + n$. Then $\xi = \text{d}\eta$ for some
$\eta \in K_{i + 1}$ as $K_\bullet$ is exact in degrees $ > 0$.
(The case $i = 0$ is left to the reader.)
Now $\deg(\eta) = m \geq i + 1 + n$. Hence writing $\eta$
in terms of the basis we see the coordinates are in $I^n$.
Thus $\xi$ maps to zero in the homology of $I^nK_\bullet$ as desired.
\end{proof}

\begin{theorem}[Quillen spectral sequence]
\label{theorem-quillen-spectral-sequence}
Let $A \to B$ be a surjective ring map. Consider the sheaf
$\Omega = \Omega_{\mathcal{O}/A} \otimes_\mathcal{O} B$ of
$\underline{B}$-modules on $\mathcal{C}_{B/A}$, see
Section \ref{section-compute-L-pi-shriek}.
Then there is a spectral sequence with $E_1$-page
$$
E_1^{p, q} =
H_{- p - q}(\mathcal{C}_{B/A}, \text{Sym}^p_{\underline{B}}(\Omega))
\Rightarrow \text{Tor}^A_{- p - q}(B, B)
$$
with $d_r$ of bidegree $(r, -r + 1)$.
Moreover, $H_i(\mathcal{C}_{B/A}, \text{Sym}^k_{\underline{B}}(\Omega)) = 0$
for $i < k$.
\end{theorem}

\begin{proof}
Let $I \subset A$ be the kernel of $A \to B$. Let
$\mathcal{J} \subset \mathcal{O}$
be the kernel of $\mathcal{O} \to \underline{B}$. Then
$I\mathcal{O} \subset \mathcal{J}$. Set
$\mathcal{K} = \mathcal{J}/I\mathcal{O}$ and
$\overline{\mathcal{O}} = \mathcal{O}/I\mathcal{O}$.

\medskip\noindent
For every object $U = (P \to B)$ of $\mathcal{C}_{B/A}$
we can choose an isomorphism $P = A[E]$ such that the map
$P \to B$ maps each $e \in E$ to zero. Then
$J = \mathcal{J}(U) \subset P = \mathcal{O}(U)$
is equal to $J = IP + (e; e \in E)$. Morever
$\overline{\mathcal{O}}(U) = B[E]$ and $K = \mathcal{K}(U) = (e; e \in E)$
is the ideal generated by the variables in the polynomial ring $B[E]$.
In particular it is clear that
$$
K/K^2 \xrightarrow{\text{d}} \Omega_{P/A} \otimes_P B
$$
is a bijection. In other words, $\Omega = \mathcal{K}/\mathcal{K}^2$
and $\text{Sym}_B^k(\Omega) = \mathcal{K}^k/\mathcal{K}^{k + 1}$.
Note that $\pi_!(\Omega) = \Omega_{B/A} = 0$ (Lemma \ref{lemma-identify-H0})
as $A \to B$ is surjective
(Algebra, Lemma \ref{algebra-lemma-trivial-differential-surjective}).
By Lemma \ref{lemma-vanishing-symmetric-powers} we conclude that
$$
H_i(\mathcal{C}_{B/A}, \mathcal{K}^k/\mathcal{K}^{k + 1}) =
H_i(\mathcal{C}_{B/A}, \text{Sym}^k_{\underline{B}}(\Omega)) = 0
$$
for $i < k$. This proves the final statement of the theorem.

\medskip\noindent
The approach to the theorem is to note that
$$
B \otimes_A^\mathbf{L} B = L\pi_!(\mathcal{O}) \otimes_A^\mathbf{L} B =
L\pi_!(\mathcal{O} \otimes_{\underline{A}}^\mathbf{L} \underline{B}) =
L\pi_!(\overline{\mathcal{O}})
$$
The first equality by Lemma \ref{lemma-apply-O-B-comparison},
the second equality by Lemma \ref{lemma-change-of-rings}, and
the third equality as $\mathcal{O}$ is flat over $\underline{A}$.
The sheaf $\overline{\mathcal{O}}$ has a filtration
$$
\ldots \subset
\mathcal{K}^3 \subset
\mathcal{K}^2 \subset
\mathcal{K} \subset
\overline{\mathcal{O}}
$$
This induces a filtration $F$ on a complex $C$ representing
$L\pi_!(\overline{\mathcal{O}})$ with $F^pC$ representing
$L\pi_!(\mathcal{K}^p)$ (construction of $C$ and $F$ omitted).
Consider the spectral sequence of
Homology, Section \ref{homology-section-filtered-complex}
associated to $(C, F)$. It has $E_1$-page
$$
E_1^{p, q} = H_{- p - q}(\mathcal{C}_{B/A}, \mathcal{K}^p/\mathcal{K}^{p + 1})
\quad\Rightarrow\quad
H_{- p - q}(\mathcal{C}_{B/A}, \overline{\mathcal{O}}) = 
\text{Tor}_{- p - q}^A(B, B)
$$
and differentials $E_r^{p, q} \to E_r^{p + r, q - r + 1}$. To show convergence
we will show that for every $k$ there exists a $c$ such that
$H_i(\mathcal{C}_{B/A}, \mathcal{K}^n) = 0$
for $i < k$ and $n > c$\footnote{A posteriori
the ``correct'' vanishing $H_i(\mathcal{C}_{B/A}, \mathcal{K}^n) = 0$ for
$i < n$ can be concluded.}.

\medskip\noindent
Given $k \geq 0$ set $c = k^2$. We claim that
$$
H_i(\mathcal{C}_{B/A}, \mathcal{K}^{n + c}) \to
H_i(\mathcal{C}_{B/A}, \mathcal{K}^n)
$$
is zero for $i < k$ and all $n \geq 0$. Note that
$\mathcal{K}^n/\mathcal{K}^{n + c}$ has a finite filtration whose succesive
quotients $\mathcal{K}^m/\mathcal{K}^{m + 1}$, $n \leq m < n + c$
have $H_i(\mathcal{C}_{B/A}, \mathcal{K}^m/\mathcal{K}^{m + 1}) = 0$
for $i < n$ (see above). Hence the claim implies
$H_i(\mathcal{C}_{B/A}, \mathcal{K}^{n + c}) = 0$ for $i < k$ and all
$n \geq k$ which is what we need to show.

\medskip\noindent
Proof of the claim. Recall that for any $\mathcal{O}$-module $\mathcal{F}$
the map $\mathcal{F} \to \mathcal{F} \otimes_\mathcal{O}^\mathbf{L} B$
induces an isomorphism on applying $L\pi_!$, see
Lemma \ref{lemma-O-homology-B-homology}.
Consider the map
$$
\mathcal{K}^{n + k} \otimes_\mathcal{O}^\mathbf{L} B
\longrightarrow
\mathcal{K}^n \otimes_\mathcal{O}^\mathbf{L} B
$$
We claim that this map induces the zero map on cohomology sheaves
in degrees $0, -1, \ldots, - k + 1$. If this second claim holds, then
the $k$-fold composition
$$
\mathcal{K}^{n + c} \otimes_\mathcal{O}^\mathbf{L} B
\longrightarrow
\mathcal{K}^n \otimes_\mathcal{O}^\mathbf{L} B
$$
factors through $\tau_{\leq -k}\mathcal{K}^n \otimes_\mathcal{O}^\mathbf{L} B$
hence induces zero on $H_i(\mathcal{C}_{B/A}, -) = L_i\pi_!( - )$
for $i < k$, see
Derived Categories, Lemma \ref{derived-lemma-trick-vanishing-composition}.
By the remark above this means the same thing is true for
$H_i(\mathcal{C}_{B/A}, \mathcal{K}^{n + c}) \to
H_i(\mathcal{C}_{B/A}, \mathcal{K}^n)$
which proves the (first) claim.

\medskip\noindent
Proof of the second claim. The statement is local, hence we may work
over an object $U = (P \to B)$ as above. We have to show
the maps
$$
\text{Tor}_i^P(B, K^{n + k}) \to \text{Tor}_i^P(B, K^n)
$$
are zero for $i < k$. There is a spectral sequence
$$
\text{Tor}_a^P(P/IP, \text{Tor}_b^{P/IP}(B, K^n))
\Rightarrow
\text{Tor}_{a + b}^P(B, K^n),
$$
see More on Algebra, Example \ref{more-algebra-example-tor-change-rings}.
Thus it suffices to prove the maps
$$
\text{Tor}_i^{P/IP}(B, K^{n + 1}) \to \text{Tor}_i^{P/IP}(B, K^n)
$$
are zero for all $i$. This is Lemma \ref{lemma-map-tors-zero}.
\end{proof}

\begin{remark}
\label{remark-elucidate-ss}
In the situation of Theorem \ref{theorem-quillen-spectral-sequence}
let $I = \text{Ker}(A \to B)$. Then
$H^{-1}(L_{B/A}) = H_1(\mathcal{C}_{B/A}, \Omega) = I/I^2$, see
Lemma \ref{lemma-surjection}.
Hence $H_k(\mathcal{C}_{B/A}, \text{Sym}^k(\Omega)) = \wedge^k_B(I/I^2)$ by
Remark \ref{remark-first-homology-symmetric-power}. Thus the
$E_1$-page looks like
$$
\begin{matrix}
B \\
0 \\
0 & I/I^2 \\
0 & H^{-2}(L_{B/A}) \\
0 & H^{-3}(L_{B/A}) & \wedge^2(I/I^2) \\
0 & H^{-4}(L_{B/A}) & H_3(\mathcal{C}_{B/A}, \text{Sym}^2(\Omega)) \\
0 & H^{-5}(L_{B/A}) & H_4(\mathcal{C}_{B/A}, \text{Sym}^2(\Omega)) &
\wedge^3(I/I^2)
\end{matrix}
$$
with horizontal differential. Thus we obtain edge maps
$\text{Tor}_i^A(B, B) \to H^{-i}(L_{B/A})$, $i > 0$ and
$\wedge^i_B(I/I^2) \to \text{Tor}_i^A(B, B)$. Finally, we have
$\text{Tor}_1^A(B, B) = I/I^2$ and there is a
five term exact sequence
$$
\text{Tor}_3^A(B, B) \to H^{-3}(L_{B/A}) \to \wedge^2_B(I/I^2) \to
\text{Tor}_2^A(B, B) \to H^{-2}(L_{B/A}) \to 0
$$
of low degree terms.
\end{remark}





\section{The cotangent complex of a local complete intersection}
\label{section-lci}

\noindent
If $A \to B$ is a local complete intersection map, then
$L_{B/A}$ is a perfect complex. The key to proving this is
the following lemma.

\begin{lemma}
\label{lemma-special-case}
Let $A = \mathbf{Z}[x] \to B = \mathbf{Z}$ be the ring map which sends
$x$ to $0$. Let $I = (x) \subset A$. Then $L_{B/A}$ is quasi-isomorphic to
$I/I^2[1]$.
\end{lemma}

\begin{proof}
There are several ways to prove this. For example one can explicitly construct
a resolution of $B$ over $A$ and compute. Or one can use the spectral sequence
of Quillen (Theorem \ref{theorem-quillen-spectral-sequence})
and the vanishing of $\text{Tor}_i^A(B, B)$ for $i > 1$.
Finally, one can use (\ref{equation-triangle}) which is what we will do here.
Namely, consider the distinguished triangle
$$
L_{\mathbf{Z}[x]/\mathbf{Z}} \otimes_{\mathbf{Z}[x]} \mathbf{Z} \to
L_{\mathbf{Z}/\mathbf{Z}} \to
L_{\mathbf{Z}/\mathbf{Z}[x]}\to
L_{\mathbf{Z}[x]/\mathbf{Z}} \otimes_{\mathbf{Z}[x]} \mathbf{Z}[1]
$$
The complex $L_{\mathbf{Z}[x]/\mathbf{Z}}$ is quasi-isomorphic to
$\Omega_{\mathbf{Z}[x]/\mathbf{Z}}$ by
Lemma \ref{lemma-cotangent-complex-polynomial-algebra}.
The complex $L_{\mathbf{Z}/\mathbf{Z}}$ is zero in $D(\mathbf{Z})$ by
Lemma \ref{lemma-when-zero}.
Thus we see that $L_{B/A}$ has only one nonzero cohomology group
which is as described in the lemma by Lemma \ref{lemma-surjection}.
\end{proof}

\begin{lemma}
\label{lemma-mod-regular-sequence}
Let $A \to B$ be a surjective ring map whose kernel $I$ is generated
by a regular sequence. Then $L_{B/A}$ is quasi-isomorphic to $I/I^2[1]$.
\end{lemma}

\begin{proof}
This is true if $I = (0)$. If $I = (f)$ is generated by a single
nonzerodivisor, then consider the ring map $\mathbf{Z}[x] \to A$
which sends $x$ to $f$. By assumption we have
$B = A \otimes_{\mathbf{Z}[x]}^\mathbf{L} \mathbf{Z}$.
Thus we obtain $L_{B/A} = I/I^2[1]$ from
Lemmas \ref{lemma-flat-base-change-cotangent-complex} and
\ref{lemma-special-case}.

\medskip\noindent
We prove the general case by induction. Suppose that we have
$I = (f_1, \ldots, f_r)$ where $f_1, \ldots, f_r$ is a regular sequence.
Set $C = A/(f_1, \ldots, f_{r - 1})$. By induction the result is
true for $A \to C$ and $C \to B$. We have a distinguished triangle
(\ref{equation-triangle})
$$
L_{C/A} \otimes_C^\mathbf{L} B \to L_{B/A} \to L_{B/C} \to
L_{C/A} \otimes_C^\mathbf{L} B[1]
$$
which shows that $L_{B/A}$ has only one nonzero cohomology group
which is as described in the lemma by Lemma \ref{lemma-surjection}.
\end{proof}

\begin{lemma}
\label{lemma-mod-Koszul-regular-ideal}
Let $A \to B$ be a surjective ring map whose kernel $I$ is Koszul.
Then $L_{B/A}$ is quasi-isomorphic to $I/I^2[1]$.
\end{lemma}

\begin{proof}
Flat locally on $\Spec(A)$ the ideal $I$ is generated by a regular
sequence, see More on Algebra, Lemma
\ref{more-algebra-lemma-Koszul-regular-flat-locally-regular}.
Hence this follows from
Lemma \ref{lemma-flat-base-change-cotangent-complex}
and flat descent.
\end{proof}

\begin{proposition}
\label{proposition-cotangent-complex-local-complete-intersection}
Let $A \to B$ be a local complete intersection map.
Then $L_{B/A}$ is a perfect complex with tor amplitude in $[-1, 0]$.
\end{proposition}

\begin{proof}
Choose a surjection $P = A[x_1, \ldots, x_n] \to B$ with kernel $J$.
By Lemma \ref{lemma-relation-with-naive-cotangent-complex}
we see that $J/J^2 \to \bigoplus B\text{d}x_i$
is quasi-isomorphic to $\tau_{\geq -1}L_{B/A}$.
Note that $J/J^2$ is finite projective
(More on Algebra, Lemma
\ref{more-algebra-lemma-quasi-regular-ideal-finite-projective}),
hence $\tau_{\geq -1}L_{B/A}$ is a perfect complex with
tor amplitude in $[-1, 0]$.
Thus it suffices to show that $H^i(L_{B/A}) = 0$ for $i \not \in [-1, 0]$.
This follows from (\ref{equation-triangle})
$$
L_{P/A} \otimes_P^\mathbf{L} B \to L_{B/A} \to L_{B/P} \to
L_{P/A} \otimes_P^\mathbf{L} B[1]
$$
and Lemma \ref{lemma-mod-Koszul-regular-ideal}
to see that $H^i(L_{B/P})$ is zero unless $i \in \{-1, 0\}$.
(We also use Lemma \ref{lemma-cotangent-complex-polynomial-algebra}
for the term on the left.)
\end{proof}




\section{The cotangent complex of a map of sheaves of rings}
\label{section-cotangent-morphism-ringed-topoi}

\noindent
Let $\mathcal{C}$ be a site and let $\Sh(\mathcal{C})$ denote the
associated topos. Let $\mathcal{A}$ denote a sheaf of rings
on $\mathcal{C}$. Let $\mathcal{A}\textit{-Alg}$ be the category of
$\mathcal{A}$-algebras. Consider the pair of adjoint functors $(F, i)$ where
$i : \mathcal{A}\textit{-Alg} \to \Sh(\mathcal{C})$ is the forgetful functor and
$F : \Sh(\mathcal{C}) \to \mathcal{A}\textit{-Alg}$ assigns to a sheaf of sets
$\mathcal{E}$ the polynomial algebra $\mathcal{A}[\mathcal{E}]$ on
$\mathcal{E}$ over $\mathcal{A}$.
Let $X_\bullet$ be the simplicial object of
$\text{Fun}(\mathcal{A}\textit{-Alg}, \mathcal{A}\textit{-Alg})$
constructed in
Simplicial, Section \ref{simplicial-section-standard}.

\medskip\noindent
Now assume that $\mathcal{A} \to \mathcal{B}$ is a homomorphism of sheaves
of rings. Then $\mathcal{B}$ is an object of the category
$\mathcal{A}\textit{-Alg}$. Denote
$\mathcal{P}_\bullet = X_\bullet(\mathcal{B})$ the resulting
simplicial $\mathcal{A}$-algebra.
Recall that
$\mathcal{P}_0 = \mathcal{A}[\mathcal{B}]$,
$\mathcal{P}_1 = \mathcal{A}[\mathcal{A}[\mathcal{B}]]$, and so on.
Recall also that there is an augmentation
$$
\epsilon : \mathcal{P}_\bullet \longrightarrow \mathcal{B}
$$
where we view $\mathcal{B}$ as a constant simplicial $\mathcal{A}$-algebra.

\begin{definition}
\label{definition-standard-resolution-sheaves-rings}
Let $\mathcal{C}$ be a site.
Let $\mathcal{A} \to \mathcal{B}$ be a homomorphism of sheaves of rings
on $\mathcal{C}$. The {\it standard resolution of $\mathcal{B}$ over
$\mathcal{A}$} is the augmentation
$\epsilon : \mathcal{P}_\bullet \to \mathcal{B}$
with terms
$$
\mathcal{P}_0 = \mathcal{A}[\mathcal{B}],\quad
\mathcal{P}_1 = \mathcal{A}[\mathcal{A}[\mathcal{B}]],\quad \ldots
$$
and maps as constructed above.
\end{definition}

\noindent
With this definition in hand the cotangent complex of a map of sheaves
of rings is defined as follows.
We will use the module of differentials as defined in
Modules on Sites, Section \ref{sites-modules-section-differentials}.

\begin{definition}
\label{definition-cotangent-complex-morphism-sheaves-rings}
Let $\mathcal{C}$ be a site.
Let $\mathcal{A} \to \mathcal{B}$ be a homomorphism of sheaves of rings
on $\mathcal{C}$.
The {\it cotangent complex} $L_{\mathcal{B}/\mathcal{A}}$
is the complex of $\mathcal{B}$-modules associated to the
simplicial module
$$
\Omega_{\mathcal{P}_\bullet/\mathcal{A}}
\otimes_{\mathcal{P}_\bullet, \epsilon} \mathcal{B}
$$
where $\epsilon : \mathcal{P}_\bullet \to \mathcal{B}$
is the standard resolution of $\mathcal{B}$ over
$\mathcal{A}$. We usually think of $L_{\mathcal{B}/\mathcal{A}}$
as an object of $D(\mathcal{B})$.
\end{definition}

\noindent
These constructions satisfy a functoriality similar to that discussed
in Section \ref{section-functoriality}. Namely, given a commutative diagram
\begin{equation}
\label{equation-commutative-square-sheaves}
\vcenter{
\xymatrix{
\mathcal{B} \ar[r] & \mathcal{B}' \\
\mathcal{A} \ar[u] \ar[r] & \mathcal{A}' \ar[u]
}
}
\end{equation}
of sheaves of rings on $\mathcal{C}$ there is a canonical
$\mathcal{B}$-linear map of complexes
$$
L_{\mathcal{B}/\mathcal{A}} \longrightarrow L_{\mathcal{B}'/\mathcal{A}'}
$$
constructed as follows. If $\mathcal{P}_\bullet \to \mathcal{B}$ is the
standard resolution of $\mathcal{B}$ over $\mathcal{A}$ and
$\mathcal{P}'_\bullet \to \mathcal{B}'$ is the
standard resoluton of $\mathcal{B}'$ over $\mathcal{A}'$,
then there is a canonical map $\mathcal{P}_\bullet \to \mathcal{P}'_\bullet$
of simplicial $\mathcal{A}$-algebras compatible with the augmentations
$\mathcal{P}_\bullet \to \mathcal{B}$ and
$\mathcal{P}'_\bullet \to \mathcal{B}'$. The maps
$$
\mathcal{P}_0 = \mathcal{A}[\mathcal{B}]
\longrightarrow
\mathcal{A}'[\mathcal{B}'] = \mathcal{P}'_0,
\quad
\mathcal{P}_1 = \mathcal{A}[\mathcal{A}[\mathcal{B}]]
\longrightarrow
\mathcal{A}'[\mathcal{A}'[\mathcal{B}']] = \mathcal{P}'_1
$$
and so on are given by the given maps $\mathcal{A} \to \mathcal{A}'$
and $\mathcal{B} \to \mathcal{B}'$. The desired map
$L_{\mathcal{B}/\mathcal{A}} \to L_{\mathcal{B}'/\mathcal{A}'}$
then comes from the associated maps on sheaves of differentials.

\medskip\noindent
The cotangent complex of a morphism of ringed topoi is defined
in terms of the cotangent complex we defined above.

\begin{definition}
\label{definition-cotangent-complex-morphism-ringed-topoi}
The {\it cotangent complex} $L_f$ of a morphism of ringed topoi
$(f, f^\sharp) : (\Sh(\mathcal{C}), \mathcal{O}_\mathcal{C}) \to
(\Sh(\mathcal{D}), \mathcal{O}_\mathcal{D})$ is
$L_f = L_{\mathcal{O}_\mathcal{C}/f^{-1}\mathcal{O}_\mathcal{D}}$.
\end{definition}

\noindent
This definition applies to many situations, but it doesn't always produce
the thing one expects. For example, if $f : X \to Y$ is a morphism of
schemes, then $f$ induces a morphism of big \'etale sites
$f_{big} : (\Sch/X)_{\acute{e}tale} \to (\Sch/Y)_{\acute{e}tale}$
which is a morphism of ringed topoi (Descent, Remark
\ref{descent-remark-change-topologies-ringed}).
However, $L_{f_{big}} = 0$ since $(f_{big})^\sharp$ is an isomorphism.
On the other hand, if we take $L_f$ where we think of $f$ as a morphism
between the underlying Zariski ringed topoi, then $L_f$ does agree with
the cotangent complex $L_{X/Y}$ (as defined below)
whose zeroth cohomology sheaf is $\Omega_{X/Y}$.

\begin{lemma}
\label{lemma-pullback-cotangent-morphism-topoi}
Let $f : \Sh(\mathcal{D}) \to \Sh(\mathcal{C})$ be a morphism of topoi.
Let $\mathcal{A} \to \mathcal{B}$ be a homomorphism of sheaves of rings
on $\mathcal{C}$. Then
$f^{-1}L_{\mathcal{B}/\mathcal{A}} = L_{f^{-1}\mathcal{B}/f^{-1}\mathcal{A}}$.
\end{lemma}

\begin{proof}
The diagram
$$
\xymatrix{
\mathcal{A}\textit{-Alg} \ar[d]_{f^{-1}} \ar[r] &
\Sh(\mathcal{C}) \ar@<1ex>[l] \ar[d]^{f^{-1}} \\
f^{-1}\mathcal{A}\textit{-Alg} \ar[r] & \Sh(\mathcal{D}) \ar@<1ex>[l]
}
$$
commutes.
\end{proof}

\begin{lemma}
\label{lemma-compute-L-morphism-sheaves-rings}
Let $\mathcal{C}$ be a site. Let $\mathcal{A} \to \mathcal{B}$ be a
homomorphism of sheaves of rings on $\mathcal{C}$. Then
$H^i(L_{\mathcal{B}/\mathcal{A}})$ is the sheaf associated to the
presheaf $U \mapsto H^i(L_{\mathcal{B}(U)/\mathcal{A}(U)})$.
\end{lemma}

\begin{proof}
Let $\mathcal{C}'$ be the site we get by endowing $\mathcal{C}$ with the
chaotic topology (presheaves are sheaves). There is a morphism of topoi
$f : \Sh(\mathcal{C}) \to \Sh(\mathcal{C}')$ where $f_*$ is the inclusion
of sheaves into presheaves and $f^{-1}$ is sheafification.
By Lemma \ref{lemma-pullback-cotangent-morphism-topoi}
it suffices to prove the result for $\mathcal{C}'$, i.e.,
in case $\mathcal{C}$ has the chaotic topology.

\medskip\noindent
If $\mathcal{C}$ carries the chaotic topology, then
$L_{\mathcal{B}/\mathcal{A}}(U)$ is equal to
$L_{\mathcal{B}(U)/\mathcal{A}(U)}$ because
$$
\xymatrix{
\mathcal{A}\textit{-Alg} \ar[d]_{\text{sections over }U} \ar[r] &
\Sh(\mathcal{C}) \ar@<1ex>[l] \ar[d]^{\text{sections over }U} \\
\mathcal{A}(U)\textit{-Alg} \ar[r] & \textit{Sets} \ar@<1ex>[l]
}
$$
commutes.
\end{proof}

\begin{remark}
\label{remark-map-sections-over-U}
It is clear from the proof of
Lemma \ref{lemma-compute-L-morphism-sheaves-rings}
that for any $U \in \Ob(\mathcal{C})$ there is a canonical map
$L_{\mathcal{B}(U)/\mathcal{A}(U)} \to L_{\mathcal{B}/\mathcal{A}}(U)$
of complexes of $\mathcal{B}(U)$-modules. Moreover, these maps
are compatible with restriction maps and the complex
$L_{\mathcal{B}/\mathcal{A}}$
is the sheafifiction of the rule $U \mapsto L_{\mathcal{B}(U)/\mathcal{A}(U)}$.
\end{remark}

\begin{lemma}
\label{lemma-compute-L-product-sheaves-rings}
Let $\mathcal{C}$ be a site. Let $\mathcal{A} \to \mathcal{B}$
and $\mathcal{A} \to \mathcal{B}'$ be homomorphisms of sheaves of rings
on $\mathcal{C}$. Then
$$
L_{\mathcal{B} \times \mathcal{B}'/\mathcal{A}}
\longrightarrow
L_{\mathcal{B}/\mathcal{A}} \oplus L_{\mathcal{B}'/\mathcal{A}}
$$
is an isomorphism in $D(\mathcal{B} \times \mathcal{B}')$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-compute-L-morphism-sheaves-rings}
it suffices to prove this for ring maps.
In the case of rings this is
Lemma \ref{lemma-cotangent-complex-product}.
\end{proof}

\noindent
The fundamental triangle for the cotangent complex of sheaves of rings
is an easy consequence of the result for homomorphisms of rings.

\begin{lemma}
\label{lemma-triangle-sheaves-rings}
Let $\mathcal{D}$ be a site. Let $\mathcal{A} \to \mathcal{B} \to \mathcal{C}$
be homomorphisms of sheaves of rings on $\mathcal{D}$.
There is a canonical distinguished triangle
$$
L_{\mathcal{B}/\mathcal{A}} \otimes_\mathcal{B}^\mathbf{L} \mathcal{C}
\to L_{\mathcal{C}/\mathcal{A}} \to L_{\mathcal{C}/\mathcal{B}} \to
L_{\mathcal{B}/\mathcal{A}} \otimes_\mathcal{B}^\mathbf{L} \mathcal{C}[1]
$$
in $D(\mathcal{C})$.
\end{lemma}

\begin{proof}
We will use the method described in
Remarks \ref{remark-triangle} and \ref{remark-explicit-map}
to construct the triangle; we will freely use the results mentioned there.
As in those remarks we first construct the triangle in case
$\mathcal{B} \to \mathcal{C}$ is an injective map of sheaves of rings.
In this case we set
\begin{enumerate}
\item $\mathcal{P}_\bullet$ is the standard resolution of $\mathcal{B}$
over $\mathcal{A}$,
\item $\mathcal{Q}_\bullet$ is the standard resolution of $\mathcal{C}$
over $\mathcal{A}$,
\item $\mathcal{R}_\bullet$ is the standard resolution of $\mathcal{C}$
over $\mathcal{B}$,
\item $\mathcal{S}_\bullet$ is the standard resolution of $\mathcal{B}$
over $\mathcal{B}$,
\item $\overline{\mathcal{Q}}_\bullet =
\mathcal{Q}_\bullet \otimes_{\mathcal{P}_\bullet} \mathcal{B}$, and
\item $\overline{\mathcal{R}}_\bullet =
\mathcal{R}_\bullet \otimes_{\mathcal{S}_\bullet} \mathcal{B}$.
\end{enumerate}
The distinguished triangle is the distinguished triangle associated
to the short exact sequence
of simplicial $\mathcal{C}$-modules
$$
0 \to
\Omega_{\mathcal{P}_\bullet/\mathcal{A}}
\otimes_{\mathcal{P}_\bullet} \mathcal{C} \to
\Omega_{\mathcal{Q}_\bullet/\mathcal{A}}
\otimes_{\mathcal{Q}_\bullet} \mathcal{C} \to
\Omega_{\overline{\mathcal{Q}}_\bullet/\mathcal{B}}
\otimes_{\overline{\mathcal{Q}}_\bullet} \mathcal{C} \to 0
$$
The first two terms are equal to the first two terms of the triangle
of the statement of the lemma. The identification of the last term with
$L_{\mathcal{C}/\mathcal{B}}$ uses the quasi-isomorphisms of complexes
$$
L_{\mathcal{C}/\mathcal{B}} =
\Omega_{\mathcal{R}_\bullet/\mathcal{B}}
\otimes_{\mathcal{R}_\bullet} \mathcal{C}
\longrightarrow
\Omega_{\overline{\mathcal{R}}_\bullet/\mathcal{B}}
\otimes_{\overline{\mathcal{R}}_\bullet} \mathcal{C}
\longleftarrow
\Omega_{\overline{\mathcal{Q}}_\bullet/\mathcal{B}}
\otimes_{\overline{\mathcal{Q}}_\bullet} \mathcal{C}
$$
All the constructions used above can first be done on the level
of presheaves and then sheafified. Hence to prove sequences are exact,
or that map are quasi-isomorphisms it suffices to prove the corresponding
statement for the ring maps
$\mathcal{A}(U) \to \mathcal{B}(U) \to \mathcal{C}(U)$
which are known. This finishes the proof in the case that
$\mathcal{B} \to \mathcal{C}$ is injective.

\medskip\noindent
In general, we reduce to the case where $\mathcal{B} \to \mathcal{C}$ is
injective by replacing $\mathcal{C}$ by $\mathcal{B} \times \mathcal{C}$ if
necessary. This is possible by the argument given in
Remark \ref{remark-triangle} by
Lemma \ref{lemma-compute-L-product-sheaves-rings}.
\end{proof}

\begin{lemma}
\label{lemma-stalk-cotangent-complex}
Let $\mathcal{C}$ be a site. Let $\mathcal{A} \to \mathcal{B}$ be a
homomorphism of sheaves of rings on $\mathcal{C}$. If $p$ is a point
of $\mathcal{C}$, then
$(L_{\mathcal{B}/\mathcal{A}})_p = L_{\mathcal{B}_p/\mathcal{A}_p}$.
\end{lemma}

\begin{proof}
This is a special case of Lemma \ref{lemma-pullback-cotangent-morphism-topoi}.
\end{proof}







\section{The cotangent complex of a morphism of schemes}
\label{section-cotangent-morphism-schemes}

\noindent
As promised above we define the cotangent complex of a morphism of
schemes as follows.

\begin{definition}
\label{definition-cotangent-morphism-schemes}
Let $f : X \to Y$ be a morphism of schemes. The {\it cotangent complex
$L_{X/Y}$ of $X$ over $Y$} is the complex of $\mathcal{O}_X$-modules
$L_f$ of Definition \ref{definition-cotangent-complex-morphism-ringed-topoi}
where $f$ is viewed as a morphism between the ringed Zariski topoi
of $X$ and $Y$.
\end{definition}

\noindent
This definition is compatible with the definition for ring maps.
See next lemma which also implies that $L_{X/Y}$ is an
object of $D_{\textit{QCoh}}(\mathcal{O}_X)$.

\begin{lemma}
\label{lemma-morphism-affine-schemes}
Let $f : X \to Y$ be a morphism of schemes. Let $U = \Spec(A) \subset X$
and $V = \Spec(B) \subset Y$ be affine opens such that $f(U) \subset V$.
There is a canonical map
$$
\widetilde{L_{B/A}} \longrightarrow L_{X/Y}|_U
$$
of complexes which is an isomorphism in $D(\mathcal{O}_U)$.
This map is compatible with restricting to smaller affine opens
of $X$ and $Y$.
\end{lemma}

\begin{proof}
By Remark \ref{remark-map-sections-over-U}
there is a canonical map of complexes
$L_{\mathcal{O}_X(U)/f^{-1}\mathcal{O}_Y(U)} \to L_{X/Y}(U)$
of $B = \mathcal{O}_X(U)$-modules, which is compatible
with further restrictions. Using the canonical map
$A \to f^{-1}\mathcal{O}_Y(U)$ we obtain a canonical map
$L_{B/A} \to L_{\mathcal{B}/\mathcal{A}}(U)$
of $B$-modules. Using the universal property of the $\widetilde{\ }$
functor (see Schemes, Lemma \ref{schemes-lemma-compare-constructions})
we obtain a map as in the statement of the lemma.
We may check this map is an isomorphism on cohomology sheaves
by checking it induces isomorphisms on stalks.
This follows immediately from
Lemmas \ref{lemma-stalk-cotangent-complex} and \ref{lemma-localize}
(and the description of the stalks of
$\mathcal{O}_X$ and $f^{-1}\mathcal{O}_Y$
at a point $\mathfrak p \in \Spec(B)$ as $B_\mathfrak p$ and
$A_\mathfrak q$ where $\mathfrak q = A \cap \mathfrak p$; references
used are Schemes, Lemma \ref{schemes-lemma-spec-sheaves}
and
Sheaves, Lemma \ref{sheaves-lemma-stalk-pullback}).
\end{proof}

\begin{lemma}
\label{lemma-triangle-schemes}
Let $f : X \to Y$ and $g : Y \to Z$ be morphisms of schemes.
Then there is a canonical distinguished triangle
$$
Lf^* L_{Y/Z} \to L_{X/Z} \to L_{X/Y} \to Lf^*L_{Y/Z}[1]
$$
in $D(\mathcal{O}_X)$.
\end{lemma}

\begin{proof}
Set $h = g \circ f$ so that $h^{-1}\mathcal{O}_Z = f^{-1}g^{-1}\mathcal{O}_Y$.
By Lemma \ref{lemma-pullback-cotangent-morphism-topoi} we have
$f^{-1}L_{Y/Z} = L_{f^{-1}\mathcal{O}_Y/h^{-1}\mathcal{O}_Z}$
and this is a complex of flat $f^{-1}\mathcal{O}_Y$-modules.
Hence the distinguished triangle above is an example of the
distinguished triangle of
Lemma \ref{lemma-triangle-sheaves-rings}
with $\mathcal{A} = h^{-1}\mathcal{O}_Z$, $\mathcal{B} = f^{-1}\mathcal{O}_Y$,
and $\mathcal{C} = \mathcal{O}_X$.
\end{proof}







\section{Variants of cotangent complexes for schemes}
\label{section-cotangent-schemes-variant}

\noindent
Let $f : X \to Y$ be a morphism of schemes. Let $\mathcal{C}_{X/Y}$ be the
category whose objects are commutative diagrams
\begin{equation}
\label{equation-object}
\vcenter{
\xymatrix{
X \ar[d] & U \ar[l] \ar[d] \ar[r]_i & A \ar[ld] \\
Y & V \ar[l]
}
}
\end{equation}
of schemes where
\begin{enumerate}
\item $U$ is an open subscheme of $X$,
\item $V$ is an open subscheme of $Y$, and
\item there exists an isomorphism $A = V \times \Spec(P)$ over $V$
where $P$ is a polynomial algebra over $\mathbf{Z}$ (on some set
of variables).
\end{enumerate}
In other words, $A$ is an (infinite dimensional) affine space over $V$.
Morphisms are given by commutative diagrams.

\medskip\noindent
{\bf Notation.} An object of $\mathcal{C}_{X/Y}$, i.e., a diagram
(\ref{equation-object}), is often denoted $U \to A$ where it is
understood that (a) $U$ is an open subscheme of $X$, (b)
$U \to A$ is a morphism over $Y$, (c) the image of the
structure morphism $A \to Y$ is an open $V \subset Y$, and (d)
$A \to V$ is an affine space. We'll write $U \to A/V$ to indicate
$V \subset Y$ is the image of $A \to Y$.
Recall that $X_{Zar}$ denotes the small Zariski site $X$.
There are forgetful functors
$$
\mathcal{C}_{X/Y} \to X_{Zar},\ (U \to A) \mapsto U
\quad\text{and}\quad
\mathcal{C}_{X/Y} \mapsto Y_{Zar},\ (U \to A/V) \mapsto V.
$$

\begin{lemma}
\label{lemma-category-fibred}
Let $X \to Y$ be a morphism of schemes.
\begin{enumerate}
\item The category $\mathcal{C}_{X/Y}$ is fibred over $X_{Zar}$.
\item The category $\mathcal{C}_{X/Y}$ is fibred over $Y_{Zar}$.
\item The category $\mathcal{C}_{X/Y}$ is fibred over the
category of pairs $(U, V)$ where $U \subset X$, $V \subset Y$ are
open and $f(U) \subset V$.
\end{enumerate}
\end{lemma}

\begin{proof}
Ad (1). Given an object $U \to A$ of $\mathcal{C}_{X/Y}$ and a morphism
$U' \to U$ of $X_{Zar}$ consider the object $i' : U' \to A$ of
$\mathcal{C}_{X/Y}$ where $i'$ is the composition of $i$ and $U' \to U$.
The morphism $(U' \to A) \to (U \to A)$ of $\mathcal{C}_{X/Y}$
is strongly cartesian over $X_{Zar}$.

\medskip\noindent
Ad (2). Given an object $U \to A/V$ and $V' \to V$ we can set
$U' = U \cap f^{-1}(V')$ and $A' = V' \times_V A$ to obtain a strongly
cartesian morphism $(U' \to A') \to (U \to A)$ over $V' \to V$.

\medskip\noindent
Ad (3). Denote $(X/Y)_{Zar}$ the category in (3). Given $U \to A/V$
and a morphism $(U', V') \to (U, V)$ in $(X/Y)_{Zar}$ we can consider
$A' = V' \times_V A$. Then the morphism $(U' \to A'/V') \to (U \to A/V)$
is strongly cartesian in $\mathcal{C}_{X/Y}$ over $(X/Y)_{Zar}$.
\end{proof}

\noindent
We obtain a topology $\tau_X$ on $\mathcal{C}_{X/Y}$ by
using the topology inherited from $X_{Zar}$ (see
Stacks, Section \ref{stacks-section-topology}). If not otherwise
stated this is the topology on $\mathcal{C}_{X/Y}$ we will consider.
To be precise, a family of morphisms $\{(U_i \to A_i) \to (U \to A)\}$
is a covering of $\mathcal{C}_{X/Y}$ if and only if
\begin{enumerate}
\item $U = \bigcup U_i$, and
\item $A_i = A$ for all $i$.
\end{enumerate}
We obtain the same collection of sheaves if we allow $A_i \cong A$ in (2).
The functor $u$ defines a morphism of topoi
$\pi : \Sh(\mathcal{C}_{X/Y}) \to \Sh(X_{Zar})$.

\medskip\noindent
The site $\mathcal{C}_{X/Y}$ comes with several sheaves of rings.
\begin{enumerate}
\item The sheaf $\mathcal{O}$ given by the rule
$(U \to A) \mapsto \mathcal{O}(A)$.
\item The sheaf $\underline{\mathcal{O}}_X = \pi^{-1}\mathcal{O}_X$ given by
the rule $(U \to A) \mapsto \mathcal{O}(U)$.
\item The sheaf $\underline{\mathcal{O}}_Y$ given by the rule
$(U \to A/V) \mapsto \mathcal{O}(V)$.
\end{enumerate}
We obtain morphisms of ringed topoi
\begin{equation}
\label{equation-pi-schemes}
\vcenter{
\xymatrix{
(\Sh(\mathcal{C}_{X/Y}), \underline{\mathcal{O}}_X) \ar[r]_i \ar[d]_\pi &
(\Sh(\mathcal{C}_{X/Y}), \mathcal{O}) \\
(\Sh(X_{Zar}), \mathcal{O}_X)
}
}
\end{equation}
The morphism $i$ is the identity on underlying topoi and
$i^\sharp : \mathcal{O} \to \underline{\mathcal{O}}_X$
is the obvious map.
The map $\pi$ is a special case of Situation \ref{situation-fibred-category}.
An important role will be played in the following
by the derived functors
$
Li^* : D(\mathcal{O}) \longrightarrow D(\underline{\mathcal{O}}_X)
$
left adjoint to $Ri_* = i_* : D(\underline{\mathcal{O}}_X) \to D(\mathcal{O})$
and
$
L\pi_! : D(\underline{\mathcal{O}}_X) \longrightarrow D(\mathcal{O}_X)
$
left adjoint to
$\pi^* = \pi^{-1} : D(\mathcal{O}_X) \to D(\underline{\mathcal{O}}_X)$.

\medskip\noindent
By our choice of topology on $\mathcal{C}_{X/Y}$ the rule
$$
(U \to A/V) \longmapsto \Omega_{\mathcal{O}(A)/\mathcal{O}(V)}
$$
is a sheaf, hence equal to $\Omega_{\mathcal{O}/\underline{\mathcal{O}}_Y}$.
Since $A \to V$ is an affine space, the ring
$\mathcal{O}(A)$ is a polynomial algebra over $\mathcal{O}(V)$.
Hence $\Omega_{\mathcal{O}(A)/\mathcal{O}(V)}$ is a free module over
$\mathcal{O}(A)$, in particular flat. Here is the analog of
Lemma \ref{lemma-compute-cotangent-complex}.

\begin{lemma}
\label{lemma-cotangent-morphism-schemes}
Let $f : X \to Y$ be a morphism of schemes. There is a canonical
isomorphism
$$
L_{X/Y} = 
L\pi_!(Li^*\Omega_{\mathcal{O}/\underline{\mathcal{O}}_Y}) =
L\pi_!(i^*\Omega_{\mathcal{O}/\underline{\mathcal{O}}_Y}) =
L\pi_!(\Omega_{\mathcal{O}/\underline{\mathcal{O}}_Y}
\otimes_\mathcal{O} \underline{\mathcal{O}}_X)
$$
in $D(\mathcal{O}_X)$.
\end{lemma}

\begin{proof}
FIXME.
\end{proof}

\begin{remark}
\label{remark-different-topologies}
We obtain a second topology $\tau_Y$ on $\mathcal{C}_{X/Y}$
by taking the topology inherited from $Y_{Zar}$.
There is a third topology $\tau_{X \to Y}$ where a family of morphisms
$\{(U_i \to A_i) \to (U \to A)\}$ is a covering if and only
if $U = \bigcup U_i$, $V = \bigcup V_i$ and $A_i \cong V_i \times_V A$.
This is the topology inherited from the topology on the site
$(X/Y)_{Zar}$ whose underlying category is the category of pairs
$(U, V)$ as in Lemma \ref{lemma-category-fibred} part (3). The coverings
of $(X/Y)_{Zar}$ are families $\{(U_i, V_i) \to (U, V)\}$ such that
$U = \bigcup U_i$ and $V = \bigcup V_i$. There are morphisms of topoi
$$
\xymatrix{
\Sh(\mathcal{C}_{X/Y})
= \Sh(\mathcal{C}_{X/Y}, \tau_X) &
\Sh(\mathcal{C}_{X/Y}, \tau_{X \to Y}) \ar[l] \ar[r] &
\Sh(\mathcal{C}_{X/Y}, \tau_Y)
}
$$
(recall that $\tau_X$ is our ``default'' topology). The pullback functors
for these arrows are sheafification and pushforward is the identity on
underlying presheaves. The diagram of topoi
$$
\xymatrix{
\Sh(X_{Zar}) \ar[d]^f & \Sh(\mathcal{C}_{X/Y}) \ar[l]^\pi &
\Sh(\mathcal{C}_{X/Y}, \tau_{X \to Y}) \ar[l] \ar[d] \\
\Sh(Y_{Zar}) & & \Sh(\mathcal{C}_{X/Y}, \tau_Y) \ar[ll]
}
$$
is {\bf not} commutative. Namely, the pullback of a nonzero abelian sheaf on
$Y$ is a nonzero abelian sheaf on $(\mathcal{C}_{X/Y}, \tau_{X \to Y})$,
but we can certainly find examples where such a sheaf pulls back to zero
on $X$. Note that any presheaf $\mathcal{F}$ on
$Y_{Zar}$ gives a sheaf $\underline{\mathcal{F}}$ on $\mathcal{C}_{Y/X}$
by the rule which assigns to $(U \to A/V)$ the set $\mathcal{F}(V)$.
Even if $\mathcal{F}$ happens to be a sheaf it isn't true in general that
$\underline{\mathcal{F}} = \pi^{-1}f^{-1}\mathcal{F}$. This is related
to the noncommutativity of the diagram above, as we can describe
$\underline{\mathcal{F}}$ as the pushforward of the pulllback
of $\mathcal{F}$ to $\Sh(\mathcal{C}_{X/Y}, \tau_{X \to Y})$ via
the lower horizontal and right vertical arrows. An
example is the sheaf $\underline{\mathcal{O}}_Y$.
But what is true is that there is a map
$\underline{\mathcal{F}} \to \pi^{-1}f^{-1}\mathcal{F}$
which is transformed (as we shall see later)
into an isomorphism after applying $\pi_!$.
\end{remark}






\input{chapters}

\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}
