\input{preamble}

% OK, start here.
%
\begin{document}

\title{Flatness on Algebraic Spaces}

\maketitle

\phantomsection
\label{section-phantom}

\tableofcontents



\section{Introduction}
\label{section-introduction}

\noindent
In this chapter, we discuss some advanced results on flat modules and
flat morphisms in the setting of algebraic spaces. We strongly encourage
the reader to take a look at the corresponding
chapter in the setting of schemes first, see
More on Flatness, Section \ref{flat-section-introduction}.
A reference is the paper \cite{GruRay} by Raynaud and Gruson.







\section{Impurities}
\label{section-impure}

\noindent
The section is the analogue of
More on Flatness, Section \ref{flat-section-impure}.

\begin{situation}
\label{situation-pre-pure}
Let $S$ be a scheme. Let $f : X \to Y$ be a
finite type, decent\footnote{Quasi-separated morphisms are decent, see
Decent Spaces, Lemma
\ref{decent-spaces-lemma-properties-trivial-implications}.} morphism
of algebraic spaces over $S$. Also, $\mathcal{F}$ is a finite type
quasi-coherent $\mathcal{O}_X$-module. Finally $y \in |Y|$ is a point of $Y$.
\end{situation}

\noindent
In this situation consider a scheme $T$, a morphism $g : T \to Y$,
a point $t \in T$ with $g(t) = y$, a specialization $t' \leadsto t$ in
$T$, and a point $\xi \in |X_T|$ lying over $t'$. Here $X_T = T \times_Y X$.
Picture
\begin{equation}
\label{equation-impurity}
\vcenter{
\xymatrix{
\xi \ar@{|->}[d] & \\
t' \ar@{~>}[r] & t \ar@{|->}[r] \ar[r] & y
}
}
\quad\quad
\vcenter{
\xymatrix{
X_T \ar[d]_{f_T} \ar[r] & X \ar[d]^f \\
T \ar[r]^g & Y
}
}
\end{equation}
Moreover, denote $\mathcal{F}_T$ the pullback of $\mathcal{F}$ to $X_T$.

\begin{definition}
\label{definition-impurity}
In
Situation \ref{situation-pre-pure}
we say a diagram (\ref{equation-impurity}) defines an
{\it impurity of $\mathcal{F}$ above $y$}
if $\xi \in \text{Ass}_{X_T/T}(\mathcal{F}_T)$ and
$t \not \in f_T(\overline{\{\xi\}})$. We will indicate
this by saying ``let $(g : T \to Y, t' \leadsto t, \xi)$ be
an impurity of $\mathcal{F}$ above $y$''.
\end{definition}

\noindent
Another way to say this is: $(g : T \to Y, t' \leadsto t, \xi)$ is
an impurity of $\mathcal{F}$ above $y$ if there exists no specialization
$\xi \leadsto \theta$ in the topological space $|X_T|$ with
$f_T(\theta) = t$. Specializations in non-decent algebraic spaces
do not behave well. If the morphism $f$ is decent, then $X_T$
is a decent algebraic space for all morphisms $g : T \to Y$ as above, see
Decent Spaces, Definition \ref{decent-spaces-definition-relative-conditions}.

\begin{lemma}
\label{lemma-impure-limit}
In Situation \ref{situation-pre-pure}.
Let $(g : T \to S, t' \leadsto t, \xi)$ be an impurity of
$\mathcal{F}$ above $y$. Assume $T = \lim_{i \in I} T_i$ is a directed limit
of affine schemes over $Y$. Then for some $i$ the triple
$(T_i \to Y, t'_i \leadsto t_i, \xi_i)$ is an impurity of
$\mathcal{F}$ above $y$.
\end{lemma}

\begin{proof}
The notation in the statement means this: Let $p_i : T \to T_i$
be the projection morphisms, let $t_i = p_i(t)$ and $t'_i = p_i(t')$.
Finally $\xi_i \in |X_{T_i}|$ is the image of $\xi$. By
Divisors of Spaces, Lemma
\ref{spaces-divisors-lemma-base-change-relative-assassin}
we have $\xi_i \in \text{Ass}_{X_{T_i}/T_i}(\mathcal{F}_{T_i})$.
Thus the only point is to show that
$t_i \not \in f_{T_i}(\overline{\{\xi_i\}})$ for some $i$.

\medskip\noindent
Let $Z_i \subset X_{T_i}$ be the reduced induced scheme structure
on $\overline{\{\xi_i\}} \subset |X_{T_i}|$
and let $Z \subset X_T$ be the reduced induced scheme structure on
$\overline{\{\xi\}} \subset |X_T|$.
Then $Z = \lim Z_i$ by
Limits of Spaces, Lemma \ref{spaces-limits-lemma-inverse-limit-irreducibles}
(the lemma applies because each $X_{T_i}$ is decent).
Choose a field $k$ and a morphism $\Spec(k) \to T$ whose image is $t$.
Then
$$
\emptyset =
Z \times_T \Spec(k) = (\lim Z_i) \times_{(\lim T_i)} \Spec(k)
= \lim Z_i \times_{T_i} \Spec(k)
$$
because limits commute with fibred products (limits commute with limits).
Each $Z_i \times_{T_i} \Spec(k)$ is quasi-compact because $X_{T_i} \to T_i$
is of finite type and hence $Z_i \to T_i$ is of finite type.
Hence $Z_i \times_{T_i} \Spec(k)$ is empty for some $i$ by
Limits of Spaces, Lemma \ref{spaces-limits-lemma-limit-nonempty}.
Since the image of the composition $\Spec(k) \to T \to T_i$ is $t_i$
we obtain what we want.
\end{proof}

\noindent
Impurities go up along flat base change.

\begin{lemma}
\label{lemma-flat-ascent-impurity}
In Situation \ref{situation-pre-pure}.
Let $(Y_1, y_1) \to (Y, y)$ be a morphism of pointed
algebraic spaces over $S$. Assume $Y_1 \to Y$ is flat at $y_1$.
If $(T \to Y, t' \leadsto t, \xi)$ is an impurity of
$\mathcal{F}$ above $y$, then there exists an impurity
$(T_1 \to Y_1, t_1' \leadsto t_1, \xi_1)$ of the pullback
$\mathcal{F}_1$ of $\mathcal{F}$ to $X_1 = Y_1 \times_Y X$
over $y_1$ such that $T_1$ is \'etale over $Y_1 \times_Y T$.
\end{lemma}

\begin{proof}
Choose an \'etale morphism $T_1 \to Y_1 \times_Y T$ where $T_1$
is a scheme and let $t_1 \in T_1$ be a point mapping to $y_1$ and $t$.
It is possible to find a pair $(T_1, t_1)$ like this by
Properties of Spaces, Lemma \ref{spaces-properties-lemma-points-cartesian}.
The morphism of schemes $T_1 \to T$ is flat at $t_1$
(use Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-base-change-flat}
and the definition of flat morphisms of algebraic spaces)
there exists a specialization $t'_1 \leadsto t_1$ lying over
$t' \leadsto t$, see
Morphisms, Lemma \ref{morphisms-lemma-generalizations-lift-flat}.
Choose a point $\xi_1 \in |X_{T_1}|$ mapping to $t'_1$
and $\xi$ with $\xi_1 \in \text{Ass}_{X_{T_1}/T_1}(\mathcal{F}_{T_1})$.
point of $\Spec(\kappa(t'_1) \otimes_{\kappa(t')} \kappa(\xi))$.
This is possible by
Divisors on Spaces, Lemma
\ref{spaces-divisors-lemma-base-change-relative-assassin}.
As the closure $Z_1$ of $\{\xi_1\}$ in $|X_{T_1}|$ maps into the
closure of $\{\xi\}$ in $|X_T|$ we conclude that
the image of $Z_1$ in $|T_1|$ cannot contain $t_1$.
Hence $(T_1 \to Y_1, t'_1 \leadsto t_1, \xi_1)$
is an impurity of $\mathcal{F}_1$ above $Y_1$.
\end{proof}

\begin{lemma}
\label{lemma-pure-along-X-y}
In Situation \ref{situation-pre-pure} the following are equivalent
\begin{enumerate}
\item there exists an impurity
$(\Spec(\mathcal{O}_{Y, \overline{y}}) \to Y, y' \leadsto \overline{y}, \xi)$
of $\mathcal{F}$ above $y$,
\item there exists an impurity $(T \to Y, t' \leadsto t, \xi)$
of $\mathcal{F}$ above $s$ such that $(T, t) \to (Y, y)$ is an
\'etale neighbourhood, and
\item there exists an impurity $(T \to Y, t' \leadsto t, \xi)$
of $\mathcal{F}$ above $y$ such that $T \to Y$ is quasi-finite at $t$.
\end{enumerate}
\end{lemma}

\begin{proof}
Recall that $\mathcal{O}_{Y, \overline{y}}$ is the filtered colimit
of $\mathcal{O}(V)$ over the category
of \'etale neighbourhoods $(V, \overline{v}) \to (Y, \overline{y})$
(Properties of Spaces, Lemma \ref{spaces-properties-lemma-cofinal-etale}).
Moreover, it suffices to consider affine \'etale neighbourhoods $V$.
Hence $\Spec(\mathcal{O}_{Y, \overline{y}}) = \lim \Spec(\mathcal{O}(V))$.
Thus we see that (1) implies (2) by Lemma \ref{lemma-impure-limit}.

\medskip\noindent
Since an \'etale morphism is locally quasi-finite
(Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-etale-locally-quasi-finite})
we see that (2) implies (3).

\medskip\noindent
Finally, assume (3). After replacing $T$ by an open neighbourhood of $t$
we may assume $T \to Y$ is locally quasi-finite. We abbreviate
$\mathcal{O} = \mathcal{O}_{Y, \overline{y}}$.
By Lemma \ref{lemma-flat-ascent-impurity}
we find an impurity
$(T_1 \to \Spec(\mathcal{O}), t_1' \leadsto t_1, \xi_1)$
with $T_1 \to T \times_Y \Spec(\mathcal{O})$
\'etale. Since an \'etale morphism is locally quasi-finite
and using Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-base-change-quasi-finite} and
Morphisms, Lemma \ref{morphisms-lemma-composition-quasi-finite}
we see that $T_1 \to \Spec(\mathcal{O})$
is locally quasi-finite.
As $\mathcal{O}$ is strictly henselian, we can apply More on Morphisms, Lemma
\ref{more-morphisms-lemma-etale-makes-quasi-finite-finite-at-point}
to see that after replacing $T_1$ by an open and closed neighbourhood
of $t_1$ we may assume that $T_1 \to \Spec(\mathcal{O})$
is finite. Let $\theta \in |X_{\Spec(\mathcal{O})}|$ be the image of
$\xi_1$ and let $y' \in \Spec(\mathcal{O})$ be the image
of $t_1'$. By Divisors on Spaces, Lemma
\ref{spaces-divisors-lemma-base-change-relative-assassin}
we see that $\theta \in
\text{Ass}_{X_{\mathcal{O}_{Y, \overline{y}}}/\Spec\mathcal{O}}
(\mathcal{F})$.
Since $\pi : X_{T_1} \to X_{\Spec(\mathcal{O})}$
is finite, it induces a closed map $|X_{T_1}| \to |X_{\Spec(\mathcal{O})}|$.
Hence the image of $\overline{\{\xi_1\}}$ is $\overline{\{\theta\}}$.
It follows that $(\Spec(\mathcal{O}), y' \leadsto \overline{y}, \theta)$
is an impurity of $\mathcal{F}$ above $y$ and the proof is complete.
\end{proof}















\section{Flat finite type modules}
\label{section-finite-type-flat}

\noindent
Please compare with
More on Flatness, Sections
\ref{flat-section-finite-type-flat-I},
\ref{flat-section-finite-type-flat-II}, and
\ref{flat-section-finite-type-flat-III}.
Most of these results have immediate consequences
of algebraic spaces by \'etale localization.

\begin{lemma}
\label{lemma-bourbaki-finite-type-general-base-at-point}
Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism of algebraic spaces over $S$ which is
locally of finite type. Let $x \in |X|$ with image $y \in |Y|$.
Let $\mathcal{F}$ be a finite type quasi-coherent sheaf on $X$.
Let $\mathcal{G}$ be a quasi-coherent sheaf on $Y$.
If $\mathcal{F}$ is flat at $x$ over $Y$, then
$$
x \in \text{WeakAss}_X(\mathcal{F} \otimes_{\mathcal{O}_X} f^*\mathcal{G})
\Leftrightarrow
y \in \text{WeakAss}_Y(\mathcal{G})
\text{ and }
x \in \text{Ass}_{X/Y}(\mathcal{F}).
$$
\end{lemma}

\begin{proof}
Choose a commutative diagram
$$
\xymatrix{
U \ar[d] \ar[r]_g & V \ar[d] \\
X \ar[r]^f & Y
}
$$
where $U$ and $V$ are schemes and the vertical arrows are surjective \'etale.
Choose $u \in U$ mapping to $x$. Let $\mathcal{E} = \mathcal{F}|_U$
and $\mathcal{H} = \mathcal{G}|_V$.
Let $v \in V$ be the image of $u$. Then
$x \in \text{WeakAss}_X(\mathcal{F} \otimes_{\mathcal{O}_X} f^*\mathcal{G})$
if and only if
$u \in \text{WeakAss}_X(\mathcal{E} \otimes_{\mathcal{O}_X} g^*\mathcal{H})$
by Divisors on Spaces, Definition
\ref{spaces-divisors-definition-weakly-associated}.
Similarly, $y \in \text{WeakAss}_Y(\mathcal{G})$ if and only if
$v \in \text{WeakAss}_V(\mathcal{H})$.
Finally, we have $x \in \text{Ass}_{X/Y}(\mathcal{F})$ if and only if
$u \in \text{Ass}_{U_v}(\mathcal{E}|_{U_v})$ by
Divisors on Spaces, Definition
\ref{spaces-divisors-definition-relative-weak-assassin}.
Observe that flatness of $\mathcal{F}$ at $x$ is
equivalent to flatness of $\mathcal{E}$ at $u$, see
Morphisms of Spaces, Definition \ref{spaces-morphisms-definition-flat-module}.
The equivalence for $g : U \to V$, $\mathcal{E}$, $\mathcal{H}$, $u$, and $v$
is More on Flatness, Lemma
\ref{flat-lemma-bourbaki-finite-type-general-base-at-point}.
\end{proof}

\begin{lemma}
\label{lemma-bourbaki-finite-type-general-base}
Let $S$ be a scheme. Let $f : X \to Y$ be a morphism of algebraic spaces
over $S$ which is locally of finite type.
Let $\mathcal{F}$ be a finite type quasi-coherent sheaf on $X$
which is flat over $Y$. Let $\mathcal{G}$ be a quasi-coherent sheaf on $Y$.
Then we have
$$
\text{WeakAss}_X(\mathcal{F} \otimes_{\mathcal{O}_X} f^*\mathcal{G}) =
\text{Ass}_{X/Y}(\mathcal{F}) \cap
|f|^{-1}(\text{WeakAss}_Y(\mathcal{G}))
$$
\end{lemma}

\begin{proof}
Immediate consequence of
Lemma \ref{lemma-bourbaki-finite-type-general-base-at-point}.
\end{proof}







\section{Flattening functors}
\label{section-F-zero}

\noindent
This section is the analogue of
More on Flatness, Section \ref{flat-section-flattening-functors}.
We urge the reader to skip this section on a first reading.

\begin{situation}
\label{situation-iso}
Let $S$ be a scheme.
Let $f : X \to B$ be a morphism of algebraic spaces over $S$.
Let $u : \mathcal{F} \to \mathcal{G}$ be a homomorphism of
quasi-coherent $\mathcal{O}_X$-modules. For any scheme $T$ over
$B$ we will denote $u_T : \mathcal{F}_T \to \mathcal{G}_T$ the
base change of $u$ to $T$, in other words, $u_T$ is the pullback
of $u$ via the projection morphism $X_T = X \times_B T \to X$.
In this situation we can consider the functor
\begin{equation}
\label{equation-iso}
F_{iso} : (\Sch/B)^{opp} \longrightarrow \textit{Sets}, \quad
T \longrightarrow \left\{
\begin{matrix}
\{*\} & \text{if }u_T\text{ is an isomorphism}, \\
\emptyset & \text{else.}
\end{matrix}
\right.
\end{equation}
There are variants $F_{inj}$, $F_{surj}$, $F_{zero}$ where we ask that
$u_T$ is injective, surjective, or zero.
\end{situation}

\noindent
In Situation \ref{situation-iso} we sometimes think of the functors
$F_{iso}$, $F_{inj}$, $F_{surj}$, and $F_{zero}$ as functors
$(\Sch/S)^{opp} \to \textit{Sets}$ endowed with a morphism
$F_{iso} \to B$, $F_{inj} \to B$, $F_{surj} \to B$, and $F_{zero} \to B$.
Namely, if $T$ is a scheme over $S$, then an element $h \in F_{iso}(T)$
is just a morphism $h : T \to B$, i.e., an element $h \in B(T)$,
such that the base change of $u$ via $h$ is an isomorphism.
In particular, when we say
that $F_{iso}$ is an algebraic space, we mean that the corresponding
functor $(\Sch/S)^{opp} \to \textit{Sets}$ is an algebraic space.

\begin{lemma}
\label{lemma-iso-sheaf}
In Situation \ref{situation-iso}.
Each of the functors $F_{iso}$, $F_{inj}$, $F_{surj}$, $F_{zero}$
satisfies the sheaf property for the fpqc topology.
\end{lemma}

\begin{proof}
Let $\{T_i \to T\}_{i \in I}$ be an fpqc covering of schemes over $B$.
Set $X_i = X_{T_i} = X \times_S T_i$ and $u_i = u_{T_i}$.
Note that $\{X_i \to X_T\}_{i \in I}$ is an fpqc covering of $X_T$, see
Topologies on Spaces, Lemma \ref{spaces-topologies-lemma-fpqc}.
In particular, for every $x \in |X_T|$ there exists an $i \in I$
and an $x_i \in |X_i|$ mapping to $x$. Since
$\mathcal{O}_{X_T, \overline{x}} \to \mathcal{O}_{X_i, \overline{x_i}}$
is flat, hence faithfully flat (see
Morphisms of Spaces, Section \ref{spaces-morphisms-section-flat}).
we conclude that $(u_i)_{x_i}$ is injective, surjective, bijective, or zero
if and only if $(u_T)_x$ is injective, surjective, bijective, or zero.
The lemma follows.
\end{proof}

\begin{lemma}
\label{lemma-iso-go-up}
In Situation \ref{situation-iso} let $X' \to X$ be a flat morphism
of algebraic spaces. Denote $u' : \mathcal{F}' \to \mathcal{G}'$
the pullback of $u$ to $X'$. Denote $F'_{iso}$, $F'_{inj}$, $F'_{surj}$,
$F'_{zero}$ the functors on $\Sch/B$ associated to $u'$.
\begin{enumerate}
\item If $\mathcal{G}$ is of finite type and the image of $|X'| \to |X|$
contains the support of $\mathcal{G}$, then $F_{surj} = F'_{surj}$
and $F_{zero} = F'_{zero}$.
\item If $\mathcal{F}$ is of finite type and the image of $|X'| \to |X|$
contains the support of $\mathcal{F}$, then $F_{inj} = F'_{inj}$
and $F_{zero} = F'_{zero}$.
\item If $\mathcal{F}$ and $\mathcal{G}$ are of finite type and the image of
$|X'| \to |X|$ contains the supports of $\mathcal{F}$ and $\mathcal{G}$,
then $F_{iso} = F'_{iso}$.
\end{enumerate}
\end{lemma}

\begin{proof}
let $v : \mathcal{H} \to \mathcal{E}$ be a map of quasi-coherent
modules on an algebraic space $Y$ and let $\varphi : Y' \to Y$ be a
surjective flat morphism of algebraic spaces, then $v$ is
an isomorphism, injective, surjective, or zero if and only if $\varphi^*v$ is
an isomorphism, injective, surjective, or zero. Namely,
for every $y \in |Y|$ there exists a $y' \in |Y'|$ and the map
of local rings
$\mathcal{O}_{Y, \overline{y}} \to \mathcal{O}_{Y', \overline{y'}}$
is faithfully flat (see
Morphisms of Spaces, Section \ref{spaces-morphisms-section-flat}).
Of course, to check for injectivity or being zero it suffices to look
at the points in the support of $\mathcal{H}$, and to check for
surjectivity it suffices to look at points in the support of $\mathcal{E}$.
Moreover, under the finite type assumptions as in the statement of
the lemma, taking the supports commutes with base change, see
Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-support-finite-type}.
Thus the lemma is clear.
\end{proof}

\noindent
Recall that we've defined the scheme theoretic support of a finite
type quasi-coherent module in Morphisms of Spaces, Definition
\ref{spaces-morphisms-definition-scheme-theoretic-support}.

\begin{lemma}
\label{lemma-iso-limits}
In Situation \ref{situation-iso}.
\begin{enumerate}
\item If $\mathcal{G}$ is of finite type and the scheme theoretic support
of $\mathcal{G}$ is quasi-compact over $B$, then $F_{surj}$ is limit
preserving.
\item If $\mathcal{F}$ of finite type and the scheme theoretic support
of $\mathcal{F}$ is quasi-compact over $B$, then
$F_{zero}$ is limit preserving.
\item If $\mathcal{F}$ is of finite type,
$\mathcal{G}$ is of finite presentation, and the
scheme theoretic supports of $\mathcal{F}$ and $\mathcal{G}$ are
quasi-compact over $B$, then $F_{iso}$ is limit preserving.
\end{enumerate}
\end{lemma}

\begin{proof}
Proof of (1). Let $i : Z \to X$ be the scheme theoretic support of
$\mathcal{G}$ and think of $\mathcal{G}$ as a finite type quasi-coherent
module on $Z$. We may replace $X$ by $Z$ and $u$ by the map
$i^*\mathcal{F} \to \mathcal{G}$ (details omitted). Hence we may assume
$f$ is quasi-compact and $\mathcal{G}$ of finite type.
Let $T = \lim_{i \in I} T_i$ be a directed limit of affine $B$-schemes
and assume that $u_T$ is surjective.
Set $X_i = X_{T_i} = X \times_S T_i$ and
$u_i = u_{T_i} : \mathcal{F}_i = \mathcal{F}_{T_i}
\to \mathcal{G}_i = \mathcal{G}_{T_i}$.
To prove (1) we have to show that $u_i$ is surjective for some $i$.
Pick $0 \in I$ and replace $I$ by $\{i \mid i \geq 0\}$.
Since $f$ is quasi-compact we see $X_0$ is quasi-compact.
Hence we may choose a surjective \'etale morphism $\varphi_0 : W_0 \to X_0$
where $W_0$ is an affine scheme. Set $W = W_0 \times_{T_0} T$
and $W_i = W_0 \times_{T_0} T_i$ for $i \geq 0$.  These
are affine schemes endowed
with a surjective \'etale morphisms $\varphi : W \to X_T$ and
$\varphi_i : W_i \to X_i$. Note that $W = \lim W_i$.
Hence $\varphi^*u_T$ is surjective and it suffices to prove that
$\varphi_i^*u_i$ is surjective for some $i$. Thus we have reduced
the problem to the affine case which is
Algebra, Lemma \ref{algebra-lemma-module-map-property-in-colimit} part (2).

\medskip\noindent
Proof of (2). Assume $\mathcal{F}$ is of finite type with scheme theoretic
support $Z \subset B$ quasi-compact over $B$. Let $T = \lim_{i \in I} T_i$
be a directed limit of affine $B$-schemes and assume that $u_T$ is zero.
Set $X_i = T_i \times_B X$ and denote $u_i : \mathcal{F}_i \to \mathcal{G}_i$
the pullback. Choose $0 \in I$ and replace $I$ by
$\{i \mid i \geq 0\}$. Set $Z_0 = Z \times_X X_0$. By
Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-support-finite-type}
the support of $\mathcal{F}_i$ is $|Z_0|$. Since $|Z_0|$ is quasi-compact
we can find an affine scheme $W_0$ and an \'etale morphism $W_0 \to X_0$
such that $|Z_0| \subset \Im(|W_0| \to |X_0|)$.
Set $W = W_0 \times_{T_0} T$ and $W_i = W_0 \times_{T_0} T_i$ for $i \geq 0$.
These are affine schemes endowed
with \'etale morphisms $\varphi : W \to X_T$ and
$\varphi_i : W_i \to X_i$. Note that $W = \lim W_i$
and that the support of $\mathcal{F}_T$ and $\mathcal{F}_i$
is contained in the image of $|W| \to |X_T|$ and $|W_i| \to |X_i|$.
Now $\varphi^*u_T$ is injective and it suffices to prove that
$\varphi_i^*u_i$ is injective for some $i$.
Thus we have reduced the problem to the affine case which is
Algebra, Lemma \ref{algebra-lemma-module-map-property-in-colimit} part (1).

\medskip\noindent
Proof of (3). This can be proven in exactly the same manner as in the
previous two paragraphs using
Algebra, Lemma \ref{algebra-lemma-module-map-property-in-colimit} part (3).
We can also deduce it from (1) and (2) as follows.
Let $T = \lim_{i \in I} T_i$ be a directed limit of affine $B$-schemes
and assume that $u_T$ is an isomorphism. By part (1) there exists
an $0 \in I$ such that $u_{T_0}$ is surjective. Set
$\mathcal{K} = \Ker(u_{T_0})$ and consider the map of quasi-coherent
modules $v : \mathcal{K} \to \mathcal{F}_{T_0}$. For $i \geq 0$ the base
change $v_{T_i}$ is zero if and only if $u_i$ is an isomorphism. Moreover,
$v_T$ is zero. Since $\mathcal{G}_{T_0}$
is of finite presentation, $\mathcal{F}_{T_0}$ is of finite type, and
$u_{T_0}$ is surjective we conclude that $\mathcal{K}$ is of finite type
(Modules on Sites, Lemma
\ref{sites-modules-lemma-kernel-surjection-finite-onto-finite-presentation}).
It is clear that the support of $\mathcal{K}$ is contained in the
support of $\mathcal{F}_{T_0}$ which is quasi-compact over $T_0$.
Hence we can apply part (2) to see that $v_{T_i}$ is zero for some $i$.
\end{proof}

\begin{lemma}
\label{lemma-F-zero-somewhat-closed}
Let $S = \Spec(R)$ be an affine scheme. Let $X$ be an algebraic space over
$S$. Let $u : \mathcal{F} \to \mathcal{G}$ be a map of quasi-coherent
$\mathcal{O}_X$-modules. Assume $\mathcal{G}$ flat over $S$. Let $T \to S$
be a quasi-compact morphism of schemes such that the base change $u_T$ is
zero. Then exists a closed subscheme $Z \subset S$ such that
(a) $T \to S$ factors through $Z$ and (b) the base change $u_Z$ is zero.
If $\mathcal{F}$ is a finite type $\mathcal{O}_X$-module and
the scheme theoretic support of $\mathcal{F}$ is quasi-compact,
then we can take $Z \to S$ of finite presentation.
\end{lemma}

\begin{proof}
Let $U \to X$ be a surjective \'etale morphism of algebraic spaces
where $U = \coprod U_i$ is a disjoint union of affine schemes (see
Properties of Spaces, Lemma
\ref{spaces-properties-lemma-cover-by-union-affines}).
By Lemma \ref{lemma-iso-go-up} we see that we may
replace $X$ by $U$. In other words, we may assume that $X = \coprod X_i$
is a disjoint union of affine schemes $X_i$. Suppose that we can prove
the lemma for $u_i = u|_{X_i}$. Then we find a closed subscheme
$Z_i \subset S$ such that $T \to S$ factors through $Z_i$ and
$u_{i, Z_i}$ is zero. If
$Z_i = \Spec(R/I_i) \subset \Spec(R) = S$, then taking
$Z = \Spec(R/\sum I_i)$ works. Thus we may assume that
$X = \Spec(A)$ is affine.

\medskip\noindent
Choose a finite affine open covering $T = T_1 \cup \ldots \cup T_m$.
It is clear that we may replace $T$ by $\coprod_{j = 1, \ldots, m} T_j$.
Hence we may assume $T$ is affine. Say $T = \Spec(R')$.
Let $u : M \to N$ be the homomorphisms of $A$-modules
corresponding to $u : \mathcal{F} \to \mathcal{G}$.
Then $N$ is a flat $R$-module as $\mathcal{G}$ is flat over $S$.
The assumption of the lemma means that the composition
$$
M \otimes_R R' \to N \otimes_R R'
$$
is zero. Let $z \in M$. By Lazard's theorem
(Algebra, Theorem \ref{algebra-theorem-lazard}) and the fact
that $\otimes$ commutes with colimits we can find free $R$-module
$F_z$, an element $\tilde z \in F_z$, and a map $F_z \to N$ such that
$u(z)$ is the image of $\tilde z$ and $\tilde z$ maps to zero in
$F_z \otimes_R R'$. Choose a basis $\{e_{z, \alpha}\}$ of $F_z$ and write
$\tilde z = \sum f_{z, \alpha} e_{z, \alpha}$ with $f_{z, \alpha} \in R$.
Let $I \subset R$ be the ideal generated by the elements $f_{z, \alpha}$
with $z$ ranging over all elements of $M$.
By construction $I$ maps to zero in $R'$ and the elements $\tilde z$
map to zero in $F_z/IF_z$ whence in $N/IN$. Thus $Z = \Spec(R/I)$
is a solution to the problem in this case.

\medskip\noindent
Assume $\mathcal{F}$ is of finite type with quasi-compact scheme
theoretic support. Write $Z = \Spec(R/I)$.
Write $I = \bigcup I_\lambda$ as a filtered union of finitely generated
ideals. Set $Z_\lambda = \Spec(R/I_\lambda)$, so $Z = \colim Z_\lambda$.
Since $u_Z$ is zero, we see that $u_{Z_\lambda}$ is zero
for some $\lambda$ by Lemma \ref{lemma-iso-limits}.
This finishes the proof of the lemma.
\end{proof}

\begin{lemma}
\label{lemma-F-zero-module-map}
Let $A$ be a ring. Let $u : M \to N$ be a map of $A$-modules.
If $N$ is projective as an $A$-module, then there exists an ideal
$I \subset A$ such that for any ring map $\varphi : A \to B$
the following are equivalent
\begin{enumerate}
\item $u \otimes 1 : M \otimes_A B \to N \otimes_A B$ is zero, and
\item $\varphi(I) = 0$.
\end{enumerate}
\end{lemma}

\begin{proof}
As $M$ is projective we can find a projective $A$-module $C$
such that $F = N \oplus C$ is a free $R$-module.
By replacing $u$ by $u \oplus 1 : F = M \oplus C \to N \oplus C$
we see that we may assume $N$ is free. In this case let $I$ be
the ideal of $A$ generated by coefficients of all the elements of
$\Im(u)$ with respect to some (fixed) basis of $N$.
\end{proof}

\noindent
It would be interesting to find a simple direct proof of the following
lemma using the result of Lemma \ref{lemma-F-zero-somewhat-closed}.
A ``classical'' proof of this lemma when $f : X \to B$ is a projective
morphism and $B$ a Noetherian scheme would be: (a) choose a relatively ample
invertible sheaf $\mathcal{O}_X(1)$, (b) set
$u_n : f_*\mathcal{F}(n) \to f_*\mathcal{G}(n)$,
(c) observe that $f_*\mathcal{G}(n)$ is a finite locally free sheaf
for all $n \gg 0$, and (d) $F_{zero}$ is represented by the vanishing
locus of $u_n$ for some $n \gg 0$.

\begin{lemma}
\label{lemma-F-zero-closed}
In Situation \ref{situation-iso}. Assume
\begin{enumerate}
\item $f$ is locally of finite presentation,
\item $\mathcal{G}$ is an $\mathcal{O}_X$-module of finite presentation
flat over $B$,
\item the scheme theoretic support of $\mathcal{G}$ is proper over $B$.
\end{enumerate}
Then the functor $F_{zero}$ is an algebraic space and $F_{zero} \to B$
is a closed immersion. If $\mathcal{F}$ is of finite type, then
$F_{zero} \to B$ is of finite presentation.
\end{lemma}

\begin{proof}
In order to prove that $F_{zero}$ is an algebraic space, it suffices
to show that $F_{zero} \to B$ is representable, see
Spaces, Lemma \ref{spaces-lemma-representable-over-space}.
Let $B' \to B$ be a morphism where $B'$ is a scheme and let
$u' : \mathcal{F}' \to \mathcal{G}'$ be the pullback of $u$ to $X' = X_{B'}$.
Then the associated functor $F'_{zero}$ equals $F_{zero} \times_B B'$.
This reduces us to the case that $B$ is a scheme.

\medskip\noindent
Assume $B$ is a scheme. We will show that $F_{zero}$ is representable
by a closed subscheme of $B$. By Lemma \ref{lemma-iso-sheaf} and
Descent, Lemmas \ref{descent-lemma-closed-immersion} and
\ref{descent-lemma-descent-data-sheaves}
the question is local for the \'etale topology on $B$. Let $b \in B$.
We first replace $B$ by an affine neighbourhood of $b$.
Denote $Z \subset X$ the scheme theoretic support of $\mathcal{G}$.
Denote $Z_b \subset X_b$ the fibre of $Z \subset X \to B$ over $b$.
The space $|Z_b|$ is quasi-compact by the last assumption of the lemma.
Choose an affine scheme $U$ and an \'etale morphism $\varphi : U \to X$
such that $|Z_b| \subset \Im(|U| \to |X|)$. After replacing $B$ by an
affine elementary \'etale neighbourhood of $b$ and replacing $U$
by some affine $U'$ \'etale over $U$ with $U'_b \to U_b$ surjective,
we may assume that $\Gamma(U, \varphi^*\mathcal{G})$ is a projective
$\Gamma(B, \mathcal{O}_B)$-module, see
More on Flatness, Lemma \ref{flat-lemma-finite-presentation-flat-along-fibre}.
Since $Z \to B$ is proper the image of
$$
|Z| \setminus \Im(|U| \to |X|)
$$
in $|B|$ is a closed subset not containing $b$. Hence, after replacing
$B$ by an affine open containing $b$, we may assume that
$|Z| \subset \Im(|U| \to |X|)$. (To be sure, after this replacement
it is still true that $\Gamma(U, \varphi^*\mathcal{G})$ is a projective
$\Gamma(B, \mathcal{O}_B)$-module.) By Lemma \ref{lemma-iso-go-up}
we see that $F_{zero}$ is the same as the corresponding functor
for the map $\varphi^*\mathcal{F} \to \varphi^*\mathcal{G}$.
This case follows immediately from Lemma \ref{lemma-F-zero-module-map}.

\medskip\noindent
We still have to show that $F_{zero} \to B$ is of finite presentation if
$\mathcal{F}$ is of finite type. Let $\mathcal{F}' \subset \mathcal{G}$
be the image of $u$ and denote $F'_{zero}$ the functor corresponding
to $\mathcal{F}' \to \mathcal{G}$. Then $F_{zero} = F'_{zero}$ and
the scheme theoretic support of $\mathcal{F}'$ is a closed subspace of
the scheme theoretic support of $\mathcal{G}$, hence proper over $B$.
Thus Lemma \ref{lemma-iso-limits} implies that $F_{zero} = F'_{zero}$
is limit preserving over $B$. We conclude by Limits of Spaces, Proposition
\ref{spaces-limits-proposition-characterize-locally-finite-presentation}.
\end{proof}

\noindent
The following result is a variant of
More on Flatness, Theorem \ref{flat-theorem-flattening-map}.

\begin{lemma}
\label{lemma-F-iso-closed}
In Situation \ref{situation-iso}. Assume
\begin{enumerate}
\item $f$ is locally of finite presentation,
\item $\mathcal{F}$ is locally of finite presentation and flat over $B$,
\item the scheme theoretic support of $\mathcal{F}$ is proper over $B$, and
\item $u$ is surjective.
\end{enumerate}
Then the functor $F_{iso}$ is an algebraic space and $F_{iso} \to B$
is a closed immersion. If $\mathcal{G}$ is of finite presentation, then
$F_{iso} \to B$ is of finite presentation.
\end{lemma}

\begin{proof}
Let $\mathcal{K} = \Ker(u)$ and apply Lemma \ref{lemma-F-zero-closed}
to $\mathcal{K} \to \mathcal{F}$. Note that $\mathcal{K}$ is of finite type
if $\mathcal{G}$ is of finite presentation, see
Modules on Sites, Lemma
\ref{sites-modules-lemma-kernel-surjection-finite-onto-finite-presentation}.
\end{proof}

\noindent
We will use the following (easy) result when discussing the Quot functor.

\begin{lemma}
\label{lemma-F-surj-open}
In Situation \ref{situation-iso}. Assume
\begin{enumerate}
\item $f$ is locally of finite presentation,
\item $\mathcal{G}$ is of finite type,
\item the scheme theoretic support of $\mathcal{G}$ is proper over $B$.
\end{enumerate}
Then $F_{surj}$ is an algebraic space and $F_{surj} \to B$
is an open immersion.
\end{lemma}

\begin{proof}
Consider $\Coker(u)$. Observe that
$\Coker(u_T) = \Coker(u)_T$ for any $T/B$.
Note that formation of the support of a finite type
quasi-coherent module commutes with pullback
(Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-support-covering}).
Hence $F_{surj}$ is representable by the open subspace of $B$
corresponding to the open set
$$
|B| \setminus |f|(\text{Supp}(\Coker(u)))
$$
see Properties of Spaces, Lemma \ref{spaces-properties-lemma-open-subspaces}.
This is an open because $|f|$ is closed on $\text{Supp}(\mathcal{G})$
and $\text{Supp}(\Coker(u))$ is a closed subset of
$\text{Supp}(\mathcal{G})$.
\end{proof}











\input{chapters}


\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}
