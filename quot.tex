\input{preamble}

% OK, start here.
%
\begin{document}

\title{Quot and Hilbert Spaces}

\maketitle

\phantomsection
\label{section-phantom}

\tableofcontents




\section{Introduction}
\label{section-introduction}

\noindent
The purpose of this chapter is to write about Quot and Hilbert functors
and to prove that these are algebraic spaces provided certain technical
conditions are satisfied. In this chapter we will discuss this in the
setting of algebraic space. A reference is Grothendieck's lectures, see
\cite{Gr-I},
\cite{Gr-II},
\cite{Gr-III},
\cite{Gr-IV},
\cite{Gr-V}, and
\cite{Gr-VI}.
Another reference is the paper \cite{olsson-starr}; this paper discusses
the more general case of Quot and Hilbert spaces associated to a morphism
of algebraic stacks which we will discuss in another chapter, see
(insert future reference here).

\medskip\noindent
In the case of Hilbert spaces there is a more general notion of
``Hilbert stacks'' which we will discuss in a separate chapter, see
(insert future reference here).

\medskip\noindent
We have intentionally placed this chapter, as well as the chapters
``Examples of Stacks'', ``Sheaves on Algebraic Stacks'',
``Criteria for Representability'', and ``Artin's Axioms'' before the
general development of the theory of algebraic stacks. The reason
for this is that starting with the next chapter (see
Properties of Stacks, Section \ref{stacks-properties-section-conventions})
we will no longer distinguish between a scheme and the algebraic stack
it gives rise to. Thus our language will become more flexible and
easier for a human to parse, but also less precise. These first few
chapters, including the initial chapter ``Algebraic Stacks'', lay the
groundwork that later allow us to ignore some of the very technical
distinctions between different ways of thinking about algebraic stacks.
But especially in the chapters ``Artin's Axioms'' and
``Criteria of Representability'' we need
to be very precise about what objects exactly we are working with, as
we are trying to show that certain constructions produce algebraic stacks or
algebraic spaces.

\medskip\noindent
Unfortunately, this means that some of the notation, conventions and
terminology is awkward and may seem backwards to the more experienced
reader. We hope the reader will forgive us!





\section{Conventions}
\label{section-conventions}

\noindent
The standing assumption is that all schemes are contained in
a big fppf site $\Sch_{fppf}$. And all rings $A$ considered
have the property that $\Spec(A)$ is (isomorphic) to an
object of this big site.

\medskip\noindent
Let $S$ be a scheme and let $X$ be an algebraic space over $S$.
In this chapter and the following we will write $X \times_S X$
for the product of $X$ with itself (in the category of algebraic
spaces over $S$), instead of $X \times X$.















\section{The Hom functor}
\label{section-hom}

\noindent
In this section we study the functor of homomorphisms defined below.

\begin{situation}
\label{situation-hom}
Let $S$ be a scheme. Let $f : X \to B$ be a morphism of algebraic spaces
over $S$. Let $\mathcal{F}$, $\mathcal{G}$ be quasi-coherent
$\mathcal{O}_X$-modules. For any scheme $T$ over $B$ we will denote
$\mathcal{F}_T$ and $\mathcal{G}_T$ the base changes of
$\mathcal{F}$ and $\mathcal{G}$ to $T$, in other words, the pullbacks
via the projection morphism $X_T = X \times_B T \to X$.
We consider the functor
\begin{equation}
\label{equation-hom}
\mathit{Hom}(\mathcal{F}, \mathcal{G}) :
(\Sch/B)^{opp}
\longrightarrow
\textit{Sets},\quad
T
\longrightarrow
\Hom_{\mathcal{O}_{X_T}}(\mathcal{F}_T, \mathcal{G}_T)
\end{equation}
\end{situation}

\noindent
In Situation \ref{situation-hom} we sometimes think of
$\mathit{Hom}(\mathcal{F}, \mathcal{G})$ as a functor
$(\Sch/S)^{opp} \to \textit{Sets}$
endowed with a morphism
$\mathit{Hom}(\mathcal{F}, \mathcal{G}) \to B$.
Namely, if $T$ is a scheme over $S$, then an element of
$\mathit{Hom}(\mathcal{F}, \mathcal{G})(T)$ consists of a pair
$(h, u)$, where $h$ is a morphism $h : T \to B$ and
$u : \mathcal{F}_T \to \mathcal{G}_T$ is an $\mathcal{O}_{X_T}$-module
map where $X_T = T \times_{h, B} X$ and $\mathcal{F}_T$ and $\mathcal{G}_T$
are the pullbacks to $X_T$. In particular, when we say
that $\mathit{Hom}(\mathcal{F}, \mathcal{G})$ is an algebraic space,
we mean that the corresponding functor
$(\Sch/S)^{opp} \to \textit{Sets}$ is an algebraic space.

\begin{lemma}
\label{lemma-hom-sheaf}
In Situation \ref{situation-hom} the functor
$\mathit{Hom}(\mathcal{F}, \mathcal{G})$ 
satisfies the sheaf property for the fpqc topology.
\end{lemma}

\begin{proof}
Let $\{T_i \to T\}_{i \in I}$ be an fpqc covering of schemes over $B$.
Set $X_i = X_{T_i} = X \times_S T_i$ and $\mathcal{F}_i = u_{T_i}$
and $\mathcal{G}_i = \mathcal{G}_{T_i}$.
Note that $\{X_i \to X_T\}_{i \in I}$ is an fpqc covering of $X_T$, see
Topologies on Spaces, Lemma \ref{spaces-topologies-lemma-fpqc}.
Thus a family of maps $u_i : \mathcal{F}_i \to \mathcal{G}_i$
such that $u_i$ and $u_j$ restrict to the same map on
$X_{T_i \times_T T_j}$ comes from a unique map
$u : \mathcal{F}_T \to \mathcal{G}_T$ by descent
(Descent on Spaces, Proposition
\ref{spaces-descent-proposition-fpqc-descent-quasi-coherent}).
\end{proof}

\begin{remark}
\label{remark-hom-base-change}
In Situation \ref{situation-hom} let $B' \to B$ be a morphism of
algebraic spaces over $S$. Set $X' = X \times_B B'$ and denote
$\mathcal{F}'$, $\mathcal{G}'$ the pullback of
$\mathcal{F}$, $\mathcal{G}$ to $X'$. Then we obtain a functor
$\mathit{Hom}(\mathcal{F}', \mathcal{G}') : (\Sch/B')^{opp} \to \textit{Sets}$
associated to the base change $f' : X' \to B'$. For a scheme $T$ over $B'$
it is clear that we have
$$
\mathit{Hom}(\mathcal{F}', \mathcal{G}')(T) =
\mathit{Hom}(\mathcal{F}, \mathcal{G})(T)
$$
where on the right hand side we think of $T$ as a scheme over $B$
via the composition $T \to B' \to B$. This trivial remark
will occasionally be useful to change the base algebraic space.
\end{remark}

\begin{lemma}
\label{lemma-hom-sheaf-in-X}
In Situation \ref{situation-hom} let $\{X_i \to X\}_{i \in I}$ be an fppf
covering and for each $i, j \in I$ let $\{X_{ijk} \to X_i \times_X X_j\}$
be an fppf covering. Denote $\mathcal{F}_i$, resp.\ $\mathcal{F}_{ijk}$
the pullback of $\mathcal{F}$ to $X_i$, resp.\ $X_{ijk}$. Similarly
define $\mathcal{G}_i$ and $\mathcal{G}_{ijk}$. For every scheme
$T$ over $B$ the diagram
$$
\xymatrix{
\mathit{Hom}(\mathcal{F}, \mathcal{G})(T) \ar[r] &
\prod\nolimits_i
\mathit{Hom}(\mathcal{F}_i, \mathcal{G}_i)(T)
\ar@<1ex>[r]^-{\text{pr}_0^*} \ar@<-1ex>[r]_-{\text{pr}_1^*}
&
\prod\nolimits_{i, j, k}
\mathit{Hom}(\mathcal{F}_{ijk}, \mathcal{G}_{ijk})(T)
}
$$
presents the first arrow as the equalizer of the other two.
\end{lemma}

\begin{proof}
Let $u_i : \mathcal{F}_{i, T} \to \mathcal{G}_{i, T}$ be an element in the
equalizer of $\text{pr}_0^*$ and $\text{pr}_1^*$. Since the base change
of an fppf covering is an fppf covering
(Topologies on Spaces, Lemma \ref{spaces-topologies-lemma-fppf})
we see that $\{X_{i, T} \to X_T\}_{i \in I}$ and
$\{X_{ijk, T} \to X_{i, T} \times_{X_T} X_{j, T}\}$ are fppf coverings.
Applying Descent on Spaces, Proposition
\ref{spaces-descent-proposition-fpqc-descent-quasi-coherent}
we first conclude that $u_i$ and $u_j$ restrict to the same morphism
over $X_{i, T} \times_{X_T} X_{j, T}$, whereupon a second application
shows that there is a unique morphism $u : \mathcal{F}_T \to \mathcal{G}_T$
restricting to $u_i$ for each $i$. This finishes the proof.
\end{proof}

\begin{lemma}
\label{lemma-hom-limits}
In Situation \ref{situation-hom}. If $\mathcal{F}$ is of finite presentation
and $f$ is quasi-compact and quasi-separated, then
$\mathit{Hom}(\mathcal{F}, \mathcal{G})$ is limit preserving.
\end{lemma}

\begin{proof}
Let $T = \lim_{i \in I} T_i$ be a directed limit of affine $B$-schemes.
We have to show that
$$
\mathit{Hom}(\mathcal{F}, \mathcal{G})(T) =
\colim \mathit{Hom}(\mathcal{F}, \mathcal{G})(T_i)
$$
Pick $0 \in I$. We may replace $B$ by $T_0$, $X$ by $X_{T_0}$,
$\mathcal{F}$ by $\mathcal{F}_{T_0}$, $\mathcal{G}$ by
$\mathcal{G}_{T_0}$, and $I$ by $\{i \in I \mid i \geq 0\}$.
See Remark \ref{remark-hom-base-change}.
Thus we may assume $B = \Spec(R)$ is affine.

\medskip\noindent
When $B$ is affine, then $X$ is quasi-compact and quasi-separated.
Choose a surjective \'etale morphism $U \to X$ where $U$ is an
affine scheme (Properties of Spaces, Lemma
\ref{spaces-properties-lemma-quasi-compact-affine-cover}).
Since $X$ is quasi-separated, the scheme $U \times_X U$ is quasi-compact
and we may choose a surjective \'etale morphism $V \to U \times_X U$
where $V$ is an affine scheme. Applying Lemma \ref{lemma-hom-sheaf-in-X}
we see that $\mathit{Hom}(\mathcal{F}, \mathcal{G})$ is the
equalizer of two maps between
$$
\mathit{Hom}(\mathcal{F}|_U, \mathcal{G}|_U)
\quad\text{and}\quad
\mathit{Hom}(\mathcal{F}|_V, \mathcal{G}|_V)
$$
This reduces us to the case that $X$ is affine.

\medskip\noindent
In the affine case the statement of the lemma reduces to
the following problem: Given a ring map $R \to A$, two $A$-modules
$M$, $N$ and a directed system of $R$-algebras $C = \colim C_i$.
When is it true that the map
$$
\colim \Hom_{A \otimes_R C_i}(M \otimes_R C_i, N \otimes_R C_i)
\longrightarrow
\Hom_{A \otimes_R C}(M \otimes_R C, N \otimes_R C)
$$
is bijective? By
Algebra, Lemma \ref{algebra-lemma-module-map-property-in-colimit}
this holds if $M \otimes_R C$ is of finite presentation over
$A \otimes_R C$, i.e., when $M$ is of finite presentation over $A$.
\end{proof}

\begin{lemma}
\label{lemma-hom-closed}
Let $S$ be a scheme. Let $B$ be an algebraic space over $S$.
Let $i : X' \to X$ be a closed immersion of algebraic spaces
over $B$. Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module
and let $\mathcal{G}'$ be a quasi-coherent $\mathcal{O}_{X'}$-module.
Then
$$
\mathit{Hom}(\mathcal{F}, i_*\mathcal{G}') =
\mathit{Hom}(i^*\mathcal{F}, \mathcal{G}')
$$
as functors on $(\Sch/B)$.
\end{lemma}

\begin{proof}
Let $g : T \to B$ be a morphism where $T$ is a scheme.
Denote $i_T : X'_T \to X_T$ the base change of $i$.
Denote $h : X_T \to X$ and $h' : X'_T \to X'$ the projections.
Observe that $(h')^*i^*\mathcal{F} = i_T^*h^*\mathcal{F}$.
As a closed immersion is affine
(Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-closed-immersion-affine})
we have $h^*i_*\mathcal{G} = i_{T, *}(h')^*\mathcal{G}$ by
Cohomology of Spaces, Lemma \ref{spaces-cohomology-lemma-affine-base-change}.
Thus we have
\begin{align*}
\mathit{Hom}(\mathcal{F}, i_*\mathcal{G}')(T)
& =
\Hom_{\mathcal{O}_{X_T}}(h^*\mathcal{F}, h^*i_*\mathcal{G}') \\
& =
\Hom_{\mathcal{O}_{X_T}}(h^*\mathcal{F}, i_{T, *}(h')^*\mathcal{G}) \\
& =
\Hom_{\mathcal{O}_{X'_T}}(i_T^*h^*\mathcal{F}, (h')^*\mathcal{G}) \\
& =
\Hom_{\mathcal{O}_{X'_T}}((h')^*i^*\mathcal{F}, (h')^*\mathcal{G}) \\
& =
\mathit{Hom}(i^*\mathcal{F}, \mathcal{G}')(T)
\end{align*}
as desired. The middle equality follows from the adjointness of the functors
$i_{T, *}$ and $i_T^*$.
\end{proof}

\begin{lemma}
\label{lemma-cohomology-perfect-complex}
Let $S$ be a scheme. Let $B$ be an algebraic space over $S$.
Let $K$ be a pseudo-coherent object of $D(\mathcal{O}_B)$.
\begin{enumerate}
\item If for all $g : T \to B$ in $(\Sch/B)$ the cohomology sheaf
$H^{-1}(Lg^*K)$ is zero, then the functor
$$
(\Sch/B)^{opp} \longrightarrow \textit{Sets},\quad
(g : T \to B) \longmapsto H^0(T, H^0(Lg^*K))
$$
is an algebraic space affine and of finite presentation over $B$.
\item If for all $g : T \to B$ in $(\Sch/B)$ the cohomology sheaves
$H^i(Lg^*K)$ are zero for $i < 0$, then $K$ is perfect with tor amplitude
in $[0, b]$ for some $b \geq 0$ and the functor
$$
(\Sch/B)^{opp} \longrightarrow \textit{Sets},\quad
(g : T \to B) \longmapsto H^0(T, Lg^*K)
$$
is an algebraic space affine and of finite presentation over $B$.
\end{enumerate}
\end{lemma}

\begin{proof}
Under the assumptions of (2) we have $H^0(T, Lg^*K) = H^0(T, H^0(Lg^*K))$.
Let us prove that the rule $T \mapsto H^0(T, H^0(Lg^*K))$ satisfies the
sheaf property for the fppf topology. To do this assume we have an
fppf covering $\{h_i : T_i \to T\}$ of a scheme $g : T \to B$ over $B$.
Set $g_i = g \circ h_i$. Note that since $h_i$ is flat, we have
$Lh_i^* = h_i^*$ and $h_i^*$ commutes with taking cohomology. Hence
$$
H^0(T_i, H^0(Lg_i^*K)) =
H^0(T_i, H^0(h_i^*Lg^*K)) =
H^0(T, h_i^*H^0(Lg^*K))
$$
Similarly for the pullback to $T_i \times_T T_j$.
Since $Lg^*K$ is a pseudo-coherent complex on $T$
(Cohomology on Sites, Lemma
\ref{sites-cohomology-lemma-pseudo-coherent-pullback})
the cohomology sheaf $\mathcal{F} = H^0(Lg^*K)$ is quasi-coherent
(Derived Categories of Spaces, Lemma
\ref{spaces-perfect-lemma-pseudo-coherent}).
Hence by Descent on Spaces, Proposition
\ref{spaces-descent-proposition-fpqc-descent-quasi-coherent}
we see that
$$
H^0(T, \mathcal{F}) = \Ker(
\prod H^0(T_i, h_i^*\mathcal{F}) \to
\prod H^0(T_i, h_i^*\mathcal{F}))
$$
In this way we see that the rules in (1) and (2) satisfy
the sheaf property for fppf coverings. This mean we may apply
Bootstrap, Lemma \ref{bootstrap-lemma-locally-algebraic-space-finite-type}
it suffices to prove the representability \'etale locally on $B$. Moreover,
we may check whether the end result is affine and of finite presentation
\'etale locally on $B$, see
Morphisms of Spaces, Lemmas \ref{spaces-morphisms-lemma-affine-local} and
\ref{spaces-morphisms-lemma-finite-presentation-local}.
Hence we may assume that $B$ is an affine scheme.

\medskip\noindent
Assume $B = \Spec(A)$ is an affine scheme. By the results of
Derived Categories of Spaces, Lemmas
\ref{spaces-perfect-lemma-pseudo-coherent},
\ref{spaces-perfect-lemma-derived-quasi-coherent-small-etale-site}, and
\ref{spaces-perfect-lemma-descend-pseudo-coherent}
we deduce that in the rest of the proof we may think of $K$ as a perfect
object of the derived category of complexes of modules on $B$
in the Zariski topology. By 
Derived Categories of Schemes, Lemmas
\ref{perfect-lemma-pseudo-coherent},
\ref{perfect-lemma-affine-compare-bounded}, and
\ref{perfect-lemma-pseudo-coherent-affine} we can find a pseudo-coherent
complex $M^\bullet$ of $A$-modules such that $K$ is the corresponding
object of $D(\mathcal{O}_B)$. Our assumption on pullbacks implies
that $M^\bullet \otimes^\mathbf{L}_A \kappa(\mathfrak p)$
has vanishing $H^{-1}$ for all primes $\mathfrak p \subset A$.
By More on Algebra, Lemma \ref{more-algebra-lemma-cut-complex-in-two}
we can write
$$
M^\bullet =
\tau_{\geq 0}M^\bullet \oplus \tau_{\leq - 1}M^\bullet
$$
with $\tau_{\geq 0}M^\bullet$ perfect with Tor amplitude in $[0, b]$
for some $b \geq 0$ (here we also have used
More on Algebra, Lemmas \ref{more-algebra-lemma-glue-perfect} and
\ref{more-algebra-lemma-glue-tor-amplitude}).
Note that in case (2) we also see that $\tau_{\leq - 1}M^\bullet = 0$
in $D(A)$ whence $M^\bullet$ and $K$ are perfect with
tor amplitude in $[0, b]$. For any $B$-scheme $g : T \to B$ we have
$$
H^0(T, H^0(Lg^*K)) = H^0(T, H^0(Lg^*\tau_{\geq 0}K))
$$
(by the dual of Derived Categories, Lemma
\ref{derived-lemma-negative-vanishing})
hence we may replace $K$ by $\tau_{\geq 0}K$ and correspondingly
$M^\bullet$ by $\tau_{\geq 0}M^\bullet$. In other words, we may
assume $M^\bullet$ has tor amplitude in $[0, b]$.

\medskip\noindent
Assume $M^\bullet$ has tor amplitude in $[0, b]$.
We may assume $M^\bullet$ is a bounded above complex of finite free
$A$-modules (by our definition of pseudo-coherent complexes, see
More on Algebra, Definition \ref{more-algebra-definition-pseudo-coherent}
and the discussion following the definition).
By More on Algebra, Lemma \ref{more-algebra-lemma-last-one-flat}
we see that $M = \Coker(M^{- 1} \to M^0)$ is flat. By
Algebra, Lemma \ref{algebra-lemma-finite-projective} we see that $M$
is finite locally free. Hence $M^\bullet$ is quasi-isomorphic to
$$
M \to M^1 \to M^2 \to \ldots \to M^d \to 0 \ldots
$$
Note that this is a K-flat complex
(Cohomology, Lemma \ref{cohomology-lemma-bounded-flat-K-flat}),
hence derived pullback of $K$ via a morphism $T \to B$ is computed
by the complex
$$
g^*\widetilde{M} \to g^*\widetilde{M^1} \to \ldots
$$
Thus it suffices to show that the functor
$$
(g : T \to B) \longmapsto
\Ker(
\Gamma(T,g^*\widetilde{M})
\to
\Gamma(T, g^*(\widetilde{M^1})
)
$$
is representable by an affine scheme of finite presentation over $B$.

\medskip\noindent
We may still replace $B$ by the members of an affine open covering
in order to prove this last statement. Hence we may assume that $M$
is finite free (recall that $M^1$ is finite free to begin with).
Write $M = A^{\oplus n}$ and $M^1 = A^{\oplus m}$. Let the map
$M \to M^1$ be given by the $m \times n$ matrix $(a_{ij})$ with
coefficients in $A$. Then $\widetilde{M} = \mathcal{O}_B^{\oplus n}$
and $\widetilde{M^1} = \mathcal{O}_B^{\oplus m}$. Thus the functor
above is equal to the functor
$$
(g : T \to B) \longmapsto
\{(f_1, \ldots, f_n) \in \Gamma(T, \mathcal{O}_T) \mid
\sum g^\sharp(a_{ij}f_i) = 0, j = 1, \ldots, m\}
$$
Clearly this is representable by the affine scheme
$$
\Spec\left(A[x_1, \ldots, x_n]/(\sum a_{ij}x_i; j = 1, \ldots, m)\right)
$$
and the lemma has been proved.
\end{proof}

\noindent
The functor $\mathit{Hom}(\mathcal{F}, \mathcal{G})$ is representable in a
number of situations. All of our results will be based on the following
basic case. The proof of this lemma as given below is in some sense the
natural generalization to the proof of \cite[III, Cor 7.7.8]{EGA}.

\begin{lemma}
\label{lemma-noetherian-hom}
In Situation \ref{situation-hom} assume that
\begin{enumerate}
\item $B$ is a Noetherian algebraic space,
\item $f$ is locally of finite type and quasi-separated,
\item $\mathcal{F}$ is a finite type $\mathcal{O}_X$-module, and
\item $\mathcal{G}$ is a finite type $\mathcal{O}_X$-module, flat over $B$,
with support proper over $B$.
\end{enumerate}
Then the functor $\mathit{Hom}(\mathcal{F}, \mathcal{G})$ is
an algebraic space affine and of finite presentation over $B$.
\end{lemma}

\begin{proof}
We may replace $X$ by a quasi-compact open neighbourhood of
the support of $\mathcal{G}$, hence we may assume $X$ is Noetherian.
In this case $X$ and $f$ are quasi-compact and quasi-separated.
Choose an approximation $P \to \mathcal{F}$ by a perfect complex $P$ of
the triple $(X, \mathcal{F}, 0)$, see
Derived Categories of Spaces, Definition
\ref{spaces-perfect-definition-approximation-holds} and
Theorem \ref{spaces-perfect-theorem-approximation}).
Then the induced map
$$
\Hom_{\mathcal{O}_X}(\mathcal{F}, \mathcal{G})
\longrightarrow
\Hom_{D(\mathcal{O}_X)}(P, \mathcal{G})
$$
is an isomorphism because $P \to \mathcal{F}$ induces an isomorphism
$H^0(P) \to \mathcal{F}$ and $H^i(P) = 0$ for $i > 0$.
Moreover, for any morphism $g : T \to B$
denote $h : X_T = T \times_B X \to X$ the projection and set
$P_T = Lh^*P$. Then it is equally true that
$$
\Hom_{\mathcal{O}_{X_T}}(\mathcal{F}_T, \mathcal{G}_T)
\longrightarrow
\Hom_{D(\mathcal{O}_{X_T})}(P_T, \mathcal{G}_T)
$$
is an isomorphism, as $P_T = Lh^*P \to Lh^*\mathcal{F} \to \mathcal{F}_T$
induces an isomorphism $H^0(P_T) \to \mathcal{F}_T$ (because $h^*$ is
right exact and $H^i(P) = 0$ for $i > 0$). Thus it suffices to prove the
result for the functor
$$
T \longmapsto \Hom_{D(\mathcal{O}_{X_T})}(P_T, \mathcal{G}_T).
$$
By the Leray spectral sequence (see Cohomology on Sites, Remark
\ref{sites-cohomology-remark-before-Leray}) we have
$$
\Hom_{D(\mathcal{O}_{X_T})}(P_T, \mathcal{G}_T) =
H^0(X_T, R\SheafHom(P_T, \mathcal{G}_T)) =
H^0(T, Rf_{T, *}R\SheafHom(P_T, \mathcal{G}_T))
$$
where $f_T : X_T \to T$ is the base change of $f$. By
Derived Categories of Spaces, Lemma
\ref{spaces-perfect-lemma-base-change-RHom}
we have
$$
Rf_{T, *}R\SheafHom(P_T, \mathcal{G}_T) = Lg^*Rf_*R\SheafHom(P, \mathcal{G}).
$$
By
Derived Categories of Spaces, Lemma
\ref{spaces-perfect-lemma-compute-ext-perfect}
the object $K = Rf_*R\SheafHom(P, \mathcal{G})$ of $D(\mathcal{O}_B)$
is perfect. This means we can apply
Lemma \ref{lemma-cohomology-perfect-complex}
as long as we can prove that the cohomology sheaf
$H^i(Lg^*K)$ is $0$ for all $i < 0$ and $g : T \to B$ as above.
This is clear from the last displayed formula as
the cohomology sheaves of
$Rf_{T, *}R\SheafHom(P_T, \mathcal{G}_T)$
are zero in negative degrees
due to the fact that $R\SheafHom(P_T, \mathcal{G}_T)$ has vanishing
cohomology sheaves in negative degrees as $P_T$ is perfect with
vanishing cohomology sheaves in positive degrees.
\end{proof}

\noindent
Here is a cheap consequence of Lemma \ref{lemma-noetherian-hom}.

\begin{proposition}
\label{proposition-hom}
In Situation \ref{situation-hom} assume that
\begin{enumerate}
\item $f$ is of finite presentation, and
\item $\mathcal{G}$ is a finitely presented $\mathcal{O}_X$-module,
flat over $B$, with support proper over $B$.
\end{enumerate}
Then the functor $\mathit{Hom}(\mathcal{F}, \mathcal{G})$ is
an algebraic space affine over $B$. If $\mathcal{F}$
is of finite presentation, then $\mathit{Hom}(\mathcal{F}, \mathcal{G})$
is of finite presentation over $B$.
\end{proposition}

\begin{proof}
By Lemma \ref{lemma-hom-sheaf} the functor
$\mathit{Hom}(\mathcal{F}, \mathcal{G})$ satisfies
the sheaf property for fppf coverings. This mean we may\footnote{We omit
the verification of the set theoretical condition (3) of the referenced
lemma.} apply
Bootstrap, Lemma \ref{bootstrap-lemma-locally-algebraic-space}
to check the representability \'etale locally on $B$. Moreover,
we may check whether the end result is affine or
of finite presentation \'etale locally on $B$, see
Morphisms of Spaces, Lemmas \ref{spaces-morphisms-lemma-affine-local} and
\ref{spaces-morphisms-lemma-finite-presentation-local}.
Hence we may assume that $B$ is an affine scheme.

\medskip\noindent
Assume $B$ is an affine scheme. As $f$ is of finite presentation, it follows
$X$ is quasi-compact and quasi-separated. Thus we can write
$\mathcal{F} = \colim \mathcal{F}_i$ as a filtered colimit of
$\mathcal{O}_X$-modules of finite presentation
(Limits of Spaces, Lemma \ref{spaces-limits-lemma-colimit-finitely-presented}).
It is clear that
$$
\mathit{Hom}(\mathcal{F}, \mathcal{G}) =
\lim \mathit{Hom}(\mathcal{F}_i, \mathcal{G})
$$
Hence if we can show that each $\mathit{Hom}(\mathcal{F}_i, \mathcal{G})$
is representable by an affine scheme, then we see that the same thing
holds for $\mathit{Hom}(\mathcal{F}, \mathcal{G})$. Use the material in
Limits, Section \ref{limits-section-limits} and
Limits of Spaces, Section \ref{spaces-limits-section-limits}.
Thus we may assume that $\mathcal{F}$ is of finite presentation.

\medskip\noindent
Say $B = \Spec(R)$. Write $R = \colim R_i$ with each $R_i$ a finite
type $\mathbf{Z}$-algebra. Set $B_i = \Spec(R_i)$. By the results of
Limits of Spaces, Lemmas
\ref{spaces-limits-lemma-descend-finite-presentation} and
\ref{spaces-limits-lemma-descend-modules-finite-presentation}
we can find an $i$, a morphism of algebraic spaces $X_i \to B_i$,
and finitely presented $\mathcal{O}_{X_i}$-modules $\mathcal{F}_i$ and
$\mathcal{G}_i$ such that the base change of
$(X_i, \mathcal{F}_i, \mathcal{G}_i)$ to $B$ recovers
$(X, \mathcal{F}, \mathcal{G})$. By
Limits of Spaces, Lemma \ref{spaces-limits-lemma-descend-flat}
we may, after increasing $i$, assume that $\mathcal{G}_i$
is flat over $B_i$. By
Limits of Spaces, Lemma \ref{spaces-limits-lemma-eventually-proper-support}
we may similarly assume the scheme theoretic support of $\mathcal{G}_i$
is proper over $B_i$. At this point we can apply
Lemma \ref{lemma-noetherian-hom}
to see that $H_i = \mathit{Hom}(\mathcal{F}_i, \mathcal{G}_i)$ is
an algebraic space affine of finite presentation over $B_i$.
Pulling back to $B$ (using Remark \ref{remark-hom-base-change})
we see that $H_i \times_{B_i} B = \mathit{Hom}(\mathcal{F}, \mathcal{G})$ 
and we win.
\end{proof}






\section{The Isom functor}
\label{section-isom}

\noindent
In Situation \ref{situation-hom} we can consider the subfunctor
$$
\mathit{Isom}(\mathcal{F}, \mathcal{G}) \subset
\mathit{Hom}(\mathcal{F}, \mathcal{G})
$$
whose value on a scheme $T$ over $B$ is the set of {\it invertible}
$\mathcal{O}_{X_T}$-homomorphisms $u : \mathcal{F}_T \to \mathcal{G}_T$.
In this brief section we quickly point out some properties of this
functor.

\begin{lemma}
\label{lemma-isom-sheaf}
In Situation \ref{situation-hom} the functor
$\mathit{Isom}(\mathcal{F}, \mathcal{G})$ 
satisfies the sheaf property for the fpqc topology.
\end{lemma}

\begin{proof}
We have already seen that $\mathit{Hom}(\mathcal{F}, \mathcal{G})$
satisfies the sheaf property. Hence it remains to show the following:
Given an fpqc covering $\{T_i \to T\}_{i \in I}$ of schemes over $B$
and an $\mathcal{O}_{X_T}$-linear map
$u : \mathcal{F}_T \to \mathcal{G}_T$ such that
$u_{T_i}$ is an isomorphism for all $i$, then $u$ is an isomorphism.
Since $\{X_i \to X_T\}_{i \in I}$ is an fpqc covering of $X_T$, see
Topologies on Spaces, Lemma \ref{spaces-topologies-lemma-fpqc},
this follows from
Descent on Spaces, Proposition
\ref{spaces-descent-proposition-fpqc-descent-quasi-coherent}.
\end{proof}

\begin{proposition}
\label{proposition-isom}
In Situation \ref{situation-hom} assume that
\begin{enumerate}
\item $f$ is of finite presentation, and
\item $\mathcal{F}$ and $\mathcal{G}$ are finitely presented
$\mathcal{O}_X$-modules, flat over $B$, with support proper over $B$.
\end{enumerate}
Then the functor $\mathit{Isom}(\mathcal{F}, \mathcal{G})$ is
an algebraic space affine of finite presentation over $B$.
\end{proposition}

\begin{proof}
We will use the abbreviations
$H = \mathit{Hom}(\mathcal{F}, \mathcal{G})$,
$I = \mathit{Hom}(\mathcal{F}, \mathcal{F})$,
$H' = \mathit{Hom}(\mathcal{G}, \mathcal{F})$, and
$I' = \mathit{Hom}(\mathcal{G}, \mathcal{G})$.
By Proposition \ref{proposition-hom} the functors
$H$, $I$, $H'$, $I'$ are algebraic spaces and the morphisms
$H \to B$, $I \to B$, $H' \to B$, and $I' \to B$
are affine and of finite presentation.
The composition of maps gives a morphism
$$
c : H' \times_B H \longrightarrow I \times_B I',\quad
(u', u) \longmapsto (u \circ u', u' \circ u)
$$
of algebraic spaces over $B$. Since $I \times_B I' \to B$ is separated,
the section $\sigma : B \to I \times_B I'$ corresponding to
$(\text{id}_\mathcal{F}, \text{id}_\mathcal{G})$
is a closed immersion
(Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-section-immersion}).
Moreover, $\sigma$ is of finite presentation
(Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-finite-presentation-permanence}).
Hence
$$
\mathit{Isom}(\mathcal{F}, \mathcal{G}) =
(H' \times_B H) \times_{c, I \times_B I', \sigma} B
$$
is an algebraic space affine of finite presentation over $B$ as well.
Some details omitted.
\end{proof}






\section{The stack of coherent sheaves}
\label{section-stack-coherent-sheaves}

\noindent
In this section we prove that the stack of coherent sheaves 
on $X/B$ is algebraic under suitable hypotheses. This is a
special case of \cite[Theorem 2.1.1]{lieblich_remarks}
which treats the case of the stack of coherent sheaves on an
Artin stack over a base.

\begin{situation}
\label{situation-coherent}
Let $S$ be a scheme. Let $f : X \to B$ be a morphism of algebraic spaces
over $S$. Assume that $f$ is of finite presentation.
We denote $\textit{Coh}_{X/B}$ the category whose objects are
triples $(T, g, \mathcal{F})$ where
\begin{enumerate}
\item $T$ is a scheme over $S$,
\item $g : T \to B$ is a morphism over $S$, and setting
$X_T = T \times_{g, B} X$
\item $\mathcal{F}$ is a quasi-coherent $\mathcal{O}_{X_T}$-module
of finite presentation, flat over $T$, with support proper over $T$.
\end{enumerate}
A morphism $(T, g, \mathcal{F}) \to (T', g', \mathcal{F}')$
is given by a pair $(h, \varphi)$ where
\begin{enumerate}
\item $h : T \to T'$ is a morphism of schemes over $B$
(i.e., $g' \circ h = g$), and
\item $\varphi : (h')^*\mathcal{F}' \to \mathcal{F}$ is an
isomorphism of $\mathcal{O}_{X_T}$-modules where $h' : X_T \to X_{T'}$
is the base change of $h$.
\end{enumerate}
\end{situation}

\noindent
Thus $\textit{Coh}_{X/B}$ is a category and the rule
$$
p : \textit{Coh}_{X/B} \longrightarrow (\Sch/S)_{fppf},
\quad
(T, g, \mathcal{F}) \longmapsto T
$$
is a functor. For a scheme $T$ over $S$ we denote $\textit{Coh}_{X/B, T}$
the fibre category of $p$ over $T$. These fibre categories are groupoids.

\begin{lemma}
\label{lemma-coherent-fibred-in-groupoids}
In Situation \ref{situation-coherent} the functor
$p : \textit{Coh}_{X/B} \longrightarrow (\Sch/S)_{fppf}$
is fibred in groupoids.
\end{lemma}

\begin{proof}
We show that $p$ is fibred in groupoids by checking conditions
(1) and (2) of Categories, Definition
\ref{categories-definition-fibred-groupoids}.
Given an object $(T', g', \mathcal{F}')$
of $\textit{Coh}_{X/B}$ and a morphism $h : T \to T'$ of
schemes over $S$ we can set $g = h \circ g'$ and
$\mathcal{F} = (h')^*\mathcal{F}'$ where $h' : X_T \to X_{T'}$
is the base change of $h$. Then it is clear that we obtain
a morphism $(T, g, \mathcal{F}) \to (T', g', \mathcal{F}')$
of $\textit{Coh}_{X/B}$ lying over $h$. This proves (1).
For (2) suppose we are given morphisms
$$
(h_1, \varphi_1) : (T_1, g_1, \mathcal{F}_1) \to (T, g, \mathcal{F})
\quad\text{and}\quad
(h_2, \varphi_2) : (T_2, g_2, \mathcal{F}_2) \to (T, g, \mathcal{F})
$$
of $\textit{Coh}_{X/B}$ and a morphism $h : T_1 \to T_2$ such that
$h_2 \circ h = h_1$. Then we can let $\varphi$ be the composition
$$
(h')^*\mathcal{F}_2
\xrightarrow{(h')^*\varphi_2^{-1}}
(h')^*(h_2)^*\mathcal{F} = (h_1)^*\mathcal{F}
\xrightarrow{\varphi_1}
\mathcal{F}_1
$$
to obtain the morphism
$(h, \varphi) : (T_1, g_1, \mathcal{F}_1) \to (T_2, g_2, \mathcal{F}_2)$
that witnesses the truth of condition (2).
\end{proof}

\begin{lemma}
\label{lemma-coherent-diagonal}
In Situation \ref{situation-coherent}. Denote
$\mathcal{X} = \textit{Coh}_{X/B}$. Then
$\Delta : \mathcal{X} \to \mathcal{X} \times \mathcal{X}$ is
representable by algebraic spaces.
\end{lemma}

\begin{proof}
Consider two objects $x = (T, g, \mathcal{F})$ and $y = (T, h, \mathcal{G})$
of $\mathcal{X}$ over a scheme $T$. We have to show that
$\mathit{Isom}_\mathcal{X}(x, y)$ is an algebraic space over $T$, see
Algebraic Stacks, Lemma \ref{algebraic-lemma-representable-diagonal}.
If for $a : T' \to T$ the restrictions $x|_{T'}$ and $y|_{T'}$ are isomorphic
in the fibre category $\mathcal{X}_{T'}$, then $g \circ a = h \circ a$.
Hence there is a transformation of presheaves
$$
\mathit{Isom}_\mathcal{X}(x, y) \longrightarrow \text{Equalizer}(g, h)
$$
Since the diagonal of $B$ is representable (by schemes) this equalizer is
a scheme. Thus we may replace $T$ by this equalizer and the sheaves
$\mathcal{F}$ and $\mathcal{G}$ by their pullbacks. Thus we may assume
$g = h$. In this case we have
$\mathit{Isom}_\mathcal{X}(x, y) = \mathit{Isom}(\mathcal{F}, \mathcal{G})$
and the result follows from Proposition \ref{proposition-isom}.
\end{proof}

\begin{lemma}
\label{lemma-coherent-stack}
In Situation \ref{situation-coherent} the functor
$p : \textit{Coh}_{X/B} \longrightarrow (\Sch/S)_{fppf}$
is a stack in groupoids.
\end{lemma}

\begin{proof}
To prove that $\textit{Coh}_{X/B}$ is a stack in groupoids, we have to show
that the presheaves $\mathit{Isom}$ are sheaves and that descent data are
effective. The statement on $\mathit{Isom}$ follows from
Lemma \ref{lemma-coherent-diagonal}, see
Algebraic Stacks, Lemma \ref{algebraic-lemma-representable-diagonal}.
Let us prove the statement on descent data.
Suppose that $\{a_i : T_i \to T\}$ is an fppf covering of schemes over $S$.
Let $(\xi_i, \varphi_{ij})$ be a descent datum for $\{T_i \to T\}$
with values in $\textit{Coh}_{X/B}$.
For each $i$ we can write $\xi_i = (T_i, g_i, \mathcal{F}_i)$.
Denote $\text{pr}_0 : T_i \times_T T_j \to T_i$ and
$\text{pr}_1 : T_i \times_T T_j \to T_j$ the projections.
The condition that $\xi_i|_{T_i \times_T T_j} = \xi_j|_{T_i \times_T T_j}$
implies in particular that $g_i \circ \text{pr}_0 = g_j \circ \text{pr}_1$.
Thus there exists a unique morphism $g : T \to B$ such that
$g_i = g \circ a_i$, see
Descent on Spaces, Lemma
\ref{spaces-descent-lemma-fpqc-universal-effective-epimorphisms}.
Denote $X_T = T \times_{g, B} X$. Set
$X_i = X_{T_i} = T_i \times_{g_i, B} X = T_i \times_{a_i, T} X_T$
and
$$
X_{ij} = X_{T_i} \times_{X_T} X_{T_j} = X_i \times_{X_T} X_j
$$
with projections $\text{pr}_i$ and $\text{pr}_j$ to $X_i$ and $X_j$.
Observe that the pullback of $(T_i, g_i, \mathcal{F}_i)$
by $\text{pr}_0 : T_i \times_T T_j \to T_i$ is given by
$(T_i \times_T T_j, g_i \circ \text{pr}_0, \text{pr}_i^*\mathcal{F}_i)$.
Hence a descent datum for $\{T_i \to T\}$ in $\textit{Coh}_{X/B}$
is given by the objects $(T_i, g \circ a_i, \mathcal{F}_i)$
and for each pair $i, j$ an isomorphism of $\mathcal{O}_{X_{ij}}$-modules
$$
\varphi_{ij} :
\text{pr}_i^*\mathcal{F}_i \longrightarrow \text{pr}_j^*\mathcal{F}_j
$$
satisfying the cocycle condition over (the pullback of $X$ to)
$T_i \times_T T_j \times_T T_k$.
Ok, and now we simply use that $\{X_i \to X_T\}$ is an fppf covering
so that we can view $(\mathcal{F}_i, \varphi_{ij})$ as a descent datum
for this covering. By
Descent on Spaces, Proposition
\ref{spaces-descent-proposition-fpqc-descent-quasi-coherent}
this descent datum is effective and we obtain a quasi-coherent
sheaf $\mathcal{F}$ over $X_T$ restricting to $\mathcal{F}_i$ on $X_i$.
By Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-flat-permanence}
we see that $\mathcal{F}$ is flat over $T$ and
Descent on Spaces, Lemma
\ref{spaces-descent-lemma-finite-presentation-descends}
guarantees that $\mathcal{Q}$ is of finite presentation as an
$\mathcal{O}_{X_T}$-module. Finally, by
Descent on Spaces, Lemma \ref{spaces-descent-lemma-descending-property-proper}
we see that the scheme theoretic support of $\mathcal{F}$ is proper over
$T$ as we've assume the scheme theoretic support of $\mathcal{F}_i$
is proper over $T_i$ (note that taking scheme theoretic support commutes
with flat base change by
Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-flat-pullback-support}).
In this way
and we obtain our desired object over $T$.
\end{proof}

\begin{remark}
\label{remark-coherent-base-change}
In Situation \ref{situation-coherent} the rule
$(T, g, \mathcal{F}) \mapsto (T, g)$ defines a $1$-morphism
$$
\textit{Coh}_{X/B} \longrightarrow \mathcal{S}_B
$$
of stacks in groupoids
(see Lemma \ref{lemma-coherent-stack},
Algebraic Stacks, Section \ref{algebraic-section-split}, and
Examples of Stacks, Section
\ref{examples-stacks-section-stack-associated-to-sheaf}).
Let $B' \to B$ be a morphism of
algebraic spaces over $S$. Let $\mathcal{S}_{B'} \to \mathcal{S}_B$
be the associated $1$-morphism of stacks fibred in sets.
Set $X' = X \times_B B'$.
We obtain a stack in groupoids $\textit{Coh}_{X'/B'} \to (\Sch/S)_{fppf}$
associated to the base change $f' : X' \to B'$. In this situation
the diagram
$$
\vcenter{
\xymatrix{
\textit{Coh}_{X'/B'} \ar[r] \ar[d] & \textit{Coh}_{X/B} \ar[d] \\
\mathcal{S}_{B'} \ar[r] & \mathcal{S}_B
}
}
\quad
\begin{matrix}
\text{or in} \\
\text{another} \\
\text{notation}
\end{matrix}
\quad
\vcenter{
\xymatrix{
\textit{Coh}_{X'/B'} \ar[r] \ar[d] & \textit{Coh}_{X/B} \ar[d] \\
\Sch/B' \ar[r] & \Sch/B
}
}
$$
is $2$-fibre product square. This trivial remark
will occasionally be useful to change the base algebraic space.
\end{remark}

\begin{lemma}
\label{lemma-coherent-limits}
In Situation \ref{situation-coherent} assume that $B \to S$
is locally of finite presentation. Then
$p : \textit{Coh}_{X/B} \to (\Sch/S)_{fppf}$ is limit preserving
(Artin's Axioms, Definition \ref{artin-definition-limit-preserving}).
\end{lemma}

\begin{proof}
Write $B(T)$ for the discrete category whose
objects are the $S$-morphisms $T \to B$. Let $T = \lim T_i$ be a filtered
limit of affine schemes over $S$. Assigning to an object
$(T, h, \mathcal{F})$ of $\textit{Coh}_{X/B, T}$ the object $h$
of $B(T)$ gives us a commutative diagram of fibre categories
$$
\xymatrix{
\colim \textit{Coh}_{X/B, T_i} \ar[r] \ar[d] &
\textit{Coh}_{X/B, T} \ar[d] \\
\colim B(T_i) \ar[r] & B(T)
}
$$
We have to show the top horizontal arrow is an equivalence. Since
we have assume that $B$ is locally of finite presentation over $S$
we see from
Limits of Spaces, Remark \ref{spaces-limits-remark-limit-preserving}
that the bottom horizontal arrow is an equivalence. This means that
we may assume $T = \lim T_i$ be a filtered limit of affine schemes over
$B$. Denote $g_i : T_i \to B$ and $g : T \to B$ the corresponding
morphisms. Set $X_i = T_i \times_{g_i, B} X$ and $X_T = T \times_{g, B} X$.
Observe that $X_T = \colim X_i$ and that the algebraic spaces
$X_i$ and $X_T$ are quasi-separated and quasi-compact (as they
are of finite presentation over the affines $T_i$ and $T$).
By Limits of Spaces, Lemma
\ref{spaces-limits-lemma-descend-modules-finite-presentation}
we see that
$$
\colim \textit{FP}(X_i) = \textit{FP}(X_T).
$$
where $\textit{FP}(W)$ is short hand for the category of finitely
presented $\mathcal{O}_W$-modules. The results of
Limits of Spaces, Lemmas \ref{spaces-limits-lemma-descend-flat} and
\ref{spaces-limits-lemma-eventually-proper-support}
tell us the same thing is true if we replace $\textit{FP}(X_i)$
and $\textit{FP}(X_T)$ by the full subcategory of objects
flat over $T_i$ and $T$ with scheme theoretic support proper
over $T_i$ and $T$. This proves the lemma.
\end{proof}

\begin{lemma}
\label{lemma-coherent-RS-star}
In Situation \ref{situation-coherent}. Let
$$
\xymatrix{
Z \ar[r] \ar[d] & Z' \ar[d] \\
Y \ar[r] & Y'
}
$$
be a pushout in the category of schemes over $S$ where
$Z \to Z'$ is a thickening and $Z \to Y$ is affine, see
More on Morphisms, Lemma \ref{more-morphisms-lemma-pushout-along-thickening}.
Then the functor on fibre categories
$$
\textit{Coh}_{X/B, Y'}
\longrightarrow
\textit{Coh}_{X/B, Y} \times_{\textit{Coh}_{X/B, Z}} \textit{Coh}_{X/B, Z'}
$$
is an equivalence.
\end{lemma}

\begin{proof}
Observe that the corresponding map
$$
B(Y') \longrightarrow B(Y) \times_{B(Z)} B(Z')
$$
is a bijection, see Pushouts of Spaces, Lemma
\ref{spaces-pushouts-lemma-pushout-along-thickening-schemes}.
Thus using the commutative diagram
$$
\xymatrix{
\textit{Coh}_{X/B, Y'} \ar[r] \ar[d] &
\textit{Coh}_{X/B, Y} \times_{\textit{Coh}_{X/B, Z}} \textit{Coh}_{X/B, Z'}
\ar[d] \\
B(Y') \ar[r] & B(Y) \times_{B(Z)} B(Z')
}
$$
we see that we may assume that $Y'$ is a scheme over $B'$. By
Remark \ref{remark-coherent-base-change}
we may replace $B$ by $Y'$ and $X$ by $X \times_B Y'$.
Thus we may assume $B = Y'$. In this case the statement follows from
Pushouts of Spaces, Lemma
\ref{spaces-pushouts-lemma-space-over-pushout-flat-modules}.
\end{proof}

\begin{lemma}
\label{lemma-coherent-over-first-order-thickening}
Let
$$
\xymatrix{
X \ar[d] \ar[r]_i & X' \ar[d] \\
T \ar[r] & T'
}
$$
be a cartesian square of algebraic spaces where $T \to T'$ is a first
order thickening. Let $\mathcal{F}'$ be an $\mathcal{O}_{X'}$-module
flat over $T'$. Set $\mathcal{F} = i^*\mathcal{F}'$. The following
are equivalent
\begin{enumerate}
\item $\mathcal{F}'$ is a quasi-coherent $\mathcal{O}_{X'}$-module
of finite presentation,
\item $\mathcal{F}'$ is an $\mathcal{O}_{X'}$-module of finite presentation,
\item $\mathcal{F}$ is a quasi-coherent $\mathcal{O}_X$-module
of finite presentation,
\item $\mathcal{F}$ is an $\mathcal{O}_X$-module of finite presentation,
\end{enumerate}
\end{lemma}

\begin{proof}
Recall that a finitely presented module is quasi-coherent hence the
equivalence of (1) and (2) and (3) and (4). The equivalence of (2)
and (4) is a special case of Deformation Theory, Lemma
\ref{defos-lemma-deform-fp-module-ringed-topoi}.
\end{proof}

\begin{lemma}
\label{lemma-coherent-tangent-space}
In Situation \ref{situation-coherent} assume that $S$ is a locally Noetherian
scheme and $B \to S$ is locally of finite presentation.
Let $k$ be a finite type field over $S$ and let
$x_0 = (\Spec(k), g_0, \mathcal{G}_0)$
be an object of $\mathcal{X} = \textit{Coh}_{X/B}$ over $k$. Then
the spaces $T\mathcal{F}_{\mathcal{X}, k, x_0}$ and
$\text{Inf}_{x_0}(\mathcal{F}_{\mathcal{X}, k, x_0})$
(Artin's Axioms, Section \ref{artin-section-tangent-spaces})
are finite dimensional.
\end{lemma}

\begin{proof}
Observe that by Lemma \ref{lemma-coherent-RS-star}
our stack in groupoids $\mathcal{X}$ satisfies property (RS*)
defined in Artin's Axioms, Section \ref{artin-section-inf}.
In particular $\mathcal{X}$ satisfies (RS).
Hence all associated predeformation
categories are deformation categories
(Artin's Axioms, Lemma \ref{artin-lemma-deformation-category})
and the statement makes sense.

\medskip\noindent
In this paragraph we show that we can reduce to the case $B = \Spec(k)$.
Set $X_0 = \Spec(k) \times_{g_0, B} X$
and denote $\mathcal{X}_0 = \textit{Coh}_{X_0/k}$. In
Remark \ref{remark-coherent-base-change} we have seen that
$\mathcal{X}_0$ is the $2$-fibre product of $\mathcal{X}$ with
$\Spec(k)$ over $B$ as categories fibred in groupoids over
$(\Sch/S)_{fppf}$. Thus by
Artin's Axioms, Lemma \ref{artin-lemma-fibre-product-tangent-spaces}
we reduce to proving that $B$, $\Spec(k)$, and $\mathcal{X}_0$
have finite dimensional tangent spaces and infinitesimal automorphism
spaces. The tangent space of $B$ and $\Spec(k)$ are finite dimensional by
Artin's Axioms, Lemma \ref{artin-lemma-finite-dimension}
and of course these have vanishing $\text{Inf}$.
Thus it suffices to deal with $\mathcal{X}_0$.

\medskip\noindent
Let $k[\epsilon]$ be the dual numbers over $k$.
Let $\Spec(k[\epsilon]) \to B$ be the composition of $g_0 : \Spec(k) \to B$
and the morphism $\Spec(k[\epsilon]) \to \Spec(k)$
coming from the inclusion $k \to k[\epsilon]$.
Set $X_0 = \Spec(k) \times_B X$ and
$X_\epsilon = \Spec(k[\epsilon]) \times_B X$.
Observe that $X_\epsilon$ is a first order thickening of $X_0$
flat over the first order thickening $\Spec(k) \to \Spec(k[\epsilon])$.
Unwinding the definitions and using
Lemma \ref{lemma-coherent-over-first-order-thickening}
we see that $T\mathcal{F}_{\mathcal{X}_0, k, x_0}$ is the set of
lifts of $\mathcal{G}_0$ to a flat module on $X_\epsilon$.
By Deformation Theory, Lemma \ref{defos-lemma-flat-ringed-topoi}
we conclude that
$$
T\mathcal{F}_{\mathcal{X}_0, k, x_0} =
\text{Ext}^1_{\mathcal{O}_{X_0}}(\mathcal{G}_0, \mathcal{G}_0)
$$
Here we have used the identification $\epsilon k[\epsilon] \cong k$
of $k[\epsilon]$-modules. Using
Deformation Theory, Lemma \ref{defos-lemma-flat-ringed-topoi}
once more we see that
$$
\text{Inf}_{x_0}(\mathcal{F}_{\mathcal{X}, k, x_0}) =
\text{Ext}^0_{\mathcal{O}_{X_0}}(\mathcal{G}_0, \mathcal{G}_0)
$$
These spaces are finite dimensional over $k$ as $\mathcal{G}_0$
has support proper over $\Spec(k)$. Namely, $X_0$ is of finite presentation
over $\Spec(k)$, hence Noetherian. Since $\mathcal{G}_0$ is of finite
presentation it is a coherent $\mathcal{O}_{X_0}$-module. Thus we may apply
Derived Categories of Spaces, Lemma
\ref{spaces-perfect-lemma-compute-ext}
to conclude the desired finiteness.
\end{proof}

\begin{lemma}
\label{lemma-coherent-existence}
In Situation \ref{situation-coherent} assume that $S$ is a locally Noetherian
scheme and that $f : X \to B$ is separated.
Let $\mathcal{X} = \textit{Coh}_{X/B}$. Then the functor
Artin's Axioms, Equation (\ref{artin-equation-approximation})
is an equivalence.
\end{lemma}

\begin{proof}
Let $A$ be an $S$-algebra which is a complete local Noetherian ring
with maximal ideal $\mathfrak m$
whose residue field $k$ is of finite type over $S$.
We have to show that the category of objects over $A$ is
equivalent to the category of formal objects over $A$.
Since we know this holds for the category $\mathcal{S}_B$
fibred in sets associated to $B$ by Artin's Axioms, 
Lemma \ref{artin-lemma-effective}, it suffices to prove this
for those objects lying over a given morphism $\Spec(A) \to B$.

\medskip\noindent
Set $X_A = \Spec(A) \times_B X$ and $X_n = \Spec(A/\mathfrak m^n) \times_B X$.
By Grothendieck's existence theorem
(More on Morphisms of Spaces, Theorem
\ref{spaces-more-morphisms-theorem-grothendieck-existence})
we see that the category of coherent modules $\mathcal{F}$
on $X_A$ with support proper over $\Spec(A)$ is equivalent
to the category of systems $(\mathcal{F}_n)$ of coherent modules
$\mathcal{F}_n$ on $X_n$ with support proper over
$\Spec(A/\mathfrak m^n)$. The equivalence sends $\mathcal{F}$
to the system $(\mathcal{F} \otimes_A A/\mathfrak m^n)$. See discussion in
More on Morphisms of Spaces, Remark
\ref{spaces-more-morphisms-remark-reformulate-existence-theorem}.
To finish the proof of the lemma, it suffices to show that
$\mathcal{F}$ is flat over $A$ if and only if all
$\mathcal{F} \otimes_A A/\mathfrak m^n$ are flat over $A/\mathfrak m^n$.
This follows from
More on Morphisms of Spaces, Lemma
\ref{spaces-more-morphisms-lemma-flatness-over-Noetherian-ring}.
\end{proof}

\begin{lemma}
\label{lemma-coherent-defo-thy}
In Situation \ref{situation-coherent} assume that
$S$ is a locally Noetherian scheme, $S = B$, and $f : X \to B$ is flat.
Let $\mathcal{X} = \textit{Coh}_{X/B}$. Then we have openness of
versality for $\mathcal{X}$ (see
Artin's Axioms, Definition \ref{artin-definition-openness-versality}).
\end{lemma}

\begin{proof}[First proof]
This proof is based on the criterion of
Artin's Axioms, Lemma \ref{artin-lemma-dual-openness}.
Let $U \to S$ be of finite type morphism of schemes, $x$ an object of
$\mathcal{X}$ over $U$ and $u_0 \in U$ a finite type point such that
$x$ is versal at $u_0$. After shrinking $U$ we may assume that $u_0$
is a closed point (Morphisms, Lemma \ref{morphisms-lemma-point-finite-type})
and $U = \Spec(A)$ with $U \to S$ mapping into an
affine open $\Spec(\Lambda)$ of $S$.
Let $\mathcal{F}$ be the coherent module on $X_A = \Spec(A) \times_S X$
flat over $A$ corresponding to the given object $x$.

\medskip\noindent
According to Deformation Theory, Lemma \ref{defos-lemma-flat-ringed-topoi}
we have an isomorphism of functors
$$
T_x(M) = \text{Ext}^1_{X_A}(\mathcal{F}, \mathcal{F} \otimes_A M)
$$
and given any surjection $A' \to A$ of $\Lambda$-algebras with square zero
kernel $I$ we have an obstruction class
$$
\xi_{A'} \in \text{Ext}^2_{X_A}(\mathcal{F}, \mathcal{F} \otimes_A I)
$$
This uses that for any $A' \to A$ as above the base change
$X_{A'} = \Spec(A') \times_B X$ is flat over $A'$.
Moreover, the construction of the obstruction class is functorial
in the surjection $A' \to A$ (for fixed $A$) by
Deformation Theory, Lemma \ref{defos-lemma-functorial-ringed-topoi}.
Apply Derived Categories of Spaces, Lemma
\ref{spaces-perfect-lemma-compute-ext}
to the computation of the Ext groups
$\text{Ext}^i_{X_A}(\mathcal{F}, \mathcal{F} \otimes_A M)$
for $i \leq m$ with $m = 2$. We find a perfect object $K \in D(A)$
and functorial isomorphisms
$$
H^i(K \otimes_A^\mathbf{L} M)
\longrightarrow
\text{Ext}^i_{X_A}(\mathcal{F}, \mathcal{F} \otimes_A M)
$$
for $i \leq m$ compatible with boundary maps. This object $K$, together
with the displayed identifications above gives us a datum as in
Artin's Axioms, Situation \ref{artin-situation-dual}.
Finally, condition (iv) of
Artin's Axioms, Lemma \ref{artin-lemma-dual-obstruction}
holds by 
Deformation Theory, Lemma \ref{defos-lemma-verify-iv-ringed-topoi}.
Thus Artin's Axioms, Lemma \ref{artin-lemma-dual-openness}
does indeed apply and the lemma is proved.
\end{proof}

\begin{proof}[Second proof]
This proof is based on
Artin's Axioms, Lemma \ref{artin-lemma-get-openness-obstruction-theory}.
Conditions (1), (2), and (3) of that lemma correspond to
Lemmas \ref{lemma-coherent-diagonal},
\ref{lemma-coherent-RS-star}, and
\ref{lemma-coherent-limits}.

\medskip\noindent
We have constructed an obstruction theory in the chapter on
deformation theory. Namely, given an $S$-algebra $A$ and an
object $x$ of $\textit{Coh}_{X/B}$ over $\Spec(A)$ given
by $\mathcal{F}$ on $X_A$ we set
$\mathcal{O}_x(M) = \text{Ext}^2_{X_A}(\mathcal{F}, \mathcal{F} \otimes_A M)$
and if $A' \to A$ is a surjection with kernel $I$, then as obstruction
element we take the element
$$
o_x(A') = o(\mathcal{F}, \mathcal{F} \otimes_A I, 1) \in
\mathcal{O}_x(I) = \text{Ext}^2_{X_A}(\mathcal{F}, \mathcal{F} \otimes_A I)
$$
of Deformation Theory, Lemma \ref{defos-lemma-flat-ringed-topoi}.
All properties of an obstruction theory as defined in
Artin's Axioms, Definition \ref{artin-definition-obstruction-theory}
follow from this lemma except for functoriality of obstruction classes
as formulated in condition (ii) of the definition. But as stated in
the footnote to assumption (4) of
Artin's Axioms, Lemma \ref{artin-lemma-get-openness-obstruction-theory}
it suffices to check functoriality of obstruction classes
for a fixed $A$ which follows from
Deformation Theory, Lemma \ref{defos-lemma-functorial-ringed-topoi}.
Deformation Theory, Lemma \ref{defos-lemma-flat-ringed-topoi}
also tells us that
$T_x(M) = \text{Ext}^1_{X_A}(\mathcal{F}, \mathcal{F} \otimes_A M)$
for any $A$-module $M$.

\medskip\noindent
To finish the proof it suffices to show that
$T_x(\prod M_n) = \prod T_x(M_n)$ and
$\mathcal{O}_x(\prod M_n) = \prod \mathcal{O}_x(M)$.
Apply Derived Categories of Spaces, Lemma
\ref{spaces-perfect-lemma-compute-ext}
to the computation of the Ext groups
$\text{Ext}^i_{X_A}(\mathcal{F}, \mathcal{F} \otimes_A M)$
for $i \leq m$ with $m = 2$. We find a perfect object $K \in D(A)$
and functorial isomorphisms
$$
H^i(K \otimes_A^\mathbf{L} M)
\longrightarrow
\text{Ext}^i_{X_A}(\mathcal{F}, \mathcal{F} \otimes_A M)
$$
for $i = 1, 2$. A straightforward argument shows that
$$
H^i(K \otimes_A^\mathbf{L} \prod M_n) =
\prod H^i(K \otimes_A^\mathbf{L} M_n)
$$
whenever $K$ is a pseudo-coherent object of $D(A)$.
In fact, this property (for all $i$) characterizes
pseudo-coherent complexes, see
More on Algebra, Lemma \ref{more-algebra-lemma-pseudo-coherent-tensor}.
\end{proof}

\begin{theorem}[Algebraicity of stack coherent sheaves; flat case]
\label{theorem-coherent-algebraic}
Let $S$ be a scheme. Let $f : X \to B$ be morphism of algebraic spaces
over $S$. Assume that $f$ is of finite presentation, separated, and
flat\footnote{This assumption is not necessary. See
Section \ref{section-not-flat}.}. Then $\textit{Coh}_{X/B}$ is
an algebraic stack over $S$.
\end{theorem}

\begin{proof}
Set $\mathcal{X} = \textit{Coh}_{X/B}$. We have seen that $\mathcal{X}$
is a stack in groupoids over $(\Sch/S)_{fppf}$ with diagonal representable
by algebraic spaces
(Lemmas \ref{lemma-coherent-stack} and \ref{lemma-coherent-diagonal}).
Hence it suffices to find a scheme $W$ and a surjective and smooth
morphism $W \to \mathcal{X}$.

\medskip\noindent
Let $B'$ be a scheme and let $B' \to B$ be a surjective \'etale morphism.
Set $X' = B' \times_B X$ and denote $f' : X' \to B'$ the projection.
Then $\mathcal{X}' = \textit{Coh}_{X'/B'}$ is equal to the $2$-fibre
product of $\mathcal{X}$ with the category fibred in sets
associated to $B'$ over the category fibred in sets associated to $B$
(Remark \ref{remark-coherent-base-change}). By the material in
Algebraic Stacks, Section \ref{algebraic-section-representable-properties}
the morphism $\mathcal{X}' \to \mathcal{X}$ is surjective and \'etale.
Hence it suffices to prove the result for $\mathcal{X}'$.
In other words, we may assume $B$ is a scheme.

\medskip\noindent
Assume $B$ is a scheme. In this case we may replace $S$ by $B$, see
Algebraic Stacks, Section \ref{algebraic-section-change-base-scheme}.
Thus we may assume $S = B$.

\medskip\noindent
Assume $S = B$. Choose an affine open covering $S = \bigcup U_i$.
Denote $\mathcal{X}_i$ the restriction of $\mathcal{X}$ to
$(\Sch/U_i)_{fppf}$. If we can find schemes $W_i$ over $U_i$ and
surjective smooth morphisms $W_i \to \mathcal{X}_i$, then we
set $W = \coprod W_i$ and we obtain a surjective smooth morphism
$W \to \mathcal{X}$. Thus we may assume $S = B$ is affine.

\medskip\noindent
Assume $S = B$ is affine, say $S = \Spec(\Lambda)$.
Write $\Lambda = \colim \Lambda_i$ as a filtered colimit with each $\Lambda_i$
of finite type over $\mathbf{Z}$. For some $i$ we can find
a morphism of algebraic spaces $X_i \to \Spec(\Lambda_i)$
which is of finite presentation and flat and whose base change
to $\Lambda$ is $X$. See
Limits of Spaces, Lemmas
\ref{spaces-limits-lemma-descend-finite-presentation} and
\ref{spaces-limits-lemma-descend-flat}.
If we show that $\textit{Coh}_{X_i/\Spec(\Lambda_i)}$ is an
algebraic stack, then it follows by base change
(Remark \ref{remark-coherent-base-change} and
Algebraic Stacks, Section \ref{algebraic-section-change-base-scheme})
that $\mathcal{X}$ is an algebraic stack.
Thus we may assume that $\Lambda$ is a finite type $\mathbf{Z}$-algebra.

\medskip\noindent
Assume $S = B = \Spec(\Lambda)$ is affine of finite type over $\mathbf{Z}$.
In this case we will verify conditions (1), (2), (3), (4), and (5) of
Artin's Axioms, Lemma \ref{artin-lemma-diagonal-representable}
to conclude that $\mathcal{X}$ is an algebraic stack.
Note that $\Lambda$ is a G-ring, see
More on Algebra, Proposition \ref{more-algebra-proposition-ubiquity-G-ring}.
Hence all local rings of $S$ are G-rings. Thus (5) holds.
By Lemma \ref{lemma-coherent-defo-thy}
we have that $\mathcal{X}$ satisfies openness of versality, hence (4) holds.
To check (2) we have to verify axioms [-1], [0], [1], [2], and [3]
of Artin's Axioms, Section \ref{artin-section-axioms}.
We omit the verification of [-1] and axioms
[0], [1], [2], [3] correspond respectively to
Lemmas \ref{lemma-coherent-stack},
\ref{lemma-coherent-limits},
\ref{lemma-coherent-RS-star},
\ref{lemma-coherent-tangent-space}.
Condition (3) follows from Lemma \ref{lemma-coherent-existence}.
Finally, condition (1) is Lemma \ref{lemma-coherent-diagonal}.
This finishes the proof of the theorem.
\end{proof}








\section{The stack of coherent sheaves in the non-flat case}
\label{section-not-flat}

\noindent
In Theorem \ref{theorem-coherent-algebraic} the assumption that $f : X \to B$
is flat is not necessary. In this section we give a different proof
which avoids the flatness assumption and avoids checking openness
of versality by using the results
in Flatness on Spaces, Section \ref{spaces-flat-section-existence} and
Artin's Axioms, Section \ref{artin-section-strong-formal-effectiveness}.

\medskip\noindent
For a different approach to this problem the reader may wish to consult
\cite{ArtinI} and follow the method discussed in the papers
\cite{olsson-starr}, \cite{lieblich_remarks}, \cite{olsson_proper},
\cite{Hall-Rydh}, \cite{Hall-Rydh-Hilbert}, \cite{rydh_representability}.
Some of these papers deal with the more general case of the stack of
coherent sheaves on an algebraic stack over an algebraic stack and
others deal with similar problems in the case of Hilbert stacks
or Quot functors. Our strategy will be to show algebraicity of some
cases of Hilbert stacks and Quot functors as a consequence of the
algebraicity of the stack of coherent sheaves.

\begin{theorem}[Algebraicity of stack coherent sheaves; general case]
\label{theorem-coherent-algebraic-general}
Let $S$ be a scheme. Let $f : X \to B$ be morphism of algebraic spaces
over $S$. Assume that $f$ is of finite presentation and separated. Then
$\textit{Coh}_{X/B}$ is an algebraic stack over $S$.
\end{theorem}

\begin{proof}
Only the last step of the proof is different from the proof
in the flat case, but we repeat all the arguments here to make 
sure everything works.

\medskip\noindent
Set $\mathcal{X} = \textit{Coh}_{X/B}$. We have seen that $\mathcal{X}$
is a stack in groupoids over $(\Sch/S)_{fppf}$ with diagonal representable
by algebraic spaces
(Lemmas \ref{lemma-coherent-stack} and \ref{lemma-coherent-diagonal}).
Hence it suffices to find a scheme $W$ and a surjective and smooth
morphism $W \to \mathcal{X}$.

\medskip\noindent
Let $B'$ be a scheme and let $B' \to B$ be a surjective \'etale morphism.
Set $X' = B' \times_B X$ and denote $f' : X' \to B'$ the projection.
Then $\mathcal{X}' = \textit{Coh}_{X'/B'}$ is equal to the $2$-fibre
product of $\mathcal{X}$ with the category fibred in sets
associated to $B'$ over the category fibred in sets associated to $B$
(Remark \ref{remark-coherent-base-change}). By the material in
Algebraic Stacks, Section \ref{algebraic-section-representable-properties}
the morphism $\mathcal{X}' \to \mathcal{X}$ is surjective and \'etale.
Hence it suffices to prove the result for $\mathcal{X}'$.
In other words, we may assume $B$ is a scheme.

\medskip\noindent
Assume $B$ is a scheme. In this case we may replace $S$ by $B$, see
Algebraic Stacks, Section \ref{algebraic-section-change-base-scheme}.
Thus we may assume $S = B$.

\medskip\noindent
Assume $S = B$. Choose an affine open covering $S = \bigcup U_i$.
Denote $\mathcal{X}_i$ the restriction of $\mathcal{X}$ to
$(\Sch/U_i)_{fppf}$. If we can find schemes $W_i$ over $U_i$ and
surjective smooth morphisms $W_i \to \mathcal{X}_i$, then we
set $W = \coprod W_i$ and we obtain a surjective smooth morphism
$W \to \mathcal{X}$. Thus we may assume $S = B$ is affine.

\medskip\noindent
Assume $S = B$ is affine, say $S = \Spec(\Lambda)$.
Write $\Lambda = \colim \Lambda_i$ as a filtered colimit with each $\Lambda_i$
of finite type over $\mathbf{Z}$. For some $i$ we can find
a morphism of algebraic spaces $X_i \to \Spec(\Lambda_i)$
which is of finite presentation and whose base change
to $\Lambda$ is $X$. See Limits of Spaces, Lemma
\ref{spaces-limits-lemma-descend-finite-presentation}.
If we show that $\textit{Coh}_{X_i/\Spec(\Lambda_i)}$ is an
algebraic stack, then it follows by base change
(Remark \ref{remark-coherent-base-change} and
Algebraic Stacks, Section \ref{algebraic-section-change-base-scheme})
that $\mathcal{X}$ is an algebraic stack.
Thus we may assume that $\Lambda$ is a finite type $\mathbf{Z}$-algebra.

\medskip\noindent
Assume $S = B = \Spec(\Lambda)$ is affine of finite type over $\mathbf{Z}$.
In this case we will verify conditions (1), (2), (3), (4), and (5) of
Artin's Axioms, Lemma \ref{artin-lemma-diagonal-representable}
to conclude that $\mathcal{X}$ is an algebraic stack.
Note that $\Lambda$ is a G-ring, see
More on Algebra, Proposition \ref{more-algebra-proposition-ubiquity-G-ring}.
Hence all local rings of $S$ are G-rings. Thus (5) holds.
To check (2) we have to verify axioms [-1], [0], [1], [2], and [3]
of Artin's Axioms, Section \ref{artin-section-axioms}.
We omit the verification of [-1] and axioms
[0], [1], [2], [3] correspond respectively to
Lemmas \ref{lemma-coherent-stack},
\ref{lemma-coherent-limits},
\ref{lemma-coherent-RS-star},
\ref{lemma-coherent-tangent-space}.
Condition (3) is Lemma \ref{lemma-coherent-existence}.
Condition (1) is Lemma \ref{lemma-coherent-diagonal}.

\medskip\noindent
It remains to show condition (4) which is openness of versality.
To see this we will use
Artin's Axioms, Lemma \ref{artin-lemma-SGE-implies-openness-versality}.
We have already seen that $\mathcal{X}$ has diagonal
representable by algebraic spaces, has (RS*), and is limit preserving
(see lemmas used above).
Hence we only need to see that $\mathcal{X}$ satisfies the strong
formal effectiveness formulated in
Artin's Axioms, Lemma \ref{artin-lemma-SGE-implies-openness-versality}.
This is Flatness on Spaces, Theorem \ref{spaces-flat-theorem-existence}
and the proof is complete.
\end{proof}









\section{The functor of quotients}
\label{section-functor-quotients}

\noindent
In this section we discuss some generalities regarding the functor
$Q_{\mathcal{F}/X/B}$ defined below.
The notation $\text{Quot}_{\mathcal{F}/X/B}$ is reserved for a
subfunctor of $\text{Q}_{\mathcal{F}/X/B}$.
We urge the reader to skip this section on a first reading.

\begin{situation}
\label{situation-q}
Let $S$ be a scheme. Let $f : X \to B$ be a morphism of algebraic spaces
over $S$. Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
For any scheme $T$ over $B$ we will denote $X_T$ the base change of
$X$ to $T$ and $\mathcal{F}_T$ the pullback
of $\mathcal{F}$ via the projection morphism $X_T = X \times_B T \to X$.
Given such a $T$ we set
$$
\text{Q}_{\mathcal{F}/X/B}(T) =
\left\{
\begin{matrix}
\text{quotients }\mathcal{F}_T \to \mathcal{Q}\text{ where }
\mathcal{Q}\text{ is a}\\
\text{quasi-coherent }
\mathcal{O}_{X_T}\text{-module flat over }T
\end{matrix}
\right\}
$$
We identify quotients if they have the same kernel. Suppose
that $T' \to T$ is a morphism of schemes over $B$ and
$\mathcal{F}_T \to \mathcal{Q}$ is an element of
$\text{Q}_{\mathcal{F}/X/B}(T)$. Then the pullback
$\mathcal{Q}' = (X_{T'} \to X_T)^*\mathcal{Q}$ is a quasi-coherent
$\mathcal{O}_{X_{T'}}$-module flat over $T'$ by
Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-base-change-module-flat}.
Thus we obtain a functor
\begin{equation}
\label{equation-q}
\text{Q}_{\mathcal{F}/X/B} : (\Sch/B)^{opp} \longrightarrow \textit{Sets}
\end{equation}
This is the {\it functor of quotients of $\mathcal{F}/X/B$}.
We define a subfunctor
\begin{equation}
\label{equation-q-fp}
\text{Q}^{fp}_{\mathcal{F}/X/B} : (\Sch/B)^{opp} \longrightarrow \textit{Sets}
\end{equation}
which assigns to $T$ the subset of $\text{Q}_{\mathcal{F}/X/B}(T)$
consisting of those quotients $\mathcal{F}_T \to \mathcal{Q}$
such that $\mathcal{Q}$ is of finite presentation as an
$\mathcal{O}_{X_T}$-module. This is a subfunctor by
Properties of Spaces, Section
\ref{spaces-properties-section-properties-modules}.
\end{situation}

\noindent
In Situation \ref{situation-q} we sometimes think of
$\text{Q}_{\mathcal{F}/X/B}$ as a functor
$(\Sch/S)^{opp} \to \textit{Sets}$ endowed
with a morphism $\text{Q}_{\mathcal{F}/X/S} \to B$.
Namely, if $T$ is a scheme over $S$, then an element
of $\text{Q}_{\mathcal{F}/X/B}(T)$ is a pair $(h, \mathcal{Q})$
where $h$ a morphism $h : T \to B$
and $\mathcal{Q}$ is a $T$-flat quotient $\mathcal{F}_T \to \mathcal{Q}$
of finite presentation on $X_T = X \times_{B, h} T$. In particular, when we say
that $\text{Q}_{\mathcal{F}/X/S}$ is an algebraic space, we mean that the
corresponding functor $(\Sch/S)^{opp} \to \textit{Sets}$ is an algebraic space.
Similar remarks apply to $\text{Q}^{fp}_{\mathcal{F}/X/B}$.

\begin{remark}
\label{remark-q-base-change}
In Situation \ref{situation-q} let $B' \to B$ be a morphism of
algebraic spaces over $S$. Set $X' = X \times_B B'$ and denote
$\mathcal{F}'$ the pullback of $\mathcal{F}$ to $X'$.
Thus we have the functor $Q_{\mathcal{F}'/X'/B'}$ on
the category of schemes over $B'$. For a scheme $T$ over $B'$
it is clear that we have
$$
Q_{\mathcal{F}'/X'/B'}(T) = Q_{\mathcal{F}/X/B}(T)
$$
where on the right hand side we think of $T$ as a scheme over $B$
via the composition $T \to B' \to B$.
Similar remarks apply to $\text{Q}^{fp}_{\mathcal{F}/X/B}$.
These trivial remarks
will occasionally be useful to change the base algebraic space.
\end{remark}

\begin{remark}
\label{remark-q-sheaf}
Let $S$ be a scheme, $X$ an algebraic space over $S$, and $\mathcal{F}$
a quasi-coherent $\mathcal{O}_X$-module. Suppose that
$\{f_i : X_i \to X\}_{i \in I}$
is an fpqc covering and for each $i, j \in I$ we are given an fpqc covering
$\{X_{ijk} \to X_i \times_X X_j\}$. In this situation we have a bijection
$$
\left\{
\begin{matrix}
\text{quotients }\mathcal{F} \to \mathcal{Q}\text{ where } \\
\mathcal{Q}\text{ is a quasi-coherent }\\
\end{matrix}
\right\}
\longrightarrow
\left\{
\begin{matrix}
\text{families of quotients }f_i^*\mathcal{F} \to \mathcal{Q}_i
\text{ where } \\
\mathcal{Q}_i\text{ is quasi-coherent and }
\mathcal{Q}_i\text{ and }\mathcal{Q}_j\\
\text{ restrict to the same quotient on }X_{ijk}
\end{matrix}
\right\}
$$
Namely, let $(f_i^*\mathcal{F} \to \mathcal{Q}_i)_{i \in I}$
be an element of the right hand side. Then since
$\{X_{ijk} \to X_i \times_X X_j\}$ is an fpqc covering we see that
the pullbacks of $\mathcal{Q}_i$ and $\mathcal{Q}_j$ restrict
to the same quotient of the pullback of $\mathcal{F}$ to $X_i \times_X X_j$
(by fully faithfulness in
Descent on Spaces, Proposition
\ref{spaces-descent-proposition-fpqc-descent-quasi-coherent}).
Hence we obtain a descent datum for quasi-coherent modules
with respect to $\{X_i \to X\}_{i \in I}$. By
Descent on Spaces, Proposition
\ref{spaces-descent-proposition-fpqc-descent-quasi-coherent}
we find a map of quasi-coherent $\mathcal{O}_X$-modules
$\mathcal{F} \to \mathcal{Q}$ whose restriction to $X_i$ recovers
the given maps $f_i^*\mathcal{F} \to \mathcal{Q}_i$.
Since the family of morphisms $\{X_i \to X\}$ is jointly surjective
and flat, for every point $x \in |X|$ there exists an $i$ and a point
$x_i \in |X_i|$ mapping to $x$. Note that the induced map on
local rings
$\mathcal{O}_{X, \overline{x}} \to \mathcal{O}_{X_i, \overline{x_i}}$
is faithfully flat, see
Morphisms of Spaces, Section \ref{spaces-morphisms-section-flat}.
Thus we see that $\mathcal{F} \to \mathcal{Q}$ is surjective.
\end{remark}

\begin{lemma}
\label{lemma-q-sheaf}
In Situation \ref{situation-q}. The functors
$\text{Q}_{\mathcal{F}/X/B}$ and
$\text{Q}^{fp}_{\mathcal{F}/X/B}$
satisfy the sheaf property for the fpqc topology.
\end{lemma}

\begin{proof}
Let $\{T_i \to T\}_{i \in I}$ be an fpqc covering of schemes over $S$.
Set $X_i = X_{T_i} = X \times_S T_i$ and $\mathcal{F}_i = \mathcal{F}_{T_i}$.
Note that $\{X_i \to X_T\}_{i \in I}$ is an fpqc covering of
$X_T$ (Topologies on Spaces, Lemma \ref{spaces-topologies-lemma-fpqc})
and that $X_{T_i \times_T T_{i'}} = X_i \times_{X_T} X_{i'}$.
Suppose that $\mathcal{F}_i \to \mathcal{Q}_i$ is a collection of
elements of $\text{Q}_{\mathcal{F}/X/B}(T_i)$ such that $\mathcal{Q}_i$
and $\mathcal{Q}_{i'}$ restrict to the same element of
$\text{Q}_{\mathcal{F}/X/B}(T_i \times_T T_{i'})$. By
Remark \ref{remark-q-sheaf}
we obtain a surjective map of quasi-coherent $\mathcal{O}_{X_T}$-modules
$\mathcal{F}_T \to \mathcal{Q}$ whose restriction to $X_i$ recovers
the given quotients.
By Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-flat-permanence}
we see that $\mathcal{Q}$ is flat over $T$. Finally, in the case of
$\text{Q}^{fp}_{\mathcal{F}/X/B}$, i.e., if $\mathcal{Q}_i$ are
of finite presentation, then
Descent on Spaces, Lemma
\ref{spaces-descent-lemma-finite-presentation-descends}
guarantees that $\mathcal{Q}$ is of finite presentation as an
$\mathcal{O}_{X_T}$-module.
\end{proof}

\begin{lemma}
\label{lemma-q-sheaf-in-X}
In Situation \ref{situation-q} let $\{X_i \to X\}_{i \in I}$ be an fpqc
covering and for each $i, j \in I$ let $\{X_{ijk} \to X_i \times_X X_j\}$
be an fpqc covering. Denote $\mathcal{F}_i$, resp.\ $\mathcal{F}_{ijk}$
the pullback of $\mathcal{F}$ to $X_i$, resp.\ $X_{ijk}$. For every scheme
$T$ over $B$ the diagram
$$
\xymatrix{
Q_{\mathcal{F}/X/B}(T) \ar[r] &
\prod\nolimits_i
Q_{\mathcal{F}_i/X_i/B}(T)
\ar@<1ex>[r]^-{\text{pr}_0^*} \ar@<-1ex>[r]_-{\text{pr}_1^*}
&
\prod\nolimits_{i, j, k}
Q_{\mathcal{F}_{ijk}/X_{ijk}/B}(T)
}
$$
presents the first arrow as the equalizer of the other two.
The same is true for the functor $\text{Q}^{fp}_{\mathcal{F}/X/B}$.
\end{lemma}

\begin{proof}
Let $\mathcal{F}_{i, T} \to \mathcal{Q}_i$ be an element in the equalizer
of $\text{pr}_0^*$ and $\text{pr}_1^*$. By Remark \ref{remark-q-sheaf}
we obtain a surjection $\mathcal{F}_T \to \mathcal{Q}$ of quasi-coherent
$\mathcal{O}_{X_T}$-modules whose restriction to $X_{i, T}$ recovers
$\mathcal{F}_i \to \mathcal{Q}_i$.
By Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-flat-permanence}
we see that $\mathcal{Q}$ is flat over $T$ as desired.
In the case of the functor $\text{Q}^{fp}_{\mathcal{F}/X/B}$, i.e.,
if $\mathcal{Q}_i$ is of finite presentation, then
$\mathcal{Q}$ is of finite presentation too by
Descent on Spaces, Lemma
\ref{spaces-descent-lemma-finite-presentation-descends}.
\end{proof}

\begin{lemma}
\label{lemma-q-limit-preserving}
In Situation \ref{situation-q} assume also that
(a) $f$ is quasi-compact and quasi-separated and
(b) $\mathcal{F}$ is of finite presentation.
Then the functor $\text{Q}^{fp}_{\mathcal{F}/X/B}$
is limit preserving in the following sense: If $T = \lim T_i$ is a
directed limit of affine schemes over $B$, then
$\text{Q}^{fp}_{\mathcal{F}/X/B}(T) =
\colim \text{Q}^{fp}_{\mathcal{F}/X/B}(T_i)$.
\end{lemma}

\begin{proof}
Let $T = \lim T_i$ be as in the statement of the lemma.
Choose $i_0 \in I$ and replace $I$ by $\{i \in I \mid i \geq i_0\}$.
We may set $B = S = T_{i_0}$ and we may replace $X$ by $X_{T_0}$
and $\mathcal{F}$ by the pullback to $X_{T_0}$. Then
$X_T = \lim X_{T_i}$, see
Limits of Spaces, Lemma
\ref{spaces-limits-lemma-directed-inverse-system-has-limit}.
Let $\mathcal{F}_T \to \mathcal{Q}$ be an element of
$\text{Q}^{fp}_{\mathcal{F}/X/B}(T)$. By
Limits of Spaces, Lemma
\ref{spaces-limits-lemma-descend-modules-finite-presentation}
there exists an $i$ and a map $\mathcal{F}_{T_i} \to \mathcal{Q}_i$
of $\mathcal{O}_{X_{T_i}}$-modules of finite presentation whose
pullback to $X_T$ is the given quotient map.

\medskip\noindent
We still have to check that, after possibly increasing $i$, the map
$\mathcal{F}_{T_i} \to \mathcal{Q}_i$ is surjective and $\mathcal{Q}_i$
is flat over $T_i$. To do this, choose an affine scheme $U$ and a
surjective \'etale morphism $U \to X$ (see Properties of Spaces,
Lemma \ref{spaces-properties-lemma-quasi-compact-affine-cover}).
We may check surjectivity and flatness over $T_i$ after pulling
back to the \'etale cover $U_{T_i} \to X_{T_i}$ (by definition).
This reduces us to the case where $X = \Spec(B_0)$ is an affine scheme of
finite presentation over $B = S = T_0 = \Spec(A_0)$.
Writing $T_i = \Spec(A_i)$, then $T = \Spec(A)$ with $A = \colim A_i$
we have reached the following algebra problem. Let $M_i \to N_i$
be a map of finitely presented $B_0 \otimes_{A_0} A_i$-modules
such that $M_i \otimes_{A_i} A \to N_i \otimes_{A_i} A$ is surjective
and $N_i \otimes_{A_i} A$ is flat over $A$. Show that for some $i' \geq i$
$M_i \otimes_{A_i} A_{i'} \to N_i \otimes_{A_i} A_{i'}$ is surjective
and $N_i \otimes_{A_i} A_{i'}$ is flat over $A$.
The first follows from
Algebra, Lemma \ref{algebra-lemma-module-map-property-in-colimit}
and the second from
Algebra, Lemma \ref{algebra-lemma-flat-finite-presentation-limit-flat}.
\end{proof}

\begin{lemma}
\label{lemma-q-RS-star}
In Situation \ref{situation-q}. Let
$$
\xymatrix{
Z \ar[r] \ar[d] & Z' \ar[d] \\
Y \ar[r] & Y'
}
$$
be a pushout in the category of schemes over $B$ where
$Z \to Z'$ is a thickening and $Z \to Y$ is affine, see
More on Morphisms, Lemma \ref{more-morphisms-lemma-pushout-along-thickening}.
Then the natural map
$$
Q_{\mathcal{F}/X/B}(Y') \longrightarrow
Q_{\mathcal{F}/X/B}(Y) \times_{Q_{\mathcal{F}/X/B}(Z)} Q_{\mathcal{F}/X/B}(Z')
$$
is bijective. If $X \to B$ is locally of finite presentation, then
the same thing is true for $Q^{fp}_{\mathcal{F}/X/B}$.
\end{lemma}

\begin{proof}
Let us construct an inverse map. Namely, suppose we have
$\mathcal{F}_Y \to \mathcal{A}$,
$\mathcal{F}_{Z'} \to \mathcal{B}'$, and an isomorphism
$\mathcal{A}|_{X_Z} \to \mathcal{B}'|_{X_Z}$
compatible with the given surjections.
Then we apply Pushouts of Spaces, Lemma
\ref{spaces-pushouts-lemma-space-over-pushout-flat-modules}
to get a quasi-coherent module $\mathcal{A}'$ on $X_{Y'}$
flat over $Y'$. Since this sheaf is constructed as a fibre product
(see proof of cited lemma) there is a canonical map
$\mathcal{F}_{Y'} \to \mathcal{A}'$. That this map is surjective
can be seen because it factors as
$$
\begin{matrix}
\mathcal{F}_{Y'} \\
\downarrow \\
(X_Y \to X_{Y'})_*\mathcal{F}_Y
\times_{(X_Z \to X_{Y'})_*\mathcal{F}_Z}
(X_{Z'} \to X_{Y'})_*\mathcal{F}_{Z'} \\
\downarrow \\
\mathcal{A}' =
(X_Y \to X_{Y'})_*\mathcal{A}
\times_{(X_Z \to X_{Y'})_*\mathcal{A}|_{X_Z}}
(X_{Z'} \to X_{Y'})_*\mathcal{B}'
\end{matrix}
$$
and the first arrow is surjective by
More on Algebra, Lemma \ref{more-algebra-lemma-module-over-fibre-product-bis}
and the second by
More on Algebra, Lemma
\ref{more-algebra-lemma-surjection-module-over-fibre-product}.

\medskip\noindent
In the case of $Q^{fp}_{\mathcal{F}/X/B}$ all we have to show is that
the construction above produces a finitely presented module.
This is explained in
More on Algebra, Remark
\ref{more-algebra-remark-relative-modules-over-fibre-product}
in the commutative algebra setting. The current case of modules
over algebraic spaces follows from this
by \'etale localization.
\end{proof}

\begin{remark}[Obstructions for quotients]
\label{remark-q-obs}
In Situation \ref{situation-q} {\bf assume} that $\mathcal{F}$ is flat
over $B$. Let $T \subset T'$ be an first order
thickening of schemes over $B$ with ideal sheaf $\mathcal{J}$. Then
$X_T \subset X_{T'}$ is a first order thickening of algebraic spaces
whose ideal sheaf $\mathcal{I}$ is a quotient of $f_T^*\mathcal{J}$.
We will think of sheaves on $X_{T'}$, resp.\ $T'$ as sheaves on
$X_T$, resp.\ $T$ using the fundamental equivalence described in
More on Morphisms of Spaces, Section
\ref{spaces-more-morphisms-section-thickenings}.
Let
$$
0 \to \mathcal{K} \to \mathcal{F}_T \to \mathcal{Q} \to 0
$$
define an element $x$ of $Q_{\mathcal{F}/X/B}(T)$. Since $\mathcal{F}_{T'}$
is flat over $T'$ we have a short exact sequence
$$
0 \to f_T^*\mathcal{J} \otimes_{\mathcal{O}_{X_T}} \mathcal{F}_T
\xrightarrow{i} \mathcal{F}_{T'} \xrightarrow{\pi} \mathcal{F}_T \to 0
$$
and we have
$f_T^*\mathcal{J} \otimes_{\mathcal{O}_{X_T}} \mathcal{F}_T =
\mathcal{I} \otimes_{\mathcal{O}_{X_T}} \mathcal{F}_T$, see
Deformation Theory, Lemma \ref{defos-lemma-deform-module-ringed-topoi}.
Let us use the abbreviation
$
f_T^*\mathcal{J} \otimes_{\mathcal{O}_{X_T}} \mathcal{G} =
\mathcal{G} \otimes_{\mathcal{O}_T} \mathcal{J}
$
for an $\mathcal{O}_{X_T}$-module $\mathcal{G}$.
Since $\mathcal{Q}$ is flat over $T$, we obtain a short exact sequence
$$
0 \to
\mathcal{K} \otimes_{\mathcal{O}_T} \mathcal{J} \to
\mathcal{F}_T \otimes_{\mathcal{O}_T} \mathcal{J} \to
\mathcal{Q} \otimes_{\mathcal{O}_T} \mathcal{J} \to
\to 0
$$
Combining the above we obtain an canonical extension
$$
0 \to \mathcal{Q} \otimes_{\mathcal{O}_T} \mathcal{J} \to
\pi^{-1}(\mathcal{K})/i(\mathcal{K} \otimes_{\mathcal{O}_T} \mathcal{J}) \to
\mathcal{K} \to 0
$$
of $\mathcal{O}_{X_T}$-modules. This defines a canonical class
$$
o_x(T') \in
\text{Ext}^1_{\mathcal{O}_{X_T}}(\mathcal{K},
\mathcal{Q} \otimes_{\mathcal{O}_T} \mathcal{J})
$$
If $o_x(T')$ is zero, then we obtain a splitting of the short
exact sequence defining it, in other words, we obtain a
$\mathcal{O}_{X_{T'}}$-submodule
$\mathcal{K}' \subset \pi^{-1}(\mathcal{K})$ sitting in a short
exact sequence
$0 \to \mathcal{K} \otimes_{\mathcal{O}_T} \mathcal{J} \to
\mathcal{K}' \to \mathcal{K} \to 0$.
Then it follows from the lemma reference above that
$\mathcal{Q}' = \mathcal{F}_{T'}/\mathcal{K}'$
is a lift of $x$ to an element of $Q_{\mathcal{F}/X/B}(T')$.
Conversely, the reader sees that the existence of
a lift implies that $o_x(T')$ is zero. Moreover, if
$x \in Q_{\mathcal{F}/X/B}^{fp}(T)$, then automatically
$x' \in Q_{\mathcal{F}/X/B}^{fp}(T')$ by
Deformation Theory, Lemma \ref{defos-lemma-deform-fp-module-ringed-topoi}.
If we ever need this
remark we will turn this remark into a lemma, precisely formulate
the result and give a detailed proof (in fact, all of the above
works in the setting of arbitrary ringed topoi).
\end{remark}

\begin{remark}[Deformations of quotients]
\label{remark-q-defos}
In Situation \ref{situation-q} {\bf assume} that $\mathcal{F}$ is flat
over $B$. We continue the discussion of Remark \ref{remark-q-obs}.
Assume $o_x(T') = 0$. Then we claim that the set of lifts
$x' \in Q_{\mathcal{F}/X/B}(T')$ is a principal homogeneous space
under the group
$$
\Hom_{\mathcal{O}_{X_T}}(\mathcal{K},
\mathcal{Q} \otimes_{\mathcal{O}_T} \mathcal{J})
$$
Namely, given any $\mathcal{F}_{T'} \to \mathcal{Q}'$ flat over $T'$
lifting the quotient $\mathcal{Q}$ we obtain a commutative diagram
with exact rows and columns
$$
\xymatrix{
& 0 \ar[d] & 0 \ar[d] & 0 \ar[d] \\
0 \ar[r] &
\mathcal{K} \otimes \mathcal{J} \ar[r] \ar[d] &
\mathcal{F}_T \otimes \mathcal{J} \ar[r] \ar[d] &
\mathcal{Q} \otimes \mathcal{J} \ar[r] \ar[d] &
0 \\
0 \ar[r] &
\mathcal{K}' \ar[r] \ar[d] &
\mathcal{F}_{T'} \ar[r] \ar[d] &
\mathcal{Q}' \ar[r] \ar[d] &
0 \\
0 \ar[r] &
\mathcal{K} \ar[d] \ar[r] &
\mathcal{F}_T \ar[d] \ar[r] &
\mathcal{Q} \ar[d] \ar[r] &
0 \\
& 0 & 0 & 0
}
$$
(to see this use the observations made in the previous remark).
Given a map $\varphi : \mathcal{K} \to \mathcal{Q} \otimes \mathcal{J}$
we can consider the subsheaf $\mathcal{K}'_\varphi \subset \mathcal{F}_{T'}$
consisting of those local sections $s$
whose image in $\mathcal{F}_T$ is a local section $k$ of $\mathcal{K}$
and whose image in $\mathcal{Q}'$ is the local section $\varphi(k)$ of
$\mathcal{Q} \otimes \mathcal{J}$. Then set
$\mathcal{Q}'_\varphi = \mathcal{F}_{T'}/\mathcal{K}'_\varphi$.
Conversely, any second lift of $x$ corresponds to one the
qotients constructed in this manner. If we ever need this
remark we will turn this remark into a lemma, precisely formulate
the result and give a detailed proof (in fact, all of the above
works in the setting of arbitrary ringed topoi).
\end{remark}










\section{The Quot functor}
\label{section-quot}

\noindent
In this section we prove the Quot functor is an algebraic space.

\begin{situation}
\label{situation-quot}
Let $S$ be a scheme. Let $f : X \to B$ be a morphism of
algebraic spaces over $S$. Assume that $f$ is of finite presentation.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
For any scheme $T$ over $B$ we will denote $X_T$ the base change of
$X$ to $T$ and $\mathcal{F}_T$ the pullback
of $\mathcal{F}$ via the projection morphism $X_T = X \times_S T \to X$.
Given such a $T$ we set
$$
\text{Quot}_{\mathcal{F}/X/B}(T) =
\left\{
\begin{matrix}
\text{quotients }\mathcal{F}_T \to \mathcal{Q}\text{ where }
\mathcal{Q}\text{ is a quasi-coherent }\\
\mathcal{O}_{X_T}\text{-module of finite presentation, flat over }T\\
\text{with support proper over }T
\end{matrix}
\right\}
$$
By Derived Categories of Spaces, Lemma
\ref{spaces-perfect-lemma-base-change-module-support-proper-over-base}
this is a subfunctor of the functor $Q^{fp}_{\mathcal{F}/X/B}$
we discussed in Section \ref{section-functor-quotients}.
Thus we obtain a functor
\begin{equation}
\label{equation-quot}
\text{Quot}_{\mathcal{F}/X/B} : (\Sch/B)^{opp} \longrightarrow \textit{Sets}
\end{equation}
This is the {\it Quot functor} associated to $\mathcal{F}/X/B$.
\end{situation}

\noindent
In Situation \ref{situation-quot} we sometimes think of
$\text{Quot}_{\mathcal{F}/X/B}$ as a functor
$(\Sch/S)^{opp} \to \textit{Sets}$ endowed
with a morphism $\text{Quot}_{\mathcal{F}/X/B} \to B$.
Namely, if $T$ is a scheme over $S$, then an element
of $\text{Quot}_{\mathcal{F}/X/B}(T)$ is a pair $(h, \mathcal{Q})$
where $h$ is a morphism $h : T \to B$
and $Q$ is a finitely presented, $T$-flat quotient
$\mathcal{F}_T \to \mathcal{Q}$ on $X_T = X \times_{B, h} T$
with support proper over $T$. In particular, when we say
that $\text{Quot}_{\mathcal{F}/X/B}$ is an algebraic space, we mean that the
corresponding functor $(\Sch/S)^{opp} \to \textit{Sets}$ is an algebraic space.

\begin{lemma}
\label{lemma-quot-sheaf}
In Situation \ref{situation-quot}. The functor $\text{Quot}_{\mathcal{F}/X/B}$
satisfies the sheaf property for the fpqc topology.
\end{lemma}

\begin{proof}
In Lemma \ref{lemma-q-sheaf} we have seen that the functor
$\text{Q}^{fp}_{\mathcal{F}/X/S}$ is a sheaf. Recall that for a
scheme $T$ over $S$ the subset
$\text{Quot}_{\mathcal{F}/X/S}(T) \subset \text{Q}_{\mathcal{F}/X/S}(T)$
picks out those quotients whose support is proper over $T$.
This defines a subsheaf by the result of
Descent on Spaces, Lemma \ref{spaces-descent-lemma-descending-property-proper}
combined with
Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-flat-pullback-support}
which shows that taking scheme theoretic support commutes
with flat base change.
\end{proof}

\begin{proposition}
\label{proposition-quot}
Let $S$ be a scheme. Let $f : X \to B$ be a morphism of algebraic
spaces over $S$. Let $\mathcal{F}$ be a quasi-coherent sheaf
on $X$. If $f$ is of finite presentation and separated, then
$\text{Quot}_{\mathcal{F}/X/B}$
is an algebraic space. If $\mathcal{F}$ is of finite presentation,
then $\text{Quot}_{\mathcal{F}/X/B} \to B$ is locally of finite presentation.
\end{proposition}

\begin{proof}
By Lemma \ref{lemma-quot-sheaf}
we have that $\text{Quot}_{\mathcal{F}/X/B}$ is a sheaf in the
fppf topology. Let $\textit{Quot}_{\mathcal{F}/X/B}$ be the stack in
groupoids corresponding to $\text{Quot}_{\mathcal{F}/X/S}$, see
Algebraic Stacks, Section \ref{algebraic-section-split}.
By Algebraic Stacks, Proposition
\ref{algebraic-proposition-algebraic-stack-no-automorphisms}
it suffices to show that $\textit{Quot}_{\mathcal{F}/X/B}$
is an algebraic stack.
Consider the $1$-morphism of stacks in groupoids
$$
\textit{Quot}_{\mathcal{F}/X/S}
\longrightarrow
\textit{Coh}_{X/B}
$$
on $(\Sch/S)_{fppf}$ which associates to the quotient
$\mathcal{F}_T \to \mathcal{Q}$ the coherent sheaf $\mathcal{Q}$.
By Theorem \ref{theorem-coherent-algebraic-general} we know that
$\textit{Coh}_{X/B}$ is an algebraic stack.
By Algebraic Stacks, Lemma
\ref{algebraic-lemma-representable-morphism-to-algebraic}
it suffices to show that this $1$-morphism is representable
by algebraic spaces.

\medskip\noindent
Let $T$ be a scheme over $S$ and let the object $(h, \mathcal{G})$ of
$\textit{Coh}_{X/B}$ over $T$ correspond
to a $1$-morphism $\xi : (\Sch/T)_{fppf} \to \textit{Coh}_{X/B}$.
The $2$-fibre product
$$
\mathcal{Z} =
(\Sch/T)_{fppf}
\times_{\xi, \textit{Coh}_{X/B}}
\textit{Quot}_{\mathcal{F}/X/S}
$$
is a stack in setoids, see
Stacks, Lemma \ref{stacks-lemma-2-fibre-product-gives-stack-in-setoids}.
The corresponding sheaf of sets (i.e., functor, see
Stacks, Lemmas
\ref{stacks-lemma-2-fibre-product-gives-stack-in-setoids} and
\ref{stacks-lemma-when-stack-in-sets}) assigns to a scheme
$T'/T$ the set of surjections $u : \mathcal{F}_{T'} \to \mathcal{G}_{T'}$
of quasi-coherent modules on $X_{T'}$. Thus we see that
$\mathcal{Z}$ is representable by an open subspace
(by Flatness on Spaces, Lemma \ref{spaces-flat-lemma-F-surj-open})
of the algebraic space
$\mathit{Hom}(\mathcal{F}_T, \mathcal{G})$ from
Proposition \ref{proposition-hom}.
\end{proof}

\begin{remark}[Quot via Artin's axioms]
\label{remark-quot-via-artins-axioms}
Let $S$ be a Noetherian scheme all of whose local rings are G-rings.
Let $X$ be an algebraic space over $S$ whose structure morphism
$f : X \to S$ is of finite presentation and separated.
Let $\mathcal{F}$ be a finitely presented quasi-coherent sheaf
on $X$ flat over $S$. In this remark we sketch how one can
use Artin's axioms to prove that $\text{Quot}_{\mathcal{F}/X/S}$
is an algebraic space locally of finite presentation over $S$
and avoid using the algebraicity of the stack of coherent sheaves
as was done in the proof of Proposition \ref{proposition-quot}.

\medskip\noindent
We check the conditions listed in Artin's Axioms, Proposition
\ref{artin-proposition-spaces-diagonal-representable}.
Representability of the diagonal of $\text{Quot}_{\mathcal{F}/X/S}$
can be seen as follows: suppose we have two quotients
$\mathcal{F}_T \to \mathcal{Q}_i$, $i = 1, 2$. Denote
$\mathcal{K}_1$ the kernel of the first one. Then we have
to show that the locus of $T$ over which
$u : \mathcal{K}_1 \to \mathcal{Q}_2$ becomes zero is representable.
This follows for example from Flatness on Spaces, Lemma
\ref{spaces-flat-lemma-F-zero-closed-proper}
or from a discussion of the $\mathit{Hom}$ sheaf earlier
in this chapter. Axioms [0] (sheaf), [1] (limits), [2] (Rim-Schlessinger)
follow from Lemmas \ref{lemma-quot-sheaf},
\ref{lemma-q-limit-preserving}, and \ref{lemma-q-RS-star}
(plus some extra work to deal with the properness condition).
Axiom [3] (finite dimensionality of tangent spaces)
follows from the description of the infinitesimal
deformations in Remark \ref{remark-q-defos}
and finiteness of cohomology of coherent sheaves on proper
algebraic spaces over fields (Cohomology of Spaces, Lemma
\ref{spaces-cohomology-lemma-proper-pushforward-coherent}).
Axiom [4] (effectiveness of formal objects)
follows from Grothendieck's existence theorem
(More on Morphisms of Spaces, Theorem
\ref{spaces-more-morphisms-theorem-grothendieck-existence}).
As usual, the trickiest to verify is axiom [5] (openness of versality).
One can for example use the obstruction theory described
in Remark \ref{remark-q-obs} and the description of
deformations in Remark \ref{remark-q-defos}
to do this using the criterion in
Artin's Axioms, Lemma \ref{artin-lemma-get-openness-obstruction-theory}.
Please compare with the second proof of
Lemma \ref{lemma-coherent-defo-thy}.
\end{remark}









\section{The Hilbert functor}
\label{section-hilb}

\noindent
In this section we prove the Hilb functor is an algebraic space.

\begin{situation}
\label{situation-hilb}
Let $S$ be a scheme. Let $f : X \to B$ be a morphism of
algebraic spaces over $S$. Assume that $f$ is of finite presentation.
For any scheme $T$ over $B$ we will denote $X_T$ the base change of
$X$ to $T$. Given such a $T$ we set
$$
\text{Hilb}_{X/B}(T) =
\left\{
\begin{matrix}
\text{closed subspaces }Z \subset X_T\text{ such that }Z \to T\\
\text{is of finite presentation, flat, and proper}
\end{matrix}
\right\}
$$
Since base change preserves the required properties
(Spaces, Lemma \ref{spaces-lemma-base-change-immersions} and
Morphisms of Spaces, Lemmas
\ref{spaces-morphisms-lemma-base-change-finite-presentation},
\ref{spaces-morphisms-lemma-base-change-flat}, and
\ref{spaces-morphisms-lemma-base-change-proper})
we obtain a functor
\begin{equation}
\label{equation-hilb}
\text{Hilb}_{X/B} : (\Sch/B)^{opp} \longrightarrow \textit{Sets}
\end{equation}
This is the {\it Hilbert functor} associated to $X/B$.
\end{situation}

\noindent
In Situation \ref{situation-hilb} we sometimes think of $\text{Hilb}_{X/B}$
as a functor $(\Sch/S)^{opp} \to \textit{Sets}$ endowed with a morphism
$\text{Hilb}_{X/S} \to B$. Namely, if $T$ is a scheme over $S$, then an element
of $\text{Hilb}_{X/B}(T)$ is a pair $(h, Z)$
where $h$ is a morphism $h : T \to B$
and $Z \subset X_T = X \times_{B, h} T$
is a closed subscheme, flat, proper, and of finite
presentation over $T$. In particular, when we say
that $\text{Hilb}_{X/B}$ is an algebraic space, we mean that the
corresponding functor $(\Sch/S)^{opp} \to \textit{Sets}$ is an algebraic space.

\medskip\noindent
Of course the Hilbert functor is just a special case of the
Quot functor.

\begin{lemma}
\label{lemma-hilb-is-quot}
In Situation \ref{situation-hilb} we have
$\text{Hilb}_{X/B} = \text{Quot}_{\mathcal{O}_X/X/B}$.
\end{lemma}

\begin{proof}
Let $T$ be a scheme over $B$. Given an element
$Z \in \text{Hilb}_{X/B}(T)$ we can consider the
quotient $\mathcal{O}_{X_T} \to i_*\mathcal{O}_Z$
where $i : Z \to X_T$ is the inclusion morphism.
Note that $i_*\mathcal{O}_Z$ is quasi-coherent.
Since $Z \to T$ and $X_T \to T$ are of finite presentation,
we see that $i$ is of finite presentation (Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-finite-presentation-permanence}), hence
$i_*\mathcal{O}_Z$ is an $\mathcal{O}_{X_T}$-module of
finite presentation (Descent on Spaces, Lemma
\ref{spaces-descent-lemma-finite-finitely-presented-module}).
Since $Z \to T$ is proper we see that $i_*\mathcal{O}_Z$
has support proper over $T$ (as defined in
Derived Categories of Spaces, Section
\ref{spaces-perfect-section-proper-over-base}).
Since $\mathcal{O}_Z$ is flat
over $T$ and $i$ is affine, we see that $i_*\mathcal{O}_Z$
is flat over $T$ (small argument omitted). Hence
$\mathcal{O}_{X_T} \to i_*\mathcal{O}_Z$
is an element of $\text{Quot}_{\mathcal{O}_X/X/B}(T)$.

\medskip\noindent
Conversely, given an element $\mathcal{O}_{X_T} \to \mathcal{Q}$
of $\text{Quot}_{\mathcal{O}_X/X/B}(T)$, we can consider
the closed immersion $i : Z \to X_T$ corresponding to
the quasi-coherent ideal sheaf
$\mathcal{I} = \Ker(\mathcal{O}_{X_T} \to \mathcal{Q})$
(Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-closed-immersion-ideals}).
By construction of $Z$ we see that $\mathcal{Q} = i_*\mathcal{O}_Z$.
Then we can read the arguments given above backwards to see
that $Z$ defines an element of $\text{Hilb}_{X/B}(T)$.
For example, $\mathcal{I}$ is quasi-coherent of finite type
(Modules on Sites, Lemma
\ref{sites-modules-lemma-kernel-surjection-finite-onto-finite-presentation})
hence $i : Z \to X_T$ is of finite presentation
(Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-closed-immersion-finite-presentation})
hence $Z \to T$ is of finite presentation
(Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-composition-finite-presentation}).
Properness of $Z \to T$ follows from the discussion in
Derived Categories of Spaces, Section
\ref{spaces-perfect-section-proper-over-base}.
Flatness of $Z \to T$ follows from flatness of $\mathcal{Q}$ over $T$.

\medskip\noindent
We omit the (immediate) verification that the two constructions given
above are mutually inverse.
\end{proof}

\begin{proposition}
\label{proposition-hilb}
Let $S$ be a scheme. Let $f : X \to B$ be a morphism of algebraic
spaces over $S$. If $f$ is of finite presentation and separated, then
$\text{Hilb}_{X/B}$ is an algebraic space locally of finite
presentation over $B$.
\end{proposition}

\begin{proof}
Immediate consequence of
Lemma \ref{lemma-hilb-is-quot}
and Proposition \ref{proposition-quot}.
\end{proof}






\section{The Picard stack}
\label{section-picard-stack}

\noindent
The Picard stack for a morphism of algebraic spaces was introduced
in Examples of Stacks, Section \ref{examples-stacks-section-picard-stack}.
We will deduce it is an open substack of the stack of coherent sheaves
(in good cases) from the following lemma.

\begin{lemma}
\label{lemma-picard-stack-open-in-coh}
Let $S$ be a scheme. Let $f : X \to B$ be a morphism of algebraic spaces
over $S$ which is flat, of finite presentation, and proper.
Then natural map
$$
\textit{Pic}_{X/B} \longrightarrow \textit{Coh}_{X/B}
$$
is representable by open immersions.
\end{lemma}

\begin{proof}
Observe that the map simply sends a triple $(T, g, \mathcal{L})$
as in Examples of Stacks, Section \ref{examples-stacks-section-picard-stack}
to the same triple $(T, g, \mathcal{L})$ but where now we view
this as a triple of the kind described in
Situation \ref{situation-coherent}.
This works because the invertible $\mathcal{O}_{X_T}$-module
$\mathcal{L}$ is certainly a finitely presented $\mathcal{O}_{X_T}$-module,
it is flat over $T$ because $X_T \to T$ is flat, and the support is
proper over $T$ as $X_T \to T$ is proper
(Morphisms of Spaces, Lemmas \ref{spaces-morphisms-lemma-base-change-flat}
and \ref{spaces-morphisms-lemma-base-change-proper}).
Thus the statement makes sense.

\medskip\noindent
Having said this, it is clear that the content of the lemma is the
following: given an object $(T, g, \mathcal{F})$ of
$\textit{Coh}_{X/B}$ there is an open subscheme $U \subset T$
such that for a morphism of schemes $T' \to T$ the following
are equivalent
\begin{enumerate}
\item[(a)] $T' \to T$ factors through $U$,
\item[(b)] the pullback $\mathcal{F}_{T'}$ of
$\mathcal{F}$ by $X_{T'} \to X_T$ is invertible.
\end{enumerate}
Let $W \subset |X_T|$ be the set of points $x \in |X_T|$
such that $\mathcal{F}$ is locally free in a neighbourhood of $x$. By
More on Morphisms of Spaces, Lemma
\ref{spaces-more-morphisms-lemma-finite-free-open}.
$W$ is open and formation
of $W$ commutes with arbitrary base change.
Clearly, if $T' \to T$ satisfies (b), then $|X_{T'}| \to |X_T|$
maps into $W$. Hence we may replace $T$ by the open
$T \setminus f_T(|X_T| \setminus W)$ in order
to construct $U$. After doing so we reach the situation
where $\mathcal{F}$ is finite locally free.
In this case we get a disjoint union decomposition
$X_T = X_0 \amalg X_1 \amalg X_2 \amalg \ldots$
into open and closed subspaces such that the restriction of
$\mathcal{F}$ is locally free of rank $i$ on $X_i$. Then clearly
$$
U = T \setminus f_T(|X_0| \cup |X_2| \cup |X_3| \cup \ldots )
$$
works. (Note that if we assume that $T$ is quasi-compact, then
$X_T$ is quasi-compact hence only a finite number of $X_i$
are nonempty and so $U$ is indeed open.)
\end{proof}

\begin{proposition}
\label{proposition-pic}
Let $S$ be a scheme. Let $f : X \to B$ be a morphism of algebraic
spaces over $S$. If $f$ is flat, of finite presentation, and proper, then
$\textit{Pic}_{X/B}$ is an algebraic stack.
\end{proposition}

\begin{proof}
Immediate consequence of
Lemma \ref{lemma-picard-stack-open-in-coh},
Algebraic Stacks, Lemma
\ref{algebraic-lemma-representable-morphism-to-algebraic}
and either
Theorem \ref{theorem-coherent-algebraic}
or
Theorem \ref{theorem-coherent-algebraic-general}
\end{proof}








\section{Relative morphisms}
\label{section-relative-morphisms}

\noindent
We continue the discussion from Criteria for Representability, Section
\ref{criteria-section-relative-morphisms}.
In that section, starting with a scheme $S$ and morphisms
of algebraic spaces $Z \to B$ and $X \to B$ over $S$
we constructed a functor
$$
\mathit{Mor}_B(Z, X) : (\Sch/B)^{opp} \longrightarrow \textit{Sets}, \quad
T \longmapsto \{f : Z_T \to X_T\}
$$
We sometimes think of $\mathit{Mor}_B(Z, X)$
as a functor $(\Sch/S)^{opp} \to \textit{Sets}$ endowed with a morphism
$\mathit{Mor}_B(Z, X) \to B$.
Namely, if $T$ is a scheme over $S$, then an element
of $\mathit{Mor}_B(Z, X)(T)$ is a pair $(f, h)$
where $h$ is a morphism $h : T \to B$
and $f : Z \times_{B, h} T \to X \times_{B, h} T$
is a morphism of algebraic spaces over $T$. In particular, when we say
that $\mathit{Mor}_B(Z, X)$ is an algebraic space, we mean that the
corresponding functor $(\Sch/S)^{opp} \to \textit{Sets}$ is an algebraic space.

\begin{lemma}
\label{lemma-Mor-into-Hilb}
Let $S$ be a scheme. Consider morphisms
of algebraic spaces $Z \to B$ and $X \to B$ over $S$.
If $X \to B$ is separated and $Z \to B$ is
of finite presentation, flat, and proper,
then there is a natural
injective transformation of functors
$$
\mathit{Mor}_B(Z, X) \longrightarrow \text{Hilb}_{Z \times_B X/B}
$$
which maps a morphism $f : Z_T \to X_T$ to its graph.
\end{lemma}

\begin{proof}
Given a scheme $T$ over $B$ and a morphism $f_T : Z_T \to X_T$
over $T$, the graph of $f$ is the morphism
$\Gamma_f = (\text{id}, f) : Z_T \to Z_T \times_T X_T = (Z \times_B X)_T$.
Recall that being separated, flat, proper, or finite presentation
are properties of morphisms of algebraic spaces which are stable
under base change (Morphisms of Spaces, Lemmas
\ref{spaces-morphisms-lemma-base-change-separated},
\ref{spaces-morphisms-lemma-base-change-flat},
\ref{spaces-morphisms-lemma-base-change-proper}, and
\ref{spaces-morphisms-lemma-base-change-finite-presentation}).
Hence $\Gamma_f$ is a closed immersion by
Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-semi-diagonal}.
Moreover, $\Gamma_f(Z_T)$ is flat, proper, and of finite presentation over $T$.
Thus $\Gamma_f(Z_T)$ defines an element of $\text{Hilb}_{Z \times_B X/B}(T)$.
To show the transformation is injective it suffices to show that
two morphisms with the same graph are the same. This is true because
if $Y \subset (Z \times_B X)_T$ is the graph of a morphism $f$, then
we can recover $f$ by using the inverse of $\text{pr}_1|_Y : Y \to Z_T$
composed with $\text{pr}_2|_Y$.
\end{proof}

\begin{lemma}
\label{lemma-Mor-into-Hilb-open}
Assumption and notation as in Lemma \ref{lemma-Mor-into-Hilb}.
The transformation
$\mathit{Mor}_B(Z, X) \longrightarrow \text{Hilb}_{Z \times_B X/B}$
is representable by open immersions.
\end{lemma}

\begin{proof}
Let $T$ be a scheme over $B$ and let $Y \subset (Z \times_B X)_T$
be an element of $\text{Hilb}_{Z \times_B X/B}(T)$. Then we see that
$Y$ is the graph of a morphism $Z_T \to X_T$ over $T$ if and only
if $k = \text{pr}_1|_Y : Y \to Z_T$ is an isomorphism. By
More on Morphisms of Spaces, Lemma
\ref{spaces-more-morphisms-lemma-where-isomorphism}
there exists an open subscheme $V \subset T$ such that
for any morphism of schemes $T' \to T$ we have
$k_{T'} : Y_{T'} \to Z_{T'}$ is an isomorphism if and
only if $T' \to T$ factors through $V$.
This proves the lemma.
\end{proof}

\begin{proposition}
\label{proposition-Mor}
Let $S$ be a scheme. Let $Z \to B$ and $X \to B$ be morphisms of algebraic
spaces over $S$. Assume $X \to B$ is of finite presentation and separated and
$Z \to B$ is of finite presentation, flat, and proper. Then
$\mathit{Mor}_B(Z, X)$ is an algebraic space locally of finite
presentation over $B$.
\end{proposition}

\begin{proof}
Immediate consequence of
Lemma \ref{lemma-Mor-into-Hilb-open}
and Proposition \ref{proposition-hilb}.
\end{proof}








\section{The stack of algebraic spaces}
\label{section-stack-of-spaces}

\noindent
This section continuous the discussion started in
Examples of Stacks, Sections
\ref{examples-stacks-section-stack-of-spaces},
\ref{examples-stacks-section-stack-of-finite-type-spaces}, and
\ref{examples-stacks-section-stack-in-groupoids-of-finite-type-spaces}.
Working over $\mathbf{Z}$, the discussion therein shows
that we have a stack in groupoids
$$
p'_{ft} : \textit{Spaces}'_{ft} \longrightarrow \Sch_{fppf}
$$
parametrizing (nonflat) families of finite type algebraic spaces.
More precisely, an object\footnote{We always perform a replacement as in
Examples of Stacks, Lemma \ref{examples-stacks-lemma-stack-ft-spaces}.}
of $\textit{Spaces}'_{ft}$ is a finite type morphism $X \to S$
from an algebraic space $X$ to a scheme $S$ and a morphism
$(X' \to S') \to (X \to S)$ is given by a pair $(f, g)$
where $f : X' \to X$ is a morphism of algebraic spaces
and $g : S' \to S$ is a morphism of schemes
which fit into a commutative diagram
$$
\xymatrix{
X' \ar[d] \ar[r]_f & X \ar[d] \\
S' \ar[r]^g & S
}
$$
inducing an isomorphism $X' \to S' \times_S X$, in other words, the
diagram is cartesian in the category of algebraic spaces.
The functor $p'_{ft}$ sends $(X \to S)$ to $S$ and sends
$(f, g)$ to $g$. We define a full subcategory
$$
\textit{Spaces}'_{fp, flat, proper} \subset
\textit{Spaces}'_{ft}
$$
consisting of objects $X \to S$ of $\textit{Spaces}'_{ft}$
such that $X \to S$ is of finite presentation, flat, and proper.
We denote
$$
p'_{fp, flat, proper} :
\textit{Spaces}'_{fp, flat, proper}
\longrightarrow
\Sch_{fppf}
$$
the restriction of the functor $p'_{ft}$ to the indicated subcategory.
We first review the results already obtained in the references
listed above, and then we start adding further results.

\begin{lemma}
\label{lemma-spaces-fibred-in-groupoids}
The category $\textit{Spaces}'_{ft}$ is fibred in groupoids
over $\Sch_{fppf}$. The same is true for
$\textit{Spaces}'_{fp, flat, proper}$.
\end{lemma}

\begin{proof}
We have seen this in
Examples of Stacks, Section
\ref{examples-stacks-section-stack-in-groupoids-of-finite-type-spaces}
for the case of $\textit{Spaces}'_{ft}$ and this easily implies the
result for the other case. However, let us also prove
this directly by checking conditions (1) and (2) of
Categories, Definition \ref{categories-definition-fibred-groupoids}.

\medskip\noindent
Condition (1). Let $X \to S$ be an object of $\textit{Spaces}'_{ft}$
and let $S' \to S$ be a morphism of schemes. Then we set
$X' = S' \times_S X$. Note that $X' \to S'$ is of finite type
by Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-base-change-finite-type}.
to obtain a morphism $(X' \to S') \to (X \to S)$
lying over $S' \to S$.
Argue similarly for the other case using
Morphisms of Spaces, Lemmas
\ref{spaces-morphisms-lemma-base-change-finite-presentation},
\ref{spaces-morphisms-lemma-base-change-flat}, and
\ref{spaces-morphisms-lemma-base-change-proper}.

\medskip\noindent
Condition (2). Consider morphisms
$(f, g) : (X' \to S') \to (X \to S)$ and $(a, b) : (Y \to T) \to (X \to S)$
of $\textit{Spaces}'_{ft}$. Given a morphism $h : T \to S'$ with
$g \circ h = b$ we have to show
there is a unique morphism $(k, h) : (Y \to T) \to (X' \to S')$ of
$\textit{Spaces}'_{ft}$ such that
$(f, g) \circ (k, h) = (a, b)$.
This is clear from the fact that $X' = S' \times_S X$.
The same therefore works for any full subcategory of
$\textit{Spaces}'_{ft}$ satisfying (1).
\end{proof}

\begin{lemma}
\label{lemma-spaces-diagonal}
The diagonal
$$
\Delta : \textit{Spaces}'_{fp, flat, proper} \longrightarrow
\textit{Spaces}'_{fp, flat, proper} \times \textit{Spaces}'_{fp, flat, proper}
$$
representable by algebraic spaces.
\end{lemma}

\begin{proof}
We will use criterion (2) of
Algebraic Stacks, Lemma \ref{algebraic-lemma-representable-diagonal}.
Let $S$ be a scheme and let $X$ and $Y$ be algebraic spaces
of finite presentation over $S$, flat over $S$, and proper over $S$.
We have to show that the functor
$$
\mathit{Isom}_S(X, Y) : (\Sch/S)_{fppf} \longrightarrow \textit{Sets}, \quad
T \longmapsto \{f : X_T \to Y_T \text{ isomorphism}\}
$$
is an algebraic space. An elementary argument shows that
$\mathit{Isom}_S(X, Y)$ sits in a fibre product
$$
\xymatrix{
\mathit{Isom}_S(X, Y) \ar[r] \ar[d] & S \ar[d]_{(\text{id}, \text{id})} \\
\mathit{Mor}_S(X, Y) \times \mathit{Mor}_S(Y, X) \ar[r] &
\mathit{Mor}_S(X, X) \times \mathit{Mor}_S(Y, Y)
}
$$
By Proposition \ref{proposition-Mor} the functors on the bottom row
are algebraic spaces over $S$. 
Hence the result follows from the fact that the category of
algebraic spaces over $S$ has fibre products.
\end{proof}

\begin{lemma}
\label{lemma-spaces-stack}
The category $\textit{Spaces}'_{ft}$ is a stack in groupoids
over $\Sch_{fppf}$. The same is true for
$\textit{Spaces}'_{fp, flat, proper}$.
\end{lemma}

\begin{proof}
The reason this lemma holds is the slogan: any fppf descent datum for algebraic
spaces is effective, see Bootstrap, Section
\ref{bootstrap-section-applications}.
More precisely, the lemma for $\textit{Spaces}'_{ft}$ follows from
Examples of Stacks, Lemma
\ref{examples-stacks-lemma-stack-of-finite-type-spaces}
as we saw in Examples of Stacks, Section
\ref{examples-stacks-section-stack-in-groupoids-of-finite-type-spaces}.
However, let us review the proof. We need to check conditions
(1), (2), and (3) of Stacks, Definition
\ref{stacks-definition-stack-in-groupoids}.

\medskip\noindent
Property (1) we have seen in Lemma \ref{lemma-spaces-fibred-in-groupoids}.

\medskip\noindent
Property (2) follows from
Lemma \ref{lemma-spaces-diagonal} in the case of
$\textit{Spaces}'_{fp, flat, proper}$.
In the case of $\textit{Spaces}'_{ft}$ it follows
from Examples of Stacks, Lemma
\ref{examples-stacks-lemma-pre-stack-of-spaces}
(and this is really the ``correct'' reference).

\medskip\noindent
Condition (3) for $\textit{Spaces}'_{ft}$ is checked as follows. Suppose given
\begin{enumerate}
\item an fppf covering $\{U_i \to U\}_{i \in I}$ in $\Sch_{fppf}$,
\item for each $i \in I$ an algebraic space $X_i$ of finite type over
$U_i$, and
\item for each $i, j \in I$ an isomorphism
$\varphi_{ij} : X_i \times_U U_j \to U_i \times_U X_j$ of algebraic spaces
over $U_i \times_U U_j$ satisfying the cocycle condition over
$U_i \times_U U_j \times_U U_k$.
\end{enumerate}
We have to show there exists an algebraic space $X$ of finite type over $U$
and isomorphisms $X_{U_i} \cong X_i$ over $U_i$ recovering the
isomorphisms $\varphi_{ij}$.
First, note that by Sites, Lemma \ref{sites-lemma-glue-sheaves}
there exists a sheaf $X$ on $(\Sch/U)_{fppf}$ recovering
the $X_i$ and the $\varphi_{ij}$. Then by
Bootstrap, Lemma \ref{bootstrap-lemma-locally-algebraic-space-finite-type}
we see that $X$ is an algebraic space.
By Descent on Spaces, Lemma
\ref{spaces-descent-lemma-descending-property-finite-type}
we see that $X \to U$ is of finite type.
In the case of $\textit{Spaces}'_{fp, flat, proper}$
one additionally uses
Descent on Spaces, Lemma
\ref{spaces-descent-lemma-descending-property-finite-presentation},
\ref{spaces-descent-lemma-descending-property-flat}, and
\ref{spaces-descent-lemma-descending-property-proper}
in the last step.
\end{proof}

\begin{remark}
\label{remark-spaces-base-change}
Let $B$ be an algebraic space over $\Spec(\mathbf{Z})$.
Let $B\textit{-Spaces}'_{ft}$ be the category consisting
of pairs $(X \to S, h : S \to B)$
where $X \to S$ is an object of
$\textit{Spaces}'_{ft}$ and $h : S \to B$ is a morphism.
A morphism $(X' \to S', h') \to (X \to S, h)$
in $B\textit{-Spaces}'_{ft}$ is a morphism $(f, g)$
in $\textit{Spaces}'_{ft}$ such that $h \circ g = h'$.
In this situation the diagram
$$
\xymatrix{
B\textit{-Spaces}'_{ft} \ar[r] \ar[d] & \textit{Spaces}'_{ft} \ar[d] \\
(\Sch/B)_{fppf} \ar[r] & \Sch_{fppf}
}
$$
is $2$-fibre product square. This trivial remark
will occasionally be useful to deduce results from
the absolute case $\textit{Spaces}'_{ft}$ to the case
of families over a given base algebraic space.
Of course, a similar construction works for
$B\textit{-Spaces}'_{fp, flat, proper}$
\end{remark}

\begin{lemma}
\label{lemma-spaces-limits}
The stack
$p'_{fp, flat, proper} :
\textit{Spaces}'_{fp, flat, proper} \to (\Sch/S)_{fppf}$ is limit preserving
(Artin's Axioms, Definition \ref{artin-definition-limit-preserving}).
\end{lemma}

\begin{proof}
Let $T = \lim T_i$ be the limits of a
directed inverse system of affine schemes.
By Limits of Spaces, Lemma
\ref{spaces-limits-lemma-descend-finite-presentation}
the category of algebraic spaces of finite presentation
over $T$ is the colimit of the categories of algebraic spaces
of finite presentation over $T_i$.
To finish the proof use that flatness and properness
descends through the limit, see
Limits of Spaces, Lemmas
\ref{spaces-limits-lemma-descend-flat} and
\ref{spaces-limits-lemma-eventually-proper}.
\end{proof}

\begin{lemma}
\label{lemma-spaces-RS-star}
Let
$$
\xymatrix{
T \ar[r] \ar[d] & T' \ar[d] \\
S \ar[r] & S'
}
$$
be a pushout in the category of schemes where
$T \to T'$ is a thickening and $T \to S$ is affine, see
More on Morphisms, Lemma \ref{more-morphisms-lemma-pushout-along-thickening}.
Then the functor on fibre categories
$$
\begin{matrix}
\textit{Spaces}'_{fp, flat, proper, S'} \\
\downarrow \\
\textit{Spaces}'_{fp, flat, proper, S}
\times_{\textit{Spaces}'_{fp, flat, proper, T}}
\textit{Spaces}'_{fp, flat, proper, T'}
\end{matrix}
$$
is an equivalence.
\end{lemma}

\begin{proof}
The functor is an equivalence if we drop ``proper'' from the list
of conditions and replace ``of finite presentation'' by
``locally of finite presentation'', see Pushouts of Spaces, Lemma
\ref{spaces-pushouts-lemma-equivalence-categories-spaces-pushout-flat}.
Thus it suffices to show that given a morphism
$X' \to S'$ of an algebraic space to $S'$ which is
flat and locally of finite presentation, then
$X' \to S'$ is proper if and only if $S \times_{S'} X' \to S$
and $T' \times_{S'} X' \to T'$ are proper.
One implication follows from the fact that
properness is preserved under base change
(Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-base-change-proper})
and the other from the fact that properness of $S \times_{S'} X' \to S$
implies properness of $X' \to S'$ by
More on Morphisms of Spaces, Lemma
\ref{spaces-more-morphisms-lemma-thicken-property-morphisms-cartesian}.
\end{proof}

\begin{lemma}
\label{lemma-spaces-tangent-space}
Let $k$ be a field and let $x_0 = (X \to \Spec(k))$ be an object of
$\mathcal{X} = \textit{Spaces}'_{fp, flat, proper}$ over $\Spec(k)$.
Then the spaces $T\mathcal{F}_{\mathcal{X}, k, x_0}$ and
$\text{Inf}_{x_0}(\mathcal{F}_{\mathcal{X}, k, x_0})$
(see Artin's Axioms, Sections
\ref{artin-section-tangent-spaces} and
\ref{artin-section-inf})
are finite dimensional.
\end{lemma}

\begin{proof}
The discussion in Artin's Axioms, Section \ref{artin-section-tangent-spaces}
only applies to fields of finite type over the base scheme $\Spec(\mathbf{Z})$.
Since our stack satisfies (RS*) by Lemma \ref{lemma-spaces-RS-star}
the construction in
Artin's Axioms, Lemma \ref{artin-lemma-properties-lift-RS-star}
applies and for general fields $k$ we can consider the vector spaces
$T_x(k)$ and $\text{Inf}_x(k)$. Moreover, these spaces agree with the
ones mentioned in the lemma
by Artin's Axioms, Remark \ref{artin-remark-compare-deformation-spaces}.
With this out of the way we can start the proof.
Observe that the first order thickening
$\Spec(k) \to \Spec(k[\epsilon]) = \Spec(k[k])$
has conormal module $k$. Hence the formula in
Deformation Theory, Lemma \ref{defos-lemma-deform-spaces}
describing infinitesimal deformations of $X$ and infinitesimal
automorphisms of $X$ become
$$
T_x(k) = \text{Ext}^1_{\mathcal{O}_X}(\NL_{X/k}, \mathcal{O}_X)
\quad\text{and}\quad
\text{Inf}_x(k) = \text{Ext}^0_{\mathcal{O}_X}(\NL_{X/k}, \mathcal{O}_X)
$$
By More on Morphisms of Spaces, Lemma
\ref{spaces-more-morphisms-lemma-netherlander-fp}
and the fact that $X$ is Noetherian, we see that
$\NL_{X/k}$ has coherent cohomology sheaves zero except
in degrees $0$ and $-1$.
By Derived Categories of Spaces, Lemma \ref{spaces-perfect-lemma-ext-finite}
the displayed $\text{Ext}$-groups are finite $k$-vector spaces
and the proof is complete.
\end{proof}






\section{Polarized proper schemes}
\label{section-polarized}

\noindent
To study the stack of polarized proper schemes it suffices to work
over $\mathbf{Z}$ as we can later pullback to any scheme or algebraic
space we want (see Remark \ref{remark-polarized-base-change}).

\begin{situation}
\label{situation-polarized}
We define a category $\textit{Polarized}$ as follows. Objects are
pairs $(X \to S, \mathcal{L})$ where
\begin{enumerate}
\item $X \to S$ is a morphism of schemes which is proper, flat, and
of finite presentation, and
\item $\mathcal{L}$ is an invertible $\mathcal{O}_X$-module
which is relatively ample on $X/S$
(Morphisms, Definition \ref{morphisms-definition-relatively-ample}).
\end{enumerate}
A morphism $(X' \to S', \mathcal{L}') \to (X \to S, \mathcal{L})$
between objects
is given by a triple $(f, g, \varphi)$ where $f : X' \to X$ and $g : S' \to S$
are morphisms of schemes which fit into a commutative diagram
$$
\xymatrix{
X' \ar[d] \ar[r]_f & X \ar[d] \\
S' \ar[r]^g & S
}
$$
inducing an isomorphism $X' \to S' \times_S X$, in other words, the
diagram is cartesian,
and $\varphi : f^*\mathcal{L} \to \mathcal{L}'$ is an isomorphism.
Composition is defined in the obvious manner (see
Examples of Stacks, Sections
\ref{examples-stacks-section-stack-of-spaces} and
\ref{examples-stacks-section-stack-of-quasi-coherent-sheaves}).
The forgetful functor
$$
p : \textit{Polarized} \longrightarrow \Sch_{fppf},\quad
(X \to S, \mathcal{L}) \longmapsto S
$$
is how we view $\textit{Polarized}$ as a category over $\Sch_{fppf}$
(see Section \ref{section-conventions} for notation).
\end{situation}

\begin{remark}
\label{remark-polarized-base-change}
Let $B$ be an algebraic space over $\Spec(\mathbf{Z})$.
Let $B\textit{-Polarized}$ be the category consisting
of triples $(X \to S, \mathcal{L}, h : S \to B)$
where $(X \to S, \mathcal{L})$ is an object of
$\textit{Polarized}$ and $h : S \to B$ is a morphism.
A morphism $(X' \to S', \mathcal{L}', h') \to (X \to S, \mathcal{L}, h)$
in $B\textit{-Polarized}$ is a morphism $(f, g, \varphi)$
in $\textit{Polarized}$ such that $h \circ g = h'$.
In this situation the diagram
$$
\xymatrix{
B\textit{-Polarized} \ar[r] \ar[d] & \textit{Polarized} \ar[d] \\
(\Sch/B)_{fppf} \ar[r] & \Sch_{fppf}
}
$$
is $2$-fibre product square. This trivial remark
will occasionally be useful to deduce results from
the absolute case $\textit{Polarized}$ to the case
of families over a given base algebraic space.
\end{remark}








\input{chapters}

\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}
