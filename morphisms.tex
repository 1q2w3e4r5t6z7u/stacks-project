\input{preamble}

% OK, start here.
%
\begin{document}

\title{Morphisms of Schemes}


\maketitle

\phantomsection
\label{section-phantom}

\tableofcontents

\section{Introduction}
\label{section-introduction}

\noindent
In this chapter we introduce some types of morphisms of schemes.
A basic reference is \cite{EGA}.




















\section{Closed immersions}
\label{section-closed-immersions}

\noindent
In this section we elucidate some of the results obtained previously on closed
immersions of schemes. Recall that a morphism of schemes $i : Z \to X$
is defined to be a closed immersion if (a) $i$ induces a homeomorphism onto
a closed subset of $X$, (b) $i^\sharp : \mathcal{O}_X \to i_*\mathcal{O}_Z$
is surjective, and (c) the kernel of $i^\sharp$ is locally generated by
sections, see Schemes, Definitions \ref{schemes-definition-immersion}
and \ref{schemes-definition-closed-immersion-locally-ringed-spaces}. It turns
out that, given that $Z$ and $X$ are schemes, there are many different
ways of characterizing a closed immersion.

\begin{lemma}
\label{lemma-closed-immersion}
Let $i : Z \to X$ be a morphism of schemes.
The following are equivalent:
\begin{enumerate}
\item The morphism $i$ is a closed immersion.
\item For every affine open $\text{Spec}(R) = U \subset X$,
there exists an ideal $I \subset R$ such that
$i^{-1}(U) = \text{Spec}(R/I)$ as schemes over $U = \text{Spec}(R)$.
\item There exists an affine open covering $X = \bigcup_{j \in J} U_j$,
$U_j = \text{Spec}(R_j)$ and for every $j \in J$ there exists
an ideal $I_j \subset R_j$ such that
$i^{-1}(U_j) = \text{Spec}(R_j/I_j)$ as schemes over $U_j = \text{Spec}(R_j)$.
\item The morphism $i$ induces a homeomorphism of $Z$ with a closed subset
of $X$ and $i^\sharp : \mathcal{O}_X \to i_*\mathcal{O}_Z$ is surjective.
\item The morphism $i$ induces a homeomorphism of $Z$ with a closed subset
of $X$, the map $i^\sharp : \mathcal{O}_X \to i_*\mathcal{O}_Z$ is surjective,
and the kernel $\text{Ker}(i^\sharp)\subset \mathcal{O}_X$ is a quasi-coherent
sheaf of ideals.
\item The morphism $i$ induces a homeomorphism of $Z$ with a closed subset
of $X$, the map $i^\sharp : \mathcal{O}_X \to i_*\mathcal{O}_Z$ is surjective,
and the kernel $\text{Ker}(i^\sharp)\subset \mathcal{O}_X$ is a
sheaf of ideals which is locally generated by sections.
\end{enumerate}
\end{lemma}

\begin{proof}
Condition (6) is our definition of a closed immersion, see Schemes,
Definitions \ref{schemes-definition-closed-immersion-locally-ringed-spaces}
and \ref{schemes-definition-immersion}.
So (6) $\Leftrightarrow$ (1). We have (1) $\Rightarrow$ (2) by
Schemes, Lemma \ref{schemes-lemma-closed-subspace-scheme}.
Trivially (2) $\Rightarrow$ (3).

\medskip\noindent
Assume (3). Each of the morphisms
$\text{Spec}(R_j/I_j) \to \text{Spec}(R_j)$ is
a closed immersion, see
Schemes, Example \ref{schemes-example-closed-immersion-affines}.
Hence $i^{-1}(U_j) \to U_j$ is a homeomorphism onto its image
and $i^\sharp|_{U_j}$ is surjective. Hence $i$ is a homeomorphism
onto its image and $i^\sharp$ is surjective since this may be
checked locally. We conclude that (3) $\Rightarrow$ (4).

\medskip\noindent
The implication (4) $\Rightarrow$ (1) is
Schemes, Lemma \ref{schemes-lemma-characterize-closed-immersions}.
The implication (5) $\Rightarrow$ (6) is trivial.
And the implication (6) $\Rightarrow$ (5) follows
from Schemes, Lemma \ref{schemes-lemma-closed-subspace-scheme}.
\end{proof}

\begin{lemma}
\label{lemma-closed-immersion-ideals}
Let $X$ be a scheme.
Suppose $i : Z \to X$ and $i' : Z' \to X$ are closed immersions
corresponding to the quasi-coherent
ideal sheaves $\mathcal{I} = \text{Ker}(i^\sharp)$
and $\mathcal{I}' = \text{Ker}((i')^\sharp)$ of $\mathcal{O}_X$.
\begin{enumerate}
\item The morphism $i : Z \to X$ factors as $Z \to Z' \to X$
for some $a : Z \to Z'$
if and only if $\mathcal{I}' \subset \mathcal{I}$.
If this happens, then $a$ is a closed immersion.
\item We have $Z \cong Z'$ as schemes over $X$ if and only if
$\mathcal{I} = \mathcal{I}'$.
\end{enumerate}
\end{lemma}

\begin{proof}
This follows from our discussion of closed subspaces in
Schemes, Section \ref{schemes-section-closed-immersion} especially
Schemes, Lemma \ref{schemes-lemma-characterize-closed-subspace}.
It also follows in a straightforward way from characterization
(3) in Lemma \ref{lemma-closed-immersion} above.
\end{proof}

\begin{lemma}
\label{lemma-closed-immersion-bijection-ideals}
Let $X$ be a scheme.
Let $\mathcal{I} \subset \mathcal{O}_X$ be a sheaf of ideals.
The following are equivalent:
\begin{enumerate}
\item The sheaf of ideals $\mathcal{I}$ is locally generated by
sections as a sheaf of $\mathcal{O}_X$ modules.
\item The sheaf of ideals $\mathcal{I}$ is quasi-coherent as
a sheaf of $\mathcal{O}_X$-modules.
\item There exists a closed immersion $i : Z \to X$ whose
corresponding sheaf of ideals $\text{Ker}(i^\sharp)$ is
equal to $\mathcal{I}$.
\end{enumerate}
\end{lemma}

\begin{proof}
In Schemes, Section \ref{schemes-section-closed-immersion} we constructed
the closed subspace associated to a sheaf of ideals locally generated
by sections. This closed subspace is a scheme by
Schemes, Lemma \ref{schemes-lemma-closed-subspace-scheme}.
Hence we see that (1) $\Rightarrow$ (3) by our definition
of a closed immersion of schemes. By Lemma \ref{lemma-closed-immersion}
above we see that (3) $\Rightarrow$ (2). And of course (2) $\Rightarrow$ (1).
\end{proof}

\begin{lemma}
\label{lemma-base-change-closed-immersion}
The base change of a closed immersion is a closed immersion.
\end{lemma}

\begin{proof}
See Schemes, Lemma \ref{schemes-lemma-base-change-immersion}.
\end{proof}

\begin{lemma}
\label{lemma-composition-closed-immersion}
A composition of closed immersions is a closed immersion.
\end{lemma}

\begin{proof}
We have seen this in
Schemes, Lemma \ref{schemes-lemma-composition-immersion},
but here is another
proof. Namely, it follows from the characterization (3) of closed immersions
in Lemma \ref{lemma-closed-immersion}. Since if $I \subset R$
is an ideal, and $\overline{J} \subset R/I$ is an ideal, then
$\overline{J} = J/I$ for some ideal $J \subset R$ which contains
$I$ and $(R/I)/\overline{J} = R/J$.
\end{proof}

\begin{lemma}
\label{lemma-closed-immersion-quasi-compact}
A closed immersion is quasi-compact.
\end{lemma}

\begin{proof}
This lemma is a duplicate of
Schemes, Lemma \ref{schemes-lemma-closed-immersion-quasi-compact}.
\end{proof}

\begin{lemma}
\label{lemma-closed-immersion-separated}
A closed immersion is separated.
\end{lemma}

\begin{proof}
This lemma is a special case of
Schemes, Lemma \ref{schemes-lemma-immersions-monomorphisms}.
\end{proof}

\begin{lemma}
\label{lemma-factor-quasi-compact-immersion}
Let $h : Z \to X$ be an immersion.
If $h$ is quasi-compact, then we can factor
$h = i \circ j$ with $j : Z \to \overline{Z}$ an
open immersion and $i : \overline{Z} \to X$ a closed immersion.
\end{lemma}

\begin{proof}
Note that $h$ is quasi-compact and quasi-separated (see
Schemes, Lemma \ref{schemes-lemma-immersions-monomorphisms}).
Hence $h_*\mathcal{O}_Z$ is a quasi-coherent sheaf of $\mathcal{O}_X$-modules
by Schemes, Lemma \ref{schemes-lemma-push-forward-quasi-coherent}.
This implies that
$\mathcal{I} = \text{Ker}(\mathcal{O}_X \to h_*\mathcal{O}_Z)$
is a quasi-coherent sheaf of ideals, see
Schemes, Section \ref{schemes-section-quasi-coherent}.
Let $\overline{Z} \subset X$ be the closed subscheme corresponding
to $\mathcal{I}$, see Lemma \ref{lemma-closed-immersion-bijection-ideals}.
By Schemes, Lemma \ref{schemes-lemma-characterize-closed-subspace}
the morphism $h$ factors as
$h = i \circ j$ where $i : \overline{Z} \to X$ is the inclusion morphism.
To see that $j$ is an open immersion, choose an open subscheme
$U \subset X$ such that $h$ induces a closed immersion of $Z$
into $U$. Then it is clear that $\mathcal{I}|_U$ is the
sheaf of ideals corresponding to the closed immersion $Z \to U$.
Hence we see that $Z = \overline{Z} \cap U$.
\end{proof}

\begin{lemma}
\label{lemma-factor-reduced-immersion}
Let $h : Z \to X$ be an immersion.
If $Z$ is reduced, then we can factor
$h = i \circ j$ with $j : Z \to \overline{Z}$ an
open immersion and $i : \overline{Z} \to X$ a closed immersion.
\end{lemma}

\begin{proof}
Let $\overline{Z} \subset X$ be the closure of $h(Z)$ with the reduced
induced closed subscheme structure, see
Schemes, Definition \ref{schemes-definition-reduced-induced-scheme}.
By Schemes, Lemma \ref{schemes-lemma-map-into-reduction}
the morphism $h$ factors as
$h = i \circ j$ with $i : \overline{Z} \to X$ the inclusion morphism
and $j : Z \to \overline{Z}$. From the definition of an immersion we
see there exists an open subscheme $U \subset X$ such that
$h$ factors through a closed immersion into $U$. Hence
$\overline{Z} \cap U$ and $h(Z)$ are reduced closed subschemes
of $U$ with the same underlying closed set. Hence by the uniqueness
in Schemes, Lemma \ref{schemes-lemma-reduced-closed-subscheme}
we see that $h(Z) \cong \overline{Z} \cap U$.
So $j$ induces an isomorphism of $Z$ with $\overline{Z} \cap U$.
In other words $j$ is an open immersion.
\end{proof}



\begin{example}
\label{example-thibaut}
Here is an example of an immersion which is not a composition of an
open immersion followed by a closed immersion.
Let $k$ be a field.
Let $X = \text{Spec}(k[x_1, x_2, x_3, \ldots])$.
Let $U = \bigcup_{n = 1}^{\infty} D(x_n)$.
Then $U \to X$ is an open immersion.
Consider the ideals
$$
I_n =
(x_1^n, x_2^n, \ldots, x_{n - 1}^n, x_n - 1, x_{n + 1}, x_{n + 2}, \ldots)
\subset
k[x_1, x_2, x_3, \ldots][1/x_n].
$$
Note that $I_n k[x_1, x_2, x_3, \ldots][1/x_nx_m] = (1)$
for any $m \not = n$. Hence the quasi-coherent ideals
$\widetilde I_n$ on $D(x_n)$ agree on $D(x_nx_m)$, namely
$\widetilde I_n|_{D(x_nx_m)} = \mathcal{O}_{D(x_n x_m)}$ if
$n \not = m$. Hence these ideals glue to a quasi-coherent sheaf of ideals
$\mathcal{I} \subset \mathcal{O}_U$.
Let $Z \subset U$ be the closed subscheme corresponding to
$\mathcal{I}$. Thus $Z \to X$ is an immersion.

\medskip\noindent
We claim that we cannot factor $Z \to X$ as
$Z \to \overline{Z} \to X$, where $\overline{Z} \to X$ is closed
and $Z \to \overline{Z}$ is open. Namely, $\overline{Z}$ would
have to be defined by an ideal $I \subset k[x_1, x_2, x_3, \ldots]$
such that $I_n = I k[x_1, x_2, x_3, \ldots][1/x_n]$.
But the only element $f \in k[x_1, x_2, x_3, \ldots]$
which ends up in all $I_n$ is $0$! Hence $I$ does not exist.
\end{example}








\section{Closed immersions and quasi-coherent sheaves}
\label{section-closed-immersions-quasi-coherent}

\noindent
The following lemma finally does for quasi-coherent sheaves on schemes
what Modules, Lemma \ref{modules-lemma-i-star-exact} does for abelian sheaves.
See also the discussion in
Modules, Section \ref{modules-section-closed-immersion}.

\begin{lemma}
\label{lemma-i-star-equivalence}
Let $i : Z \to X$ be a closed immersion of schemes. Let
$\mathcal{I} \subset \mathcal{O}_X$ be the quasi-coherent sheaf of ideals
cutting out $Z$. The functor
$$
i_* :
\text{QCoh}(\mathcal{O}_Z)
\longrightarrow
\text{QCoh}(\mathcal{O}_X)
$$
is exact, fully faithful, with essential image those quasi-coherent
$\mathcal{O}_X$-modules $\mathcal{G}$ such that $\mathcal{I}\mathcal{G} = 0$.
\end{lemma}

\begin{proof}
A closed immersion is quasi-compact and separated, see
Lemmas \ref{lemma-closed-immersion-quasi-compact} and
\ref{lemma-closed-immersion-separated}. Hence
Schemes, Lemma \ref{schemes-lemma-push-forward-quasi-coherent}
applies and the pushforward of a quasi-coherent
sheaf on $Z$ is indeed a quasi-coherent sheaf on $X$.

\medskip\noindent
By Modules, Lemma \ref{modules-lemma-i-star-exact}
the functor $i_*$ is faithful. We claim that
for any quasi-coherent sheaf $\mathcal{F}$ on $Z$
the canonical map
$$
i^*i_*\mathcal{F} \longrightarrow \mathcal{F}
$$
is an isomorphism. This claim implies in particular that $i_*$ is
fully faithful. To prove the claim let $U = \text{Spec}(R)$ be any affine open
of $X$, and write $Z \cap U = \text{Spec}(R/I)$, see
Lemma \ref{lemma-closed-immersion} above. We may write
$\mathcal{F}|_{U \cap Z} = \widetilde{M}$ where
$M$ is an $R/I$-module (see
Schemes, Section \ref{schemes-section-quasi-coherent}).
By Schemes, Lemma \ref{schemes-lemma-widetilde-pullback}
we see that $i_*\mathcal{F}|_U$ corresponds to
$M_R$ and then $i^*i_*\mathcal{F}|_{Z \cap U}$ corresponds
to $M_R \otimes_R R/I$. In other words, we have to see that
for any $R/I$-module $M$ the canonical map
$$
M_R \otimes_R R/I \longrightarrow M, \ \ 
m \otimes f \longmapsto fm
$$
is an isomorphism. Proof of this easy algebra fact is omitted.

\medskip\noindent
Now we turn to the description of the essential image of the
functor $i_*$. It is clear that $\mathcal{I}(i_*\mathcal{F}) = 0$
for any quasi-coherent $\mathcal{O}_Z$-module, for example
by our local description above. Next, suppose that $\mathcal{G}$
is any quasi-coherent $\mathcal{O}_X$-module such that
$\mathcal{I}\mathcal{G} = 0$. It suffices to show that the canonical map
$$
\mathcal{G} \longrightarrow i_* i^*\mathcal{G}
$$
is an isomorphism. By exactly the same arguments as above we see that
it suffices to prove the following algebraic statement: Given a ring
$R$, an ideal $I$ and an $R$-module $N$ such that $IN = 0$ the canonical map
$$
N \longrightarrow N \otimes_R R/I, \ \ 
n \longmapsto n \otimes 1
$$
is an isomorphism of $R$-modules. Proof of this easy algebra fact is omitted.
\end{proof}

\noindent
Let $i : Z \to X$ be a closed immersion. Because of the lemma above we often,
by abuse of notation, denote $\mathcal{F}$ the sheaf $i_*\mathcal{F}$ on $X$.

\begin{lemma}
\label{lemma-largest-quasi-coherent-subsheaf}
Let $X$ be a scheme. Let $\mathcal{F}$ be a quasi-coherent
$\mathcal{O}_X$-module. Let $\mathcal{G} \subset \mathcal{F}$
be a $\mathcal{O}_X$-submodule. There exists a unique quasi-coherent
$\mathcal{O}_X$-submodule $\mathcal{G}' \subset \mathcal{G}$
with the following property: For every quasi-coherent $\mathcal{O}_X$-module
$\mathcal{H}$ the map
$$
\text{Hom}_{\mathcal{O}_X}(\mathcal{H}, \mathcal{G}')
\longrightarrow
\text{Hom}_{\mathcal{O}_X}(\mathcal{H}, \mathcal{G})
$$
is bijective. In particular $\mathcal{G}'$ is the largest quasi-coherent
$\mathcal{O}_X$-submodule of $\mathcal{F}$ contained in $\mathcal{G}$.
\end{lemma}

\begin{proof}
Let $\mathcal{G}_a$, $a \in A$ be the set of quasi-coherent
$\mathcal{O}_X$-submodules contained in $\mathcal{G}$.
Then the image $\mathcal{G}'$ of
$$
\bigoplus\nolimits_{a \in A} \mathcal{G}_a \longrightarrow \mathcal{F}
$$
is quasi-coherent as the image of a map of quasi-coherent sheaves
on $X$ is quasi-coherent and since a direct sum of quasi-coherent sheaves
is quasi-coherent, see
Schemes, Section \ref{schemes-section-quasi-coherent}.
The module $\mathcal{G}'$ is contained in $\mathcal{G}$. Hence this is the
largest quasi-coherent $\mathcal{O}_X$-module contained in $\mathcal{G}$.

\medskip\noindent
To prove the formula, let $\mathcal{H}$ be a quasi-coherent
$\mathcal{O}_X$-module and let $\alpha : \mathcal{H} \to \mathcal{G}$
be an $\mathcal{O}_X$-module map. The image of the composition
$\mathcal{H} \to \mathcal{G} \to \mathcal{F}$ is quasi-coherent
as the image of a map of quasi-coherent sheaves. Hence it is contained
in $\mathcal{G}'$. Hence $\alpha$ factors through $\mathcal{G}'$
as desired.
\end{proof}

\begin{lemma}
\label{lemma-i-upper-shriek}
Let $i : Z \to X$ be a closed immersion of schemes.
There is a functor\footnote{This is likely nonstandard notation.}
$i^! : \text{QCoh}(\mathcal{O}_X) \to \text{QCoh}(\mathcal{O}_Z)$
which is a right adjoint to $i_*$. (Compare
Modules, Lemma \ref{modules-lemma-i-star-right-adjoint}.)
\end{lemma}

\begin{proof}
Given quasi-coherent $\mathcal{O}_X$-module $\mathcal{G}$ we consider
the subsheaf $\mathcal{H}_Z(\mathcal{G})$ of $\mathcal{G}$ of local sections
annihilated by $\mathcal{I}$. By
Lemma \ref{lemma-largest-quasi-coherent-subsheaf}
there is a canonical largest quasi-coherent $\mathcal{O}_X$-submodule
$\mathcal{H}_Z(\mathcal{G})'$. By construction we have
$$
\text{Hom}_{\mathcal{O}_X}(i_*\mathcal{F}, \mathcal{H}_Z(\mathcal{G})')
=
\text{Hom}_{\mathcal{O}_X}(i_*\mathcal{F}, \mathcal{G})
$$
for any quasi-coherent $\mathcal{O}_Z$-module $\mathcal{F}$.
Hence we can set $i^!\mathcal{G} = i^*(\mathcal{H}_Z(\mathcal{G})')$.
Details omitted.
\end{proof}












\section{Scheme theoretic image}
\label{section-scheme-theoretic-image}

\begin{lemma}
\label{lemma-scheme-theoretic-image}
Let $f : X \to Y$ be a morphism of schemes. There exists a closed
subscheme $Z \subset Y$ such that $f$ factors through $Z$ and such
that for any other closed subscheme $Z' \subset Y$ such that $f$
factors through $Z'$ we have $Z \subset Z'$.
\end{lemma}

\begin{proof}
Let $\mathcal{I} = \text{Ker}(\mathcal{O}_Y \to f_*\mathcal{O}_X)$.
If $\mathcal{I}$ is quasi-coherent then we just take $Z$ to be the
closed subscheme determined by $\mathcal{I}$, see
Lemma \ref{lemma-closed-immersion-bijection-ideals}. This works by
Schemes, Lemma \ref{schemes-lemma-characterize-closed-subspace}.
In general the same lemma requires us to show that there exists
a largest quasi-coherent sheaf of ideals $\mathcal{I}'$ contained in
$\mathcal{I}$.
This follows from Lemma \ref{lemma-largest-quasi-coherent-subsheaf}.
\end{proof}

\begin{definition}
\label{definition-scheme-theoretic-image}
Let $f : X \to Y$ be a morphism of schemes. The {\it scheme theoretic image}
of $f$ is the smallest closed subscheme $Z \subset Y$ through which $f$
factors, see Lemma \ref{lemma-scheme-theoretic-image} above.
\end{definition}

\noindent
We often just denote $f : X \to Z$ the factorization of $f$.
If the morphism $f$ is not quasi-compact, then (in general) the
construction of the scheme theoretic image does not commute with
restriction to open subschemes to $Y$. Namely, if $f$ is the
immersion $Z \to X$ of Example \ref{example-thibaut} above then
the scheme theoretic image of $Z \to X$ is $X$. But clearly the
scheme theoretic image of $Z = Z \cap U \to U$ is just $Z$.

\begin{lemma}
\label{lemma-quasi-compact-scheme-theoretic-image}
Let $f : X \to Y$ be a morphism of schemes.
Let $Z \subset Y$ be the scheme theoretic image of $f$.
If $f$ is quasi-compact then
\begin{enumerate}
\item the sheaf of ideals
$\mathcal{I} = \text{Ker}(\mathcal{O}_Y \to f_*\mathcal{O}_X)$
is quasi-coherent,
\item the scheme theoretic image $Z$ is the closed subscheme
determined by $\mathcal{I}$,
\item for any open $U \subset Y$ the scheme theoretic image of
$f|_{f^{-1}(U)} : f^{-1}(U) \to U$ is equal to $Z \cap U$, and
\item the image $f(X) \subset Z$ is a dense subset of $Z$, in other
words the morphism $X \to Z$ is dominant
(see Definition \ref{definition-dominant}).
\end{enumerate}
\end{lemma}

\begin{proof}
Part (4) follows from part (3). To show (3) it suffices
to prove (1) since the formation of $\mathcal{I}$ commutes with restriction to
open subschemes of $Y$. And if (1) holds then in the proof of 
Lemma \ref{lemma-scheme-theoretic-image}
we showed (2). Thus it suffices to prove that $\mathcal{I}$ is quasi-coherent.
Since the property of being quasi-coherent is
local we may assume $Y$ is affine. As $f$ is quasi-compact,
we can find a finite affine open covering
$X = \bigcup_{i = 1, \ldots, n} U_i$. Denote $f'$ the composition
$$
X' = \coprod U_i \longrightarrow X \longrightarrow Y.
$$
Then $f_*\mathcal{O}_X$ is a subsheaf of $f'_*\mathcal{O}_{X'}$,
and hence $\mathcal{I} = \text{Ker}(\mathcal{O}_Y \to \mathcal{O}_{X'})$.
By Schemes, Lemma \ref{schemes-lemma-push-forward-quasi-coherent}
the sheaf $f'_*\mathcal{O}_{X'}$ is quasi-coherent on $Y$. Hence we win.
\end{proof}

\begin{example}
\label{example-scheme-theoretic-image}
If $A \to B$ is a ring map with kernel $I$, then the scheme theoretic image
of $\text{Spec}(B) \to \text{Spec}(A)$ is the closed subscheme
$\text{Spec}(A/I)$ of $\text{Spec}(A)$. This follows from
Lemma \ref{lemma-quasi-compact-scheme-theoretic-image}.
\end{example}

\noindent
If the morphism is quasi-compact, then the scheme theoretic image only
adds points which are specializations of points in the image.

\begin{lemma}
\label{lemma-reach-points-scheme-theoretic-image}
Let $f : X \to Y$ be a quasi-compact morphism.
Let $Z$ be the scheme theoretic image of $f$.
Let $z \in Z$. There exists a valuation ring $A$ with
fraction field $K$ and a commutative diagram
$$
\xymatrix{
\text{Spec}(K) \ar[rr] \ar[d] & & X \ar[d] \ar[ld] \\
\text{Spec}(A) \ar[r] & Z \ar[r] & Y
}
$$
such that the closed point of $\text{Spec}(A)$ maps to $z$.
\end{lemma}

\begin{proof}
Let $z \in \text{Spec}(R) = V \subset Y$ be an affine open
neighbourhood of $z$. By
Lemma \ref{lemma-quasi-compact-scheme-theoretic-image}
we have $Z \cap V$ is the scheme theoretic closure of
$f^{-1}(V) \to V$, and hence we may replace $Y$ by $V$
and assume $Y = \text{Spec}(R)$ is affine.
In this case $X$ is quasi-compact as $f$ is quasi-compact.
Say $X = U_1 \cup \ldots \cup U_n$
is a finite affine open covering. Write $U_i = \text{Spec}(A_i)$.
Let $I = \text{Ker}(R \to A_1 \times \ldots \times A_n)$.
By Lemma \ref{lemma-quasi-compact-scheme-theoretic-image}
again we see that $Z$ corresponds to the closed subscheme
$\text{Spec}(R/I)$ of $Y$. If $\mathfrak p \subset R$ is
the prime corresponding to $z$, then we see that
$I_{\mathfrak p} \subset R_{\mathfrak p}$ is not an
equality. Hence (as localization is exact, see
Algebra, Proposition \ref{algebra-proposition-localization-exact})
we see that
$R_{\mathfrak p} \to
(A_1)_{\mathfrak p} \times \ldots \times (A_1)_{\mathfrak p}$
is not zero. Hence one of the rings $(A_i)_{\mathfrak p}$ is not zero.
Hence there exists an $i$ and a prime $\mathfrak q_i \subset A_i$
lying over a prime $\mathfrak p_i \subset \mathfrak p$.
By Algebra, Lemma \ref{algebra-lemma-dominate} we can choose a valuation ring
$A \subset K = f.f.(A_i/\mathfrak q_i)$ dominating
the local ring
$R_{\mathfrak p}/\mathfrak p_1R_{\mathfrak p} \subset f.f.(A_i/\mathfrak q_i)$.
This gives the desired diagram. Some details omitted.
\end{proof}


\begin{lemma}
\label{lemma-factor-factor}
Let $f_1 : X \to Y_1$ and $Y_1 \to Y_2$ be morphisms of schemes.
Let $f_2 : X \to Y_2$ be the composition. Let $Z_i \subset Y_i$, $i = 1, 2$ be
the scheme theoretic image of $f_i$. Then the morphism
$Y_1 \to Y_2$ induces a morphism $Z_1 \to Z_2$ and a
commutative diagram
$$
\xymatrix{
X \ar[r] \ar[rd] & Z_1 \ar[d] \ar[r] & Y_1 \ar[d] \\
& Z_2 \ar[r] & Y_2
}
$$
\end{lemma}

\begin{proof}
See Schemes, Lemma \ref{schemes-lemma-characterize-closed-subspace}.
\end{proof}

\begin{lemma}
\label{lemma-scheme-theoretic-image-reduced}
Let $f : X \to Y$ be a morphism of schemes.
If $X$ is reduced, then the scheme theoretic image of $f$ is
the reduced induced scheme structure on $\overline{f(X)}$.
\end{lemma}

\begin{proof}
This is true because the reduced induced scheme structure on $\overline{f(X)}$
is clearly the smallest closed subscheme of $Y$ through which $f$ factors,
see
Schemes, Lemma \ref{schemes-lemma-map-into-reduction}.
\end{proof}




\section{Scheme theoretic closure and density}
\label{section-scheme-theoretic-closure}

\begin{definition}
\label{definition-scheme-theoretically-dense}
Let $X$ be a scheme. Let $U \subset X$ be an open subscheme.
\begin{enumerate}
\item The scheme theoretic image of the morphism $U \to X$
is called the {\it scheme theoretic closure of $U$ in $X$}.
\item We say $U$ is {\it scheme theoretically dense in $X$}
if for every open $V \subset X$ the scheme theoretic closure
of $U \cap V$ in $V$ is equal to $V$.
\end{enumerate}
\end{definition}

\noindent
This is \cite[IV, Definition 11.10.2]{EGA}. With this definition it is
{\bf not} the case that $U$ is scheme theoretically dense in $X$ if and
only if the scheme theoretic closure of $U$ is $X$, see
Example \ref{example-scheme-theretically-dense-not-dense}.
This is somewhat inelegant; but see
Lemmas \ref{lemma-scheme-theoretically-dense-quasi-compact}
and
\ref{lemma-reduced-scheme-theoretically-dense}
below. On the other hand, with this definition $U$ is scheme theoretically
dense in $X$ if and only if for every $V \subset X$ open the ring map
$\mathcal{O}_X(V) \to \mathcal{O}_X(U \cap V)$ is injective, see
Lemma \ref{lemma-characterize-scheme-theoretically-dense}
below. In particular we see that scheme theoretically dense implies dense
which is pleasing.

\begin{example}
\label{example-scheme-theretically-dense-not-dense}
Here is an example where scheme theoretic closure being $X$ does not
imply dense for the underlying topological spaces.
Let $k$ be a field.
Set $A = k[x, z_1, z_2, \ldots]/(x^n z_n)$
Set $I = (z_1, z_2, \ldots) \subset A$.
Consider the affine scheme $X = \text{Spec}(A)$ and the
open subscheme $U = X \setminus V(I)$.
Since $A \to \prod_n A_{z_n}$ is injective we see that the scheme theoretic
closure of $U$ is $X$. Consider the morphism
$X \to \text{Spec}(k[x])$. This morphism is surjective
(set all $z_n = 0$ to see this). But the restriction
of this morphism to $U$ is not surjective because it maps
to the point $x = 0$. Hence $U$ cannot be topologically dense
in $X$.
\end{example}

\begin{lemma}
\label{lemma-scheme-theoretically-dense-quasi-compact}
Let $X$ be a scheme.
Let $U \subset X$ be an open subscheme.
If the inclusion morphism $U \to X$ is quasi-compact, then $U$
is scheme theoretically dense in $X$ if and only if the scheme theoretic
closure of $U$ in $X$ is $X$.
\end{lemma}

\begin{proof}
Follows from Lemma \ref{lemma-quasi-compact-scheme-theoretic-image} part (3).
\end{proof}

\begin{example}
\label{example-scheme-theoretic-closure}
Let $A$ be a ring and $X = \text{Spec}(A)$.
Let $f_1, \ldots, f_n \in A$ and let $U = D(f_1) \cup \ldots \cup D(f_n)$.
Let $I = \text{Ker}(A \to \prod A_{f_i})$.
Then the scheme theoretic closure of $U$ in $X$
is the closed subscheme $\text{Spec}(A/I)$ of $X$.
Note that $U \to X$ is quasi-compact. Hence by
Lemma \ref{lemma-scheme-theoretically-dense-quasi-compact}
we see $U$ is scheme theoretically dense in $X$ if and only if $I = 0$.
\end{example}

\begin{lemma}
\label{lemma-characterize-scheme-theoretically-dense}
Let $j : U \to X$ be an open immersion of schemes.
Then $U$ is scheme theoretically dense in $X$ if and only if
$\mathcal{O}_X \to j_*\mathcal{O}_U$ is injective.
\end{lemma}

\begin{proof}
If $\mathcal{O}_X \to j_*\mathcal{O}_U$ is injective,
then the same is true when restricted to any open $V$ of $X$.
Hence the scheme theoretic closure of $U \cap V$ in $V$
is equal to $V$, see Lemma \ref{lemma-quasi-compact-scheme-theoretic-image}
for example. Conversely, suppose that the scheme theoretic
closure of $U \cap V$ is equal to $V$ for all opens $V$.
Suppose that $\mathcal{O}_X \to j_*\mathcal{O}_U$ is not injective.
Then we can find an affine open, say $\text{Spec}(A) = V \subset X$
and a nonzero element $f \in A$ such that $f$ maps to zero in
$\Gamma(V \cap U, \mathcal{O}_X)$. In this case the scheme theoretic
closure of $V \cap U$ in $V$ is clearly contained in $\text{Spec}(A/(f))$
a contradiction.
\end{proof}

\begin{lemma}
\label{lemma-intersection-scheme-theoretically-dense}
Let $X$ be a scheme. If $U$, $V$ are scheme theoretically dense
open subschemes of $X$, then so is $U \cap V$.
\end{lemma}

\begin{proof}
Let $W \subset X$ be any open.
Consider the map
$\mathcal{O}_X(W) \to \mathcal{O}_X(W \cap V)
\to \mathcal{O}_X(W \cap V \cap U)$.
By Lemma \ref{lemma-characterize-scheme-theoretically-dense}
both maps are injective. Hence the composite is injective.
Hence by Lemma \ref{lemma-characterize-scheme-theoretically-dense}
$U \cap V$ is scheme theoretically dense in $X$.
\end{proof}

\begin{lemma}
\label{lemma-quasi-compact-immersion}
Let $Z \to X$ be an immersion. Assume either $Z \to X$ is quasi-compact
or $Z$ is reduced.
Let $\overline{Z} \subset X$ be the scheme theoretic image of $h$.
Then the morphism $Z \to \overline{Z}$ is an open immersion
which identifies $Z$ with a scheme theoretically dense open
subscheme of $\overline{Z}$. Moreover, $Z$ is topologically
dense in $\overline{Z}$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-factor-quasi-compact-immersion} or
Lemma \ref{lemma-factor-reduced-immersion} we can factor
$Z \to X$ as $Z \to \overline{Z}_1 \to X$ with $Z \to \overline{Z}_1$
open and $\overline{Z}_1 \to X$ closed. On the other hand, let
$Z \to \overline{Z} \subset X$ be the scheme theoretic closure of
$Z \to X$. We conclude that $\overline{Z} \subset \overline{Z}_1$.
Since $Z$ is an open subscheme of $\overline{Z}_1$ it follows
that $Z$ is an open subscheme of $\overline{Z}$ as well.
In the case that $Z$ is reduced we know that $Z \subset \overline{Z}_1$
is topologically dense by the construction of $\overline{Z}_1$ in
the proof of Lemma \ref{lemma-factor-reduced-immersion}.
Hence $\overline{Z}_1$ and $\overline{Z}$ have the same
underlying topological spaces. Thus $\overline{Z} \subset \overline{Z}_1$
is a closed immersion into a reduced scheme which induces a bijection
on underlying topological spaces, and hence it is an isomorphism.
In the case that $Z \to X$ is quasi-compact we argue as follows:
The assertion that $Z$ is scheme theoretically dense in
$\overline{Z}$ follows from
Lemma \ref{lemma-quasi-compact-scheme-theoretic-image} part (3).
The last assertion follows from
Lemma \ref{lemma-quasi-compact-scheme-theoretic-image} part (4).
\end{proof}

\begin{lemma}
\label{lemma-reduced-scheme-theoretically-dense}
Let $X$ be a reduced scheme and let $U \subset X$ be an open subscheme.
Then the following are equivalent
\begin{enumerate}
\item $U$ is topologically dense in $X$,
\item the scheme theoretic closure of $U$ in $X$ is $X$, and
\item $U$ is scheme theoretically dense in $X$.
\end{enumerate}
\end{lemma}

\begin{proof}
This follows from
Lemma \ref{lemma-quasi-compact-immersion}
and the fact that the a closed subscheme $Z$ of $X$ whose
underlying topological space equals $X$ must be equal to $X$
as a scheme.
\end{proof}

\begin{lemma}
\label{lemma-reduced-subscheme-closure}
Let $X$ be a scheme and let $U \subset X$ be a reduced open subscheme.
Then the following are equivalent
\begin{enumerate}
\item the scheme theoretic closure of $U$ in $X$ is $X$, and
\item $U$ is scheme theoretically dense in $X$.
\end{enumerate}
If this holds then $X$ is a reduced scheme.
\end{lemma}

\begin{proof}
This follows from
Lemma \ref{lemma-quasi-compact-immersion}
and the fact that the scheme theoretic closure of $U$ in $X$ is
reduced by
Lemma \ref{lemma-scheme-theoretic-image-reduced}.
\end{proof}


\begin{lemma}
\label{lemma-equality-of-morphisms}
Let $S$ be a scheme. Let $X$, $Y$ be schemes over $S$.
Let $f, g : X \to Y$ be morphisms of schemes over $S$.
Let $U \subset X$ be an open subscheme such that
$f|_U = g|_U$. If the scheme theoretic closure of $U$
in $X$ is $X$ and $Y \to S$ is separated, then $f = g$.
\end{lemma}

\begin{proof}
Follows from the definitions and
Schemes, Lemma \ref{schemes-lemma-where-are-they-equal}.
\end{proof}




\section{Dominant morphisms}
\label{section-dominant}

\noindent
The definition of a morphism of schemes being dominant is a little
different from what you might expect if you are used to the notion
of a dominant morphism of varieties.

\begin{definition}
\label{definition-dominant}
A morphism $f : X \to S$ of schemes is called {\it dominant} if the
image of $f$ is a dense subset of $S$.
\end{definition}

\noindent
So for example, if $k$ is an infinite field and $\lambda_1, \lambda_2, \ldots$
is a countable collection of elements of $k$, then the morphism
$$
\coprod\nolimits_{i = 1, 2, \ldots } \text{Spec}(k)
\longrightarrow
\text{Spec}(k[x])
$$
with $i$th factor mapping to the point $x = \lambda_i$ is dominant.

\begin{lemma}
\label{lemma-generic-points-in-image-dominant}
Let $f : X \to S$ be a morphism of schemes.
If every generic point of every irreducible component of $S$
is in the image of $f$, then $f$ is dominant.
\end{lemma}

\begin{proof}
This is a topological fact which follows directly from the fact that
the topological space underlying a scheme is sober, see
Schemes, Lemma \ref{schemes-lemma-scheme-sober}, and that
every point of $S$ is contained in an irreducible component of
$S$, see Topology, Lemma \ref{topology-lemma-irreducible}.
\end{proof}

\noindent
The expectation that morphisms are dominant only if generic points of the
target are in the image does hold if the morphism is quasi-compact.

\begin{lemma}
\label{lemma-quasi-compact-dominant}
Let $f : X \to S$ be a quasi-compact morphism of schemes.
Then $f$ is dominant (if and) only if for every irreducible
component $Z \subset S$ the generic point of $Z$ is in the
image of $f$.
\end{lemma}

\begin{proof}
Let $V \subset S$ be an affine open.
Because $f$ is quasi-compact we may choose finitely many affine
opens $U_i \subset f^{-1}(V)$, $i = 1, \ldots, n$ covering
$f^{-1}(V)$. Consider the morphism of affines
$$
f' :
\coprod\nolimits_{i = 1, \ldots, n} U_i
\longrightarrow
V.
$$
A disjoint union of affines is affine, see
Schemes, \ref{schemes-lemma-disjoint-union-affines}.
Generic points of irreducible components of $V$
are exactly the generic points of the irreducible components of
$S$ that meet $V$. Also, $f$ is dominant if and only $f'$ is dominant
no matter what choices of $V, n, U_i$ we make above. Thus we
have reduced the lemma to the case of a morphism of affine schemes.
The affine case is
Algebra, Lemma \ref{algebra-lemma-image-dense-generic-points}.
\end{proof}

\noindent
Here is a slightly more useful variant of the lemma above.

\begin{lemma}
\label{lemma-quasi-compact-generic-point-not-in-image}
Let $f : X \to S$ be a quasi-compact morphism of schemes.
Let $\eta \in S$ be a generic point of an irreducible
component of $S$. If $\eta \not \in f(X)$ then there
exists an open neighbourhood $V \subset S$ of $\eta$
such that $f^{-1}(V) = \emptyset$.
\end{lemma}

\begin{proof}
Let $Z \subset S$ be the scheme theoretic image of $f$.
By Lemma \ref{lemma-quasi-compact-scheme-theoretic-image}
the morphism $X \to Z$ is dominant, which by
Lemma \ref{lemma-quasi-compact-dominant}
means all the generic points of all irreducible components of $Z$
are in the image of $X \to Z$. By assumption we see that
$\eta \not \in Z$ (since $\eta$ would be the generic 
point of some irreducible component of $Z$ if it were in $Z$).
Hence there exists an open neighbourhood $V$ of $\eta$ in $Y$
such that $V \cap Z = \emptyset$. For this $V$ we have
$f^{-1}(V) = \emptyset$.
\end{proof}

\noindent
There is another case where dominant is the same as having all
generic points of irreducible components in the image.

\begin{lemma}
\label{lemma-dominant-finite-number-irreducible-components}
Let $f : X \to S$ be a morphism of schemes.
Suppose that $X$ has finitely many irreducible components.
Then $f$ is dominant (if and) only if for every irreducible
component $Z \subset S$ the generic point of $Z$ is in the
image of $f$. If so, then $S$ has finitely many irreducible
components as well.
\end{lemma}

\begin{proof}
Assume $f$ is dominant.
Say $X = Z_1 \cup Z_2 \cup \ldots \cup Z_n$ is the decomposition
of $X$ into irreducible components. Let $\xi_i \in Z_i$ be
its generic point, so $Z_i = \overline{\{\xi_i\}}$.
Note that $f(Z_i)$ is an irreducible subset of $S$.
Hence
$$
S = \overline{f(X)} = \bigcup \overline{f(Z_i)} =
\bigcup \overline{\{f(\xi_i)\}}
$$
is a finite union of irreducible subsets whose generic
points are in the image of $f$. The lemma follows.
\end{proof}






\section{Birational morphisms}
\label{section-birational}

\noindent
You may be used to the notion of a birational map of varieties
having the property that it is an isomorphism over an open subset
of the target. However, in general a birational morphism may
not be an isomorphism over any nonempty open, see
Example \ref{example-birational-not-iso-over-open}.
Here is the formal definition.

\begin{definition}
\label{definition-birational}
Let $X$, $Y$ be schemes. Assume $X$ and $Y$ have finitely many
irreducible components. We say a morphism $f : X \to Y$ is
{\it birational} if
\begin{enumerate}
\item $f$ induces a bijection between the set of generic points
of irreducible components of $X$ and the set of generic points
of the irreducible components of $Y$, and
\item for every generic point $\eta \in X$ of an irreducible component
of $X$ the local ring map
$\mathcal{O}_{Y, f(\eta)} \to \mathcal{O}_{X, \eta}$
is an isomorphism.
\end{enumerate}
\end{definition}

\begin{lemma}
\label{lemma-birational-dominant}
Let $f : X \to Y$ be a morphism of schemes having finitely
many irreducible components. If $f$ is birational then
$f$ is dominant.
\end{lemma}

\begin{proof}
Follows immediately from the definitions.
\end{proof}

\begin{example}
\label{example-birational-not-iso-over-open}
Here is an example of a birational morphism which is not an isomorphism
over any open of the target.
Let $k$ be an infinite field.
Let $A = k[x]$. Let
$B = k[x, \{y_{\alpha}\}_{\alpha \in k}]/
((x-\alpha)y_\alpha, y_\alpha y_\beta)$.
There is an inclusion $A \subset B$ and a retraction $B \to A$
setting all $y_\alpha$ equal to zero.
Both the morphism $\text{Spec}(A) \to \text{Spec}(B)$
and the morphism $\text{Spec}(B) \to \text{Spec}(A)$ are birational
but not an isomorphism over any open.
\end{example}





\section{Rational maps}
\label{section-rational-maps}

\noindent
Let $X$ be a scheme. Note that if $U$, $V$ are dense open
in $X$, then so is $U \cap V$.

\begin{definition}
\label{definition-rational-map}
Let $X$, $Y$ be schemes.
\begin{enumerate}
\item Let $f : U \to Y$, $g : V \to Y$ be morphisms of schemes defined
on dense open subsets $U$, $V$ of $X$. We say that $f$ is
{\it equivalent} to $g$ if $f|_W = g|_W$ for some $W \subset U \cap V$
dense open in $X$.
\item A {\it rational map from $X$ to $Y$}
is an equivalence class for the equivalence relation defined in (1).
\item If $X$, $Y$ are schemes over a base scheme $S$ we say that
a rational map from $X$ to $Y$ is an {\it $S$-rational map from $X$
to $Y$} if there exists a representative $f : U \to Y$ of the equivalence
class which is an $S$-morphism.
\end{enumerate}
\end{definition}

\noindent
We say that two morphisms $f$, $g$ as in (1) of the definition
define the same rational map instead of saying that they are equivalent.

\begin{definition}
\label{definition-rational-function}
Let $X$ be a scheme. A {\it rational function on $X$} is a rational morphism
from $X$ to $\mathbf{A}^1_{\mathbf{Z}}$.
\end{definition}

\noindent
See Constructions, Definition \ref{constructions-definition-affine-n-space}
for the definition of the affine line $\mathbf{A}^1$. Let $X$ be a scheme
over $S$. For any open $U \subset X$ a morphism
$U \to \mathbf{A}^1_{\mathbf{Z}}$ is the same as a morphism
$U \to \mathbf{A}^1_S$ over $S$. Hence a rational function is
also the same as a $S$-rational map from $X$ into $\mathbf{A}^1_S$.

\medskip\noindent
Recall that we have the canonical identification
$\text{Mor}(T, \mathbf{A}^1_{\mathbf{Z}}) = \Gamma(T, \mathcal{O}_T)$
for any scheme $T$, see Schemes, Example \ref{schemes-example-global-sections}.
Hence $\mathbf{A}^1_{\mathbf{Z}}$ is a ring-object in the
category of schemes. More precisely, the morphisms
\begin{eqnarray*}
+ : \mathbf{A}^1_{\mathbf{Z}} \times \mathbf{A}^1_{\mathbf{Z}}
& \longrightarrow &
\mathbf{A}^1_{\mathbf{Z}} \\
(f, g) & \longmapsto & f + g \\
* : \mathbf{A}^1_{\mathbf{Z}} \times \mathbf{A}^1_{\mathbf{Z}}
& \longrightarrow &
\mathbf{A}^1_{\mathbf{Z}} \\
(f, g) & \longmapsto & fg
\end{eqnarray*}
satisfy all the axioms of the addition and multiplication in a ring
(commutative with $1$ as always). Hence also the set of rational
maps into $\mathbf{A}^1_{\mathbf{Z}}$ has a natural ring structure.

\begin{definition}
\label{definition-ring-of-rational-functions}
Let $X$ be a scheme. The {\it ring of rational functions on $X$}
is the ring $R(X)$ whose elements are rational functions with
addition and multiplication as just described.
\end{definition}

\begin{lemma}
\label{lemma-integral-scheme-rational-functions}
Let $X$ be an irreducible scheme. Let $\eta \in X$ be the generic point
of $X$. There is a canonical identification
$R(X) \cong \mathcal{O}_{X, \eta}$. If $X$ is integral then
$R(X) = \kappa(\eta) = \mathcal{O}_{X, \eta}$ is
a field.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{definition}
\label{definition-function-field}
Let $X$ be an integral scheme.
The {\it function field}, or the {\it field of rational functions}
of $X$ is the field $R(X)$.
\end{definition}

\noindent
We may occasionally indicate this field $k(X)$ instead of $R(X)$.

\begin{remark}
\label{remark-pseudo-morphisms}
There is a variant of Definition \ref{definition-rational-map}
where we consider only those morphism $U \to Y$ defined on
scheme theoretically dense open subschemes $U \subset X$.
We use Lemma \ref{lemma-intersection-scheme-theoretically-dense}
to see that we obtain an equivalence relation.
An equivalence class of these is called a
{\it pseudo-morphism from $X$ to $Y$}.
If $X$ is reduced the two notions coincide.
\end{remark}

\noindent
Here is a fun application of these notions.
Note that by Lemma \ref{lemma-integral-scheme-rational-functions}
on an integral scheme every local ring $\mathcal{O}_{X, x}$ may be viewed
as a local subring of $R(X)$.

\begin{lemma}
\label{lemma-distinct-local-rings}
Let $X$ be an integral separated scheme.
Let $Z_1$, $Z_2$ be distinct irreducible closed subsets of $X$.
Let $\eta_i$ be the generic point of $Z_i$.
If $Z_1 \not\subset Z_2$, then
$\mathcal{O}_{X, \eta_1} \not \subset \mathcal{O}_{X, \eta_2}$
as subrings of $R(X)$.
In particular, if $Z_1 = \{x\}$ consists of one closed point $x$,
there exists a function regular in a neighborhood of $x$
which is not in $\mathcal{O}_{X, \eta_{2}}$.
\end{lemma}

\begin{proof}
First observe that under the assumption of $X$ being seperated,
there is a unique map of schemes
$\text{Spec}(\mathcal{O}_{X, \eta_2}) \to X$ over $X$
such that the composition
$$
\text{Spec}(R(X)) \longrightarrow
\text{Spec}(\mathcal{O}_{X, \eta_2}) \longrightarrow X
$$
is the canonical map $\text{Spec}(R(X)) \to X$.
Namely, there is the canonical map
$can : \text{Spec}(\mathcal{O}_{X, \eta_2}) \to X$, see
Schemes, Equation (\ref{schemes-equation-canonical-morphism}).
Given a second morphism $a$ to $X$, we have that $a$ agrees with $can$
on the generic point of
$\text{Spec}(\mathcal{O}_{X,\eta_2})$ by assumption.
Now being $X$ being seperated guarantees that the subset in
$\text{Spec}(\mathcal{O}_{X,\eta_2})$ where
these two maps agree is closed, see
Schemes, Lemma \ref{schemes-lemma-where-are-they-equal}.
Hence $a = can$ on all of $\text{Spec}(\mathcal{O}_{X,\eta_2})$.

\medskip\noindent
Assume $Z_1 \not \subset Z_2$ and assume on the contrary that
$\mathcal{O}_{X,\eta_{1}} \subset \mathcal{O}_{X,\eta_{2}}$
as subrings of $R(X)$. Then we would obtain a second morphism
$$
\text{Spec}(\mathcal{O}_{X,\eta_{2}}) \longrightarrow
\text{Spec}(\mathcal{O}_{X,\eta_{1}}) \longrightarrow
X.
$$
By the above this composition would have to be equal to $can$.
This implies that $\eta_2$ specializes to $\eta_1$ (see
Schemes, Lemma \ref{schemes-lemma-specialize-points}).
But this contradicts our assumption $Z_1 \not \subset Z_2$.
\end{proof}







\section{Surjective morphisms}
\label{section-surjective}

\begin{definition}
\label{definition-surjective}
A morphism of schemes is said to be {\it surjective}
if it is surjective on underlying topological
spaces.
\end{definition}

\begin{lemma}
\label{lemma-composition-surjective}
The composition of surjective morphisms is surjective.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-when-point-maps-to-pair}
Let $X$ and $Y$ be schemes over a base scheme $S$. Given points $x \in X$ and
$y \in Y$, there is a point of $X \times_S Y$ mapping to $x$ and $y$ under the
projections if and only if $x$ and $y$ lie above the same point of $S$.
\end{lemma}

\begin{proof}
The condition is obviously necessary, and the converse follows from the proof
of Schemes, Lemma \ref{schemes-lemma-points-fibre-product}.
\end{proof}

\begin{lemma}
\label{lemma-base-change-surjective}
The base change of a surjective morphism is surjective.
\end{lemma}

\begin{proof}
Let $f: X \to Y$ be a morphism of schemes over a base scheme $S$.
If $S' \to S$ is a morphism of schemes, let $p: X_{S'} \to X$
and $q: Y_{S'} \to Y$ be the canonical projections.  The commutative
square
$$
\xymatrix{
X_{S'} \ar[d]_{f_{S'}} \ar[r]_{p} & X \ar[d]^{f} \\
Y_{S'} \ar[r]^{q} & Y.
}
$$
identifies $X_{S'}$ as a fibre product of $X \to Y$ and
$Y_{S'} \to Y$.  Let $Z$ be a subset of the underlying topological
space of $X$.  Then $q^{-1}(f(Z)) = f_{S'}(p^{-1}(Z))$, because
$y' \in q^{-1}(f(Z))$ if and only if $q(y') = f(x)$ for some $x \in Z$,
if and only if, by Lemma \ref{lemma-when-point-maps-to-pair}, there exists
$x' \in X_{S'}$ such that $f_{S'}(x') = y'$ and $p(x') = x$.  In particular
taking $Z = X$ we see that if $f$ is surjective so is the base change
$f_{S'}: X_{S'} \to Y_{S'}$.
\end{proof}

\begin{example}
\label{example-injective-not-preserved-base-change}
Bijectivity is not stable under base change, and so neither is injectivity.
For example consider the bijection
$\text{Spec}(\mathbf{C}) \to \text{Spec}(\mathbf{R})$.
The base change
$\text{Spec}(\mathbf{C} \otimes_{\mathbf{R}} \mathbf{C}) \to
\text{Spec}(\mathbf{C})$
is not injective, since there is an isomorphism
$\mathbf{C} \otimes_{\mathbf{R}} \mathbf{C} \cong \mathbf{C} \times \mathbf{C}$
(the decomposition comes from the idempotent
$\frac{1 \otimes 1 + i \otimes i}{2}$) and hence
$\text{Spec}(\mathbf{C} \otimes_{\mathbf{R}} \mathbf{C})$ has two points.
\end{example}

\begin{lemma}
\label{lemma-surjection-from-quasi-compact}
Let
$$
\xymatrix{
X \ar[rr]_f \ar[rd]_p & &
Y \ar[dl]^q \\
& Z
}
$$
be a commutative diagram of morphisms of schemes.
If $f$ is surjective and $p$ is quasi-compact, then $q$ is quasi-compact.
\end{lemma}

\begin{proof}
Let $W \subset Z$ be a quasi-compact open. By assumption $p^{-1}(W)$
is quasi-compact. Hence by
Topology, Lemma \ref{topology-lemma-image-quasi-compact}
the inverse image $q^{-1}(W) = f(p^{-1}(W))$ is quasi-compact too.
This proves the lemma.
\end{proof}




\section{Radicial and universally injective morphisms}
\label{section-radicial}

\noindent
In this section we define what it means for a morphism of schemes to
be {\it radicial} and what it means for a morphism of schemes to be
{\it universally injective}. We then show that these notions agree.
The reason for introducing both is that in the case of algebraic spaces
there are corresponding notions which may not always agree.

\begin{definition}
\label{definition-universally-injective}
Let $f : X \to S$ be a morphism.
\begin{enumerate}
\item We say that $f$ is {\it universally injective} if and only
if for any morphism of schemes $S' \to S$ the base change
$f' : X_{S'} \to S'$ is injective (on underlying topological spaces).
\item We say $f$ is {\it radicial} if $f$ is injective as a
map of topological spaces, and for every $x \in X$ the field
extension $\kappa(x) \supset \kappa(f(x))$ is purely inseparable.
\end{enumerate}
\end{definition}

\begin{lemma}
\label{lemma-universally-injective}
Let $f : X \to S$ be a morphism of schemes.
The following are equivalent:
\begin{enumerate}
\item For every field $K$ the induced map
$\text{Mor}(\text{Spec}(K), X) \to \text{Mor}(\text{Spec}(K), S)$
is injective.
\item The morphism $f$ is universally injective.
\item The morphism $f$ is radicial.
\item The diagonal morphism $\Delta_{X/S} : X \longrightarrow X \times_S X$
is surjective.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $K$ be a field, and let $s : \text{Spec}(K) \to S$ be a morphism.
Giving a morphism $x : \text{Spec}(K) \to X$ such that $f \circ x = s$
is the same as giving a section of the projection
$X_K = \text{Spec}(K) \times_S X \to \text{Spec}(K)$, which in turn
is the same as giving a point $x \in X_K$ whose residue field is $K$.
Hence we see that (2) implies (1).

\medskip\noindent
Conversely, suppose that (1) holds. Assume that $x, x' \in X_{S'}$
map to the same point $s' \in S'$. Choose a commutative diagram
$$
\xymatrix{
K & \kappa(x) \ar[l] \\
\kappa(x') \ar[u] & \kappa(s') \ar[l] \ar[u]
}
$$
of fields. By Schemes, Lemma \ref{schemes-lemma-characterize-points}
we get two morphisms $a, a' : \text{Spec}(K) \to X_{S'}$. One corresponding
to the point $x$ and the embedding $\kappa(x) \subset K$ and
the other corresponding to the  point $x'$ and the embedding
$\kappa(x') \subset K$. Also we have $f' \circ a = f' \circ a'$.
Condition (1) now implies that the compositions of $a$ and $a'$ with
$X_{S'} \to X$ are equal. Since $X_{S'}$ is the fibre product
of $S'$ and $X$ over $S$ we see that $a = a'$. Hence $x = x'$.
Thus (1) implies (2).

\medskip\noindent
If there are two different points $x, x' \in X$ mapping to the same point of $s$
then (2) is violated.
If for some $s = f(x)$, $x \in X$ the field extension
$\kappa(s) \subset \kappa(x)$ is not purely inseparable, then
we may find a field extension $\kappa(s) \subset K$ such that
$\kappa(x)$ has two $\kappa(s)$-homomorphisms into $K$. By
Schemes, Lemma \ref{schemes-lemma-characterize-points} this
implies that the map
$\text{Mor}(\text{Spec}(K), X) \to \text{Mor}(\text{Spec}(K), S)$
is not injective, and hence (1) is violated.
Thus we see that the equivalent conditions (1) and (2) imply
$f$ is radicial, i.e., they imply (3).

\medskip\noindent
Assume (3). By
Schemes, Lemma \ref{schemes-lemma-characterize-points}
a morphism $\text{Spec}(K) \to X$ is given by a pair $(x, \kappa(x) \to K)$.
Property (3) says exactly that associating to the pair
$(x, \kappa(x) \to K)$ the pair $(s, \kappa(s) \to \kappa(x) \to K)$
is injective. In other words (1) holds. At this point we know that
(1), (2) and (3) are all equivalent.

\medskip\noindent
Finally, we prove the equivalence of (4) with (1), (2) and (3).
A point of $X \times_S X$ is given by a quadruple
$(x_1, x_2, s, \mathfrak p)$, where $x_1, x_2 \in X$,
$f(x_1) = f(x_2) = s$ and
$\mathfrak p \subset \kappa(x_1) \otimes_{\kappa(s)} \kappa(x_2)$
is a prime ideal, see
Schemes, Lemma \ref{schemes-lemma-points-fibre-product}.
If $f$ is universally injective, then 
by taking $S'=X$ in the definition of universally injective,
$\Delta_{X/S}$ must be surjective since it is a section of
the injective morphism
$X \times_S X  \longrightarrow X$.
Conversely, if
$\Delta_{X/S}$ is surjective, then always $x_1 = x_2 = x$ and there
is exactly one such prime ideal $\mathfrak p$, which means that
$\kappa(s) \subset \kappa(x)$ is purely inseparable.
Hence $f$ is radicial.
Alternatively, if $\Delta_{X/S}$ is surjective,
then for any $S' \to S$ the base
change $\Delta_{X_{S'}/S'}$ is surjective which implies that $f$
is universally injective. This finishes the proof of the lemma.
\end{proof}

\begin{lemma}
\label{lemma-base-change-universally-injective}
A base change of a universally injective morphism is universally injective.
\end{lemma}

\begin{proof}
This is formal.
\end{proof}

\begin{lemma}
\label{lemma-composition-universally-injective}
A composition of radicial morphisms is radicial, and so the same holds
for the equivalent condition of being universally injective.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}









\section{Affine morphisms}
\label{section-affine}

\begin{definition}
\label{definition-affine}
A morphism of schemes $f : X \to S$ is called {\it affine} if
the inverse image of every affine open of $S$ is an affine
open of $X$.
\end{definition}

\begin{lemma}
\label{lemma-affine-separated}
An affine morphism is separated and quasi-compact.
\end{lemma}

\begin{proof}
Let $f : X \to S$ be affine. Quasi-compactness is immediate from
Schemes, Lemma \ref{schemes-lemma-quasi-compact-affine}.
We will show $f$ is separated using
Schemes, Lemma \ref{schemes-lemma-characterize-separated}. Let
$x_1, x_2 \in X$ be points of $X$ which map to the same point $s \in S$.
Choose any affine open $W \subset S$ containing $s$. By assumption
$f^{-1}(W)$ is affine. Apply the lemma cited with $U = V = f^{-1}(W)$.
\end{proof}

\begin{lemma}
\label{lemma-characterize-affine}
Let $f : X \to S$ be a morphism of schemes.
The following are equivalent
\begin{enumerate}
\item The morphism $f$ is affine.
\item There exists an affine open covering $S = \bigcup W_j$
such that each $f^{-1}(W_j)$ is affine.
\item There exists a quasi-coherent sheaf of $\mathcal{O}_S$-algebras
$\mathcal{A}$ and an isomorphism
$X \cong \underline{\text{Spec}}_S(\mathcal{A})$
of schemes over $S$. See
Constructions, Section \ref{constructions-section-spec} for notation.
\end{enumerate}
Moreover, in this case $X = \underline{\text{Spec}}_S(f_*\mathcal{O}_X)$.
\end{lemma}

\begin{proof}
It is obvious that (1) implies (2).

\medskip\noindent
Assume $S = \bigcup_{j \in J} W_j$ is an affine open covering such that
each $f^{-1}(W_j)$ is affine. By
Schemes, Lemma \ref{schemes-lemma-quasi-compact-affine} we see
that $f$ is quasi-compact. By
Schemes, Lemma \ref{schemes-lemma-characterize-quasi-separated}
we see the morphism $f$ is quasi-separated. Hence by
Schemes, Lemma \ref{schemes-lemma-push-forward-quasi-coherent} the
sheaf $\mathcal{A} = f_*\mathcal{O}_X$ is a quasi-coherent sheaf
of $\mathcal{O}_X$-algebras. Thus we have the scheme
$g : Y = \underline{\text{Spec}}_S(\mathcal{A}) \to S$ over $S$.
The identity map
$\text{id} : \mathcal{A} = f_*\mathcal{O}_X \to f_*\mathcal{O}_X$
provides, via the definition of the relative spectrum,
a morphism $can : X \to Y$ over $S$, see
Constructions, Lemma \ref{constructions-lemma-canonical-morphism}.
By assumption and the lemma just cited
the restriction $can|_{f^{-1}(W_j)} : f^{-1}(W_j) \to g^{-1}(W_j)$
is an isomorphism. Thus $can$ is an isomorphism.
We have shown that (2) implies (3).

\medskip\noindent
Assume (3). By Constructions, Lemma \ref{constructions-lemma-spec-properties}
we see that the inverse image of every affine open is affine, and hence
the morphism is affine by definition.
\end{proof}

\begin{remark}
\label{remark-direct-argument}
We can also argue directly that (2) implies (1) in
Lemma \ref{lemma-characterize-affine} above as follows.
Assume $S = \bigcup W_j$ is an affine open covering
such that each $f^{-1}(W_j)$ is affine.
First argue that $\mathcal{A} = f_*\mathcal{O}_X$ is quasi-coherent
as in the proof above.
Let $\text{Spec}(R) = V \subset S$ be affine open.
We have to show that $f^{-1}(V)$ is affine. Set
$A = \mathcal{A}(V) = f_*\mathcal{O}_X(V) = \mathcal{O}_X(f^{-1}(V))$.
By Schemes, Lemma \ref{schemes-lemma-morphism-into-affine} there is
a canonical morphism $\psi : f^{-1}(V) \to \text{Spec}(A)$ over
$\text{Spec}(R) = V$.
By Schemes, Lemma \ref{schemes-lemma-good-subcover} there exists
an integer $n \geq 0$, a standard open covering
$V = \bigcup_{i = 1, \ldots, n} D(h_i)$, $h_i \in R$, and a map
$a : \{1, \ldots, n\} \to J$ such that each $D(h_i)$ is also
a standard open of the affine scheme $W_{a(i)}$. The inverse image
of a standard open under a morphism of affine schemes is standard open, see
Algebra, Lemma \ref{algebra-lemma-spec-functorial}. Hence we see
that $f^{-1}(D(h_i))$ is a standard open of $f^{-1}(W_{a(i)})$,
in particular that $f^{-1}(D(h_i))$ is affine. Because $\mathcal{A}$
is quasi-coherent we have
$A_{h_i} = \mathcal{A}(D(h_i)) = \mathcal{O}_X(f^{-1}(D(h_i)))$,
so $f^{-1}(D(h_i))$ is the spectrum of $A_{h_i}$.
It follows that the morphism $\psi$ induces an isomorphism of the open
$f^{-1}(D(h_i))$ with the open $\text{Spec}(A_{h_i})$ of
$\text{Spec}(A)$. Since $f^{-1}(V) = \bigcup f^{-1}(D(h_i))$
and $\text{Spec}(A) = \bigcup \text{Spec}(A_{h_i})$ we win.
\end{remark}

\begin{lemma}
\label{lemma-affine-equivalence-algebras}
Let $S$ be a scheme. There is an anti-equivalence of categories
$$
\begin{matrix}
\text{Schemes affine} \\
\text{over }S
\end{matrix}
\longleftrightarrow
\begin{matrix}
\text{quasi-coherent sheaves} \\
\text{of }\mathcal{O}_S\text{-algebras}
\end{matrix}
$$
which associates to $f : X \to S$ the sheaf $f_*\mathcal{O}_X$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-affine-equivalence-modules}
Let $f : X \to S$ be an affine morphism of schemes.
Let $\mathcal{A} = f_*\mathcal{O}_X$.
The functor $\mathcal{F} \mapsto f_*\mathcal{F}$ induces
an equivalence of categories
$$
\left\{
\begin{matrix}
\text{category of quasi-coherent}\\
\mathcal{O}_X\text{-modules}
\end{matrix}
\right\}
\longrightarrow
\left\{
\begin{matrix}
\text{category of quasi-coherent}\\
\mathcal{A}\text{-modules}
\end{matrix}
\right\}
$$
Moreover, an $\mathcal{A}$-module is
quasi-coherent as an $\mathcal{O}_S$-module if and only if
it is quasi-coherent as an $\mathcal{A}$-module.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-composition-affine}
The composition of affine morphisms is affine.
\end{lemma}

\begin{proof}
Let $f : X \to Y$ and $g : Y \to Z$ be affine morphisms.
Let $U \subset Z$ be affine open. Then $g^{-1}(U)$ is affine
by assumption on $g$. Whereupon $f^{-1}(g^{-1}(U))$ is affine
by assumption on $f$. Hence $(g \circ f)^{-1}(U)$ is affine.
\end{proof}

\begin{lemma}
\label{lemma-base-change-affine}
The base change of an affine morphism is affine.
\end{lemma}

\begin{proof}
Let $f : X \to S$ be an affine morphism. Let $S' \to S$ be any morphism.
Denote $f' : X_{S'} = S' \times_S X \to S'$ the base change of $f$.
For every $s' \in S'$ there exists an open affine neighbourhood
$s' \in V \subset S'$ which maps into some open affine $U \subset S$.
By assumption $f^{-1}(U)$ is affine. By the material in
Schemes, Section \ref{schemes-section-fibre-products} we see
that $f^{-1}(U)_{V} = V \times_U f^{-1}(U)$ is affine and equal
to $(f')^{-1}(V)$. This proves that $S'$ has an open covering by
affines whose inverse image under $f'$ is affine. We conclude
by Lemma \ref{lemma-characterize-affine} above.
\end{proof}

\begin{lemma}
\label{lemma-closed-immersion-affine}
A closed immersion is affine.
\end{lemma}

\begin{proof}
The first indication of this is
Schemes, Lemma \ref{schemes-lemma-closed-immersion-affine-case}.
See Schemes, Lemma \ref{schemes-lemma-closed-subspace-scheme}
for a complete statement.
\end{proof}

\begin{lemma}
\label{lemma-affine-s-open}
Let $X$ be a scheme.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
Let $s \in \Gamma(X, \mathcal{L})$.
The inclusion morphism $j : X_s \to X$ is affine.
\end{lemma}

\begin{proof}
This follows from Properties, Lemma \ref{properties-lemma-affine-cap-s-open}
and the definition.
\end{proof}

\begin{lemma}
\label{lemma-affine-permanence}
Suppose $g : X \to Y$ is a morphism of schemes over $S$.
If $X$ is affine over $S$ and $Y$ is separated over $S$,
then $g$ is affine. In particular, any morphism from an
affine scheme to a separated scheme is affine.
\end{lemma}

\begin{proof}
The base change $X \times_S Y \to Y$ is affine by
Lemma \ref{lemma-base-change-affine}.
The morphism $X \to X \times_S Y$ is
a closed immersion as $Y \to S$ is separated, see
Schemes, \ref{schemes-lemma-section-immersion}.
A closed immersion is affine (see Lemma \ref{lemma-closed-immersion-affine})
and the composition of affine morphisms is affine
(see Lemma \ref{lemma-composition-affine}). Thus we win.
\end{proof}

\begin{lemma}
\label{lemma-morphism-affines-affine}
A morphism between affine schemes is affine.
\end{lemma}

\begin{proof}
Immediate from Lemma \ref{lemma-affine-permanence} with
$S = \text{Spec}(\mathbf{Z})$. It also follows directly from the
equivalence of (1) and (2) in Lemma \ref{lemma-characterize-affine}.
\end{proof}

\begin{lemma}
\label{lemma-Artinian-affine}
Let $S$ be a scheme.
Let $A$ be an Artinian ring.
Any morphism $\text{Spec}(A) \to S$ is affine.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}









\section{Quasi-affine morphisms}
\label{section-quasi-affine}

\noindent
Recall that a scheme $X$ is called {\it quasi-affine} if it is quasi-compact
and isomorphic to an open subscheme of an affine scheme, see
Properties, Definition \ref{properties-definition-quasi-affine}.

\begin{definition}
\label{definition-quasi-affine}
A morphism of schemes $f : X \to S$ is called {\it quasi-affine} if the
inverse image of every affine open of $S$ is a quasi-affine scheme.
\end{definition}

\begin{lemma}
\label{lemma-quasi-affine-separated}
A quasi-affine morphism is separated and quasi-compact.
\end{lemma}

\begin{proof}
Let $f : X \to S$ be quasi-affine.
Quasi-compactness is immediate from
Schemes, Lemma \ref{schemes-lemma-quasi-compact-affine}.
We will show $f$ is separated using
Schemes, Lemma \ref{schemes-lemma-characterize-separated}. Let
$x_1, x_2 \in X$ be points of $X$ which map to the same point $s \in S$.
Choose any affine open $W \subset S$ containing $s$. By assumption
$f^{-1}(W)$ is isomorphic to an open subscheme of an affine scheme,
say $f^{-1}(W) \to Y$ is such an open immersion.
Choose affine open neighbourhoods $x_1 \in U \subset f^{-1}(W)$
and $x_2 \in V \subset f^{-1}(W)$. We may think of $U$ and $V$
as open subschemes of $Y$ and hence we see that
$U \cap V$ is affine and that
$\mathcal{O}(U) \otimes_{\mathbf{Z}} \mathcal{O}(V) \to \mathcal{O}(U \cap V)$
is surjective (by the lemma cited above applied to $U, V$ in $Y$).
Hence by the lemma cited we conclude that $f$ is separated.
\end{proof}

\begin{lemma}
\label{lemma-characterize-quasi-affine}
Let $f : X \to S$ be a morphism of schemes.
The following are equivalent
\begin{enumerate}
\item The morphism $f$ is quasi-affine.
\item There exists an affine open covering $S = \bigcup W_j$
such that each $f^{-1}(W_j)$ is quasi-affine.
\item There exists a quasi-coherent sheaf of $\mathcal{O}_S$-algebras
$\mathcal{A}$ and a quasi-compact open immersion
$$
\xymatrix{
X \ar[rr] \ar[rd] & & \underline{\text{Spec}}_S(\mathcal{A}) \ar[dl] \\
& S &
}
$$
over $S$.
\item Same as in (3) but with $\mathcal{A} = f_*\mathcal{O}_X$
and the horizontal arrow the canonical morphism of
Constructions, Lemma \ref{constructions-lemma-canonical-morphism}.
\end{enumerate}
\end{lemma}

\begin{proof}
It is obvious that (1) implies (2) and that (4) implies (3).

\medskip\noindent
Assume $S = \bigcup_{j \in J} W_j$ is an affine open covering such that
each $f^{-1}(W_j)$ is quasi-affine. By
Schemes, Lemma \ref{schemes-lemma-quasi-compact-affine} we see
that $f$ is quasi-compact. By
Schemes, Lemma \ref{schemes-lemma-characterize-quasi-separated}
we see the morphism $f$ is quasi-separated. Hence by
Schemes, Lemma \ref{schemes-lemma-push-forward-quasi-coherent} the
sheaf $\mathcal{A} = f_*\mathcal{O}_X$ is a quasi-coherent sheaf
of $\mathcal{O}_X$-algebras. Thus we have the scheme
$g : Y = \underline{\text{Spec}}_S(\mathcal{A}) \to S$ over $S$.
The identity map
$\text{id} : \mathcal{A} = f_*\mathcal{O}_X \to f_*\mathcal{O}_X$
provides, via the definition of the relative spectrum,
a morphism $can : X \to Y$ over $S$, see
Constructions, Lemma \ref{constructions-lemma-canonical-morphism}.
By assumption, the lemma just cited, and
Properties, Lemma \ref{properties-lemma-quasi-affine}
the restriction $can|_{f^{-1}(W_j)} : f^{-1}(W_j) \to g^{-1}(W_j)$
is a quasi-compact open immersion. Thus $can$ is a quasi-compact
open immersion. We have shown that (2) implies (4).

\medskip\noindent
Assume (3). Choose any affine open $U \subset S$.
By Constructions, Lemma \ref{constructions-lemma-spec-properties}
we see that the inverse image of $U$ in the relative spectrum
is affine. Hence we conclude that $f^{-1}(U)$ is quasi-affine
(note that quasi-compactness is encoded in (3) as well).
Thus (3) implies (1).
\end{proof}

\begin{lemma}
\label{lemma-composition-quasi-affine}
The composition of quasi-affine morphisms is quasi-affine.
\end{lemma}

\begin{proof}
Let $f : X \to Y$ and $g : Y \to Z$ be quasi-affine morphisms.
Let $U \subset Z$ be affine open. Then $g^{-1}(U)$ is quasi-affine
by assumption on $g$. Let $j : g^{-1}(U) \to V$ be a quasi-compact
open immersion into an affine scheme $V$.
By Lemma \ref{lemma-characterize-quasi-affine} above
we see that $f^{-1}(g^{-1}(U))$
is a quasi-compact open subscheme of the relative spectrum
$\underline{\text{Spec}}_{g^{-1}(U)}(\mathcal{A})$ for
some quasi-coherent sheaf of $\mathcal{O}_{g^{-1}(U)}$-algebras
$\mathcal{A}$. By
Schemes, Lemma \ref{schemes-lemma-push-forward-quasi-coherent}
the sheaf $\mathcal{A}' = j_*\mathcal{A}$
is a quasi-coherent sheaf of $\mathcal{O}_V$-algebras
with the property that $j^*\mathcal{A}' = \mathcal{A}$.
Hence we get a commutative diagram
$$
\xymatrix{
f^{-1}(g^{-1}(U)) \ar[r] &
\underline{\text{Spec}}_{g^{-1}(U)}(\mathcal{A})
\ar[r] \ar[d] &
\underline{\text{Spec}}_{V}(\mathcal{A}') \ar[d] \\
& g^{-1}(U) \ar[r]^j & V
}
$$
with the square being a fibre square,
see Constructions, Lemma \ref{constructions-lemma-spec-properties}.
Note that the upper right corner is an affine scheme.
Hence $(g \circ f)^{-1}(U)$ is quasi-affine.
\end{proof}

\begin{lemma}
\label{lemma-base-change-quasi-affine}
The base change of a quasi-affine morphism is quasi-affine.
\end{lemma}

\begin{proof}
Let $f : X \to S$ be a quasi-affine morphism.
By Lemma \ref{lemma-characterize-quasi-affine} above
we can find a quasi-coherent sheaf
of $\mathcal{O}_S$-algebras $\mathcal{A}$ and a quasi-compact
open immersion $X \to \underline{\text{Spec}}_S(\mathcal{A})$
over $S$.
Let $g : S' \to S$ be any morphism.
Denote $f' : X_{S'} = S' \times_S X \to S'$ the base change of $f$.
Since the base change of a quasi-compact open immersion is
a quasi-compact open immersion we see that
$X_{S'} \to \underline{\text{Spec}}_{S'}(g^*\mathcal{A})$
is a quasi-compact open immersion
(we have used Schemes, Lemmas
\ref{schemes-lemma-quasi-compact-preserved-base-change} and
\ref{schemes-lemma-base-change-immersion} and
Constructions, Lemma \ref{constructions-lemma-spec-properties}).
By Lemma \ref{lemma-characterize-quasi-affine} again
we conclude that $X_{S'} \to S'$ is quasi-affine.
\end{proof}

\begin{lemma}
\label{lemma-quasi-compact-immersion-quasi-affine}
A quasi-compact immersion is quasi-affine.
\end{lemma}

\begin{proof}
Let $X \to S$ be a quasi-compact immersion. We have to show the
inverse image of every affine open is quasi-affine. Hence,
assuming $S$ is an affine scheme, we have to show
$X$ is quasi-affine. By Lemma \ref{lemma-quasi-compact-immersion}
the morphism $X \to S$ factors as $X \to Z \to S$ where $Z$ is a closed
subscheme of $S$ and $X \subset Z$ is a quasi-compact open.
Since $S$ is affine Lemma \ref{lemma-closed-immersion} implies
$Z$ is affine. Hence we win.
\end{proof}

\begin{lemma}
\label{lemma-affine-quasi-affine}
Let $S$ be a scheme. Let $X$ be an affine scheme.
A morphism $f : X \to S$ is quasi-affine if and only if it is quasi-compact.
In particular any morphism from an affine scheme to a quasi-separated
scheme is quasi-affine.
\end{lemma}

\begin{proof}
Let $V \subset S$ be an affine open. Then $f^{-1}(V)$ is an open subscheme
of the affine scheme $X$, hence quasi-affine if and only if it is
quasi-compact. This proves the first assertion. The quasi-compactness of any
$f : X \to S$ where $X$ is affine and $S$ quasi-separated follows from
Schemes, Lemma \ref{schemes-lemma-quasi-compact-permanence}
applied to $X \to S \to \text{Spec}(\mathbf{Z})$.
\end{proof}

\begin{lemma}
\label{lemma-quasi-affine-permanence}
Suppose $g : X \to Y$ is a morphism of schemes over $S$.
If $X$ is quasi-affine over $S$ and $Y$ is quasi-separated over $S$,
then $g$ is quasi-affine. In particular, any morphism from a
quasi-affine scheme to a quasi-separated scheme is quasi-affine.
\end{lemma}

\begin{proof}
The base change $X \times_S Y \to Y$ is quasi-affine by
Lemma \ref{lemma-base-change-quasi-affine}.
The morphism $X \to X \times_S Y$ is
a quasi-compact immersion as $Y \to S$ is quasi-separated, see
Schemes, \ref{schemes-lemma-section-immersion}.
A quasi-compact immersion is quasi-affine by
Lemma \ref{lemma-quasi-compact-immersion-quasi-affine}
and the composition of quasi-affine morphisms is quasi-affine
(see Lemma \ref{lemma-composition-quasi-affine}). Thus we win.
\end{proof}











\section{Types of morphisms defined by properties of ring maps}
\label{section-properties-ring-maps}

\noindent
In this section we study what properties of ring maps
allow one to define local properties of morphisms of schemes.

\begin{definition}
\label{definition-property-local}
Let $P$ be a property of ring maps.
\begin{enumerate}
\item We say that $P$ is {\it local} if the following hold:
\begin{enumerate}
\item For any ring map $R \to A$, and any $f \in R$ we have
$P(R \to A) \Rightarrow P(R_f \to A_f)$.
\item For any rings $R$, $A$, any $f \in R$, $a\in A$, and any ring map
$R_f \to A$ we have $P(R_f \to A) \Rightarrow P(R \to A_a)$.
\item For any ring map $R \to A$, and $a_i \in A$ such that
$(a_1, \ldots, a_n) = A$ then
$\forall i, P(R \to A_{a_i}) \Rightarrow P(R \to A)$.
\end{enumerate}
\item We say that $P$ is {\it stable under base change} if for any
ring maps $R \to A$, $R \to R'$ we have
$P(R \to A) \Rightarrow P(R' \to R' \otimes_R A)$.
\item We say that $P$ is {\it stable under composition} if for any
ring maps $A \to B$, $B \to C$ we have
$P(A \to B) \wedge P(B \to C) \Rightarrow P(A \to C)$.
\end{enumerate}
\end{definition}

\begin{definition}
\label{definition-locally-P}
Let $P$ be a property of ring maps.
Let $f : X \to S$ be a morphisms of schemes.
We say $f$ is {\it locally of type $P$} if for any $x \in X$
there exists an affine open neighbourhood $U$ of $x$
in $X$ which maps into an affine open $V \subset S$ such that
the induced ring map $\mathcal{O}_S(V) \to \mathcal{O}_X(U)$
has property $P$.
\end{definition}

\noindent
This is not a ``good'' definition unless the property $P$ is
a local property. Even if $P$ is a local property we will not
automatically use this definition to say that a morphism is
``locally of type $P$'' unless we also explicitly state the
definition elsewhere.

\begin{lemma}
\label{lemma-locally-P}
Let $f : X \to S$ be a morphism of schemes.
Let $P$ be a property of ring maps.
Let $\text{Spec}(A) = U$ be an affine open of $X$,
and $\text{Spec}(R) = V$ an affine open of $S$ such that
$f(U) \subset V$. Let $R \to A$ be the induced ring map.
If $f$ is locally of type $P$ and $P$ is local,
then $P(R \to A)$ holds.
\end{lemma}

\begin{proof}
By definition there exists an affine open covering
$U = \bigcup_{i \in I} U_i$, $U_i = \text{Spec}(A_i)$ such that each $f(U_i)$
is contained in an affine open $V_i = \text{Spec}(R_i)$ of $S$
and such $P(R_i \to A_i)$ holds for all $i$.
(Warning: $V_i$ may not be contained in $V$.)
For any $u \in U_i$ we may choose an open neighbourhood
$V_{iu} \subset V \cap V_i$ of $f(u)$ which is a standard affine
open in both $V$ and $V_i$, see
Schemes, Lemma \ref{schemes-lemma-standard-open-two-affines}.
Note that $u \in f^{-1}(V_{i, u})$.
Because $U_i$ is quasi-compact we may choose a finite
collection $V_{ij} \subset V \cap V_i$, $j \in I_i$ of such affine opens
such that $f(U_i) \subset \bigcup_{j \in I_j} V_{ij}$.
Write $V_{ij} = \text{Spec}(R_{ij})$, so that
$R_{ij} \cong R_{r_{ij}} \cong (R_i)_{r_{ij}'}$ for certain
$r_{ij} \in R$, $r_{ij}' \in R_i$.
We may cover each $U_i \cap f^{-1}(V_{ij})$
by finitely many standard opens of $U = \text{Spec}(A)$.
Say $U_i \cap f^{-1}(V_{ij}) = \bigcup_{k \in K_{ij}} D(a_{ijk})$,
with $a_{ijk} \in A$. We have $A_{a_{ijk}} \cong (A_i)_{a_{ijk}}$.
The open subschemes and their inclusion relations give rise
to the following commutative diagram or rings:
$$
\xymatrix{
& R_i \ar[r] \ar[d]^{r_{ij}'} & A_i \ar[d]^{r_{ij}'}
& A \ar[l] \ar[d]^{a_{ijk}}\\
R \ar[r]^{r_{ij}} & R_{ij} \ar[r] & A_i \otimes_{R_i} R_{ij} \ar[r]^-{a_{ijk}}
& A_{a_{ijk}}
}
$$
Here we have labeled each arrow which is a principal localization with
the element at which the source of the arrow is being localized.
Since we have $P(R_i \to A_i)$ we have
$P(R_{ij} \to A_i \otimes_{R_i} R_{ij})$ by
Definition \ref{definition-property-local} (1)(a).
Then we conclude $P(R \to A_{a_{ijk}})$ by
Definition \ref{definition-property-local} (1)(b).
Because the opens $D(a_{ijk})$ cover all the opens
$U_i \cap f^{-1}(D(r_{ij})$ which cover the opens $U_i$
which cover all of $U$ we see that $U = \bigcup_{ijk} D(a_{ijk})$.
Hence $P(R \to A)$ by Definition \ref{definition-property-local} (1)(c).
\end{proof}

\begin{lemma}
\label{lemma-locally-P-characterize}
Let $P$ be a local property of ring maps.
Let $f : X \to S$ be a morphism of schemes.
The following are equivalent
\begin{enumerate}
\item The morphism $f$ is locally of type $P$.
\item For every affine opens $U \subset X$, $V \subset S$
with $f(U) \subset V$ we have $P(\mathcal{O}_S(V) \to \mathcal{O}_X(U))$.
\item There exists an open covering $S = \bigcup_{j \in J} V_j$
and open coverings $f^{-1}(V_j) = \bigcup_{i \in I_j} U_i$ such
that each of the morphisms $U_i \to V_j$, $j\in J, i\in I_j$
is locally of type $P$.
\item There exists an affine open covering $S = \bigcup_{j \in J} V_j$
and affine open coverings $f^{-1}(V_j) = \bigcup_{i \in I_j} U_i$ such
that $P(\mathcal{O}_S(V_j) \to \mathcal{O}_X(U_i))$ holds, for all
$j\in J, i\in I_j$.
\end{enumerate}
Moreover, if $f$ is locally of type $P$ then for
any open subschemes $U \subset X$, $V \subset S$ with $f(U) \subset V$
the restriction $f|_U : U \to V$ is locally of type $P$.
\end{lemma}

\begin{proof}
This follows from Lemma \ref{lemma-locally-P} above.
\end{proof}

\begin{lemma}
\label{lemma-composition-type-P}
Let $P$ be a property of ring maps.
Assume $P$ is local and stable under composition.
The composition of morphisms locally of type $P$ is
locally of type $P$.
\end{lemma}

\begin{proof}
Let $f : X \to Y$ and $g : Y \to Z$ be morphisms locally of type $P$.
Let $x \in X$. Choose an affine open neighbourhood $W \subset Z$ of
$g(f(x))$. Choose an affine open neighbourhood $V \subset g^{-1}(W)$
of $f(x)$. Choose an affine open neighbourhood $U \subset f^{-1}(V)$
of $x$. By Lemma \ref{lemma-locally-P-characterize} the ring maps
$\mathcal{O}_Z(W) \to \mathcal{O}_Y(V)$ and
$\mathcal{O}_Y(V) \to \mathcal{O}_X(U)$ satisfy $P$.
Hence $\mathcal{O}_Z(W) \to \mathcal{O}_X(U)$ satisfies $P$
as $P$ is assumed stable under composition.
\end{proof}

\begin{lemma}
\label{lemma-base-change-type-P}
Let $P$ be a property of ring maps.
Assume $P$ is local and stable under base change.
The base change of a morphism locally of type $P$
is locally of type $P$.
\end{lemma}

\begin{proof}
Let $f : X \to S$ be a morphism locally of type $P$.
Let $S' \to S$ be any morphism. Denote
$f' : X_{S'} = S' \times_S X \to S'$ the base change of $f$.
For every $s' \in S'$ there exists an open affine neighbourhood
$s' \in V' \subset S'$ which maps into some open affine $V \subset S$.
By Lemma \ref{lemma-locally-P-characterize} the open $f^{-1}(V)$ is a
union of affines $U_i$ such that the ring maps
$\mathcal{O}_S(V) \to \mathcal{O}_X(U_i)$ all satisfy $P$.
By the material in Schemes, Section \ref{schemes-section-fibre-products}
we see that $f^{-1}(U)_{V'} = V' \times_V f^{-1}(V)$ is
the union of the affine opens $V' \times_V U_i$.
Since $\mathcal{O}_{X_{S'}}(V' \times_V U_i) =
\mathcal{O}_{S'}(V') \otimes_{\mathcal{O}_S(V)} \mathcal{O}_X(U_i)$
we see that the ring maps
$\mathcal{O}_{S'}(V') \to \mathcal{O}_{X_{S'}}(V' \times_V U_i)$
satisfy $P$ as $P$ is assumed stable under base change.
\end{proof}

\begin{lemma}
\label{lemma-properties-local}
The following properties of a ring map $R \to A$ are local.
\begin{enumerate}
\item (Isomorphism on local rings.)
For every prime $\mathfrak q$ of $A$ lying over $\mathfrak p \subset R$
the ring map $R \to A$ induces an isomorphism
$R_{\mathfrak p} \to A_{\mathfrak q}$.
\item (Open immersion.)
For every prime $\mathfrak q$ of $A$ there exists an $f \in R$,
$\varphi(f) \not \in \mathfrak q$ such that the ring map $\varphi : R \to A$
induces an isomorphism $R_f \to A_f$.
\item (Reduced fibres.)
For every prime $\mathfrak p$ of $R$ the fibre ring
$A \otimes_R \kappa(\mathfrak p)$ is reduced.
\item (Fibres of dimension at most $n$.)
For every prime $\mathfrak p$ of $R$ the fibre ring
$A \otimes_R \kappa(\mathfrak p)$ has Krull dimension at most $n$.
\item (Locally Noetherian on the target.)
The ring map $R \to A$ has the property that $A$ is Noetherian.
\item Add more here as needed\footnote{But only those properties
that are not already dealt with separately elsewhere.}.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-properties-base-change}
The following properties of ring maps are stable under base change.
\begin{enumerate}
\item (Isomorphism on local rings.)
For every prime $\mathfrak q$ of $A$ lying over $\mathfrak p \subset R$
the ring map $R \to A$ induces an isomorphism
$R_{\mathfrak p} \to A_{\mathfrak q}$.
\item (Open immersion.)
For every prime $\mathfrak q$ of $A$ there exists an $f \in R$,
$\varphi(f) \not \in \mathfrak q$ such that the ring map $\varphi : R \to A$
induces an isomorphism $R_f \to A_f$.
\item (Reduced fibres.)
For every prime $\mathfrak p$ of $R$ the fibre ring
$A \otimes_R \kappa(\mathfrak p)$ is reduced.
\item (Fibres of dimension at most $n$.)
For every prime $\mathfrak p$ of $R$ the fibre ring
$A \otimes_R \kappa(\mathfrak p)$ has Krull dimension at most $n$.
\item Add more here as needed\footnote{But only those properties
that are not already dealt with separately elsewhere.}.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-properties-composition}
The following properties of ring maps are stable under composition.
\begin{enumerate}
\item (Isomorphism on local rings.)
For every prime $\mathfrak q$ of $A$ lying over $\mathfrak p \subset R$
the ring map $R \to A$ induces an isomorphism
$R_{\mathfrak p} \to A_{\mathfrak q}$.
\item (Open immersion.)
For every prime $\mathfrak q$ of $A$ there exists an $f \in R$,
$\varphi(f) \not \in \mathfrak q$ such that the ring map $\varphi : R \to A$
induces an isomorphism $R_f \to A_f$.
\item (Locally Noetherian on the target.)
The ring map $R \to A$ has the property that $A$ is Noetherian.
\item Add more here as needed\footnote{But only those properties
that are not already dealt with separately elsewhere.}.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted.
\end{proof}








\section{Morphisms of finite type}
\label{section-finite-type}

\noindent
Recall that a ring map $R \to A$ is said to be of finite type
if $A$ is isomorphic to a quotient of $R[x_1, \ldots, x_n]$ as an $R$-algebra.

\begin{definition}
\label{definition-finite-type}
Let $f : X \to S$ be a morphism of schemes.
\begin{enumerate}
\item We say that $f$ is of {\it finite type at $x \in X$} if
there exists an affine open neighbourhood $\text{Spec}(A) = U \subset X$
of $x$ and and an affine open $\text{Spec}(R) = V \subset S$
with $f(U) \subset V$ such that the induced ring map
$R \to A$ is of finite type.
\item We say that $f$ is {\it locally of finite type} if it is
of finite type at every point of $X$.
\item We say that $f$ is of {\it finite type} if it is locally of
finite type and quasi-compact.
\end{enumerate}
\end{definition}

\begin{lemma}
\label{lemma-locally-finite-type-characterize}
Let $f : X \to S$ be a morphism of schemes.
The following are equivalent
\begin{enumerate}
\item The morphism $f$ is locally of finite type.
\item For every affine opens $U \subset X$, $V \subset S$
with $f(U) \subset V$ the ring map
$\mathcal{O}_S(V) \to \mathcal{O}_X(U)$ is of finite type.
\item There exists an open covering $S = \bigcup_{j \in J} V_j$
and open coverings $f^{-1}(V_j) = \bigcup_{i \in I_j} U_i$ such
that each of the morphisms $U_i \to V_j$, $j\in J, i\in I_j$
is locally of finite type.
\item There exists an affine open covering $S = \bigcup_{j \in J} V_j$
and affine open coverings $f^{-1}(V_j) = \bigcup_{i \in I_j} U_i$ such
that the ring map $\mathcal{O}_S(V_j) \to \mathcal{O}_X(U_i)$ is
of finite type, for all $j\in J, i\in I_j$.
\end{enumerate}
Moreover, if $f$ is locally of finite type then for
any open subschemes $U \subset X$, $V \subset S$ with $f(U) \subset V$
the restriction $f|_U : U \to V$ is locally of finite type.
\end{lemma}

\begin{proof}
This follows from Lemma \ref{lemma-locally-P} if we show that
the property ``$R \to A$ is of finite type'' is local.
We check conditions (a), (b) and (c) of Definition
\ref{definition-property-local}.
By Algebra, Lemma \ref{algebra-lemma-compose-finite-type}
being of finite type is stable under base change and hence
we conclude (a) holds. By the same lemma being of finite type
is stable under composition and trivially for any ring
$R$ the ring map $R \to R_f$ is of finite type.
We conclude (b) holds. Finally, property (c) is true
according to Algebra, Lemma \ref{algebra-lemma-cover-upstairs}.
\end{proof}

\begin{lemma}
\label{lemma-composition-finite-type}
The composition of two morphisms which locally of finite type is
locally of finite type. The same is true for morphisms of finite type.
\end{lemma}

\begin{proof}
In the proof of Lemma \ref{lemma-locally-finite-type-characterize}
we saw that being of finite type is a local property of ring maps.
Hence the first statement of the lemma follows from
Lemma \ref{lemma-composition-type-P} combined
with the fact that being of finite type is a property of ring maps that is
stable under composition, see
Algebra, Lemma \ref{algebra-lemma-compose-finite-type}.
By the above and the fact that compositions of
quasi-compact morphisms are quasi-compact, see
Schemes, Lemma \ref{schemes-lemma-composition-quasi-compact}
we see that the composition of morphisms of finite type is
of finite type.
\end{proof}

\begin{lemma}
\label{lemma-base-change-finite-type}
The base change of a morphism which is locally of finite type
is locally of finite type. The same is true for morphisms of
finite type.
\end{lemma}

\begin{proof}
In the proof of Lemma \ref{lemma-locally-finite-type-characterize}
we saw that being of finite type is a local property of ring maps.
Hence the first statement of the lemma follows from
Lemma \ref{lemma-composition-type-P} combined
with the fact that being of finite type is a property of ring maps that is
stable under base change, see
Algebra, Lemma \ref{algebra-lemma-compose-finite-type}.
By the above and the fact that a base change of a
quasi-compact morphism is quasi-compact, see
Schemes, Lemma \ref{schemes-lemma-quasi-compact-preserved-base-change}
we see that the base change of a morphism of finite type is
a morphism of finite type.
\end{proof}

\begin{lemma}
\label{lemma-immersion-locally-finite-type}
A closed immersion is of finite type.
An immersion is locally of finite type.
\end{lemma}

\begin{proof}
This is true because an open immersion is a local isomorphism,
and a closed immersion is obviously of finite type.
\end{proof}

\begin{lemma}
\label{lemma-finite-type-noetherian}
Let $f : X \to S$ be a morphism.
If $S$ is (locally) Noetherian and $f$ (locally) of finite type
then $X$ is (locally) Noetherian.
\end{lemma}

\begin{proof}
This follows immediately from the fact that a ring
of finite type over a Noetherian ring is Noetherian,
see Algebra, Lemma \ref{algebra-lemma-Noetherian-permanence}.
(Also: use the fact that the source of a quasi-compact morphism
with quasi-compact target is quasi-compact.)
\end{proof}

\begin{lemma}
\label{lemma-finite-type-Noetherian-quasi-separated}
Let $f : X \to S$ be locally of finite type with $S$ locally Noetherian.
Then $f$ is quasi-separated.
\end{lemma}

\begin{proof}
In fact, it is true that $X$ is quasi-separated, see
Properties, Lemma \ref{properties-lemma-locally-Noetherian-quasi-separated}
and Lemma \ref{lemma-finite-type-noetherian} above.
Then apply Schemes, Lemma \ref{schemes-lemma-compose-after-separated}
to conclude that $f$ is quasi-separated.
\end{proof}

\begin{lemma}
\label{lemma-permanence-finite-type}
Let $X \to Y$ be a morphism of schemes over a base scheme $S$.
If $X$ is locally of finite type over $S$, then $X \to Y$
is locally of finite type.
\end{lemma}

\begin{proof}
Via Lemma \ref{lemma-locally-finite-type-characterize} this translates
into the following algebra
fact: Given ring maps $A \to B \to C$ such that $A \to C$ is
of finite type, then $B \to C$ is of finite type.
(See Algebra Lemma \ref{algebra-lemma-compose-finite-type}).
\end{proof}







\section{Points of finite type and Jacobson schemes}
\label{section-points-finite-type}

\noindent
Let $S$ be a scheme. A finite type point $s$ of $S$ is a point such
that the morphism $\text{Spec}(\kappa(s)) \to S$ is of finite type.
The reason for studying this is that finite type points can replace
closed points in a certain sense and in certain situations.
There are always enough of them for example. Moreover, a scheme
is Jacobson if and only if all finite type points are closed points.

\begin{lemma}
\label{lemma-point-finite-type}
Let $S$ be a scheme. Let $k$ be a field.
Let $f : \text{Spec}(k) \to S$ be a morphism.
The following are equivalent:
\begin{enumerate}
\item The morphism $f$ is of finite type.
\item The morphism $f$ is locally of finite type.
\item There exists an affine open $U = \text{Spec}(R)$ of $S$
such that $f$ corresponds to a finite ring map $R \to k$.
\item There exists an affine open $U = \text{Spec}(R)$ of $S$
such that the image of $f$ consists of a closed point $u$ in $U$
and the field extension $\kappa(u) \subset k$ is finite.
\end{enumerate}
\end{lemma}

\begin{proof}
The equivalence of (1) and (2) is obvious as $\text{Spec}(k)$
is a singleton and hence any morphism from it is quasi-compact.

\medskip\noindent
Suppose $f$ is locally of finite type. Choose any affine open
$\text{Spec}(R) = U \subset S$ such that the image of $f$
is contained in $U$, and the ring map $R \to k$
is of finite type. Let $\mathfrak p \subset R$ be the kernel.
Then $R/\mathfrak p \subset k$ is of finite type. By
Algebra, Lemma \ref{algebra-lemma-field-finite-type-over-domain}
there exist a $\overline{f} \in R/\mathfrak p$ such that
$(R\mathfrak p)_{\overline{f}}$ is a field and
$(R\mathfrak p)_{\overline{f}} \to k$ is a finite field
extension. If $f \in R$ is a lift of $\overline{f}$, then
we see that $k$ is a finite $R_f$-module. Thus (2) $\Rightarrow$ (3).

\medskip\noindent
Suppose that $\text{Spec}(R) = U \subset S$ is an affine open
such that $f$ corresponds to a finite ring map $R \to k$.
Then $f$ is locally of finite type
by Lemma \ref{lemma-locally-finite-type-characterize}.
Thus (3) $\Rightarrow$ (2).

\medskip\noindent
Suppose $R \to k$ is finite. The image of $R \to k$ is a field
over which $k$ is finite by
Algebra, Lemma \ref{algebra-lemma-integral-under-field}.
Hence the kernel of $R \to k$ is a maximal ideal.
Thus (3) $\Rightarrow$ (4).

\medskip\noindent
The implication (4) $\Rightarrow$ (3) is immediate.
\end{proof}

\begin{lemma}
\label{lemma-artinian-finite-type}
Let $S$ be a scheme.
Let $A$ be an Artinian local ring with residue field $\kappa$.
Let $f : \text{Spec}(A) \to S$ be a morphism of schemes.
Then $f$ is of finite type if and only if the composition
$\text{Spec}(\kappa) \to \text{Spec}(A) \to S$ is of finite type.
\end{lemma}

\begin{proof}
Since the morphism $\text{Spec}(\kappa) \to \text{Spec}(A)$ is of finite
type it is clear that if $f$ is of finite type so is the composition
$\text{Spec}(\kappa) \to S$ (see Lemma \ref{lemma-composition-finite-type}).

\medskip\noindent
Assume that the composition is of finite type. According to
Lemma \ref{lemma-point-finite-type} this means that there exists
an affine open $\text{Spec}(R) = U \subset S$ such that
$\text{Spec}(\kappa) \to S$ ends up in $U$ and the induced ring map
$R \to \kappa$ is finite. Since $A$ is local Artinian we see that
$\text{Spec}(A)$ is a singleton
(Algebra, Lemma \ref{algebra-lemma-artinian-finite-length})
and hence the morphism $f$ also factors
through $U$. This gives a ring map $R \to A$. If we can show that $R \to A$
is finite then we win. We are given that $R \to A/\mathfrak m = \kappa$
is finite and that $(A, \mathfrak m, \kappa)$ is a local Artinian
ring. As $A$ has finite length over itself
(Algebra, Lemma \ref{algebra-lemma-artinian-finite-length})
we can choose a filtration
$$
0 \subset I_1 \subset \ldots \subset I_n = A
$$
by ideals such that $I_i/I_{i - 1} \cong \kappa$ as $A$-modules.
Thus $A$ has a filtration by $R$-submodules $I_i$ such that each
successive quotient is a finite $R$-module. Hence we win.
\end{proof}

\begin{definition}
\label{definition-finite-type-point}
Let $S$ be a scheme.
Let us say that a point $s$ of $S$ is a {\it finite type point}
if the canonical morphism $\text{Spec}(\kappa(s)) \to S$, see
Schemes, Section \ref{schemes-section-points}, is of finite type.
We denote $S_{\text{ft-pts}}$
the set of finite type points of $S$.
\end{definition}

\noindent
We can describe the set of finite type points as follows.

\begin{lemma}
\label{lemma-identify-finite-type-points}
Let $S$ be a scheme. We have
$$
S_{\text{ft-pts}} = \bigcup\nolimits_{U \subset S\text{ open}} U_0
$$
where $U_0$ is the set of closed points of $U$.
Here we may let $U$ range over all opens or over all affine opens of $S$.
\end{lemma}

\begin{proof}
Immediate from Lemma \ref{lemma-point-finite-type}.
\end{proof}

\begin{lemma}
\label{lemma-finite-type-points-morphism}
Let $f : T \to S$ be a morphism of schemes.
If $f$ is locally of finite type, then
$f(T_{\text{ft-pts}}) \subset S_{\text{ft-pts}}$.
\end{lemma}

\begin{proof}
If $T$ is the spectrum of a field this is Lemma \ref{lemma-point-finite-type}.
In general it follows since the composition of morphisms locally of finite
type is locally of finite type (Lemma \ref{lemma-composition-finite-type}).
\end{proof}


\begin{lemma}
\label{lemma-enough-finite-type-points}
Let $S$ be a scheme.
For any locally closed subset $T \subset S$ we have
$$
T \not = \emptyset
\Rightarrow
T \cap S_{\text{ft-pts}} \not = \emptyset.
$$
In particular, for any closed subset $T \subset S$ we
see that $T \cap S_{\text{ft-pts}}$ is dense in $T$.
\end{lemma}

\begin{proof}
Note that $T$ carries a scheme structure (see
Schemes, Lemma \ref{schemes-lemma-reduced-closed-subscheme})
such that $T \to S$ is a locally closed immersion.
Any locally closed immersion is locally of finite type,
see Lemma \ref{lemma-immersion-locally-finite-type}.
Hence by Lemma \ref{lemma-finite-type-points-morphism}
we see $T_{\text{ft-pts}} \subset S_{\text{ft-pts}}$.
Finally, any nonempty affine open of $T$ has at least one closed point
which is a finite type point of $T$ by
Lemma \ref{lemma-identify-finite-type-points}.
\end{proof}

\noindent
It follows that most of the material from
Topology, Section \ref{topology-section-space-jacobson} goes through
with the set of closed points replaced by the set of points of
finite type.
In fact, if $S$ is Jacobson then we recover the closed points as
the finite type points.

\begin{lemma}
\label{lemma-jacobson-finite-type-points}
Let $S$ be a scheme.
The following are equivalent:
\begin{enumerate}
\item For every finite type morphism $f : \text{Spec}(k) \to S$
with $k$ a field the image consists of a closed point of $S$.
In the terminology introduced above: finite type points of $S$ are
closed points of $S$.
\item For every locally finite type morphism $T \to S$ closed points map
to closed points.
\item For every locally finite type morphism $f : T \to S$ any closed point
$t \in T$ maps to a closed point $s \in S$ and $\kappa(s) \subset \kappa(t)$
is finite.
\item The scheme $S$ is Jacobson.
\end{enumerate}
\end{lemma}

\begin{proof}
We have trivially (3) $\Rightarrow$ (2) $\Rightarrow$ (1).
The discussion above shows that (1) implies (4).
Hence it suffices to show that (4) implies (3).
Suppose that $T \to S$ is locally of finite type.
Choose $t \in T$ with $s = f(t)$ as in (3).
Choose affine open neighbourhoods $\text{Spec}(R) = U \subset S$ of $s$ and
$\text{Spec}(A) = V \subset T$ of $t$ with $f(V) \subset U$.
The induced ring map $R \to A$ is of finite type
(see Lemma \ref{lemma-locally-finite-type-characterize}) and $R$ is Jacobson
by Properties, Lemma \ref{properties-lemma-locally-jacobson}.
Thus the result follows from
Algebra, Proposition \ref{algebra-proposition-Jacobson-permanence}.
\end{proof}

\begin{lemma}
\label{lemma-Jacobson-universally-Jacobson}
Let $S$ be a Jacobson scheme.
Any scheme locally of finite type over $S$ is Jacobson.
\end{lemma}

\begin{proof}
This is clear from
Algebra, Proposition \ref{algebra-proposition-Jacobson-permanence}
(and Properties, Lemma \ref{properties-lemma-locally-jacobson} and
Lemma \ref{lemma-locally-finite-type-characterize}).
\end{proof}

\begin{lemma}
\label{lemma-ubiquity-Jacobson-schemes}
The following types of schemes are Jacobson.
\begin{enumerate}
\item Any scheme locally of finite type over a field.
\item Any scheme locally of finite type over $\mathbf{Z}$.
\item Any scheme locally of finite type over a $1$-dimensional
Noetherian domain with infinitely many primes.
\item A scheme of the form $\text{Spec}(R) \setminus \{\mathfrak m\}$
where $(R, \mathfrak m)$ is a Noetherian local ring.
Also any scheme locally of finite type over it.
\end{enumerate}
\end{lemma}

\begin{proof}
We will use Lemma \ref{lemma-Jacobson-universally-Jacobson} without mention.
The spectrum of a field is clearly Jacobson.
The spectrum of $\mathbf{Z}$ is Jacobson, see
Algebra, Lemma \ref{algebra-lemma-pid-jacobson}.
For (3) see
Algebra, Lemma \ref{algebra-lemma-noetherian-dim-1-Jacobson}.
For (4) see
Properties, Lemma \ref{properties-lemma-complement-closed-point-Jacobson}.
\end{proof}







\section{Universally catenary schemes}
\label{section-universally-catenary}

\noindent
Recall that a topological space $X$ is called {\it catenary} if
for every pair of irreducible closed subsets $T \subset T'$
there exist a maximal chain of irreducible closed subsets
$$
T = T_0 \subset T_1 \subset \ldots \subset T_e = T'
$$
and every such chain has the same length. See
Topology, Definition \ref{topology-definition-catenary}.
Recall that a scheme is catenary if its underlying topological space
is catenary. See Properties, Definition \ref{properties-definition-catenary}.

\begin{definition}
\label{definition-universally-catenary}
Let $S$ be a scheme. Assume $S$ is locally Noetherian.
We say $S$ is {\it universally catenary} if for every
morphism $X \to S$ locally of finite type the scheme $X$ is catenary.
\end{definition}

\noindent
This is a ``better'' notion than catenary as there exist Noetherian schemes
which are catenary but not universally catenary. See
Examples, Section \ref{examples-section-non-catenary-Noetherian-local}.
Many schemes are universally catenary, see
Lemma \ref{lemma-ubiquity-uc} below.

\medskip\noindent
Recall that a ring $A$ is called {\it catenary} if
for any pair of prime ideals $\mathfrak p \subset \mathfrak q$
there exists a maximal chain of primes
$$
\mathfrak p =
\mathfrak p_0 \subset \ldots \subset \mathfrak p_e
= \mathfrak q
$$
and all of these have the same length. See
Algebra, Definition \ref{algebra-definition-catenary}.
We have seen the relationship between catenary schemes and
catenary rings in Properties, Section \ref{properties-section-catenary}.
Recall that a ring $A$ is called {\it universally catenary} if
$A$ is Noetherian and for every finite type ring map $A \to B$
the ring $B$ is catenary. See
Algebra, Definition \ref{algebra-definition-universally-catenary}.
Many interesting rings which come up
in algebraic geometry satisfy this property.

\begin{lemma}
\label{lemma-universally-catenary-local}
Let $S$ be a locally Noetherian scheme. The following are equivalent
\begin{enumerate}
\item $S$ is universally catenary,
\item there exists an open covering of $S$ all of whose members are
universally catenary schemes,
\item for every affine open $\text{Spec}(R) = U \subset S$ the ring
$R$ is universally catenary, and
\item there exists an affine open covering $S = \bigcup U_i$ such
that each $U_i$ is the spectrum of a universally catenary ring.
\end{enumerate}
Moreover, in this case any scheme locally of finite type over $S$
is universally catenary as well.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-immersion-locally-finite-type} an open immersion
is locally of finite type. A composition of morphisms locally of
finite type is locally of finite type
(Lemma \ref{lemma-composition-finite-type}). Thus it is clear that if $S$ is
universally catenary then any open and any scheme locally of finite
type over $S$ is universally catenary as well. This proves the final
statement of the lemma and that (1) implies (2).

\medskip\noindent
If $\text{Spec}(R)$ is a universally catenary scheme, then every
scheme $\text{Spec}(A)$ with $A$ a finite type $R$-algebra is
catenary. Hence all these rings $A$ are catenary by
Algebra, Lemma \ref{algebra-lemma-catenary}.
Thus $R$ is universally catenary. Combined with the remarks above we
conclude that (1) implies (3), and (2) implies (4). Of course
(3) implies (4) trivially.

\medskip\noindent
To finish the proof we show that (4) implies (1).
Assume (4) and let $X \to S$ be a morphism locally of finite type.
We can find an affine open covering $X = \bigcup V_j$ such that
each $V_j \to S$ maps into one of the $U_i$. By
Lemma \ref{lemma-locally-finite-type-characterize}
the induced ring map $\mathcal{O}(U_i) \to \mathcal{O}(V_j)$ is
of finite type. Hence $\mathcal{O}(V_j)$ is catenary. Hence
$X$ is catenary by Properties, Lemma \ref{properties-lemma-catenary-local}.
\end{proof}

\begin{lemma}
\label{lemma-universally-catenary-local-rings-universally-catenary}
Let $S$ be a locally Noetherian scheme.
The following are equivalent:
\begin{enumerate}
\item $S$ is universally catenary, and
\item all local rings $\mathcal{O}_{S, s}$ of $S$ are universally catenary.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume that all local rings of $S$ are universally catenary.
Let $f : X \to S$ be locally of finite type.
We know that $X$ is catenary if and only if $\mathcal{O}_{X, x}$ is
catenary for all $x \in X$. If $f(x) = s$, then $\mathcal{O}_{X, x}$
is essentially of finite type over $\mathcal{O}_{S, s}$. Hence
$\mathcal{O}_{X, x}$ is catenary by the assumption that
$\mathcal{O}_{S, s}$ is universally catenary.

\medskip\noindent
Conversly, assume that $S$ is universally catenary. Let $s \in S$.
We may replace $S$ by an affine open neighbourhood of $s$ by
Lemma \ref{lemma-universally-catenary-local}. Say $S = \text{Spec}(R)$
and $s$ corresponds to the prime ideal $\mathfrak p$. Any finite
type $R_{\mathfrak p}$-algebra $A'$ is of the form
$A_{\mathfrak p}$ for some finite type $R$-algebra $A$.
By assumption (and Lemma \ref{lemma-universally-catenary-local} if you like)
the ring $A$ is catenary, and hence $A'$ (a localization of $A$) is
catenary. Thus $R_{\mathfrak p}$ is universally catenary.
\end{proof}

\begin{lemma}
\label{lemma-ubiquity-uc}
The following types of schemes are universally catenary.
\begin{enumerate}
\item Any scheme locally of finite type over a field.
\item Any scheme locally of finite type over a Cohen-Macaulay scheme.
\item Any scheme locally of finite type over $\mathbf{Z}$.
\item Any scheme locally of finite type over a $1$-dimensional
Noetherian domain.
\item And so on.
\end{enumerate}
\end{lemma}

\begin{proof}
All of these follow from the fact that a
Cohen-Macaulay ring is universally catenary, see
Algebra, Lemma \ref{algebra-lemma-CM-ring-catenary}.
Also, use the last assertion of
Lemma \ref{lemma-universally-catenary-local}.
Some details omitted.
\end{proof}























\section{Nagata schemes, reprise}
\label{section-nagata}

\noindent
See Properties, Section \ref{properties-section-nagata} for the definitions
and basic properties of Nagata and universally Japanese schemes.

\begin{lemma}
\label{lemma-finite-type-nagata}
Let $f : X \to S$ be a morphism.
If $S$ is Nagata and $f$ locally of finite type then $X$ is Nagata.
If $S$ is universally Japanese
and $f$ locally of finite type then $X$ is universally Japanese.
\end{lemma}

\begin{proof}
For ``universally Japanese'' this follows from
Algebra, Lemma \ref{algebra-lemma-universally-japanese}.
For ``Nagata'' this follows from
Algebra, Proposition \ref{algebra-proposition-nagata-universally-japanese}.
\end{proof}

\begin{lemma}
\label{lemma-ubiquity-nagata}
The following types of schemes are Nagata.
\begin{enumerate}
\item Any scheme locally of finite type over a field.
\item Any scheme locally of finite type over a Noetherian complete local ring.
\item Any scheme locally of finite type over $\mathbf{Z}$.
\item Any scheme locally of finite type over a Dedeking ring of
characteristic zero.
\item And so on.
\end{enumerate}
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-finite-type-nagata} we only need to show that
the rings mentioned above are Nagata rings. For this see
Algebra, Proposition \ref{algebra-proposition-ubiquity-nagata}.
\end{proof}




\section{Quasi-finite morphisms}
\label{section-quasi-finite}

\noindent
A solid treatment of quasi-finite morphisms is the basis of many developments
further down the road. It will lead to various versions of Zariski's Main
Theorem, behaviour of dimensions of fibres, descend for etale morphisms, etc,
etc. Before reading this section it may be a good idea to take a look at
the algebra results in Algebra, Section \ref{algebra-section-quasi-finite}.

\medskip\noindent
Recall that a finite type ring map $R \to A$ is quasi-finite at
a prime $\mathfrak q$ if $\mathfrak q$ defines an isolated point
of its fibre, see Algebra, Definition \ref{algebra-definition-quasi-finite}.

\begin{definition}
\label{definition-quasi-finite}
Let $f : X \to S$ be a morphism of schemes.
\begin{enumerate}
\item We say that $f$ is {\it quasi-finite at a point $x \in X$}
if there exist an affine neighbourhood $\text{Spec}(A) = U \subset X$
of $x$ and an affine open $\text{Spec}(R) = V \subset S$ such that
$f(U) \subset V$, the ring map $R \to A$ is of finite type,
and $R \to A$ is quasi-finite at the prime of $A$ corresponding to $x$
(see above).
\item We say $f$ is {\it locally quasi-finite} if $f$ is
quasi-finite at every point $x$ of $X$.
\item We say that $f$ is {\it quasi-finite} if $f$ is of finite type
and every point $x$ is an isolated point of its fibre.
\end{enumerate}
\end{definition}

\noindent
Trivially, a locally quasi-finite morphism is locally of finite type.
We will see below that a morphism $f$ which is locally of finite type
is quasi-finite at $x$ if and only if $x$ is isolated in its fibre.
Moreover, the set of points at which a morphism is quasi-finite is open;
we will see this in Section \ref{section-Zariski} on Zariski's Main Theorem

\begin{lemma}
\label{lemma-algebraic-residue-field-extension-closed-point-fibre}
Let $f : X \to S$ be a morphism of schemes.
Let $x \in X$ be a point. Set $s = f(x)$.
If $\kappa(s) \supset \kappa(x)$
is an algebraic field extension, then
\begin{enumerate}
\item $x$ is a closed point of its fibre, and
\item if in addition $s$ is a closed point of $S$, then
$x$ is a closed point of $X$.
\end{enumerate}
\end{lemma}

\begin{proof}
The second statement follows from the first by elementary topology.
According to Schemes, Lemma \ref{schemes-lemma-fibre-topological}
to prove the first statement
we may replace $X$ by $X_s$ and $S$ by $\text{Spec}(\kappa(s))$.
Thus we may assume that $S = \text{Spec}(k)$ is the spectrum of a field.
In this case, let $\text{Spec}(A) = U \subset X$ be any affine open
containing $x$. The point $x$ corresponds to a prime ideal
$\mathfrak q \subset A$ such that $k \subset \kappa(\mathfrak q)$
is an algebraic field extension. By
Algebra, Lemma \ref{algebra-lemma-finite-residue-extension-closed}
we see that $\mathfrak q$ is a maximal ideal, i.e., $x \in U$ is a
closed point. Since the affine opens form
a basis of the topology of $X$ we conclude that $\{x\}$ is closed.
\end{proof}

\noindent
The following lemma is a version of the Hilbert Nullstellensatz.

\begin{lemma}
\label{lemma-closed-point-fibre-locally-finite-type}
Let $f : X \to S$ be a morphism of schemes.
Let $x \in X$ be a point. Set $s = f(x)$.
Assume $f$ is locally of finite type.
Then $x$ is a closed point of its fibre
if and only if $\kappa(s) \subset \kappa(x)$ is
a finite field extension.
\end{lemma}

\begin{proof}
If the extension is finite, then $x$ is a closed point of
the fibre by
Lemma \ref{lemma-algebraic-residue-field-extension-closed-point-fibre}
above. For the converse, assume that $x$ is a closed point
of its fibre. Choose affine opens $\text{Spec}(A) = U \subset X$
and $\text{Spec}(R) = V \subset S$ such that $f(U) \subset V$.
By Lemma \ref{lemma-locally-finite-type-characterize} the ring map
$R \to A$ is of finite type. Let $\mathfrak q \subset A$,
resp.\ $\mathfrak p \subset R$ be the prime ideal corresponding
to $x$, resp.\ $s$. Consider the fibre ring
$\overline{A} = A \otimes_R \kappa(\mathfrak p)$.
Let $\overline{\mathfrak q}$ be the prime of $\overline{A}$
corresponding to $\mathfrak q$. The assumption that $x$
is a closed point of its fibre implies that $\overline{\mathfrak q}$
is a maximal ideal of $\overline{A}$. Since $\overline{A}$
is an algebra of finite type over the field $\kappa(\mathfrak p)$
we see by the Hilbert Nullstellensatz, see
Algebra, Theorem \ref{algebra-theorem-nullstellensatz},
that $\kappa(\overline{\mathfrak q})$ is a finite extension
of $\kappa(\mathfrak p)$.
Since $\kappa(s) = \kappa(\mathfrak p)$ and
$\kappa(x) = \kappa(\mathfrak q) = \kappa(\overline{\mathfrak q})$
we win.
\end{proof}

\begin{lemma}
\label{lemma-base-change-closed-point-fibre-locally-finite-type}
Let $f : X \to S$ be a morphism of schemes which is locally of finite type.
Let $g : S' \to S$ be any morphism. Denote $f' : X' \to S'$ the base change.
If $x' \in X'$ maps to a point $x \in X$ which is closed in $X_{f(s)}$
then $x'$ is closed in $X'_{f'(x')}$.
\end{lemma}

\begin{proof}
The residue field $\kappa(x')$ is a quotient of
$\kappa(f'(x')) \otimes_{\kappa(f(x))} \kappa(x)$, see
Schemes, Lemma \ref{schemes-lemma-points-fibre-product}.
Hence it is a finite extension of $\kappa(f'(x'))$ as
$\kappa(x)$ is a finite extension of $\kappa(f(x))$ by
Lemma \ref{lemma-closed-point-fibre-locally-finite-type}.
Thus we see that $x'$ is closed in its fibre by applying that lemma
one more time.
\end{proof}

\begin{lemma}
\label{lemma-residue-field-quasi-finite}
Let $f : X \to S$ be a morphism of schemes.
Let $x \in X$ be a point. Set $s = f(x)$.
If $f$ is quasi-finite at $x$, then the residue field
extension $\kappa(s) \subset \kappa(x)$ is finite.
\end{lemma}

\begin{proof}
This is clear from Algebra, Definition \ref{algebra-definition-quasi-finite}.
\end{proof}

\begin{lemma}
\label{lemma-quasi-finite-at-point-characterize}
Let $f : X \to S$ be a morphism of schemes.
Let $x \in X$ be a point. Set $s = f(x)$.
Let $X_s$ be the fibre of $f$ at $s$.
Assume $f$ is locally of finite type.
The following are equivalent:
\begin{enumerate}
\item The morphism $f$ is quasi-finite at $x$.
\item The point $x$ is isolated in $X_s$.
\item The point $x$ is closed in $X_s$
and there is no point $x' \in X_s$, $x' \not = x$
which specializes to $x$.
\item For any pair of affine opens
$\text{Spec}(A) = U \subset X$, $\text{Spec}(R) = V \subset S$ with
$f(U) \subset V$ and $x \in U$ corresponding to $\mathfrak q \subset A$
the ring map $R \to A$ is quasi-finite at $\mathfrak q$.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume $f$ is quasi-finite at $x$.
Note that $x$ defines a closed point of $X_s$ as follows by combining
Lemmas \ref{lemma-algebraic-residue-field-extension-closed-point-fibre} and
\ref{lemma-residue-field-quasi-finite}.
By assumption there exist opens $U \subset X$, $V \subset S$ such
that $f(U) \subset V$, $x \in U$ and $x$ an isolated point
of $U_s$. Hence $\{x\} \subset U_s$ is an open subset.
Since $U_s = U \cap X_s \subset X_s$ is also open we conclude
that $\{x\} \subset X_s$ is an open subset also. Thus we conclude
that $x$ is an isolated point of $X_s$.

\medskip\noindent
If $x$ is isolated in $X_s$, then we see immediately that
$x$ is closed in $X_s$ and that there is no point $x' \in X_s$,
distinct from $x$, specializing to $x$.

\medskip\noindent
Assume that $x$ is closed in $X_s$ and that there is no point $x' \in X_s$,
distinct from $x$, specializing to $x$. Consider a pair of affine opens
$\text{Spec}(A) = U \subset X$, $\text{Spec}(R) = V \subset S$ with
$f(U) \subset V$ and $x \in U$. Let $\mathfrak q \subset A$ correspond to
$x$ and $\mathfrak p \subset R$ correspond to $s$.
By Lemma \ref{lemma-locally-finite-type-characterize} the ring map
$R \to A$ is of finite type. Consider the fibre ring
$\overline{A} = A \otimes_R \kappa(\mathfrak p)$.
Let $\overline{\mathfrak q}$ be the prime of $\overline{A}$ corresponding
to $\mathfrak q$. Since $\text{Spec}(\overline{A})$ is an open subscheme of
the fibre $X_s$ we see that $\overline{q}$ is a maximal ideal
of $\overline{A}$ and that there is no point of $\text{Spec}(\overline{A})$
specializing to $\overline{\mathfrak q}$.
This implies that $\dim(\overline{A}_{\overline{q}}) = 0$.
Hence by
Algebra, Lemma \ref{algebra-lemma-dimension-closed-point-finite-type-field}
we have $\dim_{\overline{\mathfrak q}}(\overline{A}) = 0$.
Hence by Algebra, Lemma \ref{algebra-lemma-isolated-point}
we see that $\mathfrak q$ defines an isolated point of
$\text{Spec}(\overline{A})$. Thus $X \to S$ is quasi-finite at
$x$ by definition.

\medskip\noindent
At this point we have shown conditions (1) -- (3) are all equivalent.
It is clear that (4) implies (1). And it is also clear that
(2) implies (4) since if $x$ is an isolated point of $X_s$
then it is also an isolated point of $U_s$ for any open $U$
which contains it.
\end{proof}

\begin{lemma}
\label{lemma-finite-fibre}
Let $f : X \to S$ be a morphism of schemes.
Let $s \in S$. Assume that
\begin{enumerate}
\item $f$ is locally of finite type, and
\item $f^{-1}(\{s\})$ is a finite set.
\end{enumerate}
Then $X_s$ is a finite discrete topological space, and
$f$ is quasi-finite at each point of $X$ lying over $s$.
\end{lemma}

\begin{proof}
Suppose $T$ is a scheme which (a) is locally of finite type
over a field $k$, and (b) has finitely many points. Then every
point of $T$ is isolated. Namely, by
Lemma \ref{lemma-ubiquity-Jacobson-schemes} the scheme $T$ is a
Jacobson scheme. Hence no point of $T$ is open. Since $T$ is
finite this has to mean every point is closed. Apply this remark
to the fibre $X_s$ which is locally of finite type over
$\text{Spec}(\kappa(s))$, to see the first statement. Finally, apply
Lemma \ref{lemma-quasi-finite-at-point-characterize} to see the second.
\end{proof}


\begin{lemma}
\label{lemma-quasi-finite-locally-quasi-compact}
Let $f : X \to S$ be a morphism of schemes.
Then $f$ is quasi-finite if and only if $f$ is
locally quasi-finite and quasi-compact.
\end{lemma}

\begin{proof}
Assume $f$ is quasi-finite. It is quasi-compact by Definition
\ref{definition-finite-type}. Let $x \in X$.
We see that $f$ is quasi-finite at $x$ by
Lemma \ref{lemma-quasi-finite-at-point-characterize}.
Hence $f$ is quasi-compact and locally quasi-finite.

\medskip\noindent
Assume $f$ is quasi-compact and locally quasi-finite.
Then $f$ is of finite type. Let $x \in X$ be a point.
By Lemma \ref{lemma-quasi-finite-at-point-characterize}
we see that $x$ is an isolated point of its fibre.
The lemma is proved.
\end{proof}

\begin{lemma}
\label{lemma-quasi-finite}
Let $f : X \to S$ be a morphism of schemes.
The following are equivalent:
\begin{enumerate}
\item $f$ is quasi-finite, and
\item $f$ is locally of finite type, quasi-compact, and has finite fibres.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume $f$ is quasi-finite. In particular $f$ is locally of finite type
and quasi-compact (since it is of finite type). Let $s \in S$. Since
every $x \in X_s$ is isolated in $X_s$ we see that
$X_s = \bigcup_{x \in X_s} \{x\}$ is an open covering. As $f$
is quasi-compact, the fibre $X_s$ is quasi-compact. Hence we see
that $X_s$ is finite.

\medskip\noindent
Conversely, assume $f$ is locally of finite type, quasi-compact
and has finite fibres. Then it is locally quasi-finite by
Lemma \ref{lemma-finite-fibre}. Hence it is quasi-finite by
Lemma \ref{lemma-quasi-finite-locally-quasi-compact}.
\end{proof}

\noindent
Recall that a ring map $R \to A$ is quasi-finite if it is
of finite type and quasi-finite at {\it all} primes of $A$, see
Algebra, Definition \ref{algebra-definition-quasi-finite}.

\begin{lemma}
\label{lemma-locally-quasi-finite-characterize}
Let $f : X \to S$ be a morphism of schemes.
The following are equivalent
\begin{enumerate}
\item The morphism $f$ is locally quasi-finite.
\item For every pair of affine opens $U \subset X$, $V \subset S$
with $f(U) \subset V$ the ring map
$\mathcal{O}_S(V) \to \mathcal{O}_X(U)$ is quasi-finite.
\item There exists an open covering $S = \bigcup_{j \in J} V_j$
and open coverings $f^{-1}(V_j) = \bigcup_{i \in I_j} U_i$ such
that each of the morphisms $U_i \to V_j$, $j\in J, i\in I_j$
is locally quasi-finite.
\item There exists an affine open covering $S = \bigcup_{j \in J} V_j$
and affine open coverings $f^{-1}(V_j) = \bigcup_{i \in I_j} U_i$ such
that the ring map $\mathcal{O}_S(V_j) \to \mathcal{O}_X(U_i)$ is
quasi-finite, for all $j\in J, i\in I_j$.
\end{enumerate}
Moreover, if $f$ is locally quasi-finite then for
any open subschemes $U \subset X$, $V \subset S$ with $f(U) \subset V$
the restriction $f|_U : U \to V$ is locally quasi-finite.
\end{lemma}

\begin{proof}
For a ring map $R \to A$ let us define
$P(R \to A)$ to mean ``$R \to A$ is quasi-finite''
(see remark above lemma).
We claim that $P$ is a local property of ring maps.
We check conditions (a), (b) and (c) of Definition
\ref{definition-property-local}. In the proof of
Lemma \ref{lemma-locally-finite-type-characterize}
we have seen that (a), (b) and (c) hold for the property
of being ``of finite type''. Note that, for a finite type ring map
$R \to A$, the property $R \to A$ is quasi-finite at $\mathfrak q$
depends only on the local ring $A_{\mathfrak q}$ as an
algebra over $R_{\mathfrak p}$ where $\mathfrak p = R \cap \mathfrak q$
(usual abuse of notation). Using these remarks (a), (b) and (c) of
Definition \ref{definition-property-local} follow immediately.
For example, suppose $R \to A$ is a ring map
such that all of the ring maps $R \to A_{a_i}$ are quasi-finite
for $a_1, \ldots, a_n \in A$ generating the unit ideal.
We conclude that $R \to A$ is of finite type. Also, for any
prime $\mathfrak q \subset A$ the local ring $A_{\mathfrak q}$
is isomorphic as an $R$-algebra to the local ring
$(A_{a_i})_{\mathfrak q_i}$ for some $i$ and some
$\mathfrak q_i \subset A_{a_i}$. Hence we conclude that
$R \to A$ is quasi-finite at $\mathfrak q$.

\medskip\noindent
We conclude that Lemma \ref{lemma-locally-P} applies with $P$
as in the previous paragraph.
Hence it suffices to prove that $f$ is locally quasi-finite is
equivalent to $f$ is locally of type $P$. Since $P(R \to A)$
is ``$R \to A$ is quasi-finite'' which means $R \to A$ is
quasi-finite at every prime of $A$, this follows from
Lemma \ref{lemma-quasi-finite-at-point-characterize}.
\end{proof}

\begin{lemma}
\label{lemma-composition-quasi-finite}
The composition of two morphisms which are locally quasi-finite is
locally quasi-finite. The same is true for quasi-finite morphisms.
\end{lemma}

\begin{proof}
In the proof of Lemma \ref{lemma-locally-quasi-finite-characterize}
we saw that $P = $``quasi-finite'' is a local property of ring maps,
and that a morphism of schemes is locally quasi-finite if and only if
it is locally of type $P$ as in Definition \ref{definition-locally-P}.
Hence the first statement of the lemma follows from
Lemma \ref{lemma-composition-type-P} combined
with the fact that being quasi-finite is a property of ring maps that is
stable under composition, see
Algebra, Lemma \ref{algebra-lemma-quasi-finite-composition}.
By the above, Lemma \ref{lemma-quasi-finite-locally-quasi-compact}
and the fact that compositions of
quasi-compact morphisms are quasi-compact, see
Schemes, Lemma \ref{schemes-lemma-composition-quasi-compact}
we see that the composition of quasi-finite morphisms is
quasi-finite.
\end{proof}

\begin{lemma}
\label{lemma-base-change-quasi-finite}
Let $f : X \to S$ be a morphism of schemes.
Let $g : S' \to S$ be a morphism of schemes.
Denote $f' : X_{S'} \to S'$ the base change of $f$ by $g$
and denote $g' : X_{S'} \to X$ the projection.
Assume $X$ is locally of finite type over $S$.
\begin{enumerate}
\item Let $U \subset X$ (resp.\ $U' \subset X'$)
be the set of points where $f$ (resp.\ $f'$) is quasi-finite.
Then $U' = U_{S'} = (g')^{-1}(U)$.
\item The base change of a morphism which is locally quasi-finite
is locally quasi-finite.
\item The base change of a quasi-finite morphism is
quasi-finite.
\end{enumerate}
\end{lemma}

\begin{proof}
The first and second assertion follow from the corresponding
algebra result, see
Algebra, Lemma \ref{algebra-lemma-quasi-finite-base-change}
(combined with the fact that $f'$ is also locally of finite type by
Lemma \ref{lemma-base-change-finite-type}).
By the above, Lemma \ref{lemma-quasi-finite-locally-quasi-compact}
and the fact that a base change of a
quasi-compact morphism is quasi-compact, see
Schemes, Lemma \ref{schemes-lemma-quasi-compact-preserved-base-change}
we see that the base change of a quasi-finite morphism
is quasi-finite.
\end{proof}

\begin{lemma}
\label{lemma-immersion-locally-quasi-finite}
Any immersion is locally quasi-finite.
\end{lemma}

\begin{proof}
This is true because an open immersion is a local isomorphism
and a closed immersion is clearly quasi-finite.
\end{proof}

\begin{lemma}
\label{lemma-permanence-quasi-finite}
Let $X \to Y$ be a morphism of schemes over a base scheme $S$.
Let $x \in X$. If $X \to S$ is quasi-finite at $x$, then
$X \to Y$ is quasi-finite at $x$.
If $X$ is locally quasi-finite over $S$, then $X \to Y$
is locally quasi-finite.
\end{lemma}

\begin{proof}
Via Lemma \ref{lemma-locally-quasi-finite-characterize} this translates
into the following algebra
fact: Given ring maps $A \to B \to C$ such that $A \to C$ is
quasi-finite, then $B \to C$ is quasi-finite.
This follows from Algebra Lemma \ref{algebra-lemma-four-rings}
with $R = A$, $S = S' = C$ and $R' = B$.
\end{proof}















\section{Morphisms of finite presentation}
\label{section-finite-presentation}

\noindent
Recall that a ring map $R \to A$ is of finite presentation if
$A$ is isomorphic to $R[x_1, \ldots, x_n]/(f_1, \ldots, f_m)$ as
an $R$-algebra for some $n, m$ and some polynomials $f_j$.

\begin{definition}
\label{definition-finite-presentation}
Let $f : X \to S$ be a morphism of schemes.
\begin{enumerate}
\item We say that $f$ is of {\it finite presentation at $x \in X$} if
there exists a affine open neighbourhood $\text{Spec}(A) = U \subset X$
of $x$ and and affine open $\text{Spec}(R) = V \subset S$
with $f(U) \subset V$ such that the induced ring map
$R \to A$ is of finite presentation.
\item We say that $f$ is {\it locally of finite presentation} if it is
of finite presentation at every point of $X$.
\item We say that $f$ is of {\it finite presentation} if it is locally of
finite presentation, quasi-compact and quasi-separated.
\end{enumerate}
\end{definition}

\noindent
Note that a morphism of finite presentation is {\bf not} just a quasi-compact
morphism which is locally of finite presentation.
Later we will characterize morphisms which are
locally of finite presentation as those morphisms such that
$$
\text{colim}\ \text{Mor}_S(T_i, X) = \text{Mor}_S(\text{lim}\ T_i, X)
$$
for any directed system of affine schemes $T_i$ over $S$. See
Limits,
Proposition \ref{limits-proposition-characterize-locally-finite-presentation}.
In Limits, Section \ref{limits-section-descending-relative} we show
that, if $S = \text{lim}_i\ S_i$ is a limit of affine schemes,
any scheme $X$ of finite presentation over $S$ descends to a scheme
$X_i$ over $S_i$ for some $i$.

\begin{lemma}
\label{lemma-locally-finite-presentation-characterize}
Let $f : X \to S$ be a morphism of schemes.
The following are equivalent
\begin{enumerate}
\item The morphism $f$ is locally of finite presentation.
\item For every affine opens $U \subset X$, $V \subset S$
with $f(U) \subset V$ the ring map
$\mathcal{O}_S(V) \to \mathcal{O}_X(U)$ is of finite presentation.
\item There exists an open covering $S = \bigcup_{j \in J} V_j$
and open coverings $f^{-1}(V_j) = \bigcup_{i \in I_j} U_i$ such
that each of the morphisms $U_i \to V_j$, $j\in J, i\in I_j$
is locally of finite presentation.
\item There exists an affine open covering $S = \bigcup_{j \in J} V_j$
and affine open coverings $f^{-1}(V_j) = \bigcup_{i \in I_j} U_i$ such
that the ring map $\mathcal{O}_S(V_j) \to \mathcal{O}_X(U_i)$ is
of finite presentation, for all $j\in J, i\in I_j$.
\end{enumerate}
Moreover, if $f$ is locally of finite presentation then for
any open subschemes $U \subset X$, $V \subset S$ with $f(U) \subset V$
the restriction $f|_U : U \to V$ is locally of finite presentation.
\end{lemma}

\begin{proof}
This follows from Lemma \ref{lemma-locally-P} if we show that
the property ``$R \to A$ is of finite presentation'' is local.
We check conditions (a), (b) and (c) of Definition
\ref{definition-property-local}.
By Algebra, Lemma \ref{algebra-lemma-compose-finite-type}
being of finite presentation is stable under base change and hence
we conclude (a) holds. By the same lemma being of finite presentation
is stable under composition and trivially for any ring
$R$ the ring map $R \to R_f$ is of finite presentation.
We conclude (b) holds. Finally, property (c) is true
according to Algebra, Lemma \ref{algebra-lemma-cover-upstairs}.
\end{proof}

\begin{lemma}
\label{lemma-composition-finite-presentation}
The composition of two morphisms which locally of finite presentation is
locally of finite presentation.
The same is true for morphisms of finite presentation.
\end{lemma}

\begin{proof}
In the proof of Lemma \ref{lemma-locally-finite-presentation-characterize}
we saw that being of finite presentation is a local property of ring maps.
Hence the first statement of the lemma follows from
Lemma \ref{lemma-composition-type-P} combined
with the fact that being of finite presentation
is a property of ring maps that is
stable under composition, see
Algebra, Lemma \ref{algebra-lemma-compose-finite-type}.
By the above and the fact that compositions of
quasi-compact, quasi-separated morphisms are
quasi-compact and quasi-separated, see
Schemes, Lemmas \ref{schemes-lemma-composition-quasi-compact}
and \ref{schemes-lemma-separated-permanence}
we see that the composition of morphisms of finite presentation is
of finite presentation.
\end{proof}

\begin{lemma}
\label{lemma-base-change-finite-presentation}
The base change of a morphism which is locally of finite presentation
is locally of finite presentation. The same is true for morphisms of
finite presentation.
\end{lemma}

\begin{proof}
In the proof of Lemma \ref{lemma-locally-finite-presentation-characterize}
we saw that being of finite presentation is a local property of ring maps.
Hence the first statement of the lemma follows from
Lemma \ref{lemma-composition-type-P} combined
with the fact that being of finite presentation
is a property of ring maps that is
stable under base change, see
Algebra, Lemma \ref{algebra-lemma-compose-finite-type}.
By the above and the fact that a base change of a
quasi-compact, quasi-separated morphism is quasi-compact
and quasi-separated, see
Schemes, Lemmas \ref{schemes-lemma-quasi-compact-preserved-base-change}
and \ref{schemes-lemma-separated-permanence}
we see that the base change of a morphism of finite presentation is
a morphism of finite presentation.
\end{proof}

\begin{lemma}
\label{lemma-open-immersion-locally-finite-presentation}
Any open immersion is locally of finite presentation.
\end{lemma}

\begin{proof}
This is true because an open immersion is a local isomorphism.
\end{proof}

\begin{lemma}
\label{lemma-quasi-compact-open-immersion-finite-presentation}
Any open immersion is of finite presentation if and only if
it is quasi-compact.
\end{lemma}

\begin{proof}
We have seen (Lemma \ref{lemma-open-immersion-locally-finite-presentation})
that an open immersion is locally of finite presentation.
We have see (Schemes, Lemma \ref{schemes-lemma-immersions-monomorphisms})
that an immersion is separated and hence quasi-separated. From this
and Definition \ref{definition-finite-presentation} the lemma follows.
\end{proof}

\begin{lemma}
\label{lemma-closed-immersion-finite-presentation}
Any closed immersion $i : Z \to X$ is of finite presentation if and only if
the associated quasi-coherent sheaf of ideals
$\mathcal{I} = \text{Ker}(\mathcal{O}_X \to i_*\mathcal{O}_Z)$
is of finite type (as an $\mathcal{O}_X$-module).
\end{lemma}

\begin{proof}
On any affine open $\text{Spec}(R) \subset X$ we have
$i^{-1}(\text{Spec}(R)) = \text{Spec}(R/I)$ and
$\mathcal{I} = \widetilde{I}$. Moreover, $\mathcal{I}$
is of finite type if and only if $I$ is a finite $R$-module
for every such affine open (see
Properties, Lemma \ref{properties-lemma-finite-type-module}).
And $R/I$ is of finite presentation
over $R$ if and only if $I$ is a finite $R$-module. Hence we win.
\end{proof}

\begin{lemma}
\label{lemma-finite-presentation-finite-type}
A morphism which is locally of finite presentation is locally of finite type.
A morphism of finite presentation is of finite type.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-noetherian-finite-type-finite-presentation}
Let $f : X \to S$ be a morphism.
\begin{enumerate}
\item If $S$ is locally Noetherian and $f$ locally of finite type
then $f$ is locally of finite presentation.
\item If $S$ is locally Noetherian and $f$ of finite type
then $f$ is of finite presentation.
\end{enumerate}
\end{lemma}

\begin{proof}
The first statement follows from the fact that a ring
of finite type over a Noetherian ring is of finite presentation, see Algebra,
Lemma \ref{algebra-lemma-Noetherian-finite-type-is-finite-presentation}.
Suppose that $f$ is of finite type and $S$ is locally Noetherian.
Then $f$ is quasi-compact and locally of finite presentation by (1).
Hence it suffices to prove that $f$ is quasi-separated.
This follows from Lemma \ref{lemma-finite-type-Noetherian-quasi-separated}
(and Lemma \ref{lemma-finite-presentation-finite-type}).
\end{proof}

\begin{lemma}
\label{lemma-finite-presentation-quasi-compact-quasi-separated}
Let $S$ be a scheme which is quasi-compact and quasi-separated.
If $X$ is of finite presentation over $S$, then $X$ is quasi-compact
and quasi-separated.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-finite-presentation-permanence}
Let $f : X \to Y$ be a morphism of schemes over $S$.
If $X$ is locally of finite presentation over $S$, and
$Y$ is locally of finite type over $S$, then $f$ is locally
of finite presentation.
\end{lemma}

\begin{proof}
Via Lemma \ref{lemma-locally-finite-presentation-characterize} this translates
into the following algebra
fact: Given ring maps $A \to B \to C$ such that $A \to C$ is
of finite presentation and $A \to B$ is of finite type,
then $B \to C$ is of finite type.
(See Algebra Lemma \ref{algebra-lemma-compose-finite-type}).
\end{proof}




\section{Constructible sets}
\label{section-constructible}

\noindent
Constructible and locally construcible sets of schemes have been discussed in
Properties, Section \ref{properties-section-constructible}.
In this section we prove some results concerning images and inverse images
of (locally) constructible sets. The main result is Chevalley's theorem
which states that the image of a locally constructible set under a morphism
of finite presentation is locally constructible.

\begin{lemma}
\label{lemma-inverse-image-construcible}
Let $f : X \to Y$ be a morphism of schemes.
Let $E \subset Y$ be a subset.
If $E$ is (locally) construcible in $Y$, then $f^{-1}(E)$ is (locally)
constructible in $X$.
\end{lemma}

\begin{proof}
To show that the inverse image of every construcible subset is constructible
it suffices to show that the inverse image of every retrocompact open $V$
of $Y$ is retrocompact in $X$. The significance of $V$ being retrocompact
in $Y$ is just that the open immersion $V \to Y$ is quasi-compact.
Hence the base change $f^{-1}(V) = X \times_Y V \to X$ is quasi-compact
too, see
Schemes, Lemma \ref{schemes-lemma-quasi-compact-preserved-base-change}.
Hence we see $f^{-1}(V)$ is retrocompact in $X$.
Suppose $E$ is locally constructible in $Y$.
Choose $x \in X$. Choose an affine neighbourhood $V$ of $f(x)$ and
an affine neighbourhood $U \subset X$ of $x$ such that $f(U) \subset V$.
Thus we think of $f|_U : U \to V$ as a morphism into $V$. By
Properties, Lemma \ref{properties-lemma-locally-constructible}
we see that $E \cap V$ is constructible in $V$. By the constructible case
we see that $(f|_U)^{-1}(E \cap V)$ is constructible in $U$.
Since $(f|_U)^{-1}(E \cap V) = f^{-1}(E) \cap U$ we win.
\end{proof}

\begin{lemma}
\label{lemma-chevalley}
Let $f : X \to Y$ be a morphism of schemes.
Assume
\begin{enumerate}
\item $f$ is quasi-compact and locally of finite presentation, and
\item $Y$ is quasi-compact and quasi-separated.
\end{enumerate}
Then the image of every constructible subset of $X$ is constructible in $Y$.
\end{lemma}

\begin{proof}
By
Properties,
Lemma \ref{properties-lemma-constructible-quasi-compact-quasi-separated}
it suffices to prove this lemma in case $Y$ is affine.
In this case $X$ is quasi-compact. Hence we can write
$X = U_1 \cup \ldots \cup U_n$ with each $U_i$ affine open in $X$.
If $E \subset X$ is constructible, then each $E \cap U_i$ is constructible
too, see
Topology,
Lemma \ref{topology-lemma-open-immersion-constructible-inverse-image}.
Hence, since $f(E) = \bigcup f(E \cap U_i)$ and since finite unions of
constructible sets are constructible, this reduces us to the case where
$X$ is affine. In this case the result is
Algebra, Theorem \ref{algebra-theorem-chevalley}.
\end{proof}

\begin{theorem}
\label{theorem-chevalley}
(Chevalley's Theorem.)
Let $f : X \to Y$ be a morphism of schemes.
Assume $f$ is quasi-compact and locally of finite presentation.
Then the image of every locally constructible subset is locally constructible.
\end{theorem}

\begin{proof}
Let $E \subset X$ be locally constructible.
We have to show that $f(E)$ is locally constructible too.
We will show that $f(E) \cap V$ is constructible for any affine
open $V \subset Y$. Thus we reduce to the case where $Y$ is affine.
In this case $X$ is quasi-compact. Hence we can write
$X = U_1 \cup \ldots \cup U_n$ with each $U_i$ affine open in $X$.
If $E \subset X$ is locally constructible, then each $E \cap U_i$
is constructible, see
Properties, Lemma \ref{properties-lemma-locally-constructible}.
Hence, since $f(E) = \bigcup f(E \cap U_i)$ and since finite unions of
constructible sets are constructible, this reduces us to the case where $X$
is affine. In this case the result is
Algebra, Theorem \ref{algebra-theorem-chevalley}.
\end{proof}



\section{Open morphisms}
\label{section-open}

\begin{definition}
\label{definition-open}
Let $f : X \to S$ be a morphism.
\begin{enumerate}
\item We say $f$ is {\it open} if the map on underlying
topological spaces is open.
\item We say $f$ is {\it universally open} if for any morphism of
schemes $S' \to S$ the base change $f' : X_{S'} \to S'$ is open.
\end{enumerate}
\end{definition}

\noindent
According to
Topology, Lemma \ref{topology-lemma-closed-open-map-specialization}
generalizations lift along certain types of open maps of topological
spaces. In fact generalizations lift along any open morphism of schemes
(see
Lemma \ref{lemma-open-generizing}).
Also, we will see that generalizations lift along flat morphisms
of schemes (Lemma \ref{lemma-generalizations-lift-flat}).
This sometimes in turn implies that the morphism is open.

\begin{lemma}
\label{lemma-locally-finite-presentation-universally-open}
Let $f : X \to S$ be a morphism.
\begin{enumerate}
\item If $f$ is locally of finite presentation and generalizations lift
along $f$, then $f$ is open.
\item If $f$ is locally of finite presentation and generalizations lift
along every base change of $f$, then $f$ is universally open.
\end{enumerate}
\end{lemma}

\begin{proof}
It suffices to prove the first assertion.
This reduces to the case where both $X$ and $S$ are affine.
In this case the result follows from
Algebra, Lemma \ref{algebra-lemma-going-up-down-specialization}
and Proposition \ref{algebra-proposition-fppf-open}.
\end{proof}

\noindent
See also Lemma \ref{lemma-fppf-open} for the case of a morphism
flat of finite presentation.

\begin{lemma}
\label{lemma-composition-open}
A composition of (universally) open morphisms is (universally) open.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-scheme-over-field-universally-open}
Let $k$ be a field. Let $X$ be a scheme over $k$.
The structure morphism $X \to \text{Spec}(k)$ is universally open.
\end{lemma}

\begin{proof}
Let $S \to \text{Spec}(k)$ be a morphism.
We have to show that the base change $X_S \to S$ is open.
The question is local on $S$ and $X$, hence we may assume that
$S$ and $X$ are affine. In this case the result is
Algebra, Lemma \ref{algebra-lemma-map-into-tensor-algebra-open}.
\end{proof}

\begin{lemma}
\label{lemma-open-generizing}
Let $\varphi : X \to Y$ be a morphism of schemes.
If $\varphi$ is open, then $\varphi$ is generizing
(i.e., generalizations lift along $\varphi$).
If $\varphi$ is universally open, then $\varphi$ is
universally generizing.
\end{lemma}

\begin{proof}
Assume $\varphi$ is open.
Let $y' \leadsto y$ be a specialization of points of $Y$.
Let $x \in X$ with $\varphi(x) = y$.
Choose affine opens $U \subset X$ and $V \subset Y$ such that
$\varphi(U) \subset V$ and $x \in U$. Then also $y' \in V$. Hence we
may replace $X$ by $U$ and $Y$ by $V$ and assume $X$, $Y$ affine.
The affine case is
Algebra, Lemma \ref{algebra-lemma-open-going-down}
(combined with
Algebra, Lemmma \ref{algebra-lemma-going-up-down-specialization}).
\end{proof}

\begin{lemma}
\label{lemma-descent-quasi-compact}
Let $f : X \to Y$ be a morphism of schemes.
Let $g : Y' \to Y$ be open and surjective such that the base change
$f' : X' \to Y'$ is quasi-compact. Then $f$ is quasi-compact.
\end{lemma}

\begin{proof}
Let $V \subset Y$ be a quasi-compact open. As $g$ is open and surjective
we can find a quasi-compact open $W' \subset W$ such that $g(W') = V$.
By assumption $(f')^{-1}(W')$ is quasi-compact. The image of
$(f')^{-1}(W')$ in $X$ is equal to $f^{-1}(V)$, see
Lemma \ref{lemma-when-point-maps-to-pair}.
Hence $f^{-1}(V)$ is quasi-compact as the image of a quasi-compact space, see
Topology, Lemma \ref{topology-lemma-image-quasi-compact}.
Thus $f$ is quasi-compact.
\end{proof}





\section{Submersive morphisms}
\label{section-submersive}

\begin{definition}
\label{definition-submersive}
Let $f : X \to Y$ be a morphism of schemes.
\begin{enumerate}
\item We say $f$ is {\it submersive}\footnote{This is very different
from the notion of a submersion of differential manifolds.}
if the continuous map of underlying topological spaces is submersive, see
Topology, Definition \ref{topology-definition-submersive}.
\item We say $f$ is {\it universally submersive} if for every
morphism of schemes $Y' \to Y$ the base change
$Y' \times_Y X \to Y'$ is submersive.
\end{enumerate}
\end{definition}

\noindent
We note that a submersive morphism is in particular surjective.









\section{Flat morphisms}
\label{section-flat}

\noindent
Flatness is one of the most important technical tools in algebraic geometry.
In this section we introduce this notion. We intentionally limit the discussion
to straightforward observations, apart from Lemma \ref{lemma-fppf-open}.
A very important class of results, namely criteria for flatness will
be discussed (insert future reference here).

\medskip\noindent
Recall that a module $M$ over a ring $R$ is {\it flat} if the functor
$-\otimes_R M : \text{Mod}_R \to \text{Mod}_R$ is exact. A ring map
$R \to A$ is said to be {\it flat} if $A$ is flat as an $R$-module.

\begin{definition}
\label{definition-flat}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{F}$ be a quasi-coherent sheaf of $\mathcal{O}_X$-modules.
\begin{enumerate}
\item We say $f$ is {\it flat at a point $x \in X$} if the
local ring $\mathcal{O}_{X, x}$ is flat over the local ring
$\mathcal{O}_{S, f(x)}$.
\item We say that $\mathcal{F}$ is {\it flat over $S$ at a point $x \in X$}
if the stalk $\mathcal{F}_x$ is a flat $\mathcal{O}_{S, f(x)}$-module.
\item We say $f$ is {\it flat} if $f$ is flat at every point of $X$.
\item We say that $\mathcal{F}$ is {\it flat over $S$} if
$\mathcal{F}$ is flat over $S$ at every point $x$ of $X$.
\end{enumerate}
\end{definition}

\noindent
Thus we see that $f$ is flat if and only if
the structure sheaf $\mathcal{O}_X$ is flat over $S$.

\begin{lemma}
\label{lemma-flat-module-characterize}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{F}$ be a quasi-coherent sheaf of $\mathcal{O}_X$-modules.
The following are equivalent
\begin{enumerate}
\item The sheaf $\mathcal{F}$ is flat over $S$.
\item For every affine opens $U \subset X$, $V \subset S$
with $f(U) \subset V$ the $\mathcal{O}_S(V)$-module $\mathcal{F}(U)$ is flat.
\item There exists an open covering $S = \bigcup_{j \in J} V_j$
and open coverings $f^{-1}(V_j) = \bigcup_{i \in I_j} U_i$ such
that each of the modules $\mathcal{F}|_{U_i}$ is
flat over $V_j$, for all $j\in J, i\in I_j$.
\item There exists an affine open covering $S = \bigcup_{j \in J} V_j$
and affine open coverings $f^{-1}(V_j) = \bigcup_{i \in I_j} U_i$ such
that $\mathcal{F}(U_i)$ is a flat $\mathcal{O}_S(V_j)$-module, for all
$j\in J, i\in I_j$.
\end{enumerate}
Moreover, if $\mathcal{F}$ is flat over $S$ then for
any open subschemes $U \subset X$, $V \subset S$ with $f(U) \subset V$
the restriction $\mathcal{F}|_U$ is flat over $V$.
\end{lemma}

\begin{proof}
Let $R \to A$ be a ring map. Let $M$ be an $A$-module.
If $M$ is $R$-flat, then for all primes
$\mathfrak q$ the module $M_{\mathfrak q}$ is flat over $R_{\mathfrak p}$
with $\mathfrak p$ the prime of $R$ lying under $\mathfrak q$. Conversely, if
$M_{\mathfrak q}$ is flat over $R_{\mathfrak p}$ for all primes $\mathfrak q$
of $A$, then $M$ is flat over $R$. See
Algebra, Lemma \ref{algebra-lemma-flat-localization}.
This equivalence easily implies the statements of the lemma.
\end{proof}

\begin{lemma}
\label{lemma-flat-characterize}
Let $f : X \to S$ be a morphism of schemes.
The following are equivalent
\begin{enumerate}
\item The morphism $f$ is flat.
\item For every affine opens $U \subset X$, $V \subset S$
with $f(U) \subset V$ the ring map
$\mathcal{O}_S(V) \to \mathcal{O}_X(U)$ is flat.
\item There exists an open covering $S = \bigcup_{j \in J} V_j$
and open coverings $f^{-1}(V_j) = \bigcup_{i \in I_j} U_i$ such
that each of the morphisms $U_i \to V_j$, $j\in J, i\in I_j$
is flat.
\item There exists an affine open covering $S = \bigcup_{j \in J} V_j$
and affine open coverings $f^{-1}(V_j) = \bigcup_{i \in I_j} U_i$ such
that $\mathcal{O}_S(V_j) \to \mathcal{O}_X(U_i)$ is flat, for all
$j\in J, i\in I_j$.
\end{enumerate}
Moreover, if $f$ is flat then for
any open subschemes $U \subset X$, $V \subset S$ with $f(U) \subset V$
the restriction $f|_U : U \to V$ is flat.
\end{lemma}

\begin{proof}
This is a special case of Lemma \ref{lemma-flat-module-characterize}
above.
\end{proof}

\begin{lemma}
\label{lemma-composition-module-flat}
Let $X \to Y \to Z$ be morphisms of schemes.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
If $\mathcal{F}$ is flat over $Y$, and $Y$ is flat over $Z$, then
$\mathcal{F}$ is flat over $Z$.
\end{lemma}

\begin{proof}
See Algebra, Lemma \ref{algebra-lemma-composition-flat}.
\end{proof}

\begin{lemma}
\label{lemma-composition-flat}
The composition of flat morphisms is flat.
\end{lemma}

\begin{proof}
This is a special case of Lemma \ref{lemma-composition-module-flat}.
\end{proof}

\begin{lemma}
\label{lemma-base-change-module-flat}
Let $f : X \to S$ be a morphism of schemes. Let $\mathcal{F}$ be a
quasi-coherent sheaf of $\mathcal{O}_X$-modules.
Let $g : S' \to S$ be a morphism of schemes. Denote
$g' : X_{S'} \to X$ the projection. If $\mathcal{F}$ is flat
over $S$, then $(g')^*\mathcal{F}$ is flat over $S'$.
\end{lemma}

\begin{proof}
See Algebra, Lemma \ref{algebra-lemma-flat-base-change}.
\end{proof}

\begin{lemma}
\label{lemma-base-change-flat}
The base change of a flat morphism is flat.
\end{lemma}

\begin{proof}
This is a special case of Lemma \ref{lemma-base-change-module-flat}.
\end{proof}

\begin{lemma}
\label{lemma-generalizations-lift-flat}
Let $f : X \to S$ be a flat morphism of schemes.
Then generalizations lift along $f$, see
Topology, Definition \ref{topology-definition-lift-specializations}.
\end{lemma}

\begin{proof}
See Algebra, Section \ref{algebra-section-going-up}.
\end{proof}

\begin{lemma}
\label{lemma-fppf-open}
A flat morphism locally of finite presentation is universally open.
\end{lemma}

\begin{proof}
This follows from Lemmas \ref{lemma-generalizations-lift-flat} and
Lemma \ref{lemma-locally-finite-presentation-universally-open} above.
We can also argue directly as follows.

\medskip\noindent
Let $f : X \to S$ be flat locally of finite presentation.
To show $f$ is open it suffices to show that we may cover
$X$ by open affines $X = \bigcup U_i$ such that $U_i \to S$
is open. By definition we may cover $X$ by
affine opens $U_i \subset X$ such that each $U_i$ maps
into an affine open $V_i \subset S$ and such that
the induced ring map $\mathcal{O}_S(V_i) \to \mathcal{O}_X(U_i)$ is
of finite presentation. Thus $U_i \to V_i$ is open by
Algebra, Proposition \ref{algebra-proposition-fppf-open}.
The lemma follows.
\end{proof}

\begin{lemma}
\label{lemma-fpqc-quotient-topology}
Let $f : X \to Y$ be a quasi-compact, surjective, flat morphism.
A subset $T \subset Y$ is open (resp.\ closed) if and only
$f^{-1}(T)$ is open (resp.\ closed). In other words, $f$ is
a submersive morphism.
\end{lemma}

\begin{proof}
The question is local on $Y$, hence we may assume that $Y$ is affine.
In this case $X$ is quasi-compact as $f$ is quasi-compact.
Write $X = X_1 \cup \ldots \cup X_n$ as a finite union of affine opens.
Then $f' : X' = X_1 \coprod \ldots \coprod X_n \to Y$ is a surjective
flat morphism of affine schemes. Note that for $T \subset Y$ we have
$(f')^{-1}(T) = f^{-1}(T) \cap X_1 \coprod \ldots \coprod f^{-1}(T) \cap X_n$.
Hence, $f^{-1}(T)$ is open if and only if $(f')^{-1}(T)$ is open.
Thus we may assume both $X$ and $Y$ are affine.

\medskip\noindent
Let $f : \text{Spec}(B) \to \text{Spec}(A)$ be a surjective
morphism of affine schemes corresponding to a flat ring map $A \to B$.
Suppose that $f^{-1}(T)$ is closed, say $f^{-1}(T) = V(I)$ for $I \subset A$
an ideal. Then $T = f(f^{-1}(T)) = f(V(I))$ is the image of
$\text{Spec}(A/I) \to \text{Spec}(B)$ (here we use that $f$
is surjective). On the other hand, generalizations lift along $f$
(Lemma \ref{lemma-generalizations-lift-flat}).
Hence by Topology, Lemma \ref{topology-lemma-lift-specializations-images}
we see that $Y \setminus T = f(X \setminus f^{-1}(T))$ is stable under
generalization. Hence $T$ is stable under specialization
(Topology, Lemma \ref{topology-lemma-open-closed-specialization}).
Thus $T$ is closed by
Algebra, Lemma \ref{algebra-lemma-image-stable-specialization-closed}.
\end{proof}

\begin{lemma}
\label{lemma-flat-permanence}
Let $h : X \to Y$ be a morphism of schemes over $S$.
If $h$ is surjective and flat, and $X$ is flat over $S$, then
$Y$ is flat over $S$.
\end{lemma}

\begin{proof}
Let $y \in Y$ be a point with image $s \in S$.
Choose a point $x \in X$ mapping to $y$ under $h$.
Consider the local ring maps
$\mathcal{O}_{S, s} \to \mathcal{O}_{Y, y} \to \mathcal{O}_{X, x}$.
Let $N \to M$ be an injection of $\mathcal{O}_{S, s}$-modules.
If $N \otimes \mathcal{O}_{Y, y} \to M \otimes \mathcal{O}_{Y, y}$
has a nonzero kernel then so does
$N \otimes \mathcal{O}_{X, x} \to M \otimes \mathcal{O}_{X, x}$
as $\mathcal{O}_{Y, y} \to \mathcal{O}_{X, x}$ is faithfully flat
(see Algebra, Lemma \ref{algebra-lemma-local-flat-ff}). But this is
impossible as $\mathcal{O}_{S, s} \to \mathcal{O}_{X, x}$ is flat.
Thus $N \otimes \mathcal{O}_{Y, y} \to M \otimes \mathcal{O}_{Y, y}$
is injective and we win.
\end{proof}





\section{Flat closed immersions}
\label{section-flat-closed-immersions}

\noindent
Connected components of schemes are not always open. But they do always
have a canonical scheme structure. We explain this in this section.

\begin{lemma}
\label{lemma-characterize-flat-closed-immersions}
Let $X$ be a scheme. The rule which associates to a closed subscheme
of $X$ its underlying closed subset defines a bijection
$$
\left\{
\begin{matrix}
\text{closed subschemes }Z \subset X \\
\text{such that }Z \to X\text{ is flat}
\end{matrix}
\right\}
\leftrightarrow
\left\{
\begin{matrix}
\text{closed subsets }Z \subset X \\
\text{closed under generalizations}
\end{matrix}
\right\}
$$
\end{lemma}

\begin{proof}
The affine case is
Algebra, Lemma \ref{algebra-lemma-pure-open-closed-specializations}.
In general the lemma follows by covering $X$ by affines and glueing.
Details omitted.
\end{proof}

\noindent
Note that a connected component $T$ of a scheme $X$ is a closed
subset stable under generalization. Hence the following definition
makes sense.

\begin{definition}
\label{definition-scheme-structure-connected-component}
Let $X$ be a scheme. Let $T \subset X$ be a connected component.
The {\it canonical scheme structure on $T$} is the unique
scheme structure on $T$ such that the closed immersion $T \to X$
is flat, see
Lemma \ref{lemma-characterize-flat-closed-immersions}.
\end{definition}

\noindent
It turns out that we can determine when every finite flat
$\mathcal{O}_X$-module is finite locally free using the previous lemma.

\begin{lemma}
\label{lemma-finite-flat-is-finite-locally-free}
Let $X$ be a scheme. The following are equivalent
\begin{enumerate}
\item every finite flat quasi-coherent $\mathcal{O}_X$-module is
finite locally free, and
\item every closed subset $Z \subset X$ which is closed under generalizations
is open.
\end{enumerate}
\end{lemma}

\begin{proof}
In the affine case this is
Algebra, Lemma \ref{algebra-lemma-finite-flat-module-finitely-presented}.
The scheme case does not follow directly from the affine case, so we
simply repeat the arguments.

\medskip\noindent
Assume (1). Consider a closed immersion $i : Z \to X$ such that $i$ is flat.
Then $i_*\mathcal{O}_Z$ is quasi-coherent and flat, hence finite locally
free by (1). Thus $Z = \text{Supp}(i_*\mathcal{O}_Z)$ is also open and we see
that (2) holds. Hence the implication (1) $\Rightarrow$ (2) follows from
the characterization of flat closed immersions in
Lemma \ref{lemma-characterize-flat-closed-immersions}.

\medskip\noindent
For the converse assume that $X$ satisfies (2).
Let $\mathcal{F}$ be a finite flat quasi-coherent $\mathcal{O}_X$-module.
The support $Z = \text{Supp}(\mathcal{F})$ of $\mathcal{F}$ is closed, see
Modules, Lemma \ref{modules-lemma-support-finite-type-closed}.
On the other hand, if $x \leadsto x'$ is a specialization, then by
Algebra, Lemma \ref{algebra-lemma-finite-flat-local}
the module $\mathcal{F}_{x'}$ is free over $\mathcal{O}_{X, x'}$, and
$$
\mathcal{F}_x =
\mathcal{F}_{x'} \otimes_{\mathcal{O}_{X, x'}} \mathcal{O}_{X, x}.
$$
Hence
$x' \in \text{Supp}(\mathcal{F}) \Rightarrow x \in \text{Supp}(\mathcal{F})$,
in other words, the support is closed under generalization.
As $X$ satisfies (2) we see that the support of $\mathcal{F}$
is open and closed. The modules $\wedge^i(\mathcal{F})$, $i = 1, 2, 3, \ldots$
are finite flat quasi-coherent $\mathcal{O}_X$-modules
also, see
Modules, Section \ref{modules-section-symmetric-exterior}.
Note that
$\text{Supp}(\wedge^{i + 1}(\mathcal{F})) \subset
\text{Supp}(\wedge^i(\mathcal{F}))$.
Thus we see that there exists a decomposition
$$
X = U_0 \coprod U_1 \coprod U_2 \coprod \ldots
$$
by open and closed subsets such that the support of
$\wedge^i(\mathcal{F})$ is $U_i \cup U_{i + 1} \cup \ldots$ for all $i$.
Let $x$ be a point of $X$, and say $x \in U_r$.
Note that
$\wedge^i(\mathcal{F})_x \otimes \kappa(x) = 
\wedge^i(\mathcal{F}_x \otimes \kappa(x))$.
Hence, $x \in U_r$ implies that $\mathcal{F}_x \otimes \kappa(x)$
is a vector space of dimension $r$. By Nakayama's lemma, see
Algebra, Lemma \ref{algebra-lemma-NAK}
we can choose an affine open neighbourhood $U \subset U_r \subset X$
of $x$ and sections $s_1, \ldots, s_r \in \mathcal{F}(U)$ such that
the induced map
$$
\mathcal{O}_U^{\oplus r} \longrightarrow \mathcal{F}|_U,\quad
(f_1, \ldots, f_r) \longmapsto \sum f_i s_i
$$
is surjective. This means that
$\wedge^r(\mathcal{F}|_U)$ is a finite flat quasi-coherent
$\mathcal{O}_U$-module whose support is all of $U$.
By the above it is generated by a single element, namely
$s_1 \wedge \ldots \wedge s_r$. Hence
$\wedge^r(\mathcal{F}|_U) \cong \mathcal{O}_U/\mathcal{I}$
for some quasi-coherent sheaf of ideals $\mathcal{I}$
such that $\mathcal{O}_U/\mathcal{I}$ is flat over $\mathcal{O}_U$ and
such that $V(\mathcal{I}) = U$.
It follows that $\mathcal{I} = 0$ by applying
Lemma \ref{lemma-characterize-flat-closed-immersions}.
Thus $s_1 \wedge \ldots \wedge s_r$ is a basis for
$\wedge^r(\mathcal{F}|_U)$ and it follows that the displayed map is injective
as well as surjective. This proves that $\mathcal{F}$ is finite locally free
as desired.
\end{proof}






\section{Generic flatness}
\label{section-generic-flatness}

\noindent
A scheme of finite type over an integral base is flat over a dense
open of the base. By analogy with the results in
Algebra, Section \ref{section-generic-flatness}
there is a Noetherian version, a version for morphisms of finite presentation
and a general version. Since the general version directly implies the other
two we only state and prove the general version here.
Here is the statement.

\begin{proposition}
\label{proposition-generic-flatness}
(Generic flatness)
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{F}$ be a quasi-coherent sheaf of $\mathcal{O}_X$-modules.
Assume
\begin{enumerate}
\item $S$ is integral,
\item $f$ is of finite type, and
\item $\mathcal{F}$ is a finite type $\mathcal{O}_X$-module.
\end{enumerate}
Then there exists an open dense subscheme $U \subset S$ such that
$X_U \to U$ is flat and of finite presentation and such that
$\mathcal{F}|_{X_U}$ is flat over $U$ and of finite presentation
over $\mathcal{O}_{X_U}$.
\end{proposition}

\begin{proof}
As $S$ is integral it is irreducible (see
Properties, Lemma \ref{properties-lemma-characterize-integral})
and any nonempty open is dense. Hence we may replace
$S$ by an affine open of $S$ and assume that $S = \text{Spec}(A)$ is
affine. As $S$ is integral we see that $A$ is a domain.
As $f$ is of finite type, it is quasi-compact, so $X$ is quasi-compact.
Hence we can find a finite affine open cover
$X = \bigcup_{i = 1, \ldots, n} X_i$. Write $X_i = \text{Spec}(B_i)$.
Then $B_i$ is a finite type $A$-algebra, see
Lemma \ref{lemma-locally-finite-type-characterize}.
Moreover there are finite type
$B_i$-modules $M_i$ such that $\mathcal{F}|_{X_i}$ is the
quasi-coherent sheaf associated to the $B_i$-module $M_i$, see
Properties, Lemma \ref{properties-lemma-finite-type-module}.
Next, for each pair of indices $i, j$ choose an ideal $I_{ij} \subset B_i$
such that $X_i \setminus X_i \cap X_j = V(I_{ij})$ inside
$X_i = \text{Spec}(B_i)$. Set $M_{ij} = B_i/I_{ij}$ and think
of it as a $B_i$-module. Then $V(I_{ij}) = \text{Supp}(M_{ij})$
and $M_{ij}$ is a finite $B_i$-module.

\medskip\noindent
At this point we apply
Algebra, Lemma \ref{algebra-lemma-generic-flatness}
the pairs $(A \to B_i, M_{ij})$ and to the
pairs $(A \to B_i, M_i)$. Thus we obtain
nonzero $f_{ij}, f_i \in A$ such that (a) $A_{f_{ij}} \to B_{i, f_{ij}}$
is flat and of finite presentation and $M_{ij, f_{ij}}$ is flat
over $A_{f_{ij}}$ and of finite presentation over $B_{i, f_{ij}}$, and
(b) $B_{i, f_i}$ is flat and of finite presentation over $A_f$ and
$M_{i, f_i}$ is flat and of finite presentation over $B_{i, f_i}$. Set
$f = (\prod f_i) (\prod f_{ij})$.
We claim that taking $U = D(f)$ works.

\medskip\noindent
To prove our claim we may replace $A$ by $A_f$, i.e.,
perform the base change by $U = \text{Spec}(A_f) \to S$.
After this base change we see that each of $A \to B_i$ is
flat and of finite presentation and that $M_i$, $M_{ij}$ are flat over $A$
and of finite presentation over $B_i$.
This already proves that $X \to S$ is quasi-compact,
locally of finite presentation, flat, and that $\mathcal{F}$
is flat over $S$ and of finite presentation over $\mathcal{O}_X$, see
Lemma \ref{lemma-locally-finite-presentation-characterize}
and
Properties, Lemma \ref{properties-lemma-finite-presentation-module}.
Since $M_{ij}$ is of finite presentation over $B_i$ we see that
$X_i \cap X_j = X_i \setminus \text{Supp}(M_{ij})$ is a quasi-compact
open of $X_i$, see
Algebra, Lemma \ref{algebra-lemma-support-finite-presentation-constructible}.
Hence we see that $X \to S$ is quasi-separated by
Schemes, Lemma \ref{schemes-lemma-characterize-quasi-separated}.
This proves the proposition.
\end{proof}

\noindent
It actually turns out that there is also a version of generic
flatness over an arbitrary reduced base. Here it is.

\begin{proposition}
\label{proposition-generic-flatness-reduced}
(Generic flatness, reduced case)
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{F}$ be a quasi-coherent sheaf of $\mathcal{O}_X$-modules.
Assume
\begin{enumerate}
\item $S$ is reduced,
\item $f$ is of finite type, and
\item $\mathcal{F}$ is a finite type $\mathcal{O}_X$-module.
\end{enumerate}
Then there exists an open dense subscheme $U \subset S$ such that
$X_U \to U$ is flat and of finite presentation and such that
$\mathcal{F}|_{X_U}$ is flat over $U$ and of finite presentation
over $\mathcal{O}_{X_U}$.
\end{proposition}

\begin{proof}
For the impatient reader: This proof is a repeat of the proof of
Proposition \ref{proposition-generic-flatness}
using
Algebra, Lemma \ref{algebra-lemma-generic-flatness-reduced}
instead of
Algebra, Lemma \ref{algebra-lemma-generic-flatness}.

\medskip\noindent
Since being flat and being of finite presentation is local on the
base, see
Lemmas \ref{lemma-flat-module-characterize} and
\ref{lemma-locally-finite-presentation-characterize},
we may work affine locally on $S$. Thus we may assume that
$S = \text{Spec}(A)$, where $A$ is a reduced ring (see
Properties, Lemma \ref{properties-lemma-characterize-reduced}).
As $f$ is of finite type, it is quasi-compact, so $X$ is quasi-compact.
Hence we can find a finite affine open cover
$X = \bigcup_{i = 1, \ldots, n} X_i$. Write $X_i = \text{Spec}(B_i)$.
Then $B_i$ is a finite type $A$-algebra, see
Lemma \ref{lemma-locally-finite-type-characterize}.
Moreover there are finite type
$B_i$-modules $M_i$ such that $\mathcal{F}|_{X_i}$ is the
quasi-coherent sheaf associated to the $B_i$-module $M_i$, see
Properties, Lemma \ref{properties-lemma-finite-type-module}.
Next, for each pair of indices $i, j$ choose an ideal $I_{ij} \subset B_i$
such that $X_i \setminus X_i \cap X_j = V(I_{ij})$ inside
$X_i = \text{Spec}(B_i)$. Set $M_{ij} = B_i/I_{ij}$ and think
of it as a $B_i$-module. Then $V(I_{ij}) = \text{Supp}(M_{ij})$
and $M_{ij}$ is a finite $B_i$-module.

\medskip\noindent
At this point we apply
Algebra, Lemma \ref{algebra-lemma-generic-flatness-reduced}
the pairs $(A \to B_i, M_{ij})$ and to the pairs $(A \to B_i, M_i)$.
Thus we obtain dense opens
$U(A \to B_i, M_{ij}) \subset S$ and dense opens
$U(A \to B_i, M_i) \subset S$ with notation as in
Algebra, Equation (\ref{algebra-equation-good-locus}).
Since a finite intersection of dense opens is dense open, we see that
$$
U =
\bigcap\nolimits_{i, j} U(A \to B_i, M_{ij})
\quad\cap\quad
\bigcap\nolimits_i U(A \to B_i, M_i)
$$
is open and dense in $S$. We claim that $U$ is the desired open.

\medskip\noindent
Pick $u \in U$. By definition of the loci $U(A \to B_i, M_{ij})$
and $U(A \to B, M_i)$ there exist $f_{ij}, f_i \in A$ such that
(a) $u \in D(f_i)$ and $u \in D(f_{ij})$,
(b) $A_{f_{ij}} \to B_{i, f_{ij}}$ is flat and of finite presentation
and $M_{ij, f_{ij}}$ is flat over $A_{f_{ij}}$ and of finite presentation
over $B_{i, f_{ij}}$, and
(c) $B_{i, f_i}$ is flat and of finite presentation over $A_f$ and
$M_{i, f_i}$ is flat and of finite presentation over $B_{i, f_i}$. Set
$f = (\prod f_i) (\prod f_{ij})$.
Now it suffices to prove that $X \to S$ is flat and of finite presentation
over $D(f)$ and that $\mathcal{F}$ restricted to $X_{D(f)}$ is
flat over $D(f)$ and of finite presentation over the structure sheaf
of $X_{D(f)}$.

\medskip\noindent
Hence we may replace $A$ by $A_f$, i.e.,
perform the base change by $\text{Spec}(A_f) \to S$.
After this base change we see that each of $A \to B_i$ is
flat and of finite presentation and that $M_i$, $M_{ij}$ are flat over $A$
and of finite presentation over $B_i$.
This already proves that $X \to S$ is quasi-compact,
locally of finite presentation, flat, and that $\mathcal{F}$
is flat over $S$ and of finite presentation over $\mathcal{O}_X$, see
Lemma \ref{lemma-locally-finite-presentation-characterize}
and
Properties, Lemma \ref{properties-lemma-finite-presentation-module}.
Since $M_{ij}$ is of finite presentation over $B_i$ we see that
$X_i \cap X_j = X_i \setminus \text{Supp}(M_{ij})$ is a quasi-compact
open of $X_i$, see
Algebra, Lemma \ref{algebra-lemma-support-finite-presentation-constructible}.
Hence we see that $X \to S$ is quasi-separated by
Schemes, Lemma \ref{schemes-lemma-characterize-quasi-separated}.
This proves the proposition.
\end{proof}









\begin{remark}
\label{remark-flattening}
The results above are a first step towards more refined flattening techniques
for morphisms of schemes. The article \cite{GruRay} by Raynaud and Gruson
contains many wonderful results in this direction.
\end{remark}







\section{Morphisms and dimensions of fibres}
\label{section-dimension-fibres}

\noindent
Let $X$ be a topological space, and $x \in X$.
Recall that we have defined $\dim_x(X)$ as the minimum of the
dimensions of the open neighbourhoods of $x$ in $X$.
See Topology, Definition \ref{topology-definition-Krull}.

\begin{lemma}
\label{lemma-dimension-fibre-at-a-point}
Let $f : X \to S$ be a morphism of schemes.
Let $x \in X$ and set $s = f(x)$.
Assume $f$ is locally of finite type.
Then
$$
\dim_x(X_s) =
\dim(\mathcal{O}_{X_s, x}) + \text{trdeg}_{\kappa(s)}(\kappa(x)).
$$
\end{lemma}

\begin{proof}
This immediately reduces to the case $S = s$, and $X$ affine.
In this case the result follows from
Algebra, Lemma \ref{algebra-lemma-dimension-at-a-point-finite-type-field}.
\end{proof}

\begin{lemma}
\label{lemma-dimension-fibre-at-a-point-additive}
Let $f : X \to Y$ and $g : Y \to S$ be morphisms of schemes.
Let $x \in X$ and set $y = f(x)$, $s = g(y)$.
Assume $f$ and $g$ locally of finite type.
Then
$$
\dim_x(X_s) \leq \dim_x(X_y) + \dim_y(Y_s).
$$
Moreover, equality holds if $\mathcal{O}_{X_s, x}$ is flat
over $\mathcal{O}_{Y_s, y}$, which holds for example if $\mathcal{O}_{X, x}$
is flat over $\mathcal{O}_{Y, y}$.
\end{lemma}

\begin{proof}
Note that $\text{trdeg}_{\kappa(s)}(\kappa(x)) =
\text{trdeg}_{\kappa(y)}(\kappa(x)) + \text{trdeg}_{\kappa(s)}(\kappa(y))$.
Thus by Lemma \ref{lemma-dimension-fibre-at-a-point} the statement
is equivalent to
$$
\dim(\mathcal{O}_{X_s, x})
\leq
\dim(\mathcal{O}_{X_y, x}) + \dim(\mathcal{O}_{Y_s, y}).
$$
For this see Algebra, Lemma \ref{algebra-lemma-dimension-base-fibre-total}.
For the flat case see
Algebra, Lemma \ref{algebra-lemma-dimension-base-fibre-equals-total}.
\end{proof}

\begin{lemma}
\label{lemma-dimension-fibre-after-base-change}
Let
$$
\xymatrix{
X' \ar[r]_{g'} \ar[d]_{f'} & X \ar[d]^f \\
S' \ar[r]^g & S
}
$$
be a fibre product diagram of schemes. Assume $f$ locally of finite type.
Suppose that $x' \in X'$, $x = g'(x')$, $s' = f'(x')$ and
$s = g(s') = f(x)$. Then $\dim_x(X_s) = \dim_{x'}(X'_{s'})$.
\end{lemma}

\begin{proof}
Follows immediately from
Algebra,
Lemma \ref{algebra-lemma-dimension-at-a-point-preserved-field-extension}.
\end{proof}

\noindent
The following lemma follows from a nontrivial algebraic result.
Namely, the algebraic version of Zariski's main theorem.

\begin{lemma}
\label{lemma-openness-bounded-dimension-fibres}
Let $f : X \to S$ be a morphism of schemes.
Let $n \geq 0$. Assume $f$ is locally of finite type.
The set
$$
U_n = \{x \in X \mid \dim_x X_{f(x)} \leq n\}
$$
is open in $X$.
\end{lemma}

\begin{proof}
This is immediate from
Algebra,
Lemma \ref{algebra-lemma-dimension-fibres-bounded-open-upstairs}
\end{proof}

\begin{lemma}
\label{lemma-openness-bounded-dimension-fibres-finite-presentation}
Let $f : X \to S$ be a morphism of schemes.
Let $n \geq 0$. Assume $f$ is locally of finite presentation.
The open
$$
U_n = \{x \in X \mid \dim_x X_{f(x)} \leq n\}
$$
of Lemma \ref{lemma-openness-bounded-dimension-fibres} is retrocompact
in $X$. (See Topology, Definition \ref{topology-definition-quasi-compact}.)
\end{lemma}

\begin{proof}
The topological space $X$ has a basis for its topology consisting of
affine opens $U \subset X$ such that the infuced morphism
$f|_U : U \to S$ factors through an affine open $V \subset S$. Hence
it is enough to show that $U \cap U_n$ is quasi-compact for such a $U$.
Note that $U_n \cap U$ is the same as the open
$\{x \in U \mid \dim_x U_{f(x)} \leq n\}$. This reduces us to the case
where $X$ and $S$ are affine. In this case the lemma follows from
Algebra,
Lemma \ref{algebra-lemma-dimension-fibres-bounded-quasi-compact-open-upstairs}
(and Lemma \ref{lemma-locally-finite-presentation-characterize}).
\end{proof}





\section{Morphisms of given relative dimension}
\label{section-relative-dimension}

\noindent
In order to be able to speak comfortably about morphisms of a
given relative dimension we introduce the following notion.

\begin{definition}
\label{definition-relative-dimension-d}
Let $f : X \to S$ be a morphism of schemes.
Assume $f$ is locally of finite type.
\begin{enumerate}
\item We say $f$ is of {\it relative dimension $\leq d$ at $x$} if
$\dim_x(X_{f(x)}) \leq d$.
\item We say $f$ is of {\it relative dimension $\leq d$} if
$\dim_x(X_{f(x)}) \leq d$ for all $x \in X$.
\item We say $f$ is of {\it relative dimension $d$} if
all nonempty fibres $X_s$ are equidimensional of dimension $d$.
\end{enumerate}
\end{definition}

\noindent
This is not a particularly well behaved notion, but it works well
in a number of situations.

\begin{lemma}
\label{lemma-base-change-relative-dimension-d}
Let $f : X \to S$ be a morphism of schemes which is locally of finite type.
If $f$ has relative dimension $d$, then so does any base change of $f$.
Same for relative dimension $\leq d$.
\end{lemma}

\begin{proof}
This is immediate from
Lemma \ref{lemma-dimension-fibre-after-base-change}.
\end{proof}

\begin{lemma}
\label{lemma-composition-relative-dimension-d}
Let $f : X \to Y$, $g : Y \to Z$ be locally of finite type.
If $f$ has relative dimension $\leq d$ and $g$ has relative dimension $\leq e$
then $g \circ f$ has relative dimension $\leq d + e$.
If
\begin{enumerate}
\item $f$ has relative dimension $d$,
\item $g$ has relative dimension $e$, and
\item $f$ is flat,
\end{enumerate}
then $g \circ f$ has relative dimension $d + e$.
\end{lemma}

\begin{proof}
This is immediate from Lemma \ref{lemma-dimension-fibre-at-a-point-additive}.
\end{proof}

\noindent
In general it is not possible to decompose a morphism
into its pieces where the relative dimension is a given
one. However, it is possible if the morphism has Cohen-Macaulay
fibres and is flat of finite presentation.

\begin{lemma}
\label{lemma-flat-finite-presentation-CM-fibres-relative-dimension}
Let $f : X \to S$ be a morphism of schemes.
Assume that
\begin{enumerate}
\item $f$ is flat,
\item $f$ is locally of finite presentation, and
\item for all $s \in S$ the fibre $X_s$ is Cohen-Macaulay
(Properties, Definition \ref{properties-definition-Cohen-Macaulay})
\end{enumerate}
Then there exist open and closed subschemes $X_d \subset X$
such that $X = \coprod_{d \geq 0} X_d$ and $f|_{X_d} : X_d \to S$
has relative dimension $d$.
\end{lemma}

\begin{proof}
This is immediate from
Algebra,
Lemma
\ref{algebra-lemma-relative-dimension-CM}.
\end{proof}

\begin{lemma}
\label{lemma-locally-quasi-finite-rel-dimension-0}
Let $f : X \to S$ be a morphism of schemes.
Assume $f$ is locally of finite type.
Let $x \in X$ with $s = f(x)$.
Then $f$ is quasi-finite at $x$ if and only if $\dim_x(X_s) = 0$.
In particular, $f$ is locally quasi-finite if and only if $f$ has relative
dimension $0$.
\end{lemma}

\begin{proof}
If $f$ is quasi-finite at $x$ then $\kappa(x)$ is a finite extension of
$\kappa(s)$ (by
Lemma \ref{lemma-residue-field-quasi-finite})
and $x$ is isolated in $X_s$ (by
Lemma \ref{lemma-quasi-finite-at-point-characterize}),
hence $\dim_x(X_s) = 0$ by
Lemma \ref{lemma-dimension-fibre-at-a-point}.
Conversely, if $\dim_x(X_s) = 0$ then by
Lemma \ref{lemma-dimension-fibre-at-a-point}
we see $\kappa(s) \subset \kappa(x)$ is algebraic and
there are no other points of $X_s$ specializing to $x$.
Hence $x$ is closed in its fibre by
Lemma \ref{lemma-algebraic-residue-field-extension-closed-point-fibre}
and by
Lemma \ref{lemma-quasi-finite-at-point-characterize} (3)
we conclude that $f$ is quasi-finite at $x$.
\end{proof}





\section{The dimension formula}
\label{section-dimension-formula}

\noindent
For morphisms between Noetherian schemes we can say a little more
about dimensions of local rings. Here is an important (and not so
hard to prove) result. Recall that $R(X)$ denotes the function field
of an integral scheme $X$.

\begin{lemma}
\label{lemma-dimension-formula}
Let $S$ be a scheme.
Let $f : X \to S$ be a morphism of schemes.
Let $x \in X$, and set $s = f(x)$.
Assume
\begin{enumerate}
\item $S$ is locally Noetherian,
\item $f$ is locally of finite type,
\item $X$ and $S$ integral, and
\item $f$ dominant.
\end{enumerate}
We have
\begin{equation}
\label{equation-dimension-formula}
\dim(\mathcal{O}_{X, x})
\leq
\dim(\mathcal{O}_{S, s}) + \text{trdeg}_{R(S)}R(X)
- \text{trdeg}_{\kappa(s)} \kappa(x).
\end{equation}
Moreover, equality holds if $S$ is universally catenary.
\end{lemma}

\begin{proof}
The corresponding algebra statement is
Algebra, Lemma \ref{algebra-lemma-dimension-formula}.
\end{proof}

\noindent
An application is the construction of a dimension function
on any scheme of finite type over a universally catenary
scheme endowed with a dimension function. For the definition
of dimension functions, see
Topology, Definition \ref{topology-definition-dimension-function}.

\begin{lemma}
\label{lemma-dimension-function-propagates}
Let $S$ be a universally catenary scheme.
Let $\delta : S \to \mathbf{Z}$ be a dimension function.
Let $f : X \to S$ be a morphism of schemes.
Assume $f$ locally of finite type.
Then the map
\begin{align*}
\delta = \delta_{X/S} : X & \longrightarrow \mathbf{Z} \\
x & \longmapsto \delta(f(x)) + \text{trdeg}_{\kappa(f(x))} \kappa(x)
\end{align*}
is a dimension function on $X$.
\end{lemma}

\begin{proof}
Let $f : X \to S$ be locally of finite type.
Let $x \leadsto y$, $x \not = y$ be a specialization in $X$.
We have to show that $\delta_{X/S}(x) > \delta_{X/S}(y)$ and
that $\delta_{X/S}(x) = \delta_{X/S}(y) + 1$ if $y$ is an
immediate specialization of $x$.

\medskip\noindent
Choose an affine open $V \subset S$ containing the image of
$y$ and choose an affine open $U \subset X$ mapping into $V$
and containing $y$. We may clearly replace $X$ by $U$ and
$S$ by $V$. Thus we may assume that $X = \text{Spec}(A)$
and $S = \text{Spec}(R)$ and that $f$ is given by a ring
map $R \to A$. The ring $R$ is universally catenary
(Lemma \ref{lemma-universally-catenary-local})
and the map $R \to A$ is of finite type
(Lemma \ref{lemma-locally-finite-type-characterize}).

\medskip\noindent
Let $\mathfrak q \subset A$ be the prime ideal corresponding
to the point $x$ and let $\mathfrak p \subset R$ be the prime
ideal corresponding to $f(x)$. The restriction $\delta'$ of $\delta$
to $S' = \text{Spec}(R/\mathfrak p) \subset S$ is a dimension
function. The ring $R/\mathfrak p$ is universally catenary.
The restriction of $\delta_{X/S}$ to $X' = \text{Spec}(A/\mathfrak q)$
is clearly equal to the function $\delta_{X'/S'}$ constructed
using the dimension function $\delta'$. Hence we may assume
in addition to the above that $R \subset A$ are domains, in
other words that $X$ and $S$ are integral schemes.

\medskip\noindent
Note that $\mathcal{O}_{X, x}$ is a localization of
$\mathcal{O}_{X, y}$ at a non-maximal prime
(Schemes, Lemma \ref{schemes-lemma-specialize-points}).
Hence $\dim(\mathcal{O}_{X, x}) < \dim(\mathcal{O}_{X, y})$
and $\dim(\mathcal{O}_{X, x}) = \dim(\mathcal{O}_{X, y}) - 1$
if $y$ is an immediate specialization of $x$.

\medskip\noindent
Write $s = f(x) \not = f(y) = s'$. We see, using equality
in (\ref{equation-dimension-formula}), that
\begin{align*}
\delta_{X/S}(x) - \delta_{X/S}(y) & = \delta(s) - \delta(s') \\
& + \dim(\mathcal{O}_{S, s}) - \dim(\mathcal{O}_{S, s'}) \\
& - \dim(\mathcal{O}_{X, x}) + \dim(\mathcal{O}_{X, y}).
\end{align*}
Since $\delta$ is a dimension function on the scheme $S$ the difference
$\delta(s) - \delta(s')$ is equal to
$\text{codim}(\overline{\{s'\}}, \overline{\{s\}})$ by
Topology, Lemma \ref{topology-lemma-dimension-function-catenary}.
As $S$ is integral, catenary this is equal to
$\text{codim}(\overline{\{s'\}}, S) - \text{codim}(\overline{\{s\}}, S)$
(Topology, Lemma \ref{topology-lemma-catenary-in-codimension}).
And this in turn is equal to
$\dim(\mathcal{O}_{S, s'}) - \dim(\mathcal{O}_{S, s})$ by
Lemma \ref{properties-lemma-codimension-local-ring}.
Hence we conclude that
$$
\delta_{X/S}(x) - \delta_{X/S}(y)
=
- \dim(\mathcal{O}_{X, x}) + \dim(\mathcal{O}_{X, y})
$$
and hence the lemma follows from our remarks about the dimensions
of these local rings above.
\end{proof}

\noindent
Another application of the dimension formula is that the dimension does not
change under ``alterations'' (to be defined later).

\begin{lemma}
\label{lemma-alteration-dimension}
Let $f : X \to Y$ be a morphism of schemes. Assume that
\begin{enumerate}
\item $Y$ is locally Noetherian,
\item $X$ and $Y$ are integral schemes,
\item $f$ is dominant, and
\item $f$ is locally of finite type.
\end{enumerate}
Then we have
$$
\dim(X) \leq \dim(Y) + \text{trdeg}_{R(Y)} R(X).
$$
If $f$ is closed\footnote{For example if $f$ is proper, see
Definition \ref{definition-proper}.} then equality holds.
\end{lemma}

\begin{proof}
Let $f : X \to Y$ be as in the lemma.
Let $\xi_0 \leadsto \xi_1 \leadsto \ldots \leadsto \xi_e$ be
a sequence of specializations in $X$. We may assume that $x = \xi_e$
is a closed point of $X$, see
Properties, Lemma \ref{properties-lemma-locally-Noetherian-closed-point}.
In particular, setting $y = f(x)$, we see $x$ is a closed point of its fibre
$X_y$. By the Hilbert Nullstellensatz we see that $\kappa(x)$ is a finite
extension of $\kappa(y)$, see
Lemma \ref{lemma-closed-point-fibre-locally-finite-type}.
By the dimension formula, Lemma \ref{lemma-dimension-formula},
we see that
$$
\dim(\mathcal{O}_{X, x}) \leq \dim(\mathcal{O}_{Y, y}) +
\text{trdeg}_{R(Y)} R(X)
$$
Hence we conclude that $e \leq \dim(Y) + \text{trdeg}_{R(Y)} R(X)$ as desired.

\medskip\noindent
Next, assume $f$ is also closed.
Say $\overline{\xi}_0 \leadsto \overline{\xi}_1 \leadsto \ldots
\leadsto \overline{\xi}_d$ is a sequence of specializations in $Y$.
We want to show that $\dim(X) \geq d + r$.
We may assume that $\overline{\xi}_0 = \eta$ is the generic point of $Y$.
The generic fibre $X_\eta$ is a scheme locally of finite type over
$\kappa(\eta) = R(Y)$. It is nonempty as $f$ is dominant. Hence by
Lemma \ref{lemma-ubiquity-Jacobson-schemes} it is a Jacobson scheme.
Thus by Lemma \ref{lemma-jacobson-finite-type-points}
we can find a closed point $\xi_0 \in X_\eta$ and the extension
$\kappa(\eta) \subset \kappa(\xi_0)$ is
a finite extension. Note that
$\mathcal{O}_{X, \xi_0} = \mathcal{O}_{X_\eta, \xi_0}$ because
$\eta$ is the generic point of $Y$. Hence we see that
$\dim(\mathcal{O}_{X, \xi_0}) = r$ by Lemma \ref{lemma-dimension-formula}
applied to the scheme $X_\eta$ over the universally catenary
scheme $\text{Spec}(\kappa(\eta))$ (see Lemma \ref{lemma-ubiquity-uc})
and the point $\xi_0$. This means that we can find
$\xi_{-r} \leadsto \ldots \leadsto \xi_{-1} \leadsto \xi_0$
in $X$. On the other hand, as $f$ is closed specializations
lift along $f$, see
Topology, Lemma \ref{topology-lemma-closed-open-map-specialization}.
Thus, as $\xi_0$ lies
over $\eta = \overline{\xi}_0$ we can
find specializations $\xi_0 \leadsto \xi_1 \leadsto \ldots \leadsto \xi_d$
lying over $\overline{\xi}_0 \leadsto \overline{\xi}_1 \leadsto \ldots
\leadsto \overline{\xi}_d$. In other words we have
$$
\xi_{-r} \leadsto \ldots \leadsto \xi_{-1} \leadsto \xi_0
\leadsto \xi_1 \leadsto \ldots \leadsto \xi_d
$$
which means that $\dim(X) \geq d + r$ as desired.
\end{proof}












\section{Syntomic morphisms}
\label{section-syntomic}

\noindent
An algebra $A$ over a field $k$ is called a
{\it global complete intersection over $k$}
if $A \cong k[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$ and
$\dim(A) = n - c$. An algebra $A$ over a field $k$ is called a
{\it local complete intersection} if $\text{Spec}(A)$
can be covered by standard opens each of which are global
complete intersections over $k$. See Algebra, Section
\ref{algebra-section-lci}. Recall that a ring map $R \to A$
is {\it syntomic} if it is of finite presentation,
flat with local complete intersection rings as fibres,
see Algebra, Definition \ref{algebra-definition-lci}.

\begin{definition}
\label{definition-syntomic}
Let $f : X \to S$ be a morphism of schemes.
\begin{enumerate}
\item We say that $f$ is {\it syntomic at $x \in X$} if
there exists a affine open neighbourhood $\text{Spec}(A) = U \subset X$
of $x$ and and affine open $\text{Spec}(R) = V \subset S$
with $f(U) \subset V$ such that the induced ring map
$R \to A$ is syntomic.
\item We say that $f$ is {\it syntomic} if it is syntomic
at every point of $X$.
\item If $S = \text{Spec}(k)$ and $f$ is syntomic, then we say that
$X$ is a {\it local complete intersection over $k$}.
\item A morphism of affine schemes $f : X \to S$
is called {\it standard syntomic} if there exists a
global relative complete intersection
$R \to R[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$ (see
Algebra,
Definition \ref{algebra-definition-relative-global-complete-intersection})
such that $X \to S$ is isomorphic to
$$
\text{Spec}(R[x_1, \ldots, x_n]/(f_1, \ldots, f_c)) \to \text{Spec}(R).
$$
\end{enumerate}
\end{definition}

\noindent
In the literature a syntomic morphism is sometimes referred to as a
{\it flat local complete intersection morphism}.
It turns out this is a convenient class of morphisms. For example one
can define a syntomic topology using these, which is finer than the
smooth and etale topologies, but has many of the same formal properties.

\medskip\noindent
Note that there is no separation or quasi-compactness hypotheses in the
definition. Hence the question of being syntomic is local in nature on
the source. Here is the precise result.

\begin{lemma}
\label{lemma-syntomic-characterize}
Let $f : X \to S$ be a morphism of schemes.
The following are equivalent
\begin{enumerate}
\item The morphism $f$ is syntomic.
\item For every affine opens $U \subset X$, $V \subset S$
with $f(U) \subset V$ the ring map
$\mathcal{O}_S(V) \to \mathcal{O}_X(U)$ is syntomic.
\item There exists an open covering $S = \bigcup_{j \in J} V_j$
and open coverings $f^{-1}(V_j) = \bigcup_{i \in I_j} U_i$ such
that each of the morphisms $U_i \to V_j$, $j\in J, i\in I_j$
is syntomic.
\item There exists an affine open covering $S = \bigcup_{j \in J} V_j$
and affine open coverings $f^{-1}(V_j) = \bigcup_{i \in I_j} U_i$ such
that the ring map $\mathcal{O}_S(V_j) \to \mathcal{O}_X(U_i)$ is
syntomic, for all $j\in J, i\in I_j$.
\end{enumerate}
Moreover, if $f$ is syntomic then for
any open subschemes $U \subset X$, $V \subset S$ with $f(U) \subset V$
the restriction $f|_U : U \to V$ is syntomic.
\end{lemma}

\begin{proof}
This follows from Lemma \ref{lemma-locally-P} if we show that
the property ``$R \to A$ is syntomic'' is local.
We check conditions (a), (b) and (c) of Definition
\ref{definition-property-local}.
By Algebra, Lemma \ref{algebra-lemma-base-change-syntomic}
being syntomic is stable under base change and hence
we conclude (a) holds. By
Algebra, Lemma \ref{algebra-lemma-composition-syntomic}
being syntomic is stable under composition and trivially for any ring
$R$ the ring map $R \to R_f$ is syntomic.
We conclude (b) holds. Finally, property (c) is true
according to Algebra, Lemma \ref{algebra-lemma-local-syntomic}.
\end{proof}

\begin{lemma}
\label{lemma-composition-syntomic}
The composition of two morphisms which are syntomic is syntomic.
\end{lemma}

\begin{proof}
In the proof of Lemma \ref{lemma-syntomic-characterize}
we saw that being syntomic is a local property of ring maps.
Hence the first statement of the lemma follows from
Lemma \ref{lemma-composition-type-P} combined
with the fact that being syntomic is a property of ring maps that is
stable under composition, see
Algebra, Lemma \ref{algebra-lemma-composition-syntomic}.
\end{proof}

\begin{lemma}
\label{lemma-base-change-syntomic}
The base change of a morphism which is syntomic is syntomic.
\end{lemma}

\begin{proof}
In the proof of Lemma \ref{lemma-syntomic-characterize}
we saw that being syntomic is a local property of ring maps.
Hence the lemma follows from
Lemma \ref{lemma-composition-type-P} combined
with the fact that being syntomic is a property of ring maps that is
stable under base change, see
Algebra, Lemma \ref{algebra-lemma-base-change-syntomic}.
\end{proof}

\begin{lemma}
\label{lemma-open-immersion-syntomic}
Any open immersion is syntomic.
\end{lemma}

\begin{proof}
This is true because an open immersion is a local isomorphism.
\end{proof}

\begin{lemma}
\label{lemma-syntomic-locally-finite-presentation}
A syntomic morphism is locally of finite presentation.
\end{lemma}

\begin{proof}
True because a syntomic ring map is of finite presentation by
definition.
\end{proof}

\begin{lemma}
\label{lemma-syntomic-flat}
A syntomic morphism is flat.
\end{lemma}

\begin{proof}
True because a syntomic ring map is flat by definition.
\end{proof}

\noindent
Let $k$ be a field. Let $A$ be a local $k$-algebra essentially
of finite type over $k$. Recall that $A$ is called a
{\it complete intersection over $k$} if we can write
$A \cong R/(f_1, \ldots, f_c)$ where $R$ is a regular local ring
essentially of finite type over $k$, and $f_1, \ldots, f_c$ is
a regular sequence in $R$, see
Algebra, Definition \ref{algebra-definition-lci-local-ring}.

\begin{lemma}
\label{lemma-local-complete-intersection}
Let $k$ be a field.
Let $X$ be a scheme locally of finite type over $k$.
The following are equivalent:
\begin{enumerate}
\item $X$ is a local complete intersection over $k$,
\item for every $x \in X$ there exists an affine open
$U = \text{Spec}(R) \subset X$ neighbourhood of $x$
such that $R \cong k[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$
is a global complete intersection over $k$, and
\item for every $x \in X$ the local ring $\mathcal{O}_{X, x}$
is a complete intersection over $k$.
\end{enumerate}
\end{lemma}

\begin{proof}
The corresponding algebra results can be found in
Algebra, Lemmas \ref{algebra-lemma-lci-at-prime} and
\ref{algebra-lemma-lci-global}.
\end{proof}

\noindent
The following lemma says locally any syntomic morphism is standard syntomic.
Hence we can use standard syntomic morphisms as a {\it local model}
for a syntomic morphism. Moreover, it says that a flat morphism of finite
presentation is syntomic if and only if the fibres are local complete
intersection schemes.

\begin{lemma}
\label{lemma-syntomic-locally-standard-syntomic}
Let $f : X  \to S$ be a morphism of schemes.
Assume $f$ locally of finite presentation.
Let $x \in X$ be a point.
Set $s = f(x)$.
The following are equivalent
\begin{enumerate}
\item The morphism $f$ is syntomic at $x$.
\item There exist affine opens $U \subset X$,
and $V \subset S$ such that $x \in U$, $f(U) \subset V$ and the
induced morphism $f|_U : U \to V$ is standard syntomic.
\item The local ring map $\mathcal{O}_{S, s} \to \mathcal{O}_{X, x}$
is flat and $\mathcal{O}_{X, x}/\mathfrak m_s \mathcal{O}_{X, x}$
is a complete intersection over $\kappa(s)$ (see
Algebra, Definition \ref{algebra-definition-lci-local-ring}).
\end{enumerate}
\end{lemma}

\begin{proof}
Follows from the definitions and
Algebra, Lemma \ref{algebra-lemma-syntomic}.
\end{proof}

\begin{lemma}
\label{lemma-syntomic-flat-fibres}
Let $f : X \to S$ be a morphism of schemes.
If $f$ is flat, locally of finite presentation, and all
fibres $X_s$ are local complete intersections, then $f$
is syntomic.
\end{lemma}

\begin{proof}
Clear from Lemmas
\ref{lemma-local-complete-intersection} and
\ref{lemma-syntomic-locally-standard-syntomic}
and the isomorphisms of local rings
$
\mathcal{O}_{X, x}/\mathfrak m_s \mathcal{O}_{X, x}
\cong
\mathcal{O}_{X_s, x}
$.
\end{proof}

\begin{lemma}
\label{lemma-set-points-where-fibres-lci}
Let $f : X \to S$ be a morphism of schemes.
Assume $f$ locally of finite type. Formation of the set
$$
T = \{x \in X \mid \mathcal{O}_{X_{f(x)}, x}
\text{ is a complete intersection over }\kappa(f(x))\}
$$
commutes with arbitrary base change:
For any morphism $g : S' \to S$, consider
the base change $f' : X' \to S'$ of $f$ and the
projection $g' : X' \to X$. Then the corresponding
set $T'$ for the morphism $f'$ is equal to $T' = (g')^{-1}(T)$.
In particular, if $f$ is assumed flat, and locally of finite
presentation then the same holds for the open set of points
where $f$ is syntomic.
\end{lemma}

\begin{proof}
Let $s' \in S'$ be a point, and let $s = g(s')$. Then we have
$$
X'_{s'} =
\text{Spec}(\kappa(s')) \times_{\text{Spec}(\kappa(s))} X_s
$$
In other words the fibres of the base change are the base changes
of the fibres. Hence the first part is equivalent to
Algebra, Lemma \ref{algebra-lemma-lci-field-change-local}.
The second part follows from the first because in that case
$T$ is the set of points where $f$ is syntomic according to
Lemma \ref{lemma-syntomic-locally-standard-syntomic}.
\end{proof}

\begin{lemma}
\label{lemma-standard-syntomic-relative-dimension}
Let $R$ be a ring.
Let $R \to A = R[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$ be a relative
global complete intersection. Set $S = \text{Spec}(R)$ and
$X = \text{Spec}(A)$. Consider the morphism
$f : X \to S$ associated to the ring map $R \to A$.
The function $x \mapsto \dim_x(X_{f(x)})$ is constant with value $n - c$.
\end{lemma}

\begin{proof}
By Algebra,
Definition \ref{algebra-definition-relative-global-complete-intersection}
$R \to A$ being a relative global complete intersection means
all nonzero fibre rings have dimension $n - c$.
Thus for a prime $\mathfrak p$ of $R$ the fibre ring 
$\kappa(\mathfrak p)[x_1, \ldots, x_n]/(\overline{f}_1, \ldots, \overline{f}_c)$
is either zero or a global complete intersection ring of dimension $n - c$.
By the discussion following
Algebra, Definition \ref{algebra-definition-lci-field}
this implies it is equidimensional of dimension $n - c$.
Whence the lemma.
\end{proof}

\begin{lemma}
\label{lemma-syntomic-relative-dimension}
Let $f : X \to S$ be a syntomic morphism. The function
$x \mapsto \dim_x(X_{f(x)})$ is locally constant on $X$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-syntomic-locally-standard-syntomic}
the morphism $f$ locally looks like a standard
syntomic morphism of affines. Hence the result follows
from Lemma \ref{lemma-standard-syntomic-relative-dimension}.
\end{proof}

\noindent
Lemma \ref{lemma-syntomic-relative-dimension}
says that the following definition makes sense.

\begin{definition}
\label{definition-syntomic-relative-dimension}
Let $d \geq 0$ be an integer. We say a morphism of schemes $f : X \to S$
is {\it syntomic of relative dimension $d$} if $f$ is syntomic and
the function $\dim_x(X_{f(x)}) = d$ for all $x \in X$.
\end{definition}

\noindent
In other words, $f$ is syntomic and the nonempty fibres are equidimensional
of dimension $d$.

\begin{lemma}
\label{lemma-syntomic-permanence}
Let
$$
\xymatrix{
X \ar[rr]_f \ar[rd]_p & &
Y \ar[dl]^q \\
& S
}
$$
be a commutative diagram of morphisms of schemes. Assume that
\begin{enumerate}
\item $f$ is surjective, and syntomic,
\item $p$ is syntomic, and
\item $q$ is locally of finite presentation\footnote{In fact this
is implied by (1) and (2), see
Descent, Lemma \ref{descent-lemma-flat-finitely-presented-permanence}.}.
\end{enumerate}
Then $q$ is syntomic.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-flat-permanence} we see that $q$ is flat.
Hence it suffices to show that the fibres of $Y \to S$ are
local complete intersections, see Lemma \ref{lemma-syntomic-flat-fibres}.
Let $s \in S$. Consider the morphism $X_s \to Y_s$.
This is a base change of the morphism $X \to Y$ and hence
surjective, and syntomic (Lemma \ref{lemma-base-change-syntomic}).
For the same reason $X_s$ is syntomic over $\kappa(s)$.
Moreover, $Y_s$ is locally of finite type over $\kappa(s)$
(Lemma \ref{lemma-base-change-finite-type}). In this way
we reduce to the case where $S$ is the spectrum of a field.

\medskip\noindent
Assume $S = \text{Spec}(k)$. Let $y \in Y$. Choose an affine
open $\text{Spec}(A) \subset Y$ neighbourhood of $y$. Let
$\text{Spec}(B) \subset X$ be an affine open such that
$f(\text{Spec}(B)) \subset \text{Spec}(A)$, containing
a point $x \in X$ such that $f(x) = y$. Choose a surjection
$k[x_1, \ldots, x_n] \to A$ with kernel $I$.
Choose a surjection $A[y_1, \ldots, y_m] \to B$, which gives
rise in turn to a surjection $k[x_i, y_j] \to B$ with kernel $J$.
Let $\mathfrak q \subset k[x_i, y_j]$ be the prime corresponding
to $y \in \text{Spec}(B)$ and let $\mathfrak p \subset k[x_i]$ the prime
corresponding to $x \in \text{Spec}(A)$.
Since $x$ maps to $y$ we have $\mathfrak p = \mathfrak q \cap k[x_i]$.
Consider the following commutative diagram of local rings:
$$
\xymatrix{
\mathcal{O}_{X, x} \ar@{=}[r] &
B_{\mathfrak q} &
k[x_1, \ldots, x_n, y_1, \ldots, y_m]_{\mathfrak q} \ar[l] \\
\mathcal{O}_{Y, y} \ar@{=}[r] \ar[u] & A_{\mathfrak p} \ar[u] &
k[x_1, \ldots, x_n]_{\mathfrak p} \ar[l] \ar[u]
}
$$
We claim that the hypotheses of
Algebra, Lemma \ref{algebra-lemma-lci-permanence-initial} are satisfied.
Conditions (1) and (2) are trivial. Condition (4) follows as
$X \to Y$ is flat. Condition (3) follows as the rings
$\mathcal{O}_{Y, y}$ and
$\mathcal{O}_{X_y, x} = \mathcal{O}_{X, x}/\mathfrak m_y\mathcal{O}_{X, x}$
are complete intersection rings by our assumptions that
$f$ and $p$ are syntomic, see
Lemma \ref{lemma-syntomic-locally-standard-syntomic}.
The output of Algebra, Lemma \ref{algebra-lemma-lci-permanence-initial}
is exactly that $\mathcal{O}_{Y, y}$ is a complete intersection
ring! Hence by Lemma \ref{lemma-syntomic-locally-standard-syntomic}
again we see that $Y$ is syntomic over $k$ at $y$ as desired.
\end{proof}









\section{Conormal sheaf of an immersion}
\label{section-conormal-sheaf}

\noindent
Let $i : Z \to X$ be a closed immersion. Let
$\mathcal{I} \subset \mathcal{O}_X$ be the corresponding quasi-coherent
sheaf of ideals. Consider the short exact sequence
$$
0 \to \mathcal{I}^2 \to \mathcal{I} \to \mathcal{I}/\mathcal{I}^2 \to 0
$$
of quasi-coherent sheaves on $X$. Since the sheaf $\mathcal{I}/\mathcal{I}^2$
is annihilated by $\mathcal{I}$ it corresponds to a sheaf on $Z$ by
Lemma \ref{lemma-i-star-equivalence}. This sheaf is often simply denoted
$\mathcal{I}/\mathcal{I}^2$ by the abuse of notation mentioned in
Section \ref{section-closed-immersions-quasi-coherent}.

\medskip\noindent
In case $i : Z \to X$ is a (locally closed) immersion we define the
conormal sheaf of $i$ as the conormal sheaf of the closed
immersion $i : Z \to X \setminus \partial Z$, where
$\partial Z = \overline{Z} \setminus Z$. It is often denoted
$\mathcal{I}/\mathcal{I}^2$ where $\mathcal{I}$ is the ideal sheaf
of the closed immersion $i : Z \to X \setminus \partial Z$.

\begin{definition}
\label{definition-conormal-sheaf}
Let $i : Z \to X$ be an immersion. The {\it conormal sheaf
$\mathcal{C}_{Z/X}$ of $Z$ in $X$} or the {\it conormal sheaf of $i$}
is the quasi-coherent $\mathcal{O}_Z$-module $\mathcal{I}/\mathcal{I}^2$
described above.
\end{definition}

\noindent
In \cite[IV Definition 16.1.2]{EGA} this sheaf is denoted
$\mathcal{N}_{Z/X}$. We will not follow this convention since we would
like to reserve the notation $\mathcal{N}_{Z/X}$
for the {\it normal sheaf of the immersion}. It is defined as
$$
\mathcal{N}_{Z/X} =
\textit{Hom}_{\mathcal{O}_Z}(\mathcal{C}_{Z/X}, \mathcal{O}_Z) =
\textit{Hom}_{\mathcal{O}_Z}(\mathcal{I}/\mathcal{I}^2, \mathcal{O}_Z)
$$
provided the conormal sheaf is of finite presentation (otherwise the
normal sheaf may not even be quasi-coherent). We will come back to the
normal sheaf later (insert future reference here).

\begin{lemma}
\label{lemma-affine-conormal}
Let $i : Z \to X$ be an immersion. The conormal sheaf
of $i$ has the following properties:
\begin{enumerate}
\item Let $U \subset X$ be any open such that $i(Z)$ is
a closed subset of $U$. Let $\mathcal{I} \subset \mathcal{O}_U$
be the sheaf of ideals corresponding to the closed subscheme
$i(Z) \subset U$. Then
$$
\mathcal{C}_{Z/X} = i^*\mathcal{I} = i^{-1}(\mathcal{I}/\mathcal{I}^2)
$$
\item
For any affine open $\text{Spec}(R) = U \subset X$
such that $Z \cap U = \text{Spec}(R/I)$ there is a
canonical isomorphism
$\Gamma(Z \cap U, \mathcal{C}_{Z/X}) = I/I^2$.
\end{enumerate}
\end{lemma}

\begin{proof}
Mostly clear from the definitions. Note that given a ring $R$ and
an ideal $I$ of $R$ we have $I/I^2 = I \otimes_R R/I$. Details omitted.
\end{proof}

\begin{lemma}
\label{lemma-conormal-functorial}
Let
$$
\xymatrix{
Z \ar[r]_i \ar[d]_f & X \ar[d]^g \\
Z' \ar[r]^{i'} & X'
}
$$
be a commutative diagram in the category of schemes.
Assume $i$, $i'$ immersions. There is a canonical map
of $\mathcal{O}_Z$-modules
$$
f^*\mathcal{C}_{Z'/X'}
\longrightarrow
\mathcal{C}_{Z/X}
$$
characterized by the following property: For every pair of affine opens
$(\text{Spec}(R) = U \subset X, \text{Spec}(R') = U' \subset X')$ with
$f(U) \subset U'$ such that
$Z \cap U = \text{Spec}(R/I)$ and $Z' \cap U' = \text{Spec}(R'/I')$
the induced map
$$
\Gamma(Z' \cap U', \mathcal{C}_{Z'/X'}) = I'/I'^2
\longrightarrow
I/I^2 = \Gamma(Z \cap U, \mathcal{C}_{Z/X})
$$
is the one induced by the ring map $f^\sharp : R' \to R$ which
has the property $f^\sharp(I') \subset I$.
\end{lemma}

\begin{proof}
Let $\partial Z' = \overline{Z'} \setminus Z'$ and
$\partial Z = \overline{Z} \setminus Z$. These are closed subsets of $X'$ and
of $X$. Replacing $X'$ by $X' \setminus \partial Z'$ and $X$ by
$X \setminus \big(g^{-1}(\partial Z') \cup \partial Z\big)$ we
see that we may assume that $i$ and $i'$ are closed immersions.

\medskip\noindent
The fact that $g \circ i$ factors through $i'$ implies that
$g^*\mathcal{I}'$ maps into $\mathcal{I}$ under the canonical
map $g^*\mathcal{I}' \to \mathcal{O}_X$, see
Schemes, Lemmas
\ref{schemes-lemma-characterize-closed-subspace} and
\ref{schemes-lemma-restrict-map-to-closed}.
Hence we get an induced map of quasi-coherent sheaves
$g^*(\mathcal{I}'/(\mathcal{I}')^2) \to \mathcal{I}/\mathcal{I}^2$.
Pulling back by $i$ gives
$i^*g^*(\mathcal{I}'/(\mathcal{I}')^2) \to i^*(\mathcal{I}/\mathcal{I}^2)$.
Note that $i^*(\mathcal{I}/\mathcal{I}^2) = \mathcal{C}_{Z/X}$.
On the other hand,
$i^*g^*(\mathcal{I}'/(\mathcal{I}')^2) =
f^*(i')^*(\mathcal{I}'/(\mathcal{I}')^2) = f^*\mathcal{C}_{Z'/X'}$.
This gives the desired map.

\medskip\noindent
Checking that the map is locally described as the given map
$I'/(I')^2 \to I/I^2$ is a matter of unwinding the definitions
and is omitted. Another observation is that given any
$x \in i(Z)$ there do exist affine open neighbourhoods $U$, $U'$
with $f(U) \subset U'$ and $Z \cap U$ as well as $U' \cap Z'$
closed such that $x \in U$. Proof omitted. Hence the requirement
of the lemma indeed characterizes the map (and could have been used
to define it).
\end{proof}

\begin{lemma}
\label{lemma-conormal-functorial-flat}
Let
$$
\xymatrix{
Z \ar[r]_i \ar[d]_f & X \ar[d]^g \\
Z' \ar[r]^{i'} & X'
}
$$
be a fibre product diagram in the category of schemes with
$i$, $i'$ immersions. Then the canonical map
$f^*\mathcal{C}_{Z'/X'} \to \mathcal{C}_{Z/X}$ of
Lemma \ref{lemma-conormal-functorial}
is surjective. If $g$ is flat, then it is an isomorphism.
\end{lemma}

\begin{proof}
Let $R' \to R$ be a ring map, and $I' \subset R'$ an ideal.
Set $I = I'R$. Then $I'/(I')^2 \otimes_{R'} R \to I/I^2$ is
surjective. If $R' \to R$ is flat, then $I = I' \otimes_{R'} R$
and $I^2 = (I')^2 \otimes_{R'} R$ and we see the map is an
isomorphism.
\end{proof}









\section{Sheaf of differentials of a morphism}
\label{section-sheaf-differentials}

\noindent
We suggest the reader take a look at the corresponding section
in the chapter on commutative algebra
(Algebra, Section \ref{algebra-section-differentials}).

\begin{definition}
\label{definition-derivation}
Let $f : X \to S$ be a morphism of schemes. Let $\mathcal{F}$
be an $\mathcal{O}_X$-module. A {\it derivation} or more precisely
an {\it $S$-derivation} into $\mathcal{F}$ is a map
$D : \mathcal{O}_X \to \mathcal{F}$ which is additive, annihilates
the image of $f^{-1}\mathcal{O}_S \to \mathcal{O}_X$, and satisfies the
{\it Leibniz rule}
$$
D(ab) = aD(b) + D(a)b
$$
for all $a, b$ local sections of $\mathcal{O}_X$
(wherever they are both defined). We denote
$$
\text{Der}_S(\mathcal{O}_X, \mathcal{F})
$$
the set of $S$-derivations into $\mathcal{F}$.
\end{definition}

\noindent
This is the sheaf theoretic analogue of
Algebra, Definition \ref{definition-derivation}.
Given a derivation $D : \mathcal{O}_X \to \mathcal{F}$
as in the definition the map on global sections
$$
D : \Gamma(X, \mathcal{O}_X) \longrightarrow \Gamma(X, \mathcal{F})
$$
clearly is a $\Gamma(S, \mathcal{O}_S)$-derivation as in
the algebra definition.

\begin{lemma}
\label{lemma-affine-case-derivation}
Let $R \to A$ be a ring map. Let $\mathcal{F}$
be a sheaf of $\mathcal{O}_X$-modules
on $X = \text{Spec}(A)$. Set $S = \text{Spec}(R)$.
The rule which associates to an $S$-derivation on $\mathcal{F}$
its action on global sections defines a bijection between
the set of $S$-derivations of $\mathcal{F}$ and the set of
$R$-derivations on $M = \Gamma(X, \mathcal{F})$.
\end{lemma}

\begin{proof}
Let $D : A \to M$ be an $R$-derivation. We have to show there exists
a unique $S$-derivation on $\mathcal{F}$ which gives rise to
$D$ on global sections. Let $U = D(f) \subset X$ be a standard affine open.
Any element of $\Gamma(U, \mathcal{O}_X)$ is of the form
$a/f^n$ for some $a \in A$ and $n \geq 0$. By the Leibniz rule
we have
$$
D(a)|_U = a/f^n D(f^n)|_U + f^n D(a/f^n)
$$
in $\Gamma(U, \mathcal{F})$. Since $f$ acts invertibly
on $\Gamma(U, \mathcal{F})$ this completely determines
the value of $D(a/f^n) \in \Gamma(U, \mathcal{F})$.
This proves uniqueness. Existence follows by simply defining
$$
D(a/f^n) := (1/f^n) D(a)|_U - a/f^{2n} D(f^n)|_U
$$
and proving this has all the desired properties (on the basis
of standard opens of $X$). Details omitted.
\end{proof}

\noindent
Here is a particular situation where derivations come up
naturally.

\begin{lemma}
\label{lemma-double-structure-gives-derivation}
Let $f : X \to S$ be a morphism of schemes.
Consider a short exact sequence
$$
0 \to \mathcal{F} \to \mathcal{A} \to \mathcal{O}_X \to 0
$$
Here $\mathcal{A}$ is a sheaf of $f^{-1}\mathcal{O}_S$-algebras,
$\pi : \mathcal{A} \to \mathcal{O}_X$ is a surjection
of sheaves of $f^{-1}\mathcal{O}_S$-algebras, and
$\mathcal{F} = \text{Ker}(\pi)$ is its kernel. Assume $\mathcal{F}$ an ideal
sheaf with square zero in $\mathcal{A}$. So $\mathcal{F}$
has a natural structure of an $\mathcal{O}_X$-module.
A section $s : \mathcal{O}_X \to \mathcal{A}$ of $\pi$
is a $f^{-1}\mathcal{O}_S$-algebra map such that $\pi \circ s = \text{id}$.
Given any section $s : \mathcal{O}_X \to \mathcal{F}$
of $\pi$ and any $S$-derivation $D : \mathcal{O}_X \to \mathcal{F}$
the map
$$
s + D : \mathcal{O}_X \to \mathcal{A}
$$
is a section of $\pi$ and every section $s'$ is of the form $s + D$
for a unique $S$-derivation $D$.
\end{lemma}

\begin{proof}
Recall that the $\mathcal{O}_X$-module structure on $\mathcal{F}$
is given by $h \tau = \tilde h \tau$ (multiplication in $\mathcal{A}$)
where $h$ is a local section of $\mathcal{O}_X$, and
$\tilde h$ is a local lift of $h$ to a local
section of $\mathcal{A}$, and $\tau$ is a local section of $\mathcal{F}$.
In particular, given $s$, we may use $\tilde h = s(h)$.
To verify that $s + D$ is a homomorphism of sheaves of rings we
compute
\begin{eqnarray*}
(s + D)(ab) & = & s(ab) + D(ab) \\
& = & s(a)s(b) + aD(b) + D(a)b \\
& = & s(a) s(b) + s(a)D(b) + D(a)s(b) \\
& = & (s(a) + D(a))(s(b) + D(b))
\end{eqnarray*}
by the Leibniz rule. In the same manner one shows
$s + D$ is a $f^{-1}\mathcal{O}_S$-algebra
map because $D$ is an $S$-derivation. Conversely, given $s'$ we set
$D = s' - s$. Details omitted.
\end{proof}

\noindent
Let $f : X \to S$ be a morphism of schemes.
We now esthablish the existence of a couple of ``global'' sheaves
and maps of sheaves, and in the next paragraph we describe
the constructions over some affine opens.

\medskip\noindent
Recall that $\Delta = \Delta_{X/S} : X \to X \times_S X$
is an immersion, see Schemes, Lemma \ref{schemes-lemma-diagonal-immersion}.
Let $\mathcal{J}$ be the ideal sheaf of the immersion.
It lives over any open subscheme $U$ of $X \times_S X$
such that $\Delta(X) \subset U$ is closed. For example the one from
the proof of the lemma just cited;
if $f$ is separated then we can take $U = X \times_S X$.
Note that the sheaf of rings $\mathcal{O}_U/\mathcal{J}^2$
is supported on $\Delta(X)$. Moreover it sits in a
short exact sequence of sheaves
$$
0 \to \mathcal{J}/\mathcal{J}^2
\to \mathcal{O}_U/\mathcal{J}^2
\to \Delta_*\mathcal{O}_X
\to 0.
$$
Using $\Delta^{-1}$ we can think of this as a surjection of
sheaves of $f^{-1}\mathcal{O}_S$-algebras with kernel the
conormal sheaf of $\Delta$ (see Definition \ref{definition-conormal-sheaf}
and Lemma \ref{lemma-affine-conormal}).
$$
0 \to \mathcal{C}_{X/X\times_SX}
\to \Delta^{-1}(\mathcal{O}_U/\mathcal{J}^2)
\to \mathcal{O}_X
\to 0
$$
This places us in the sitation of
Lemma \ref{lemma-double-structure-gives-derivation}.
The projection morphisms $p_i : X \times_S X \to X$, $i = 1, 2$ induce
maps of sheaves of rings
$p_i^\sharp : p_i^{-1}\mathcal{O}_X \to \mathcal{O}_{X\times_S X}$.
We may restrict to $U$ and divide by $\mathcal{J}^2$ to get
$p_i^{-1}\mathcal{O}_X \to \mathcal{O}_U/\mathcal{J}^2$.
Since $\Delta^{-1}p_i^{-1}\mathcal{O}_X = \mathcal{O}_X$
we get maps
$$
s_i : \mathcal{O}_X \to \Delta^{-1}(\mathcal{O}_U/\mathcal{J}^2).
$$
Both $s_1$ and $s_2$ are sections to the map
$\Delta^{-1}(\mathcal{O}_U/\mathcal{J}^2) \to \mathcal{O}_X$,
as in Lemma \ref{lemma-double-structure-gives-derivation}.
Thus we get an $S$-derivation
$\text{d} = s_2 - s_1 : \mathcal{O}_X \to \mathcal{C}_{X/X\times_SX}$.

\medskip\noindent
Let us work this out on a suitable affine open.
We can cover $X$ by affine opens $\text{Spec}(A) = W \subset X$
whose image is contained in an affine open $\text{Spec}(R) = V \subset S$.
According to the proof of Schemes, Lemma \ref{schemes-lemma-diagonal-immersion}
$W \times_V W \subset X \times_S X$ is an affine open
contained in the open $U$ mentioned above. Also
$W \times_V W = \text{Spec}(A \otimes_R A)$.
The sheaf $\mathcal{J}$ corresponds to the ideal
$J = \text{Ker}(A \otimes_R A \to A)$.
The short exact sequence to the short exact sequence
of $A \otimes_R A$-modules
$$
0 \to J/J^2 \to (A \otimes_R A)/J^2 \to A \to 0
$$
The sections $s_i$ correspond to the ring maps
$$
A \longrightarrow (A \otimes_R A)/J^2, \ \ 
s_1 : a \mapsto a \otimes 1, \ \ 
s_2 : a \mapsto 1 \otimes a.
$$
By Lemma \ref{lemma-affine-conormal} the conormal sheaf
of $\Delta_{X/S}$ restricted
to $U \times_V U$ is the quasi-coherent sheaf associated to the
$A$-module $J/J^2$. Comparing with
Algebra, Lemma \ref{algebra-lemma-differentials-diagonal}
(or by a direct computation)
we see that the induced map $\text{d} : A \to J/J^2$
is isomorphic to the universal $R$-derivation on $A$.
Thus the following definition makes sense.

\begin{definition}
\label{definition-sheaf-differentials}
Let $f : X \to S$ be a morphism of schemes.
\begin{enumerate}
\item The {\it sheaf of differentials $\Omega_{X/S}$ of $X$ over $S$} is
the conormal sheaf of the immersion $\Delta_{X/S} : X \to X \times_S X$,
see Definition \ref{definition-conormal-sheaf}.
\item The {\it universal $S$-derivation} is the $S$-derivation
$$
\text{d}_{X/S} : \mathcal{O}_X \longrightarrow \Omega_{X/S}
$$
which maps a local section $f$ of $\mathcal{O}_X$ to the class of
the local section $\text{d}(f) = \text{d}_{X/S}(f) = s_2(f) - s_1(f)$ with
$s_2$ and $s_1$ as described above.
\end{enumerate}
\end{definition}

\noindent
Here is the universal property of the universal derivation.
If you have any other construction of the sheaf of relative differentials
which satisfies this universal property then, by the Yoneda lemma,
it will be canonically isomorphic to the one defined above.

\begin{lemma}
\label{lemma-universal-derivation-universal}
Let $f : X \to S$ be a morphism of schemes.
The map
$$
\text{Hom}_{\mathcal{O}_X}(\Omega_{X/S}, \mathcal{F})
\longrightarrow
\text{Der}_S(\mathcal{O}_X, \mathcal{F}), \ \ 
\alpha
\longmapsto
\alpha \circ \text{d}_{X/S}
$$
is an isomorphism of functors
from the category of $\mathcal{O}_X$-modules
to the category of sets.
\end{lemma}

\begin{proof}
Let $\mathcal{F}$ be an $\mathcal{O}_X$-module.
Let $D \in \text{Der}_S(\mathcal{O}_X, \mathcal{F})$.
We have to show there exists a unique $\mathcal{O}_X$-linear
map $\alpha : \Omega_{X/S} \to \mathcal{F}$ such that
$D = \alpha \circ \text{d}_{X/S}$.

\medskip\noindent
We claim that the image of $\text{d}_{X/S} : \mathcal{O}_X \to \Omega_{X/S}$
generates $\Omega_{X/S}$ as an $\mathcal{O}_X$-module. To see this it
suffices to prove this is true on suitable affine opens.
We can cover $X$ by affine opens $\text{Spec}(A) = W \subset X$
whose image is contained in an affine open $\text{Spec}(R) = V \subset S$.
As seen in the discussion leading up to
Definition \ref{definition-sheaf-differentials}
we have
$$
\Omega_{X/S}|_W = \widetilde{J/J^2}
$$
with $J = \text{Ker}(A \otimes_R A \to A)$. Now clearly $J$ is generated
by the elements $1 \otimes f - f \otimes 1$. Hence the claim follows.
This claim implies immediately that $\alpha$, if it exists, is unique.

\medskip\noindent
Next, we come to existence of $\alpha$. Note that the construction of
the pair $(\Omega_{X/S}, \text{d}_{X/S})$ commutes with restriction
to open subschemes (in both $X$ and $S$). Proof omitted. By the uniqueness
just shown, it therefore suffices to prove existence in case both
$X$ and $S$ are affine. Thus we may write $X = \text{Spec}(A)$,
$S = \text{Spec}(S)$ and $M = \Gamma(X, \mathcal{F})$.
Set as usual $J = \text{Ker}(A \otimes_R A \to A)$ so that
$\Omega_{X/S} = \widetilde{J/J^2}$.
According to Algebra, Lemmas \ref{algebra-lemma-universal-omega} and
\ref{algebra-lemma-differentials-diagonal}
there exists a unique $A$-linear map
$\alpha' : J/J^2 \to M$ such that the composition
$\text{d} \circ \alpha' : A \to J/J^2 \to M$
is equal to the action of $D$ on global sections over $X$.
By Schemes, Lemma \ref{schemes-lemma-compare-constructions} the $A$-linear map
$\alpha'$ corresponds to a map
$\alpha : \Omega_{X/S} = \widetilde{J/J^2} \to \mathcal{F}$.
Then the derivations $\alpha \circ \text{d}_{X/S}$ and $D$
have the same effect on global sections and hence agree
by Lemma \ref{lemma-affine-case-derivation}.
This proves existence and we win.
\end{proof}

\begin{lemma}
\label{lemma-differentials-restrict-open}
Let $f : X \to S$ be a morphism of schemes.
Let $U \subset X$, $V \subset S$ be open subschemes such
that $f(U) \subset V$. Then there is a unique isomorphism
$\Omega_{X/S}|_U = \Omega_{U/V}$ of $\mathcal{O}_U$-modules such that
$\text{d}_{X/S}|_U = \text{d}_{U/V}$.
\end{lemma}

\begin{proof}
The existence of the isomorphism is clear from the construction
of $\Omega_{X/S}$. Uniqueness comes from the fact, seen in
the proof of Lemma \ref{lemma-universal-derivation-universal},
that the image of $\text{d}_{X/S} : \mathcal{O}_X \to \Omega_{X/S}$ generates
$\Omega_{X/S}$ as an $\mathcal{O}_X$-module.
\end{proof}

\noindent
From now on we will use these canonical identifications and simply
write $\Omega_{U/S}$ or $\Omega_{U/V}$ for the restriction of
$\Omega_{X/S}$ to $U$.

\begin{lemma}
\label{lemma-differentials-affine}
Let $f : X \to S$ be a morphism of schemes.
For any pair of affine opens $\text{Spec}(A) = U \subset X$,
$\text{Spec}(R) = V \subset S$ with $f(U) \subset V$ there is
a unique isomorphism
$$
\Gamma(U, \mathcal{O}_{X/S}) =
\Omega_{A/R}.
$$
compatible with $\text{d}_{X/S}$ and $\text{d} : A \to \Omega_{A/R}$.
\end{lemma}

\begin{proof}
During the construction of $\Omega_{X/S}$ we have seen that
the restriction of $\Omega_{X/S}$ to $U$ is isomorphic to the quasi-coherent
sheaf associated to the $A$-module $J/J^2$ where
$J = \text{Ker}(A \otimes_R A \to A)$. Hence the result follows from
Algebra, Lemma \ref{algebra-lemma-differentials-diagonal}.

\medskip\noindent
An alternative proof is to show that the $A$-module
$M = \Gamma(U, \Omega_{X/S}) = \Gamma(U, \Omega_{U/V})$
together with $\text{d}_{X/S} = \text{d}_{U/V} : A \to M$
is a universal $R$-derivation of $A$. This follows by combining
Lemmas \ref{lemma-affine-case-derivation}
and \ref{lemma-universal-derivation-universal} above.
The universal property of
$\text{d} : A \to \Omega_{A/R}$
(see Algebra, Lemma \ref{algebra-lemma-universal-omega})
and the Yoneda lemma
(Categories, Lemma \ref{categories-lemma-yoneda})
imply there is a unique isomorphism of $A$-modules
$M \cong \Omega_{A/R}$ compatible with derivations.
This gives the second proof.
\end{proof}

\begin{remark}
\label{remark-differentials-glue}
The lemma above gives a second way of constructing the module of
differentials. Namely, let $f : X \to S$ be a morphism of schemes.
Consider the collection of all affine opens $U \subset X$ which
map into an affine open of $S$. These form a basis for the topology
on $X$. Thus it suffices to define $\Gamma(U, \Omega_{X/S})$
for such $U$. We simply set $\Gamma(U, \Omega_{X/S}) = \Omega_{A/R}$ if
$A$, $R$ are as in Lemma \ref{lemma-differentials-affine} above.
This works, but it takes somewhat more algebraic preliminaries
to construct the restriction mappings and to verify the sheaf
condition with this ansatz.
\end{remark}

\begin{lemma}
\label{lemma-functoriality-differentials}
Let
$$
\xymatrix{
X' \ar[d] \ar[r]_f & X \ar[d] \\
S' \ar[r] & S
}
$$
be a commutative diagram of schemes. The canonical map
$\mathcal{O}_X \to f_*\mathcal{O}_{X'}$ composed with the map
$f_*\text{d}_{X'/S'} : f_*\mathcal{O}_{X'} \to f_*\Omega_{X'/S'}$ is a
$S$-derivation. Hence we obtain a canonical map of $\mathcal{O}_X$-modules
$\Omega_{X/S} \to f_*\Omega_{X'/S'}$, and by
adjointness of $f_*$ and $f^*$ a
canonical $\mathcal{O}_{X'}$-module homomorphism
$$
c_f : f^*\Omega_{X/S} \longrightarrow \Omega_{X'/S'}.
$$
It is uniquely characterized by the property that
$f^*\text{d}_{X/S}(h)$ mapsto $\text{d}_{X'/S'}(f^* h)$
for any local section $h$ of $\mathcal{O}_X$.
\end{lemma}

\begin{proof}
Everything but the last assertion of the lemma is proven in the lemma;
the universal property of $\Omega_{X/S}$ is
Lemma \ref{lemma-universal-derivation-universal}.
The last assertion means that $c_f$ is the unique $\mathcal{O}_{X'}$-linear
map such that whenever $U \subset X$ is open and $h \in \mathcal{O}_X(U)$,
then the pullback $f^*h \in \mathcal{O}_{X'}(f^{-1}U)$ of $h$ satisfies
$\text{d}_{X'/S'}(f^*h) = c_f(f^*\text{d}_{X/S}(h))$. We omit the proof.
We can also use the functoriality of the conormal sheaves
(see Lemma \ref{lemma-conormal-functorial}) to define $c_f$.
Or we can use the characterization in the last line of the lemma to
glue maps defined on affine patches
(see Algebra, Equation (\ref{algebra-equation-functorial-omega})).
\end{proof}

\begin{lemma}
\label{lemma-check-functoriality-differentials}
Let
$$
\xymatrix{
X'' \ar[d] \ar[r]_g & X' \ar[d] \ar[r]_f & X \ar[d] \\
S'' \ar[r] & S' \ar[r] & S
}
$$
be a commutative diagram of schemes. Then we have
$$
c_{f \circ g} = c_g \circ g^* c_f
$$
as maps $(f \circ g)^*\Omega_{X/S} \to \Omega_{X''/S''}$.
\end{lemma}

\begin{proof}
Omitted. One way to see this is to restrict to affine opens.
\end{proof}

\begin{lemma}
\label{lemma-triangle-differentials}
Let $f : X \to Y$, $g : Y \to S$ be morphisms of schemes.
Then there is a canonical exact sequence
$$
f^*\Omega_{Y/S} \to \Omega_{X/S} \to \Omega_{X/Y} \to 0
$$
where the maps come from applications of
Lemma \ref{lemma-functoriality-differentials}.
\end{lemma}

\begin{proof}
This is the sheafified version of
Algebra, Lemma \ref{algebra-lemma-exact-sequence-differentials}.
\end{proof}

\begin{lemma}
\label{lemma-immersion-differentials}
If $X \to S$ is an immersion, or more generally a monomorphism, then
$\Omega_{X/S}$ is zero.
\end{lemma}

\begin{proof}
This is true because $\Delta_{X/S}$ is an isomorphism in this case
and hence has trivial conormal sheaf. The algebraic version is
Algebra, Lemma \ref{algebra-lemma-trivial-differential-surjective}.
\end{proof}

\begin{lemma}
\label{lemma-differentials-relative-immersion}
Let $i : Z \to X$ be an immersion of schemes over $S$.
There is a canonical exact sequence
$$
\mathcal{C}_{Z/X} \to i^*\Omega_{X/S} \to \Omega_{Z/S} \to 0
$$
where the first arrow is induced by $\text{d}_{X/S}$
and the second arrow comes from Lemma \ref{lemma-functoriality-differentials}.
\end{lemma}

\begin{proof}
This is the sheafified version of
Algebra, Lemma \ref{algebra-lemma-differential-seq}. However
we should make sure we can define the first arrow globally.
Hence we explain the meaning of ``induced by $\text{d}_{X/S}$'' here.
Namely, we may assume that $i$ is a closed immersion by
shrinking $X$. Let $\mathcal{I} \subset \mathcal{O}_X$
be the sheaf of ideals corresponding to $Z \subset X$.
Then $\text{d}_{X/S} : \mathcal{I} \to \Omega_{X/S}$
maps the subsheaf $\mathcal{I}^2 \subset \mathcal{I}$ to
$\mathcal{I}\Omega_{X/S}$. Hence it induces a map
$\mathcal{I}/\mathcal{I}^2 \to \Omega_{X/S}/\mathcal{I}\Omega_{X/S}$
which is $\mathcal{O}_X/\mathcal{I}$-linear.
By Lemma \ref{lemma-i-star-equivalence} this corresponds to a map
$\mathcal{C}_{Z/X} \to i^*\Omega_{X/S}$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-differentials-relative-immersion-section}
Let $i : Z \to X$ be an immersion of schemes over $S$, and
assume $i$ (locally) has a left inverse. Then the canonical
sequence
$$
0 \to \mathcal{C}_{Z/X} \to i^*\Omega_{X/S} \to \Omega_{Z/S} \to 0
$$
of
Lemma \ref{lemma-differentials-relative-immersion}
is (locally) split exact. In particular, if $s : S \to X$ is a section
then the map $\mathcal{C}_{S/X} \to s^*\Omega_{X/S}$ induced by
$\text{d}_{X/S}$ is an isomorphism.
\end{lemma}

\begin{proof}
Follows from
Algebra, Lemma \ref{algebra-lemma-differential-seq-split}.
Clarification: if $g : X \to Z$ is a left inverse of $i$, then
$i^*c_g$ is a right inverse of the map $i^*\Omega_{X/S} \to \Omega_{Z/S}$.
Also, if $s$ is a section, then it is an immersion $s : Z = S \to X$
over $S$ (see
Schemes, Lemma \ref{schemes-lemma-section-immersion})
and in that case $\Omega_{Z/S} = 0$.
\end{proof}

\begin{lemma}
\label{lemma-base-change-differentials}
Let $X \to S$ be a morphism of schemes.
Let $g : S' \to S$ be a morphism of schemes.
Let $X' = X_{S'}$ be the base change of $X$.
Denote $g' : X' \to X$ the projection.
Then the map
$$
(g')^*\Omega_{X/S} \to \Omega_{X'/S'}
$$
of Lemma \ref{lemma-functoriality-differentials} is an isomorphism.
\end{lemma}

\begin{proof}
This is the sheafified version of
Algebra, Lemma \ref{algebra-lemma-differentials-base-change}.
\end{proof}

\begin{lemma}
\label{lemma-differential-product}
Let $f : X \to S$ and $g : Y \to S$ be morphisms of schemes with the same
target. Let $p : X \times_S Y \to X$ and $q : X \times_S Y \to Y$ be the
projection morphisms. The maps from
Lemma \ref{lemma-functoriality-differentials}
$$
p^*\Omega_{X/S} \oplus q^*\Omega_{Y/S}
\longrightarrow
\Omega_{X \times_S Y/S}
$$
give an isomorphism.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-base-change-differentials} the composition
$p^*\Omega_{X/S} \to \Omega_{X \times_S Y/S} \to \Omega_{X \times_S Y/Y}$
is an isomorphism, and similarly for $q$. Moreover, the cokernel
of $p^*\Omega_{X/S} \to \Omega_{X \times_S Y/S}$ is
$\Omega_{X \times_S Y/X}$ by
Lemma \ref{lemma-triangle-differentials}. The result follows.
\end{proof}





\begin{lemma}
\label{lemma-finite-type-differentials}
Let $f : X \to S$ be a morphism of schemes.
If $f$ is locally of finite type, then $\Omega_{X/S}$ is
a finite type $\mathcal{O}_X$-module.
\end{lemma}

\begin{proof}
Immediate from
Algebra, Lemma \ref{algebra-lemma-differentials-finitely-generated},
Lemma \ref{lemma-differentials-affine},
Lemma \ref{lemma-locally-finite-type-characterize}, and
Properties, Lemma \ref{properties-lemma-finite-type-module}.
\end{proof}

\begin{lemma}
\label{lemma-finite-presentation-differentials}
Let $f : X \to S$ be a morphism of schemes.
If $f$ is locally of finite type, then $\Omega_{X/S}$ is
an $\mathcal{O}_X$-module of finite presentation.
\end{lemma}

\begin{proof}
Immediate from
Algebra, Lemma \ref{algebra-lemma-differentials-finitely-presented},
Lemma \ref{lemma-differentials-affine},
Lemma \ref{lemma-locally-finite-presentation-characterize}, and
Properties, Lemma \ref{properties-lemma-finite-presentation-module}.
\end{proof}










\section{Smooth morphisms}
\label{section-smooth}

\noindent
Let $f : X \to Y$ be a map of topological spaces. Consider the following
condition:
\begin{list}{(*)}{}
\item For every $x \in X$ there exist open neighbourhoods
$x \in U \subset X$ and $f(x) \in V \subset Y$, and an integer $d$
such that $f(U) = V$ and such that there is an isomorphism
$$
\xymatrix{
V \times B_d(0, 1) \ar[r]^-{\cong} \ar[d] & U \ar[r] \ar[d] & X \ar[d] \\
V \ar@{=}[r] & V \ar[r] & Y
}
$$
where $B_d(0, 1) \subset \mathbf{R}^d$ is a ball of radius $1$ around $0$.
\end{list}
Smooth morphisms are the analogue of such morphisms in the category
of schemes. See Lemma \ref{lemma-smooth-locally-standard-smooth}
and (insert future reference here about
etale over affine space).

\medskip\noindent
Contrary to expectations (perhaps) the notion
of a smooth ring map is not defined solely in terms
of the module of differentials. Namely, recall that
$R \to A$ is a {\it smooth ring map} if $A$ is of finite presentation over $R$
and if the naive cotangent complex of $A$ over $R$ is quasi-isomorphic
to a projective module placed in degree $0$.

\begin{definition}
\label{definition-smooth}
Let $f : X \to S$ be a morphism of schemes.
\begin{enumerate}
\item We say that $f$ is {\it smooth at $x \in X$} if
there exists a affine open neighbourhood $\text{Spec}(A) = U \subset X$
of $x$ and and affine open $\text{Spec}(R) = V \subset S$
with $f(U) \subset V$ such that the induced ring map
$R \to A$ is smooth, see Algebra, Definition \ref{algebra-definition-smooth}.
\item We say that $f$ is {\it smooth} if it is smooth at every point of $X$.
\item A morphism of affine schemes $f : X \to S$
is called {\it standard smooth} there exists a standard smooth ring
map $R \to R[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$ (see
Algebra, Definition \ref{algebra-definition-standard-smooth})
such that $X \to S$ is isomorphic to
$$
\text{Spec}(R[x_1, \ldots, x_n]/(f_1, \ldots, f_c)) \to \text{Spec}(R).
$$
\end{enumerate}
\end{definition}

\noindent
A pleasing feature of this definition is that the set of points
where a morphism is smooth is automatically open.

\medskip\noindent
Note that there is no separation or quasi-compactness hypotheses in the
definition. Hence the question of being smooth is local in nature on
the source. Here is the precise result.

\begin{lemma}
\label{lemma-smooth-characterize}
Let $f : X \to S$ be a morphism of schemes.
The following are equivalent
\begin{enumerate}
\item The morphism $f$ is smooth.
\item For every affine opens $U \subset X$, $V \subset S$
with $f(U) \subset V$ the ring map
$\mathcal{O}_S(V) \to \mathcal{O}_X(U)$ is smooth.
\item There exists an open covering $S = \bigcup_{j \in J} V_j$
and open coverings $f^{-1}(V_j) = \bigcup_{i \in I_j} U_i$ such
that each of the morphisms $U_i \to V_j$, $j\in J, i\in I_j$
is smooth.
\item There exists an affine open covering $S = \bigcup_{j \in J} V_j$
and affine open coverings $f^{-1}(V_j) = \bigcup_{i \in I_j} U_i$ such
that the ring map $\mathcal{O}_S(V_j) \to \mathcal{O}_X(U_i)$ is
smooth, for all $j\in J, i\in I_j$.
\end{enumerate}
Moreover, if $f$ is smooth then for
any open subschemes $U \subset X$, $V \subset S$ with $f(U) \subset V$
the restriction $f|_U : U \to V$ is smooth.
\end{lemma}

\begin{proof}
This follows from Lemma \ref{lemma-locally-P} if we show that
the property ``$R \to A$ is smooth'' is local.
We check conditions (a), (b) and (c) of Definition
\ref{definition-property-local}.
By Algebra, Lemma \ref{algebra-lemma-base-change-smooth}
being smooth is stable under base change and hence
we conclude (a) holds. By
Algebra, Lemma \ref{algebra-lemma-compose-smooth}
being smooth is stable under composition and for any ring
$R$ the ring map $R \to R_f$ is (standard) smooth.
We conclude (b) holds. Finally, property (c) is true
according to Algebra, Lemma \ref{algebra-lemma-locally-smooth}.
\end{proof}


\noindent
The following lemma characterizes a smooth morphism as a
flat, finitely presented morphism with smooth fibres.

\begin{lemma}
\label{lemma-smooth-flat-smooth-fibres}
Let $f : X \to S$ be a morphism of schemes.
If $f$ is flat, locally of finite presentation, and all
fibres $X_s$ are smooth, then $f$
is smooth.
\end{lemma}

\begin{proof}
Follows from Algebra, Lemma \ref{algebra-lemma-flat-fibre-smooth}.
\end{proof}


\begin{lemma}
\label{lemma-composition-smooth}
The composition of two morphisms which are smooth is smooth.
\end{lemma}

\begin{proof}
In the proof of Lemma \ref{lemma-smooth-characterize}
we saw that being smooth is a local property of ring maps.
Hence the first statement of the lemma follows from
Lemma \ref{lemma-composition-type-P} combined
with the fact that being smooth is a property of ring maps that is
stable under composition, see
Algebra, Lemma \ref{algebra-lemma-compose-smooth}.
\end{proof}

\begin{lemma}
\label{lemma-base-change-smooth}
The base change of a morphism which is smooth is smooth.
\end{lemma}

\begin{proof}
In the proof of Lemma \ref{lemma-smooth-characterize}
we saw that being smooth is a local property of ring maps.
Hence the lemma follows from
Lemma \ref{lemma-composition-type-P} combined
with the fact that being smooth is a property of ring maps that is
stable under base change, see
Algebra, Lemma \ref{algebra-lemma-base-change-smooth}.
\end{proof}

\begin{lemma}
\label{lemma-open-immersion-smooth}
Any open immersion is smooth.
\end{lemma}

\begin{proof}
This is true because an open immersion is a local isomorphism.
\end{proof}

\begin{lemma}
\label{lemma-smooth-syntomic}
A smooth morphism is syntomic.
\end{lemma}

\begin{proof}
See Algebra, Lemma \ref{algebra-lemma-smooth-syntomic}.
\end{proof}

\begin{lemma}
\label{lemma-smooth-locally-finite-presentation}
A smooth morphism is locally of finite presentation.
\end{lemma}

\begin{proof}
True because a smooth ring map is of finite presentation by
definition.
\end{proof}

\begin{lemma}
\label{lemma-smooth-flat}
A smooth morphism is flat.
\end{lemma}

\begin{proof}
Combine Lemmas \ref{lemma-syntomic-flat} and \ref{lemma-smooth-syntomic}.
\end{proof}

\noindent
The following lemma says locally any smooth morphism is standard smooth.
Hence we can use standard smooth morphisms as a {\it local model}
for a smooth morphism.

\begin{lemma}
\label{lemma-smooth-locally-standard-smooth}
Let $f : X  \to S$ be a morphism of schemes.
Let $x \in X$ be a point.
Set $s = f(x)$.
The following are equivalent
\begin{enumerate}
\item The morphism $f$ is smooth at $x$.
\item There exist affine opens $U \subset X$,
and $V \subset S$ such that $x \in U$, $f(U) \subset V$ and the
induced morphism $f|_U : U \to V$ is standard smooth.
\end{enumerate}
\end{lemma}

\begin{proof}
Follows from the definitions and
Algebra, Lemmas \ref{algebra-lemma-standard-smooth}
and \ref{algebra-lemma-smooth-syntomic}.
\end{proof}

\begin{lemma}
\label{lemma-smooth-omega-finite-locally-free}
Let $f : X \to S$ be a morphism of schemes.
Assume $f$ is smooth.
Then the module of differentials $\Omega_{X/S}$ of $X$ over $S$
is finite locally free and
$$
\text{rank}_x(\Omega_{X/S}) = \dim_x(X_{f(x)})
$$
for every $x \in X$.
\end{lemma}

\begin{proof}
The statement is local on $X$ and $S$.
By Lemma \ref{lemma-smooth-locally-standard-smooth}
above we may assume that $f$ is a standard smooth morphism of affines.
In this case the result follows from
Algebra, Lemma \ref{algebra-lemma-standard-smooth}
(and the definition of a relative global complete intersection, see
Algebra,
Definition \ref{algebra-definition-relative-global-complete-intersection}).
\end{proof}

\noindent
Lemma \ref{lemma-smooth-omega-finite-locally-free}
says that the following definition makes sense.

\begin{definition}
\label{definition-smooth-relative-dimension}
Let $d \geq 0$ be an integer. We say a morphism of schemes $f : X \to S$
is {\it smooth of relative dimension $d$} if $f$ is smooth and
$\Omega_{X/S}$ is finite locally free of constant rank $d$.
\end{definition}

\noindent
In other words, $f$ is smooth and the nonempty fibres are equidimensional
of dimension $d$. By Lemma \ref{lemma-smooth-at-point} below this is also
the same as requiring: (a) $f$ is locally of finite presentation, (b) $f$ is
flat, (c) all nonempty fibres equidimensional of dimension $d$, and (d)
$\Omega_{X/S}$ finite locally free of rank $d$. It is not enough to simply
assume that $f$ is flat, of finite presentation, and $\Omega_{X/S}$ is
finite locally free of rank $d$. A counter example is given by
$\text{Spec}(\mathbf{F}_p[t]) \to \text{Spec}(\mathbf{F}_p[t^p])$.

\medskip\noindent
Here is a differential criterion of smoothness at a point.
There are many variants of this result
all of which may be useful at some point. We will just add them
here as needed.

\begin{lemma}
\label{lemma-smooth-at-point}
Let $f : X \to S$ be a morphism of schemes.
Let $x \in X$.
Set $s = f(x)$.
Assume $f$ is locally of finite presentation.
The following are equivalent:
\begin{enumerate}
\item The morphism $f$ is smooth at $x$.
\item The local ring map $\mathcal{O}_{S, s} \to \mathcal{O}_{X, x}$
is flat and the $\mathcal{O}_{X, x}$-module $\Omega_{X/S, x}$
can be generated by at most $\dim_x(X_{f(x)})$ elements.
\item The local ring map $\mathcal{O}_{S, s} \to \mathcal{O}_{X, x}$
is flat and the $\kappa(x)$-vector space
$$
\Omega_{X_s/s, x} \otimes_{\mathcal{O}_{X_s, x}} \kappa(x) =
\Omega_{X/S, x} \otimes_{\mathcal{O}_{X, x}} \kappa(x)
$$
can be generated by at most $\dim_x(X_{f(x)})$ elements.
\item There exist affine opens $U \subset X$,
and $V \subset S$ such that $x \in U$, $f(U) \subset V$ and the
induced morphism $f|_U : U \to V$ is standard smooth.
\item There exist affine opens $\text{Spec}(A) = U \subset X$
and $\text{Spec}(R) = V \subset S$ with $x \in U$ corresponding
to $\mathfrak q \subset A$, and $f(U) \subset V$
such that there exists a presentation
$$
A = R[x_1, \ldots, x_n]/(f_1, \ldots, f_c)
$$
with
$$
g =
\det
\left(
\begin{matrix}
\partial f_1/\partial x_1 &
\partial f_2/\partial x_1 &
\ldots &
\partial f_c/\partial x_1 \\
\partial f_1/\partial x_2 &
\partial f_2/\partial x_2 &
\ldots &
\partial f_c/\partial x_2 \\
\ldots & \ldots & \ldots & \ldots \\
\partial f_1/\partial x_c &
\partial f_2/\partial x_c &
\ldots &
\partial f_c/\partial x_c
\end{matrix}
\right)
$$
mapping to an element of $A$ not in $\mathfrak q$.
\end{enumerate}
\end{lemma}

\begin{proof}
Note that if $f$ is smooth at $x$, then we see from Lemma
\ref{lemma-smooth-locally-standard-smooth} that (4) holds, and (5) is a slightly
weakened version of (4). Moreover, this implies that the ring
map $\mathcal{O}_{S, s} \to \mathcal{O}_{X, x}$ is flat (see
Lemma \ref{lemma-smooth-flat}) and that $\Omega_{X/S}$ is
finite locally free of rank equal to
$\dim_x(X_s)$ (see Lemma \ref{lemma-smooth-omega-finite-locally-free}).
This implies (2) and (3).

\medskip\noindent
By Lemma \ref{lemma-base-change-differentials}
the module of differentials $\Omega_{X_s/s}$ of the fibre $X_s$
over $\kappa(s)$ is the pullback of the module of differentials
$\Omega_{X/S}$ of $X$ over $S$. Hence the displayed equality in
part (3) of the lemma. By Lemma \ref{lemma-finite-type-differentials}
these modules are of finite type. Hence the mimimal number of
generators of the modules
$\Omega_{X/S, x}$ and $\Omega_{X_s/s, x}$ is the same and equal to the
dimension of this $\kappa(x)$-vector space by Nakayama's Lemma
(Algebra, Lemma \ref{algebra-lemma-NAK}). This in particular shows that
(2) and (3) are equivalent.

\medskip\noindent
Combining Algebra, Lemmas \ref{algebra-lemma-flat-fibre-smooth} and
\ref{algebra-lemma-characterize-smooth-over-field} shows that
(2) and (3) imply (1). Finally, (5) implies (4) see for example
Algebra, Example \ref{algebra-example-make-standard-smooth}.
\end{proof}

\begin{lemma}
\label{lemma-set-points-where-fibres-smooth}
Let $f : X \to S$ be a morphism of schemes.
Assume $f$ locally of finite type. Formation of the set
$$
T = \{x \in X \mid
X_{f(x)}\text{ is smooth over }\kappa(f(x))\text{ at }x\}
$$
commutes with arbitrary base change:
For any morphism $g : S' \to S$, consider
the base change $f' : X' \to S'$ of $f$ and the
projection $g' : X' \to X$. Then the corresponding
set $T'$ for the morphism $f'$ is equal to $T' = (g')^{-1}(T)$.
In particular, if $f$ is assumed flat, and locally of finite
presentation then the same holds for the open set of points
where $f$ is smooth.
\end{lemma}

\begin{proof}
Let $s' \in S'$ be a point, and let $s = g(s')$. Then we have
$$
X'_{s'} =
\text{Spec}(\kappa(s')) \times_{\text{Spec}(\kappa(s))} X_s
$$
In other words the fibres of the base change are the base changes
of the fibres. Hence the first part is equivalent to
Algebra, Lemma \ref{algebra-lemma-smooth-field-change-local}.
The second part follows from the first because in that case
$T$ is the (open) set of points where $f$ is smooth according to
Lemma \ref{lemma-smooth-flat-smooth-fibres}.
\end{proof}

\noindent
Here is a lemma that actually uses the vanishing of $H^{-1}$
of the naive cotangent complex for a smooth ring map.

\begin{lemma}
\label{lemma-triangle-differentials-smooth}
Let $f : X \to Y$, $g : Y \to S$ be morphisms of schemes.
Assume $f$ is smooth. Then
$$
0 \to f^*\Omega_{Y/S} \to \Omega_{X/S} \to \Omega_{X/Y} \to 0
$$
(see Lemma \ref{lemma-triangle-differentials}) is short exact.
\end{lemma}

\begin{proof}
The algebraic version of this lemma is the following:
Given ring maps $A \to B \to C$ with $A \to B$ of finite
type and $B \to C$ smooth, then the sequence
$$
0 \to C \otimes_B \Omega_{B/A} \to \Omega_{C/A} \to \Omega_{C/B} \to 0
$$
of Algebra, Lemma \ref{algebra-lemma-exact-sequence-differentials} is exact.
This is
Algebra, Lemma \ref{algebra-lemma-triangle-differentials-smooth}.
\end{proof}

\begin{lemma}
\label{lemma-smooth-permanence}
Let
$$
\xymatrix{
X \ar[rr]_f \ar[rd]_p & &
Y \ar[dl]^q \\
& S
}
$$
be a commutative diagram of morphisms of schemes. Assume that
\begin{enumerate}
\item $f$ is surjective, and smooth,
\item $p$ is smooth, and
\item $q$ is locally of finite presentation\footnote{In fact this
is implied by (1) and (2), see
Descent, Lemma \ref{descent-lemma-flat-finitely-presented-permanence}.}.
\end{enumerate}
Then $q$ is smooth.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-flat-permanence} we see that $q$ is flat.
Pick a point $y \in Y$. Pick a point $x \in X$ mapping to $y$.
Suppose $f$ has relative dimension $a$ at $x$ and $p$ has relative
dimension $b$ at $x$. By Lemma \ref{lemma-smooth-omega-finite-locally-free}
this means that $\Omega_{X/S, x}$ is free of rank $b$ and $\Omega_{X/Y, x}$
is free of rank $a$. By the short exact sequence
of Lemma \ref{lemma-triangle-differentials-smooth}
this means that $(f^*\Omega_{Y/S})_x$ is free
of rank $b - a$. By Nakayama's Lemma this implies that
$\Omega_{Y/S, y}$ can be generated by $b - a$ elements.
Also, by Lemma \ref{lemma-dimension-fibre-at-a-point-additive} we see that
$\dim_y(Y_s) = b - a$. Hence we conclude that
$Y \to S$ is smooth at $y$ by Lemma \ref{lemma-smooth-at-point} part (2).
\end{proof}
















\section{Unramified morphisms}
\label{section-unramified}

\noindent
We briefly discuss unramified morphisms before the (perhaps) more interesting
class of etale morphisms. Recall that a ring map $R \to A$ is {\it unramified}
if it is of finite type and $\Omega_{A/R} = 0$ (this is the definition
of \cite{Henselian}). A ring map $R \to A$ is called {\it G-unramified} if it
is of finite presentation and $\Omega_{A/R} = 0$ (this is the definition of
\cite{EGA}).

\begin{definition}
\label{definition-unramified}
Let $f : X \to S$ be a morphism of schemes.
\begin{enumerate}
\item We say that $f$ is {\it unramified at $x \in X$} if
there exists a affine open neighbourhood $\text{Spec}(A) = U \subset X$
of $x$ and and affine open $\text{Spec}(R) = V \subset S$
with $f(U) \subset V$ such that the induced ring map
$R \to A$ is unramified, see
Algebra, Definition \ref{algebra-definition-unramified}.
\item We say that $f$ is {\it G-unramified at $x \in X$} if
there exists a affine open neighbourhood $\text{Spec}(A) = U \subset X$
of $x$ and and affine open $\text{Spec}(R) = V \subset S$
with $f(U) \subset V$ such that the induced ring map
$R \to A$ is G-unramified, see
Algebra, Definition \ref{algebra-definition-unramified}.
\item We say that $f$ is {\it unramified} if it is unramified
at every point of $X$.
\item We say that $f$ is {\it G-unramified} if it is G-unramified
at every point of $X$.
\end{enumerate}
\end{definition}

\noindent
Note that a G-unramified morphism is unramified. Hence any result for
unramified morphisms implies the corresponding result for G-unramified
morphisms. Moreover, if $S$ is locally Noetherian then there is no difference
between G-unramified and unramified morphisms, see
Lemma \ref{lemma-noetherian-unramfied}.
A pleasing feature of this definition is that the set of points
where a morphism is unramified (resp.\ G-unramified) is automatically open.

\begin{lemma}
\label{lemma-unramified-omega-zero}
Let $f : X \to S$ be a morphism of schemes. Then
\begin{enumerate}
\item $f$ is unramified if and only if $f$ is locally of finite type
and $\Omega_{X/S} = 0$, and
\item $f$ is G-unramified if and only if $f$ is locally of finite presentation
and $\Omega_{X/S} = 0$.
\end{enumerate}
\end{lemma}

\begin{proof}
By definition a ring map $R \to A$ is unramified (resp.\ G-unramified)
if and only if it is of finite type (resp.\ finite presentation)
and $\Omega_{A/R} = 0$. Hence the lemma follows
directly from the definitions and Lemma \ref{lemma-differentials-affine}.
\end{proof}

\medskip\noindent
Note that there is no separation or quasi-compactness hypotheses in the
definition. Hence the question of being unramified is local in nature on
the source. Here is the precise result.

\begin{lemma}
\label{lemma-unramified-characterize}
Let $f : X \to S$ be a morphism of schemes.
The following are equivalent
\begin{enumerate}
\item The morphism $f$ is unramified (resp.\ G-unramified).
\item For every affine opens $U \subset X$, $V \subset S$
with $f(U) \subset V$ the ring map
$\mathcal{O}_S(V) \to \mathcal{O}_X(U)$ is unramified (resp.\ G-unramified).
\item There exists an open covering $S = \bigcup_{j \in J} V_j$
and open coverings $f^{-1}(V_j) = \bigcup_{i \in I_j} U_i$ such
that each of the morphisms $U_i \to V_j$, $j\in J, i\in I_j$
is unramified (resp.\ G-unramified).
\item There exists an affine open covering $S = \bigcup_{j \in J} V_j$
and affine open coverings $f^{-1}(V_j) = \bigcup_{i \in I_j} U_i$ such
that the ring map $\mathcal{O}_S(V_j) \to \mathcal{O}_X(U_i)$ is
unramified (resp.\ G-unramified), for all $j\in J, i\in I_j$.
\end{enumerate}
Moreover, if $f$ is unramified (resp.\ G-unramified) then for
any open subschemes $U \subset X$, $V \subset S$ with $f(U) \subset V$
the restriction $f|_U : U \to V$ is unramified (resp.\ G-unramified).
\end{lemma}

\begin{proof}
This follows from Lemma \ref{lemma-locally-P} if we show that
the property ``$R \to A$ is unramified'' is local.
We check conditions (a), (b) and (c) of Definition
\ref{definition-property-local}.
These properties are proved in
Algebra, Lemma \ref{algebra-lemma-unramified}.
\end{proof}

\begin{lemma}
\label{lemma-composition-unramified}
The composition of two morphisms which are unramified is unramified.
The same holds for G-unramified morphisms.
\end{lemma}

\begin{proof}
The proof of Lemma \ref{lemma-unramified-characterize}
shows that being unramified (resp.\ G-unramified)
is a local property of ring maps.
Hence the first statement of the lemma follows from
Lemma \ref{lemma-composition-type-P} combined
with the fact that being unramified (resp.\ G-unramified)
is a property of ring maps that is stable under composition, see
Algebra, Lemma \ref{algebra-lemma-unramified}.
\end{proof}

\begin{lemma}
\label{lemma-base-change-unramified}
The base change of a morphism which is unramified is unramified.
The same holds for G-unramified morphisms.
\end{lemma}

\begin{proof}
The proof of Lemma \ref{lemma-unramified-characterize}
shows that being unramified (resp.\ G-unramified)
is a local property of ring maps. Hence the lemma follows from
Lemma \ref{lemma-composition-type-P} combined
with the fact that being unramified (resp.\ G-unramified)
is a property of ring maps that is stable under base change, see
Algebra, Lemma \ref{algebra-lemma-unramified}.
\end{proof}

\begin{lemma}
\label{lemma-noetherian-unramfied}
Let $f : X \to S$ be a morphism of schemes. Assume $S$ is locally Noetherian.
The $f$ is unramified if and only if $f$ is G-unramified.
\end{lemma}

\begin{proof}
Follows from the definitions and
Lemma \ref{lemma-noetherian-finite-type-finite-presentation}.
\end{proof}


\begin{lemma}
\label{lemma-open-immersion-unramified}
Any open immersion is G-unramified.
\end{lemma}

\begin{proof}
This is true because an open immersion is a local isomorphism.
\end{proof}

\begin{lemma}
\label{lemma-closed-immersion-unramified}
A closed immersion $i : Z \to X$ is unramified.
It is G-unramified if and only if the associated quasi-coherent sheaf of
ideals $\mathcal{I} = \text{Ker}(\mathcal{O}_X \to i_*\mathcal{O}_Z)$
is of finite type (as an $\mathcal{O}_X$-module).
\end{lemma}

\begin{proof}
Follows from Lemma \ref{lemma-closed-immersion-finite-presentation} and
Algebra, Lemma \ref{algebra-lemma-unramified}.
\end{proof}

\begin{lemma}
\label{lemma-unramified-locally-finite-type}
An unramified morphism is locally of finite type.
A G-unramified morphism is locally of finite presentation.
\end{lemma}

\begin{proof}
An unramified ring map is of finite type by definition.
A G-unramified ring map is of finite presentation by definition.
\end{proof}

\begin{lemma}
\label{lemma-unramified-quasi-finite}
Let $f : X \to S$ be a morphism of schemes.
If $f$ is unramified at $x$ then $f$ is quasi-finite at $x$.
In particular, an unramified morphism is locally quasi-finite.
\end{lemma}

\begin{proof}
See Algebra, Lemma \ref{algebra-lemma-unramified-quasi-finite}.
\end{proof}

\begin{lemma}
\label{lemma-unramified-over-field}
Fibres of unramified morphisms.
\begin{enumerate}
\item Let $X$ be a scheme over a field $k$.
The structure morphism $X \to \text{Spec}(k)$ is unramified if
and only if $X$ is a disjoint union of spectra of finite separable
field extensions of $k$.
\item If $f : X \to S$ is an unramified morphism then for every $s \in S$
the fibre $X_s$ is a disjoint union of spectra of finite separable field
extensions of $\kappa(s)$.
\end{enumerate}
\end{lemma}

\begin{proof}
Part (2) follows from part (1) and
Lemma \ref{lemma-base-change-unramified}.
Let us prove part (1).
We first use Algebra, Lemma \ref{algebra-lemma-characterize-unramified}.
This lemma implies that if $X$ is a disjoint union of spectra of finite
separable field extensions of $k$ then $X \to \text{Spec}(k)$ is unramified.
Conversely, suppose that $X \to \text{Spec}(k)$ is unramified.
By Algebra, Lemma \ref{algebra-lemma-unramified-at-prime} for every $x \in X$
the residue field extension $k \subset \kappa(x)$ is
finite separable. Hence all points of $X$ are closed points (see
Lemma \ref{lemma-algebraic-residue-field-extension-closed-point-fibre}
for example). Thus $X$ is a discrete space, in particular the disjoint union
of the spectra of its local rings. By
Algebra, Lemma \ref{algebra-lemma-unramified-at-prime} again these
local rings are fields, and we win.
\end{proof}

\noindent
The following lemma characterizes an unramified morphisms as
morphisms locally of finite type with unramified fibres.

\begin{lemma}
\label{lemma-unramfied-etale-fibres}
Let $f : X \to S$ be a morphism of schemes.
\begin{enumerate}
\item If $f$ is unramified then for any $x \in X$ the field extension
$\kappa(f(x)) \subset \kappa(x)$ is finite separable.
\item If $f$ is locally of finite type, and for every
$s \in S$ the fibre $X_s$ is a disjoint union of spectra of finite separable
field extensions of $\kappa(s)$ then $f$ is unramified.
\item If $f$ is locally of finite presentation, and for every
$s \in S$ the fibre $X_s$ is a disjoint union of spectra of finite separable
field extensions of $\kappa(s)$ then $f$ is G-unramified.
\end{enumerate}
\end{lemma}

\begin{proof}
Follows from Algebra, Lemmas
\ref{algebra-lemma-unramified-at-prime} and
\ref{algebra-lemma-characterize-unramified}.
\end{proof}

\noindent
Here is a characterization of unramified morphisms in terms of the
diagonal morphism.

\begin{lemma}
\label{lemma-diagonal-unramfied-morphism}
Let $f : X \to S$ be a morphism.
\begin{enumerate}
\item If $f$ is unramified, then the diagonal morphism
$\Delta : X \to X \times_S X$ is an open immersion.
\item If $f$ is locally of finite type
and $\Delta$ is an open immersion, then $f$ is unramified.
\item If $f$ is locally of finite presentation and $\Delta$ is an open
immersion, then $f$ is G-unramified.
\end{enumerate}
\end{lemma}

\begin{proof}
The first statement follows from
Algebra, Lemma \ref{algebra-lemma-diagonal-unramified}.
The second statement from the fact that $\Omega_{X/S}$
(see Definition \ref{definition-sheaf-differentials})
is the conormal sheaf of the diagonal morphism and hence
clearly zero if $\Delta$ is an open immersion.
\end{proof}

\begin{lemma}
\label{lemma-unramified-at-point}
Let $f : X \to S$ be a morphism of schemes.
Let $x \in X$.
Set $s = f(x)$.
Assume $f$ is locally of finite type (resp.\ locally of finite presentation).
The following are equivalent:
\begin{enumerate}
\item The morphism $f$ is unramified (resp.\ G-unramified) at $x$.
\item The fibre $X_s$ is unramfied over $\kappa(s)$ at $x$.
\item The $\mathcal{O}_{X, x}$-module $\Omega_{X/S, x}$ is zero.
\item The $\mathcal{O}_{X_s, x}$-module $\Omega_{X_s/s, x}$ is zero.
\item The $\kappa(x)$-vector space
$$
\Omega_{X_s/s, x} \otimes_{\mathcal{O}_{X_s, x}} \kappa(x) =
\Omega_{X/S, x} \otimes_{\mathcal{O}_{X, x}} \kappa(x)
$$
is zero.
\item We have $\mathfrak m_s\mathcal{O}_{X, x} = \mathfrak m_x$
and the field extension $\kappa(s) \subset \kappa(x)$ is finite
separable.
\end{enumerate}
\end{lemma}

\begin{proof}
Note that if $f$ is unramified at $x$, then
we see that $\Omega_{X/S} = 0$ in a neighbourhood of $x$
by the definitions and the results on modules of differentials
in Section \ref{section-sheaf-differentials}. Hence (1) implies
(3) and the vanishing of the right hand vector space in (5).
It also implies (2) because by
Lemma \ref{lemma-base-change-differentials}
the module of differentials $\Omega_{X_s/s}$ of the fibre $X_s$
over $\kappa(s)$ is the pullback of the module of differentials
$\Omega_{X/S}$ of $X$ over $S$. This fact on modules of differentials
also implies the displayed equality of vector spaces in part (4). By
Lemma \ref{lemma-finite-type-differentials}
the modules $\Omega_{X/S, x}$ and $\Omega_{X_s/s, x}$ are of finite type.
Hence he modules $\Omega_{X/S, x}$ and $\Omega_{X_s/s, x}$ are zero if and only
if the corresponding $\kappa(x)$-vector space in (4) is zero by
Nakayama's Lemma (Algebra, Lemma \ref{algebra-lemma-NAK}).
This in particular shows that (3), (4) and (5) are equivalent.
The support of $\Omega_{X/S}$ is closed in $X$, see
Modules, Lemma \ref{modules-lemma-support-finite-type-closed}.
Assumption (3) implies that $x$ is not in the support.
Hence $\Omega_{X/S}$ is zero in a neighbourhood of $x$, which
implies (1). The equivalence of (1) and (3) applied to $X_s \to s$
implies the equivalence of (2) and (4).
At this point we have seen that (1) -- (5) are equivalent.

\medskip\noindent
Alternatively you can use Algebra, Lemma \ref{algebra-lemma-unramified}
to see the equivalence of (1) -- (5) more directly.

\medskip\noindent
The equivalence of (1) and (6) follows from Lemma
\ref{lemma-unramfied-etale-fibres}.
It also follows more directly from
Algebra, Lemmas \ref{algebra-lemma-unramified-at-prime} and
\ref{algebra-lemma-characterize-unramified}.
\end{proof}

\begin{lemma}
\label{lemma-set-points-where-fibres-unramified}
Let $f : X \to S$ be a morphism of schemes.
Assume $f$ locally of finite type. Formation of the open set
\begin{align*}
T
& =
\{x \in X \mid X_{f(x)}\text{ is unramified over }\kappa(f(x))\text{ at }x\} \\
& =
\{x \in X \mid X\text{ is unramified over }S\text{ at }x\}
\end{align*}
commutes with arbitrary base change:
For any morphism $g : S' \to S$, consider
the base change $f' : X' \to S'$ of $f$ and the
projection $g' : X' \to X$. Then the corresponding
set $T'$ for the morphism $f'$ is equal to $T' = (g')^{-1}(T)$.
If $f$ is assumed locally of finite presentation then the same holds
for the open set of points where $f$ is G-unramified.
\end{lemma}

\begin{proof}
Let $s' \in S'$ be a point, and let $s = g(s')$. Then we have
$$
X'_{s'} =
\text{Spec}(\kappa(s')) \times_{\text{Spec}(\kappa(s))} X_s
$$
In other words the fibres of the base change are the base changes
of the fibres. In particular
$$
\Omega_{X_s/s, x} \otimes_{\mathcal{O}_{X_s, x}} \kappa(x')
=
\Omega_{X'_{s'}/s', x'} \otimes_{\mathcal{O}_{X'_{s'}, x'}} \kappa(x')
$$
see
Lemma \ref{lemma-base-change-differentials}.
Whence $x' \in T'$ if and only if $x \in T$ by
Lemma \ref{lemma-unramified-at-point}.
The second part follows from the first because in that case
$T$ is the (open) set of points where $f$ is G-unramified according to
Lemma \ref{lemma-unramified-at-point}.
\end{proof}

\begin{lemma}
\label{lemma-unramified-permanence}
Let $f : X \to Y$ be a morphism of schemes over $S$.
\begin{enumerate}
\item If $X$ is unramified over $S$, then $f$ is unramified.
\item If $X$ is G-unramified over $S$ and $Y$ of finite type over $S$, then
$f$ is G-unramified.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume that $X$ is unramified over $S$.
By Lemma \ref{lemma-permanence-finite-type} we see that $f$
is locally of finite type.
By assumption we have $\Omega_{X/S} = 0$. Hence
$\Omega_{X/Y} = 0$ by Lemma \ref{lemma-triangle-differentials}. Thus
$f$ is unramified. If $X$ is G-unramfied over $S$ and $Y$ of finite type
over $S$, then by
Lemma \ref{lemma-finite-presentation-permanence}
we see that $f$ is locally of finite presentation and we conclude
that $f$ is G-unramified.
\end{proof}

\begin{lemma}
\label{lemma-value-at-one-point}
Let $S$ be a scheme.
Let $X$, $Y$ be schemes over $S$.
Let $f, g : X \to Y$ be morphisms over $S$. Let $x \in X$.
Assume that
\begin{enumerate}
\item the structure morphism $Y \to S$ is unramified,
\item $f(x) = g(x)$ in $Y$, say $y = f(x) = g(x)$, and
\item the induced maps $f^\sharp, g^\sharp : \kappa(y) \to \kappa(x)$
are equal.
\end{enumerate}
Then there exists an open neighbourhood of $x$ in $X$ on which
$f$ and $g$ are equal.
\end{lemma}

\begin{proof}
Consider the morphism $(f, g) : X \to Y \times_S Y$. By assumption (1) and
Lemma \ref{lemma-diagonal-unramfied-morphism}
the inverse image of $\Delta_{Y/S}(Y)$ is open in $X$.
And assumptions (2) and (3) imply that $x$ is in this open subset.
\end{proof}










\section{Etale morphisms}
\label{section-etale}

\noindent
The Zariski topology of a scheme is a very coarse topology.
This is particularly clear when looking at varieties over $\mathbf{C}$.
It turns out that declaring an etale morphism to be the analogue of a
local isomorphism in topology introduces a much finer topology. On
varieties over $\mathbf{C}$ this topology gives rise to the ``correct'' betti
numbers when computing cohomology with finite coefficients. Another
observable is that if $f : X \to Y$ is an etale morphism of varieties over
$\mathbf{C}$, and if $x$ is a closed point of $X$, then 
$f$ induces an isomorphism
$\mathcal{O}^{\wedge}_{Y, f(x)} \to \mathcal{O}^{\wedge}_{X, x}$
of complete local rings.

\medskip\noindent
In this section we start our study of these matters. In fact we deliberately
restrict our discussion to a minimum since we will discuss more interesting
results elsewhere. Recall that a ring map $R \to A$ is said to be {\it etale}
if it is smooth and $\Omega_{A/R} = 0$.

\begin{definition}
\label{definition-etale}
Let $f : X \to S$ be a morphism of schemes.
\begin{enumerate}
\item We say that $f$ is {\it etale at $x \in X$} if
there exists a affine open neighbourhood $\text{Spec}(A) = U \subset X$
of $x$ and and affine open $\text{Spec}(R) = V \subset S$
with $f(U) \subset V$ such that the induced ring map
$R \to A$ is etale, see Algebra, Definition \ref{algebra-definition-etale}.
\item We say that $f$ is {\it etale} if it is etale at every point of $X$.
\item A morphism of affine schemes $f : X \to S$
is called {\it standard etale} there exists a standard etale ring
map $R \to R[x]_g/(f)$ (see
Algebra, Definition \ref{algebra-definition-standard-etale}; note that
$f$ is monic and $f'$ invertible in $R[x]_g$)
such that $X \to S$ is isomorphic to
$$
\text{Spec}(R[x]_g/(f)) \to \text{Spec}(R).
$$
\end{enumerate}
\end{definition}

\noindent
A morphism is etale if and only if it is smooth of relative dimension $0$
(see Definition \ref{definition-smooth-relative-dimension}).
A pleasing feature of the definition is that the set of points
where a morphism is etale is automatically open.

\medskip\noindent
Note that there is no separation or quasi-compactness hypotheses in the
definition. Hence the question of being etale is local in nature on
the source. Here is the precise result.

\begin{lemma}
\label{lemma-etale-characterize}
Let $f : X \to S$ be a morphism of schemes.
The following are equivalent
\begin{enumerate}
\item The morphism $f$ is etale.
\item For every affine opens $U \subset X$, $V \subset S$
with $f(U) \subset V$ the ring map
$\mathcal{O}_S(V) \to \mathcal{O}_X(U)$ is etale.
\item There exists an open covering $S = \bigcup_{j \in J} V_j$
and open coverings $f^{-1}(V_j) = \bigcup_{i \in I_j} U_i$ such
that each of the morphisms $U_i \to V_j$, $j\in J, i\in I_j$
is etale.
\item There exists an affine open covering $S = \bigcup_{j \in J} V_j$
and affine open coverings $f^{-1}(V_j) = \bigcup_{i \in I_j} U_i$ such
that the ring map $\mathcal{O}_S(V_j) \to \mathcal{O}_X(U_i)$ is
etale, for all $j\in J, i\in I_j$.
\end{enumerate}
Moreover, if $f$ is etale then for
any open subschemes $U \subset X$, $V \subset S$ with $f(U) \subset V$
the restriction $f|_U : U \to V$ is etale.
\end{lemma}

\begin{proof}
This follows from Lemma \ref{lemma-locally-P} if we show that
the property ``$R \to A$ is etale'' is local.
We check conditions (a), (b) and (c) of Definition
\ref{definition-property-local}.
These all follow from Algebra, Lemma \ref{algebra-lemma-etale}.
\end{proof}

\begin{lemma}
\label{lemma-composition-etale}
The composition of two morphisms which are etale is etale.
\end{lemma}

\begin{proof}
In the proof of Lemma \ref{lemma-etale-characterize}
we saw that being etale is a local property of ring maps.
Hence the first statement of the lemma follows from
Lemma \ref{lemma-composition-type-P} combined
with the fact that being etale is a property of ring maps that is
stable under composition, see
Algebra, Lemma \ref{algebra-lemma-etale}.
\end{proof}

\begin{lemma}
\label{lemma-base-change-etale}
The base change of a morphism which is etale is etale.
\end{lemma}

\begin{proof}
In the proof of Lemma \ref{lemma-etale-characterize}
we saw that being etale is a local property of ring maps.
Hence the lemma follows from
Lemma \ref{lemma-composition-type-P} combined
with the fact that being etale is a property of ring maps that is
stable under base change, see
Algebra, Lemma \ref{algebra-lemma-etale}.
\end{proof}

\begin{lemma}
\label{lemma-etale-smooth-unramified}
Let $f : X \to S$ be a morphism of schemes.
Let $x \in X$. Then $f$ is etale at $x$ if and only if $f$ is
smooth and unramified at $x$.
\end{lemma}

\begin{proof}
This follows immediately from the definitions.
\end{proof}

\begin{lemma}
\label{lemma-etale-locally-quasi-finite}
An etale morphism is locally quasi-finite.
\end{lemma}

\begin{proof}
By
Lemma \ref{lemma-etale-smooth-unramified}
an etale morphism is unramified. By
Lemma \ref{lemma-unramified-quasi-finite}
an unramified morphism is locally quasi-finite.
\end{proof}

\begin{lemma}
\label{lemma-etale-over-field}
Fibres of etale morphisms.
\begin{enumerate}
\item Let $X$ be a scheme over a field $k$.
The structure morphism $X \to \text{Spec}(k)$ is etale if
and only if $X$ is a disjoint union of spectra of finite separable
field extensions of $k$.
\item If $f : X \to S$ is an etale morphism, then for every $s \in S$ the
fibre $X_s$ is a disjoint union of spectra of finite separable field
extensions of $\kappa(s)$.
\end{enumerate}
\end{lemma}

\begin{proof}
You can deduce this from Lemma \ref{lemma-unramified-over-field}
via Lemma \ref{lemma-etale-smooth-unramified} above.
Here is a direct proof.

\medskip\noindent
We will use Algebra, Lemma \ref{algebra-lemma-etale-over-field}.
Hence it is clear that if $X$ is a disjoint union of spectra of finite
separable field extensions of $k$ then $X \to \text{Spec}(k)$ is etale.
Conversely, suppose that $X \to \text{Spec}(k)$ is etale. Then for any affine
open $U \subset X$ we see that $U$ is a finite disjoint union of spectra
of finite separable field extensions of $k$. Hence all points of $X$
are closed points (see
Lemma \ref{lemma-algebraic-residue-field-extension-closed-point-fibre}
for example). Thus $X$ is a discrete space and we win.
\end{proof}

\noindent
The following lemma characterizes an etale morphism as a
flat, finitely presented morphism with ``etale fibres''.

\begin{lemma}
\label{lemma-etale-flat-etale-fibres}
Let $f : X \to S$ be a morphism of schemes.
If $f$ is flat, locally of finite presentation, and for every $s \in S$
the fibre $X_s$ is a disjoint union of spectra of finite separable
field extensions of $\kappa(s)$, then $f$ is etale.
\end{lemma}

\begin{proof}
You can deduce this easily from
Algebra, Lemma \ref{algebra-lemma-characterize-etale}.
Here is another proof.

\medskip\noindent
By Lemma \ref{lemma-etale-over-field} a fibre $X_s$ is etale
and hence smooth over $s$. By Lemma \ref{lemma-smooth-flat-smooth-fibres}
we see that $X \to S$ is smooth.
By Lemma \ref{lemma-unramfied-etale-fibres}
we see that $f$ is unramified. We conclude by
Lemma \ref{lemma-etale-smooth-unramified}.
\end{proof}

\begin{lemma}
\label{lemma-open-immersion-etale}
Any open immersion is etale.
\end{lemma}

\begin{proof}
This is true because an open immersion is a local isomorphism.
\end{proof}

\begin{lemma}
\label{lemma-etale-syntomic}
An etale morphism is syntomic.
\end{lemma}

\begin{proof}
See Algebra, Lemma \ref{algebra-lemma-smooth-syntomic} and use that an
etale morphism is the same as a smooth morphism of relative dimension $0$.
\end{proof}

\begin{lemma}
\label{lemma-etale-locally-finite-presentation}
An etale morphism is locally of finite presentation.
\end{lemma}

\begin{proof}
True because an etale ring map is of finite presentation by
definition.
\end{proof}

\begin{lemma}
\label{lemma-etale-flat}
An etale morphism is flat.
\end{lemma}

\begin{proof}
Combine Lemmas \ref{lemma-syntomic-flat} and \ref{lemma-etale-syntomic}.
\end{proof}

\begin{lemma}
\label{lemma-etale-open}
An etale morphism is open.
\end{lemma}

\begin{proof}
Combine Lemmas \ref{lemma-etale-flat},
\ref{lemma-etale-locally-finite-presentation}, and
\ref{lemma-fppf-open}.
\end{proof}

\noindent
The following lemma says locally any etale morphism is standard etale.
This is actually kind of a tricky result to prove in complete generality.
The tricky parts are hidden in the chapter on commutative algebra.
Hence a standard etale morphism is a {\it local model} for a general
etale morphism.

\begin{lemma}
\label{lemma-etale-locally-standard-etale}
Let $f : X  \to S$ be a morphism of schemes.
Let $x \in X$ be a point.
Set $s = f(x)$.
The following are equivalent
\begin{enumerate}
\item The morphism $f$ is etale at $x$.
\item There exist affine opens $U \subset X$,
and $V \subset S$ such that $x \in U$, $f(U) \subset V$ and the
induced morphism $f|_U : U \to V$ is standard etale
(see Definition \ref{definition-etale}).
\end{enumerate}
\end{lemma}

\begin{proof}
Follows from the definitions and
Algebra, Proposition \ref{algebra-proposition-etale-locally-standard}.
\end{proof}

\noindent
Here is a differential criterion of etaleness at a point.
There are many variants of this result
all of which may be useful at some point. We will just add them
here as needed.

\begin{lemma}
\label{lemma-etale-at-point}
Let $f : X \to S$ be a morphism of schemes.
Let $x \in X$.
Set $s = f(x)$.
Assume $f$ is locally of finite presentation.
The following are equivalent:
\begin{enumerate}
\item The morphism $f$ is etale at $x$.
\item The local ring map $\mathcal{O}_{S, s} \to \mathcal{O}_{X, x}$
is flat and the $\mathcal{O}_{X, x}$-module $\Omega_{X/S, x}$
is zero.
\item The local ring map $\mathcal{O}_{S, s} \to \mathcal{O}_{X, x}$
is flat and the $\kappa(x)$-vector space
$$
\Omega_{X_s/s, x} \otimes_{\mathcal{O}_{X_s, x}} \kappa(x) =
\Omega_{X/S, x} \otimes_{\mathcal{O}_{X, x}} \kappa(x)
$$
is zero.
\item The local ring map $\mathcal{O}_{S, s} \to \mathcal{O}_{X, x}$
is flat, we have $\mathfrak m_s\mathcal{O}_{X, x} = \mathfrak m_x$ and
the field extension $\kappa(s) \subset \kappa(x)$ is finite
separable.
\item There exist affine opens $U \subset X$,
and $V \subset S$ such that $x \in U$, $f(U) \subset V$ and the
induced morphism $f|_U : U \to V$ is standard smooth
of relative dimension $0$.
\item There exist affine opens $\text{Spec}(A) = U \subset X$
and $\text{Spec}(R) = V \subset S$ with $x \in U$ corresponding
to $\mathfrak q \subset A$, and $f(U) \subset V$
such that there exists a presentation
$$
A = R[x_1, \ldots, x_n]/(f_1, \ldots, f_n)
$$
with
$$
g =
\det
\left(
\begin{matrix}
\partial f_1/\partial x_1 &
\partial f_2/\partial x_1 &
\ldots &
\partial f_n/\partial x_1 \\
\partial f_1/\partial x_2 &
\partial f_2/\partial x_2 &
\ldots &
\partial f_n/\partial x_2 \\
\ldots & \ldots & \ldots & \ldots \\
\partial f_1/\partial x_n &
\partial f_2/\partial x_n &
\ldots &
\partial f_n/\partial x_n
\end{matrix}
\right)
$$
mapping to an element of $A$ not in $\mathfrak q$.
\item There exist affine opens $U \subset X$,
and $V \subset S$ such that $x \in U$, $f(U) \subset V$ and the
induced morphism $f|_U : U \to V$ is standard etale.
\item There exist affine opens $\text{Spec}(A) = U \subset X$
and $\text{Spec}(R) = V \subset S$ with $x \in U$ corresponding
to $\mathfrak q \subset A$, and $f(U) \subset V$
such that there exists a presentation
$$
A = R[x]_Q/(P) = R[x, 1/Q]/(P)
$$
with $P, Q \in R[x]$, $P$ monic and $P' = {\rm d}P/{\rm d}x$ mapping to
an element of $A$ not in $\mathfrak q$.
\end{enumerate}
\end{lemma}

\begin{proof}
Use Lemma \ref{lemma-etale-locally-standard-etale}
and the definitions to see that (1) implies all
of the other conditions. For each of the conditions
(2) -- (7) combine Lemmas \ref{lemma-smooth-at-point}
and \ref{lemma-unramified-at-point} to see
that (1) holds by showing $f$ is both smooth and unramified
at $x$ and applying Lemma \ref{lemma-etale-smooth-unramified}.
Some details omitted.
\end{proof}

\begin{lemma}
\label{lemma-flat-unramified-etale}
A morphism is etale at a point if and only if it is flat and G-unramified
at that point.
A morphism is etale if and only if it is flat and G-unramified.
\end{lemma}

\begin{proof}
This is clear from Lemmas \ref{lemma-etale-at-point}
and \ref{lemma-unramified-at-point}.
\end{proof}

\begin{lemma}
\label{lemma-set-points-where-fibres-etale}
Let $f : X \to S$ be a morphism of schemes.
Assume $f$ locally of finite type. Formation of the set
$$
T = \{x \in X \mid
X_{f(x)}\text{ is etale over }\kappa(f(x))\text{ at }x\}
$$
commutes with arbitrary base change:
For any morphism $g : S' \to S$, consider
the base change $f' : X' \to S'$ of $f$ and the
projection $g' : X' \to X$. Then the corresponding
set $T'$ for the morphism $f'$ is equal to $T' = (g')^{-1}(T)$.
In particular, if $f$ is assumed locally of finite
presentation and flat then the same holds for the open set of points
where $f$ is etale.
\end{lemma}

\begin{proof}
Combine
Lemmas \ref{lemma-flat-unramified-etale} and
\ref{lemma-set-points-where-fibres-unramified}.
\end{proof}

\noindent
Our proof of the following lemma is somewhat complicated.
It uses the ``Crit\`ere de platitude par fibres'' to see that
a morphism $X \to Y$ over $S$ between schemes etale over $S$
is automatically flat. The details are in the chapter on commutative algebra.

\begin{lemma}
\label{lemma-etale-permanence}
Let $f : X \to Y$ be a morphism of schemes over $S$.
If $X$ and $Y$ are etale over $S$, then
$f$ is etale.
\end{lemma}

\begin{proof}
See Algebra, Lemma \ref{algebra-lemma-map-between-etale}.
\end{proof}

\begin{lemma}
\label{lemma-etale-permanence-two}
Let
$$
\xymatrix{
X \ar[rr]_f \ar[rd]_p & &
Y \ar[dl]^q \\
& S
}
$$
be a commutative diagram of morphisms of schemes. Assume that
\begin{enumerate}
\item $f$ is surjective, and etale,
\item $p$ is etale, and
\item $q$ is locally of finite presentation\footnote{In fact this
is implied by (1) and (2), see
Descent, Lemma \ref{descent-lemma-flat-finitely-presented-permanence}.}.
\end{enumerate}
Then $q$ is etale.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-smooth-permanence} we see that $q$ is smooth.
Thus we only need to see that $q$ has relative dimension $0$.
This follows from Lemma \ref{lemma-dimension-fibre-at-a-point-additive}
and the fact that $f$ and $p$ have relative dimension $0$.
\end{proof}

\noindent
A final characterization of smooth morphisms is that a smooth morphism
$f : X \to S$ is locally the composition of an etale morphism by a projection
$\mathbf{A}_S^d \to S$.

\begin{lemma}
\label{lemma-smooth-etale-over-affine-space}
Let $\varphi : X \to Y$ be a morphism of schemes. Let $x \in X$.
If $\varphi$ is smooth at $x$, then there exist exist an integer $d \geq 0$
and affine opens $V \subset Y$ and $U \subset X$ with $x \in U$ and
$\varphi(U) \subset V$ such that there exists a commutative diagram
$$
\xymatrix{
X \ar[d] & U \ar[l] \ar[d] \ar[r]_-\pi & \mathbf{A}^d_V \ar[ld] \\
Y & V \ar[l]
}
$$
where $\pi$ is etale.
\end{lemma}

\begin{proof}
By
Lemma \ref{lemma-smooth-locally-standard-smooth}
we can find affine opens $U$ and $V$ as in the lemma such that
$\varphi|_U : U \to V$ is standard smooth. Write
$U = \text{Spec}(A)$ and $V = \text{Spec}(R)$ so that we can write
$$
A = R[x_1, \ldots, x_n]/(f_1, \ldots, f_c)
$$
with
$$
g =
\det
\left(
\begin{matrix}
\partial f_1/\partial x_1 &
\partial f_2/\partial x_1 &
\ldots &
\partial f_c/\partial x_1 \\
\partial f_1/\partial x_2 &
\partial f_2/\partial x_2 &
\ldots &
\partial f_c/\partial x_2 \\
\ldots & \ldots & \ldots & \ldots \\
\partial f_1/\partial x_c &
\partial f_2/\partial x_c &
\ldots &
\partial f_c/\partial x_c
\end{matrix}
\right)
$$
mapping to an invertible element of $A$. Then it is clear that
$R[x_{c + 1}, \ldots, x_n] \to A$ is standard smooth of relative
dimension $0$. Hence it is smooth of relative dimension $0$.
In other words the ring map $R[x_{c + 1}, \ldots, x_n] \to A$
is etale. As $\mathbf{A}^{n - c}_V = \text{Spec}(R[x_{c + 1}, \ldots, x_n])$
the lemma with $d = n - c$.
\end{proof}
















\section{Relatively ample sheaves}
\label{section-relatively-ample}

\noindent
Let $X \to S$ be a morphism of schemes.
Contrary to what one may think the existence of a relatively
ample sheaf on $X$ does not force the morphism $X \to S$ to be
of finite type. Here is the definition.

\begin{definition}
\label{definition-relatively-ample}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
We say $\mathcal{L}$ is {\it relatively ample} or more
precisely {\it $f$-relatively ample}, or
{\it ample on $X/S$}, or just {\it $f$-ample} if $f : X \to S$
is quasi-compact, and if for every affine open $V \subset S$
the restriction of $\mathcal{L}$ to the open subscheme
$f^{-1}(V)$ of $X$ is ample.
\end{definition}

\begin{lemma}
\label{lemma-ample-power-ample}
Let $X \to S$ be a morphism of schemes.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
Let $n \geq 1$. Then $\mathcal{L}$ is $f$-ample if and only if
$\mathcal{L}^{\otimes n}$ is $f$-ample.
\end{lemma}

\begin{proof}
This follows from Properties, Lemma \ref{properties-lemma-ample-power-ample}.
\end{proof}

\begin{lemma}
\label{lemma-relatively-ample-separated}
Let $f : X \to S$ be a morphism of schemes.
If there exists an $f$-ample invertible sheaf, then
$f$ is separated.
\end{lemma}

\begin{proof}
Being separated is local on the base (see
Schemes, Lemma \ref{schemes-lemma-characterize-separated} for example;
it also follows easily from the definition).
Hence we may assume $S$ is affine and $X$
has an ample invertible sheaf. In this case the
result follows from
Properties, Lemma \ref{properties-lemma-ample-immersion-into-proj}
and Constructions, Lemma \ref{constructions-lemma-proj-separated}.
\end{proof}

\noindent
There are many ways to charactarize relatively ample invertible
sheaves, by relativizing any of the list of equivalent conditions in
Properties, Proposition \ref{properties-proposition-characterize-ample}.
We will add these here as needed.

\begin{lemma}
\label{lemma-characterize-relatively-ample}
Let $f : X \to S$ be a quasi-compact morphism of schemes.
Let $\mathcal{L}$ be an invertible sheaf on $X$.
The following are equivalent:
\begin{enumerate}
\item The invertible sheaf $\mathcal{L}$ is $f$-ample.
\item There exists an open covering $S = \bigcup V_i$
such that each $\mathcal{L}|_{f^{-1}(V_i)}$ is ample
relative to $f^{-1}(V_i) \to V_i$.
\item There exists an affine open covering $S = \bigcup V_i$
such that each $\mathcal{L}|_{f^{-1}(V_i)}$ is ample.
\item There exists a quasi-coherent graded $\mathcal{O}_S$-algebra
$\mathcal{A}$ and a map of graded $\mathcal{O}_X$-algebras
$\psi : f^*\mathcal{A} \to \bigoplus_{d \geq 0} \mathcal{L}^{\otimes d}$
such that $U(\psi) = X$ and
$$
r_{\mathcal{L}, \psi} :
X
\longrightarrow
\underline{\text{Proj}}_S(\mathcal{A})
$$
is an open immersion (see Constructions, Lemma
\ref{constructions-lemma-invertible-map-into-relative-proj} for notation).
\item The morphism $f$ is quasi-separated and
part (4) above holds with
$\mathcal{A} = f_*(\bigoplus_{d \geq 0} \mathcal{L}^{\otimes d})$
and $\psi$ the adjunction mapping.
\item Same as (4) but just requiring $r_{\mathcal{L}, \psi}$
to be an immersion.
\end{enumerate}
\end{lemma}

\begin{proof}
It is immediate from the definition that (1) implies (2) and
(2) implies (3). It is clear that (5) implies (4).

\medskip\noindent
Assume (3) holds for the affine open covering $S = \bigcup V_i$.
We are going to show (5) holds.
Since each $f^{-1}(V_i)$ has an ample invertible sheaf we see
that $f^{-1}(V_i)$ is separated (see
Properties, Lemma \ref{properties-lemma-ample-immersion-into-proj} and
Constructions, Lemma \ref{constructions-lemma-proj-separated}).
Hence $f$ is separated. By
Schemes, Lemma \ref{schemes-lemma-push-forward-quasi-coherent}
we see that $\mathcal{A} = f_*(\bigoplus_{d \geq 0} \mathcal{L}^{\otimes d})$
is a quasi-coherent graded $\mathcal{O}_S$-algebra.
Denote $\psi : f^*\mathcal{A} \to \bigoplus_{d \geq 0} \mathcal{L}^{\otimes d}$
the adjunction mapping.
The description of the open $U(\psi)$ in
Construction, Section \ref{constructions-section-invertible-relative-proj}
and the definition of ampleness
of $\mathcal{L}|_{f^{-1}(V_i)}$ show that $U(\psi) = X$.
Moreover, Constructions,
Lemma \ref{constructions-lemma-invertible-map-into-relative-proj} part (3)
shows that the restriction of $r_{\mathcal{L}, \psi}$ to
$f^{-1}(V_i)$ is the same as the morphism from
Properties, Lemma \ref{properties-lemma-map-into-proj}
which is an open immersion according to
Properties, Lemma \ref{properties-lemma-ample-immersion-into-proj}.
Hence (5) holds.

\medskip\noindent
Let us show that (4) implies (1). Assume (4).
Denote $\pi : \underline{\text{Proj}}_S(\mathcal{A}) \to S$
the structure morphism. Choose $V \subset S$ affine open. By
Constructions, Definition \ref{constructions-definition-relative-proj}
we see that $\pi^{-1}(V) \subset \underline{\text{Proj}}_S(\mathcal{A})$
is equal to $\text{Proj}(A)$ where $A = \mathcal{A}(V)$
as a graded ring. Hence $r_{\mathcal{L}, \psi}$ maps
$f^{-1}(V)$ isomorphically onto
a quasi-compact open of $\text{Proj}(A)$.
Moreover, $\mathcal{L}^{\otimes d}$ is isomorphic to the pullback of
$\mathcal{O}_{\text{Proj}(A)}(d)$ for some $d \geq 1$.
(See part (3) of Constructions,
Lemma \ref{constructions-lemma-invertible-map-into-relative-proj}
and the final statement of Constructions,
Lemma \ref{constructions-lemma-invertible-map-into-proj}.)
This implies that $\mathcal{L}|_{f^{-1}(V)}$ is ample by
Properties, Lemmas \ref{properties-lemma-open-in-proj-ample}
and \ref{properties-lemma-ample-power-ample}.

\medskip\noindent
Assume (6). By the equivalence of (1) - (5) above we see that the
property of being relatively ample on $X/S$ is local on $S$. Hence
we may assume that $S$ is affine, and we have to show that
$\mathcal{L}$ is ample on $X$. In this case the morphism
$r_{\mathcal{L}, \psi}$ is identified with the morphism, also denoted
$r_{\mathcal{L}, \psi} : X \to \text{Proj}(A)$ associated to the map
$\psi : A = \mathcal{A}(V) \to \Gamma_*(X, \mathcal{L})$.
(See references above.) As above we also see that
$\mathcal{L}^{\otimes d}$ is the pullback of the sheaf
$\mathcal{O}_{\text{Proj}(A)}(d)$ for some $d \geq 1$.
Moreover, since $X$ is quasi-compact we
see that $X$ gets identified with a closed subscheme of a
quasi-compact open subscheme $Y \subset \text{Proj}(A)$.
By Construction, Lemma \ref{constructions-lemma-ample-on-proj}
(see also
Properties, Lemma \ref{properties-lemma-open-in-proj-ample})
we see that $\mathcal{O}_Y(d')$ is an ample invertible sheaf on
$Y$ for some $d' \geq 1$. Since the restriction of an ample
sheaf to a closed subscheme is ample, see
Properties, Lemma \ref{properties-lemma-ample-on-closed}
we conclude that the pullback of
$\mathcal{O}_Y^{d'}$ is ample. Combining these results with
Properties, Lemma \ref{properties-lemma-ample-power-ample}
we conclude that $\mathcal{L}$ is ample as desired.
\end{proof}

\begin{lemma}
\label{lemma-ample-over-affine}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
Assume $S$ affine.
Then $\mathcal{L}$ is $f$-relatively ample if and only
if $\mathcal{L}$ is ample on $X$.
\end{lemma}

\begin{proof}
Immediate from Lemma \ref{lemma-characterize-relatively-ample}
and the definitions.
\end{proof}











\section{Very ample sheaves}
\label{section-very-ample}

\begin{definition}
\label{definition-very-ample}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
We say $\mathcal{L}$ is {\it relatively very ample} or more
precisely {\it $f$-relatively very ample}, or
{\it very ample on $X/S$}, or {\it $f$-very ample} if
there exist a quasi-coherent $\mathcal{O}_S$-module
$\mathcal{E}$ and an immersion $i : X \to \mathbf{P}(\mathcal{E})$
over $S$ such that
$\mathcal{L} \cong i^*\mathcal{O}_{\mathbf{P}(\mathcal{E})}(1)$.
\end{definition}

\noindent
Since there is no assumption of quasi-compactness in this definition it is not
true in general that a relatively very ample invertible sheaf is a relatively
ample invertible sheaf.

\begin{lemma}
\label{lemma-ample-very-ample}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
If $f$ is quasi-compact and $\mathcal{L}$ is a relatively
very ample invertible sheaf, then $\mathcal{L}$ is a relatively
ample invertible sheaf.
\end{lemma}

\begin{proof}
By definition there exists quasi-coherent $\mathcal{O}_S$-module
$\mathcal{E}$ and an immersion $i : X \to \mathbf{P}(\mathcal{E})$
over $S$ such that
$\mathcal{L} \cong i^*\mathcal{O}_{\mathbf{P}(\mathcal{E})}(1)$.
Set $\mathcal{A} = \text{Sym}(\mathcal{E})$, so
$\mathbf{P}(\mathcal{E}) = \underline{\text{Proj}}_S(\mathcal{A})$
by definition. The graded $\mathcal{O}_S$-algebra $\mathcal{A}$
comes equipped with a map
$$
\psi :
\mathcal{A} \to
\bigoplus\nolimits_{n \geq 0}
\pi_*\mathcal{O}_{\mathbf{P}(\mathcal{E})}(n) \to
\bigoplus\nolimits_{n \geq 0}
f_*\mathcal{L}^{\otimes n}
$$
where the second arrow uses the identification
$\mathcal{L} \cong i^*\mathcal{O}_{\mathbf{P}(\mathcal{E})}(1)$.
By adjointness of $f_*$ and $f^*$ we get a morphism
$\psi : f^*\mathcal{A} \to \bigoplus_{n \geq 0}\mathcal{L}^{\otimes n}$.
We omit the verification that the morphism $r_{\mathcal{L}, \psi}$
associated to this map is exactly the immersion $i$.
Hence the result follows from
part (6) of Lemma \ref{lemma-characterize-relatively-ample}.
\end{proof}

\noindent
To arrive at the correct converse of this lemma we ask
whether given a relatively ample
invertible sheaf $\mathcal{L}$ there exists an integer $n \geq 1$ such
that $\mathcal{L}^{\otimes n}$ is relatively very ample? In general this
is false. There are several things that prevent this from being true:
\begin{enumerate}
\item Even if $S$ is affine, it can happen that no finite integer
$n$ works because $X \to S$ is not of finite type, see
Example \ref{example-not-finite-type-proj}.
\item The base not being quasi-compact means the result can be
prevented from being true even with $f$ finite type. Namely, given
a field $k$ there exists a scheme $X_d$ of finite type over $k$ with
an ample invertible sheaf $\mathcal{O}_{X_d}(1)$ so that the smallest
tensor power of $\mathcal{O}_{X_d}(1)$ which is very ample is the $d$th
power. See Example \ref{example-not-bounded}.
Taking $f$ to be the disjoint union of the schemes $X_d$ mapping
to the disjoint union of copies of $\text{Spec}(k)$ gives an example.
\end{enumerate}
To see our version of the converse take a look at
Lemma \ref{lemma-finite-type-ample-very-ample} below.
We will do some preliminary work before proving it.

\begin{example}
\label{example-not-finite-type-proj}
Let $k$ be a field.
Consider the graded $k$-algebra
$$
A = k[U, V, Z_1, Z_2, Z_3, \ldots]/I
\quad
\text{with}
\quad
I = (U^2 - Z_1^2, U^4 - Z_2^2, U^6 - Z_3^2, \ldots)
$$
with grading given by $\deg(U) = \deg(V) = \deg(Z_1) = 1$
and $\deg(Z_d) = d$.
Note that $X = \text{Proj}(A)$ is covered by $D_{+}(U)$ and
$D_{+}(V)$. Hence the sheaves $\mathcal{O}_X(n)$ are all
invertible and isomorphic to $\mathcal{O}_X(1)^{\otimes n}$.
In particular $\mathcal{O}_X(1)$ is ample and $f$-ample
for the morphism $f : X \to \text{Spec}(k)$.
We claim that no power of $\mathcal{O}_X(1)$ is $f$-relatively very ample.
Namely, it is easy to see that $\Gamma(X, \mathcal{O}_X(n))$
is the degree $n$ summand of the algebra $A$. Hence if $\mathcal{O}_X(n)$
were very ample, then $X$ would be a closed subscheme of a projective
space over $k$ and hence of finite type over $k$. On the other hand
$D_{+}(V)$ is the spectrum of
$k[t, t_1, t_2, \ldots]/(t^2 - t_1^2, t^4 - t_2^2, t^6 - t_3^2, \ldots)$
which is not of finite type over $k$.
\end{example}

\begin{example}
\label{example-not-bounded}
Let $k$ be an infinite field. Let $\lambda_1, \lambda_2, \lambda_3, \ldots$
be pairwise distinct elements of $k^*$. (This is not strictly necessary,
and in fact the example works perfectly well even if all $\lambda_i$
are equal to $1$.)
Consider the graded $k$-algebra
$$
A_d = k[U, V, Z]/I_d
\quad
\text{with}
\quad
I_d = (Z^2 - \prod\nolimits_{i = 1}^{2d} (U - \lambda_i V)).
$$
with grading given by $\deg(U) = \deg(V) = 1$ and $\deg(Z) = d$.
Then $X_d = \text{Proj}(A_d)$ has ample invertible sheaf
$\mathcal{O}_{X_d}(1)$. We claim that if $\mathcal{O}_{X_d}(n)$
is very ample, then $n \geq d$. The reason for this is that $Z$
has degree $d$, and hence $\Gamma(X_d, \mathcal{O}_{X_d}(n)) = 
k[U, V]_n$ for $n < d$. Details omitted.
\end{example}

\begin{lemma}
\label{lemma-relatively-very-ample-separated}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{L}$ be an invertible sheaf on $X$.
If $\mathcal{L}$ is relatively very ample on $X/S$ then
$f$ is separated.
\end{lemma}

\begin{proof}
Being separated is local on the base (see
Schemes, Section \ref{schemes-section-separation-axioms}).
An immersion is separated
(see Schemes, Lemma \ref{schemes-lemma-immersions-monomorphisms}).
Hence the lemma follows since locally $X$ has an immersion into
the homogeneous spectrum of a graded ring which is separated, see
Constructions, Lemma \ref{constructions-lemma-proj-separated}.
\end{proof}

\begin{lemma}
\label{lemma-relatively-very-ample}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{L}$ be an invertible sheaf on $X$.
Assume $f$ is quasi-compact. The following are
equivalent
\begin{enumerate}
\item $\mathcal{L}$ is relatively very ample on $X/S$,
\item there exists an open covering $S = \bigcup V_j$ such
that $\mathcal{L}|_{f^{-1}(V_j)}$ is relatively very ample
on $f^{-1}(V_j)/V_j$ for all $j$,
\item there exists a quasi-coherent sheaf of graded
$\mathcal{O}_S$-algebras $\mathcal{A}$ generated in degree
$1$ over $\mathcal{O}_S$ and a map of graded $\mathcal{O}_X$-algebras
$\psi : f^*\mathcal{A} \to \bigoplus_{n \geq 0} \mathcal{L}^{\otimes n}$
such that $f^*\mathcal{A}_1 \to \mathcal{L}$ is surjective and the
associated morphism
$r_{\mathcal{L}, \psi} : X \to \underline{\text{Proj}}_S(\mathcal{A})$
is an immersion, and
\item $f$ is quasi-separated, the canonical map
$\psi : f^*f_*\mathcal{L} \to \mathcal{L}$ is surjective, and
the associated map $r_{\mathcal{L}, \psi} : X \to \mathbf{P}(f_*\mathcal{L})$
is an immersion.
\end{enumerate}
\end{lemma}

\begin{proof}
It is clear that (1) implies (2). It is also clear that
(4) implies (1); the hypothesis of quasi-spearation
in (4) is used to garantee that $f_*\mathcal{L}$ is quasi-coherent via
Schemes, Lemma \ref{schemes-lemma-push-forward-quasi-coherent}.

\medskip\noindent
Assume (2).
We will prove (4).
Let $S = \bigcup V_j$ be an open covering as in (2).
Set $X_j = f^{-1}(V_j)$ and $f_j : X_j \to V_j$ the
restriction of $f$. We see that $f$ is separated by
Lemma \ref{lemma-relatively-very-ample-separated} (as being
separated is local on the base). Consider the map
$\psi : f^*f_*\mathcal{L} \to \mathcal{L}$. On each $V_j$ there exists a
quasi-coherent sheaf $\mathcal{E}_j$ and an embedding
$i : X_j \to \mathbf{P}(\mathcal{E}_j)$ with
$\mathcal{L}_{X_j} \cong i^*\mathcal{O}_{\mathbf{P}(\mathcal{E}_j)}(1)$.
In other words there is a map $\mathcal{E}_j \to (f_*\mathcal{L})|_{X_j}$
such that the composition
$$
f_j^*\mathcal{E}_j \to (f^*f_*\mathcal{L})|_{X_j} \to \mathcal{L}|_{X_j}
$$
is surjective. Hence we conclude that $\psi$ is surjective. Let
$r_{\mathcal{L}, \psi} : X \to \mathbf{P}(f_*\mathcal{L})$ be the
associated morphism.
Using the maps $\mathcal{E}_j \to (f_*\mathcal{L})|_{X_j}$
we see that there is a factorization
$$
\xymatrix{
X_j \ar[r]^-{r_{\mathcal{L}, \psi}} &
\mathbf{P}(f_*\mathcal{L})|_{V_j} \ar[r] &
\mathbf{P}(\mathcal{E}_j)
}
$$
which shows that $r_{\mathcal{L}, \psi}$ is an immersion.

\medskip\noindent
At this point we see that (1), (2) and (4) are equivalent.
Clearly (4) implies (3). Assume (3). We will prove (1).
Let $\mathcal{A}$ be a quasi-coherent sheaf of graded $\mathcal{O}_S$-algebras
generated in degree $1$ over $\mathcal{O}_S$. Consider the map of
graded $\mathcal{O}_S$-algebras $\text{Sym}(\mathcal{A}_1) \to \mathcal{A}$.
This is surjective by hypothesis and hence induces a closed immersion
$$
\underline{\text{Proj}}_S(\mathcal{A})
\longrightarrow
\mathbf{P}(\mathcal{A}_1)
$$
which pulls back $\mathcal{O}(1)$ to $\mathcal{O}(1)$,
see (insert future reference here -- but see
Constructions, Lemma \ref{constructions-lemma-surjective-graded-rings-map-proj}
for the case where $S$ is affine). Hence it is clear that
(3) implies (1).
\end{proof}






\section{Ample and very ample sheaves relative to finite type morphisms}
\label{section-ample-finite-type}

\noindent
In fact most of the material in this section is about the notion of
a (quasi-)projective morphism which we have not defined yet.

\begin{lemma}
\label{lemma-very-ample-finite-type-over-affine}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{L}$ be an invertible sheaf on $X$.
Assume that
\begin{enumerate}
\item the invertible sheaf $\mathcal{L}$ is very ample on $X/S$,
\item the morphism $X \to S$ is of finite type, and
\item $S$ is affine.
\end{enumerate}
Then there exists an $n \geq 0$ and an immersion
$i : X \to \mathbf{P}^n_S$ over $S$ such that
$\mathcal{L} \cong i^*\mathcal{O}_{\mathbf{P}^n_S}(1)$.
\end{lemma}

\begin{proof}
Assume (1), (2) and (3).
Condition (3) means $S = \text{Spec}(R)$ for some ring $R$.
Condition (1) means by definition
there exists a quasi-coherent $\mathcal{O}_S$-module
$\mathcal{E}$ and an immersion $\alpha : X \to \mathbf{P}(\mathcal{E})$
such that $\mathcal{L} = \alpha^*\mathcal{O}_{\mathbf{P}(\mathcal{E})}(1)$.
Write $\mathcal{E} = \widetilde{M}$ for some $R$-module $M$.
Thus we have
$$
\mathbf{P}(\mathcal{E}) = \text{Proj}(\text{Sym}_R(M)).
$$
Since $\alpha$ is an immersion, and since the topology of
$\text{Proj}(\text{Sym}_R(M))$ is generated by the standard
opens $D_{+}(f)$, $f \in \text{Sym}_R^d(M)$, $d \geq 1$,
we can find for each $x \in X$ an
$f \in \text{Sym}_R^d(M)$, $d \geq 1$, with $\alpha(x) \in D_{+}(f)$
such that
$$
\alpha|_{\alpha^{-1}(D_{+}(f))} : \alpha^{-1}(D_{+}(f)) \to D_{+}(f)
$$
is a closed immersion. 
Condition (2) implies $X$ is quasi-compact. Hence we can find
a finite collection of elements
$f_j \in \text{Sym}_R^{d_j}(M)$, $d_j \geq 1$
such that for each $f = f_j$ the displayed map above
is a closed immersion and such that $\alpha(X) \subset \bigcup D_{+}(f_j)$.
Write $U_j = \alpha^{-1}(D_{+}(f_j))$. Note that $U_j$ is affine
as a closed subscheme of the affine scheme $D_{+}(f_j)$.
Write $U_j = \text{Spec}(A_j)$. Condition (2) also implies that
$A_j$ is of finite type over $R$, see
Lemma \ref{lemma-locally-finite-type-characterize}.
Choose finitely many $x_{j, k} \in A_j$ which
generate $A_j$ as a $R$-algebra. Since $\alpha|_{U_j}$ is a closed
immersion we see that $x_{j, k}$ is the image of an element
$$
f_{j, k}/f_j^{e_{j, k}} \in \text{Sym}_R(M)_{(f_j)}
=
\Gamma(D_{+}(f_j), \mathcal{O}_{\text{Proj}(\text{Sym}_R(M))}).
$$
Finally, choose $n \geq 1$ and elements $y_0, \ldots, y_n \in M$ such that each
of the polynomials $f_j, f_{j, k} \in \text{Sym}_R(M)$ is a polynomial
in the elements $y_t$ with coefficients in $R$.
Consider the graded ring map
$$
\psi : R[Y_0, \ldots, Y_n] \longrightarrow \text{Sym}_R(M),
\quad Y_i \longmapsto y_i.
$$
Denote $F_j$, $F_{j, k}$ the elements of $R[Y_0, \ldots, Y_n]$ such
that $\psi(F_j) = f_j$ and $\psi(F_{j, k}) = f_{j, k}$.
By Constructions, Lemma \ref{constructions-lemma-morphism-proj}
we obtain an open subscheme
$$
U(\psi) \subset \text{Proj}(\text{Sym}_R(M))
$$
and a morphism
$r_\psi : U(\psi) \to \mathbf{P}^n_R$. This morphism
satisfies $r_\psi^{-1}(D_{+}(F_j)) = D_{+}(f_j)$, and hence we see
that $\alpha(X) \subset U(\psi)$. Moreover, it is clear
that
$$
i = r_\psi \circ \alpha : X \longrightarrow \mathbf{P}^n_R
$$
is still an immersion since
$i^\sharp(F_{j, k}/F_j^{e_{j, k}}) = x_{j, k} \in
A_j = \Gamma(U_j, \mathcal{O}_X)$
by construction. Moreover, the morphism $r_\psi$ comes
equipped with a map
$\theta : r_\psi^*\mathcal{O}_{\mathbf{P}^n_R}(1)
\to \mathcal{O}_{\text{Proj}(\text{Sym}_R(M))}(1)|_{U(\psi)}$
which is an isomorphism in this case (for construction $\theta$
see lemma cited above; some details omitted).
Since the original map $\alpha$ was assumed to have the 
property that
$\mathcal{L} = \alpha^*\mathcal{O}_{\text{Proj}(\text{Sym}_R(M))}(1)$
we win.
\end{proof}

\begin{lemma}
\label{lemma-quasi-affine-finite-type-over-S}
Let $\pi : X \to S$ be a morphism of schemes.
Assume that $X$ is quasi-affine and that $\pi$ is locally of finite type.
Then there exist $n \geq 0$ and an immersion $i : X \to \mathbf{A}^n_S$
over $S$.
\end{lemma}

\begin{proof}
Let $A = \Gamma(X, \mathcal{O}_X)$. By assumption $X$ is quasi-compact
and is identified with an open subscheme of $\text{Spec}(A)$, see
Properties, Lemma \ref{properties-lemma-quasi-affine}.
Moreover, the set of opens $X_f$, for those $f \in A$ such that $X_f$ is
affine, forms a basis for the topology of $X$, see the proof of
Properties, Lemma \ref{properties-lemma-quasi-affine}.
Hence we can find a finite number of $f_j \in A$, $j = 1, \ldots, m$ such that
$X = \bigcup X_{f_j}$, and such that $\pi(X_{f_j}) \subset V_j$ for
some affine open $V_j \subset S$. By
Lemma \ref{lemma-locally-finite-type-characterize}
the ring maps $\mathcal{O}(V_j) \to \mathcal{O}(X_{f_j}) = A_{f_j}$
are of finite type. Thus we may choose $a_1, \ldots, a_N \in A$ such that
the elements $a_1, \ldots, a_N, f_1, \ldots, f_m, 1/f_j$ generate
$A_{f_j}$ over $\mathcal{O}(V_j)$ for each $j$. Take $n = N + m$ and
let
$$
i : X \longrightarrow \mathbf{A}^n_S
$$
be the morphism given by the global sections
$a_1, \ldots, a_n, f_1, \ldots, f_n$ of the structure sheaf of $X$.
Let $D(x_j) \subset \mathbf{A}^n_S$ be the open subscheme where the
$j$th coordinate function is nonzero.
Then it is clear that $i^{-1}(D(x_j))$ is $X_{f_j}$ and that
the induced morphism $X_{f_j} \to D(x_j)$ factors through the affine
open $\text{Spec}(\mathcal{O}(V_j)[x_1, \ldots, x_n, 1/x_j])$
of $D(x_j)$. Since the ring map
$\mathcal{O}(V_j)[x_1, \ldots, x_n, 1/x_j] \to A_{f_j}$ is
surjective by construction we conclude that the restriction of $i$
to $X_{f_j}$ is an immersion as desired.
\end{proof}

\begin{lemma}
\label{lemma-quasi-projective-finite-type-over-S}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{L}$ be an invertible sheaf on $X$.
Assume that
\begin{enumerate}
\item the invertible sheaf $\mathcal{L}$ is ample on $X$, and
\item the morphism $X \to S$ is locally of finite type.
\end{enumerate}
Then there exists a $d_0 \geq 1$ such that for every $d \geq d_0$
there exists an $n \geq 0$ and an immersion
$i : X \to \mathbf{P}^n_S$ over $S$ such that
$\mathcal{L}^{\otimes d} \cong i^*\mathcal{O}_{\mathbf{P}^n_S}(1)$.
\end{lemma}

\begin{proof}
Let
$A = \Gamma_*(X, \mathcal{L}) =
\bigoplus_{d \geq 0} \Gamma(X, \mathcal{L}^{\otimes d})$.
By Properties, Proposition \ref{properties-proposition-characterize-ample}
the set of affine opens $X_a$ with $a \in A_{+}$ homogeneous forms
a basis for the topology of $X$. Hence we can find finitely
many such elements $a_0, \ldots, a_n \in A_{+}$ such that
\begin{enumerate}
\item we have $X = \bigcup_{i = 0, \ldots, n} X_{a_i}$,
\item each $X_{a_i}$ is affine, and
\item each $X_{a_i}$ maps into an affine open $V_i \subset S$.
\end{enumerate}
By Lemma \ref{lemma-locally-finite-type-characterize}
we see that the ring maps
$\mathcal{O}_S(V_i) \to \mathcal{O}_X(X_{a_i})$ are
of finite type. Hence we can find finitely many
elements $f_{ij} \in \mathcal{O}_X(X_{a_i})$, $j = 1, \ldots, n_i$
which generate $\mathcal{O}_X(X_{a_i})$ as an $\mathcal{O}_S(V_i)$-algebra.
By Properties, Lemma \ref{properties-lemma-invert-s-sections}
we may write each
$f_{ij}$ as $a_{ij}/a_i^{e_{ij}}$ for some
$a_{ij} \in A_{+}$ homogeneous. Let $N$ be a positive integer which
is a common multiple of all the degrees of the elements
$a_i$, $a_{ij}$. Consider the elements
$$
a_i^{N/\deg(a_i)}, \ a_{ij}a_i^{(N/\deg(a_i)) - e_{ij}} \in A_N.
$$
By construction these generate the invertible sheaf
$\mathcal{L}^{\otimes N}$ over $X$. Hence they give rise
to a morphism
$$
j : X \longrightarrow
\mathbf{P}_S^{m}
\quad
\text{with } m = n + \sum n_i
$$
over $S$, see Constructions, Lemma \ref{constructions-lemma-projective-space}
and Definition \ref{constructions-definition-projective-space}.
Moreover, $j^*\mathcal{O}_{\mathbf{P}_S}(1) = \mathcal{L}^{\otimes N}$.
We name the homogeneous coordinates $T_0, \ldots, T_n, T_{ij}$
instead of $T_0, \ldots, T_m$.
For $i = 0, \ldots, n$ we have $i^{-1}(D_{+}(T_i)) = X_{a_i}$.
Moreover, pulling back the element $T_{ij}/T_i$ via $j^\sharp$ we
get the element $f_{ij} \in \mathcal{O}_X(X_{a_i})$.
Hence the morphism $j$ restricted to $X_{a_i}$
gives a closed immersion of $X_{a_i}$ into the affine open
$D_{+}(T_i) \cap \mathbf{P}^m_{V_i}$ of $\mathbf{P}^N_S$.
Hence we conclude that the morphism $j$ is an immersion.
This implies the lemma holds for some $d$ and $n$ which is enough
in virtually all applications.

\medskip\noindent
This proves that for one $d_2 \geq 1$
(namely $d_2 = N$ above), some $m \geq 0$ there exists some
immersion $j : X \to \mathbf{P}^m_S$ given by global sections
$s'_0, \ldots, s'_m \in \Gamma(X, \mathcal{L}^{\otimes d_2})$.
By Properties, Proposition \ref{properties-proposition-characterize-ample}
we know there exists an integer
$d_1$ such that $\mathcal{L}^{\otimes d}$ is globally generated
for all $d \geq d_1$. Set $d_0 = d_1 + d_2$. We claim that
the lemma holds with this value of $d_0$. Namely, given
an integer $d \geq d_0$ we may choose $s''_1, \ldots, s''_t
\in \Gamma(X, \mathcal{L}^{\otimes d - d_2})$ which generate
$\mathcal{L}^{\otimes d - d_2}$ over $X$. Set $n = (m + 1)t$ and
denote $s_0, \ldots, s_n$ the collection of sections
$s'_\alpha s''_\beta$, $\alpha = 0, \ldots, m$, 
$\beta = 1, \ldots, t$. These generate $\mathcal{L}^{\otimes d}$
over $X$ and therefore define a morphism
$$
i : X \longrightarrow \mathbf{P}^n_S
$$
such that $i^*\mathcal{O}_{\mathbf{P}^n_S}(1) \cong \mathcal{L}^{\otimes d}$.
We omit the verification that since $j$ was an immersion
also the morphism $i$ so obtained is an immersion also.
(Hint: Segre embedding.)
\end{proof}

\begin{lemma}
\label{lemma-finite-type-over-affine-ample-very-ample}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
Assume $S$ affine and $f$ of finite type.
The following are equivalent
\begin{enumerate}
\item $\mathcal{L}$ is ample on $X$,
\item $\mathcal{L}$ is $f$-ample,
\item $\mathcal{L}^{\otimes d}$ is $f$-very ample for some $d \geq 1$,
\item $\mathcal{L}^{\otimes d}$ is $f$-very ample for all $d \gg 1$,
\item for some $d \geq 1$ there exist $n \geq 1$ and an immersion
$i : X \to \mathbf{P}^n_S$ such that
$\mathcal{L}^{\otimes d} \cong i^*\mathcal{O}_{\mathbf{P}^n_S}(1)$, and
\item for all $d \gg 1$ there exist $n \geq 1$ and an immersion
$i : X \to \mathbf{P}^n_S$ such that
$\mathcal{L}^{\otimes d} \cong i^*\mathcal{O}_{\mathbf{P}^n_S}(1)$.
\end{enumerate}
\end{lemma}

\begin{proof}
The equivalence of (1) and (2) is Lemma \ref{lemma-ample-over-affine}.
The implication (2) $\Rightarrow$ (6) is
Lemma \ref{lemma-quasi-projective-finite-type-over-S}.
Trivially (6) implies (5).
As $\mathbf{P}^n_S$ is a projective bundle over $S$ (see
Constructions, Lemma \ref{constructions-lemma-projective-space-bundle})
we see that
(5) implies (3) and (6) implies (4) from the definition of a
relatively very ample sheaf.
Trivially (4) implies (3). To finish we have to show that
(3) implies (2) which follows from Lemma \ref{lemma-ample-very-ample}
and Lemma \ref{lemma-ample-power-ample}.
\end{proof}

\begin{lemma}
\label{lemma-finite-type-ample-very-ample}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
Assume $S$ quasi-compact and $f$ of finite type.
The following are equivalent
\begin{enumerate}
\item $\mathcal{L}$ is $f$-ample,
\item $\mathcal{L}^{\otimes d}$ is $f$-very ample for some $d \geq 1$,
\item $\mathcal{L}^{\otimes d}$ is $f$-very ample for all $d \gg 1$.
\end{enumerate}
\end{lemma}

\begin{proof}
Trivially (3) implies (2). Lemma \ref{lemma-ample-very-ample} garantees that
(2) implies (1) since a morphism of finite type is quasi-compact
by definition. Assume that $\mathcal{L}$ is $f$-ample. Choose a finite affine
open covering $S = V_1 \cup \ldots \cup V_m$. Write $X_i = f^{-1}(V_i)$.
By Lemma \ref{lemma-finite-type-over-affine-ample-very-ample} above we see
there exists a $d_0$ such that $\mathcal{L}^{\otimes d}$ is
relatively very ample on $X_i/V_i$ for all $d \geq d_0$. Hence we conclude
(1) implies (3) by Lemma \ref{lemma-relatively-very-ample}.
\end{proof}

\noindent
The following two lemmas provide the most used and most useful
characterizations of relatively very ample and relatively ample
invertible sheaves when the morphism is of finite type.

\begin{lemma}
\label{lemma-characterize-very-ample-on-finite-type}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{L}$ be an invertible sheaf on $X$.
Assume $f$ is of finite type.
The following are equivalent:
\begin{enumerate}
\item $\mathcal{L}$ is $f$-relatively very ample, and
\item there exist an open covering $S = \bigcup V_j$,
for each $j$ an integer $n_j$, and immersions
$$
i_j :
X_j = f^{-1}(V_j) = V_j \times_S X
\longrightarrow
\mathbf{P}^{n_j}_{V_j}
$$
over $V_j$ such that
$\mathcal{L}|_{X_j} \cong i_j^*\mathcal{O}_{\mathbf{P}^{n_j}_{V_j}}(1)$.
\end{enumerate}
\end{lemma}

\begin{proof}
We see that (1) implies (2) by taking an affine open covering of $S$
and applying Lemma \ref{lemma-very-ample-finite-type-over-affine} to
each of the restrictions of $f$ and
$\mathcal{L}$. We see that (2) implies (1) by
Lemma \ref{lemma-relatively-very-ample}.
\end{proof}

\begin{lemma}
\label{lemma-characterize-ample-on-finite-type}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{L}$ be an invertible sheaf on $X$.
Assume $f$ is of finite type.
The following are equivalent:
\begin{enumerate}
\item $\mathcal{L}$ is $f$-relatively ample, and
\item there exist an open covering $S = \bigcup V_j$,
for each $j$ an integers $d_j \geq 1$,
$n_j \geq 0$, and immersions
$$
i_j :
X_j = f^{-1}(V_j) = V_j \times_S X
\longrightarrow
\mathbf{P}^{n_j}_{V_j}
$$
over $V_j$ such that
$\mathcal{L}^{\otimes d_j}|_{X_j} \cong
i_j^*\mathcal{O}_{\mathbf{P}^{n_j}_{V_j}}(1)$.
\end{enumerate}
\end{lemma}

\begin{proof}
We see that (1) implies (2) by taking an affine open covering of $S$
and applying Lemma \ref{lemma-finite-type-over-affine-ample-very-ample} to
each of the restrictions of $f$ and
$\mathcal{L}$. We see that (2) implies (1) by
Lemma \ref{lemma-characterize-relatively-ample}.
\end{proof}










\section{Quasi-projective morphisms}
\label{section-quasi-projective}

\noindent
The discussion in the previous section suggests the following definitions.
We take our definition of quasi-projective from \cite{EGA}. The version
with the letter ``H'' is the definition in \cite{H}.

\begin{definition}
\label{definition-quasi-projective}
Let $f : X \to S$ be a morphism of schemes.
\begin{enumerate}
\item We say $f$ is {\it quasi-projective} if $f$ is of finite type
and there exists an $f$-relatively ample invertible $\mathcal{O}_X$-module.
\item We say $f$ is {\it H-quasi-projective} if $f$ if there exists
a quasi-compact immersion $X \to \mathbf{P}^n_S$ over $S$ for some $n$.
\footnote{This is not exactly the same as the definition in Hartshorne.
Namely, the definition in Hartshorne (8th corrected printing, 1997) is that
$f$ should be the composition of an open immersion followed by a H-projective
morphism (see Definition \ref{definition-projective}), which does not imply
$f$ is quasi-compact. See
Lemma \ref{lemma-H-quasi-projective-open-H-projective} for
the implication in the other direction.}
\item We say $f$ is {\it locally quasi-projective} if there exists
an open covering $S = \bigcup V_j$ such that each $f^{-1}(V_j) \to V_j$
is quasi-projective.
\end{enumerate}
\end{definition}

\noindent
As this definition suggests the property of being quasi-projective
is not local on $S$.

\begin{lemma}
\label{lemma-quasi-projective-properties}
Let $f : X \to S$ be a morphism of schemes. If $f$ is quasi-projective,
or H-quasi-projective or locally quasi-projective, then $f$ is
separated of finite type.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-H-quasi-projective-quasi-projective}
A H-quasi-projective morphism is quasi-projective.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-characterize-locally-quasi-projective}
Let $f : X \to S$ be a morphism of schemes.
The following are equivalent:
\begin{enumerate}
\item The morphism $f$ is locally quasi-projective.
\item There exists an open covering $S = \bigcup V_j$ such
that each $f^{-1}(V_j) \to V_j$ is H-quasi-projective.
\end{enumerate}
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-H-quasi-projective-quasi-projective}
we see that (2) implies (1). Assume (1).
The question is local on $S$ and hence we may assume $S$ is affine,
$X$ of finite type over $S$ and
$\mathcal{L}$ is a relatively ample invertible sheaf on $X/S$.
By Lemma \ref{lemma-finite-type-over-affine-ample-very-ample}
we may assume $\mathcal{L}$ is ample on $X$.
By Lemma \ref{lemma-quasi-projective-finite-type-over-S} we see that there
exists an immersion of $X$ into
a projective space over $S$, i.e., $X$ is H-quasi-projective over $S$
as desired.
\end{proof}





\section{Proper morphisms}
\label{section-proper}

\noindent
The notion of a proper morphism plays an important role in algebraic
geometry. An important example of a proper morphism will be the
structure morphism $\mathbf{P}^n_S \to S$ of projective $n$-space,
and this is in fact the motivating example leading to the definition.

\begin{definition}
\label{definition-proper}
Let $f : X \to S$ be a morphism of schemes.
We say $f$ is {\it proper} if $f$ is separated, finite type, and
universally closed.
\end{definition}

\noindent
The morphism from the affine line with zero doubled to the affine line
is of finite type and universally closed, so the separation condition is
necessary in the definition above.
In the rest of this section we prove some of the basic properties
of proper morphisms and of universally closed morphisms.

\begin{lemma}
\label{lemma-universally-closed-local-on-the-base}
Let $f : X \to S$ be a morphism of schemes.
The following are equivalent:
\begin{enumerate}
\item The morphism $f$ is universally closed.
\item There exists an open covering $S = \bigcup V_j$ such
that $f^{-1}(V_j) \to V_j$ is universally closed for all indices $j$.
\end{enumerate}
\end{lemma}

\begin{proof}
This is clear from the definition.
\end{proof}

\begin{lemma}
\label{lemma-proper-local-on-the-base}
Let $f : X \to S$ be a morphism of schemes.
The following are equivalent:
\begin{enumerate}
\item The morphism $f$ is proper.
\item There exists an open covering $S = \bigcup V_j$ such
that $f^{-1}(V_j) \to V_j$ is proper for all indices $j$.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-composition-proper}
The composition of proper morphisms is proper.
The same is true for universally closed morphisms.
\end{lemma}

\begin{proof}
A composition of closed morphisms is closed.
If $X \to Y \to Z$ are universally closed morphisms
and $Z' \to Z$ is any morphism, then we see that
$Z' \times_Z X = (Z' \times_Z Y) \times_Y X  \to Z' \times_Z Y$
is closed and $Z' \times_Z Y \to Z'$ is closed.
Hence the result for universally closed morphisms.
We have seen that ``separated'' and ``finite type''
are preserved under compositions
(Schemes, Lemma \ref{schemes-lemma-separated-permanence} and
Lemma \ref{lemma-composition-finite-type}). Hence the
result for proper morphisms.
\end{proof}

\begin{lemma}
\label{lemma-base-change-proper}
The base change of a proper morphism is proper.
The same is true for universally closed morphisms.
\end{lemma}

\begin{proof}
This is true by definition for universally closed morphisms.
It is true for separated morphisms
(Schemes, Lemma \ref{schemes-lemma-separated-permanence}).
It is true for morphisms of finite type
(Lemma \ref{lemma-base-change-finite-type}).
Hence it is true for proper morphisms.
\end{proof}

\begin{lemma}
\label{lemma-closed-immersion-proper}
A closed immersion is proper, hence a fortiori universally closed.
\end{lemma}

\begin{proof}
The base change of a closed immersion is a closed immersion
(Schemes, Lemma \ref{schemes-lemma-base-change-immersion}).
Hence it is universally closed.
A closed immersion is separated
(Schemes, Lemma \ref{schemes-lemma-immersions-monomorphisms}).
A closed immersion is of finite type
(Lemma \ref{lemma-immersion-locally-finite-type}).
Hence a closed immersion is proper.
\end{proof}

\begin{lemma}
\label{lemma-image-proper-scheme-closed}
Suppose given a commutative diagram of schemes
$$
\xymatrix{
X \ar[rr] \ar[rd] & &
Y \ar[ld] \\
& S &
}
$$
with $Y$ separated over $S$.
\begin{enumerate}
\item If $X \to S$ is universally closed, then the morphism
$X \to Y$ is universally closed.
\item If $X$ proper over $S$, then the morphism $X \to Y$ is proper.
\end{enumerate}
In particular, in both cases the image of $X$ in $Y$ is closed.
\end{lemma}

\begin{proof}
Assume that $X \to S$ is universally closed (resp.\ proper).
We factor the morphism as $X \to X \times_S Y \to Y$.
The first morphism is a closed immersion, see
Schemes, Lemma \ref{schemes-lemma-semi-diagonal}.
Hence the first morphism is proper (Lemma \ref{lemma-closed-immersion-proper}).
The projection $X \times_S Y \to Y$ is the base change
of a unviversally closed (resp.\ proper) morphism and hence
universally closed (resp.\ proper), see Lemma \ref{lemma-base-change-proper}.
Thus $X \to Y$ is universally closed (resp.\ proper) as the composition
of universally closed (resp.\ proper) morphisms
(Lemma \ref{lemma-composition-proper}).
\end{proof}

\noindent
The following lemma says that the image of a proper scheme (in a separated
scheme of finite type over the base) is proper.

\begin{lemma}
\label{lemma-image-proper-is-proper}
Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism of schemes over $S$.
If $X$ is universally closed over $S$ and $f$ is surjective then
$Y$ is universally closed over $S$. In particular, if also $Y$ is
separated and of finite type over $S$, then $Y$ is proper over $S$.
\end{lemma}

\begin{proof}
Assume $X$ is universally closed and $f$ surjective.
Denote $p : X \to S$, $q : Y \to S$ the structure morphisms.
Let $S' \to S$ be a morphism of schemes. The base change
$f' : X_{S'} \to Y_{S'}$ is surjective
(Lemma \ref{lemma-base-change-surjective}), and the base
change $p' : X_{S'} \to S'$ is closed.
If $T \subset Y_{S'}$ is closed, then $(f')^{-1}(T) \subset X_{S'}$
is closed, hence $p'((f')^{-1}(T)) = q'(T)$ is closed.
So $q'$ is closed.
\end{proof}

\noindent
The proof of the following lemma is due to Bjorn Poonen, see
\href{http://mathoverflow.net/questions/23337/is-a-universally-closed-%
morphism-of-schemes-quasi-compact/23528#23528}{this location}.

\begin{lemma}
\label{lemma-universally-closed-quasi-compact}
A universally closed morphism of schemes is quasi-compact.
\end{lemma}

\begin{proof}
Let $f : X \to S$ be a morphism. Assume that $f$ is not quasi-compact.
Our goal is to show that $f$ is not universally closed. By
Schemes, Lemma \ref{schemes-lemma-quasi-compact-affine}
there exists an affine open $V \subset S$ such that $f^{-1}(V)$ is
not quasi-compact. To achieve our goal it suffices to show that
$f^{-1}(V) \to V$ is not universally closed, hence we may assume that
$S = \text{Spec}(A)$ for some ring $A$.

\medskip\noindent
Write $X = \bigcup_{i \in I} X_i$ where the $X_i$ are affine open subschemes
of $X$.  Let $T = \text{Spec}(A[y_i ; i \in I])$.
Let $T_i = D(y_i) \subset T$. Let $Z$ be the closed set
$(X \times_S T) - \bigcup_{i \in I} (X_i \times_S T_i)$.  It suffices to
prove that the image $f_T(Z)$ of $Z$ under $f_T : X \times_S T \to T$
is not closed.

\medskip\noindent
There exists a point $s \in S$ such that there is no
neighborhood $U$ of $s$ in $S$ such that $X_U$ is quasi-compact.
Otherwise we could cover $S$ with finitely many such $U$ and
Schemes, Lemma \ref{schemes-lemma-quasi-compact-affine}
would imply $f$ quasi-compact. Fix such an $s \in S$.

\medskip\noindent
First we check that $f_T(Z_s) \ne T_s$.  Let $t \in T$ be the point
lying over $s$ with $\kappa(t) = \kappa(s)$ such that $y_i = 1$ in
$\kappa(t)$ for all $i$.
Then $t \in T_i$ for all $i$, and the fiber of $Z_s \to T_s$ above
$t$ is isomorphic to $(X - \bigcup_{i \in I} X_i)_s$, which is empty.
Thus $t \in T_s - f_T(Z_s)$.

\medskip\noindent
Assume $f_T(Z)$ is closed in $T$. Then there exists an element
$g \in A[y_i; i \in I]$ with $f_T(Z) \subset V(g)$ but $t \not \in V(g)$.
Hence the image of $g$ in $\kappa(t)$ is nonzero. In particular some
coefficient of $g$ has nonzero image in $\kappa(s)$. Hence this coefficient is
invertible on some neighborhood $U$ of $s$. Let $J$ be the finite set of
$j \in I$ such that $y_j$ appears in $g$. Since $X_U$ is not quasi-compact,
we may choose a point $x \in X - \bigcup_{j \in J} X_j$ lying above some
$u \in U$. Since $g$ has a coefficient that is invertible on $U$, we can
find a point $t' \in T$ lying above $u$ such that $t' \not \in V(g)$ and
$t' \in V(y_i)$ for all $i \notin J$. This is true because
$V(y_i; i \in I, i \not\in J) = \text{Spec}(A[t_j; j\in J])$
and the set of points of this scheme lying over $u$ is bijective
with $\text{Spec}(\kappa(u)[t_j; j \in J])$. In other words $t' \notin T_i$
for each $i \notin J$. By
Schemes, Lemma \ref{schemes-lemma-points-fibre-product}
we can find a point $z$ of $X \times_S T$ mapping to $x \in X$ and to
$t' \in T$. Since $x \not \in X_j$ for $j \in J$ and $t' \not \in T_i$
for $i \in I \setminus J$ we see that $z \in Z$. On the other hand
$f_T(z) = t' \not \in V(g)$ which contradicts $f_T(Z) \subset V(g)$.
Thus the assumption ``$f_T(Z)$ closed'' is wrong and we conclude indeed
that $f_T$ is not closed, as desired.
\end{proof}



\section{Projective morphisms}
\label{section-projective}

\noindent
We will use the definition of a projective morphism from \cite{EGA}.
The version of the definition with the ``H'' is the one
from \cite{H}. The resulting definitions are different. Both are useful.

\begin{definition}
\label{definition-projective}
Let $f : X \to S$ be a morphism of schemes.
\begin{enumerate}
\item We say $f$ is {\it projective} if $X$ is isomorphic as
an $S$-scheme to a closed subscheme of a projective
bundle $\mathbf{P}(\mathcal{E})$ (see
Constructions, Definition \ref{constructions-definition-projective-bundle})
for some quasi-coherent, finite type $\mathcal{O}_S$-module $\mathcal{E}$.
\item We say $f$ is {\it H-projective} if there exists and integer $n$ and
a closed immersion $X \to \mathbf{P}^n_S$ over $S$.
\item We say $f$ is {\it locally projective} if there exists an open
covering $S = \bigcup U_i$ such that each $f^{-1}(U_i) \to U_i$ is
projective.
\end{enumerate}
\end{definition}

\begin{lemma}
\label{lemma-H-projective}
An H-projective morphism is projective.
\end{lemma}

\begin{proof}
This is true as $\mathbf{P}^n_S$ is a projective bundle over $S$, see
Constructions, Lemma \ref{constructions-lemma-projective-space-bundle}.
\end{proof}

\begin{lemma}
\label{lemma-H-quasi-projective-open-H-projective}
Let $f : X \to S$ be a H-quasi-projective morphism.
Then $f$ factors as $X \to X' \to S$ where $X \to X'$ is an
open immersion and $X' \to S$ is H-projective.
\end{lemma}

\begin{proof}
By definition we can factor $f$ as a quasi-compact immersion
$i : X \to \mathbf{P}^n_S$ followed by the projection $\mathbf{P}^n_S \to S$.
By Lemma \ref{lemma-quasi-compact-immersion} there exists a closed
subscheme $X' \subset \mathbf{P}^n_S$ such that $i$ factors through
an open immersion $X \to X'$. The lemma follows.
\end{proof}

\begin{lemma}
\label{lemma-characterize-locally-projective}
Let $f : X \to S$ be a morphism of schemes.
The following are equivalent:
\begin{enumerate}
\item The morphism $f$ is locally projective.
\item There exists an open covering $S = \bigcup U_i$ such
that each $f^{-1}(U_i) \to U_i$ is H-projective.
\end{enumerate}
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-H-projective} we see that (2) implies (1). Assume (1).
For every point $s \in S$ we can find $\text{Spec}(R) = U \subset S$
an affine open neighbourhood of $s$ such that $X_U$ is isomorphic to a
closed subscheme of $\mathbf{P}(\mathcal{E})$ for some finite type,
quasi-coherent sheaf of $\mathcal{O}_U$-modules $\mathcal{E}$.
Write $\mathcal{E} = \widetilde{M}$ for some finite type
$R$-module $M$ (see
Properties, Lemma \ref{properties-lemma-finite-type-module}).
Choose generators $x_0, \ldots, x_n \in M$ of $M$ as an $R$-module.
Consider the surjective graded $R$-algebra map
$$
R[X_0, \ldots, X_n] \longrightarrow \text{Sym}_R(M).
$$
According to
Constructions, Lemma \ref{constructions-lemma-surjective-graded-rings-map-proj}
the corresponding morphism
$$
\mathbf{P}(\mathcal{E}) \to \mathbf{P}^n_R
$$
is a closed immersion. Hence we conclude that $f^{-1}(U)$ is isomorphic
to a closed subscheme of $\mathbf{P}^n_U$ (as a scheme over $U$).
In other words: (2) holds.
\end{proof}

\begin{lemma}
\label{lemma-locally-projective-proper}
A locally projective morphism is proper.
\end{lemma}

\begin{proof}
Let $f : X \to S$ be locally projective.
In order to show that $f$ is proper we may work locally on the
base, see Lemma \ref{lemma-proper-local-on-the-base}.
Hence, by Lemma \ref{lemma-characterize-locally-projective}
above we may assume there exists a closed immersion $X \to \mathbf{P}^n_S$.
By Lemmas \ref{lemma-composition-proper}
and \ref{lemma-closed-immersion-proper} it suffices to prove that
$\mathbf{P}^n_S \to S$ is proper. Since
$\mathbf{P}^n_S \to S$ is the base change of
$\mathbf{P}^n_{\mathbf{Z}} \to \text{Spec}(\mathbf{Z})$ it suffices
to show that $\mathbf{P}^n_{\mathbf{Z}} \to \text{Spec}(\mathbf{Z})$
is proper, see Lemma \ref{lemma-base-change-proper}.
By Constructions, Lemma \ref{constructions-lemma-proj-separated} the scheme
$\mathbf{P}^n_{\mathbf{Z}}$ is separated.
By Constructions, Lemma \ref{constructions-lemma-proj-quasi-compact} the scheme
$\mathbf{P}^n_{\mathbf{Z}}$ is quasi-compact.
It is clear that $\mathbf{P}^n_{\mathbf{Z}} \to \text{Spec}(\mathbf{Z})$
is locally of finite type since $\mathbf{P}^n_{\mathbf{Z}}$ is
covered by the affine opens $D_{+}(X_i)$ each of which is the
spectrum of the finite type $\mathbf{Z}$-algebra
$$
\mathbf{Z}[X_0/X_i, \ldots, X_n/X_i].
$$
Finally, we have to show that
$\mathbf{P}^n_{\mathbf{Z}} \to \text{Spec}(\mathbf{Z})$
is universally closed. This follows from
Constructions, Lemma \ref{constructions-lemma-proj-valuative-criterion}
and the valuative criterion (see Schemes,
Proposition \ref{schemes-proposition-characterize-universally-closed}).
\end{proof}

\begin{lemma}
\label{lemma-segre-embedding}
Let $S$ be a scheme. There exists a closed immersion
$$
\mathbf{P}^n_S \times_S \mathbf{P}^m_S
\longrightarrow
\mathbf{P}^{nm + n + m}_S
$$
called the {\it Segre embedding}.
\end{lemma}

\begin{proof}
It suffices to prove this when $S = \text{Spec}(\mathbf{Z})$.
Hence we will drop the index $S$ and work in the absolute setting.
Write $\mathbf{P}^n = \text{Proj}(\mathbf{Z}[X_0, \ldots, X_n])$,
$\mathbf{P}^m = \text{Proj}(\mathbf{Z}[Y_0, \ldots, Y_m])$,
and
$\mathbf{P}^{nm + n + m} =
\text{Proj}(\mathbf{Z}[Z_0, \ldots, Z_{nm + n + m}])$.
In order to map into $\mathbf{P}^{nm + n + m}$ we have to
write down an invertible sheaf $\mathcal{L}$ on the left hand
side and $(n + 1)(m + 1)$ sections $s_i$ which generate it.
See Constructions, Lemma \ref{constructions-lemma-projective-space}.
The invertible sheaf we take is
$$
\mathcal{L} =
\text{pr}_1^*\mathcal{O}_{\mathbf{P}^n}(1)
\otimes
\text{pr}_2^*\mathcal{O}_{\mathbf{P}^m}(1)
$$
The sections we take are
$$
s_0 = X_0Y_0, \ s_1 = X_1Y_0, \ldots, \ s_n = X_nY_0, \ 
s_{n + 1} = X_0Y_1, \ldots, \ s_{nm + n + m} = X_nY_m.
$$
These generate $\mathcal{L}$ since the sections $X_i$ generate
$\mathcal{O}_{\mathbf{P}^n}(1)$ and the sections $Y_j$ generate
$\mathcal{O}_{\mathbf{P}^m}(1)$. The induced morphism
$\varphi$ has the property that
$$
\varphi^{-1}(D_{+}(Z_{i + (n + 1)j})) = D_{+}(X_i) \times D_{+}(Y_j).
$$
Hence it is an affine morphism. The corresponding ring map in case
$(i, j) = (0, 0)$ is the map
$$
\mathbf{Z}[Z_1/Z_0, \ldots, Z_{nm + n + m}/Z_0]
\longrightarrow
\mathbf{Z}[X_1/X_0, \ldots, X_n/X_0, Y_1/Y_0, \ldots, Y_n/Y_0]
$$
which maps $Z_i/Z_0$ to the element $X_i/X_0$ for $i \leq n$ and
the element $Z_{(n + 1)j}/Z_0$ to the element $Y_j/Y_0$. Hence it
is surjective. A similar argument works for the other affine
open subsets. Hence the morphism $\varphi$ is a closed immersion.
\end{proof}

\begin{lemma}
\label{lemma-H-projective-composition}
A composition of H-projective morphisms is H-projective.
\end{lemma}

\begin{proof}
Suppose $X \to Y$ and $Y \to Z$ are H-projective.
Then there exist closed immersions $X \to \mathbf{P}^n_Y$
over $Y$, and $Y \to \mathbf{P}^m_Z$ over $Z$.
Consider the following diagram
$$
\xymatrix{
X \ar[r] \ar[d] &
\mathbf{P}^n_Y \ar[r] \ar[dl] &
\mathbf{P}^n_{\mathbf{P}^m_Z} \ar[dl] \ar@{=}[r] &
\mathbf{P}^n_Z \times_Z \mathbf{P}^m_Z \ar[r] &
\mathbf{P}^{nm + n + m}_Z \ar[ddllll] \\
Y \ar[r] \ar[d] & \mathbf{P}^m_Z \ar[dl] & \\
Z & &
}
$$
Here the rightmost top horizontal arrow is the Segre embedding,
see Lemma \ref{lemma-segre-embedding}. The diagram identifies
$X$ as a closed subscheme of $\mathbf{P}^{nm + n + m}_Z$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-H-projective-base-change}
A base change of a H-projective morphism is H-projective.
\end{lemma}

\begin{proof}
This is true because the base change of projective space
over a scheme is projective space, and the fact that the base
change of a closed immersion is a closed immersion, see
Schemes, Lemma \ref{schemes-lemma-base-change-immersion}.
\end{proof}

\begin{lemma}
\label{lemma-base-change-projective}
A base change of a (locally) projective morphism is (locally) projective.
\end{lemma}

\begin{proof}
This is true because the base change of a projective bundle
over a scheme is a projective bundle, the pullback of
a finite type $\mathcal{O}$-module is of finite type
(Modules, Lemma \ref{modules-lemma-pullback-finite-type})
and the fact that the base
change of a closed immersion is a closed immersion, see
Schemes, Lemma \ref{schemes-lemma-base-change-immersion}.
Some details omitted.
\end{proof}

\begin{lemma}
\label{lemma-blowing-up-projective}
Le $X$ be a scheme.
Let $\mathcal{I} \subset \mathcal{O}_X$ be a quasi-coherent
sheaf of ideals. If $\mathcal{I}$ is of finite type, then
the blowing up of $X$ in the ideal sheaf $\mathcal{I}$ is
a projective morphism
$b : \underline{\text{Proj}}_X (\bigoplus_{n \geq 0} \mathcal{I}^n) \to X$.
\end{lemma}

\begin{proof}
Omitted. Hint: Use $\mathcal{I}$ as the sheaf $\mathcal{E}$
of the definition of a projective morphism.
\end{proof}











\section{Integral and finite morphisms}
\label{section-integral}

\noindent
Recall that a ring map $R \to A$ is said to be {\it integral}
if every element of $A$ satisfies a monic equation with
coefficients in $R$. Recall that a ring map $R \to A$ is
said to be finite if $A$ is {\it finite} as an $R$-module.
See Algebra, Definition \ref{algebra-definition-integral-ring-map}.

\begin{definition}
\label{definition-integral}
Let $f : X \to S$ be a morphism of schemes.
\begin{enumerate}
\item We say that $f$ is {\it integral} if $f$ is affine
and if for every affine open $\text{Spec}(R) = V \subset S$
with inverse image $\text{Spec}(A) = f^{-1}(V) \subset X$
the associated ring map $R \to A$ is integral.
\item We say that $f$ is {\it finite} if $f$ is affine
and if for every affine open $\text{Spec}(R) = V \subset S$
with inverse image $\text{Spec}(A) = f^{-1}(V) \subset X$
the associated ring map $R \to A$ is finite.
\end{enumerate}
\end{definition}

\noindent
It is clear that integral/finite morphisms are separated and
quasi-compact. It is also clear that a finite morphism is a
morphism of finite type. Most of the lemmas in this section are
completely standard.
But note the fun Lemma \ref{lemma-integral-universally-closed}
at the end of the section.

\begin{lemma}
\label{lemma-integral-local}
Let $f : X \to S$ be a morphism of schemes.
The following are equivalent:
\begin{enumerate}
\item The morphism $f$ is integral.
\item There exists an affine open covering $S = \bigcup U_i$ such that
each $f^{-1}(U_i)$ is affine and
$\mathcal{O}_S(U_i) \to \mathcal{O}_X(f^{-1}(U_i))$ is integral.
\item There exists an open covering $S = \bigcup S_j$
such that each $f^{-1}(U_i) \to U_i$ is integral.
\end{enumerate}
Moreover, if $f$ is integral then for every open subscheme
$U \subset S$ the morphism $f : f^{-1}(U) \to U$ is integral.
\end{lemma}

\begin{proof}
See Algebra, Lemma \ref{algebra-lemma-integral-local}.
Some details omitted.
\end{proof}

\begin{lemma}
\label{lemma-finite-local}
Let $f : X \to S$ be a morphism of schemes.
The following are equivalent:
\begin{enumerate}
\item The morphism $f$ is finite.
\item There exists an affine open covering $S = \bigcup U_i$ such that
each $f^{-1}(U_i)$ is affine and
$\mathcal{O}_S(U_i) \to \mathcal{O}_X(f^{-1}(U_i))$ is finite.
\item There exists an open covering $S = \bigcup S_j$
such that each $f^{-1}(U_i) \to U_i$ is finite.
\end{enumerate}
Moreover, if $f$ is finite then for every open subscheme
$U \subset S$ the morphim $f : f^{-1}(U) \to U$ is finite.
\end{lemma}

\begin{proof}
See Algebra, Lemma \ref{algebra-lemma-integral-local}.
Some details omitted.
\end{proof}

\begin{lemma}
\label{lemma-finite-integral}
A finite morphism is integral.
An integral morphism which is locally of finite type is finite.
\end{lemma}

\begin{proof}
See Algebra, Lemma \ref{algebra-lemma-finite-is-integral}
and Lemma \ref{algebra-lemma-characterize-finite-in-terms-of-integral}.
\end{proof}

\begin{lemma}
\label{lemma-composition-finite}
A composition of finite morphisms is finite.
Same is true for integral morphisms.
\end{lemma}

\begin{proof}
See Algebra, Lemmas \ref{algebra-lemma-finite-transitive}
and \ref{algebra-lemma-integral-transitive}.
\end{proof}

\begin{lemma}
\label{lemma-base-change-finite}
A base change of a finite morphism is finite.
Same is true for integral morphisms.
\end{lemma}

\begin{proof}
See Algebra, Lemma \ref{algebra-lemma-base-change-integral}.
\end{proof}

\begin{lemma}
\label{lemma-integral-universally-closed}
Let $f : X \to S$ be a morphism of schemes.
The following are equivalent
\begin{enumerate}
\item $f$ is integral, and
\item $f$ is affine and universally closed.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume (1). An integral morphism is affine by definition.
A base change of an integral morphism is integral so in order to prove (2)
it suffices to show that an integral morphism is closed.
This follows from Algebra, Lemmas \ref{algebra-lemma-integral-going-up}
and \ref{algebra-lemma-going-up-closed}.

\medskip\noindent
Assume (2). We may assume that $f$ is the morphism
$f : \text{Spec}(A) \to \text{Spec}(R)$ coming from a ring
map $R \to A$. Choose $a \in A$. We have to show that $a$
is integral over $R$. Let $I \subset R[x]$ be the ideal of
polynomials $P$ such that $P(a) = 0$ in $A$. Consider the commutative
diagram
$$
\xymatrix{
\text{Spec}(A) \ar[r]_-\varphi \ar[rd]_f &
\text{Spec}(R[x]) = \mathbf{A}^1_R \ar[r] \ar[d] &
\mathbf{P}^1_R  \ar[ld] \\
& \text{Spec}(R) &
}
$$
where $\varphi$ comes from the ring map $R[x] \to A$, $x \mapsto a$.
Since $f$ is universally closed we see that the image of $\varphi$
is closed in $\mathbf{P}^1_R$
(see Lemma \ref{lemma-image-proper-scheme-closed}). Working
out what this means we see that the ideal
$$
I' = \{ y^{\deg(P)}P(y^{-1}) \mid P(x) \in I \} \subset R[y]
$$
has the property that $I'$ surjects onto $R = R[y]/yR[y]$.
Translating back to $I$ this means exactly that $I$ contains
a monic polynomial as desired.
\end{proof}

\begin{lemma}
\label{lemma-integral-fibres}
Let $f : X \to S$ be an integral morphism.
Then every point of $X$ is closed in its fibre.
\end{lemma}

\begin{proof}
See Algebra, Lemma \ref{algebra-lemma-integral-no-inclusion}.
\end{proof}

\begin{lemma}
\label{lemma-finite-quasi-finite}
A finite morphism is quasi-finite.
\end{lemma}

\begin{proof}
This is implied by Algebra, Lemma \ref{algebra-lemma-quasi-finite}
and Lemma \ref{lemma-quasi-finite-locally-quasi-compact}.
Alternatively, all points in fibres are closed points by
Lemma \ref{lemma-integral-fibres} (and the fact that a finite
morphism is integral) and use
Lemma \ref{lemma-quasi-finite-at-point-characterize} (3) to
see that $f$ is quasi-finite at $x$ for all $x \in X$.
\end{proof}

\begin{lemma}
\label{lemma-finite-proper}
A finite morphism is proper.
\end{lemma}

\begin{proof}
A finite morphism is integral and hence universally closed by
Lemma \ref{lemma-integral-universally-closed}. It is also
clearly separated and of finite type. Hence it is proper by
definition.
\end{proof}

\begin{lemma}
\label{lemma-closed-immersion-finite}
A closed immersion is finite (and a fortiori integral).
\end{lemma}

\begin{proof}
True because a closed immersion is affine
(Lemma \ref{lemma-closed-immersion-affine})
and a surjective ring map is finite and integral.
\end{proof}

\begin{lemma}
\label{lemma-finite-permanence}
Let $f : X \to Y$ and $g : Y \to Z$ be morphisms.
\begin{enumerate}
\item If $g \circ f$ is finite and $g$ separated then $f$ is finite.
\item If $g \circ f$ is integral and $g$ separated then $f$ is integral.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume $g \circ f$ is finite (resp.\ integral) and $g$ separated.
The base change $X \times_Z Y \to Y$ is finite (resp.\ integral) by
Lemma \ref{lemma-base-change-finite}.
The morphism $X \to X \times_Z Y$ is
a closed immersion as $Y \to Z$ is separated, see
Schemes, \ref{schemes-lemma-section-immersion}.
A closed immersion is finite (resp.\ integral),
see Lemma \ref{lemma-closed-immersion-finite}.
The composition of finite (resp.\ integral) morphisms is finite
(resp.\ integral),
see Lemma \ref{lemma-composition-finite}. Thus we win.
\end{proof}

\begin{lemma}
\label{lemma-finite-monomorphism-closed}
Let $f : X \to Y$ be a morphism of schemes.
If $f$ is finite and a monomorphism, then $f$ is a closed immersion.
\end{lemma}

\begin{proof}
This reduces to
Algebra, Lemma \ref{algebra-lemma-finite-epimorphism-surjective}.
\end{proof}







\section{Universal homeomorphisms}
\label{section-universal-homeomorphisms}

\noindent
The following definition is really superfluous since a universal
homeomorphism is really just an integral, universally injective
and surjective morphism, see
Lemma \ref{lemma-universal-homeomorphism}.

\begin{definition}
\label{definition-universal-homeomorphism}
A morphisms $f : X \to Y$ of schemes is called a {\it universal homeomorphism}
if the base change $f' : Y' \times_Y X \to Y'$ is a homeomorphism for
every morphism $Y' \to Y$.
\end{definition}

\begin{lemma}
\label{lemma-homeomorphism-affine}
Let $f : X \to Y$ be a morphism of schemes.
If $f$ is a homeomorphism then $f$ is affine.
\end{lemma}

\begin{proof}
Let $y \in Y$ be a point. Let $y \in V$ be an affine open neighbourhood.
let $x \in X$ be the unique point of $X$ mapping to $y$.
Let $U \subset X$ be an affine open neighbourhood of $x$ which maps into $V$.
Since $f(U) \subset V$ is open we may choose a $h \in \Gamma(V, \mathcal{O}_Y)$
such that $y \in D(h) \subset f(U)$. Denote $h' \in \Gamma(U, \mathcal{O}_X)$
the restriction of $f^\sharp(h)$ to $U$. Then we see that
$D(h') \subset U$ is equal to $f^{-1}(D(h))$. In other words, every point
of $Y$ has an open neighbourhood whose inverse image is affine.
Thus $f$ is affine, see
Lemma \ref{lemma-characterize-affine}.
\end{proof}

\begin{lemma}
\label{lemma-universal-homeomorphism}
Let $f : X \to Y$ be a morphism of schemes. The following are
equivalent:
\begin{enumerate}
\item $f$ is a universal homeomorphism, and
\item $f$ is integral, universally injective and surjective.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume $f$ is a universal homeomorphism. By
Lemma \ref{lemma-homeomorphism-affine}
we see that $f$ is affine. Since $f$ is clearly universally closed we
see that $f$ is integral by
Lemma \ref{lemma-integral-universally-closed}.
It is also clear that $f$ is universally injective and surjective.

\medskip\noindent
Assume $f$ is integral, universally injective and surjective. By
Lemma \ref{lemma-integral-universally-closed}
$f$ is universally closed. Since it is also universally bijective (see
Lemma \ref{lemma-base-change-surjective})
we see that it is a universal homeomorphism.
\end{proof}

\begin{lemma}
\label{lemma-reduction-universal-homeomorphism}
Let $X$ be a scheme. The canonical closed immersion $X_{red} \to X$ (see
Schemes, Definition \ref{schemes-definition-reduced-induced-scheme})
is a universal homeomorphism.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}







\section{Finite locally free morphisms}
\label{section-finite-locally-free}

\noindent
In many papers the authors use finite flat morphisms when they really mean
finite locally free morphisms. The reason is that if the base is locally
Noetherian then this is the same thing. But in general it is not, see
Exercises, Exercise \ref{exercises-exercise-flat-not-projective}.

\begin{definition}
\label{definition-finite-locally-free}
Let $f : X \to S$ be a morphism of schemes.
We say $f$ is {\it finite locally free} if $f$ is
affine and $f_*\mathcal{O}_X$ is a finite locally
free $\mathcal{O}_S$-module. In this case we say $f$ is
has {\it rank} or {\it degree} $d$
if the sheaf $f_*\mathcal{O}_X$ is finite locally free of degree $d$.
\end{definition}

\begin{lemma}
\label{lemma-finite-flat}
Let $f : X \to S$ be a morphism of schemes.
The following are equivalent:
\begin{enumerate}
\item $f$ is finite locally free,
\item $f$ is finite, flat, and locally of finite presentation.
\end{enumerate}
If $S$ is locally Noetherian these are also equivalent to
\begin{enumerate}
\item[(3)] $f$ is finite and flat.
\end{enumerate}
\end{lemma}

\begin{proof}
See Algebra, Lemma \ref{algebra-lemma-finite-projective}.
The Noetherian case follows also since a finite module
over a Noetherian ring is a finitely presented module.
\end{proof}

\begin{lemma}
\label{lemma-composition-finite-locally-free}
A composition of finite locally free morphisms is finite locally free.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-base-change-finite-locally-free}
A base change of a finite locally free morphism is finite locally free.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-finite-locally-free}
Let $f : X \to S$ be a finite locally free morphism of schemes.
There exists a disjoint union decomposition
$S = \coprod_{d \geq 0} S_d$ by open and closed subschemes
such that setting $X_d = f^{-1}(S_d)$ the restrictions
$f|_{X_d}$ are finite locally free morphisms $X_d \to S_d$
of degree $d$.
\end{lemma}

\begin{proof}
This is true because a finite locally free sheaf locally has
a well defined rank. Details omittted.
\end{proof}

\begin{lemma}
\label{lemma-massage-finite}
Let $f : Y \to X$ be a finite morphism with $X$ affine.
There exists a diagram
$$
\xymatrix{
Z' \ar[rd] &
Y' \ar[l]^i \ar[d] \ar[r] &
Y \ar[d] \\
 & X' \ar[r] & X
}
$$
where
\begin{enumerate}
\item $Y' \to Y$ and $X' \to X$ are surjective finite locally free,
\item $Y' = X' \times_X Y$,
\item $i : Y' \to Z'$ is a closed immersion,
\item $Z' \to X'$ is finite locally free, and
\item $Z' = \bigcup_{j = 1, \ldots, m} Z'_j$ is a (set theoretic)
finite union of closed subschemes, each of which maps isomorphically
to $X'$.
\end{enumerate}
\end{lemma}

\begin{proof}
Write $X = \text{Spec}(A)$ and $Y = \text{Spec}(B)$. See also
Algebra, Section \ref{algebra-section-descent-flatness-integral}.
Let $x_1, \ldots, x_n \in B$ be generators of $B$ over $A$.
For each $i$ we can choose a monic polynomial $P_i(T) \in A[T]$
such that $P(x_i) = 0$ in $B$. By
Algebra, Lemma \ref{algebra-lemma-adjoin-roots}
(applied $n$ times) there exists a finite locally free ring
extension $A \subset A'$ such that each $P_i$ splits completely:
$$
P_i(T) = \prod\nolimits_{k = 1, \ldots, d_i} (T - \alpha_{ik})
$$
for certain $\alpha_{ik} \in A'$. Set
$$
C = A'[T_1, \ldots, T_n]/(P_1(T_1), \ldots, P_n(T_n))
$$
and $B' = A' \otimes_A B$. The map $C \to B'$, $T_i \mapsto 1 \otimes x_i$
is an $A'$-algebra surjection. Setting $X' = \text{Spec}(A')$,
$Y' = \text{Spec}(B')$ and $Z' = \text{Spec}(C)$ we see that
(1) -- (4) hold. Part (5) holds because set theoretically
$\text{Spec}(C)$ is the union of the closed subschemes
cut out by the ideals
$$
(T_1 - \alpha_{1k_1}, T_2 - \alpha_{2k_2}, \ldots, T_n - \alpha_{nk_n})
$$
for any $1 \leq k_i \leq d_i$.
\end{proof}

\noindent
The following lemma is stated in the correct generality
in Lemma \ref{lemma-image-nowhere-dense-quasi-finite} below.

\begin{lemma}
\label{lemma-image-nowhere-dense-finite}
Let $f : Y \to X$ be a finite morphism of schemes.
Let $T \subset Y$ be a closed nowhere dense subset of $Y$.
Then $f(T) \subset X$ is a closed nowhere dense subset of $X$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-finite-proper} we know that $f(T) \subset X$ is closed.
Let $X = \bigcup X_i$ be an affine covering.
Since $T$ is nowhere dense in $Y$, we see that also $T \cap f^{-1}(X_i)$
is nowhere dense in $f^{-1}(X_i)$. Hence if we can prove the theorem in the
affine case, then we see that $f(T) \cap X_i$ is nowhere dense.
This then implies that $T$ is nowhere dense in $X$ by
Topology, Lemma \ref{topology-lemma-nowhere-dense-local}.

\medskip\noindent
Assume $X$ is affine. Choose a diagram
$$
\xymatrix{
Z' \ar[rd] &
Y' \ar[l]^i \ar[d]^{f'} \ar[r]_a &
Y \ar[d]^f \\
 & X' \ar[r]^b & X
}
$$
as in Lemma \ref{lemma-massage-finite}. The morphisms $a$, $b$ are
open since they are finite locally free
(Lemmas \ref{lemma-finite-flat} and \ref{lemma-fppf-open}).
Hence $T' = a^{-1}(T)$ is nowhere dense, see
Topology, Lemma \ref{topology-lemma-open-inverse-image-closed-nowhere-dense}.
The morphism $b$ is surjective and open.
Hence, if we can prove $f'(T') = b^{-1}(f(T))$ is
nowhere dense, then $f(T)$ is nowhere dense, see
Topology, Lemma \ref{topology-lemma-open-inverse-image-closed-nowhere-dense}.
As $i$ is a closed immersion, by
Topology, Lemma \ref{topology-lemma-closed-image-nowhere-dense}
we see that $i(T') \subset Z'$ is closed and nowhere dense.
Thus we have reduced the problem to the case discussed
in the following paragraph.

\medskip\noindent
Assume that $Y = \bigcup_{i = 1, \ldots, n} Y_i$ is a finite union of
closed subsets, each mapping isomorphically to $X$. Consider
$T_i = Y_i \cap T$. If each of the $T_i$ is nowhere dense in $Y_i$,
then each $f(T_i)$ is nowhere dense in $X$ as $Y_i \to X$ is an isomorphism.
Hence $f(T) = f(T_i)$ is a finite union of nowhere dense closed
subsets of $X$ and we win, see
Topology, Lemma \ref{topology-lemma-nowhere-dense}.
Suppose not, say $T_1$ contains a nonempty open $V \subset Y_1$.
We are going to show this leads to a contradiction.
Consider $Y_2 \cap V \subset V$. This is either
a proper closed subset, or equal to $V$. In the first case we replace
$V$ by $V \setminus V \cap Y_2$, so $V \subset T_1$ is open in $Y_1$ and
does not meet $Y_2$. In the second case we have
$V \subset Y_1 \cap Y_2$ is open in both $Y_1$ and $Y_2$.
Repeat sequentially with $i = 3, \ldots, n$. The result is a disjoint
union decomposition
$$
\{1, \ldots, n\} = I_1 \coprod I_2,\quad 1 \in I_1
$$
and an open $V$ of $Y_1$ contained in $T_1$ such that $V \subset Y_i$
for $i \in I_1$ and $V \cap Y_i = \emptyset$ for $i \in I_2$. Set
$U = f(V)$. This is an open of $X$ since $f|_{Y_1} : Y_1 \to X$ is
an isomorphism. Then
$$
f^{-1}(U) = V\ \coprod\ \bigcup\nolimits_{i \in I_2} (Y_i \cap f^{-1}(U))
$$
As $\bigcup_{i \in I_2} Y_i$ is closed, this implies that
$V \subset f^{-1}(U)$ is open, hence $V \subset Y$ is open.
This contradicts the assumption that $T$ is nowhere dense in $Y$, as desired.
\end{proof}


\section{Generically finite morphisms}
\label{section-generically-finite}

\noindent
In this section we characterize maps between schemes
which are locally of finite type and which are ``generically finite''
in some sense.

\begin{lemma}
\label{lemma-generically-finite}
Let $X$, $Y$ be schemes.
Let $f : X \to Y$ be locally of finite type.
Let $\eta \in Y$ be a generic point of an irreducible component
of $Y$. The following are equivalent:
\begin{enumerate}
\item the set $f^{-1}(\{\eta\})$ is finite,
\item there exist affine opens $U_i \subset X$, $i = 1, \ldots, n$
and $V \subset Y$ with $f(U_i) \subset V$,
$\eta \in V$ and $f^{-1}(\{\eta\}) \subset \bigcup U_i$
such that each $f|_{U_i} : U_i \to V$ is finite.
\end{enumerate}
If $f$ is quasi-separated, then these are also equivalent to
\begin{enumerate}
\item[(3)] there exist affine opens $V \subset Y$,
and $U \subset X$ with $f(U) \subset V$,
$\eta \in V$ and $f^{-1}(\{\eta\}) \subset U$
such that $f|_U : U \to V$ is finite.
\end{enumerate}
If $f$ is quasi-compact and quasi-separated,
then these are also equivalent to
\begin{enumerate}
\item[(4)] there exists an affine open $V \subset Y$, $\eta \in V$
such that $f^{-1}(V) \to V$ is finite.
\end{enumerate}
\end{lemma}

\begin{proof}
The question is local on the base. Hence we may replace $Y$ by an
affine neighbourhood of $\eta$, and we may and do assume throughout
the proof below that $Y$ is affine, say $Y = \text{Spec}(R)$.

\medskip\noindent
It is clear that (2) implies (1).
Assume that $f^{-1}(\{\eta\}) = \{\xi_1, \ldots, \xi_n\}$ is finite.
Choose affine opens $U_i \subset X$ with $\xi_i \in U_i$.
By Algebra, Lemma \ref{algebra-lemma-generically-finite} we see
that after replacing $Y$ by a standard open in
$Y$ each of the morphisms $U_i \to Y$ is finite.
In other words (2) holds.

\medskip\noindent
It is clear that (3) implies (1).
Assume $f^{-1}(\{\eta\}) = \{\xi_1, \ldots, \xi_n\}$ and assume
that $f$ is quasi-separated.
Since $Y$ is affine this implies that $X$ is quasi-separated.
Since each $\xi_i$ maps to a generic point of an irreducible component
of $Y$, we see that each $\xi_i$ is a generic point of an irreducible
component of $X$.
By Properties, Lemma \ref{properties-lemma-maximal-points-affine}
we can find an affine open $U \subset X$ containing each $\xi_i$.
By Algebra, Lemma \ref{algebra-lemma-generically-finite} we see
that after replacing $Y$ by a standard open in
$Y$ the morphisms $U \to Y$ is finite.
In other words (3) holds.

\medskip\noindent
It is clear that (4) implies all of (1) -- (3) with no further assumptions
on $f$. Suppose that $f$ is quasi-compact and quasi-separated. We have to
show that the equivalent conditions (1) -- (3) imply (4).
Let $U$, $V$ be as in (3). Replace $Y$ by $V$. Since $f$ is quasi-compact
and $Y$ is quasi-compact (being affine) we see that $X$ is quasi-compact.
Hence $Z = X \setminus U$ is quasi-compact, hence the morphism
$f|_Z : Z \to Y$ is quasi-compact. By construction of $Z$ we see that
$\eta \not \in f(Z)$. Hence by
Lemma \ref{lemma-quasi-compact-generic-point-not-in-image}
we see that there exists an affine open
neighbourhood $V'$ of $\eta$ in $Y$ such that $f^{-1}(V') \cap Z = \emptyset$.
Then we have $f^{-1}(V') \subset U$ and this means
that $f^{-1}(V') \to V'$ is finite.
\end{proof}

\begin{example}
\label{example-counter-generically-finite}
Let $A = \prod_{n \in \mathbf{N}} \mathbf{F}_2$.
Every element of $A$ is an idempotent. Hence every prime ideal is maximal
with residue field $\mathbf{F}_2$.
Thus the topology on $X = \text{Spec}(A)$ is totally disconnected
and quasi-compact. The projection maps $A \to \mathbf{F}_2$ define open
points of $\text{Spec}(A)$. It cannot be the case that all the points
of $X$ are open since $X$ is quasi-compact. Let $x \in X$ be a closed
point which is not open. Then we can form a scheme $Y$ which is two
copies of $X$ glued along $X \setminus \{x\}$. In other words, this
is $X$ with $x$ doubled, compare
Schemes, Example \ref{schemes-example-affine-space-zero-doubled}.
The morphism
$f : Y \to X$ is quasi-compact, finite type and has finite fibres
but is not quasi-separated.
The point $x \in X$ is a generic point of an irreducible component
of $X$ (since $X$ is totally disconnected). But properties (3) and (4)
of Lemma \ref{lemma-generically-finite} do not hold. The reason is that
for any open neighbourhood $x \in U \subset X$ the inverse image
$f^{-1}(U)$ is not affine because functions on $f^{-1}(U)$ cannot
separated the two points lying over $x$ (proof omitted; this is a
nice exercise). Hence the condition that $f$ is quasi-separated is
necessary in parts (3) and (4) of the lemma.
\end{example}

\begin{remark}
\label{remark-quasi-finite-finite-over-dense-open}
An alternative to
Lemma \ref{lemma-generically-finite}
is the statement that a quasi-finite morphism is finite
over a dense open of the target. This will be shown in
More on Morphisms,
Section \ref{more-morphisms-section-application-etale-neighbourhoods}.
\end{remark}

\begin{lemma}
\label{lemma-finite-degree}
Let $X$, $Y$ be integral schemes.
Let $f : X \to Y$ be locally of finite type.
Assume $f$ is dominant.
The following are equivalent:
\begin{enumerate}
\item the extension $R(Y) \subset R(X)$ has
transcendence degree $0$,
\item the extension $R(Y) \subset R(X)$ is finite,
\item there exist nonempty affine opens $U \subset X$
and $V \subset Y$ such that $f(U) \subset V$
and $f|_U : U \to V$ is finite, and
\item the generic point of $X$ is the only point of $X$ mapping to
the generic point of $Y$.
\end{enumerate}
If $f$ is separated, or if $f$ is quasi-compact, then these are
also equivalent to
\begin{enumerate}
\item[(5)] there exists a nonempty affine open $V \subset Y$ such
that $f^{-1}(V) \to V$ is finite.
\end{enumerate}
\end{lemma}

\begin{proof}
Choose any affine opens $\text{Spec}(A) = U \subset X$
and $\text{Spec}(R) = V \subset Y$ such that $f(U) \subset V$.
Then $R$ and $A$ are domains by definition. The ring map
$R \to A$ is of finite type
Lemma \ref{lemma-locally-finite-type-characterize}).
Let $K = f.f.(R) = R(Y)$ and $L = f.f.(A) = R(X)$. Then $K \subset L$
is a finitely generated field extension. Hence we see that
(1) is equivalent to (2).

\medskip\noindent
Suppose (2) holds. Let $x_1, \ldots, x_n \in A$ be generators
of $A$ over $R$. By assumption there exist nonzero polynomials
$P_i(X) \in R[X]$ such that $P_i(x_i) = 0$. Let $f_i \in R$ be the
leading coefficient of $P_i$. Then we conclude that
$R_{f_1 \ldots f_n} \to A_{f_1 \ldots f_n}$ is finite, i.e., (3) holds.
Note that (3) implies (2). So now we see that (1), (2) and (3) are all
equivalent.

\medskip\noindent
Let $\eta$ be the generic point of $X$, and let $\eta' \in Y$ be the
generic point of $Y$. Assume (4). Then
$\dim_\eta(X_{\eta'}) = 0$ and we see that $R(X) = \kappa(\eta)$ has
transcendence degree $0$ over $R(Y) = \kappa(\eta')$ by
Lemma \ref{lemma-dimension-fibre-at-a-point}.
In other words (1) holds. Assume the equivalent conditions (1), (2) and
(3). Suppose that $x \in X$ is a point mapping to $\eta'$.
As $x$ is a specialization of $\eta$,
this gives inclusions $R(Y) \subset \mathcal{O}_{X, x} \subset R(X)$,
which implies $\mathcal{O}_{X, x}$ is a field, see
Algebra, Lemma \ref{algebra-lemma-integral-over-field}.
Hence $x = \eta$. Thus we see that (1) -- (4)
are all equivalent.

\medskip\noindent
It is clear that (5) implies (3) with no additional assumptions on
$f$. What remains is to prove that if $f$ is either separated or
quasi-compact, then the equivalent conditions (1) -- (4) imply (5).

\medskip\noindent
Assume $U, V$ as in (3) and assume $f$ is separated.
Then $U \to f^{-1}(V)$ is a morphism from a scheme proper over $V$
Lemma \ref{lemma-finite-proper})
into a scheme separated over $V$.
Hence $U \subset f^{-1}(V)$ is closed
Lemma \ref{lemma-image-proper-scheme-closed}.
Since $X$ is irreducible we conclude $U = f^{-1}(V)$. This
proves (5).

\medskip\noindent
Assume $f$ is quasi-compact. Let $U, V$ be as in (3).
Then $f^{-1}(V)$ is quasi-compact. Consider the closed subset
$Z = f^{-1}(V) \setminus U$. Since $Z$ does not contain the
generic point of $X$ we see that the quasi-compact morphism
$f : Z \to V$ is not dominant by
Lemma \ref{lemma-quasi-compact-dominant}.
Hence after shrinking $V$ we may assume that $f^{-1}(V) = U$
which implies that (5) holds.
\end{proof}

\begin{definition}
\label{definition-degree}
Let $X$ and $Y$ be integral schemes.
Let $f : X \to Y$ be locally of finite type and dominant.
Assume $[R(X) : R(Y)] < \infty$, or any other of the equivalent
conditions (1) -- (4) of Lemma \ref{lemma-finite-degree}.
Then the positive integer
$$
\text{deg}(X/Y) = [R(X) : R(Y)]
$$
is called the {\it degree of $X$ over $Y$}.
\end{definition}

\noindent
It is possible to extend this notion to a morphism
$f : X \to Y$ if (a) $Y$ is integral with generic point $\eta$,
(b) $f$ is locally of finite type, and (c) $f^{-1}(\{\eta\})$ is finite.
Namely, in this case we can define
$$
\deg(X/Y)
=
\sum\nolimits_{\xi \in X,\ f(\xi) = \eta}
\dim_{R(Y)} (\mathcal{O}_{X, \xi}).
$$
Namely, given that $R(Y) = \kappa(\eta) = \mathcal{O}_{Y, \eta}$
(Lemma \ref{lemma-integral-scheme-rational-functions})
the dimensions above are finite by
Lemma \ref{lemma-generically-finite} above.
However, for most applications the definition given above
is the right one.

\begin{lemma}
\label{lemma-degree-composition}
Let $X$, $Y$, $Z$ be integral schemes.
Let $f : X \to Y$ and $g : Y \to Z$ be dominant morphisms locally
of finite type. Assume that $[R(X) : R(Y)] < \infty$ and
$[R(Y) : R(Z)] < \infty$. Then
$$
\deg(X/Z) = \deg(X/Y) \deg(Y/Z).
$$
\end{lemma}

\begin{proof}
This comes from the multiplicativity of degrees in towers
of finite extensions of fields.
\end{proof}









\section{Normalization}
\label{section-normalization}

\noindent
In this section we construct the {\it normalization}, and the
{\it normalization of one scheme in another}.

\begin{lemma}
\label{lemma-integral-closure}
Let $X$ be a scheme. Let $\mathcal{A}$ be a quasi-coherent sheaf
of $\mathcal{O}_X$-algebras. The subsheaf $\mathcal{A}' \subset \mathcal{A}$
defined by the rule
$$
U \longmapsto \{f \in \mathcal{A}(U) \mid
f_x \in \mathcal{A}_x \text{ integral over } \mathcal{O}_{X, x}
\text{ for all }x \in U\}
$$
is a quasi-coherent $\mathcal{O}_X$-algebra, and for any affine open
$U \subset X$ the ring $\mathcal{A}'(U) \subset \mathcal{A}(U)$ is
the integral closure of $\mathcal{O}_X(U)$ in $\mathcal{A}(U)$.
\end{lemma}

\begin{proof}
This is a subsheaf by the local nature of the conditions.
It is an $\mathcal{O}_X$-algebra by
Algebra, Lemma \ref{algebra-lemma-integral-closure-is-ring}.
Let $U \subset X$ be an affine open. Say $U = \text{Spec}(R)$
and say $\mathcal{A}$ is the quasi-coherent sheaf associated to
the $R$-algebra $A$. Then according to
Algebra, Lemma \ref{algebra-lemma-integral-closure-stalks}
the value of $\mathcal{A}'$ over $U$ is given by the integral
closure $A'$ of $R$ in $A$. This proves the last assertion of
the lemma. To prove that $\mathcal{A}'$ is quasi-coherent, it
suffices to show that $\mathcal{A}'(D(f)) = A'_f$. This follows
from the fact that integral closure and localization commute, see
Algebra, Lemma \ref{algebra-lemma-integral-closure-localize}.
\end{proof}

\begin{definition}
\label{definition-integral-closure}
Let $X$ be a scheme. Let $\mathcal{A}$ be a quasi-coherent sheaf
of $\mathcal{O}_X$-algebras. The {\it integral closure of $\mathcal{O}_X$
in $\mathcal{A}$} is the quasi-coherent $\mathcal{O}_X$-subalgebra
$\mathcal{A}' \subset \mathcal{A}$ constructed in
Lemma \ref{lemma-integral-closure} above.
\end{definition}

\noindent
In the setting of the definition above we can consider the morphism
of relative spectra
$$
\xymatrix{
Y = \underline{\text{Spec}}_X(\mathcal{A}) \ar[rr] \ar[rd] & &
X' = \underline{\text{Spec}}_X(\mathcal{A}') \ar[ld] \\
& X &
}
$$
see Lemma \ref{lemma-affine-equivalence-algebras}.
The scheme $X' \to X$ will be the normalization of $X$ in the scheme $Y$.
Here is a slightly more general setting. Suppose we have a
quasi-compact and quasi-separated morphism $f : Y \to X$
of schemes. In this case the sheaf of
$\mathcal{O}_X$-algebras $f_*\mathcal{O}_Y$ is quasi-coherent, see
Schemes, Lemma \ref{schemes-lemma-push-forward-quasi-coherent}.
Taking the integral closure $\mathcal{O}' \subset f_*\mathcal{O}_Y$
we obtain a quasi-coherent sheaf of $\mathcal{O}_X$-algebras
whose relative spectrum is the normalization of $X$ in $Y$. Here is
the formal definition.

\begin{definition}
\label{definition-normalization-X-in-Y}
Let $f : Y \to X$ be a quasi-compact and quasi-separated morphism of schemes. 
Let $\mathcal{O}'$ be the integral closure of $\mathcal{O}_X$ in
$f_*\mathcal{O}_Y$. The {\it normalization of $X$ in $Y$} is the
scheme\footnote{The scheme $X'$ need not be normal, for example if
$Y = X$ and $f = \text{id}_X$, then $X' = X$.}
$$
\nu : X' = \underline{\text{Spec}}_X(\mathcal{O}') \to X
$$
over $X$. It comes equipped with a natural factorization
$$
Y \xrightarrow{f'} X' \xrightarrow{\nu} X
$$
of the initial morphism $f$.
\end{definition}

\noindent
The factorization is the composition of the canonical morphism
$Y \to \underline{\text{Spec}}(f_*\mathcal{O}_Y)$ (see
Lemma \ref{constructions-lemma-canonical-morphism})
and the morphism of relative spectra coming from the inclusion map
$\mathcal{O}' \to f_*\mathcal{O}_Y$. We can characterize the
normalization as follows.

\begin{lemma}
\label{lemma-characterize-normalization}
Let $f : Y \to X$ be a quasi-compact and quasi-separated morphism of schemes.
The factorization $f = \nu \circ f'$, where $\nu : X' \to X$ is the
normalization of $X$ in $Y$ is characterized by the following
two properties:
\begin{enumerate}
\item the morphism $\nu$ is integral, and
\item for any factorization $f = \pi \circ g$, with $\pi : Z \to X$
integral, there exists a commutative diagram
$$
\xymatrix{
Y \ar[d]_{f'} \ar[r]_g & Z \ar[d]^\pi \\
X' \ar[ru]^h \ar[r]^\nu & X
}
$$
for some unique morphism $h : X' \to Z$.
\end{enumerate}
Moreover, in (2) the morphism $h : X' \to Z$ is the normalization of
$Z$ in $Y$.
\end{lemma}

\begin{proof}
Let $\mathcal{O}' \subset f_*\mathcal{O}_Y$ be the integral closure of
$\mathcal{O}_X$ as in Definition \ref{definition-normalization-X-in-Y}.
The morphism $\nu$ is integral by construction, which proves (1).
Assume given a factorization $f = \pi \circ g$ with $\pi : Z \to X$
integral as in (2). By Definition \ref{definition-integral}
Then $\pi$ is affine, and hence $Z$ is the relative
spectrum of a quasi-coherent sheaf of $\mathcal{O}_X$-algebras $\mathcal{B}$.
The morphism $g : X \to Z$ corresponds to a map of $\mathcal{O}_X$-algebras
$\chi : \mathcal{B} \to f_*\mathcal{O}_Y$. Since $\mathcal{B}(U)$ is
integral over $\mathcal{O}_X(U)$ for every affine open $U \subset X$
(by Definition \ref{definition-integral})
we see from Lemma \ref{lemma-integral-closure}
that $\chi(\mathcal{B}) \subset \mathcal{O}'$.
By the functoriality of the relative spectrum
Lemma \ref{lemma-affine-equivalence-algebras}
this provides us with a unique morphism
$h : X' \to Z$. We omit the verification that the diagram commutes.

\medskip\noindent
It is clear that (1) and (2) characterize the
factorization $f = \nu \circ f'$ since it characterizes it
as an initial object in a category. The morphism $h$ in (2)
is integral by Lemma \ref{lemma-finite-permanence}.
Given a factorization $g = \pi' \circ g'$ with $\pi' : Z' \to Z$
integral, we get a factorization $f = (\pi \circ \pi') \circ g'$ and
we get a morphism $h' : X' \to Z'$. Uniqueness implies that
$\pi' \circ h' = h$. Hence the characterization (1), (2) applies
to the morphism $h : X' \to Z$ which gives the last statement of the lemma.
\end{proof}

\begin{lemma}
\label{lemma-functoriality-normalization}
Let
$$
\xymatrix{
Y_2 \ar[d]_{f_2} \ar[r] & Y_1 \ar[d]^{f_1} \\
X_2 \ar[r] & X_1
}
$$
be a commutative diagram of morphisms of schemes.
Assume $f_1$, $f_2$ quasi-compact and quasi-separated.
Let $f_i = \nu_i \circ f_i'$, $i = 1, 2$
be the canonical factorizations, where $\nu_i : X_i' \to X_i$ is
the normalization of $X_i$ in $Y_i$. Then there exists a
canonical commutative diagram
$$
\xymatrix{
Y_2 \ar[d]_{f_2'} \ar[r] & Y_1 \ar[d]^{f_1'} \\
X_2' \ar[d]_{\nu_2} \ar[r] & X_1' \ar[d]^{\nu_1} \\
X_2 \ar[r] & X_1
}
$$
\end{lemma}

\begin{proof}
By Lemmas \ref{lemma-characterize-normalization} (1)
and \ref{lemma-base-change-finite}
the base change $X_2 \times_{X_1} X'_1 \to X_2$
is integral. Note that $f_2$ factors through this morphism.
Hence we get a canonical morphism
$X'_2 \to X_2 \times_{X_1} X'_1$ from
Lemma \ref{lemma-characterize-normalization} (2).
This gives the middle horizontal arrow in the last diagram.
\end{proof}

\begin{lemma}
\label{lemma-normalization-localization}
Let $f : Y \to X$ be a quasi-compact and quasi-separated morphism of schemes.
Let $U \subset X$ be an open subscheme and set $V = f^{-1}(U)$.
Then the normalization of $U$ in $V$ is the inverse image of $U$
in the normalization of $X$ in $Y$.
\end{lemma}

\begin{proof}
Clear from the construction.
\end{proof}

\begin{lemma}
\label{lemma-normalization-in-disjoint-union}
Let $f : Y \to X$ be a quasi-compact and quasi-separated morphism of schemes.
Suppose that $Y = Y_1 \coprod Y_2$ is a disjoint union of two schemes.
Write $f_i = f_{Y_i}$. Let $X_i'$ be the normalization of $X$ in $Y_i$.
Then $Y_1' \coprod Y_2'$ is the normalization of $X$ in $Y$.
\end{lemma}

\begin{proof}
In terms of integral closures this corresponds to the following fact:
Let $A \to B$ be a ring map. Suppose that $B = B_1 \times B_2$.
Let $A_i'$ be the integral closure of $A$ in $B_i$. Then
$A_1' \times A_2'$ is the integral closure of $A$ in $B$.
The reason this works is that the elements $(1, 0)$ and $(0, 1)$ of $B$
are idempotents and hence integral over $A$. Thus the integral closure
$A'$ of $A$ in $B$ is a product and it is not hard to see that the factors
are the integral closures $A'_i$ as described above (some details
omitted).
\end{proof}

\begin{lemma}
\label{lemma-normalization-in-integral}
Let $f : Y \to X$ be an integral morphism.
Then the integral closure of $X$ in $Y$ is equal to $Y$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\noindent
The following lemma is a generalization of the preceding one.

\begin{lemma}
\label{lemma-normalization-in-universally-closed}
Let $f : X \to S$ be a quasi-compact, quasi-separated and
universally closed morphisms of schemes.
Then $f_*\mathcal{O}_X$ is integral over $\mathcal{O}_S$. In other
words, the normalization of $S$ in $X$ is equal to the factorization
$$
X \longrightarrow \underline{\text{Spec}}_S(f_*\mathcal{O}_X)
\longrightarrow S
$$
of Constructions, Lemma \ref{constructions-lemma-canonical-morphism}.
\end{lemma}

\begin{proof}
The question is local on $S$, hence we may assume $S = \text{Spec}(R)$
is affine. Let $h \in \Gamma(X, \mathcal{O}_X)$. We have to show that
$h$ satisfies a monic equation over $R$. Think of $h$ as a morphism
as in the following commutative diagram
$$
\xymatrix{
X \ar[rr]_h \ar[rd]_f & & \mathbf{A}^1_S \ar[ld] \\
& S &
}
$$
Let $Z \subset \mathbf{A}^1_S$ be the scheme theoretic image of $h$,
see Definition \ref{definition-scheme-theoretic-image}.
The morphism $h$ is quasi-compact as $f$ is quasi-compact and
$\mathbf{A}^1_S \to S$ is separated, see
Schemes, Lemma \ref{schemes-lemma-quasi-compact-permanence}.
By Lemma \ref{lemma-quasi-compact-scheme-theoretic-image} the
morphism $X \to Z$ is dominant. By
Lemma \ref{lemma-image-proper-scheme-closed} the morphism
$X \to Z$ is closed. Hence $h(X) = Z$ (set theoretically).
Thus we can use
Lemma \ref{lemma-image-proper-is-proper}
to conclude that $Z \to S$ is universally closed (and even proper).
Since $Z \subset \mathbf{A}^1_S$, we see that $Z \to S$ is affine
and proper, hence integral by Lemma \ref{lemma-integral-universally-closed}.
Writing $\mathbf{A}^1_S = \text{Spec}(R[T])$ we conclude that
the ideal $I \subset R[T]$ of $Z$ contains a monic polynomial
$P(T) \in R[T]$. Hence $P(h) = 0$ and we win.
\end{proof}

\begin{lemma}
\label{lemma-normal-normalization}
Let $f : Y \to X$ be a quasi-compact and quasi-separated morphism
of schemes. Assume
\begin{enumerate}
\item $Y$ is a normal scheme,
\item any quasi-compact open $V \subset Y$ has a finite number of
irreducible components.
\end{enumerate}
Then the normalization $X'$ of $X$ in $Y$ is a normal scheme. Moreover,
the morphism $Y \to X'$ is dominant and induces a bijection of
irreducible components.
\end{lemma}

\begin{proof}
We first prove that $X'$ is normal.
Let $U \subset X$ be an affine open. It suffices to prove that
the inverse image of $U$ in $X'$ is normal (see
Properties, Lemma \ref{properties-lemma-locally-normal}).
By Lemma \ref{lemma-normalization-localization} we may replace $X$ by $U$,
and hence we may assume $X = \text{Spec}(A)$ affine.
In this case $Y$ is quasi-compact, and hence has a finite number of
irreducible components by assumption. Hence
$Y = \coprod_{i = 1, \ldots n} Y_i$ is a finite disjoint union of
normal integral schemes by
Properties, Lemma \ref{properties-lemma-normal-locally-finite-nr-irreducibles}.
By Lemma \ref{lemma-normalization-in-disjoint-union}
we see that $X' = \coprod_{i = 1, \ldots, n} X_i'$,
where $X'_i$ is the normalization of $X$ in $Y_i$.
By Properties, Lemma \ref{properties-lemma-normal-integral-sections}
we see that $B_i = \Gamma(Y_i, \mathcal{O}_{Y_i})$ is a normal domain.
Note that $X_i' = \text{Spec}(A_i')$, where $A_i' \subset B_i$
is the integral closure of $A$ in $B_i$, see
Lemma \ref{lemma-integral-closure}. By 
Algebra, Lemma \ref{algebra-lemma-integral-closure-in-normal}
we see that $A_i' \subset B_i$ is a normal domain.
Hence $X' = \coprod X_i'$ is a finite union of normal schemes
and hence is normal.

\medskip\noindent
It is clear from the description of $X'$ above that $Y \to X'$
is dominant and induces a bijection on irreducible components if
$X$ is affine. The result in general follows from this by a topological
argument (omitted).
\end{proof}

\begin{lemma}
\label{lemma-nagata-normalization-finite}
Let $f : X \to S$ be a morphism.
Assume that
\begin{enumerate}
\item $S$ is a Nagata scheme,
\item $f$ is of finite type\footnote{The proof
shows that the lemma holds if $f$ is quasi-compact and ``essentially
of finite type''.}, and
\item $X$ is reduced.
\end{enumerate}
Then the normalization $\nu : S' \to S$ of $S$ in $X$ is finite.
\end{lemma}

\begin{proof}
There is an immediate reduction to the case $S = \text{Spec}(R)$
where $R$ is a Nagata ring. In this case we have to show that
the integral closure $A$ of $R$ in $\Gamma(X, \mathcal{O}_X)$ is
finite over $R$. Since $f$ is of finite type we can write
$X = \bigcup_{i = 1, \ldots, n} U_i$ with each $U_i$ affine.
Say $U_i = \text{Spec}(B_i)$. Each $B_i$ is a reduced ring of finite type
over $R$ (Lemma \ref{lemma-locally-finite-type-characterize}).
Moreover, $\Gamma(X, \mathcal{O}_X) \subset B = B_1 \times \ldots \times B_n$.
So $A$ is contained in the integral closure $A'$ of $R$ in $B$.
Note that $B$ is a reduced finite type $R$-algebra. Since $R$ is Noetherian
it suffices to prove that $A'$ is finite over $R$. This is
Algebra, Lemma
\ref{algebra-lemma-nagata-in-reduced-finite-type-finite-integral-closure}.
\end{proof}

\noindent
Next, we come to the normalization of a scheme $X$.
We only define/construct it when $X$ has locally finitely many irreducible
components. Let $X$ be a scheme such that every quasi-compact open has
finitely many irreducible components. Let
$X^{(0)} \subset X$ be the set of generic points of irreducible components
of $X$. Let
\begin{equation}
\label{equation-generic-points}
f :
Y = \coprod\nolimits_{\eta \in X^{(0)}} \text{Spec}(\kappa(\eta))
\longrightarrow
X
\end{equation}
be the inclusion of the generic points into $X$ using the
canonical maps of Schemes, Section \ref{schemes-section-points}.
Note that this morphism is quasi-compact by assumption and
quasi-separated as $Y$ is separated (see
Schemes, Section \ref{schemes-section-separation-axioms}).

\begin{definition}
\label{definition-normalization}
Let $X$ be a scheme such that every quasi-compact open has
finitely many irreducible components. We define the
{\it normalization} of $X$ as the morphism
$$
\nu : X^\nu \longrightarrow X
$$
which is the normalization of $X$ in the morphism $f : Y \to X$
(\ref{equation-generic-points}) constructed above.
\end{definition}

\noindent
Any locally Noetherian scheme has a locally finite set of irreducible
components and the definition applies to it.
Usually the normalization is defined only for reduced schemes.
With the definition above the normalization of $X$ is the same
as the normalization of the reduction $X_{red}$ of $X$.

\begin{lemma}
\label{lemma-normalization-reduced}
Let $X$ be a scheme such that every quasi-compact open has
finitely many irreducible components. The normalization morphism
$\nu$ factors through the reduction $X_{red}$ and $X^\nu \to X_{red}$
is the normalization of $X_{red}$.
\end{lemma}

\begin{proof}
Let $f : Y \to X$ be the morphism (\ref{equation-generic-points}).
We get a factorization $Y \to X_{red} \to X$ of $f$ from
Schemes, Lemma \ref{schemes-lemma-map-into-reduction}.
By Lemma \ref{lemma-characterize-normalization} we obtain a canonical
morphism $X^\nu \to X_{red}$
and that $X^\nu$ is the normalization of $X_{red}$ in $Y$.
The lemma follows as $Y \to X_{red}$ is identical to the morphism 
(\ref{equation-generic-points}) constructed for $X_{red}$.
\end{proof}

\noindent
If $X$ is reduced, then the normalization of $X$ is the same
as the relative spectrum of the integral closure of $\mathcal{O}_X$
in the sheaf of meromorphic functions $\mathcal{K}_X$
(see Divisors, Section \ref{divisors-section-meromorphic-functions}).
Namely, $\mathcal{K}_X = f_*\mathcal{O}_Y$ in this case, see
Divisors, Lemma \ref{divisors-lemma-reduced-finite-irreducible}
and its proof. We describe this here explicitly.

\begin{lemma}
\label{lemma-description-normalization}
Let $X$ be a reduced scheme such that every quasi-compact open has
finitely many irreducible components. Let $\text{Spec}(A) = U \subset X$
be an affine open. Then
\begin{enumerate}
\item $A$ has finitely many minimal primes
$\mathfrak q_1, \ldots, \mathfrak q_t$,
\item the total ring of fractions $Q(A)$ of $A$ is
$Q(A/\mathfrak q_1) \times \ldots \times Q(A/\mathfrak q_t)$,
\item the integral closure $A'$ of $A$ in $Q(A)$ is the product of
the integral closures of the domains $A/\mathfrak q_i$
in the fields $Q(A/\mathfrak q_i)$, and
\item $\nu^{-1}(U)$ is identified with the spectrum of $A'$.
\end{enumerate}
\end{lemma}

\begin{proof}
Minimal primes correspond to irreducible components
(Algebra, Lemma \ref{algebra-lemma-irreducible}),
hence we have (1) by assumption. Then
$(0) = \mathfrak q_1 \cap \ldots \cap \mathfrak q_t$ because $A$ is reduced
(Algebra, Lemma \ref{algebra-lemma-Zariski-topology}).
Then we have
$Q(A) = \prod A_{\mathfrak q_i} = \prod \kappa(\mathfrak q_i)$
by Algebra, Lemmas \ref{algebra-lemma-total-ring-fractions-no-embedded-points}
and \ref{algebra-lemma-minimal-prime-reduced-ring}.
This proves (2). Part (3) follows from
Algebra, Lemma \ref{algebra-lemma-characterize-reduced-ring-normal},
or Lemma \ref{lemma-normalization-in-disjoint-union}.
Part (4) holds because it is clear that $f^{-1}(U) \to U$ is the morphism
$$
\text{Spec}\left(\prod \kappa(\mathfrak q_i)\right)
\longrightarrow
\text{Spec}(A)
$$
where $f : Y \to X$ is the morphism (\ref{equation-generic-points}).
\end{proof}

\begin{lemma}
\label{lemma-normalization-normal}
Let $X$ be a scheme such that every quasi-compact open has
finitely many irreducible components.
\begin{enumerate}
\item The normalization $X^\nu$ is a normal scheme.
\item The morphism $\nu : X^\nu \to X$ is integral, dominant, and
induces a bijection on irreducible components.
\item For any integral, birational\footnote{It suffices if
$X'_{red} \to X_{red}$ is birational.} morphism $X' \to X$ there
exists a factorization $X^\nu \to X' \to X$ and $X^\nu \to X'$
is the normalization of $X'$.
\item For any morphism $Z \to X$ with $Z$ a normal scheme
such that each irreducible component of $Z$ dominates an irreducible
component of $X$ there exists a unique factorization $Z \to X^\nu \to X$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $f : Y \to X$ be as in (\ref{equation-generic-points}).
Part (1) follows from Lemma \ref{lemma-normal-normalization}
and the fact that $Y$ is normal. It also follows from the description
of the affine opens in Lemma \ref{lemma-description-normalization}.

\medskip\noindent
The morphism $\nu$ is integral by Lemma \ref{lemma-characterize-normalization}.
By Lemma \ref{lemma-normal-normalization} the
morphism $Y \to X^\nu$ induces a bijection on irreducible components,
and by construction of $Y$ this implies that $X^\nu \to X$ induces
a bijection on irreducible components. By construction $f : Y \to X$
is dominant, hence also $\nu$ is dominant. This proves (2).

\medskip\noindent
Suppose that $\alpha : X' \to X$ is integral and birational.
Any quasi-compact open $U'$ of $X'$ maps to a quasi-compact open
of $X$, hence we see that $U'$ has only finitely many irreducible
components. Let $f' : Y' \to X'$ be the morphism
(\ref{equation-generic-points}) constructed starting with $X'$.
As $\alpha$ is birational
it is clear that $Y' = Y$ and $f = \alpha \circ f'$. Hence
the factorization $X^\nu \to X' \to X$ exists
and $X^\nu \to X'$ is the normalization of $X'$ by
Lemma \ref{lemma-characterize-normalization}. This proves (3).

\medskip\noindent
Let $g : Z \to X$ be a morphism whose domain is a normal scheme
and such that every irreducible component dominates an irreducible
component of $X$. By Lemma \ref{lemma-normalization-reduced}
we have $X^\nu = X_{red}^\nu$ and by
Schemes, Lemma \ref{schemes-lemma-map-into-reduction}
$Z \to X$ factors through $X_{red}$. Hence we may replace $X$ by
$X_{red}$ and assume $X$ is reduced. Moreover, as the factorization
is unique it suffices to construct it locally on $Z$.
Let $W \subset Z$ and $U \subset X$ be affine opens
such that $g(W) \subset U$. Write $U = \text{Spec}(A)$ and
$W = \text{Spec}(B)$, with $g|_W$ given by $\varphi : A \to B$.
We will use the results of Lemma \ref{lemma-description-normalization} freely.
Let $\mathfrak p_1, \ldots, \mathfrak p_t$ be the minimal primes of $A$.
As $Z$ is normal, we see that $B$ is a normal
ring, in particular reduced. Moreover, by assumption any minimal
prime $\mathfrak q \subset B$ we have that $\varphi^{-1}(\mathfrak q)$
is a minimal prime of $A$. Hence if $x \in A$ is a nonzero divisor, i.e.,
$x \not \in \bigcup \mathfrak p_i$, then $\varphi(x)$ is a nonzero divisor
in $B$. Thus we obtain a canonical ring map $Q(A) \to Q(B)$. As $B$ is
normal it is equal to its integral closure in $Q(B)$ (see
Algebra, Lemma \ref{algebra-lemma-normal-ring-integrally-closed}).
Hence we see that the integral closure $A' \subset Q(A)$ of $A$
maps into $B$ via the canonical map $Q(A) \to Q(B)$.
Since $\nu^{-1}(U) = \text{Spec}(A')$ this gives the canonical
factorization $W \to \nu^{-1}(U) \to U$ of $\nu|_W$.
We omit the verification that it is unique.
\end{proof}

\begin{lemma}
\label{lemma-Japanese-normalization}
Let $X$ be an integral, Japanese scheme.
The normalization $\nu : X^\nu \to X$ is a finite morphism.
\end{lemma}

\begin{proof}
Follows from the definitions and
Lemma \ref{lemma-description-normalization}. Namely, in this case
the lemma says that $\nu^{-1}(\text{Spec}(A))$ is the spectrum
of the integral closure of $A$ in its field of fractions.
\end{proof}

\begin{lemma}
\label{lemma-nagata-normalization}
Let $X$ be a nagata scheme.
The normalization $\nu : X^\nu \to X$ is a finite morphism.
\end{lemma}

\begin{proof}
Note that a Nagata scheme is locally Noetherian, thus
Definition \ref{definition-normalization}
does apply. Write $X^\nu \to X$ as the composition
$X^\nu \to X_{red} \to X$. As $X_{red} \to X$ is a closed immersion
it is finite. Hence it suffices to prove the lemma for a reduced
Nagata scheme (by Lemma \ref{lemma-composition-finite}).
Let $\text{Spec}(A) = U \subset X$ be an affine open.
By Lemma \ref{lemma-description-normalization} we have
$\nu^{-1}(U) = \text{Spec}(\prod A_i')$ where $A_i'$ is the integral
closure of $A/\mathfrak q_i$ in its fraction field. As $A$ is a Nagata
ring (see Properties, Lemma \ref{properties-lemma-locally-nagata})
each of the ring extensions
$A/\mathfrak q_i \subset A'_i$ are finite. Hence $A \to \prod A'_i$
is a finite ring map and we win.
\end{proof}








\section{Zariski's Main Theorem (algebraic version)}
\label{section-Zariski}

\noindent
This is the version you can prove using purely algebraic methods.
Before we can prove more powerful versions (for non-affine morphisms)
we need to develop more tools. See
Coherent Cohomology,
Section \ref{coherent-section-applications-formal-functions}
and
More on Morphisms,
Section \ref{more-morphisms-section-application-etale-neighbourhoods}.

\begin{theorem}
\label{theorem-main-theorem}
(Algebraic version of Zariski's Main Theorem)
Let $f : Y \to X$ be an affine morphism of schemes.
Assume $f$ is of finite type.
Let $X'$ be the normalization of $X$ in $Y$. Picture:
$$
\xymatrix{
Y \ar[rd]_f \ar[rr]_{f'} & & X' \ar[ld]^\nu \\
& X &
}
$$
Then there exists an open subscheme $U' \subset X'$ such that
\begin{enumerate}
\item $(f')^{-1}(U') \to U'$ is an isomorphism, and
\item $(f')^{-1}(U') \subset Y$ is the set of points at which
$f$ is quasi-finite.
\end{enumerate}
\end{theorem}

\begin{proof}
There is an immediate reduction to the case where $X$ and hence $Y$
are affine. Say $X = \text{Spec}(R)$ and $Y = \text{Spec}(A)$.
Then $X' = \text{Spec}(A')$, where $A'$ is the integral closure of
$R$ in $A$, see Definitions \ref{definition-integral-closure}
and \ref{definition-normalization-X-in-Y}. By
Algebra, Theorem \ref{algebra-theorem-main-theorem}
for every $y \in Y$ at which $f$ is quasi-finite, there exists an
open $U'_y \subset X'$ such that $(f')^{-1}(U'_y) \to U'_y$
is an isomorphism. Set $U' = \bigcup U'_y$ where $y \in Y$ ranges
over all points where $f$ is quasi-finite. It remains to show that
$f$ is quasi-finite at all points of $(f')^{-1}(U')$.
If $y \in (f')^{-1}(U')$ with image $x \in X$, then we see that
$Y_x \to X'_x$ is an isomorphism in a neighbourhood of $y$. Hence
there is no point of $Y_x$ which specializes to $y$, since this
is true for $f'(y)$ in $X'_x$, see Lemma \ref{lemma-integral-fibres}.
By Lemma \ref{lemma-quasi-finite-at-point-characterize} part (3)
this implies $f$ is quasi-finite at $y$.
\end{proof}

\noindent
We can use the algebraic version of Zariski's Main Theorem to show that
the set of points where a morphism is quasi-finite is open.

\begin{lemma}
\label{lemma-quasi-finite-points-open}
Let $f : X \to S$ be a morphism of schemes.
The set of points of $X$ where $f$ is quasi-finite is an open
$U \subset X$. The induced morphism $U \to S$ is locally quasi-finite.
\end{lemma}

\begin{proof}
Suppose $f$ is quasi-finite at $x$.
Let $x \in U = \text{Spec}(R) \subset X$, $V = \text{Spec}(A) \subset S$
be affine opens as in Definition \ref{definition-quasi-finite}.
By either Theorem \ref{theorem-main-theorem} above or
Algebra, Lemma \ref{algebra-lemma-quasi-finite-open},
the set of primes $\mathfrak q$ at which $R \to A$ is quasi-finite
is open in $\text{Spec}(A)$. Since these all correspond to points
of $X$ where $f$ is quasi-finite we get the first statement.
The second statement is obvious.
\end{proof}

\noindent
We will improve the following lemma to general quasi-finite separated
morphisms later (insert future reference here).

\begin{lemma}
\label{lemma-quasi-finite-affine}
Let $f : Y \to X$ be a morphism of schemes.
Assume
\begin{enumerate}
\item $X$ and $Y$ are affine, and
\item $f$ is quasi-finite.
\end{enumerate}
Then there exists a diagram
$$
\xymatrix{
Y \ar[rd]_f \ar[rr]_{j} & & Z \ar[ld]^\pi \\
& X &
}
$$
with $Z$ affine, $\pi$ finite and $j$ an open immersion.
\end{lemma}

\begin{proof}
This is
Algebra, Lemma \ref{algebra-lemma-quasi-finite-open-integral-closure}
reformulated in the laguage of schemes.
\end{proof}

\begin{lemma}
\label{lemma-image-nowhere-dense-quasi-finite}
Let $f : Y \to X$ be a quasi-finite morphism of schemes.
Let $T \subset Y$ be a closed nowhere dense subset of $Y$.
Then $f(T) \subset X$ is a nowhere dense subset of $X$.
\end{lemma}

\begin{proof}
As in the proof of Lemma \ref{lemma-image-nowhere-dense-finite} this
reduces immediately to the case where the base $X$ is affine.
In this case $Y = \bigcup_{i = 1, \ldots, n} Y_i$ is a finite union
of affine opens (as $f$ is quasi-compact). Since each $T \cap Y_i$
is nowhere dense, and since a finite union of nowhere dense sets is
nowhere dense (see
Topology, Lemma \ref{topology-lemma-nowhere-dense}),
it suffices to prove that the image $f(T \cap Y_i)$ is nowhere dense in $X$.
This reduces us to the case where both $X$ and $Y$ are affine. At this point
we apply Lemma \ref{lemma-quasi-finite-affine} above to get a diagram
$$
\xymatrix{
Y \ar[rd]_f \ar[rr]_{j} & & Z \ar[ld]^\pi \\
& X &
}
$$
with $Z$ affine, $\pi$ finite and $j$ an open immersion.
Set $\overline{T} = \overline{j(T)} \subset Z$. By
Topology, Lemma \ref{topology-lemma-image-nowhere-dense-open}
we see $\overline{T}$ is nowhere dense in $Z$.
Since $f(T) \subset \pi(\overline{T})$
the lemma follows from the corresponding result in the finite case, see
Lemma \ref{lemma-image-nowhere-dense-finite}.
\end{proof}




\section{Universally bounded fibres}
\label{section-universally-bounded}

\noindent
Let $X$ be a scheme over a field $k$. If $X$ is finite over $k$,
then $X = \text{Spec}(A)$ where $A$ is a finite $k$-algebra. Another way
to say this is that $X$ is finite locally free over $\text{Spec}(k)$,
see Definition \ref{definition-finite-locally-free}. Hence
$X \to \text{Spec}(k)$ has a {\it degree} which is an integer $d \geq 0$,
namely $d = \dim_k(A)$. We sometime call this the {\it degree} of the (finite)
scheme $X$ over $k$.

\begin{definition}
\label{definition-universally-bounded}
Let $f : X \to Y$ be a morphism of schemes.
\begin{enumerate}
\item We say the integer $n$ {\it bounds the degrees of the fibres
of $f$} if for all $y \in Y$
the fibre $X_y$ is a finite scheme over $\kappa(y)$ whose
degree over $\kappa(y)$ is $\leq n$.
\item We say the {\it fibres of $f$ are universally bounded}\footnote{This is
probably nonstandard notation.}
if there exists an integer $n$ which bounds the degrees of the fibres
of $f$.
\end{enumerate}
\end{definition}

\noindent
Note that in particular the number of points in a fibre is bounded by $n$
as well. (The converse does not hold, even if all fibres are finite reduced
schemes.)

\begin{lemma}
\label{lemma-characterize-universally-bounded}
Let $f : X \to Y$ be a morphism of schemes. Let $n \geq 0$.
The following are equivalent:
\begin{enumerate}
\item the integer $n$ bounds the degrees of the fibres of $f$, and
\item for every morphism $\text{Spec}(k) \to Y$, where $k$ is a field,
the fibre product $X_k = \text{Spec}(k) \times_Y X$ is finite over $k$
of degree $\leq n$.
\end{enumerate}
In this case $f$ is universally bounded and the schemes $X_k$ have at most
$n$ points.
\end{lemma}

\begin{proof}
The implication (2) $\Rightarrow$ (1) is trivial. The other implication
holds because if the image of $\text{Spec}(k) \to Y$ is $y$, then
$X_k = \text{Spec}(k) \times_{\text{Spec}(\kappa(y))} X_y$.
\end{proof}

\begin{lemma}
\label{lemma-composition-universally-bounded}
A composition of morphisms with universally bounded fibres
is a morphism with universally bounded fibres. More precisely,
assume that $n$ bounds the degrees of the fibres of $f : X \to Y$ and
$m$ bounds the degrees of $g : Y \to Z$.
Then $nm$ bounds the degrees of the fibres of $g \circ f : X \to Z$.
\end{lemma}

\begin{proof}
Let $f : X \to Y$ and $g : Y \to Z$ have universally bounded fibres.
Say that $\deg(X_y/\kappa(y)) \leq n$ for all $y \in Y$, and that
$\deg(Y_z/\kappa(z)) \leq m$ for all $z \in Z$.
Let $z \in Z$ be a point. By assumption the scheme
$Y_z$ is finite over $\text{Spec}(\kappa(z))$.
In particular, the underlying topological space of $Y_z$
is a finite discrete set. The fibres of the morphism
$f_z : X_z \to Y_z$ are the fibres of $f$ at the corresponding
points of $Y$, which are finite discrete sets by the reasoning above.
Hence we conclude that the underlying topological space
of $X_z$ is a finite discrete set as well. Thus $X_z$ is an affine
scheme (this is a nice exercise; it also follows for example from
Properties, Lemma \ref{properties-lemma-maximal-points-affine}
applied to the set of all points of $X_z$). Write $X_z = \text{Spec}(A)$,
$Y_z = \text{Spec}(B)$, and $k = \kappa(z)$. Then $k \to B \to A$
and we know that (a) $\dim_k(B) \leq m$, and (b) for every maximal
ideal $\mathfrak m \subset B$ we have
$\dim_{\kappa(\mathfrak m)}(A/\mathfrak mA) \leq n$.
We claim this implies that $\dim_k(A) \leq nm$.
Note that $B$ is the product of its localizations $B_{\mathfrak m}$, for
example because $Y_z$ is a disjoint union of $1$-point schemes, or by
Algebra, Lemmas \ref{algebra-lemma-finite-dimensional-algebra} and
\ref{algebra-lemma-artinian-finite-length}.
So we see that
$\dim_k(B) = \sum_{\mathfrak m}(B_{\mathfrak m})$ and
$\dim_k(A) = \sum_{\mathfrak m}(A_{\mathfrak m})$ where
in both cases $\mathfrak m$ runs over the maximal ideals of
$B$ (not of $A$). By the above, and Nakayama's Lemma
(Algebra, Lemma \ref{algebra-lemma-NAK})
we see that each $A_{\mathfrak m}$ is a quotient of
$B_{\mathfrak m}^{\oplus n}$ as a $B_{\mathfrak m}$-module. Hence
$\dim_k(A_{\mathfrak m}) \leq n \dim_k(B_{\mathfrak m})$. Putting
everything together we see that
$$
\dim_k(A) = \sum\nolimits_{\mathfrak m}(A_{\mathfrak m})
\leq \sum\nolimits_{\mathfrak m} n \dim_k(B_{\mathfrak m})
= n \dim_k(B) \leq nm
$$
as desired.
\end{proof}

\begin{lemma}
\label{lemma-base-change-universally-bounded}
A base change of a morphism with universally bounded fibres is
a morphism with universally bounded fibres. More precisely, if
$n$ bounds the degrees of the fibres of $f : X \to Y$ and $Y' \to Y$
is any morphism, then the degrees of the fibres of the base change
$f' : Y' \times_Y X \to Y' \to Y'$ is also bounded by $n$.
\end{lemma}

\begin{proof}
This is clear from the result of
Lemma \ref{lemma-characterize-universally-bounded}.
\end{proof}

\begin{lemma}
\label{lemma-descent-universally-bounded}
Let $f : X \to Y$ be a morphism of schemes.
Let $Y' \to Y$ be a morphism of schemes, and let
$f' : X' = X_{Y'} \to Y'$ be the base change of $f$.
If $Y' \to Y$ is surjective and $f'$ has universally bounded fibres,
then $f$ has universally bounded fibres. More precisely, if $n$ bounds
the degree of the fibres of $f'$, then also $n$ bounds the degrees
of the fibres of $f$.
\end{lemma}

\begin{proof}
Let $n \geq 0$ be an integer bounding the degrees of the fibres of $f'$.
We claim that $n$ works for $f$ also. Namely, if $y \in Y$ is a point,
then choose a point $y' \in Y'$ lying over $y$ and observe that
$$
X'_{y'} = \text{Spec}(\kappa(y')) \times_{\text{Spec}(\kappa(y))} X_y.
$$
Since $X'_{y'}$ is assumed finite of degree $\leq n$ over $\kappa(y')$
it follows that also $X_y$ is finite of degree $\leq n$ over $\kappa(y)$.
(Some details omitted.)
\end{proof}

\begin{lemma}
\label{lemma-immersion-universally-bounded}
An immersion has universally bounded fibres.
\end{lemma}

\begin{proof}
The integer $n = 1$ works in the definition.
\end{proof}

\begin{lemma}
\label{lemma-etale-universally-bounded}
Let $f : X \to Y$ be an etale morphism of schemes.
Let $n \geq 0$. The following are equivalent
\begin{enumerate}
\item the integer $n$ bounds the degrees of the fibres,
\item for every field $k$ and morphism $\text{Spec}(k) \to Y$ the
base change $X_k = \text{Spec}(k) \times_Y X$ has at most $n$ points, and
\item for every $y \in Y$ and every separable algebraic closure
$\kappa(y) \subset \kappa(y)^{sep}$ the scheme
$X_{\kappa(y)^{sep}}$ has at most $n$ points.
\end{enumerate}
\end{lemma}

\begin{proof}
This follows from
Lemma \ref{lemma-characterize-universally-bounded}
and the fact that the fibres $X_y$ are disjoint unions of spectra of finite
separable field extensions of $\kappa(y)$, see
Lemma \ref{lemma-etale-over-field}.
\end{proof}

\noindent
Having universally bounded fibres is an absolute notion and not a relative
notion. This is why the condition in the following lemma is that $X$ is
quasi-compact, and not that $f$ is quasi-compact.

\begin{lemma}
\label{lemma-locally-quasi-finite-qc-source-universally-bounded}
Let $f : X \to Y$ be a morphism of schemes.
Assume that
\begin{enumerate}
\item $f$ is locally quasi-finite, and
\item $X$ is quasi-compact.
\end{enumerate}
Then $f$ has universally bounded fibres.
\end{lemma}

\begin{proof}
Since $X$ is quasi-compact, there exists a finite affine open covering
$X = \bigcup_{i = 1, \ldots, n} U_i$ and affine opens $V_i \subset Y$,
$i = 1, \ldots, n$ such that $f(U_i) \subset V_i$.
Because of the local nature of ``local quasi-finiteness''
(see Lemma \ref{lemma-quasi-finite-at-point-characterize} part (4))
we see that the morphisms $f|_{U_i} : U_i \to V_i$ are locally
quasi-finite morphisms of affines, hence quasi-finite, see
Lemma \ref{lemma-quasi-finite-locally-quasi-compact}.
For $y \in Y$ it is clear that $X_y = \bigcup_{y \in V_i} (U_i)_y$
is an open covering. Hence it suffices to prove the lemma
for a quasi-finite morphism of affines (namely, if $n_i$ works
for the morphism $f|_{U_i} : U_i \to V_i$, then $\sum n_i$
works for $f$).

\medskip\noindent
Assume $f : X \to Y$ is a quasi-finite morphism of affines.
By Lemma \ref{lemma-quasi-finite-affine}
we can find a diagram
$$
\xymatrix{
X \ar[rd]_f \ar[rr]_{j} & & Z \ar[ld]^\pi \\
& Y &
}
$$
with $Z$ affine, $\pi$ finite and $j$ an open immersion. Since
$j$ has universally bounded fibres
(Lemma \ref{lemma-immersion-universally-bounded})
this reduces us to showing that $\pi$ has universally bounded
fibres (Lemma \ref{lemma-composition-universally-bounded}).

\medskip\noindent
This reduces us to a morphism of the form
$\text{Spec}(B) \to \text{Spec}(A)$ where 
$A \to B$ is finite. Say $B$ is generated by $x_1, \ldots, x_n$
over $A$ and say $P_i(T) \in A[T]$ is a monic polynomial of degree
$d_i$ such that $P_i(x_i) = 0$ in $B$ (a finite ring extension
is integral, see
Algebra, Lemma \ref{algebra-lemma-finite-is-integral}).
With these notations it is clear that
$$
\bigoplus_{0 \leq e_i < d_i, i = 1, \ldots n} A
\longrightarrow
B, \quad
(a_{(e_1, \ldots, e_n)}) \longmapsto
\sum a_{(e_1, \ldots, e_n)} x_1^{e_1} \ldots x_n^{e_n}
$$
is a surjective $A$-module map. Thus for any prime $\mathfrak p \subset A$
this induces a surjective map $\kappa(\mathfrak p)$-vector spaces
$$
\kappa(\mathfrak p)^{\oplus d_1 \ldots d_n} \longrightarrow
B \otimes_A \kappa(\mathfrak p)
$$
In other words, the integer $d_1 \ldots d_n$ works in the definition
of a morphism with universally bounded fibres.
\end{proof}

\begin{lemma}
\label{lemma-universally-bounded-permanence}
Consider a commutative diagram of morphisms of schemes
$$
\xymatrix{
X \ar[rd]_g \ar[rr]_{f} & & Y \ar[ld]^h \\
& Z &
}
$$
If $g$ has universally bounded fibres, and $f$ is surjective and flat,
then also $h$ has universally bounded fibres. More precisely, if $n$
bounds the degree of the fibres of $g$, then also $n$ bounds the
degree of the fibres of $h$.
\end{lemma}

\begin{proof}
Assume $g$ has universally bounded fibres, and $f$ is surjective and flat.
Say the degree of the fibres of $g$ is bounded by $n \in \mathbf{N}$.
We claim $n$ also works for $h$.
Let $z \in Z$. Consider the morphism of schemes $X_z \to Y_z$.
It is flat and surjective. By assumption $X_z$ is a finite scheme
over $\kappa(z)$, in particular it is the spectrum of an
Artinian ring (by
Algebra, Lemma \ref{algebra-lemma-finite-dimensional-algebra}).
By Lemma \ref{lemma-Artinian-affine} the morphism $X_z \to Y_z$ is affine
in particular quasi-compact. It follows from
Lemma \ref{lemma-fpqc-quotient-topology}
that $Y_z$ is a finite discrete as this holds for $X_z$.
Hence $Y_z$ is an affine scheme (this is a nice exercise; it also follows
for example from
Properties, Lemma \ref{properties-lemma-maximal-points-affine}
applied to the set of all points of $Y_z$).
Write $Y_z = \text{Spec}(B)$ and $X_z = \text{Spec}(A)$.
Then $A$ is faithfully flat over $B$, so $B \subset A$.
Hence $\dim_k(B) \leq \dim_k(A) \leq n$ as desired.
\end{proof}








\input{chapters}

\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}
