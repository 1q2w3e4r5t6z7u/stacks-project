\input{preamble}

% OK, start here.
%
\begin{document}

\title{Morphisms of schemes}


\maketitle

\phantomsection
\label{section-phantom}

\tableofcontents

\section{Introduction}
\label{section-introduction}

\noindent
In this chapter we introduce some types of morphisms of schemes.
A basic reference is \cite{EGA}.




















\section{Closed immersions}
\label{section-closed-immersions}

\noindent
In this section we elucidate some of the results obtained previously on closed
immersions of schemes. Recall that a morphism of schemes $i : Z \to X$
is defined to be a closed immersion if (a) $i$ induces a homeomorphism onto
a closed subset of $X$, (b) $i^\sharp : \mathcal{O}_X \to i_*\mathcal{O}_Z$
is surjective, and (c) the kernel of $i^\sharp$ is locally generated by
sections, see Schemes, Definitions \ref{schemes-definition-immersion}
and \ref{schemes-definition-closed-immersion-locally-ringed-spaces}. It turns
out that, given that $Z$ and $X$ are schemes, there are many different
ways of characterizing a closed immersion.

\begin{lemma}
\label{lemma-closed-immersion}
Let $i : Z \to X$ be a morphism of schemes.
The following are equivalent:
\begin{enumerate}
\item The morphism $i$ is a closed immersions.
\item For every affine open $\text{Spec}(R) = U \subset X$,
there exists an ideal $I \subset R$ such that
$i^{-1}(U) = \text{Spec}(R/I)$ as schemes over $U = \text{Spec}(R)$.
\item There exists an affine open covering $X = \bigcup_{j \in J} U_j$,
$U_j = \text{Spec}(R_j)$ and for every $j \in J$ there exists
an ideal $I_j \subset R_j$ such that
$i^{-1}(U_j) = \text{Spec}(R_j/I_j)$ as schemes over $U_j = \text{Spec}(R_j)$.
\item The morphism $i$ induces a homeomorphism of $Z$ with a closed subset
of $X$ and $i^\sharp : \mathcal{O}_X \to i_*\mathcal{O}_Z$ is surjective.
\item The morphism $i$ induces a homeomorphism of $Z$ with a closed subset
of $X$, the map $i^\sharp : \mathcal{O}_X \to i_*\mathcal{O}_Z$ is surjective,
and the kernel $\text{Ker}(i^\sharp)\subset \mathcal{O}_X$ is a quasi-coherent
sheaf of ideals.
\item The morphism $i$ induces a homeomorphism of $Z$ with a closed subset
of $X$, the map $i^\sharp : \mathcal{O}_X \to i_*\mathcal{O}_Z$ is surjective,
and the kernel $\text{Ker}(i^\sharp)\subset \mathcal{O}_X$ is a
sheaf of ideals which is locally generated by sections.
\end{enumerate}
\end{lemma}

\begin{proof}
Condition (6) is our definition of a closed immersion, see Schemes,
Definitions \ref{schemes-definition-closed-immersion-locally-ringed-spaces}
and \ref{schemes-definition-immersion}.
So (6) $\Leftrightarrow$ (1). We have (1) $\Rightarrow$ (2) by
Schemes, Lemma \ref{schemes-lemma-closed-subspace-scheme}.
Trivially (2) $\Rightarrow$ (3).

\medskip\noindent
Assume (3). Each of the morphisms
$\text{Spec}(R_j/I_j) \to \text{Spec}(R_j)$ is
a closed immersion, see
Schemes, Example \ref{schemes-example-closed-immersion-affines}.
Hence $i^{-1}(U_j) \to U_j$ is a homeomorphism onto its image
and $i^\sharp|_{U_j}$ is surjective. Hence $i$ is a homeomorphism
onto its image and $i^\sharp$ is surjective since this may be
checked locally. We conclude that (3) $\Rightarrow$ (4).

\medskip\noindent
The implication (4) $\Rightarrow$ (1) is
Schemes, Lemma \ref{schemes-lemma-characterize-closed-immersions}.
The implication (5) $\Rightarrow$ (6) is trivial.
And the implication (6) $\Rightarrow$ (5) follows
from Schemes, Lemma \ref{schemes-lemma-closed-subspace-scheme}.
\end{proof}

\begin{lemma}
\label{lemma-closed-immersion-ideals}
Let $X$ be a scheme.
Suppose $i : Z \to X$ and $i' : Z' \to X$ are closed immersions
corresponding to the quasi-coherent
ideal sheaves $\mathcal{I} = \text{Ker}(i^\sharp)$
and $\mathcal{I}' = \text{Ker}((i')^\sharp)$ of $\mathcal{O}_X$.
\begin{enumerate}
\item The morphism $i : Z \to X$ factors as $Z \to Z' \to X$
for some $a : Z \to Z'$
if and only if $\mathcal{I}' \subset \mathcal{I}$.
If this happens, then $a$ is a closed immersion.
\item We have $Z \cong Z'$ as schemes over $X$ if and only if
$\mathcal{I} = \mathcal{I}'$.
\end{enumerate}
\end{lemma}

\begin{proof}
This follows from our discussion of closed subspaces in
Schemes, Section \ref{schemes-section-closed-immersion} especially
Schemes, Lemma \ref{schemes-lemma-characterize-closed-subspace}.
It also follows in a straightforward way from characterization
(3) in Lemma \ref{lemma-closed-immersion} above.
\end{proof}

\begin{lemma}
\label{lemma-closed-immersion-bijection-ideals}
Let $X$ be a scheme.
Let $\mathcal{I} \subset \mathcal{O}_X$ be a sheaf of ideals.
The following are equivalent:
\begin{enumerate}
\item The sheaf of ideals $\mathcal{I}$ is locally generated by
sections as a sheaf of $\mathcal{O}_X$ modules.
\item The sheaf of ideals $\mathcal{I}$ is quasi-coherent as
a sheaf of $\mathcal{O}_X$-modules.
\item There exists a closed immersion $i : Z \to X$ whose
corresponding sheaf of ideals $\text{Ker}(i^\sharp)$ is
equal to $\mathcal{I}$.
\end{enumerate}
\end{lemma}

\begin{proof}
In Schemes, Section \ref{schemes-section-closed-immersion} we constructed
the closed subspace associated to a sheaf of ideals locally generated
by sections. This closed subspace is a scheme by
Schemes, Lemma \ref{schemes-lemma-closed-subspace-scheme}.
Hence we see that (1) $\Rightarrow$ (3) by our definition
of a closed immersion of schemes. By Lemma \ref{lemma-closed-immersion}
above we see that (3) $\Rightarrow$ (2). And of course (2) $\Rightarrow$ (1).
\end{proof}

\begin{lemma}
\label{lemma-base-change-closed-immersion}
The base change of a closed immersion is a closed immersion.
\end{lemma}

\begin{proof}
See Schemes, Lemma \ref{schemes-lemma-base-change-immersion}.
\end{proof}

\begin{lemma}
\label{lemma-composition-closed-immersion}
A composition of closed immersions is a closed immersion.
\end{lemma}

\begin{proof}
This is clear from the characterization (3) of closed immersions
in Lemma \ref{lemma-closed-immersion}. Since if $I \subset R$
is an ideal, and $\overline{J} \subset R/I$ is an ideal, then
$\overline{J} = J/I$ for some ideal $J \subset R$ which contains
$I$ and $(R/I)/\overline{J} = R/J$.
\end{proof}

\begin{lemma}
\label{lemma-closed-immersion-quasi-compact}
A closed immersion is quasi-compact.
\end{lemma}

\begin{proof}
This lemma is a duplicate of
Schemes, Lemma \ref{schemes-lemma-closed-immersion-quasi-compact}.
\end{proof}

\begin{lemma}
\label{lemma-closed-immersion-separated}
A closed immersion is separated.
\end{lemma}

\begin{proof}
This lemma is a special case of
Schemes, Lemma \ref{schemes-lemma-immersions-monomorphisms}.
\end{proof}

\begin{lemma}
\label{lemma-factor-quasi-compact-immersion}
Let $h : Z \to X$ be an immersion.
If $h$ is quasi-compact, then we can factor
$h = i \circ j$ with $j : Z \to \overline{Z}$ an
open immersion and $i : \overline{Z} \to X$ a closed immersion.
\end{lemma}

\begin{proof}
Note that $h$ is quasi-compact and quasi-separated (see
Schemes, Lemma \ref{schemes-lemma-immersions-monomorphisms}).
Hence $h_*\mathcal{O}_Z$ is a quasi-coherent sheaf of $\mathcal{O}_X$-modules
by Schemes, Lemma \ref{schemes-lemma-push-forward-quasi-coherent}.
This implies that
$\mathcal{I} = \text{Ker}(\mathcal{O}_X \to h_*\mathcal{O}_Z)$
is a quasi-coherent sheaf of ideals, see
Schemes, Section \ref{schemes-section-quasi-coherent}.
Let $\overline{Z} \subset X$ be the closed subscheme corresponding
to $\mathcal{I}$, see Lemma \ref{lemma-closed-immersion-bijection-ideals}.
By Schemes, Lemma \ref{schemes-lemma-characterize-closed-subspace}
the morphism $h$ factors as
$h = i \circ j$ where $i : \overline{Z} \to X$ is the inclusion morphism.
To see that $j$ is an open immersion, choose an open subscheme
$U \subset X$ such that $h$ induces a closed immersion of $Z$
into $U$. Then it is clear that $\mathcal{I}|_U$ is the
sheaf of ideals corresponding to the closed immersion $Z \to U$.
Hence we see that $Z = \overline{Z} \cap U$.
\end{proof}

\begin{example}
\label{example-thibaut}
Here is an example of an immersion which is not a composition of an
open immersion followed by a closed immersion.
Let $k$ be a field.
Let $X = \text{Spec}(k[x_1, x_2, x_3, \ldots])$.
Let $U = \bigcup_{n = 1}^{\infty} D(x_n)$.
Then $U \to X$ is an open immersion.
Consider the ideals
$$
I_n =
(x_1^n, x_2^n, \ldots, x_{n - 1}^n, x_n - 1, x_{n + 1}, x_{n + 2}, \ldots)
\subset
k[x_1, x_2, x_3, \ldots][1/x_n].
$$
Note that $I_n k[x_1, x_2, x_3, \ldots][1/x_nx_m] = (1)$
for any $m \not = n$. Hence the quasi-coherent ideals
$\widetilde I_n$ on $D(x_n)$ agree on $D(x_nx_m)$, namely
$\widetilde I_n|_{D(x_nx_m)} = \mathcal{O}_{D(x_n x_m)}$ if
$n \not = m$. Hence these ideals glue to a quasi-coherent sheaf of ideals
$\mathcal{I} \subset \mathcal{O}_U$.
Let $Z \subset U$ be the closed subscheme corresponding to
$\mathcal{I}$. Thus $Z \to X$ is an immersion.

\medskip\noindent
We claim that we cannot factor $Z \to X$ as
$Z \to \overline{Z} \to X$, where $\overline{Z} \to X$ is closed
and $Z \to \overline{Z}$ is open. Namely, $\overline{Z}$ would
have to be defined by an ideal $I \subset k[x_1, x_2, x_3, \ldots]$
such that $I_n = I k[x_1, x_2, x_3, \ldots][1/x_n]$.
But the only element $f \in k[x_1, x_2, x_3, \ldots]$
which ends up in all $I_n$ is $0$! Hence $I$ does not exist.
\end{example}








\section{Closed immersions and quasi-coherent sheaves}
\label{section-closed-immersions-quasi-coherent}

\noindent
The following lemma finally does for quasi-coherent sheaves on schemes
what Modules, Lemma \ref{modules-lemma-i-star-exact} does for abelian sheaves.
See also the discussion in
Modules, Section \ref{modules-section-closed-immersion}.

\begin{lemma}
\label{lemma-i-star-equivalence}
Let $i : Z \to X$ be a closed immersion of schemes. Let
$\mathcal{I} \subset \mathcal{O}_X$ be the quasi-coherent sheaf of ideals
cutting out $Z$. The functor
$$
i_* :
\text{QCoh}(\mathcal{O}_Z)
\longrightarrow
\text{QCoh}(\mathcal{O}_X)
$$
is exact, fully faithful, with essential image those quasi-coherent
$\mathcal{O}_X$-modules $\mathcal{G}$ such that $\mathcal{I}\mathcal{G} = 0$.
\end{lemma}

\begin{proof}
A closed immersion is quasi-compact and separated, see
Lemmas \ref{lemma-closed-immersion-quasi-compact} and
\ref{lemma-closed-immersion-separated}. Hence
Schemes, Lemma \ref{schemes-lemma-push-forward-quasi-coherent}
applies and the pushforward of a quasi-coherent
sheaf on $Z$ is indeed a quasi-coherent sheaf on $X$.

\medskip\noindent
By Modules, Lemma \ref{modules-lemma-i-star-exact}
the functor $i_*$ is faithful. We claim that
for any quasi-coherent sheaf $\mathcal{F}$ on $X$
the canonical map
$$
i^*i_*\mathcal{F} \longrightarrow \mathcal{F}
$$
is an isomorphism. This claim implies in particular that $i_*$ is
fully faithful. To prove the claim let $U = \text{Spec}(R)$ be any affine open
of $X$, and write $Z \cap U = \text{Spec}(R/I)$, see
Lemma \ref{lemma-closed-immersion} above. We may write
$\mathcal{F}|_{U \cap Z} = \widetilde{M}$ where
$M$ is an $R/I$-module (see
Schemes, Section \ref{schemes-section-quasi-coherent}).
By Schemes, Lemma \ref{schemes-lemma-widetilde-pullback}
we see that $i_*\mathcal{F}|_U$ corresponds to
$M_R$ and then $i^*i_*\mathcal{F}|_{Z \cap U}$ corresponds
to $M_R \otimes_R R/I$. In other words, we have to see that
for any $R/I$-module $M$ the canonical map
$$
M_R \otimes_R R/I \longrightarrow M, \ \ 
m \otimes f \longmapsto fm
$$
is an isomorphism. Proof of this easy algebra fact is omitted.

\medskip\noindent
Now we turn to the description of the essential image of the
functor $i_*$. It is clear that $\mathcal{I}(i_*\mathcal{F}) = 0$
for any quasi-coherent $\mathcal{O}_Z$-module, for example
by our local description above. Next, suppose that $\mathcal{G}$
is any quasi-coherent $\mathcal{O}_X$-module such that
$\mathcal{I}\mathcal{G} = 0$. It suffices to show that the canonical map
$$
\mathcal{G} \longrightarrow i_* i^*\mathcal{G}
$$
is an isomorphism. By exactly the same arguments as above we see that
it suffices to prove the following algebraic statement: Given a ring
$R$, an ideal $I$ and an $R$-module $N$ such that $IN = 0$ the canonical map
$$
N \longrightarrow N \otimes_R R/I, \ \ 
n \longmapsto n \otimes 1
$$
is an isomorphism of $R$-modules. Proof of this easy algebra fact is omitted.
\end{proof}

\noindent
Let $i : Z \to X$ be a closed immersion. Because of the lemma above we often,
by abuse of notation, denote $\mathcal{F}$ the sheaf $i_*\mathcal{F}$ on $X$.

\begin{lemma}
\label{lemma-largest-quasi-coherent-subsheaf}
Let $X$ be a scheme. Let $\mathcal{F}$ be a quasi-coherent
$\mathcal{O}_X$-module. Let $\mathcal{G} \subset \mathcal{F}$
be a $\mathcal{O}_X$-submodule. There exists a unique quasi-coherent
$\mathcal{O}_X$-submodule $\mathcal{G}' \subset \mathcal{G}$
with the following property: For every quasi-coherent $\mathcal{O}_X$-module
$\mathcal{H}$ the map
$$
\text{Hom}_{\mathcal{O}_X}(\mathcal{H}, \mathcal{G}')
\longrightarrow
\text{Hom}_{\mathcal{O}_X}(\mathcal{H}, \mathcal{G})
$$
is bijective. In particular $\mathcal{G}'$ is the largest quasi-coherent
$\mathcal{O}_X$-submodule of $\mathcal{F}$ contained in $\mathcal{G}$.
\end{lemma}

\begin{proof}
Let $\mathcal{G}_a$, $a \in A$ be the set of quasi-coherent
$\mathcal{O}_X$-submodules contained in $\mathcal{G}$.
Then the image $\mathcal{G}'$ of
$$
\bigoplus\nolimits_{a \in A} \mathcal{G}_a \longrightarrow \mathcal{F}
$$
is quasi-coherent as the image of a map of quasi-coherent sheaves
on $Y$ is quasi-coherent and since a direct sum of quasi-coherent sheaves
is quasi-coherent, see
Schemes, Section \ref{schemes-section-quasi-coherent}.
The module $\mathcal{G}'$ is contained in $\mathcal{G}$. Hence this is the
largest quasi-coherent $\mathcal{O}_X$-module contained in $\mathcal{G}$.

\medskip\noindent
To prove the formula, let $\mathcal{H}$ be a quasi-coherent
$\mathcal{O}_X$-module and let $\alpha : \mathcal{H} \to \mathcal{G}$
be an $\mathcal{O}_X$-module map. The image of the composition
$\mathcal{H} \to \mathcal{G} \to \mathcal{F}$ is quasi-coherent
as the image of a map of quasi-coherent sheaves. Hence it is contained
in $\mathcal{G}'$. Hence $\alpha$ factors through $\mathcal{G}'$
as desired.
\end{proof}

\begin{lemma}
\label{lemma-i-upper-shriek}
Let $i : Z \to X$ be a closed immersion of schemes.
There is a functor\footnote{This is likely nonstandard notation.}
$i^! : \text{QCoh}(\mathcal{O}_X) \to \text{QCoh}(\mathcal{O}_Z)$
which is a right adjoint to $i_*$. (Compare
Modules, Lemma \ref{modules-lemma-i-star-right-adjoint}.)
\end{lemma}

\begin{proof}
Namely, given quasi-coherent $\mathcal{O}_X$-module $\mathcal{G}$ we consider
the subsheaf $\mathcal{H}_Z(\mathcal{G})$ of $\mathcal{G}$ of local sections
annihilated by $\mathcal{I}$. By
Lemma \ref{lemma-largest-quasi-coherent-subsheaf}
there is a canonical largest quasi-coherent $\mathcal{O}_X$-submodule
$\mathcal{H}_Z(\mathcal{G})'$. By construction we have
$$
\text{Hom}_{\mathcal{O}_X}(i_*\mathcal{F}, \mathcal{H}_Z(\mathcal{G})')
=
\text{Hom}_{\mathcal{O}_X}(i_*\mathcal{F}, \mathcal{G})
$$
for any quasi-coherent $\mathcal{O}_Z$-module $\mathcal{F}$.
Hence we can set $i^!\mathcal{G} = i^*(\mathcal{H}_Z(\mathcal{G})')$.
Details omitted.
\end{proof}





\section{Conormal sheaf of an immersion}
\label{section-conormal-sheaf}

\noindent
Let $i : Z \to X$ be a closed immersion. Let
$\mathcal{I} \subset \mathcal{O}_X$ be the corresponding quasi-coherent
sheaf of ideals. Consider the short exact sequence
$$
0 \to \mathcal{I}^2 \to \mathcal{I} \to \mathcal{I}/\mathcal{I}^2 \to 0
$$
of quasi-coherent sheaves on $X$. Since the sheaf $\mathcal{I}/\mathcal{I}^2$
is annihilated by $\mathcal{I}$ it corresponds to a sheaf on $Z$ by
Lemma \ref{lemma-i-star-equivalence}. This sheaf is often simply denoted
$\mathcal{I}/\mathcal{I}^2$ by the abuse of notation mentioned in
Section \ref{section-closed-immersions-quasi-coherent}.

\medskip\noindent
In case $i : Z \to X$ is a (locally closed) immersion we define the
conormal sheaf of $i$ as the conormal sheaf of the closed
immersion $i : Z \to X \setminus \partial Z$, where
$\partial Z = \overline{Z} \setminus Z$. It is often denoted
$\mathcal{I}/\mathcal{I}^2$ where $\mathcal{I}$ is the ideal sheaf
of the closed immersion $i : Z \to X \setminus \partial Z$.

\begin{definition}
\label{definition-conormal-sheaf}
Let $i : Z \to X$ be an immersion. The {\it conormal sheaf
$\mathcal{C}_{Z/X}$ of $Z$ in $X$} or the {\it conormal sheaf of $i$}
is the quasi-coherent $\mathcal{O}_Z$-module $\mathcal{I}/\mathcal{I}^2$
described above.
\end{definition}

\noindent
In \cite[IV Definition 16.1.2]{EGA} this sheaf is denoted
$\mathcal{N}_{Z/X}$. We will not follow this convention since we would
like to reserve the notation $\mathcal{N}_{Z/X}$
for the {\it normal sheaf of the immersion}. It is defined as
$$
\mathcal{N}_{Z/X} =
\textit{Hom}_{\mathcal{O}_Z}(\mathcal{C}_{Z/X}, \mathcal{O}_Z) =
\textit{Hom}_{\mathcal{O}_Z}(\mathcal{I}/\mathcal{I}^2, \mathcal{O}_Z)
$$
provided the conormal sheaf is of finite presentation (otherwise the
normal sheaf may not even be quasi-coherent). We will come back to the
normal sheaf later (insert future reference here).

\begin{lemma}
\label{lemma-affine-conormal}
Let $i : Z \to X$ be an immersion. The conormal sheaf
of $i$ has the following properties:
\begin{enumerate}
\item Let $U \subset X$ be any open such that $i(Z)$ is
a closed subset of $U$. Let $\mathcal{I} \subset \mathcal{O}_U$
be the sheaf of ideals corresponding to the closed subscheme
$i(Z) \subset U$. Then
$$
\mathcal{C}_{Z/X} = i^*\mathcal{I} = i^{-1}(\mathcal{I}/\mathcal{I}^2)
$$
\item
For any affine open $\text{Spec}(R) = U \subset X$
such that $Z \cap U = \text{Spec}(R/I)$ there is a
canonical isomorphism
$\Gamma(Z \cap U, \mathcal{C}_{Z/X}) = I/I^2$.
\end{enumerate}
\end{lemma}

\begin{proof}
Mostly clear from the definitions. Note that given a ring $R$ and
an ideal $I$ of $R$ we have $I/I^2 = I \otimes_R R/I$. Details omitted.
\end{proof}

\begin{lemma}
\label{lemma-conormal-functorial}
Let
$$
\xymatrix{
Z \ar[r]_i \ar[d]_f & X \ar[d]^g \\
Z' \ar[r]^{i'} & X'
}
$$
be a commutative diagram in the category of schemes.
Assume $i$, $i'$ immersions. There is a canonical map
of $\mathcal{O}_Z$-modules
$$
f^*\mathcal{C}_{Z'/X'}
\longrightarrow
\mathcal{C}_{Z/X}
$$
characterized by the following property: For every pair of affine opens
$(\text{Spec}(R) = U \subset X, \text{Spec}(R') = U' \subset X')$ with
$f(U) \subset I'$ such that
$Z \cap U = \text{Spec}(R/I)$ and $Z' \cap U' = \text{Spec}(R'/I')$
the induced map
$$
\Gamma(Z' \cap U', \mathcal{C}_{Z'/X'}) = I'/I'^2
\longrightarrow
I/I^2 = \Gamma(Z \cap U, \mathcal{C}_{Z/X})
$$
is the one induced by the ring map $f^\sharp : R' \to R$ which
has the property $f^\sharp(I') \subset I$.
\end{lemma}

\begin{proof}
Let $\partial Z' = \overline{Z'} \setminus Z'$ and
$\partial Z = \overline{Z} \setminus Z$. These are closed subsets of $X'$ and
of $X$. Replacing $X'$ by $X' \setminus \partial Z'$ and $X$ by
$X \setminus \big(g^{-1}(\partial Z') \cup \partial Z\big)$ we
see that we may assume that $i$ and $i'$ are closed immersions.

\medskip\noindent
The fact that $g \circ i$ factors through $i'$ implies that
$g^*\mathcal{I}'$ maps into $\mathcal{I}$ under the canonical
map $g^*\mathcal{I}' \to \mathcal{O}_X$, see
Schemes, Lemmas
\ref{schemes-lemma-characterize-closed-subspace} and
\ref{schemes-lemma-restrict-map-to-closed}.
Hence we get an induced map of quasi-coherent sheaves
$g^*(\mathcal{I}'/(\mathcal{I}')^2) \to \mathcal{I}/\mathcal{I}^2$.
Pulling back by $i$ gives
$i^*g^*(\mathcal{I}'/(\mathcal{I}')^2) \to i^*(\mathcal{I}/\mathcal{I}^2)$.
Note that $i^*(\mathcal{I}/\mathcal{I}^2) = \mathcal{C}_{Z/X}$.
On the other hand,
$i^*g^*(\mathcal{I}'/(\mathcal{I}')^2) =
f^*(i')^*(\mathcal{I}'/(\mathcal{I}')^2) = f^*\mathcal{C}_{Z'/X'}$.
This gives the desired map.

\medskip\noindent
Checking that the map is locally described as the given map
$I'/(I')^2 \to I/I^2$ is a matter of unwinding the definitions
and is omitted. Another observation is that given any
$x \in i(Z)$ there do exist affine open neighbourhoods $U$, $U'$
with $f(U) \subset U'$ and $Z \cap U$ as well as $U' \cap Z'$
closed such that $x \in U$. Proof omitted. Hence the requirement
of the lemma indeed characterizes the map (and could have been used
to define it).
\end{proof}






\section{Scheme theoretic image}
\label{section-scheme-theoretic-image}

\begin{lemma}
\label{lemma-scheme-theoretic-image}
Let $f : X \to Y$ be a morphism of schemes. There exists a closed
subscheme $Z \subset Y$ such that $f$ factors through $Z$ and such
that for any other closed subscheme $Z' \subset Y$ such that $f$
factors through $Z'$ we have $Z \subset Z'$.
\end{lemma}

\begin{proof}
Let $\mathcal{I} = \text{Ker}(\mathcal{O}_Y \to f_*\mathcal{O}_X)$.
If $\mathcal{I}$ is quasi-coherent then we just take $Z$ to be the
closed subscheme determined by $\mathcal{I}$, see
Lemma \ref{lemma-closed-immersion-bijection-ideals}. This works by
Schemes, Lemma \ref{schemes-lemma-characterize-closed-subspace}.
In general the same lemma requires us to show that there exists
a largest quasi-coherent sheaf of ideals $\mathcal{I}'$ contained in
$\mathcal{I}$.
This follows from Lemma \ref{lemma-largest-quasi-coherent-subsheaf}.
\end{proof}

\begin{definition}
\label{definition-scheme-theoretic-image}
Let $f : X \to Y$ be a morphism of schemes. The {\it scheme theoretic image}
of $f$ is the smallest closed subscheme $Z \subset Y$ through which $f$
factors, see Lemma \ref{lemma-scheme-theoretic-image} above.
\end{definition}

\noindent
We often just denote $f : X \to Z$ the factorization of $f$.
If the morphism $f$ is not quasi-compact, then (in general) the
construction of the scheme theoretic image does not commute with
restriction to open subschemes to $Y$. Namely, if $f$ is the
immersion $Z \to X$ of Example \ref{example-thibaut} above then
the scheme theoretic image of $Z \to X$ is $X$. But clearly the
scheme theoretic image of $Z = Z \cap U \to U$ is just $Z$.

\begin{lemma}
\label{lemma-quasi-compact-scheme-theoretic-image}
Let $f : X \to Y$ be a morphism of schemes.
Let $Z \subset Y$ be the scheme theoretic image of $f$.
If $f$ is quasi-compact then
\begin{enumerate}
\item the sheaf of ideals
$\mathcal{I} = \text{Ker}(\mathcal{O}_Y \to f_*\mathcal{O}_X)$
is quasi-coherent,
\item the scheme theoretic image $Z$ is the closed subscheme
determined by $\mathcal{I}$,
\item for any open $U \subset Y$ the scheme theoretic image of
$f|_{f^{-1}(U)} : f^{-1}(U) \to U$ is equal to $Z \cap U$, and
\item the image $f(X) \subset Z$ is a dense subset of $Z$, in other
words the morphism $X \to Z$ is dominant
(see Definition \ref{definition-dominant}).
\end{enumerate}
\end{lemma}

\begin{proof}
Part (4) follows from part (3). To show (3) it suffices
to prove (1) since the formation of $\mathcal{I}$ commutes with restriction to
open subschemes of $Y$. And if (1) holds then in
the proof of Lemma \ref{lemma-scheme-theoretic-image} we showed (2).
Thus it suffices to prove that $\mathcal{I}$ is quasi-coherent.
Since the property of being quasi-coherent is
local we may assume $Y$ is affine. As $f$ is quasi-compact,
we can find a finite affine open covering
$X = \bigcup_{i = 1, \ldots, n} U_i$. Denote $f'$ the composition
$$
X' = \coprod U_i \longrightarrow X \longrightarrow Y.
$$
Then $f_*\mathcal{O}_X$ is a subsheaf of $f'_*\mathcal{O}_{X'}$,
and hence $\mathcal{I} = \text{Ker}(\mathcal{O}_Y \to \mathcal{O}_{X'})$.
By Schemes, Lemma \ref{schemes-lemma-push-forward-quasi-coherent}
the sheaf $f'_*\mathcal{O}_{X'}$ is quasi-coherent on $Y$. Hence we win.
\end{proof}

\begin{lemma}
\label{lemma-factor-factor}
Let $f_1 : X \to Y_1$ and $Y_1 \to Y_2$ be morphisms of schemes.
Let $f_2 : X \to Y_2$ be the composition. Let $Z_i \subset Y_i$, $i = 1, 2$ be
the scheme theoretic image of $f_i$. Then the morphism
$Y_1 \to Y_2$ induces a morphism $Z_1 \to Z_2$ and a
commutative diagram
$$
\xymatrix{
X \ar[r] \ar[rd] & Z_1 \ar[d] \ar[r] & Y_1 \ar[d] \\
& Z_2 \ar[r] & Y_2
}
$$
\end{lemma}

\begin{proof}
See Schemes, Lemma \ref{schemes-lemma-characterize-closed-subspace}.
\end{proof}





\section{Scheme theoretic closure and density}
\label{section-scheme-theoretic-closure}

\begin{definition}
\label{definition-scheme-theoretically-dense}
Let $X$ be a scheme. Let $U \subset X$ be an open subscheme.
\begin{enumerate}
\item The scheme theoretic image of the morphism $U \to X$
is called the {\it scheme theoretic closure of $U$ in $X$}.
\item We say $U$ is {\it scheme theoretically dense in $X$}
if for every open $V \subset X$ the scheme theoretic closure
of $U \cap V$ in $V$ is equal to $V$.
\end{enumerate}
\end{definition}

\noindent
This is \cite[IV, Definition 11.10.2]{EGA}.
With this definition it is not the case that $U$ is scheme theoretically
dense in $X$ if and only if the scheme theoretic closure of $U$ is $X$,
see Example \ref{example-scheme-theretically-dense-not-dense}. This is somewhat
inelegant; but see Lemma \ref{lemma-scheme-theoretically-dense-quasi-compact}
below. On the other hand, with this definition $U$ is scheme theoretically
dense in $X$ if and only if for every $V \subset X$ open the ring map
$\mathcal{O}_X(V) \to \mathcal{O}_X(U \cap V)$ is injective, see
Lemma \ref{lemma-characterize-scheme-theoretically-dense} below.
In particular we see that scheme theoretically dense implies dense
which is pleasing.

\begin{example}
\label{example-scheme-theretically-dense-not-dense}
Here is an example where scheme theoretic closure being $X$ does not
imply dense for the underlying topological spaces.
Let $k$ be a field.
Set $A = k[x, z_1, z_2, \ldots]/(x^n z_n)$
Set $I = (z_1, z_2, \ldots) \subset A$.
Consider the affine scheme $X = \text{Spec}(A)$ and the
open subscheme $U = X \setminus V(I)$.
Since $A \to \prod_n A_{z_n}$ is injective we see that the scheme theoretic
closure of $U$ is $X$. Consider the morphism
$X \to \text{Spec}(k[x])$. This morphism is surjective
(set all $z_n = 0$ to see this). But the restriction
of this morphism to $U$ is not surjective because it maps
to the point $x = 0$. Hence $U$ cannot be topologically dense
in $X$.
\end{example}

\begin{lemma}
\label{lemma-scheme-theoretically-dense-quasi-compact}
Let $X$ be a scheme.
Let $U \subset X$ be an open subscheme.
If the inclusion morphism $U \to X$ is quasi-compact, then $U$
is scheme theoretically dense in $X$ if and only if the scheme theoretic
closure of $U$ in $X$ is $X$.
\end{lemma}

\begin{proof}
Follows from Lemma \ref{lemma-quasi-compact-scheme-theoretic-image} part (3).
\end{proof}

\begin{lemma}
\label{lemma-characterize-scheme-theoretically-dense}
Let $j : U \to X$ be an open immersion of schemes.
Then $U$ is scheme theoretically dense in $X$ if and only if
$\mathcal{O}_X \to j_*\mathcal{O}_U$ is injective.
\end{lemma}

\begin{proof}
If $\mathcal{O}_X \to j_*\mathcal{O}_U$ is injective,
then the same is true when restricted to any open $V$ of $X$.
Hence the scheme theoretic closure of $U \cap V$ in $V$
is equal to $V$, see Lemma \ref{lemma-quasi-compact-scheme-theoretic-image}
for example. Conversely, suppose that the scheme theoretic
closure of $U \cap V$ is equal to $V$ for all opens $V$.
Suppose that $\mathcal{O}_X \to j_*\mathcal{O}_U$ is not injective.
Then we can find an affine open, say $\text{Spec}(A) = V \subset X$
and a nonzero element $f \in A$ such that $f$ maps to zero in
$\Gamma(V \cap U, \mathcal{O}_X)$. In this case the scheme theoretic
closure of $V \cap U$ in $V$ is clearly contained in $\text{Spec}(A/(f))$
a contradiction.
\end{proof}

\begin{lemma}
\label{lemma-intersection-scheme-theoretically-dense}
Let $X$ be a scheme. If $U$, $V$ are scheme theoretically dense
open subschemes of $X$, then so is $U \cap V$.
\end{lemma}

\begin{proof}
Let $W \subset X$ be any open.
Consider the map
$\mathcal{O}_X(W) \to \mathcal{O}_X(W \cap V)
\to \mathcal{O}_X(W \cap V \cap U)$.
By Lemma \ref{lemma-characterize-scheme-theoretically-dense}
both maps are injective. Hence the composite is injective.
Hence by Lemma \ref{lemma-characterize-scheme-theoretically-dense}
$U \cap V$ is scheme theoretically dense in $X$.
\end{proof}

\begin{lemma}
\label{lemma-quasi-compact-immersion}
Let $Z \to X$ be a quasi-compact immersion.
Let $\overline{Z} \subset X$ be the scheme theoretic image of $h$.
Then the morphism $Z \to \overline{Z}$ is an open immersion
which identifies $Z$ with a scheme theoretically dense open
subscheme of $\overline{Z}$. Moreover, $Z$ is topologically
dense in $\overline{Z}$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-factor-quasi-compact-immersion} we can factor
$Z \to X$ as $Z \to \overline{Z}_1 \to X$ with $Z \to \overline{Z}_1$
open and $\overline{Z}_1 \to X$ closed. On the other hand, let
$Z \to \overline{Z} \subset X$ be the scheme theoretic closure of
$Z \to X$. We conclude that $\overline{Z} \subset \overline{Z}_1$.
Since $Z$ is an open subscheme of $\overline{Z}_1$ it follows
that $Z$ is an open subscheme of $\overline{Z}$ as well.
The assertion that $Z$ is scheme theoretically dense in
$\overline{Z}$ follows from
Lemma \ref{lemma-factor-quasi-compact-immersion} part (3).
The last assertion follows from
Lemma \ref{lemma-factor-quasi-compact-immersion} part (4).
\end{proof}

\begin{lemma}
\label{lemma-equality-of-morphisms}
Let $S$ be a scheme. Let $X$, $Y$ be schemes over $S$.
Let $f, g : X \to Y$ be morphisms of schemes over $S$.
Let $U \subset X$ be an open subscheme such that
$f|_U = g|_U$. If the scheme theoretic closure of $U$
in $X$ is $X$ and $Y \to S$ is separated, then $f = g$.
\end{lemma}

\begin{proof}
Follows from the definitions and
Schemes, Lemma \ref{schemes-lemma-where-are-they-equal}.
\end{proof}




\section{Dominant morphisms}
\label{section-dominant}

\noindent
The definition of a morphism of schemes being dominant is a little
different from what you might expect if you are used to the notion
of a dominant morphism of varieties.

\begin{definition}
\label{definition-dominant}
A morphism $f : X \to S$ of schemes is called {\it dominant} if the
image of $f$ is a dense subset of $S$.
\end{definition}

\noindent
So for example, if $k$ is an infinite field and $\lambda_1, \lambda_2, \ldots$
is a countable collection of elements of $k$, then the morphism
$$
\coprod\nolimits_{i = 1, 2, \ldots } \text{Spec}(k)
\longrightarrow
\text{Spec}(k[x])
$$
with $i$th factor mapping to the point $x = \lambda_i$ is dominant.

\begin{lemma}
\label{lemma-generic-points-in-image-dominant}
Let $f : X \to S$ be a morphism of schemes.
If every generic point of every irreducible component of $S$
is in the image of $f$, then $f$ is dominant.
\end{lemma}

\begin{proof}
This is a topological fact which follows directly from the fact that
the topological space underlying a scheme is sober, see
Schemes, Lemma \ref{schemes-lemma-scheme-sober}, and that
every point of $S$ is contained in an irreducible component of
$S$, see Topology, Lemma \ref{topology-lemma-irreducible}.
\end{proof}

\noindent
The expectation that morphisms are dominant only if generic points of the
target are in the image does hold if the morphism is quasi-compact.

\begin{lemma}
\label{lemma-quasi-compact-dominant}
Let $f : X \to S$ be a quasi-compact morphism of schemes.
Then $f$ is dominant (if and) only if for every irreducible
component $Z \subset S$ the generic point of $Z$ is in the
image of $f$.
\end{lemma}

\begin{proof}
Let $V \subset S$ be an affine open.
Because $f$ is quasi-compact we may choose finitely many affine
opens $U_i \subset f^{-1}(V)$, $i = 1, \ldots, n$ covering
$f^{-1}(V)$. Consider the morphism of affines
$$
f' :
\coprod\nolimits_{i = 1, \ldots, n} U_i
\longrightarrow
V.
$$
A disjoint union of affines is affine, see
Schemes, \ref{schemes-lemma-disjoint-union-affines}.
Generic points of irreducible components of $V$
are exactly the generic points of the irreducible components of
$S$ that meet $V$. Also, $f$ is dominant if and only $f'$ is dominant
no matter what choices of $V, n, U_i$ we make above. Thus we
have reduced the lemma to the case of a morphism of affine schemes.
The affine case is
Algebra, Lemma \ref{algebra-lemma-image-dense-generic-points}.
\end{proof}

\noindent
There is another case where this holds.

\begin{lemma}
\label{lemma-dominant-finite-number-irreducible-components}
Let $f : X \to S$ be a morphism of schemes.
Suppose that $X$ has finitely many irreducible components.
Then $f$ is dominant (if and) only if for every irreducible
component $Z \subset S$ the generic point of $Z$ is in the
image of $f$. If so, then $S$ has finitely many irreducible
components as well.
\end{lemma}

\begin{proof}
Assume $f$ is dominant.
Say $X = Z_1 \cup Z_2 \cup \ldots \cup Z_n$ is the decomposition
of $X$ into irreducible components. Let $\xi_i \in Z_i$ be
its generic point, so $Z_i = \overline{\{\xi_i\}}$.
Note that $f(Z_i)$ is an irreducible subset of $S$.
Hence
$$
S = \overline{f(X)} = \bigcup \overline{f(Z_i)} =
\bigcup \overline{\{f(\xi_i)\}}
$$
is a finite union if irreducible subsets whose generic
points are in the image of $f$. The lemma follows.
\end{proof}






\section{Birational morphisms}
\label{section-birational}

\noindent
You may be used to the notion of a birational map of varieties
having the property that it is an isomorphism over an open subset
of the target. However, in general a birational morphism may
not be an isomorphism over any nonempty open, see
Example \ref{example-birational-not-iso-over-open}.
Here is the formal definition.

\begin{definition}
\label{definition-birational}
Let $X$, $Y$ be schemes. Assume $X$ and $Y$ have finitely many
irreducible components. We say a morphism $f : X \to Y$ is
{\it birational} if
\begin{enumerate}
\item $f$ induces a bijection between the set of generic points
of irreducible components of $X$ and the set of generic points
of the irreducible components of $Y$, and
\item for every generic point $\eta \in X$ of an irreducible component
of $X$ the local ring map
$\mathcal{O}_{Y, f(\eta)} \to \mathcal{O}_{X, \eta}$
is an isomorphism.
\end{enumerate}
\end{definition}

\begin{lemma}
\label{lemma-birational-dominant}
Let $f : X \to Y$ be a morphism of schemes having finitely
many irreducible components. If $f$ is birational then
$f$ is dominant.
\end{lemma}

\begin{proof}
Follows immediately from the definitions.
\end{proof}

\begin{example}
\label{example-birational-not-iso-over-open}
Here is an example of a birational morphism which is not an isomorphism
over any open of the target.
Let $k$ be an infinite field.
Let $A = k[x]$. Let
$B = k[x, \{y_{\alpha}\}_{\alpha \in k}]/
((x-\alpha)y_\alpha, y_\alpha y_\beta)$.
There is an inclusion $A \subset B$ and a retraction $B \to A$
setting all $y_\alpha$ equal to zero.
Both the morphism $\text{Spec}(A) \to \text{Spec}(B)$
and the morphism $\text{Spec}(B) \to \text{Spec}(A)$ are birational
but not an isomorphism over any open.
\end{example}





\section{Rational maps}
\label{section-rational-maps}

\noindent
Let $X$ be a scheme. Note that if $U$, $V$ are dense open
in $X$, then so is $U \cap V$.

\begin{definition}
\label{definition-rational-map}
Let $X$, $Y$ be schemes.
\begin{enumerate}
\item Let $f : U \to Y$, $g : V \to Y$ be morphisms of schemes defined
on dense open subsets $U$, $V$ of $X$. We say that $f$ is
{\it equivalent} to $g$ if $f|_W = g|_W$ for some $W \subset U \cap V$
dense open in $X$.
\item A {\it rational map from $X$ to $Y$}
is an equivalence class for the equivalence relation defined in (1).
\item If $X$, $Y$ are schemes over a base scheme $S$ we say that
a rational map from $X$ to $Y$ is an {\it $S$-rational map from $X$
to $Y$} if there exists a representative $f : U \to Y$ of the equivalence
class which is an $S$-morphism.
\end{enumerate}
\end{definition}

\noindent
We say that two morphisms $f$, $g$ as in (1) of the definition
define the same rational map instead of saying that they are equivalent.

\begin{definition}
\label{definition-rational-function}
Let $X$ be a scheme. A {\it rational function on $X$} is a rational morphism
from $X$ to $\mathbf{A}^1_{\mathbf{Z}}$.
\end{definition}

\noindent
See Constructions, Definition \ref{constructions-definition-affine-n-space}
for the definition of the affine line $\mathbf{A}^1$. Let $X$ be a scheme
over $S$. For any open $U \subset X$ a morphism
$U \to \mathbf{A}^1_{\mathbf{Z}}$ is the same as a morphism
$U \to \mathbf{A}^1_S$ over $S$. Hence a rational function is
also the same as a $S$-rational map from $X$ into $\mathbf{A}^1_S$.

\medskip\noindent
Recall that we have the canonical identification
$\text{Mor}(T, \mathbf{A}^1_{\mathbf{Z}}) = \Gamma(T, \mathcal{O}_T)$
for any scheme $T$, see Schemes, Example \ref{schemes-example-global-sections}.
Hence $\mathbf{A}^1_{\mathbf{Z}}$ is a ring-object in the
category of schemes. More precisely, the morphisms
\begin{eqnarray*}
+ : \mathbf{A}^1_{\mathbf{Z}} \times \mathbf{A}^1_{\mathbf{Z}}
& \longrightarrow &
\mathbf{A}^1_{\mathbf{Z}} \\
(f, g) & \longmapsto & f + g \\
* : \mathbf{A}^1_{\mathbf{Z}} \times \mathbf{A}^1_{\mathbf{Z}}
& \longrightarrow &
\mathbf{A}^1_{\mathbf{Z}} \\
(f, g) & \longmapsto & fg
\end{eqnarray*}
satisfy all the axioms of the addition and multiplication in a ring
(commutative with $1$ as always). Hence also the set of rational
maps into $\mathbf{A}^1_{\mathbf{Z}}$ has a natural ring structure.

\begin{definition}
\label{definition-ring-of-rational-functions}
Let $X$ be a scheme. The {\it ring of rational functions on $X$}
is the ring $R(X)$ whose elements are rational functions with
addition and multiplication as just described.
\end{definition}

\begin{lemma}
\label{lemma-integral-scheme-rational-functions}
Let $X$ be an irreducible scheme. Let $\eta \in X$ be the generic point
of $X$. There is a canonical identification
$R(X) \cong \mathcal{O}_{X, \eta}$. If $X$ is integral then $R(X)$ is
a field.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{definition}
\label{definition-function-field}
Let $X$ be an integral scheme.
The {\it function field}, or the {\it field of rational functions}
of $X$ is the field $R(X)$.
\end{definition}

\noindent
We may occasionally indicate this field $k(X)$ instead of $R(X)$.

\begin{remark}
\label{remark-pseudo-morphisms}
There is a variant of Definition \ref{definition-rational-map}
where we consider only those morphism $U \to Y$ defined on
scheme theoretically dense open subschemes $U \subset X$.
We use Lemma \ref{lemma-intersection-scheme-theoretically-dense}
to see that we obtain an equivalence relation.
An equivalence class of these is called a
{\it pseudo-morphism from $X$ to $Y$}.
If $X$ is reduced the two notions coincide.
\end{remark}









\section{Surjective morphisms}
\label{section-surjective}

\begin{definition}
\label{definition-surjective}
A morphism of schemes is said to be {\it surjective}
if it is surjective on underlying topological
spaces.
\end{definition}

\begin{lemma}
\label{lemma-composition-surjective}
The composition of surjective morphisms is surjective.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-base-change-surjective}
The base change of a surjective morphism is surjective.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}




\section{Radicial morphisms}
\label{section-radicial}

\begin{definition}
\label{definition-radicial}
Let $f : X \to S$ be a morphism.
We say $f$ is {\it radicial}, or {\it universally injective}
if for every field $K$ the induced map
$\text{Mor}(\text{Spec}(K), X) \to \text{Mor}(\text{Spec}(K), S)$
is injective.
\end{definition}

\begin{lemma}
\label{lemma-radicial-universally-injective}
Let $f : X \to S$ be a morphism of schemes.
The following are equivalent:
\begin{enumerate}
\item The morphism $f$ is radicial.
\item The morphism $f$ is universally injective, i.e.,
for every morphism $S' \to S$ the base change $f' : X_{S'} \to S$
is injective on underlying topological spaces.
\item For every $s \in S$ there is at most one $x \in X$
with $f(s) = x$ and the field extension $\kappa(s) \subset \kappa(x)$
is either an equality or purely inseparable.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $K$ be a field, and let $s : \text{Spec}(K) \to S$ be a morphism.
Giving a morphism $x : \text{Spec}(K) \to X$ such that $f \circ x = s$
is the same as giving a section of the projection
$X_K = \text{Spec}(K) \times_S X \to \text{Spec}(K)$, which in turn
is the same as giving a point $x \in X_K$ whose residue field is $K$.
Hence we see that (2) implies (1).

\medskip\noindent
Conversely, suppose that (1) holds. Assume that $x, x' \in X_{S'}$
map to the same point $s' \in S'$. Choose a commutative diagram
$$
\xymatrix{
K & \kappa(x) \ar[l] \\
\kappa(x') \ar[u] & \kappa(s') \ar[l] \ar[u]
}
$$
of fields. By Schemes, Lemma \ref{schemes-lemma-characterize-points}
we get two morphisms $a, a' : \text{Spec}(K) \to X_{S'}$. One corresponding
to the point $x$ and the embedding $\kappa(x) \subset K$ and
the other corresponding to the  point $x$ and the embedding
$\kappa(x') \subset K$. Also we have $f' \circ a = f' \circ a'$.
Condition (1) now implies that the compositions of $a$ and $a'$ with
$X_{S'} \to X$ are equal. Since $X_{S'}$ is the fibre product
of $S'$ and $X$ over $S$ we see that $a = a'$. Hence $x = x'$ as
desired.

\medskip\noindent
If there are two points $x, x'$ mapping to the same point of $s$
then $f$ is not radicial by the equivalence of (1) and (2) above.
If for some $s = f(x)$, $x \in X$ the field extension
$\kappa(s) \subset \kappa(x)$ is not purely inseparable, then
we may find a field extension $\kappa(s) \subset K$ such that
$\kappa(x)$ has two $\kappa(s)$-homomorphisms into $K$. By
Schemes, Lemma \ref{schemes-lemma-characterize-points} this
implies that the map
$\text{Mor}(\text{Spec}(K), X) \to \text{Mor}(\text{Spec}(K), S)$
is not injective, and hence $f$ is not radicial.
Thus we see that (1) implies (3).

\medskip\noindent
Finally, assume (3). By
Schemes, Lemma \ref{schemes-lemma-characterize-points} a morphism
$\text{Spec}(K) \to X$ is given by a pair $(x, \kappa(x) \to K)$.
Property (3) says exactly that associating to the pair
$(x, \kappa(x) \to K)$ the pair $(s, \kappa(s) \to \kappa(x) \to K)$
is injective.
\end{proof}











\section{Affine morphisms}
\label{section-affine}

\begin{definition}
\label{definition-affine}
A morphism of schemes $f : X \to S$ is called {\it affine} if
the inverse image of every affine open of $S$ is an affine
open of $X$.
\end{definition}

\begin{lemma}
\label{lemma-affine-separated}
An affine morphism is separated and quasi-compact.
\end{lemma}

\begin{proof}
Let $f : X \to S$ be affine. Quasi-compactness is immediate from
Schemes, Lemma \ref{schemes-lemma-quasi-compact-affine}.
We will show $f$ is separated using
Schemes, Lemma \ref{schemes-lemma-characterize-separated}. Let
$x_1, x_2 \in X$ be points of $X$ which map to the same point $s \in S$.
Choose any affine open $W \subset S$ containing $s$. By assumption
$f^{-1}(W)$ is affine. Apply the lemma cited with $U = V = f^{-1}(W)$.
\end{proof}

\begin{lemma}
\label{lemma-characterize-affine}
Let $f : X \to S$ be a morphism of schemes.
The following are equivalent
\begin{enumerate}
\item The morphism $f$ is affine.
\item There exists an affine open covering $S = \bigcup W_j$
such that each $f^{-1}(W_j)$ is affine.
\item There exists a quasi-coherent sheaf of $\mathcal{O}_S$-algebras
$\mathcal{A}$ such that $X \cong \underline{\text{Spec}}_S(\mathcal{A})$
as schemes over $S$. See
Constructions, Section \ref{constructions-section-spec} for notation.
\end{enumerate}
Moreover, in this case $X = \underline{\text{Spec}}_S(f_*\mathcal{O}_X)$.
\end{lemma}

\begin{proof}
It is obvious that (1) implies (2).

\medskip\noindent
Assume $S = \bigcup_{j \in J} W_j$ is an affine open covering such that
each $f^{-1}(W_j)$ is affine. By
Schemes, Lemma \ref{schemes-lemma-quasi-compact-affine} we see
that $f$ is quasi-compact. By
Schemes, Lemma \ref{schemes-lemma-characterize-quasi-separated}
we see the morphism $f$ is quasi-separated. Hence by
Schemes, Lemma \ref{schemes-lemma-push-forward-quasi-coherent} the
sheaf $\mathcal{A} = f_*\mathcal{O}_X$ is a quasi-coherent sheaf
of $\mathcal{O}_X$-algebras. Thus we have the scheme
$g : Y = \underline{\text{Spec}}_S(\mathcal{A}) \to S$ over $S$.
The identity map
$\text{id} : \mathcal{A} = f_*\mathcal{O}_X \to f_*\mathcal{O}_X$
provides, via the definition of the relative spectrum,
a morphism $can : X \to Y$ over $S$, see
Constructions, Lemma \ref{constructions-lemma-canonical-morphism}.
By assumption and the lemma just cited
the restriction $can|_{f^{-1}(W_j)} : f^{-1}(W_j) \to g^{-1}(W_j)$
is an isomorphism. Thus $can$ is an isomorphism.
We have shown that (2) implies (3).

\medskip\noindent
Assume (3). By Constructions, Lemma \ref{constructions-lemma-spec-properties}
we see that the inverse image of every affine open is affine, and hence
the morphism is affine by definition.
\end{proof}

\begin{remark}
\label{remark-direct-argument}
We can also argue directly that (2) implies (1) in
Lemma \ref{lemma-characterize-affine} above as follows.
Assume $S = \bigcup W_j$ is an affine open covering
such that each $f^{-1}(W_j)$ is affine.
First argue that $\mathcal{A} = f_*\mathcal{O}_X$ is quasi-coherent
as in the proof above.
Let $\text{Spec}(R) = V \subset S$ be affine open.
We have to show that $f^{-1}(V)$ is affine. Set
$A = \mathcal{A}(V) = f_*\mathcal{O}_X(V) = \mathcal{O}_X(f^{-1}(V))$.
By Schemes, Lemma \ref{schemes-lemma-morphism-into-affine} there is
a canonical morphism $\psi : f^{-1}(V) \to \text{Spec}(A)$ over
$\text{Spec}(R) = V$.
By Schemes, Lemma \ref{schemes-lemma-good-subcover} there exists
an integer $n \geq 0$, a standard open covering
$V = \bigcup_{i = 1, \ldots, n} D(h_i)$, $h_i \in R$, and a map
$a : \{1, \ldots, n\} \to J$ such that each $D(h_i)$ is also
a standard open of the affine scheme $W_{a(i)}$. The inverse image
of a standard open under a morphism of affine schemes is standard open, see
Algebra, Lemma \ref{algebra-lemma-spec-functorial}. Hence we see
that $f^{-1}(D(h_i))$ is a standard open of $f^{-1}(W_{a(i)})$,
in particular that $f^{-1}(D(h_i))$ is affine. Because $\mathcal{A}$
is quasi-coherent we have
$A_{h_i} = \mathcal{A}(D(h_i)) = \mathcal{O}_X(f^{-1}(D(h_i)))$,
so $f^{-1}(D(h_i))$ is the spectrum of $A_{h_i}$.
It follows that the morphism $\psi$ induces an isomorphism of the open
$f^{-1}(D(h_i))$ with the open $\text{Spec}(A_{h_i})$ of
$\text{Spec}(A)$. Since $f^{-1}(V) = \bigcup f^{-1}(D(h_i))$
and $\text{Spec}(A) = \bigcup \text{Spec}(A_{h_i})$ we win.
\end{remark}

\begin{lemma}
\label{lemma-affine-equivalence-algebras}
Let $S$ be a scheme. There is an anti-equivalence of categories
$$
\begin{matrix}
\text{Schemes affine} \\
\text{over }S
\end{matrix}
\longleftrightarrow
\begin{matrix}
\text{quasi-coherent sheaves} \\
\text{of }\mathcal{O}_S\text{-algebras}
\end{matrix}
$$
which associates to $f : X \to S$ the sheaf $f_*\mathcal{O}_X$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-affine-equivalence-modules}
Let $f : X \to S$ be an affine morphism of schemes.
Let $\mathcal{A} = f_*\mathcal{O}_X$.
There are canonical equivalences between the following categories:
\begin{enumerate}
\item The category of quasi-coherent $\mathcal{O}_X$-modules.
\item The category of sheaves of $\mathcal{A}$-modules which
are quasi-coherent as sheaves of $\mathcal{O}_S$-modules.
\item The category of quasi-coherent sheaves of $\mathcal{A}$-modules.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-composition-affine}
The composition of affine morphisms is affine.
\end{lemma}

\begin{proof}
Let $f : X \to Y$ and $g : Y \to Z$ be affine morphisms.
Let $U \subset Z$ be affine open. Then $g^{-1}(U)$ is affine
by assumption on $g$. Whereupon $f^{-1}(g^{-1}(U))$ is affine
by assumption on $f$. Hence $(g \circ f)^{-1}(U)$ is affine.
\end{proof}

\begin{lemma}
\label{lemma-base-change-affine}
The base change of an affine morphism is affine.
\end{lemma}

\begin{proof}
Let $f : X \to S$ be an affine morphism. Let $S' \to S$ be any morphism.
Denote $f' : X_{S'} = S' \times_S X \to S'$ the base change of $f$.
For every $s' \in S'$ there exists an open affine neighbourhood
$s' \in V \subset S'$ which maps into some open affine $U \subset S$.
By assumption $f^{-1}(U)$ is affine. By the material in
Schemes, Section \ref{schemes-section-fibre-products} we see
that $f^{-1}(U)_{V} = V \times_U f^{-1}(U)$ is affine and equal
to $(f')^{-1}(V)$. This proves that $S'$ has an open covering by
affines whose inverse image under $f'$ is affine. We conclude
by Lemma \ref{lemma-characterize-affine} above.
\end{proof}

\begin{lemma}
\label{lemma-closed-immersion-affine}
A closed immersion is affine.
\end{lemma}

\begin{proof}
The first indication of this is
Schemes, Lemma \ref{schemes-lemma-closed-immersion-affine-case}.
See Schemes, Lemma \ref{schemes-lemma-closed-subspace-scheme}
for a complete statement.
\end{proof}

\begin{lemma}
\label{lemma-affine-s-open}
Let $X$ be a scheme.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
Let $s \in \Gamma(X, \mathcal{L})$.
The inclusion morphism $j : X_s \to X$ is affine.
\end{lemma}

\begin{proof}
This follows from Properties, Lemma \ref{properties-lemma-affine-cap-s-open}
and the definition.
\end{proof}

\begin{lemma}
\label{lemma-affine-permanence}
Suppose $g : X \to Y$ is a morphism of schemes over $S$.
If $X$ is affine over $S$ and $Y$ is separated over $S$,
then $g$ is affine. In particular, any morphism from an
affine scheme into a separated scheme is affine.
\end{lemma}

\begin{proof}
The base change $X \times_S Y \to Y$ is affine by
Lemma \ref{lemma-base-change-affine}.
The morphism $X \to X \times_S Y$ is
a closed immersion as $Y \to S$ is separated, see
Schemes, \ref{schemes-lemma-section-immersion}.
A closed immersion is affine (see Lemma \ref{lemma-closed-immersion-affine})
and the composition of affine morphisms is affine
(see Lemma \ref{lemma-composition-affine}). Thus we win.
\end{proof}

\begin{lemma}
\label{lemma-morphism-affines-affine}
A morphism between affine schemes is affine.
\end{lemma}

\begin{proof}
Immediate from Lemma \ref{lemma-affine-permanence} with
$S = \text{Spec}(\mathbf{Z})$. It also follows directly from the
equivalence of (1) and (2) in Lemma \ref{lemma-characterize-affine}.
\end{proof}

\begin{lemma}
\label{lemma-Artinian-affine}
Let $S$ be a scheme.
Let $A$ be an Artinian ring.
Any morphism $\text{Spec}(A) \to S$ is affine.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}









\section{Quasi-affine morphisms}
\label{section-quasi-affine}

\noindent
Recall that a scheme $X$ is called {\it quasi-affine} if it is quasi-compact
and isomorphic to an open subscheme of an affine scheme, see
Properties, Definition \ref{properties-definition-quasi-affine}.

\begin{definition}
\label{definition-quasi-affine}
A morphism of schemes $f : X \to S$ is called {\it quasi-affine} if
it is quasi-compact and the inverse image of every affine open
of $S$ is a quasi-affine scheme.
\end{definition}

\begin{lemma}
\label{lemma-quasi-affine-separated}
A quasi-affine morphism is separated and quasi-compact.
\end{lemma}

\begin{proof}
Let $f : X \to S$ be quasi-affine.
Quasi-compactness is immediate from
Schemes, Lemma \ref{schemes-lemma-quasi-compact-affine}.
We will show $f$ is separated using
Schemes, Lemma \ref{schemes-lemma-characterize-separated}. Let
$x_1, x_2 \in X$ be points of $X$ which map to the same point $s \in S$.
Choose any affine open $W \subset S$ containing $s$. By assumption
$f^{-1}(W)$ is isomorphic to an open subscheme of an affine scheme,
say $f^{-1}(W) \to Y$ is such an open immersion.
Choose affine open neighbourhoods $x_1 \in U \subset f^{-1}(W)$
and $x_2 \in V \subset f^{-1}(W)$. We may think of $U$ and $V$
as open subschemes of $Y$ and hence we see that
$U \cap V$ is affine and that
$\mathcal{O}(U) \otimes_{\mathbf{Z}} \mathcal{O}(V) \to \mathcal{O}(U \cap V)$
is surjective (by the lemma cited above applied to $U, V$ in $Y$).
Hence by the lemma cited we conclude that $f$ is separated.
\end{proof}

\begin{lemma}
\label{lemma-characterize-quasi-affine}
Let $f : X \to S$ be a morphism of schemes.
The following are equivalent
\begin{enumerate}
\item The morphism $f$ is quasi-affine.
\item There exists an affine open covering $S = \bigcup W_j$
such that each $f^{-1}(W_j)$ is quasi-affine.
\item There exists a quasi-coherent sheaf of $\mathcal{O}_S$-algebras
$\mathcal{A}$ and a quasi-compact open immersion
$$
\xymatrix{
X \ar[rr] \ar[rd] & & \underline{\text{Spec}}_S(\mathcal{A}) \ar[dl] \\
& S &
}
$$
over $S$.
\item Same as in (3) but with $\mathcal{A} = f_*\mathcal{O}_X$
and the horizontal arrow the canonical morphism of
Constructions, Lemma \ref{constructions-lemma-canonical-morphism}.
\end{enumerate}
\end{lemma}

\begin{proof}
It is obvious that (1) implies (2) and that (4) implies (3).

\medskip\noindent
Assume $S = \bigcup_{j \in J} W_j$ is an affine open covering such that
each $f^{-1}(W_j)$ is quasi-affine. By
Schemes, Lemma \ref{schemes-lemma-quasi-compact-affine} we see
that $f$ is quasi-compact. By
Schemes, Lemma \ref{schemes-lemma-characterize-quasi-separated}
we see the morphism $f$ is quasi-separated. Hence by
Schemes, Lemma \ref{schemes-lemma-push-forward-quasi-coherent} the
sheaf $\mathcal{A} = f_*\mathcal{O}_X$ is a quasi-coherent sheaf
of $\mathcal{O}_X$-algebras. Thus we have the scheme
$g : Y = \underline{\text{Spec}}_S(\mathcal{A}) \to S$ over $S$.
The identity map
$\text{id} : \mathcal{A} = f_*\mathcal{O}_X \to f_*\mathcal{O}_X$
provides, via the definition of the relative spectrum,
a morphism $can : X \to Y$ over $S$, see
Constructions, Lemma \ref{constructions-lemma-canonical-morphism}.
By assumption, the lemma just cited, and
Properties, Lemma \ref{properties-lemma-quasi-affine}
the restriction $can|_{f^{-1}(W_j)} : f^{-1}(W_j) \to g^{-1}(W_j)$
is a quasi-compact open immersion. Thus $can$ is a quasi-compact
open immersion. We have shown that (2) implies (4).

\medskip\noindent
Assume (3). Choose any affine open $U \subset S$.
By Constructions, Lemma \ref{constructions-lemma-spec-properties}
we see that the inverse image of $U$ in the relative spectrum
is affine. Hence we conclude that $f^{-1}(U)$ is quasi-affine
(note that quasi-compactness is encoded in (3) as well).
Thus (3) implies (1).
\end{proof}

\begin{lemma}
\label{lemma-composition-quasi-affine}
The composition of quasi-affine morphisms is quasi-affine.
\end{lemma}

\begin{proof}
Let $f : X \to Y$ and $g : Y \to Z$ be quasi-affine morphisms.
Let $U \subset Z$ be affine open. Then $g^{-1}(U)$ is quasi-affine
by assumption on $g$. Let $j : g^{-1}(U) \to V$ be a quasi-compact
open immersion into an affine scheme $V$.
By Lemma \ref{lemma-characterize-quasi-affine} above
we see that $f^{-1}(g^{-1}(U))$
is a quasi-compact open subscheme of the relative spectrum
$\underline{\text{Spec}}_{g^{-1}(U)}(\mathcal{A})$ for
some quasi-coherent sheaf of $\mathcal{O}_{g^{-1}(U)}$-algebras
$\mathcal{A}$. By
Schemes, Lemma \ref{schemes-lemma-push-forward-quasi-coherent}
the sheaf $\mathcal{A}' = j_*\mathcal{A}$
is a quasi-coherent sheaf of $\mathcal{O}_V$-algebras
with the property that $j^*\mathcal{A}' = \mathcal{A}$.
Hence we get a commutative diagram
$$
\xymatrix{
f^{-1}(g^{-1}(U)) \ar[r] &
\underline{\text{Spec}}_{g^{-1}(U)}(\mathcal{A})
\ar[r] \ar[d] &
\underline{\text{Spec}}_{V}(\mathcal{A}') \ar[d] \\
& g^{-1}(U) \ar[r]^j & V
}
$$
with the square being a fibre square,
see Constructions, Lemma \ref{constructions-lemma-spec-properties}.
Note that the upper right corner is an affine scheme.
Hence $(g \circ f)^{-1}(U)$ is quasi-affine.
\end{proof}

\begin{lemma}
\label{lemma-base-change-quasi-affine}
The base change of a quasi-affine morphism is quasi-affine.
\end{lemma}

\begin{proof}
Let $f : X \to S$ be a quasi-affine morphism.
By Lemma \ref{lemma-characterize-quasi-affine} above
we can find a quasi-coherent sheaf
of $\mathcal{O}_S$-algebras $\mathcal{A}$ and a quasi-compact
open immersion $X \to \underline{\text{Spec}}_S(\mathcal{A})$
over $S$.
Let $g : S' \to S$ be any morphism.
Denote $f' : X_{S'} = S' \times_S X \to S'$ the base change of $f$.
Since the base change of a quasi-compact open immersion is
a quasi-compact open immersion we see that
$X_{S'} \to \underline{\text{Spec}}_{S'}(g^*\mathcal{A})$
is a quasi-compact open immersion
(we have used Schemes, Lemmas
\ref{schemes-lemma-quasi-compact-preserved-base-change} and
\ref{schemes-lemma-base-change-immersion} and
Constructions, Lemma \ref{constructions-lemma-spec-properties}).
By Lemma \ref{lemma-characterize-quasi-affine} again
we conclude that $X_{S'} \to S'$ is quasi-affine.
\end{proof}

\begin{lemma}
\label{lemma-affine-quasi-affine}
Let $S$ be a scheme. Let $X$ be an affine scheme.
A morphism $X \to S$ is quasi-affine
if and only if it is quasi-compact.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}












\section{Types of morphisms defined by properties of ring maps}
\label{section-properties-ring-maps}

\noindent
In this section we study what properties of ring maps
allow one to define local properties of morphisms of schemes.

\begin{definition}
\label{definition-property-local}
Let $P$ be a property of ring maps.
\begin{enumerate}
\item We say that $P$ is {\it local} if the following hold:
\begin{enumerate}
\item For any ring map $R \to A$, and any $f \in R$ we have
$P(R \to A) \Rightarrow P(R_f \to A_f)$.
\item For any rings $R$, $A$, any $f \in R$, $a\in A$, and any ring map
$R_f \to A$ we have $P(R_f \to A) \Rightarrow P(R \to A_a)$.
\item For any ring map $R \to A$, and $a_i \in A$ such that
$(a_1, \ldots, a_n) = A$ then
$\forall i, P(R \to A_{a_i}) \Rightarrow P(R \to A)$.
\end{enumerate}
\item We say that $P$ is {\it stable under base change} if for any
ring maps $R \to A$, $R \to R'$ we have
$P(R \to A) \Rightarrow P(R' \to R' \otimes_R A)$.
\item We say that $P$ is {\it stable under composition} if for any
ring maps $A \to B$, $B \to C$ we have
$P(A \to B) \wedge P(B \to C) \Rightarrow P(A \to C)$.
\end{enumerate}
\end{definition}

\begin{definition}
\label{definition-locally-P}
Let $P$ be a property of ring maps.
Let $f : X \to S$ be a morphisms of schemes.
We say $f$ is {\it locally of type $P$} if for any $x \in X$
there exists an affine open neighbourhood $U$ of $x$
in $X$ which maps into an affine open $V \subset S$ such that
the induced ring map $\mathcal{O}_S(V) \to \mathcal{O}_X(U)$
has property $P$.
\end{definition}

\noindent
This is not a ``good'' definition unless the property $P$ is
a local property. Even if $P$ is a local property we will not
automatically use this definition to say that a morphism is
``locally of type $P$'' unless we also explicitly state the
definition elsewhere.

\begin{lemma}
\label{lemma-locally-P}
Let $f : X \to S$ be a morphism of schemes.
Let $P$ be a property of ring maps.
Let $\text{Spec}(A) = U$ be an affine open of $X$,
and $\text{Spec}(R) = V$ an affine open of $S$ such that
$f(U) \subset V$. Let $R \to A$ be the induced ring map.
If $f$ is locally of type $P$ and $P$ is local,
then $P(R \to A)$ holds.
\end{lemma}

\begin{proof}
By definition there exists an affine open covering
$U = \bigcup_{i \in I} U_i$, $U_i = \text{Spec}(A_i)$ such that each $f(U_i)$
is contained in an affine open $V_i = \text{Spec}(R_i)$ of $S$
and such $P(R_i \to A_i)$ holds for all $i$.
(Warning: $V_i$ may not be contained in $V$.)
For any $u \in U_i$ we may choose an open neighbourhood
$V_{iu} \subset V \cap V_i$ of $f(u)$ which is a standard affine
open in both $V$ and $V_i$, see
Schemes, Lemma \ref{schemes-lemma-standard-open-two-affines}.
Note that $u \in f^{-1}(V_{i, u})$.
Because $U_i$ is quasi-compact we may choose a finite
collection $V_{ij} \subset V \cap V_i$, $j \in I_i$ of such affine opens
such that $f(U_i) \subset \bigcup_{j \in I_j} V_{ij}$.
Write $V_{ij} = \text{Spec}(R_{ij})$, so that
$R_{ij} \cong R_{r_{ij}} \cong (R_i)_{r_{ij}'}$ for certain
$r_{ij} \in R$, $r_{ij}' \in R_i$.
We may cover each $U_i \cap f^{-1}(V_{ij})$
by finitely many standard opens of $U = \text{Spec}(A)$.
Say $U_i \cap f^{-1}(V_{ij}) = \bigcup_{k \in K_{ij}} D(a_{ijk})$,
with $a_{ijk} \in A$. We have $A_{a_{ijk}} \cong (A_i)_{a_{ijk}}$.
The open subschemes and their inclusion relations give rise
to the following commutative diagram or rings:
$$
\xymatrix{
& R_i \ar[r] \ar[d]^{r_{ij}'} & A_i \ar[d]^{r_{ij}'}
& A \ar[l] \ar[d]^{a_{ijk}}\\
R \ar[r]^{r_{ij}} & R_{ij} \ar[r] & A_i \otimes_{R_i} R_{ij} \ar[r]^-{a_{ijk}}
& A_{a_{ijk}}
}
$$
Here we have labeled each arrow which is a principal localization with
the element at which the source of the arrow is being localized.
Since we have $P(R_i \to A_i)$ we have
$P(R_{ij} \to A_i \otimes_{R_i} R_{ij})$ by
Definition \ref{definition-property-local} (1)(a).
Then we conclude $P(R \to A_{a_{ijk}})$ by
Definition \ref{definition-property-local} (1)(b).
Because the opens $D(a_{ijk})$ cover all the opens
$U_i \cap f^{-1}(D(r_{ij})$ which cover the opens $U_i$
which cover all of $U$ we see that $U = \bigcup_{ijk} D(a_{ijk})$.
Hence $P(R \to A)$ by Definition \ref{definition-property-local} (1)(c).
\end{proof}

\begin{lemma}
\label{lemma-locally-P-characterize}
Let $P$ be a local property of ring maps.
Let $f : X \to S$ be a morphism of schemes.
The following are equivalent
\begin{enumerate}
\item The morphism $f$ is locally of type $P$.
\item For every affine opens $U \subset X$, $V \subset S$
with $f(U) \subset V$ we have $P(\mathcal{O}_S(V) \to \mathcal{O}_X(U))$.
\item There exists an open covering $S = \bigcup_{j \in J} V_j$
and open coverings $f^{-1}(V_j) = \bigcup_{i \in I_j} U_i$ such
that each of the morphisms $U_i \to V_j$, $j\in J, i\in I_j$
is locally of type $P$.
\item There exists an affine open covering $S = \bigcup_{j \in J} V_j$
and affine open coverings $f^{-1}(V_j) = \bigcup_{i \in I_j} U_i$ such
that $P(\mathcal{O}_S(V_j) \to \mathcal{O}_X(U_i))$ holds, for all
$j\in J, i\in I_j$.
\end{enumerate}
Moreover, if $f$ is locally of type $P$ then for
any open subschemes $U \subset X$, $V \subset S$ with $f(U) \subset V$
the restriction $f|_U : U \to V$ is locally of type $P$.
\end{lemma}

\begin{proof}
This follows from Lemma \ref{lemma-locally-P} above.
\end{proof}

\begin{lemma}
\label{lemma-composition-type-P}
Let $P$ be a property of ring maps.
Assume $P$ is local and stable under composition.
The composition of morphisms locally of type $P$ is
locally of type $P$.
\end{lemma}

\begin{proof}
Let $f : X \to Y$ and $g : Y \to Z$ be morphisms locally of type $P$.
Let $x \in X$. Choose an affine open neighbourhood $W \subset Z$ of
$g(f(x))$. Choose an affine open neighbourhood $V \subset g^{-1}(W)$
of $f(x)$. Choose an affine open neighbourhood $U \subset f^{-1}(V)$
of $x$. By Lemma \ref{lemma-locally-P-characterize} the ring maps
$\mathcal{O}_Z(W) \to \mathcal{O}_Y(V)$ and
$\mathcal{O}_Y(V) \to \mathcal{O}_X(U)$ satisfy $P$.
Hence $\mathcal{O}_Z(W) \to \mathcal{O}_X(U)$ satisfies $P$
as $P$ is assumed stable under composition.
\end{proof}

\begin{lemma}
\label{lemma-base-change-type-P}
Let $P$ be a property of ring maps.
Assume $P$ is local and stable under base change.
The base change of a morphism locally of type $P$
is locally of type $P$.
\end{lemma}

\begin{proof}
Let $f : X \to S$ be a morphism locally of type $P$.
Let $S' \to S$ be any morphism. Denote
$f' : X_{S'} = S' \times_S X \to S'$ the base change of $f$.
For every $s' \in S'$ there exists an open affine neighbourhood
$s' \in V' \subset S'$ which maps into some open affine $V \subset S$.
By Lemma \ref{lemma-locally-P-characterize} the open $f^{-1}(V)$ is a
union of affines $U_i$ such that the ring maps
$\mathcal{O}_S(V) \to \mathcal{O}_X(U_i)$ all satisfy $P$.
By the material in Schemes, Section \ref{schemes-section-fibre-products}
we see that $f^{-1}(U)_{V'} = V' \times_V f^{-1}(V)$ is
the union of the affine opens $V' \times_V U_i$.
Since $\mathcal{O}_{X_{S'}}(V' \times_V U_i) =
\mathcal{O}_{S'}(V') \otimes_{\mathcal{O}_S(V)} \mathcal{O}_X(U_i)$
we see that the ring maps
$\mathcal{O}_{S'}(V') \to \mathcal{O}_{X_{S'}}(V' \times_V U_i)$
satisfy $P$ as $P$ is assumed stable under base change.
\end{proof}

\begin{lemma}
\label{lemma-properties-local}
The following properties of a ring map $R \to A$ are local.
\begin{enumerate}
\item (Isomorphism on local rings.)
For every prime $\mathfrak q$ of $A$ lying over $\mathfrak p \subset R$
the ring map $R \to A$ induces an isomorphism
$R_{\mathfrak p} \to A_{\mathfrak q}$.
\item (Open immersion.)
For every prime $\mathfrak q$ of $A$ there exists an $f \in R$,
$\varphi(f) \not \in \mathfrak q$ such that the ring map $\varphi : R \to A$
induces an isomorphism $R_f \to A_f$.
\item (Reduced fibres.)
For every prime $\mathfrak p$ of $R$ the fibre ring
$A \otimes_R \kappa(\mathfrak p)$ is reduced.
\item (Fibres of dimension at most $n$.)
For every prime $\mathfrak p$ of $R$ the fibre ring
$A \otimes_R \kappa(\mathfrak p)$ has Krull dimension at most $n$.
\item (Locally Noetherian on the target.)
The ring map $R \to A$ has the property that $A$ is Noetherian.
\item Add more here as needed\footnote{But only those properties
that are not already dealt with separately elsewhere.}.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-properties-base-change}
The following properties of ring maps are stable under base change.
\begin{enumerate}
\item (Isomorphism on local rings.)
For every prime $\mathfrak q$ of $A$ lying over $\mathfrak p \subset R$
the ring map $R \to A$ induces an isomorphism
$R_{\mathfrak p} \to A_{\mathfrak q}$.
\item (Open immersion.)
For every prime $\mathfrak q$ of $A$ there exists an $f \in R$,
$\varphi(f) \not \in \mathfrak q$ such that the ring map $\varphi : R \to A$
induces an isomorphism $R_f \to A_f$.
\item (Reduced fibres.)
For every prime $\mathfrak p$ of $R$ the fibre ring
$A \otimes_R \kappa(\mathfrak p)$ is reduced.
\item (Fibres of dimension at most $n$.)
For every prime $\mathfrak p$ of $R$ the fibre ring
$A \otimes_R \kappa(\mathfrak p)$ has Krull dimension at most $n$.
\item Add more here as needed\footnote{But only those properties
that are not already dealt with separately elsewhere.}.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-properties-composition}
The following properties of ring maps are stable under composition.
\begin{enumerate}
\item (Isomorphism on local rings.)
For every prime $\mathfrak q$ of $A$ lying over $\mathfrak p \subset R$
the ring map $R \to A$ induces an isomorphism
$R_{\mathfrak p} \to A_{\mathfrak q}$.
\item (Open immersion.)
For every prime $\mathfrak q$ of $A$ there exists an $f \in R$,
$\varphi(f) \not \in \mathfrak q$ such that the ring map $\varphi : R \to A$
induces an isomorphism $R_f \to A_f$.
\item (Locally Noetherian on the target.)
The ring map $R \to A$ has the property that $A$ is Noetherian.
\item Add more here as needed\footnote{But only those properties
that are not already dealt with separately elsewhere.}.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted.
\end{proof}








\section{Morphisms of finite type}
\label{section-finite-type}

\noindent
Recall that a ring map $R \to A$ is said to be of finite type
if $A$ is isomorphic to a quotient of $R[x_1, \ldots, x_n]$ as an $R$-algebra.

\begin{definition}
\label{definition-finite-type}
Let $f : X \to S$ be a morphism of schemes.
\begin{enumerate}
\item We say that $f$ is of {\it finite type at $x \in X$} if
there exists an affine open neighbourhood $\text{Spec}(A) = U \subset X$
of $x$ and and an affine open $\text{Spec}(R) = V \subset S$
with $f(U) \subset V$ such that the induced ring map
$R \to A$ is of finite type.
\item We say that $f$ is {\it locally of finite type} if it is
of finite type at every point of $X$.
\item We say that $f$ is of {\it finite type} if it is locally of
finite type and quasi-compact.
\end{enumerate}
\end{definition}

\begin{lemma}
\label{lemma-locally-finite-type-characterize}
Let $f : X \to S$ be a morphism of schemes.
The following are equivalent
\begin{enumerate}
\item The morphism $f$ is locally of finite type.
\item For every affine opens $U \subset X$, $V \subset S$
with $f(U) \subset V$ the ring map
$\mathcal{O}_S(V) \to \mathcal{O}_X(U)$ is of finite type.
\item There exists an open covering $S = \bigcup_{j \in J} V_j$
and open coverings $f^{-1}(V_j) = \bigcup_{i \in I_j} U_i$ such
that each of the morphisms $U_i \to V_j$, $j\in J, i\in I_j$
is locally of finite type.
\item There exists an affine open covering $S = \bigcup_{j \in J} V_j$
and affine open coverings $f^{-1}(V_j) = \bigcup_{i \in I_j} U_i$ such
that the ring map $\mathcal{O}_S(V_j) \to \mathcal{O}_X(U_i)$ is
of finite type, for all $j\in J, i\in I_j$.
\end{enumerate}
Moreover, if $f$ is locally of finite type then for
any open subschemes $U \subset X$, $V \subset S$ with $f(U) \subset V$
the restriction $f|_U : U \to V$ is locally of finite type.
\end{lemma}

\begin{proof}
This follows from Lemma \ref{lemma-locally-P} if we show that
the property ``$R \to A$ is of finite type'' is local.
We check conditions (a), (b) and (c) of Definition
\ref{definition-property-local}.
By Algebra, Lemma \ref{algebra-lemma-compose-finite-type}
being of finite type is stable under base change and hence
we conclude (a) holds. By the same lemma being of finite type
is stable under composition and trivially for any ring
$R$ the ring map $R \to R_f$ is of finite type.
We conclude (b) holds. Finally, property (c) is true
according to Algebra, Lemma \ref{algebra-lemma-cover-upstairs}.
\end{proof}

\begin{lemma}
\label{lemma-composition-finite-type}
The composition of two morphisms which locally of finite type is
locally of finite type. The same is true for morphisms of finite type.
\end{lemma}

\begin{proof}
In the proof of Lemma \ref{lemma-locally-finite-type-characterize}
we saw that being of finite type is a local property of ring maps.
Hence the first statement of the lemma follows from
Lemma \ref{lemma-composition-type-P} combined
with the fact that being of finite type is a property of ring maps that is
stable under composition, see
Algebra, Lemma \ref{algebra-lemma-compose-finite-type}.
By the above and the fact that compositions of
quasi-compact morphisms are quasi-compact, see
Schemes, Lemma \ref{schemes-lemma-composition-quasi-compact}
we see that the composition of morphisms of finite type is
of finite type.
\end{proof}

\begin{lemma}
\label{lemma-base-change-finite-type}
The base change of a morphism which is locally of finite type
is locally of finite type. The same is true for morphisms of
finite type.
\end{lemma}

\begin{proof}
In the proof of Lemma \ref{lemma-locally-finite-type-characterize}
we saw that being of finite type is a local property of ring maps.
Hence the first statement of the lemma follows from
Lemma \ref{lemma-composition-type-P} combined
with the fact that being of finite type is a property of ring maps that is
stable under base change, see
Algebra, Lemma \ref{algebra-lemma-compose-finite-type}.
By the above and the fact that a base change of a
quasi-compact morphism is quasi-compact, see
Schemes, Lemma \ref{schemes-lemma-quasi-compact-preserved-base-change}
we see that the base change of a morphism of finite type is
a morphism of finite type.
\end{proof}

\begin{lemma}
\label{lemma-immersion-locally-finite-type}
A closed immersion is of finite type.
An immersion is locally of finite type.
\end{lemma}

\begin{proof}
This is true because an open immersion is a local isomorphism,
and a closed immersion is obviously of finite type.
\end{proof}

\begin{lemma}
\label{lemma-finite-type-noetherian}
Let $f : X \to S$ be a morphism.
If $S$ is (locally) Noetherian and $f$ (locally) of finite type
then $X$ is (locally) Noetherian.
\end{lemma}

\begin{proof}
This follows immediately from the fact that a ring
of finite type over a Noetherian ring is Noetherian,
see Algebra, Lemma \ref{algebra-lemma-Noetherian-permanence}.
(Also: use the fact that the source of a quasi-compact morphism
with quasi-compact target is quasi-compact.)
\end{proof}

\begin{lemma}
\label{lemma-finite-type-Noetherian-quasi-separated}
Let $f : X \to S$ be locally of finite type with $S$ locally Noetherian.
Then $f$ is quasi-separated.
\end{lemma}

\begin{proof}
In fact, it is true that $X$ is quasi-separated, see
Properties, Lemma \ref{properties-lemma-locally-Noetherian-quasi-separated}
and Lemma \ref{lemma-finite-type-noetherian} above.
Then apply Schemes, Lemma \ref{schemes-lemma-compose-after-separated}
to conclude that $f$ is quasi-separated.
\end{proof}

\begin{lemma}
\label{lemma-permanence-finite-type}
Let $X \to Y$ be a morphism of schemes over a base scheme $S$.
If $X$ is locally of finite type over $S$, then $X \to Y$
is locally of finite type.
\end{lemma}

\begin{proof}
Via Lemma \ref{lemma-locally-finite-type-characterize} this translates
into the following algebra
fact: Given ring maps $A \to B \to C$ such that $A \to C$ is
of finite type, then $B \to C$ is of finite type.
(See Algebra Lemma \ref{algebra-lemma-compose-finite-type}).
\end{proof}







\section{Points of finite type and Jacobson schemes}
\label{section-points-finite-type}

\noindent
Let $S$ be a scheme. A finite type point $s$ of $S$ is a point such
that the morphism $\text{Spec}(\kappa(s)) \to S$ is of finite type.
The reason for studying this is that finite type points can replace
closed points in a certain sense and in certain situations.
There are always enough of them for example. Moreover, a scheme
is Jacobson if and only if all finite type points are closed points.

\begin{lemma}
\label{lemma-point-finite-type}
Let $S$ be a scheme. Let $k$ be a field.
Let $f : \text{Spec}(k) \to S$ be a morphism.
The following are equivalent:
\begin{enumerate}
\item The morphism $f$ is of finite type.
\item The morphism $f$ is locally of finite type.
\item There exists an affine open $U = \text{Spec}(R)$ of $S$
such that $f$ corresponds to a finite ring map $R \to k$.
\item There exists an affine open $U = \text{Spec}(R)$ of $S$
such that the image of $f$ consists of a closed point $u$ in $U$
and the field extension $\kappa(u) \subset k$ is finite.
\end{enumerate}
\end{lemma}

\begin{proof}
The equivalence of (1) and (2) is obvious as $\text{Spec}(k)$
is a singleton and hence any morphism from it is quasi-compact.

\medskip\noindent
Suppose $f$ is locally of finite type. Choose any affine open
$\text{Spec}(R) = U \subset S$ such that the image of $f$
is contained in $U$, and the ring map $R \to k$
is of finite type. Let $\mathfrak p \subset R$ be the kernel.
Then $R/\mathfrak p \subset k$ is of finite type. By
Algebra, Lemma \ref{algebra-lemma-field-finite-type-over-domain}
there exist a $\overline{f} \in R/\mathfrak p$ such that
$(R\mathfrak p)_{\overline{f}}$ is a field and
$(R\mathfrak p)_{\overline{f}} \to k$ is a finite field
extension. If $f \in R$ is a lift of $\overline{f}$, then
we see that $k$ is a finite $R_f$-module. Thus (2) $\Rightarrow$ (3).

\medskip\noindent
Suppose that $\text{Spec}(R) = U \subset S$ is an affine open
such that $f$ corresponds to a finite ring map $R \to k$.
Then $f$ is locally of finite type
by Lemma \ref{lemma-locally-finite-type-characterize}.
Thus (3) $\Rightarrow$ (2).

\medskip\noindent
Suppose $R \to k$ is finite. The image of $R \to k$ is a field
over which $k$ is finite by
Algebra, Lemma \ref{algebra-lemma-integral-under-field}.
Hence the kernel of $R \to k$ is a maximal ideal.
Thus (3) $\Rightarrow$ (4).

\medskip\noindent
The implication (4) $\Rightarrow$ (3) is immediate.
\end{proof}

\begin{lemma}
\label{lemma-artinian-finite-type}
Let $S$ be a scheme.
Let $A$ be an Artinian local ring with residue field $\kappa$.
Let $f : \text{Spec}(A) \to S$ be a morphism of schemes.
Then $f$ is of finite type if and only if the composition
$\text{Spec}(\kappa) \to \text{Spec}(A) \to S$ is of finite type.
\end{lemma}

\begin{proof}
Since the morphism $\text{Spec}(\kappa) \to \text{Spec}(A)$ is of finite
type it is clear that if $f$ is of finite type so is the composition
$\text{Spec}(\kappa) \to S$ (see Lemma \ref{lemma-composition-finite-type}).

\medskip\noindent
Assume that the composition is of finite type. According to
Lemma \ref{lemma-point-finite-type} this means that there exists
an affine open $\text{Spec}(R) = U \subset S$ such that
$\text{Spec}(\kappa) \to S$ ends up in $U$ and the induced ring map
$R \to \kappa$ is finite. Since $A$ is local Artinian we see that
$\text{Spec}(A)$ is a singleton
(Algebra, Lemma \ref{algebra-lemma-artinian-finite-length})
and hence the morphism $f$ also factors
through $U$. This gives a ring map $R \to A$. If we can show that $R \to A$
is finite then we win. We are given that $R \to A/\mathfrak m = \kappa$
is finite and that $(A, \mathfrak m, \kappa)$ is a local Artinian
ring. As $A$ has finite length over itself
(Algebra, Lemma \ref{algebra-lemma-artinian-finite-length})
we can choose a filtration
$$
0 \subset I_1 \subset \ldots \subset I_n = A
$$
by ideals such that $I_i/I_{i - 1} \cong \kappa$ as $A$-modules.
Thus $A$ has a filtration by $R$-submodules $I_i$ such that each
successive quotient is a finite $R$-module. Hence we win.
\end{proof}

\begin{definition}
\label{definition-finite-type-point}
Let $S$ be a scheme.
Let us say that a point $s$ of $S$ is a {\it finite type point}
if the canonical morphism $\text{Spec}(\kappa(s)) \to S$, see
Schemes, Section \ref{schemes-section-points}, is of finite type.
We denote $S_{\text{ft-pts}}$
the set of finite type points of $S$.
\end{definition}

\noindent
We can describe the set of finite type points as follows.

\begin{lemma}
\label{lemma-identify-finite-type-points}
Let $S$ be a scheme. We have
$$
S_{\text{ft-pts}} = \bigcup\nolimits_{U \subset S\text{ open}} U_0
$$
where $U_0$ is the set of closed points of $U$.
Here we may let $U$ range over all opens or over all affine opens of $S$.
\end{lemma}

\begin{proof}
Immediate from Lemma \ref{lemma-point-finite-type}.
\end{proof}

\begin{lemma}
\label{lemma-finite-type-points-morphism}
Let $f : T \to S$ be a morphism of schemes.
If $f$ is locally of finite type, then
$f(T_{\text{ft-pts}}) \subset S_{\text{ft-pts}}$.
\end{lemma}

\begin{proof}
If $T$ is the spectrum of a field this is Lemma \ref{lemma-point-finite-type}.
In general it follows since the composition of morphisms locally of finite
type is locally of finite type (Lemma \ref{lemma-composition-finite-type}).
\end{proof}


\begin{lemma}
\label{lemma-enough-finite-type-points}
Let $S$ be a scheme.
For any locally closed subset $T \subset S$ we have
$$
T \not = \emptyset
\Rightarrow
T \cap S_{\text{ft-pts}} \not = \emptyset.
$$
In particular, for any closed subset $T \subset S$ we
see that $T \cap S_{\text{ft-pts}}$ is dense in $T$.
\end{lemma}

\begin{proof}
Note that $T$ carries a scheme structure (see
Schemes, Lemma \ref{schemes-lemma-reduced-closed-subscheme})
such that $T \to S$ is a locally closed immersion.
Any locally closed immersion is locally of finite type,
see Lemma \ref{lemma-immersion-locally-finite-type}.
Hence by Lemma \ref{lemma-finite-type-points-morphism}
we see $T_{\text{ft-pts}} \subset S_{\text{ft-pts}}$.
Finally, any nonempty affine open of $T$ has at least one closed point
which is a finite type point of $T$ by
Lemma \ref{lemma-identify-finite-type-points}.
\end{proof}

\noindent
It follows that most of the material from
Topology, Section \ref{topology-section-space-jacobson} goes through
with the set of closed points replaced by the set of points of
finite type.
In fact, if $S$ is Jacobson then we recover the closed points as
the finite type points.

\begin{lemma}
\label{lemma-jacobson-finite-type-points}
Let $S$ be a scheme.
The following are equivalent:
\begin{enumerate}
\item For every finite type morphism $f : \text{Spec}(k) \to S$
with $k$ a field the image consists of a closed point of $S$.
In the terminology introduced above: finite type points of $S$ are
closed points of $S$.
\item For every locally finite type morphism $T \to S$ closed points map
to closed points.
\item For every locally finite type morphism $f : T \to S$ any closed point
$t \in T$ maps to a closed point $s \in S$ and $\kappa(s) \subset \kappa(t)$
is finite.
\item The scheme $S$ is Jacobson.
\end{enumerate}
\end{lemma}

\begin{proof}
We have trivially (3) $\Rightarrow$ (2) $\Rightarrow$ (1).
The discussion above shows that (1) implies (4).
Hence it suffices to show that (4) implies (3).
Suppose that $T \to S$ is locally of finite type.
Choose $t \in T$ with $s = f(t)$ as in (3).
Choose affine open neighbourhoods $\text{Spec}(R) = U \subset S$ of $s$ and
$\text{Spec}(A) = V \subset T$ of $t$ with $f(V) \subset U$.
The induced ring map $R \to A$ is of finite type
(see Lemma \ref{lemma-locally-finite-type-characterize}) and $A$ is Jacobson
by Properties, Lemma \ref{properties-lemma-locally-jacobson}.
Thus the result follows from
Algebra, Proposition \ref{algebra-proposition-Jacobson-permanence}.
\end{proof}

\begin{lemma}
\label{lemma-Jacobson-universally-Jacobson}
Let $S$ be a Jacobson scheme.
Any scheme locally of finite type over $S$ is Jacobson.
\end{lemma}

\begin{proof}
This is clear from
Algebra, Proposition \ref{algebra-proposition-Jacobson-permanence}
(and Properties, Lemma \ref{properties-lemma-locally-jacobson} and
Lemma \ref{lemma-locally-finite-type-characterize}).
\end{proof}

\begin{lemma}
\label{lemma-ubiquity-Jacobson-schemes}
The following types of schemes are Jacobson.
\begin{enumerate}
\item Any scheme locally of finite type over a field.
\item Any scheme locally of finite type over $\mathbf{Z}$.
\item Any scheme locally of finite type over a $1$-dimensional
Noetherian domain with infinitely many primes.
\item A scheme of the form $\text{Spec}(R) \setminus \{\mathfrak m\}$
where $(R, \mathfrak m)$ is a Noetherian local ring.
Also any scheme locally of finite type over it.
\end{enumerate}
\end{lemma}

\begin{proof}
We will use Lemma \ref{lemma-Jacobson-universally-Jacobson} without mention.
The spectrum of a field is clearly Jacobson.
The spectrum of $\mathbf{Z}$ is Jacobson, see
Algebra, Lemma \ref{algebra-lemma-pid-jacobson}.
For (3) see
Algebra, Lemma \ref{algebra-lemma-noetherian-dim-1-Jacobson}.
For (4) see
Properties, Lemma \ref{properties-lemma-complement-closed-point-Jacobson}.
\end{proof}







\section{Universally catenary schemes}
\label{section-universally-catenary}

\noindent
Recall that a topological space $X$ is called {\it catenary} if
for every pair of irreducible closed subsets $T \subset T'$
there exist a maximal chain of irreducible closed subsets
$$
T = T_0 \subset T_1 \subset \ldots \subset T_e = T'
$$
and every such chain has the same length. See
Topology, Definition \ref{topology-definition-catenary}.
Recall that a scheme is catenary if its underlying topological space
is catenary. See Properties, Definition \ref{properties-definition-catenary}.

\begin{definition}
\label{definition-universally-catenary}
Let $S$ be a scheme. Assume $S$ is locally Noetherian.
We say $S$ is {\it universally catenary} if for every
morphism $X \to S$ locally of finite type the scheme $X$ is catenary.
\end{definition}

\noindent
This is a ``better'' notion than catenary as there exist Noetherian schemes
which are catenary but not universally catenary. See
Examples, Section \ref{examples-section-non-catenary-Noetherian-local}.
Many schemes are universally catenary, see
Lemma \ref{lemma-ubiquity-uc} below.

\medskip\noindent
Recall that a ring $A$ is called {\it catenary} if
for any pair of prime ideals $\mathfrak p \subset \mathfrak q$
there exists a maximal chain of primes
$$
\mathfrak p =
\mathfrak p_0 \subset \ldots \subset \mathfrak p_e
= \mathfrak q
$$
and all of these have the same length. See
Algebra, Definition \ref{algebra-definition-catenary}.
We have seen the relationship between catenary schemes and
catenary rings in Properties, Section \ref{properties-section-catenary}.
Recall that a ring $A$ is called {\it universally catenary} if
$A$ is Noetherian and for every finite type ring map $A \to B$
the ring $B$ is catenary. See
Algebra, Definition \ref{algebra-definition-universally-catenary}.
Many interesting rings which come up
in algebraic geometry satisfy this property.

\begin{lemma}
\label{lemma-universally-catenary-local}
Let $S$ be a locally Noetherian scheme. The following are equivalent
\begin{enumerate}
\item $S$ is universally catenary,
\item there exists an open covering of $S$ all of whose members are
universally catenary schemes,
\item for every affine open $\text{Spec}(R) = U \subset S$ the ring
$R$ is universally catenary, and
\item there exists an affine open covering $S = \bigcup U_i$ such
that each $U_i$ is the spectrum of a universally catenary ring.
\end{enumerate}
Moreover, in this case any scheme locally of finite type over $S$
is universally catenary as well.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-immersion-locally-finite-type} an open immersion
is locally of finite type. A composition of morphisms locally of
finite type is locally of finite type
(Lemma \ref{lemma-composition-finite-type}). Thus it is clear that if $S$ is
universally catenary then any open and any scheme locally of finite
type over $S$ is universally catenary as well. This proves the final
statement of the lemma and that (1) implies (2).

\medskip\noindent
If $\text{Spec}(R)$ is a universally catenary scheme, then every
scheme $\text{Spec}(A)$ with $A$ a finite type $R$-algebra is
catenary. Hence all these rings $A$ are catenary by
Algebra, Lemma \ref{algebra-lemma-catenary}.
Thus $R$ is universally catenary. Combined with the remarks above we
conclude that (1) implies (3), and (2) implies (4). Of course
(3) implies (4) trivially.

\medskip\noindent
To finish the proof we show that (4) implies (1).
Assume (4) and let $X \to S$ be a morphism locally of finite type.
We can find an affine open covering $X = \bigcup V_j$ such that
each $V_j \to S$ maps into one of the $U_i$. By
Lemma \ref{lemma-locally-finite-type-characterize}
the induced ring map $\mathcal{O}(U_i) \to \mathcal{O}(V_j)$ is
of finite type. Hence $\mathcal{O}(V_j)$ is catenary. Hence
$X$ is catenary by Properties, Lemma \ref{properties-lemma-catenary-local}.
\end{proof}

\begin{lemma}
\label{lemma-universally-catenary-local-rings-universally-catenary}
Let $S$ be a locally Noetherian scheme.
The following are equivalent:
\begin{enumerate}
\item $S$ is universally catenary, and
\item all local rings $\mathcal{O}_{S, s}$ of $S$ are universally catenary.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume that all local rings of $S$ are universally catenary.
Let $f : X \to S$ be locally of finite type.
We know that $X$ is catenary if and only if $\mathcal{O}_{X, x}$ is
catenary for all $x \in X$. If $f(x) = s$, then $\mathcal{O}_{X, x}$
is essentially of finite type over $\mathcal{O}_{S, s}$. Hence
$\mathcal{O}_{X, x}$ is catenary by the assumption that
$\mathcal{O}_{S, s}$ is universally catenary.

\medskip\noindent
Conversly, assume that $S$ is universally catenary. Let $s \in S$.
We may replace $S$ by an affine open neighbourhood of $s$ by
Lemma \ref{lemma-universally-catenary-local}. Say $S = \text{Spec}(R)$
and $s$ corresponds to the prime ideal $\mathfrak p$. Any finite
type $R_{\mathfrak p}$-algebra $A'$ is of the form
$A_{\mathfrak p}$ for some finite type $R$-algebra $A$.
By assumption (and Lemma \ref{lemma-universally-catenary-local} if you like)
the ring $A$ is catenary, and hence $A'$ (a localization of $A$) is
catenary. Thus $R_{\mathfrak p}$ is universally catenary.
\end{proof}

\begin{lemma}
\label{lemma-ubiquity-uc}
The following types of schemes are universally catenary.
\begin{enumerate}
\item Any scheme locally of finite type over a field.
\item Any scheme locally of finite type over a Cohen-Macaulay scheme.
\item Any scheme locally of finite type over $\mathbf{Z}$.
\item Any scheme locally of finite type over a $1$-dimensional
Noetherian domain.
\item And so on.
\end{enumerate}
\end{lemma}

\begin{proof}
All of these follow from the fact that a
Cohen-Macaulay ring is universally catenary, see
Algebra, Lemma \ref{algebra-lemma-CM-ring-catenary}.
Also, use the last assertion of
Lemma \ref{lemma-universally-catenary-local}.
Some details omitted.
\end{proof}









\section{Quasi-finite morphisms}
\label{section-quasi-finite}

\noindent
A solid treatment of quasi-finite morphisms is the basis of many developments
further down the road. It will lead to various versions of Zariski's Main
Theorem, behaviour of dimensions of fibres, descend for etale morphisms, etc,
etc. Before reading this section it may be a good idea to take a look at
the algebra results in Algebra, Section \ref{algebra-section-Zariski}.

\medskip\noindent
Recall that a finite type ring map $R \to A$ is quasi-finite at
a prime $\mathfrak q$ if $\mathfrak q$ defines an isolated point
of its fibre, see Algebra, Definition \ref{algebra-definition-quasi-finite}.

\begin{definition}
\label{definition-quasi-finite}
Let $f : X \to S$ be a morphism of schemes.
\begin{enumerate}
\item We say that $f$ is {\it quasi-finite at a point $x \in X$}
if there exist an affine neighbourhood $\text{Spec}(A) = U \subset X$
of $x$ and an affine open $\text{Spec}(R) = V \subset S$ such that
$f(U) \subset V$, the ring map $R \to A$ is of finite type,
and $R \to A$ is quasi-finite at the prime of $A$ corresponding to $x$
(see above).
\item We say $f$ is {\it locally quasi-finite} if $f$ is
quasi-finite at every point $x$ of $X$.
\item We say that $f$ is {\it quasi-finite} if $f$ is of finite type
and every point $x$ is an isolated point of its fibre.
\end{enumerate}
\end{definition}

\noindent
Trivially, a locally quasi-finite morphism is locally of finite type.
We will see below that a morphism $f$ which is locally of finite type
is quasi-finite at $x$ if and only if $x$ is isolated in its fibre.
Moreover, we will see that the set of points at which a morphism
is quasi-finite is open.

\begin{lemma}
\label{lemma-algebraic-residue-field-extension-closed-point-fibre}
Let $f : X \to S$ be a morphism of schemes.
Let $x \in X$ be a point. Set $s = f(x)$.
If $\kappa(s) \supset \kappa(x)$
is an algebraic field extension, then
\begin{enumerate}
\item $x$ is a closed point of its fibre, and
\item if in addition $s$ is a closed point of $S$, then
$x$ is a closed point of $X$.
\end{enumerate}
\end{lemma}

\begin{proof}
The second statement follows from the first by elementary topology.
According to Schemes, Lemma \ref{schemes-lemma-fibre-topological}
to prove the first statement
we may replace $X$ by $X_s$ and $S$ by $\text{Spec}(\kappa(s))$.
Thus we may assume that $S = \text{Spec}(k)$ is the spectrum of a field.
In this case, let $\text{Spec}(A) = U \subset X$ be any affine open
containing $x$. The point $x$ corresponds to a prime ideal
$\mathfrak q \subset A$ such that $k \subset \kappa(\mathfrak q)$
is an algebraic field extension. By
Algebra, Lemma \ref{algebra-lemma-finite-residue-extension-closed}
we see that $\mathfrak q$ is a maximal ideal, i.e., $x \in U$ is a
closed point. Since the affine opens form
a basis of the topology of $X$ we conclude that $\{x\}$ is closed.
\end{proof}

\noindent
The following lemma is a version of the Hilbert Nullstellensatz.

\begin{lemma}
\label{lemma-closed-point-fibre-locally-finite-type}
Let $f : X \to S$ be a morphism of schemes.
Let $x \in X$ be a point. Set $s = f(x)$.
Assume $f$ is locally of finite type.
Then $x$ is a closed point of its fibre
if and only if $\kappa(s) \subset \kappa(x)$ is
a finite field extension.
\end{lemma}

\begin{proof}
If the extension is finite, then $x$ is a closed point of
the fibre by
Lemma \ref{lemma-algebraic-residue-field-extension-closed-point-fibre}
above. For the converse, assume that $x$ is a closed point
of its fibre. Choose affine opens $\text{Spec}(A) = U \subset X$
and $\text{Spec}(R) = V \subset S$ such that $f(U) \subset V$.
By Lemma \ref{lemma-locally-finite-type-characterize} the ring map
$R \to A$ is of finite type. Let $\mathfrak q \subset A$,
resp.\ $\mathfrak p \subset R$ be the prime ideal corresponding
to $x$, resp.\ $s$. Consider the fibre ring
$\overline{A} = A \otimes_R \kappa(\mathfrak p)$.
Let $\overline{\mathfrak q}$ be the prime of $\overline{A}$
corresponding to $\mathfrak q$. The assumption that $x$
is a closed point of its fibre implies that $\overline{\mathfrak q}$
is a maximal ideal of $\overline{A}$. Since $\overline{A}$
is an algebra of finite type over the field $\kappa(\mathfrak p)$
we see by the Hilbert Nullstellensatz, see
Algebra, Theorem \ref{algebra-theorem-nullstellensatz},
that $\kappa(\overline{\mathfrak q})$ is a finite extension
of $\kappa(\mathfrak p)$.
Since $\kappa(s) = \kappa(\mathfrak p)$ and
$\kappa(x) = \kappa(\mathfrak q) = \kappa(\overline{\mathfrak q})$
we win.
\end{proof}

\begin{lemma}
\label{lemma-residue-field-quasi-finite}
Let $f : X \to S$ be a morphism of schemes.
Let $x \in X$ be a point. Set $s = f(x)$.
If $f$ is quasi-finite at $x$, then the residue field
extension $\kappa(s) \subset \kappa(x)$ is finite.
\end{lemma}

\begin{proof}
This is clear from Algebra, Definition \ref{algebra-definition-quasi-finite}.
\end{proof}

\begin{lemma}
\label{lemma-quasi-finite-at-point-characterize}
Let $f : X \to S$ be a morphism of schemes.
Let $x \in X$ be a point. Set $s = f(x)$.
Let $X_s$ be the fibre of $f$ at $s$.
Assume $f$ is locally of finite type.
The following are equivalent:
\begin{enumerate}
\item The morphism $f$ is quasi-finite at $x$.
\item The point $x$ is isolated in $X_s$.
\item The point $x$ is closed in $X_s$
and there is no point $x' \in X_s$, $x' \not = x$
which specializes to $x$.
\item For any pair of affine opens
$\text{Spec}(A) = U \subset X$, $\text{Spec}(R) = V \subset S$ with
$f(U) \subset V$ and $x \in U$ corresponding to $\mathfrak q \subset A$
the ring map $R \to A$ is quasi-finite at $\mathfrak q$.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume $f$ is quasi-finite at $x$.
Note that $x$ defines a closed point of $X_s$ as follows by combining
Lemmas \ref{lemma-algebraic-residue-field-extension-closed-point-fibre} and
\ref{lemma-residue-field-quasi-finite}.
By assumption there exist opens $U \subset X$, $V \subset S$ such
that $f(U) \subset V$, $x \in U$ and $x$ an isolated point
of $U_s$. Hence $\{x\} \subset U_s$ is an open subset.
Since $U_s = U \cap X_s \subset X_s$ is also open we conclude
that $\{x\} \subset X_s$ is an open subset also. Thus we conclude
that $x$ is an isolated point of $X_s$.

\medskip\noindent
If $x$ is isolated in $X_s$, then we see immediately that
$x$ is closed in $X_s$ and that there is no point $x' \in X_s$,
distinct from $x$, specializing to $x$.

\medskip\noindent
Assume that $x$ is closed in $X_s$ and that there is no point $x' \in X_s$,
distinct from $x$, specializing to $x$. Consider a pair of affine opens
$\text{Spec}(A) = U \subset X$, $\text{Spec}(R) = V \subset S$ with
$f(U) \subset V$ and $x \in U$. Let $\mathfrak q \subset A$ correspond to
$x$ and $\mathfrak p \subset R$ correspond to $s$.
By Lemma \ref{lemma-locally-finite-type-characterize} the ring map
$R \to A$ is of finite type. Consider the fibre ring
$\overline{A} = A \otimes_R \kappa(\mathfrak p)$.
Let $\overline{\mathfrak q}$ be the prime of $\overline{A}$ corresponding
to $\mathfrak q$. Since $\text{Spec}(\overline{A})$ is an open subscheme of
the fibre $X_s$ we see that $\overline{q}$ is a maximal ideal
of $\overline{A}$ and that there is no point of $\text{Spec}(\overline{A})$
specializing to $\overline{\mathfrak q}$.
This implies that $\dim(\overline{A}_{\overline{q}}) = 0$.
Hence by
Algebra, Lemma \ref{algebra-lemma-dimension-closed-point-finite-type-field}
we have $\dim_{\overline{\mathfrak q}}(\overline{A}) = 0$.
Hence by Algebra, Lemma \ref{algebra-lemma-isolated-point}
we see that $\mathfrak q$ defines an isolated point of
$\text{Spec}(\overline{A})$. Thus $X \to S$ is quasi-finite at
$x$ by definition.

\medskip\noindent
At this point we have shown conditions (1) -- (3) are all equivalent.
It is clear that (4) implies (1). And it is also clear that
(2) implies (4) since if $x$ is an isolated point of $X_s$
then it is also an isolated point of $U_s$ for any open $U$
which contains it.
\end{proof}

\noindent
The following lemma uses Zariski's Main Theorem (the algebraic version).

\begin{lemma}
\label{lemma-quasi-finite-points-open}
Let $f : X \to S$ be a morphism of schemes.
The set of points of $X$ where $f$ is quasi-finite is an open
$U \subset X$. The induced morphism $U \to S$ is locally quasi-finite.
\end{lemma}

\begin{proof}
Suppose $f$ is quasi-finite at $x$.
Let $x \in U = \text{Spec}(R) \subset X$, $V = \text{Spec}(A) \subset S$
be affine opens as in Definition \ref{definition-quasi-finite}.
By Algebra, Lemma \ref{algebra-lemma-quasi-finite-open} the set
of primes $\mathfrak q$ at which $R \to A$ is quasi-finite
is open in $\text{Spec}(A)$. Since these all correspond to points
of $X$ where $f$ is quasi-finite we get the first statement.
The second statement is obvious.
\end{proof}

\begin{lemma}
\label{lemma-quasi-finite-locally-quasi-compact}
Let $f : X \to S$ be a morphism of schemes.
Then $f$ is quasi-finite if and only if $f$ is
locally quasi-finite and quasi-compact.
\end{lemma}

\begin{proof}
Assume $f$ is quasi-finite. It is quasi-compact by Definition
\ref{definition-finite-type}. Let $x \in X$.
We see that $f$ is quasi-finite at $x$ by
Lemma \ref{lemma-quasi-finite-at-point-characterize}.
Hence $f$ is quasi-compact and locally quasi-finite.

\medskip\noindent
Assume $f$ is quasi-compact and locally quasi-finite.
Then $f$ is of finite type. Let $x \in X$ be a point.
By Lemma \ref{lemma-quasi-finite-at-point-characterize}
we see that $x$ is an isolated point of its fibre.
The lemma is proved.
\end{proof}

\noindent
Recall that a ring map $R \to A$ is quasi-finite if it is
of finite type and quasi-finite at {\it all} primes of $A$, see
Algebra, Definition \ref{algebra-definition-quasi-finite}.

\begin{lemma}
\label{lemma-locally-quasi-finite-characterize}
Let $f : X \to S$ be a morphism of schemes.
The following are equivalent
\begin{enumerate}
\item The morphism $f$ is locally quasi-finite.
\item For every pair of affine opens $U \subset X$, $V \subset S$
with $f(U) \subset V$ the ring map
$\mathcal{O}_S(V) \to \mathcal{O}_X(U)$ is quasi-finite.
\item There exists an open covering $S = \bigcup_{j \in J} V_j$
and open coverings $f^{-1}(V_j) = \bigcup_{i \in I_j} U_i$ such
that each of the morphisms $U_i \to V_j$, $j\in J, i\in I_j$
is locally quasi-finite.
\item There exists an affine open covering $S = \bigcup_{j \in J} V_j$
and affine open coverings $f^{-1}(V_j) = \bigcup_{i \in I_j} U_i$ such
that the ring map $\mathcal{O}_S(V_j) \to \mathcal{O}_X(U_i)$ is
quasi-finite, for all $j\in J, i\in I_j$.
\end{enumerate}
Moreover, if $f$ is locally quasi-finite then for
any open subschemes $U \subset X$, $V \subset S$ with $f(U) \subset V$
the restriction $f|_U : U \to V$ is locally quasi-finite.
\end{lemma}

\begin{proof}
For a ring map $R \to A$ let us define
$P(R \to A)$ to mean ``$R \to A$ is quasi-finite''
(see remark above lemma).
We claim that $P$ is a local property of ring maps.
We check conditions (a), (b) and (c) of Definition
\ref{definition-property-local}. In the proof of
Lemma \ref{lemma-locally-finite-type-characterize}
we have seen that (a), (b) and (c) hold for the property
of being ``of finite type''. Note that, for a finite type ring map
$R \to A$, the property $R \to A$ is quasi-finite at $\mathfrak q$
depends only on the local ring $A_{\mathfrak q}$ as an
algebra over $R_{\mathfrak p}$ where $\mathfrak p = R \cap \mathfrak q$
(usual abuse of notation). Using these remarks (a), (b) and (c) of
Definition \ref{definition-property-local} follow immediately.
For example, suppose $R \to A$ is a ring map
such that all of the ring maps $R \to A_{a_i}$ are quasi-finite
for $a_1, \ldots, a_n \in A$ generating the unit ideal.
We conclude that $R \to A$ is of finite type. Also, for any
prime $\mathfrak q \subset A$ the local ring $A_{\mathfrak q}$
is isomorphic as an $R$-algebra to the local ring
$(A_{a_i})_{\mathfrak q_i}$ for some $i$ and some
$\mathfrak q_i \subset A_{a_i}$. Hence we conclude that
$R \to A$ is quasi-finite at $\mathfrak q$.

\medskip\noindent
We conclude that Lemma \ref{lemma-locally-P} applies with $P$
as in the previous paragraph.
Hence it suffices to prove that $f$ is locally quasi-finite is
equivalent to $f$ is locally of type $P$. Since $P(R \to A)$
is ``$R \to A$ is quasi-finite'' which means $R \to A$ is
quasi-finite at every prime of $A$, this follows from
Lemma \ref{lemma-quasi-finite-at-point-characterize}.
\end{proof}

\begin{lemma}
\label{lemma-composition-quasi-finite}
The composition of two morphisms which are locally quasi-finite type is
locally quasi-finite. The same is true for quasi-finite morphisms.
\end{lemma}

\begin{proof}
In the proof of Lemma \ref{lemma-locally-quasi-finite-characterize}
we saw that $P = $``quasi-finite'' is a local property of ring maps,
and that a morphism of schemes is locally quasi-finite if and only if
it is locally of type $P$ as in Definition \ref{definition-locally-P}.
Hence the first statement of the lemma follows from
Lemma \ref{lemma-composition-type-P} combined
with the fact that being quasi-finite is a property of ring maps that is
stable under composition, see
Algebra, Lemma \ref{algebra-lemma-quasi-finite-composition}.
By the above, Lemma \ref{lemma-quasi-finite-locally-quasi-compact}
and the fact that compositions of
quasi-compact morphisms are quasi-compact, see
Schemes, Lemma \ref{schemes-lemma-composition-quasi-compact}
we see that the composition of quasi-finite morphisms is
quasi-finite.
\end{proof}

\begin{lemma}
\label{lemma-base-change-quasi-finite}
Let $f : X \to S$ be a morphism of schemes.
Let $g : S' \to S$ be a morphism of schemes.
Denote $f' : X_{S'} \to S'$ the base change of $f$ by $g$
and denote $g' : X_{S'} \to X$ the projection.
Assume $X$ is locally of finite type over $S$.
\begin{enumerate}
\item Let $U \subset X$ (resp.\ $U' \subset X'$)
be the set of points where $f$ (resp.\ $f'$) is quasi-finite.
Then $U' = U_{S'} = (g')^{-1}(U)$.
\item The base change of a morphism which is locally quasi-finite
is locally quasi-finite.
\item The base change of a quasi-finite morphism is
quasi-finite.
\end{enumerate}
\end{lemma}

\begin{proof}
The first and second assertion follow from the corresponding
algebra result, see
Algebra, Lemma \ref{algebra-lemma-quasi-finite-base-change}
(combined with the fact that $f'$ is also locally of finite type by
Lemma \ref{lemma-base-change-finite-type}).
By the above, Lemma \ref{lemma-quasi-finite-locally-quasi-compact}
and the fact that a base change of a
quasi-compact morphism is quasi-compact, see
Schemes, Lemma \ref{schemes-lemma-quasi-compact-preserved-base-change}
we see that the base change of a quasi-finite morphism
is quasi-finite.
\end{proof}

\begin{lemma}
\label{lemma-immersion-locally-quasi-finite}
Any immersion is locally quasi-finite.
\end{lemma}

\begin{proof}
This is true because an open immersion is a local isomorphism
and a closed immersion is clearly quasi-finite.
\end{proof}













\section{Morphisms of finite presentation}
\label{section-finite-presentation}

\noindent
Recall that a ring map $R \to A$ is of finite presentation if
$A \cong R[x_1, \ldots, x_n]/(f_1, \ldots, f_m)$ as $R$-algebras
for some $n, m$ and some polynomials $f_j$.

\begin{definition}
\label{definition-finite-presentation}
Let $f : X \to S$ be a morphism of schemes.
\begin{enumerate}
\item We say that $f$ is of {\it finite presentation at $x \in X$} if
there exists a affine open neighbourhood $\text{Spec}(A) = U \subset X$
of $x$ and and affine open $\text{Spec}(R) = V \subset S$
with $f(U) \subset V$ such that the induced ring map
$R \to A$ is of finite presentation.
\item We say that $f$ is {\it locally of finite presentation} if it is
of finite presentation at every point of $X$.
\item We say that $f$ is of {\it finite presentation} if it is locally of
finite presentation, quasi-compact and quasi-separated.
\end{enumerate}
\end{definition}

\noindent
Later we will characterize morphisms which are
locally of finite presentation as those morphisms such that
$$
\text{colim}\ \text{Mor}_S(T_i, X) = \text{Mor}_S(\text{lim}\ T_i, X)
$$
for any directed system of affine schemes $T_i$ over $S$. See
Limits,
Proposition \ref{limits-proposition-characterize-locally-finite-presentation}.
In Limits, Section \ref{limits-section-descending-relative} we show
that, if $S = \text{lim}_i\ S_i$ is a limit of affine schemes,
any scheme $X$ of finite presentation over $S$ descends to a scheme
$X_i$ over $S_i$ for some $i$.

\begin{lemma}
\label{lemma-locally-finite-presentation-characterize}
Let $f : X \to S$ be a morphism of schemes.
The following are equivalent
\begin{enumerate}
\item The morphism $f$ is locally of finite presentation.
\item For every affine opens $U \subset X$, $V \subset S$
with $f(U) \subset V$ the ring map
$\mathcal{O}_S(V) \to \mathcal{O}_X(U)$ is of finite presentation.
\item There exists an open covering $S = \bigcup_{j \in J} V_j$
and open coverings $f^{-1}(V_j) = \bigcup_{i \in I_j} U_i$ such
that each of the morphisms $U_i \to V_j$, $j\in J, i\in I_j$
is locally of finite presentation.
\item There exists an affine open covering $S = \bigcup_{j \in J} V_j$
and affine open coverings $f^{-1}(V_j) = \bigcup_{i \in I_j} U_i$ such
that the ring map $\mathcal{O}_S(V_j) \to \mathcal{O}_X(U_i)$ is
of finite presentation, for all $j\in J, i\in I_j$.
\end{enumerate}
Moreover, if $f$ is locally of finite presentation then for
any open subschemes $U \subset X$, $V \subset S$ with $f(U) \subset V$
the restriction $f|_U : U \to V$ is locally of finite presentation.
\end{lemma}

\begin{proof}
This follows from Lemma \ref{lemma-locally-P} if we show that
the property ``$R \to A$ is of finite presentation'' is local.
We check conditions (a), (b) and (c) of Definition
\ref{definition-property-local}.
By Algebra, Lemma \ref{algebra-lemma-compose-finite-type}
being of finite presentation is stable under base change and hence
we conclude (a) holds. By the same lemma being of finite presentation
is stable under composition and trivially for any ring
$R$ the ring map $R \to R_f$ is of finite presentation.
We conclude (b) holds. Finally, property (c) is true
according to Algebra, Lemma \ref{algebra-lemma-cover-upstairs}.
\end{proof}

\begin{lemma}
\label{lemma-composition-finite-presentation}
The composition of two morphisms which locally of finite presentation is
locally of finite presentation.
The same is true for morphisms of finite presentation.
\end{lemma}

\begin{proof}
In the proof of Lemma \ref{lemma-locally-finite-presentation-characterize}
we saw that being of finite presentation is a local property of ring maps.
Hence the first statement of the lemma follows from
Lemma \ref{lemma-composition-type-P} combined
with the fact that being of finite presentation
is a property of ring maps that is
stable under composition, see
Algebra, Lemma \ref{algebra-lemma-compose-finite-type}.
By the above and the fact that compositions of
quasi-compact, quasi-separated morphisms are
quasi-compact and quasi-separated, see
Schemes, Lemmas \ref{schemes-lemma-composition-quasi-compact}
and \ref{schemes-lemma-separated-permanence}
we see that the composition of morphisms of finite presentation is
of finite presentation.
\end{proof}

\begin{lemma}
\label{lemma-base-change-finite-presentation}
The base change of a morphism which is locally of finite presentation
is locally of finite presentation. The same is true for morphisms of
finite presentation.
\end{lemma}

\begin{proof}
In the proof of Lemma \ref{lemma-locally-finite-presentation-characterize}
we saw that being of finite presentation is a local property of ring maps.
Hence the first statement of the lemma follows from
Lemma \ref{lemma-composition-type-P} combined
with the fact that being of finite presentation
is a property of ring maps that is
stable under base change, see
Algebra, Lemma \ref{algebra-lemma-compose-finite-type}.
By the above and the fact that a base change of a
quasi-compact, quasi-separated morphism is quasi-compact
and quasi-separated, see
Schemes, Lemmas \ref{schemes-lemma-quasi-compact-preserved-base-change}
and \ref{schemes-lemma-separated-permanence}
we see that the base change of a morphism of finite presentation is
a morphism of finite presentation.
\end{proof}

\begin{lemma}
\label{lemma-open-immersion-locally-finite-presentation}
Any open immersion is locally of finite presentation.
\end{lemma}

\begin{proof}
This is true because an open immersion is a local isomorphism.
\end{proof}

\begin{lemma}
\label{lemma-quasi-compact-open-immersion-finite-presentation}
Any open immersion is of finite presentation if and only if
it is quasi-compact.
\end{lemma}

\begin{proof}
We have seen (Lemma \ref{lemma-open-immersion-locally-finite-presentation})
that an open immersion is locally of finite presentation.
We have see (Schemes, Lemma \ref{schemes-lemma-immersions-monomorphisms})
that an immersion is separated and hence quasi-separated. From this
and Definition \ref{definition-finite-presentation} the lemma follows.
\end{proof}

\begin{lemma}
\label{lemma-closed-immersion-finite-presentation}
Any closed immersion $i : Z \to X$ is of finite presentation if and only if
the associated quasi-coherent sheaf of ideals
$\mathcal{I} = \text{Ker}(\mathcal{O}_X \to i_*\mathcal{O}_Z)$
is of finite type (as an $\mathcal{O}_X$-module).
\end{lemma}

\begin{proof}
On any affine open $\text{Spec}(R) \subset X$ we have
$i^{-1}(\text{Spec}(R)) = \text{Spec}(R/I)$ and
$\mathcal{I} = \widetilde{I}$. Moreover, $\mathcal{I}$
is of finite type if and only if $I$ is a finite $R$-module
for every such affine open (see
Properties, Lemma \ref{properties-lemma-finite-type-module}).
And $R/I$ is of finite presentation
over $R$ if and only if $I$ is a finite $R$-module. Hence we win.
\end{proof}

\begin{lemma}
\label{lemma-finite-presentation-finite-type}
A morphism which is locally of finite presentation is locally of finite type.
A morphism of finite presentation is of finite type.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-noetherian-finite-type-finite-presentation}
Let $f : X \to S$ be a morphism.
\begin{enumerate}
\item If $S$ is locally Noetherian and $f$ locally of finite type
then $f$ is locally of finite presentation.
\item If $S$ is locally Noetherian and $f$ of finite type
then $f$ is of finite presentation.
\end{enumerate}
\end{lemma}

\begin{proof}
The first statement follows from the fact that a ring
of finite type over a Noetherian ring is of finite presentation, see Algebra,
Lemma \ref{algebra-lemma-Noetherian-finite-type-is-finite-presentation}.
Suppose that $f$ is of finite type and $S$ is locally Noetherian.
Then $f$ is quasi-compact and locally of finite presentation by (1).
Hence it suffices to prove that $f$ is quasi-separated.
This follows from Lemma \ref{lemma-finite-type-Noetherian-quasi-separated}
(and Lemma \ref{lemma-finite-presentation-finite-type}).
\end{proof}

\begin{lemma}
\label{lemma-finite-presentation-quasi-compact-quasi-separated}
Let $S$ be a scheme which is quasi-compact and quasi-separated.
If $X$ is of finite presentation over $S$, then $X$ is quasi-compact
and quasi-separated.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-finite-presentation-permanence}
Let $f : X \to Y$ be a morphism of schemes over $S$.
If $X$ is locally of finite presentation over $S$, and
$Y$ is locally of finite type over $S$, then $f$ is locally
of finite presentation.
\end{lemma}

\begin{proof}
Via Lemma \ref{lemma-locally-finite-presentation-characterize} this translates
into the following algebra
fact: Given ring maps $A \to B \to C$ such that $A \to C$ is
of finite presentation and $A \to B$ is of finite type,
then $B \to C$ is of finite type.
(See Algebra Lemma \ref{algebra-lemma-compose-finite-type}).
\end{proof}








\section{Morphisms and dimensions of fibres}
\label{section-dimension-fibres}

\noindent
Let $X$ be a topological space, and $x \in X$.
Recall that we have defined $\dim_x(X)$ as the minimum of the
dimensions of the open neighbourhoods of $x$ in $X$.
See Topology, Definition \ref{topology-definition-Krull}.

\begin{lemma}
\label{lemma-dimension-fibre-at-a-point}
Let $f : X \to S$ be a morphism of schemes.
Let $x \in X$ and set $s = f(x)$.
Assume $f$ is locally of finite type.
Then
$$
\dim_x(X_s) =
\dim(\mathcal{O}_{X_s, x}) + \text{trdeg}_{\kappa(s)}(\kappa(x)).
$$
\end{lemma}

\begin{proof}
This immediately reduces to the case $S = s$, and $X$ affine.
In this case the result follows from
Algebra, Lemma \ref{algebra-lemma-dimension-at-a-point-finite-type-field}.
\end{proof}

\begin{lemma}
\label{lemma-dimension-fibre-after-base-change}
Let
$$
\xymatrix{
X' \ar[r]_{g'} \ar[d]_{f'} & X \ar[d]^f \\
S' \ar[r]^g & S
}
$$
be a fibre product diagram of schemes. Assume $f$ locally of finite type.
Suppose that $x' \in X'$, $x = g'(x')$, $s' = f'(x')$ and
$s = g(s') = f(x)$. Then $\dim_x(X_s) = \dim_{x'}(X'_{s'})$.
\end{lemma}

\begin{proof}
Follows immediately from
Algebra,
Lemma \ref{algebra-lemma-dimension-at-a-point-preserved-field-extension}.
\end{proof}

\noindent
The following lemma follows from a nontrivial algebraic result.
Namely, the algebraic version of Zariski's main theorem.

\begin{lemma}
\label{lemma-openness-bounded-dimension-fibres}
Let $f : X \to S$ be a morphism of schemes.
Let $n \geq 0$. Assume $f$ is locally of finite type.
The set
$$
U_n = \{x \in X \mid \dim_x X_{f(x)} \leq n\}
$$
is open in $X$.
\end{lemma}

\begin{proof}
This is immediate from
Algebra,
Lemma \ref{algebra-lemma-dimension-fibres-bounded-open-upstairs}
\end{proof}

\begin{lemma}
\label{lemma-openness-bounded-dimension-fibres-finite-presentation}
Let $f : X \to S$ be a morphism of schemes.
Let $n \geq 0$. Assume $f$ is locally of finite presentation.
The open
$$
U_n = \{x \in X \mid \dim_x X_{f(x)} \leq n\}
$$
of Lemma \ref{lemma-openness-bounded-dimension-fibres} is retrocompact
in $X$. (See Topology, Definition \ref{topology-definition-quasi-compact}.)
\end{lemma}

\begin{proof}
The topological space $X$ has a basis for its topology consisting of
affine opens $U \subset X$ such that the infuced morphism
$f|_U : U \to S$ factors through an affine open $V \subset S$. Hence
it is enough to show that $U \cap U_n$ is quasi-compact for such a $U$.
Note that $U_n \cap U$ is the same as the open
$\{x \in U \mid \dim_x U_{f(x)} \leq n\}$. This reduces us to the case
where $X$ and $S$ are affine. In this case the lemma follows from
Algebra,
Lemma \ref{algebra-lemma-dimension-fibres-bounded-quasi-compact-open-upstairs}
(and Lemma \ref{lemma-locally-finite-presentation-characterize}).
\end{proof}












\section{The dimension formula}
\label{section-dimension-formula}

\noindent
For morphisms between Noetherian schemes we can say a little more
about dimensions of local rings. Here is an important (and not so
hard to prove) result. Recall that $R(X)$ denotes the function field
of an integral scheme $X$.

\begin{lemma}
\label{lemma-dimension-formula}
Let $S$ be a scheme.
Let $f : X \to S$ be a morphism of schemes.
Let $x \in X$, and set $s = f(x)$.
Assume
\begin{enumerate}
\item $S$ is locally Noetherian,
\item $f$ is locally of finite type,
\item $X$ and $S$ integral, and
\item $f$ dominant.
\end{enumerate}
We have
\begin{equation}
\label{equation-dimension-formula}
\dim(\mathcal{O}_{X, x})
\leq
\dim(\mathcal{O}_{S, s}) + \text{trdeg}_{R(S)}R(X)
- \text{trdeg}_{\kappa(s)} \kappa(x).
\end{equation}
Moreover, equality holds if $S$ is universally catenary.
\end{lemma}

\begin{proof}
The corresponding algebra statement is
Algebra, Lemma \ref{algebra-lemma-dimension-formula}.
\end{proof}

\noindent
An application is the construction of a dimension function
on any scheme of finite type over a universally catenary
scheme endowed with a dimension function. For the definition
of dimension functions, see
Topology, Definition \ref{topology-definition-dimension-function}.

\begin{lemma}
\label{lemma-dimension-function-propagates}
Let $S$ be a universally catenary scheme.
Let $\delta : S \to \mathbf{Z}$ be a dimension function.
Let $f : X \to S$ be a morphism of schemes.
Assume $f$ locally of finite type.
Then the map
\begin{align*}
\delta = \delta_{X/S} : X & \longrightarrow \mathbf{Z} \\
x & \longmapsto \delta(f(x)) + \text{trdeg}_{\kappa(f(x))} \kappa(x)
\end{align*}
is a dimension function on $X$.
\end{lemma}

\begin{proof}
Let $f : X \to S$ be locally of finite type.
Let $x \leadsto y$, $x \not = y$ be a specialization in $X$.
We have to show that $\delta_{X/S}(x) > \delta_{X/S}(y)$ and
that $\delta_{X/S}(x) = \delta_{X/S}(y) + 1$ if $y$ is an
immediate specialization of $x$.

\medskip\noindent
Choose an affine open $V \subset S$ containing the image of
$y$ and choose an affine open $U \subset X$ mapping into $V$
and containing $y$. We may clearly replace $X$ by $U$ and
$S$ by $V$. Thus we may assume that $X = \text{Spec}(A)$
and $S = \text{Spec}(R)$ and that $f$ is given by a ring
map $R \to A$. The ring $R$ is universally catenary
(Lemma \ref{lemma-universally-catenary-local})
and the map $R \to A$ is of finite type
(Lemma \ref{lemma-locally-finite-type-characterize}).

\medskip\noindent
Let $\mathfrak q \subset A$ be the prime ideal corresponding
to the point $x$ and let $\mathfrak p \subset R$ be the prime
ideal corresponding to $f(x)$. The restriction $\delta'$ of $\delta$
to $S' = \text{Spec}(R/\mathfrak p) \subset S$ is a dimension
function. The ring $R/\mathfrak p$ is universally catenary.
The restriction of $\delta_{X/S}$ to $X' = \text{Spec}(A/\mathfrak q)$
is clearly equal to the function $\delta_{X'/S'}$ constructed
using the dimension function $\delta'$. Hence we may assume
in addition to the above that $R \subset A$ are domains, in
other words that $X$ and $S$ are integral schemes.

\medskip\noindent
Note that $\mathcal{O}_{X, x}$ is a localization of
$\mathcal{O}_{X, y}$ at a non-maximal prime
(Schemes, Lemma \ref{schemes-lemma-specialize-points}).
Hence $\dim(\mathcal{O}_{X, x}) < \dim(\mathcal{O}_{X, y})$
and $\dim(\mathcal{O}_{X, x}) = \dim(\mathcal{O}_{X, y}) - 1$
if $y$ is an immediate specialization of $x$.

\medskip\noindent
Write $s = f(x) \not = f(y) = s'$. We see, using equality
in (\ref{equation-dimension-formula}), that
\begin{align*}
\delta_{X/S}(x) - \delta_{X/S}(y) & = \delta(s) - \delta(s') \\
& + \dim(\mathcal{O}_{S, s}) - \dim(\mathcal{O}_{S, s'}) \\
& - \dim(\mathcal{O}_{X, x}) + \dim(\mathcal{O}_{X, y}).
\end{align*}
Since $\delta$ is a dimension function on $S$ we see that
$\delta(s) - \delta(s')$ is equal to
$\text{codim}(\overline{\{s'\}}, \overline{\{s\}})$ by
Topology, Lemma \ref{topology-lemma-dimension-function-catenary}.
As $S$ is integral, catenary this is equal to
$\text{codim}(\overline{\{s'\}}, S) - \text{codim}(\overline{\{s\}}, S)$
(Topology, Lemma \ref{topology-lemma-catenary-in-codimension}).
And this in turn is equal to
$\dim(\mathcal{O}_{S, s'}) - \dim(\mathcal{O}_{S, s})$ by
Lemma \ref{properties-lemma-codimension-local-ring}.
Hence we conclude that
$$
\delta_{X/S}(x) - \delta_{X/S}(y)
=
- \dim(\mathcal{O}_{X, x}) + \dim(\mathcal{O}_{X, y})
$$
and hence the lemma follows from our remarks about the dimensions
of these local rings above.
\end{proof}

\noindent
Another application of the dimension formula
is that the dimension does not change under
``alterations'' (to be defined later).

\begin{lemma}
\label{lemma-alteration-dimension}
Let $f : X \to Y$ be a morphism of schemes. Assume that
\begin{enumerate}
\item $Y$ is locally Noetherian,
\item $X$ and $Y$ are integral schemes,
\item $f$ is dominant, and
\item $f$ is locally of finite type.
\end{enumerate}
Then we have
$$
\dim(X) \leq \dim(Y) + \text{trdeg}_{R(Y)} R(X).
$$
If $f$ is universally closed\footnote{For example if $f$ is proper, see
Definition \ref{definition-proper}.} then equality holds.
\end{lemma}

\begin{proof}
Let $f : X \to Y$ be as in the lemma.
Let $\xi_0 \leadsto \xi_1 \leadsto \ldots \leadsto \xi_e$ be
a sequence of specializations in $X$. We may assume that $x = \xi_e$
is a closed point of $X$, see
Properties, Lemma \ref{properties-lemma-locally-Noetherian-closed-point}.
In particular, setting $y = f(x)$, we see $x$ is a closed point of its fibre
$X_y$. By the Hilbert Nullstellensatz we see that $\kappa(x)$ is a finite
extension of $\kappa(y)$, see
Lemma \ref{lemma-closed-point-fibre-locally-finite-type}.
By the dimension formula, Lemma \ref{lemma-dimension-formula},
we see that
$$
\dim(\mathcal{O}_{X, x}) \leq \dim(\mathcal{O}_{Y, y}) +
\text{trdeg}_{R(Y)} R(X)
$$
Hence we conclude that $e \leq \dim(Y) + \text{trdeg}_{R(Y)} R(X)$ as desired.

\medskip\noindent
Next, assume $f$ is also universally closed. Choose elements
$x_1, \ldots, x_r \in R(X)$ which form a transcendence basis for
the finitely generated field extension $R(X)$ over $R(Y)$.
By definition, there exists a nonempty affine open $U \subset X$ such
that
$$
\gamma = (x_1, \ldots, x_r) : U \longrightarrow \mathbf{A}^r_Y
$$
is a morphism over $Y$. By choice of $x_1, \ldots, x_r$ we see that
the generic point of $U$ maps to the generic point of $\mathbf{A}^r_Y$.
Let $X' \subset X \times \mathbf{A}^r = X \times_Y \mathbf{A}^r_Y$
be the scheme theoretic image of the morphism
$(\gamma, f|_U) : U \to X \times \mathbf{A}^r$, see
Section \ref{section-scheme-theoretic-image}.

\medskip\noindent
We claim that
\begin{enumerate}
\item The scheme $X'$ is locally Noetherian and integral.
\item The morphism $X' \to X$ is locally of finite type,
dominant and induces an isomorphism $R(X) = R(X')$.
\item The morphism $X' \to \mathbf{A}^r_Y$ is dominant,
locally of finite type, universally closed and induces a finite extension
of function fields $R(\mathbf{A}^r_Y) \subset R(X')$.
\end{enumerate}
We omit the detailed verifications.

\medskip\noindent
By the first part of the lemma we have
$\dim(X') \leq \dim(X)$,
$\dim(X') \leq \dim(\mathbf{A}^r_Y)$
and
$\dim(\mathbf{A}^r_Y) \leq \dim(Y) + r$.
It is clear that $\dim(\mathbf{A}^r_Y) = \dim(Y) + r$
(for example look at local rings and use
Exercises, Exercise \ref{exercises-exercise-dimension-polynomial-ring}).
Hence it suffices to show that $\dim(X') \geq \dim(\mathbf{A}^r_Y)$.

\medskip\noindent
As $X' \to \mathbf{A}^r_Y$ is dominant the image contains
the generic point of $\mathbf{A}^r_Y$.
As $X' \to \mathbf{A}^r_Y$ is universally closed the image is closed.
Hence we see that $X' \to \mathbf{A}^r_Y$ is surjective.
By Schemes, Lemma \ref{schemes-lemma-specializations-lift}
specializations lift along $X' \to \mathbf{A}^r_Y$.
Hence we see that $\dim(X') \geq \dim(\mathbf{A}^r_Y)$ by
Topology, Lemma \ref{topology-lemma-dimension-specializations-lift}.
\end{proof}












\section{Open morphisms}
\label{section-open}

\begin{definition}
\label{definition-open}
Let $f : X \to S$ be a morphism.
\begin{enumerate}
\item We say $f$ is {\it open} if the map on underlying
topological spaces is open.
\item We say $f$ is {\it universally open} if for any morphism of
schemes $S' \to S$ the base change $f' : X_{S'} \to S'$ is open.
\end{enumerate}
\end{definition}

\noindent
According to
Topology, Lemma \ref{topology-lemma-closed-open-map-specialization}
generalizations lift along an open morphism.
Here is a (partial) converse.

\begin{lemma}
\label{lemma-locally-finite-presentation-universally-open}
Let $f : X \to S$ be a morphism.
\begin{enumerate}
\item If $f$ is locally of finite presentation and generalizations lift
along $f$, then $f$ is open.
\item If $f$ is locally of finite presentation and generalizations lift
along every base change of $f$, then $f$ is universally open.
\end{enumerate}
\end{lemma}

\begin{proof}
It suffices to prove the first assertion.
This reduces to the case where both $X$ and $S$ are affine.
In this case the result follows from
Algebra, Lemma \ref{algebra-lemma-going-up-down-specialization}
and Proposition \ref{algebra-proposition-fppf-open}.
\end{proof}

\noindent
See also Lemma \ref{lemma-fppf-open} for the case of a morphism
flat of finite presentation.









\section{Flat morphisms}
\label{section-flat}

\noindent
Flatness is one of the most important technical tools in algebraic geometry.
In this section we introduce this notion. We intentionally limit the discussion
to straightforward observations, apart from Lemma \ref{lemma-fppf-open}.
A very important class of results, namely criteria for flatness will
be discussed (insert future reference here).

\medskip\noindent
Recall that a module $M$ over a ring $R$ is {\it flat} if the functor
$-\otimes_R M : \text{Mod}_R \to \text{Mod}_R$ is exact. A ring map
$R \to A$ is said to be {\it flat} if $A$ is flat as an $R$-module.

\begin{definition}
\label{definition-flat}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{F}$ be a quasi-coherent sheaf of $\mathcal{O}_X$-modules.
\begin{enumerate}
\item We say $f$ is {\it flat at a point $x \in X$} if the
local ring $\mathcal{O}_{X, x}$ is flat over the local ring
$\mathcal{O}_{S, f(x)}$.
\item We say that $\mathcal{F}$ is {\it flat over $S$ at a point $x \in X$}
if the stalk $\mathcal{F}_x$ is a flat $\mathcal{O}_{S, f(x)}$-module.
\item We say $f$ is {\it flat} if $f$ is flat at every point of $X$.
\item We say that $\mathcal{F}$ is {\it flat over $S$} if
$\mathcal{F}$ is flat over $S$ at every point $x$ of $X$.
\end{enumerate}
\end{definition}

\noindent
Thus we see that $f$ is flat if and only if
the structure sheaf $\mathcal{O}_X$ is flat over $S$.

\begin{lemma}
\label{lemma-flat-module-characterize}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{F}$ be a quasi-coherent sheaf of $\mathcal{O}_X$-modules.
The following are equivalent
\begin{enumerate}
\item The sheaf $\mathcal{F}$ is flat over $S$.
\item For every affine opens $U \subset X$, $V \subset S$
with $f(U) \subset V$ the $\mathcal{O}_S(V)$-module $\mathcal{F}(U)$ is flat.
\item There exists an open covering $S = \bigcup_{j \in J} V_j$
and open coverings $f^{-1}(V_j) = \bigcup_{i \in I_j} U_i$ such
that each of the modules $\mathcal{F}|_{U_i}$ is
flat over $V_j$, for all $j\in J, i\in I_j$.
\item There exists an affine open covering $S = \bigcup_{j \in J} V_j$
and affine open coverings $f^{-1}(V_j) = \bigcup_{i \in I_j} U_i$ such
that $\mathcal{F}(U_i)$ is a flat $\mathcal{O}_S(V_j)$-module, for all
$j\in J, i\in I_j$.
\end{enumerate}
Moreover, if $\mathcal{F}$ is flat over $S$ then for
any open subschemes $U \subset X$, $V \subset S$ with $f(U) \subset V$
the restriction $\mathcal{F}|_U$ is flat over $V$.
\end{lemma}

\begin{proof}
Let $R \to A$ be a ring map. Let $M$ be an $A$-module.
If $M$ is $R$-flat, then for all primes
$\mathfrak q$ the module $M_{\mathfrak q}$ is flat over $R_{\mathfrak p}$
with $\mathfrak p$ the prime of $R$ lying under $\mathfrak q$. Conversely, if
$M_{\mathfrak q}$ is flat over $R_{\mathfrak p}$ for all primes $\mathfrak q$
of $A$, then $M$ is flat over $R$. See
Algebra, Lemma \ref{algebra-lemma-flat-localization}.
This equivalence easily implies the statements of the lemma.
\end{proof}

\begin{lemma}
\label{lemma-flat-characterize}
Let $f : X \to S$ be a morphism of schemes.
The following are equivalent
\begin{enumerate}
\item The morphism $f$ is flat.
\item For every affine opens $U \subset X$, $V \subset S$
with $f(U) \subset V$ the ring map
$\mathcal{O}_S(V) \to \mathcal{O}_X(U)$ is flat.
\item There exists an open covering $S = \bigcup_{j \in J} V_j$
and open coverings $f^{-1}(V_j) = \bigcup_{i \in I_j} U_i$ such
that each of the morphisms $U_i \to V_j$, $j\in J, i\in I_j$
is flat.
\item There exists an affine open covering $S = \bigcup_{j \in J} V_j$
and affine open coverings $f^{-1}(V_j) = \bigcup_{i \in I_j} U_i$ such
that $\mathcal{O}_S(V_j) \to \mathcal{O}_X(U_i)$ is flat, for all
$j\in J, i\in I_j$.
\end{enumerate}
Moreover, if $f$ is flat then for
any open subschemes $U \subset X$, $V \subset S$ with $f(U) \subset V$
the restriction $f|_U : U \to V$ is flat.
\end{lemma}

\begin{proof}
This is a special case of Lemma \ref{lemma-flat-module-characterize}
above.
\end{proof}

\begin{lemma}
\label{lemma-composition-module-flat}
Let $X \to Y \to Z$ be morphisms of schemes.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
If $\mathcal{F}$ is flat over $Y$, and $Y$ is flat over $Z$, then
$\mathcal{F}$ is flat over $Z$.
\end{lemma}

\begin{proof}
See Algebra, Lemma \ref{algebra-lemma-composition-flat}.
\end{proof}

\begin{lemma}
\label{lemma-composition-flat}
The composition of flat morphisms is flat.
\end{lemma}

\begin{proof}
This is a special case of Lemma \ref{lemma-composition-module-flat}.
\end{proof}

\begin{lemma}
\label{lemma-base-change-module-flat}
Let $f : X \to S$ be a morphism of schemes. Let $\mathcal{F}$ be a
quasi-coherent sheaf of $\mathcal{O}_X$-modules.
Let $g : S' \to S$ be a morphism of schemes. Denote
$g' : X_{S'} \to X$ the projection. If $\mathcal{F}$ is flat
over $S$, then $(g')^*\mathcal{F}$ is flat over $S'$.
\end{lemma}

\begin{proof}
See Algebra, Lemma \ref{algebra-lemma-flat-base-change}.
\end{proof}

\begin{lemma}
\label{lemma-base-change-flat}
The base change of a flat morphism is flat.
\end{lemma}

\begin{proof}
This is a special case of Lemma \ref{lemma-base-change-module-flat}.
\end{proof}

\begin{lemma}
\label{lemma-fppf-open}
A flat morphism locally of finite presentation is universally open.
\end{lemma}

\begin{proof}
This follows because generalizations lift along a flat morphism
(see Algebra, Section \ref{algebra-section-going-up}), and
Lemma \ref{lemma-locally-finite-presentation-universally-open} above.
We can also argue directly as follows.

\medskip\noindent
Let $f : X \to S$ be flat locally of finite presentation.
To show $f$ is open it suffices to show that we may cover
$X$ by open affines $X = \bigcup U_i$ such that $U_i \to S$
is open. By definition we may cover $X$ by
affine opens $U_i \subset X$ such that each $U_i$ maps
into an affine open $V_i \subset S$ and such that
the induced ring map $\mathcal{O}_S(V_i) \to \mathcal{O}_X(U_i)$ is
of finite presentation. Thus $U_i \to V_i$ is open by
Algebra, Proposition \ref{algebra-proposition-fppf-open}.
The lemma follows.
\end{proof}

\begin{lemma}
\label{lemma-fpqc-quotient-topology}
Let $f : X \to Y$ be a quasi-compact, surjective, flat morphism.
A subset $T \subset Y$ is open (resp.\ closed) if and only
$f^{-1}(T)$ is open (resp.\ closed).
\end{lemma}

\begin{proof}
The question is local on $Y$, hence we may assume that $Y$ is affine.
In this case $X$ is quasi-compact as $f$ is quasi-compact.
Write $X = X_1 \cup \ldots \cup X_n$ as a finite union of affine opens.
Then $f' : X' = X_1 \coprod \ldots \coprod X_n \to Y$ is a surjective
flat morphism of affine schemes. Note that for $T \subset Y$ we have
$(f')^{-1}(T) = f^{-1}(T) \cap X_1 \coprod \ldots \coprod f^{-1}(T) \cap X_n$.
Hence, $f^{-1}(T)$ is open if and only if $(f')^{-1}(T)$ is open.
Thus we may assume both $X$ and $Y$ are affine.

\medskip\noindent
Suppose that $f^{-1}(T)$ is closed, say $f^{-1}(T) = V(I)$ for $I \subset A$
an ideal. Then $T = f(f^{-1}(T)) = f(V(I))$ is the image of
$\text{Spec}(A/I) \to \text{Spec}(B)$ (here we use that $f$
is surjective). On the other hand,
we have going down for $A \to B$, see
Algebra, Lemma \ref{algebra-lemma-flat-going-down}.
In other words, generalizations lift along $f$.
Hence by Topology, Lemma \ref{topology-lemma-lift-specializations-images}
we see that $Y \setminus T = f(X \setminus f^{-1}(T))$ is stable under
generalization. Hence $T$ is stable under specialization
(Topology, Lemma \ref{topology-lemma-open-closed-specialization}).
Thus $T$ is closed by
Algebra, Lemma \ref{algebra-lemma-image-stable-specialization-closed}.
\end{proof}

\begin{lemma}
\label{lemma-flat-permanence}
Let $h : X \to Y$ be a morphism of schemes over $S$.
If $h$ is surjective and flat, and $X$ is flat over $S$, then
$Y$ is flat over $S$.
\end{lemma}

\begin{proof}
Let $y \in Y$ be a point with image $s \in S$.
Choose a point $x \in X$ mapping to $y$ under $h$.
Consider the local ring maps
$\mathcal{O}_{S, s} \to \mathcal{O}_{Y, y} \to \mathcal{O}_{X, x}$.
Let $N \to M$ be an injection of $\mathcal{O}_{S, s}$-modules.
If $N \otimes \mathcal{O}_{Y, y} \to M \otimes \mathcal{O}_{Y, y}$
has a nonzero kernel then so does
$N \otimes \mathcal{O}_{X, x} \to M \otimes \mathcal{O}_{X, x}$
as $\mathcal{O}_{Y, y} \to \mathcal{O}_{X, x}$ is faithfully flat
(see Algebra, Lemma \ref{algebra-lemma-local-flat-ff}). But this is
impossible as $\mathcal{O}_{S, s} \to \mathcal{O}_{X, x}$ is flat.
Thus $N \otimes \mathcal{O}_{Y, y} \to M \otimes \mathcal{O}_{Y, y}$
is injective and we win.
\end{proof}















\section{Syntomic morphisms}
\label{section-syntomic}

\noindent
Recall that a ring map $R \to A$ is syntomic if it is of finite presentation,
flat with local complete intersection rings as fibres.

\begin{definition}
\label{definition-syntomic}
Let $f : X \to S$ be a morphism of schemes.
\begin{enumerate}
\item We say that $f$ is {\it syntomic at $x \in X$} if
there exists a affine open neighbourhood $\text{Spec}(A) = U \subset X$
of $x$ and and affine open $\text{Spec}(R) = V \subset S$
with $f(U) \subset V$ such that the induced ring map
$R \to A$ is syntomic, see
Algebra, Definition \ref{algebra-definition-lci}.
\item We say that $f$ is {\it syntomic} if it is syntomic
at every point of $X$.
\item If $S = \text{Spec}(k)$ and $f$ is syntomic, then we say that
$X$ is a {\it local complete intersection over $k$}.
\item A morphism of affine schemes $f : X \to S$
is called {\it standard syntomic} if there exists a
global relative complete intersection
$R \to R[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$ (see
Algebra,
Definition \ref{algebra-definition-relative-global-complete-intersection})
such that $X \to S$ is isomorphic to
$$
\text{Spec}(R[x_1, \ldots, x_n]/(f_1, \ldots, f_c)) \to \text{Spec}(R).
$$
\end{enumerate}
\end{definition}

\noindent
In the literature a syntomic morphism is sometimes referred to as a
{\it flat local complete intersection morphism}.
It turns out this is a convenient class of morphisms. For example one
can define a syntomic topology using these, which is finer than the
smooth and etale topologies, but has many of the same formal properties.

\medskip\noindent
Note that there is no separation or quasi-compactness hypotheses in the
definition. Hence the question of being syntomic is local in nature on
the source. Here is the precise result.

\begin{lemma}
\label{lemma-syntomic-characterize}
Let $f : X \to S$ be a morphism of schemes.
The following are equivalent
\begin{enumerate}
\item The morphism $f$ is syntomic.
\item For every affine opens $U \subset X$, $V \subset S$
with $f(U) \subset V$ the ring map
$\mathcal{O}_S(V) \to \mathcal{O}_X(U)$ is syntomic.
\item There exists an open covering $S = \bigcup_{j \in J} V_j$
and open coverings $f^{-1}(V_j) = \bigcup_{i \in I_j} U_i$ such
that each of the morphisms $U_i \to V_j$, $j\in J, i\in I_j$
is syntomic.
\item There exists an affine open covering $S = \bigcup_{j \in J} V_j$
and affine open coverings $f^{-1}(V_j) = \bigcup_{i \in I_j} U_i$ such
that the ring map $\mathcal{O}_S(V_j) \to \mathcal{O}_X(U_i)$ is
syntomic, for all $j\in J, i\in I_j$.
\end{enumerate}
Moreover, if $f$ is syntomic then for
any open subschemes $U \subset X$, $V \subset S$ with $f(U) \subset V$
the restriction $f|_U : U \to V$ is syntomic.
\end{lemma}

\begin{proof}
This follows from Lemma \ref{lemma-locally-P} if we show that
the property ``$R \to A$ is syntomic'' is local.
We check conditions (a), (b) and (c) of Definition
\ref{definition-property-local}.
By Algebra, Lemma \ref{algebra-lemma-base-change-syntomic}
being syntomic is stable under base change and hence
we conclude (a) holds. By
Algebra, Lemma \ref{algebra-lemma-composition-syntomic}
being syntomic is stable under composition and trivially for any ring
$R$ the ring map $R \to R_f$ is syntomic.
We conclude (b) holds. Finally, property (c) is true
according to Algebra, Lemma \ref{algebra-lemma-local-syntomic}.
\end{proof}

\noindent
The following lemma says locally any syntomic morphism is standard syntomic.
Hence we can use standard syntomic morphisms as a {\it local model}
for a syntomic morphism. Moreover, it says that a flat morphism of finite
presentation is syntomic if and only if the fibres are local complete
intersection schemes.

\begin{lemma}
\label{lemma-syntomic-locally-standard-syntomic}
Let $f : X  \to S$ be a morphism of schemes.
Assume $f$ locally of finite presentation.
Let $x \in X$ be a point.
Set $s = f(x)$.
The following are equivalent
\begin{enumerate}
\item The morphism $f$ is syntomic at $x$.
\item There exist affine opens $U \subset X$,
and $V \subset S$ such that $x \in U$, $f(U) \subset V$ and the
induced morphism $f|_U : U \to V$ is standard syntomic.
\item The local ring map $\mathcal{O}_{S, s} \to \mathcal{O}_{X, x}$
is flat and $\mathcal{O}_{X, x}/\mathfrak m_s \mathcal{O}_{X, x}$
is a complete intersection over $\kappa(s)$ (see
Algebra, Definition \ref{algebra-definition-lci-local-ring}).
\end{enumerate}
\end{lemma}

\begin{proof}
Follows from the definitions and
Algebra, Lemma \ref{algebra-lemma-syntomic}.
\end{proof}

\begin{lemma}
\label{lemma-syntomic-flat-fibres}
Let $f : X \to S$ be a morphism of schemes.
If $f$ is flat, locally of finite presentation, and all
fibres $X_s$ are local complete intersections, then $f$
is syntomic.
\end{lemma}

\begin{proof}
Clear from Lemma \ref{lemma-syntomic-locally-standard-syntomic},
the isomorphisms of local rings
$$
\mathcal{O}_{X, x}/\mathfrak m_s \mathcal{O}_{X, x}
\cong
\mathcal{O}_{X_s, x}
$$
and Algebra, Lemma \ref{algebra-lemma-lci-local} for example.
\end{proof}

\begin{lemma}
\label{lemma-local-complete-intersection}
Let $k$ be a field.
Let $X$ be a scheme locally of finite type over $k$.
The following are equivalent:
\begin{enumerate}
\item $X$ is a local complete intersection over $k$,
\item for every $x \in X$ there exists an affine open
$U = \text{Spec}(R) \subset X$ neighbourhood of $x$
such that $R \cong k[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$
is a global complete intersection over $k$ (see
Algebra, Definition \ref{algebra-definition-lci-field}), and
\item for every $x \in X$ the local ring $\mathcal{O}_{X, x}$
is a complete intersection over $k$ (see
Algebra, Definition \ref{algebra-definition-lci-local-ring}).
\end{enumerate}
\end{lemma}

\begin{proof}
Note that $X \to \text{Spec}(k)$ is automatically flat and
of finite presentation. Hence we can deduce this from the previous
Lemma \ref{lemma-syntomic-locally-standard-syntomic}.
However, this is backwards, since these results come first
in the chapter on commutative algebra. See
Algebra, Section \ref{algebra-section-lci}.
\end{proof}

\begin{lemma}
\label{lemma-composition-syntomic}
The composition of two morphisms which are syntomic is syntomic.
\end{lemma}

\begin{proof}
In the proof of Lemma \ref{lemma-syntomic-characterize}
we saw that being syntomic is a local property of ring maps.
Hence the first statement of the lemma follows from
Lemma \ref{lemma-composition-type-P} combined
with the fact that being syntomic is a property of ring maps that is
stable under composition, see
Algebra, Lemma \ref{algebra-lemma-composition-syntomic}.
\end{proof}

\begin{lemma}
\label{lemma-base-change-syntomic}
The base change of a morphism which is syntomic is syntomic.
\end{lemma}

\begin{proof}
In the proof of Lemma \ref{lemma-syntomic-characterize}
we saw that being syntomic is a local property of ring maps.
Hence the lemma follows from
Lemma \ref{lemma-composition-type-P} combined
with the fact that being syntomic is a property of ring maps that is
stable under base change, see
Algebra, Lemma \ref{algebra-lemma-base-change-syntomic}.
\end{proof}

\begin{lemma}
\label{lemma-open-immersion-syntomic}
Any open immersion is syntomic.
\end{lemma}

\begin{proof}
This is true because an open immersion is a local isomorphism.
\end{proof}

\begin{lemma}
\label{lemma-syntomic-locally-finite-presentation}
A syntomic morphism is locally of finite presentation.
\end{lemma}

\begin{proof}
True because a syntomic ring map is of finite presentation by
definition.
\end{proof}

\begin{lemma}
\label{lemma-syntomic-flat}
A syntomic morphism is flat.
\end{lemma}

\begin{proof}
True because a syntomic ring map is flat by definition.
\end{proof}

\begin{lemma}
\label{lemma-syntomic-permanence}
Let
$$
\xymatrix{
X \ar[rr]_f \ar[rd]_p & &
Y \ar[dl]^q \\
& S
}
$$
be a commutative diagram of morphisms of schemes. Assume that
\begin{enumerate}
\item $f$ is surjective, and syntomic,
\item $p$ is syntomic, and
\item $q$ is locally of finite presentation\footnote{In fact this
is implied by (1) and (2), see
Descent, Lemma \ref{fpqc-descent-lemma-flat-finitely-presented-permanence}.}.
\end{enumerate}
Then $q$ is syntomic.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-flat-permanence} we see that $q$ is flat.
Hence it suffices to show that the fibres of $Y \to S$ are
local complete intersections, see Lemma \ref{lemma-syntomic-flat-fibres}.
Let $s \in S$. Consider the morphism $X_s \to Y_s$.
This is a base change of the morphism $X \to Y$ and hence
surjective, and syntomic (Lemma \ref{lemma-base-change-syntomic}).
For the same reason $X_s$ is syntomic over $\kappa(s)$.
Moreover, $Y_s$ is locally of finite type over $\kappa(s)$
(Lemma \ref{lemma-base-change-finite-type}). In this way
we reduce to the case where $S$ is the spectrum of a field.

\medskip\noindent
Assume $S = \text{Spec}(k)$. Let $y \in Y$. Choose an affine
open $\text{Spec}(A) \subset Y$ neighbourhood of $y$. Let
$\text{Spec}(B) \subset X$ be an affine open such that
$f(\text{Spec}(B)) \subset \text{Spec}(A)$, containing
a point $x \in X$ such that $f(x) = y$. Choose a surjection
$k[x_1, \ldots, x_n] \to A$ with kernel $I$.
Choose a surjection $A[y_1, \ldots, y_m] \to B$, which gives
rise in turn to a surjection $k[x_i, y_j] \to B$ with kernel $J$.
Let $\mathfrak q \subset k[x_i, y_j]$ be the prime corresponding
to $y \in \text{Spec}(B)$ and let $\mathfrak p \subset k[x_i]$ the prime
corresponding to $x \in \text{Spec}(A)$.
Since $x$ maps to $y$ we have $\mathfrak p = \mathfrak q \cap k[x_i]$.
Consider the following commutative diagram of local rings:
$$
\xymatrix{
\mathcal{O}_{X, x} \ar@{=}[r] &
B_{\mathfrak q} &
k[x_1, \ldots, x_n, y_1, \ldots, y_m]_{\mathfrak q} \ar[l] \\
\mathcal{O}_{Y, y} \ar@{=}[r] \ar[u] & A_{\mathfrak p} \ar[u] &
k[x_1, \ldots, x_n]_{\mathfrak p} \ar[l] \ar[u]
}
$$
We claim that the hypotheses of
Algebra, Lemma \ref{algebra-lemma-lci-permanence-initial} are satisfied.
Condition (1) and (2) are trivial. Condition (4) follows as
$X \to Y$ is flat. Condition (3) follows as the rings
$\mathcal{O}_{Y, y}$ and
$\mathcal{O}_{X_y, x} = \mathcal{O}_{X, x}/\mathfrak m_y\mathcal{O}_{X, x}$
are complete intersection rings by our assumptions that
$f$ and $p$ are syntomic, see
Lemma \ref{lemma-syntomic-locally-standard-syntomic}.
The output of Algebra, Lemma \ref{algebra-lemma-lci-permanence-initial}
is exactly that $\mathcal{O}_{Y, y}$ is a complete intersection
ring! Hence by Lemma \ref{lemma-syntomic-locally-standard-syntomic}
again we see that $Y$ is syntomic over $k$ at $y$ as desired.
\end{proof}









\section{Sheaf of differentials of a morphism}
\label{section-sheaf-differentials}

\noindent
We suggest the reader take a look at the corresponding section
in the chapter on commutative algebra
(Algebra, Section \ref{algebra-section-differentials}).

\begin{definition}
\label{definition-derivation}
Let $f : X \to S$ be a morphism of schemes. Let $\mathcal{F}$
be an $\mathcal{O}_X$-module. A {\it derivation} or more precisely
an {\it $S$-derivation} into $\mathcal{F}$ is a map
$D : \mathcal{O}_X \to \mathcal{F}$ which is additive, annihilates
the image of $f^{-1}\mathcal{O}_S \to \mathcal{O}_X$, and satisfies the
{\it Leibniz rule}
$$
D(ab) = aD(b) + D(a)b
$$
for all $a, b$ local sections of $\mathcal{O}_X$
(wherever they are both defined). We denote
$$
\text{Der}_S(\mathcal{O}_X, \mathcal{F})
$$
the set of $S$-derivations into $\mathcal{F}$.
\end{definition}

\noindent
This is the sheaf theoretic analogue of
Algebra, Definition \ref{definition-derivation}.
Given a derivation $D : \mathcal{O}_X \to \mathcal{F}$
as in the definition the map on global sections
$$
D : \Gamma(X, \mathcal{O}_X) \longrightarrow \Gamma(X, \mathcal{F})
$$
clearly is a $\Gamma(S, \mathcal{O}_S)$-derivation as in
the algebra definition.

\begin{lemma}
\label{lemma-affine-case-derivation}
Let $R \to A$ be a ring map. Let $\mathcal{F}$
be a sheaf of $\mathcal{O}_X$-modules
on $X = \text{Spec}(A)$. Set $S = \text{Spec}(R)$.
The rule which associates to an $S$-derivation on $\mathcal{F}$
its action on global sections defines a bijection between
the set of $S$-derivations of $\mathcal{F}$ and the set of
$R$-derivations on $M = \Gamma(X, \mathcal{F})$.
\end{lemma}

\begin{proof}
Let $D : A \to M$ be an $R$-derivation. We have to show there exists
a unique $S$-derivation on $\mathcal{F}$ which gives rise to
$D$ on global sections. Let $U = D(f) \subset X$ be a standard affine open.
Any element of $\Gamma(U, \mathcal{O}_X)$ is of the form
$a/f^n$ for some $a \in A$ and $n \geq 0$. By the Leibniz rule
we have
$$
D(a)|_U = a/f^n D(f^n)|_U + f^n D(a/f^n)
$$
in $\Gamma(U, \mathcal{F})$. Since $f$ acts invertibly
on $\Gamma(U, \mathcal{F})$ this completely determines
the value of $D(a/f^n) \in \Gamma(U, \mathcal{F})$.
This proves uniqueness. Existence follows by simply defining
$$
D(a/f^n) := (1/f^n) D(a)|_U - a/f^{2n} D(f^n)|_U
$$
and proving this has all the desired properties (on the basis
of standard opens of $X$). Details omitted.
\end{proof}

\noindent
Here is a particular situation where derivations come up
naturally.

\begin{lemma}
\label{lemma-double-structure-gives-derivation}
Let $f : X \to S$ be a morphism of schemes.
Consider a short exact sequence
$$
0 \to \mathcal{F} \to \mathcal{A} \to \mathcal{O}_X \to 0
$$
Here $\mathcal{A}$ is a sheaf of $f^{-1}\mathcal{O}_S$-algebras,
$\pi : \mathcal{A} \to \mathcal{O}_X$ is a surjection
of sheaves of $f^{-1}\mathcal{O}_S$-algebras, and
$\mathcal{F} = \text{Ker}(\pi)$ is its kernel. Assume $\mathcal{F}$ an ideal
sheaf with square zero in $\mathcal{A}$. So $\mathcal{F}$
has a natural structure of an $\mathcal{O}_X$-module.
A section $s : \mathcal{O}_X \to \mathcal{F}$ of $\pi$
is a $f^{-1}\mathcal{O}_S$-algebra map such that $\pi \circ s = \text{id}$.
Given any section $s : \mathcal{O}_X \to \mathcal{F}$
of $\pi$ and any $S$-derivation $D : \mathcal{O}_X \to \mathcal{F}$
the map
$$
s + D : \mathcal{O}_X \to \mathcal{A}
$$
is a section of $\pi$ and every section $s'$ is of the form $s + D$
for a unique $S$-derivation $D$.
\end{lemma}

\begin{proof}
Recall that the $\mathcal{O}_X$-module structure on $\mathcal{F}$
is given by $h \tau = \tilde h \tau$ (multiplication in $\mathcal{A}$)
where $h$ is a local section of $\mathcal{O}_X$, and
$\tilde h$ is a local lift of $h$ to a local
section of $\mathcal{A}$, and $\tau$ is a local section of $\mathcal{F}$.
In particular, given $s$, we may use $\tilde h = s(h)$.
To verify that $s + D$ is a homomorphism of sheaves of rings we
compute
\begin{eqnarray*}
(s + D)(ab) & = & s(ab) + D(ab) \\
& = & s(a)s(b) + aD(b) + D(a)b \\
& = & s(a) s(b) + s(a)D(b) + D(a)s(b) \\
& = & (s(a) + D(a))(s(b) + D(b))
\end{eqnarray*}
by the Leibniz rule. In the same manner one shows
$s$ is a $f^{-1}\mathcal{O}_S$-algebra
map because $D$ is an $S$-derivation. Conversely, given $s'$ we set
$D = s' - s$. Details omitted.
\end{proof}

\noindent
Let $f : X \to S$ be a morphism of schemes.
We now esthablish the existence of a couple of ``global'' sheaves
and maps of sheaves, and in the next paragraph we describe
the constructions over some affine opens.

\medskip\noindent
Recall that $\Delta = \Delta_{X/S} : X \to X \times_S X$
is an immersion, see Schemes, Lemma \ref{schemes-lemma-diagonal-immersion}.
Let $\mathcal{J}$ be the ideal sheaf of the immersion.
It lives over any open subscheme $U$ of $X \times_S X$
such that $\Delta(X) \subset U$ is closed. For example the one from
the proof of the lemma just cited;
if $f$ is separated then we can take $U = X \times_S X$.
Note that the sheaf of rings $\mathcal{O}_U/\mathcal{J}^2$
is supported on $\Delta(X)$. Moreover it sits in a
short exact sequence of sheaves
$$
0 \to \mathcal{J}/\mathcal{J}^2
\to \mathcal{O}_U/\mathcal{J}^2
\to \Delta_*\mathcal{O}_X
\to 0.
$$
Using $\Delta^{-1}$ we can think of this as a surjection of
sheaves of $f^{-1}\mathcal{O}_S$-algebras with kernel the
conormal sheaf of $\Delta$ (see Definition \ref{definition-conormal-sheaf}
and Lemma \ref{lemma-affine-conormal}).
$$
0 \to \mathcal{C}_{X/X\times_SX}
\to \Delta^{-1}(\mathcal{O}_U/\mathcal{J}^2)
\to \mathcal{O}_X
\to 0
$$
This places us in the sitation of
Lemma \ref{lemma-double-structure-gives-derivation}.
The projection morphisms $p_i : X \times_S X \to X$, $i = 1, 2$ induce
maps of sheaves of rings
$p_i^\sharp : p_i^{-1}\mathcal{O}_X \to \mathcal{O}_{X\times_S X}$.
We may restrict to $U$ and divide by $\mathcal{J}^2$ to get
$p_i^{-1}\mathcal{O}_X \to \mathcal{O}_U/\mathcal{J}^2$.
Since $\Delta^{-1}p_i^{-1}\mathcal{O}_X = \mathcal{O}_X$
we get maps
$$
s_i : \mathcal{O}_X \to \Delta^{-1}(\mathcal{O}_U/\mathcal{J}^2).
$$
Both $s_1$ and $s_2$ are sections to the map
$\Delta^{-1}(\mathcal{O}_U/\mathcal{J}^2) \to \mathcal{O}_X$,
as in Lemma \ref{lemma-double-structure-gives-derivation}.
Thus we get an $S$-derivation
$\text{d} = s_2 - s_1 : \mathcal{O}_X \to \mathcal{C}_{X/X\times_SX}$.

\medskip\noindent
Let us work this out on a suitable affine open.
We can cover $X$ by affine opens $\text{Spec}(A) = W \subset X$
whose image is contained in an affine open $\text{Spec}(R) = V \subset S$.
According to the proof of Schemes, Lemma \ref{schemes-lemma-diagonal-immersion}
$W \times_V W \subset X \times_S X$ is an affine open
contained in the open $U$ mentioned above. Also
$W \times_V W = \text{Spec}(A \otimes_R A)$.
The sheaf $\mathcal{J}$ corresponds to the ideal
$J = \text{Ker}(A \otimes_R A \to A)$.
The short exact sequence to the short exact sequence
of $A \otimes_R A$-modules
$$
0 \to J/J^2 \to (A \otimes_R A)/J^2 \to A \to 0
$$
The sections $s_i$ correspond to the ring maps
$$
A \longrightarrow (A \otimes_R A)/J^2, \ \ 
s_1 : a \mapsto a \otimes 1, \ \ 
s_2 : a \mapsto 1 \otimes a.
$$
By Lemma \ref{lemma-affine-conormal} the conormal sheaf
of $\Delta_{X/S}$ restricted
to $U \times_V U$ is the quasi-coherent sheaf associated to the
$A$-module $J/J^2$. Comparing with
Algebra, Lemma \ref{algebra-lemma-differentials-diagonal}
(or by a direct computation)
we see that the induced map $\text{d} : A \to J/J^2$
is isomorphic to the universal $R$-derivation on $A$.
Thus the following definition makes sense.

\begin{definition}
\label{definition-sheaf-differentials}
Let $f : X \to S$ be a morphism of schemes.
\begin{enumerate}
\item The {\it sheaf of differentials $\Omega_{X/S}$ of $X$ over $S$} is
the conormal sheaf of the immersion $\Delta_{X/S} : X \to X \times_S X$,
see Definition \ref{definition-conormal-sheaf}.
\item The {\it universal $S$-derivation} is the $S$-derivation
$$
\text{d}_{X/S} : \mathcal{O}_X \longrightarrow \Omega_{X/S}
$$
which maps a local section $f$ of $\mathcal{O}_X$ to the class of
the local section $\text{d}_{X/S}(f) = s_2(f) - s_1(f)$ with
$s_2$ and $s_1$ as described above.
\end{enumerate}
\end{definition}

\noindent
Here is the universal property of the universal derivation.
If you have any other construction of the sheaf of relative differentials
which satisfies this universal property then, by the Yoneda lemma,
it will be canonically isomorphic to the one defined above.

\begin{lemma}
\label{lemma-universal-derivation-universal}
Let $f : X \to S$ be a morphism of schemes.
The map
$$
\text{Hom}_{\mathcal{O}_X}(\Omega_{X/S}, \mathcal{F})
\longrightarrow
\text{Der}_S(\mathcal{O}_X, \mathcal{F}), \ \ 
\alpha
\longmapsto
\alpha \circ \text{d}_{X/S}
$$
is an isomorphism of functors
from the category of $\mathcal{O}_X$-modules
to the category of sets.
\end{lemma}

\begin{proof}
Let $\mathcal{F}$ be an $\mathcal{O}_X$-module.
Let $D \in \text{Der}_S(\mathcal{O}_X, \mathcal{F})$.
We have to show there exists a unique $\mathcal{O}_X$-linear
map $\alpha : \Omega_{X/S} \to \mathcal{F}$ such that
$D = \alpha \circ \text{d}_{X/S}$.

\medskip\noindent
We claim that the image of $\text{d}_{X/S} : \mathcal{O}_X \to \Omega_{X/S}$
generates $\Omega_{X/S}$ as an $\mathcal{O}_X$-module. To see this it
suffices to prove this is true on suitable affine opens.
We can cover $X$ by affine opens $\text{Spec}(A) = W \subset X$
whose image is contained in an affine open $\text{Spec}(R) = V \subset S$.
As seen in the discussion leading up to
Definition \ref{definition-sheaf-differentials}
we have
$$
\Omega_{X/S}|_W = \widetilde{J/J^2}
$$
with $J = \text{Ker}(A \otimes_R A \to A)$. Now clearly $J$ is generated
by the elements $1 \otimes f - f \otimes 1$. Hence the claim follows.
This claim implies immediately that $\alpha$, if it exists, is unique.

\medskip\noindent
Next, we come to existence of $\alpha$. Note that the construction of
the pair $(\Omega_{X/S}, \text{d}_{X/S})$ commutes with restriction
to open subschemes (in both $X$ and $S$). Proof omitted. By the uniqueness
just shown, it therefore suffices to prove existence in case both
$X$ and $S$ are affine. Thus we may write $X = \text{Spec}(A)$,
$S = \text{Spec}(S)$ and $M = \Gamma(X, \mathcal{F})$.
Set as usual $J = \text{Ker}(A \otimes_R A \to A)$ so that
$\Omega_{X/S} = \widetilde{J/J^2}$.
According to Algebra, Lemmas \ref{algebra-lemma-universal-omega} and
\ref{algebra-lemma-differentials-diagonal}
there exists a unique $A$-linear map
$\alpha' : J/J^2 \to M$ such that the composition
$\text{d} \circ \alpha' : A \to J/J^2 \to M$
is equal to the action of $D$ on global sections over $X$.
By Schemes, Lemma \ref{schemes-lemma-compare-constructions} the $A$-linear map
$\alpha'$ corresponds to a map
$\alpha : \Omega_{X/S} = \widetilde{J/J^2} \to \mathcal{F}$.
Then the derivations $\alpha \circ \text{d}_{X/S}$ and $D$
have the same effect on global sections and hence agree
by Lemma \ref{lemma-affine-case-derivation}.
This proves existence and we win.
\end{proof}

\begin{lemma}
\label{lemma-differentials-restrict-open}
Let $f : X \to S$ be a morphism of schemes.
Let $U \subset X$, $V \subset S$ be open subschemes such
that $f(U) \subset V$. Then there is a unique isomorphism
$\Omega_{X/S}|_U = \Omega_{U/V}$ of $\mathcal{O}_U$-modules such that
$\text{d}_{X/S}|_U = \text{d}_{U/V}$.
\end{lemma}

\begin{proof}
The existence of the isomorphism is clear from the construction
of $\Omega_{X/S}$. Uniqueness comes from the fact, seen in
the proof of Lemma \ref{lemma-universal-derivation-universal},
that the image of $\text{d}_{X/S} : \mathcal{O}_X \to \Omega_{X/S}$ generates
$\Omega_{X/S}$ as an $\mathcal{O}_X$-module.
\end{proof}

\noindent
From now on we will use these canonical identifications and simply
write $\Omega_{U/S}$ or $\Omega_{U/V}$ for the restriction of
$\Omega_{X/S}$ to $U$.

\begin{lemma}
\label{lemma-differentials-affine}
Let $f : X \to S$ be a morphism of schemes.
For any pair of affine opens $\text{Spec}(A) = U \subset X$,
$\text{Spec}(R) = V \subset S$ with $f(U) \subset V$ there is
a unique isomorphism
$$
\Gamma(U, \mathcal{O}_{X/S}) =
\Omega_{A/R}.
$$
compatible with $\text{d}_{X/S}$ and $\text{d} : A \to \Omega_{A/R}$.
\end{lemma}

\begin{proof}
During the construction of $\Omega_{X/S}$ we have seen that
the restriction of $\Omega_{X/S}$ to $U$ is isomorphic to the quasi-coherent
sheaf associated to the $A$-module $J/J^2$ where
$J = \text{Ker}(A \otimes_R A \to A)$. Hence the result follows from
Algebra, Lemma \ref{algebra-lemma-differentials-diagonal}.

\medskip\noindent
An alternative proof is to show that the $A$-module
$M = \Gamma(U, \Omega_{X/S}) = \Gamma(U, \Omega_{U/V})$
together with $\text{d}_{X/S} = \text{d}_{U/V} : A \to M$
is a universal $R$-derivation of $A$. This follows by combining
Lemmas \ref{lemma-affine-case-derivation}
and \ref{lemma-universal-derivation-universal} above.
The universal property of
$\text{d} : A \to \Omega_{A/R}$
(see Algebra, Lemma \ref{algebra-lemma-universal-omega})
and the Yoneda lemma
(Categories, Lemma \ref{categories-lemma-yoneda})
imply there is a unique isomorphism of $A$-modules
$M \cong \Omega_{A/R}$ compatible with derivations.
This gives the second proof.
\end{proof}

\begin{remark}
\label{remark-differentials-glue}
The lemma above gives a second way of constructing the module of
differentials. Namely, let $f : X \to S$ be a morphism of schemes.
Consider the collection of all affine opens $U \subset X$ which
map into an affine open of $S$. These form a basis for the topology
on $X$. Thus it suffices to define $\Gamma(U, \Omega_{X/S})$
for such $U$. We simply set $\Gamma(U, \Omega_{X/S}) = \Omega_{A/R}$ if
$A$, $R$ are as in Lemma \ref{lemma-differentials-affine} above.
This works, but it takes somewhat more algebraic preliminaries
to construct the restriction mappings and to verify the sheaf
condition with this ansatz.
\end{remark}

\begin{lemma}
\label{lemma-functoriality-differentials}
Let
$$
\xymatrix{
X' \ar[d] \ar[r]_f & X \ar[d] \\
S' \ar[r] & S
}
$$
be a commutative diagram of schemes. The canonical map
$\mathcal{O}_X \to f_*\mathcal{O}_{X'}$ composed with the map
$f_*\text{d}_{X'/S'} : f_*\mathcal{O}_{X'} \to f_*\Omega_{X'/S'}$ is a
$S$-derivation. Hence we obtain a canonical map of $\mathcal{O}_X$-modules
$\Omega_{X/S} \to f_*\Omega_{X'/S'}$, and by
adjointness of $f_*$ and $f^*$ a
canonical $\mathcal{O}_{X'}$-module homomorphism
$$
c_f : f^*\Omega_{X/S} \longrightarrow \Omega_{X'/S'}.
$$
It is uniquely characterized by the property that
$f^*\text{d}_{X/S}(h)$ mapsto $\text{d}_{X'/S'}(f^\sharp h)$
for any local section $h$ of $\mathcal{O}_X$.
\end{lemma}

\begin{proof}
Omitted. We can use the functoriality of the conormal sheaves
(see Lemma \ref{lemma-conormal-functorial}) to define this or
we can use the characterization
at the end of the lemma to glue maps defined on affine patches
(see Algebra, Equation (\ref{algebra-equation-functorial-omega})).
\end{proof}

\begin{lemma}
\label{lemma-check-functoriality-differentials}
Let
$$
\xymatrix{
X'' \ar[d] \ar[r]_g & X' \ar[d] \ar[r]_f & X \ar[d] \\
S'' \ar[r] & S' \ar[r] & S
}
$$
be a commutative diagram of schemes. Then we have
$$
c_{f \circ g} = c_g \circ g^* c_f
$$
as maps $(f \circ g)^*\Omega_{X/S} \to \Omega_{X''/S''}$.
\end{lemma}

\begin{proof}
Omitted. One way to see this is to restrict to affine opens.
\end{proof}

\begin{lemma}
\label{lemma-triangle-differentials}
Let $f : X \to Y$ $g : Y \to S$ be morphisms of schemes.
Then there is a canonical exact sequence
$$
f^*\Omega_{Y/S} \to \Omega_{X/S} \to \Omega_{X/Y} \to 0
$$
where the maps come from applications of
Lemma \ref{lemma-functoriality-differentials}.
\end{lemma}

\begin{proof}
This is the sheafified version of
Algebra, Lemma \ref{algebra-lemma-exact-sequence-differentials}.
\end{proof}

\begin{lemma}
\label{lemma-immersion-differentials}
If $X \to S$ is an immersion, or more generally a monomorphism, then
$\Omega_{X/S}$ is zero.
\end{lemma}

\begin{proof}
This is true because $\Delta_{X/S}$ is an isomorphism in this case
and hence has trivial conormal sheaf. The algebraic version is
Algebra, Lemma \ref{algebra-lemma-trivial-differential-surjective}.
\end{proof}

\begin{lemma}
\label{lemma-differentials-relative-immersion}
Let $i : Z \to X$ be an immersion of schemes over $S$.
There is a canonical exact sequence
$$
\mathcal{C}_{Z/X} \to i^*\Omega_{X/S} \to \Omega_{Z/S} \to 0
$$
where the first arrow is induced by $\text{d}_{X/S}$
and the second arrow comes from Lemma \ref{lemma-functoriality-differentials}.
\end{lemma}

\begin{proof}
This is the sheafified version of
Algebra, Lemma \ref{algebra-lemma-differential-seq}. However
we should make sure we can define the first arrow globally.
Hence we explain the meaning of ``induced by $\text{d}_{X/S}$'' here.
Namely, we may assume that $i$ is a closed immersion by
shrinking $X$. Let $\mathcal{I} \subset \mathcal{O}_X$
be the sheaf of ideals corresponding to $Z \subset X$.
Then $\text{d}_{X/S} : \mathcal{I} \to \Omega_{X/S}$
maps the subsheaf $\mathcal{I}^2 \subset \mathcal{I}$ to
$\mathcal{I}\Omega_{X/S}$. Hence it induces a map
$\mathcal{I}/\mathcal{I}^2 \to \Omega_{X/S}/\mathcal{I}\Omega_{X/S}$
which is $\mathcal{O}_X/\mathcal{I}$-linear.
By Lemma \ref{lemma-i-star-equivalence} this corresponds to a map
$\mathcal{C}_{Z/X} \to i^*\Omega_{X/S}$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-base-change-differentials}
Let $X \to S$ be a morphism of schemes.
Let $g : S' \to S$ be a morphism of schemes.
Let $X' = X_{S'}$ be the base change of $X$.
Denote $g' : X' \to X$ the projection.
Then the map
$$
(g')^*\Omega_{X/S} \to \Omega_{X'/S'}
$$
of Lemma \ref{lemma-functoriality-differentials} is an isomorphism.
\end{lemma}

\begin{proof}
This is the sheafified version of
Algebra, Lemma \ref{algebra-lemma-differentials-base-change}.
\end{proof}

\begin{lemma}
\label{lemma-differential-product}
Let $f : X \to S$ and $g : Y \to S$ be morphisms of schemes with the same
target. Let $p : X \times_S Y \to X$ and $q : X \times_S Y \to Y$ be the
projection morphisms. The maps from
Lemma \ref{lemma-functoriality-differentials}
$$
p^*\Omega_{X/S} \oplus q^*\Omega_{Y/S}
\longrightarrow
\Omega_{X \times_S Y/S}
$$
give an isomorphism.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-base-change-differentials} the composition
$p^*\Omega_{X/S} \to \Omega_{X \times_S Y/S} \to \Omega_{X \times_S Y/Y}$
is an isomorphism, and similarly for $q$. Moreover, the cokernel
of $p^*\Omega_{X/S} \to \Omega_{X \times_S Y/S}$ is
$\Omega_{X \times_S Y/X}$ by
Lemma \ref{lemma-triangle-differentials}. The result follows.
\end{proof}





\begin{lemma}
\label{lemma-finite-type-differentials}
Let $f : X \to S$ be a morphism of schemes.
If $f$ is locally of finite type, then $\Omega_{X/S}$ is
a finite type $\mathcal{O}_X$-module.
\end{lemma}

\begin{proof}
Immediate from
Algebra, Lemma \ref{algebra-lemma-differentials-finitely-generated},
Lemma \ref{lemma-differentials-affine},
Lemma \ref{lemma-locally-finite-type-characterize}, and
Properties, Lemma \ref{properties-lemma-finite-type-module}.
\end{proof}

\begin{lemma}
\label{lemma-finite-presentation-differentials}
Let $f : X \to S$ be a morphism of schemes.
If $f$ is locally of finite type, then $\Omega_{X/S}$ is
an $\mathcal{O}_X$-module of finite presentation.
\end{lemma}

\begin{proof}
Immediate from
Algebra, Lemma \ref{algebra-lemma-differentials-finitely-presented},
Lemma \ref{lemma-differentials-affine},
Lemma \ref{lemma-locally-finite-presentation-characterize}, and
Properties, Lemma \ref{properties-lemma-finite-presentation-module}.
\end{proof}










\section{Smooth morphisms}
\label{section-smooth}

\noindent
Let $f : X \to Y$ be a map of topological spaces. Consider the following
condition:
\begin{list}{(*)}{}
\item For every $x \in X$ there exist open neighbourhoods
$x \in U \subset X$ and $f(x) \in V \subset Y$, and an integer $d$
such that $f(U) = V$ and such that there is an isomorphism
$$
\xymatrix{
V \times B_d(0, 1) \ar[r]^-{\cong} \ar[d] & U \ar[r] \ar[d] & X \ar[d] \\
V \ar@{=}[r] & V \ar[r] & Y
}
$$
where $B_d(0, 1) \subset \mathbf{R}^d$ is a ball of radius $1$ around $0$.
\end{list}
Smooth morphisms are the analogue of such morphisms in the category
of schemes. See Lemma \ref{lemma-smooth-locally-standard-smooth}
and (insert future reference here about
etale over affine space).

\medskip\noindent
Contrary to expectations (perhaps) the notion
of a smooth ring map is not defined solely in terms
of the module of differentials. Namely, recall that
$R \to A$ is a {\it smooth ring map} if $A$ is of finite presentation over $R$
and if the naive cotangent complex of $A$ over $R$ is quasi-isomorphic
to a projective module placed in degree $0$.

\begin{definition}
\label{definition-smooth}
Let $f : X \to S$ be a morphism of schemes.
\begin{enumerate}
\item We say that $f$ is {\it smooth at $x \in X$} if
there exists a affine open neighbourhood $\text{Spec}(A) = U \subset X$
of $x$ and and affine open $\text{Spec}(R) = V \subset S$
with $f(U) \subset V$ such that the induced ring map
$R \to A$ is smooth, see Algebra, Definition \ref{algebra-definition-smooth}.
\item We say that $f$ is {\it smooth} if it is smooth at every point of $X$.
\item A morphism of affine schemes $f : X \to S$
is called {\it standard smooth} there exists a standard smooth ring
map $R \to R[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$ (see
Algebra, Definition \ref{algebra-definition-standard-smooth})
such that $X \to S$ is isomorphic to
$$
\text{Spec}(R[x_1, \ldots, x_n]/(f_1, \ldots, f_c)) \to \text{Spec}(R).
$$
\end{enumerate}
\end{definition}

\noindent
A pleasing feature of this definition is that the set of points
where a morphism is smooth is automatically open.

\medskip\noindent
Note that there is no separation or quasi-compactness hypotheses in the
definition. Hence the question of being smooth is local in nature on
the source. Here is the precise result.

\begin{lemma}
\label{lemma-smooth-characterize}
Let $f : X \to S$ be a morphism of schemes.
The following are equivalent
\begin{enumerate}
\item The morphism $f$ is smooth.
\item For every affine opens $U \subset X$, $V \subset S$
with $f(U) \subset V$ the ring map
$\mathcal{O}_S(V) \to \mathcal{O}_X(U)$ is smooth.
\item There exists an open covering $S = \bigcup_{j \in J} V_j$
and open coverings $f^{-1}(V_j) = \bigcup_{i \in I_j} U_i$ such
that each of the morphisms $U_i \to V_j$, $j\in J, i\in I_j$
is smooth.
\item There exists an affine open covering $S = \bigcup_{j \in J} V_j$
and affine open coverings $f^{-1}(V_j) = \bigcup_{i \in I_j} U_i$ such
that the ring map $\mathcal{O}_S(V_j) \to \mathcal{O}_X(U_i)$ is
smooth, for all $j\in J, i\in I_j$.
\end{enumerate}
Moreover, if $f$ is smooth then for
any open subschemes $U \subset X$, $V \subset S$ with $f(U) \subset V$
the restriction $f|_U : U \to V$ is smooth.
\end{lemma}

\begin{proof}
This follows from Lemma \ref{lemma-locally-P} if we show that
the property ``$R \to A$ is smooth'' is local.
We check conditions (a), (b) and (c) of Definition
\ref{definition-property-local}.
By Algebra, Lemma \ref{algebra-lemma-base-change-smooth}
being smooth is stable under base change and hence
we conclude (a) holds. By
Algebra, Lemma \ref{algebra-lemma-compose-smooth}
being smooth is stable under composition and for any ring
$R$ the ring map $R \to R_f$ is (standard) smooth.
We conclude (b) holds. Finally, property (c) is true
according to Algebra, Lemma \ref{algebra-lemma-locally-smooth}.
\end{proof}


\noindent
The following lemma characterizes a smooth morphism as a
flat, finitely presented morphism with smooth fibres.

\begin{lemma}
\label{lemma-smooth-flat-smooth-fibres}
Let $f : X \to S$ be a morphism of schemes.
If $f$ is flat, locally of finite presentation, and all
fibres $X_s$ are smooth, then $f$
is smooth.
\end{lemma}

\begin{proof}
Follows from Algebra, Lemma \ref{algebra-lemma-flat-fibre-smooth}.
\end{proof}


\begin{lemma}
\label{lemma-composition-smooth}
The composition of two morphisms which are smooth is smooth.
\end{lemma}

\begin{proof}
In the proof of Lemma \ref{lemma-smooth-characterize}
we saw that being smooth is a local property of ring maps.
Hence the first statement of the lemma follows from
Lemma \ref{lemma-composition-type-P} combined
with the fact that being smooth is a property of ring maps that is
stable under composition, see
Algebra, Lemma \ref{algebra-lemma-compose-smooth}.
\end{proof}

\begin{lemma}
\label{lemma-base-change-smooth}
The base change of a morphism which is smooth is smooth.
\end{lemma}

\begin{proof}
In the proof of Lemma \ref{lemma-smooth-characterize}
we saw that being smooth is a local property of ring maps.
Hence the lemma follows from
Lemma \ref{lemma-composition-type-P} combined
with the fact that being smooth is a property of ring maps that is
stable under base change, see
Algebra, Lemma \ref{algebra-lemma-base-change-smooth}.
\end{proof}

\begin{lemma}
\label{lemma-open-immersion-smooth}
Any open immersion is smooth.
\end{lemma}

\begin{proof}
This is true because an open immersion is a local isomorphism.
\end{proof}

\begin{lemma}
\label{lemma-smooth-syntomic}
A smooth morphism is syntomic.
\end{lemma}

\begin{proof}
See Algebra, Lemma \ref{algebra-lemma-smooth-syntomic}.
\end{proof}

\begin{lemma}
\label{lemma-smooth-locally-finite-presentation}
A smooth morphism is locally of finite presentation.
\end{lemma}

\begin{proof}
True because a smooth ring map is of finite presentation by
definition.
\end{proof}

\begin{lemma}
\label{lemma-smooth-flat}
A smooth morphism is flat.
\end{lemma}

\begin{proof}
Combine Lemmas \ref{lemma-syntomic-flat} and \ref{lemma-smooth-syntomic}.
\end{proof}

\noindent
The following lemma says locally any smooth morphism is standard smooth.
Hence we can use standard smooth morphisms as a {\it local model}
for a smooth morphism.

\begin{lemma}
\label{lemma-smooth-locally-standard-smooth}
Let $f : X  \to S$ be a morphism of schemes.
Let $x \in X$ be a point.
Set $s = f(x)$.
The following are equivalent
\begin{enumerate}
\item The morphism $f$ is smooth at $x$.
\item There exist affine opens $U \subset X$,
and $V \subset S$ such that $x \in U$, $f(U) \subset V$ and the
induced morphism $f|_U : U \to V$ is standard smooth.
\end{enumerate}
\end{lemma}

\begin{proof}
Follows from the definitions and
Algebra, Lemmas \ref{algebra-lemma-standard-smooth}
and \ref{algebra-lemma-smooth-syntomic}.
\end{proof}

\begin{lemma}
\label{lemma-smooth-omega-finite-locally-free}
Let $f : X \to S$ be a morphism of schemes.
Assume $f$ is smooth.
Then the module of differentials $\Omega_{X/S}$ of $X$ over $S$
is finite locally free and
$$
\text{rank}_x(\Omega_{X/S}) = \dim_x(X_{f(x)})
$$
for every $x \in X$.
\end{lemma}

\begin{proof}
The statement is local on $X$ and $S$.
By Lemma \ref{lemma-smooth-locally-standard-smooth}
above we may assume that $f$ is a standard smooth morphism of affines.
In this case the result follows from
Algebra, Lemma \ref{algebra-lemma-standard-smooth}
(and the definition of a relative global complete intersection, see
Algebra,
Definition \ref{algebra-definition-relative-global-complete-intersection}).
\end{proof}

\noindent
Lemma \ref{lemma-smooth-omega-finite-locally-free}
says that the following definition makes sense.

\begin{definition}
\label{definition-smooth-relative-dimension}
Let $d \geq 0$ be an integer. We say a morphism of schemes $f : X \to S$
is {\it smooth of relative dimension $d$} if $f$ is smooth and
$\Omega_{X/S}$ is finite locally free of constant rank $d$.
\end{definition}

\noindent
In other words, $f$ is smooth and the nonempty fibres are equidimensional
of dimension $d$. By Lemma \ref{lemma-smooth-at-point} below this is also
the same as requiring: (a) $f$ is locally of finite presentation, (b) $f$ is
flat, (c) all nonempty fibres equidimensional of dimension $d$, and (d)
$\Omega_{X/S}$ finite locally free of rank $d$. It is not enough to simply
assume that $f$ is flat, of finite presentation, and $\Omega_{X/S}$ is
finite locally free of rank $d$. A counter example is given by
$\text{Spec}(\mathbf{F}_p[t]) \to \text{Spec}(\mathbf{F}_p[t^p])$.

\medskip\noindent
Here is a differential criterion of smoothness at a point.
There are many variants of this result
all of which may be usefull at some point. We will just add them
here as needed.

\begin{lemma}
\label{lemma-smooth-at-point}
Let $f : X \to S$ be a morphism of schemes.
Let $x \in X$.
Set $s = f(x)$.
Assume $f$ is locally of finite presentation.
The following are equivalent:
\begin{enumerate}
\item The morphism $f$ is smooth at $x$.
\item The local ring map $\mathcal{O}_{S, s} \to \mathcal{O}_{X, x}$
is flat and the $\mathcal{O}_{X, x}$-module $\Omega_{X/S, x}$
can be generated by at most $\dim_x(X_{f(x)})$ elements.
\item The local ring map $\mathcal{O}_{S, s} \to \mathcal{O}_{X, x}$
is flat and the $\kappa(x)$-vector space
$$
\Omega_{X_s/s, x} \otimes_{\mathcal{O}_{X_s, x}} \kappa(x) =
\Omega_{X/S, x} \otimes_{\mathcal{O}_{X, x}} \kappa(x)
$$
can be generated by at most $\dim_x(X_{f(x)})$ elements.
\item There exist affine opens $U \subset X$,
and $V \subset S$ such that $x \in U$, $f(U) \subset V$ and the
induced morphism $f|_U : U \to V$ is standard smooth.
\item There exist affine opens $\text{Spec}(A) = U \subset X$
and $\text{Spec}(R) = V \subset S$ with $x \in U$ corresponding
to $\mathfrak q \subset A$, and $f(U) \subset V$
such that there exists a presentation
$$
A = R[x_1, \ldots, x_n]/(f_1, \ldots, f_c)
$$
with
$$
g =
\det
\left(
\begin{matrix}
\partial f_1/\partial x_1 &
\partial f_2/\partial x_1 &
\ldots &
\partial f_c/\partial x_1 \\
\partial f_1/\partial x_2 &
\partial f_2/\partial x_2 &
\ldots &
\partial f_c/\partial x_2 \\
\ldots & \ldots & \ldots & \ldots \\
\partial f_1/\partial x_c &
\partial f_2/\partial x_c &
\ldots &
\partial f_c/\partial x_c
\end{matrix}
\right)
$$
mapping to an element of $A$ not in $\mathfrak q$.
\end{enumerate}
\end{lemma}

\begin{proof}
Note that if $f$ is smooth at $x$, then we see from Lemma
\ref{lemma-smooth-at-point} that (4) holds, and (5) is a slightly
weakened version of (4). Moreover, this implies that the ring
map $\mathcal{O}_{S, s} \to \mathcal{O}_{X, x}$ is flat (see
Lemma \ref{lemma-smooth-flat}) and that $\Omega_{X/S}$ is
finite locally free of rank equal to
$\dim_x(X_s)$ (see Lemma \ref{lemma-smooth-omega-finite-locally-free}).
This implies (2) and (3).

\medskip\noindent
By Lemma \ref{lemma-base-change-differentials}
the module of differentials $\Omega_{X_s/s}$ of the fibre $X_s$
over $\kappa(s)$ is the pullback of the module of differentials
$\Omega_{X/S}$ of $X$ over $S$. Hence the displayed equality in
part (3) of the lemma. By Lemma \ref{lemma-finite-type-differentials}
these modules are of finite type. Hence the mimimal number of
generators of the modules
$\Omega_{X/S, x}$ and $\Omega_{X_s/s, x}$ is the same and equal to the
dimension of this $\kappa(x)$-vector space by Nakayama's Lemma
(Algebra, Lemma \ref{algebra-lemma-NAK}). This in particular shows that
(2) and (3) are equivalent.

\medskip\noindent
Combining Algebra, Lemmas \ref{algebra-lemma-flat-fibre-smooth} and
\ref{algebra-lemma-characterize-smooth-over-field} shows that
(2) and (3) imply (1). Finally, (5) implies (4) see for example
Algebra, Example \ref{algebra-example-make-standard-smooth}.
\end{proof}















\section{Unramified morphisms}
\label{section-unramified}

\noindent
We briefly discuss unramified morphisms before the (perhaps) more interesting
class of etale morphisms. Recall that a ring map $R \to A$ is {\it unramified}
if it is of finite presentation and $\Omega_{A/R} = 0$.

\begin{definition}
\label{definition-unramified}
Let $f : X \to S$ be a morphism of schemes.
\begin{enumerate}
\item We say that $f$ is {\it unramified at $x \in X$} if
there exists a affine open neighbourhood $\text{Spec}(A) = U \subset X$
of $x$ and and affine open $\text{Spec}(R) = V \subset S$
with $f(U) \subset V$ such that the induced ring map
$R \to A$ is unramified, see
Algebra, Definition \ref{algebra-definition-unramified}.
\item We say that $f$ is {\it unramified} if it is unramified
at every point of $X$.
\end{enumerate}
\end{definition}

\noindent
A pleasing feature of this definition is that the set of points
where a morphism is unramified is automatically open.

\begin{lemma}
\label{lemma-unramified-omega-zero}
Let $f : X \to S$ be a morphism of schemes.
Then $f$ is unramified if and only if $f$ is locally of finite presentation
and $\Omega_{X/S} = 0$.
\end{lemma}

\begin{proof}
By definition a ring map $R \to A$ is unramified if and only if it is
of finite presentation and $\Omega_{A/R} = 0$. Hence the lemma follows
directly from the definitions and Lemma \ref{lemma-differentials-affine}.
\end{proof}

\medskip\noindent
Note that there is no separation or quasi-compactness hypotheses in the
definition. Hence the question of being unramified is local in nature on
the source. Here is the precise result.

\begin{lemma}
\label{lemma-unramified-characterize}
Let $f : X \to S$ be a morphism of schemes.
The following are equivalent
\begin{enumerate}
\item The morphism $f$ is unramified.
\item For every affine opens $U \subset X$, $V \subset S$
with $f(U) \subset V$ the ring map
$\mathcal{O}_S(V) \to \mathcal{O}_X(U)$ is unramified.
\item There exists an open covering $S = \bigcup_{j \in J} V_j$
and open coverings $f^{-1}(V_j) = \bigcup_{i \in I_j} U_i$ such
that each of the morphisms $U_i \to V_j$, $j\in J, i\in I_j$
is unramified.
\item There exists an affine open covering $S = \bigcup_{j \in J} V_j$
and affine open coverings $f^{-1}(V_j) = \bigcup_{i \in I_j} U_i$ such
that the ring map $\mathcal{O}_S(V_j) \to \mathcal{O}_X(U_i)$ is
unramified, for all $j\in J, i\in I_j$.
\end{enumerate}
Moreover, if $f$ is unramified then for
any open subschemes $U \subset X$, $V \subset S$ with $f(U) \subset V$
the restriction $f|_U : U \to V$ is unramified.
\end{lemma}

\begin{proof}
This follows from Lemma \ref{lemma-locally-P} if we show that
the property ``$R \to A$ is unramified'' is local.
We check conditions (a), (b) and (c) of Definition
\ref{definition-property-local}.
These properties are proved in
Algebra, Lemma \ref{algebra-lemma-unramified}.
\end{proof}

\begin{lemma}
\label{lemma-composition-unramified}
The composition of two morphisms which are unramified is unramified.
\end{lemma}

\begin{proof}
In the proof of Lemma \ref{lemma-unramified-characterize}
we saw that being unramified is a local property of ring maps.
Hence the first statement of the lemma follows from
Lemma \ref{lemma-composition-type-P} combined
with the fact that being unramified is a property of ring maps that is
stable under composition, see
Algebra, Lemma \ref{algebra-lemma-unramified}.
\end{proof}

\begin{lemma}
\label{lemma-base-change-unramified}
The base change of a morphism which is unramified is unramified.
\end{lemma}

\begin{proof}
In the proof of Lemma \ref{lemma-unramified-characterize}
we saw that being unramified is a local property of ring maps.
Hence the lemma follows from
Lemma \ref{lemma-composition-type-P} combined
with the fact that being unramified is a property of ring maps that is
stable under base change, see
Algebra, Lemma \ref{algebra-lemma-unramified}.
\end{proof}

\begin{lemma}
\label{lemma-open-immersion-unramified}
Any open immersion is unramified.
\end{lemma}

\begin{proof}
This is true because an open immersion is a local isomorphism.
\end{proof}

\begin{lemma}
\label{lemma-closed-immersion-unramified}
A closed immersion $i : Z \to X$ is unramified if and only if
the associated quasi-coherent sheaf of ideals
$\mathcal{I} = \text{Ker}(\mathcal{O}_X \to i_*\mathcal{O}_Z)$
is of finite type (as an $\mathcal{O}_X$-module).
\end{lemma}

\begin{proof}
Follows from Lemma \ref{lemma-closed-immersion-finite-presentation} and
Algebra, Lemma \ref{algebra-lemma-unramified}.
\end{proof}

\begin{lemma}
\label{lemma-unramified-locally-finite-presentation}
An unramified morphism is locally of finite presentation.
\end{lemma}

\begin{proof}
An unramified ring map is locally of finite presentation by definition.
\end{proof}

\begin{lemma}
\label{lemma-unramified-over-field}
Let $X$ be a scheme over a field $k$.
The structure morphism $X \to \text{Spec}(k)$ is unramified if
and only if $X$ is a disjoint union of spectra of finite separable
field extensions of $k$.
\end{lemma}

\begin{proof}
We first use Algebra, Lemma \ref{algebra-lemma-characterize-unramified}.
This lemma implies that if $X$ is a disjoint union of spectra of finite
separable field extensions of $k$ then $X \to \text{Spec}(k)$ is unramified.
Conversely, suppose that $X \to \text{Spec}(k)$ is unramified.
By Algebra, Lemma \ref{algebra-lemma-unramified-at-prime} for every $x \in X$
the residue field extension $k \subset \kappa(x)$ is
finite separable. Hence all points of $X$ are closed points (see
Lemma \ref{lemma-algebraic-residue-field-extension-closed-point-fibre}
for example). Thus $X$ is a discrete space, in particular the disjoint union
of the spectra of its local rings. By
Algebra, Lemma \ref{algebra-lemma-unramified-at-prime} again these
local rings are fields, and we win.
\end{proof}

\noindent
The following lemma characterizes an unramified morphism as a
locally finitely presented morphism with unramified fibres.

\begin{lemma}
\label{lemma-unramfied-etale-fibres}
Let $f : X \to S$ be a morphism of schemes.
If $f$ is unramified then for any $x \in X$ the field extension
$\kappa(f(x)) \subset \kappa(x)$ is finite separable. Conversely,
if $f$ is locally of finite presentation, and for every $s \in S$
the fibre $X_s$ is a disjoint union of spectra of finite separable
field extensions of $\kappa(s)$ then $f$ is unramified.
\end{lemma}

\begin{proof}
Follows from Algebra, Lemma \ref{algebra-lemma-characterize-unramified}.
\end{proof}

\noindent
Here is a characterization of unramified morphisms in terms of the
diagonal morphism.

\begin{lemma}
\label{lemma-diagonal-unramfied-morphism}
Let $f : X \to S$ be a morphism. If $f$ is unramified, then
the diagonal morphism $\Delta : X \to X \times_S X$
is an open immersion. Conversely, if $f$ is locally of finite presentation
and $\Delta$ is an open immersion, then $f$ is unramified.
\end{lemma}

\begin{proof}
The first statement follows from
Algebra, Lemma \ref{algebra-lemma-diagonal-unramified}.
The second statement from the fact that $\Omega_{X/S}$
(see Definition \ref{definition-sheaf-differentials})
is the conormal sheaf of the diagonal morphism and hence
clearly zero if $\Delta$ is an open immersion.
\end{proof}

\begin{lemma}
\label{lemma-unramified-at-point}
Let $f : X \to S$ be a morphism of schemes.
Let $x \in X$.
Set $s = f(x)$.
Assume $f$ is locally of finite presentation.
The following are equivalent:
\begin{enumerate}
\item The morphism $f$ is unramified at $x$.
\item The $\mathcal{O}_{X, x}$-module $\Omega_{X/S, x}$ is zero.
\item The $\kappa(x)$-vector space
$$
\Omega_{X_s/s, x} \otimes_{\mathcal{O}_{X_s, x}} \kappa(x) =
\Omega_{X/S, x} \otimes_{\mathcal{O}_{X, x}} \kappa(x)
$$
is zero.
\item We have $\mathfrak m_s\mathcal{O}_{X, x} = \mathfrak m_x$
and the field extension $\kappa(s) \subset \kappa(x)$ is finite
separable.
\end{enumerate}
\end{lemma}

\begin{proof}
Note that if $f$ is unramified at $x$, then
we see that $\Omega_{X/S} = 0$ in a neighbourhood of $x$
by the definitions and the results on modules of differentials
in Section \ref{section-sheaf-differentials}. Hence (1) implies
(2) and (3).

\medskip\noindent
By Lemma \ref{lemma-base-change-differentials}
the module of differentials $\Omega_{X_s/s}$ of the fibre $X_s$
over $\kappa(s)$ is the pullback of the module of differentials
$\Omega_{X/S}$ of $X$ over $S$. Hence the displayed equality in
part (3) of the lemma. By Lemma \ref{lemma-finite-type-differentials}
these modules are of finite type. Hence he modules
$\Omega_{X/S, x}$ and $\Omega_{X_s/s, x}$ are zero if and only
if this $\kappa(x)$-vector space is zero by Nakayama's Lemma
(Algebra, Lemma \ref{algebra-lemma-NAK}). This in particular shows that
(2) and (3) are equivalent.

\medskip\noindent
The support of $\Omega_{X/S}$ is closed in $X$, see
Modules, Lemma \ref{modules-lemma-support-finite-type-closed}.
Assumption (2) implies that $x$ is not in the support.
Hence $\Omega_{X/S}$ is zero in a neighbourhood of $x$, which
clearly implies that $f$ is unramified at $x$.

\medskip\noindent
Alternatively you can use Algebra, Lemma \ref{algebra-lemma-unramified}
to see the implications (2) $\Rightarrow$ (1) and (3) $\Rightarrow$ (1)
more directly.

\medskip\noindent
The equivalence of (1) and (4) follows from Lemma
\ref{lemma-unramfied-etale-fibres}.
It also follows more directly from
Algebra, Lemmas \ref{algebra-lemma-unramified-at-prime} and
\ref{algebra-lemma-characterize-unramified}.
\end{proof}

\begin{lemma}
\label{lemma-unramified-permanence}
Let $f : X \to Y$ be a morphism of schemes over $S$.
If $X$ is unramified over $S$ and $Y$ of finite type over $S$, then
$f$ is unramified.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-finite-presentation-permanence} we see that
$f$ is locally of finite presentation.
By assumption we have $\Omega_{X/S} = 0$. Hence
$\Omega_{X/Y} = 0$ by Lemma \ref{lemma-triangle-differentials}. Thus we win.
\end{proof}













\section{Etale morphisms}
\label{section-etale}

\noindent
The Zariski topology of a scheme is a very coarse topology.
This is particularly clear when looking at varieties over $\mathbf{C}$.
It turns out that declaring an etale morphism to be the analogue of a
local isomorphism in topology introduces a much finer topology. On
varieties over $\mathbf{C}$ this topology gives rise to the ``correct'' betti
numbers when computing cohomology with finite coefficients. Another
observable is that if $f : X \to Y$ is an etale morphism of varieties over
$\mathbf{C}$, and if $x$ is a closed point of $X$, then 
$f$ induces an isomorphism
$\mathcal{O}^{\wedge}_{Y, f(x)} \to \mathcal{O}^{\wedge}_{X, x}$
of complete local rings.

\medskip\noindent
In this section we start our study of these matters. In fact we deliberately
restrict our discussion to a minimum since we will discuss more interesting
results elsewhere. Recall that a ring map $R \to A$ is said to be {\it etale}
if it is smooth and $\Omega_{A/R} = 0$.

\begin{definition}
\label{definition-etale}
Let $f : X \to S$ be a morphism of schemes.
\begin{enumerate}
\item We say that $f$ is {\it etale at $x \in X$} if
there exists a affine open neighbourhood $\text{Spec}(A) = U \subset X$
of $x$ and and affine open $\text{Spec}(R) = V \subset S$
with $f(U) \subset V$ such that the induced ring map
$R \to A$ is etale, see Algebra, Definition \ref{algebra-definition-etale}.
\item We say that $f$ is {\it etale} if it is etale at every point of $X$.
\item A morphism of affine schemes $f : X \to S$
is called {\it standard etale} there exists a standard etale ring
map $R \to R[x]_g/(f)$ (see
Algebra, Definition \ref{algebra-definition-standard-etale}; note that
$f$ is monic and $f'$ invertible in $R[x]_g$)
such that $X \to S$ is isomorphic to
$$
\text{Spec}(R[x]_g/(f)) \to \text{Spec}(R).
$$
\end{enumerate}
\end{definition}

\noindent
A morphism is etale if and only if it is smooth of relative dimension $0$
(see Definition \ref{definition-smooth-relative-dimension}).
A pleasing feature of the definition is that the set of points
where a morphism is etale is automatically open.

\medskip\noindent
Note that there is no separation or quasi-compactness hypotheses in the
definition. Hence the question of being etale is local in nature on
the source. Here is the precise result.

\begin{lemma}
\label{lemma-etale-characterize}
Let $f : X \to S$ be a morphism of schemes.
The following are equivalent
\begin{enumerate}
\item The morphism $f$ is etale.
\item For every affine opens $U \subset X$, $V \subset S$
with $f(U) \subset V$ the ring map
$\mathcal{O}_S(V) \to \mathcal{O}_X(U)$ is etale.
\item There exists an open covering $S = \bigcup_{j \in J} V_j$
and open coverings $f^{-1}(V_j) = \bigcup_{i \in I_j} U_i$ such
that each of the morphisms $U_i \to V_j$, $j\in J, i\in I_j$
is etale.
\item There exists an affine open covering $S = \bigcup_{j \in J} V_j$
and affine open coverings $f^{-1}(V_j) = \bigcup_{i \in I_j} U_i$ such
that the ring map $\mathcal{O}_S(V_j) \to \mathcal{O}_X(U_i)$ is
etale, for all $j\in J, i\in I_j$.
\end{enumerate}
Moreover, if $f$ is etale then for
any open subschemes $U \subset X$, $V \subset S$ with $f(U) \subset V$
the restriction $f|_U : U \to V$ is etale.
\end{lemma}

\begin{proof}
This follows from Lemma \ref{lemma-locally-P} if we show that
the property ``$R \to A$ is etale'' is local.
We check conditions (a), (b) and (c) of Definition
\ref{definition-property-local}.
These all follow from Algebra, Lemma \ref{algebra-lemma-etale}.
\end{proof}

\begin{lemma}
\label{lemma-etale-smooth-unramified}
Let $f : X \to S$ be a morphism of schemes.
Let $x \in X$. Then $f$ is etale at $x$ if and only if $f$ is
smooth and unramified at $x$.
\end{lemma}

\begin{proof}
This follows immediately from the definitions.
\end{proof}

\begin{lemma}
\label{lemma-etale-over-field}
Let $X$ be a scheme over a field $k$.
The structure morphism $X \to \text{Spec}(k)$ is etale if
and only if $X$ is a disjoint union of spectra of finite separable
field extensions of $k$.
\end{lemma}

\begin{proof}
You can deduce this from Lemma \ref{lemma-unramified-over-field}
via Lemma \ref{lemma-etale-smooth-unramified} above.
Here is a direct proof.

\medskip\noindent
We will use Algebra, Lemma \ref{algebra-lemma-etale-over-field}.
Hence it is clear that if $X$ is a disjoint union of spectra of finite
separable field extensions of $k$ then $X \to \text{Spec}(k)$ is etale.
Conversely, suppose that $X \to \text{Spec}(k)$ is etale. Then for any affine
open $U \subset X$ we see that $U$ is a finite disjoint union of spectra
of finite separable field extensions of $k$. Hence all points of $X$
are closed points (see
Lemma \ref{lemma-algebraic-residue-field-extension-closed-point-fibre}
for example). Thus $X$ is a discrete space and we win.
\end{proof}

\noindent
The following lemma characterizes an etale morphism as a
flat, finitely presented morphism with ``etale fibres''.

\begin{lemma}
\label{lemma-etale-flat-etale-fibres}
Let $f : X \to S$ be a morphism of schemes.
If $f$ is flat, locally of finite presentation, and for every $s \in S$
the fibre $X_s$ is a disjoint union of spectra of finite separable
field extensions of $\kappa(s)$, then $f$ is etale.
\end{lemma}

\begin{proof}
You can deduce this easily from
Algebra, Lemma \ref{algebra-lemma-characterize-etale}.
Here is another proof.

\medskip\noindent
By Lemma \ref{lemma-etale-over-field} a fibre $X_s$ is etale
and hence smooth over $s$. By Lemma \ref{lemma-smooth-flat-smooth-fibres}
we see that $X \to S$ is smooth.
By Lemma \ref{lemma-unramfied-etale-fibres}
we see that $f$ is unramified. We conclude by
Lemma \ref{lemma-etale-smooth-unramified}.
\end{proof}

\begin{lemma}
\label{lemma-composition-etale}
The composition of two morphisms which are etale is etale.
\end{lemma}

\begin{proof}
In the proof of Lemma \ref{lemma-etale-characterize}
we saw that being etale is a local property of ring maps.
Hence the first statement of the lemma follows from
Lemma \ref{lemma-composition-type-P} combined
with the fact that being etale is a property of ring maps that is
stable under composition, see
Algebra, Lemma \ref{algebra-lemma-etale}.
\end{proof}

\begin{lemma}
\label{lemma-base-change-etale}
The base change of a morphism which is etale is etale.
\end{lemma}

\begin{proof}
In the proof of Lemma \ref{lemma-etale-characterize}
we saw that being etale is a local property of ring maps.
Hence the lemma follows from
Lemma \ref{lemma-composition-type-P} combined
with the fact that being etale is a property of ring maps that is
stable under base change, see
Algebra, Lemma \ref{algebra-lemma-etale}.
\end{proof}

\begin{lemma}
\label{lemma-open-immersion-etale}
Any open immersion is etale.
\end{lemma}

\begin{proof}
This is true because an open immersion is a local isomorphism.
\end{proof}

\begin{lemma}
\label{lemma-etale-syntomic}
An etale morphism is syntomic.
\end{lemma}

\begin{proof}
See Algebra, Lemma \ref{algebra-lemma-smooth-syntomic} and use that an
etale morphism is the same as a smooth morphism of relative dimension $0$.
\end{proof}

\begin{lemma}
\label{lemma-etale-locally-finite-presentation}
An etale morphism is locally of finite presentation.
\end{lemma}

\begin{proof}
True because an etale ring map is of finite presentation by
definition.
\end{proof}

\begin{lemma}
\label{lemma-etale-flat}
An etale morphism is flat.
\end{lemma}

\begin{proof}
Combine Lemmas \ref{lemma-syntomic-flat} and \ref{lemma-etale-syntomic}.
\end{proof}

\noindent
The following lemma says locally any etale morphism is standard etale.
This is actually kind of a tricky result to prove in complete generality.
The tricky parts are hidden in the chapter on commutative algebra.
Hence a standard etale morphism is a {\it local model} for a general
etale morphism.

\begin{lemma}
\label{lemma-etale-locally-standard-etale}
Let $f : X  \to S$ be a morphism of schemes.
Let $x \in X$ be a point.
Set $s = f(x)$.
The following are equivalent
\begin{enumerate}
\item The morphism $f$ is etale at $x$.
\item There exist affine opens $U \subset X$,
and $V \subset S$ such that $x \in U$, $f(U) \subset V$ and the
induced morphism $f|_U : U \to V$ is standard etale
(see Definition \ref{definition-etale}).
\end{enumerate}
\end{lemma}

\begin{proof}
Follows from the definitions and
Algebra, Proposition \ref{algebra-proposition-etale-locally-standard}.
\end{proof}

\noindent
Here is a differential criterion of etaleness at a point.
There are many variants of this result
all of which may be usefull at some point. We will just add them
here as needed.

\begin{lemma}
\label{lemma-etale-at-point}
Let $f : X \to S$ be a morphism of schemes.
Let $x \in X$.
Set $s = f(x)$.
Assume $f$ is locally of finite presentation.
The following are equivalent:
\begin{enumerate}
\item The morphism $f$ is etale at $x$.
\item The local ring map $\mathcal{O}_{S, s} \to \mathcal{O}_{X, x}$
is flat and the $\mathcal{O}_{X, x}$-module $\Omega_{X/S, x}$
is zero.
\item The local ring map $\mathcal{O}_{S, s} \to \mathcal{O}_{X, x}$
is flat and the $\kappa(x)$-vector space
$$
\Omega_{X_s/s, x} \otimes_{\mathcal{O}_{X_s, x}} \kappa(x) =
\Omega_{X/S, x} \otimes_{\mathcal{O}_{X, x}} \kappa(x)
$$
is zero.
\item The local ring map $\mathcal{O}_{S, s} \to \mathcal{O}_{X, x}$
is flat, we have $\mathfrak m_s\mathcal{O}_{X, x} = \mathfrak m_x$ and
the field extension $\kappa(s) \subset \kappa(x)$ is finite
separable.
\item There exist affine opens $U \subset X$,
and $V \subset S$ such that $x \in U$, $f(U) \subset V$ and the
induced morphism $f|_U : U \to V$ is standard smooth
of relative dimension $0$.
\item There exist affine opens $\text{Spec}(A) = U \subset X$
and $\text{Spec}(R) = V \subset S$ with $x \in U$ corresponding
to $\mathfrak q \subset A$, and $f(U) \subset V$
such that there exists a presentation
$$
A = R[x_1, \ldots, x_n]/(f_1, \ldots, f_n)
$$
with
$$
g =
\det
\left(
\begin{matrix}
\partial f_1/\partial x_1 &
\partial f_2/\partial x_1 &
\ldots &
\partial f_n/\partial x_1 \\
\partial f_1/\partial x_2 &
\partial f_2/\partial x_2 &
\ldots &
\partial f_n/\partial x_2 \\
\ldots & \ldots & \ldots & \ldots \\
\partial f_1/\partial x_n &
\partial f_2/\partial x_n &
\ldots &
\partial f_n/\partial x_n
\end{matrix}
\right)
$$
mapping to an element of $A$ not in $\mathfrak q$.
\item There exist affine opens $U \subset X$,
and $V \subset S$ such that $x \in U$, $f(U) \subset V$ and the
induced morphism $f|_U : U \to V$ is standard etale.
\item There exist affine opens $\text{Spec}(A) = U \subset X$
and $\text{Spec}(R) = V \subset S$ with $x \in U$ corresponding
to $\mathfrak q \subset A$, and $f(U) \subset V$
such that there exists a presentation
$$
A = R[x]_Q/(P) = R[x, 1/Q]/(P)
$$
with $P, Q \in R[x]$, $P$ monic and $P' = {\rm d}P/{\rm d}x$ mapping to
an element of $A$ not in $\mathfrak q$.
\end{enumerate}
\end{lemma}

\begin{proof}
Use Lemma \ref{lemma-etale-locally-standard-etale}
and the definitions to see that (1) implies all
of the other conditions. For each of the conditions
(2) -- (7) combine Lemmas \ref{lemma-smooth-at-point}
and \ref{lemma-unramified-at-point} to see
that (1) holds by showing $f$ is both smooth and unramified
at $x$ and applying Lemma \ref{lemma-etale-smooth-unramified}.
Some details omitted.
\end{proof}

\begin{lemma}
\label{lemma-flat-unramified-etale}
A morphism is etale at a point if and only if it is flat and unramified
at that point.
A morphism is etale if and only if it is flat and unramified.
\end{lemma}

\begin{proof}
This is clear from Lemmas \ref{lemma-etale-at-point}
and \ref{lemma-unramified-at-point}.
\end{proof}

\noindent
Our proof of the following lemma is somewhat complicated.
It uses the ``Crit\`ere de platitude par fibres'' to see that
a morphism $X \to Y$ over $S$ between schemes etale over $S$
is automatically flat. The details are in the chapter on commutative algebra.

\begin{lemma}
\label{lemma-etale-permanence}
Let $f : X \to Y$ be a morphism of schemes over $S$.
If $X$ and $Y$ are etale over $S$, then
$f$ is etale.
\end{lemma}

\begin{proof}
See Algebra, Lemma \ref{algebra-lemma-map-between-etale}.
\end{proof}

















\section{Relatively ample sheaves}
\label{section-relatively-ample}

\noindent
Let $X \to S$ be a morphism of schemes.
Contrary to what one may think the existence of a relatively
ample sheaf on $X$ does not force the morphism $X \to S$ to be
of finite type. Here is the definition.

\begin{definition}
\label{definition-relatively-ample}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
We say $\mathcal{L}$ is {\it relatively ample} or more
precisely $\mathcal{L}$ is {\it $f$-relatively ample}, or
$\mathcal{L}$ is {\it ample on $X/S$} if $f : X \to S$
is quasi-compact, and if for every affine open $V \subset S$
the restriction of $\mathcal{L}$ to the open subscheme
$f^{-1}(V)$ of $X$ is ample.
\end{definition}

\begin{lemma}
\label{lemma-relatively-ample-separated}
Let $f : X \to S$ be a morphism of schemes.
If there exists an $f$-ample invertible sheaf, then
$f$ is separated.
\end{lemma}

\begin{proof}
Being separated is local on the base (see
Schemes, Lemma \ref{schemes-lemma-characterize-separated} for example;
it also follows easily from the definition).
Hence we may assume $S$ is affine and $X$
has an ample invertible sheaf. In this case the
result follows from
Properties, Lemma \ref{properties-lemma-ample-immersion-into-proj}
and Constructions, Lemma \ref{constructions-lemma-proj-separated}.
\end{proof}

\noindent
There are many ways to charactarize relatively ample invertible
sheaves, by relativizing any of the list of equivalent conditions in
Properties, Proposition \ref{properties-proposition-characterize-ample}.
We will add these here as needed.

\begin{lemma}
\label{lemma-characterize-relatively-ample}
Let $f : X \to S$ be a quasi-compact morphism of schemes.
Let $\mathcal{L}$ be an invertible sheaf on $X$.
The following are equivalent:
\begin{enumerate}
\item The invertible sheaf $\mathcal{L}$ is $f$-ample.
\item There exists an open covering $S = \bigcup V_i$
such that each $\mathcal{L}|_{f^{-1}(V_i)}$ is ample
relative to $f^{-1}(V_i) \to V_i$.
\item There exists an affine open covering $S = \bigcup V_i$
such that each $\mathcal{L}|_{f^{-1}(V_i)}$ is ample.
\item There exists a quasi-coherent graded $\mathcal{O}_S$-algebra
$\mathcal{A}$ and a map of graded $\mathcal{O}_X$-algebras
$\psi : f^*\mathcal{A} \to \bigoplus_{d \geq 0} \mathcal{L}^{\otimes d}$
such that $U(\psi) = X$ and
$$
r_{\mathcal{L}, \psi} :
X
\longrightarrow
\underline{\text{Proj}}_S(\mathcal{A})
$$
is an open immersion (see Constructions, Lemma
\ref{constructions-lemma-invertible-map-into-relative-proj} for notation).
\item The morphism $f$ is quasi-separated and
part (4) above holds with
$\mathcal{A} = f_*(\bigoplus_{d \geq 0} \mathcal{L}^{\otimes d})$
and $\psi$ the adjunction mapping.
\item Same as (4) but just requiring $r_{\mathcal{L}, \psi}$
to be an immersion.
\end{enumerate}
\end{lemma}

\begin{proof}
It is immediate from the definition that (1) implies (2) and
(2) implies (3). It is clear that (5) implies (4).

\medskip\noindent
Assume (3) holds for the affine open covering $S = \bigcup V_i$.
We are going to show (5) holds.
Since each $f^{-1}(V_i)$ has an ample invertible sheaf we see
that $f^{-1}(V_i)$ is separated (see
Properties, Lemma \ref{properties-lemma-ample-immersion-into-proj} and
Constructions, Lemma \ref{constructions-lemma-proj-separated}).
Hence $f$ is separated. By
Schemes, Lemma \ref{schemes-lemma-push-forward-quasi-coherent}
we see that $\mathcal{A} = f_*(\bigoplus_{d \geq 0} \mathcal{L}^{\otimes d})$
is a quasi-coherent graded $\mathcal{O}_S$-algebra.
Denote $\psi : f^*\mathcal{A} \to \bigoplus_{d \geq 0} \mathcal{L}^{\otimes d}$
the adjunction mapping.
The description of the open $U(\psi)$ in
Construction, Section \ref{constructions-section-invertible-relative-proj}
and the definition of ampleness
of $\mathcal{L}|_{f^{-1}(V_i)}$ show that $U(\psi) = X$.
Moreover, Constructions,
Lemma \ref{constructions-lemma-invertible-map-into-relative-proj} part (3)
shows that the restriction of $r_{\mathcal{L}, \psi}$ to
$f^{-1}(V_i)$ is the same as the morphism from
Properties, Lemma \ref{properties-lemma-map-into-proj}
which is an open immersion according to
Properties, Lemma \ref{properties-lemma-ample-immersion-into-proj}.
Hence (5) holds.

\medskip\noindent
Let us show that (4) implies (1). Assume (4).
Denote $\pi : \underline{\text{Proj}}_S(\mathcal{A}) \to S$
the structure morphism. Choose $V \subset S$ affine open. By
Constructions, Definition \ref{constructions-definition-relative-proj}
we see that $\pi^{-1}(V) \subset \underline{\text{Proj}}_S(\mathcal{A})$
is equal to $\text{Proj}(A)$ where $A = \mathcal{A}(V)$
as a graded ring. Hence $r_{\mathcal{L}, \psi}$ maps
$f^{-1}(V)$ isomorphically onto
a quasi-compact open of $\text{Proj}(A)$.
Moreover, $\mathcal{L}^{\otimes d}$ is isomorphic to the pullback of
$\mathcal{O}_{\text{Proj}(A)}(d)$ for some $d \geq 1$.
(See part (3) of Constructions,
Lemma \ref{constructions-lemma-invertible-map-into-relative-proj}
and the final statement of Constructions,
Lemma \ref{constructions-lemma-invertible-map-into-proj}.)
This implies that $\mathcal{L}|_{f^{-1}(V)}$ is ample by
Properties, Lemmas \ref{properties-lemma-open-in-proj-ample}
and \ref{properties-lemma-ample-power-ample}.

\medskip\noindent
Assume (6). By the equivalence of (1) - (5) above we see that the
property of being relatively ample on $X/S$ is local on $S$. Hence
we may assume that $S$ is affine, and we have to show that
$\mathcal{L}$ is ample on $X$. In this case the morphism
$r_{\mathcal{L}, \psi}$ is identified with the morphism, also denoted
$r_{\mathcal{L}, \psi} : X \to \text{Proj}(A)$ associated to the map
$\psi : A = \mathcal{A}(V) \to \Gamma_*(X, \mathcal{L})$.
(See references above.) As above we also see that
$\mathcal{L}^{\otimes d}$ is the pullback of the sheaf
$\mathcal{O}_{\text{Proj}(A)}(d)$ for some $d \geq 1$.
Moreover, since $X$ is quasi-compact we
see that $X$ gets identified with a closed subscheme of a
quasi-compact open subscheme $Y \subset \text{Proj}(A)$.
By Construction, Lemma \ref{constructions-lemma-ample-on-proj}
(see also
Properties, Lemma \ref{properties-lemma-open-in-proj-ample})
we see that $\mathcal{O}_Y(d')$ is an ample invertible sheaf on
$Y$ for some $d' \geq 1$. Since the restriction of an ample
sheaf to a closed subscheme is ample, see
Properties, Lemma \ref{properties-lemma-ample-on-closed}
we conclude that the pullback of
$\mathcal{O}_Y^{d'}$ is ample. Combining these results with
Properties, Lemma \ref{properties-lemma-ample-power-ample}
we conclude that $\mathcal{L}$ is ample as desired.
\end{proof}

\begin{lemma}
\label{lemma-ample-over-affine}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
Assume $S$ affine.
Then $\mathcal{L}$ is $f$-relatively ample if and only
if $\mathcal{L}$ is ample on $X$.
\end{lemma}

\begin{proof}
Immediate from Lemma \ref{lemma-characterize-relatively-ample}
and the definitions.
\end{proof}











\section{Very ample sheaves}
\label{section-very-ample}

\begin{definition}
\label{definition-very-ample}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
We say $\mathcal{L}$ is {\it relatively very ample} or more
precisely {\it $f$-relatively very ample}, or
{\it $\mathcal{L}$ is very ample on $X/S$} if
there exist a quasi-coherent $\mathcal{O}_S$-module
$\mathcal{E}$ and an immersion $i : X \to \mathbf{P}(\mathcal{E})$
over $S$ such that
$\mathcal{L} \cong i^*\mathcal{O}_{\mathbf{P}(\mathcal{E})}(1)$.
\end{definition}

\noindent
Since there is no assumption of quasi-compactness in this definition it is not
true in general that a relatively ample invertible sheaf is a relatively
ample invertible sheaf.

\begin{lemma}
\label{lemma-ample-very-ample}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
If $f$ is quasi-compact and $\mathcal{L}$ is a relatively
very ample invertible sheaf, then $\mathcal{L}$ is a relatively
ample invertible sheaf.
\end{lemma}

\begin{proof}
By definition there exists quasi-coherent $\mathcal{O}_S$-module
$\mathcal{E}$ and an immersion $i : X \to \mathbf{P}(\mathcal{E})$
over $S$ such that
$\mathcal{L} \cong i^*\mathcal{O}_{\mathbf{P}(\mathcal{E})}(1)$.
Set $\mathcal{A} = \text{Sym}(\mathcal{E})$, so
$\mathbf{P}(\mathcal{E}) = \underline{\text{Proj}}_S(\mathcal{A})$
by definition. The graded $\mathcal{O}_S$-algebra $\mathcal{A}$
comes equipped with a map
$$
\psi :
\mathcal{A} \to
\bigoplus\nolimits_{n \geq 0}
\pi_*\mathcal{O}_{\mathbf{P}(\mathcal{E})}(n) \to
\bigoplus\nolimits_{n \geq 0}
f_*\mathcal{L}^{\otimes n}
$$
where the second arrow uses the identification
$\mathcal{L} \cong i^*\mathcal{O}_{\mathbf{P}(\mathcal{E})}(1)$.
By adjointness of $f_*$ and $f^*$ we get a morphism
$\psi : f^*\mathcal{A} \to \bigoplus_{n \geq 0}\mathcal{L}^{\otimes n}$.
We omit the verification that the morphism $r_{\mathcal{L}, \psi}$
associated to this map is exactly the immersion $i$.
Hence the result follows from
part (6) of Lemma \ref{lemma-characterize-relatively-ample}.
\end{proof}

\noindent
To arrive at the correct converse of this lemma we ask
whether given a relatively ample
invertible sheaf $\mathcal{L}$ there exists an integer $n \geq 1$ such
that $\mathcal{L}^{\otimes n}$ is relatively very ample? In general this
is false. There are several things that prevent this from being true:
\begin{enumerate}
\item Even if $S$ is affine, it can happen that no finite integer
$n$ works because $X \to S$ is not of finite type, see
Example \ref{example-not-finite-type-proj}.
\item The base not being quasi-compact means the result can be
prevented from being true even with $f$ finite type. Namely, given
a field $k$ there exists a scheme $X_d$ of finite type over $k$ with
an ample invertible sheaf $\mathcal{O}_{X_d}(1)$ so that the smallest
tensor power of $\mathcal{O}_{X_d}(1)$ which is very ample is the $d$th
power. See Example \ref{example-not-bounded}.
Taking $f$ to be the disjoint union of the schemes $X_d$ mapping
to the disjoint union of copies of $\text{Spec}(k)$ gives an example.
\end{enumerate}

\begin{example}
\label{example-not-finite-type-proj}
Let $k$ be a field.
Consider the graded $k$-algebra
$$
A = k[U, V, Z_1, Z_2, Z_3, \ldots]/I
\quad
\text{with}
\quad
I = (U^2 - Z_1^2, U^4 - Z_2^2, U^6 - Z_3^2, \ldots)
$$
with grading given by $\deg(U) = \deg(V) = \deg(Z_1) = 1$
and $\deg(Z_d) = d$.
Note that $X = \text{Proj}(A)$ is covered by $D_{+}(U)$ and
$D_{+}(V)$. Hence the sheaves $\mathcal{O}_X(n)$ are all
invertible and isomorphic to $\mathcal{O}_X(1)^{\otimes n}$.
In particular $\mathcal{O}_X(1)$ is ample and $f$-ample
for the morphism $f : X \to \text{Spec}(k)$.
We claim that no power of $\mathcal{O}_X(1)$ is $f$-relatively very ample.
Namely, it is easy to see that $\Gamma(X, \mathcal{O}_X(n))$
is the degree $n$ summand of the algebra $A$. Hence if $\mathcal{O}_X(n)$
were very ample, then $X$ would be a closed subscheme of a projective
space over $k$ and hence of finite type over $k$. On the other hand
$D_{+}(V)$ is the spectrum of
$k[t, t_1, t_2, \ldots]/(t^2 - t_1^2, t^4 - t_2^2, t^6 - t_3^2, \ldots)$
which is not of finite type over $k$.
\end{example}

\begin{example}
\label{example-not-bounded}
Let $k$ be an infinite field. Let $\lambda_1, \lambda_2, \lambda_3, \ldots$
be pairwise distinct elements of $k^*$. (This is not strictly necessary,
and in fact the example works perfectly well even if all $\lambda_i$
are equal to $1$.)
Consider the graded $k$-algebra
$$
A_d = k[U, V, Z]/I_d
\quad
\text{with}
\quad
I_d = (Z^2 - \prod\nolimits_{i = 1}^{2d} (U - \lambda_i V)).
$$
with grading given by $\deg(U) = \deg(V) = 1$ and $\deg(Z) = d$.
Then $X_d = \text{Proj}(A_d)$ has ample invertible sheaf
$\mathcal{O}_{X_d}(1)$. We claim that if $\mathcal{O}_{X_d}(n)$
is very ample, then $n \geq d$. The reason for this is that $Z$
has degree $d$, and hence $\Gamma(X_d, \mathcal{O}_{X_d}(n)) = 
k[U, V]_n$ for $n < d$. Details omitted.
\end{example}

\begin{lemma}
\label{lemma-relatively-very-ample-separated}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{L}$ be an invertible sheaf on $X$.
If $\mathcal{L}$ is relatively very ample on $X/S$ then
$f$ is separated.
\end{lemma}

\begin{proof}
Being separated is local on the base (see
Schemes, Section \ref{schemes-section-speration-axioms}).
An immersion is separated
(see Schemes, Lemma \ref{schemes-lemma-immersions-monomorphisms}).
Hence the lemma follows since locally $X$ has an immersion into
the homogeneous spectrum of a graded ring which is separated, see
Constructions, Lemma \ref{constructions-lemma-proj-separated}.
\end{proof}

\begin{lemma}
\label{lemma-relatively-very-ample}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{L}$ be an invertible sheaf on $X$.
Assume $f$ is quasi-compact. The following are
equivalent
\begin{enumerate}
\item $\mathcal{L}$ is relatively very ample on $X/S$,
\item there exists an open covering $S = \bigcup V_j$ such
that $\mathcal{L}|_{f^{-1}(V_j)}$ is relatively very ample
on $f^{-1}(V_j)/V_j$ for all $j$,
\item there exists a quasi-coherent sheaf of graded
$\mathcal{O}_S$-algebras $\mathcal{A}$ generated in degree
$1$ over $\mathcal{O}_S$ and a map of graded $\mathcal{O}_X$-algebras
$\psi : f^*\mathcal{A} \to \bigoplus_{n \geq 0} \mathcal{L}^{\otimes n}$
such that $f^*\mathcal{A}_1 \to \mathcal{L}$ is surjective and the
associated morphism
$r_{\mathcal{L}, \psi} : X \to \underline{\text{Proj}}_S(\mathcal{A})$
is an immersion, and
\item $f$ is quasi-separated, the canonical map
$\psi : f^*f_*\mathcal{L} \to \mathcal{L}$ is surjective, and
the associated map $r_{\mathcal{L}, \psi} : X \to \mathbf{P}(f_*\mathcal{L})$
is an immersion.
\end{enumerate}
\end{lemma}

\begin{proof}
It is clear that (1) implies (2). It is also clear that
(4) implies (1); the hypothesis of quasi-spearation
in (4) is used to garantee that $f_*\mathcal{L}$ is quasi-coherent via
Schemes, Lemma \ref{schemes-lemma-push-forward-quasi-coherent}.

\medskip\noindent
Assume (2).
We will prove (4).
Let $S = \bigcup V_j$ be an open covering as in (2).
Set $X_j = f^{-1}(V_j)$ and $f_j : X_j \to V_j$ the
restriction of $f$. We see that $f$ is separated by
Lemma \ref{lemma-relatively-very-ample-separated} (as being
separated is local on the base). Consider the map
$\psi : f^*f_*\mathcal{L} \to \mathcal{L}$. On each $V_j$ there exists a
quasi-coherent sheaf $\mathcal{E}_j$ and an embedding
$i : X_j \to \mathbf{P}(\mathcal{E}_j)$ with
$\mathcal{L}_{X_j} \cong i^*\mathcal{O}_{\mathbf{P}(\mathcal{E}_j)}(1)$.
In other words there is a map $\mathcal{E}_j \to (f_*\mathcal{L})|_{X_j}$
such that the composition
$$
f_j^*\mathcal{E}_j \to (f^*f_*\mathcal{L})|_{X_j} \to \mathcal{L}|_{X_j}
$$
is surjective. Hence we conclude that $\psi$ is surjective. Let
$r_{\mathcal{L}, \psi} : X \to \mathbf{P}(f_*\mathcal{L})$ be the
associated morphism.
Using the maps $\mathcal{E}_j \to (f_*\mathcal{L})|_{X_j}$
we see that there is a factorization
$$
\xymatrix{
X_j \ar[r]^-{r_{\mathcal{L}, \psi}} &
\mathbf{P}(f_*\mathcal{L})|_{V_j} \ar[r] &
\mathbf{P}(\mathcal{E}_j)
}
$$
which shows that $r_{\mathcal{L}, \psi}$ is an immersion.

\medskip\noindent
At this point we see that (1), (2) and (4) are equivalent.
Clearly (4) implies (3). Assume (3). We will prove (1).
Let $\mathcal{A}$ be a quasi-coherent sheaf of graded $\mathcal{O}_S$-algebras
generated in degree $1$ over $\mathcal{O}_S$. Consider the map of
graded $\mathcal{O}_S$-algebras $\text{Sym}(\mathcal{A}_1) \to \mathcal{A}$.
This is surjective by hypothesis and hence induces a closed immersion
$$
\underline{\text{Proj}}_S(\mathcal{A})
\longrightarrow
\mathbf{P}(\mathcal{A}_1)
$$
which pulls back $\mathcal{O}(1)$ to $\mathcal{O}(1)$,
see (insert future reference here -- but see
Constructions, Lemma \ref{constructions-lemma-surjective-graded-rings-map-proj}
for the case where $S$ is affine). Hence it is clear that
(3) implies (1).
\end{proof}


\begin{lemma}
\label{lemma-quasi-projective-finite-type-over-S}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{L}$ be an invertible sheaf on $X$.
Assume that
\begin{enumerate}
\item the invertible sheaf $\mathcal{L}$ is ample on $X$, and
\item the morphism $X \to S$ is locally of finite type.
\end{enumerate}
Then there exists a $d_0 \geq 1$ such that for every $d \geq d_0$
there exists an $n \geq 0$ and an immersion
$i : X \to \mathbf{P}^n_S$ over $S$ such that
$\mathcal{L}^{\otimes d} \cong i^*\mathcal{O}_{\mathbf{P}^n_S}(1)$.
\end{lemma}

\begin{proof}
Let
$A = \Gamma_*(X, \mathcal{L}) =
\bigoplus_{d \geq 0} \Gamma(X, \mathcal{L}^{\otimes d})$.
By Properties, Proposition \ref{properties-proposition-characterize-ample}
the set of affine opens $X_a$ with $a \in A_{+}$ homogeneous forms
a basis for the topology of $X$. Hence we can find finitely
many such elements $a_0, \ldots, a_n \in A_{+}$ such that
\begin{enumerate}
\item we have $X = \bigcup_{i = 0, \ldots, n} X_{a_i}$,
\item each $X_{a_i}$ is affine, and
\item each $X_{a_i}$ maps into an affine open $V_i \subset S$.
\end{enumerate}
By Morphisms, Lemma \ref{morphisms-lemma-locally-finite-type-characterize}
we see that the ring maps
$\mathcal{O}_S(V_i) \to \mathcal{O}_X(X_{a_i})$ are
of finite type. Hence we can find finitely many
elements $f_{ij} \in \mathcal{O}_X(X_{a_i})$, $j = 1, \ldots, n_i$
which generate $\mathcal{O}_X(X_{a_i})$ as an $\mathcal{O}_S(V_i)$-algebra.
By Properties, Lemma \ref{properties-lemma-invert-s-sections}
we may write each
$f_{ij}$ as $a_{ij}/a_i^{e_{ij}}$ for some
$a_{ij} \in A_{+}$ homogeneous. Let $N$ be a positive integer which
is a common multiple of all the degrees of the elements
$a_i$, $a_{ij}$. Consider the elements
$$
a_i^{N/\deg(a_i)}, \ a_{ij}a_i^{(N/\deg(a_i)) - e_{ij}} \in A_N.
$$
By construction these generate the invertible sheaf
$\mathcal{L}^{\otimes N}$ over $X$. Hence they give rise
to a morphism
$$
j : X \longrightarrow
\mathbf{P}_S^{m}
\quad
\text{with } m = n + \sum n_i
$$
over $S$, see Constructions, Lemma \ref{constructions-lemma-projective-space}
and Definition \ref{constructions-definition-projective-space}.
Note that $j^*\mathcal{O}_{\mathbf{P}_S}(1) = \mathcal{L}^{\otimes N}$.
We rename the homogeneous coordinates $T_0, \ldots, T_n, T_{ij}$
instead of $T_0, \ldots, T_m$.
For $i = 0, \ldots, n$ we have $i^{-1}(D_{+}(T_i)) = X_{a_i}$.
Moreover, pulling back the element $T_{ij}/T_i$ via $j^\sharp$ we
get the element $f_{ij} \in \mathcal{O}_X(X_{a_i})$.
Hence the morphism $j$ restricted to $X_{a_i}$
gives a closed immersion of $X_{a_i}$ into the affine open
$D_{+}(T_i) \cap \mathbf{P}^m_{V_i}$ of $\mathbf{P}^N_S$.
Hence we conclude that the morphism $j$ is an immersion.
This implies the lemma holds for some $d$ and $n$ which is enough
in virtually all applications.

\medskip\noindent
This proves that for one $d_2 \geq 1$
(namely $d_2 = N$ above), some $m \geq 0$ there exists some
immersion $j : X \to \mathbf{P}^m_S$ given by global sections
$s'_0, \ldots, s'_m \in \Gamma(X, \mathcal{L}^{\otimes d_2})$.
By Properties, Proposition \ref{properties-proposition-characterize-ample}
we know there exists an integer
$d_1$ such that $\mathcal{L}^{\otimes d}$ is globally generated
for all $d \geq d_1$. Set $d_0 = d_1 + d_2$. We claim that
the lemma holds with this value of $d_0$. Namely, given
an integer $d \geq d_0$ we may choose $s''_1, \ldots, s''_t
\in \Gamma(X, \mathcal{L}^{\otimes d - d_2})$ which generate
$\mathcal{L}^{\otimes d - d_2}$ over $X$. Set $n = (m + 1)t$ and
denote $s_0, \ldots, s_n$ the collection of sections
$s'_\alpha s''_\beta$, $\alpha = 0, \ldots, m$, 
$\beta = 1, \ldots, t$. These generate $\mathcal{L}^{\otimes d}$
over $X$ and therefore define a morphism
$$
i : X \longrightarrow \mathbf{P}^n_S
$$
such that $i^*\mathcal{O}_{\mathbf{P}^n_S}(1) \cong \mathcal{L}^{\otimes d}$.
We omit the verification that since $j$ was an immersion
also the morphism $i$ so obtained is an immersion also.
(Hint: Segre embedding.)
\end{proof}

\begin{lemma}
\label{lemma-finite-type-over-affine-ample-very-ample}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
Assume $S$ affine and $f$ of finite type.
The following are equivalent
\begin{enumerate}
\item $\mathcal{L}$ is ample on $X$,
\item $\mathcal{L}$ is $f$-ample,
\item $\mathcal{L}^{\otimes d}$ is $f$-very ample for some $d \geq 1$,
\item $\mathcal{L}^{\otimes d}$ is $f$-very ample for all $d \gg 1$.
\end{enumerate}
\end{lemma}

\begin{proof}
This is immediate on combining Lemmas \ref{lemma-ample-over-affine},
\ref{lemma-ample-very-ample} and
\ref{lemma-quasi-projective-finite-type-over-S} and the
definitions.
\end{proof}

\begin{lemma}
\label{lemma-finite-type-ample-very-ample}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
Assume $S$ quasi-compact and $f$ of finite type.
The following are equivalent
\begin{enumerate}
\item $\mathcal{L}$ is $f$-ample,
\item $\mathcal{L}^{\otimes d}$ is $f$-very ample for some $d \geq 1$,
\item $\mathcal{L}^{\otimes d}$ is $f$-very ample for all $d \gg 1$.
\end{enumerate}
\end{lemma}

\begin{proof}
Trivially (3) implies (2). Lemma \ref{lemma-ample-very-ample} garantees that
(2) implies (1) since a morphism of finite type is quasi-compact
by definition. Assume that $f$ is ample. Choose a finite affine open
covering $S = V_1 \cup \ldots \cup V_m$. Write $X_i = f^{-1}(V_i)$.
By Lemma \ref{lemma-finite-type-over-affine-ample-very-ample} above we see
there exists a $d_0$ such that $\mathcal{L}^{\otimes d}$ is
relatively very ample on $X_i/V_i$ for all $d \geq d_0$. Hence we conclude
(1) implies (3) by Lemma \ref{lemma-relatively-very-ample}.
\end{proof}














\section{Quasi-projective morphisms}
\label{section-quasi-projective}

\noindent
The discussion in the previous section suggests the following definitions.
We take our definition of quasi-projective from \cite{EGA}. The version
with the letter ``H'' is the definition in \cite{H}.

\begin{definition}
\label{definition-quasi-projective}
Let $f : X \to S$ be a morphism of schemes.
\begin{enumerate}
\item We say $f$ is {\it quasi-projective} if $f$ is of finite type
and there exists an $f$-relatively ample invertible $\mathcal{O}_X$-module.
\item We say $f$ is {\it H-quasi-projective} if $f$ if there exists
a quasi-compact immersion $X \to \mathbf{P}^n_S$ over $S$ for some $n$.
\footnote{This is not exactly the same as the definition in Harthorne.
Namely, the definition in Hartshorne (8th corrected printing, 1997) is that
$f$ should be the composition of an open immersion followed by a H-projective
morphism (see Definition \ref{definition-projective}), which does not imply
$f$ is quasi-compact. See
Lemma \ref{lemma-H-quasi-projective-open-H-projective} for
the implication in the other direction.}
\item We say $f$ is {\it locally quasi-projective} if there exists
an open covering $S = \bigcup V_j$ such that each $f^{-1}(V_j) \to V_j$
is quasi-projective.
\end{enumerate}
\end{definition}

\noindent
As this definition suggests the property of being quasi-projective
is not local on $S$.

\begin{lemma}
\label{lemma-quasi-projective-properties}
Let $f : X \to S$ be a morphism of schemes. If $f$ is quasi-projective,
or H-quasi-projective or locally quasi-projective, then $f$ is
separated of finite type.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-H-quasi-projective-quasi-projective}
A H-quasi-projective morphism is quasi-projective.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-characterize-locally-quasi-projective}
Let $f : X \to S$ be a morphism of schemes.
The following are equivalent:
\begin{enumerate}
\item The morphism $f$ is locally projective.
\item There exists an open covering $S = \bigcup V_j$ such
that each $f^{-1}(V_j) \to V_j$ is H-quasi-projective.
\end{enumerate}
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-H-quasi-projective-quasi-projective}
we see that (2) implies (1). Assume (1).
The question is local on $S$ and hence we may assume $S$ is affine,
$X$ of finite type over $S$ and
$\mathcal{L}$ is a relatively very ample invertible sheaf on $X/S$.
By Lemma \ref{lemma-quasi-projective-finite-type-over-S} we see that there
exists an immersion of $X$ into
a projective space over $S$, i.e., $X$ is H-quasi-projective over $S$
as desired.
\end{proof}





\section{Proper morphisms}
\label{section-proper}

\noindent
The notion of a proper morphism plays an important role in algebraic
geometry. An important example of a proper morphism will be the
structure morphism $\mathbf{P}^n_S \to S$ of projective $n$-space,
and this is in fact the motivating example leading to the definition.

\begin{definition}
\label{definition-proper}
Let $f : X \to S$ be a morphism of schemes.
We say $f$ is {\it proper} if $f$ is separated, finite type, and
universally closed.
\end{definition}

\noindent
In the rest of this section we prove some of the basic properties
of proper morphisms and of universally closed morphisms.

\begin{lemma}
\label{lemma-universally-closed-local-on-the-base}
Let $f : X \to S$ be a morphism of schemes.
The following are equivalent:
\begin{enumerate}
\item The morphism $f$ is universally closed.
\item There exists an open covering $S = \bigcup V_j$ such
that $f^{-1}(V_j) \to V_j$ is universally closed for all indices $j$.
\end{enumerate}
\end{lemma}

\begin{proof}
This is clear from the definition.
\end{proof}

\begin{lemma}
\label{lemma-proper-local-on-the-base}
Let $f : X \to S$ be a morphism of schemes.
The following are equivalent:
\begin{enumerate}
\item The morphism $f$ is proper.
\item There exists an open covering $S = \bigcup V_j$ such
that $f^{-1}(V_j) \to V_j$ is proper for all indices $j$.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-composition-proper}
The composition of proper morphisms is proper.
The same is true for universally closed morphisms.
\end{lemma}

\begin{proof}
A composition of closed morphisms is closed.
If $X \to Y \to Z$ are universally closed morphisms
and $Z' \to Z$ is any morphism, then we see that
$Z' \times_Z X = (Z' \times_Z Y) \times_Y X  \to Z' \times_Z Y$
is closed and $Z' \times_Z Y \to Z'$ is closed.
Hence the result for universally closed morphisms.
We have seen that ``separated'' and ``finite type''
are preserved under compositions
(Schemes, Lemma \ref{schemes-lemma-separated-permanence} and
Lemma \ref{lemma-composition-finite-type}). Hence the
result for proper morphisms.
\end{proof}

\begin{lemma}
\label{lemma-base-change-proper}
The base change of a proper morphism is proper.
The same is true for universally closed morphisms.
\end{lemma}

\begin{proof}
This is true by definition for universally closed morphisms.
It is true for separated morphisms
(Schemes, Lemma \ref{schemes-lemma-separated-permanence}).
It is true for morphisms of finite type
(Lemma \ref{lemma-base-change-finite-type}).
Hence it is true for proper morphisms.
\end{proof}

\begin{lemma}
\label{lemma-closed-immersion-proper}
A closed immersion is proper, hence a fortiori universally closed.
\end{lemma}

\begin{proof}
The base change of a closed immersion is a closed immersion
(Schemes, Lemma \ref{schemes-lemma-base-change-immersion}).
Hence it is universally closed.
A closed immersion is separated
(Schemes, Lemma \ref{schemes-lemma-immersions-monomorphisms}).
A closed immersion is of finite type
(Lemma \ref{lemma-immersion-locally-finite-type}).
Hence a closed immersion is proper.
\end{proof}

\begin{lemma}
\label{lemma-image-proper-scheme-closed}
Suppose given a commutative diagram of schemes
$$
\xymatrix{
X \ar[rr] \ar[rd] & &
Y \ar[ld] \\
& S &
}
$$
with $Y$ separated over $S$.
\begin{enumerate}
\item If $X \to S$ is universally closed, then the morphism
$X \to Y$ is universally closed.
\item If $X$ proper over $S$, then the morphism $X \to Y$ is proper.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume that $X \to S$ is universally closed (resp.\ proper).
We factor the morphism as $X \to X \times_S Y \to Y$.
The first morphism is a closed immersion, see
Schemes, Lemma \ref{schemes-lemma-semi-diagonal}.
Hence the first morphism is proper (Lemma \ref{lemma-closed-immersion-proper}).
The projection $X \times_S Y \to Y$ is the base change
of a unviversally closed (resp.\ proper) morphism and hence
universally closed (resp.\ proper), see Lemma \ref{lemma-base-change-proper}.
Thus $X \to Y$ is universally closed (resp.\ proper) as the composition
of universally closed (resp.\ proper) morphisms
(Lemma \ref{lemma-composition-proper}).
\end{proof}







\section{Projective morphisms}
\label{section-projective}

\noindent
We will use the definition of a projective morphism from \cite{EGA}.
The version of the definition with the ``H'' is the one
from \cite{H}. The resulting definitions are different. Both are useful.

\begin{definition}
\label{definition-projective}
Let $f : X \to S$ be a morphism of schemes.
\begin{enumerate}
\item We say $f$ is {\it projective} if $X$ is isomorphic as
an $S$-scheme to a closed subscheme of a projective
bundle $\mathbf{P}(\mathcal{E})$ (see
Constructions, Definition \ref{constructions-definition-projective-bundle})
for some quasi-coherent, finite type $\mathcal{O}_S$-module $\mathcal{E}$.
\item We say $f$ is {\it H-projective} if there exists and integer $n$ and
a closed immersion $X \to \mathbf{P}^n_S$ over $S$.
\item We say $f$ is {\it locally projective} if there exists an open
covering $S = \bigcup U_i$ such that each $f^{-1}(U_i) \to U_i$ is
projective.
\end{enumerate}
\end{definition}

\begin{lemma}
\label{lemma-H-projective}
An H-projective morphism is projective.
\end{lemma}

\begin{proof}
This is true as $\mathbf{P}^n_S$ is a projective bundle over $S$, see
Constructions, Lemma \ref{constructions-lemma-projective-space-bundle}.
\end{proof}

\begin{lemma}
\label{lemma-H-quasi-projective-open-H-projective}
Let $f : X \to S$ be a H-quasi-projective morphism.
Then $f$ factors as $X \to X' \to S$ where $X \to X'$ is an
open immersion and $X' \to S$ is H-projective.
\end{lemma}

\begin{proof}
By definition we can factor $f$ as a quasi-compact immersion
$i : X \to \mathbf{P}^n_S$ followed by the projection $\mathbf{P}^n_S \to S$.
By Lemma \ref{lemma-quasi-compact-immersion} there exists a closed
subscheme $X' \subset \mathbf{P}^n_S$ such that $i$ factors through
an open immersion $X \to X'$. The lemma follows.
\end{proof}

\begin{lemma}
\label{lemma-characterize-locally-projective}
Let $f : X \to S$ be a morphism of schemes.
The following are equivalent:
\begin{enumerate}
\item The morphism $f$ is locally projective.
\item There exists an open covering $S = \bigcup U_i$ such
that each $f^{-1}(U_i) \to U_i$ is H-projective.
\end{enumerate}
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-H-projective} we see that (2) implies (1). Assume (1).
For every point $s \in S$ we can find $\text{Spec}(R) = U \subset S$
an affine open neighbourhood of $s$ such that $X_U$ is isomorphic to a
closed subscheme of $\mathbf{P}(\mathcal{E})$ for some finite type,
quasi-coherent sheaf of $\mathcal{O}_U$-modules $\mathcal{E}$.
Write $\mathcal{E} = \widetilde{M}$ for some finite type
$R$-module $M$ (see
Properties, Lemma \ref{properties-lemma-finite-type-module}).
Choose generators $x_0, \ldots, x_n \in M$ of $M$ as an $R$-module.
Consider the surjective graded $R$-algebra map
$$
R[X_0, \ldots, X_n] \longrightarrow \text{Sym}_R(M).
$$
According to
Constructions, Lemma \ref{constructions-lemma-surjective-graded-rings-map-proj}
the corresponding morphism
$$
\mathbf{P}(\mathcal{E}) \to \mathbf{P}^n_R
$$
is a closed immersion. Hence we conclude that $f^{-1}(U)$ is isomorphic
to a closed subscheme of $\mathbf{P}^n_U$ (as a scheme over $U$).
In other words: (2) holds.
\end{proof}

\begin{lemma}
\label{lemma-locally-projective-proper}
A locally projective morphism is proper.
\end{lemma}

\begin{proof}
Let $f : X \to S$ be locally projective.
In order to show that $f$ is proper we may work locally on the
base, see Lemma \ref{lemma-proper-local-on-the-base}.
Hence, by Lemma \ref{lemma-characterize-locally-projective}
above we may assume there exists a closed immersion $X \to \mathbf{P}^n_S$.
By Lemmas \ref{lemma-composition-proper}
and \ref{lemma-closed-immersion-proper} it suffices to prove that
$\mathbf{P}^n_S \to S$ is proper. Since
$\mathbf{P}^n_S \to S$ is the base change of
$\mathbf{P}^n_{\mathbf{Z}} \to \text{Spec}(\mathbf{Z})$ it suffices
to show that $\mathbf{P}^n_{\mathbf{Z}} \to \text{Spec}(\mathbf{Z})$
is proper, see Lemma \ref{lemma-base-change-proper}.
By Constructions, Lemma \ref{constructions-lemma-proj-separated} the scheme
$\mathbf{P}^n_{\mathbf{Z}}$ is separated.
By Constructions, Lemma \ref{constructions-lemma-proj-quasi-compact} the scheme
$\mathbf{P}^n_{\mathbf{Z}}$ is quasi-compact.
It is clear that $\mathbf{P}^n_{\mathbf{Z}} \to \text{Spec}(\mathbf{Z})$
is locally of finite type since $\mathbf{P}^n_{\mathbf{Z}}$ is
covered by the affine opens $D_{+}(X_i)$ each of which is the
spectrum of the finite type $\mathbf{Z}$-algebra
$$
\mathbf{Z}[X_0/X_i, \ldots, X_n/X_i].
$$
Finally, we have to show that
$\mathbf{P}^n_{\mathbf{Z}} \to \text{Spec}(\mathbf{Z})$
is universally closed. This follows from
Constructions, Lemma \ref{constructions-lemma-proj-valuative-criterion}
and the valuative criterion (see Schemes,
Proposition \ref{schemes-proposition-characterize-universally-closed}).
\end{proof}

\begin{lemma}
\label{lemma-segre-embedding}
Let $S$ be a scheme. There exists a closed immersion
$$
\mathbf{P}^n_S \times_S \mathbf{P}^m_S
\longrightarrow
\mathbf{P}^{nm + n + m}_S
$$
called the {\it Segre embedding}.
\end{lemma}

\begin{proof}
It suffices to prove this when $S = \text{Spec}(\mathbf{Z})$.
Hence we will drop the index $S$ and work in the absolute setting.
Write $\mathbf{P}^n = \text{Proj}(\mathbf{Z}[X_0, \ldots, X_n])$,
$\mathbf{P}^m = \text{Proj}(\mathbf{Z}[Y_0, \ldots, Y_m])$,
and
$\mathbf{P}^{nm + n + m} =
\text{Proj}(\mathbf{Z}[Z_0, \ldots, Z_{nm + n + m}])$.
In order to map into $\mathbf{P}^{nm + n + m}$ we have to
write down an invertible sheaf $\mathcal{L}$ on the left hand
side and $(n + 1)(m + 1)$ sections $s_i$ which generate it.
See Constructions, Lemma \ref{constructions-lemma-projective-space}.
The invertible sheaf we take is
$$
\mathcal{L} =
\text{pr}_1^*\mathcal{O}_{\mathbf{P}^n}(1)
\otimes
\text{pr}_2^*\mathcal{O}_{\mathbf{P}^m}(1)
$$
The sections we take are
$$
s_0 = X_0Y_0, \ s_1 = X_1Y_0, \ldots, \ s_n = X_nY_0, \ 
s_{n + 1} = X_0Y_1, \ldots, \ s_{nm + n + m} = X_nY_m.
$$
These generate $\mathcal{L}$ since the sections $X_i$ generate
$\mathcal{O}_{\mathbf{P}^n}(1)$ and the sections $Y_j$ generate
$\mathcal{O}_{\mathbf{P}^m}(1)$. The induced morphism
$\varphi$ has the property that
$$
\varphi^{-1}(D_{+}(Z_{i + (n + 1)j})) = D_{+}(X_i) \times D_{+}(Y_j).
$$
Hence it is an affine morphism. The corresponding ring map in case
$(i, j) = (0, 0)$ is the map
$$
\mathbf{Z}[Z_1/Z_0, \ldots, Z_{nm + n + m}/Z_0]
\longrightarrow
\mathbf{Z}[X_1/X_0, \ldots, X_n/X_0, Y_1/Y_0, \ldots, Y_n/Y_0]
$$
which maps $Z_i/Z_0$ to the element $X_i/X_0$ for $i \leq n$ and
the element $Z_{(n + 1)j}/Z_0$ to the element $Y_j/Y_0$. Hence it
is surjective. A similar argument works for the other affine
open subsets. Hence the morphism $\varphi$ is a closed immersion.
\end{proof}

\begin{lemma}
\label{lemma-H-projective-composition}
A composition of H-projective morphisms is projective.
\end{lemma}

\begin{proof}
Suppose $X \to Y$ and $Y \to Z$ are H-projective.
Then there exist closed immersions $X \to \mathbf{P}^n_Y$
over $Y$, and $Y \to \mathbf{P}^m_Z$ over $Z$.
Consider the following diagram
$$
\xymatrix{
X \ar[r] \ar[d] &
\mathbf{P}^n_Y \ar[r] \ar[dl] &
\mathbf{P}^n_{\mathbf{P}^m_Z} \ar[dl] \ar@{=}[r] &
\mathbf{P}^n_Z \times_Z \mathbf{P}^m_Z \ar[r] &
\mathbf{P}^{nm + n + m}_Z \ar[ddllll] \\
Y \ar[r] \ar[d] & \mathbf{P}^m_Z \ar[dl] & \\
Z & &
}
$$
Here the rightmost top horizontal arrow is the Segre embedding,
see Lemma \ref{lemma-segre-embedding}. The diagram identifies
$X$ as a closed subscheme of $\mathbf{P}^{nm + n + m}_Z$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-H-projective-base-change}
A base change of a H-projective morphism is H-projective.
\end{lemma}

\begin{proof}
This is true because the base change of projective space
over a scheme is projective space, and the fact that the base
change of a closed immersion is a closed immersion, see
Schemes, Lemma \ref{schemes-lemma-base-change-immersion}.
\end{proof}











\section{Integral and finite morphisms}
\label{section-integral}

\noindent
Recall that a ring map $R \to A$ is said to be {\it integral}
if every element of $A$ satisfies a monic equation with
coefficients in $R$. Recall that a ring map $R \to A$ is
said to be finite if $A$ is {\it finite} as an $R$-module.
See Algebra, Definition \ref{algebra-definition-integral-ring-map}.

\begin{definition}
\label{definition-integral}
Let $f : X \to S$ be a morphism of schemes.
\begin{enumerate}
\item We say that $f$ is {\it integral} if $f$ is affine
and if for every affine open $\text{Spec}(R) = V \subset S$
with inverse image $\text{Spec}(A) = f^{-1}(V) \subset X$
the associated ring map $R \to A$ is integral.
\item We say that $f$ is {\it finite} if $f$ is affine
and if for every affine open $\text{Spec}(R) = V \subset S$
with inverse image $\text{Spec}(A) = f^{-1}(V) \subset X$
the associated ring map $R \to A$ is finite.
\end{enumerate}
\end{definition}

\noindent
It is clear that integral/finite morphisms are separated and
quasi-compact. It is also clear that a finite morphism is a
morphism of finite type. Most of the lemmas in this section are
completely standard.
But note the fun Lemma \ref{lemma-integral-universally-closed}
at the end of the section.

\begin{lemma}
\label{lemma-integral-local}
Let $f : X \to S$ be a morphism of schemes.
The following are equivalent:
\begin{enumerate}
\item The morphism $f$ is integral.
\item There exists an affine open covering $S = \bigcup U_i$ such that
each $f^{-1}(U_i)$ is affine and
$\mathcal{O}_S(U_i) \to \mathcal{O}_X(f^{-1}(U_i))$ is integral.
\item There exists an open covering $S = \bigcup S_j$
such that each $f^{-1}(U_i) \to U_i$ is integral.
\end{enumerate}
Moreover, if $f$ is integral then for every open subscheme
$U \subset S$ the morphim $f : f^{-1}(U) \to U$ is integral.
\end{lemma}

\begin{proof}
See Algebra, Lemma \ref{algebra-lemma-integral-local}.
Some details omitted.
\end{proof}

\begin{lemma}
\label{lemma-finite-local}
Let $f : X \to S$ be a morphism of schemes.
The following are equivalent:
\begin{enumerate}
\item The morphism $f$ is finite.
\item There exists an affine open covering $S = \bigcup U_i$ such that
each $f^{-1}(U_i)$ is affine and
$\mathcal{O}_S(U_i) \to \mathcal{O}_X(f^{-1}(U_i))$ is finite.
\item There exists an open covering $S = \bigcup S_j$
such that each $f^{-1}(U_i) \to U_i$ is finite.
\end{enumerate}
Moreover, if $f$ is finite then for every open subscheme
$U \subset S$ the morphim $f : f^{-1}(U) \to U$ is finite.
\end{lemma}

\begin{proof}
See Algebra, Lemma \ref{algebra-lemma-integral-local}.
Some details omitted.
\end{proof}

\begin{lemma}
\label{lemma-finite-integral}
A finite morphism is integral.
An integral morphism which is locally of finite type is finite.
\end{lemma}

\begin{proof}
See Algebra, Lemma \ref{algebra-lemma-finite-is-integral}
and Lemma \ref{algebra-lemma-characterize-finite-in-terms-of-integral}.
\end{proof}

\begin{lemma}
\label{lemma-composition-finite}
A composition of finite morphisms is finite.
Same is true for integral morphisms.
\end{lemma}

\begin{proof}
See Algebra, Lemmas \ref{algebra-lemma-finite-transitive}
and \ref{algebra-lemma-integral-transitive}.
\end{proof}

\begin{lemma}
\label{lemma-base-change-finite}
A base change of a finite morphism is finite.
Same is true for integral morphisms.
\end{lemma}

\begin{proof}
See Algebra, Lemma \ref{algebra-lemma-base-change-integral}.
\end{proof}

\begin{lemma}
\label{lemma-integral-universally-closed}
Let $f : X \to S$ be a morphism of schemes.
The following are equivalent
\begin{enumerate}
\item $f$ is integral, and
\item $f$ is affine and universally closed.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume (1). An integral morphism is affine by definition.
A base change of an integral morphism is integral so in order to prove (2)
it suffices to show that an integral morphism is closed.
This follows from Algebra, Lemmas \ref{algebra-lemma-integral-going-up}
and \ref{algebra-lemma-going-up-closed}.

\medskip\noindent
Assume (2). We may assume that $f$ is the morphism
$f : \text{Spec}(A) \to \text{Spec}(R)$ coming from a ring
map $R \to A$. Choose $a \in A$. We have to show that $a$
is integral over $R$. Let $I \subset R[x]$ be the ideal of
polynomials $P$ such that $P(a) = 0$ in $A$. Consider the commutative
diagram
$$
\xymatrix{
\text{Spec}(A) \ar[r]_-\varphi \ar[rd]_f &
\text{Spec}(R[x]) = \mathbf{A}^1_R \ar[r] \ar[d] &
\mathbf{P}^1_R  \ar[ld] \\
& \text{Spec}(R) &
}
$$
where $\varphi$ comes from the ring map $R[x] \to A$, $x \mapsto a$.
Since $f$ is universally closed we see that the image of $\varphi$
is closed in $\mathbf{P}^1_R$
(see Lemma \ref{lemma-image-proper-scheme-closed}). Working
out what this means we see that the ideal
$$
I' = \{ y^{\deg(P)}P(y^{-1}) \mid P(x) \in I \} \subset R[y]
$$
has the property that $I'$ surjects onto $R = R[y]/yR[y]$.
Translating back to $I$ this means exactly that $I$ contains
a monic polynomial as desired.
\end{proof}

\begin{lemma}
\label{lemma-finite-proper}
A finite morphism is proper.
\end{lemma}

\begin{proof}
A finite morphism is integral and hence universally closed by
Lemma \ref{lemma-integral-universally-closed}. It is also
clearly separated and of finite type. Hence it is proper by
definition.
\end{proof}










\section{Finite locally free morphisms}
\label{section-finite-locally-free}

\noindent
We put this for want of a better spot to put it in.

\begin{definition}
\label{definition-finite-locally-free}
Let $f : X \to S$ be a morphism of schemes.
We say $f$ is {\it finite locally free} if $f$ is
affine and $f_*\mathcal{O}_X$ is a finite locally
free $\mathcal{O}_S$-module.
\end{definition}

\noindent
This is {\bf not} the same thing as a finite flat morphism due to
the existence of finite flat but not free modules (over a general
ring). It is the same as a finite flat morphism in the locally
Noetherian case. See below.

\begin{lemma}
\label{lemma-finite-flat}
Let $f : X \to S$ be a morphism of schemes.
The following are equivalent:
\begin{enumerate}
\item $f$ is finite locally free,
\item $f$ is finite, flat, and locally of finite presentation.
\end{enumerate}
If $S$ is locally Noetherian these are also equivalent to
\begin{enumerate}
\item[(3)] $f$ is finite and flat.
\end{enumerate}
\end{lemma}

\begin{proof}
See Algebra, Lemma \ref{algebra-lemma-finite-projective}.
The Noetherian case follows also since a finite module
over a Noetherian ring is a finitely presented module.
\end{proof}

\begin{lemma}
\label{lemma-composition-finite-locally-free}
A composition of finite locally free morphisms is finite locally free.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-base-change-finite-locally-free}
A base change of a finite locally free morphism is finite locally free.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}


























\input{chapters}

\bibliography{my}
\bibliographystyle{alpha}

\end{document}
