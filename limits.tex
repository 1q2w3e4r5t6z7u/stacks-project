\input{preamble}

% OK, start here.
%
\begin{document}

\title{Limits of Schemes}


\maketitle

\phantomsection
\label{section-phantom}

\tableofcontents

\section{Introduction}
\label{section-introduction}

\noindent
In this chapter we put material related to limits of schemes. We mostly
study limits of inverse systems over directed partially ordered sets
with affine transition maps. We discuss absolute Noetherian
approximation. We characterize schemes locally of finite presentation
over a base as those whose associated functor of points is limit
preserving. As an application of absolute Noetherian approximation
we prove that the image of an affine under an integral morphism is affine.
Moreover, we prove some very general variants of Chow's lemma.
A basic reference is \cite{EGA}.




\section{Directed limits of schemes with affine transition maps}
\label{section-limits}

\noindent
In this section we construct the limit.

\begin{lemma}
\label{lemma-directed-inverse-system-affine-schemes-has-limit}
Let $I$ be a directed partially ordered set.
Let $(S_i, f_{ii'})$ be an inverse system of
schemes over $I$.  If all the schemes $S_i$
are affine, then the limit $S = \lim_i S_i$ exists
in the category of schemes.
In fact $S$ is affine and $S = \Spec(\colim_i R_i)$
with $R_i = \Gamma(S_i, \mathcal{O})$.
\end{lemma}

\begin{proof}
Just define $S = \Spec(\colim_i R_i)$.
It follows from Schemes, Lemma \ref{schemes-lemma-morphism-into-affine}
that $S$ is the limit even in the category of locally ringed spaces.
\end{proof}

\begin{lemma}
\label{lemma-directed-inverse-system-has-limit}
Let $I$ be a directed partially ordered set. Let $(S_i, f_{ii'})$ be an
inverse system of schemes over $I$. If all the morphisms
$f_{ii'} : S_i \to S_{i'}$ are affine, then the limit $S = \lim_i S_i$ exists
in the category of schemes. Moreover,
\begin{enumerate}
\item each of the morphisms $f_i : S \to S_i$ is affine,
\item for any $i \in I$ and any open subscheme $U_i \subset S_i$
we have
$$
f_i^{-1}(U_i) = \lim_{i' \geq i} f_{i'i}^{-1}(U_i)
$$
in the category of schemes.
\end{enumerate}
\end{lemma}

\begin{proof}
Choose an element $0 \in I$. Note that $I$ is nonempty as the limit is
directed. For every $i \geq 0$ consider the quasi-coherent sheaf of
$\mathcal{O}_{S_0}$-algebras $\mathcal{A}_i = f_{i0, *}\mathcal{O}_{S_i}$.
Recall that $S_i = \underline{\Spec}_{S_0}(\mathcal{A}_i)$,
see Morphisms, Lemma \ref{morphisms-lemma-characterize-affine}.
Set $\mathcal{A} = \colim_{i \geq 0} \mathcal{A}_i$.
This is a quasi-coherent sheaf of $\mathcal{O}_{S_0}$-algebras,
see Schemes, Section \ref{schemes-section-quasi-coherent}.
Set $S = \underline{\Spec}_{S_0}(\mathcal{A})$.
By Morphisms, Lemma \ref{morphisms-lemma-affine-equivalence-algebras}
we get for $i \geq 0$ morphisms $f_i : S \to S_i$ compatible with
the transition morphisms. Note that the morphisms $f_i$ are
affine by Morphisms, Lemma \ref{morphisms-lemma-affine-permanence} for example.
By Lemma \ref{lemma-directed-inverse-system-affine-schemes-has-limit} above
we see that for any affine open $U_0 \subset S_0$ the
inverse image $U = f_0^{-1}(U_0) \subset S$ is the limit of the
system of opens $U_i = f_{i0}^{-1}(U_0)$, $i \geq 0$ in the
category of schemes.

\medskip\noindent
Let $T$ be a scheme. Let $g_i : T \to S_i$ be a compatible system
of morphisms. To show that $S = \lim_i S_i$ we have
to prove there is a unique morphism $g : T \to S$ with
$g_i = f_i \circ g$ for all $i \in I$.
For every $t \in T$ there exists an affine open
$U_0 \subset S_0$ containing $g_0(t)$. Let $V \subset g_0^{-1}(U_0)$
be an affine open neighbourhood containing $t$.
By the remarks above we obtain a unique morphism
$g_V : V \to U = f_0^{-1}(U_0)$ such that $f_i \circ g_V = g_i|_{U_i}$
for all $i$. The open sets $V \subset T$ so constructed form
a basis for the topology of $T$. The morphisms $g_V$ glue to a morphism
$g : T \to S$ because of the uniqueness property. This gives the
desired morphism $g : T \to S$.

\medskip\noindent
We omit the proof of the final statement.
\end{proof}

\begin{lemma}
\label{lemma-topology-limit}
Let $I$ be a directed partially ordered set.
Let $(S_i, f_{ii'})$ be an inverse system of schemes over $I$.
Assume all the morphisms $f_{ii'} : S_i \to S_{i'}$ are affine,
Let $S = \lim_i S_i$.
\begin{enumerate}
\item We have $S_{set} = \lim_i S_{i, set}$ where $S_{set}$
indicates the underlying set of the scheme $S$.
\item If $s, s' \in S$ and $s'$ is not a specialization of $s$
then for some $i \in I$ the image $s'_i \in S_i$ of $s'$ is not
a specialization of the image $s_i \in S_i$ of $s$.
\item Add more easy facts on topology of $S$ here.
(Requirement: whatever is added should be easy in the affine case.)
\end{enumerate}
\end{lemma}

\begin{proof}
Proof of (1). Pick $i \in I$.
Take $U_i \subset S_i$ an affine open.
Denote $U_{i'} = f_{i'i}^{-1}(U_i)$ and $U = f_i^{-1}(U_i)$.
Suppose we can show that
$U_{set} = \lim_{i' \geq i} U_{i', set}$. Then assertion
(1) follows by a simple argument using an affine covering of $S_i$.
Hence we may assume all $S_i$ and $S$ affine.
This reduces us to the following algebra question:
Suppose given a system of rings $(A_i, \varphi_{ii'})$ over $I$. Set
$A = \colim_i A_i$ with canonical maps $\varphi_i : A_i \to A$.
Then
$$
\Spec(A) = \lim_i \Spec(A_i)
$$
Namely, suppose that we are given primes $\mathfrak p_i \subset A_i$
such that $\mathfrak p_i = \varphi_{ii'}^{-1}(\mathfrak p_{i'})$
for all $i' \geq i$. Then we simply set
$$
\mathfrak p =
\{x \in A
\mid
\exists i, x_i \in \mathfrak p_i \text{ with }\varphi(x_i) = x\}
$$
It is clear that this is an ideal and has the property that
$\varphi_i^{-1}(\mathfrak p) = \mathfrak p_i$. Then it follows
easily that it is a prime ideal as well. This proves (1).

\medskip\noindent
Proof of (2). Pick $i \in I$. Pick an affine open $U_i \subset S_i$
containing $f_i(s')$. If $f_i(s) \not \in S_i$ then we
are done. Hence reduce to the affine case by considering the inverse
images of $U_i$ as above.
This reduces us to the following algebra question:
Suppose given a system of rings $(A_i, \varphi_{ii'})$ over $I$. Set
$A = \colim_i A_i$ with canonical maps $\varphi_i : A_i \to A$.
Suppose given primes $\mathfrak p$, $\mathfrak p'$ of $A$.
Suppose that $\mathfrak p \not \subset \mathfrak p'$.
Then for some $i$ we have
$\varphi_i^{-1}(\mathfrak p) \not \subset \varphi_i^{-1}(\mathfrak p')$.
This is clear.
\end{proof}

\begin{lemma}
\label{lemma-scheme-over-limit}
Let $I$ be a directed partially ordered set.
Let $(S_i, f_{ii'})$ be an inverse system of schemes over $I$.
Assume all the morphisms $f_{ii'} : S_i \to S_{i'}$ are affine,
Let $S = \lim_i S_i$. Let $i \in I$.
Suppose that $X_i$ is a scheme over $S_i$.
Set $X_j = S_j \times_{S_i} X_i$ for $j \geq i$ and set
$X = S \times_{S_i} X_i$.
Then
$$
X = \lim_{j \geq i} X_j
$$
\end{lemma}

\begin{proof}
The transition morphisms of the system $\{X_j\}_{j \geq i}$ are
affine as they are base changes of the affine morphisms between
the $S_j$, see Morphisms, Lemma \ref{morphisms-lemma-base-change-affine}.
Hence we know the limit of the system $\{X_j\}_{j \geq i}$
exists. There is a canonical morphism $X \to \lim X_j$.
To see that it is an isomorphism we may work locally.
Hence we may assume that $X_i = \Spec(B_i)$ is an affine such that
the morphism $X_i \to S_i$ has image contained in an affine open
subscheme $U$ of $S_i$. In this case we may also replace each $S_j$
by the inverse image of $U$ in $S_j$, in other words we may assume
all the $S_j = \Spec(A_j)$ are affine. Then we have
$X_j = \Spec(A_j \otimes_{A_i} B_i)$. In this case the statement
becomes the equality
$$
\colim_{j \geq i} (A_j \otimes_{A_i} B_i) =
(\colim_{j \geq i} A_j) \otimes_{A_i} B_i
$$
which follows from
Algebra, Lemma \ref{algebra-lemma-tensor-products-commute-with-limits}.
\end{proof}


\begin{lemma}
\label{lemma-descend-section}
Let $I$ be a directed partially ordered set.
Let $(S_i, f_{ii'})$ be an inverse system of schemes over $I$.
Assume
\begin{enumerate}
\item all the morphisms $f_{ii'} : S_i \to S_{i'}$ are affine,
\item all the schemes $S_i$ are quasi-compact and quasi-separated.
\end{enumerate}
Let $S = \lim_i S_i$. Let $i \in I$.
Suppose that $\mathcal{F}_i$ is a quasi-coherent sheaf on $S_i$.
Set $\mathcal{F}_j = f_{ji}^*\mathcal{F}_i$ for $j \geq i$ and set
$\mathcal{F} = f_i^*\mathcal{F}_i$.
Then
$$
\Gamma(S, \mathcal{F}) = \colim_{j \geq i} \Gamma(S_j, \mathcal{F}_j)
$$
\end{lemma}

\begin{proof}
Write $\mathcal{A}_j = f_{ji, *} \mathcal{O}_{S_j}$.
This is a quasi-coherent sheaf of $\mathcal{O}_{S_i}$-algebras
(see Morphisms, Lemma \ref{morphisms-lemma-affine-equivalence-algebras})
and $S_j$ is the relative spectrum of $\mathcal{A}_j$ over $S_i$.
In the proof of Lemma \ref{lemma-directed-inverse-system-has-limit}
we constructed $S$ as the relative spectrum of
$\mathcal{A} = \colim_{j \geq i} \mathcal{A}_j$
over $S_i$. Set
$$
\mathcal{M}_j = \mathcal{F}_i \otimes_{\mathcal{O}_{S_i}} \mathcal{A}_j
$$
and
$$
\mathcal{M} = \mathcal{F}_i \otimes_{\mathcal{O}_{S_i}} \mathcal{A}.
$$
Then we have $f_{ji, *} \mathcal{F}_j = \mathcal{M}_j$
and $f_{i, *}\mathcal{F} = \mathcal{M}$. Since $\mathcal{A}$
is the colimit of the sheaves $\mathcal{A}_j$ and since tensor
product commutes with directed colimits, we conclude that
$\mathcal{M} = \colim_{j \geq i} \mathcal{M}_j$.
Since $S_i$ is quasi-compact and quasi-separated we see that
\begin{eqnarray*}
\Gamma(S, \mathcal{F})
& = &
\Gamma(S_i, \mathcal{M}) \\
& = &
\Gamma(S_i, \colim_{j \geq i} \mathcal{M}_j) \\
& = &
\colim_{j \geq i} \Gamma(S_i, \mathcal{M}_j) \\
& = &
\colim_{j \geq i} \Gamma(S_j, \mathcal{F}_j)
\end{eqnarray*}
see Sheaves, Lemma \ref{sheaves-lemma-directed-colimits-sections} and
Topology, Lemma \ref{topology-lemma-topology-quasi-separated-scheme}
for the middle equality.
\end{proof}















\section{Absolute Noetherian Approximation}
\label{section-approximation}

\noindent
A nice reference for this section is Appendix C of the article
by Thomason and Trobaugh \cite{TT}.
See Categories, Section \ref{categories-section-posets-limits}
for our conventions regarding directed systems.
We will use the existence result and properties of the limit
from Section \ref{section-limits} without further mention.

\begin{lemma}
\label{lemma-limit-nonempty}
Let $I$ be a directed partially ordered set.
Let $(S_i, f_{ii'})$ be an inverse system of
schemes over $I$. Assume
\begin{enumerate}
\item all the morphisms $f_{ii'} : S_i \to S_{i'}$ are affine,
\item all the schemes $S_i$ are quasi-compact, and
\item all the schemes $S_i$ are nonempty.
\end{enumerate}
Then the limit $S = \lim_i S_i$ is nonempty.
\end{lemma}

\begin{proof}
Choose $i_0 \in I$. Note that $I$ is nonempty as the limit is directed.
For convenience write $S_0 = S_{i_0}$ and $i_0 = 0$.
Choose an affine open covering $S_0 = \bigcup_{j = 1, \ldots, m} U_j$.
Since $I$ is directed there exists a $j \in \{1, \ldots, m\}$
such that $f_{i0}^{-1}(U_j) \not = \emptyset$ for all
$i \geq 0$. Hence $\lim_{i \geq 0} f_{i0}^{-1}(U_j)$ is not
empty since a directed colimit of nonzero rings is nonzero
(because $1 \not = 0$). As $\lim_{i \geq 0} f_{i0}^{-1}(U_j)$
is an open subscheme of the limit we win.
\end{proof}

\begin{lemma}
\label{lemma-limit-closed-nonempty}
Let $I$ be a directed partially ordered set.
Let $(S_i, f_{ii'})$ be an inverse system of
schemes over $I$. Assume
\begin{enumerate}
\item all the morphisms $f_{ii'} : S_i \to S_{i'}$ are affine, and
\item all the schemes $S_i$ are quasi-compact.
\end{enumerate}
Let $S = \lim_i S_i$.
Suppose for each $i$ we are given a nonempty closed subset
$Z_i \subset S_i$ with $f_{ii'}(Z_i) \subset Z_{i'}$.
Then there exists a point $s \in S$ with $f_i(s) \in Z_i$ for
all $i$.
\end{lemma}

\begin{proof}
Let $Z_i \subset S_i$ also denote the reduced closed subscheme
associated to $Z_i$, see Schemes,
Definition \ref{schemes-definition-reduced-induced-scheme}.
A closed immersion is affine, and a composition of affine
morphisms is affine (see
Morphisms, Lemmas \ref{morphisms-lemma-closed-immersion-affine}
and \ref{morphisms-lemma-composition-affine}), and hence $Z_i \to S_{i'}$ is
affine when $i \geq i'$. We conclude that the morphism
$f_{ii'} : Z_i \to Z_{i'}$ is affine by
Morphisms, Lemma \ref{morphisms-lemma-affine-permanence}.
Each of the schemes $Z_i$ is quasi-compact as a closed
subscheme of a quasi-compact scheme. Hence we may apply
Lemma \ref{lemma-limit-nonempty} to see that
$Z = \lim_i Z_i$ is nonempty. Since there is a
canonical morphism $Z \to S$ we win.
\end{proof}

\begin{lemma}
\label{lemma-limit-fibre-product-empty}
Let $I$ be a directed partially ordered set.
Let $(S_i, f_{ii'})$ be an inverse system of schemes over $I$.
Assume all the morphisms $f_{ii'} : S_i \to S_{i'}$ are affine.
Let $S = \lim_i S_i$. Suppose we are given an $i$ and a
morphism $T \to S_i$ such that
\begin{enumerate}
\item $T \times_{S_i} S = \emptyset$, and
\item $T$ is quasi-compact.
\end{enumerate}
Then $T \times_{S_i} S_{i'} = \emptyset$ for all sufficiently large $i'$.
\end{lemma}

\begin{proof}
By
Lemma \ref{lemma-scheme-over-limit}
we see that $T \times_{S_i} S = \lim_{i' \geq i} T \times_{S_i} S_{i'}$.
Hence the result follows from
Lemma \ref{lemma-limit-nonempty}.
\end{proof}

\begin{lemma}
\label{lemma-limit-contained-in-constructible}
Let $I$ be a directed partially ordered set.
Let $(S_i, f_{ii'})$ be an inverse system of schemes over $I$.
Assume all the morphisms $f_{ii'} : S_i \to S_{i'}$ are affine, and
all the schemes $S_i$ are quasi-compact. Let $S = \lim_i S_i$
with projection morphisms $f_i : S \to S_i$.
Suppose we are given an $i$ and a locally constructible subset
$E \subset S_i$ such that $f_i(S) \subset E$.
Then $f_{ii'}(S_{i'}) \subset E$ for all sufficiently large $i'$.
\end{lemma}

\begin{proof}
Writing $S_i$ as a finite union of open affine subschemes reduces
the question to the case that $S_i$ is affine and $E$ is constructible, see
Lemma \ref{lemma-directed-inverse-system-has-limit}
and
Properties, Lemma \ref{properties-lemma-locally-constructible}.
In this case the complement $S_i \setminus E$ is contstructible too.
Hence there exists an affine scheme $T$ and a morphism $T \to S_i$
whose image is $S_i \setminus E$, see
Algebra, Lemma \ref{algebra-lemma-constructible-is-image}.
By
Lemma \ref{lemma-limit-fibre-product-empty}
we see that $T \times_{S_i} S_{i'}$ is empty for all sufficiently large
$i'$, and hence $f_{ii'}(S_{i'}) \subset E$ for all sufficiently large $i'$.
\end{proof}



\begin{lemma}
\label{lemma-descend-opens}
Let $I$ be a directed partially ordered set.
Let $(S_i, f_{ii'})$ be an inverse system of
schemes over $I$. Assume
\begin{enumerate}
\item all the morphisms $f_{ii'} : S_i \to S_{i'}$ are affine,
\item all the schemes $S_i$ are quasi-compact and quasi-separated.
\end{enumerate}
Then we have the following:
\begin{enumerate}
\item Given any quasi-compact open $V \subset S = \lim_i S_i$
there exists an $i \in I$ and a quasi-compact open $V_i \subset S_i$
such that $f_i^{-1}(V_i) = V$.
\item Given $V_i \subset S_i$ and $V_{i'} \subset S_{i'}$
quasi-compact opens such that $f_i^{-1}(V_i) = f_{i'}^{-1}(V_{i'})$
there exists an index $i'' \geq i, i'$ such that
$f_{i''i}^{-1}(V_i) = f_{i''i'}^{-1}(V_{i'})$.
\item If $V_{1, i}, \ldots, V_{n, i} \subset S_i$ are quasi-compact
opens and $S = f_i^{-1}(V_{1, i}) \cup \ldots \cup f_i^{-1}(V_{n, i})$
then $S_{i'} = f_{i'i}^{-1}(V_{1, i}) \cup \ldots \cup f_{i'i}^{-1}(V_{n, i})$
for some $i' \geq i$.
\end{enumerate}
\end{lemma}

\begin{proof}
Choose $i_0 \in I$. Note that $I$ is nonempty as the limit is directed.
For convenience we write $S_0 = S_{i_0}$ and $i_0 = 0$.
Choose an affine open covering $S_0 = U_{1, 0} \cup \ldots \cup U_{m, 0}$.
Denote $U_{j, i} \subset S_i$ the inverse image of $U_{j, 0}$
under the transition morphism for $i \geq 0$.
Denote $U_j$ the inverse image of $U_{j, 0}$ in $S$.
Note that $U_j = \lim_i U_{j, i}$ is a limit of affine
schemes.

\medskip\noindent
We first prove the uniqueness statement: Let
$V_i \subset S_i$ and $V_{i'} \subset S_{i'}$
quasi-compact opens such that $f_i^{-1}(V_i) = f_{i'}^{-1}(V_{i'})$.
It suffices to show that $f_{i''i}^{-1}(V_i \cap U_{j, i''})$ and
$f_{i''i'}^{-1}(V_{i'} \cap U_{j, i''})$ become equal
for $i''$ large enough. Hence we reduce to the case
of a limit of affine schemes. In this case write
$S = \Spec(R)$ and $S_i = \Spec(R_i)$ for all $i \in I$.
We may write $V_i = S_i \setminus V(h_1, \ldots, h_m)$
and $V_{i'} = S_{i'} \setminus V(g_1, \ldots, g_n)$.
The assumption means that the ideals
$\sum g_jR$ and $\sum h_jR$ have the same radical
in $R$. This means that $g_j^N = \sum a_{jj'}h_{j'}$ and
$h_j^N = \sum b_{jj'} g_{j'}$ for some $N \gg 0$ and $a_{jj'}$
and $b_{jj'}$ in $R$.
Since $R = \colim_i R_i$ we can chose an index
$i'' \geq i$ such that the equations
$g_j^N = \sum a_{jj'}h_{j'}$ and
$h_j^N = \sum b_{jj'} g_{j'}$ hold in $R_{i''}$ for some
$a_{jj'}$ and $b_{jj'}$ in $R_{i''}$. This implies that
the ideals $\sum g_jR_{i''}$ and $\sum h_jR_{i''}$ have the same radical
in $R_{i''}$ as desired.

\medskip\noindent
We prove existence. We may apply the uniqueness statement to
the limit of schemes
$U_{j_1} \cap U_{j_2} = \lim_i U_{j_1, i} \cap U_{j_2, i}$
since these are still quasi-compact due to the fact that the
$S_i$ were assumed quasi-separated.
Hence it is enough to prove existence in the affine case.
In this case write $S = \Spec(R)$ and $S_i = \Spec(R_i)$
for all $i \in I$. Then $V = S \setminus V(g_1, \ldots, g_n)$
for some $g_1, \ldots, g_n \in R$. Choose any $i$ large enough
so that each of the $g_j$ comes from an element $g_{j, i} \in R_i$
and take $V_i = S_i \setminus V(g_{1, i}, \ldots, g_{n, i})$.

\medskip\noindent
The statement on coverings follows from the uniqueness statement
for the opens $V_{1, i} \cup \ldots \cup V_{n, i}$ and $S_i$ of $S_i$.
\end{proof}

\begin{lemma}
\label{lemma-limit-quasi-affine}
Let $I$ be a directed partially ordered set.
Let $(S_i, f_{ii'})$ be an inverse system of
schemes over $I$. Assume
\begin{enumerate}
\item all the morphisms $f_{ii'} : S_i \to S_{i'}$ are affine,
\item all the schemes $S_i$ are quasi-compact and quasi-separated, and
\item the limit $S = \lim_i S_i$ is quasi-affine.
\end{enumerate}
Then for some $i_0 \in I$ the schemes $S_i$ for $i \geq i_0$
are quasi-affine.
\end{lemma}

\begin{proof}
Choose $i_0 \in I$. Note that $I$ is nonempty as the limit is directed.
For convenience we write $S_0 = S_{i_0}$ and $i_0 = 0$.
Let $s \in S$. We may choose an affine open
$U_0 \subset S_0$ containing $f_0(s)$. Since $S$ is quasi-affine
we may choose an element $a \in \Gamma(S, \mathcal{O}_S)$ such
that $s \in D(a) \subset f_0^{-1}(U_0)$, and such that
$D(a)$ is affine. By Lemma \ref{lemma-descend-section}
there exists an $i \geq 0$ such that $a$
comes from an element $a_i \in \Gamma(S_i, \mathcal{O}_{S_i})$.
For any index $j \geq i$ we denote $a_j$
the image of $a_i$ in the global sections of the
structure sheaf of $S_j$.
Consider the opens $D(a_j) \subset S_j$
and $U_j = f_{j0}^{-1}(U_0)$. Note that
$U_j$ is affine and $D(a_j)$ is a quasi-compact open of $S_j$,
see Properties, Lemma \ref{properties-lemma-affine-cap-s-open}
for example. Hence we may apply Lemma \ref{lemma-descend-opens} to the opens
$U_j$ and $U_j \cup D(a_j)$ to conclude that
$D(a_j) \subset U_j$ for some  $j \geq i$.
For such an index $j$ we see that $D(a_j) \subset S_j$ is an affine open
(because $D(a_j)$ is a standard affine open of the affine open $U_j$)
containing the image $f_j(s)$.

\medskip\noindent
We conclude that for every $s \in S$ there exist
an index $i \in I$, and a global section
$a \in \Gamma(S_i, \mathcal{O}_{S_i})$
such that $D(a) \subset S_i$ is an affine open
containing $f_i(s)$. Because $S$ is quasi-compact we
may choose a single index $i \in I$ and global sections
$a_1, \ldots, a_m \in \Gamma(S_i, \mathcal{O}_{S_i})$
such that each $D(a_j) \subset S_i$ is affine open
and such that $f_i : S \to S_i$ has image contained
in the union $W_i = \bigcup_{j = 1, \ldots, m} D(a_j)$.
For $i' \geq i$ set $W_{i'} = f_{i'i}^{-1}(W_i)$.
Since $f_i^{-1}(W_i)$ is all of $S$ we see
(by Lemma \ref{lemma-descend-opens} again)
that for a suitable $i' \geq i$ we
have $S_{i'} = W_{i'}$. Thus we may replace $i$ by
$i'$ and assume that $S_i = \bigcup_{j = 1, \ldots, m} D(a_j)$.
This implies that $\mathcal{O}_{S_i}$ is an ample invertible
sheaf on $S_i$ (see Properties, Definition \ref{properties-definition-ample})
and hence that $S_i$ is quasi-affine, see
Properties, Lemma \ref{properties-lemma-quasi-affine-O-ample}.
Hence we win.
\end{proof}

\begin{lemma}
\label{lemma-limit-affine}
Let $I$ be a directed partially ordered set.
Let $(S_i, f_{ii'})$ be an inverse system of
schemes over $I$. Assume
\begin{enumerate}
\item all the morphisms $f_{ii'} : S_i \to S_{i'}$ are affine,
\item all the schemes $S_i$ are quasi-compact and quasi-separated, and
\item the limit $S = \lim_i S_i$ is affine.
\end{enumerate}
Then for some $i_0 \in I$ the schemes $S_i$ for $i \geq i_0$
are affine.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-limit-quasi-affine} we may assume that
$S_i$ is quasi-affine for all $i$. Set $R_i = \Gamma(S_i, \mathcal{O}_{S_i})$.
Then $S_i$ is a quasi-compact open of $\overline{S_i} := \Spec(R_i)$.
Write $S = \Spec(R)$. We have $R = \colim_i R_i$
by Lemma \ref{lemma-descend-section}.
Hence also $S = \lim_i \overline{S_i}$.
Let $Z_i \subset \overline{S_i}$ be the closed subset such that
$\overline{S_i} = Z_i \coprod S_i$.
We have to show that $Z_i$ is empty for some $i$.
Assume $Z_i$ is nonempty for all $i$ to get a contradiction.
By Lemma \ref{lemma-limit-closed-nonempty} there exists
a point $s$ of $S$ which maps to a point of $Z_i$ for every $i$.
But $S = \lim_i S_i$, and hence we get a contradiction.
\end{proof}

\begin{lemma}
\label{lemma-quasi-affine-finite-type-over-Z}
Let $W$ be a quasi-affine scheme of finite type over
$\mathbf{Z}$. Suppose $W \to \Spec(R)$ is an
open immersion into an affine scheme. There exists a
finite type $\mathbf{Z}$-algebra $A \subset R$
which induces an open immersion $W \to \Spec(A)$.
Moreover, $R$ is the directed colimit of such subalgebras.
\end{lemma}

\begin{proof}
Choose an affine open covering $W = \bigcup_{i = 1, \ldots, n} W_i$
such that each $W_i$ is a standard affine open in $\Spec(R)$.
In other words, if we write $W_i = \Spec(R_i)$
then $R_i = R_{f_i}$ for some $f_i \in R$.
Choose finitely many $x_{ij} \in R_i$ which generate
$R_i$ over $\mathbf{Z}$.
Pick an $N \gg 0$ such that each $f_i^Nx_{ij}$ comes from an
element of $R$, say $y_{ij} \in R$.
Set $A$ equal to the $\mathbf{Z}$-algebra generated by
the $f_i$ and the $y_{ij}$ and (optionally) finitely many
additional elements of $R$. Then $A$ works. Details omitted.
\end{proof}

\begin{lemma}
\label{lemma-diagram-localize}
Suppose given a cartesian diagram of rings
$$
\xymatrix{
B \ar[r]_s & R \\
B'\ar[u] \ar[r] & R' \ar[u]_t
}
$$
Suppose $h \in B'$ corresponds to $g \in B$
and $f \in R'$ such that $s(g) = t(f)$.
Then the diagram
$$
\xymatrix{
B_g \ar[r]_-s & R_{s(g)} = R_{t(f)} \\
(B')_h \ar[u] \ar[r] & (R')_f \ar[u]_t
}
$$
is cartesian too.
\end{lemma}

\begin{proof}
Note that $B' = \{(b, r') \in B \times R' \mid s(b) = t(r')\}$.
So $h = (g, f) \in B'$. First we show that $(B')_h$ maps
injectively into $B_g \times (R')_f$. Namely, suppose that
$(x, y)/h^n$ maps to zero. This means that
$(g^Nx, f^Ny)$ is zero for some $N$. Which clearly implies
that $x/g^n$ and $y/f^n$ are both zero.
Next, suppose that $x/g^n$ and $y/f^m$ are elements
which map to the same element of $R_{s(g)}$.
This means that $s(g)^N(t(f)^ms(x) - s(g)^nt(y)) = 0$ in $R'$
for some $N \gg 0$. We can rewrite this as
$s(g^{m + N}x) = t(f^{n + N}y)$. Hence we see that the
pair $(x/g^n, y/f^m)$ is the image of the element
$(g^{m + N}x, t(f^{n + N}y)/(g, f)^{n + m + N}$ of
$(B')_h$.
\end{proof}

\begin{lemma}
\label{lemma-diagram}
Suppose given a cartesian diagram of rings
$$
\xymatrix{
B \ar[r]_s & R \\
B'\ar[u] \ar[r] & R' \ar[u]_t
}
$$
Let $W' \subset \Spec(R')$ be an open of
the form $W' = D(f_1) \cup \ldots \cup D(f_n)$
such that $t(f_i) = s(g_i)$ for some $g_i \in B$
and $B_{g_i} \cong R_{s(g_i)}$. Then $B' \to R'$
induces an open immersion of $W'$ into $\Spec(B')$.
\end{lemma}

\begin{proof}
Set $h_i = (g_i, f_i) \in B'$.
Lemma \ref{lemma-diagram-localize} above shows that
$(B')_{h_i} \cong (R')_{f_i}$ as desired.
\end{proof}

\noindent
The following lemma is a precise statement of Noetherian
approximation.

\begin{lemma}
\label{lemma-approximate}
Let $S$ be a quasi-compact and quasi-separated scheme. Let $V \subset S$
be a quasi-compact open. Let $I$ be a directed partially ordered set
and let $(V_i, f_{ii'})$ be an inverse system of schemes over $I$
with affine transition maps, with each $V_i$ of finite type over $\mathbf{Z}$,
and with $V = \lim V_i$. Then there exist
\begin{enumerate}
\item a directed partially ordered set $J$,
\item an inverse system of schemes $(S_j, g_{jj'})$ over $J$,
\item an order preserving map $\alpha : J \to I$,
\item open subschemes $V'_j \subset S_j$, and
\item isomorphisms $V'_j \to V_{\alpha(j)}$
\end{enumerate}
such that
\begin{enumerate}
\item the transition morphisms $g_{jj'} : S_j \to S_{j'}$ are affine,
\item each $S_j$ is of finite type over $\mathbf{Z}$,
\item $g_{jj'}^{-1}(V_{j'}) = V_j$,
\item $S = \lim S_j$ and $V = \lim V_j$, and
\item the diagrams
$$
\vcenter{
\xymatrix{
V \ar[d] \ar[rd] \\
V'_j \ar[r] & V_{\alpha(j)}
}
}
\quad\text{and}\quad
\vcenter{
\xymatrix{
V_j \ar[r] \ar[d] & V_{\alpha(j)} \ar[d] \\
V_{j'} \ar[r] & V_{\alpha(j')}
}
}
$$
are commutative.
\end{enumerate}
\end{lemma}

\begin{proof}
Set $Z = S \setminus V$. Choose affine opens $U_1, \ldots, U_m \subset S$
such that $Z \subset \bigcup_{l = 1, \ldots, m} U_l$. Consider the opens
$$
V \subset V \cup U_1 \subset V \cup U_1 \cup U_2 \subset
\ldots \subset V \cup \bigcup\nolimits_{l = 1, \ldots, m} U_l = S
$$
If we can prove the lemma successively for each of the cases
$$
V \cup U_1 \cup \ldots \cup U_l
\subset
V \cup U_1 \cup \ldots \cup U_{l + 1}
$$
then the lemma will follow for $V \subset S$. In each case we are adding
one affine open. Thus we may assume
\begin{enumerate}
\item $S = U \cup V$,
\item $U$ affine open in $S$,
\item $V$ quasi-compact open in $S$, and
\item $V = \lim_i V_i$ with $(V_i, f_{ii'})$
an inverse system over a directed set $I$, each $f_{ii'}$
affine and each $V_i$ of finite type over $\mathbf{Z}$.
\end{enumerate}
Set $W = U \cap V$. As $S$ is quasi-separated, this is a quasi-compact open
of $V$. By Lemma \ref{lemma-descend-opens}
(and after shrinking $I$) we may assume that there exist
opens $W_i \subset V_i$ such that $f_{ij}^{-1}(W_j) = W_i$
and such that $f_i^{-1}(W_i) = W$. Since $W$ is a quasi-compact open
of $U$ it is quasi-affine. Hence we may assume (after shrinking $I$ again)
that $W_i$ is quasi-affine for all $i$, see
Lemma \ref{lemma-limit-quasi-affine}.

\medskip\noindent
Write $U = \Spec(B)$. Set $R = \Gamma(W, \mathcal{O}_W)$,
and $R_i = \Gamma(W_i, \mathcal{O}_{W_i})$.
By Lemma \ref{lemma-descend-section} we have $R = \colim_i R_i$.
Now we have the maps of rings
$$
\xymatrix{
B \ar[r]_s & R \\
& R_i \ar[u]_{t_i}
}
$$
We set $B_i = \{(b, r) \in B \times R_i \mid s(b) = t_i(t)\}$ so that we
have a cartesian diagram
$$
\xymatrix{
B \ar[r]_s & R \\
B_i \ar[u] \ar[r] & R_i \ar[u]_{t_i}
}
$$
for each $i$. The transition maps $R_i \to R_{i'}$ induce maps
$B_i \to B_{i'}$. It is clear that $B = \colim_i B_i$.
In the next paragraph we show that for all sufficiently large $i$
the composition $W_i \to \Spec(R_i) \to \Spec(B_i)$ is an open immersion.

\medskip\noindent
As $W$ is a quasi-compact open of $U = \Spec(B)$
we can find a finitely many elements $g_l \in B$, $l = 1, \ldots, m$
such that $D(g_l) \subset W$ and such that
$W = \bigcup_{l = 1, \ldots, m} D(g_l)$.
Note that this implies $D(g_l) = W_{s(g_l)}$ as open subsets of $U$,
where $W_{s(g_l)}$ denotes the largest open subset of $W$ on which
$s(g_l)$ is invertible. Hence
$$
B_{g_l} =
\Gamma(D(g_l), \mathcal{O}_U) =
\Gamma(W_{s(g_l)}, \mathcal{O}_W) = R_{s(g_l)},
$$
where the last equality is
Properties, Lemma \ref{properties-lemma-invert-f-sections}.
Since $W_{s(g_l)}$ is affine this also
implies that $D(s(g_l)) = W_{s(g_l)}$ as open subsets of $\Spec(R)$.
Since $R = \colim_i R_i$ we can (after shrinking $I$)
assume there exist $g_{l, i} \in R_i$ for all $i \in I$ such that
$s(g_l) = t_i(g_{l, i})$. Of course we choose the $g_{l, i}$
such that $g_{l, i}$ maps to $g_{l, i'}$ under the transition maps
$R_i \to R_{i'}$. Then, by Lemma \ref{lemma-descend-opens} we can
(after shrinking $I$ again)
assume the corresponding opens $D(g_{l, i}) \subset \Spec(R_i)$
are contained in $W_i$, $j = 1, \ldots, m$ and cover $W_i$.
We conclude that the morphism $W_i \to \Spec(R_i) \to \Spec(B_i)$
is an open immersion, see Lemma \ref{lemma-diagram}

\medskip\noindent
By Lemma \ref{lemma-quasi-affine-finite-type-over-Z}
we can write $B_i$ as a directed colimit of subalgebras
$A_{i, p} \subset B_i$, $p \in P_i$ each
of finite type over $\mathbf{Z}$ and such that $W_i$ is
identified with an open subscheme of $\Spec(A_{i, p})$.
Let $S_{i, p}$ be the scheme obtained by glueing
$V_i$ and $\Spec(A_{i, p})$ along the open $W_i$, see
Schemes, Section \ref{schemes-section-glueing-schemes}.
Here is the resulting commutative diagram of schemes:
$$
\xymatrix{
& & V \ar[lld] \ar[d] & W \ar[l] \ar[lld] \ar[d] \\
V_i \ar[d] & W_i \ar[l] \ar[d] & S \ar[lld] & U \ar[lld] \ar[l] \\
S_{i, p} & \Spec(A_{i, p}) \ar[l]
}
$$
The morphism $S \to S_{i, p}$ arises because the upper right
square is a pushout in the category of schemes.
Note that $S_{i, p}$ is of finite type over $\mathbf{Z}$ since
it has a finite affine open covering whose members are
spectra of finite type $\mathbf{Z}$-algebras.
We define a partial ordering on $J = \coprod_{i \in I} P_i$
by the rule $(i', p') \geq (i, p)$ if and only if
$i' \geq i$ and the map $B_i \to B_{i'}$ maps $A_{i, p}$ into
$A_{i', p'}$. This is exactly the condition needed to
define a morphism $S_{i', p'} \to S_{i, p}$: namely make a commutative
diagram as above using the transition morphisms $V_{i'} \to V_i$
and $W_{i'} \to W_i$ and
the morphism $\Spec(A_{i', p'}) \to \Spec(A_{i, p})$ induced
by the ring map $A_{i, p} \to A_{i', p'}$. The relevant commutativities
have been built into the constructions.
We claim that $S$ is the directed limit of the schemes $S_{i, p}$.
Since by construction the schemes $V_i$ have limit $V$ this boils
down to the fact that $B$ is the limit of the rings $A_{i, p}$
which is true by construction. The map $\alpha : J \to I$ is given
by the rule $j = (i, p) \mapsto i$. The open subscheme $V'_j$ is
just the image of $V_i \to S_{i, p}$ above. The commutativity of
the diagrams in (5) is clear from the construction.
This finishes the proof of the lemma.
\end{proof}

\begin{proposition}
\label{proposition-approximate}
Let $S$ be a quasi-compact and quasi-separated scheme.
There exist a directed partially ordered set $I$
and an inverse system of schemes $(S_i, f_{ii'})$ over $I$
such that
\begin{enumerate}
\item the transition morphisms $f_{ii'}$ are affine
\item each $S_i$ is of finite type over $\mathbf{Z}$, and
\item $S = \lim_i S_i$.
\end{enumerate}
\end{proposition}

\begin{proof}
This is a special case of Lemma \ref{lemma-approximate}
with $V = \emptyset$.
\end{proof}






\section{Limits and morphisms of finite presentation}
\label{section-finite-presentation}

\noindent
The following is a generalization of
Algebra, Lemma \ref{algebra-lemma-characterize-finite-presentation}.

\begin{proposition}
\label{proposition-characterize-locally-finite-presentation}
Let $f : X \to S$ be a morphism of schemes.
The following are equivalent:
\begin{enumerate}
\item The morphism $f$ is locally of finite presentation.
\item For any directed partially ordered set $I$, and any
inverse system $(T_i, f_{ii'})$ of $S$-schemes over $I$
with each $T_i$ affine, we have
$$
\Mor_S(\lim_i T_i, X) =
\colim_i \Mor_S(T_i, X)
$$
\item For any directed partially ordered set $I$, and any
inverse system $(T_i, f_{ii'})$ of $S$-schemes over $I$
with each $f_{ii'}$ affine and every $T_i$ quasi-compact and
quasi-separated as a scheme, we have
$$
\Mor_S(\lim_i T_i, X) =
\colim_i \Mor_S(T_i, X)
$$
\end{enumerate}
\end{proposition}

\begin{proof}
It is clear that (3) implies (2).

\medskip\noindent
Let us prove that (2) implies (1). Assume (2).
Choose any affine opens $U \subset X$ and $V \subset S$ such that
$f(U) \subset V$. We have to show that
$\mathcal{O}_S(V) \to \mathcal{O}_X(U)$ is of finite presentation.
Let $(A_i, \varphi_{ii'})$ be a directed system of
$\mathcal{O}_S(V)$-algebras. Set $A = \colim_i A_i$.
According to
Algebra, Lemma \ref{algebra-lemma-characterize-finite-presentation}
we have to show that
$$
\Hom_{\mathcal{O}_S(V)}(\mathcal{O}_X(U), A) =
\colim_i \Hom_{\mathcal{O}_S(V)}(\mathcal{O}_X(U), A_i)
$$
Consider the schemes $T_i = \Spec(A_i)$. They
form an inverse system of $V$-schemes over $I$
with transition morphisms $f_{ii'} : T_i \to T_{i'}$
induced by the $\mathcal{O}_S(V)$-algebra maps $\varphi_{i'i}$.
Set $T := \Spec(A) = \lim_i T_i$.
The formula above becomes in terms of morphism sets of schemes
$$
\Mor_V(\lim_i T_i, U) =
\colim_i \Mor_V(T_i, U).
$$
We first observe that
$\Mor_V(T_i, U) = \Mor_S(T_i, U)$
and
$\Mor_V(T, U) = \Mor_S(T, U)$.
Hence we have to show that
$$
\Mor_S(\lim_i T_i, U) =
\colim_i \Mor_S(T_i, U)
$$
and we are given that
$$
\Mor_S(\lim_i T_i, X) =
\colim_i \Mor_S(T_i, X).
$$
Hence it suffices to prove that given a morphism $g_i : T_i \to X$ over $S$
such that the composition $T \to T_i \to X$ ends up in $U$ there exists some
$i' \geq i$ such that the composition $g_{i'} : T_{i'} \to T_i \to X$ ends up
in $U$. Denote $Z_{i'} = g_{i'}^{-1}(X \setminus U)$.
Assume each $Z_{i'}$ is nonempty
to get a contradiction. By Lemma \ref{lemma-limit-closed-nonempty}
there exists a point $t$ of $T$ which is mapped into $Z_{i'}$ for all
$i' \geq i$. Such a point is not mapped into $U$. A contradiction.

\medskip\noindent
Finally, let us prove that (1) implies (3). Assume (1). Let an inverse directed
system $(T_i, f_{ii'})$ of $S$-schemes be given. Assume the morphisms $f_{ii'}$
are affine and each $T_i$ is quasi-compact and quasi-separated as a scheme. Let
$T = \lim_i T_i$. Denote $f_i : T \to T_i$ the projection morphisms.
We have to show:
\begin{enumerate}
\item[(a)] Given morphisms $g_i, g'_i : T_i \to X$ over $S$ such that
$g_i \circ f_i = g'_i \circ f_i$, then there exists an $i' \geq i$
such that $g_i \circ f_{i'i} = g'_i \circ f_{i'i}$.
\item[(b)] Given any morphism
$g : T \to X$ over $S$ there exists an $i \in I$ and a morphism
$g_i : T_i \to X$ such that $g = f_i \circ g_i$.
\end{enumerate}

\noindent
First let us prove the uniqueness part (a). Let $g_i, g'_i : T_i \to X$ be
morphisms such that $g_i \circ f_i = g'_i \circ f_i$. For any $i' \geq i$
we set $g_{i'} = g_i \circ f_{i'i}$ and $g'_{i'} = g'_i \circ f_{i'i}$.
We also set $g = g_i \circ f_i = g'_i \circ f_i$.
Consider the morphism
$(g_i, g'_i) : T_i \to X \times_S X$. Set
$$
W =
\bigcup\nolimits_{U \subset X\text{ affine open},
V \subset S\text{ affine open}, f(U) \subset V}
U \times_V U.
$$
This is an open in $X \times_S X$, with the property that the morphism
$\Delta_{X/S}$ factors through a closed immersion into $W$, see the proof
of Schemes, Lemma \ref{schemes-lemma-diagonal-immersion}.
Note that the composition
$(g_i, g'_i) \circ f_i : T \to X \times_S X$ is a morphism into $W$
because it factors through the diagonal by assumption.
Set $Z_{i'} = (g_{i'}, g'_{i'})^{-1}(X \times_S X \setminus W)$.
If each $Z_{i'}$ is nonempty, then by Lemma \ref{lemma-limit-closed-nonempty}
there exists a point $t \in T$ which maps to $Z_{i'}$ for all
$i' \geq i$. This is a contradiction with the fact that $T$ maps into $W$.
Hence we may increase $i$ and assume that $(g_i, g'_i) : T_i \to X \times_S X$
is a morphism into $W$. By construction of $W$, and since $T_i$ is
quasi-compact we can find a finite affine open covering
$T_i = T_{1, i} \cup \ldots \cup T_{n, i}$ such that
$(g_i, g'_i)|_{T_{j, i}}$ is a morphism into $U \times_V U$ for
some pair $(U, V)$ as in the definition of $W$ above.
Since it suffices to prove that $g_{i'}$ and $g'_{i'}$ agree
on each of the $f_{i'i}^{-1}(T_{j, i})$ this reduces us to the affine case.
The affine case follows from
Algebra, Lemma \ref{algebra-lemma-characterize-finite-presentation}
and the fact that the ring map
$\mathcal{O}_S(V) \to \mathcal{O}_X(U)$ is of finite presentation
(see Morphisms,
Lemma \ref{morphisms-lemma-locally-finite-presentation-characterize}).

\medskip\noindent
Finally, we prove the existence part (b).
Let $g : T \to X$ be a morphism of schemes over $S$.
We can find a finite affine open covering
$T = W_1 \cup \ldots \cup W_n$ such that for
each $j \in \{1, \ldots, n\}$ there exist affine opens
$U_j \subset X$ and $V_j \subset S$ with $f(U_j) \subset V_j$
and $g(W_j) \subset U_j$. By Lemmas \ref{lemma-descend-opens}
and \ref{lemma-limit-affine}
(after possibly shrinking $I$) we may assume that
there exist affine open coverings $T_i = W_{1, i} \cup \ldots \cup W_{n, i}$
compatible with transition maps such that $W_j = \lim_i W_{j, i}$.
We apply Algebra, Lemma \ref{algebra-lemma-characterize-finite-presentation}
to the rings corresponding to the affine schemes $U_j$, $V_j$, $W_{j, i}$ and
$W_j$ using that $\mathcal{O}_S(V_j) \to \mathcal{O}_X(U_j)$ is of finite
presentation (see Morphisms,
Lemma \ref{morphisms-lemma-locally-finite-presentation-characterize}).
Thus we can find for each $j$ an index $i_j \in I$ and a morphism
$g_{j, i_j} : W_{j, i_j} \to X$ such that
$g_{j, i_j} \circ f_i|_{W_j} : W_j \to W_{j, i} \to X$
equals $g|_{W_j}$. By part (a) proved above, using the quasi-compactness of
$W_{j_1, i} \cap W_{j_2, i}$ which follows as $T_i$ is quasi-separated,
we can find an index $i' \in I$ larger than all $i_j$ such that
$$
g_{j_1, i_{j_1}} \circ f_{i'i_{j_1}}|_{W_{j_1, i'} \cap W_{j_2, i'}} =
g_{j_2, i_{j_2}} \circ f_{i'i_{j_2}}|_{W_{j_1, i'} \cap W_{j_2, i'}}
$$
for all $j_1, j_2 \in \{1, \ldots, n\}$. Hence the morphisms
$g_{j, i_j} \circ f_{i'i_j}|_{W_{j, i'}}$ glue to given the
desired morphism $T_{i'} \to X$.
\end{proof}

\begin{remark}
\label{remark-limit-preserving}
Let $S$ be a scheme. Let us say that a functor
$F : (\Sch/S)^{opp} \to \textit{Sets}$ is
{\it limit preserving} if for every directed inverse system
$\{T_i\}_{i \in I}$ of affine schemes with limit $T$ we have
$F(T) = \colim_i F(T_i)$. Let $X$ be a scheme over $S$, and
let $h_X : (\Sch/S)^{opp} \to \textit{Sets}$ be its
functor of points, see
Schemes, Section \ref{schemes-section-representable}.
In this terminology
Proposition \ref{proposition-characterize-locally-finite-presentation}
says that a scheme $X$ is locally of finite presentation over
$S$ if and only if $h_X$ is limit preserving.
\end{remark}






\section{Finite type closed in finite presentation}
\label{section-finite-type-closed-in-finite-presentation}

\noindent
A reference is \cite{Conrad-Nagata}.

\begin{lemma}
\label{lemma-locally-finite-type-in-finite-presentation}
Let $f : X \to S$ be a morphism of schemes.
Assume:
\begin{enumerate}
\item The morphism $f$ is locally of finite type.
\item The scheme $X$ is quasi-compact and quasi-separated.
\end{enumerate}
Then there exists a morphism of finite presentation
$f' : X' \to S$ and an immersion $X \to X'$ of schemes over $S$.
\end{lemma}

\begin{proof}
By
Proposition \ref{proposition-approximate}
we can write
$X = \lim_i X_i$ with each $X_i$ of finite type over $\mathbf{Z}$ and
with transition morphisms $f_{ii'} : X_i \to X_{i'}$ affine.
Consider the commutative diagram
$$
\xymatrix{
X \ar[r] \ar[rd] & X_{i, S} \ar[r] \ar[d] & X_i \ar[d] \\
& S \ar[r] & \Spec(\mathbf{Z})
}
$$
Note that $X_i$ is of finite presentation over $\Spec(\mathbf{Z})$, see
Morphisms,
Lemma \ref{morphisms-lemma-noetherian-finite-type-finite-presentation}.
Hence the base change $X_{i, S} \to S$ is of finite presentation by
Morphisms, Lemma \ref{morphisms-lemma-base-change-finite-presentation}.
Thus it suffices to show that the arrow $X \to X_{i, S}$ is an
immersion for some $i$ sufficiently large.

\medskip\noindent
To do this we choose a finite affine open covering
$X = V_1 \cup \ldots \cup V_n$ such that
$f$ maps each $V_j$ into an affine open $U_j \subset S$.
Let $h_{j, a} \in \mathcal{O}_X(V_j)$ be a finite
set of elements which generate $\mathcal{O}_X(V_j)$ as
an $\mathcal{O}_S(U_j)$-algebra, see
Morphisms, Lemma \ref{morphisms-lemma-locally-finite-type-characterize}.
By Lemmas \ref{lemma-descend-opens} and \ref{lemma-limit-affine}
(after possibly shrinking $I$) we may assume that
there exist affine open coverings
$X_i = V_{1, i} \cup \ldots \cup V_{n, i}$
compatible with transition maps such that $V_j = \lim_i V_{j, i}$.
By Lemma \ref{lemma-descend-section} we can choose $i$ so large that each
$h_{j, a}$ comes from an element
$h_{j, a, i} \in \mathcal{O}_{X_i}(V_{j, i})$.
At this point it is clear that
$$
V_j \longrightarrow U_j \times_{\Spec(\mathbf{Z})} V_{j, i} =
(V_{j, i})_{U_j} \subset (V_{j, i})_S \subset X_{i, S}
$$
is a closed immersion. Since the union of the schemes which appear as
the targets of these morphisms form an open of $X_{i, S}$ we win.
\end{proof}

\begin{remark}
\label{remark-cannot-do-better}
We cannot do better than this if we do not assume
more on $S$ and the morphism $f : X \to S$.
For example, in general it will not be possible to
find a {\it closed} immersion $X \to X'$ as in the lemma.
The reason is that this would imply that $f$ is quasi-compact which
may not be the case. An example is to take $S$ to be infinite
dimensional affine space with $0$ doubled and $X$ to be one of
the two infinite dimensional affine spaces.
\end{remark}

\begin{lemma}
\label{lemma-finite-type-closed-in-finite-presentation}
Let $f : X \to S$ be a morphism of schemes.
Assume:
\begin{enumerate}
\item The morphism $f$ is of locally of finite type.
\item The scheme $X$ is quasi-compact and quasi-separated, and
\item The scheme $S$ is quasi-separated.
\end{enumerate}
Then there exists a morphism of finite presentation
$f' : X' \to S$ and a closed immersion $X \to X'$ of schemes over $S$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-locally-finite-type-in-finite-presentation} above
there exists a morphism $Y \to S$ of finite presentation and an
immersion $i : X \to Y$ of schemes over $S$.
For every point $x \in X$, there exists an affine open
$V_x \subset Y$ such that $i^{-1}(V_x) \to V_x$ is a
closed immersion. Since $X$ is quasi-compact we can find
finitely may affine opens $V_1, \ldots, V_n \subset Y$
such that $i(X) \subset V_1 \cup \ldots \cup V_n$ and
$i^{-1}(V_j) \to V_j$ is a closed immersion. In other words
such that $i : X \to X' = V_1 \cup \ldots \cup V_n$ is a
closed immersion of schemes over $S$.
Since $S$ is quasi-separated and $Y$ is quasi-separated over $S$
we deduce that $Y$ is quasi-separated, see
Schemes, Lemma \ref{schemes-lemma-separated-permanence}.
Hence the open immersion $X' = V_1 \cup \ldots \cup V_n \to Y$
is quasi-compact. This implies that
$X' \to Y$ is of finite presentation, see
Morphisms,
Lemma \ref{morphisms-lemma-quasi-compact-open-immersion-finite-presentation}.
We conclude since then $X' \to Y \to S$ is a composition of morphisms
of finite presentation, and hence of finite presentation (see
Morphisms, Lemma \ref{morphisms-lemma-composition-finite-presentation}).
\end{proof}

\begin{lemma}
\label{lemma-eventually-separated}
Let $S$ be a scheme.
Let $I$ be a directed partially ordered set.
Let $(X_i, f_{ii'})$ be an inverse system of schemes over $S$ indexed by $I$.
Assume
\begin{enumerate}
\item the scheme $S$ is quasi-separated,
\item each $X_i$ is locally of finite type over $S$,
\item all the morphisms $f_{ii'} : X_i \to X_{i'}$ are affine,
\item all the schemes $X_i$ are quasi-compact and quasi-separated,
\item the morphism $X = \lim_i X_i \to S$ is separated.
\end{enumerate}
Then $X_i \to S$ is separated for all $i$ large enough.
\end{lemma}

\begin{proof}
Let $i_0 \in I$. Note that $I$ is nonempty as the limit is directed.
For convenience write $X_0 = X_{i_0}$ and $i_0 = 0$.
As $X_0$ is quasi-compact we can find finitely many
affine opens $U_1, \ldots, U_n \subset S$ such that
$X_0 \to S$ maps into $U_1 \cup \ldots \cup U_n$.
Denote $h_i : X_i \to S$ the structure morphism.
It suffices to check that for some $i \geq 0$ the morphisms
$h_i^{-1}(U_j) \to U_j$ are separated for all $j = 1, \ldots,  n$.
Since $S$ is quasi-separated the morphisms $U_j \to S$ are quasi-compact.
Hence $h_i^{-1}(U_j)$ is quasi-compact and quasi-separated.
In this way we reduce to the case $S$ affine.

\medskip\noindent
Assume $S$ affine. Choose a finite affine open covering
$X_0 = V_{1, 0} \cup \ldots \cup V_{m, 0}$. As usual we denote
$V_{j, i}$ the inverse image of $V_{j, 0}$ in $X_i$ for
$i \geq 0$. We also denote $V_j$ the inverse image of
$V_{j, 0}$ in $X$. By assumption the intersections
$V_{j_1, i} \cap V_{j_2, i}$ are quasi-compact opens.
Since $X$ is separated we see that $V_{j_1} \cap V_{j_2}$
is affine. Hence we see that $V_{j_1, i} \cap V_{j_2, i}$
are all affine for $i$ big enough by Lemma \ref{lemma-limit-affine}.
After increasing $i_0 = 0$ we may assume this holds for
all $i \geq 0$.
By Schemes, Lemma \ref{schemes-lemma-characterize-separated}
we have to show that for some
$i$ big enough the ring map
$$
\mathcal{O}_{X_i}(V_{j_1, i})
\otimes_{\mathcal{O}_S(S)}
\mathcal{O}_{X_i}(V_{j_2, i})
\longrightarrow
\mathcal{O}_{X_i}(V_{j_1, i} \cap V_{j_2, i})
$$
is surjective. Since $V_{j, i}$ is the inverse image of
$V_{j, 0}$ under the affine transition maps $f_{i0}$ we
see that
$$
V_{j_1, i} \cap V_{j_2, i} =
V_{j_1, i} \times_{V_{j_1, 0}} (V_{j_1, 0} \cap V_{j_2, 0})
$$
Choose generators
$x_{j_1, j_2, \alpha} \in \mathcal{O}_{X_0}(V_{j_1, 0} \cap V_{j_2, 0})$
as an algebra over $\mathcal{O}_{X_0}(V_{j_1, 0})$.
We can choose finitely many of these since
$\mathcal{O}_{X_0}(V_{j_1, 0} \cap V_{j_2, 0})$
is a finite type $\mathcal{O}_S(S)$-algebra, see
Morphisms, Lemma \ref{morphisms-lemma-locally-finite-type-characterize}.
By the displayed equality of fibre products,
the images of $x_{j_1, j_2, \alpha}$ generate
$\mathcal{O}_{X_i}(V_{j_1, i} \cap V_{j_2, i})$ as an algebra over
$\mathcal{O}_{X_i}(V_{j_1, i})$ also.
Since $X$ is separated the ring maps
$$
\mathcal{O}_X(V_{j_1})
\otimes_{\mathcal{O}_S(S)}
\mathcal{O}_X(V_{j_2, i})
\longrightarrow
\mathcal{O}_X(V_{j_1} \cap V_{j_2})
$$
are surjective. Hence we can find finite sums
$$
\sum y_{j_1, j_2, \alpha, \beta} \otimes z_{j_1, j_2, \alpha, \beta}
$$
in the left hand side which map to the elements
$x_{j_1, j_2, \alpha}$ of the right hand side.
Using Lemma \ref{lemma-descend-section} we may choose
$i$ large enough so that each of the (finitely many)
elements $y_{j_1, j_2, \alpha, \beta}$
(resp.\ $z_{j_1, j_2, \alpha, \beta}$) comes from a corresponding element
$y_{j_1, j_2, \alpha, \beta, i}$
(resp.\ $z_{j_1, j_2, \alpha, \beta, i}$) of
$\mathcal{O}_{X_i}(V_{j_1, i})$
(resp.\ $\mathcal{O}_{X_i}(V_{j_2, i})$ and moreover such that the image of
$$
\sum y_{j_1, j_2, \alpha, \beta, i} \otimes z_{j_1, j_2, \alpha, \beta, i}
$$
is the image of the element $x_{j_1, j_2, \alpha}$
in $\mathcal{O}_{X_i}(V_{j_1, i} \cap V_{j_2, i})$.
This clearly implies the desired surjectivity and we win.
\end{proof}

\begin{remark}
\label{remark-question-finite-type-necessary}
Is there an easy example to show that the finite type condition
for the morphisms $X_i \to S$ is necessary? Email if you have
one.
\end{remark}

\noindent
A less technical version of the results above is the following.

\begin{proposition}
\label{proposition-separated-closed-in-finite-presentation}
Let $f : X \to S$ be a morphism of schemes.
Assume:
\begin{enumerate}
\item The morphism $f$ is of finite type and separated.
\item The scheme $S$ is quasi-compact and quasi-separated.
\end{enumerate}
Then there exists a separated morphism of finite presentation
$f' : X' \to S$ and a closed immersion $X \to X'$ of schemes over $S$.
\end{proposition}

\begin{proof}
We have seen that there is a closed immersion $X \to Y$ with $Y/S$ of
finite presentation. Let $\mathcal{I} \subset \mathcal{O}_Y$
be the quasi-coherent sheaf of ideals defining $X$ as a closed
subscheme of $Y$. By
Properties, Lemma \ref{properties-lemma-quasi-coherent-colimit-finite-type}
we can write $\mathcal{I}$ as a directed colimit
$\mathcal{I} = \colim_{a \in A} \mathcal{I}_a$ of its
quasi-coherent sheaves of ideals of finite type.
Let $X_a \subset Y$ be the closed subscheme defined by $\mathcal{I}_a$.
These form an inverse system of schemes indexed by $A$.
The transition morphisms $X_a \to X_{a'}$ are affine because
they are closed immersions. Each $X_a$ is quasi-compact and quasi-separated
since it is a closed subscheme of $Y$ and $Y$ is quasi-compact and
quasi-separated by our assumptions.
We have $X = \lim_a X_a$ as follows directly from the
fact that $\mathcal{I} = \colim_{a \in A} \mathcal{I}_a$.
Each of the morphisms $X_a \to Y$ is of finite presentation, see
Morphisms, Lemma \ref{morphisms-lemma-closed-immersion-finite-presentation}.
Hence the morphisms $X_a \to S$ are of finite presentation.
Thus it suffices to show that $X_a \to S$ is separated for some
$a \in A$. This follows from Lemma \ref{lemma-eventually-separated} as we have
assumed that $X \to S$ is separated.
\end{proof}

\noindent
We end this section with a variant concerning finite morphisms.

\begin{lemma}
\label{lemma-finite-closed-in-finite-finite-presentation}
Let $f : X \to S$ be a morphism of schemes.
Assume:
\begin{enumerate}
\item The morphism $f$ is finite.
\item The scheme $S$ is quasi-compact and quasi-separated.
\end{enumerate}
Then there exists a morphism which is finite and of finite presentation
$f' : X' \to S$ and a closed immersion $X \to X'$ of schemes over $S$.
\end{lemma}

\begin{proof}
By Proposition \ref{proposition-separated-closed-in-finite-presentation}
there is a closed immersion $X \to Y$ with $g : Y \to S$
separated and of finite presentation. Let $\mathcal{I} \subset \mathcal{O}_Y$
be the quasi-coherent sheaf of ideals defining $X$ as a closed
subscheme of $Y$. By
Properties, Lemma \ref{properties-lemma-quasi-coherent-colimit-finite-type}
we can write $\mathcal{I}$ as a directed colimit
$\mathcal{I} = \colim_{a \in A} \mathcal{I}_a$ of its
quasi-coherent sheaves of ideals of finite type.
Let $X_a \subset Y$ be the closed subscheme defined by $\mathcal{I}_a$
and denote $f_a : X_a \to S$ the structure morphism.
These form an inverse system of schemes indexed by $A$.
The transition morphisms $X_a \to X_{a'}$ are affine because
they are closed immersions. Each $X_a$ is quasi-compact and separated
over $S$ since it is a closed subscheme of $Y$ and $Y$ is quasi-compact and
separated over $S$.
We have $X = \lim_a X_a$ as follows directly from the
fact that $\mathcal{I} = \colim_{a \in A} \mathcal{I}_a$.
Each of the morphisms $X_a \to Y$ is of finite presentation, see
Morphisms, Lemma \ref{morphisms-lemma-closed-immersion-finite-presentation}.
Hence the morphisms $X_a \to S$ are of finite presentation.
Thus it suffices to show that $f_a : X_a \to S$ is finite for some
$a \in A$.

\medskip\noindent
Choose a finite affine open covering $S = \bigcup_{j = 1, \ldots, n} V_j$.
For each $j$ the scheme $f^{-1}(V_j) = \lim_a f_a^{-1}(V_j)$
is affine (as a finite morphism is affine by definition). Hence by
Lemma \ref{lemma-limit-affine} there exists an $a \in A$ such that
each $f_a^{-1}(V_j)$ is affine. In other words, $f_a : X_a \to S$ is
affine, see Morphisms, Lemma \ref{morphisms-lemma-characterize-affine}.
By replacing $Y$ with $X_a$ we may assume $g : Y \to S$ is affine.

\medskip\noindent
For each $j = 1, \ldots, m$ the ring $\mathcal{O}_Y(g^{-1}(V_j))$
is a finitely presented $\mathcal{O}_S(V_j)$-algebra. Say it is
generated by $x_{ji}$, $i = 1, \ldots, n_j$. Note that the images
of $x_{ji}$ in $\mathcal{O}_X(f_a^{-1}(V_j))$,
resp.\ $\mathcal{O}_X(f^{-1}(V_j))$ generate over $\mathcal{O}_S(V_j)$ as well.
Since $f : X \to S$ is
finite, the image of $x_{ji}$ in $\mathcal{O}_X(f^{-1}(V_j))$
satisfies a monic polynomial $P_{ij}$ whose coefficients
are elements of $\mathcal{O}_S(V_j)$. Since
$\mathcal{O}_X(f^{-1}(V_j)) =
\colim_{a \in A} \mathcal{O}_{X_a}(f_a^{-1}(V_j))$
we see there exists an $a \in A$ such that
$P_{ji}(x_{ij})$ maps to zero in $\mathcal{O}_{X_a}(f_a^{-1}(V_j))$
for all $j, i$. It follows from
Morphisms, Lemma \ref{morphisms-lemma-finite-local}
that the morphism $f_a : X_a \to S$ is finite for this $a$.
\end{proof}





















\section{Descending relative objects}
\label{section-descending-relative}

\noindent
The following lemma is typical of the type of results in this section.
We write out the ``standard'' proof completely. It may be faster to
convince yourself that the result is true than to read this proof.

\begin{lemma}
\label{lemma-descend-finite-presentation}
Let $I$ be a directed partially ordered set.
Let $(S_i, f_{ii'})$ be an inverse system of schemes over $I$.
Assume
\begin{enumerate}
\item the morphisms $f_{ii'} : S_i \to S_{i'}$ are affine,
\item the schemes $S_i$ are quasi-compact and quasi-separated.
\end{enumerate}
Let $S = \lim_i S_i$. Then we have the following:
\begin{enumerate}
\item For any morphism of finite presentation $X \to S$
there exists an index $i \in I$ and a morphism of finite
presentation $X_i \to S_i$ such that $X \cong X_{i, S}$ as
schemes over $S$.
\item Given an index $i \in I$, schemes
$X_i$, $Y_i$ of finite presentation over $S_i$, and a morphism
$\varphi : X_{i, S} \to Y_{i, S}$ over $S$, there exists an index
$i' \geq i$ and a morphism
$\varphi_{i'} : X_{i, S_{i'}} \to Y_{i, S_{i'}}$
whose base change to $S$ is $\varphi$.
\item Given an index $i \in I$, schemes $X_i$, $Y_i$ of finite presentation
over $S_i$ and a pair of morphisms $\varphi_i, \psi_i : X_i \to Y_i$
whose base changes $\varphi_{i, S} = \psi_{i, S}$ are equal,
there exists an index $i' \geq i$ such that
$\varphi_{i, S_{i'}} = \psi_{i, S_{i'}}$.
\end{enumerate}
In other words, the category of schemes of finite presentation over
$S$ is the colimit over $I$ of the categories of schemes of finite
presentation over $S_i$.
\end{lemma}

\begin{proof}
In case each of the schemes $S_i$ is affine, and we consider
only affine schemes of finite presentation over $S_i$, resp.\ $S$
this lemma is equivalent to
Algebra, Lemma \ref{algebra-lemma-colimit-category-fp-algebras}.
We claim that the affine case implies the lemma in general.

\medskip\noindent
Let us prove (3). Suppose given an index $i \in I$, schemes
$X_i$, $Y_i$ of finite presentation over $S_i$ and a pair of morphisms
$\varphi_i, \psi_i : X_i \to Y_i$. Assume that the base changes are
equal: $\varphi_{i, S} = \psi_{i, S}$. We will use the notation
$X_{i'} = X_{i, S_{i'}}$ and $Y_{i'} = Y_{i, S_{i'}}$ for
$i' \geq i$. We also set $X = X_{i, S}$ and $Y = Y_{i, S}$.
Note that according to Lemma \ref{lemma-scheme-over-limit} we have
$X = \lim_{i' \geq i} X_{i'}$ and similarly for $Y$.
Additionally we denote $\varphi_{i'}$ and $\psi_{i'}$
(resp.\ $\varphi$ and $\psi$)
the base change of $\varphi_i$ and $\psi_i$ to $S_{i'}$
(resp.\ $S$). So our assumption means that $\varphi = \psi$.
Since $Y_i$ and $X_i$ are of finite presentation
over $S_i$, and since $S_i$ is quasi-compact and quasi-separated, also
$X_i$ and $Y_i$ are quasi-compact and quasi-separated
(see Morphisms,
Lemma \ref{morphisms-lemma-finite-presentation-quasi-compact-quasi-separated}).
Hence we may choose a finite affine open covering
$Y_i = \bigcup V_{j, i}$ such that each $V_{j, i}$ maps into
an affine open of $S$. As above, denote $V_{j, i'}$ the inverse
image of $V_{j, i}$ in $Y_{i'}$ and $V_j$ the inverse image in $Y$.
The immersions $V_{j, i'} \to Y_{i'}$ are quasi-compact, and the inverse images
$U_{j, i'} = \varphi_i^{-1}(V_{j, i'})$ and
$U_{j, i'}' = \psi_i^{-1}(V_{j, i'})$
are quasi-compact opens of $X_{i'}$. By assumption the inverse images of
$V_j$ under $\varphi$ and $\psi$ in $X$ are equal.
Hence by Lemma \ref{lemma-descend-opens}
there exists an index $i' \geq i$ such that
of $U_{j, i'} = U_{j, i'}'$ in $X_{i'}$.
Choose an finite affine open covering
$U_{j, i'} = U_{j, i'}' = \bigcup W_{j, k, i'}$
which induce coverings $U_{j, i''} = U_{j, i''}' = \bigcup W_{j, k, i''}$
for all $i'' \geq i'$.
By the affine case there exists
an index $i''$ such that
$\varphi_{i''}|_{W_{j, k, i''}} = \psi_{i''}|_{W_{j, k, i''}}$
for all $j, k$. Then $i''$ is an index such that
$\varphi_{i''} = \psi_{i''}$ and (3) is proved.

\medskip\noindent
Let us prove (2). Suppose given an index $i \in I$, schemes
$X_i$, $Y_i$ of finite presentation over $S_i$ and a morphism
$\varphi : X_{i, S} \to Y_{i, S}$. We will use the notation
$X_{i'} = X_{i, S_{i'}}$ and $Y_{i'} = Y_{i, S_{i'}}$ for
$i' \geq i$. We also set $X = X_{i, S}$ and $Y = Y_{i, S}$.
Note that according to Lemma \ref{lemma-scheme-over-limit} we have
$X = \lim_{i' \geq i} X_{i'}$ and similarly for $Y$.
Since $Y_i$ and $X_i$ are of finite presentation
over $S_i$, and since $S_i$ is quasi-compact and quasi-separated, also
$X_i$ and $Y_i$ are quasi-compact and quasi-separated
(see Morphisms,
Lemma \ref{morphisms-lemma-finite-presentation-quasi-compact-quasi-separated}).
Hence we may choose a finite affine open covering
$Y_i = \bigcup V_{j, i}$ such that each $V_{j, i}$ maps into
an affine open of $S$. As above, denote $V_{j, i'}$ the inverse
image of $V_{j, i}$ in $Y_{i'}$ and $V_j$ the inverse image in $Y$.
The immersions $V_j \to Y$ are quasi-compact, and the inverse images
$U_j = \varphi^{-1}(V_j)$ are quasi-compact opens of $X$.
Hence by Lemma \ref{lemma-descend-opens} there exists an index
$i' \geq i$ and quasi-compact opens $U_{j, i'}$ of $X_{i'}$
whose inverse image in $X$ is $U_j$. Choose an finite affine open covering
$U_{j, i'} = \bigcup W_{j, k, i'}$ which induce affine open
coverings $U_{j, i''} = \bigcup W_{j, k, i''}$
for all $i'' \geq i'$ and an affine open covering
$U_j = \bigcup W_{j, k}$. By the affine case there exists
an index $i''$ and morphisms
$\varphi_{j, k, i''} : W_{j, k, i''} \to V_{j, i''}$
such that
$\varphi|_{W_{j, k}} = \varphi_{j, k, i'', S}$ for all $j, k$.
By part (3) proved above, there is a further index $i''' \geq i''$
such that
$$
\varphi_{j_1, k_1, i'', S_{i'''}}|_{W_{j_1, k_1, i'''} \cap W_{j_2, k_2, i'''}}
=
\varphi_{j_2, k_2, i'', S_{i'''}}|_{W_{j_1, k_1, i'''} \cap W_{j_2, k_2, i'''}}
$$
for all $j_1, j_2, k_1, k_2$. Then $i'''$ is an index such that
there exists a morphism $\varphi_{i'''} : X_{i'''} \to Y_{i'''}$
whose base change to $S$ gives $\varphi$. Hence (2) holds.

\medskip\noindent
Let us prove (1). Suppose given a scheme $X$ of finite presentation
over $S$. Since $X$ is of finite presentation
over $S$, and since $S$ is quasi-compact and quasi-separated, also
$X$ is quasi-compact and quasi-separated
(see Morphisms,
Lemma \ref{morphisms-lemma-finite-presentation-quasi-compact-quasi-separated}).
Choose a finite affine open covering $X = \bigcup U_j$
such that each $U_j$ maps into an affine open $V_j \subset S$.
Denote $U_{j_1j_2} = U_{j_1} \cap U_{j_2}$ and
$U_{j_1j_2j_3} = U_{j_1} \cap U_{j_2} \cap U_{j_3}$.
By Lemmas \ref{lemma-descend-opens} and \ref{lemma-limit-affine}
we can find an index $i_1$ and affine opens $V_{j, i_1} \subset S_{i_1}$
such that each $V_j$ is the inverse of this in $S$.
Let $V_{j, i}$ be the inverse image of $V_{j, i_1}$ in $S_i$ for
$i \geq i_1$. By the affine case we may find an index $i_2 \geq i_1$ and
affine schemes $U_{j, i_2} \to V_{j, i_2}$ such
that $U_j = S \times_{S_{i_2}} U_{j, i_2}$ is the base change.
Denote $U_{j, i} = S_i \times_{S_{i_2}} U_{j, i_2}$ for $i \geq i_2$.
By Lemma \ref{lemma-descend-opens} there exists an index
$i_3 \geq i_2$ and open subschemes
$W_{j_1, j_2, i_3} \subset U_{j_1, i_3}$
whose base change to $S$ is equal to $U_{j_1j_2}$.
Denote $W_{j_1, j_2, i} = S_i \times_{S_{i_3}} W_{j_1, j_2, i_3}$
for $i \geq i_3$. By part (2) shown above there exists an index
$i_4 \geq i_3$ and morphisms
$\varphi_{j_1, j_2, i_4} : W_{j_1, j_2, i_4} \to W_{j_2, j_1, i_4}$
whose base change to $S$ gives the identity morphism
$U_{j_1j_2} = U_{j_2j_1}$ for all $j_1, j_2$.
For all $i \geq i_4$ denote
$\varphi_{j_1, j_2, i} = \text{id}_S \times \varphi_{j_1, j_2, i_4}$
the base change. We claim that for some $i_5 \geq i_4$ the system
$((U_{j, i_5})_j, (W_{j_1, j_2, i_5})_{j_1, j_2},
(\varphi_{j_1, j_2, i_5})_{j_1, j_2})$ forms a glueing datum
as in Schemes, Section \ref{schemes-section-glueing-schemes}.
In order to see this we have to verify that for $i$ large enough
we have
$$
\varphi_{j_1, j_2, i}^{-1}(W_{j_1, j_2, i} \cap W_{j_1, j_3, i})
=
W_{j_1, j_2, i} \cap W_{j_1, j_3, i}
$$
and that for large enough $i$ the cocycle condition holds.
The first condition follows from Lemma \ref{lemma-descend-opens}
and the fact that $U_{j_2j_1j_3} = U_{j_1j_2j_3}$.
The second from part (1) of the lemma proved above and the fact
that the cocycle condition holds for the maps
$\text{id} : U_{j_1j_2} \to U_{j_2j_1}$.
Ok, so now we can use Schemes, Lemma \ref{schemes-lemma-glue-schemes}
to glue the system
$((U_{j, i_5})_j, (W_{j_1, j_2, i_5})_{j_1, j_2},
(\varphi_{j_1, j_2, i_5})_{j_1, j_2})$ to get a scheme
$X_{i_5} \to S_{i_5}$. By construction the base change of
$X_{i_5}$ to $S$ is formed by glueing the open affines
$U_j$ along the opens $U_{j_1} \leftarrow U_{j_1j_2} \rightarrow U_{j_2}$.
Hence $S \times_{S_{i_5}} X_{i_5} \cong X$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-descend-affine-finite-presentation}
With notation and assumptions as in
Lemma \ref{lemma-descend-finite-presentation}.
Let $i \in I$.
Suppose that $\varphi_i : X_i \to Y_i$ is a morphism of schemes
of finite presentation over $S_i$.
If the base change of $\varphi_i$ to $S$ is affine,
then there exists an index $i' \geq i$ such that
$\text{id}_{S_{i'}} \times \varphi_i : X_{i, S_{i'}} \to Y_{i, S_{i'}}$
is affine.
\end{lemma}

\begin{proof}
For $i' \geq i$ denote $X_{i'} = S_{i'} \times_{S_i} X_i$ and similarly
for $Y_{i'}$. Denote $\varphi_{i'}$ the base change of $\varphi_i$ to
$S_{i'}$. Also set $X = S \times_{S_i} X_i$, $Y =S \times_{S_i} X_i$,
and $\varphi$ the base change of $\varphi_i$ to $S$.
Let $Y_i = \bigcup V_{j, i}$ be a finite affine open covering.
Set $U_{j, i} = \varphi_i^{-1}(V_{j, i})$. For $i' \geq i$ we denote
$V_{j, i'}$ the inverse image of $V_{j, i}$ in $Y_{i'}$ and
$U_{j, i'} = \varphi_{i'}^{-1}(V_{j, i'})$. Similarly we have
$U_j = \varphi^{-1}(V_j)$. Then $U_j = \lim_{i' \geq i} U_{j, i'}$
(see Lemma \ref{lemma-directed-inverse-system-has-limit}).
Since $U_j$ is affine by assumption we see that
each $U_{j, i'}$ is affine for $i'$ large enough, see
Lemma \ref{lemma-limit-affine}. Thus $\varphi_{i'}$ is
affine for $i'$ large enough, see
Morphisms, Lemma \ref{morphisms-lemma-characterize-affine}.
\end{proof}

\begin{lemma}
\label{lemma-descend-flat-finite-presentation}
With notation and assumptions as in
Lemma \ref{lemma-descend-finite-presentation}.
Let $i \in I$.
Suppose that $\varphi_i : X_i \to Y_i$ is a morphism of schemes
of finite presentation over $S_i$.
If the base change of $\varphi_i$ to $S$ is flat,
then there exists an index $i' \geq i$ such that
$\text{id}_{S_{i'}} \times \varphi_i : X_{i, S_{i'}} \to Y_{i, S_{i'}}$
is flat.
\end{lemma}

\begin{proof}
For $i' \geq i$ denote $X_{i'} = S_{i'} \times_{S_i} X_i$ and similarly
for $Y_{i'}$. Denote $\varphi_{i'}$ the base change of $\varphi_i$ to
$S_{i'}$. Also set $X = S \times_{S_i} X_i$, $Y =S \times_{S_i} X_i$,
and $\varphi$ the base change of $\varphi_i$ to $S$.
Let $Y_i = \bigcup_{j = 1, \ldots, m} V_{j, i}$ be a finite affine open
covering such that each $V_{j, i}$ maps into some affine open of $S_i$.
For each $j = 1, \ldots m$ let
$\varphi_i^{-1}(V_{j, i}) = \bigcup_{k = 1, \ldots, m(j)} U_{k, j, i}$
be a finite affine open covering. For $i' \geq i$ we denote
$V_{j, i'}$ the inverse image of $V_{j, i}$ in $Y_{i'}$ and
$U_{k, j, i'}$ the inverse image of $U_{k, j, i}$ in $X_{i'}$.
Similarly we have $U_{k, j} \subset X$ and $V_j \subset Y$.
Then $U_{k, j} = \lim_{i' \geq i} U_{k, j, i'}$
and $V_j = \lim_{i' \geq i} V_j$
(see Lemma \ref{lemma-directed-inverse-system-has-limit}).
Hence we see that the lemma reduces to the case that $X_i$ and
$Y_i$ are affine and map into an affine open of $S_i$, i.e., we
may also assume that $S$ is affine.

\medskip\noindent
In the affine case we reduce to the following algebra result.
Suppose that $R = \colim_{i \in I} R_i$. For some $i \in I$
suppose given a map $A_i \to B_i$ of finitely presented $R_i$-algebras.
Then, if $R \otimes_{R_i} A_i \to R \otimes_{R_i} B_i$ is flat, then
for some $i' \geq i$ the map
$R_{i'} \otimes_{R_i} A_i \to R_{i'} \otimes_{R_i} B_i$ is flat.
This follows from
Algebra,
Lemma \ref{algebra-lemma-flat-finite-presentation-limit-flat} part (3).
\end{proof}

\begin{lemma}
\label{lemma-descend-finite-finite-presentation}
With notation and assumptions as in
Lemma \ref{lemma-descend-finite-presentation}.
Let $i \in I$.
Suppose that $\varphi_i : X_i \to Y_i$ is a morphism of schemes
of finite presentation over $S_i$.
If the base change of $\varphi_i$ to $S$ is a finite morphism,
then there exists an index $i' \geq i$ such that
$\text{id}_{S_{i'}} \times \varphi_i : X_{i, S_{i'}} \to Y_{i, S_{i'}}$
is a finite morphism.
\end{lemma}

\begin{proof}
A finite morphism is affine, see
Morphisms, Definition \ref{morphisms-definition-integral}.
Hence by Lemma \ref{lemma-descend-affine-finite-presentation} above
we may assume that $\varphi_i$ is affine.
By writing $Y_i$ as a finite union of affines we reduce to proving
the result when $X_i$ and $Y_i$ are affine and map
into a common affine $W_i \subset S_i$. The corresponding algebra
statement follows from Algebra, Lemma \ref{algebra-lemma-colimit-finite}.
\end{proof}

\begin{lemma}
\label{lemma-descend-closed-immersion-finite-presentation}
With notation and assumptions as in
Lemma \ref{lemma-descend-finite-presentation}.
Let $i \in I$.
Suppose that $\varphi_i : X_i \to Y_i$ is a morphism of schemes
of finite presentation over $S_i$.
If the base change of $\varphi_i$ to $S$ is a closed immersion,
then there exists an index $i' \geq i$ such that
$\text{id}_{S_{i'}} \times \varphi_i : X_{i, S_{i'}} \to Y_{i, S_{i'}}$
is a closed immersion.
\end{lemma}

\begin{proof}
A closed immersion is affine, see
Morphisms, Lemma \ref{morphisms-lemma-closed-immersion-affine}.
Hence by Lemma \ref{lemma-descend-affine-finite-presentation} above
we may assume that $\varphi_i$ is affine.
By writing $Y_i$ as a finite union of affines we reduce to proving
the result when $X_i$ and $Y_i$ are affine and map
into a common affine $W_i \subset S_i$. The corresponding algebra
statement is a consequence of
Algebra, Lemma \ref{algebra-lemma-colimit-surjective}.
\end{proof}

\begin{lemma}
\label{lemma-descend-separated-finite-presentation}
With notation and assumptions as in
Lemma \ref{lemma-descend-finite-presentation}.
Let $i \in I$.
Suppose that $X_i$ is a scheme
of finite presentation over $S_i$.
If the base change of $X_i$ to $S$ is separated over $S$
then there exists an index $i' \geq i$ such that
$X_{i, S_{i'}}$ is separated over $S_{i'}$.
\end{lemma}

\begin{proof}
Apply Lemma \ref{lemma-descend-closed-immersion-finite-presentation}
to the diagonal morphism $\Delta_{X_i/S_i} : X_i \to X_i \times_{S_i} X_i$.
\end{proof}

\begin{lemma}
\label{lemma-descend-finite-locally-free}
With notation and assumptions as in
Lemma \ref{lemma-descend-finite-presentation}.
Let $i \in I$. Suppose that $\varphi_i : X_i \to Y_i$
is a morphism of schemes of finite presentation over $S$.
If the base change of $\varphi_i$ to $S$ is finite locally free
(of degree $d$) then there exists an index $i' \geq i$ such that
the base change of $\varphi_i$ to $S_{i'}$ is finite locally free
(of degree $d$).
\end{lemma}

\begin{proof}
By
Lemmas \ref{lemma-descend-flat-finite-presentation} and
\ref{lemma-descend-finite-finite-presentation}
we see that we may reduce to the case that $\varphi_i$ is flat and finite.
On the other hand, $\varphi_i$ is locally of finite presentation by
Morphisms, Lemma \ref{morphisms-lemma-finite-presentation-permanence}.
Hence $\varphi_i$ is finite locally free by
Morphisms, Lemma \ref{morphisms-lemma-finite-flat}.
If moreover $\varphi_i \times S$ is finite locally free of degree $d$,
then the image of $Y_i \times_{S_i} S \to Y_i$ is contained in the
open and closed locus $W_d \subset Y_i$ over which $\varphi_i$ has degree
$d$. By
Lemma \ref{lemma-limit-contained-in-constructible}
we see that for some $i' \gg i$ the image of $Y_{i'} \to Y_i$
is contained in $W_d$. Then the base change of $\varphi_i$ to
$S_{i'}$ will be finite locally free of degree $d$.
\end{proof}

\begin{lemma}
\label{lemma-descend-etale}
With notation and assumptions as in
Lemma \ref{lemma-descend-finite-presentation}.
Let $0 \in I$. Suppose that $\varphi_0 : X_0 \to Y_0$
is a morphism of schemes of finite presentation over $S$.
If the base change of $\varphi_0$ to $S$ is \'etale
then there exists an index $i \geq 0$ such that
the base change of $\varphi_0$ to $S_i$ is \'etale.
\end{lemma}

\begin{proof}
Being \'etale is local on the source and the target (Morphisms,
Lemma \ref{morphisms-lemma-etale-characterize}) hence we may assume all
$S_i, X_i, Y_i$ affine. The corresponding algebra fact is
Algebra, Lemma \ref{algebra-lemma-colimit-etale}.
\end{proof}

\begin{lemma}
\label{lemma-descend-modules-finite-presentation}
Let $I$ be a directed partially ordered set.
Let $(S_i, f_{ii'})$ be an inverse system of schemes over $I$.
Assume
\begin{enumerate}
\item all the morphisms $f_{ii'} : S_i \to S_{i'}$ are affine,
\item all the schemes $S_i$ are quasi-compact and quasi-separated.
\end{enumerate}
Let $S = \lim_i S_i$. Then we have the following:
\begin{enumerate}
\item For any sheaf of $\mathcal{O}_S$-modules
$\mathcal{F}$ of finite presentation there exists an index
$i \in I$ and a sheaf of $\mathcal{O}_{S_i}$-modules of finite
presentation $\mathcal{F}_i$ such that
$\mathcal{F} \cong f_i^*\mathcal{I}_i$.
\item Suppose given an index $i \in I$, sheaves
of $\mathcal{O}_{S_i}$-modules $\mathcal{F}_i$, $\mathcal{G}_i$
of finite presentation and a morphism
$\varphi : f_i^*\mathcal{F}_i \to f_i^*\mathcal{G}_i$ over $S$.
Then there exists an index $i' \geq i$ and a morphism
$\varphi_{i'} : f_{i'i}^*\mathcal{F}_i \to f_{i'i}^*\mathcal{G}_i$
whose base change to $S$ is $\varphi$.
\item Suppose given an index $i \in I$, sheaves of $\mathcal{O}_{S_i}$-modules
$\mathcal{F}_i$, $\mathcal{G}_i$ of finite presentation
and a pair of morphisms $\varphi_i, \psi_i : \mathcal{F}_i \to \mathcal{G}_i$.
Assume that the base changes are equal: $f_i^*\varphi_i = f_i^*\psi_i$.
Then there exists an index $i' \geq i$ such that
$f_{i'i}^*\varphi_i = f_{i'i}^*\psi_i$.
\end{enumerate}
In other words, the category of modules
of finite presentation over $S$ is the colimit over $I$
of the categories modules of finite presentation over $S_i$.
\end{lemma}

\begin{proof}
Omitted. Since we have written out completely the proof of
Lemma \ref{lemma-descend-finite-presentation} above
it seems wise to use this here and not completely write this
proof out also. For example we can use:
\begin{enumerate}
\item there is an equivalence of categories
between quasi-coherent $\mathcal{O}_S$-modules and
vector bundles over $S$, see
Constructions, Section \ref{constructions-section-vector-bundle}.
\item a vector bundle $\mathbf{V}(\mathcal{F}) \to S$ is
of finite presentation over $S$ if and only if $\mathcal{F}$
is an $\mathcal{O}_S$-module of finite presentation.
\end{enumerate}
Then you can descend morphisms in terms of morphisms of the
associated vectorbundles. Similarly for objects.
\end{proof}

\begin{lemma}
\label{lemma-descend-module-flat-finite-presentation}
With notation and assumptions as in
Lemma \ref{lemma-descend-finite-presentation}.
Let $i \in I$.
Suppose that $\varphi_i : X_i \to Y_i$ is a morphism of schemes
of finite presentation over $S_i$ and that $\mathcal{F}_i$ is a
quasi-coherent $\mathcal{O}_{X_i}$-module of finite presentation.
If the pullback of $\mathcal{F}_i$ to $X_i \times_{S_i} S$ is flat
over $Y_i \times_{S_i} S$, then there exists an index $i' \geq i$
such that the pullback of $\mathcal{F}_i$ to $X_i \times_{S_i} S_{i'}$
is flat over $Y_i \times_{S_i} S_{i'}$.
\end{lemma}

\begin{proof}
(This lemma is the analogue of
Lemma \ref{lemma-descend-flat-finite-presentation}
for modules.)
For $i' \geq i$ denote $X_{i'} = S_{i'} \times_{S_i} X_i$,
$\mathcal{F}_{i'} = (X_{i'} \to X_i)^*\mathcal{F}_i$ and similarly
for $Y_{i'}$. Denote $\varphi_{i'}$ the base change
of $\varphi_i$ to $S_{i'}$. Also set $X = S \times_{S_i} X_i$,
$Y =S \times_{S_i} X_i$, $\mathcal{F} = (X \to X_i)^*\mathcal{F}_i$
and $\varphi$ the base change of $\varphi_i$ to $S$.
Let $Y_i = \bigcup_{j = 1, \ldots, m} V_{j, i}$ be a finite affine open
covering such that each $V_{j, i}$ maps into some affine open of $S_i$.
For each $j = 1, \ldots m$ let
$\varphi_i^{-1}(V_{j, i}) = \bigcup_{k = 1, \ldots, m(j)} U_{k, j, i}$
be a finite affine open covering. For $i' \geq i$ we denote
$V_{j, i'}$ the inverse image of $V_{j, i}$ in $Y_{i'}$ and
$U_{k, j, i'}$ the inverse image of $U_{k, j, i}$ in $X_{i'}$.
Similarly we have $U_{k, j} \subset X$ and $V_j \subset Y$.
Then $U_{k, j} = \lim_{i' \geq i} U_{k, j, i'}$
and $V_j = \lim_{i' \geq i} V_j$
(see Lemma \ref{lemma-directed-inverse-system-has-limit}).
Since $X_{i'} = \bigcup_{k, j} U_{k, j, i'}$ is a finite open covering
it suffices to prove the lemma for each of the morphisms
$U_{k, j, i} \to V_{j, i}$ and the sheaf $\mathcal{F}_i|_{U_{k, j, i}}$.
Hence we see that the lemma reduces to the case that $X_i$ and
$Y_i$ are affine and map into an affine open of $S_i$, i.e., we
may also assume that $S$ is affine.

\medskip\noindent
In the affine case we reduce to the following algebra result.
Suppose that $R = \colim_{i \in I} R_i$. For some $i \in I$
suppose given a map $A_i \to B_i$ of finitely presented $R_i$-algebras.
Let $N_i$ be a finitely presented $B_i$-module.
Then, if $R \otimes_{R_i} N_i$ is flat over $R \otimes_{R_i} A_i$,
then for some $i' \geq i$ the module
$R_{i'} \otimes_{R_i} N_i$ is flat over $R_{i'} \otimes_{R_i} A$.
This is exactly the result proved in
Algebra,
Lemma \ref{algebra-lemma-flat-finite-presentation-limit-flat} part (3).
\end{proof}












\section{Characterizing affine schemes}
\label{section-affine}

\noindent
If $f : X \to S$ is a surjective integral morphism of schemes
such that $X$ is an affine scheme then $S$ is affine too.
See \cite[A.2]{Conrad-Nagata}. Our proof relies
on the Noetherian case which we stated and proved in Coherent,
Lemma \ref{coherent-lemma-image-affine-finite-morphism-affine-Noetherian}.
See also \cite[II 6.7.1]{EGA}.

\begin{lemma}
\label{lemma-affine}
Let $f : X \to S$ be a morphism of schemes.
Assume that $f$ is surjective and finite, and assume that $X$ is affine.
Then $S$ is affine.
\end{lemma}

\begin{proof}
Since $f$ is surjective and $X$ is quasi-compact we see that $S$ is
quasi-compact. Consider the commutative diagram
$$
\xymatrix{
X \ar[d] \ar[r]_-{\Delta} & X \times X \ar[d] \\
S  \ar[r]^-{\Delta} & S \times S
}
$$
(products over $\Spec(\mathbf{Z})$).
Since $X$ is separated the image of the top horizontal arrow
is closed. The right vertical arrow is the composition of
$X \times X \to X \times S \to S \times S$ and hence is finite
(see Morphisms, Lemmas \ref{morphisms-lemma-composition-finite} and
\ref{morphisms-lemma-base-change-finite}). Hence it is proper (see
Morphisms, Lemma \ref{morphisms-lemma-finite-proper}). Thus the image
of $\Delta(X)$ in $S \times S$ is closed. But as $X \to S$ is surjective
we conclude that $\Delta(S)$ is closed as well. Hence $S$ is separated.

\medskip\noindent
By Lemma \ref{lemma-finite-closed-in-finite-finite-presentation}
there exists a factorization $X \to Y \to S$, with $X \to Y$ a
closed immersion and $Y \to S$ finite and of finite presentation.
Let $\mathcal{I} \subset \mathcal{O}_Y$ be the quasi-coherent sheaf of
ideals cutting out the closed subscheme $X$ in $Y$.
By
Properties, Lemma \ref{properties-lemma-quasi-coherent-colimit-finite-type}
we can write $\mathcal{I}$ as a directed colimit
$\mathcal{I} = \colim_{a \in A} \mathcal{I}_a$ of its
quasi-coherent sheaves of ideals of finite type.
Let $X_a \subset Y$ be the closed subscheme defined by $\mathcal{I}_a$.
These form an inverse system of schemes indexed by $A$.
The transition morphisms $X_a \to X_{a'}$ are affine because
they are closed immersions. Each $X_a$ is quasi-compact and quasi-separated
since it is a closed subscheme of $Y$ and $Y$ is quasi-compact and
quasi-separated.
Each of the morphisms $X_a \to Y$ is of finite presentation, see
Morphisms, Lemma \ref{morphisms-lemma-closed-immersion-finite-presentation}.
Hence the morphisms $X_a \to S$ are of finite presentation, and
also finite as the composition of a closed immersion and a finite morphism.
We have $X = \lim_a X_a$ as follows directly from the
fact that $\mathcal{I} = \colim_{a \in A} \mathcal{I}_a$.
Hence by Lemma \ref{lemma-limit-affine} we see that $X_a$ is affine for some
$a \in A$. Replacing $X$ by $X_a$ we may assume that $X \to S$ is surjective,
finite, of finite presentation and that $X$ is affine.

\medskip\noindent
By Proposition \ref{proposition-approximate} we may write
$S = \lim_{i \in I} S_i$ as
a directed limits as schemes of finite type over $\mathbf{Z}$.
By Lemma \ref{lemma-descend-finite-presentation} we can
after shrinking $I$ assume there exist schemes $X_i \to S_i$
of finite presentation such that $X_{i'} = X_i \times_S S_{i'}$
for $i' \geq i$ and such that $X = \lim_i X_i$. By
Lemma \ref{lemma-descend-finite-finite-presentation} we may
assume that $X_i \to S_i$ is finite for all $i \in I$ as well.
By Lemma \ref{lemma-limit-affine} once again we may assume that $X_i$ is
affine for all $i \in I$. Hence the result follows from the
Noetherian case, see Coherent,
Lemma \ref{coherent-lemma-image-affine-finite-morphism-affine-Noetherian}.
\end{proof}

\begin{proposition}
\label{proposition-affine}
Let $f : X \to S$ be a morphism of schemes.
Assume that $f$ is surjective and integral, and assume that $X$ is affine.
Then $S$ is affine.
\end{proposition}

\begin{proof}
Since $f$ is surjective and $X$ is quasi-compact we see that $S$ is
quasi-compact. Consider the commutative diagram
$$
\xymatrix{
X \ar[d] \ar[r]_-{\Delta} & X \times X \ar[d] \\
S  \ar[r]^-{\Delta} & S \times S
}
$$
(products over $\Spec(\mathbf{Z})$).
Since $X$ is separated the image of the top horizontal arrow
is closed. The right vertical arrow is the composition of
$X \times X \to X \times S \to S \times S$ and hence is integral
(see Morphisms, Lemmas \ref{morphisms-lemma-composition-finite} and
\ref{morphisms-lemma-base-change-finite}). Hence it is universally closed (see
Morphisms, Lemma \ref{morphisms-lemma-integral-universally-closed}).
Thus the image of $\Delta(X)$ in $S \times S$ is closed. But as
$X \to S$ is surjective we conclude that $\Delta(S)$ is closed as well.
Hence $S$ is separated. This in particular implies that $f$ is
an affine morphism, see
Morphisms, Lemma \ref{morphisms-lemma-affine-permanence}.

\medskip\noindent
Consider the sheaf $\mathcal{A} = f_*\mathcal{O}_X$.
This is a quasi-coherent sheaf of $\mathcal{O}_S$-algebras, see
Schemes, Lemma \ref{schemes-lemma-push-forward-quasi-coherent}.
By
Properties, Lemma \ref{properties-lemma-quasi-coherent-colimit-finite-type}
we can write $\mathcal{A} = \colim_i \mathcal{F}_i$ as a filtered
colimit of finite type $\mathcal{O}_X$-modules. Let
$\mathcal{A}_i \subset \mathcal{A}$ be the $\mathcal{O}_X$-subalgebra
generated by $\mathcal{F}_i$. Since the map of algebras
$\mathcal{O}_X \to \mathcal{A}$ is integral, we see that each $\mathcal{A}_i$
is a finite quasi-coherent $\mathcal{O}_S$-algebra. Hence
$$
X_i = \underline{\Spec}_S(\mathcal{A}_i)
\longrightarrow
S
$$
is a finite morphism of schemes. It is clear that
$X = \lim_i X_i$. Hence by
Lemma \ref{lemma-limit-affine}
we see that for $i$ sufficiently large the scheme $X_i$ is affine. Moreover,
since $X \to S$ factors through each $X_i$ we see that $X_i \to S$ is
surjective. Hence we conclude that $S$ is affine by
Lemma \ref{lemma-affine}.
\end{proof}
























\section{Variants of Chow's Lemma}
\label{section-chows-lemma}

\noindent
In this section we prove a number of variants of Chow's lemma.
The most interesting version is probably just the Noetherian
case, which we stated and proved in
Coherent, Section \ref{coherent-section-chows-lemma}.

\begin{lemma}
\label{lemma-chow-finite-type}
Let $S$ be a quasi-compact and quasi-separated scheme.
Let $f : X \to S$ be a separated morphism of finite type.
Then there exists an $n \geq 0$ and a diagram
$$
\xymatrix{
X \ar[rd] & X' \ar[d] \ar[l]^\pi \ar[r] & \mathbf{P}^n_S \ar[dl] \\
& S &
}
$$
where $X' \to \mathbf{P}^n_S$ is an immersion, and
$\pi : X' \to X$ is proper and surjective.
\end{lemma}

\begin{proof}
By Proposition \ref{proposition-separated-closed-in-finite-presentation}
we can find a closed immersion $X \to Y$ where $Y$ is separated
and of finite presentation over $S$. Clearly, if we prove the assertion
for $Y$, then the result follows for $X$. Hence we may assume that
$X$ is of finite presentation over $S$.

\medskip\noindent
Write $S = \lim_i S_i$ as a directed limit of Noetherian schemes, see
Proposition \ref{proposition-approximate}. By
Lemma \ref{lemma-descend-finite-presentation} we can
find an index $i \in I$ and a scheme $X_i \to S_i$ of finite presentation
so that $X = S \times_{S_i} X_i$.
By Lemma \ref{lemma-descend-separated-finite-presentation}
we may assume that $X_i \to S_i$ is separated.
Clearly, if we prove the assertion for
$X_i$ over $S_i$, then the assertion holds for $X$. The case
$X_i \to S_i$ is treated by
Coherent, Lemma \ref{coherent-lemma-chow-Noetherian}.
\end{proof}

\noindent
Here is a variant of Chow's lemma where we assume the scheme
on top has finitely many irreducible components.

\begin{lemma}
\label{lemma-chow-EGA}
Let $S$ be a quasi-compact and quasi-separated scheme.
Let $f : X \to S$ be a separated morphism of finite type.
Assume that $X$ has finitely many irreducible components.
Then there exists an $n \geq 0$ and a diagram
$$
\xymatrix{
X \ar[rd] & X' \ar[d] \ar[l]^\pi \ar[r] & \mathbf{P}^n_S \ar[dl] \\
& S &
}
$$
where $X' \to \mathbf{P}^n_S$ is an immersion, and
$\pi : X' \to X$ is proper and surjective. Moreover, there exists
an open dense subscheme $U \subset X$ such that $\pi^{-1}(U) \to U$
is an isomorphism of schemes.
\end{lemma}

\begin{proof}
Let $X = Z_1 \cup \ldots \cup Z_n$ be the decomposition of $X$
into irreducible components. Let $\eta_j \in Z_j$ be the generic point.

\medskip\noindent
There are (at least) two ways to proceed with the proof.
The first is to redo the proof of
Coherent, Lemma \ref{coherent-lemma-chow-Noetherian}
using the general
Properties, Lemma \ref{properties-lemma-point-and-maximal-points-affine}
to find suitable affine opens in $X$. (This is the ``standard'' proof.)
The second is to use absolute Noetherian approximation as in
the proof of Lemma \ref{lemma-chow-finite-type} above.
This is what we will do here.

\medskip\noindent
By Proposition \ref{proposition-separated-closed-in-finite-presentation}
we can find a closed immersion $X \to Y$ where $Y$ is separated
and of finite presentation over $S$.
Write $S = \lim_i S_i$ as a directed limit of Noetherian schemes, see
Proposition \ref{proposition-approximate}. By
Lemma \ref{lemma-descend-finite-presentation} we can
find an index $i \in I$ and a scheme $Y_i \to S_i$ of finite presentation
so that $Y = S \times_{S_i} Y_i$.
By Lemma \ref{lemma-descend-separated-finite-presentation}
we may assume that $Y_i \to S_i$ is separated.
We have the following diagram
$$
\xymatrix{
\eta_j \in Z_j \ar[r] & X \ar[r] \ar[rd] & Y \ar[r] \ar[d] & Y_i \ar[d] \\
& & S \ar[r] & S_i
}
$$
Denote $h : X \to Y_i$ the composition.

\medskip\noindent
For $i' \geq i$ write $Y_{i'} = S_{i'} \times_{S_i} Y_i$.
Then $Y = \lim_{i' \geq i} Y_{i'}$, see
Lemma \ref{lemma-scheme-over-limit}.
Choose $j, j' \in \{1, \ldots, n\}$, $j \not = j'$.
Note that $\eta_j$ is not a specialization of $\eta_{j'}$.
By Lemma \ref{lemma-topology-limit}
we can replace $i$ by a bigger index and assume
that $h(\eta_j)$ is not a specialization of $h(\eta_{j'})$
for all pairs $(j, j')$ as above.
For such an index, let
$Y' \subset Y_i$ be the scheme theoretic image of
$h : X \to Y_i$, see
Morphisms, Definition \ref{morphisms-definition-scheme-theoretic-image}.
The morphism $h$ is quasi-compact as the composition of the quasi-compact
morphisms $X \to Y$ and $Y \to Y_i$ (which is affine).
Hence by
Morphisms, Lemma \ref{morphisms-lemma-quasi-compact-scheme-theoretic-image}
the morphism $X \to Y'$ is dominant. Thus the generic points
of $Y'$ are all contained in the set
$\{h(\eta_1), \ldots, h(\eta_n)\}$, see
Morphisms, Lemma \ref{morphisms-lemma-quasi-compact-dominant}.
Since none of the $h(\eta_j)$ is the specialization of another
we see that the points $h(\eta_1), \ldots, h(\eta_n)$ are pairwise
distinct and are each a generic point of $Y'$.

\medskip\noindent
We apply
Coherent, Lemma \ref{coherent-lemma-chow-Noetherian} above to the morphism
$Y' \to S_i$. This gives a diagram
$$
\xymatrix{
Y' \ar[rd] & Y^* \ar[d] \ar[l]^\pi \ar[r] & \mathbf{P}^n_{S_i} \ar[dl] \\
& S_i &
}
$$
such that $\pi$ is proper and surjective and an isomorphism over
a dense open subscheme $V \subset Y'$. By our choice of $i$ above
we know that $h(\eta_1), \ldots, h(\eta_n) \in V$. Consider
the commutative diagram
$$
\xymatrix{
X' \ar@{=}[r] &
X \times_{Y'} Y^* \ar[r] \ar[d] &
Y^* \ar[r] \ar[d] &
\mathbf{P}^n_{S_i} \ar[ddl] \\
& X \ar[r] \ar[d] & Y' \ar[d] & \\
& S \ar[r] & S_i &
}
$$
Note that $X' \to X$ is an isomorphism over the open subscheme
$U = h^{-1}(V)$ which contains each of the $\eta_j$ and hence is
dense in $X$. We conclude $X \leftarrow X' \rightarrow \mathbf{P}^n_S$
is a solution to the problem posed in the lemma.
\end{proof}













\section{Applications of Chow's lemma}
\label{section-apply-chow}

\noindent
We can use Chow's lemma to investigate the notions of proper and separated
morphisms. As a first application we have the following.

\begin{lemma}
\label{lemma-limited-base-change}
Let $S$ be a scheme.
Let $f : X \to S$ be a separated morphism of finite type.
The following are equivalent:
\begin{enumerate}
\item The morphism $f$ is proper.
\item For any morphism $S' \to S$ which is locally of finite type
the base change $X_{S'} \to S'$ is closed.
\item For every $n \geq 0$ the morphism
$\mathbf{A}^n \times X \to \mathbf{A}^n \times S$ is closed.
\end{enumerate}
\end{lemma}

\begin{proof}
Clearly (1) implies (2), and (2) implies (3), so we just need to show (3)
implies (1).
First we reduce to the case when $S$ is affine.  Assume that (3) implies (1)
when the base is affine.  Now let $f: X \to S$ be a separated morphism of
finite type.  Being proper is local on the base
(see Morphisms, Lemma \ref{morphisms-lemma-proper-local-on-the-base}), so if
$S = \bigcup_\alpha S_\alpha$ is an open affine cover, and if
we denote $X_\alpha := f^{-1}(S_\alpha)$, then it is
enough to show that $f|_{X_\alpha}: X_\alpha \to S_\alpha$ is proper
for all $\alpha$.  Since $S_\alpha$ is affine, if
the map $f|_{X_\alpha}$ satisfies (3), then it will satisfy (1)
by assumption, and will be proper.  To finish the reduction to the
case $S$ is affine, we must show that if $f: X \to S$ is separated of
finite type satisfying (3), then $f|_{X_\alpha} : X_\alpha \to S_\alpha$
is separated of finite type satisfying (3).  Separatedness and finite
type are clear.  To see (3), notice that
$\mathbf{A}^n \times X_\alpha$ is the open preimage of
$\mathbf{A}^n \times S_\alpha$ under the map $1 \times f$.  Fix a closed
set $Z \subset \mathbf A^n \times X_\alpha$.  Let $\bar Z$ denote the
closure of $Z$ in $\mathbf{A}^n \times X$.  Then for topological
reasons,
$$
1 \times f(\bar Z) \cap \mathbf{A}^n \times S_\alpha  = 1 \times f(Z).
$$
Hence $1 \times f(Z)$ is closed, and we have reduced the proof of
(3) $\Rightarrow$ (1) to the affine case.

\medskip\noindent
Assume $S$ affine, and $f : X \to S$ separated of finite type.
We can apply Chow's Lemma \ref{lemma-chow-finite-type}
to get $\pi : X' \to X$ proper surjective and $X' \to \mathbf{P}^n_S$
an immersion. If $X$ is proper over $S$, then $X' \to S$ is proper
(Morphisms, Lemma \ref{morphisms-lemma-composition-proper}). Since
$\mathbf{P}^n_S \to S$ is separated, we conclude that $X' \to
\mathbf{P}^n_S$ is proper
(Morphisms, Lemma \ref{morphisms-lemma-image-proper-scheme-closed})
and hence a closed immersion
(Schemes, Lemma \ref{schemes-lemma-immersion-when-closed}).
Conversely, assume $X' \to \mathbf{P}^n_S$ is a closed immersion.
Consider the diagram:
\begin{equation}
\label{equation-check-proper}
\xymatrix{
X' \ar[r] \ar@{->>}[d]_{\pi} &
\mathbf{P}^n_S \ar[d] \\
X \ar[r]^f & S
}
\end{equation}
All maps are a priori proper except for $X \to S$.
Hence we conclude that $X \to S$ is proper by
Morphisms, Lemma \ref{morphisms-lemma-image-proper-is-proper}.
Therefore, we have shown that $X \to S$ is proper if and only if
$X' \to \mathbf{P}^n_S$ is a closed immersion.

\medskip\noindent
Assume $S$ is affine and (3) holds, and let $n, X', \pi$ be as above.
Since being a closed morphism is local on the base, the map
$X \times \mathbf{P}^n \to S \times \mathbf{P}^n$ is closed since by (3)
$X \times \mathbf{A}^n \to S \times \mathbf{A}^n$ is closed and since
projective space is covered by copies of affine $n$-space, see
Constructions,
Lemma \ref{constructions-lemma-standard-covering-projective-space}.
By Morphisms, Lemma \ref{morphisms-lemma-base-change-proper}
the morphism
$$
X' \times_S \mathbf{P}^n_S
\to
X \times_S \mathbf{P}^n_S =
X \times \mathbf{P}^n
$$
is proper. Since $\mathbf{P}^n$ is separated, the projection
$$
X' \times_S \mathbf{P}^n_S = \mathbf{P}^n_{X'} \to X'
$$
will be separated as it is just a base change of a separated
morphism. Therefore, the map $X' \to X' \times_S \mathbf{P}^n_S$ is proper,
since it is a section to a separated map (see
Schemes, Lemma \ref{schemes-lemma-section-immersion}).
Composing all these proper morphisms
$$
X' \to X' \times_S \mathbf{P}^n_S \to X \times_S \mathbf{P}^n_S
= X \times \mathbf{P}^n \to S \times \mathbf{P}^n = \mathbf{P}^n_S
$$
we see
that the map $X' \to \mathbf{P}^n_S$ is proper, and hence a closed
immersion.
\end{proof}

\noindent
If the base is Noetherian we can show that the valuative criterion holds
using only discrete valuation rings. First we state the result concerning
separation. We will often use solid commutative diagrams of morphisms of
schemes having the following shape
\begin{equation}
\label{equation-valuative}
\xymatrix{
\Spec(K) \ar[r] \ar[d] & X \ar[d] \\
\Spec(A) \ar[r] \ar@{-->}[ru] & S
}
\end{equation}
with $A$ a valuation ring and $K$ its field of fractions.

\begin{lemma}
\label{lemma-Noetherian-dvr-valuative-separation}
Let $S$ be a locally Noetherian scheme.
Let $f : X \to S$ be a morphism of schemes.
Assume $f$ is locally of finite type.
The following are equivalent:
\begin{enumerate}
\item The morphism $f$ is separated.
\item For any diagram (\ref{equation-valuative}) there is at most
one dotted arrow.
\item For all diagrams (\ref{equation-valuative}) with $A$ a discrete
valuation ring there is at most one dotted arrow.
\item For any irreducible component $X_0$ of $X$ with
generic point $\eta \in X_0$, for any discrete valuation ring
$A \subset K = \kappa(\eta)$ with fraction field $K$ and any
diagram (\ref{equation-valuative}) such that
the morphism $\Spec(K) \to X$ is the canonical one
(see Schemes, Section \ref{schemes-section-points})
there is at most one dotted arrow.
\end{enumerate}
\end{lemma}

\begin{proof}
Clearly (1) implies (2), (2) implies (3), and (3) implies (4).  It
remains to show (4) implies (1). Assume (4).
We begin by reducing to $S$ affine.  Being separated is a local
on the base (see
Schemes, Lemma \ref{schemes-lemma-characterize-separated}).
Hence, as in the proof of Lemma
\ref{lemma-limited-base-change}, if we can show that whenever
$X \to S$ has (4) that the restriction $X_\alpha \to S_\alpha$ has (4)
where $S_\alpha \subset S$ is an (affine) open subset and $X_\alpha :=
f^{-1}(S_\alpha)$, then we will be done.  The
generic points of the irreducible components of $X_\alpha$ will be the
generic points of irreducible components of $X$, since $X_\alpha$ is
open in $X$.  Therefore, any two distinct dotted arrows in the diagram
\begin{equation}
\label{equation-valuative-alpha}
\xymatrix{
\Spec(K) \ar[r] \ar[d] & X_\alpha \ar[d] \\
\Spec(A) \ar[r] \ar@{-->}[ru] & S_\alpha
}
\end{equation}
would then give two distinct arrows in diagram
(\ref{equation-valuative}) via the maps $X_\alpha \to X$ and
$S_\alpha \to S$, which is a contradiction.  Thus we have reduced
to the case $S$ is affine.  We remark that in the course of this
reduction, we prove that if $X \to S$ has (4) then the restriction $U
\to V$ has (4) for opens $U \subset X$ and $V \subset S$ with
$f(U) \subset V$.

\medskip\noindent
We next wish to reduce to the case $X \to S$ is finite type.  Assume
that we know (4) implies (1) when $X$ is finite type. Since
$S$ is Noetherian and $X$ is locally of finite type over $S$
we see $X$ is locally Noetherian as well (see Morphisms,
Lemma \ref{morphisms-lemma-finite-type-noetherian}).
Thus, $X \to S$ is quasi-separated (see
Properties, Lemma \ref{properties-lemma-locally-Noetherian-quasi-separated}),
and therefore we may apply the valuative criterion to check whether $X$
is separated (see
Schemes, Lemma \ref{schemes-lemma-valuative-criterion-separatedness}).
Let $X = \bigcup_\alpha X_\alpha$ be an affine open
cover of $X$. Given any two dotted arrows, in a diagram
(\ref{equation-valuative}), the image of the closed points of
$\text{Spec } A$ will
fall in two sets $X_\alpha$ and $X_\beta$.  Since $X_\alpha \cup
X_\beta$ is open, for topological reasons it must contain the image of
$\Spec(A)$ under both maps. Therefore, the two dotted arrows factor
through $X_\alpha \cup X_\beta \to X$, which is a scheme of finite type over
$S$. Since $X_\alpha \cup X_\beta$ is an open subset of $X$, by our
previous remark, $X_\alpha \cup X_\beta$ satisfies (4), so by
assumption, is separated.  This implies the two given dotted
arrows are the same. Therefore, we have reduced to $X \to S$ is finite type.

\medskip\noindent
Assume $X \to S$ of finite type and assume (4).
Since $X \to S$ is finite type, and $S$ is an affine Noetherian
scheme, $X$ is also Noetherian (see
Morphisms, Lemma \ref{morphisms-lemma-finite-type-noetherian}).
Therefore, $X \to X \times_S X$ will
be a quasi-compact immersion of Noetherian schemes.  We proceed by
contradiction.  Assume that $X \to X \times_S X$ is not closed.  Then,
there is some $y \in X \times_S X$ in the closure of the image that is
not in the image. As $X$ is Noetherian it has finitely many irreducible
components. Therefore, $y$ is in the closure of the image of one of
the irreducible components $X_0 \subset X$.  Give $X_0$ the reduced
induced structure.  The composition $X_0 \to X \to X \times_S X$
factors through the closed subscheme $X_0 \times_S X_0 \subset X \times_S X$.
Denote the closure of $\Delta(X_0)$ in $X_0 \times_S X_0$
by $\bar X_0$ (again as a reduced closed subscheme). Thus $y \in \bar X_0$.
Since $X_0 \to X_0 \times_S X_0$ is an immersion, the image of $X_0$
will be open in $\bar X_0$. Hence $X_0$ and $\bar X_0$ are
birational. Since $\bar{X}_0$ is a closed subscheme of a
Noetherian scheme, it is Noetherian. Thus, the local ring
$\mathcal O_{{\bar X_0, y}}$ is a local Noetherian domain with fraction
field $K$ equal to the function field of $X_0$.  By the Krull-Akizuki
theorem (see Algebra, Lemma \ref{algebra-lemma-exists-dvr}), there exists a
discrete valuation ring $A$ dominating $\mathcal O_{{\bar X_0, y}}$
with fraction field $K$.  This allows to to construct a diagram:
\begin{equation}
\label{equation-valuative-generic}
\xymatrix{
\text{Spec }K \ar[r] \ar[d] & X_0 \ar[d]^{\Delta} \\
A \ar[r] \ar@{-->}[ur]& X_0 \times_S X_0 \\
}
\end{equation}
which sends $\text{Spec K}$ to the generic point of $\Delta(X_0)$ and
the closed point of $A$ to $y \in X_0 \times_S X_0$ (use the material in
Schemes, Section \ref{schemes-section-points} to construct the arrows).
There cannot even exist
a set theoretic dotted arrow, since $y$ is not in the image of
$\Delta$ by our choice of $y$.  By categorical means, the existence of
the dotted arrow in the above diagram is equivalent to the uniqueness
of the dotted arrow in the following diagram:
\begin{equation}
\label{equation-valuative-nonexistent}
\xymatrix {
\text{Spec } K \ar[r] \ar[d] & X_0 \ar[d]\\
A \ar[r] \ar@{-->}[ur] & S \\
}
\end{equation}
Therefore, we have non-uniqueness in this latter diagram by the
nonexistence in the first.  Therefore, $X_0$ does not satisfy
uniqueness for discrete valuation rings, and since $X_0$ is an
irreducible component of $X$, we have that $X \to S$ does not satisfy
(4).  Therefore, we have shown (4) implies (1).
\end{proof}

\begin{lemma}
\label{lemma-Noetherian-dvr-valuative-proper}
Let $S$ be a locally Noetherian scheme.
Let $f : X \to S$ be a morphism of finite type.
The following are equivalent:
\begin{enumerate}
\item The morphism $f$ is proper.
\item For any diagram (\ref{equation-valuative}) there exists exactly
one dotted arrow.
\item For all diagrams (\ref{equation-valuative}) with $A$ a discrete
valuation ring there exists exactly one dotted arrow.
\item For any irreducible component $X_0$ of $X$ with
generic point $\eta \in X_0$, for any discrete valuation ring
$A \subset K = \kappa(\eta)$ with fraction field $K$ and any
diagram (\ref{equation-valuative}) such that
the morphism $\Spec(K) \to X$ is the canonical one
(see
Schemes, Section \ref{schemes-section-points})
there exists exactly one dotted arrow.
\end{enumerate}
\end{lemma}

\begin{proof}
(1) implies (2) implies (3) implies (4).  We will now show (4) implies
(1).  As in the proof of Lemma \ref{lemma-Noetherian-dvr-valuative-separation},
we can reduce to the
case $S$ is affine, since properness is local on the base, and if $X
\to S$ satisfies (4), then $X_\alpha \to S_\alpha$ does as well for
open $S_\alpha \subset S$ and $X_\alpha = f^{-1}(S_\alpha)$.

\medskip\noindent
Now $S$ is a Noetherian scheme, and so $X$ is as well, since $X \to
S$ is of finite type.  Now we may use Chow's lemma
(Coherent, Lemma \ref{coherent-lemma-chow-Noetherian})
to get a surjective, proper, birational
$X' \to X$ and an immersion $X' \to \mathbf{P}^n_S$.  We wish to
show $X \to S$ is universally closed.  As in the proof of Lemma
\ref{lemma-limited-base-change}, it is enough to check that
$X' \to \mathbf{P}^n_S$ is a closed immersion.
For the sake of contradiction, assume that $X' \to
\mathbf{P}^n_S$ is not a closed immersion.  Then there is some $y
\in \mathbf{P}^n_S$ that is in the closure of the image of $X'$, but
is not in the image.  So $y$ is in the closure of the image of an
irreducible component $X_0'$ of $X'$, but not in the image.
Let $\bar X_0' \subset \mathbf{P}^n_S$ be the closure of
the image of $X_0'$. As $X' \to \mathbf{P}^n_S$ is an immersion
of Noetherian schemes, the morphism $X'_0 \to \bar X_0'$ is
open and dense. By
Algebra, Lemma \ref{algebra-lemma-exists-dvr}
or
Properties, Lemma \ref{properties-lemma-locally-Noetherian-specialization-dvr}
we can find a discrete valuation ring $A$ dominating
$\mathcal{O}_{\bar X_0', y}$ and with identical field
of fractions $K$. It is clear that
$K$ is the residue field at the generic point of $X_0'$.
Thus the solid commutative diagram
\begin{equation}
\label{equation-solid}
\xymatrix{
\text{Spec } K \ar[r] \ar[d] & X' \ar [r] \ar[d] &
\mathbf{P}^n_S \ar[d] \\
\text{Spec } A \ar@{-->}[r] \ar@{-->}[ru] \ar[urr] & X \ar[r] & S\\
}
\end{equation}
Note that the closed point of $A$ maps to $y \in \mathbf{P}^n_S$.  By
construction, there does not exist a set theoretic lift to $X'$.
As $X' \to X$ is birational, the image of $X'_0$ in $X$ is an
irreducible component $X_0$ of $X$ and $K$ is also identified with
the function field of $X_0$. Hence, as $X \to S$ is assumed to satisfy (4),
the dotted arrow $\Spec(A) \to X$ exists.
Since $X' \to X$ is proper, the dotted
arrow lifts to the dotted arrow $\Spec(A) \to X'$ (use Schemes,
Proposition \ref{schemes-proposition-characterize-universally-closed}).
We can compose this with the immersion $X' \to \mathbf{P}^n_S$ to obtain
another morphism (not depicted in the diagram) from
$\Spec(A) \to \mathbf{P}^n_S$.  Since $\mathbf{P}^n_S$
is proper over $S$, it satisfies (2), and so these two morphisms
agree.  This is a contradiction, for we have constructed the
forbidden lift of our original map $\Spec(A) \to \mathbf{P}^n_S$
to $X'$.
\end{proof}




\section{Universally closed morphisms}
\label{section-universally-closed}

\noindent
In this section we discuss when a quasi-compact but not necessarily
separated morphism is universally closed. We first prove a lemma which
will allow us to check universal closedness after a base change
which is locally of finite presentation.

\begin{lemma}
\label{lemma-separate}
Let $f : X \to S$ be a quasi-compact morphism of schemes.
Let $g : T \to S$ be a morphism of schemes.
Let $t \in T$ be a point and $Z \subset X_T$ be a closed
subscheme such that $Z \cap X_t = \emptyset$.
Then there exists an open neighbourhood
$V \subset T$ of $t$, a commutative diagram
$$
\xymatrix{
V \ar[d] \ar[r]_a & T' \ar[d]^b \\
T \ar[r]^g & S,
}
$$
and a closed subscheme $Z' \subset X_{T'}$ such that
\begin{enumerate}
\item the morphism $b : T' \to S$ is locally of finite presentation,
\item with $t' = a(t)$ we have $Z' \cap X_{t'} = \emptyset$, and
\item $Z \cap X_V$ maps into $Z'$ via the morphism $X_V \to X_{T'}$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $s = g(t)$. During the proof we may always replace $T$ by an
open neighbourhood of $t$. Hence we may also replace $S$ by an open
neighbourhood of $s$. Thus we may and do assume that $T$ and $S$ are affine.
Say $S = \Spec(A)$, $T = \Spec(B)$, $g$ is given by the
ring map $A \to B$, and $t$ correspond to the prime ideal
$\mathfrak q \subset B$.

\medskip\noindent
As $X \to S$ is quasi-compact and $S$ is affine we may write
$X = \bigcup_{i = 1, \ldots, n} U_i$ as a finite union of affine opens.
Write $U_i = \Spec(C_i)$. In particular we have
$X_T = \bigcup_{i = 1, \ldots, n} U_{i, T} =
\bigcup_{i = 1, \ldots n} \Spec(C_i \otimes_A B)$.
Let $I_i \subset C_i \otimes_A B$ be the ideal corresponding to the
closed subscheme $Z \cap U_{i, T}$. The condition that
$Z \cap X_t = \emptyset$ signifies that $I_i$ generates the
unit ideal in the ring
$$
C_i \otimes_A \kappa(\mathfrak q) =
(B \setminus \mathfrak q)^{-1}\left(
C_i \otimes_A B/\mathfrak q C_i \otimes_A B \right)
$$
Since $I_i (B \setminus \mathfrak q)^{-1}(C_i \otimes_A B) =
(B \setminus \mathfrak q)^{-1} I_i$ this means that $1 = x_i/g_i$
for some $x_i \in I_i$ and $g_i \in B$, $g_i \not \in \mathfrak q$.
Thus, clearing denominators we can find a relation of the form
$$
x_i + \sum\nolimits_j f_{i, j}c_{i, j} = g_i
$$
with $x_i \in I_i$, $f_{i, j} \in \mathfrak q$, $c_{i, j} \in C_i \otimes_A B$,
and $g_i \in B$, $g_i \not \in \mathfrak q$. After replacing $B$ by
$B_{g_1 \ldots g_n}$, i.e., after replacing $T$ by a smaller affine
neighbourhood of $t$, we may assume the equations read
$$
x_i + \sum\nolimits_j f_{i, j}c_{i, j} = 1
$$
with $x_i \in I_i$, $f_{i, j} \in \mathfrak q$, $c_{i, j} \in C_i \otimes_A B$.

\medskip\noindent
To finish the argument write $B$ as a colimit of finitely presented
$A$-algebras $B_\lambda$ over a directed partially ordered set $\Lambda$.
For each $\lambda$ set
$\mathfrak q_\lambda = (B_\lambda \to B)^{-1}(\mathfrak q)$.
For sufficiently large $\lambda \in \Lambda$ we can find
\begin{enumerate}
\item an element
$x_{i, \lambda} \in C_i \otimes_A B_\lambda$ which maps to $x_i$,
\item elements $f_{i, j, \lambda} \in \mathfrak q_{i, \lambda}$
mapping to $f_{i, j}$, and
\item elements $c_{i, j, \lambda} \in C_i \otimes_A B_\lambda$
mapping to $c_{i, j}$.
\end{enumerate}
After increasing $\lambda$ a bit more the equation
$$
x_{i, \lambda} + \sum\nolimits_j f_{i, j, \lambda}c_{i, j, \lambda} = 1
$$
will hold. Fix such a $\lambda$ and set $T' = \Spec(B_\lambda)$.
Then $t' \in T'$ is the point corresponding to the prime $\mathfrak q_\lambda$.
Finally, let $Z' \subset X_{T'}$ be the scheme theoretic closure of
$Z \to X_T \to X_{T'}$. As $X_T \to X_{T'}$ is affine, we can compute $Z'$
on the affine open pieces $U_{i, T'}$ as the closed subscheme associated
to $\text{Ker}(C_i \otimes_A B_\lambda \to C_i \otimes_A B/I_i)$, see
Morphisms, Example \ref{morphisms-example-scheme-theoretic-image}.
Hence $x_{i, \lambda}$ is in the ideal defining $Z'$. Thus the last
displayed equation shows that $Z' \cap X_{t'}$ is empty.
\end{proof}

\begin{lemma}
\label{lemma-test-universally-closed}
Let $f : X \to S$ be a quasi-compact morphism of schemes.
The following are equivalent
\begin{enumerate}
\item $f$ is universally closed,
\item for every morphism $S' \to S$ which is locally of finite presentation
the base change $X_{S'} \to S'$ is closed, and
\item for every $n$ the morphism
$\mathbf{A}^n \times X \to \mathbf{A}^n \times S$
is closed.
\end{enumerate}
\end{lemma}

\begin{proof}
It is clear that (1) implies (2). Let us prove that (2) implies (1).
Suppose that the base change $X_T \to T$ is not closed for some
scheme $T$ over $S$. By
Schemes, Lemma \ref{schemes-lemma-quasi-compact-closed}
this means that there exists some specialization $t_1 \leadsto t$ in
$T$ and a point $\xi \in X_T$ mapping to $t_1$ such that $\xi$ does not
specialize to a point in the fibre over $t$. Set
$Z = \overline{\{\xi\}} \subset X_T$. Then $Z \cap X_t = \emptyset$. Apply
Lemma \ref{lemma-separate}.
We find an open neighbourhood $V \subset T$ of $t$, a commutative diagram
$$
\xymatrix{
V \ar[d] \ar[r]_a & T' \ar[d]^b \\
T \ar[r]^g & S,
}
$$
and a closed subscheme $Z' \subset X_{T'}$ such that
\begin{enumerate}
\item the morphism $b : T' \to S$ is locally of finite presentation,
\item with $t' = a(t)$ we have $Z' \cap X_{t'} = \emptyset$, and
\item $Z \cap X_V$ maps into $Z'$ via the morphism $X_V \to X_{T'}$.
\end{enumerate}
Clearly this means that $X_{T'} \to T'$ maps the closed subset $Z'$
to a subset of $T'$ which contains $a(t_1)$ but not $t' = a(t)$.
Since $a(t_1) \leadsto a(t) = t'$ we conclude that $X_{T'} \to T'$
is not closed. Hence we have shown that $X \to S$ not universally closed
implies that $X_{T'} \to T'$ is not closed for some $T' \to S$
which is locally of finite presentation. In order words (2)
implies (1).

\medskip\noindent
Assume that $\mathbf{A}^n \times X \to \mathbf{A}^n \times S$ is
closed for every integer $n$. We want to prove that $X_T \to T$ is
closed for every scheme $T$ which is locally of finite presentation
over $S$. We may of course assume that $T$ is affine and maps into
an affine open $V$ of $S$ (since $X_T \to T$ being a closed is local on $T$).
In this case there exists a closed immersion $T \to \mathbf{A}^n \times V$
because $\mathcal{O}_T(T)$ is a finitely presented
$\mathcal{O}_S(V)$-algebra, see
Morphisms,
Lemma \ref{morphisms-lemma-locally-finite-presentation-characterize}.
Then $T \to \mathbf{A}^n \times S$ is a locally closed immersion.
Hence we get a cartesian diagram
$$
\xymatrix{
X_T \ar[d]_{f_T} \ar[r] & \mathbf{A}^n \times X \ar[d]^{f_n} \\
T \ar[r] & \mathbf{A}^n \times S
}
$$
of schemes where the horizontal arrows are locally closed immersions.
Hence any closed subset $Z \subset X_T$ can be written as
$X_T \cap Z'$ for some closed subset $Z' \subset \mathbf{A}^n \times X$.
Then $f_T(Z) = T \cap f_n(Z')$ and we see that if $f_n$ is closed, then
also $f_T$ is closed.
\end{proof}

\begin{lemma}
\label{lemma-check-universally-closed-Noetherian}
Let $f : X \to S$ be a finite type morphism of schemes.
Assume $S$ is locally Noetherian. Then the following are equivalent
\begin{enumerate}
\item $f$ is universally closed,
\item for every $n$ the morphism
$\mathbf{A}^n \times X \to \mathbf{A}^n \times S$ is closed,
\item for any diagram (\ref{equation-valuative}) there exists some
dotted arrow,
\item for all diagrams (\ref{equation-valuative}) with $A$ a discrete
valuation ring there exists some dotted arrow.
\end{enumerate}
\end{lemma}

\begin{proof}
The equivalence of (1) and (2) is a special case of
Lemma \ref{lemma-test-universally-closed}.
The equivalence of (1) and (3) is a special case of
Schemes, Proposition \ref{schemes-proposition-characterize-universally-closed}.
Trivially (3) implies (4).
Thus all we have to do is prove that (4) implies (2).
We will prove that $\mathbf{A}^n \times X \to \mathbf{A}^n \times S$
is closed by the criterion of
Schemes, Lemma \ref{schemes-lemma-quasi-compact-closed}.
Pick $n$ and a specialization $z \leadsto z'$ of points
in $\mathbf{A}^n \times S$ and a point $y \in \mathbf{A}^n \times X$
lying over $z$. Note that $\kappa(y)$ is a finitely generated field
extension of $\kappa(z)$ as $\mathbf{A}^n \times X \to \mathbf{A}^n \times S$
is of finite type. Hence by
Properties, Lemma \ref{properties-lemma-locally-Noetherian-specialization-dvr}
or
Algebra, Lemma \ref{algebra-lemma-exists-dvr}
implies that there exists a discrete valuation ring $A \subset \kappa(y)$
with fraction field $\kappa(z)$ dominating the image of
$\mathcal{O}_{\mathbf{A}^n \times S, z'}$ in $\kappa(z)$.
This gives a commutative diagram
$$
\xymatrix{
\Spec(\kappa(y)) \ar[r] \ar[d] &
\mathbf{A}^n \times X \ar[d] \ar[r] & X \ar[d] \\
\Spec(A) \ar[r] & \mathbf{A}^n \times S \ar[r] & S
}
$$
Now property (4) implies that there exists a morphism
$\Spec(A) \to X$ which fits into this diagram.
Since we already have the morphism $\Spec(A) \to \mathbf{A}^n$
from the left lower horizontal arrow we also get a morphism
$\Spec(A) \to \mathbf{A}^n \times X$ fitting into the
left square. Thus the image $y' \in \mathbf{A}^n \times X$
of the closed point is a specialization of $y$ lying over $z'$.
This proves that specializations lift along
$\mathbf{A}^n \times X \to \mathbf{A}^n \times S$
and we win.
\end{proof}









\section{Limits and dimensions of fibres}
\label{section-limits-dimension}

\noindent
The following lemma is most often used in the situation of
Lemma \ref{lemma-descend-finite-presentation}
to assure that if the fibres of the limit have dimension $\leq d$,
then the fibres at some finite stage have dimension $\leq d$.

\begin{lemma}
\label{lemma-limit-dimension}
Let $I$ be a directed partially ordered set.
Let $(f_i : X_i \to S_i)$ be an inverse system of morphisms of schemes
over $I$. Assume
\begin{enumerate}
\item all the morphisms $S_{i'} \to S_i$ are affine,
\item all the schemes $S_i$ are quasi-compact and quasi-separated,
\item the morphisms $f_i$ are of finite type, and
\item the morphisms $X_{i'} \to X_i \times_{S_i} S_{i'}$ are closed
immersions.
\end{enumerate}
Let $f : X = \lim_i X_i \to S = \lim_i S_i$ be the limit.
Let $d \geq 0$.
If every fibre of $f$ has dimension $\leq d$, then for some $i$
every fibre of $f_i$ has dimension $\leq d$.
\end{lemma}

\begin{proof}
For each $i$ let $U_i = \{x \in X_i \mid \dim_x((X_i)_{f_i(x)}) \leq d\}$.
This is an open subset of $X_i$, see
Morphisms, Lemma \ref{morphisms-lemma-openness-bounded-dimension-fibres}.
Set $Z_i = X_i \setminus U_i$ (with reduced induced scheme structure).
We have to show that $Z_i = \emptyset$ for some $i$.
If not, then $Z = \lim Z_i \not = \emptyset$, see
Lemma \ref{lemma-limit-nonempty}.
Say $z \in Z$ is a point. Note that $Z \subset X$ is a closed subscheme.
Set $s = f(z)$. For each $i$ let $s_i \in S_i$ be the image
of $s$. We remark that $Z_s$ is the limit of the schemes $(Z_i)_{s_i}$
and $Z_s$ is also the limit of the schemes $(Z_i)_{s_i}$ base
changed to $\kappa(s)$. Moreover, all the morphisms
$$
Z_s
\longrightarrow
(Z_{i'})_{s_{i'}} \times_{\Spec(\kappa(s_{i'}))} \Spec(\kappa(s))
\longrightarrow
(Z_i)_{s_i} \times_{\Spec(\kappa(s_i))} \Spec(\kappa(s))
\longrightarrow
X_s
$$
are closed immersions by assumption (4). Hence $Z_s$ is the scheme
theoretic intersection of the closed subschemes
$(Z_i)_{s_i} \times_{\Spec(\kappa(s_i))} \Spec(\kappa(s))$
in $X_s$. Since all the irreducible components of the schemes
$(Z_i)_{s_i} \times_{\Spec(\kappa(s_i))} \Spec(\kappa(s))$
have dimension $> d$ and contain $z$ we conclude that
$Z_s$ contains an irreducible component of dimension $> d$ passing
through $z$ which contradicts the fact that $Z_s \subset X_s$ and
$\dim(X_s) \leq d$.
\end{proof}

\begin{lemma}
\label{lemma-approximate-given-relative-dimension}
Let $S$ be a quasi-compact and quasi-separated scheme.
Let $f : X \to S$ be a morphism of finite presentation.
Let $d \geq 0$ be an integer.
If $Z \subset X$ be a closed subscheme such that
$\dim(Z_s) \leq d$ for all $s \in S$, then there exists a
closed subscheme $Z' \subset X$ such that
\begin{enumerate}
\item $Z \subset Z'$,
\item $Z' \to X$ is of finite presentation, and
\item $\dim(Z'_s) \leq d$ for all $s \in S$.
\end{enumerate}
\end{lemma}

\begin{proof}
By
Proposition \ref{proposition-approximate}
we can write $S = \lim S_i$ as the limit of a directed inverse
system of Noetherian schemes with affine transition maps. By
Lemma \ref{lemma-descend-finite-presentation}
we may assume that there exist a system of morphisms
$f_i : X_i \to S_i$ of finite presentation such that
$X_{i'} = X_i \times_{S_i} S_{i'}$
for all $i' \geq i$ and such that $X = X_i \times_{S_i} S$.
Let $Z_i \subset X_i$ be the scheme theoretic image of
$Z \to X \to X_i$. Then for $i' \geq i$ the morphism $X_{i'} \to X_i$
maps $Z_{i'}$ into $Z_i$ and the induced morphism
$Z_{i'} \to Z_i \times_{S_i} S_{i'}$ is a closed immersion. By
Lemma \ref{lemma-limit-dimension}
we see that the dimension of the fibres of $Z_i \to S_i$
all have dimension $\leq d$ for a suitable $i \in I$.
Fix such an $i$ and set $Z' = Z_i \times_{S_i} S \subset X$.
Since $S_i$ is Noetherian, we see that $X_i$ is Noetherian, and hence
the morphism $Z_i \to X_i$ is of finite presentation.
Therefore also the base change $Z' \to X$ is of finite presentation.
Moreover, the fibres of $Z' \to S$ are base changes of the fibres
of $Z_i \to S_i$ and hence have dimension $\leq d$.
\end{proof}










\input{chapters}

\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}

