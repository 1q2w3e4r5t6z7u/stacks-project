\input{preamble}

% OK, start here.
%
\begin{document}

\title{Chow homology and Chern classes}

\maketitle

\phantomsection
\label{section-phantom}


\tableofcontents



\section{Introduction}
\label{section-introduction}

\noindent
In this chapter we discuss Chow homology groups and the construction
of chern classes of vector bundles as elements of operational
Chow cohomology groups (everything with $\mathbf{Z}$-coefficients).
We follow the first few chapters of \cite{F}, except that we have been
less precise about the supports of the cycles involved.
More classical discussions of Chow groups can be found in
\cite{Samuel}, \cite{ChevalleyI}, and \cite{ChevalleyII}.
Of course there are many others.

\medskip\noindent
To make the material a little bit more challenging we decided
to treat a somewhat more general case than is usually done.
Namely we assume our schemes $X$ are locally of finite type
over a fixed locally Noetherian base scheme which is universally
catenary and has a given dimension function. This seems to be
all that is needed to be able to define the Chow homology
groups $A_*(X)$ and the action of capping with chern classes
on them. This is an indication that we should be able to define
these also for algebraic stacks locally of finite type over such
a base.

\medskip\noindent
In another chapter we will define the intersection products
on $A_*(X)$ using Serre's Tor-formula in case $X$ is nonsingular
(see \cite{Serre_local_algebra}, or \cite{Serre_algebre_locale})
and we have a good moving lemma. See (insert future reference here).



\section{Algebraic lemmas}
\label{section-algebraic-lemmas}

\noindent
In this section we collect algebraic lemmas used below in order to
slot them into the chapter on commutative algebra later on.

\begin{lemma}
\label{lemma-pushdown-module}
Let $A$ be a local Noetherian ring with maximal ideal $\mathfrak m$.
Let $B$ be a semi-local Noetherian ring with maximal ideals $\mathfrak m_i$,
$i = 1, \ldots, n$.
Suppose that $A \to B$ is a homomorphism such that each $\mathfrak m_i$
lies over $\mathfrak m$ and such that
$$
[\kappa(\mathfrak m_i) : \kappa(\mathfrak m)] < \infty.
$$
Let $M$ be a $B$-module of finite length.
Then
$$
\text{length}_A(M) = \sum\nolimits_{i = 1, \ldots, n}
[\kappa(\mathfrak m_i) : \kappa(\mathfrak m)]
\text{length}_{B_{\mathfrak m_i}}(M_{\mathfrak m_i}),
$$
in particular $\text{length}_A(M) < \infty$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-pullback-module}
Let $A \to B$ be a flat local homomorphism of local Noetherian rings.
Assume that $\sqrt{\mathfrak m_A B} = \mathfrak m_B$.
Then for any $A$-module $M$ of finite length we have
$$
\text{length}_A(M) \text{length}_B(B/\mathfrak m_AB)
=
\text{length}_B(M \otimes_A B)
$$
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-pullback-transitive}
Let $A \to B \to C$ be flat local homomorphisms of local Noetherian rings.
Let $M$ be an $A$-module of finite length.
Then
$$
\text{length}_B(M \otimes_A B) \text{length}_C(C/\mathfrak m_B C)
=
\text{length}_C(M \otimes_A C)
$$
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-finite-in-codim-1}
Let $A \subset B$ be an extension of domains.
Assume $A$ is Noetherian, $A \to B$ is of finite type, and
the extension $f.f.(A) \subset f.f.(B)$ is finite.
Let $\mathfrak p \subset A$ be a prime such that $\dim(A_\mathfrak p) = 1$.
Then there are at most finitely many primes of $B$ lying over $\mathfrak p$.
\end{lemma}

\begin{proof}
By the dimension formula (Algebra, Lemma \ref{algebra-lemma-dimension-formula})
for any prime $\mathfrak q$ lying over $\mathfrak p$ we have
$$
\dim(B_{\mathfrak q}) \leq
\dim(A_{\mathfrak p}) - \text{trdeg}_{\kappa(\mathfrak p)} \kappa(\mathfrak q).
$$
Since $\dim(B_{\mathfrak q})$ is clearly at least $1$ we conclude that
it is $1$ and that the extension
$\kappa(\mathfrak p) \subset \kappa(\mathfrak q)$ is algebraic.
Hence every such prime $\mathfrak q$ is an isolated point of its fibre.
Since the fibre $\text{Spec}(B \otimes_A \kappa(\mathfrak p))$
is quasi-compact we see that it is finite.
\end{proof}



\begin{lemma}
\label{lemma-flat-pullback-pushdown-module}
Let
$$
\xymatrix{
A' = B' \otimes_B A & A \ar[l] \\
B' \ar[u] & B \ar[l] \ar[u]
}
$$
be a diagram of Noetherian rings. Assume that $A$, $A'$, $B'$ are local,
the homomorphisms $B \to A$ and $B \to B'$ are local,
$\kappa(\mathfrak m_B) \to \kappa(\mathfrak m_A)$ is finite,
$B \to B'$ is flat and $\sqrt{\mathfrak m_A B'} = \mathfrak m_{B'}$.
Then
\begin{enumerate}
\item Any prime $\mathfrak m'$ of $A'$ lying over $\mathfrak m_A$
is maximal and $[\kappa(\mathfrak m') : \kappa(\mathfrak m_{B'})] < \infty$.
Moreover, there are only a finite number, say
$\mathfrak m'_1, \ldots, \mathfrak m'_n$, of these.
\item We have
\begin{align*}
[\kappa(\mathfrak m_A) : \kappa(\mathfrak m_B)]
&
\text{length}_{B'}(B'/\mathfrak m_BB')
= \\
& \sum\nolimits_{i = 1, \ldots, n}
[\kappa(\mathfrak m'_i) : \kappa(\mathfrak m_{B'})]
\text{length}_{A'_{\mathfrak m'_i}}((A'/\mathfrak m_AA')_{\mathfrak m'_i})
\end{align*}
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-length-additive}
Let $A$ be a semi-local Noetherian ring of dimension $1$.
If $a, b \in A$ are not zero divisors then
$$
\text{length}_A(A/(ab)) =
\text{length}_A(A/(a)) +
\text{length}_A(A/(b))
$$
and these lengths are finite.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{definition}
\label{definition-ord}
Suppose that $K$ is a field, and $A \subset K$ is a
local\footnote{We could also define this when $A$ is only
semi-local but this is probably never really what you want!}
Noetherian subring of dimension $1$ with fraction field $K$.
In this case we define the {\it order of vanishing along $A$}
$$
\text{ord}_A : K^* \longrightarrow \mathbf{Z}
$$
by the rule
$$
\text{ord}_A(x) = \text{length}_A(A/(x))
$$
if $x \in A$ and we set
$\text{ord}_A(x/y) = \text{ord}_A(x) - \text{ord}_A(y)$
for $x, y \in A$ both nonzero.
\end{definition}

\begin{lemma}
\label{lemma-finite-extension-dim-1}
Let $A \subset B$ be a finite extension of Noetherian domains.
Assume that $A$ is a local of dimension $1$.
Let $K = f.f.(A)$ and $L = B \otimes_A K$ so that $L$ is
a finite field extension of $K$.
Let $y \in L^*$ and $x = \text{Nm}_{L/K}(y)$.
Let $\mathfrak m_i$, $i = 1, \ldots, n$ be the maximal ideals of $B$.
Then
$$
\text{ord}_A(x) =
\sum\nolimits_i
[\kappa(\mathfrak m_i) : \kappa(\mathfrak m_A)]
\text{ord}_{B_{\mathfrak m_i}}(y)
$$
where $\text{ord}$ is defined as in Definition \ref{definition-ord}.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-quasi-finite-extension-dim-1}
Let $A \subset B$ be an extension of domains.
Assume
\begin{enumerate}
\item $A$ is a local Noetherian ring of dimension $1$,
\item $A \to B$ is of finite type, and
\item setting $K = f.f.(A)$ and $L = B \otimes_A K$
we have that $L$ is a finite field extension of $K$.
\end{enumerate}
Then $B$ is semi-local. Moreover, Let $y \in L^*$ and
$x = \text{Nm}_{L/K}(y)$. Let $\mathfrak m_i$, $i = 1, \ldots, n$
be the maximal ideals of $B$. Then
$$
\text{ord}_A(x)
\geq
\sum\nolimits_i
[\kappa(\mathfrak m_i) : \kappa(\mathfrak m_A)]
\text{ord}_{B_{\mathfrak m_i}}(y)
$$
where $\text{ord}$ is defined as in Definition \ref{definition-ord}.
If for some $y \in \text{Im}(\mathfrak m_A \to L)$ we have equality,
then $A \to B$ is finite.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}





\begin{lemma}
\label{lemma-relative-effective-cartier-algebra}
Let $A \to B$ be a ring map. Let $f \in B$. Assume that
\begin{enumerate}
\item $A \to B$ is flat,
\item $f$ is a nonzero divisor, and
\item $A \to B/fB$ is flat.
\end{enumerate}
Then for every ideal $I \subset A$ the map
$f : B/IB \to B/IB$ is injective.
\end{lemma}

\begin{proof}
Note that $IB = I \otimes_A B$ and $I(B/fB) = I\otimes_A B/fB$
by the flatness of $B$ and $B/fB$ over $A$.
In particular $IB/fIB \cong I \otimes_A B/fB$ maps injectively
into $B/fB$. Hence the result follows from the snake lemma applied
to the diagram
$$
\xymatrix{
0 \ar[r] &
I \otimes_A B \ar[r] \ar[d]^f &
B \ar[r] \ar[d]^f &
B/IB \ar[r] \ar[d]^f &
0 \\
0 \ar[r] &
I \otimes_A B \ar[r] &
B \ar[r] &
B/IB \ar[r] &
0
}
$$
with exact rows.
\end{proof}




\section{Determinants of finite length modules}
\label{section-determinants-finite-length}

\noindent
The material in this section is related to the material in
the paper \cite{determinant} and to the material in the
thesis \cite{Joe}. If you have a good reference then please
email \href{mailto:stacks.project@gmail.com}{stacks.project@gmail.com}.

\medskip\noindent
Given any field $\kappa$ and
any finite dimensional $\kappa$-vector space $V$ we set
$\det\nolimits_\kappa(V)$ equal to $\det\nolimits_\kappa(V) = \wedge^n(V)$
where $n = \dim_\kappa(V)$. We want to generalize this slightly.

\begin{definition}
\label{definition-determinant}
Let $R$ be a local ring with maximal ideal $\mathfrak m$ and
residue field $\kappa$. Let $M$ be a finite length $R$-module.
Say $l = \text{length}_R(M)$.
\begin{enumerate}
\item Given elements $x_1, \ldots, x_r \in M$ we denote
$\langle x_1, \ldots, x_r \rangle = Rx_1 + \ldots + Rx_r$ the
$R$-submodule of $R$ generated by $x_1, \ldots, x_r$.
\item We will say an $l$-tuples of elements
$(e_1, \ldots, e_l)$ of $M$ is {\it admissible} if
$\mathfrak m e_i \in \langle e_1, \ldots, e_{i - 1} \rangle$
for $i = 1, \ldots, l$.
\item A {\it symbol} $[e_1, \ldots, e_l]$ will mean
$(e_1, \ldots, e_l)$ is an admissible $l$-tuple.
\item An {\it admissible relation} between symbols is one of the following:
\begin{enumerate}
\item if $(e_1, \ldots, e_l)$ is an admissible sequence and
for some $1 \leq a \leq l$ we have
$e_a \in \langle e_1, \ldots, e_{a - 1}\rangle$, then
$[e_1, \ldots, e_l] = 0$,
\item if $(e_1, \ldots, e_l)$ is an admissible sequence and
for some $1 \leq a \leq l$ we have $e_a = \lambda e'_a + x$
with $\lambda \in R^*$, and
$x \in \langle e_1, \ldots, e_{a - 1}\rangle$, then
$$
[e_1, \ldots, e_l] =
\overline{\lambda} [e_1, \ldots, e_{a - 1}, e'_a, e_{a + 1}, \ldots, e_l]
$$
where $\overline{\lambda} \in \kappa^*$ is the image of $\lambda$ in
the residue field, and
\item if $(e_1, \ldots, e_l)$ is an admissible sequence and
$\mathfrak m e_a \subset \langle e_1, \ldots, e_{a - 2}\rangle$ then
$$
[e_1, \ldots, e_l] =
- [e_1, \ldots, e_{a - 2}, e_a, e_{a - 1}, e_{a + 1}, \ldots, e_l].
$$
\end{enumerate}
\item
We define the {\it determinant of the finite length $R$-module} to be
$$
\det\nolimits_\kappa(M) =
\left\{
\frac{\kappa\text{-vector space generated by symbols}}
{\kappa\text{-linear combinations of admissible relations}}
\right\}
$$
\end{enumerate}
\end{definition}

\noindent
We stress that always $l = \text{length}_R(M)$. We also stress that
it does not follow that the symbol $[e_1, \ldots, e_l]$ is
additive in the entries (this will typically not be the case).
Before we can show that the determinant $\det_\kappa(M)$ actually
has dimension $1$ we have to show that it has dimension at most $1$.

\begin{lemma}
\label{lemma-dimension-at-most-one}
With notations as above we have $\dim_\kappa(\det_\kappa(M)) \leq 1$.
\end{lemma}

\begin{proof}
Fix an admissible sequence $(f_1, \ldots, f_l)$ of $M$ such that
$$
\text{length}_R(\langle f_1, \ldots, f_i\rangle) = i
$$
for $i = 1, \ldots, l$. Such an admissible sequence exists exactly because
$M$ has length $l$. We will show that any element of 
$\det_\kappa(M)$ is a $\kappa$-multiple of the symbol
$[f_1, \ldots, f_l]$. This will prove the lemma.

\medskip\noindent
Let $(e_1, \ldots, e_l)$ be an admissible sequence of $M$.
It suffices to show that $[e_1, \ldots, e_l$ is a multiple
of $[f_1, \ldots, f_l]$. First assume that
$\langle e_1, \ldots, e_l\rangle \not = M$. Then there exists
an $i \in [1, \ldots, l]$ such that
$e_i \in \langle e_1, \ldots, e_{i - 1}\rangle$. It immediately
follows from the first admissible relation that
$[e_1, \ldots, e_n] = 0$ in $\det_\kappa(M)$.
Hence we may assume that $\langle e_1, \ldots, e_l\rangle = M$.
In particular there exists a smallest index $i \in \{1, \ldots, l\}$
such that $f_1 \in \langle e_1, \ldots, e_i\rangle$. This means
that $e_i = \lambda f_1 + x$ with
$x \in \langle e_1, \ldots, e_{i - 1}\rangle$ and $\lambda \in R^*$.
By the second admissible relation this means that
$[e_1, \ldots, e_l] = 
\overline{\lambda}[e_1, \ldots, e_{i - 1}, f_1, e_{i + 1}, \ldots, e_l]$.
Note that $\mathfrak m f_1 = 0$. Hence by applying the third
admissible relation $i - 1$ times we see that
$$
[e_1, \ldots, e_l] = 
(-1)^{i - 1}\overline{\lambda}
[f_1, e_1, \ldots, e_{i - 1}, e_{i + 1}, \ldots, e_l].
$$
Note that it is also the case that
$ \langle f_1, e_1, \ldots, e_{i - 1}, e_{i + 1}, \ldots, e_l\rangle = M$.
By induction suppose we have proven that our original
symbol is equal to a scalar times
$$
[f_1, \ldots, f_j, e_{j + 1}, \ldots, e_l]
$$
for some admissible sequence $(f_1, \ldots, f_j, e_{j + 1}, \ldots, e_l)$
such that $\langle f_1, \ldots, f_j, e_{j + 1}, \ldots, e_l\rangle = M$.
Then we find the smallest $i$ such that
$f_{j + 1} \in \langle f_1, \ldots, f_j, e_{j + 1}, \ldots, e_i\rangle$
and we go through the same process as above to see that
$$
[f_1, \ldots, f_j, e_{j + 1}, \ldots, e_l]
=
(\text{scalar}) [f_1, \ldots, f_j, f_{j + 1}, e_{j + 1},
\ldots, \hat{e_i}, \ldots, e_l]
$$
Continuing in this vein we obtain the desired result.
\end{proof}

\noindent
Before we show that $\det_\kappa(M)$ always has dimension $1$,
let us show that it agree with the usual top exterior power in
the case the module is a vector space over $\kappa$.

\begin{lemma}
\label{lemma-compare-det}
Let $R$ be a local ring with maximal ideal $\mathfrak m$ and
residue field $\kappa$. Let $M$ be a finite length $R$-module
which is annihilated by $\mathfrak m$. Let $l = n = \dim_\kappa(M)$.
Then the map
$$
\det\nolimits_\kappa(M) \longrightarrow \wedge^l_\kappa(M),
\quad
[e_1, \ldots, e_l] \longmapsto e_1 \wedge \ldots \wedge e_l
$$
is an isomorphism.
\end{lemma}

\begin{proof}
It is clear that the rule described in the lemma gives a $\kappa$-linear
map since all of the admissible relations are satisfied by the usual
symbols $e_1 \wedge \ldots \wedge e_l$. It is also clearly a surjective
map. Since by Lemma \ref{lemma-dimension-at-most-one} the left hand side
has dimension at most one
we see that the map is an isomorphism.
\end{proof}

\begin{lemma}
\label{lemma-determinant-dimension-one}
Let $R$ be a local ring with maximal ideal $\mathfrak m$ and
residue field $\kappa$. Let $M$ be a finite length $R$-module.
The determinant $\det_\kappa(M)$ defined above is a $\kappa$-vector
space of dimension $1$. It is generated by the symbol
$[f_1, \ldots, f_l]$ for any admissible sequence such
that $\langle f_1, \ldots f_l \rangle = M$.
\end{lemma}

\begin{proof}
We know $\det_\kappa(M)$ has dimension at most $1$, and in fact that it
is generated by $[f_1, \ldots, f_l]$, by
Lemma \ref{lemma-dimension-at-most-one} and its proof.
We will show by induction on $l = \text{length}(M)$
that it is nonzero. For $l = 1$ it follows from Lemma \ref{lemma-compare-det}.
Choose a nonzero element $f \in M$
with $\mathfrak m f = 0$. Set $\overline{M} = M /\langle f \rangle$,
and denote the quotient map $x \mapsto \overline{x}$.
We will define a surjective map
$$
\psi : \det\nolimits_k(M) \to \det\nolimits_\kappa(\overline{M})
$$
which will prove the lemma since by induction the determinant of
$\overline{M}$ is nonzero.

\medskip\noindent
We define $\psi$ on symbols as follows.
Let $(e_1, \ldots, e_l)$ be an admissible sequence.
If $f \not \in \langle e_1, \ldots, e_l \rangle$ then 
we simply set $\psi([e_1, \ldots, e_l]) = 0$.
If $f \in \langle e_1, \ldots, e_l \rangle$ then we choose
an $i$ minimal such that $f \in \langle e_1, \ldots, e_i \rangle$
and write $e_i = \lambda f + x$ for some $\lambda \in R$
and $x \in \langle e_1, \ldots, e_{i - 1} \rangle$.
In this case we set
$$
\psi([e_1, \ldots, e_l]) =
\overline{\lambda}[\overline{e}_1, \ldots,
\overline{e}_{i - 1},
\overline{e}_{i + 1}, \ldots, \overline{e}_l].
$$
Note that it is indeed the case that
$(\overline{e}_1, \ldots,
\overline{e}_{i - 1},
\overline{e}_{i + 1}, \ldots, \overline{e}_l)$
is an admissible sequence in $\overline{M}$, so this makes sense.
Let us show that extending this rule $\kappa$-linearly to
linear combinations of symbolds does indeed lead to a map on
determinants. To do this we have to show that the admissible
relations are mapped to zero.

\medskip\noindent
Type (a) relations. Suppose we have $(e_1, \ldots, e_l)$ an
admissible sequence and for some $1 \leq a \leq l$ we have
$e_a \in \langle e_1, \ldots, e_{a - 1}\rangle$.
Suppose that $f \in \langle e_1, \ldots, e_i\rangle$ with $i$ minimal.
Then it is immediate that $i \not = a$. Since it is also
the case that
$\overline{e}_a \in
\langle \overline{e}_1, \ldots, \hat{\overline{e}_i}, \ldots,
\overline{e}_{a - 1}\rangle$ we see immediately that the same
admissible relation for $\det_\kappa(\overline{M})$ forces
the symbol $[\overline{e}_1, \ldots,
\overline{e}_{i - 1},
\overline{e}_{i + 1}, \ldots, \overline{e}_l]$
to be zero as desired.

\medskip\noindent
Type (b) relations. Suppose we have $(e_1, \ldots, e_l)$ an
admissible sequence and for some $1 \leq a \leq l$ we have
$e_a = \lambda e'_a + x$ with $\lambda \in R^*$, and
$x \in \langle e_1, \ldots, e_{a - 1}\rangle$.
Suppose that $f \in \langle e_1, \ldots, e_i\rangle$ with $i$ minimal.
Say $e_i = \mu f + y$ with $y \in \langle e_1, \ldots, e_{i - 1}\rangle$.
If $i < a$ then the desired equality is 
$$
\overline{\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{i - 1},
\overline{e}_{i + 1},
\ldots,
\overline{e}_l]
=
\overline{\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{i - 1},
\overline{e}_{i + 1},
\ldots,
\overline{e}_{a - 1},
\overline{e}'_a,
\overline{e}_{a + 1},
\ldots,
\overline{e}_l]
$$
which follows from $\overline{e}_a = \lambda \overline{e}'_a + \overline{x}$
and the corresponding admissible relation for $\det_\kappa(\overline{M})$.
If $i > a$ then the desired equality is 
$$
\overline{\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{i - 1},
\overline{e}_{i + 1},
\ldots,
\overline{e}_l]
=
\overline{\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{a - 1},
\overline{e}'_a,
\overline{e}_{a + 1},
\ldots,
\overline{e}_{i - 1},
\overline{e}_{i + 1},
\ldots,
\overline{e}_l]
$$
which follows from $\overline{e}_a = \lambda \overline{e}'_a + \overline{x}$
and the corresponding admissible relation for $\det_\kappa(\overline{M})$.
The interesting case is when $i = a$. In this case we have
$e_a = \lambda e'_a + x = \mu f + y$. Hence also
$e'_a = \lambda^{-1}(\mu f + y - x)$. Thus we see that
$$
\psi([e_1, \ldots, e_l])
= \overline{\mu}
[\overline{e}_1, \ldots,
\overline{e}_{i - 1},
\overline{e}_{i + 1}, \ldots, \overline{e}_l]
=
\psi(
\overline{\lambda}
[e_1, \ldots, e_{a - 1}, e'_a, e_{a + 1}, \ldots, e_l]
)
$$
as desired.

\medskip\noindent
Type (c) relations. Suppose that $(e_1, \ldots, e_l)$
is an admissible sequence and
$\mathfrak m e_a \subset \langle e_1, \ldots, e_{a - 2}\rangle$.
Suppose that $f \in \langle e_1, \ldots, e_i\rangle$ with $i$ minimal.
Say $e_i = \lambda f + x$ with $x \in \langle e_1, \ldots, e_{i - 1}\rangle$.
If $i < a - 1$, then the desired equality is
$$
\overline{\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{i - 1},
\overline{e}_{i + 1},
\ldots,
\overline{e}_l]
=
\overline{\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{i - 1},
\overline{e}_{i + 1},
\ldots,
\overline{e}_{a - 2},
\overline{e}_a,
\overline{e}_{a - 1},
\overline{e}_{a + 1},
\ldots,
\overline{e}_l]
$$
which follows from the type (c) admissible relation for
$\det_\kappa(\overline{M})$. Similarly, if $i > a$, then the
desired equality is
$$
\overline{\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{i - 1},
\overline{e}_{i + 1},
\ldots,
\overline{e}_l]
=
\overline{\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{a - 2},
\overline{e}_a,
\overline{e}_{a - 1},
\overline{e}_{a + 1},
\ldots,
\overline{e}_{i - 1},
\overline{e}_{i + 1},
\ldots,
\overline{e}_l]
$$
which follows from the type (c) admissible relation for
$\det_\kappa(\overline{M})$. If $i = a$, then the desired
equality is
$$
\overline{\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{a - 1},
\overline{e}_{a + 1},
\ldots,
\overline{e}_l]
=
\overline{\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{a - 2},
\overline{e}_{a - 1},
\overline{e}_{a + 1},
\ldots,
\overline{e}_l]
$$
which is tautological. Finally, the interesting case is $i = a - 1$.
This case itself splits into two cases as to whether
$f \in \langle e_1, \ldots, e_{a - 2}, e_a \rangle$ or not.
If not, then we see that the desired equality is
$$
\overline{\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{a - 2},
\overline{e}_a,
\ldots,
\overline{e}_l]
=
\overline{\lambda}
[\overline{e}_1,
\ldots,
\overline{e}_{a - 2},
\overline{e}_a,
\overline{e}_{a + 1},
\ldots,
\overline{e}_l]
$$
which is tautological since after switching $e_{a - 1}$ and $e_a$
the smallest index such that $f$ is in the becomes equal to
$i' = a$ and it is again $e_a$ which is removed. On the other
hand, suppose that $f \in \langle e_1, \ldots, e_{a - 2}, e_a \rangle$.
In this case we see that we can, besides the equality
$e_{a - 1} = \lambda f + x$ of above, also write
$e_a = \mu f + y$ with $y \in \langle e_1, \ldots, e_{a - 2}\rangle$.
Clearly this means that both
$e_a \in \langle e_1, \ldots, e_{a - 1} \rangle$ and
$e_{a - 1} \in \langle e_1, \ldots, e_{a - 2}, e_a\rangle$.
Thus we can use relations of type (a) and the compatibility of $\psi$
with these shown above to see that both
$$
\psi([e_1, \ldots, e_l])
\quad\text{and}\quad
\psi([e_1, \ldots, e_{a - 2}, e_a, e_{a - 1}, e_{a + 1}, \ldots, e_l])
$$
are zero, as desired.

\medskip\noindent
At this point we have shown that $\psi$ is well defined, and all that remains
is to show that it is surjective. To see this let
$(\overline{f}_2, \ldots, \overline{f}_l)$ be an admissible sequence
in $\overline{M}$. We can choose lifts $f_2, \ldots, f_l \in M$, and
then $(f, f_2, \ldots, f_l)$ is an admissible sequence in $M$.
Since $\psi([f, f_2, \ldots, f_l]) = [f_2, \ldots, f_l]$ we win.
\end{proof}

\noindent
Let $R$ be a local ring with maximal ideal $\mathfrak m$ and
residue field $\kappa$. Note that if $\varphi : M \to N$ is an
isomorphism of finite length $R$-modules, then we get an
isomorphism
$$
\det\nolimits_\kappa(\varphi) :
\det\nolimits_\kappa(M)
\to
\det\nolimits_\kappa(N)
$$
simply by the rule
$$
\det\nolimits_\kappa(\varphi)([e_1, \ldots, e_l])
=
[\varphi(e_1), \ldots, \varphi(e_l)]
$$
for any symbol $[e_1, \ldots, e_l]$ for $M$.
Hence we see that $\det\nolimits_\kappa$ is a functor
\begin{equation}
\left\{
\begin{matrix}
\text{finite length $R$-modules}\\
\text{with isomorphisms}
\end{matrix}
\right\}
\longrightarrow
\left\{
\begin{matrix}
1\text{-dimensional }\kappa\text{-vector spaces}\\
\text{with isomorphisms}
\end{matrix}
\right\}
\end{equation}
This is typical for a ``determinant functor''
(see \cite{Knudsen}), as is the following additivity
property.

\begin{lemma}
\label{lemma-det-exact-sequences}
Let $(R, \mathfrak m, \kappa)$ be a local ring.
For every short exact sequence
$$
0 \to K \to L \to M \to 0
$$
of finite length $R$-modules there exists a canonical isomorphism
$$
\gamma_{K \to L \to M} :
\det\nolimits_\kappa(K) \otimes_\kappa \det\nolimits_\kappa(M)
\longrightarrow
\det\nolimits_\kappa(L)
$$
defined by the rule on nonzero symbols
$$
[e_1, \ldots, e_k]
\otimes
[\overline{f}_1, \ldots, \overline{f}_m]
\longrightarrow
[e_1, \ldots, e_k, f_1, \ldots, f_m]
$$
with the following properties:
\begin{enumerate}
\item For every isomorphism of short exact sequences, i.e., for
every commutative diagram
$$
\xymatrix{
0 \ar[r] &
K \ar[r] \ar[d]^u &
L \ar[r] \ar[d]^v &
M \ar[r] \ar[d]^w &
0 \\
0 \ar[r] &
K' \ar[r] &
L' \ar[r] &
M' \ar[r] &
0
}
$$
with short exact rows and isomorphisms $u, v, w$ we have
$$
\gamma_{K' \to L' \to M'} \circ
(\det\nolimits_\kappa(u) \otimes \det\nolimits_\kappa(w))
=
\det\nolimits_\kappa(v) \circ
\gamma_{K \to L \to M},
$$
\item for every commutative square of finite length $R$-modules
with exact rows and columns
$$
\xymatrix{
& 0 \ar[d] & 0 \ar[d] & 0 \ar[d] & \\
0 \ar[r] & A \ar[r] \ar[d] & B \ar[r] \ar[d] & C \ar[r] \ar[d] & 0 \\
0 \ar[r] & D \ar[r] \ar[d] & E \ar[r] \ar[d] & F \ar[r] \ar[d] & 0 \\
0 \ar[r] & G \ar[r] \ar[d] & H \ar[r] \ar[d] & I \ar[r] \ar[d] & 0 \\
& 0  & 0  & 0  &
}
$$
the following diagram is commutative
$$
\xymatrix{
\det\nolimits_\kappa(A) \otimes
\det\nolimits_\kappa(C) \otimes
\det\nolimits_\kappa(G) \otimes 
\det\nolimits_\kappa(I)
\ar[dd]_{\epsilon}
\ar[rrr]_-{\gamma_{A \to B \to C} \otimes \gamma_{G \to H \to I}}
& & &
\det\nolimits_\kappa(B) \otimes 
\det\nolimits_\kappa(H)
\ar[d]^{\gamma_{B \to E \to H}}
\\
& & & \det\nolimits_\kappa(E)
\\
\det\nolimits_\kappa(A) \otimes
\det\nolimits_\kappa(G) \otimes
\det\nolimits_\kappa(C) \otimes 
\det\nolimits_\kappa(I)
\ar[rrr]^-{\gamma_{A \to D \to G} \otimes \gamma_{C \to F \to I}}
& & &
\det\nolimits_\kappa(D) \otimes 
\det\nolimits_\kappa(F)
\ar[u]_{\gamma_{D \to E \to F}}
}
$$
where $\epsilon$ is the switch of the factors in the tensor product
times $(-1)^{cg}$ with $c = \text{length}_R(C)$ and $g = \text{length}_R(G)$,
and
\item the map $\gamma_{K \to L \to M}$ agrees with the usual isomorphism
if $0 \to K \to L \to M \to 0$ is actually a short exact sequence
of $\kappa$-vector spaces.
\end{enumerate}
\end{lemma}

\begin{proof}
The significance of taking nonzero symbols in the explicit description
of the map $\gamma_{K \to L \to M}$ is simply that if $(e_1, \ldots, e_l)$
is an admissible sequence in $K$, and
$(\overline{f}_1, \ldots, \overline{f}_m)$ is an admissible sequence in
$M$, then it is not garanteed that $(e_1, \ldots, e_l, f_1, \ldots, f_m)$
is an admissible sequence in $L$ (where of course $f_i \in L$ signifies
a lift of $\overline{f}_i$). However, if the symbol
$[e_1, \ldots, e_l]$ is nonzero in $\det_\kappa(K)$, then
necessarily $K = \langle e_1, \ldots, e_k\rangle$ (see
proof of Lemma \ref{lemma-dimension-at-most-one}), and
in this case it is true that $(e_1, \ldots, e_k, f_1, \ldots, f_m)$
is an admissible sequence.
Moreover, by the admissible relations of type (b) for $\det_\kappa(L)$
we see that the value of $[e_1, \ldots, e_k, f_1, \ldots, f_m]$ in
$\det_\kappa(L)$ is independent of the choice of the lifts
$f_i$ in this case also. Given this remark, it is clear
that an admissible relation for $e_1, \ldots, e_k$ in $K$
translates into an admissible relation among
$e_1, \ldots, e_k, f_1, \ldots, f_m$ in $L$, and
similarly for an admissible relation among the
$\overline{f}_1, \ldots, \overline{f}_m$.
Thus $\gamma$ defines a linear map of vector spaces as claimed in the lemma.

\medskip\noindent
By Lemma \ref{lemma-determinant-dimension-one} we know
$\det_\kappa(L)$ is generated by any single
symbol $[x_1, \ldots, x_{k + m}]$ such that
$(x_1, \ldots, x_{k + m})$ is an admissible sequence
with $L = \langle x_1, \ldots, x_{k + m}\rangle$. Hence it is
clear that the map $\gamma_{K \to L \to M}$ is surjective and
hence an isomorphism.

\medskip\noindent
Property (1) holds because
\begin{eqnarray*}
& & \det\nolimits_\kappa(v)([e_1, \ldots, e_k, f_1, \ldots, f_m]) \\
& = &
[v(e_1), \ldots, v(e_k), v(f_1), \ldots, v(f_m)] \\
& = &
\gamma_{K' \to L' \to M'}([u(e_1), \ldots, u(e_k)]
\otimes [w(f_1), \ldots, w(f_m)]).
\end{eqnarray*}
Property (2) means that given symbols
$[\alpha_1, \ldots, \alpha_a]$ generating $\det_\kappa(A)$,
$[\gamma_1, \ldots, \gamma_c]$ generating $\det_\kappa(C)$,
$[\zeta_1, \ldots, \zeta_g]$ generating $\det_\kappa(G)$, and
$[\iota_1, \ldots, \iota_i]$ generating $\det_\kappa(I)$
we have
\begin{eqnarray*}
& & [\alpha_1, \ldots, \alpha_a, \tilde\gamma_1, \ldots, \tilde\gamma_c,
\tilde\zeta_1, \ldots, \tilde\zeta_g, \tilde\iota_1, \ldots, \tilde\iota_i] \\
& = &
(-1)^{cg} [\alpha_1, \ldots, \alpha_a, \tilde\zeta_1, \ldots, \tilde\zeta_g,
\tilde\gamma_1, \ldots, \tilde\gamma_c, \tilde\iota_1, \ldots, \tilde\iota_i]
\end{eqnarray*}
(for suitable lifts $\tilde{x}$ in $E$) in $\det_\kappa(E)$.
This holds because we may use the admissible relations of type (c)
$cg$ times in the following order: move the
$\tilde\zeta_1$ past the elements
$\tilde\gamma_c, \ldots, \tilde\gamma_1$
(allowed since $\mathfrak m\tilde\zeta_1 \subset A$),
then move $\tilde\zeta_2$ past the elements
$\tilde\gamma_c, \ldots, \tilde\gamma_1$
(allowed since $\mathfrak m\tilde\zeta_2 \subset A + R\tilde\zeta_1$),
and so on.

\medskip\noindent
Part (3) of the lemma is obvious.
This finishes the proof.
\end{proof}

\noindent
We can use the maps $\gamma$ of the lemma to define more general maps
$\gamma$ as follows. Suppose that $(R, \mathfrak m, \kappa)$ is a
local ring. Let $M$ be a finite length $R$-module and suppose we 
are given a finite filtration (see
Homology, Definition \ref{homology-definition-filtered})
$$
M = F^n \supset F^{n + 1} \supset \ldots \supset F^{m - 1} \supset F^m = 0.
$$
Then there is a canonical isomorphism
$$
\gamma_{(M, F)} :
\bigotimes\nolimits_i \det\nolimits_\kappa(F^i/F^{i + 1})
\longrightarrow
\det\nolimits_\kappa(M)
$$
well defined up to sign(!). One can make the sign explicit either by
giving a well defined order of the terms in the tensor product (starting with
higher indices unfortunately), and by thinking of the target category for
the functor $\det_\kappa$ as the category of
$1$-dimensional super vector spaces. See \cite[Section 1]{determinant}.

\medskip\noindent
Here is another typical result for determinant functors.
It is not hard to show. The tricky part is usually to show the
existence of a determinant functor.

\begin{lemma}
\label{lemma-uniqueness-det}
Let $(R, \mathfrak m, \kappa)$ be any local ring.
The functor
$$
\det\nolimits_\kappa :
\left\{
\begin{matrix}
\text{finite length }R\text{-modules} \\
\text{with isomorphisms}
\end{matrix}
\right\}
\longrightarrow
\left\{
\begin{matrix}
1\text{-dimensional }\kappa\text{-vector spaces} \\
\text{with isomorphisms}
\end{matrix}
\right\}
$$
endowed with the maps $\gamma_{K \to L \to M}$ is characterized by
the following properties
\begin{enumerate}
\item its restriction to the subcategory of modules annihilated
by $\mathfrak m$ is isomorphic to the usual determinant functor
(see Lemma \ref{lemma-compare-det}), and
\item (1), (2) and (3) of Lemma \ref{lemma-det-exact-sequences}
hold.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\noindent
Here is a case where we can compute the determinant of a linear map.
In fact there is nothing mysterious about this in any case, see
Example \ref{example-determinant-map} for a random example.

\begin{lemma}
\label{lemma-times-u-determinant}
Let $R$ be a local ring with residue field $\kappa$.
Let $u \in R^*$ be a unit.
Let $M$ be a module of finite length over $R$.
Denote $u_M : M \to M$ the map multiplication by $u$.
Then
$$
\det\nolimits_\kappa(u_M) :
\det\nolimits_\kappa(M)
\longrightarrow
\det\nolimits_\kappa(M)
$$
is multiplication by $\overline{u}^l$ where $l = \text{length}_R(M)$
and $\overline{u} \in \kappa^*$ is the image of $u$.
\end{lemma}

\begin{proof}
Denote temporarily $f_M \in \kappa^*$ the element such that
$\det\nolimits_\kappa(u_M) = f_M \text{id}_{\det\nolimits_\kappa(M)}$.
Suppose that $0 \to K \to L \to M \to 0$ is a short
exact sequence of finite $R$-modules. Then we see that
$u_k$, $u_L$, $u_M$ give an isomorphism of short exact sequences.
Hence by Lemma \ref{lemma-det-exact-sequences} (1) we conclude that
$f_K f_M = f_L$.
This means that by induction on length it suffices to prove the
lemma in the case of length $1$ where it is trivial.
\end{proof}

\begin{example}
\label{example-determinant-map}
Consider the local ring $R = \mathbf{Z}_p$.
Set $M = \mathbf{Z}_p/(p^2) \oplus \mathbf{Z}_p/(p^3)$.
Let $u : M \to M$ be the map given by the matrix
$$
u =
\left(
\begin{matrix}
a & b \\
pc & d
\end{matrix}
\right)
$$
where $a, b, c, d \in \mathbf{Z}_p$, and $a, d \in \mathbf{Z}_p^*$.
In this case $\det_\kappa(u)$ equals multiplication by
$a^2d^3 \bmod p \in \mathbf{F}_p^*$. This can easily be seen
by consider the effect of $u$ on the symbol
$[p^2e, pe, pf, e, f]$ where $e = (0 , 1) \in M$ and
$f = (1, 0) \in M$.
\end{example}








\section{Periodic complexes}
\label{section-periodic-complexes}

\noindent
Of course there is a very general notion of periodic complexes.
We can require periodicity of the maps, or periodicity of the objects.
We will add these here as needed. For the moment we only need
the following cases.

\begin{definition}
\label{definition-periodic-complex}
Let $R$ be a ring.
\begin{enumerate}
\item A {\it $2$-periodic complex} over $R$ is given
by a quadruple $(M, N, \varphi, \psi)$ consisting of
$R$-modules $M$, $N$ and $R$-module maps $\varphi : M \to N$,
$\psi: N \to M$ such that
$$
\xymatrix{
\ldots \ar[r] &
M \ar[r]^\varphi &
N \ar[r]^\psi &
M \ar[r]^\varphi &
N \ar[r] & \ldots
}
$$
is a complex. In this setting we define the {\it cohomology modules}
of the complex to be the $R$-modules
$$
H^0(M, N, \varphi, \psi) = \text{Ker}(\varphi)/\text{Im}(\psi)
,\quad\text{and}\quad
H^1(M, N, \varphi, \psi) = \text{Ker}(\psi)/\text{Im}(\varphi).
$$
We say the $2$-periodic complex is {\it exact} if the cohomology
groups are zero.
\item A {\it $(2, 1)$-periodic complex} over $R$ is given
by a triple $(M, \varphi, \psi)$ consisting of an $R$-module $M$ and
$R$-module maps $\varphi : M \to M$, $\psi : M \to M$
such that
$$
\xymatrix{
\ldots \ar[r] &
M \ar[r]^\varphi &
M \ar[r]^\psi &
M \ar[r]^\varphi &
M \ar[r] & \ldots
}
$$
is a complex. Since this is a special case of a $2$-periodic complex
we have its {\it cohomology modules} $H^0(M, \varphi, \psi)$,
$H^1(M, \varphi, \psi)$ and a notion of exactness.
\end{enumerate}
\end{definition}

\noindent
In the following we will use any result proved for $2$-periodic
complexes without further mention for $(2, 1)$-periodic complexes.
It is clear that the collection of $2$-periodic complexes
(resp.\ $(2, 1)$-periodic complexes) forms a category with morphisms
$(f, g) : (M, N, \varphi, \psi) \to (M', N', \varphi', \psi')$
pairs of morphisms $f : M \to M'$ and $g : N \to N'$ such
that $\varphi' \circ f = f \circ \varphi$ and $\psi' \circ g = g \circ \psi$.
In fact it is an abelian category, with kernels and cokernels as in
Homology, Lemma \ref{homology-lemma-cat-chain-abelian}.
Also, note that a special case are the
$(2, 1)$-periodic complexes of the form $(M, 0, \psi)$. In this
special case we have
$$
H^0(M, 0, \psi) = \text{Coker}(\psi)
,\quad\text{and}\quad
H^1(M, 0, \psi) = \text{Ker}(\psi).
$$

\begin{definition}
\label{definition-periodic-length}
Let $R$ be a local ring.
Let $(M, N, \varphi, \psi)$ be a $2$-periodic complex over $R$
whose cohomology groups have finite length over $R$.
In this case we define the {\it multiplicity} of $(M, N, \varphi, \psi)$
to be the integer
$$
e_R(M, N, \varphi, \psi) = 
\text{length}_R(H^0(M, N, \varphi, \psi))
-
\text{length}_R(H^1(M, N, \varphi, \psi))
$$
We will sometimes (especially in the case of a $(2, 1)$-periodic complex with
$\varphi = 0$) call this the {\it Herbrand quotient}\footnote{If the residue
field of $R$ is finite with $q$ elements
it is customary to call the Herbrand quotient
$h(M, N, \varphi, \psi) = q^{e_R(M, N, \varphi, \psi)}$ which is equal to
the number of elements of $H^0$ divided by the number of elements of
$H^1$.}.
\end{definition}

\begin{lemma}
\label{lemma-periodic-length}
Let $R$ be a local ring.
\begin{enumerate}
\item If $(M, N, \varphi, \psi)$ is a $2$-periodic complex
such that $M$, $N$ have finite length. Then
$e_R(M, N, \varphi, \psi) = \text{length}_R(M) - \text{length}_R(N)$.
\item If $(M, \varphi, \psi)$ is a $(2, 1)$-periodic complex
such that $M$ has finite length. Then
$e_R(M, \varphi, \psi) = 0$.
\item Suppose that we have a short exact sequence of
$(2, 1)$-periodic complexes
$$
0 \to (M_1, N_1, \varphi_1, \psi_1)
\to (M_2, N_2, \varphi_2, \psi_2)
\to (M_3, N_3, \varphi_3, \psi_3)
\to 0
$$
If two out of three have cohomology modules of finite length so does
the third and we have
$$
e_R(M_2, N_2, \varphi_2, \psi_2) =
e_R(M_1, N_1, \varphi_1, \psi_1) +
e_R(M_3, N_3, \varphi_3, \psi_3).
$$
\end{enumerate}
\end{lemma}

\begin{proof}
Proof of (3). Abbreviate $A = (M_1, N_1, \varphi_1, \psi_1)$,
$B = (M_2, N_2, \varphi_2, \psi_2)$ and $C = (M_3, N_3, \varphi_3, \psi_3)$.
We have a long exact cohomology sequence
$$
\ldots
\to H^1(C)
\to H^0(A)
\to H^0(B)
\to H^0(C)
\to H^1(A)
\to H^1(B)
\to H^1(C)
\to \ldots
$$
This gives a finite exact sequence
$$
0 \to I
\to H^0(A)
\to H^0(B)
\to H^0(C)
\to H^1(A)
\to H^1(B)
\to K \to 0
$$
with $0 \to K \to H^1(C) \to I \to 0$ a filtration. By additivity of
the length function (Algebra, Lemma \ref{algebra-lemma-length-additive})
we see the result.
The proofs of (1) and (2) are omitted.
\end{proof}

\noindent
Let $R$ be a local ring with residue field $\kappa$.
Let $(M, \varphi, \psi)$ be a $(2, 1)$-periodic complex over $R$.
Assume that $M$ has finite length and that $(M, \varphi, \psi)$ is
exact. We are going to use the determinant construction to define
an invariant of this situation. See
Section \ref{section-determinants-finite-length}.
Let us abbreviate
$K_\varphi = \text{Ker}(\varphi)$,
$I_\varphi = \text{Im}(\varphi)$,
$K_\psi = \text{Ker}(\psi)$, and
$I_\psi = \text{Im}(\psi)$.
The short exact sequences
$$
0 \to K_\varphi \to M \to I_\varphi \to 0,\quad
0 \to K_\psi \to M \to I_\psi \to 0
$$
give isomorphisms
$$
\gamma_\varphi :
\det\nolimits_\kappa(K_\varphi)
\otimes
\det\nolimits_\kappa(I_\varphi)
\longrightarrow
\det\nolimits_\kappa(M), \quad
\gamma_\psi :
\det\nolimits_\kappa(K_\psi)
\otimes
\det\nolimits_\kappa(I_\psi)
\longrightarrow
\det\nolimits_\kappa(M),
$$
see Lemma \ref{lemma-det-exact-sequences}.
On the other hand the exactness of the complex gives equalities
$K_\varphi = I_\psi$, and $K_\psi = I_\varphi$
and hence an isomorphism
$$
\sigma :
\det\nolimits_\kappa(K_\varphi)
\otimes
\det\nolimits_\kappa(I_\varphi)
\longrightarrow
\det\nolimits_\kappa(K_\psi)
\otimes
\det\nolimits_\kappa(I_\psi)
$$
by switching the factors. Using this notation we can define our invariant.

\begin{definition}
\label{definition-periodic-determinant}
Let $R$ be a local ring with residue field $\kappa$.
Let $(M, \varphi, \psi)$ be a $(2, 1)$-periodic complex over $R$.
Assume that $M$ has finite length and that $(M, \varphi, \psi)$ is
exact. The {\it determinant of $(M, \varphi, \psi)$} is
the element
$$
\det\nolimits_\kappa(M, \varphi, \psi) \in \kappa^*
$$
such that the composition
$$
\det\nolimits_\kappa(M)
\xrightarrow{\gamma_\psi \circ \sigma \circ \gamma_\varphi^{-1}}
\det\nolimits_\kappa(M)
$$
is multiplication by
$(-1)^{\text{length}_R(I_\varphi)\text{length}_R(I_\psi)}
\det\nolimits_\kappa(M, \varphi, \psi)$.
\end{definition}

\begin{lemma}
\label{lemma-periodic-determinant-easy-case}
Let $R$ be a local ring with residue field $\kappa$.
Let $M$ be a finite length $R$-module.
\begin{enumerate}
\item if $\varphi : M \to M$ is an isomorphism then
$\det_\kappa(M, \varphi, 0) = \det_\kappa(\varphi)$.
\item if $\psi : M \to M$ is an isomorphism then
$\det_\kappa(M, 0, \psi) = \det_\kappa(\psi)^{-1}$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let us prove (1). Set $\psi = 0$. Then we may, with notation
as above Definition \ref{definition-periodic-determinant}, identify
$K_\varphi = I_\psi = 0$, $I_\varphi = K_\psi = M$.
With these identifications, the map
$$
\gamma_\varphi :
\kappa \otimes \det\nolimits_\kappa(M)
=
\det\nolimits_\kappa(K_\varphi)
\otimes
\det\nolimits_\kappa(I_\varphi)
\longrightarrow
\det\nolimits_\kappa(M)
$$
is identified with $\det_\kappa(\varphi^{-1})$. On the other hand the
map $\gamma_\psi$ is identified with the identity map. Hence
$\gamma_\psi \circ \sigma \circ \gamma_\varphi^{-1}$ is equal
to $\det_\kappa(\varphi)$ in this case. Whence the result.
We omit the proof of (2).
\end{proof}

\begin{lemma}
\label{lemma-periodic-determinant}
Let $R$ be a local ring with residue field $\kappa$.
Suppose that we have a short exact sequence of
$(2, 1)$-periodic complexes
$$
0 \to (M_1, \varphi_1, \psi_1)
\to (M_2, \varphi_2, \psi_2)
\to (M_3, \varphi_3, \psi_3)
\to 0
$$
with all $M_i$ of finite length, and each $(M_1, \varphi_1, \psi_1)$ exact.
Then
$$
\det\nolimits_\kappa(M_2, \varphi_2, \psi_2) =
\det\nolimits_\kappa(M_1, \varphi_1, \psi_1)
\det\nolimits_\kappa(M_3, \varphi_3, \psi_3).
$$
in $\kappa^*$.
\end{lemma}

\begin{proof}
Let us abbreviate
$I_{\varphi, i} = \text{Im}(\varphi_i)$,
$K_{\varphi, i} = \text{Ker}(\varphi_i)$,
$I_{\psi, i} = \text{Im}(\psi_i)$, and
$K_{\psi, i} = \text{Ker}(\psi_i)$.
Observe that we have a commutative square
$$
\xymatrix{
& 0 \ar[d] & 0 \ar[d] & 0 \ar[d] & \\
0 \ar[r] &
K_{\varphi, 1} \ar[r] \ar[d] &
K_{\varphi, 2} \ar[r] \ar[d] &
K_{\varphi, 3} \ar[r] \ar[d] &
0 \\
0 \ar[r] &
M_1 \ar[r] \ar[d] &
M_2 \ar[r] \ar[d] &
M_3 \ar[r] \ar[d] &
0 \\
0 \ar[r] &
I_{\varphi, 1} \ar[r] \ar[d] &
I_{\varphi, 2} \ar[r] \ar[d] &
I_{\varphi, 3} \ar[r] \ar[d] &
0 \\
& 0  & 0  & 0  &
}
$$
of finite length $R$-modules with exact rows and columns.
The top row is exact since it can be identified with the
sequence $I_{\psi, 1} \to I_{\psi, 2} \to I_{\psi, 3} \to 0$
of images, and similarly for the bottom row. There is a similar diagram
involving the modules $I_{\psi, i}$ and $K_{\psi, i}$.
By definition $\det_\kappa(M_2, \varphi_2, \psi_2)$
corresponds, up to a sign, to the composition of the left vertical maps
in the following diagram
$$
\xymatrix{
\det_\kappa(M_1) \otimes
\det_\kappa(M_3) \ar[r]^\gamma
\ar[d]^{\gamma^{-1} \otimes \gamma^{-1}} &
\det_\kappa(M_2)
\ar[d]^{\gamma^{-1}} \\
\det\nolimits_\kappa(K_{\varphi, 1})
\otimes
\det\nolimits_\kappa(I_{\varphi, 1})
\otimes
\det\nolimits_\kappa(K_{\varphi, 3})
\otimes
\det\nolimits_\kappa(I_{\varphi, 3})
\ar[d]^{\sigma \otimes \sigma}
\ar[r]^-{\gamma \otimes \gamma} &
\det\nolimits_\kappa(K_{\varphi, 2})
\otimes
\det\nolimits_\kappa(I_{\varphi, 2})
\ar[d]^\sigma
\\
\det\nolimits_\kappa(K_{\psi, 1})
\otimes
\det\nolimits_\kappa(I_{\psi, 1})
\otimes
\det\nolimits_\kappa(K_{\psi, 3})
\otimes
\det\nolimits_\kappa(I_{\psi, 3})
\ar[d]^{\gamma \otimes \gamma}
\ar[r]^-{\gamma \otimes \gamma}
&
\det\nolimits_\kappa(K_{\psi, 2})
\otimes
\det\nolimits_\kappa(I_{\psi, 2})
\ar[d]^\gamma \\
\det_\kappa(M_1)
\otimes
\det_\kappa(M_3) \ar[r]^\gamma
&
\det_\kappa(M_2)
}
$$
The top and bottom squares are commutative up to sign
by applying Lemma \ref{lemma-det-exact-sequences} (2).
The middle square is trivially
commutative (we are just switching factors). Hence we see
that
$\det\nolimits_\kappa(M_2, \varphi_2, \psi_2) =
\epsilon \det\nolimits_\kappa(M_1, \varphi_1, \psi_1)
\det\nolimits_\kappa(M_3, \varphi_3, \psi_3)
$
for some sign $\epsilon$. And the sign can be worked out, namely
the outer rectangle in the diagram above commutes up to
\begin{eqnarray*}
\epsilon & = &
(-1)^{\text{length}(I_{\varphi, 1})\text{length}(K_{\varphi, 3})
+ \text{length}(I_{\psi, 1})\text{length}(K_{\psi, 3})} \\
& = &
(-1)^{\text{length}(I_{\varphi, 1})\text{length}(I_{\psi, 3})
+ \text{length}(I_{\psi, 1})\text{length}(I_{\varphi, 3})}
\end{eqnarray*}
(proof omitted). It follows easily from this that the signs
work out as well.
\end{proof}

\begin{example}
\label{example-dual-numbers}
Let $k$ be a field.
Consider the ring $R = k[T]/(T^2)$ of dual numbers over $k$.
Denote $t$ the class of $T$ in $R$.
Let $M = R$ and $\varphi = ut$, $\psi = vt$ with $u, v \in k^*$.
In this case $\det_k(M)$ has generator $e = [t, 1]$.
We identify $I_\varphi = K_\varphi = I_\psi = K_\psi = (t)$.
Then $\gamma_\varphi(t \otimes t) = u^{-1}[t, 1]$
(since $u^{-1} \in M$ is a lift of $t \in I_\varphi$)
and $\gamma_\psi(t \otimes t) = v^{-1}[t, 1]$ (same reason).
Hence we see that $\det_k(M, \varphi, \psi) = -u/v \in k^*$.
\end{example}

\begin{example}
\label{example-Zp}
Let $R = \mathbf{Z}_p$ and let $M = \mathbf{Z}_p/(p^l)$.
Let $\varphi = p^a u$ and $\varphi = p^b v$ with $a, b \geq 0$,
$a + b = l$ and $u, v \in \mathbf{Z}_p^*$.
Then a computation as in Example \ref{example-dual-numbers}
shows that
\begin{eqnarray*}
\det\nolimits_{\mathbf{F}_p}(\mathbf{Z}_p/(p^l), p^au, p^bv) & = &
(-1)^{ab}u^b/v^a \bmod p \\
& = &
(-1)^{\text{ord}_p(\alpha)\text{ord}_p(\beta)}
\frac{\alpha^{\text{ord}_p(\beta)}}{\beta^{\text{ord}_p(\alpha)}} \bmod p
\end{eqnarray*}
with $\alpha = p^au, \beta = p^bv \in \mathbf{Z}_p$.
\end{example}

\begin{example}
\label{example-generic-vector-space}
Let $R = k$ be a field.
Let $M = k^{\oplus a} \oplus k^{\oplus b}$ be $l = a + b$ dimensional.
Let $\varphi$ and $\psi$ be the following diagonal matrices
$$
\varphi = \text{diag}(u_1, \ldots, u_a, 0, \ldots, 0),
\quad
\psi = \text{diag}(0, \ldots, 0, v_1, \ldots, v_b)
$$
with $u_i, v_j \in k^*$. In this case we have
$$
\det\nolimits_k(M, \varphi, \psi)
=
\frac{u_1 \ldots u_a}{v_1 \ldots v_b}.
$$
This can be seen by a direct computation or by computing in case $l = 1$
and using the additivity of Lemma \ref{lemma-periodic-determinant}.
\end{example}

\begin{example}
\label{example-special-vector-space}
Let $R = k$ be a field.
Let $M = k^{\oplus a} \oplus k^{\oplus a}$ be $l = 2a$ dimensional.
Let $\varphi$ and $\psi$ be the following block matrices
$$
\varphi =
\left(
\begin{matrix}
0 & U \\
0 & 0
\end{matrix}
\right),
\quad
\psi =
\left(
\begin{matrix}
0 & V \\
0 & 0
\end{matrix}
\right),
$$
with $U, V \in \text{Mat}(a \times a, k)$ invertible.
In this case we have
$$
\det\nolimits_k(M, \varphi, \psi)
=
(-1)^a\frac{\det(U)}{\det(V)}.
$$
This can be seen by a direct computation.
The case $a = 1$ is similar to the computation in
Example \ref{example-dual-numbers}.
\end{example}

\begin{example}
\label{example-a-la-oort}
Let $R = k$ be a field.
Let $M = k^{\oplus 4}$.
Let
$$
\varphi =
\left(
\begin{matrix}
  0 &   0 &   0 &   0 \\
u_1 &   0 &   0 &   0 \\
  0 &   0 &   0 &   0 \\
  0 &   0 & u_2 &   0
\end{matrix}
\right)
\quad
\varphi =
\left(
\begin{matrix}
  0 &   0 &   0 &   0 \\
  0 &   0 & v_2 &   0 \\
  0 &   0 &   0 &   0 \\
v_1 &   0 &   0 &   0
\end{matrix}
\right)
\quad
$$
with $u_1, u_2, v_1, v_2 \in k^*$.
Then we have
$$
\det\nolimits_k(M, \varphi, \psi) = -\frac{u_1u_2}{v_1v_2}.
$$
\end{example}









\section{Lengths and determinants}
\label{section-length-determinant}

\noindent
In this section we use the determinant to compare lattices.
The key lemma is the following.

\begin{lemma}
\label{lemma-key-lemma}
Let $R$ be a noetherian local ring.
Let $\mathfrak q \subset R$ be a prime with $\dim(R/\mathfrak q) = 1$.
Let $\varphi : M \to N$ be a homomorphism of finite $R$-modules.
Assume there exist $x_1, \ldots, x_l \in M$ and $y_1, \ldots, y_l \in M$
with the following properties
\begin{enumerate}
\item $M = \langle x_1, \ldots, x_l\rangle$,
\item $\langle x_1, \ldots, x_i\rangle / \langle x_1, \ldots, x_{i - 1}\rangle
\cong R/\mathfrak q$ for $i = 1, \ldots, l$,
\item $N = \langle y_1, \ldots, y_l\rangle$, and
\item $\langle y_1, \ldots, y_i\rangle / \langle y_1, \ldots, y_{i - 1}\rangle
\cong R/\mathfrak q$ for $i = 1, \ldots, l$.
\end{enumerate}
Then $\varphi$ is injective if and only if $\varphi_{\mathfrak q}$ is an
isomorphism, and in this case we have
$$
\text{length}_R(\text{Coker}(\varphi)) = \text{ord}_{R/\mathfrak q}(f)
$$
where $f \in \kappa(\mathfrak q)$ is the element such that
$$
[\varphi(x_1), \ldots, \varphi(x_l)] = f [y_1, \ldots, y_l]
$$
in $\det_{\kappa(\mathfrak q)}(N_{\mathfrak q})$.
\end{lemma}

\begin{proof}
First, note that the lemma holds in case $l = 1$.
Namely, in this case $x_1$ is a basis of $M$ over $R/\mathfrak q$
and $y_1$ is a basis of $N$ over $R/\mathfrak q$ and we have
$\varphi(x_1) = fy_1$ for some $f \in R$. Thus $\varphi$ is injective
if and only if $f \not \in \mathfrak q$. Moreover,
$\text{Coker}(\varphi) = R/(f, \mathfrak q)$ and hence the lemma
holds by definition of $\text{ord}_{R/q}(f)$
(see Definition \ref{definition-ord}).

\medskip\noindent
In fact, suppose more generally that $\varphi(x_i) = f_iy_i$ for some
$f_i \in R$, $f_i \not \in \mathfrak q$. Then the induced maps
$$
\langle x_1, \ldots, x_i\rangle / \langle x_1, \ldots, x_{i - 1}\rangle
\longrightarrow
\langle y_1, \ldots, y_i\rangle / \langle y_1, \ldots, y_{i - 1}\rangle
$$
are all injective and have cokernels isomorphic to
$R/(f_i, \mathfrak q)$. Hence we see that
$$
\text{length}_R(\text{Coker}(\varphi)) = \sum \text{ord}_{R/\mathfrak q}(f_i).
$$
On the other hand it is clear that
$$
[\varphi(x_1), \ldots, \varphi(x_l)] = f_1 \ldots f_l [y_1, \ldots, y_l]
$$
in this case from the admissible relation (b) for symbols.
Hence we see the result holds in this case also.

\medskip\noindent
We prove the general case by induction on $l$. Assume $l > 1$.
Let $i \in \{1, \ldots, l\}$ be minimal such that
$\varphi(x_1) \in \langle y_1, \ldots, y_i\rangle$.
We will argue by induction on $i$.
If $i = 1$, then we get a commutative diagram
$$
\xymatrix{
0 \ar[r] &
\langle x_1 \rangle \ar[r] \ar[d] &
\langle x_1, \ldots, x_l \rangle \ar[r] \ar[d] &
\langle x_1, \ldots, x_l \rangle / \langle x_1 \rangle \ar[r] \ar[d] &
0 \\
0 \ar[r] &
\langle y_1 \rangle \ar[r] &
\langle y_1, \ldots, y_l \rangle \ar[r] &
\langle y_1, \ldots, y_l \rangle / \langle y_1 \rangle \ar[r] &
0
}
$$
and the lemma follows from the snake lemma and induction on $l$.
Assume now that $i > 1$.
Write $\varphi(x_1) = a_1 y_1 + \ldots + a_{i - 1} y_{i - 1} + a y_i$
with $a_j, a \in R$ and $a \not \in \mathfrak q$ (since otherwise
$i$ was not minimal). Set
$$
x'_j =
\left\{
\begin{matrix}
x_j & \text{if} & j = 1 \\
ax_j & \text{if} & j \geq 2
\end{matrix}
\right.
\quad\text{and}\quad
y'_j =
\left\{
\begin{matrix}
y_j & \text{if} & j < i \\
ay_j & \text{if} & j \geq i
\end{matrix}
\right.
$$
Let $M' = \langle x'_1, \ldots, x'_l \rangle$ and 
$N' = \langle y'_1, \ldots, y'_l \rangle$.
Since $\varphi(x'_1) = a_1 y'_1 + \ldots + a_{i - 1} y'_{i - 1} + y'_i$
by construction and since for $j > 1$ we have
$\varphi(x'_j) = a\varphi(x_i) \in \langle y'_1, \ldots, y'_l\rangle$
we get a commutative diagram of $R$-modules and maps
$$
\xymatrix{
M' \ar[d] \ar[r]_{\varphi'} & N' \ar[d] \\
M \ar[r]^\varphi & N
}
$$
By the result of the second paragraph of the proof we know
that $\text{length}_R(M/M') = (l - 1)\text{ord}_{R/\mathfrak q}(a)$
and similarly
$\text{length}_R(M/M') = (l - i + 1)\text{ord}_{R/\mathfrak q}(a)$.
By a diagram chase this implies that
$$
\text{length}_R(\text{Coker}(\varphi')) =
\text{length}_R(\text{Coker}(\varphi)) + i\;\text{ord}_{R/\mathfrak q}(a).
$$
On the other hand, it is clear that writing
$$
[\varphi(x_1), \ldots, \varphi(x_l)] = f [y_1, \ldots, y_l],
\quad
[\varphi'(x'_1), \ldots, \varphi(x'_l)] = f' [y'_1, \ldots, y'_l]
$$
we have $f' = a^if$. Hence it suffices to prove the lemma for the
case that $\varphi(x_1) = a_1y_1 + \ldots a_{i - 1}y_{i - 1} + y_i$,
i.e., in the case that $a = 1$. Next, recall that
$$
[y_1, \ldots, y_l] = [y_1, \ldots, y_{i - 1},
a_1y_1 + \ldots a_{i - 1}y_{i - 1} + y_i, y_{i + 1}, \ldots, y_l]
$$
by the admissible relations for symbols. The sequence
$y_1, \ldots, y_{i - 1},
a_1y_1 + \ldots + a_{i - 1}y_{i - 1} + y_i, y_{i + 1}, \ldots, y_l$
satisfies the conditions (3), (4) of the lemma also.
Hence, we may actually
assume that $\varphi(x_1) = y_i$. In this case, note that we have
$\mathfrak q x_1 = 0$ which implies also $\mathfrak q y_i = 0$.
We have
$$
[y_1, \ldots, y_l] =
- [y_1, \ldots, y_{i - 2}, y_i, y_{i - 1}, y_{i + 1}, \ldots, y_l]
$$
by the third of the admissible relations defining
$\det_{\kappa(\mathfrak q)}(N_{\mathfrak q})$. Hence we may
replace $y_1, \ldots, y_l$ by
the sequence
$y'_1, \ldots, y'_l =
y_1, \ldots, y_{i - 2}, y_i, y_{i - 1}, y_{i + 1}, \ldots, y_l$
(which also satisfies conditions (3) and (4) of the lemma).
Clearly this decreases the invariant $i$ by $1$ and we win by induction
on $i$.
\end{proof}

\noindent
To use the previous lemma we show that often sequences of elements
with the required properties exist.

\begin{lemma}
\label{lemma-good-sequence-exists}
Let $R$ be a local Noetherian ring.
Let $\mathfrak q \subset R$ be a prime ideal.
Let $M$ be a finite $R$-module such that
$\mathfrak q$ is one of the minimal primes of the support of $M$.
Then there exist $x_1, \ldots, x_l \in M$ such that
\begin{enumerate}
\item the support of $M / \langle x_1, \ldots, x_l\rangle$ does not contain
$\mathfrak q$, and
\item $\langle x_1, \ldots, x_i\rangle / \langle x_1, \ldots, x_{i - 1}\rangle
\cong R/\mathfrak q$ for $i = 1, \ldots, l$.
\end{enumerate}
Moreover, in this case $l = \text{length}_{R_\mathfrak q}(M_\mathfrak q)$.
\end{lemma}

\begin{proof}
The condition that $\mathfrak q$ is a minimal prime in the support
of $M$ implies that $l = \text{length}_{R_\mathfrak q}(M_\mathfrak q)$
is finite (see Algebra, Lemma \ref{algebra-lemma-support-point}).
Hence we can find $y_1, \ldots, y_l \in M_{\mathfrak q}$
such that
$\langle y_1, \ldots, y_i\rangle / \langle y_1, \ldots, y_{i - 1}\rangle
\cong \kappa(\mathfrak q)$ for $i = 1, \ldots, l$.
We can find $f_i \in R$, $f_i \not \in \mathfrak q$ such that
$f_i y_i$ is the image of some element $z_i \in M$.
Moreover, as $R$ is Noetherian we can write
$\mathfrak q = (g_1, \ldots, g_t)$ for some $g_j \in R$.
By assumption $g_j y_i \in \langle y_1, \ldots, y_{i - 1} \rangle$
inside the module $M_{\mathfrak q}$.
By our choice of $z_i$ we can find some further elements
$f_{ji} \in R$, $f_{ij} \not \in \mathfrak q$ such that
$f_{ij} g_j z_i \in \langle z_1, \ldots, z_{i - 1} \rangle$
(equality in the module $M$).
The lemma follows by taking
$$
x_1 = f_{11}f_{12}\ldots f_{1t}z_1,
\quad
x_2 = f_{11}f_{12}\ldots f_{1t}f_{21}f_{22}\ldots f_{2t}z_2,
$$
and so on. Namely, since all the elements $f_i, f_{ij}$ are invertible
in $R_{\mathfrak q}$ we still have that
$R_{\mathfrak q}x_1 + \ldots + R_{\mathfrak q}x_i /
R_{\mathfrak q}x_1 + \ldots + R_{\mathfrak q}x_{i - 1}
\cong \kappa(\mathfrak q)$ for $i = 1, \ldots, l$.
By construction, $\mathfrak q x_i \in \langle x_1, \ldots, x_{i - 1}\rangle$.
Thus $\langle x_1, \ldots, x_i\rangle / \langle x_1, \ldots, x_{i - 1}\rangle$
is an $R$-module generated by one element, annihilated $\mathfrak q$
such that localizing at $\mathfrak q$ gives a $q$-dimensional
vector space over $\kappa(\mathfrak q)$.
Hence it is isomorphic to $R/\mathfrak q$.
\end{proof}

\noindent
Here is the main result of this section.
We will see below the various different
consequences of this proposition.

\begin{proposition}
\label{proposition-length-determinant-periodic-complex}
Let $R$ be a local Noetherian ring with residue field $\kappa$.
Suppose that $(M, \varphi, \psi)$ is a $(2, 1)$-periodic
complex over $R$. Assume
\begin{enumerate}
\item $M$ is a finite $R$-module,
\item the cohomology modules of $(M, \varphi, \psi)$ are of finite length, and
\item $\dim(\text{Supp}(M)) = 1$.
\end{enumerate}
Let $\mathfrak q_i$, $i = 1, \ldots, t$ be the minimal
primes of the support of $M$. Then we have\footnote{
Obviously we could get rid of the minus sign by redefining
$\det_\kappa(M, \varphi, \psi)$ as the inverse of its
current value, see Definition \ref{definition-periodic-determinant}.}
$$
- e_R(M, \varphi, \psi) =
\sum\nolimits_{i = 1, \ldots, t}
\text{ord}_{R/\mathfrak q_i}\left(
\det\nolimits_{\kappa(\mathfrak q_i)}
(M_{\mathfrak q_i}, \varphi_{\mathfrak q_i}, \psi_{\mathfrak q_i})
\right)
$$
\end{proposition}

\begin{proof}
We first reduce to the case $t = 1$ in the following way.
Note that
$\text{Supp}(M) = \{\mathfrak m, \mathfrak q_1, \ldots, \mathfrak q_t\}$,
where $\mathfrak m \subset R$ is the maximal ideal.
Let $M_i$ denote the image of $M \to M_{\mathfrak q_i}$,
so $\text{Supp}(M_i) = \{\mathfrak m, \mathfrak q_i\}$.
The map $\varphi$ (resp.\ $\psi$) induces an $R$-module map
$\varphi_i : M_i \to M_i$ (resp.\ $\psi_i : M_i \to M_i$).
Thus we get a morphism of $(2, 1)$-periodic complexes
$$
(M, \varphi, \psi) \longrightarrow
\bigoplus\nolimits_{i = 1, \ldots, t} (M_i, \varphi_i, \psi_i).
$$
The kernel and cokernel of this map have support equal to
$\{\mathfrak m\}$ (or are zero). Hence by Lemma \ref{lemma-periodic-length}
these $(2, 1)$-periodic complexes have multiplicity $0$.
In other words we have
$$
e_R(M, \varphi, \psi) =
\sum\nolimits_{i = 1, \ldots, t}
e_R(M_i, \varphi_i, \psi_i)
$$
On the other hand we clearly have $M_{\mathfrak q_i} = M_{i, \mathfrak q_i}$,
and hence the terms of the right hand side of the formula of the
lemma are equal to the expressions
$$
\text{ord}_{R/\mathfrak q_i}\left(
\det\nolimits_{\kappa(\mathfrak q_i)}
(M_{i, \mathfrak q_i}, \varphi_{i, \mathfrak q_i}, \psi_{i, \mathfrak q_i})
\right)
$$
In other words, if we can prove the lemma for each of the modules
$M_i$, then the lemma holds. This reduces us to the case $t = 1$.

\medskip\noindent
Assume we have a $(2, 1)$-periodic complex $(M, \varphi, \psi)$
over a Noetherian local ring with $M$ a finite $R$-module,
$\text{Supp}(M) = \{\mathfrak m, \mathfrak q\}$, and
finite length cohomology modules. The proof in this case
follows from Lemma \ref{lemma-key-lemma} and careful bookkeeping\footnote{
The reader is encouraged to first prove the easier
Lemma \ref{lemma-application-herbrand-quotient}
by the same method his/herself.}.
Denote
$K_\varphi = \text{Ker}(\varphi)$,
$I_\varphi = \text{Im}(\varphi)$,
$K_\psi = \text{Ker}(\psi)$, and
$I_\psi = \text{Im}(\psi)$.
Since $R$ is Noetherian these are all finite $R$-modules.
Set
$$
a = \text{length}_{R_{\mathfrak q}}(I_{\varphi, \mathfrak q})
= \text{length}_{R_{\mathfrak q}}(K_{\psi, \mathfrak q}),
\quad
b = \text{length}_{R_{\mathfrak q}}(I_{\psi, \mathfrak q})
= \text{length}_{R_{\mathfrak q}}(K_{\varphi, \mathfrak q}).
$$
Equalities because the complex becomes exact after localizing at
$\mathfrak q$. Note that $l = \text{length}_{R_{\mathfrak q}}(M_{\mathfrak q})$
is equal to $l = a + b$.

\medskip\noindent
We are going to use Lemma \ref{lemma-good-sequence-exists}
to choose sequences of elements in finite $R$-modules
$N$ with support contained in $\{\mathfrak m, \mathfrak q\}$.
In this case $N_{\mathfrak q}$ has finite length, say $n \in \mathbf{N}$.
Let us call a sequence $w_1, \ldots, w_n \in N$
with properties (1) and (2) of Lemma \ref{lemma-good-sequence-exists}
a ``good sequence''. Note that the quotient
$N/\langle w_1, \ldots, w_n \rangle$ of $N$ by the submodule generated by
a good sequence has support (contained in) $\{\mathfrak m\}$
and hence has finite length (Algebra, Lemma \ref{algebra-lemma-support-point}).
Moreover, the symbol
$[w_1, \ldots, w_n] \in \det_{\kappa(\mathfrak q)}(N_{\mathfrak q})$
is a generator, see Lemma \ref{lemma-determinant-dimension-one}.

\medskip\noindent
Having said this we choose good sequences
$$
\begin{matrix}
x_1, \ldots, x_b & \text{in} & K_\varphi, &
t_1, \ldots, t_a & \text{in} & K_\psi, \\
y_1, \ldots, y_a & \text{in} & I_\varphi \cap \langle t_1, \ldots t_a\rangle,&
s_1, \ldots, s_b & \text{in} & I_\psi \cap \langle x_1, \ldots, x_b\rangle.
\end{matrix}
$$
We will adjust our choices a little bit as follows.
Choose lifts $\tilde y_i \in M$ of $y_i \in I_\varphi$
and $\tilde s_i \in M$ of $s_i \in I_\psi$. It may not be the case
that $\mathfrak q \tilde y_1 \subset \langle x_1, \ldots, x_b\rangle$
and it may not be the case that
$\mathfrak q \tilde s_1 \subset \langle t_1, \ldots, t_a\rangle$.
However, using that $\mathfrak q$ is finitely generated (as in the proof
of Lemma \ref{lemma-good-sequence-exists}) we can find a
$d \in R$, $d \not \in \mathfrak q$ such that
$\mathfrak q d\tilde y_1 \subset \langle x_1, \ldots, x_b\rangle$
and
$\mathfrak q d\tilde s_1 \subset \langle t_1, \ldots, t_a\rangle$.
Thus after replacing $y_i$ by $dy_i$,
$\tilde y_i$ by $d\tilde y_i$, $s_i$ by $ds_i$ and $\tilde s_i$
by $d\tilde s_i$ we see that we may assume also that
$x_1, \ldots, x_b, \tilde y_1, \ldots, \tilde y_b$
and $t_1, \ldots, t_a, \tilde s_1, \ldots, \tilde s_b$
are good sequences in $M$.

\medskip\noindent
Finally, we choose a good sequence
$z_1, \ldots, z_l$ in the finite $R$-module
$$
\langle
x_1, \ldots, x_b, \tilde y_1, \ldots, \tilde y_a
\rangle
\cap
\langle 
t_1, \ldots, t_a, \tilde s_1, \ldots, \tilde s_b
\rangle.
$$
Note that this is also a good sequence in $M$.

\medskip\noindent
Since $I_{\varphi, \mathfrak q} = K_{\psi, \mathfrak q}$
there is a unique element $h \in \kappa(\mathfrak q)$ such that
$[y_1, \ldots, y_a] = h [t_1, \ldots, t_a]$
inside $\det_{\kappa(\mathfrak q)}(K_{\psi, \mathfrak q})$.
Similarly, as $I_{\psi, \mathfrak q} = K_{\varphi, \mathfrak q}$
there is a unique element $h \in \kappa(\mathfrak q)$ such that
$[s_1, \ldots, s_b] = g [x_1, \ldots, x_b]$
inside $\det_{\kappa(\mathfrak q)}(K_{\varphi, \mathfrak q})$.
We can also do this with the three good sequences we have
in $M$. All in all we get the following identities
\begin{eqnarray*}
\empty [y_1, \ldots, y_a] & = & h [t_1, \ldots, t_a] \\
\empty [s_1, \ldots, s_b] & = & g [x_1, \ldots, x_b] \\
\empty [z_1, \ldots, z_l] & = &
f_\varphi [x_1, \ldots, x_b, \tilde y_1, \ldots, \tilde y_a] \\
\empty [z_1, \ldots, z_l] & = &
f_\psi [t_1, \ldots, t_a, \tilde s_1, \ldots, \tilde s_b]
\end{eqnarray*}
for some $g, h, f_\varphi, f_\psi \in \kappa(\mathfrak q)$.

\medskip\noindent
Having set up all this
notation let us compute $\det_{\kappa(\mathfrak q)}(M, \varphi, \psi)$.
Namely, consider the element $[z_1, \ldots, z_l]$.
Under the map $\gamma_\psi \circ \sigma \circ \gamma_\varphi^{-1}$
of Definition \ref{definition-periodic-determinant} we have
\begin{eqnarray*}
[z_1, \ldots, z_l] & = &
f_\varphi [x_1, \ldots, x_b, \tilde y_1, \ldots, \tilde y_a] \\
& \mapsto & f_\varphi [x_1, \ldots, x_b] \otimes [y_1, \ldots, y_a] \\
& \mapsto &
f_\varphi h/g [t_1, \ldots, t_a] \otimes [s_1, \ldots, s_b] \\
& \mapsto &
f_\varphi h/g [t_1, \ldots, t_a, \tilde s_1, \ldots, \tilde s_b] \\
& = &
f_\varphi h/f_\psi g [z_1, \ldots, z_l]
\end{eqnarray*}
This means that
$\det_{\kappa(\mathfrak q)}
(M_{\mathfrak q}, \varphi_{\mathfrak q}, \psi_{\mathfrak q})$
is equal to $f_\varphi h/f_\psi g$ up to a sign.

\medskip\noindent
We abbreviate the following quantities
\begin{eqnarray*}
k_\varphi & = & \text{length}_R(K_\varphi/\langle x_1, \ldots, x_b\rangle) \\
k_\psi    & = & \text{length}_R(K_\psi/\langle t_1, \ldots, t_a\rangle) \\
i_\varphi & = & \text{length}_R(I_\varphi/\langle y_1, \ldots, y_a\rangle) \\
i_\psi    & = & \text{length}_R(I_\psi/\langle s_1, \ldots, s_a\rangle) \\
m_\varphi & = & \text{length}_R(M/
\langle x_1, \ldots, x_b, \tilde y_1, \ldots, \tilde y_a\rangle) \\
m_\psi    & = & \text{length}_R(M/
\langle t_1, \ldots, t_a, \tilde s_1, \ldots, \tilde s_b\rangle) \\
\delta_\varphi & = & \text{length}_R(
\langle x_1, \ldots, x_b, \tilde y_1, \ldots, \tilde y_a\rangle
\langle z_1, \ldots, z_l\rangle) \\
\delta_\psi & = & \text{length}_R(
\langle t_1, \ldots, t_a, \tilde s_1, \ldots, \tilde s_b\rangle
\langle z_1, \ldots, z_l\rangle)
\end{eqnarray*}
Using the exact sequences $0 \to K_\varphi \to M \to I_\varphi \to 0$
we get $m_\varphi = k_\varphi + i_\varphi$. Similarly we have
$m_\psi = k_\psi + i_\psi$. We have
$\delta_\varphi + m_\varphi = \delta_\psi + m_\psi$ since this
is equal to the colength of $\langle z_1, \ldots, z_l \rangle$
in $M$. Finally, we have
$$
\delta_\varphi = \text{ord}_{R/\mathfrak q}(f_\varphi),
\quad
\delta_\psi = \text{ord}_{R/\mathfrak q}(f_\psi)
$$
by our first application of the key Lemma \ref{lemma-key-lemma}.

\medskip\noindent
Next, let us compute the multiplicity of the periodic complex
\begin{eqnarray*}
e_R(M, \varphi, \psi) & = &
\text{length}_R(K_\varphi/I_\psi) - \text{length}_R(K_\psi/I_\varphi) \\
& = &
\text{length}_R(
\langle x_1, \ldots, x_b\rangle/
\langle s_1, \ldots, s_b\rangle)
+ k_\varphi - i_\psi \\
& & -
\text{length}_R(
\langle t_1, \ldots, t_a\rangle/
\langle y_1, \ldots, y_a\rangle)
- k_\psi + i_\varphi \\
& = &
\text{ord}_{R/\mathfrak q}(g/h) + k_\varphi - i_\psi - k_\psi + i_\varphi \\
& = &
\text{ord}_{R/\mathfrak q}(g/h) + m_\varphi - m_\psi \\
& = &
\text{ord}_{R/\mathfrak q}(g/h) + \delta_\psi - \delta_\varphi \\
& = &
\text{ord}_{R/\mathfrak q}(f_\psi g/f_\varphi h)
\end{eqnarray*}
where we used the key Lemma \ref{lemma-key-lemma} twice in the third equality.
By our computation of $\det_{\kappa(\mathfrak q)}
(M_{\mathfrak q}, \varphi_{\mathfrak q}, \psi_{\mathfrak q})$
this proves the proposition.
\end{proof}

\noindent
In most applications the following lemma suffices.

\begin{lemma}
\label{lemma-application-herbrand-quotient}
Let $R$ be a Noetherian local ring with maximal ideal $\mathfrak m$.
Let $M$ be a finite $R$-module, and let $\psi : M \to M$ be an
$R$-module map. Assume that
\begin{enumerate}
\item $\text{Ker}(\psi)$ and $\text{Coker}(\psi)$ have finite length, and
\item $\dim(\text{Supp}(M)) \leq 1$.
\end{enumerate}
Write
$\text{Supp}(M) = \{\mathfrak m, \mathfrak q_1, \ldots, \mathfrak q_t\}$
and denote $f_i \in \kappa(\mathfrak q_i)^*$ the element such that
$\det_{\kappa(\mathfrak q_i)}(\psi_{\mathfrak q_i}) :
\det_{\kappa(\mathfrak q_i)}(M_{\mathfrak q_i})
\to \det_{\kappa(\mathfrak q_i)}(M_{\mathfrak q_i})$
is multiplication by $f_i$. Then
we have
$$
\text{length}_R(\text{Coker}(\psi))
-
\text{length}_R(\text{Ker}(\psi))
=
\sum\nolimits_{i = 1, \ldots, t}
\text{ord}_{R/\mathfrak q_i}(f_i).
$$
\end{lemma}

\begin{proof}
Recall that $H^0(M, 0, \psi) = \text{Coker}(\psi)$ and
$H^1(M, 0, \psi) = \text{Ker}(\psi)$, see remarks above
Definition \ref{definition-periodic-length}.
The lemma follows by combining
Proposition \ref{proposition-length-determinant-periodic-complex} with
Lemma \ref{lemma-periodic-determinant-easy-case}.

\medskip\noindent
Alternative proof. Reduce to the case
$\text{Supp}(M) = \{\mathfrak m, \mathfrak q\}$
as in the proof of
Proposition \ref{proposition-length-determinant-periodic-complex}.
Then directly combine lemmas \ref{lemma-key-lemma}
and \ref{lemma-good-sequence-exists} to proof this
specific case of
Proposition \ref{proposition-length-determinant-periodic-complex}.
There is much less bookkeeping in this case, and the reader is
encouraged to work this out. Details omitted.
\end{proof}

\begin{lemma}
\label{lemma-length-multiplication}
Let $R$ be a Noetherian local ring with maximal ideal $\mathfrak m$.
Let $M$ be a finite $R$-module.
Let $x \in R$.
Assume that
\begin{enumerate}
\item $\dim(\text{Supp}(M)) \leq 1$, and
\item $\dim(M/xM) \leq 0$.
\end{enumerate}
Write
$\text{Supp}(M) = \{\mathfrak m, \mathfrak q_1, \ldots, \mathfrak q_t\}$.
Then
$$
\text{length}_R(M_x)
-
\text{length}_R({}_xM)
=
\sum\nolimits_{i = 1, \ldots, t}
\text{ord}_{R/\mathfrak q_i}(x)
\text{length}_{R_{\mathfrak q_i}}(M_{\mathfrak q_i}).
$$
where $M_x = M/xM$ and ${}_xM = \text{Ker}(x : M \to M)$.
\end{lemma}

\begin{proof}
This is a special case of Lemma \ref{lemma-application-herbrand-quotient}.
To see that $f_i = x^{\text{length}_{R_{\mathfrak q_i}}(M_{\mathfrak q_i})}$
see Lemma \ref{lemma-times-u-determinant}.
\end{proof}

\begin{lemma}
\label{lemma-additivity-divisors-restricted}
Let $R$ be a Noetherian local ring with maximal ideal $\mathfrak m$.
Let $I \subset R$ be an ideal and let $x \in R$.
Assume $x$ is a nonzero divisor on $R/I$ and that $\dim(R/I) = 1$.
Then
$$
\text{length}_R(R/(x, I))
=
\sum\nolimits_i \text{length}_R(R/(x, \mathfrak q_i))
\text{length}_{R_{\mathfrak q_i}}((R/I)_{\mathfrak q_i})
$$
where $\mathfrak q_1, \ldots, \mathfrak q_n$ are the minimal
primes over $I$. More generally if $M$ is any finite Cohen-Macaulay
module of dimension $1$ over $R$ and $\dim(M/xM) = 0$, then
$$
\text{length}_R(M/xM)
=
\sum\nolimits_i \text{length}_R(R/(x, \mathfrak q_i))
\text{length}_{R_{\mathfrak q_i}}(M_{\mathfrak q_i}).
$$
where $\mathfrak q_1, \ldots, \mathfrak q_t$ are the
minimal primes of the support of $M$.
\end{lemma}

\begin{proof}
These are special cases of Lemma \ref{lemma-length-multiplication}.
\end{proof}





\section{Setup}
\label{section-setup}

\noindent
We will throughout work over a locally Noetherian universally
catenary base $S$ endowed with a dimension function $\delta$.
Allthough it is likely possible to generalize (parts of) the
discussion in the chapter, it seems that this is a good first
approximation. We usually do not assume our schemes are
separated or quasi-compact. Many interesting algebraic stacks
are non-separated and/or non-quasi-compact and this is a good
case study to see how to develop a reasonable theory for those as well.
In order to reference these hypotheses we give it a number.

\begin{situation}
\label{situation-setup}
Here $S$ is a locally Noetherian, and universally catenary scheme.
Moreover, we assume $S$ is endowed with a dimension function
$\delta : S \longrightarrow \mathbf{Z}$.
\end{situation}

\noindent
See Morphisms, Definition \ref{morphisms-definition-universally-catenary}
for the notion of a universally catenary scheme, and see
Topology, Definition \ref{topology-definition-dimension-function}
for the notion of a dimension function. Recall that any locally
Noetherian catenary scheme locally has a dimension function, see
Properties, Lemma \ref{properties-lemma-catenary-dimension-function}.
Moreover, there are lots of schemes which are universally catenary,
see Morphisms, Lemma \ref{morphisms-lemma-ubiquity-uc}.

\medskip\noindent
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Any scheme $X$ locally of finite type over $S$ is locally Noetherian
and catenary. In fact, $X$ has a canonical dimension function
$$
\delta = \delta_{X/S} : X \longrightarrow \mathbf{Z}
$$
associated to $(f : X \to S, \delta)$ given by the rule
$\delta_{X/S}(x) = \delta(f(x)) + \text{trdeg}_{\kappa(f(x))}\kappa(x)$.
See Morphisms, Lemma \ref{morphisms-lemma-dimension-function-propagates}.
Moreover, if $h : X \to Y$ is a morphism of schemes locally of finite
type over $S$, and $x \in X$, $y = h(x)$,
then obviously
$\delta_{X/S}(x) = \delta_{Y/S}(y) + \text{trdeg}_{\kappa(y)}\kappa(x)$.
We will freely use this function and its properties in the following.

\medskip\noindent
Here are the basic examples of setups as above.
In fact, the main interest lies in the case where the base
is the spectrum of a field, or the case where the base
is the spectrum of a Dedekind ring (e.g.\ $\mathbf{Z}$,
or a discrete valuation ring).

\begin{example}
\label{example-field}
Here $S = \text{Spec}(k)$ and $k$ is a field.
We set $\delta(pt) = 0$ where $pt$ indicates the unique point of $S$.
The pair $(S, \delta)$ is an example of a situation as in
Situation \ref{situation-setup} by
Morphisms, Lemma \ref{morphisms-lemma-ubiquity-uc}.
\end{example}

\begin{example}
\label{example-domain-dimension-1}
Here $S = \text{Spec}(A)$, where $A$ is a Noetherian domain
of dimension $1$.
For example we could consider $A = \mathbf{Z}$.
We set $\delta(\mathfrak p) = 0$ if
$\mathfrak p$ is a maximal ideal and $\delta(\mathfrak p) = 1$
if $\mathfrak p = (0)$ corresponds to the generic point.
This is an example of Situation \ref{situation-setup} by
Morphisms, Lemma \ref{morphisms-lemma-ubiquity-uc}.
\end{example}

\noindent
In good cases $\delta$ corresponds to the dimension function.

\begin{lemma}
\label{lemma-delta-is-dimension}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Assume in addition $S$ is a Jacobson scheme, and $\delta(s) = 0$ for every
closed point $s$ of $S$. Let $X$ be locally of finite type over $S$.
Let $Z \subset X$ be an integral closed subscheme and let
$\xi \in Z$ be its generic point. The following integers are the same:
\begin{enumerate}
\item $\delta_{X/S}(\xi)$,
\item $\dim(Z)$, and
\item $\dim(\mathcal{O}_{Z, z})$ where $z$ is a closed point of $Z$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $X \to S$, $\xi \in Z \subset X$ be as in the lemma.
Since $X$ is locally of finite type over $S$ we see that
$X$ is Jacobson, see
Morphisms, Lemma \ref{morphisms-lemma-Jacobson-universally-Jacobson}.
Hence closed points of $X$ are dense in every closed subset of $Z$
and map to closed points of $S$. Hence given any chain
of irreducible closed subsets of $Z$ we can end it with a closed point of $Z$.
It follows that $\dim(Z) = \text{sup}_z(\dim(\mathcal{O}_{Z, z})$
(see Properties, Lemma \ref{properties-lemma-codimension-local-ring})
where $z \in Z$ runs over the closed points of $Z$.
Note that $\dim(\mathcal{O}_{Z, z}) = \delta(\xi) - \delta(z))$
by the properties of a dimension function.
For each closed $z \in Z$ the field extension
$\kappa(z) \supset \kappa(f(z))$ is finite, see Morphisms,
Lemma \ref{morphisms-lemma-jacobson-finite-type-points}.
Hence $\delta_{X/S}(z) = \delta(f(z)) = 0$ for $z \in Z$ closed.
It follows that all three integers are equal.
\end{proof}

\noindent
In the situation of the lemma above the
value of $\delta$ at the generic point of a closed irreducible subset
is the dimension of the irreducible closed subset.
However, in general we cannot expect the equality to hold.
For example if $S = \text{Spec}(\mathbf{C}[[t]])$ and
$X = \text{Spec}(\mathbf{C}((t)))$ then we would get
$\delta(x) = 1$ for the unique point of $X$, but $\dim(X) = 0$.
Still we want to think of $\delta_{X/S}$ as giving the
dimension of the irreducible closed subschemes. Thus we introduce
the following terminology.

\begin{definition}
\label{definition-delta-dimension}
Let $(S, \delta)$ as in Sitation \ref{situation-setup}.
For any scheme $X$ locally of finite type over $S$
and any irreducible closed subset $Z \subset X$ we define
$$
\dim_\delta(Z) = \delta(\xi)
$$
where $\xi \in Z$ is the generic point of $Z$.
We will call this the {\it $\delta$-dimension of $Z$}.
If $Z$ is a closed subscheme of $X$, then we define
$\dim_\delta(Z)$ as the supremum of the $\delta$-dimensions
of its irreducible components.
\end{definition}







\section{Cycles}
\label{section-cycles}

\noindent
Since we are not assuming our schemes are quasi-compact we have
to be a little careful when defining cycles. We have to allow
infinite sums because a rational function may have infinitely many
poles for example. In any case, if $X$ is quasi-compact then a
cycle is a finite sum as usual.

\begin{definition}
\label{definition-cycles}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $k \in \mathbf{Z}$.
\begin{enumerate}
\item A collection of closed subschemes $\{Z_i\}_{i \in I}$ of $X$
is said to be {\it locally finite} if for every quasi-compact open
$U \subset X$ the set
$$
\# \{i\in I \mid Z_i \cap U \not = \emptyset\}
$$
is finite.
\item A {\it cycle on $X$} is a formal sum
$$
\alpha = \sum n_Z [Z]
$$
where the sum is over integral closed subschemes $Z \subset X$,
each $n_Z \in \mathbf{Z}$, and the collection
$\{Z; n_Z \not = 0\}$ is locally finite.
\item A {\it $k$-cycle}, on $X$ is
a cycle
$$
\alpha = \sum n_Z [Z]
$$
where $n_Z \not = 0 \Rightarrow \dim_\delta(Z) = k$.
\item The abelian group of all $k$-cycles on $X$ is denoted $Z_k(X)$.
\end{enumerate}
\end{definition}

\noindent
In other words, a $k$-cycle on $X$
is a locally finite formal $\mathbf{Z}$-linear
combination of integral closed subschemes of $\delta$-dimension $k$.
Addition of $k$-cycles $\alpha = \sum n_Z[Z]$ and 
$\beta = \sum m_Z[Z]$ is given by
$$
\alpha + \beta = \sum (n_Z + m_Z)[Z],
$$
i.e., by adding the coefficients.




\section{Cycle associated to a closed subscheme}
\label{section-cycle-of-closed-subscheme}

\begin{lemma}
\label{lemma-multiplicity-finite}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $Z \subset X$ be a closed subscheme.
\begin{enumerate}
\item The collection of irreducible components of $Z$
is locally finite.
\item Let $Z' \subset Z$ be an irreducible component and
let $\xi \in Z'$ be its generic point.
Then
$$
\text{length}_{\mathcal{O}_{X, \xi}} \mathcal{O}_{Z, \xi} < \infty
$$
\item If $\dim_\delta(Z) \leq k$ and $\xi \in Z$ with
$\delta(\xi) = k$, then $\xi$ is a generic point of an
irreducible component of $Z$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $U \subset X$ be a quasi-compact open subscheme.
Then $U$ is a Noetherian scheme, and hence has a Noetherian
underlying topological space
(Properties, Lemma \ref{properties-lemma-Noetherian-topology}).
Hence every subspace is Noetherian and
has finitely many irreducible components
(see Topology, Lemma \ref{topology-lemma-Noetherian}).
This proves (1).

\medskip\noindent
Let $Z' \subset Z$, $\xi \in Z'$ be as in (2).
Then $\dim(\mathcal{O}_{Z, \xi}) = 0$ (for example by
Properties, Lemma \ref{properties-lemma-codimension-local-ring}).
Hence $\mathcal{O}_{Z, \xi}$ is Noetherian
local ring of dimension zero, and hence has finite length over
itself (see
Algebra, Proposition \ref{algebra-proposition-dimension-zero-ring}).
Hence, it also has finite length over $\mathcal{O}_{X, \xi}$, see
Lemma \ref{lemma-pushdown-module}.

\medskip\noindent
Assume $\xi \in Z$ and $\delta(\xi) = k$.
Consider the closure $Z' = \overline{\{\xi\}}$. It is an irreducible
closed subscheme with $\dim_\delta(Z') = k$ by definition.
Since $\dim_\delta(Z) = k$ it must be an irreducible component
of $Z$. Hence we see (3) holds.
\end{proof}

\begin{definition}
\label{definition-cycle-associated-to-closed-subscheme}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $Z \subset X$ be a closed subscheme.
\begin{enumerate}
\item For any irreducible component $Z' \subset Z$ with generic point $\xi$
the integer
$m_{Z', Z} = \text{length}_{\mathcal{O}_{X, \xi}} \mathcal{O}_{Z, \xi}$
(Lemma \ref{lemma-multiplicity-finite})
is called the {\it multiplicity of $Z'$ in $Z$}.
\item Assume $\dim_\delta(Z) \leq k$.
The {\it $k$-cycle associated to $Z$} is
$$
[Z]_k
=
\sum m_{Z', Z}[Z']
$$
where the sum is over the irreducible components of $Z$
of $\delta$-dimension $k$. (This is a $k$-cycle by
Lemma \ref{lemma-multiplicity-finite}.)
\end{enumerate}
\end{definition}

\noindent
It is important to note that we only define $[Z]_k$ if the $\delta$-dimension
of $Z$ does not exceed $k$. In other words, by convention, if we write
$[Z]_k$ then this implies that $\dim_\delta(Z) \leq k$.



\section{Cycle associated to a coherent sheaf}
\label{section-cycle-of-coherent-sheaf}



\begin{lemma}
\label{lemma-length-finite}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{F}$ be a coherent $\mathcal{O}_X$-module.
\begin{enumerate}
\item The collection of irreducible components of the support of
$\mathcal{F}$ is locally finite.
\item Let $Z' \subset \text{Supp}(\mathcal{F})$
be an irreducible component and
let $\xi \in Z'$ be its generic point.
Then
$$
\text{length}_{\mathcal{O}_{X, \xi}} \mathcal{F}_\xi < \infty
$$
\item If $\dim_\delta(\text{Supp}(\mathcal{F})) \leq k$
and $\xi \in Z$ with $\delta(\xi) = k$, then $\xi$ is a
generic point of an irreducible component of $\text{Supp}(\mathcal{F})$.
\end{enumerate}
\end{lemma}

\begin{proof}
By Coherent, Lemma \ref{coherent-lemma-coherent-support-closed}
the support $Z$ of $\mathcal{F}$ is a closed subset of $X$.
We may think of $Z$ as a reduced closed subscheme of $X$
(Schemes, Lemma \ref{schemes-lemma-reduced-closed-subscheme}).
Hence (1) and (3) follow immediately by applying
Lemma \ref{lemma-multiplicity-finite} to $Z \subset X$.

\medskip\noindent
Let $\xi \in Z'$ be as in (2). In this case for any specialization
$\xi' \leadsto \xi$ in $X$ we have $\mathcal{F}_{\xi'} = 0$.
Recall that the non-maximal primes of $\mathcal{O}_{X, \xi}$ correspond
to the points of $X$ specializing to $\xi$
(Schemes, Lemma \ref{schemes-lemma-specialize-points}).
Hence $\mathcal{F}_\xi$ is a finite $\mathcal{O}_{X, \xi}$-module
whose support is $\{\mathfrak m_\xi\}$. Hence it has finite length
by Algebra, Lemma \ref{algebra-lemma-support-point}.
\end{proof}

\begin{definition}
\label{definition-cycle-associated-to-coherent-sheaf}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{F}$ be a coherent $\mathcal{O}_X$-module.
\begin{enumerate}
\item For any irreducible component $Z' \subset \text{Supp}(\mathcal{F})$
with generic point $\xi$ the integer
$m_{Z', \mathcal{F}} = \text{length}_{\mathcal{O}_{X, \xi}} \mathcal{F}_\xi$
(Lemma \ref{lemma-length-finite})
is called the {\it multiplicity of $Z'$ in $\mathcal{F}$}.
\item Assume $\dim_\delta(\text{Supp}(\mathcal{F})) \leq k$.
The {\it $k$-cycle associated to $\mathcal{F}$} is
$$
[\mathcal{F}]_k
=
\sum m_{Z', \mathcal{F}}[Z']
$$
where the sum is over the irreducible components of
$\text{Supp}(\mathcal{F})$ of $\delta$-dimension $k$.
(This is a $k$-cycle by Lemma \ref{lemma-length-finite}.)
\end{enumerate}
\end{definition}

\noindent
It is important to note that we only define $[\mathcal{F}]_k$
if $\mathcal{F}$ is coherent and the $\delta$-dimension
of $\text{Supp}(\mathcal{F})$ does not exceed $k$. In other words,
by convention, if we write $[\mathcal{F}]_k$ then this implies that
$\mathcal{F}$ is coherent on $X$ and
$\dim_\delta(\text{Supp}(\mathcal{F})) \leq k$.

\begin{lemma}
\label{lemma-cycle-closed-coherent}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $Z \subset X$ be a closed subscheme.
If $\dim_\delta(Z) \leq k$, then $[Z]_k = [{\mathcal O}_Z]_k$.
\end{lemma}

\begin{proof}
This is because in this case the multiplicities $m_{Z', Z}$ and
$m_{Z', \mathcal{O}_Z}$ agree by definition.
\end{proof}

\begin{lemma}
\label{lemma-additivity-sheaf-cycle}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $0 \to \mathcal{F} \to \mathcal{G} \to \mathcal{H} \to 0$
be a short exact sequence of coherent sheaves on $X$.
Assume that the $\delta$-dimension of the supports
of $\mathcal{F}$, $\mathcal{G}$, and $\mathcal{H}$ is $\leq k$.
Then $[\mathcal{G}]_k = [\mathcal{F}]_k + [\mathcal{H}]_k$.
\end{lemma}

\begin{proof}
Follows immediately from additivity of lengths, see
Algebra, Lemma \ref{algebra-lemma-length-additive}.
\end{proof}









\section{Preparation for proper pushforward}
\label{section-preparation-pushforward}

\begin{lemma}
\label{lemma-equal-dimension}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a morphism.
Assume $X$, $Y$ integral and $\dim_\delta(X) = \dim_\delta(Y)$.
Then either $f(X)$ is contained in a proper closed subscheme
of $Y$, or $f$ is dominant and the extension of function fields
$R(Y) \subset R(X)$ is finite.
\end{lemma}

\begin{proof}
The closure $\overline{f(X)} \subset Y$ is irreducible as $X$
is irreducible. If $\overline{f(X)} \not = Y$, then we are done.
If $\overline{f(X)} = Y$, then $f$ is dominant and by
Morphisms,
Lemma \ref{morphisms-lemma-dominant-finite-number-irreducible-components}
we see that the generic point $\eta_Y$ of $Y$ is in the image of $f$.
Of course this implies that $f(\eta_X) = \eta_Y$, where $\eta_X \in X$
is the generic point of $X$. Since $\delta(\eta_X) = \delta(\eta_Y)$
we see that $R(Y) = \kappa(\eta_Y) \subset \kappa(\eta_X) = R(X)$
is an extension of transcendence degree $0$.
Hence Morphisms, Lemma \ref{morphisms-lemma-finite-degree} applies.
\end{proof}

\begin{lemma}
\label{lemma-quasi-compact-locally-finite}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a morphism.
Assume $f$ is quasi-compact, and $\{Z_i\}_{i \in I}$ is a locally
finite collection of closed subsets of $X$.
Then $\{\overline{f(Z_i)}\}_{i \in I}$ is a locally finite
collection of closed subsets of $Y$.
\end{lemma}

\begin{proof}
Let $V \subset Y$ be a quasi-compact open subset.
Since $f$ is quasi-compact the open $f^{-1}(V)$ is
quasi-compact. Hence the set
$\{i \in I \mid Z_i \cap f^{-1}(V) \not = \emptyset \}$
is finite by assumption. Since this is the same
as the set
$\{i \in I \mid f(Z_i) \cap V \not = \emptyset \}$
we win.
\end{proof}









\section{Proper pushforward}
\label{section-proper-pushforward}

\begin{definition}
\label{definition-proper-pushforward}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a morphism.
Assume $f$ is proper.
\begin{enumerate}
\item Let $Z \subset X$ be an integral closed subscheme
with $\dim_\delta(Z) = k$. We define
$$
f_*[Z] =
\left\{
\begin{matrix}
0 & \text{if} & \dim_\delta(f(Z))< k, \\
\deg(Z/f(Z)) [f(Z)] & \text{if} & \dim_\delta(f(Z)) = k.
\end{matrix}
\right.
$$
Here we think of $f(Z) \subset Y$ as an integral closed subscheme.
The degree of $Z$ over $f(Z)$ is finite if
$\dim_\delta(f(Z)) = \dim_\delta(Z)$
by Lemma \ref{lemma-equal-dimension}.
\item Let $\alpha = \sum n_Z [Z]$ be a $k$-cycle on $X$. The
{\it pushforward} of $\alpha$ as the sum
$$
f_* \alpha = \sum n_Z f_*[Z]
$$
where each $f_*[Z]$ is defined as above. The sum is locally finite
by Lemma \ref{lemma-quasi-compact-locally-finite} above.
\end{enumerate}
\end{definition}

\noindent
By definition the proper pushforward of cycles
$$
f_* : Z_k(X) \longrightarrow Z_k(Y)
$$
is a homomorphism of abelian groups. It turns $X \mapsto Z_k(X)$
into a covariant functor on the category of schemes locally of
finite type over $S$ with morphisms equal to proper morphisms.

\begin{lemma}
\label{lemma-compose-pushforward}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$, $Y$, and $Z$ be locally of finite type over $S$.
Let $f : X \to Y$ and $g : Y \to Z$ be proper morphisms.
Then $g_* \circ f_* = (g \circ f)_*$ as maps $Z_k(X) \to Z_k(Z)$.
\end{lemma}

\begin{proof}
Let $W \subset X$ be an integral closed subscheme of dimension $k$.
Consider $W' = f(Z) \subset Y$ and $W'' = g(f(Z)) \subset Z$.
Since $f$, $g$ are proper we see that $W'$ (resp.\ $W''$) is
an integral closed subscheme of $Y$ (resp.\ $Z$).
We have to show that $g_*(f_*[W]) = (f \circ g)_*[W]$.
If $\dim_\delta(W'') < k$, then both sides are zero.
If $\dim_\delta(W'') = k$, then we see the induced morphisms
$$
W \longrightarrow
W' \longrightarrow
W''
$$
both satisfy the hypotheses of Lemma \ref{lemma-equal-dimension}. Hence
$$
g_*(f_*[W]) = \deg(W/W')\deg(W'/W'')[W''],
\quad
(f \circ g)_*[W] = \deg(W/W'')[W''].
$$
Then we can apply
Morphisms, Lemma \ref{morphisms-lemma-degree-composition}
to conclude.
\end{proof}

\begin{lemma}
\label{lemma-cycle-push-sheaf}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a morphism.
Assume $f$ is proper.
\begin{enumerate}
\item Let $Z \subset X$ be a closed subscheme with $\dim_\delta(Z) \leq k$.
Then
$$
f_*[Z]_k = [f_*{\mathcal O}_Z]_k.
$$
\item Let $\mathcal{F}$ be a coherent sheaf on $X$ such that
$\dim_\delta(\text{Supp}(\mathcal{F})) \leq k$. Then
$$
f_*[\mathcal{F}]_k = [f_*{\mathcal F}]_k.
$$
\end{enumerate}
Note that the statement makes sense since $f_*\mathcal{F}$ and
$f_*\mathcal{O}_Z$ are coherent $\mathcal{O}_Y$-modules by
Coherent, Lemma \ref{coherent-lemma-proper-pushforward-coherent}.
\end{lemma}

\begin{proof}
Part (1) follows from (2) and Lemma \ref{lemma-cycle-closed-coherent}.
Let $\mathcal{F}$ be a coherent sheaf on $X$.
Assume that $\dim_\delta(\text{Supp}(\mathcal{F})) \leq k$.
By Coherent, Lemma \ref{coherent-lemma-coherent-support-closed}
there exists a closed subscheme $i : Z \to X$ and a coherent
$\mathcal{O}_Z$-module $\mathcal{G}$ such that
$i_*\mathcal{G} \cong \mathcal{F}$ and such that the support
of $\mathcal{F}$ is $Z$. Let $Z' \subset Y$ be the scheme theoretic image
of $f|_Z : Z \to Y$.Consider the commutative diagram of schemes
$$
\xymatrix{
Z \ar[r]_i \ar[d]_{f|_Z} &
X \ar[d]^f \\
Z' \ar[r]^{i'} & Y
}
$$
We have $f_*\mathcal{F} = f_*i_*\mathcal{G} = i'_*(f|_Z)_*\mathcal{G}$
by going around the diagram in two ways. Suppose we know the result holds
for closed immersions and for $f|_Z$. Then we see that
$$
f_*[\mathcal{F}]_k = f_*i_*[\mathcal{G}]_k
= (i')_*(f|_Z)_*[\mathcal{G}]_k =
(i')_*[(f|_Z)_*\mathcal{G}]_k =
[(i')_*(f|_Z)_*\mathcal{G}]_k = [f_*\mathcal{F}]_k
$$
as desired. The case of a closed immersion is straightforward (omitted).
Note that $f|_Z : Z \to Z'$ is a dominant morphism (see
Morphisms, Lemma \ref{morphisms-lemma-quasi-compact-scheme-theoretic-image}).
Thus we have reduced to the case where
$\dim_\delta(X) \leq k$ and $f : X \to Y$ is proper and dominant.

\medskip\noindent
Assume $\dim_\delta(X) \leq k$ and $f : X \to Y$ is proper and dominant.
Since $f$ is dominant, for every irreducible component $Z \subset Y$
with generic point $\eta$ there exists a point $\xi \in X$ such
that $f(\xi) = \eta$. Hence $\delta(\eta) \leq \delta(\xi) \leq k$.
Thus we see that in the expressions
$$
f_*[\mathcal{F}]_k = \sum n_Z[Z],
\quad
\text{and}
\quad
[f_*\mathcal{F}]_k = \sum m_Z[Z].
$$
whenever $n_Z \not = 0$, or $m_Z \not = 0$ the integral closed
subscheme $Z$ is actually an irreducible component of $Y$ of
$\delta$-dimension $k$. Pick such an integral closed subscheme
$Z \subset Y$ and denote $\eta$ its generic point. Note that for
any $\xi \in X$ with $f(\xi) = \eta$ we have $\delta(\xi) \geq k$
and hence $\xi$ is a generic point of an irreducible component
of $X$ of $\delta$-dimension $k$ as well
(see Lemma \ref{lemma-multiplicity-finite}). Since $f$ is quasi-compact
and $X$ is locally Noetherian, there can be only finitely many of
these and hence $f^{-1}(\{\eta\})$ is finite.
By Morphisms, Lemma \ref{morphisms-lemma-generically-finite} there exists
an open neighbourhood $\eta \in V \subset Y$ such that $f^{-1}(V) \to V$
is finite. Replacing $Y$ by $V$ and $X$ by $f^{-1}(V)$ we reduce to the
case where $Y$ is affine, and $f$ is finite.

\medskip\noindent
Write $Y = \text{Spec}(R)$ and $X = \text{Spec}(A)$ (possible as
a finite morphism is affine).
Then $R$ and $A$ are Noetherian rings and $A$ is finite over $R$.
Moreover $\mathcal{F} = \widetilde{M}$ for some finite $A$-module
$M$. Note that $f_*\mathcal{F}$ corresponds to $M$ viewed as an $R$-module.
Let $\mathfrak p \subset R$ be the minimal prime corresponding
to $\eta \in Y$. The coefficient of $Z$ in $[f_*\mathcal{F}]_k$
is clearly $\text{length}_{R_{\mathfrak p}}(M_{\mathfrak p})$.
Let $\mathfrak q_i$, $i = 1, \ldots, t$ be the primes of $A$
lying over $\mathfrak p$. Then $A_{\mathfrak p} = \prod A_{\mathfrak q_i}$
since $A_{\mathfrak p}$ is an Artinian ring being finite over the
dimension zero local Noetherian ring $R_{\mathfrak p}$.
Clearly the coefficient of $Z$ in $f_*[\mathcal{F}]_k$ is
$$
\sum\nolimits_{i = 1, \ldots, t}
[\kappa(\mathfrak q_i) : \kappa(\mathfrak p)]
\text{length}_{A_{\mathfrak q_i}}(M_{\mathfrak q_i})
$$
Hence the desired equality follows from Lemma \ref{lemma-pushdown-module}.
\end{proof}




















\section{Preparation for flat pullback}
\label{section-preparation-flat-pullback}


\noindent
Recall that a morphism $f : X \to Y$ which is locally of finite type
is said to have relative dimension $r$ if every nonempty fibre
is equidimensional of dimension $r$. See
Morphisms, Definition \ref{morphisms-definition-relative-dimension-d}.

\begin{lemma}
\label{lemma-flat-inverse-image-dimension}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a morphism.
Assume $f$ is flat of relative dimension $r$.
For any closed subset $Z \subset Y$ we have
$$
\dim_\delta(f^{-1}(Z)) = \dim_\delta(Z) + r.
$$
If $Z$ is irreducible and $Z' \subset f^{-1}(Z)$ is an irreducible
component, then $Z'$ dominates $Z$ and
$\dim_\delta(Z') = \dim_\delta(Z) + r$.
\end{lemma}

\begin{proof}
It suffices to prove the final statement.
We may replace $Y$ by the integral closed subscheme $Z$ and
$X$ by the scheme theoretic inverse image $f^{-1}(Z) = Z \times_Y X$.
Hence we may assume $Z = Y$ is integral and $f$ is a flat morphism
of relative dimension $r$. Since $Y$ is locally Noetherian the
morphism $f$ which is locally of finite type,
is actually locally of finite presentation. Hence
Morphisms, Lemma \ref{morphisms-lemma-fppf-open}
applies and we see that $f$ is open.
Let $\xi \in X$ be a generic point of an irreducible component
of $X$. By the openness of $f$ we see that $f(\xi)$ is the
generic point $\eta$ of $Z = Y$. Note that $\dim_\xi(X_\eta) = r$
by assumption that $f$ has relative dimension $r$. On the other
hand, since $\xi$ is a generic point of $X$ we see that
$\mathcal{O}_{X, \xi} = \mathcal{O}_{X_\eta, \xi}$ has only one
prime ideal and hence has dimension $0$. Thus by
Morphisms, Lemma \ref{morphisms-lemma-dimension-fibre-at-a-point}
we conclude that the transcendence
degree of $\kappa(\xi)$ over $\kappa(\eta)$ is $r$.
In other words, $\delta(\xi) = \delta(\eta) + r$ as desired.
\end{proof}

\noindent
Here is the lemma that we will use to prove that the flat pullback
of a locally finite collection of closed subschemes is locally finite.

\begin{lemma}
\label{lemma-inverse-image-locally-finite}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a morphism.
Assume $\{Z_i\}_{i \in I}$ is a locally
finite collection of closed subsets of $Y$.
Then $\{f^{-1}(Z_i)\}_{i \in I}$ is a locally finite
collection of closed subsets of $Y$.
\end{lemma}

\begin{proof}
Let $U \subset X$ be a quasi-compact open subset.
Since the image $f(U) \subset Y$ is a quasi-compact subset
there exists a quasi-compact open $V \subset Y$ such that
$f(U) \subset V$. Note that 
$$
\{i \in I \mid f^{-1}(Z_i) \cap U \not = \emptyset \}
\subset
\{i \in I \mid Z_i \cap V \not = \emptyset \}.
$$
Since the right hand side is finite by assumption we win.
\end{proof}



\section{Flat pullback}
\label{section-flat-pullback}

\noindent
In the following we use $f^{-1}(Z)$ to denote the
{\it scheme theoretic inverse image} of a closed subscheme
$Z \subset Y$ for a morphism of schemes $f : X \to Y$.
We recall that the scheme theoretic inverse image is the fibre product
$$
\xymatrix{
f^{-1}(Z) \ar[r] \ar[d] & X \ar[d] \\
Z \ar[r] & Y
}
$$
and it is also the closed subscheme of $X$ cut out by the
quasi-coherent sheaf of ideals $f^{-1}(\mathcal{I})\mathcal{O}_X$, if
$\mathcal{I} \subset \mathcal{O}_Y$ is the quasi-coherent sheaf of ideals
corresponding to $Z$ in $Y$.
(This is discussed in
Schemes, Section \ref{schemes-section-closed-immersion} and
Lemma \ref{schemes-lemma-fibre-product-immersion}
and Definition \ref{schemes-definition-inverse-image-closed-subscheme}.)

\begin{definition}
\label{definition-flat-pullback}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a morphism.
Assume $f$ is flat of relative dimension $r$.
\begin{enumerate}
\item Let $Z \subset Y$ be an integral closed subscheme of
$\delta$-dimension $k$. We define $f^*[Z]$ to be the
$(k+r)$-cycle on $X$ to the scheme theoretic inverse image
$$
f^*[Z] = [f^{-1}(Z)]_{k+r}.
$$
This makes sense since $\dim_\delta(f^{-1}(Z)) = k + r$
by Lemma \ref{lemma-flat-inverse-image-dimension}.
\item Let $\alpha = \sum n_i [Z_i]$ be
a $k$-cycle on $Y$. The {\it flat pullback of $\alpha$ by $f$}
is the sum
$$
f^* \alpha = \sum n_i f^*[Z_i]
$$
where each $f^*[Z_i]$ is defined as above.
The sum is locally finite by Lemma \ref{lemma-inverse-image-locally-finite}.
\item We denote $f^* : Z_k(Y) \to Z_{k + r}(Y)$ the map of abelian
groups so obtained.
\end{enumerate}
\end{definition}

\noindent
An open immersion is flat. This is an important though trivial special
case of a flat morphism. If $U \subset X$ is open then sometimes the
pullback by $j : U \to X$ of a cycle is called the {\it restriction} of the
cycle to $U$. Note that in this case the maps
$$
j^* : Z_k(X) \longrightarrow Z_k(U)
$$
are all {\it surjective}. The reason is that given any integral closed
subscheme $Z' \subset U$, we can take the closure of $Z$ of $Z'$ in $X$
and think of it as a reduced closed subscheme of $X$ (see
Schemes, Lemma \ref{schemes-lemma-reduced-closed-subscheme}).
And clearly $Z \cap U = Z'$, in other words
$j^*[Z] = [Z']$ whence the surjectivity. In fact a little bit more
is true.

\begin{lemma}
\label{lemma-exact-sequence-open}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $U \subset X$ be an open subscheme, and denote
$i : Y = X \setminus U \to X$ as a reduced closed subscheme of $X$.
For every $k \in \mathbf{Z}$ the sequence
$$
\xymatrix{
Z_k(Y) \ar[r]^{i_*} & Z_k(X) \ar[r]^{j_*} & Z_k(U) \ar[r] & 0
}
$$
is an exact complex of abelian groups.
\end{lemma}

\begin{proof}
By the description above the basis elements $[Z]$ of the free
abelian group $Z_k(X)$ map either to (distinct) basis elements
$[Z \cap U]$ or to zero if $Z \subset Y$. Hence the lemma is clear.
\end{proof}

\begin{lemma}
\label{lemma-compose-flat-pullback}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X, Y, Z$ be locally of finite type over $S$.
Let $f : X \to Y$ and $g : Y \to Z$ be flat morphisms of relative dimensions
$r$ and $s$. Then $g \circ f$ is flat of relative dimension
$r + s$ and
$$
f^* \circ g^* = (g \circ f)^*
$$
as maps $Z_k(Z) \to Z_{k + r + s}(X)$.
\end{lemma}

\begin{proof}
The composition is flat of relative dimension $r + s$ by
Morphisms, Lemma \ref{morphisms-lemma-composition-relative-dimension-d}.
Suppose that
\begin{enumerate}
\item $W \subset Z$ is a closed integral subscheme of $\delta$-dimension $k$,
\item $W' \subset Y$ is a closed integral subscheme of $\delta$-dimension
$k + s$ with $W' \subset g^{-1}(W)$, and
\item $W'' \subset Y$ is a closed integral subscheme of $\delta$-dimension
$k + s + r$ with $W'' \subset f^{-1}(W')$.
\end{enumerate}
We have to show that the coefficient $n$ of $[W'']$ in
$(g \circ f)^*[W]$ agrees with the coefficient $m$ of
$[W'']$ in $f^*(g^*[W])$. That it suffices to check the lemma in these
cases follows from Lemma \ref{lemma-flat-inverse-image-dimension}.
Let $\xi'' \in W''$, $\xi' \in W'$
and $\xi \in W$ be the generic points. Consider the local rings
$A = \mathcal{O}_{Z, \xi}$, $B = \mathcal{O}_{Y, \xi'}$
and $C = \mathcal{O}_{X, \xi''}$. Then we have local flat ring maps
$A \to B$, $B \to C$ and moreover
$$
n = \text{length}_C(C/\mathfrak m_AC),
\quad
\text{and}
\quad
m = \text{length}_C(C/\mathfrak m_BC) \text{length}_B(B/\mathfrak m_AB)
$$
Hence the equality follows from Lemma \ref{lemma-pullback-transitive}
with $M = A/\mathfrak m_A$.
\end{proof}

\begin{lemma}
\label{lemma-pullback-coherent}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X, Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a flat morphism of relative dimension $r$.
\begin{enumerate}
\item Let $Z \subset Y$ be a closed subscheme with
$\dim_\delta(Z) \leq k$. Then we have
$\dim_\delta(f^{-1}(Z)) \leq k + r$
and $[f^{-1}(Z)]_{k + r} = f^*[Z]_k$ in $Z_{k + r}(X)$.
\item Let $\mathcal{F}$ be a coherent sheaf on $Y$ with
$\dim_\delta(\text{Supp}(\mathcal{F})) \leq k$.
Then we have $\dim_\delta(\text{Supp}(f^*\mathcal{F})) \leq k + r$
and
$$
f^*[{\mathcal F}]_k = [f^*{\mathcal F}]_{k+r}
$$
in $Z_{k + r}(X)$.
\end{enumerate}
\end{lemma}

\begin{proof}
Part (1) follows from part (2) by Lemma \ref{lemma-cycle-closed-coherent}
and the fact that $f^*\mathcal{O}_Z = \mathcal{O}_{f^{-1}(Z)}$.

\medskip\noindent
Proof of (2).
As $X$, $Y$ are locally Noetherian we may apply
Coherent, Lemma \ref{coherent-lemma-coherent-Noetherian} to see
that $\mathcal{F}$ is of finite type, hence $f^*\mathcal{F}$ is
of finite type (Modules, Lemma \ref{modules-lemma-pullback-finite-type}),
hence $f^*\mathcal{F}$ is coherent
(Coherent, Lemma \ref{coherent-lemma-coherent-Noetherian} again).
Thus the lemma makes sense. Let $W \subset Y$ be an integral closed
subscheme of $\delta$-dimension $k$, and let $W' \subset X$ be
an integral closed subscheme of dimension $k + r$ mapping into $W$
under $f$. We have to show that the coefficient $n$ of
$[W]$ in $f^*[{\mathcal F}]_k$ agrees with the coefficient
$m$ of $[W]$ in $[f^*{\mathcal F}]_{k+r}$. Let $\xi \in W$ and
$\xi' \in W'$ be the generic points. Let
$A = \mathcal{O}_{Y, \xi}$, $B = \mathcal{O}_{X, \xi'}$
and set $M = \mathcal{F}_\xi$ as an $A$-module. (Note that
$M$ has finite length by our dimension assumptions, but we
actually do not need to verify this. See
Lemma \ref{lemma-length-finite}.)
We have $f^*\mathcal{F}_{\xi'} = B \otimes_A M$.
Thus we see that
$$
n = \text{length}_B(B \otimes_A M)
\quad
\text{and}
\quad
m = \text{length}_A(M) \text{length}_B(B/\mathfrak m_AB)
$$
Thus the equality follows from Lemma \ref{lemma-pullback-module}.
\end{proof}



\section{Push and pull}
\label{section-push-pull}

\noindent
In this section we verify that proper pushforward and flat pullback
are compatible when this makes sense. By the work we did above this
is a consequence of cohomology and base change.

\begin{lemma}
\label{lemma-flat-pullback-proper-pushforward}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let
$$
\xymatrix{
X' \ar[r]_{g'} \ar[d]_{f'} & X \ar[d]^f \\
Y' \ar[r]^g & Y
}
$$
be a fibre product diagram of schemes locally of finite type over $S$.
Assume $f : X \to Y$ proper and $g : Y' \to Y$ flat of relative dimension $r$.
Then also $f'$ is proper and $g'$ is flat of relative dimension $r$.
For any $k$-cycle $\alpha$ on $X$ we have
$$
g^*f_*\alpha = f'_*(g')^*\alpha
$$
in $Z_{k + r}(Y')$.
\end{lemma}

\begin{proof}
The assertion that $f'$ is proper follows from
Morphisms, Lemma \ref{morphisms-lemma-base-change-proper}.
The assertion that $g'$ is flat of relative dimension $r$ follows from
Morphisms, Lemmas \ref{morphisms-lemma-base-change-relative-dimension-d}
and \ref{morphisms-lemma-base-change-flat}.
It suffices to prove the equality of cycles when $\alpha = [W]$
for some integral closed subscheme $W \subset X$ of $\delta$-dimension $k$.
Note that in this case we have $\alpha = [\mathcal{O}_W]_k$, see
Lemma \ref{lemma-cycle-closed-coherent}.
By Lemmas \ref{lemma-cycle-push-sheaf} and
\ref{lemma-pullback-coherent} it therefore suffices
to show that $f'_*(g')^*\mathcal{O}_W$ is isomorphic to
$g^*f_*\mathcal{O}_W$. This follows from cohomology and
base change, see
Coherent, Lemma \ref{coherent-lemma-flat-base-change-cohomology}.
\end{proof}

\begin{lemma}
\label{lemma-finite-flat}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a finite locally free morphism
of degree $d$ (see
Morphisms, Definition \ref{morphisms-definition-finite-locally-free}).
Then $f$ is both proper and flat of relative dimension $0$, and
$$
f_*f^*\alpha = d\alpha
$$
for every $\alpha \in Z_k(Y)$.
\end{lemma}

\begin{proof}
A finite locally free morphism is flat and finite by
Morphisms, Lemma \ref{morphisms-lemma-finite-flat},
and a finite morphism is proper
by Morphisms, Lemma \ref{morphisms-lemma-finite-proper}.
We omit showing that a finite
morphism has relative dimension $0$. Thus the formula makes sense.
To prove it, let $Z \subset Y$ be an integral closed subscheme
of $\delta$-dimension $k$. It suffices to prove the formula
for $\alpha = [Z]$. Since the base change of a finite locally free
morphism is finite locally free
(Morphisms, Lemma \ref{morphisms-lemma-base-change-finite-locally-free})
we see that $f_*f^*\mathcal{O}_Z$ is a finite locally free sheaf of
rank $d$ on $Z$. Hence
$$
f_*f^*[Z] = f_*f^*[\mathcal{O}_Z]_k =
[f_*f^*\mathcal{O}_Z]_k = d[Z]
$$
where we have used Lemmas \ref{lemma-pullback-coherent} and
\ref{lemma-cycle-push-sheaf}.
\end{proof}








\section{Preparation for principal divisors}
\label{section-preparation-principal-divisors}

\noindent
Recall that if $Z$ is an irreducible closed subset of a scheme $X$,
then the codimension of $Z$ in $X$ is equal to the dimension
of the local ring $\mathcal{O}_{X, \xi}$, where $\xi \in Z$
is the generic point. See
Properties, Lemma \ref{properties-lemma-codimension-local-ring}.

\begin{definition}
\label{definition-order-vanishing}
Let $X$ be a locally Noetherian scheme. Assume $X$ is integral.
Let $f \in R(X)^*$. For every integral closed subscheme
$Z \subset X$ of codimension $1$ we define
the {\it order of vanishing of $f$ along $Z$} as the integer
$$
\text{ord}_Z(f) = \text{ord}_{\mathcal{O}_{X, \xi}}(f)
$$
where the right hand side is the notion of
Definition \ref{definition-ord} and $\xi$ is the generic point of $Z$.
\end{definition}

\noindent
Of course it can happen that $\text{ord}_Z(f) < 0$.
In this case we say that $f$ has a {\it pole} along $Z$
and that $-\text{ord}_Z(f) > 0$ is the {\it order of pole of
$f$ along $Z$}. Note that for $f, g \in R(X)^*$ we have
$$
\text{ord}_Z(fg) = \text{ord}_Z(f) + \text{ord}_Z(g).
$$

\begin{lemma}
\label{lemma-divisor-delta-dimension}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$. Assume $X$ is
integral. If $Z \subset X$ is an integral closed subscheme
of codimension $1$, then $\dim_\delta(Z) = \dim_\delta(X) - 1$.
\end{lemma}

\begin{proof}
This is more or less the defining property of a dimension function.
\end{proof}

\begin{lemma}
\label{lemma-divisor-locally-finite}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$. Assume $X$ is
integral. Let $f \in R(X)^*$. Then the set
$$
\{Z \subset X \mid Z \text{ is integral, closed of codimension }1
\text{ and }\text{ord}_Z(f) \not = 0\}
$$
is locally finite in $X$.
\end{lemma}

\begin{proof}
This is true simply because there exists a nonempty open subscheme
$U \subset X$ such that $f$ corresponds to a section of
$\Gamma(U, \mathcal{O}_X^*)$, and hence the codimension $1$
irreducibles which can occur in the set of the lemma are all
irreducible components of $X \setminus U$.
Hence Lemma \ref{lemma-multiplicity-finite} gives the desired result.
\end{proof}

\begin{lemma}
\label{lemma-finite-in-codimension-one}
Let $f : X \to Y$ be a morphism of schemes.
Let $\xi \in Y$ be a point.
Assume that
\begin{enumerate}
\item $X$, $Y$ are integral,
\item $X$ is locally Noetherian
\item $f$ is proper, dominant and $R(X) \subset R(Y)$ is finite, and
\item $\dim(\mathcal{O}_{Y, \xi}) = 1$.
\end{enumerate}
Then there exists an open neighbourhood $V \subset Y$ of $\xi$
such that $f|_{f^{-1}(V)} : f^{-1}(V) \to V$ is finite.
\end{lemma}

\begin{proof}
By
More on Morphisms,
Lemma \ref{more-morphisms-lemma-proper-finite-fibre-finite-in-neighbourhood}
it suffices to prove that $f^{-1}(\{\xi\})$ is finite.
We replace $Y$ by an affine open, say $Y = \text{Spec}(R)$.
Note that $R$ is Noetherian, as $X$ is assumed locally Noetherian.
Since $f$ is proper it is quasi-compact. Hence we can find a finite
affine open covering $X = U_1 \cup \ldots \cup U_n$ with
each $U_i = \text{Spec}(A_i)$. Note that $R \to A_i$ is a
finite type injective homomorphism of domains with
$f.f.(R) \subset f.f.(A_i)$ finite. Thus the lemma follows
from Lemma \ref{lemma-finite-in-codim-1}.
\end{proof}


\section{Principal divisors}
\label{section-principal-divisors}

\noindent
The following definition is the key to everything that follows.

\begin{definition}
\label{definition-principal-divisor}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$. Assume $X$ is
integral with $\dim_\delta(X) = n$.
Let $f \in R(X)^*$. The {\it principal divisor
associated to $f$} is the $(n - 1)$-cycle
$$
\text{div}(f) = \text{div}_X(f) = \sum \text{ord}_Z(f) [Z]
$$
where the sum is over integral closed subschemes of
codimension $1$ and $\text{ord}_Z(f)$ is as in
Definition \ref{definition-order-vanishing}. This makes sense
by Lemmas \ref{lemma-divisor-delta-dimension} and
\ref{lemma-divisor-locally-finite}.
\end{definition}


\begin{lemma}
\label{lemma-div-additive}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$. Assume $X$ is
integral with $\dim_\delta(X) = n$.
Let $f, g \in R(X)^*$.
Then
$$
\text{div}(fg) = \text{div}(f) + \text{div}(g)
$$
in $Z_{n - 1}(X)$.
\end{lemma}

\begin{proof}
This is clear from the additivity of the $\text{ord}$ functions.
\end{proof}

\noindent
An important role in the discussion of principal divisors
is played by the ``universal'' principal divisor $[0] - [\infty]$
on $\mathbf{P}^1_S$. To make this more precise, let us denote
$$
D_0, D_\infty \subset
\mathbf{P}^1_S = \underline{\text{Proj}}_S(\mathcal{O}_S[X_0, X_1])
$$
the closed subscheme cut out by the section $X_1$, resp.\ $X_0$
of $\mathcal{O}(1)$. These are effective Cartier divisors, see
Divisors, Definition \ref{divisors-definition-effective-Cartier-divisor}
and Lemma \ref{divisors-lemma-characterize-OD}.
The following lemma says that loosely speaking we have
``$\text{div}(X_1/X_0) = [D_0] - [D_1]$'' and that this is the
universal principal divisor.

\begin{lemma}
\label{lemma-rational-function}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$. Assume $X$ is
integral and $n = \dim_\delta(X)$. Let $f \in R(X)^*$.
Let $U \subset X$ be a nonempty open such that $f$
corresponds to a section $f \in \Gamma(U, \mathcal{O}_X^*)$.
Let $Y \subset X \times_S \mathbf{P}^1_S$ be the
closure of the graph of $f : U \to \mathbf{P}^1_S$.
Then
\begin{enumerate}
\item the projection morphism $p : Y \to X$ is proper,
\item $p|_{p^{-1}(U)} : p^{-1}(U) \to U$ is an isomorphism,
\item the pullbacks $q^{-1}D_0$ and $q^{-1}D_\infty$ via the morphism
$q : Y \to \mathbf{P}^1_S$ are effective Cartier divisors on $Y$,
\item we have
$$
\text{div}_Y(f) = [q^{-1}D_0]_{n - 1} - [q^{-1}D_\infty]_{n - 1}
$$
\item we have
$$
\text{div}_X(f) = p_*\text{div}_Y(f)
$$
\item if we view $Y_0 = q^{-1}D_0$, and
$Y_\infty = q^{-1}D_\infty$ as closed subschemes of $X$
via the morphism $p$ then we have
$$
\text{div}_X(f) = [Y_0]_{n - 1} - [Y_\infty]_{n - 1}
$$
\end{enumerate}
\end{lemma}

\begin{proof}
Since $X$ is integral, we see that $U$ is integral.
Hence $Y$ is integral, and $(1,f)(U) \subset Y$ is an open dense subscheme.
Also, note that the closed subscheme $Y \subset X \times_S \mathbf{P}^1_S$
does not depend on the choice of the open $U$, since after all it is
the closure of the one point set $\{\eta'\} = \{(1, f)(\eta)\}$
where $\eta \in X$ is the generic point. Having said this let us
prove the assertions of the lemma.

\medskip\noindent
For (1) note that $p$ is the composition of the closed immersion
$Y \to X \times_S \mathbf{P}^1_S = \mathbf{P}^1_X$ with the proper
morphism $\mathbf{P}^1_X \to X$. As a composition of proper morphisms
is proper (Morphisms, Lemma \ref{morphisms-lemma-composition-proper})
we conclude.

\medskip\noindent
It is clear that $Y \cap U \times_S \mathbf{P}^1_S = (1, f)(U)$.
Thus (2) follows. It also follows that $\dim_\delta(Y) = n$.

\medskip\noindent
Note that $q(\eta') = f(\eta)$ is not contained in $D_0$ or $D_\infty$
since $f \in R(X)^*$. Hence $q^{-1}D_0$ and $q^{-1}D_\infty$ are
effective Cartier divisors on $Y$ by
Divisors, Lemma \ref{divisors-lemma-pullback-effective-Cartier-defined}.
Thus we see (3). It also follows that $\dim_\delta(q^{-1}D_0) = n - 1$
and $\dim_\delta(q^{-1}D_\infty) = n - 1$.

\medskip\noindent
Consider the effective Cartier divisor $q^{-1}D_0$.
At every point $\xi \in q^{-1}D_0$ we have $f \in \mathcal{O}_{Y, \xi}$ and
the local equation for $q^{-1}D_0$ is given by $f$.
In particular, if $\delta(\xi) = n - 1$ so $\xi$ is the generic point
of a integral closed subscheme $Z$ of $\delta$-dimension $n - 1$,
then we see that the coefficient of $[Z]$ in $\text{div}_Y(f)$ is
$$
\text{ord}_Z(f) =
\text{length}_{\mathcal{O}_{Y, \xi}}
(\mathcal{O}_{Y, \xi}/f\mathcal{O}_{Y, \xi}) =
\text{length}_{\mathcal{O}_{Y, \xi}}
(\mathcal{O}_{q^{-1}D_0, \xi})
$$
which is the coefficient of $[Z]$ in $[q^{-1}D_0]_{n - 1}$. A similar
argument using the rational function $1/f$ shows that
$-[q^{-1}D_\infty]$ agrees with the terms with negative coefficients in
the expression for $\text{div}_Y(f)$. Hence (4) follows.

\medskip\noindent
Note that $D_0 \to S$ is an isomorphism. Hence we see that
$X \times_S D_0 \to X$ is an isomorphism as well. Clearly
we have $q^{-1}D_0 = Y \cap X \times_S D_0$ (scheme theoretic intersection)
inside $X \times_S \mathbf{P}^1_S$. Hence it is really the case that
$Y_0 \to X$ is a closed immersion. By the same token we see that
$$
p_*\mathcal{O}_{q^{-1}D_0} = \mathcal{O}_{Y_0}
$$
and hence by Lemma \ref{lemma-cycle-push-sheaf} we
have $p_*[q^{-1}D_0]_{n - 1} = [Y_0]_{n - 1}$. Of course the same
is true for $D_\infty$ and $Y_\infty$. Hence to finish the proof of
the lemma it suffices to prove the last assertion.

\medskip\noindent
Let $Z \subset X$ be an integral closed subscheme of $\delta$-dimension
$n - 1$. We want to show that the coefficient of $[Z]$ in $\text{div}(f)$
is the same as the coefficient of $[Z]$ in
$[Y_0]_{n - 1} - [Y_\infty]_{n - 1}$.
We may apply Lemma \ref{lemma-finite-in-codimension-one}
to the morphism $p : Y \to X$ and
the generic point $\xi \in Z$. Hence we may replace $X$ by an
affine open neighbourhood of $\xi$ and assume that $p : Y \to X$ is finite.
Write $X = \text{Spec}(R)$ and $Y = \text{Spec}(A)$ with $p$ induced
by a finite homomorphism $R \to A$ of Noetherian domains which induces
an isomorphism $f.f.(R) \cong f.f.(A)$ of fraction fields.
Now we have $f \in f.f.(R)$ and a prime $\mathfrak p \subset R$
with $\dim(R_{\mathfrak p}) = 1$. The coefficient of
$[Z]$ in $\text{div}_X(f)$ is $\text{ord}_{R_\mathfrak p}(f)$.
The coefficient of $[Z]$ in $p_*\text{div}_Y(f)$ is
$$
\sum\nolimits_{\mathfrak q\text{ lying over }\mathfrak p}
[\kappa(\mathfrak q) : \kappa(\mathfrak p)]
\text{ord}_{A_{\mathfrak q}}(f)
$$
The desired equality therefore follows from
Lemma \ref{lemma-finite-extension-dim-1}.
\end{proof}

\noindent
This lemma will be superseded by the more general
Lemma \ref{lemma-flat-pullback-rational-equivalence}.

\begin{lemma}
\label{lemma-flat-pullback-principal-divisor}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$. Assume $X$, $Y$
are integral and $n = \dim_\delta(Y)$.
Let $f : X \to Y$ be a flat morphism of relative dimension $r$.
Let $g \in R(Y)^*$. Then
$$
f^*(\text{div}_Y(g)) = \text{div}_X(g)
$$
in $Z_{n + r - 1}(X)$.
\end{lemma}

\begin{proof}
Note that since $f$ is flat it is dominant so that
$f$ induces an embedding $R(Y) \subset R(X)$, and hence
we may think of $g$ as an element of $R(X)^*$.
Let $Z \subset X$ be an integral closed subscheme of
$\delta$-dimension $n + r - 1$. Let $\xi \in Z$
be its generic point. If $\dim_\delta(f(Z)) > n - 1$,
then we see that the coefficient of $[Z]$ in the left and
right hand side of the equation is zero.
Hence we may assume that $Z' = \overline{f(Z)}$ is an
intral closed subscheme of $Y$ of $\delta$-dimension $n - 1$.
Let $\xi' = f(\xi)$. It is the generic point of $Z'$.
Set $A = \mathcal{O}_{Y, \xi'}$, $B = \mathcal{O}_{X, \xi}$.
The ring map $A \to B$ is a flat local homomorphism of
Noetherian local domains of dimension $1$.
We have $g \in f.f.(A)$. What we have to show is that
$$
\text{ord}_A(g) \text{length}_B(B/\mathfrak m_AB)
=
\text{ord}_B(g).
$$
This follows from Lemma \ref{lemma-pullback-module}
(details omitted).
\end{proof}











\section{Two fun results on principal divisors}
\label{section-two-fun}

\noindent
The first lemma implies that the pushforward of a principal
divisor along a generically finite morphism is a principal divisor.

\begin{lemma}
\label{lemma-proper-pushforward-alteration}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$. Assume $X$, $Y$
are integral and $n = \dim_\delta(X) = \dim_\delta(Y)$.
Let $p : X \to Y$ be a dominant proper morphism.
Let $f \in R(X)^*$. Set
$$
g = \text{Nm}_{R(X)/R(Y)}(f).
$$
Then we have
$p_*\text{div}(f) = \text{div}(g)$.
\end{lemma}

\begin{proof}
Let $Z \subset Y$ be an integral closed subscheme of $\delta$-dimension
$n - 1$. We want to show that the coefficient of $[Z]$ in
$p_*\text{div}(f)$ and $\text{div}(g)$ are equal. We may apply
Lemma \ref{lemma-finite-in-codimension-one}
to the morphism $p : X \to X$ and the generic point $\xi \in Z$.
Hence we may replace $X$ by an
affine open neighbourhood of $\xi$ and assume that $p : Y \to X$ is finite.
Write $X = \text{Spec}(R)$ and $Y = \text{Spec}(A)$ with $p$ induced
by a finite homomorphism $R \to A$ of Noetherian domains which induces
an finite field extension $f.f.(R) \subset f.f.(A)$ of fraction fields.
Now we have $f \in f.f.(A)$, $g = \text{Nm}(f) \in f.f.(R)$,
and a prime $\mathfrak p \subset R$ with $\dim(R_{\mathfrak p}) = 1$.
The coefficient of $[Z]$ in $\text{div}_Y(g)$ is
$\text{ord}_{R_\mathfrak p}(g)$.
The coefficient of $[Z]$ in $p_*\text{div}_X(f)$ is
$$
\sum\nolimits_{\mathfrak q\text{ lying over }\mathfrak p}
[\kappa(\mathfrak q) : \kappa(\mathfrak p)]
\text{ord}_{A_{\mathfrak q}}(f)
$$
The desired equality therefore follows from
Lemma \ref{lemma-finite-extension-dim-1}.
\end{proof}

\noindent
The following lemma says that the degree of a principal divisor on
a proper curve is zero.

\begin{lemma}
\label{lemma-curve-principal-divisor}
Let $K$ be any field. Let $X$ be a $1$-dimensional integral scheme
endowed with a proper morphism $c : X \to \text{Spec}(K)$.
Let $f \in K(X)^*$ be an invertible rational function.
Then
$$
\sum\nolimits_{x \in X \text{ closed}}
[\kappa(x) : K] \text{ord}_{\mathcal{O}_{X, x}}(f)
=
0
$$
where $\text{ord}$ is as in Definition \ref{definition-ord}.
In other words, $c_*\text{div}(f) = 0$.
\end{lemma}

\begin{proof}
Consider the diagram
$$
\xymatrix{
Y \ar[r]_p \ar[d]_q & X \ar[d]^c \\
\mathbf{P}^1_K \ar[r]^-{c'} & \text{Spec}(K)
}
$$
that we constructed in Lemma \ref{lemma-rational-function}
starting with $X$ and the rational function $f$ over $S = \text{Spec}(K)$.
We will use all the results of this lemma without further mention.
We have to show that $c_*\text{div}_X(f) = p_*c_*\text{div}_Y(f) = 0$.
This is the same as proving that $c'_*q_*\text{div}_Y(f) = 0$.
If $q(Y)$ is a closed point of $\mathbf{P}^1_K$ then we
see that $\text{div}_X(f) = 0$ and the lemma holds.
Thus we may assume that $q$ is dominant.
Since $\text{div}_Y(f) = [q^{-1}D_0]_0 - [q^{-1}D_\infty]_0$
we see (by definition of flat pullback) that
$\text{div}_Y(f) = q^*([D_0]_0 - [D_\infty]_0)$.
Suppose we can show that $q : Y \to \mathbf{P}^1_K$ is finite
locally free of degree $d$ (see
Morphisms, Definition \ref{morphisms-definition-finite-locally-free}).
Then byy Lemma \ref{lemma-finite-flat} we get
$q_*\text{div}_Y(f) = d([D_0]_0 - [D_\infty]_0)$.
Since clearly $c'_*[D_0]_0 = c'_*[D_\infty]_0$ we win.

\medskip\noindent
It remains to show that $q$ is finite locally free.
(It will automatically have some given degree as $\mathbf{P}^1_K$
is connected.)
Since $\dim(\mathbf{P}^1_K) = 1$ we see that $q$ is finite for example
by Lemma \ref{lemma-finite-in-codimension-one}.
All local rings of $\mathbf{P}^1_K$ at
closed points are regular local rings of dimension $1$
(in other words discrete valuation rings), since they are
localizations of $K[T]$ (see
Algebra, Lemma \ref{algebra-lemma-dim-affine-space}).
Hence for $y\in Y$ closed the local ring $\mathcal{O}_{Y, y}$
will be flat over $\mathcal{O}_{\mathbf{P}^1_K, q(y)}$ as soon as
it is torsion free. This is obviously the case as
$\mathcal{O}_{Y, y}$ is a domain and $q$ is dominant.
Thus $q$ is flat. Hence $q$ is finite locally free by
Morphisms, Lemma \ref{morphisms-lemma-finite-flat}.
\end{proof}





\section{Rational equivalence}
\label{section-rational-equivalence}

\noindent
In this section we define {\it rational equivalence} on $k$-cycles.
We will allow locally finite sums of images of
principal divisors (under closed immersions). This leads to some
pretty strange phenomena, see Example \ref{example-weird}.
However, if we do not allow these then we do not know how to prove that
capping with chern classes of line bundles factors through rational
equivalence.

\begin{definition}
\label{definition-rational-equivalence}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
Let $k \in \mathbf{Z}$.
\begin{enumerate}
\item Given any locally finite collection $\{W_j \subset X\}$
of integral closed subschemes with $\dim_\delta(W_j) = k + 1$,
and any $f_j \in R(W_j)^*$ we may consider
$$
\sum (i_j)_*\text{div}(f_j) \in Z_k(X)
$$
where $i_j : W_j \to X$ is the inclusion morphism.
This makes sense as the morphism
$\coprod i_j : \coprod W_j \to X$ is proper.
\item We say that $\alpha \in Z_k(X)$ is {\it rationally equivalent to zero}
if $\alpha$ is a cycle of the form displayed above.
\item We say $\alpha, \beta \in Z_k(X)$ are
{\it rationally equivalent} and we write $\alpha \sim_{rat} \beta$
if $\alpha - \beta$ is rationally equivalent to zero.
\item We define
$$
A_k(X) = Z_k(X) / \sim_{rat}
$$
to be the {\it Chow group of $k$-cycles on $X$}. This is sometimes called
the {\it Chow group of $k$-cycles module rational equivalence on $X$}.
\end{enumerate}
\end{definition}

\noindent
There are many other interesting (adequate) equivalence relations.
Rational equivalence is the coarsest one of them all.
A very simple but important lemma is the following.

\begin{lemma}
\label{lemma-restrict-to-open}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
Let $U \subset X$ be an open subscheme, and denote
$i : Y = X \setminus U \to X$ as a reduced closed subscheme of $X$.
Let $k \in \mathbf{Z}$.
Suppose $\alpha, \beta \in Z_k(X)$.
If $\alpha|_U \sim_{rat} \beta|_U$ then there exist a cycle
$\gamma \in Z_k(Y)$ such that
$$
\alpha \sim_{rat} \beta + i_*\gamma.
$$
In other words, the sequence
$$
\xymatrix{
A_k(Y) \ar[r]^{i_*} & A_k(X) \ar[r]^{j_*} & A_k(U) \ar[r] & 0
}
$$
is an exact complex of abelian groups.
\end{lemma}

\begin{proof}
Let $\{W_j\}_{j \in J}$ be a locally finite collection of integral closed
subschemes of $\delta$-dimension $k + 1$, and let $f_j \in R(W_j)^*$
be elements such that $(\alpha - \beta)|_U = \sum (i_j)_*\text{div}(f_j)$
as in the definition. Set $W_j' \subset X$ equal
to the closure of $W_j$. Suppose that $V \subset X$ is a quasi-compact
open. Then also $V \cap U$ is quasi-compact open in $U$ as
$V$ is Noetherian. Hence the set
$\{j \in J \mid W_j \cap V \not = \emptyset\}
= \{j \in J \mid W'_j \cap V \not = \emptyset\}$
is finite since $\{W_j\}$ is locally finite. In other words we see that
$\{W'_j\}$ is also locally finite. Since $R(W_j) = R(W'_j)$ we see
that
$$
\alpha - \beta - \sum (i'_j)_*\text{div}(f_j)
$$
is a cycle supported on $Y$ and the lemma follows (see
Lemma \ref{lemma-exact-sequence-open}).
\end{proof}

\begin{example}
\label{example-weird}
Here is a ``strange'' example.
Suppose that $S$ is the spectrum of a field $k$
with $\delta$ as in Example \ref{example-field}.
Suppose that $X = C_1 \cup C_2 \cup \ldots$ is an infinite
union of curves $C_j \cong \mathbf{P}^1_k$ glued together
in the following way: The point $\infty \in C_j$ is glued
transversally to the point $0 \in C_{j + 1}$ for $j = 1, 2, 3, \ldots$.
Take the point $0 \in C_1$. This gives a zero cycle
$[0] \in Z_0(X)$. The ``strangeness'' in this situation is
that actually $[0] \sim_{rat} 0$! Namely we can choose
the rational function $f_j \in R(C_j)$ to be the function
which has a simple zero at $0$ and a simple pole at $\infty$
and no other zeros or poles. Then we see that the sum
$\sum (i_j)_*\text{div}(f_j)$ is exactly the $0$-cycle
$[0]$. In fact it turns out that $A_0(X) = 0$ in this example.
If you find this too bizarre, then you can just
make sure your spaces are always quasi-compact
(so $X$ does not even exist for you).
\end{example}









\section{Properties of rational equivalence}
\label{section-properties-rational-equivalence}

\begin{lemma}
\label{lemma-flat-pullback-rational-equivalence}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$, $Y$ be schemes locally of finite type over $S$.
Let $f : X \to Y$ be a flat morphism of relative dimension $r$.
Let $\alpha \sim_{rat} \beta$ be rationally equivalent $k$-cycles on $Y$.
Then $f^*\alpha \sim_{rat} f^*\beta$ as $(k + r)$-cycles on $X$.
\end{lemma}

\begin{proof}
What do we have to show? Well, suppose we are given a collection
$$
i_j : W_j \longrightarrow Y
$$
of closed immersions, with each $W_j$ integral of $\delta$-dimension $k + 1$
and rational functions $f_j \in R(W_j)^*$.
Moreover, assume that
the collection $\{i_j(W_j)\}_{j \in J}$ is locally finite on $Y$.
Then we have to show that
$$
f^*(\sum i_{j, *}\text{div}(f_j))
$$
is rationally equivalent to zero on $X$.

\medskip\noindent
Consider the fibre products
$$
i'_j : 
W'_j = W_j \times_Y X
\longrightarrow
X.
$$
For each $j$, consider the collection $\{W'_{j, l}\}_{l \in L_j}$
of irreducible components $W'_{j, l} \subset W'_j$ having $\delta$-dimension
$k + 1$. We may write
$$
[W'_j]_{k + 1} = \sum\nolimits_{l \in L_j} n_{j, l}[W'_{j, l}]_{k + 1}
$$
for some $n_{j, l} > 0$.
By Lemma \ref{lemma-flat-inverse-image-dimension}
we see that $W'_{j, l} \to W_j$ is
dominant and hence we can let $f_{j, l} \in R(W'_{j, l})^*$ denote the
image of $f_j$ under the map of fields $R(W_j) \to R(W'_{j, l})$.
We claim that
\begin{enumerate}
\item the collection $\{W'_{j, l}\}_{j \in J, l \in L_j}$ is
locally finite on $X$, and
\item with obvious notation
$f^*(\sum i_{j, *}\text{div}(f_j))
=
\sum i'_{j, l, *} \text{div}(f_{j, l}^{n_{j, l}})$.
\end{enumerate}
Clearly this claim implies the lemma.

\medskip\noindent
To show (1), note that $\{W'_j\}$ is a locally finite collection
of closed subschemes of $X$ by Lemma \ref{lemma-inverse-image-locally-finite}.
Hence if $U \subset X$ is quasi-compact, then $U$ meets only finitely
many $W'_j$. By Lemma \ref{lemma-multiplicity-finite} the collection of
irreducible components of each $W_j$ is locally finite as well. Hence
we see only finitely many $W'_{j, l}$ meet $U$ as desired.

\medskip\noindent
Let $Z \subset X$ be an integral closed subscheme of $\delta$-dimension
$k + r$. We have to show that the coefficient $n$ of $[Z]$ in
$f^*(\sum i_{j, *}\text{div}(f_j))$ is equal to the coefficient
$m$ of $[Z]$ in $\sum i'_{j, l, *} \text{div}(f_{j, l}^{n_{j, l}})$.
Let $Z'$ be the closure of $f(Z)$ which is an integral closed
subscheme of $Y$. By Lemma \ref{lemma-flat-inverse-image-dimension}
we have $\dim_\delta(Z') \geq k$.
If $\dim_\delta(Z') > k$, then the coefficients $n$ and $m$ are
both zero, since the generic point of $Z$ will not be contained
in any $W'_j$ or $W'_{j, l}$. Hence we may assume that $\dim_\delta(Z') = k$.

\medskip\noindent
We are going to translate the equality of $n$ and $m$ into algebra.
Namely, let $\xi' \in Z'$ and $\xi \in Z$ be the generic points.
Set $A = \mathcal{O}_{Y, \xi'}$ and $B = \mathcal{O}_{X, \xi}$.
Note that $A$, $B$ are Noetherian, $A \to B$ is flat, local,
and that $\mathfrak m_AB$ is an ideal of definition of the local ring $B$.
There are finitely many $j$ such that $W_j$ passes through
$\xi'$, and these correspond to prime ideals
$$
\mathfrak p_1, \ldots, \mathfrak p_T \subset A
$$
with the property that $\dim(A/\mathfrak p_t) = 1$ for each
$t = 1, \ldots, T$. The rational functions $f_j$ correspond
to elements $f_t \in \kappa(\mathfrak p_t)^*$.
Say $\mathfrak p_t$ corresponds to $W_j$.
By construction, the closed subschemes $W'_{j, l}$ which meet
$\xi$ correspond $1 - 1$ with minimal primes
$$
\mathfrak p_tB
\subset
\mathfrak q_{t, 1}, \ldots, \mathfrak q_{t, S_t}
\subset
B
$$
over $\mathfrak p_tB$.
The integers $n_{j, l}$ correspond to the integers
$$
n_{t, s} = \text{length}_{B_{\mathfrak q_{t, s}}}
((B/\mathfrak p_tB)_{B_{\mathfrak q_{t, s}}})
$$
The rational functions $f_{j, l}$ correspond to the images
$f_{t, s} \in \kappa(\mathfrak q_{t, s})^*$ of the elements
$f_t \in \kappa(\mathfrak p_t)^*$. Putting everything together
we see that
$$
n = \sum \text{ord}_{A/\mathfrak p_t}(f_t)\text{length}_B(B/\mathfrak m_AB)
$$
and that
$$
m = \sum \text{ord}_{B/\mathfrak q_{t, s}}(f_{t, s})
\text{length}_{B_{\mathfrak q_{t, s}}}
((B/\mathfrak p_tB)_{B_{\mathfrak q_{t, s}}})
$$
Note that it suffices to prove the equality for each
$t \in \{1, \ldots, T\}$ separately. Writing $f_t = x/y$
for some nonzero $\overline{x}, \overline{y} \in A/\mathfrak p_t$
coming from $x, y\in A$ we see that it suffices
to prove
$$
\text{length}_{A/\mathfrak p_t}(A/(\mathfrak p_t, x))
\text{length}_B(B/\mathfrak m_AB)
=
\text{length}_B(B/(x, \mathfrak p_t)B)
$$
(equality uses Lemma \ref{lemma-pullback-module})
equals
$$
\sum\nolimits_{s = 1, \ldots, S_t}
\text{ord}_{B/\mathfrak q_{t, s}}(B/(x, \mathfrak q_{t, s}))
\text{length}_{B_{\mathfrak q_{t, s}}}
((B/\mathfrak p_tB)_{B_{\mathfrak q_{t, s}}})
$$
and similarly for $y$. Note that as $x \not \in \mathfrak p_t$ we
see that $x$ is a nonzero divisor on $A/\mathfrak p_t$. As $A \to B$
is flat it follows that $x$ is a nonzero divisor on the module
$M = B/\mathfrak p_tB$. Hence the equality above follows from
Lemma \ref{lemma-additivity-divisors-restricted}.
\end{proof}

\begin{lemma}
\label{lemma-proper-pushforward-rational-equivalence}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$, $Y$ be schemes locally of finite type over $S$.
Let $p : X \to Y$ be a proper morphism.
Suppose $\alpha, \beta \in Z_k(X)$ are rationally equivalent.
Then $p_*\alpha$ is rationally equivalent to $p_*\beta$.
\end{lemma}

\begin{proof}
What do we have to show? Well, suppose we are given a collection
$$
i_j : W_j \longrightarrow X
$$
of closed immersions, with each $W_j$ integral of $\delta$-dimension $k + 1$
and rational functions $f_j \in R(W_j)^*$.
Moreover, assume that
the collection $\{i_j(W_j)\}_{j \in J}$ is locally finite on $X$.
Then we have to show that
$$
p_*\left(\sum i_{j, *}\text{div}(f_j)\right)
$$
is rationally equivalent to zero on $X$.

\medskip\noindent
Note that the sum is equal to
$$
\sum p_*i_{j, *}\text{div}(f_j).
$$
Let $W'_j \subset Y$ be the integral closed subscheme which is the
image of $p \circ i_j$. The collection $\{W'_j\}$ is locally finite
in $Y$ by Lemma \ref{lemma-quasi-compact-locally-finite}.
Hence it suffices to show, for a given $j$, that either
$p_*i_{j, *}\text{div}(f_j) = 0$ or that it
is equal to $i'_{j, *}\text{div}(g_j)$ for some $g_j \in R(W'_j)^*$.

\medskip\noindent
The arguments above therefore reduce us to the case of a since
integral closed subscheme $W \subset X$ of $\delta$-dimension $k + 1$.
Let $f \in R(W)^*$. Let $W' = p(W)$ as above.
We get a commutative diagram of morphisms
$$
\xymatrix{
W \ar[r]_i \ar[d]_{p'} & X \ar[d]^p \\
W' \ar[r]^{i'} & Y
}
$$
Note that $p_*i_*\text{div}(f) = i'_*(p')_*\text{div}(f)$ by
Lemma \ref{lemma-compose-pushforward}. As explained above
we have to show that $(p')_*\text{div}(f)$
is the divisor of a rational function on $W'$ or zero.
There are three cases to distinguish.

\medskip\noindent
The case $\dim_\delta(W') < k$. In this case automatically
$(p')_*\text{div}(f) = 0$ and there is nothing to prove.

\medskip\noindent
The case $\dim_\delta(W') = k$. Let us show that $(p')_*\text{div}(f) = 0$
in this case. Let $\eta \in W'$ be the generic point.
Note that $c : W_\eta \to \text{Spec}(K)$
is a proper integral curve over $K = \kappa(\eta)$
whose function field $K(W_\eta)$ is identified with $R(W)$.
Here is a diagram
$$
\xymatrix{
W_\eta \ar[r] \ar[d]_c & W \ar[d]^p \\
\text{Spec}(K) \ar[r] & W'
}
$$
Let us denote $f_\eta \in K(W_\eta)^*$ the rational function
corresponding to $f \in R(W)^*$.
Moreover, the closed points $\xi$ of $W_\eta$ correspond $1 - 1$ to the
closed integral subschemes $Z = Z_\xi \subset W$ of $\delta$-dimension $k$
with $f(Z) = W'$. Note that the multiplicity
of $Z_\xi$ in $\text{div}(f)$ is equal to
$\text{ord}_{\mathcal{O}_{W_\eta, \xi}}(f_\eta)$ simply because the
local rings $\mathcal{O}_{W_\eta, \xi}$ and $\mathcal{O}_{W, \xi}$
are identified (as subrings of their fraction fields).
Hence we see that the multiplicity of $[W']$ in
$(p')_*\text{div}(f)$ is equal to the multiplicity of
$[\text{Spec}(K)]$ in $c_*\text{div}(f_\eta)$.
By Lemma \ref{lemma-curve-principal-divisor} this is zero.

\medskip\noindent
The case $\dim_\delta(W') = k + 1$. In this case
Lemma \ref{lemma-proper-pushforward-alteration} applies,
and we see that indeed $p'_*\text{div}(f) = \text{div}(g)$
for some $g \in R(W')^*$ as desired.
\end{proof}















\section{Different characterizations of rational equivalence}
\label{section-different-rational-equivalence}

\noindent
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
Given any closed subscheme
$Z \subset X \times_S \mathbf{P}^1_S = X \times \mathbf{P}^1$
we let $Z_0$, resp.\ $Z_\infty$ be the scheme theoretic closed 
subscheme $Z_0 = \text{pr}_2^{-1}(D_0)$,
resp.\ $Z_\infty = \text{pr}_2^{-1}(D_\infty)$.
Here $D_0$, $D_\infty$ are as defined just above
Lemma \ref{lemma-rational-function}.

\begin{lemma}
\label{lemma-rational-equivalence-family}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
Let $W \subset X \times_S \mathbf{P}^1_S$ be an integral
closed subscheme of $\delta$-dimension $k + 1$.
Assume $W \not = W_0$, and $W \not = W_\infty$. Then
\begin{enumerate}
\item $W_0$, $W_\infty$ are effective Cartier divisors of $W$,
\item $W_0$, $W_\infty$ can be viewed as closed subschemes
of $X$ and
$$
[W_0]_k \sim_{rat} [W_\infty]_k,
$$
\item for any locally finite family of
integral closed subschemes
$W_i \subset X \times_S \mathbf{P}^1_S$
of $\delta$-dimension $k + 1$ with $W_i \not = (W_i)_0$ and
$W_i \not = (W_i)_\infty$ we have
$\sum ([(W_i)_0]_k - [(W_i)_\infty]_k) \sim_{rat} 0$
on $X$, and
\item for any $\alpha \in Z_k(X)$ with $\alpha \sim_{rat} 0$
there exists a locally finite family of
integral closed subschemes $W_i \subset X \times_S \mathbf{P}^1_S$
as above such that $\alpha = \sum ([(W_i)_0]_k - [(W_i)_\infty]_k)$.
\end{enumerate}
\end{lemma}

\begin{proof}
Part (1) follows from
Divisors, Lemma \ref{divisors-lemma-pullback-effective-Cartier-defined}
since the generic point
of $W$ is not mapped into $D_0$ or $D_\infty$ under the projection
$X \times_S \mathbf{P}^1_S \to \mathbf{P}^1_S$ by assumtion.

\medskip\noindent
Since $X \times_S D_0 \to X$ is an isomorphism we see that $W_0$
is isomorphic to a closed subscheme of $X$. Similarly for $W_\infty$.
Consider the morphism $p : W \to X$. It is proper and on $W$ we have
$[W_0]_k \sim_{rat} [W_\infty]_k$. Hence part (2) follows from
Lemma \ref{lemma-proper-pushforward-rational-equivalence} as clearly
$p_*[W_0]_k = [W_0]_k$ and similarly for $W_\infty$.

\medskip\noindent
The only content of statement (3) is, given parts (1) and (2), that
the collection $\{(W_i)_0, (W_i)_\infty\}$ is a locally finite collection
of closed subschemes of $X$. This is clear.

\medskip\noindent
Suppose that $\alpha \sim_{rat} 0$.
By definition this means there exist integral closed subschemes
$V_i \subset X$ of $\delta$-dimension $k + 1$ and rational
functions $f_i \in R(V_i)^*$ such that the family
$\{V_i\}_{i \in I}$ is locally finite in $X$ and such that
$\alpha = \sum (V_i \to X)_*\text{div}(f_i)$.
Let
$$
W_i \subset V_i \times_S \mathbf{P}^1_S \subset X \times_S \mathbf{P}^1_S
$$
be the closure of the graph of the rational map $f_i$ as in
Lemma \ref{lemma-rational-function}.
Then we have that $(V_i \to X)_*\text{div}(f_i)$
is equal to $[(W_i)_0]_k - [(W_i)_\infty]_k$ by that same lemma.
Hence the result is clear.
\end{proof}

\begin{lemma}
\label{lemma-closed-subscheme-cross-p1}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
Let $Z$ be a closed subscheme of $X \times \mathbf{P}^1$.
Assume $\dim_\delta(Z) \leq k + 1$, $\dim_\delta(Z_0) \leq k$,
$\dim_\delta(Z_\infty) \leq k$ and assume
any embedded point $\xi$ (insert future reference here)
of $Z$ has $\delta(\xi) < k$. Then
$$
[Z_0]_k \sim_{rat} [Z_\infty]_k
$$
as $k$-cycles on $X$.
\end{lemma}

\begin{proof}
Let $\{W_i\}_{i \in I}$ be the collection of irreducible
components of $Z$ which have $\delta$-dimension $k + 1$.
Write
$$
[Z]_{k + 1} = \sum n_i[W_i]
$$
with $n_i > 0$ as per definition. Note that $\{W_i\}$
is a locally finite collection of closed subsets of
$X \times_S \mathbf{P}^1_S$ by Lemma \ref{lemma-multiplicity-finite}.
We claim that
$$
[Z_0]_k = \sum n_i[(W_i)_0]_k
$$
and similarly for $[Z_\infty]_k$. If we prove this then the lemma
follows from Lemma \ref{lemma-rational-equivalence-family}.

\medskip\noindent
Let $Z' \subset X$ be an integral closed subscheme of $\delta$-dimension $k$.
To prove the equality above it suffices to show that the coefficient $n$
of $[Z']$ in $[Z_0]_k$ is the same as the coefficient $m$ of
$[Z']$ in $\sum n_i[(W_i)_0]_k$. Let $\xi' \in Z'$ be the generic point.
Set $\xi = (\xi', 0) \in  X \times_S \mathbf{P}^1_S$.
Consider the local ring $A = \mathcal{O}_{X \times_S \mathbf{P}^1_S, \xi}$.
Let $I \subset A$ be the ideal cutting out $Z$, in other words so that
$A/I = \mathcal{O}_{Z, \xi}$. Let $t \in A$ be the element cutting
out $X \times_S D_0$ (i.e., the coordinate of $\mathbf{P}^1$ at zero
pulled back). By our choice of $\xi' \in Z'$ we have $\delta(\xi) = k$
and hence $\dim(A/I) = 1$. Since $\xi$ is not an embedded point by
definition we see that $A/I$ is Cohen-Macaulay. Since $\dim_\delta(Z_0)
= k$ we see that $\dim(A/(t, I)) = 0$ which implies that $t$
is a nonzero divisor on $A/I$. Finally, the irreducible closed subschemes
$W_i$ passing through $\xi$ correspond to the minimal primes
$I \subset \mathfrak q_i$ over $I$. The multiplicities $n_i$ correspond
to the lengths $\text{length}_{A_{\mathfrak q_i}}(A/I)_{\mathfrak q_i}$.
Hence we see that
$$
n = \text{length}_A(A/(t, I))
$$
and
$$
m = \sum
\text{length}_A(A/(t, \mathfrak q_i)) 
\text{length}_{A_{\mathfrak q_i}}(A/I)_{\mathfrak q_i}
$$
Thus the result follows from
Lemma \ref{lemma-additivity-divisors-restricted}.
\end{proof}

\begin{lemma}
\label{lemma-coherent-sheaf-cross-p1}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
Let $\mathcal{F}$ be a coherent sheaf on $X \times \mathbf{P}^1$.
Let $i_0, i_\infty : X \to X \times \mathbf{P}^1$ be the closed immersion
such that $i_t(x) = (x, t)$. Denote $\mathcal{F}_0 = i_0^*\mathcal{F}$ and
$\mathcal{F}_\infty = i_\infty^*\mathcal{F}$.
Assume
\begin{enumerate}
\item $\dim_\delta(\text{Supp}(\mathcal{F})) \leq k + 1$,
\item $\dim_\delta(\text{Supp}(\mathcal{F}_0)) \leq k$,
$\dim_\delta(\text{Supp}(\mathcal{F}_\infty)) \leq k$, and
\item any nonmaximal associated point
(insert future reference here) $\xi \in \text{Supp}(\mathcal{F})$
of $\mathcal{F}$ has $\delta(\xi) < k$.
\end{enumerate}
Then
$$
[\mathcal{F}_0]_k \sim_{rat} [\mathcal{F}_\infty]_k
$$
as $k$-cycles on $X$.
\end{lemma}

\begin{proof}
Let $\{W_i\}_{i \in I}$ be the collection of irreducible
components of $\text{Supp}(\mathcal{F})$
which have $\delta$-dimension $k + 1$.
Write
$$
[\mathcal{F}]_{k + 1} = \sum n_i[W_i]
$$
with $n_i > 0$ as per definition. Note that $\{W_i\}$
is a locally finite collection of closed subsets of
$X \times_S \mathbf{P}^1_S$ by Lemma \ref{lemma-length-finite}.
We claim that
$$
[\mathcal{F}_0]_k = \sum n_i[(W_i)_0]_k
$$
and similarly for $[\mathcal{F}_\infty]_k$. If we prove this then the lemma
follows from Lemma \ref{lemma-rational-equivalence-family}.

\medskip\noindent
Let $Z' \subset X$ be an integral closed subscheme of $\delta$-dimension $k$.
To prove the equality above it suffices to show that the coefficient $n$
of $[Z']$ in $[\mathcal{F}_0]_k$ is the same as the coefficient $m$ of
$[Z']$ in $\sum n_i[(W_i)_0]_k$. Let $\xi' \in Z'$ be the generic point.
Set $\xi = (\xi', 0) \in  X \times_S \mathbf{P}^1_S$.
Consider the local ring $A = \mathcal{O}_{X \times_S \mathbf{P}^1_S, \xi}$.
Let $M = \mathcal{F}_\xi$ as an $A$-module.
Let $t \in A$ be the element cutting out $X \times_S D_0$
(i.e., the coordinate of $\mathbf{P}^1$ at zero pulled back).
By our choice of $\xi' \in Z'$ we have $\delta(\xi) = k$
and hence $\dim(M) = 1$. Since $\xi$ is not an associated point
of $\mathcal{F}$ by definition we see that $M$ is Cohen-Macaulay module.
Since $\dim_\delta(\text{Supp}(\mathcal{F}_0)) = k$
we see that $\dim(M/tM) = 0$ which implies that $t$
is a nonzero divisor on $M$. Finally, the irreducible closed subschemes
$W_i$ passing through $\xi$ correspond to the minimal primes
$\mathfrak q_i$ of $\text{Ass}(M)$. The multiplicities $n_i$ correspond
to the lengths $\text{length}_{A_{\mathfrak q_i}}M_{\mathfrak q_i}$.
Hence we see that
$$
n = \text{length}_A(M/tM)
$$
and
$$
m = \sum
\text{length}_A(A/(t, \mathfrak q_i)A) 
\text{length}_{A_{\mathfrak q_i}}M_{\mathfrak q_i}
$$
Thus the result follows from
Lemma \ref{lemma-additivity-divisors-restricted}.
\end{proof}





\section{Rational equivalence and K-groups}
\label{section-rational-equivalence-K-groups}

\noindent
In this section we compare the cycle groups $Z_k(X)$ and
the Chow groups $A_k(X)$ with certain $K_0$-groups of
abelian categories of coherent sheaves on $X$. We avoid having
to talk about $K_1(\mathcal{A})$ for an abelian category
$\mathcal{A}$ by dint of
Homology, Lemma \ref{homology-lemma-serre-subcategory-K-groups}.
In particular, the motivation for the precise form of
Lemma \ref{lemma-maps-between-coherent-sheaves} is that lemma.

\medskip\noindent
Let us introduce the following notation.
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
We denote $\text{Coh}(X) = \text{Coh}(\mathcal{O}_X)$
the category of coherent sheaves on $X$.
It is an abelian category, see
Coherent, Lemma \ref{coherent-lemma-coherent-abelian-Noetherian}.
For any $k \in \mathbf{Z}$ we let $\text{Coh}_{\leq k}(X)$
be the full subcategory of $\text{Coh}(X)$
consisting of those coherent sheaves $\mathcal{F}$
having $\dim_\delta(\text{Supp}(\mathcal{F})) \leq k$.

\begin{lemma}
\label{lemma-Serre-subcategories}
Let us introduce the following notation.
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
The categories $\text{Coh}_{\leq k}(X)$ are Serre subcategories
of the abelian category $\text{Coh}(X)$.
\end{lemma}

\begin{proof}
Omitted. The definition of a Serre subcateory is
Homology, Definition \ref{homology-definition-serre-subcategory}.
\end{proof}

\begin{lemma}
\label{lemma-cycles-k-group}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
There are maps
$$
Z_k(X)
\longrightarrow
K_0(\text{Coh}_{\leq k}(X)/\text{Coh}_{\leq k - 1}(X))
\longrightarrow
Z_k(X)
$$
whose composition is the identity. The first is the map
$$
\sum n_Z[Z] \mapsto
\left[\bigoplus\nolimits_{n_Z > 0} \mathcal{O}_Z^{\oplus n_Z}\right]
-
\left[\bigoplus\nolimits_{n_Z < 0} \mathcal{O}_Z^{\oplus -n_Z}\right]
$$
and the second comes from the map $\mathcal{F} \mapsto [\mathcal{F}]_k$.
If $X$ is quasi-compact, then both maps are isomorphisms.
\end{lemma}

\begin{proof}
Note that the direct sum
$\bigoplus\nolimits_{n_Z > 0} \mathcal{O}_Z^{\oplus n_Z}$
is indeed a coherent sheaf on $X$ since the family $\{Z \mid n_Z > 0\}$
is locally finite on $X$.
The map $\mathcal{F} \to [\mathcal{F}]_k$ is additive
on $\text{Coh}_{\leq k}(X)$, see
Lemma \ref{lemma-additivity-sheaf-cycle}. And $[\mathcal{F}]_k = 0$
if $\mathcal{F} \in \text{Coh}_{\leq k - 1}(X)$.
This implies we have the left map as shown in the lemma.
It is clear that their composition is the identity.

\medskip\noindent
In case $X$ is quasi-compact we will show that the right arrow
is injective.
Suppose that $q \in K_0(\text{Coh}_{\leq k}(X)/\text{Coh}_{\leq k + 1}(X))$
maps to zero in $Z_k(X)$. By
Homology, Lemma \ref{homology-lemma-serre-subcategory-K-groups}
we can find
a $\tilde q \in K_0(\text{Coh}_{\leq k}(X))$ mapping to $q$.
Write $\tilde q = [\mathcal{F}] - [\mathcal{G}]$ for some
$\mathcal{F}, \mathcal{G} \in K_0(\text{Coh}_{\leq k}(X))$.
Since $X$ is quasi-compact we may apply
Coherent, Lemma \ref{coherent-lemma-coherent-filter}.
This shows that there exist integral closed subschemes
$Z_j, T_i \subset X$ and (nonzero) ideal sheaves
$\mathcal{I}_j \subset \mathcal{O}_{Z_j}$,
$\mathcal{I}_i \subset \mathcal{O}_{T_i}$ such that
$\mathcal{F}$, resp.\ $\mathcal{G}$ have filtrations whose succesive
quotients are the sheaves $\mathcal{I}_j$, resp.\ $\mathcal{I}_i$.
In particular we see that $\dim_\delta(Z_j), \dim_\delta(T_i) \leq k$.
In other words we have
$$
[\mathcal{F}] = \sum\nolimits_j [\mathcal{I}_j],
\quad
[\mathcal{G}] = \sum\nolimits_i [\mathcal{I}_i],
$$
in $K_0(\text{Coh}_{\leq k}(X))$. Our assumption is that
$\sum_j [\mathcal{I}_j]_k - \sum_i [\mathcal{I}_i]_k = 0$.
It is clear that we may throw out the indices $j$, resp.\ $i$
such that $\dim_\delta(Z_j) < k$, resp.\ $\dim_\delta(T_i) < k$,
since the corresponding sheaves are in $\text{Coh}_{k - 1}(X)$ and
also do not contribute to the cycle. Moreover, the exact sequences
$0 \to \mathcal{I}_j \to \mathcal{O}_{Z_j} \to
\mathcal{O}_{Z_j}/\mathcal{I}_j \to 0$
and
$0 \to \mathcal{I}_i \to \mathcal{O}_{T_i} \to
\mathcal{O}_{Z_i}/\mathcal{I}_i \to 0$
show similarly that we may replace $\mathcal{I}_j$, resp.\ $\mathcal{I}_i$
by $\mathcal{O}_{Z_j}$, resp.\ $\mathcal{O}_{T_i}$.
OK, and finally, at this point it is clear that our assumption
$$
\sum\nolimits_j [\mathcal{O}_{Z_j}]_k - \sum\nolimits_i [\mathcal{O}_{T_i}]_k
= 0
$$
implies that in $K_0(\text{Coh}_k(X))$ we have also
$\sum\nolimits_j [\mathcal{O}_{Z_j}] - \sum\nolimits_i [\mathcal{O}_{T_i}]
= 0$
as desired.
\end{proof}

\begin{remark}
\label{remark-not-true-not-quasi-compact}
It seems likely that the arrows of Lemma \ref{lemma-cycles-k-group}
are not isomorphisms if $X$ is not quasi-compact. For example, suppose $X$ is
an infinite disjoint union $X = \coprod_{n \in \mathbf{N}} \mathbf{P}^1_k$
over a field $k$. Let $\mathcal{F}$, resp.\ $\mathcal{G}$ be the coherent
sheaf on $X$ whose restriction to the $n$th summand is equal to the skyscraper
sheaf at $0$ associated to $\mathcal{O}_{\mathbf{P}^1_k, 0}/\mathfrak m_0^n$,
resp.\ $\kappa(0)^{\oplus n}$. The cycle associated to $\mathcal{F}$ is
equal to the cycle associated to $\mathcal{G}$, namely both are equal to
$\sum n[0_n]$ where $0_n \in X$ denotes $0$ on the $n$th component of $X$.
But there seems to be no way to show that
$[\mathcal{F}] = [\mathcal{G}]$ in $K_0(\text{Coh}(X))$ since
any proof we can envision uses infinitely many relations.
\end{remark}

\begin{lemma}
\label{lemma-maps-between-coherent-sheaves}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
Let $\mathcal{F}$ be a coherent sheaf on $X$.
Let 
$$
\xymatrix{
\ldots \ar[r] &
\mathcal{F} \ar[r]^\varphi &
\mathcal{F} \ar[r]^\psi &
\mathcal{F} \ar[r]^\varphi &
\mathcal{F} \ar[r] & \ldots
}
$$
be a complex as in Homology (\ref{homology-equation-cyclic-complex}).
Assume that
\begin{enumerate}
\item $\dim_\delta(\text{Supp}(\mathcal{F})) \leq k + 1$.
\item $\dim_\delta(\text{Supp}(H^i(\mathcal{F}, \varphi, \psi))) \leq k$
for $i = 0, 1$.
\end{enumerate}
Then we have
$$
[H^0(\mathcal{F}, \varphi, \psi)]_k
\sim_{rat}
[H^1(\mathcal{F}, \varphi, \psi)]_k
$$
as $k$-cycles on $X$.
\end{lemma}

\begin{proof}
Let $\{W_j\}_{j \in J}$ be the collection of irreducible
components of $\text{Supp}(\mathcal{F})$
which have $\delta$-dimension $k + 1$. Note that $\{W_j\}$
is a locally finite collection of closed subsets of
$X$ by Lemma \ref{lemma-length-finite}.
For every $j$, let $\xi_j \in W_j$ be the generic point.
Set
$$
f_j = \det\nolimits_{\kappa(\xi_j)}
(\mathcal{F}_{\xi_j}, \varphi_{\xi_j}, \psi_{\xi_j})
\in
R(W_j)^*.
$$
See Definition \ref{definition-periodic-determinant} for notation.
We claim that
$$
- [H^0(\mathcal{F}, \varphi, \psi)]_k + [H^1(\mathcal{F}, \varphi, \psi)]_k
=
\sum (W_j \to X)_*\text{div}(f_j)
$$
If we prove this then the lemma follows.

\medskip\noindent
Let $Z \subset X$ be an integral closed subscheme of $\delta$-dimension $k$.
To prove the equality above it suffices to show that the coefficient $n$
of $[Z]$ in
$
[H^0(\mathcal{F}, \varphi, \psi)]_k - [H^1(\mathcal{F}, \varphi, \psi)]_k
$
is the same as the coefficient $m$ of $[Z]$ in
$
\sum (W_j \to X)_*\text{div}(f_j)
$.
Let $\xi \in Z$ be the generic point.
Consider the local ring $A = \mathcal{O}_{X, \xi}$.
Let $M = \mathcal{F}_\xi$ as an $A$-module.
Denote $\varphi, \psi : M \to M$ the action of $\varphi, \psi$ on
the stalk.
By our choice of $\xi \in Z$ we have $\delta(\xi) = k$
and hence $\dim(M) = 1$.
Finally, the integral closed subschemes
$W_j$ passing through $\xi$ correspond to the minimal primes
$\mathfrak q_i$ of $\text{Supp}(M)$.
In each case the element $f_j \in R(W_j)^*$ corresponds to
the element $\det_{\kappa(\mathfrak q_i)}(M_{\mathfrak q_i}, \varphi, \psi)$
in $\kappa(\mathfrak q_i)^*$. Hence we see that
$$
n = - e_A(M, \varphi, \psi)
$$
and
$$
m =
\sum
\text{ord}_{A/\mathfrak q_i}
(\det\nolimits_{\kappa(\mathfrak q_i)}(M_{\mathfrak q_i}, \varphi, \psi))
$$
Thus the result follows from
Proposition \ref{proposition-length-determinant-periodic-complex}.
\end{proof}

\begin{lemma}
\label{lemma-cycles-rational-equivalence-K-group}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
Denote $B_k(X)$ the image of the map
$$
K_0(\text{Coh}_{\leq k}(X)/\text{Coh}_{\leq k - 1}(X))
\longrightarrow
K_0(\text{Coh}_{\leq k + 1}(X)/\text{Coh}_{\leq k - 1}(X)).
$$
There is a commutative diagram
$$
\xymatrix{
K_0\left(\frac{\text{Coh}_{\leq k}(X)}{\text{Coh}_{\leq k - 1}(X)}\right)
\ar[r] \ar[d] &
B_k(X) \ar[d] \ar@{^{(}->}[r] &
K_0\left(\frac{\text{Coh}_{\leq k + 1}(X)}{\text{Coh}_{\leq k - 1}(X)}\right)
\\
Z_k(X) \ar[r] & A_k(X)
}
$$
where the left vertical arrow is the one from
Lemma \ref{lemma-cycles-k-group}. If $X$ is quasi-compact
then both vertical arrows are isomorphisms.
\end{lemma}

\begin{proof}
Suppose we have an element $[A] - [B]$ of
$K_0(\text{Coh}_{\leq k}(X)/\text{Coh}_{\leq k - 1}(X))$
which maps to zero in $B_k(X)$, i.e., in
$K_0(\text{Coh}_{\leq k + 1}(X)/\text{Coh}_{\leq k - 1}(X))$.
Suppose $[A] = [\mathcal{A}]$ and $[B] = [\mathcal{B}]$
for some coherent sheaves $\mathcal{A}, \mathcal{B}$ on
$X$ supported in $\delta$-dimension $\leq k$.
The fact that $[A] - [B]$ maps to zero on
$K_0(\text{Coh}_{\leq k + 1}(X)/\text{Coh}_{\leq k - 1}(X))$
means that there exists coherent sheaves
$\mathcal{A}', \mathcal{B}'$ on $X$ supported in
$\delta$-dimension $\leq k - 1$ such that
$[\mathcal{A} \oplus \mathcal{A}'] - [\mathcal{B} \oplus \mathcal{B}']$
is zero in $K_0(\text{Coh}_{k + 1}(X))$ (use part (1) of
Homology, Lemma \ref{homology-lemma-serre-subcategory-K-groups}).
By part (2) of
Homology, Lemma \ref{homology-lemma-serre-subcategory-K-groups}
this means there exists a $(2, 1)$-periodic complex
$(\mathcal{F}, \varphi, \psi)$ in the category $\text{Coh}_{\leq k + 1}(X)$
such that
$\mathcal{A} \oplus \mathcal{A}' = H^0(\mathcal{F}, \varphi, \psi)$
and $\mathcal{B} \oplus \mathcal{B}' = H^1(\mathcal{F}, \varphi, \psi)$.
By Lemma \ref{lemma-maps-between-coherent-sheaves}
this implies that
$$
[\mathcal{A} \oplus \mathcal{A}']_k
\sim_{rat}
[\mathcal{B} \oplus \mathcal{B}']_k
$$
This proves that $[A] - [B]$ maps to zero via the composition
$$
K_0(\text{Coh}_{\leq k}(X)/\text{Coh}_{\leq k - 1}(X))
\longrightarrow Z_k(X)
\longrightarrow A_k(X).
$$
In other words this proves the
commutative diagram exists.

\medskip\noindent
Next, assume that $X$ is quasi-compact. By Lemma \ref{lemma-cycles-k-group}
the left vertical arrow is bijective. Hence it suffices to show
any $\alpha \in Z_k(X)$ which is rationally equivalent to zero
maps to zero in $B_k(X)$ via the inverse of the left vertical
arrow composed with the horizontal arrow.
By Lemma \ref{lemma-rational-equivalence-family} we see that
$\alpha = \sum ([(W_i)_0]_k - [(W_i)_\infty]_k)$ for some
closed integral subschemes $W_i \subset X\times_S \mathbf{P}^1_S$
of $\delta$-dimension $k + 1$. Moreover the family
$\{W_i\}$ is finite because $X$ is quasi-compact.
Note that the ideal sheaves
$\mathcal{I}_i, \mathcal{J}_i \subset \mathcal{O}_{W_i}$
of the effective Cartier divisors $(W_i)_0, (W_i)_\infty$
are isomorphic (as $\mathcal{O}_{W_i}$-modules). This is true
because the ideal sheaves of $D_0$ and $D_\infty$ on $\mathbf{P}^1$
are isomorphic and $\mathcal{I}_i, \mathcal{J}_i$ are the pullbacks of
these. (Some details omitted.) Hence we have
short exact sequences
$$
0 \to \mathcal{I}_i \to \mathcal{O}_{W_i} \to \mathcal{O}_{(W_i)_0} \to 0,
\quad
0 \to \mathcal{J}_i \to \mathcal{O}_{W_i} \to \mathcal{O}_{(W_i)_\infty} \to 0
$$
of coherent $\mathcal{O}_{W_i}$-modules.
Also, since $[(W_i)_0]_k = [p_*\mathcal{O}_{(W_i)_0}]_k$ in
$Z_k(X)$ we see that the inverse of the left vertical arrow
maps $[(W_i)_0]_k$ to the element $[p_*\mathcal{O}_{(W_i)_0}]$ in
$K_0(\text{Coh}_{\leq k}(X)/\text{Coh}_{\leq k - 1}(X))$.
Thus we have
\begin{eqnarray*}
\alpha
& = &
\sum \left([(W_i)_0]_k - [(W_i)_\infty]_k\right) \\
& \mapsto &
\sum \left([p_*\mathcal{O}_{(W_i)_0}] - [p_*\mathcal{O}_{(W_i)_\infty}]\right)
\\
& = &
\sum \left([p_*\mathcal{O}_{W_i}] - [p_*\mathcal{I}_i]
- [p_*\mathcal{O}_{W_i}] + [p_*\mathcal{J}_i]\right)
\end{eqnarray*}
in $K_0(\text{Coh}_{\leq k + 1}(X)/\text{Coh}_{\leq k - 1}(X))$.
By what was said above this is zero, and we win.
\end{proof}

\begin{remark}
\label{remark-good-cases-K-A}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
Assume $X$ is quasi-compact.
The result of Lemma \ref{lemma-cycles-rational-equivalence-K-group}
in particular gives a map
$$
A_k(X)
\longrightarrow
K_0(\text{Coh}(X)/\text{Coh}_{\leq k - 1}(X)).
$$
We have not been able to find a statement or conjecture in the
literature as to whether this map
is should be injective or not.
If $X$ is connected nonsingular, then, using the
isomorphism $K_0(X) = K^0(X)$ (see insert future reference here)
and chern classes (see below), one can show that
the map is an isomorphism up to $(p - 1)!$-torsion where
$p = \dim_\delta(X) - k$.
\end{remark}


















\section{Preparation for the divisor associated to an invertible sheaf}
\label{section-preparation-divisor-sheaf}

\noindent
For the following remarks, see
Divisors, Section \ref{divisors-section-meromorphic-functions}.
Let $X$ be a scheme.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
Let $\xi \in X$ be a point.
If $s_\xi, s'_\xi \in \mathcal{L}_\xi$ generate $\mathcal{L}_\xi$
as $\mathcal{O}_{X, \xi}$-module, then there exists a unit
$u \in \mathcal{O}_{X, \xi}^*$ such that $s_\xi = u s'_\xi$.
The stalk of the sheaf of meromorphic sections
$\mathcal{K}_X(\mathcal{L})$ of $\mathcal{L}$
at $x$ is equal to
$\mathcal{K}_{X, x} \otimes_{\mathcal{O}_{X, x}} \mathcal{L}_x$.
Thus the image of any meromorphic section $s$
of $\mathcal{L}$ in the stalk at $x$ can be written as $s = fs_\xi$ with
$f \in \mathcal{K}_{X, x}$. Below we will abbreviate this by
saying $f = s/s_\xi$. Also, if $X$ is integral we have
$\mathcal{K}_{X, x} = R(X)$ is equal to the function field of $X$,
so $s/s_\xi \in R(X)$. If $s$ is a {\it regular} meromorphic
section (see
Divisors, Definition \ref{divisors-definition-regular-meromorphic-section}),
then actually $f \in R(X)^*$. (On an integral scheme a regular
meromorphic section is the same thing as a nonzero meromorphic section.)
Hence the following definition makes sense.

\begin{definition}
\label{definition-order-vanishing-meromorphic}
Let $X$ be a locally Noetherian scheme. Assume $X$ is integral.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
Let $s \in \Gamma(X, \mathcal{K}_X(\mathcal{L}))$
be a regular meromorphic section of $\mathcal{L}$.
For every integral closed subscheme
$Z \subset X$ of codimension $1$ we define
the {\it order of vanishing of $s$ along $Z$} as the integer
$$
\text{ord}_{Z, \mathcal{L}}(s)
= \text{ord}_{\mathcal{O}_{X, \xi}}(s/s_\xi)
$$
where the right hand side is the notion of
Definition \ref{definition-ord}, $\xi \in Z$ is the generic point,
and $s_\xi \in \mathcal{L}_\xi$ is a generator.
\end{definition}

\begin{lemma}
\label{lemma-divisor-meromorphic-locally-finite}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$. Assume $X$ is
integral. Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
Let $s \in \mathcal{K}_X(\mathcal{L})$ be a regular (i.e., nonzero)
meromorphic section of $\mathcal{L}$. Then the set
$$
\{Z \subset X \mid Z \text{ is irreducible, closed of codimension }1
\text{ and }\text{ord}_{Z, \mathcal{L}}(s) \not = 0\}
$$
is locally finite in $X$.
\end{lemma}

\begin{proof}
This is true simply because there exists a nonempty open subscheme
$U \subset X$ such that $s$ corresponds to a section of
$\Gamma(U, \mathcal{L})$ which generates $\mathcal{L}$ over $U$.
Hence the codimension $1$
irreducibles which can occur in the set of the lemma are all
irreducible components of $X \setminus U$.
Hence Lemma \ref{lemma-multiplicity-finite} gives the desired result.
\end{proof}

\begin{lemma}
\label{lemma-divisor-meromorphic-well-defined}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$. Assume $X$ is
integral and $n = \dim_\delta(X)$.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
Let $s, s' \in \mathcal{K}_X(\mathcal{L})$ be nonzero
meromorphic sections of $\mathcal{L}$. Then $f = s/s'$
is an element of $R(X)^*$ and we have
$$
\sum \text{ord}_{Z, \mathcal{L}}(s)[Z]
=
\sum \text{ord}_{Z, \mathcal{L}}(s')[Z]
+
\text{div}(f)
$$
(where the sums are over integral closed subschemes $Z \subset X$
of $\delta$-dimension $n - 1$) as elements of $Z_{n - 1}(X)$.
\end{lemma}

\begin{proof}
This is clear from the definitions.
Note that Lemma \ref{lemma-divisor-meromorphic-locally-finite}
garantees that the sums are indeed
elements of $Z_{n - 1}(X)$.
\end{proof}









\section{The divisor associated to an invertible sheaf}
\label{section-divisor-invertible-sheaf}

\noindent
The material above allows us to define the divisor
associated to an invertible sheaf.

\begin{definition}
\label{definition-divisor-invertible-sheaf}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$. Assume $X$ is
integral and $n = \dim_\delta(X)$.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
\begin{enumerate}
\item For any nonzero meromorphic section $s$ of $\mathcal{L}$
we define the {\it Weil divisor associated to $s$} as
$$
\text{div}_{\mathcal{L}}(s) :=
\sum \text{ord}_{Z, \mathcal{L}}(s) [Z] \in Z_{n - 1}(X)
$$
where the sum is over integral closed subschemes $Z \subset X$
of $\delta$-dimension $n - 1$.
\item We define {\it Weil divisor associated to $\mathcal{L}$}
$$
c_1(\mathcal{L}) \cap [X] =
\text{class of }\text{div}_{\mathcal{L}}(s) \in A_{n - 1}(X)
$$
where $s$ is any nonzero meromorphic section of $\mathcal{L}$ over
$X$. This is well defined by
Lemma \ref{lemma-divisor-meromorphic-well-defined}.
\end{enumerate}
\end{definition}

\noindent
There are some cases where it is easy to compute the
Weil divisor associated to an invertible sheaf.

\begin{lemma}
\label{lemma-compute-c1}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$. Assume $X$ is
integral and $n = \dim_\delta(X)$.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
Let $s \in \Gamma(X, \mathcal{L})$ be a nonzero global section.
Then
$$
c_1(\mathcal{L}) \cap [X] = [Z(s)]_{n - 1}
$$
in $A_{n - 1}(X)$.
\end{lemma}

\begin{proof}
Let $Z \subset X$ be an integral closed subscheme of
$\delta$-dimension $n - 1$. Let $\xi \in Z$ be its generic
point. Choose a generator $s_\xi \in \mathcal{L}_\xi$.
Write $s = fs_\xi$ for some $f \in \mathcal{O}_{X, \xi}$.
By definition of $Z(s)$, see
Divisors, Definition \ref{divisors-definition-zero-scheme-s}
we see that $Z(s)$ is cut out by a quasi-coherent
sheaf of ideals $\mathcal{I} \subset \mathcal{O}_X$ such
that $\mathcal{I}_\xi = (f)$. Hence
$\text{length}_{\mathcal{O}_{X, x}}(\mathcal{O}_{Z(s), \xi})
=
\text{length}_{\mathcal{O}_{X, x}}(\mathcal{O}_{X, \xi}/(f))
=
\text{ord}_{\mathcal{O}_{X, x}}(f)$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-c1-additive}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$. Assume $X$ is
integral and $n = \dim_\delta(X)$.
Let $\mathcal{L}$, $\mathcal{N}$ be invertible $\mathcal{O}_X$-modules.
Then
\begin{enumerate}
\item Let $s$, resp.\ $t$ be a nonzero meromorphic section
of $\mathcal{L}$, resp.\ $\mathcal{N}$. Then $st$ is a nonzero
meromorphic section of $\mathcal{L} \otimes \mathcal{N}$, and
$$
\text{div}_{\mathcal{L} \otimes \mathcal{N}}(st)
=
\text{div}_{\mathcal{L}}(s) + \text{div}_{\mathcal{N}}(t)
$$
in $Z_{n - 1}(X)$.
\item We have
$$
c_1(\mathcal{L}) \cap [X] + c_1(\mathcal{N}) \cap [X] =
c_1(\mathcal{L} \otimes_{\mathcal{O}_X} \mathcal{N}) \cap [X]
$$
in $A_{n - 1}(X)$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $s$, resp.\ $t$ be a nonzero meromorphic section
of $\mathcal{L}$, resp.\ $\mathcal{N}$. Then $st$ is a nonzero
meromorphic section of $\mathcal{L} \otimes \mathcal{N}$.
Let $Z \subset X$ be an integral closed subscheme of
$\delta$-dimension $n - 1$. Let $\xi \in Z$ be its generic
point. Choose generators $s_\xi \in \mathcal{L}_\xi$, and
$t_\xi \in \mathcal{N}_\xi$. Then $s_\xi t_\xi$ is a generator
for $(\mathcal{L} \otimes \mathcal{N})_\xi$.
So $st/(s_\xi t_\xi) = (s/s_\xi)(t/t_\xi)$.
Hence we see that
$$
\text{div}_{\mathcal{L} \otimes \mathcal{N}, Z}(st)
=
\text{div}_{\mathcal{L}, Z}(s) + \text{div}_{\mathcal{N}, Z}(t)
$$
by the additivity of the $\text{ord}_Z$ function.
\end{proof}

\noindent
The following lemma will be superseded by the more general
Lemma \ref{lemma-flat-pullback-cap-c1}.

\begin{lemma}
\label{lemma-flat-pullback-divisor-invertible-sheaf}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$. Assume $X$, $Y$
are integral and $n = \dim_\delta(Y)$.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_Y$-module.
Let $f : X \to Y$ be a flat morphism of relative dimension $r$.
Let $\mathcal{L}$ be an invertible sheaf on $Y$. Then
$$
f^*(c_1(\mathcal{L}) \cap [Y]) = c_1(f^*\mathcal{L}) \cap [X]
$$
in $A_{n + r - 1}(X)$.
\end{lemma}

\begin{proof}
Let $s$ be a nonzero meromorphic section of $\mathcal{L}$.
We will show that actually
$f^*\text{div}_{\mathcal{L}}(s) = \text{div}_{f^*\mathcal{L}}(f^*s)$
and hence the lemma holds.
To see this let $\xi \in Y$ be a point and let $s_\xi \in \mathcal{L}_\xi$
be a generator. Write $s = gs_\xi$ with $g \in R(X)^*$.
Then there is an open neighbourhood $V \subset Y$ of $\xi$
such that $s_\xi \in \mathcal{L}(V)$ and such that $s_\xi$ generates
$\mathcal{L}|_V$. Hence we see that
$$
\text{div}_{\mathcal{L}}(s)|_V = \text{div}(g)|_V.
$$
In exactly the same way, since $f^*s_\xi$ generates $\mathcal{L}$
over $f^{-1}(V)$ and since $f^*s = g f^*s_\xi$ we also
have
$$
\text{div}_{\mathcal{L}}(f^*s)|_{f^{-1}(V)}
=
\text{div}(g)|_{f^{-1}(V)}.
$$
Thus the desired equality of cycles over $f^{-1}(V)$ follows from the
corresponding result for pull backs of principal divisors, see
Lemma \ref{lemma-flat-pullback-principal-divisor}.
\end{proof}



\section{Intersecting with Cartier divisors}
\label{section-intersecting-with-divisors}

\begin{definition}
\label{definition-cap-c1}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
We define, for every integer $k$, an operation
$$
c_1(\mathcal{L}) \cap - :
Z_{k + 1}(X) \to A_k(X)
$$
called {\it intersection with the first chern class of $\mathcal{L}$}.
\begin{enumerate}
\item Given an integral closed subscheme $i : W \to X$ with
$\dim_\delta(W) = k + 1$ we define
$$
c_1(\mathcal{L}) \cap [W] = i_*(c_1({i^*\mathcal{L}}) \cap [W])
$$
where the right hand side is defined in
Definition \ref{definition-divisor-invertible-sheaf}.
\item For a general $(k + 1)$-cycle $\alpha = \sum n_i [W_i]$ we set
$$
c_1(\mathcal{L}) \cap \alpha = \sum n_i c_1(\mathcal{L}) \cap [W_i]
$$
\end{enumerate}
\end{definition}

\noindent
Write each $c_1(\mathcal{L}) \cap W_i = \sum_j n_{i,j} [Z_{i, j}]$
with $\{Z_{i, j}\}_j$ a locally finite sum
of integral closed subschemes of $W_i$. Since $\{W_i\}$ is a locally
finite collection of integral closed subschemes on $X$, it follows
easily that $\{Z_{i, j}\}_{i, j}$ is a locally finite collection
of closed subschemes of $X$. Hence
$c_1(\mathcal{L}) \cap \alpha = \sum n_in_{i, j}[Z_{i, j}]$
is a cycle. Another, more convenient, way to think about this
is to observe that the morphism $\coprod W_i \to X$ is
proper. Hence $c_1(\mathcal{L}) \cap \alpha$ can be viewed
as the pushforward of a class in $A_k(\coprod W_i) = \prod A_k(W_i)$.
This also explains why the result is well defined up to rational
equivalence on $X$.

\medskip\noindent
The main goal for the next few sections is to show that intersecting with
$c_1(\mathcal{L})$ factors through rational equivalence, and is commutative.
This is not a trviality.

\begin{lemma}
\label{lemma-c1-cap-additive}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{L}$, $\mathcal{N}$ be an invertible sheaves on $X$.
Then
$$
c_1(\mathcal{L}) \cap \alpha  + c_1(\mathcal{N}) \cap \alpha =
c_1(\mathcal{L} \otimes_{\mathcal{O}_X} \mathcal{N}) \cap \alpha
$$
in $A_k(X)$ for every $\alpha \in Z_{k - 1}(X)$. Moreover, 
$c_1(\mathcal{O}_X) \cap \alpha = 0$ for all $\alpha$.
\end{lemma}

\begin{proof}
This follows directly from Lemma \ref{lemma-c1-additive} and the definitions.
\end{proof}

\noindent
The following lemma is a useful result in order to compute the intersection
product of the $c_1$ of an invertible sheaf and the cycle associated
to a closed subscheme.
Recall that $Z(s) \subset X$ denotes the zero scheme of a global section
$s$ of an invertible sheaf on a scheme $X$, see
Divisors, Definition \ref{divisors-definition-zero-scheme-s}.

\begin{lemma}
\label{lemma-geometric-cap}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
Let $Z \subset X$ be a closed subscheme.
Assume $\dim_\delta(Z) \leq k + 1$.
Let $s \in \Gamma(Z, \mathcal{L}|_Z)$.
Assume
\begin{enumerate}
\item $\dim_\delta(Z(s)) \leq k$, and
\item for every generic point $\xi$ of an irreducible component of
$Z(s)$ of dimension $k$ the multiplication by $s$
induces an injection $\mathcal{O}_{Z, \xi} \to (\mathcal{L}|_Z)_\xi$.
\end{enumerate}
This holds for example if $s$ is a regular section of $\mathcal{L}|_Z$.
Then
$$
[Z(s)]_k = c_1(\mathcal{L}) \cap [Z]_{k + 1}
$$
in $A_k(X)$.
\end{lemma}

\begin{proof}
Write
$$
[Z]_{k + 1} = \sum n_i[W_i]
$$
where $W_i \subset Z$ are the irreducible components of
$Z$ of $\delta$-dimension $k + 1$ and $n_i > 0$.
By assumption the restriction
$s_i = s|_{W_i} \in \Gamma(W_i, \mathcal{L}|_{W_i})$ is not
zero, and hence is a regular section. By Lemma \ref{lemma-compute-c1}
we see that $[Z(s_i)]_k$ represents $c_1(\mathcal{L}|_{W_i})$.
Hence by definition
$$
c_1(\mathcal{L}) \cap [Z]_{k + 1} = \sum n_i[Z(s_i)]_k
$$
In fact, the proof below will show that we have
\begin{equation}
\label{equation-equal-as-cycles}
[Z(s)]_k =  \sum n_i[Z(s_i)]_k
\end{equation}
as $k$-cycles on $X$.

\medskip\noindent
Let $Z' \subset X$ be an integral closed subscheme of
$\delta$-dimension $k$. Let $\xi' \in Z'$ be its generic point.
We want to compare the coefficient $n$ of $[Z']$ in the expression
$\sum n_i[Z(s_i)]_k$ with the coefficient $m$ of $[Z']$ in the
expression $[Z(s)]_k$. Choose a generator $s_{\xi'} \in \mathcal{L}_\xi$.
Let $\mathcal{I} \subset \mathcal{O}_X$ be the ideal sheaf of $Z$.
Write $A = \mathcal{O}_{X, \xi'}$, $L = \mathcal{L}_{\xi'}$
and $I = \mathcal{I}_{\xi'}$. Then $L = As_{\xi'}$ and
$L/IL = (A/I)s_{\xi'} = (\mathcal{L}|_Z)_{\xi'}$.
Write $s = f s_{\xi'}$ for some (unique) $f \in A/I$.
Hypothesis (2) means that $f : A/I \to A/I$ is injective.
Since $\dim_\delta(Z) \leq k + 1$ and $\dim_\delta(Z') = k$
we have $\dim(A/I) = 0$ or $1$. We have
$$
m = \text{length}_A(A/(f, I))
$$
which is finite in either case.

\medskip\noindent
If $\dim(A/I) = 0$, then $f : A/I \to A/I$ being injective
implies that $f \in (A/I)^*$. Hence in this case $m$ is zero.
Moreover, the condition $\dim(A/I) = 0$ means that $\xi'$
does not lie on any irreducible component of $\delta$-dimension
$k + 1$, i.e., $n = 0$ as well.

\medskip\noindent
Now, let $\dim(A/I) = 1$.
Since $A$ is a Noetherian local ring there are finitely
many minimal primes $\mathfrak q_1, \ldots, \mathfrak q_t \supset I$
over $I$. These correspond 1-1 with $W_i$ passing through $\xi'$.
Moreover $n_i = \text{length}_{A_{\mathfrak q_i}}((A/I)_{\mathfrak q_i})$.
Also, the multiplicity of $[Z']$ in $[Z(s_i)]_k$ is
$\text{length}_A(A/(f, \mathfrak q_i))$.
Hence the equation to prove in this case is
$$
\text{length}_A(A/(f, I))
=
\sum \text{length}_{A_{\mathfrak q_i}}((A/I)_{\mathfrak q_i})
\text{length}_A(A/(f, \mathfrak q_i))
$$
which follows from Lemma \ref{lemma-additivity-divisors-restricted}.
\end{proof}

\begin{lemma}
\label{lemma-flat-pullback-cap-c1}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a flat morphism of relative dimension $r$.
Let $\mathcal{L}$ be an invertible sheaf on $Y$.
Let $\alpha$ be a $k$-cycle on $Y$.
Then
$$
f^*(c_1(\mathcal{L}) \cap \alpha) = c_1(f^*\mathcal{L}) \cap f^*\alpha
$$
in $A_{k + r - 1}(X)$.
\end{lemma}

\begin{proof}
Write $\alpha = \sum n_i[W_i]$. We claim it suffices to show that
$f^*(c_1(\mathcal{L}) \cap [W_i]) = c_1(f^*\mathcal{L}) \cap f^*[W_i]$
for each $i$. Proof of this claim is omitted.
(Remarks: it is clear in the quasi-compact case.
Something similar happened in the proof of
Lemma \ref{lemma-flat-pullback-rational-equivalence}, and one
can copy the method used there here. Another possibility
is to check the cycles and rational equivalences used
for all $W_i$ combined at each step form a locally finite collection).

\medskip\noindent
Let $W \subset Y$ be an integral closed subscheme of $\delta$-dimension $k$.
We have to show that
$f^*(c_1(\mathcal{L}) \cap [W]) = c_1(f^*\mathcal{L}) \cap f^*[W]$.
Consider the following fibre product diagram
$$
\xymatrix{
W' = W \times_Y X \ar[r] \ar[d] & X \ar[d] \\
W \ar[r] & Y
}
$$
and let $W'_i \subset W'$ be the irreducible components of
$\delta$-dimension $k + r$. Write
$[W']_{k + r} = \sum n_i[W'_i]$ with $n_i > 0$ as per definition.
So $f^*[W] = \sum n_i[W'_i]$. Choose a nonzero meromorphic section
$s$ of $\mathcal{L}|_W$. Since each $W'_i \to W$ is dominant we
see that $s_i = s|_{W'_i}$ is a nonzero meromorphic section for
each $i$. We claim that we have the following equality of
cycles
$$
\sum n_i\text{div}_{\mathcal{L}|_{W_i}}(s_i)
=
f^*\text{div}_{\mathcal{L}|_W}(s)
$$
in $Z_{k + r - 1}(X)$.

\medskip\noindent
Having formulated the problem as an equality of cycles
we may work locally on $Y$. Hence we may assume
$Y$ and also $W$ affine, and $s = p/q$ for some
nonzero sections $p \in \Gamma(W, \mathcal{L})$
and $q \in \Gamma(W, \mathcal{O})$. If we can show both
$$
\sum n_i\text{div}_{\mathcal{L}|_{W_i}}(p_i)
=
f^*\text{div}_{\mathcal{L}|_W}(p),
\quad\text{and}\quad
\sum n_i\text{div}_{\mathcal{O}|_{W_i}}(q_i)
=
f^*\text{div}_{\mathcal{O}|_W}(q)
$$
(with obvious notations) then we win by the
additivity, see Lemma \ref{lemma-c1-additive}.
Thus we may assume that $s \in \Gamma(W, \mathcal{L}|_W)$.
In this case we may apply the equality
(\ref{equation-equal-as-cycles}) obtained in the proof of
Lemma \ref{lemma-geometric-cap} to see that
$$
\sum n_i\text{div}_{\mathcal{L}|_{W_i}}(s_i)
=
[Z(s')]_{k + r - 1}
$$
where $s' \in f^*\mathcal{L}|_{W'}$ denotes the pull back
of $s$ to $W'$. On the other hand we have
$$
f^*\text{div}_{\mathcal{L}|_W}(s) = f^*[Z(s)]_{k - 1}
= [f^{-1}(Z(s))]_{k + r - 1},
$$
by Lemmas \ref{lemma-compute-c1} and \ref{lemma-pullback-coherent}. 
Since $Z(s') = f^{-1}(Z(s))$ we win.
\end{proof}

\begin{lemma}
\label{lemma-pushforward-cap-c1}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $p : X \to Y$ be a proper morphism.
Let $\alpha \in Z_{k + 1}(X)$.
Let $\mathcal{L}$ be an invertible sheaf on $Y$.
Then
$$
p_*(c_1(p^*\mathcal{L}) \cap \alpha) = c_1(\mathcal{L}) \cap p_*\alpha
$$
in $A_k(Y)$.
\end{lemma}

\begin{proof}
Suppose that $p$ has the property that for every integral
closed subscheme $W \subset X$ the map $p|_W : W \to Y$
is a closed immersion. Then, by definition of capping
wiht $c_1(\mathcal{L})$ the lemma holds.

\medskip\noindent
We will use this remark to reduce to a special case. Namely,
write $\alpha = \sum n_i[W_i]$ with $n_i \not = 0$ and $W_i$ pairwise
distinct. Let $W'_i \subset Y$ be the image of $W_i$ (as an integral
closed subscheme). Consider the diagram
$$
\xymatrix{
X' = \coprod W_i \ar[r]_-q \ar[d]_{p'} & X \ar[d]^p \\
Y' = \coprod W'_i \ar[r]^-{q'} & Y.
}
$$
Since $\{W_i\}$ is locally finite on $X$, and $p$ is proper
we see that $\{W'_i\}$ is locally finite on $Y$ and that
$q, q', p'$ are also proper morphisms.
We may think of $\sum n_i[W_i]$ also as a $k$-cycle
$\alpha' \in Z_k(X')$. Clearly $q_*\alpha' = \alpha$.
We have
$q_*(c_1(q^*p^*\mathcal{L}) \cap \alpha')
= c_1(p^*\mathcal{L}) \cap q_*\alpha'$
and
$(q')_*(c_1((q')^*\mathcal{L}) \cap p'_*\alpha') =
c_1(\mathcal{L}) \cap q'_*p'_*\alpha'$ by the initial
remark of the proof. Hence it suffices to prove the lemma
for the morphism $p'$ and the cycle $\sum n_i[W_i]$.
Clearly, this means we may assume $X$, $Y$ integral,
$f : X \to Y$ dominant and $\alpha = [X]$.

\medskip\noindent
Assume $X$, $Y$ integral,
$f : X \to Y$ dominant and $\alpha = [X]$.
Note that if $\dim_\delta(X) \not = \dim_\delta(Y)$,
then $\dim_\delta(Y) < \dim_\delta(X)$ and the right
hand side is zero. In this case, choose any
nonzero meromorphic section $s$ of $\mathcal{L}$ over $Y$.
Consider the pullback $f^*s$ a nonzero meromorphic section
of $f^*\mathcal{L}$. It is clear that the
irreducible subsets $Z$ of $X$ which occur
with nonzero coefficient in $\text{div}_{f^*\mathcal{L}}(f^*s)$
do not dominate $Y$ (since $s$ was regular nonzero at the generic
point of $Y$). Hence clearly also the left hand side is zero.

\medskip\noindent
Assume $X$, $Y$ integral,
$f : X \to Y$ dominant, $\alpha = [X]$ and $\dim_\delta(X) = \dim_\delta(Y)$.
Choose a nonzero meromorphic section
$s$ of $\mathcal{L}$ on $Y$. We claim that
\begin{equation}
\label{equation-equal-c1-as-cycles}
f_*\left(\text{div}_{f^*\mathcal{L}}(f^*s)\right) =
[R(X) : R(Y)]\text{div}_{\mathcal{L}}(s).
\end{equation}
This will finish the proof since $f_*[X] = [R(X) : R(Y)][Y]$
by definition. It turns out that we can re-use
Lemma \ref{lemma-proper-pushforward-alteration}
to prove this. Namely, since we are trying to prove an equality
of cycles, we may work locally on $Y$. Hence we may assume
that $\mathcal{L} = \mathcal{O}_Y$. In this case $s$
corresponds to a rational function $g \in R(Y)$, and
we are simply trying to prove
$$
f_*\left(\text{div}_X(g)\right) =
[R(X) : R(Y)]\text{div}_Y(g).
$$
Comparing with the result of the aforementioned
Lemma \ref{lemma-proper-pushforward-alteration}
we see this true since
$\text{Nm}_{R(X)/R(Y)}(g) = g^{[R(X) : R(Y)]}$
as $g \in R(Y)^*$.
\end{proof}








\section{Blowing up lemmas}
\label{section-blowing-up-lemmas}

\noindent
In this section we prove some lemmas on representing
Cartier divisors by suitable effective Cartier divisors
on blow-ups. These lemmas can be found in \cite[Section 2.4]{F}.
We have adapted the formulation so they also work
in the non-finite type setting. It may happen that the morphism $b$
of Lemma \ref{lemma-blowing-up-intersections} is a composition of
infinitely many blow ups, but over any given quasi-compact open
$W \subset X$ one needs only finitely many blow-ups
(and this is the result of loc.\ cit.).

\begin{lemma}
\label{lemma-blowing-up-denominators}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Assume $X$ integral with $\dim_\delta(X) = n$.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
Let $s$ be a nonzero meromorphic section of $\mathcal{L}$.
Let $U \subset X$ be the maximal open subscheme such that
$s$ corresponds to a section of $\mathcal{L}$ over $U$.
There exists a projective morphism
$$
\pi : X' \longrightarrow X
$$
such that
\begin{enumerate}
\item $X'$ is integral,
\item $\pi|_{\pi^{-1}(U)} : \pi^{-1}(U) \to U$ is an isomorphism,
\item there exist effective Cartier divisors $D, E \subset X'$
such that 
$$
\pi^*\mathcal{L} = \mathcal{O}_{X'}(D - E),
$$
\item the meromorphic section $s$ corresponds, via the isomorphism above,
to the meromorphic section $1_D \otimes (1_E)^{-1}$ (see Divisors,
Definition
\ref{divisors-definition-invertible-sheaf-effective-Cartier-divisor}),
\item we have
$$
\pi_*([D]_{n - 1} - [E]_{n - 1}) = \text{div}_{\mathcal{L}}(s)
$$
in $Z_{n - 1}(X)$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $\mathcal{I} \subset \mathcal{O}_X$ be the quasi-coherent ideal sheaf
of denominators of $s$. Namely, we declare a local section
$f$ of $\mathcal{O}_X$ to be a local section of $\mathcal{I}$
if and only if $fs$ is a local section of $\mathcal{L}$.
On any affine open $U = \text{Spec}(A)$
of $X$ write $\mathcal{L}|_U = \widetilde{L}$ for some invertible
$A$-module $L$. Then $A$ is a Noetherian domain with fraction field
$K = R(X)$ and we may think of $s|_U$ as an element of
$L \otimes_A K$ (see
Divisors, Lemma \ref{divisors-lemma-locally-Noetherian-K}).
Let $I = \{x \in A \mid xs \in L\}$. Then we see that
$\mathcal{I}|_U = \widetilde{I}$ (details omitted) and hence
$\mathcal{I}$ is quasi-coherent.

\medskip\noindent
Consider the closed subscheme $Z \subset X$ defined by $\mathcal{I}$.
It is clear that $U = X \setminus Z$. This suggests we should blow
up $Z$. Let
$$
\pi : X' = 
\underline{\text{Proj}}_X
\left(\bigoplus\nolimits_{n \geq 0} \mathcal{I}^n\right)
\longrightarrow
X
$$
be the blowing up of $X$ along $Z$. The quasi-coherent
sheaf of $\mathcal{O}_X$-algebras
$\bigoplus\nolimits_{n \geq 0} \mathcal{I}^n$
is generated in degree $1$ over $\mathcal{O}_X$.
Moreover, the degree $1$ part is a coherent $\mathcal{O}_X$-module,
in particular of finite type. Hence we see that $\pi$
is projective and $\mathcal{O}_{X'}(1)$ is relatively very ample.

\medskip\noindent
By Constructions, Lemma \ref{constructions-lemma-blow-up-integral-scheme}
we have $X'$ is integral. By
Divisors, Lemma \ref{divisors-lemma-blowing-up-gives-effective-Cartier-divisor}
there exists an effective Cartier divisor $E \subset X'$ such that
$\pi^{-1}\mathcal{I} \cdot \mathcal{O}_{X'} = \mathcal{I}_E$.
Also, by the same lemma we see that $\pi^{-1}(U) \cong U$.

\medskip\noindent
Denote $s'$ the pullback of the meromorphic section $s$ to a meromorphic
section of $\mathcal{L}' = \pi^*\mathcal{L}$ over $X'$.
It follows from the fact that $\mathcal{I}s \subset \mathcal{L}$
that $\mathcal{I}_Es' \subset \mathcal{L}'$. In other words,
$s'$ gives rise to an $\mathcal{O}_{X'}$-linear map
$\mathcal{I}_E \to \mathcal{L}'$, or in other words
a section $t \in \mathcal{L}' \otimes \mathcal{O}_{X'}(E)$.
By Divisors, Lemma \ref{divisors-lemma-characterize-OD} we obtain a unique
effective Cartier divisor $D \subset X'$ such that
$\mathcal{L}' \otimes \mathcal{O}_{X'}(E) \cong \mathcal{O}_{X'}(D)$
with $t$ corresponding to $1_D$. Reversing this procedure
we conclude that
$\mathcal{L}' = \mathcal{O}_{X'}(-E) \cong \mathcal{O}_{X'}(D)$
with $s'$ corresponding to $1_D \otimes 1_E^{-1}$ as in (4).

\medskip\noindent
We still have to prove (5).
To see this note that in the proof of Lemma \ref{lemma-pushforward-cap-c1}
we showed that
$$
\pi_*(\text{div}_{\mathcal{L}'}(s')) = \text{div}_{\mathcal{L}}(s),
$$
see Equation \ref{equation-equal-c1-as-cycles}.
Hence it suffices to show that
$\text{div}_{\mathcal{L}'}(s') = [D]_{n - 1} - [E]_{n - 1}$.
This follows from the equality
$s' = 1_D \otimes 1_E^{-1}$ and additivity, see
Lemma \ref{lemma-c1-additive}.
\end{proof}

\begin{definition}
\label{definition-epsilon}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Assume $X$ integral and $\dim_\delta(X) = n$.
Let $D_1, D_2$ be two effective Cartier divisors in $X$.
Let $Z \subset X$ be an integral closed subscheme
with $\dim_\delta(Z) = n - 1$. The {\it $\epsilon$-invariant}
of this situation is
$$
\epsilon_Z(D_1, D_2) = n_Z \cdot m_Z
$$
where $n_Z$, resp.\ $m_Z$ is the coefficient of
$Z$ in the $(n - 1)$-cycle $[D_1]_{n - 1}$, resp.\ $[D_2]_{n - 1}$.
\end{definition}

\begin{lemma}
\label{lemma-two-divisors}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Assume $X$ integral and $\dim_\delta(X) = n$.
Let $D_1, D_2$ be two effective Cartier divisors in $X$.
Let $Z$ be an open and closed subscheme of the scheme $D_1 \cap D_2$.
Assume $\dim_\delta(D_1 \cap D_2 \setminus Z) \leq n - 2$.
Then there exists a morphism
$b : X' \to X$, and Cartier divisors
$D_1', D_2', E$ on $X'$ with the following properties
\begin{enumerate}
\item $X'$ is integral,
\item $b$ is projective,
\item $b$ is the blow up of $X$ in the closed subscheme $Z$,
\item $E = b^{-1}(Z)$,
\item $b^{-1}(D_1) = D'_1 + E$, and $b^{-1}D_2 = D_2' + E$,
\item $\dim_\delta(D'_1 \cap D'_2) \leq n - 2$, and if
$Z = D_1 \cap D_2$ then $D'_1 \cap D'_2 = \emptyset$,
\item for every integral closed subscheme $W'$
with $\dim_\delta(W') = n - 1$ we have
\begin{enumerate}
\item if $\epsilon_{W'}(D'_1, E) > 0$, then setting
$W = b(W')$ we have
$\dim_\delta(W) = n - 1$ and
$$
\epsilon_{W'}(D'_1, E) < \epsilon_W(D_1, D_2),
$$
\item if $\epsilon_{W'}(D'_2, E) > 0$, then setting
$W = b(W')$ we have
$\dim_\delta(W) = n - 1$ and
$$
\epsilon_{W'}(D'_2, E) < \epsilon_W(D_1, D_2),
$$
\end{enumerate}
\end{enumerate}
\end{lemma}

\begin{proof}
Note that the quasi-coherent ideal sheaf
$\mathcal{I} = \mathcal{I}_{D_1} + \mathcal{I}_{D_2}$
defines the scheme theoretic intersection $D_1 \cap D_2 \subset X$.
Since $Z$ is a union of connected components of $D_1 \cap D_2$
we see that for every $z \in Z$ the kernel of
$\mathcal{O}_{X, z} \to \mathcal{O}_{Z, z}$ is equal to $\mathcal{I}_z$.
Let $b : X' \to X$ be the blow up of $X$ in $Z$. (So Zariski locally
around $Z$ it is the blow up of $X$ in $\mathcal{I}$.)
Denote $E = b^{-1}(Z)$ the corresponding effective Cartier divisor, see
Divisors,
Lemma \ref{divisors-lemma-blowing-up-gives-effective-Cartier-divisor}.
Since $Z \subset D_1$ we have $E \subset f^{-1}(D_1)$ and hence
$D_1 = D_1' + E$ for some effective Cartier divisor $D'_1 \subset X'$,
see Divisors, Lemma \ref{divisors-lemma-difference-effective-Cartier-divisors}.
Similarly $D_2 = D_2' + E$. This takes care of assertions (1) -- (5).

\medskip\noindent
Note that if $W'$ is as in (7) (a) or (7) (b), then the image $W$
of $W'$ is contained in $D_1 \cap D_2$. If $W$ is not contained in
$Z$, then $b$ is an isomorphism at the generic point of $W$ and
we see that $\dim_\delta(W) = \dim_\delta(W') = n - 1$ which
contradicts the assumption that $\dim_\delta(D_1 \cap D_2 \setminus Z) \leq n - 2$. Hence $W \subset Z$. This means that
to prove (6) and (7) we may work locally around $Z$ on $X$.

\medskip\noindent
Thus we may assume that $X = \text{Spec}(A)$ with
$A$ a Noetherian domain, and $D_1 = \text{Spec}(A/a)$,
$D_2 = \text{Spec}(A/b)$ and $Z = D_1 \cap D_2$.
Set $I = (a, b)$. Since $A$ is a domain and $a, b \not = 0$ we can
cover the blow up by two patches, namely
$U = \text{Spec}(A[s]/(as - b))$ and $V = \text{Spec}(A[t]/(bt -a))$.
These patches are glued using the isomorphism
$A[s, s^{-1}]/(as - b) \cong A[t, t^{-1}]/(bt - a)$
which maps $s$ to $t^{-1}$.
The effective Cartier divisor $E$ is described by
$\text{Spec}(A[s]/(as - b, a)) \subset U$ and
$\text{Spec}(A[t]/(bt - a, b)) \subset V$.
The closed subscheme $D'_1$ corresponds to
$\text{Spec}(A[t]/(bt - a, t)) \subset U$.
The closed subscheme $D'_2$ corresponds to
$\text{Spec}(A[s]/(as -b, s)) \subset V$.
Since ``$ts = 1$'' we see that $D'_1 \cap D'_2 = \emptyset$.

\medskip\noindent
Suppose we have a prime $\mathfrak q \subset A[s]/(as - b)$
of height one with $s, a \in \mathfrak q$.
Let $\mathfrak p \subset A$ be the corresponding prime of $A$.
Observe that $a, b \in \mathfrak p$.
By the dimension formula we see that $\dim(A_{\mathfrak p}) = 1$
as well. The final assertion to be shown is that
$$
\text{ord}_{A_{\mathfrak p}}(a)
\;
\text{ord}_{A_{\mathfrak p}}(b)
>
\text{ord}_{B_{\mathfrak q}}(a)
\;
\text{ord}_{B_{\mathfrak q}}(s)
$$
where $B = A[s]/(as - b)$. By Lemma \ref{lemma-quasi-finite-extension-dim-1}
we have $\text{ord}_{A_{\mathfrak p}}(x) \geq \text{ord}_{B_{\mathfrak q}}(x)$
for $x = a, b$. Since $\text{ord}_{B_{\mathfrak q}}(s) > 0$ we win
by additivity of the $\text{ord}$ function and the fact that
$as = b$.
\end{proof}

\noindent
Let $X$ be a scheme. Let $\{D_i\}_{i \in I}$ be a locally finite collection
of effective Cartier divisors on $X$. Suppose given a function
$I \to \mathbf{Z}_{\geq 0}$, $i \mapsto n_i$. Then it makes sense to talk
about the effective Cartier divisor $\sum n_i D_i$. This is a mild
generalization of Divisors,
Definition \ref{divisors-definition-sum-effective-Cartier-divisors}.

\begin{lemma}
\label{lemma-blowing-up-intersections}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Assume $X$ integral and $\dim_\delta(X) = d$.
Let $\{D_i\}_{i \in I}$ be a locally finite collection of
effective Cartier divisors on $X$.
Assume that for all $\{i, j, k\} \subset I$, $\#\{i, j, k\} = 3$
we have $D_i \cap D_j \cap D_k = \emptyset$.
Then there exist
\begin{enumerate}
\item an open subscheme $U \subset X$ with
$\dim_\delta(X \setminus U) \leq d - 3$,
\item a morphism $b : U' \to U$, and
\item effective Cartier divisors $\{D'_j\}_{j \in J}$ on $U'$
\end{enumerate}
with the following properties:
\begin{enumerate}
\item $b$ is proper morphism $b : U' \to U$,
\item $U'$ is integral,
\item $b$ is an isomorphism over the complement of the union of the pairwise
intersections of the $D_i|_U$,
\item $\{D'_j\}_{j \in J}$ is a locally finite collection of effective
Cartier divisors on $U'$,
\item $\dim_\delta(D'_j \cap D'_{j'}) \leq d - 2$ if $j \not = j'$, and
\item $b^{-1}(D_i|_U) = \sum n_{ij} D'_j$ for certain $n_{ij} \geq 0$.
\end{enumerate}
Moreover, if $X$ is quasi-compact, then we may assume $U = X$ in the above.
\end{lemma}

\begin{proof}
Let us first prove this in the quasi-compact case, since it is perhaps
the most interesting case. In this case we produce inductively a sequence
of blowups
$$
X = X_0 \xleftarrow{b_0} X_1 \xleftarrow{b_1} X_2 \leftarrow \ldots
$$
and finite sets of effective Cartier divisors $\{D_{n, i}\}_{i \in I_n}$.
At each stage these will have the property that any triple
intersection $D_{n, i} \cap D_{n, j} \cap D_{n, k}$ is empty.
Moreover, for each $n \geq 0$ we will have
$I_{n + 1} = I_n \coprod P(I_n)$ where $P(I_n)$ denotes
the set of pairs of elements of $I_n$. Finally, we will have
$$
b_n^{-1}(D_{n, i}) = D_{n + 1, i} +
\sum\nolimits_{i' \in I_n, i' \not = i} D_{n + 1, \{i, i'\}}
$$
We conclude that for each $n \geq 0$ we have
$(b_0 \circ \ldots \circ b_n)^{-1}(D_i)$ is a nonnegative
integer combination of the divisors $D_{n + 1, j}$, $j \in I_{n + 1}$.

\medskip\noindent
To start the induction we set $X_0 = X$ and 
$I_0 = I$ and $D_{0, i} = D_i$.

\medskip\noindent
Given $(X_n, \{D_{n, i}\}_{i \in I_n})$ let $X_{n + 1}$ be the
blow up of $X_n$ in the closed subscheme
$Z_n = \bigcup_{\{i, i'\} \in P(I_n)} D_{n, i} \cap D_{n, i'}$.
Note that the closed subschemes $D_{n, i} \cap D_{n, i'}$ are pairwise
disjoint by our assumption on triple intersections.
In other words we may write
$Z_n = \coprod_{\{i, i'\} \in P(I_n)} D_{n, i} \cap D_{n, i'}$.
Moreover, in a Zariski neighbourhood of $D_{n, i} \cap D_{n, i'}$ the
morphism $b_n$ is equal to the blow up of the scheme $X_n$
in the closed subscheme $D_{n, i} \cap D_{n, i'}$, and the results
of Lemma \ref{lemma-two-divisors} apply.
Hence setting $D_{n + 1, \{i,i'\}} = b_n^{-1}(D_i \cap D_{i'})$
we get an effective Cartier divisor.
The Cartier divisors $D_{n + 1, \{i, i'\}}$ are pairwise disjoint.
Clearly we have
$b_n^{-1}(D_{n, i}) \supset D_{n + 1, \{i, i'\}}$ for
every $i' \in I_n$, $i' \not = i$. Hence, applying
Divisors, Lemma \ref{divisors-lemma-difference-effective-Cartier-divisors}
we see that indeed $b^{-1}(D_{n, i}) = D_{n + 1, i} +
\sum\nolimits_{i' \in I_n, i' \not = i} D_{n + 1, \{i, i'\}}$
for some effective Cartier divisor $D_{n + 1, i}$ on $X_{n + 1}$.
In a neighbourhood of $D_{n + 1, \{i, i'\}}$ these divisors
$D_{n + 1, i}$ play the role of the primed divisors of
Lemma \ref{lemma-two-divisors}. In particular we conclude that
$D_{n + 1, i} \cap D_{n + 1, i'} = \emptyset$ if $i \not = i'$,
$i, i' \in I_n$ by part (6) of Lemma \ref{lemma-two-divisors}.
This already implies that triple intersections
of the divisors $D_{n + 1, i}$ are zero.

\medskip\noindent
OK, and at this point we can use the quasi-compactness of $X$
to conclude that the invariant
\begin{equation}
\label{equation-invariant}
\epsilon(X, \{D_i\}_{i \in I}) =
\max\{\epsilon_Z(D_i, D_{i'}) \mid
Z \subset X,
\dim_\delta(Z) = d - 1,
\{i, i'\} \in P(I)\}
\end{equation}
is finite, since after all each $D_i$ has at most finitely many irreducible
components. We claim that for some $n$ the invariant
$\epsilon(X_n, \{D_{n, i}\}_{i \in I_n})$ is zero. Namely, if not then
by Lemma \ref{lemma-two-divisors} we have a strictly decreasing sequence
$$
\epsilon(X, \{D_i\}_{i \in I})
=
\epsilon(X_0, \{D_{0, i}\}_{i \in I_0})
>
\epsilon(X_1, \{D_{1, i}\}_{i \in I_1})
>
\ldots
$$
of positive integers which is a contradiction. Take $n$ with 
invariant $\epsilon(X_n, \{D_{n, i}\}_{i \in I_n})$ equal to zero.
This means that there is no integral closed subscheme $Z \subset X_n$
and no pair of indices $i, i' \in I_n$
such that $\epsilon_Z(D_{n, i}, D_{n, i'}) > 0$.
In other words, $\dim_\delta(D_{n, i}, D_{n, i'}) \leq d - 2$ for
all pairs $\{i, i'\} \in P(I_n)$ as desired.

\medskip\noindent
Next, we come to the general case where we no longer assume that
the scheme $X$ is quasi-compact. The problem with the idea from
the first part of the proof is that we may get and infinite sequence
of blow ups with centers dominating a fixed point of $X$. In order to
avoid this we cut out suitable closed subsets of codimension $\geq 3$
at each stage. Namely, we will construct by induction
a sequence of morphisms having the following shape
$$
\xymatrix{
X = X_0 \\
U_0 \ar[u]^{j_0} & X_1 \ar[l]_{b_0} \\
 & U_1 \ar[u]^{j_1} & X_2 \ar[l]_{b_1} \\
 & & U_2 \ar[u]^{j_2} & X_3 \ar[l]_{b_2}
}
$$
Each of the morphisms $j_n : U_n \to X_n$ will be an open immersion.
Each of the morphisms $b_n : X_{n + 1} \to U_n$ will be a proper birational
morphism of integral schemes. As in the quasi-compact case we will have
effective Cartier divisors $\{D_{n, i}\}_{i \in I_n}$ on $X_n$.
At each stage these will have the property that any triple
intersection $D_{n, i} \cap D_{n, j} \cap D_{n, k}$ is empty.
Moreover, for each $n \geq 0$ we will have
$I_{n + 1} = I_n \coprod P(I_n)$ where $P(I_n)$ denotes
the set of pairs of elements of $I_n$.
Finally, we will arrange it so that
$$
b_n^{-1}(D_{n, i}|_{U_n}) = D_{n + 1, i} +
\sum\nolimits_{i' \in I_n, i' \not = i} D_{n + 1, \{i, i'\}}
$$

\medskip\noindent
We start the induction by setting $X_0 = X$,
$I_0 = I$ and $D_{0, i} = D_i$.

\medskip\noindent
Given $(X_n, \{D_{n, i}\})$ we construct the open subscheme
$U_n$ as follows. For each pair $\{i, i'\} \in P(I_n)$ consider
the closed subscheme $D_{n, i} \cap D_{n, i'}$. This has ``good''
irreducible components which have $\delta$-dimension $d - 2$ and
``bad'' irreducible components which have $\delta$-dimension $d - 1$.
Let us set
$$
\text{Bad}(i, i')
=
\bigcup\nolimits_{W \subset D_{n, i} \cap D_{n, i'}
\text{ irred.\ comp. with }\dim_\delta(W) = d - 1} W
$$
and similarly
$$
\text{Good}(i, i')
=
\bigcup\nolimits_{W \subset D_{n, i} \cap D_{n, i'}
\text{ irred.\ comp. with }\dim_\delta(W) = d - 2} W.
$$
Then $D_{n, i} \cap D_{n, i'} = \text{Bad}(i, i') \cup \text{Good}(i, i')$
and moreover we have
$\dim_\delta(\text{Bad}(i, i') \cap \text{Good}(i, i')) \leq d - 3$.
Here is our choice of $U_n$:
$$
U_n
=
X_n
\setminus
\bigcup\nolimits_{\{i, i'\} \in P(I_n)}
\text{Bad}(i, i') \cap \text{Good}(i, i').
$$
By our condition on triple intersections of the divisors $D_{n, i}$
we see that the union is actually a disjoint union. Moreover,
we see that (as a scheme)
$$
D_{n, i}|_{U_n} \cap D_{n, i'}|_{U_n}
=
Z_{n, i, i'} \coprod G_{n, i, i'}
$$
where $Z_{n, i, i'}$ is $\delta$-equidimension of dimension $d - 1$
and $G_{n, i, i'}$ is $\delta$-equidimensional of dimension $d - 2$.
(So toplogically $Z_{n, i, i'}$ is the union of the bad components
but throw out intersections with good components.) Finally we set
$$
Z_n =
\bigcup\nolimits_{\{i, i'\} \in P(I_n)} Z_{n, i, i'} =
\coprod\nolimits_{\{i, i'\} \in P(I_n)} Z_{n, i, i'},
$$
and we let $b_n : X_{n + 1} \to X_n$ be the blow up in $Z_n$.
Note that Lemma \ref{lemma-two-divisors}
applies to the morphism $b_n : X_{n + 1} \to X_n$ locally around
each of the loci $D_{n, i}|_{U_n} \cap D_{n, i'}|_{U_n}$. Hence,
exactly as in the first part of the proof we obtain effective
Cartier divisors $D_{n + 1, \{i, i'\}}$ for $\{i, i'\} \in P(I_n)$
and effective Cartier divisors $D_{n + 1, i}$ for $i \in I_n$
such that
$b_n^{-1}(D_{n, i}|_{U_n}) = D_{n + 1, i} +
\sum\nolimits_{i' \in I_n, i' \not = i} D_{n + 1, \{i, i'\}}$.
For each $n$ denote $\pi_n : X_n \to X$ the morphism obtained
as the composition $j_0 \circ \ldots \circ j_{n - 1} \circ b_{n - 1}$.

\medskip\noindent
{\bf Claim:} given any quasi-compact open $V \subset X$
for all sufficiently large $n$ the maps
$$
\pi_n^{-1}(V) \leftarrow \pi_{n + 1}^{-1}(V) \leftarrow \ldots
$$
are all isomorphisms. Namely, if the map
$\pi_n^{-1}(V) \leftarrow \pi_{n + 1}^{-1}(V)$ is not an isomorphism,
then $Z_{n, i, i'} \cap \pi_n^{-1}(V) \not = \emptyset$ for some
$\{i, i'\} \in P(I_n)$. Hence there exists an irreducible component
$W \subset D_{n, i} \cap D_{n, i'}$ with $\dim_\delta(W) = d - 1$.
In particular we see that $\epsilon_W(D_{n, i}, D_{n, i'}) > 0$.
Applying Lemma \ref{lemma-two-divisors} repeatedly we see that
$$
\epsilon_W(D_{n, i}, D_{n, i'})
<
\epsilon(V, \{D_i|_V\}) - n
$$
with $\epsilon(V, \{D_i|_V\})$ as in (\ref{equation-invariant}).
Since $V$ is quasi-compact, we see that
$\epsilon(V, \{D_i|_V\}) < \infty$ and taking $n > \epsilon(V, \{D_i|_V\})$
we see the result.

\medskip\noindent
Note that by construction the difference $X_n \setminus U_n$
has $\dim_\delta(X_n \setminus U_n) \leq d - 3$. 
Let $T_n = \pi_n(X_n \setminus U_n)$ be its image in $X$.
Traversing in the diagram of maps above using each $b_n$ is closed
it follows that $T_0 \cup \ldots \cup T_n$ is a closed subset of $X$
for each $n$. Any $t \in T_n$ satisfies $\delta(t) \leq d - 3$
by construction. Hence $\overline{T_n} \subset X$ is a closed subset
with $\dim_\delta(T_n) \leq d - 3$. By the claim above we see
that for any quasi-compact open $V \subset X$ we have
$T_n \cap V \not = \emptyset$ for at most finitely many $n$.
Hence $\{\overline{T_n}\}_{n \geq 0}$ is a locally finite
collection of closed subsets, and we may set
$U = X \setminus \bigcup \overline{T_n}$. This will be
$U$ as in the lemma.

\medskip\noindent
Note that $U_n \cap \pi_n^{-1}(U) = \pi_n^{-1}(U)$ by construction
of $U$. Hence all the morphisms
$$
b_n : \pi_{n + 1}^{-1}(U) \longrightarrow \pi_n^{-1}(U)
$$
are proper. Moreover, by the claim they eventually become isomorphisms
over each quasi-compact open of $X$. Hence we can define
$$
U' = \text{lim}_n\ \pi_n^{-1}(U).
$$
The induced morphism $b : U' \to U$ is proper since this is local
on $U$, and over each compact open the limit stabilizes. Similarly
we set $J = \bigcup_{n \geq 0} I_n$ using the inclusions
$I_n \to I_{n + 1}$ from the construction. For $j \in J$ choose
an $n_0$ such that $j$ corresponds to $i \in I_{n_0}$ and define
$D'_j = \text{lim}_{n \geq n_0} D_{n, i}$. Again this makes sense
as locally over $X$ the morphisms stabilize.
The other claims of the lemma are verified as in the case
of a quasi-compact $X$.
\end{proof}







\section{Intersecting with effective Cartier divisors}
\label{section-intersecting-effective-Cartier}


\begin{lemma}
\label{lemma-relative-effective-cartier}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $p : X \to Y$ be a flat morphism of relative dimension $r$.
Let $i : D \to X$ be an effective Cartier divisor with the property
that $p|_D : D \to Y$ is flat of relative dimension $r - 1$.
Let $\mathcal{L} = \mathcal{O}_X(D)$.
Then
$$
c_1(\mathcal{L}) \cap p^*\alpha = i_* ((p|_D)^*\alpha)
$$
in $A_{k + r - 1}(X)$ for every $\alpha \in A_k(Y)$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-support-cap-effective-Cartier}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $D$ be an effective Cartier divisor on $X$.
Let $\alpha$ be a $k$-cycle on $X$.
There exists a representative $\beta \in Z_{k - 1}(X)$ of
$c_1(\mathcal{O}_X(D)) \cap \alpha$ which is
supported on $D \cap \text{Supp}(\alpha)$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}


\begin{lemma}
\label{lemma-improved-additivity}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\{D_i\}_{i \in I}$ be a locally finite collection
of effective Cartier divisors on $X$. Let $n_i \geq 0$
and set $D = \sum n_i D_i$.
Let $\alpha \in Z_k(X)$. Choose representatives
$\alpha_i$ of $c_1(\mathcal{O}_X(D_i)) \cap \alpha$
supported on $\text{Supp}(\alpha) \cap D_i$, see
Lemma \ref{lemma-support-cap-effective-Cartier}.
Then $\sum n_i \alpha _i$ is a cycle and is equal
to $c_1(\mathcal{O}_X(D)) \cap \alpha$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-commutativity-effective-Cartier-proper-intersection}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Assume $X$ integral and $\dim_\delta(X) = n$.
Let $D_1$, $D_2$ be effective Cartier divisors on $X$.
Assume $\dim_\delta(D_1 \cap D_2) = n - 2$. Then
$$
c_1(\mathcal{O}_X(D_1)) \cap [D_2]_{n - 1}
=
c_1(\mathcal{O}_X(D_2)) \cap [D_1]_{n - 1}
$$
in $A_{n - 2}(X)$.
\end{lemma}

\begin{proof}
Omitted. Use the canonical sections $1_{D_i}$ and
Lemma \ref{lemma-geometric-cap}.
\end{proof}

\begin{lemma}
\label{lemma-commutativity-effective-Cartier}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Assume $X$ integral and $\dim_\delta(X) = n$.
Let $D_1$, $D_2$ be effective Cartier divisors on $X$.
Then
$$
c_1(\mathcal{O}_X(D_1)) \cap [D_2]_{n - 1}
=
c_1(\mathcal{O}_X(D_2)) \cap [D_1]_{n - 1}
$$
in $A_{n - 2}(X)$.
\end{lemma}

\begin{proof}
Apply Lemma \ref{lemma-blowing-up-intersections} to the set $\{D_1, D_2\}$.
Thus we get a proper birational morphism $b : X' \to X$
and a locally finite collection of effective Cartier
divisors $\{D'_j\}_{j \in J}$ of $X'$ such that
$b^{-1}D_1 = \sum n_j D'_j$ and such that
$b^{-1}D_2 = \sum m_j D'_j$ for some $n_j, m_j \geq 0$.
Moreover $\dim_\delta(D'_j \cap D'_{j'}) = n - 2$ whenever
$j \not = j'$.
Whence $[D_1]_{n - 1} = b_* ( \sum n_j[D'_j]_{n - 1} )$
and $[D_2]_{n - 1} = b_* ( \sum m_j[D'_j]_{n - 1} )$.
By the projection formula of Lemma \ref{lemma-pushforward-cap-c1}
and the additivity of Lemmas \ref{lemma-c1-cap-additive}
and \ref{lemma-improved-additivity}
it is enough to show the equalities
$$
c_1(\mathcal{O}_{X'}(D'_j)) \cap [D_{j'}]_{n - 1}
=
c_1(\mathcal{O}_{X'}(D'_{j'})) \cap [D'_j]_{n - 1}
$$
in $A_{n - 2}(X')$. This is trivial if $j = j'$ and
if $j \not = j'$, then we see this from
Lemma \ref{lemma-commutativity-effective-Cartier-proper-intersection}.
\end{proof}








\section{Commutativity}
\label{section-commutativity}



\begin{lemma}
\label{lemma-commutativity-on-integral}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Assume $X$ integral and $\dim_\delta(X) = n$.
Let $\mathcal{L}$, $\mathcal{N}$ be invertible on $X$.
Choose a nonzero meromorphic section $s$ of $\mathcal{L}$
and a nonzero meromorphic section $t$ of $\mathcal{N}$.
Set $\alpha = \text{div}_{\mathcal{L}}(s)$ and
$\beta = \text{div}_{\mathcal{N}}(t)$.
Then
$$
c_1(\mathcal{N}) \cap \alpha
=
c_1(\mathcal{L}) \cap \beta
$$
in $A_{n - 2}(X)$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-blowing-up-denominators} (applied twice)
there exists a proper morphism
$\pi : X' \to X$ and effective Cartier divisors
$D_1, E_1, D_2, E_2$ on $X'$ such that
$$
b^*\mathcal{L} = \mathcal{O}_{X'}(D_1 - E_1),
\quad
b^*\mathcal{L} = \mathcal{O}_{X'}(D_2 - E_2),
$$
and such that
$$
\alpha = \pi_*([D_1]_{n - 1} - [E_1]_{n - 1}),
\quad
\beta = \pi_*([D_2]_{n - 1} - [E_2]_{n - 1}).
$$
By the projection formula of Lemma \ref{lemma-pushforward-cap-c1}
and the additivity of Lemma \ref{lemma-c1-cap-additive}
it is enough to show the equality
$$
c_1(\mathcal{O}_{X'}(D_1)) \cap [D_2]_{n - 1}
=
c_1(\mathcal{O}_{X'}(D_2)) \cap [D_1]_{n - 1}
$$
and three other similar equalities involving $D_i$ and $E_j$.
Thus the result follows from Lemma \ref{lemma-commutativity-effective-Cartier}.
\end{proof}

\begin{lemma}
\label{lemma-factors}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{L}$ be invertible on $X$.
The operation $\alpha \mapsto c_1(\mathcal{L}) \cap \alpha$
factors through rational equivalence to give an operation
$$
c_1(\mathcal{L}) \cap - : A_{k + 1}(X) \to A_k(X)
$$
\end{lemma}

\begin{proof}
Omitted. Hint:
Apply Lemma \ref{lemma-commutativity-on-integral}
with one of the invertible sheaves equal to the
trivial one.
\end{proof}

\noindent
For any integer $s \geq 0$ we will denote
$$
c_1(\mathcal{L})^s \cap - : A_{k + s}(X) \to A_k(X)
$$
the $s$-fold iterate of the operation $c_1(\mathcal{L}) \cap - $.
This makes sense by the lemma above.

\begin{lemma}
\label{lemma-cap-commutative}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{L}$, $\mathcal{N}$ be invertible on $X$.
For any $\alpha \in A_{k + 2}(X)$ we have
$$
c_1(\mathcal{L}) \cap c_1(\mathcal{N}) \cap \alpha
=
c_1(\mathcal{N}) \cap c_1(\mathcal{L}) \cap \alpha
$$
as elements of $A_k(X)$.
\end{lemma}

\begin{proof}
Omitted. Hint: use Lemma \ref{lemma-commutativity-on-integral}.
\end{proof}









\section{Affine bundles}
\label{section-affine-vector}

\begin{lemma}
\label{lemma-pullback-affine-fibres-surjective}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $f : X \to Y$ be a flat morphism of relative dimension $r$.
Assume that for every $y \in Y$, there exists an open neighbourhood
$U \subset Y$ such that $f|_{f^{-1}(U)} : f^{-1}(U) \to U$
is identified with the morphism $U \times \mathbf{A}^r \to U$.
Then $f^* : A_k(Y) \to A_{k + r}(X)$ is surjective for all
$k \in \mathbf{Z}$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}






\section{Projective space bundle formula}
\label{section-projective-space-bundle-formula}

\noindent
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Consider a finite locally free $\mathcal{O}_X$-module
$\mathcal{E}$ of rank $r$.
Our convention is that
$$
\xymatrix{
\mathbf{P}(\mathcal{E})
=
\underline{\text{Proj}}_X(\text{Sym}^*(\mathcal{E}))
\ar[r]^-\pi
& X
}
$$
over $X$ with
$\mathcal{O}_{\mathbf{P}(\mathcal{E}}(1)$ normalized so that
$\pi_*(\mathcal{O}_{\mathbf{P}(\mathcal{E})}(1)) = \mathcal{E}$.
In particular there is a surjection
$\pi^*\mathcal{E} \to \mathcal{O}_{\mathbf{P}(\mathcal{E})}(1)$.

\begin{lemma}
\label{lemma-cap-projective-bundle}
With notation as above the cycle class
$$
\pi_*\left(
c_1(\mathcal{O}_{\mathbf{P}(\mathcal{E})}(1))^s \cap \pi^*\alpha
\right)
$$
is $0$ if $s < r - 1$ and is equal to $\alpha$
for any $\alpha \in A_k(X)$ for all $k$ when $s = r - 1$.
\end{lemma}

\begin{proof}
Let $Z \subset X$ be an integral closed subscheme of $\delta$-dimension $k$.
Note that $\pi^*[Z] = [\mathbf{P}(\mathcal{E}|_Z)]$.
If $s < r - 1$, then by construction
$c_1(\mathcal{O}_{\mathbf{P}(\mathcal{E})}(1))^s \cap \pi^*[Z]$
is represented by a $(k + r - 1 - s)$-cycle supported on
$\mathbf{P}(\mathcal{E}|_Z)$. Hence the pushforward of this cycle
is zero for dimension reasons.
Let $\xi$ be the generic point of $Z$.
We can choose elements $e_1, \ldots, e_{r - 1} \in \mathcal{E}_\xi$
which form part of a basis of $\mathcal{E}_\xi$. These give rational
sections of $\mathcal{O}(1)$ over $\mathbf{P}(\mathcal{E}|_Z)$
whose common zero set is the closure of the image a rational section of
$\mathbf{P}(\mathcal{E}|_Z) \to Z$ union a closed subset whose
support maps to a proper closed subset of $Z$. This implies that
$$
\pi_* c_1(\mathcal{O}_{\mathbf{P}(\mathcal{E})}(1))^{r - 1} \cap \pi^*[Z]
=
[Z].
$$
Details omitted.
\end{proof}

\begin{lemma}
\label{lemma-chow-ring-projective-bundle}
(Projective space bundle formula.)
With notation as above the map
\begin{align*}
\bigoplus\nolimits_{i=0}^{r-1} A_{k + i}(X)
& \longrightarrow
A_k({\bf P}({\mathcal E})), \\
(\alpha_0,\ldots,\alpha_{r-1}) &
\longmapsto
\pi^*\alpha_0 +
c_1(\mathcal{O}_{\mathbf{P}(\mathcal{E})}(1)) \cap \pi^*\alpha_1
+ \ldots + \\
&
\quad \quad \quad \quad
\quad \quad \quad \quad
\quad \quad \quad \quad
c_1(\mathcal{O}_{\mathbf{P}(\mathcal{E})}(1))^{r - 1} \cap \pi^*\alpha_{r-1}
\end{align*}
is an isomorphism where $r = rank({\mathcal E})$.
\end{lemma}

\begin{proof}
Fix $k \in \mathbf{Z}$.
By the result of the previous lemma this map is injective.
We have to show it is surjective.
Let $X_i$, $i \in I$ be the irreducible components of $X$.
Then $\mathbf{P}(\mathcal{E}|_{X_i})$, $i \in I$
are the irreducible components of $\mathbf{P}(\mathcal{E})$.
If the map is surjective for each of the morphisms
$\mathbf{P}(\mathcal{E}|_{X_i}) \to X_i$, then the map is
surjective for $\mathbf{P}(\mathcal{E}|_X) \to X$.
Hence we may assume $X$ is irreducible.
Thus $\dim_\delta(X) < \infty$ and we may use
induction on $\dim_\delta(X)$.
The result is clear if $\dim_\delta(X) + r - 1 < k$.
Let $\beta \in A_k(\mathbf{P}(\mathcal{E}))$.
If for some nonempty open $U \subset X$ we have $\beta|_U \sim_{rat} 0$
then by Lemma \ref{lemma-restrict-to-open} we see that $\beta$
is rationally equivalent to a $k$-cycle on $\mathbf{P}(\mathcal{E}|_Y)$
where $Y = X \setminus U$ as a reduced closed subscheme.
Note that $\dim_\delta(Y) < \dim_\delta(X)$.
By induction the result holds
for $\mathbf{P}(\mathcal{E}|_Y) \to Y$ and hence the
result holds for $\beta$. Hence we may replace $X$ by any nonempty
open of $X$.

\medskip\noindent
In particular we may assume that $\mathcal{E} \cong \mathcal{O}_X^{\oplus r}$.
In this case $\mathbf{P}(\mathcal{E}) = X \times \mathbf{P}^{r - 1}$.
Consider the open standard affine open
$\mathbf{A}^{r - 1} \subset \mathbf{P}^{r - 1}$ with complement
$\mathbf{P}^{r - 2} \to \mathbf{P}^{r - 1}$.
This gives an open subset $X \times \mathbf{A}^{r - 1}$ and a
closed immersion
$i : X \times \mathbf{P}^{r - 2} \to X \times \mathbf{P}^{r - 1}$.
The restriction of $\beta$ to the open subset is rationally equivalent
to a pullback of a cycle $\alpha_0$ from $X$. After replacing
$\beta$ by $\beta - \pi^*\alpha_0$ we see that $\beta$ restricts
to zero on $X \times \mathbf{A}^{r - 1}$. Hence $\beta$ is
of the form $i_*\beta'$ for some $\beta' \in A_k(X \times \mathbf{P}^{r - 2})$
by Lemma \ref{lemma-restrict-to-open}. By induction on $r$ we see that
$$
\beta' =
\pi^*\alpha'_0 +
c_1(\mathcal{O}_{\mathbf{P}^{r - 2}}(1)) \cap \pi^*\alpha'_1 + \ldots +
c_1(\mathcal{O}_{\mathbf{P}^{r - 2}}(1))^{r - 2} \cap \pi^*\alpha'_{r-2}
$$
The relation in Lemma \ref{lemma-relative-effective-cartier}
and the fact that
$\mathcal{O}_{\mathbf{P}^{r - 1}}(\mathbf{P}^{r - 2})
\cong \mathcal{O}_{\mathbf{P}^{r - 1}}(1)$ implies
that
$$
i_*\beta' =
c_1(\mathcal{O}_{\mathbf{P}^{r - 1}}(1)) \cap \pi^*\alpha'_0 +
c_1(\mathcal{O}_{\mathbf{P}^{r - 1}}(1))^2 \cap \pi^*\alpha'_1 + \ldots +
c_1(\mathcal{O}_{\mathbf{P}^{r - 1}}(1))^{r - 1} \cap \pi^*\alpha'_{r-2}
$$
as desired.
\end{proof}

\begin{lemma}
\label{lemma-vectorbundle}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a finite locally free sheaf of rank $r$ on $X$.
Let
$$
p :
E = \underline{\text{Spec}}(\text{Sym}^*(\mathcal{E}))
\longrightarrow
X
$$
be the associated vector bundle over $X$.
Then $p^* : A_k(X) \to A_{k + r}(E)$ is an isomorphism for all $k$.
\end{lemma}

\begin{proof}
For surjectivity see Lemma \ref{lemma-pullback-affine-fibres-surjective}.

\medskip\noindent
For injectivity we use that the kernel of
$$
j^* :
A_{k + r}(\mathbf{P}(\mathcal{E} \oplus \mathcal{O}_X))
\longrightarrow
A_{k + r}(E)
$$
are the cycles supported in the hyperplace $\mathbf{P}(\mathcal{E})$
at infinity and the fact that the cycles supported there map to cycles
whose expression (in the projective space bundle formula) is a sum of
terms as above with $s \geq 1$ (see proof of projective space bundle
formula). Details omitted.
\end{proof}








\section{The Chern classes of a vector bundle}
\label{section-chern-classes-vector-bundles}

\noindent
We can use the projective space bundle formula to define the
chern classes of a rank $r$ vector bundle in terms of the expansion
of $c_1(\mathcal{O}(1))^r$ in terms of the lower powers, see
formula (\ref{equation-chern-classes}).
The reason for the signs will be explained later.

\begin{definition}
\label{definition-chern-classes}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Assume $X$ is integral and $n = \dim_\delta(X)$.
Let $\mathcal{E}$ be a finite locally free sheaf of rank $r$ on $X$.
\begin{enumerate}
\item By Lemma \ref{lemma-chow-ring-projective-bundle} there are
elements $c_i \in A_{\dim(X) - i}(X)$, $i=0, \ldots, r$
such that $c_0 = [X]$, and
\begin{equation}
\label{equation-chern-classes}
\sum\nolimits_{i = 0}^r
(-1)^i c_1(\mathcal{O}_{\mathbf{P}(\mathcal{E})}(1))^i \cap \pi^*c_{r - i}
= 0.
\end{equation}
\item With notation as above we set
$$
c_i(\mathcal{E}) \cap [X] = c_i
$$
as an element of $A_{n - i}(X)$.
We call these the {\it chern classes of $\mathcal{E}$ on $X$}.
\item The {\it total chern class of $\mathcal{E}$ on $X$}
is the combination
$$
c({\mathcal E}) \cap [X] = 
c_0({\mathcal E}) \cap [X] + c_1({\mathcal E}) \cap [X] + \ldots
+ c_r({\mathcal E}) \cap [X]
$$
which is an element of
$A_*(X) = \bigoplus_{k \in \mathbf{Z}} A_k(X)$.
\end{enumerate}
\end{definition}

\noindent
Let us check that this does not give a new notion in case the
vector bundle has rank $1$.

\begin{lemma}
\label{lemma-first-chern-class}
Let $(S, \delta)$ be as in Situation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Assume $X$ is integral and $n = \dim_\delta(X)$.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
The first chern class of $\mathcal{L}$ on $X$
is equal to the Weil divisor associated to $\mathcal{L}$
by Definition \ref{definition-divisor-invertible-sheaf}.
\end{lemma}

\begin{proof}
In this proof we use $c_1(\mathcal{L}) \cap [X]$ to denote the
construction of Definition \ref{definition-divisor-invertible-sheaf}.
Since $\mathcal{L}$ has rank $1$ we have
$\mathbf{P}(\mathcal{L}) = X$ and
$\mathcal{O}_{\mathbf{P}(\mathcal{L})} = \mathcal{L}$
by our normalizations. Hence (\ref{equation-chern-classes})
reads
$$
(-1)^1 c_1(\mathcal{L}) \cap c_0 + (-1)^0 c_1 = 0
$$
Since $c_0 = [X]$, we conclude $c_1 = c_1(\mathcal{L}) \cap [X]$
as desired.
\end{proof}

\begin{remark}
\label{remark-equation-signs}
We could also rewrite equation \ref{equation-chern-classes} as
\begin{equation}
\sum\nolimits_{i = 0}^r
c_1(\mathcal{O}_{\mathbf{P}(\mathcal{E})}(-1))^i \cap \pi^*c_{r - i}
= 0.
\end{equation}
but we find it easier to work with the tautological quotient
sheaf $\mathcal{O}_{\mathbf{P}(\mathcal{E})}(1)$ instead of
its dual.
\end{remark}




\section{Intersecting with chern classes}
\label{section-intersecting-chern-classes}

\noindent


\begin{definition}
\label{definition-cap-chern-classes}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a finite locally free sheaf of rank $r$ on $X$.
We define, for every integer $k$ and any $0 \leq j \leq r$,
an operation
$$
c_j(\mathcal{E}) \cap - : Z_k(X) \to A_{k - j}(X)
$$
called {\it intersection with the $j$th chern class of $\mathcal{E}$}.
\begin{enumerate}
\item Given an integral closed subscheme $i : W \to X$ of $\delta$-dimension
$k$ we define
$$
c_j(\mathcal{E}) \cap [W] = i_*(c_j({i^*\mathcal{E}}) \cap [W])
\in
A_{k - j}(X)
$$
where $c_j({i^*\mathcal{E}}) \cap [W]$ is as defined in
Definition \ref{definition-chern-classes}.
\item For a general $k$-cycle $\alpha = \sum n_i [W_i]$ we set
$$
c_j(\mathcal{E}) \cap \alpha = \sum n_i c_j(\mathcal{E}) \cap [W_i]
$$
\end{enumerate}
\end{definition}

\noindent
Again, if $\mathcal{E}$ has rank $1$ then this agrees with our
previous definition.

\begin{lemma}
\label{lemma-determine-intersections}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a finite locally free sheaf of rank $r$ on $X$.
Let $\pi : \mathbf{P}(\mathcal{E}) \to X$ be the projective bundle
associated to $\mathcal{E}$.
For $\alpha \in Z_k(X)$ the elements
$c_j(\mathcal{E}) \cap \alpha$ are the unique elements
$\alpha_j$ of $A_{k - j}(X)$
such that
$$
\sum\nolimits_{i = 0}^r
(-1)^i c_1(\mathcal{O}_{\mathbf{P}(\mathcal{E})}(1))^i \cap
\pi^*(\alpha_{r - i}) = 0
$$
holds in the Chow group of $\mathbf{P}(\mathcal{E})$.
\end{lemma}

\begin{proof}
Omitted. Hint: this is true by definition for
$\alpha = [X]$ and follows by Lemma \ref{lemma-pushforward-cap-c1}
in general.
\end{proof}

\noindent
This characterization of chern classes allows us to prove many more
properties.

\begin{lemma}
\label{lemma-cap-chern-class-factors-rational-equivalence}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a finite locally free sheaf of rank $r$ on $X$.
If $\alpha \sim_{rat} \beta$ are rationally equivalent $k$-cycles
on $X$ then $c_j(\mathcal{E}) \cap \alpha = c_j(\mathcal{E}) \cap \beta$
in $A_{k - j}(X)$.
\end{lemma}

\begin{proof}
Omitted, but follows easily from Lemma \ref{lemma-determine-intersections}.
\end{proof}

\noindent
In other words capping with chern classes of
finite locally free sheaves factors through rational equivalence
to give maps
$$
c_j(\mathcal{E}) \cap - : A_k(X) \to A_{k - j}(X).
$$

\begin{lemma}
\label{lemma-flat-pushback-cap-cj}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a finite locally free sheaf of rank $r$ on $X$.
Let $p : X \to Y$ be a flat morphism of relative dimension $r$.
Let $\alpha$ be a $k$-cycle on $Y$.
Then
$$
p_*(c_j(\mathcal{E}) \cap \alpha) = c_j(p^*\mathcal{E}) \cap p_*\alpha
$$
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-pushforward-cap-cj}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$, $Y$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a finite locally free sheaf of rank $r$ on $X$.
Let $p : X \to Y$ be a proper morphism.
Let $\alpha$ be a $k$-cycle on $X$.
Let $\mathcal{E}$ be a finite locally free sheaf on $Y$.
Then
$$
p_*(c_j(p^*\mathcal{E}) \cap \alpha) = c_j(\mathcal{E}) \cap p_*\alpha
$$
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-cap-commutative-chern}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$, $\mathcal{F}$ be finite locally free sheaves on $X$
of ranks $r$ and $s$.
For any $\alpha \in A_k(X)$ we have
$$
c_i(\mathcal{E}) \cap c_j(\mathcal{F}) \cap \alpha
=
c_j(\mathcal{F}) \cap c_i(\mathcal{E}) \cap \alpha
$$
as elements of $A_{k - i - j}(X)$.
\end{lemma}

\begin{proof}
Consider
$$
\pi : \mathbf{P}(\mathcal{E}) \times_X \mathbf{P}(\mathcal{F})
\longrightarrow
X
$$
with invertible sheaves
$\mathcal{L} = \text{pr}_1^*\mathcal{O}_{\mathbf{P}(\mathcal{E})}(1)$
and
$\mathcal{N} = \text{pr}_2^*\mathcal{O}_{\mathbf{P}(\mathcal{F})}(1)$.
Write $\alpha_{i, j}$ for the left hand side and $\beta_{i, j}$
for the right hand side. Also write
$\alpha_j = c_j(\mathcal{F}) \cap \alpha$ and 
$\beta_i = c_i(\mathcal{E}) \cap \alpha$.
From Lemma \ref{lemma-determine-intersections}
(pulled back to $X$ for the first two)
and the fact that intersecting with $c_1(\mathcal{L})$ and
$c_1(\mathcal{N})$ commute (Lemma \ref{lemma-cap-commutative})
and Lemma \ref{lemma-flat-pullback-cap-c1}
we see successively that
\begin{align*}
-(-1)^s c_1(\mathcal{N})^s \cap \pi^*\alpha
& =
\sum (-1)^j c_1(\mathcal{N})^j \cap \pi^*\alpha_j \\
-(-1)^r c_1(\mathcal{L})^r \cap \pi^*\alpha
& =
\sum (-1)^i c_1(\mathcal{L})^i \cap \pi^*\beta_i \\
(-1)^{r + s}c_1(\mathcal{L})^r \cap c_1(\mathcal{N})^s \cap \pi^*\alpha
& =
\sum
(-1)^{i + j}
c_1(\mathcal{L})^i \cap c_1(\mathcal{N})^j \cap \pi^*\alpha_{i, j} \\
(-1)^{r + s}c_1(\mathcal{N})^s \cap c_1(\mathcal{L})^r \cap \pi^*\alpha
& =
\sum
(-1)^{i + j}
c_1(\mathcal{N})^j \cap c_1(\mathcal{L})^i \cap \pi^*\beta_{i, j}
\end{align*}
By the projective space bundle formula (applied twice) these representations
are unique. Whence the result.
\end{proof}









\section{Polynomial relations among chern classes}
\label{section-relations-chern-classes}

\begin{definition}
\label{definition-polynomial-relation-chern-classes}
Let $P(x_{i, j}) \in \mathbf{Z}[x_{i, j}]$ be a polynomial.
We write $P$ as a finite sum
$$
\sum\nolimits_s
\sum\nolimits_{I = ((i_1, j_1), (i_2, j_2), \ldots, (i_s, j_s))}
a_I x_{i_1, j_1} \ldots x_{i_s, j_s}.
$$
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{E}_i$ be a finite collection of finite
locally free sheaves on $X$. We say that $P$
is a {\it polynomial relation among the chern classes}
and we write $P(c_j(\mathcal{E}_i)) = 0$
if for any morphism $f : Y \to X$ of an integral scheme
locally of finite type over $S$ the cycle
$$
\sum\nolimits_s
\sum\nolimits_{I = ((i_1, j_1), (i_2, j_2), \ldots, (i_s, j_s))}
a_I\ c_{j_1}(f^*\mathcal{E}_{i_1}) \cap \ldots
\cap c_{j_s}(f^*\mathcal{E}_{i_s}) \cap [Y]
$$
is zero in $A_*(Y)$.
\end{definition}

\noindent
This is not an elegant definition but it will do
for now. It makes sense because we showed in
Lemma \ref{lemma-cap-commutative-chern} that
capping with chern classes of vector bundles is commutative.
By our definitions and results above
this is equivalent with requiring all the
operations
$$
\sum\nolimits_s
\sum\nolimits_I
a_I\ c_{j_1}(f^*\mathcal{E}_{i_1}) \cap \ldots
\cap c_{j_s}(f^*\mathcal{E}_{i_s}) \cap - :
A_*(Y) \to A_*(Y)
$$
to be zero for all morphisms $f : Y \to X$ which are locally of finite type.

\medskip\noindent
An example of such a relation is the relation
$$
c_1(\mathcal{L} \otimes_{\mathcal{O}_X} \mathcal{N})
=
c_1(\mathcal{L}) + c_1(\mathcal{N})
$$
proved in Lemma \ref{lemma-c1-cap-additive}.
More generally, here is what happens when we tensor an
arbitrary locally free sheaf by an invertible sheaf.

\begin{lemma}
\label{lemma-chern-classes-E-tensor-L}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let $\mathcal{E}$ be a finite locally free sheaf of
rank $r$ on $X$. Let $\mathcal{L}$ be an invertible
sheaf on $X$. Then
\begin{equation}
\label{equation-twist}
c_i({\mathcal E}\otimes {\mathcal L})
=
\sum\nolimits_{j = 0}^i
\binom{r - i + j}{j} c_{i - j}({\mathcal E}) c_1({\mathcal L})^j
\end{equation}
is a valid polynomial relation in the sense described above.
\end{lemma}

\begin{proof}
This should hold for any triple $(X, \mathcal{E}, \mathcal{L})$.
In particular it should hold when $X$ is integral, and in fact by
definition of a polynomial relation it is enough to prove
it holds when capping with $[X]$ for such $X$. Thus assume
that $X$ is integral. Consider the canonical morphsm
$$
\xymatrix{
{\bf P}({\mathcal E})\ar[rd] \ar[rr]_g
&
&
{\bf P}({\mathcal E} \otimes \mathcal{L})\ar[ld]
\cr
& X & 
\cr}
$$
(insert future reference here). It has the property that
$g^*{\mathcal O}_{{\bf P}({\mathcal E} \otimes \mathcal{L})}(1) 
= {\mathcal O}_{{\bf P}({\mathcal E})}(1) \otimes \pi^* {\mathcal L}$.
This means that we have
$$
\sum\nolimits_{i = 0}^r
(-1)^i
(\xi + x)^i \cap \pi^*(c_{r - i}(\mathcal{E} \otimes \mathcal{L}) \cap [X])
=
0
$$
in $A_*(\mathbf{P}(\mathcal{E}))$, where $\xi$ represents
$c_1(\mathcal{O}_{\mathbf{P}(\mathcal{E})}(1))$ and $x$
represents $c_1(\pi^*\mathcal{L})$. By simple algebra this
is equivalent to
$$
\sum\nolimits_{i = 0}^r
(-1)^i \xi^i \left(
\sum\nolimits_{j = i}^r
(-1)^{j - i}
\binom{j}{i}
x^{j - i} \cap
\pi^*(c_{r - j}(\mathcal{E} \otimes \mathcal{L}) \cap [X])
\right)
=
0
$$
Comparing with
Equation (\ref{equation-chern-classes}) it follows from this that
$$
c_{r - i}(\mathcal{E}) \cap [X] =
\sum\nolimits_{j = i}^r
\binom{j}{i}
(-c_1(\mathcal{L}))^{j - i} \cap
c_{r - j}(\mathcal{E} \otimes \mathcal{L}) \cap [X]
$$
Reworking this (getting rid of minus signs, and renumbering) we get
the desired relation.
\end{proof}

\noindent
Some example cases of (\ref{equation-twist}) are
\begin{align*}
c_1(\mathcal{E} \otimes \mathcal{L})
& =
c_1(\mathcal{E}) +
r c_1(\mathcal{L}) \\
c_2(\mathcal{E} \otimes \mathcal{L})
& =
c_2(\mathcal{E}) +
(r - 1) c_1(\mathcal{E}) c_1(\mathcal{L}) +
\binom{r}{2} c_1(\mathcal{L})^2 \\
c_3(\mathcal{E} \otimes \mathcal{L})
& =
c_3(\mathcal{E}) +
(r - 2) c_2(\mathcal{E})c_1(\mathcal{L}) + 
\binom{r - 1}{2} c_1(\mathcal{E})c_1(\mathcal{L})^2 +
\binom{r}{3} c_1(\mathcal{L})^3
\end{align*}








\section{The chern classes of the sum of invertible sheaves}
\label{section-chern-sum-linebundles}

\begin{lemma}
\label{lemma-chern-sum-linebundles}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
Let ${\mathcal L}_i$, $i = 1, \ldots, r$ be invertible
$\mathcal{O}_X$-modules on $X$. Set
$c_1({\mathcal L}_i) = x_i$. Then
$$
c({\mathcal L}_1 \oplus \ldots \oplus {\mathcal L}_r)
=
\prod\nolimits_{i = 1}^r (1 + x_i) 
$$
is a valid polynomial relation among chern classes in the sense of
Definition \ref{definition-polynomial-relation-chern-classes}.
\end{lemma}

\begin{proof}
By the polynomial relation (\ref{equation-twist}) and some easy
algebra we see that it suffices to prove the relation in case
$\mathcal{L}_r \cong \mathcal{O}_X$. In this case we have
$$
i : D = \mathbf{P}({\mathcal L}_1 \oplus \ldots \oplus {\mathcal L}_{r - 1})
\to
\mathbf{P}({\mathcal L}_1 \oplus \ldots \oplus {\mathcal L}_r)
$$
representing $c_1(\mathcal{O}(1))$. By
Lemma \ref{lemma-relative-effective-cartier} we see that
$$
-(-1)^r c_1(\mathcal{O}(1))^r \cap
[\mathbf{P}({\mathcal L}_1 \oplus \ldots \oplus {\mathcal L}_r)]
=
i_* (-1)^{r + 1} c_1(\mathcal{O}(1))^{r - 1} \cap
[\mathbf{P}({\mathcal L}_1 \oplus \ldots \oplus {\mathcal L}_{r - 1})]
$$
Hence it follows that
$$
c_j({\mathcal L}_1 \oplus \ldots \oplus
\mathcal{L}_{r - 1} \oplus {\mathcal O}_X)
=
c_j({\mathcal L}_1 \oplus \ldots \oplus {\mathcal L}_{r - 1})
$$
for all $j$. This argument works on all $Y$ mapping into $X$ in other
words we find the polynomial relation
We win by induction on $r$.
\end{proof}


\section{Additivity of chern classes}
\label{section-additivity-chern-classes}

\begin{lemma}
\label{lemma-additivity-chern-classes}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$ be a scheme locally of finite type over $S$.
Suppose that ${\mathcal E}$ sits in an
exact sequence
$$
0
\to
{\mathcal E}_1
\to 
{\mathcal E}
\to 
{\mathcal E}_2
\to 
0
$$
of finite locally free sheaves $\mathcal{E}_i$ of rank $r_i$.
Then
$$
c({\mathcal E}) = c({\mathcal E}_1) c({\mathcal E}_2)
$$
is a polynomial relation among chern classes.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}


\section{The splitting principle}
\label{section-splitting-principle}


\begin{lemma}
\label{lemma-splitting-principle}
Let $(S, \delta)$ be as in Sitation \ref{situation-setup}.
Let $X$ be locally of finite type over $S$.
For any finite locally free sheaf ${\mathcal E}$ on $X$
there exists a flat morphism or fixed dimension $r$
$f : Y \to X$ such that
\begin{enumerate}
\item $f^* : A_*(X) \to A_{* + r}(Y)$ is injective, and
\item $f^*{\mathcal E}$ has a filtration
with succesive quotients ${\mathcal L}_1, \ldots, {\mathcal L}_r$
for some invertible ${\mathcal O}_Y$-modules ${\mathcal L}_i$.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted. Hint: Flag varieties.
\end{proof}

\noindent
Using the above we formally write
$$
c({\mathcal E}) = \prod\nolimits (1+x_i)
$$
and we call $x_i$ the {\it Chern roots} of ${\mathcal E}$.
Of course it really doesn't make sense in the cohomology 
of $X$, but it does make sense in some other variety
$Y$ such that the cohomology of $X$ injects into it.
As is customary, any symmetric polynomial in the $x_i$
then corresponds to a cohomology class on $X$ because
the chern classes of ${\mathcal E}$ are up to sign the 
elementary symmetric functions in the $x_i$.

\medskip\noindent
It is especially nice to work in the
Chow groups of the Flag variety of ${\mathcal E}$ because
$ \bigoplus A_*(\text{Flag}({\mathcal E})) =
\big(\bigoplus A^{i}(X)\big) [x_1,\ldots,x_r]/I $
where $I$ is smallest ideal such that the following
equation holds true:
$ \prod_{i=1}^r (T - x_i) =  T^r - c_1({\mathcal E}) T^{r-1}+ \ldots
+ (-1)^r c_r({\mathcal E})$. This can be proved by repeated application
of the projective space bundle formula. (And of course there
is a corresponding statement for the odd cohomology.)





\section{Chern classes and tensor product}
\label{section-chern-classes-tensor}

\noindent
We define the {\it Chern character} of a finite locally free
sheaf of rank $r$ to be the expression
$$
ch({\mathcal E}) := \sum\nolimits_{i=1}^r e^{x_i}
$$
if the $x_i$ are the chern roots of ${\mathcal E}$. By the above
we have, in case of an exact sequence
$
0
\to
{\mathcal E}_1
\to 
{\mathcal E}
\to 
{\mathcal E}_2
\to 
0
$
that $ch({\mathcal E}) = ch({\mathcal E}_1) + ch({\mathcal E}_2)$. 
Using the Chern character we can express the compatibility
of the chern classes and tensor product as follows:
$$
ch({\mathcal E}_1 \otimes_{{\mathcal O}_X} {\mathcal E}_2) =
ch({\mathcal E}_1) ch({\mathcal E}_2)
$$
The proof follows directly from the splitting principle.














\input{chapters}

\bibliography{my}
\bibliographystyle{alpha}

\end{document}
