\input{preamble}

% OK, start here.
%
\begin{document}

\title{Divisors}


\maketitle

\phantomsection
\label{section-phantom}

\tableofcontents

\section{Introduction}
\label{section-introduction}

\noindent
In this chapter we study some very basic questions related
to defining divisors, etc. A basic reference is \cite{EGA}.



\section{Supports of modules}
\label{section-support}

\noindent
In this section we collect some elementary results on supports of
quasi-coherent modules on schemes.
Recall that the support of a sheaf of modules has been defined in
Modules, Section \ref{modules-section-support}.
On the other hand, the support of a module was defined in
Algebra, Section \ref{algebra-section-support}.
These match.

\begin{lemma}
\label{lemma-support-affine-open}
Let $X$ be a scheme. Let $\mathcal{F}$ be a quasi-coherent sheaf on $X$.
Let $\text{Spec}(A) = U \subset X$ be an affine open, and set
$M = \Gamma(U, \mathcal{F})$.
Let $x \in U$, and let $\mathfrak p \subset A$ be the corresponding prime.
The following are equivalent
\begin{enumerate}
\item $\mathfrak p$ is in the support of $M$, and
\item $x$ is in the support of $\mathcal{F}$.
\end{enumerate}
\end{lemma}

\begin{proof}
This follows from the equality $\mathcal{F}_x = M_{\mathfrak p}$, see
Schemes, Lemma \ref{schemes-lemma-spec-sheaves}
and the definitions.
\end{proof}

\begin{lemma}
\label{lemma-support-closed-specialization}
Let $X$ be a scheme.
Let $\mathcal{F}$ be a quasi-coherent sheaf on $X$.
The support of $\mathcal{F}$ is closed under specialization.
\end{lemma}

\begin{proof}
If $x' \leadsto x$ is a specialization and $\mathcal{F}_x = 0$
then $\mathcal{F}_{x'}$ is zero, as $\mathcal{F}_{x'}$ is a localization
of the module $\mathcal{F}_x$. Hence the complement of
$\text{Supp}(\mathcal{F})$ is closed under generalization.
\end{proof}

\noindent
For finite type quasi-coherent modules the support is closed,
can be checked on fibres, and commutes with base change.

\begin{lemma}
\label{lemma-support-finite-type}
Let $\mathcal{F}$ be a finite type quasi-coherent module
on a scheme $X$. Then
\begin{enumerate}
\item The support of $\mathcal{F}$ is closed.
\item For $x \in X$ we have
$$
x \in \text{Supp}(\mathcal{F})
\Leftrightarrow
\mathcal{F}_x \not = 0
\Leftrightarrow
\mathcal{F}_x \otimes_{\mathcal{O}_{X, x}} \kappa(x) \not = 0.
$$
\item For any morphism of schemes $f : Y \to X$ the pullback
$f^*\mathcal{F}$ is of finite type as well and we have
$\text{Supp}(f^*\mathcal{F}) = f^{-1}(\text{Supp}(\mathcal{F}))$.
\end{enumerate}
\end{lemma}

\begin{proof}
Part (1) is a reformulation of
Modules, Lemma \ref{modules-lemma-support-finite-type-closed}.
You can also combine
Lemma \ref{lemma-support-affine-open},
Properties, Lemma \ref{properties-lemma-finite-type-module},
and
Algebra, Lemma \ref{algebra-lemma-support-closed}
to see this. The first equivalence in (2) is the definition
of support, and the second equivalence follows from
Nakayama's lemma, see
Algebra, Lemma \ref{algebra-lemma-NAK}.
Let $f : Y \to X$ be a morphism of schemes. Note that
$f^*\mathcal{F}$ is of finite type by
Modules, Lemma \ref{modules-lemma-pullback-finite-type}.
For the final assertion, let $y \in Y$ with image $x \in X$.
Recall that
$$
(f^*\mathcal{F})_y =
\mathcal{F}_x \otimes_{\mathcal{O}_{X, x}} \mathcal{O}_{Y, y},
$$
see
Sheaves, Lemma \ref{sheaves-lemma-stalk-pullback-modules}.
Hence $(f^*\mathcal{F})_y \otimes \kappa(y)$ is nonzero
if and only if $\mathcal{F}_x \otimes \kappa(x)$ is nonzero.
By (2) this implies $x \in \text{Supp}(\mathcal{F})$ if and only
if $y \in \text{Supp}(f^*\mathcal{F})$, which is the content of
assertion (3).
\end{proof}




\section{Associated points}
\label{section-associated}

\noindent
Let $R$ be a ring and let $M$ be an $R$-module.
Recall that a prime $\mathfrak p \subset R$ is {\it associated} to $M$
if there exists an element of $M$ whose annihilator is $\mathfrak p$.
See Algebra, Definition \ref{algebra-definition-associated}.
Here is the definition of associated points
for quasi-coherent sheaves on schemes
as given in \cite[IV Definition 3.1.1]{EGA}.

\begin{definition}
\label{definition-associated}
Let $X$ be a scheme.
Let $\mathcal{F}$ be a quasi-coherent sheaf on $X$.
\begin{enumerate}
\item We say $x \in X$ is {\it associated} to $\mathcal{F}$
if the maximal ideal
$\mathfrak m_x$ is associated to the $\mathcal{O}_{X, x}$-module
$\mathcal{F}_x$.
\item We denote $\text{Ass}(\mathcal{F})$ the set of associated
points of $\mathcal{F}$.
\item The {\it associated points of $X$} are the associated
points of $\mathcal{O}_X$.
\end{enumerate}
\end{definition}

\noindent
These definitions are most useful when $X$ is locally Noetherian
and $\mathcal{F}$ of finite type.
For example it may happen that a generic point of an irreducible
component of $X$ is not associated to $X$, see
Example \ref{example-no-associated-prime}.
In the non-Noetherian case it may be more convenient to use weakly
associated points, see
Section \ref{section-weakly-associated}.
Let us link the scheme theoretic notion with the algebraic notion
on affine opens; note that this correspondence works perfectly only
for locally Noetherian schemes.

\begin{lemma}
\label{lemma-associated-affine-open}
Let $X$ be a scheme. Let $\mathcal{F}$ be a quasi-coherent sheaf on $X$.
Let $\text{Spec}(A) = U \subset X$ be an affine open, and set
$M = \Gamma(U, \mathcal{F})$.
Let $x \in U$, and let $\mathfrak p \subset A$ be the corresponding prime.
\begin{enumerate}
\item If $\mathfrak p$ is associated to $M$, then $x$ is associated
to $\mathcal{F}$.
\item If $\mathfrak p$ is finitely generated, then the coverse holds
as well.
\end{enumerate}
In particular, if $X$ is locally Noetherian, then the equivalence
$$
\mathfrak p \in \text{Ass}(M) \Leftrightarrow x \in \text{Ass}(\mathcal{F})
$$
holds for all pairs $(\mathfrak p, x)$ as above.
\end{lemma}

\begin{proof}
This follows from
Algebra, Lemma \ref{algebra-lemma-associated-primes-localize}.
But we can also argue directly as follows.
Suppose $\mathfrak p$ is associated to $M$.
Then there exists an $m \in M$ whose annihilator is $\mathfrak p$.
Since localization is exact we see that
$\mathfrak pA_{\mathfrak p}$ is the annihilator of
$m/1 \in M_{\mathfrak p}$. Since $M_{\mathfrak p} = \mathcal{F}_x$
(Schemes, Lemma \ref{schemes-lemma-spec-sheaves})
we conclude that $x$ is associated to $\mathcal{F}$.

\medskip\noindent
Conversely, assume that $x$ is associated to $\mathcal{F}$,
and $\mathfrak p$ is finitely generated.
As $x$ is associated to $\mathcal{F}$
there exists an element $m' \in M_{\mathfrak p}$ whose
annihilator is $\mathfrak pA_{\mathfrak p}$. Write
$m' = m/f$ for some $f \in A$, $f \not \in \mathfrak p$.
The annihilator $I$ of $m$ is an ideal of $A$ such that
$IA_{\mathfrak p} = \mathfrak pA_{\mathfrak p}$. Hence
$I \subset \mathfrak p$, and $(\mathfrak p/I)_{\mathfrak p} = 0$.
Since $\mathfrak p$ is finitely generated,
there exists a $g \in A$, $g \not \in \mathfrak p$ such that 
$g(\mathfrak p/I) = 0$. Hence the annihilator of $gm$ is
$\mathfrak p$ and we win.

\medskip\noindent
If $X$ is locally Noetherian, then $A$ is Noetherian
(Properties, Lemma \ref{properties-lemma-locally-Noetherian})
and $\mathfrak p$ is always finitely generated.
\end{proof}

\begin{lemma}
\label{lemma-ass-support}
Let $X$ be a scheme.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
Then $\text{Ass}(\mathcal{F}) \subset \text{Supp}(\mathcal{F})$.
\end{lemma}

\begin{proof}
This is immediate from the definitions.
\end{proof}

\begin{lemma}
\label{lemma-ses-ass}
Let $X$ be a scheme.
Let $0 \to \mathcal{F}_1 \to \mathcal{F}_2 \to \mathcal{F}_3 \to 0$
be a short exact sequence of quasi-coherent sheaves on $X$.
Then
$\text{Ass}(\mathcal{F}_2) \subset
\text{Ass}(\mathcal{F}_1) \cup \text{Ass}(\mathcal{F}_3)$
and
$\text{Ass}(\mathcal{F}_1) \subset \text{Ass}(\mathcal{F}_2)$.\
\end{lemma}

\begin{proof}
For every point $x \in X$ the sequence of stalks
$0 \to \mathcal{F}_{1, x} \to \mathcal{F}_{2, x} \to \mathcal{F}_{3, x} \to 0$
is a short exact sequence of $\mathcal{O}_{X, x}$-modules.
Hence the lemma follows from
Algebra, Lemma \ref{algebra-lemma-ass}.
\end{proof}

\begin{lemma}
\label{lemma-finite-ass}
Let $X$ be a locally Noetherian scheme.
Let $\mathcal{F}$ be a coherent $\mathcal{O}_X$-module.
Then $\text{Ass}(\mathcal{F}) \cap U$ is finite for
every quasi-compact open $U \subset X$.
\end{lemma}

\begin{proof}
This is true because the set of associated primes of a finite module over
a Noetherian ring is finite, see
Algebra, Lemma \ref{algebra-lemma-finite-ass}.
To translate from schemes to algebra use that $U$ is a finite union of
affine opens, each of these opens is the spectrum of a Noetherian ring
(Properties, Lemma \ref{properties-lemma-locally-Noetherian}),
$\mathcal{F}$ corresponds to a finite module over this ring
(Coherent, Lemma \ref{coherent-lemma-coherent-Noetherian}),
and finally use
Lemma \ref{lemma-associated-affine-open}.
\end{proof}

\begin{lemma}
\label{lemma-ass-zero}
Let $X$ be a Noetherian scheme. Let $\mathcal{F}$ be a
quasi-coherent $\mathcal{O}_X$-module. Then
$$
\mathcal{F} = 0 \Leftrightarrow \text{Ass}(\mathcal{F}) = \emptyset.
$$
\end{lemma}

\begin{proof}
If $\mathcal{F} = 0$, then $\text{Ass}(\mathcal{F}) = \emptyset$
by definition. Conversely, if $\text{Ass}(\mathcal{F}) = \emptyset$,
then $\mathcal{F} = 0$ by
Algebra, Lemma \ref{algebra-lemma-ass-zero}.
To translate from schemes to algebra, restrict to any affine and use
Lemma \ref{lemma-associated-affine-open}.
\end{proof}

\begin{lemma}
\label{lemma-minimal-support-in-ass}
Let $X$ be a locally Noetherian scheme.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
Let $x \in \text{Supp}(\mathcal{F})$ be a point in the support
of $\mathcal{F}$ which is not a specialization of another point of
$\text{Supp}(\mathcal{F})$. Then $x \in \text{Ass}(\mathcal{F})$.
In particular, any generic point of an irreducible component of $X$
is an associated point of $X$.
\end{lemma}

\begin{proof}
Since $x \in \text{Supp}(\mathcal{F})$ the module $\mathcal{F}_x$
is not zero. Hence
$\text{Ass}(\mathcal{F}_x) \subset \text{Spec}(\mathcal{O}_{X, x})$
is nonempty by
Algebra, Lemma \ref{algebra-lemma-ass-zero}.
On the other hand, by assumption
$\text{Supp}(\mathcal{F}_x) = \{\mathfrak m_x\}$.
Since
$\text{Ass}(\mathcal{F}_x) \subset \text{Supp}(\mathcal{F}_x)$
(Algebra, Lemma \ref{algebra-lemma-ass-support})
we see that $\mathfrak m_x$ is associated to $\mathcal{F}_x$
and we win.
\end{proof}

\begin{example}
\label{example-no-associated-prime}
Let $k$ be a field. The ring $R = R[x_1, x_2, x_3, \ldots]/(x_i^2)$
is local with locally nilpotent maximal ideal $\mathfrak m$.
There exists no element of $R$ which has annihilator $\mathfrak m$.
Hence $\text{Ass}(R) = \emptyset$, and $X = \text{Spec}(R)$
is an example of a scheme which has no associated points.
\end{example}








\section{Embedded points}
\label{section-embedded}

\noindent
Let $R$ be a ring and let $M$ be an $R$-module.
Recall that a prime $\mathfrak p \subset R$ is an
{\it embedded associated} to $M$ if it is an associated prime of
$M$ which is not minimal among the associated primes of $M$. See
Algebra, Definition \ref{algebra-definition-embedded-primes}.
Here is the definition of embedded associated points
for quasi-coherent sheaves on schemes
as given in \cite[IV Definition 3.1.1]{EGA}.

\begin{definition}
\label{definition-embedded}
Let $X$ be a scheme.
Let $\mathcal{F}$ be a quasi-coherent sheaf on $X$.
\begin{enumerate}
\item An {\it embedded associated point} of $\mathcal{F}$
is an associated point which is not maximal among the
associated points of $\mathcal{F}$, i.e., it is the specialization
of another associated point of $\mathcal{F}$.
\item A point $x$ of $X$ is called an {\it embedded point}
if $x$ is an embedded associated point of $\mathcal{O}_X$.
\item An {\it embedded component} of $X$ is an irreducible
closed subset $Z = \overline{\{x\}}$ where $x$ is an embedded
point of $X$.
\end{enumerate}
\end{definition}

\noindent
In the Noetherian case when $\mathcal{F}$ is coherent we have
the following.

\begin{lemma}
\label{lemma-embedded}
Let $X$ be a locally Noetherian scheme.
Let $\mathcal{F}$ be a coherent $\mathcal{O}_X$-module.
Then
\begin{enumerate}
\item the generic points of irreducible components of
$\text{Supp}(\mathcal{F})$ are associated points of $\mathcal{F}$, and
\item an associated point of $\mathcal{F}$ is embedded if and only
if it is not a generic point of an irreducible component
of $\text{Supp}(\mathcal{F})$.
\end{enumerate}
In particular an embedded point of $X$ is an associated point of $X$
which is not a generic point of an irreducible component of $X$.
\end{lemma}

\begin{proof}
Recall that in this case $Z = \text{Supp}(\mathcal{F})$ is closed, see
Lemma \ref{lemma-support-finite-type}
and that the generic points of irreducible components of $Z$ are
associated points of $\mathcal{F}$, see
Lemma \ref{lemma-minimal-support-in-ass}.
Finally, we have $\text{Ass}(\mathcal{F}) \subset Z$, by
Lemma \ref{lemma-ass-support}.
These results, combined with the fact that $Z$ is a sober topological
space and hence every point of $Z$ is a specialization of a generic
point of $Z$, imply (1) and (2).
\end{proof}

\begin{lemma}
\label{lemma-S1-no-embedded}
Let $X$ be a locally Noetherian scheme.
Let $\mathcal{F}$ be a coherent sheaf on $X$.
Then the following are equivalent:
\begin{enumerate}
\item $\mathcal{F}$ has no embedded associated points, and
\item $\mathcal{F}$ has property $(S_1)$.
\end{enumerate}
\end{lemma}

\begin{proof}
This is Algebra, Lemma \ref{algebra-lemma-criterion-no-embedded-primes},
combined with Lemma \ref{lemma-associated-affine-open} above.
\end{proof}

\begin{lemma}
\label{lemma-remove-embedded-points}
Let $X$ be a locally Noetherian scheme.
Let $\mathcal{F}$ be a coherent sheaf on $X$.
The set of coherent subsheaves
$$
\{
\mathcal{K} \subset \mathcal{F}
\mid
\text{Supp}(\mathcal{K})\text{ is nowhere dense in }\text{Supp}(\mathcal{F})
\}
$$
has a maximal element $\mathcal{K}$.
Setting $\mathcal{F}' = \mathcal{F}/\mathcal{K}$ we have the
following
\begin{enumerate}
\item $\text{Supp}(\mathcal{F}') = \text{Supp}(\mathcal{F})$,
\item $\mathcal{F}'$ has no embedded associated points, and
\item there exists a dense open $U \subset X$ such that
$U \cap \text{Supp}(\mathcal{F})$ is dense in $\text{Supp}(\mathcal{F})$
and $\mathcal{F}'|_U \cong \mathcal{F}|_U$.
\end{enumerate}
\end{lemma}

\begin{proof}
This follows from
Algebra, Lemmas \ref{algebra-lemma-remove-embedded-primes} and
\ref{algebra-lemma-remove-embedded-primes-localize}.
Note that $U$ can be taken as the complement of the closure
of the set of embedded associated points of $\mathcal{F}$.
\end{proof}

\begin{lemma}
\label{lemma-no-embedded-points-endos}
Let $X$ be a locally Noetherian scheme.
Let $\mathcal{F}$ be a coherent $\mathcal{O}_X$-module
without embedded associated points. Set
$$
\mathcal{I}
=
\text{Ker}(\mathcal{O}_X
\longrightarrow
\textit{Hom}_{\mathcal{O}_X}(\mathcal{F}, \mathcal{F})).
$$
This is a coherent sheaf of ideals which defines a closed
subscheme $Z \subset X$ without embedded points. Moreover
there exists a coherent sheaf $\mathcal{G}$ on $Z$
such that (a) $\mathcal{F} = (Z \to X)_*\mathcal{G}$,
(b) $\mathcal{G}$ has no associated embedded points, and
(c) $\text{Supp}(\mathcal{G}) = Z$ (as sets).
\end{lemma}

\begin{proof}
Some of the statements we have seen in the proof of
Coherent, Lemma \ref{coherent-lemma-coherent-support-closed}.
The others follow from
Algebra, Lemma \ref{algebra-lemma-no-embedded-primes-endos}.
\end{proof}



\section{Weakly associated points}
\label{section-weakly-associated}

\noindent
Let $R$ be a ring and let $M$ be an $R$-module.
Recall that a prime $\mathfrak p \subset R$ is {\it weakly associated}
to $M$ if there exists an element $m$ of $M$ such that $\mathfrak p$ is
minimal among the primes containing the annihilator of $m$. See
Algebra, Definition \ref{algebra-definition-weakly-associated}.
If $R$ is a local ring with maximal ideal $\mathfrak m$, then
$\mathfrak m$ is associated to $M$ if and only if there exists an
element $m \in M$ whose annihilator has radical $\mathfrak m$, see
Algebra, Lemma \ref{algebra-lemma-weakly-ass-local}.

\begin{definition}
\label{definition-weakly-associated}
Let $X$ be a scheme.
Let $\mathcal{F}$ be a quasi-coherent sheaf on $X$.
\begin{enumerate}
\item We say $x \in X$ is {\it weakly associated} to $\mathcal{F}$
if the maximal ideal $\mathfrak m_x$ is weakly associated to the
$\mathcal{O}_{X, x}$-module $\mathcal{F}_x$.
\item We denote $\text{WeakAss}(\mathcal{F})$ the set of weakly associated
points of $\mathcal{F}$.
\item The {\it weakly associated points of $X$} are the weakly associated
points of $\mathcal{O}_X$.
\end{enumerate}
\end{definition}

\noindent
In this case, on any affine open, this corresponds exactly to the
weakly associated primes as defined above. Here is the precise statement.

\begin{lemma}
\label{lemma-weakly-associated-affine-open}
Let $X$ be a scheme. Let $\mathcal{F}$ be a quasi-coherent sheaf on $X$.
Let $\text{Spec}(A) = U \subset X$ be an affine open, and set
$M = \Gamma(U, \mathcal{F})$.
Let $x \in U$, and let $\mathfrak p \subset A$ be the corresponding prime.
The following are equivalent
\begin{enumerate}
\item $\mathfrak p$ is weakly associated to $M$, and
\item $x$ is weakly associated to $\mathcal{F}$.
\end{enumerate}
\end{lemma}

\begin{proof}
This follows from
Algebra, Lemma \ref{algebra-lemma-weakly-ass-local}.
\end{proof}

\begin{lemma}
\label{lemma-weakly-ass-support}
Let $X$ be a scheme.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
Then
$$
\text{Ass}(\mathcal{F}) \subset \text{WeakAss}(\mathcal{F}) \subset
\text{Supp}(\mathcal{F}).
$$
\end{lemma}

\begin{proof}
This is immediate from the definitions.
\end{proof}

\begin{lemma}
\label{lemma-ses-weakly-ass}
Let $X$ be a scheme.
Let $0 \to \mathcal{F}_1 \to \mathcal{F}_2 \to \mathcal{F}_3 \to 0$
be a short exact sequence of quasi-coherent sheaves on $X$.
Then
$\text{WeakAss}(\mathcal{F}_2) \subset
\text{WeakAss}(\mathcal{F}_1) \cup \text{WeakAss}(\mathcal{F}_3)$
and
$\text{WeakAss}(\mathcal{F}_1) \subset \text{WeakAss}(\mathcal{F}_2)$.\
\end{lemma}

\begin{proof}
For every point $x \in X$ the sequence of stalks
$0 \to \mathcal{F}_{1, x} \to \mathcal{F}_{2, x} \to \mathcal{F}_{3, x} \to 0$
is a short exact sequence of $\mathcal{O}_{X, x}$-modules.
Hence the lemma follows from
Algebra, Lemma \ref{algebra-lemma-weakly-ass}.
\end{proof}

\begin{lemma}
\label{lemma-weakly-ass-zero}
Let $X$ be a scheme.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
Then
$$
\mathcal{F} = (0) \Leftrightarrow \text{WeakAss}(\mathcal{F}) = \emptyset
$$
\end{lemma}

\begin{proof}
Follows from
Lemma \ref{lemma-weakly-associated-affine-open}
and
Algebra, Lemma \ref{algebra-lemma-weakly-ass-zero}
\end{proof}

\begin{lemma}
\label{lemma-minimal-support-in-weakly-ass}
Let $X$ be a scheme.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
Let $x \in \text{Supp}(\mathcal{F})$ be a point in the support
of $\mathcal{F}$ which is not a specialization of another point of
$\text{Supp}(\mathcal{F})$. Then
$x \in \text{WeakAss}(\mathcal{F})$.
In particular, any generic point of an irreducible component of $X$
is weakly associated to $\mathcal{O}_X$.
\end{lemma}

\begin{proof}
Since $x \in \text{Supp}(\mathcal{F})$ the module $\mathcal{F}_x$
is not zero. Hence
$\text{WeakAss}(\mathcal{F}_x) \subset \text{Spec}(\mathcal{O}_{X, x})$
is nonempty by
Algebra, Lemma \ref{algebra-lemma-weakly-ass-zero}.
On the other hand, by assumption
$\text{Supp}(\mathcal{F}_x) = \{\mathfrak m_x\}$.
Since
$\text{WeakAss}(\mathcal{F}_x) \subset \text{Supp}(\mathcal{F}_x)$
(Algebra, Lemma \ref{algebra-lemma-weakly-ass-support})
we see that $\mathfrak m_x$ is weakly associated to $\mathcal{F}_x$
and we win.
\end{proof}

\begin{lemma}
\label{lemma-ass-weakly-ass}
Let $X$ be a scheme.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
If $\mathfrak m_x$ is a finitely generated ideal of $\mathcal{O}_{X, x}$,
then
$$
x \in \text{Ass}(\mathcal{F}) \Leftrightarrow
x \in \text{WeakAss}(\mathcal{F}).
$$
In particular, if $X$ is locally Noetherian, then
$\text{Ass}(\mathcal{F}) = \text{WeakAss}(\mathcal{F})$.
\end{lemma}

\begin{proof}
See
Algebra, Lemma \ref{algebra-lemma-ass-weakly-ass}.
\end{proof}


\section{Relative assasins}
\label{section-relative-assasins}

\begin{definition}
\label{definition-relative-assasin}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
The {\it relative assasin of $\mathcal{F}$ in $X$ over $S$}
is the set
$$
\text{Ass}_{X/S}(\mathcal{F}) =
\bigcup\nolimits_{s \in S} \text{Ass}(\mathcal{F}_s)
$$
where $\mathcal{F}_s = (X_s \to X)^*\mathcal{F}$ is the restriction
of $\mathcal{F}$ to the fibre of $f$ at $s$.
\end{definition}

\noindent
Again there is a caveat that this is best used when the fibres of $f$
are locally Noetherian and $\mathcal{F}$ is of finite type. In the general
case we should probably use the relative weak assasin (defined in the next
section).



\section{Relative weak assasins}
\label{section-relative-weak-assasins}

\begin{definition}
\label{definition-relative-weak-assasin}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
The {\it relative weak assasin of $\mathcal{F}$ in $X$ over $S$}
is the set
$$
\text{WeakAss}_{X/S}(\mathcal{F}) =
\bigcup\nolimits_{s \in S} \text{WeakAss}(\mathcal{F}_s)
$$
where $\mathcal{F}_s = (X_s \to X)^*\mathcal{F}$ is the restriction
of $\mathcal{F}$ to the fibre of $f$ at $s$.
\end{definition}







\section{Effective Cartier divisors}
\label{section-effective-Cartier-divisors}

\noindent
For some reason it seem convenient to define the notion of an effective
Cartier divisor before anything else.

\begin{definition}
\label{definition-effective-Cartier-divisor}
Let $S$ be a scheme.
\begin{enumerate}
\item A {\it locally principal closed subscheme} of $S$ is a closed subscheme
whose sheaf of ideals is locally generated by a single element.
\item An {\it effective Cartier divisor} on $S$ is a closed subscheme
$D \subset S$ such that the ideal sheaf $\mathcal{I}_D \subset \mathcal{O}_X$
is an invertible $\mathcal{O}_X$-module.
\end{enumerate}
\end{definition}

\noindent
Thus an effective Cartier divisor is a locally principal closed subscheme,
but the converse is not always true. Effective Cartier divisors are closed
subschemes of pure codimension $1$ in the strongest possible sense. Namely
they are locally cut out by a single element which is not a zero divisor.
In particular they are nowhere dense.

\begin{lemma}
\label{lemma-characterize-effective-Cartier-divisor}
Let $S$ be a scheme.
Let $D \subset S$ be a closed subscheme.
The following are equivalent:
\begin{enumerate}
\item The subscheme $D$ is an effective Cartier divisor on $S$.
\item For every $x \in D$ there exists an affine open neighbourhood
$\text{Spec}(A) = U \subset X$ of $x$ such that
$U \cap D = \text{Spec}(A/(f))$ with $f \in A$ not a zero divisor.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume (1).  For every $x \in D$ there exists an affine open neighbourhood
$\text{Spec}(A) = U \subset X$ of $x$ such that
$\mathcal{I}_D|_U \cong \mathcal{O}_U$. In other words, there exists
a section $f \in \Gamma(U, \mathcal{I}_D)$ which freely generates the
restriction $\mathcal{I}_D|_U$. Hence $f \in A$, and the multiplication
map $f : A \to A$ is injective. Also, since $\mathcal{I}_D$ is
quasi-coherent we see that $D \cap U = \text{Spec}(A/(f))$.

\medskip\noindent
Assume (2). Let $x \in D$. By assumption there exists an affine open
neighbourhood $\text{Spec}(A) = U \subset X$ of $x$ such that
$U \cap D = \text{Spec}(A/(f))$ with $f \in A$ not a zero divisor.
Then $\mathcal{I}_D|_U \cong \mathcal{O}_U$ since it is equal to
$\widetilde{(f)} \cong \widetilde{A} \cong \mathcal{O}_U$.
Of course $\mathcal{I}_D$ restricted to the open subscheme
$S \setminus D$ is isomorphic to $\mathcal{O}_{X \setminus D}$.
Hence $\mathcal{I}_D$ is an invertible $\mathcal{O}_S$-module.
\end{proof}

\begin{lemma}
\label{lemma-effective-Cartier-makes-dimension-drop}
Let $S$ be a scheme.
Let $D \subset X$ be an effective Cartier divisor.
Let $s \in D$.
If $\dim_s(S) < \infty$, then $\dim_s(D) < \dim_s(X)$.
\end{lemma}

\begin{proof}
Assume $\dim_s(S) < \infty$.
Let $U = \text{Spec}(A) \subset S$ be an affine open neighbourhood
of $X$ such that $\dim(U) = \dim_s(S)$ and such that $D = V(f)$
for some nonzero divisor $f \in A$ (see
Lemma \ref{lemma-characterize-effective-Cartier-divisor}).
Recall that $\dim(U)$ is the Krull dimension of the ring $A$
and that $\dim(U \cap D)$ is the Krull dimension of the ring $A/(f)$.
Then $f$ is not contained in any minimal prime of $A$.
Hence any maximal chain of primes in $A/(f)$, viewed as a chain
of primes in $A$, can be extended by adding a minimal prime.
\end{proof}

\begin{definition}
\label{definition-sum-effective-Cartier-divisors}
Let $S$ be a scheme. Given effective Cartier divisors
$D_1$, $D_2$ on $S$ we set $D = D_1 + D_2$ equal to the
closed subscheme of $S$ corresponding to the quasi-coherent
sheaf of ideals
$\mathcal{I}_{D_1}\mathcal{I}_{D_2} \subset \mathcal{O}_S$.
We call this the {\it sum of the effective Cartier divisors
$D_1$ and $D_2$}.
\end{definition}

\noindent
It is clear that we may define the sum $\sum n_iD_i$ given
finitely many effective Cartier divisors $D_i$ on $X$
and nonnegative integers $n_i$.

\begin{lemma}
\label{lemma-sum-effective-Cartier-divisors}
The sum of two effective Cartier divisors is an effective
Cartier divisor.
\end{lemma}

\begin{proof}
Omitted. Locally $f_1, f_2 \in A$ are nonzero divisors, then also
$f_1f_2 \in A$ is a nonzero divisor.
\end{proof}

\begin{lemma}
\label{lemma-difference-effective-Cartier-divisors}
Let $X$ be a scheme.
Let $D, D'$ be two effective Cartier divisors on $X$.
If $D \subset D'$ (as closed subschemes of $X$), then
there exists an effective Cartier divisor $D''$ such
that $D' = D + D''$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\noindent
Recall that we have defined the inverse image of a closed subscheme
under any morphism of schemes in
Schemes, Definition \ref{schemes-definition-inverse-image-closed-subscheme}.

\begin{lemma}
\label{lemma-pullback-locally-principal}
Let $f : S' \to S$ be a morphism of schemes. Let $Z \subset S$
be a locally principal closed subscheme. Then the inverse image
$f^{-1}(Z)$ is a locally principal closed subscheme of $S'$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{definition}
\label{definition-pullback-effective-Cartier-divisor}
Let $f : S' \to S$ be a morphism of schemes. Let $D \subset S$
be an effective Cartier divisor. We say the {\it pullback of
$D$ by $f$ is defined} if the closed subscheme $f^{-1}(D) \subset S'$
is an effective Cartier divisor. In this case we denote it either
$f^*D$ or $f^{-1}(D)$ and we call it the
{\it pullback of the effective Cartier divisor}.
\end{definition}

\noindent
The condition that $f^{-1}(D)$ is an effective Cartier divisor
is often satisfied in practice. Here is an example lemma.

\begin{lemma}
\label{lemma-pullback-effective-Cartier-defined}
Let $f : X \to Y$ be a morphism of schemes.
Let $D \subset Y$ be an effective Cartier divisor.
The pullback of $D$ by $f$ is defined in each of the following cases:
\begin{enumerate}
\item $X$, $Y$ integral and $f$ dominant,
\item $X$ reduced, and for any generic point $\xi$ of any
irreducible component of $X$ we have $f(\xi) \not \in D$,
\item $X$ is locally Noetherian and for any associated point
$x$ of $X$ we have $f(x) \not \in D$,
\item $X$ is locally Noetherian, has no embedded points, and
for any generic point $\xi$ of any irreducible component of
$X$ we have $f(\xi) \not \in D$,
\item $f$ is flat, and
\item add more here as needed.
\end{enumerate}
\end{lemma}

\begin{proof}
The question is local on $X$, and hence we reduce to the case
where $X = \text{Spec}(A)$, $Y = \text{Spec}(R)$, $f$ is
given by $\varphi : R \to A$ and
$D = \text{Spec}(R/(t))$ where $t \in R$ is not a zero divisor.
The goal in each case is to show that $\varphi(t) \in A$
is not a zero divisor.

\medskip\noindent
In case (2) this follows as the intersection of all minimal
primes of a ring is the nilradical of the ring, see
Algebra, Lemma \ref{algebra-lemma-Zariski-topology}.

\medskip\noindent
Let us prove (3). By
Lemma \ref{lemma-associated-affine-open}
the associated points of $X$ correspond to the primes
$\mathfrak p \in \text{Ass}(A)$.
By Algebra, Lemma \ref{algebra-lemma-ass-zero-divisors} we have
$\bigcup_{\mathfrak p \in \text{Ass}(A)} \mathfrak p$ is
the set of zero divisors of $A$. The hypothesis of
(3) is that $\varphi(t) \not \in \mathfrak p$ for
all $\mathfrak p \in \text{Ass}(A)$. Hence $\varphi(t)$
is a nonzero divisor as desired.

\medskip\noindent
Part (4) follows from (3) and the definitions.
\end{proof}

\begin{lemma}
\label{lemma-pullback-effective-Cartier-divisors-additive}
Let $f : S' \to S$ be a morphism of schemes.
Let $D_1$, $D_2$ be effective Cartier divisors on $S$.
If the pullbacks of $D_1$ and $D_2$ are defined then the
pullback of $D = D_1 + D_2$ is defined and
$f^*D = f^*D_1 + f^*D_2$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{definition}
\label{definition-invertible-sheaf-effective-Cartier-divisor}
Let $S$ be a scheme and let $D$ be an effective Cartier divisor.
The {\it invertible sheaf $\mathcal{O}_S(D)$ associated to $D$}
is given by
$$
\mathcal{O}_S(D) :=
\textit{Hom}_{\mathcal{O}_S}(\mathcal{I}_D, \mathcal{O}_S) =
\mathcal{I}_D^{\otimes -1}.
$$
The canonical section, usually denoted $1$ or $1_D$, is the
global section of $\mathcal{O}_S(D)$ corresponding to
the inclusion mapping $\mathcal{I}_D \to \mathcal{O}_S$.
\end{definition}

\begin{lemma}
\label{lemma-invertible-sheaf-sum-effective-Cartier-divisors}
Let $S$ be a scheme.
Let $D_1$, $D_2$ be effective Cartier divisors on $S$.
Let $D = D_1 + d_2$.
Then there is a unique isomorphism
$$
\mathcal{O}_S(D_1) \otimes_{\mathcal{O}_S} \mathcal{O}_S(D_2)
\longrightarrow
\mathcal{O}_S(D)
$$
which maps $1_{D_1} \otimes 1_{D_2}$ to $1_D$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{definition}
\label{definition-regular-section}
Let $(X, \mathcal{O}_X)$ be a locally ringed space.
Let $\mathcal{L}$ be an invertible sheaf on $X$.
A global section $s \in \Gamma(X, \mathcal{L})$ is called a
{\it regular section} if the map $\mathcal{O}_X \to \mathcal{L}$,
$f \mapsto fs$ is injective.
\end{definition}

\begin{lemma}
\label{lemma-regular-section-structure-sheaf}
Let $X$ be a locally ringed space. Let $f \in \Gamma(X, \mathcal{O}_X)$.
The following are equivalent:
\begin{enumerate}
\item $f$ is a regular section, and
\item for any $x \in X$ the image $f \in \mathcal{O}_{X, x}$
is not a zero divisor.
\end{enumerate}
If $X$ is a scheme these are also equivalent to
\begin{enumerate}
\item[(3)] for any affine open $\text{Spec}(A) = U \subset X$
the image $f \in A$ is not a zero divisor, and
\item[(4)] there exists an affine open covering
$X = \bigcup \text{Spec}(A_i)$ such that
the image of $f$ in $A_i$ is not a zero divisor for all $i$.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\noindent
Note that a global section $s$ of an invertible $\mathcal{O}_X$-module
$\mathcal{L}$ may be seen as an $\mathcal{O}_X$-module map
$s : \mathcal{O}_X \to \mathcal{L}$. Its dual is therefore a
map $s : \mathcal{L}^{\otimes -1} \to \mathcal{O}_X$.
(See Modules, Definition \ref{modules-definition-powers}
for the definition of the dual invertible sheaf.)

\begin{definition}
\label{definition-zero-scheme-s}
Let $X$ be a scheme.
Let $\mathcal{L}$ be an invertible sheaf.
Let $s \in \Gamma(X, \mathcal{L})$.
The {\it zero scheme} of $s$ is the closed subscheme $Z(s) \subset X$
defined by the quasi-coherent sheaf of ideals
$\mathcal{I} \subset \mathcal{O}_X$ which is the image of the
map $s : \mathcal{L}^{\otimes -1} \to \mathcal{O}_X$.
\end{definition}

\begin{lemma}
\label{lemma-zero-scheme}
Let $X$ be a scheme.
Let $\mathcal{L}$ be an invertible sheaf.
Let $s \in \Gamma(X, \mathcal{L})$.
\begin{enumerate}
\item Consider closed immersions $i : Z \to X$ such that
$i^*s \in \Gamma(Z, i^*\mathcal{L}))$ is zero
ordered by inclusion. The zero scheme $Z(s)$ is the
minimal element of this set.
\item For any morphism of schemes $f : Y \to X$ we have
$f^*s = 0$ in $\Gamma(Y, f^*\mathcal{L})$ if and only if
$f$ factors through $Z(s)$.
\item The zero scheme $Z(s)$ is locally cut out by one equation.
\item The zero scheme $Z(s)$ is an effective Cartier divisor
if and only if $s$ is a regular section of $\mathcal{L}$.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-characterize-OD}
Let $S$ be a scheme.
\begin{enumerate}
\item If $D \subset S$ is an effective Cartier divisor, then
the canonical section $1_D$ of $\mathcal{O}_S(D)$ is regular.
\item Conversely, if $s$ is a regular section of the invertible
sheaf $\mathcal{L}$, then there exists a unique effective
Cartier divisor $D = Z(s) \subset S$ and a unique isomorphism
$\mathcal{O}_S(D) \to \mathcal{L}$ which maps $1_D$ to $s$.
\end{enumerate}
The constructions
$D \mapsto (\mathcal{O}_X(D), 1_D)$ and $(\mathcal{L}, s) \mapsto Z(s)$
give mutually inverse maps
$$
\left\{
\begin{matrix}
\text{effective Cartier divisors on }X
\end{matrix}
\right\}
\leftrightarrow
\left\{
\begin{matrix}
\text{pairs }(\mathcal{L}, s)\text{ consisting of an invertible}\\
\mathcal{O}_X\text{-module and a regular global section}
\end{matrix}
\right\}
$$
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\noindent
Here is a way to produce effective Cartier divisors.

\begin{lemma}
\label{lemma-blowing-up-gives-effective-Cartier-divisor}
Let $X$ be a scheme.
Let $Z \subset X$ be a closed subscheme.
The blow up $b : X' \to X$ of $Z$
has the following properties:
\begin{enumerate}
\item $b|_{b^{-1}(X \setminus Z)} : b^{-1}(X \setminus Z) \to X \setminus Z$
is an isomorphism, and
\item $E = b^{-1}(Z)$ is an effective Cartier divisor on $X'$.
\end{enumerate}
\end{lemma}

\begin{proof}
Proof omitted. Here are some hints:
If $X = \text{Spec}(A)$ and $Z = \text{Spec}(A/I)$,
then $X' = \text{Proj}(\bigoplus_{n \geq 0} I^n)$.
Write $S = \bigoplus_{n \geq 0} I^n$ as a graded ring.
Pick an element $f \in I$ and denote $F \in S_1$ the
corresponding element in degree one of $S$. It is clear that
the standard opens $D_{+}(F)$ cover $X'$ in this case.
Each $D_{+}(F)$ is the spectrum of the ring $S_{(F)}$.
Note that $f$ is a nonzero divisor on $S_{(F)}$ since
$f a/F^d = 0$ (some $a \in S_d$)
implies also that $F a/F^{d + 1}$ is zero. Moreover,
$IS_{(F)}$ is generated by the elements
$g = fG/F$ where $G \in S_1$ is the degree $1$ element
of $S$ corresponding to $g$. Hence it is indeed the
case that $IS_{(F)}$ is generated by a single nonzero divisor as desired.
\end{proof}





\section{Effective Cartier divisors and morphisms}
\label{section-effective-Cartier-morphisms}

\noindent
The following lemma shows that an effective Cartier divisor which is
flat over the base is reall a ``family of effective Cartier divisors''
over the base. For example the restriction to any fibre is an effective
Cartier divisor.

\begin{lemma}
\label{lemma-relative-Cartier}
Let $f : X \to S$ be a morphism of schemes.
Let $D \subset X$ be a closed subscheme.
Assume
\begin{enumerate}
\item $D$ is an effective Cartier divisor, and
\item $D \to S$ is a flat morphism.
\end{enumerate}
Then for every morphism of schemes $g : S' \to S$ the pullback
$(g')^{-1}D$ is an effective Cartier divisor on $X' = S' \times_S X$.
\end{lemma}

\begin{proof}
Using
Lemma \ref{lemma-characterize-effective-Cartier-divisor}
this translates into the following algebra problem: Let $A \to B$ be a ring
map and $h \in B$. Assume $h$ is a nonzero divisor and that $B/hB$ is flat
over $A$. Then
$$
0 \to B \xrightarrow{h} B \to B/hB \to 0
$$
is a short exact sequence of $A$-modules with $B/hB$ flat over $A$. By
Algebra, Lemma \ref{algebra-lemma-flat-tor-zero}
this sequence remains exact on tensoring over $A$ with any module, in
particular with any $A$-algebra $A'$.
\end{proof}






\section{Meromorphic functions and sections}
\label{section-meromorphic-functions}

\noindent
See \cite{misconceptions} for some possible
pitfalls\footnote{Danger, Will Robinson!}.

\medskip\noindent
Let $(X, \mathcal{O}_X)$ be a locally ringed space.
For any open $U \subset X$ we have defined the set
$\mathcal{S}(U) \subset \mathcal{O}_X(U)$
of regular sections of $\mathcal{O}_X$ over $U$, see
Definition \ref{definition-regular-section}. The restriction
of a regular section to a smaller open is regular. Hence
$\mathcal{S} : U \mapsto \mathcal{S}(U)$ is a subsheaf (of sets)
of $\mathcal{O}_X$. We sometimes denote $\mathcal{S} = \mathcal{S}_X$
if we want to indicate the dependence on $X$.
Moreover, $\mathcal{S}(U)$
is a multiplicative subset of the ring $\mathcal{O}_X(U)$ for
each $U$. Hence we may consider
the presheaf of rings
$$
U \longmapsto \mathcal{S}(U)^{-1} \mathcal{O}_X(U),
$$
see Modules, Lemma \ref{modules-lemma-simple-invert}.

\begin{definition}
\label{definition-sheaf-meromorphic-functions}
Let $(X, \mathcal{O}_X)$ be a locally ringed space.
The {\it sheaf of meromorphic functions on $X$} is
the sheaf {\it $\mathcal{K}_X$} associated to the presheaf
displayed above. A {\it meromorphic function} on $X$
is a global section of $\mathcal{K}_X$.
\end{definition}

\noindent
Since each element of each $\mathcal{S}(U)$ is a nonzero divisor on
$\mathcal{O}_X(U)$ we see that the natural map of sheaves
of rings $\mathcal{O}_X \to \mathcal{K}_X$ is injective.

\begin{example}
\label{example-no-change}
Let $A = \mathbf{C}[x, \{y_\alpha\}_{\alpha \in \mathbf{C}}]/
((x - \alpha)y_\alpha, y_\alpha y_\beta)$. Any element of $A$
can be written uniquely as
$f(x) + \sum \lambda_\alpha y_\alpha$ with $f(x) \in \mathbf{C}[x]$
and $\lambda_\alpha \in \mathbf{C}$.
Let $X = \text{Spec}(A)$.
In this case $\mathcal{O}_X = \mathcal{K}_X$, since on
any affine open $D(f)$ the ring $A_f$ any nonzero divisor is
a unit (proof omitted).
\end{example}

\begin{definition}
\label{definition-pullback-meromorphic-sections}
Let $f : (X, \mathcal{O}_X) \to (Y, \mathcal{O}_Y)$ be a morphism
of locally ringed spaces. We say that {\it pulbacks of meromorphic
functions are defined for $f$} if for every pair of open
$U \subset X$, $V \subset Y$ such that $f(U) \subset V$, and any
section $s \in \Gamma(V, \mathcal{S}_Y)$ the pullback
$f^\sharp(s) \in \Gamma(U, \mathcal{O}_X)$ is an element
of $\Gamma(U, \mathcal{S}_X)$.
\end{definition}

\noindent
In this case there is an induced map
$f^\sharp : f^{-1}\mathcal{K}_Y \to \mathcal{K}_X$,
in other words we obtain a commutative diagram of morphisms
of ringed spaces
$$
\xymatrix{
(X, \mathcal{K}_X) \ar[r] \ar[d]^f &
(X, \mathcal{O}_X) \ar[d]^f \\
(Y, \mathcal{K}_Y) \ar[r] &
(Y, \mathcal{O}_X)
}
$$
We sometimes denote $f^*(s) = f^\sharp(s)$ for a
section $s \in \Gamma(Y, \mathcal{K}_Y)$.

\begin{lemma}
\label{lemma-pullback-meromorphic-sections-defined}
Let $f : X \to Y$ be a morphism of schemes.
In each of the following cases pullbacks of meromorphic
sections are defined.
\begin{enumerate}
\item $X$, $Y$ are integral and $f$ is dominant,
\item $X$ is integral and the generic point of $X$ maps
to a generic point of an irreducible component of $Y$,
\item $X$ is reduced and every generic point of every irreducible
component of $X$ maps to the generic point of an irreducible component
of $Y$,
\item $X$ is locally Noetherian, and any associated point of
$X$ maps to a generic point of an irreducible component of $Y$, and
\item $X$ is locally Noetherian, has no embedded points and
any generic point of an irreducible component of
$X$ maps to the generic point of an irreducible component of $Y$.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted. Hint: Similar to the proof of
Lemma \ref{lemma-pullback-effective-Cartier-defined}, using
the following fact (on $Y$): if an element $x \in R$ maps to
a nonzero divisor in $R_{\mathfrak p}$ for a minimal prime
$\mathfrak p$ of $R$, then $x \not \in \mathfrak p$.
See Algebra, Lemma \ref{algebra-lemma-minimal-prime-reduced-ring}.
\end{proof}

\noindent
Let $(X, \mathcal{O}_X)$ be a locally ringed space.
Let $\mathcal{F}$ be a sheaf of $\mathcal{O}_X$-modules.
Consider the presheaf $U \mapsto \mathcal{S}(U)^{-1}\mathcal{F}(U)$.
Its sheafification is the sheaf
$\mathcal{F} \otimes_{\mathcal{O}_X} \mathcal{K}_X$, see
Modules, Lemma \ref{modules-lemma-simple-invert-module}.

\begin{definition}
\label{definition-meromorphic-section}
Let $X$ be a locally ringed space.
Let $\mathcal{F}$ be a sheaf of $\mathcal{O}_X$-modules.
\begin{enumerate}
\item We denote
$\mathcal{K}_X(\mathcal{F})$
the sheaf of $\mathcal{K}_X$-modules which is
the sheafification of the presheaf
$U \mapsto \mathcal{S}(U)^{-1}\mathcal{F}(U)$. Equivalently
$\mathcal{K}_X(\mathcal{F}) =
\mathcal{F} \otimes_{\mathcal{O}_X} \mathcal{K}_X$ (see above).
\item A {\it meromorphic section of $\mathcal{F}$}
is a global section of $\mathcal{K}_X(\mathcal{F})$.
\end{enumerate}
\end{definition}

\noindent
In particular we have
$$
\mathcal{K}_X(\mathcal{F})_x
=
\mathcal{F}_x \otimes_{\mathcal{O}_{X, x}} \mathcal{K}_{X, x}
=
\mathcal{S}_x^{-1}\mathcal{F}_x
$$
for any point $x \in X$. However, one has to be careful since it may
not be the case that $\mathcal{S}_x$ is the set of nonzero divisors
in the local ring $\mathcal{O}_{X, x}$. Namely, there is always
an injective map
$$
\mathcal{K}_{X, x} \longrightarrow Q(\mathcal{O}_{X, x})
$$
to the total quotient ring. It is also surjective if and only if
$\mathcal{S}_x$ is the set of nonzero divisors in $\mathcal{O}_{X, x}$.

\begin{lemma}
\label{lemma-locally-Noetherian-K}
Let $X$ be a locally Noetherian scheme.
\begin{enumerate}
\item For any $x \in X$ we have $\mathcal{S}_x \subset \mathcal{O}_{X, x}$
is the set of nonzero divisors, and $\mathcal{K}_{X, x}$
is the total quotient ring of $\mathcal{O}_{X, x}$.
\item For any affine open $\text{Spec}(A) = U \subset X$ we have
that $\mathcal{K}_X(U)$ equals the total quotient ring of $A$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $A$ be a Noetherian ring.
Let $\mathfrak p \subset A$ be a prime ideal.
Let $f, g \in A$, $g \not \in \mathfrak p$.
Let $I = \{x \in A \mid fx = 0\}$.
Suppose $f/g$ is a nonzero divisor in $A_{\mathfrak p}$.
Then we see that $I_{\mathfrak p} = 0$ by exactness of
localization. Since $A$ is Noetherian we see that $I$
is finitely generated and hence that $g'I = 0$ for some $g' \in A$,
$g' \not \in \mathfrak p$. Hence $f$ is a nonzero divisor
in $A_{g'}$, i.e., in a Zariski open neighbourhood of $\mathfrak p$.
This proves (1).

\medskip\noindent
Let $f \in \Gamma(X, \mathcal{K}_{X, x})$ be a meromorphic function
on $X = \text{Spec}(A)$. Set $I = \{x \in A \mid xf \in A\}$.
For every prime $\mathfrak p \subset A$ we can write 
the image of $f$ in the stalk at $\mathfrak p$ as
$a/b$, $a, b \in A_{\mathfrak p}$ with $b \in A_{\mathfrak p}$
not a zero divisor. Hence, clearing denominators, we find there exists
an element $x \in I$ such that $x$ maps to a nonzero divisor on
$A_{\mathfrak p}$. Let
$\text{Ass}(A) = \{\mathfrak q_1, \ldots, \mathfrak q_t\}$ be the
associated primes of $A$. By looking at $IA_{\mathfrak q_i}$ and
using Algebra, Lemma \ref{algebra-lemma-associated-primes-localize}
the above says that
$I \not \subset \mathfrak q_i$ for each $i$. By
Algebra, Lemma \ref{algebra-lemma-silly}
there exists an element $x \in I$, $x \not \in \bigcup \mathfrak q_i$.
By Algebra, Lemma \ref{algebra-lemma-ass-zero-divisors}
we see that $x$ is not a zero divisor on $A$.
Hence $f = (xf)/x$ is an element of the total ring of fractions of $A$.
This proves (2).
\end{proof}

\begin{lemma}
\label{lemma-reduced-finite-irreducible}
Let $X$ be a scheme.
Assume $X$ is reduced and any quasi-compact open $U \subset X$
has a finite number of irreducible components.
\begin{enumerate}
\item The sheaf $\mathcal{K}_X$ is a quasi-coherent sheaf of
$\mathcal{O}_X$-algebras.
\item For any $x \in X$ we have $\mathcal{S}_x \subset \mathcal{O}_{X, x}$
is the set of nonzero divisors. In particular $\mathcal{K}_{X, x}$
is the total quotient ring of $\mathcal{O}_{X, x}$.
\item For any affine open $\text{Spec}(A) = U \subset X$ we have
that $\mathcal{K}_X(U)$ equals the total quotient ring of $A$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $X$ be as in the lemma. Let $X^{(0)} \subset X$ be the
set of generic points of irreducible components of $X$. Let
$$
f :
Y = \coprod\nolimits_{\eta \in X^{(0)}} \text{Spec}(\kappa(\eta))
\longrightarrow
X
$$
be the inclusion of the generic points into $X$ using the
canonical maps of Schemes, Section \ref{schemes-section-points}.
(This morphism was used in
Morphisms, Definition \ref{morphisms-definition-normalization}
to define the normalization of $X$.)
We claim that $\mathcal{K}_X = f_*\mathcal{O}_Y$.
First note that $\mathcal{K}_Y = \mathcal{O}_Y$ as $Y$ is a disjoint
union of spectra of field. Next, note that pullbacks of meromorphic
functions are defined for $f$, by
Lemma \ref{lemma-pullback-meromorphic-sections-defined}.
This gives a map
$$
\mathcal{K}_X \longrightarrow f_*\mathcal{O}_Y.
$$
Let $\text{Spec}(A) = U \subset X$ be an affine open.
Then $A$ is a reduced ring with finitely many minimal
primes $\mathfrak q_1, \ldots, \mathfrak q_t$. Then we have
$Q(A) = \prod A_{\mathfrak q_i} = \prod \kappa(\mathfrak q_i)$
by Algebra, Lemmas \ref{algebra-lemma-total-ring-fractions-no-embedded-points}
and \ref{algebra-lemma-minimal-prime-reduced-ring}.
In other words, already the value of the presheaf
$U \mapsto \mathcal{S}(U)^{-1}\mathcal{O}_X(U)$ agrees with
$f_*\mathcal{O}_Y(U)$ on our affine open $U$. Hence the displayed
map is an isomorphism.

\medskip\noindent
Now we are ready to prove (1), (2) and (3).
The morphism $f$ is quasi-compact by our assumption
that the set of irreducible components of $X$ is locally finite.
Hence $f$ is quasi-compact and quasi-separated (as $Y$ is separated).
By Schemes, Lemma \ref{schemes-lemma-push-forward-quasi-coherent}
$f_*\mathcal{O}_Y$ is quasi-coherent.
This proves (1). Let $x \in X$. Then
$$
(f_*\mathcal{O}_Y)_x
=
\prod\nolimits_{\eta \in X^{(0)},\ x \in \overline{\{\eta\}}} \kappa(\eta)
$$
On the other hand, $\mathcal{O}_{X, x}$
is reduced and has finitely minimal primes $\mathfrak q_i$ corresponding
exactly to those $\eta \in X^{(0)}$ such that
$x \in \overline{\{\eta\}} \kappa(\eta)$. Hence by
Algebra, Lemmas \ref{algebra-lemma-total-ring-fractions-no-embedded-points}
and \ref{algebra-lemma-minimal-prime-reduced-ring} again
we see that
$Q(\mathcal{O}_{X, x}) = \prod \kappa(\mathfrak q_i)$ is the
same as $(f_*\mathcal{O}_Y)_x$. This proves (2).
Part (3) we saw during the course of the proof that
$\mathcal{K}_X = f_*\mathcal{O}_Y$.
\end{proof}

\begin{lemma}
\label{lemma-reduced-normalization}
Let $X$ be a scheme.
Assume $X$ is reduced and any quasi-compact open $U \subset X$
has a finite number of irreducible components.
Then the normalization morphism $\nu : X^\nu \to X$ is the
morphism
$$
\underline{\text{Spec}}_X(\mathcal{O}') \longrightarrow X
$$
where $\mathcal{O}' \subset \mathcal{K}_X$ is the integral
closure of $\mathcal{O}_X$ in the sheaf of meromorphic functions.
\end{lemma}

\begin{proof}
Compare the definition of the normalization morphism
$\nu : X^\nu \to X$ (see
Morphisms, Definition \ref{morphisms-definition-normalization})
with the result $\mathcal{K}_X = f_*\mathcal{O}_Y$ obtained
in the proof of Lemma \ref{lemma-reduced-finite-irreducible} above.
\end{proof}

\begin{lemma}
\label{lemma-meromorphic-functions-integral-scheme}
Let $X$ be an integral scheme with generic point $\eta$. We have
\begin{enumerate}
\item the sheaf of meromorphic functions is
isomorphic to the constant sheaf with value the
function field (see
Morphisms, Definition \ref{morphisms-definition-function-field})
of $X$.
\item for any quasi-coherent sheaf $\mathcal{F}$ on $X$ the
sheaf $\mathcal{K}_X(\mathcal{F})$ is isomorphic to the
constant sheaf with value $\mathcal{F}_\eta$.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{definition}
\label{definition-regular-meromorphic-section}
Let $X$ be a locally ringed space.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
A meromorphic section $s$ of $\mathcal{L}$ is said to be {\it regular}
if the induced map
$\mathcal{K}_X \to \mathcal{K}_X(\mathcal{L})$
is injective. (In other words, this means that $s$ is a regular
section of the invertible $\mathcal{K}_X$-module
$\mathcal{K}_X(\mathcal{L})$. See
Definiton \ref{definition-regular-section}.)
\end{definition}

\noindent
First we spell out when (regular) meromorphic sections can be pulled back.
After that we discuss the existence of regular meromorphic sections
and consequences.

\begin{lemma}
\label{lemma-meromorphic-sections-pullback}
Let $f : X \to Y$ be a morphism of locally ringed spaces.
Assume that pullbacks of meromorphic functions are defined
for $f$ (see
Definition \ref{definition-pullback-meromorphic-sections}).
\begin{enumerate}
\item Let $\mathcal{F}$ be a sheaf of $\mathcal{O}_Y$-modules.
There is a canonical pullback map
$f^* : \Gamma(Y, \mathcal{K}_Y(\mathcal{F})) \to
\Gamma(X, \mathcal{F}_X(f^*\mathcal{F}))$
for meromorphic sections of $\mathcal{F}$.
\item Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
A regular meromorphic section $s$ of $\mathcal{L}$ pulls back
to a regular meromorphic section $f^*s$ of $f^*\mathcal{L}$.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted. 
\end{proof}

\noindent
In some cases we can show regular meromorphic sections exist.

\begin{lemma}
\label{lemma-regular-meromorphic-section-exists}
Let $X$ be a scheme.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
In each of the following cases $\mathcal{L}$ has a regular meromorphic
section:
\begin{enumerate}
\item $X$ is integral,
\item $X$ is reduced and any quasi-compact open has a finite
number of irreducible components, and
\item $X$ is locally Noetherian and has no embedded points.
\end{enumerate}
\end{lemma}

\begin{proof}
In case (1) we have seen in
Lemma \ref{lemma-meromorphic-functions-integral-scheme}
that $\mathcal{K}_X(\mathcal{L})$ is a constant sheaf
with value $\mathcal{L}_\eta$, and hence the result is clear.

\medskip\noindent
Suppose $X$ is a scheme. Let $G \subset X$ be the set of
generic points of irreducible components of $X$. For each $\eta \in G$
denote $j_\eta : \eta \to X$ the canonical morphism
of $\eta = \text{Spec}(\kappa(\eta))$ into $X$
(see Schemes, Lemma \ref{schemes-lemma-characterize-points}). Consider
the sheaf
$$
\mathcal{G}_X(\mathcal{L})
=
\prod\nolimits_{\eta \in G} j_{\eta, *}(\mathcal{L}_\eta).
$$
There is a canonical map
$$
\varphi :
\mathcal{K}_X(\mathcal{L})
\longrightarrow
\mathcal{G}_X(\mathcal{L})
$$
coming from the maps $\mathcal{K}_X(\mathcal{L})_\eta \to \mathcal{L}_\eta$
and adjunction (see
Sheaves, Lemma \ref{sheaves-lemma-stalk-skyscraper-adjoint}).

\medskip\noindent
We claim that in cases (2) and (3) the map $\varphi$ is an isomorphism
for any invertible sheaf $\mathcal{L}$.
Before proving this let us show that cases (2) and (3) follow from this.
Namely, we can choose $s_\eta \in \mathcal{L}_\eta$ which
generate $\mathcal{L}_\eta$, i.e., such that
$\mathcal{L}_\eta = \mathcal{O}_{X, \eta}s_\eta$.
Since the claim applied to $\mathcal{O}_X$ gives
$\mathcal{K}_X = \mathcal{G}_X(\mathcal{O}_X)$ it is
clear that the global section $s = \prod_{\eta \in G} s_\eta$
is regular as desired.

\medskip\noindent
To prove that $\varphi$ is an isomorphism we may work locally on $X$.
For example it suffices to show that sections of
$\mathcal{K}_X(\mathcal{L})$ and $\mathcal{G}_X(\mathcal{L})$
agree over small affine opens $U$. Say $U = \text{Spec}(A)$ and
$\mathcal{L}|_U \cong \mathcal{O}_U$. By
Lemmas \ref{lemma-locally-Noetherian-K} and
\ref{lemma-reduced-finite-irreducible}
we see that $\Gamma(U, \mathcal{K}_X) = Q(A)$ is
the total ring of fractions of $A$. On the other hand,
$\Gamma(U, \mathcal{G}_X(\mathcal{O}_X)) =
\prod_{\mathfrak q \subset A \text{ minimal}} A_{\mathfrak q}$.
In both cases we see that the set of minimal primes of $A$
is finite, say $\mathfrak q_1, \ldots, \mathfrak q_t$,
and that the set of zero divisors of $A$ is equal to
$\mathfrak q_1 \cup \ldots \cup \mathfrak q_t$ (see
Algebra, Lemma \ref{algebra-lemma-ass-zero-divisors}).
Hence the result follows from
Algebra, Lemma \ref{algebra-lemma-total-ring-fractions-no-embedded-points}.
\end{proof}

\begin{lemma}
\label{lemma-regular-meromorphic-ideal-denominators}
Let $X$ be a scheme.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
Let $s$ be a regular meromorphic section of $\mathcal{L}$.
Let us denote $\mathcal{I} \subset \mathcal{O}_X$ the
sheaf of ideals defined by the rule
$$
\mathcal{I}(V)
=
\{f \in \mathcal{O}_Z(V) \mid fs \in \mathcal{L}(V)\}.
$$
The formula makes sense since
$\mathcal{L}(V) \subset \mathcal{K}_X(\mathcal{L})(V)$.
Then $\mathcal{I}$ is a quasi-coherent sheaf of ideals and
we have injective maps
$$
1 : \mathcal{I} \longrightarrow \mathcal{O}_X,
\quad
s : \mathcal{I} \longrightarrow \mathcal{L}
$$
whose cokernels are supported on closed nowhere dense subsets of $X$.
\end{lemma}

\begin{proof}
The question is local on $X$.
Hence we may assume that $X = \text{Spec}(A)$,
and $\mathcal{L} = \mathcal{O}_X$. After shrinking furhter
we may assume that $s = x/y$ with $a, b \in A$ {\it both}
nonzero divisors in $A$. Set $I = \{x \in A \mid x(a/b) \in A\}$.

\medskip\noindent
To show that $\mathcal{I}$ is quasi-coherent we have to show
that $I_f = \{x \in A_f \mid x(a/b) \in A_f\}$ for every
$f \in A$. If $c/f^n \in A_f$, $(c/f^n)(a/b) \in A_f$, then we see
that $f^mc(a/b) \in A$ for some $m$, hence $c/f^n \in I_f$.
Conversely it is easy to see that $I_f$ is contained in
$\{x \in A_f \mid x(a/b) \in A_f\}$. This proves quasi-coherence.

\medskip\noindent
Let us prove the final statement. It is clear that $(b) \subset I$.
Hence $V(I) \subset V(b)$ is a nowhere dense subset as $b$ is
a nonzero divisor. Thus the cokernel of $1$ is supported in a nowhere
dense closed set. The same argument works for the cokerenel
of $s$ since $s(b) = (a) \subset sI \subset A$.
\end{proof}

\begin{definition}
\label{definition-regular-meromorphic-ideal-denominators}
Let $X$ be a scheme.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
Let $s$ be a regular meromorphic section of $\mathcal{L}$.
The sheaf of ideals $\mathcal{I}$ constructed in
Lemma \ref{lemma-regular-meromorphic-ideal-denominators}
is called the {\it ideal sheaf of denominators of $s$}.
\end{definition}

\noindent
Here is a lemma which will be used later.

\begin{lemma}
\label{lemma-make-maps-regular-section}
Suppose given
\begin{enumerate}
\item $X$ a locally Noetherian scheme,
\item $\mathcal{L}$ an invertible $\mathcal{O}_X$-module,
\item $s$ a regular meromorphic section of $\mathcal{L}$, and
\item $\mathcal{F}$ coherent on $X$
without embedded associated points and $\text{Supp}(\mathcal{F}) = X$.
\end{enumerate}
Let $\mathcal{I} \subset \mathcal{O}_X$ be the ideal of
denominators of $s$. Let $T \subset X$ be the union
of the supports of $\mathcal{O}_X/\mathcal{I}$ and
$\mathcal{L}/s(\mathcal{I})$ which is a nowhere dense closed
subset $T \subset X$ according to
Lemma \ref{lemma-regular-meromorphic-ideal-denominators}.
Then there are canonical injective maps
$$
1 : \mathcal{I}\mathcal{F} \to \mathcal{F},\quad
s : \mathcal{I}\mathcal{F} \to \mathcal{F}\otimes_{\mathcal{O}_X}\mathcal{L}
$$
whose cokernels are supported on $T$.
\end{lemma}

\begin{proof}
Reduce to the affine case with $\mathcal{L} \cong \mathcal{O}_X$,
and $s = a/b$ with $a, b \in A$ both nonzero divisors.
Proof of reduction step omitted.
Write $\mathcal{F} = \widetilde{M}$.
Let $I = \{x \in A \mid x(a/b) \in A\}$
so that $\mathcal{I} = \widetilde{I}$ (see
proof of Lemma \ref{lemma-regular-meromorphic-ideal-denominators}).
Note that $T = V(I) \cup V((a/b)I)$.
For any $A$-module $M$ consider the map $1 : IM \to M$; this is the
map that gives rise to the map $1$ of the lemma.
Consider on the other hand the map
$\sigma : IM \to M_b, x \mapsto ax/b$.
Since $b$ is not a zero divisor in $A$, and since
$M$ has support $\text{Spec}(A)$ and no embedded primes we
see that $b$ is a nonzero divisor on $M$ also. Hence $M \subset M_b$.
By definition of $I$ we have $\sigma(IM) \subset M$ as submodules
of $M_b$. Hence we get an $A$-module map $s : IM \to M$ (namely the
unique map such that $s(z)/1 = \sigma(z)$ in $M_b$ for all $z \in IM$).
It is injective because $a$ is a nonzero divisor also (on both $A$ and $M$).
It is clear that $M/IM$ is annihilated by $I$ and that
$M/s(IM)$ is annihilated by $(a/b)I$. Thus the lemma follows.
\end{proof}


















\input{chapters}

\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}
