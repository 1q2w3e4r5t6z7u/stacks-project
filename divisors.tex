\input{preamble}

% OK, start here.
%
\begin{document}

\title{Divisors}


\maketitle

\phantomsection
\label{section-phantom}

\tableofcontents

\section{Introduction}
\label{section-introduction}

\noindent
In this chapter we study some very basic questions related
to defining divisors, etc. A basic reference is \cite{EGA}.



\section{Associated points}
\label{section-associated}

\noindent
Let $R$ be a ring and let $M$ be an $R$-module.
Recall that a prime $\mathfrak p \subset R$ is {\it associated} to $M$
if there exists an element of $M$ whose annihilator is $\mathfrak p$.
See Algebra, Definition \ref{algebra-definition-associated}.
Here is the definition of associated points
for quasi-coherent sheaves on schemes
as given in \cite[IV Definition 3.1.1]{EGA}.

\begin{definition}
\label{definition-associated}
Let $X$ be a scheme.
Let $\mathcal{F}$ be a quasi-coherent sheaf on $X$.
\begin{enumerate}
\item We say $x \in X$ is {\it associated} to $\mathcal{F}$
if the maximal ideal
$\mathfrak m_x$ is associated to the $\mathcal{O}_{X, x}$-module
$\mathcal{F}_x$.
\item We denote $\text{Ass}(\mathcal{F})$ or $\text{Ass}_X(\mathcal{F})$
the set of associated points of $\mathcal{F}$.
\item The {\it associated points of $X$} are the associated
points of $\mathcal{O}_X$.
\end{enumerate}
\end{definition}

\noindent
These definitions are most useful when $X$ is locally Noetherian
and $\mathcal{F}$ of finite type.
For example it may happen that a generic point of an irreducible
component of $X$ is not associated to $X$, see
Example \ref{example-no-associated-prime}.
In the non-Noetherian case it may be more convenient to use weakly
associated points, see
Section \ref{section-weakly-associated}.
Let us link the scheme theoretic notion with the algebraic notion
on affine opens; note that this correspondence works perfectly only
for locally Noetherian schemes.

\begin{lemma}
\label{lemma-associated-affine-open}
Let $X$ be a scheme. Let $\mathcal{F}$ be a quasi-coherent sheaf on $X$.
Let $\Spec(A) = U \subset X$ be an affine open, and set
$M = \Gamma(U, \mathcal{F})$.
Let $x \in U$, and let $\mathfrak p \subset A$ be the corresponding prime.
\begin{enumerate}
\item If $\mathfrak p$ is associated to $M$, then $x$ is associated
to $\mathcal{F}$.
\item If $\mathfrak p$ is finitely generated, then the coverse holds
as well.
\end{enumerate}
In particular, if $X$ is locally Noetherian, then the equivalence
$$
\mathfrak p \in \text{Ass}(M) \Leftrightarrow x \in \text{Ass}(\mathcal{F})
$$
holds for all pairs $(\mathfrak p, x)$ as above.
\end{lemma}

\begin{proof}
This follows from
Algebra, Lemma \ref{algebra-lemma-associated-primes-localize}.
But we can also argue directly as follows.
Suppose $\mathfrak p$ is associated to $M$.
Then there exists an $m \in M$ whose annihilator is $\mathfrak p$.
Since localization is exact we see that
$\mathfrak pA_{\mathfrak p}$ is the annihilator of
$m/1 \in M_{\mathfrak p}$. Since $M_{\mathfrak p} = \mathcal{F}_x$
(Schemes, Lemma \ref{schemes-lemma-spec-sheaves})
we conclude that $x$ is associated to $\mathcal{F}$.

\medskip\noindent
Conversely, assume that $x$ is associated to $\mathcal{F}$,
and $\mathfrak p$ is finitely generated.
As $x$ is associated to $\mathcal{F}$
there exists an element $m' \in M_{\mathfrak p}$ whose
annihilator is $\mathfrak pA_{\mathfrak p}$. Write
$m' = m/f$ for some $f \in A$, $f \not \in \mathfrak p$.
The annihilator $I$ of $m$ is an ideal of $A$ such that
$IA_{\mathfrak p} = \mathfrak pA_{\mathfrak p}$. Hence
$I \subset \mathfrak p$, and $(\mathfrak p/I)_{\mathfrak p} = 0$.
Since $\mathfrak p$ is finitely generated,
there exists a $g \in A$, $g \not \in \mathfrak p$ such that
$g(\mathfrak p/I) = 0$. Hence the annihilator of $gm$ is
$\mathfrak p$ and we win.

\medskip\noindent
If $X$ is locally Noetherian, then $A$ is Noetherian
(Properties, Lemma \ref{properties-lemma-locally-Noetherian})
and $\mathfrak p$ is always finitely generated.
\end{proof}

\begin{lemma}
\label{lemma-ass-support}
Let $X$ be a scheme.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
Then $\text{Ass}(\mathcal{F}) \subset \text{Supp}(\mathcal{F})$.
\end{lemma}

\begin{proof}
This is immediate from the definitions.
\end{proof}

\begin{lemma}
\label{lemma-ses-ass}
Let $X$ be a scheme.
Let $0 \to \mathcal{F}_1 \to \mathcal{F}_2 \to \mathcal{F}_3 \to 0$
be a short exact sequence of quasi-coherent sheaves on $X$.
Then
$\text{Ass}(\mathcal{F}_2) \subset
\text{Ass}(\mathcal{F}_1) \cup \text{Ass}(\mathcal{F}_3)$
and
$\text{Ass}(\mathcal{F}_1) \subset \text{Ass}(\mathcal{F}_2)$.\
\end{lemma}

\begin{proof}
For every point $x \in X$ the sequence of stalks
$0 \to \mathcal{F}_{1, x} \to \mathcal{F}_{2, x} \to \mathcal{F}_{3, x} \to 0$
is a short exact sequence of $\mathcal{O}_{X, x}$-modules.
Hence the lemma follows from
Algebra, Lemma \ref{algebra-lemma-ass}.
\end{proof}

\begin{lemma}
\label{lemma-finite-ass}
Let $X$ be a locally Noetherian scheme.
Let $\mathcal{F}$ be a coherent $\mathcal{O}_X$-module.
Then $\text{Ass}(\mathcal{F}) \cap U$ is finite for
every quasi-compact open $U \subset X$.
\end{lemma}

\begin{proof}
This is true because the set of associated primes of a finite module over
a Noetherian ring is finite, see
Algebra, Lemma \ref{algebra-lemma-finite-ass}.
To translate from schemes to algebra use that $U$ is a finite union of
affine opens, each of these opens is the spectrum of a Noetherian ring
(Properties, Lemma \ref{properties-lemma-locally-Noetherian}),
$\mathcal{F}$ corresponds to a finite module over this ring
(Cohomology of Schemes, Lemma \ref{coherent-lemma-coherent-Noetherian}),
and finally use
Lemma \ref{lemma-associated-affine-open}.
\end{proof}

\begin{lemma}
\label{lemma-ass-zero}
Let $X$ be a locally Noetherian scheme. Let $\mathcal{F}$ be a
quasi-coherent $\mathcal{O}_X$-module. Then
$$
\mathcal{F} = 0 \Leftrightarrow \text{Ass}(\mathcal{F}) = \emptyset.
$$
\end{lemma}

\begin{proof}
If $\mathcal{F} = 0$, then $\text{Ass}(\mathcal{F}) = \emptyset$
by definition. Conversely, if $\text{Ass}(\mathcal{F}) = \emptyset$,
then $\mathcal{F} = 0$ by
Algebra, Lemma \ref{algebra-lemma-ass-zero}.
To translate from schemes to algebra, restrict to any affine and use
Lemma \ref{lemma-associated-affine-open}.
\end{proof}

\begin{example}
\label{example-no-associated-prime}
Let $k$ be a field. The ring $R = R[x_1, x_2, x_3, \ldots]/(x_i^2)$
is local with locally nilpotent maximal ideal $\mathfrak m$.
There exists no element of $R$ which has annihilator $\mathfrak m$.
Hence $\text{Ass}(R) = \emptyset$, and $X = \Spec(R)$
is an example of a scheme which has no associated points.
\end{example}

\begin{lemma}
\label{lemma-minimal-support-in-ass}
Let $X$ be a locally Noetherian scheme.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
Let $x \in \text{Supp}(\mathcal{F})$ be a point in the support
of $\mathcal{F}$ which is not a specialization of another point of
$\text{Supp}(\mathcal{F})$. Then $x \in \text{Ass}(\mathcal{F})$.
In particular, any generic point of an irreducible component of $X$
is an associated point of $X$.
\end{lemma}

\begin{proof}
Since $x \in \text{Supp}(\mathcal{F})$ the module $\mathcal{F}_x$
is not zero. Hence
$\text{Ass}(\mathcal{F}_x) \subset \Spec(\mathcal{O}_{X, x})$
is nonempty by
Algebra, Lemma \ref{algebra-lemma-ass-zero}.
On the other hand, by assumption
$\text{Supp}(\mathcal{F}_x) = \{\mathfrak m_x\}$.
Since
$\text{Ass}(\mathcal{F}_x) \subset \text{Supp}(\mathcal{F}_x)$
(Algebra, Lemma \ref{algebra-lemma-ass-support})
we see that $\mathfrak m_x$ is associated to $\mathcal{F}_x$
and we win.
\end{proof}






\section{Morphisms and associated points}
\label{section-morphisms-associated}

\begin{lemma}
\label{lemma-bourbaki}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{F}$ be a quasi-coherent sheaf on $X$ which is flat over $S$.
Let $\mathcal{G}$ be a quasi-coherent sheaf on $S$.
Then we have
$$
\text{Ass}_X(\mathcal{F} \otimes_{\mathcal{O}_X} f^*\mathcal{G})
\supset
\bigcup\nolimits_{s \in \text{Ass}_S(\mathcal{G})}
\text{Ass}_{X_s}(\mathcal{F}_s)
$$
and equality holds if $S$ is locally Noetherian.
\end{lemma}

\begin{proof}
Let $x \in X$ and let $s = f(x) \in S$.
Set $B = \mathcal{O}_{X, x}$, $A = \mathcal{O}_{S, s}$,
$N = \mathcal{F}_x$, and $M = \mathcal{G}_s$.
Note that the stalk of $\mathcal{F} \otimes_{\mathcal{O}_X} f^*\mathcal{G}$
at $x$ is equal to the $B$-module $M \otimes_A N$. Hence
$x \in \text{Ass}_X(\mathcal{F} \otimes_{\mathcal{O}_X} f^*\mathcal{G})$
if and only if $\mathfrak m_B$ is in $\text{Ass}_B(M \otimes_A N)$.
Similarly $s \in \text{Ass}_S(\mathcal{G})$ and
$x \in \text{Ass}_{X_s}(\mathcal{F}_s)$ if and only if
$\mathfrak m_A \in \text{Ass}_A(M)$ and
$\mathfrak m_B/\mathfrak m_A B \in
\text{Ass}_{B \otimes \kappa(\mathfrak m_A)}(N \otimes \kappa(\mathfrak m_A))$.
Thus the lemma follows from
Algebra, Lemma \ref{algebra-lemma-bourbaki-fibres}.
\end{proof}





\section{Embedded points}
\label{section-embedded}

\noindent
Let $R$ be a ring and let $M$ be an $R$-module.
Recall that a prime $\mathfrak p \subset R$ is an
{\it embedded associated} to $M$ if it is an associated prime of
$M$ which is not minimal among the associated primes of $M$. See
Algebra, Definition \ref{algebra-definition-embedded-primes}.
Here is the definition of embedded associated points
for quasi-coherent sheaves on schemes
as given in \cite[IV Definition 3.1.1]{EGA}.

\begin{definition}
\label{definition-embedded}
Let $X$ be a scheme.
Let $\mathcal{F}$ be a quasi-coherent sheaf on $X$.
\begin{enumerate}
\item An {\it embedded associated point} of $\mathcal{F}$
is an associated point which is not maximal among the
associated points of $\mathcal{F}$, i.e., it is the specialization
of another associated point of $\mathcal{F}$.
\item A point $x$ of $X$ is called an {\it embedded point}
if $x$ is an embedded associated point of $\mathcal{O}_X$.
\item An {\it embedded component} of $X$ is an irreducible
closed subset $Z = \overline{\{x\}}$ where $x$ is an embedded
point of $X$.
\end{enumerate}
\end{definition}

\noindent
In the Noetherian case when $\mathcal{F}$ is coherent we have
the following.

\begin{lemma}
\label{lemma-embedded}
Let $X$ be a locally Noetherian scheme.
Let $\mathcal{F}$ be a coherent $\mathcal{O}_X$-module.
Then
\begin{enumerate}
\item the generic points of irreducible components of
$\text{Supp}(\mathcal{F})$ are associated points of $\mathcal{F}$, and
\item an associated point of $\mathcal{F}$ is embedded if and only
if it is not a generic point of an irreducible component
of $\text{Supp}(\mathcal{F})$.
\end{enumerate}
In particular an embedded point of $X$ is an associated point of $X$
which is not a generic point of an irreducible component of $X$.
\end{lemma}

\begin{proof}
Recall that in this case $Z = \text{Supp}(\mathcal{F})$ is closed, see
Morphisms, Lemma \ref{morphisms-lemma-support-finite-type}
and that the generic points of irreducible components of $Z$ are
associated points of $\mathcal{F}$, see
Lemma \ref{lemma-minimal-support-in-ass}.
Finally, we have $\text{Ass}(\mathcal{F}) \subset Z$, by
Lemma \ref{lemma-ass-support}.
These results, combined with the fact that $Z$ is a sober topological
space and hence every point of $Z$ is a specialization of a generic
point of $Z$, imply (1) and (2).
\end{proof}

\begin{lemma}
\label{lemma-S1-no-embedded}
Let $X$ be a locally Noetherian scheme.
Let $\mathcal{F}$ be a coherent sheaf on $X$.
Then the following are equivalent:
\begin{enumerate}
\item $\mathcal{F}$ has no embedded associated points, and
\item $\mathcal{F}$ has property $(S_1)$.
\end{enumerate}
\end{lemma}

\begin{proof}
This is Algebra, Lemma \ref{algebra-lemma-criterion-no-embedded-primes},
combined with Lemma \ref{lemma-associated-affine-open} above.
\end{proof}

\begin{lemma}
\label{lemma-remove-embedded-points}
Let $X$ be a locally Noetherian scheme.
Let $\mathcal{F}$ be a coherent sheaf on $X$.
The set of coherent subsheaves
$$
\{
\mathcal{K} \subset \mathcal{F}
\mid
\text{Supp}(\mathcal{K})\text{ is nowhere dense in }\text{Supp}(\mathcal{F})
\}
$$
has a maximal element $\mathcal{K}$.
Setting $\mathcal{F}' = \mathcal{F}/\mathcal{K}$ we have the
following
\begin{enumerate}
\item $\text{Supp}(\mathcal{F}') = \text{Supp}(\mathcal{F})$,
\item $\mathcal{F}'$ has no embedded associated points, and
\item there exists a dense open $U \subset X$ such that
$U \cap \text{Supp}(\mathcal{F})$ is dense in $\text{Supp}(\mathcal{F})$
and $\mathcal{F}'|_U \cong \mathcal{F}|_U$.
\end{enumerate}
\end{lemma}

\begin{proof}
This follows from
Algebra, Lemmas \ref{algebra-lemma-remove-embedded-primes} and
\ref{algebra-lemma-remove-embedded-primes-localize}.
Note that $U$ can be taken as the complement of the closure
of the set of embedded associated points of $\mathcal{F}$.
\end{proof}

\begin{lemma}
\label{lemma-no-embedded-points-endos}
Let $X$ be a locally Noetherian scheme.
Let $\mathcal{F}$ be a coherent $\mathcal{O}_X$-module
without embedded associated points. Set
$$
\mathcal{I}
=
\text{Ker}(\mathcal{O}_X
\longrightarrow
\SheafHom_{\mathcal{O}_X}(\mathcal{F}, \mathcal{F})).
$$
This is a coherent sheaf of ideals which defines a closed
subscheme $Z \subset X$ without embedded points. Moreover
there exists a coherent sheaf $\mathcal{G}$ on $Z$
such that (a) $\mathcal{F} = (Z \to X)_*\mathcal{G}$,
(b) $\mathcal{G}$ has no associated embedded points, and
(c) $\text{Supp}(\mathcal{G}) = Z$ (as sets).
\end{lemma}

\begin{proof}
Some of the statements we have seen in the proof of
Cohomology of Schemes, Lemma \ref{coherent-lemma-coherent-support-closed}.
The others follow from
Algebra, Lemma \ref{algebra-lemma-no-embedded-primes-endos}.
\end{proof}



\section{Weakly associated points}
\label{section-weakly-associated}

\noindent
Let $R$ be a ring and let $M$ be an $R$-module.
Recall that a prime $\mathfrak p \subset R$ is {\it weakly associated}
to $M$ if there exists an element $m$ of $M$ such that $\mathfrak p$ is
minimal among the primes containing the annihilator of $m$. See
Algebra, Definition \ref{algebra-definition-weakly-associated}.
If $R$ is a local ring with maximal ideal $\mathfrak m$, then
$\mathfrak m$ is associated to $M$ if and only if there exists an
element $m \in M$ whose annihilator has radical $\mathfrak m$, see
Algebra, Lemma \ref{algebra-lemma-weakly-ass-local}.

\begin{definition}
\label{definition-weakly-associated}
Let $X$ be a scheme.
Let $\mathcal{F}$ be a quasi-coherent sheaf on $X$.
\begin{enumerate}
\item We say $x \in X$ is {\it weakly associated} to $\mathcal{F}$
if the maximal ideal $\mathfrak m_x$ is weakly associated to the
$\mathcal{O}_{X, x}$-module $\mathcal{F}_x$.
\item We denote $\text{WeakAss}(\mathcal{F})$ the set of weakly associated
points of $\mathcal{F}$.
\item The {\it weakly associated points of $X$} are the weakly associated
points of $\mathcal{O}_X$.
\end{enumerate}
\end{definition}

\noindent
In this case, on any affine open, this corresponds exactly to the
weakly associated primes as defined above. Here is the precise statement.

\begin{lemma}
\label{lemma-weakly-associated-affine-open}
Let $X$ be a scheme. Let $\mathcal{F}$ be a quasi-coherent sheaf on $X$.
Let $\Spec(A) = U \subset X$ be an affine open, and set
$M = \Gamma(U, \mathcal{F})$.
Let $x \in U$, and let $\mathfrak p \subset A$ be the corresponding prime.
The following are equivalent
\begin{enumerate}
\item $\mathfrak p$ is weakly associated to $M$, and
\item $x$ is weakly associated to $\mathcal{F}$.
\end{enumerate}
\end{lemma}

\begin{proof}
This follows from
Algebra, Lemma \ref{algebra-lemma-weakly-ass-local}.
\end{proof}

\begin{lemma}
\label{lemma-weakly-ass-support}
Let $X$ be a scheme.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
Then
$$
\text{Ass}(\mathcal{F}) \subset \text{WeakAss}(\mathcal{F}) \subset
\text{Supp}(\mathcal{F}).
$$
\end{lemma}

\begin{proof}
This is immediate from the definitions.
\end{proof}

\begin{lemma}
\label{lemma-ses-weakly-ass}
Let $X$ be a scheme.
Let $0 \to \mathcal{F}_1 \to \mathcal{F}_2 \to \mathcal{F}_3 \to 0$
be a short exact sequence of quasi-coherent sheaves on $X$.
Then
$\text{WeakAss}(\mathcal{F}_2) \subset
\text{WeakAss}(\mathcal{F}_1) \cup \text{WeakAss}(\mathcal{F}_3)$
and
$\text{WeakAss}(\mathcal{F}_1) \subset \text{WeakAss}(\mathcal{F}_2)$.\
\end{lemma}

\begin{proof}
For every point $x \in X$ the sequence of stalks
$0 \to \mathcal{F}_{1, x} \to \mathcal{F}_{2, x} \to \mathcal{F}_{3, x} \to 0$
is a short exact sequence of $\mathcal{O}_{X, x}$-modules.
Hence the lemma follows from
Algebra, Lemma \ref{algebra-lemma-weakly-ass}.
\end{proof}

\begin{lemma}
\label{lemma-weakly-ass-zero}
Let $X$ be a scheme.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
Then
$$
\mathcal{F} = (0) \Leftrightarrow \text{WeakAss}(\mathcal{F}) = \emptyset
$$
\end{lemma}

\begin{proof}
Follows from
Lemma \ref{lemma-weakly-associated-affine-open}
and
Algebra, Lemma \ref{algebra-lemma-weakly-ass-zero}
\end{proof}

\begin{lemma}
\label{lemma-minimal-support-in-weakly-ass}
Let $X$ be a scheme.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
Let $x \in \text{Supp}(\mathcal{F})$ be a point in the support
of $\mathcal{F}$ which is not a specialization of another point of
$\text{Supp}(\mathcal{F})$. Then
$x \in \text{WeakAss}(\mathcal{F})$.
In particular, any generic point of an irreducible component of $X$
is weakly associated to $\mathcal{O}_X$.
\end{lemma}

\begin{proof}
Since $x \in \text{Supp}(\mathcal{F})$ the module $\mathcal{F}_x$
is not zero. Hence
$\text{WeakAss}(\mathcal{F}_x) \subset \Spec(\mathcal{O}_{X, x})$
is nonempty by
Algebra, Lemma \ref{algebra-lemma-weakly-ass-zero}.
On the other hand, by assumption
$\text{Supp}(\mathcal{F}_x) = \{\mathfrak m_x\}$.
Since
$\text{WeakAss}(\mathcal{F}_x) \subset \text{Supp}(\mathcal{F}_x)$
(Algebra, Lemma \ref{algebra-lemma-weakly-ass-support})
we see that $\mathfrak m_x$ is weakly associated to $\mathcal{F}_x$
and we win.
\end{proof}

\begin{lemma}
\label{lemma-ass-weakly-ass}
Let $X$ be a scheme.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
If $\mathfrak m_x$ is a finitely generated ideal of $\mathcal{O}_{X, x}$,
then
$$
x \in \text{Ass}(\mathcal{F}) \Leftrightarrow
x \in \text{WeakAss}(\mathcal{F}).
$$
In particular, if $X$ is locally Noetherian, then
$\text{Ass}(\mathcal{F}) = \text{WeakAss}(\mathcal{F})$.
\end{lemma}

\begin{proof}
See
Algebra, Lemma \ref{algebra-lemma-ass-weakly-ass}.
\end{proof}



\section{Morphisms and weakly associated points}
\label{section-morphisms-weakly-associated}

\begin{lemma}
\label{lemma-weakly-ass-reverse-functorial}
Let $f : X \to S$ be an affine morphism of schemes.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
Then we have
$$
\text{WeakAss}_S(f_*\mathcal{F}) \subset f(\text{WeakAss}_X(\mathcal{F}))
$$
\end{lemma}

\begin{proof}
We may assume $X$ and $S$ affine, so $X \to S$ comes from a ring map
$A \to B$. Then $\mathcal{F} = \widetilde M$ for some $B$-module $M$. By
Lemma \ref{lemma-weakly-associated-affine-open}
the weakly associated points of $\mathcal{F}$ correspond exactly to the
weakly associated primes of $M$. Similarly, the weakly associated points
of $f_*\mathcal{F}$ correspond exactly to the weakly associated primes
of $M$ as an $A$-module. Hence the lemma follows from
Algebra, Lemma \ref{algebra-lemma-weakly-ass-reverse-functorial}.
\end{proof}

\begin{lemma}
\label{lemma-ass-functorial-equal}
Let $f : X \to S$ be an affine morphism of schemes.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
If $X$ is locally Noetherian, then we have
$$
f(\text{Ass}_X(\mathcal{F})) =
\text{Ass}_S(f_*\mathcal{F}) =
\text{WeakAss}_S(f_*\mathcal{F}) =
f(\text{WeakAss}_X(\mathcal{F}))
$$
\end{lemma}

\begin{proof}
We may assume $X$ and $S$ affine, so $X \to S$ comes from a ring map
$A \to B$. As $X$ is locally Noetherian the ring $B$ is Noetherian, see
Properties, Lemma \ref{properties-lemma-locally-Noetherian}.
Write $\mathcal{F} = \widetilde M$ for some $B$-module $M$. By
Lemma \ref{lemma-associated-affine-open}
the associated points of $\mathcal{F}$ correspond exactly to the associated
primes of $M$, and any associated prime of $M$ as an $A$-module is an
associated points of $f_*\mathcal{F}$.
Hence the inclusion
$$
f(\text{Ass}_X(\mathcal{F})) \subset \text{Ass}_S(f_*\mathcal{F})
$$
follows from
Algebra, Lemma \ref{algebra-lemma-ass-functorial-Noetherian}.
We have the inclusion
$$
\text{Ass}_S(f_*\mathcal{F}) \subset \text{WeakAss}_S(f_*\mathcal{F})
$$
by
Lemma \ref{lemma-weakly-ass-support}.
We have the inclusion
$$
\text{WeakAss}_S(f_*\mathcal{F}) \subset f(\text{WeakAss}_X(\mathcal{F}))
$$
by
Lemma \ref{lemma-weakly-ass-reverse-functorial}.
The outer sets are equal by
Lemma \ref{lemma-ass-weakly-ass}
hence we have equality everywhere.
\end{proof}

\begin{lemma}
\label{lemma-weakly-associated-finite}
Let $f : X \to S$ be a finite morphism of schemes.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
Then $\text{WeakAss}(f_*\mathcal{F}) = f(\text{WeakAss}(\mathcal{F}))$.
\end{lemma}

\begin{proof}
We may assume $X$ and $S$ affine, so $X \to S$ comes from a finite ring map
$A \to B$. Write $\mathcal{F} = \widetilde M$ for some $B$-module $M$. By
Lemma \ref{lemma-weakly-associated-affine-open}
the weakly associated points of $\mathcal{F}$ correspond exactly to the
weakly associated primes of $M$. Similarly, the weakly associated points
of $f_*\mathcal{F}$ correspond exactly to the weakly associated primes
of $M$ as an $A$-module. Hence the lemma follows from
Algebra, Lemma \ref{algebra-lemma-weakly-ass-finite-ring-map}.
\end{proof}

\begin{lemma}
\label{lemma-weakly-ass-pullback}
Let $f : X \to S$ be a morphism of schemes. Let $\mathcal{G}$ be a
quasi-coherent $\mathcal{O}_S$-module. Let $x \in X$ with $s = f(x)$.
If $f$ is flat at $x$, the point $x$ is a generic point of the fibre $X_s$, and
$s \in \text{WeakAss}_S(\mathcal{G})$, then
$x \in \text{WeakAss}(f^*\mathcal{G})$.
\end{lemma}

\begin{proof}
Let $A = \mathcal{O}_{S, s}$, $B = \mathcal{O}_{X, x}$, and
$M = \mathcal{G}_s$. Let $m \in M$ be an element whose annihilator
$I = \{a \in A \mid am = 0\}$ has radical $\mathfrak m_A$. Then
$m \otimes 1$ has annihilator $I B$ as $A \to B$ is
faithfully flat. Thus it suffices to see that $\sqrt{I B} = \mathfrak m_B$.
This follows from the fact that the maximal ideal of $B/\mathfrak m_AB$
is locally nilpotent (see
Algebra, Lemma \ref{algebra-lemma-minimal-prime-reduced-ring})
and the assumption that $\sqrt{I} = \mathfrak m_A$.
Some details omitted.
\end{proof}








\section{Relative assassin}
\label{section-relative-assassin}

\begin{definition}
\label{definition-relative-assassin}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
The {\it relative assassin of $\mathcal{F}$ in $X$ over $S$}
is the set
$$
\text{Ass}_{X/S}(\mathcal{F}) =
\bigcup\nolimits_{s \in S} \text{Ass}_{X_s}(\mathcal{F}_s)
$$
where $\mathcal{F}_s = (X_s \to X)^*\mathcal{F}$ is the restriction
of $\mathcal{F}$ to the fibre of $f$ at $s$.
\end{definition}

\noindent
Again there is a caveat that this is best used when the fibres of $f$
are locally Noetherian and $\mathcal{F}$ is of finite type. In the general
case we should probably use the relative weak assassin (defined in the next
section).

\begin{lemma}
\label{lemma-base-change-relative-assassin}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
Let $g : S' \to S$ be a morphism of schemes.
Consider the base change diagram
$$
\xymatrix{
X' \ar[d] \ar[r]_{g'} & X \ar[d] \\
S' \ar[r]^g & S
}
$$
and set $\mathcal{F}' = (g')^*\mathcal{F}$. Let $x' \in X'$ be a point
with images $x \in X$, $s' \in S'$ and $s \in S$.
Assume $f$ locally of finite type.
Then $x' \in \text{Ass}_{X'/S'}(\mathcal{F}')$ if and only if
$x \in \text{Ass}_{X/S}(\mathcal{F})$ and $x'$ corresponds to
a generic point of an irreducible component of
$\Spec(\kappa(s') \otimes_{\kappa(s)} \kappa(x))$.
\end{lemma}

\begin{proof}
Consider the morphism $X'_{s'} \to X_s$ of fibres. As
$X_{s'} = X_s \times_{\Spec(\kappa(s))} \Spec(\kappa(s'))$
this is a flat morphism. Moreover $\mathcal{F}'_{s'}$ is the pullback
of $\mathcal{F}_s$ via this morphism. As $X_s$ is locally of finite
type over the Noetherian scheme $\Spec(\kappa(s))$ we have that
$X_s$ is locally Noetherian, see
Morphisms, Lemma \ref{morphisms-lemma-finite-type-noetherian}.
Thus we may apply
Lemma \ref{lemma-bourbaki}
and we see that
$$
\text{Ass}_{X'_{s'}}(\mathcal{F}'_{s'}) =
\bigcup\nolimits_{x \in \text{Ass}(\mathcal{F}_s)} \text{Ass}((X'_{s'})_x).
$$
Thus to prove the lemma it suffices to show that the associated points
of the fibre $(X'_{s'})_x$ of the morphism $X'_{s'} \to X_s$ over $x$
are its generic points. Note that
$(X'_{s'})_x = \Spec(\kappa(s') \otimes_{\kappa(s)} \kappa(x))$
as schemes. By
Algebra, Lemma \ref{algebra-lemma-tensor-fields-CM}
the ring $\kappa(s') \otimes_{\kappa(s)} \kappa(x)$ is a Noetherian
Cohen-Macaulay ring. Hence its associated primes are its minimal primes, see
Algebra, Proposition \ref{algebra-proposition-minimal-primes-associated-primes}
(minimal primes are associated) and
Algebra, Lemma \ref{algebra-lemma-criterion-no-embedded-primes}
(no embedded primes).
\end{proof}

\begin{remark}
\label{remark-base-change-relative-assassin}
With notation and assumptions as in
Lemma \ref{lemma-base-change-relative-assassin}
we see that it is always the case that
$(g')^{-1}(\text{Ass}_{X/S}(\mathcal{F})) \supset
\text{Ass}_{X'/S'}(\mathcal{F}')$.
If the morphism $S' \to S$ is locally quasi-finite, then we actually have
$$
(g')^{-1}(\text{Ass}_{X/S}(\mathcal{F}))
=
\text{Ass}_{X'/S'}(\mathcal{F}')
$$
because in this case the field extensions $\kappa(s) \subset \kappa(s')$
are always finite. In fact, this holds more generally for any morphism
$g : S' \to S$ such that all the field extensions
$\kappa(s) \subset \kappa(s')$ are algebraic, because in this case all
prime ideals of $\kappa(s') \otimes_{\kappa(s)} \kappa(x)$ are
maximal (and minimal) primes, see
Algebra, Lemma \ref{algebra-lemma-integral-over-field}.
\end{remark}




\section{Relative weak assassin}
\label{section-relative-weak-assassin}

\begin{definition}
\label{definition-relative-weak-assassin}
Let $f : X \to S$ be a morphism of schemes.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
The {\it relative weak assassin of $\mathcal{F}$ in $X$ over $S$}
is the set
$$
\text{WeakAss}_{X/S}(\mathcal{F}) =
\bigcup\nolimits_{s \in S} \text{WeakAss}(\mathcal{F}_s)
$$
where $\mathcal{F}_s = (X_s \to X)^*\mathcal{F}$ is the restriction
of $\mathcal{F}$ to the fibre of $f$ at $s$.
\end{definition}

\begin{lemma}
\label{lemma-relative-weak-assassin-assassin-finite-type}
Let $f : X \to S$ be a morphism of schemes which is locally of finite type.
Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
Then $\text{WeakAss}_{X/S}(\mathcal{F}) = \text{Ass}_{X/S}(\mathcal{F})$.
\end{lemma}

\begin{proof}
This is true becase the fibres of $f$ are locally Noetherian schemes,
and associated and weakly associated points agree on locally Noetherian
schemes, see
Lemma \ref{lemma-ass-weakly-ass}.
\end{proof}





\section{Effective Cartier divisors}
\label{section-effective-Cartier-divisors}

\noindent
For some reason it seem convenient to define the notion of an effective
Cartier divisor before anything else.

\begin{definition}
\label{definition-effective-Cartier-divisor}
Let $S$ be a scheme.
\begin{enumerate}
\item A {\it locally principal closed subscheme} of $S$ is a closed subscheme
whose sheaf of ideals is locally generated by a single element.
\item An {\it effective Cartier divisor} on $S$ is a closed subscheme
$D \subset S$ such that the ideal sheaf $\mathcal{I}_D \subset \mathcal{O}_X$
is an invertible $\mathcal{O}_X$-module.
\end{enumerate}
\end{definition}

\noindent
Thus an effective Cartier divisor is a locally principal closed subscheme,
but the converse is not always true. Effective Cartier divisors are closed
subschemes of pure codimension $1$ in the strongest possible sense. Namely
they are locally cut out by a single element which is not a zerodivisor.
In particular they are nowhere dense.

\begin{lemma}
\label{lemma-characterize-effective-Cartier-divisor}
Let $S$ be a scheme.
Let $D \subset S$ be a closed subscheme.
The following are equivalent:
\begin{enumerate}
\item The subscheme $D$ is an effective Cartier divisor on $S$.
\item For every $x \in D$ there exists an affine open neighbourhood
$\Spec(A) = U \subset X$ of $x$ such that
$U \cap D = \Spec(A/(f))$ with $f \in A$ not a zerodivisor.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume (1).  For every $x \in D$ there exists an affine open neighbourhood
$\Spec(A) = U \subset X$ of $x$ such that
$\mathcal{I}_D|_U \cong \mathcal{O}_U$. In other words, there exists
a section $f \in \Gamma(U, \mathcal{I}_D)$ which freely generates the
restriction $\mathcal{I}_D|_U$. Hence $f \in A$, and the multiplication
map $f : A \to A$ is injective. Also, since $\mathcal{I}_D$ is
quasi-coherent we see that $D \cap U = \Spec(A/(f))$.

\medskip\noindent
Assume (2). Let $x \in D$. By assumption there exists an affine open
neighbourhood $\Spec(A) = U \subset X$ of $x$ such that
$U \cap D = \Spec(A/(f))$ with $f \in A$ not a zerodivisor.
Then $\mathcal{I}_D|_U \cong \mathcal{O}_U$ since it is equal to
$\widetilde{(f)} \cong \widetilde{A} \cong \mathcal{O}_U$.
Of course $\mathcal{I}_D$ restricted to the open subscheme
$S \setminus D$ is isomorphic to $\mathcal{O}_{X \setminus D}$.
Hence $\mathcal{I}_D$ is an invertible $\mathcal{O}_S$-module.
\end{proof}

\begin{lemma}
\label{lemma-complement-locally-principal-closed-subscheme}
Let $S$ be a scheme. Let $Z \subset S$ be a locally principal closed
subscheme. Let $U = S \setminus Z$. Then $U \to S$ is an affine morphism.
\end{lemma}

\begin{proof}
The question is local on $S$, see
Morphisms, Lemmas \ref{morphisms-lemma-characterize-affine}.
Thus we may assume $S = \Spec(A)$ and $Z = V(f)$ for some $f \in A$.
In this case $U = D(f) = \Spec(A_f)$ is affine hence $U \to S$ is affine.
\end{proof}

\begin{lemma}
\label{lemma-complement-effective-Cartier-divisor}
Let $S$ be a scheme. Let $D \subset S$ be an effective Cartier divisor.
Let $U = S \setminus D$. Then $U \to S$ is an affine morphism and $U$
is scheme theoretically dense in $S$.
\end{lemma}

\begin{proof}
Affineness is Lemma \ref{lemma-complement-locally-principal-closed-subscheme}.
The density question is local on $S$, see
Morphisms, Lemma \ref{morphisms-lemma-characterize-scheme-theoretically-dense}.
Thus we may assume $S = \Spec(A)$ and $D$ corresponding to the
nonzerodivisor $f \in A$, see
Lemma \ref{lemma-characterize-effective-Cartier-divisor}.
Thus $A \subset A_f$ which implies that $U \subset S$ is
scheme theoretically dense, see
Morphisms, Example \ref{morphisms-example-scheme-theoretic-closure}.
\end{proof}

\begin{lemma}
\label{lemma-effective-Cartier-makes-dimension-drop}
Let $S$ be a scheme.
Let $D \subset S$ be an effective Cartier divisor.
Let $s \in D$.
If $\dim_s(S) < \infty$, then $\dim_s(D) < \dim_s(S)$.
\end{lemma}

\begin{proof}
Assume $\dim_s(S) < \infty$.
Let $U = \Spec(A) \subset S$ be an affine open neighbourhood
of $X$ such that $\dim(U) = \dim_s(S)$ and such that $D = V(f)$
for some nonzerodivisor $f \in A$ (see
Lemma \ref{lemma-characterize-effective-Cartier-divisor}).
Recall that $\dim(U)$ is the Krull dimension of the ring $A$
and that $\dim(U \cap D)$ is the Krull dimension of the ring $A/(f)$.
Then $f$ is not contained in any minimal prime of $A$.
Hence any maximal chain of primes in $A/(f)$, viewed as a chain
of primes in $A$, can be extended by adding a minimal prime.
\end{proof}

\begin{definition}
\label{definition-sum-effective-Cartier-divisors}
Let $S$ be a scheme. Given effective Cartier divisors
$D_1$, $D_2$ on $S$ we set $D = D_1 + D_2$ equal to the
closed subscheme of $S$ corresponding to the quasi-coherent
sheaf of ideals
$\mathcal{I}_{D_1}\mathcal{I}_{D_2} \subset \mathcal{O}_S$.
We call this the {\it sum of the effective Cartier divisors
$D_1$ and $D_2$}.
\end{definition}

\noindent
It is clear that we may define the sum $\sum n_iD_i$ given
finitely many effective Cartier divisors $D_i$ on $X$
and nonnegative integers $n_i$.

\begin{lemma}
\label{lemma-sum-effective-Cartier-divisors}
The sum of two effective Cartier divisors is an effective
Cartier divisor.
\end{lemma}

\begin{proof}
Omitted. Locally $f_1, f_2 \in A$ are nonzerodivisors, then also
$f_1f_2 \in A$ is a nonzerodivisor.
\end{proof}

\begin{lemma}
\label{lemma-difference-effective-Cartier-divisors}
Let $X$ be a scheme.
Let $D, D'$ be two effective Cartier divisors on $X$.
If $D \subset D'$ (as closed subschemes of $X$), then
there exists an effective Cartier divisor $D''$ such
that $D' = D + D''$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-sum-closed-subschemes-effective-Cartier}
Let $X$ be a scheme. Let $Z, Y$ be two closed subschemes of $X$
with ideal sheaves $\mathcal{I}$ and $\mathcal{J}$. If $\mathcal{I}\mathcal{J}$
defines an effective Cartier divisor $D \subset X$, then $Z$ and $Y$
are effective Cartier divisors and $D = Z + Y$.
\end{lemma}

\begin{proof}
Applying Lemma \ref{lemma-characterize-effective-Cartier-divisor} we obtain
the following algebra situation: $A$ is a ring, $I, J \subset A$
ideals and $f \in A$ a nonzerodivisor such that $IJ = (f)$. We have
to show that $I$ and $J$ are locally free $A$-modules of rank $1$.
To do this, write $f = \sum_{i = 1, \ldots, n} x_i y_i$. We can
also write $x_iy_i = a_i f$. Since $f$ is a nonzerodivisor we see that
$\sum a_i = 1$. Thus it suffices to show that each $I_{a_i}$ and
$J_{a_i}$ is free of rank $1$ over $A_{a_i}$. After replacing $A$ by
$A_{a_i}$ we conclude that $f = xy$ for some $x \in I$ and $y \in J$.
Note that both $x$ and $y$ are nonzerodivisors. We claim that
$I = (x)$ and $J = (y)$ which finishes the proof. Namely, if $x' \in I$,
then $x'y = af = axy$ for some $a \in A$. Hence $x' = ax$ and we win.
\end{proof}

\noindent
Recall that we have defined the inverse image of a closed subscheme
under any morphism of schemes in
Schemes, Definition \ref{schemes-definition-inverse-image-closed-subscheme}.

\begin{lemma}
\label{lemma-pullback-locally-principal}
Let $f : S' \to S$ be a morphism of schemes. Let $Z \subset S$
be a locally principal closed subscheme. Then the inverse image
$f^{-1}(Z)$ is a locally principal closed subscheme of $S'$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{definition}
\label{definition-pullback-effective-Cartier-divisor}
Let $f : S' \to S$ be a morphism of schemes. Let $D \subset S$
be an effective Cartier divisor. We say the {\it pullback of
$D$ by $f$ is defined} if the closed subscheme $f^{-1}(D) \subset S'$
is an effective Cartier divisor. In this case we denote it either
$f^*D$ or $f^{-1}(D)$ and we call it the
{\it pullback of the effective Cartier divisor}.
\end{definition}

\noindent
The condition that $f^{-1}(D)$ is an effective Cartier divisor
is often satisfied in practice. Here is an example lemma.

\begin{lemma}
\label{lemma-pullback-effective-Cartier-defined}
Let $f : X \to Y$ be a morphism of schemes.
Let $D \subset Y$ be an effective Cartier divisor.
The pullback of $D$ by $f$ is defined in each of the following cases:
\begin{enumerate}
\item $X$, $Y$ integral and $f$ dominant,
\item $X$ reduced, and for any generic point $\xi$ of any
irreducible component of $X$ we have $f(\xi) \not \in D$,
\item $X$ is locally Noetherian and for any associated point
$x$ of $X$ we have $f(x) \not \in D$,
\item $X$ is locally Noetherian, has no embedded points, and
for any generic point $\xi$ of any irreducible component of
$X$ we have $f(\xi) \not \in D$,
\item $f$ is flat, and
\item add more here as needed.
\end{enumerate}
\end{lemma}

\begin{proof}
The question is local on $X$, and hence we reduce to the case
where $X = \Spec(A)$, $Y = \Spec(R)$, $f$ is
given by $\varphi : R \to A$ and
$D = \Spec(R/(t))$ where $t \in R$ is not a zerodivisor.
The goal in each case is to show that $\varphi(t) \in A$
is not a zerodivisor.

\medskip\noindent
In case (2) this follows as the intersection of all minimal
primes of a ring is the nilradical of the ring, see
Algebra, Lemma \ref{algebra-lemma-Zariski-topology}.

\medskip\noindent
Let us prove (3). By
Lemma \ref{lemma-associated-affine-open}
the associated points of $X$ correspond to the primes
$\mathfrak p \in \text{Ass}(A)$.
By Algebra, Lemma \ref{algebra-lemma-ass-zero-divisors} we have
$\bigcup_{\mathfrak p \in \text{Ass}(A)} \mathfrak p$ is
the set of zerodivisors of $A$. The hypothesis of
(3) is that $\varphi(t) \not \in \mathfrak p$ for
all $\mathfrak p \in \text{Ass}(A)$. Hence $\varphi(t)$
is a nonzerodivisor as desired.

\medskip\noindent
Part (4) follows from (3) and the definitions.
\end{proof}

\begin{lemma}
\label{lemma-pullback-effective-Cartier-divisors-additive}
Let $f : S' \to S$ be a morphism of schemes.
Let $D_1$, $D_2$ be effective Cartier divisors on $S$.
If the pullbacks of $D_1$ and $D_2$ are defined then the
pullback of $D = D_1 + D_2$ is defined and
$f^*D = f^*D_1 + f^*D_2$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{definition}
\label{definition-invertible-sheaf-effective-Cartier-divisor}
Let $S$ be a scheme and let $D$ be an effective Cartier divisor.
The {\it invertible sheaf $\mathcal{O}_S(D)$ associated to $D$}
is given by
$$
\mathcal{O}_S(D) :=
\SheafHom_{\mathcal{O}_S}(\mathcal{I}_D, \mathcal{O}_S) =
\mathcal{I}_D^{\otimes -1}.
$$
The canonical section, usually denoted $1$ or $1_D$, is the
global section of $\mathcal{O}_S(D)$ corresponding to
the inclusion mapping $\mathcal{I}_D \to \mathcal{O}_S$.
\end{definition}

\begin{lemma}
\label{lemma-invertible-sheaf-sum-effective-Cartier-divisors}
Let $S$ be a scheme.
Let $D_1$, $D_2$ be effective Cartier divisors on $S$.
Let $D = D_1 + D_2$.
Then there is a unique isomorphism
$$
\mathcal{O}_S(D_1) \otimes_{\mathcal{O}_S} \mathcal{O}_S(D_2)
\longrightarrow
\mathcal{O}_S(D)
$$
which maps $1_{D_1} \otimes 1_{D_2}$ to $1_D$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{definition}
\label{definition-regular-section}
Let $(X, \mathcal{O}_X)$ be a locally ringed space.
Let $\mathcal{L}$ be an invertible sheaf on $X$.
A global section $s \in \Gamma(X, \mathcal{L})$ is called a
{\it regular section} if the map $\mathcal{O}_X \to \mathcal{L}$,
$f \mapsto fs$ is injective.
\end{definition}

\begin{lemma}
\label{lemma-regular-section-structure-sheaf}
Let $X$ be a locally ringed space. Let $f \in \Gamma(X, \mathcal{O}_X)$.
The following are equivalent:
\begin{enumerate}
\item $f$ is a regular section, and
\item for any $x \in X$ the image $f \in \mathcal{O}_{X, x}$
is not a zerodivisor.
\end{enumerate}
If $X$ is a scheme these are also equivalent to
\begin{enumerate}
\item[(3)] for any affine open $\Spec(A) = U \subset X$
the image $f \in A$ is not a zerodivisor, and
\item[(4)] there exists an affine open covering
$X = \bigcup \Spec(A_i)$ such that
the image of $f$ in $A_i$ is not a zerodivisor for all $i$.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\noindent
Note that a global section $s$ of an invertible $\mathcal{O}_X$-module
$\mathcal{L}$ may be seen as an $\mathcal{O}_X$-module map
$s : \mathcal{O}_X \to \mathcal{L}$. Its dual is therefore a
map $s : \mathcal{L}^{\otimes -1} \to \mathcal{O}_X$.
(See Modules, Definition \ref{modules-definition-powers}
for the definition of the dual invertible sheaf.)

\begin{definition}
\label{definition-zero-scheme-s}
Let $X$ be a scheme.
Let $\mathcal{L}$ be an invertible sheaf.
Let $s \in \Gamma(X, \mathcal{L})$.
The {\it zero scheme} of $s$ is the closed subscheme $Z(s) \subset X$
defined by the quasi-coherent sheaf of ideals
$\mathcal{I} \subset \mathcal{O}_X$ which is the image of the
map $s : \mathcal{L}^{\otimes -1} \to \mathcal{O}_X$.
\end{definition}

\begin{lemma}
\label{lemma-zero-scheme}
Let $X$ be a scheme.
Let $\mathcal{L}$ be an invertible sheaf.
Let $s \in \Gamma(X, \mathcal{L})$.
\begin{enumerate}
\item Consider closed immersions $i : Z \to X$ such that
$i^*s \in \Gamma(Z, i^*\mathcal{L}))$ is zero
ordered by inclusion. The zero scheme $Z(s)$ is the
maximal element of this ordered set.
\item For any morphism of schemes $f : Y \to X$ we have
$f^*s = 0$ in $\Gamma(Y, f^*\mathcal{L})$ if and only if
$f$ factors through $Z(s)$.
\item The zero scheme $Z(s)$ is a locally principal closed subscheme.
\item The zero scheme $Z(s)$ is an effective Cartier divisor
if and only if $s$ is a regular section of $\mathcal{L}$.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-characterize-OD}
Let $S$ be a scheme.
\begin{enumerate}
\item If $D \subset S$ is an effective Cartier divisor, then
the canonical section $1_D$ of $\mathcal{O}_S(D)$ is regular.
\item Conversely, if $s$ is a regular section of the invertible
sheaf $\mathcal{L}$, then there exists a unique effective
Cartier divisor $D = Z(s) \subset S$ and a unique isomorphism
$\mathcal{O}_S(D) \to \mathcal{L}$ which maps $1_D$ to $s$.
\end{enumerate}
The constructions
$D \mapsto (\mathcal{O}_X(D), 1_D)$ and $(\mathcal{L}, s) \mapsto Z(s)$
give mutually inverse maps
$$
\left\{
\begin{matrix}
\text{effective Cartier divisors on }X
\end{matrix}
\right\}
\leftrightarrow
\left\{
\begin{matrix}
\text{pairs }(\mathcal{L}, s)\text{ consisting of an invertible}\\
\mathcal{O}_X\text{-module and a regular global section}
\end{matrix}
\right\}
$$
\end{lemma}

\begin{proof}
Omitted.
\end{proof}


















\section{Relative effective Cartier divisors}
\label{section-effective-Cartier-morphisms}

\noindent
The following lemma shows that an effective Cartier divisor which is
flat over the base is reall a ``family of effective Cartier divisors''
over the base. For example the restriction to any fibre is an effective
Cartier divisor.

\begin{lemma}
\label{lemma-relative-Cartier}
Let $f : X \to S$ be a morphism of schemes.
Let $D \subset X$ be a closed subscheme.
Assume
\begin{enumerate}
\item $D$ is an effective Cartier divisor, and
\item $D \to S$ is a flat morphism.
\end{enumerate}
Then for every morphism of schemes $g : S' \to S$ the pullback
$(g')^{-1}D$ is an effective Cartier divisor on $X' = S' \times_S X$.
\end{lemma}

\begin{proof}
Using
Lemma \ref{lemma-characterize-effective-Cartier-divisor}
we translate this as follows into algebra. Let $A \to B$ be a ring
map and $h \in B$. Assume $h$ is a nonzerodivisor and that $B/hB$ is flat
over $A$. Then
$$
0 \to B \xrightarrow{h} B \to B/hB \to 0
$$
is a short exact sequence of $A$-modules with $B/hB$ flat over $A$. By
Algebra, Lemma \ref{algebra-lemma-flat-tor-zero}
this sequence remains exact on tensoring over $A$ with any module, in
particular with any $A$-algebra $A'$.
\end{proof}

\noindent
This lemma is the motivation for the following definition.

\begin{definition}
\label{definition-relative-effective-Cartier-divisor}
Let $f : X \to S$ be a morphism of schemes.
A {\it relative effective Cartier divisor} on $X/S$ is an
effective Cartier divisor $D \subset X$ such that $D \to S$
is a flat morphism of schemes.
\end{definition}

\noindent
We warn the reader that this may be nonstandard notation.
In particular, in \cite[IV, Section 21.15]{EGA} the notion of a
relative divisor is discussed only when $X \to S$ is flat and
locally of finite presentation. Our definition is a bit more general.
However, it turns out that if $x \in D$ then $X \to S$ is
flat at $x$ in many cases (but not always).

\begin{lemma}
\label{lemma-flat-at-x}
Let $f : X \to S$ be a morphism of schemes.
Let $D \subset X$ be a relative effective Cartier divisor on $X/S$.
If $x \in D$ and $\mathcal{O}_{X, x}$ is Noetherian, then $f$ is flat at $x$.
\end{lemma}

\begin{proof}
Set $A = \mathcal{O}_{S, f(x)}$ and $B = \mathcal{O}_{X, x}$.
Let $h \in B$ be an element which generates the ideal of $D$.
Then $h$ is a nonzerodivisor in $B$ such that $B/hB$ is a flat
local $A$-algebra. Let $I \subset A$ be a finitely generated ideal.
Consider the commutative diagram
$$
\xymatrix{
0 \ar[r] &
B \ar[r]_h &
B \ar[r] &
B/hB \ar[r] & 0 \\
0 \ar[r] &
B \otimes_A I \ar[r]^h \ar[u] &
B \otimes_A I \ar[r] \ar[u] &
B/hB \otimes_A I \ar[r] \ar[u] & 0
}
$$
The lower sequence is short exact as $B/hB$ is flat over $A$, see
Algebra, Lemma \ref{algebra-lemma-flat-tor-zero}.
The right vertical arrow is injective as $B/hB$ is flat over $A$, see
Algebra, Lemma \ref{algebra-lemma-flat}.
Hence multiplication by $h$ is surjective on the kernel $K$ of
the middle vertical arrow. By Nakayama's lemma, see
Algebra, Lemma \ref{algebra-lemma-NAK}
we conclude that $K= 0$. Hence $B$ is flat over $A$, see
Algebra, Lemma \ref{algebra-lemma-flat}.
\end{proof}

\noindent
The following lemma relies on the algebraic version of
openness of the flat locus. The scheme theoretic version can be found in
More on Morphisms, Section \ref{more-morphisms-section-open-flat}.

\begin{lemma}
\label{lemma-flat-relative-Cartier-divisor}
Let $f : X \to S$ be a morphism of schemes.
Let $D \subset X$ be a relative effective Cartier divisor.
If $f$ is locally of finite presentation, then there exists
an open subscheme $U \subset X$ such that $D \subset U$ and
such that $f|_U : U \to S$ is flat.
\end{lemma}

\begin{proof}
Pick $x \in D$. It suffices to find an open neighbourhood $U \subset X$
of $x$ such that $f|_U$ is flat. Hence the lemma reduces to the case
that $X = \Spec(B)$ and $S = \Spec(A)$ are affine
and that $D$ is given by a nonzerodivisor $h \in B$. By assumption
$B$ is a finitely presented $A$-algebra and $B/hB$ is a flat
$A$-algebra. We are going to use absolute Noetherian approximation.

\medskip\noindent
Write $B = A[x_1, \ldots, x_n]/(g_1, \ldots, g_m)$. Assume
$h$ is the image of $h' \in A[x_1, \ldots, x_n]$. Choose a finite type
$\mathbf{Z}$-subalgebra $A_0 \subset A$ such that all the coefficients
of the polynomials $h', g_1, \ldots, g_m$ are in $A_0$. Then we can set
$B_0 = A_0[x_1, \ldots, x_n]/(g_1, \ldots, g_m)$ and $h_0$ the image
of $h'$ in $B_0$. Then $B = B_0 \otimes_{A_0} A$ and
$B/hB = B_0/h_0B_0 \otimes_{A_0} A$. By Algebra, Lemma
\ref{algebra-lemma-flat-finite-presentation-limit-flat}
we may, after enlarging $A_0$, assume that $B_0/h_0B_0$ is flat
over $A_0$. Let $K_0 = \text{Ker}(h_0 : B_0 \to B_0)$.
As $B_0$ is of finite type over $\mathbf{Z}$ we see that $K_0$ is
a finitely generated ideal. Let $A_1 \subset A$ be a finite type
$\mathbf{Z}$-subalgebra containing $A_0$ and denote $B_1$, $h_1$, $K_1$
the corresponding objects over $A_1$. By
More on Algebra, Lemma \ref{more-algebra-lemma-base-change-H1-regular}
the map $K_0 \otimes_{A_0} A_1 \to K_1$ is surjective. On the other hand,
the kernel of $h : B \to B$ is zero by assumption. Hence every element
of $K_0$ maps to zero in $K_1$ for sufficiently large subrings
$A_1 \subset A$. Since $K_0$ is finitely generated, we conclude that
$K_1 = 0$ for a suitable choice of $A_1$.

\medskip\noindent
Set $f_1 : X_1 \to S_1$ equal to $\Spec$ of the
ring map $A_1 \to B_1$. Set $D_1 = \Spec(B_1/h_1B_1)$.
Since $B = B_1 \otimes_{A_1} A$, i.e., $X = X_1 \times_{S_1} S$,
it now suffices to prove the lemma for $X_1 \to S_1$ and the relative
effective Cartier divisor $D_1$, see
Morphisms, Lemma \ref{morphisms-lemma-base-change-module-flat}.
Hence we have reduced to the case where $A$ is a Noetherian ring.
In this case we know that the ring map $A \to B$ is flat at every
prime $\mathfrak q$ of $V(h)$ by
Lemma \ref{lemma-flat-at-x}.
Combined with the fact that the flat locus is open in this case, see
Algebra, Theorem \ref{algebra-theorem-openess-flatness}
we win.
\end{proof}

\noindent
There is also the following lemma (whose idea is apparantly
due to Michael Artin, see \cite{Nobile}) which needs no finiteness
assumptions at all.

\begin{lemma}
\label{lemma-michael-artin}
Let $f : X \to S$ be a morphism of schemes.
Let $D \subset X$ be a relative effective Cartier divisor on $X/S$.
If $f$ is flat at all points of $X \setminus D$, then $f$ is flat.
\end{lemma}

\begin{proof}
This translates into the following algebra fact:
Let $A \to B$ be a ring map and $h \in B$.
Assume $h$ is a nonzerodivisor, that $B/hB$ is flat over $A$, and
that the localization $B_h$ is flat over $A$. Then $B$ is flat over $A$.
The reason is that we have a short exact sequence
$$
0 \to B \to B_h \to \colim_n (1/h^n)B/B \to 0
$$
and that the second and third terms are flat over $A$, which implies
that $B$ is flat over $A$ (see
Algebra, Lemma \ref{algebra-lemma-flat-ses}). Note that a filtered
colimit of flat modules is flat (see
Algebra, Lemma \ref{algebra-lemma-colimit-flat})
and that by induction on $n$ each $(1/h^n)B/B \cong B/h^nB$ is flat over
$A$ since it fits into the short exact sequence
$$
0 \to B/h^{n - 1}B \xrightarrow{h} B/h^nB \to B/hB \to 0
$$
Some details omitted.
\end{proof}

\begin{example}
\label{example-relative-cartier-ambient-space-not-flat}
Here is an example of a relative effective Cartier divisor $D$ where the
ambient scheme is not flat in a neighbourhood of $D$. Namely, let
$A = k[t]$ and
$$
B = k[t, x, y, x^{-1}y, x^{-2}y, \ldots]/(ty, tx^{-1}y, tx^{-2}y, \ldots)
$$
Then $B$ is not flat over $A$ but $B/xB \cong A$ is flat over $A$.
Moreover $x$ is a nonzerodivisor and hence defines a relative effective
Cartier divisor in $\Spec(B)$ over $\Spec(A)$.
\end{example}

\noindent
If the ambient scheme is flat and locally of finite presentation over
the base, then we can characterize a relative effective Cartier divisor
in terms of its fibres. See also
More on Morphisms, Lemma \ref{more-morphisms-lemma-slice-given-element}
for a slightly different take on this lemma.

\begin{lemma}
\label{lemma-fibre-Cartier}
Let $\varphi : X \to S$ be a flat morphism which is locally of finite
presentation. Let $Z \subset X$ be a closed subscheme.
Let $x \in Z$ with image $s \in S$.
\begin{enumerate}
\item If $Z_s \subset X_s$ is a Cartier divisor in a neighbourhood of $x$,
then there exists an open $U \subset X$ and a
relative effective Cartier divisor $D \subset U$ such that
$Z \cap U \subset D$.
\item If $Z_s \subset X_s$ is a Cartier divisor in a neighbourhood of $x$,
the morphism $Z \to X$ is of finite presentation, and $Z \to S$ is flat at
$x$, then we can choose $U$ and $D$ such that $Z \cap U = D$.
\item If $Z_s \subset X_s$ is a Cartier divisor in a neighbourhood of $x$
and $Z$ is a locally principal closed subscheme of $X$ in a neighbourhood
of $x$, then we can choose $U$ and $D$ such that $Z \cap U = D$.
\end{enumerate}
In particular, if $Z \to S$ is locally of finite presentation and flat and
all fibres $Z_s \subset X_s$ are effective Cartier divisors, then
$Z$ is a relative effective Cartier divisor. Similarly, if $Z$
is a locally principal closed subscheme of $X$ such that all fibres
$Z_s \subset X_s$ are effective Cartier divisors, then
$Z$ is a relative effective Cartier divisor.
\end{lemma}

\begin{proof}
Choose affine open neighbourhoods $\Spec(A)$ of $s$ and
$\Spec(B)$ of $x$ such that
$\varphi(\Spec(B)) \subset \Spec(A)$.
Let $\mathfrak p \subset A$ be the prime ideal corresponding to $s$.
Let $\mathfrak q \subset B$ be the prime ideal corresponding to $x$.
Let $I \subset B$ be the ideal corresponding to $Z$.
By the initial assumption of the lemma we know that
$A \to B$ is flat and of finite presentation.
The assumption in (1) means that, after shrinking $\Spec(B)$, we may
assume $I(B \otimes_A \kappa(\mathfrak p))$ is generated by a single
element which is a nonzerodivisor in $B \otimes_A \kappa(\mathfrak p)$.
Say $f \in I$ maps to this generator. We claim that after inverting
an element $g \in B$, $g \not \in \mathfrak q$ the closed subscheme
$D = V(f) \subset \Spec(B_g)$ is a relative effective Cartier
divisor.

\medskip\noindent
By
Algebra, Lemma \ref{algebra-lemma-flat-finite-presentation-limit-flat}
we can find a flat finite type ring map $A_0 \to B_0$ of Noetherian
rings, an element $f_0 \in B_0$, a ring map $A_0 \to A$ and an isomorphism
$A \otimes_{A_0} B_0 \cong B$. If $\mathfrak p_0 = A_0 \cap \mathfrak p$
then we see that
$$
B \otimes_A \kappa(\mathfrak p) =
\left(B_0 \otimes_{A_0} \kappa(\mathfrak p_0)\right)
\otimes_{\kappa(\mathfrak p_0))} \kappa(\mathfrak p)
$$
hence $f_0$ is a nonzerodivisor in $B_0 \otimes_{A_0} \kappa(\mathfrak p_0)$.
By
Algebra, Lemma \ref{algebra-lemma-grothendieck}
we see that $f_0$ is a nonzerodivisor in $(B_0)_{\mathfrak q_0}$
where $\mathfrak q_0 = B_0 \cap \mathfrak q$ and
that $(B_0/f_0B_0)_{\mathfrak q_0}$ is flat over $A_0$. Hence by
Algebra, Lemma \ref{algebra-lemma-regular-sequence-in-neighbourhood}
and
Algebra, Theorem \ref{algebra-theorem-openess-flatness}
there exists a $g_0 \in B_0$, $g_0 \not \in \mathfrak q_0$ such
that $f_0$ is a nonzerodivisor in $(B_0)_{g_0}$ and such that
$(B_0/f_0B_0)_{g_0}$ is flat over $A_0$. Hence we see that
$D_0 = V(f_0) \subset \Spec((B_0)_{g_0})$ is a relative effective
Cartier divisor. Since we know that this property is preserved under
base change, see
Lemma \ref{lemma-relative-Cartier},
we obtain the claim mentioned above with $g$ equal to the image of $g_0$
in $B$.

\medskip\noindent
At this point we have proved (1). To see (2) consider the closed
immersion $Z \to D$. The surjective ring map
$u : \mathcal{O}_{D, x} \to \mathcal{O}_{Z, x}$
is a map of flat local $\mathcal{O}_{S, s}$-algebras which
are essentially of finite presentation, and which becomes an
isomorphisms after dividing by $\mathfrak m_s$. Hence it is
an isomorphism, see
Algebra, Lemma \ref{algebra-lemma-mod-injective-general}.
It follows that $Z \to D$ is an isomorphism in a neighbourhood
of $x$, see
Algebra, Lemma \ref{algebra-lemma-local-isomorphism}.
To see (3), after possibly shrinking $U$ we may assume that
the ideal of $D$ is generated by a single nonzerodivisor $f$
and the ideal of $Z$ is generated by an element $g$. Then
$f = gh$. But $g|_{U_s}$ and $f|_{U_s}$ cut out the same
effective Cartier divisor in a neighbourhood of $x$. Hence
$h|_{X_s}$ is a unit in $\mathcal{O}_{X_s, x}$, hence $h$ is
a unit in $\mathcal{O}_{X, x}$ hence $h$ is a unit in an
open neighbourhood of $x$. I.e., $Z \cap U = D$ after shrinking $U$.

\medskip\noindent
The final statements of the lemma follow immediately from
parts (2) and (3), combined with the fact that $Z \to S$
is locally of finite presentation if and only if $Z \to X$ is
of finite presentation, see
Morphisms, Lemmas \ref{morphisms-lemma-composition-finite-presentation} and
\ref{morphisms-lemma-finite-presentation-permanence}.
\end{proof}



\section{The normal cone of an immersion}
\label{section-normal-cone}

\noindent
Let $i : Z \to X$ be a closed immersion. Let
$\mathcal{I} \subset \mathcal{O}_X$ be the corresponding quasi-coherent
sheaf of ideals. Consider the quasi-coherent sheaf of graded
$\mathcal{O}_X$-algebras
$\bigoplus_{n \geq 0} \mathcal{I}^n/\mathcal{I}^{n + 1}$.
Since the sheaves $\mathcal{I}^n/\mathcal{I}^{n + 1}$
are each annihilated by $\mathcal{I}$ this graded algebra
corresponds to a quasi-coherent sheaf of graded $\mathcal{O}_Z$-algebras
by
Morphisms, Lemma \ref{morphisms-lemma-i-star-equivalence}.
This quasi-coherent graded $\mathcal{O}_Z$-algebra is called the
{\it conormal algebra of $Z$ in $X$} and is often simply denoted
$\bigoplus_{n \geq 0} \mathcal{I}^n/\mathcal{I}^{n + 1}$
by the abuse of notation mentioned in
Morphisms, Section \ref{morphisms-section-closed-immersions-quasi-coherent}.

\medskip\noindent
Let $f : Z \to X$ be an immersion. We define the conormal algebra of $f$
as the conormal sheaf of the closed immersion
$i : Z \to X \setminus \partial Z$, where
$\partial Z = \overline{Z} \setminus Z$. It is often denoted
$\bigoplus_{n \geq 0} \mathcal{I}^n/\mathcal{I}^{n + 1}$
where $\mathcal{I}$ is the ideal sheaf
of the closed immersion $i : Z \to X \setminus \partial Z$.

\begin{definition}
\label{definition-conormal-sheaf}
Let $f : Z \to X$ be an immersion. The {\it conormal algebra
$\mathcal{C}_{Z/X, *}$ of $Z$ in $X$} or the {\it conormal algebra of $f$}
is the quasi-coherent sheaf of graded $\mathcal{O}_Z$-algebras
$\bigoplus_{n \geq 0} \mathcal{I}^n/\mathcal{I}^{n + 1}$ described above.
\end{definition}

\noindent
Thus $\mathcal{C}_{Z/X, 1} = \mathcal{C}_{Z/X}$ is the conormal sheaf
of the immersion. Also $\mathcal{C}_{Z/X, 0} = \mathcal{O}_Z$ and
$\mathcal{C}_{Z/X, n}$ is a quasi-coherent $\mathcal{O}_Z$-module
characterized by the property
\begin{equation}
\label{equation-conormal-in-degree-n}
i_*\mathcal{C}_{Z/X, n} = \mathcal{I}^n/\mathcal{I}^{n + 1}
\end{equation}
where $i : Z \to X \setminus \partial Z$ and $\mathcal{I}$ is the ideal
sheaf of $i$ as above. Finally, note that there is a canonical surjective
map
\begin{equation}
\label{equation-conormal-algebra-quotient}
\text{Sym}^*(\mathcal{C}_{Z/X}) \longrightarrow \mathcal{C}_{Z/X, *}
\end{equation}
of quasi-coherent graded $\mathcal{O}_Z$-algebras which is an isomorphism
in degrees $0$ and $1$.

\begin{lemma}
\label{lemma-affine-conormal-sheaf}
Let $i : Z \to X$ be an immersion. The conormal algebra
of $i$ has the following properties:
\begin{enumerate}
\item Let $U \subset X$ be any open such that $i(Z)$ is
a closed subset of $U$. Let $\mathcal{I} \subset \mathcal{O}_U$
be the sheaf of ideals corresponding to the closed subscheme
$i(Z) \subset U$. Then
$$
\mathcal{C}_{Z/X, *} =
i^*\left(\bigoplus\nolimits_{n \geq 0} \mathcal{I}^n\right) =
i^{-1}\left(
\bigoplus\nolimits_{n \geq 0} \mathcal{I}^n/\mathcal{I}^{n + 1}
\right)
$$
\item
For any affine open $\Spec(R) = U \subset X$
such that $Z \cap U = \Spec(R/I)$ there is a
canonical isomorphism
$\Gamma(Z \cap U, \mathcal{C}_{Z/X, *}) = \bigoplus_{n \geq 0} I^n/I^{n + 1}$.
\end{enumerate}
\end{lemma}

\begin{proof}
Mostly clear from the definitions. Note that given a ring $R$ and
an ideal $I$ of $R$ we have $I^n/I^{n + 1} = I^n \otimes_R R/I$.
Details omitted.
\end{proof}

\begin{lemma}
\label{lemma-conormal-algebra-functorial}
Let
$$
\xymatrix{
Z \ar[r]_i \ar[d]_f & X \ar[d]^g \\
Z' \ar[r]^{i'} & X'
}
$$
be a commutative diagram in the category of schemes.
Assume $i$, $i'$ immersions. There is a canonical map
of graded $\mathcal{O}_Z$-algebras
$$
f^*\mathcal{C}_{Z'/X', *}
\longrightarrow
\mathcal{C}_{Z/X, *}
$$
characterized by the following property: For every pair of affine opens
$(\Spec(R) = U \subset X, \Spec(R') = U' \subset X')$ with
$f(U) \subset U'$ such that
$Z \cap U = \Spec(R/I)$ and $Z' \cap U' = \Spec(R'/I')$
the induced map
$$
\Gamma(Z' \cap U', \mathcal{C}_{Z'/X', *}) =
\bigoplus\nolimits (I')^n/(I')^{n + 1}
\longrightarrow
\bigoplus\nolimits_{n \geq 0} I^n/I^{n + 1} =
\Gamma(Z \cap U, \mathcal{C}_{Z/X, *})
$$
is the one induced by the ring map $f^\sharp : R' \to R$ which
has the property $f^\sharp(I') \subset I$.
\end{lemma}

\begin{proof}
Let $\partial Z' = \overline{Z'} \setminus Z'$ and
$\partial Z = \overline{Z} \setminus Z$. These are closed subsets of $X'$ and
of $X$. Replacing $X'$ by $X' \setminus \partial Z'$ and $X$ by
$X \setminus \big(g^{-1}(\partial Z') \cup \partial Z\big)$ we
see that we may assume that $i$ and $i'$ are closed immersions.

\medskip\noindent
The fact that $g \circ i$ factors through $i'$ implies that
$g^*\mathcal{I}'$ maps into $\mathcal{I}$ under the canonical
map $g^*\mathcal{I}' \to \mathcal{O}_X$, see
Schemes, Lemmas
\ref{schemes-lemma-characterize-closed-subspace} and
\ref{schemes-lemma-restrict-map-to-closed}.
Hence we get an induced map of quasi-coherent sheaves
$g^*((\mathcal{I}')^n/(\mathcal{I}')^{n + 1}) \to
\mathcal{I}^n/\mathcal{I}^{n + 1}$.
Pulling back by $i$ gives
$i^*g^*((\mathcal{I}')^n/(\mathcal{I}')^{n + 1}) \to
i^*(\mathcal{I}^n/\mathcal{I}^{n + 1})$.
Note that
$i^*(\mathcal{I}^n/\mathcal{I}^{n + 1}) = \mathcal{C}_{Z/X, n}$.
On the other hand,
$i^*g^*((\mathcal{I}')^n/(\mathcal{I}')^{n + 1}) =
f^*(i')^*((\mathcal{I}')^n/(\mathcal{I}')^{n + 1}) =
f^*\mathcal{C}_{Z'/X', n}$.
This gives the desired map.

\medskip\noindent
Checking that the map is locally described as the given map
$(I')^n/(I')^{n + 1} \to I^n/I^{n + 1}$ is a matter of unwinding the
definitions and is omitted. Another observation is that given any
$x \in i(Z)$ there do exist affine open neighbourhoods $U$, $U'$
with $f(U) \subset U'$ and $Z \cap U$ as well as $U' \cap Z'$
closed such that $x \in U$. Proof omitted. Hence the requirement
of the lemma indeed characterizes the map (and could have been used
to define it).
\end{proof}

\begin{lemma}
\label{lemma-conormal-algebra-functorial-flat}
Let
$$
\xymatrix{
Z \ar[r]_i \ar[d]_f & X \ar[d]^g \\
Z' \ar[r]^{i'} & X'
}
$$
be a fibre product diagram in the category of schemes with
$i$, $i'$ immersions. Then the canonical map
$f^*\mathcal{C}_{Z'/X', *} \to \mathcal{C}_{Z/X, *}$ of
Lemma \ref{lemma-conormal-algebra-functorial}
is surjective. If $g$ is flat, then it is an isomorphism.
\end{lemma}

\begin{proof}
Let $R' \to R$ be a ring map, and $I' \subset R'$ an ideal.
Set $I = I'R$. Then $(I')^n/(I')^{n + 1} \otimes_{R'} R \to I^n/I^{n + 1}$
is surjective. If $R' \to R$ is flat, then $I^n = (I')^n \otimes_{R'} R$
and we see the map is an isomorphism.
\end{proof}

\begin{definition}
\label{definition-normal-cone}
Let $i : Z \to X$ be an immersion of schemes.
The {\it normal cone $C_ZX$} of $Z$ in $X$ is
$$
C_ZX = \underline{\Spec}_Z(\mathcal{C}_{Z/X, *})
$$
see
Constructions,
Definitions \ref{constructions-definition-cone} and
\ref{constructions-definition-abstract-cone}. The {\it normal bundle}
of $Z$ in $X$ is the vector bundle
$$
N_ZX = \underline{\Spec}_Z(\text{Sym}(\mathcal{C}_{Z/X}))
$$
see
Constructions,
Definitions \ref{constructions-definition-vector-bundle} and
\ref{constructions-definition-abstract-vector-bundle}.
\end{definition}

\noindent
Thus $C_ZX \to Z$ is a cone over $Z$ and $N_ZX \to Z$ is a vector bundle
over $Z$ (recall that in our terminology this does not imply that
the conormal sheaf is a finite locally free sheaf). Moreover, the canonical
surjection (\ref{equation-conormal-algebra-quotient}) of graded algebras
defines a canonical closed immersion
\begin{equation}
\label{equation-normal-cone-in-normal-bundle}
C_ZX \longrightarrow N_ZX
\end{equation}
of cones over $Z$.





\section{Regular ideal sheaves}
\label{section-regular-ideal-sheaves}

\noindent
In this section we generalize the notion of an effective Cartier divisor
to higher codimension. Recall that a sequence of elements
$f_1, \ldots, f_r$ of a ring $R$ is a {\it regular sequence} if for each
$i = 1, \ldots, r$ the element $f_i$ is a nonzerodivisor on
$R/(f_1, \ldots, f_{i - 1})$ and $R/(f_1, \dots, f_r) \not = 0$, see
Algebra, Definition \ref{algebra-definition-regular-sequence}.
There are three closely related weaker conditions that we can impose.
The first is to assume that $f_1, \ldots, f_r$ is a {\it Koszul-regular
sequence}, i.e., that $H_i(K_\bullet(f_1, \ldots, f_r)) = 0$ for $i > 0$, see
More on Algebra,
Definition \ref{more-algebra-definition-koszul-regular-sequence}.
The sequence is called an {\it $H_1$-regular sequence} if
$H_1(K_\bullet(f_1, \ldots, f_r)) = 0$. Another condition we can impose
is that with $J = (f_1, \ldots, f_r)$, the map
$$
R/J[T_1, \ldots, T_r]
\longrightarrow
\bigoplus\nolimits_{n \geq 0}
J^n/J^{n + 1}
$$
which maps $T_i$ to $f_i \bmod J^2$ is an isomorphism. In this case
we say that $f_1, \ldots, f_r$ is a
{\it quasi-regular sequence}, see
Algebra, Definition \ref{algebra-definition-quasi-regular-sequence}.
Given an $R$-module $M$ there is also a notion of $M$-regular and
$M$-quasi-regular sequence.

\medskip\noindent
We can generalize this to the case of ringed spaces as follows.
Let $X$ be a ringed space and let
$f_1, \ldots, f_r \in \Gamma(X, \mathcal{O}_X)$.
We say that $f_1, \ldots, f_r$ is a {\it regular sequence} if
for each $i = 1, \ldots, r$ the map
\begin{equation}
\label{equation-map-regular}
f_i :
\mathcal{O}_X/(f_1, \ldots, f_{i - 1})
\longrightarrow
\mathcal{O}_X/(f_1, \ldots, f_{i - 1})
\end{equation}
is an injective map of sheaves. We say that $f_1, \ldots, f_r$ is a
{\it Koszul-regular sequence} if the Koszul complex
\begin{equation}
\label{equation-koszul}
K_\bullet(\mathcal{O}_X, f_\bullet),
\end{equation}
see
Modules, Definition \ref{modules-definition-koszul-complex},
is acyclic in degrees $> 0$. We say that $f_1, \ldots, f_r$ is a
{\it $H_1$-regular sequence} if the Koszul complex
$K_\bullet(\mathcal{O}_X, f_\bullet)$ is exact in degree $1$. Finally,
we say that $f_1, \ldots, f_r$ is a
{\it quasi-regular} sequence if the map
\begin{equation}
\label{equation-map-quasi-regular}
\mathcal{O}_X/\mathcal{J}[T_1, \ldots, T_r]
\longrightarrow
\bigoplus\nolimits_{d \geq 0} \mathcal{J}^d/\mathcal{J}^{d + 1}
\end{equation}
is an isomorphism of sheaves where $\mathcal{J} \subset \mathcal{O}_X$
is the sheaf of ideals generated by $f_1, \ldots, f_r$. (There is also
a notion of $\mathcal{F}$-regular and $\mathcal{F}$-quasi-regular sequence
for a given $\mathcal{O}_X$-module $\mathcal{F}$ which we will introduce
here if we ever need it.)

\begin{lemma}
\label{lemma-types-regular-sequences-implications}
Let $X$ be a ringed space.
Let $f_1, \ldots, f_r \in \Gamma(X, \mathcal{O}_X)$.
We have the following implications
$f_1, \ldots, f_r$ is a regular sequence $\Rightarrow$
$f_1, \ldots, f_r$ is a Koszul-regular sequence $\Rightarrow$
$f_1, \ldots, f_r$ is an $H_1$-regular sequence $\Rightarrow$
$f_1, \ldots, f_r$ is a quasi-regular sequence.
\end{lemma}

\begin{proof}
Since we may check exactness at stalks, a
sequence $f_1, \ldots, f_r$ is a regular sequence if and only
if the maps
$$
f_i :
\mathcal{O}_{X, x}/(f_1, \ldots, f_{i - 1})
\longrightarrow
\mathcal{O}_{X, x}/(f_1, \ldots, f_{i - 1})
$$
are injective for all $x \in X$. In other words, the image of the sequence
$f_1, \ldots, f_r$ in the ring $\mathcal{O}_{X, x}$ is a
regular sequence for all $x \in X$. The other types of regularity
can be checked stalkwise as well (details omitted).
Hence the implications follow from
More on Algebra, Lemmas
\ref{more-algebra-lemma-regular-koszul-regular} and
\ref{more-algebra-lemma-H1-regular-quasi-regular}.
\end{proof}

\begin{definition}
\label{definition-regular-ideal-sheaf}
Let $X$ be a ringed space. Let $\mathcal{J} \subset \mathcal{O}_X$
be a sheaf of ideals.
\begin{enumerate}
\item We say $\mathcal{J}$ is {\it regular} if for every
$x \in \text{Supp}(\mathcal{O}_X/\mathcal{J})$ there exists an open
neighbourhood $x \in U \subset X$ and a regular sequence
$f_1, \ldots, f_r \in \mathcal{O}_X(U)$ such that $\mathcal{J}|_U$
is generated by $f_1, \ldots, f_r$.
\item We say $\mathcal{J}$ is {\it Koszul-regular} if for every
$x \in \text{Supp}(\mathcal{O}_X/\mathcal{J})$ there exists an open
neighbourhood $x \in U \subset X$ and a Koszul-regular sequence
$f_1, \ldots, f_r \in \mathcal{O}_X(U)$ such that $\mathcal{J}|_U$
is generated by $f_1, \ldots, f_r$.
\item We say $\mathcal{J}$ is {\it $H_1$-regular} if for every
$x \in \text{Supp}(\mathcal{O}_X/\mathcal{J})$ there exists an open
neighbourhood $x \in U \subset X$ and a $H_1$-regular sequence
$f_1, \ldots, f_r \in \mathcal{O}_X(U)$ such that $\mathcal{J}|_U$
is generated by $f_1, \ldots, f_r$.
\item We say $\mathcal{J}$ is {\it quasi-regular} if for every
$x \in \text{Supp}(\mathcal{O}_X/\mathcal{J})$ there exists an open
neighbourhood $x \in U \subset X$ and a quasi-regular sequence
$f_1, \ldots, f_r \in \mathcal{O}_X(U)$ such that $\mathcal{J}|_U$
is generated by $f_1, \ldots, f_r$.
\end{enumerate}
\end{definition}

\noindent
Many properties of this notion immediately follow from the
corresponding notions for regular and quasi-regular sequences
in rings.

\begin{lemma}
\label{lemma-regular-quasi-regular-scheme}
Let $X$ be a ringed space. Let $\mathcal{J}$ be a sheaf of ideals.
We have the following implications:
$\mathcal{J}$ is regular $\Rightarrow$
$\mathcal{J}$ is Koszul-regular $\Rightarrow$
$\mathcal{J}$ is $H_1$-regular $\Rightarrow$
$\mathcal{J}$ is quasi-regular.
\end{lemma}

\begin{proof}
The lemma immediately reduces to
Lemma \ref{lemma-types-regular-sequences-implications}.
\end{proof}

\begin{lemma}
\label{lemma-quasi-regular-ideal}
Let $X$ be a locally ringed space. Let $\mathcal{J} \subset \mathcal{O}_X$
be a sheaf of ideals. Then $\mathcal{J}$ is quasi-regular if and
only if the following conditions are satisfied:
\begin{enumerate}
\item $\mathcal{J}$ is an $\mathcal{O}_X$-module of finite type,
\item $\mathcal{J}/\mathcal{J}^2$ is a finite locally free
$\mathcal{O}_X/\mathcal{J}$-module, and
\item the canonical maps
$$
\text{Sym}^n_{\mathcal{O}_X/\mathcal{J}}(\mathcal{J}/\mathcal{J}^2)
\longrightarrow
\mathcal{J}^n/\mathcal{J}^{n + 1}
$$
are isomorphisms for all $n \geq 0$.
\end{enumerate}
\end{lemma}

\begin{proof}
It is clear that if $U \subset X$ is an open such that
$\mathcal{J}|_U$ is generated by a quasi-regular sequence
$f_1, \ldots, f_r \in \mathcal{O}_X(U)$ then $\mathcal{J}|_U$
is of finite type, $\mathcal{J}|_U/\mathcal{J}^2|_U$ is free
with basis $f_1, \ldots, f_r$, and the maps in (3) are isomorphisms
because they are coordinate free formulation of the degree $n$
part of (\ref{equation-map-quasi-regular}). Hence it is clear that
being quasi-regular implies conditions (1), (2), and (3).

\medskip\noindent
Conversely, suppose that (1), (2), and (3) hold. Pick a point
$x \in \text{Supp}(\mathcal{O}_X/\mathcal{J})$. Then there exists
a neighbourhood $U \subset X$ of $x$ such that
$\mathcal{J}|_U/\mathcal{J}^2|_U$
is free of rank $r$ over $\mathcal{O}_U/\mathcal{J}|_U$.
After possibly shrinking $U$ we may assume there exist
$f_1, \ldots, f_r \in \mathcal{J}(U)$ which map to a basis
of $\mathcal{J}|_U/\mathcal{J}^2|_U$ as an
$\mathcal{O}_U/\mathcal{J}|_U$-module.
In particular we see that the images of $f_1, \ldots, f_r$ in
$\mathcal{J}_x/\mathcal{J}^2_x$ generate. Hence by Nakayama's lemma
(Algebra, Lemma \ref{algebra-lemma-NAK})
we see that $f_1, \ldots, f_r$ generate the stalk $\mathcal{J}_x$.
Hence, since $\mathcal{J}$ is of finite type, by
Modules, Lemma \ref{modules-lemma-finite-type-surjective-on-stalk}
after shrinking $U$ we may assume that $f_1, \ldots, f_r$ generate
$\mathcal{J}$. Finally, from (3) and the isomorphism
$\mathcal{J}|_U/\mathcal{J}^2|_U = \bigoplus \mathcal{O}_U/\mathcal{J}|_U f_i$
it is clear that $f_1, \ldots, f_r \in \mathcal{O}_X(U)$
is a quasi-regular sequence.
\end{proof}

\begin{lemma}
\label{lemma-generate-regular-ideal}
Let $(X, \mathcal{O}_X)$ be a locally ringed space.
Let $\mathcal{J} \subset \mathcal{O}_X$ be a sheaf of ideals.
Let $x \in X$ and $f_1, \ldots, f_r \in \mathcal{J}_x$ whose images
give a basis for the $\kappa(x)$-vector space
$\mathcal{J}_x/\mathfrak m_x\mathcal{J}_x$.
\begin{enumerate}
\item If $\mathcal{J}$ is quasi-regular, then there exists an open
neighbourhood such that $f_1, \ldots, f_r \in \mathcal{O}_X(U)$
form a quasi-regular sequence generating $\mathcal{J}|_U$.
\item If $\mathcal{J}$ is $H_1$-regular, then there exists an open
neighbourhood such that $f_1, \ldots, f_r \in \mathcal{O}_X(U)$
form an $H_1$-regular sequence generating $\mathcal{J}|_U$.
\item If $\mathcal{J}$ is Koszul-regular, then there exists an open
neighbourhood such that $f_1, \ldots, f_r \in \mathcal{O}_X(U)$
form an Koszul-regular sequence generating $\mathcal{J}|_U$.
\end{enumerate}
\end{lemma}

\begin{proof}
First assume that $\mathcal{J}$ is quasi-regular. We may choose an
open neighbourhood $U \subset X$ of $x$ and a quasi-regular sequence
$g_1, \ldots, g_s \in \mathcal{O}_X(U)$ which generates $\mathcal{J}|_U$.
Note that this implies that $\mathcal{J}/\mathcal{J}^2$ is free of
rank $s$ over $\mathcal{O}_U/\mathcal{J}|_U$ (see
Lemma \ref{lemma-quasi-regular-ideal}
and its proof) and hence $r = s$.
We may shrink $U$ and assume $f_1, \ldots, f_r \in \mathcal{J}(U)$.
Thus we may write
$$
f_i = \sum a_{ij} g_j
$$
for some $a_{ij} \in \mathcal{O}_X(U)$. By assumption the matrix
$A = (a_{ij})$ maps to an invertible matrix over $\kappa(x)$.
Hence, after shrinking $U$ once more, we may assume that $(a_{ij})$
is invertible. Thus we see that $f_1, \ldots, f_r$ give a basis
for $(\mathcal{J}/\mathcal{J}^2)|_U$ which proves that $f_1, \ldots, f_r$
is a quasi-regular sequence over $U$.

\medskip\noindent
Note that in order to prove (2) and (3) we may, because the assumptions
of (2) and (3) are stronger than the assumption in (1), already assume that
$f_1, \ldots, f_r \in \mathcal{J}(U)$ and $f_i = \sum a_{ij}g_j$
with $(a_{ij})$ invertible as above, where now $g_1, \ldots, g_r$
is a $H_1$-regular or Koszul-regular sequence. Since the Koszul complex
on $f_1, \ldots, f_r$ is isomorphic to the Koszul complex on
$g_1, \ldots, g_r$ via the matrix $(a_{ij})$ (see
More on Algebra, Lemma \ref{more-algebra-lemma-change-basis})
we conclude that $f_1, \ldots, f_r$ is $H_1$-regular or Koszul-regular
as desired.
\end{proof}

\begin{lemma}
\label{lemma-regular-ideal-sheaf-quasi-coherent}
Any regular, Koszul-regular, $H_1$-regular, or quasi-regular sheaf
of ideals on a scheme is a finite type quasi-coherent sheaf of ideals.
\end{lemma}

\begin{proof}
This follows as such a sheaf of ideals is locally generated by
finitely many sections. And any sheaf of ideals locally generated
by sections on a scheme is quasi-coherent, see
Schemes, Lemma \ref{schemes-lemma-closed-subspace-scheme}.
\end{proof}

\begin{lemma}
\label{lemma-regular-ideal-sheaf-scheme}
Let $X$ be a scheme. Let $\mathcal{J}$ be a sheaf of ideals.
Then $\mathcal{J}$ is regular
(resp.\ Koszul-regular, $H_1$-regular, quasi-regular) if and only if
for every $x \in \text{Supp}(\mathcal{O}_X/\mathcal{J})$ there exists
an affine open neighbourhood $x \in U \subset X$, $U = \Spec(A)$
such that $\mathcal{J}|_U = \widetilde{I}$ and such that $I$
is generated by a regular (resp.\ Koszul-regular, $H_1$-regular,
quasi-regular) sequence $f_1, \ldots, f_r \in A$.
\end{lemma}

\begin{proof}
By assumption we can find an open neighbourhood $U$ of $x$ over which
$\mathcal{J}$ is generated by a
regular (resp.\ Koszul-regular, $H_1$-regular, quasi-regular)
sequence $f_1, \ldots, f_r \in \mathcal{O}_X(U)$. After shrinking
$U$ we may assume that $U$ is affine, say $U = \Spec(A)$.
Since $\mathcal{J}$ is quasi-coherent by
Lemma \ref{lemma-regular-ideal-sheaf-quasi-coherent}
we see that $\mathcal{J}|_U = \widetilde{I}$ for some ideal $I \subset A$.
Now we can use the fact that
$$
\widetilde{\ } : \text{Mod}_A \longrightarrow \textit{QCoh}(U)
$$
is an equivalence of categories which preserves exactness. For example
the fact that the functions $f_i$ generate $\mathcal{J}$ means that
the $f_i$, seen as elements of $A$ generate $I$. The fact that
(\ref{equation-map-regular}) is injective
(resp.\ (\ref{equation-koszul}) is exact, (\ref{equation-koszul}) is exact
in degree $1$, (\ref{equation-map-quasi-regular}) is an isomorphism)
implies the correponding property of the map
$A/(f_1, \ldots, f_{i - 1}) \to A/(f_1, \ldots, f_{i - 1})$
(resp.\ the complex $K_\bullet(A, f_1, \ldots, f_r)$, the
map $A/I[T_1, \ldots, T_r] \to \bigoplus I^n/I^{n + 1}$).
Thus $f_1, \ldots, f_r \in A$ is a regular
(resp.\ Koszul-regular, $H_1$-regular, quasi-regular)
sequence of the ring $A$.
\end{proof}

\begin{lemma}
\label{lemma-Noetherian-scheme-regular-ideal}
Let $X$ be a locally Noetherian scheme. Let $\mathcal{J} \subset \mathcal{O}_X$
be a quasi-coherent sheaf of ideals. Let $x$ be a point of the support of
$\mathcal{O}_X/\mathcal{J}$. The following are equivalent
\begin{enumerate}
\item $\mathcal{J}_x$ is generated by a regular sequence in
$\mathcal{O}_{X, x}$,
\item $\mathcal{J}_x$ is generated by a Koszul-regular sequence in
$\mathcal{O}_{X, x}$,
\item $\mathcal{J}_x$ is generated by an $H_1$-regular sequence in
$\mathcal{O}_{X, x}$,
\item $\mathcal{J}_x$ is generated by a quasi-regular sequence in
$\mathcal{O}_{X, x}$,
\item there exists an affine neighbourhood $U = \Spec(A)$ of $x$ such
that $\mathcal{J}|_U = \widetilde{I}$ and $I$ is generated by a
regular sequence in $A$, and
\item there exists an affine neighbourhood $U = \Spec(A)$ of $x$ such
that $\mathcal{J}|_U = \widetilde{I}$ and $I$ is generated by a
Koszul-regular sequence in $A$, and
\item there exists an affine neighbourhood $U = \Spec(A)$ of $x$ such
that $\mathcal{J}|_U = \widetilde{I}$ and $I$ is generated by an
$H_1$-regular sequence in $A$, and
\item there exists an affine neighbourhood $U = \Spec(A)$ of $x$ such
that $\mathcal{J}|_U = \widetilde{I}$ and $I$ is generated by a
quasi-regular sequence in $A$,
\item there exists a neighbourhood $U$ of $x$ such that $\mathcal{J}|_U$
is regular, and
\item there exists a neighbourhood $U$ of $x$ such that $\mathcal{J}|_U$
is Koszul-regular, and
\item there exists a neighbourhood $U$ of $x$ such that $\mathcal{J}|_U$
is $H_1$-regular, and
\item there exists a neighbourhood $U$ of $x$ such that $\mathcal{J}|_U$
is quasi-regular.
\end{enumerate}
In particular, on a locally Noetherian scheme the notions of
regular, Koszul-regular, $H_1$-regular, or quasi-regular ideal sheaf all agree.
\end{lemma}

\begin{proof}
It follows from
Lemma \ref{lemma-regular-ideal-sheaf-scheme}
that (5) $\Leftrightarrow$ (9), (6) $\Leftrightarrow$ (10),
(7) $\Leftrightarrow$ (11), and (8) $\Leftrightarrow$ (12).
It is clear that (5) $\Rightarrow$ (1), (6) $\Rightarrow$ (2),
(7) $\Rightarrow$ (3), and (8) $\Rightarrow$ (4).
We have (1) $\Rightarrow$ (5) by
Algebra, Lemma \ref{algebra-lemma-regular-sequence-in-neighbourhood}.
We have (9) $\Rightarrow$ (10) $\Rightarrow$ (11) $\Rightarrow$ (12) by
Lemma \ref{lemma-regular-quasi-regular-scheme}.
Finally, (4) $\Rightarrow$ (1) by
Algebra, Lemma \ref{algebra-lemma-quasi-regular-regular}.
Now all 12 statements are equivalent.
\end{proof}













\section{Regular immersions}
\label{section-regular-immersions}

\noindent
Let $i : Z \to X$ be an immersion of schemes. By definition this means
there exists an open subscheme $U \subset X$ such that
$Z$ is identified with a closed subscheme of $U$. Let
$\mathcal{I} \subset \mathcal{O}_U$ be the corresponding quasi-coherent
sheaf of ideals. Suppose $U' \subset X$ is a second such open
subscheme, and denote $\mathcal{I}' \subset \mathcal{O}_{U'}$
the corresponding quasi-coherent sheaf of ideals. Then
$\mathcal{I}|_{U \cap U'} = \mathcal{I}'|_{U \cap U'}$.
Moreover, the support of $\mathcal{O}_U/\mathcal{I}$
is $Z$ which is contained in $U \cap U'$ and is also the
support of $\mathcal{O}_{U'}/\mathcal{I}'$. Hence it follows from
Definition \ref{definition-regular-ideal-sheaf}
that $\mathcal{I}$ is a regular ideal if and only if
$\mathcal{I}'$ is a regular ideal. Similarly for being Koszul-regular,
$H_1$-regular, or quasi-regular.

\begin{definition}
\label{definition-regular-immersion}
Let $i : Z \to X$ be an immersion of schemes. Choose an open subscheme
$U \subset X$ such that $i$ identifies $Z$ with a closed
subscheme of $U$ and denote $\mathcal{I} \subset \mathcal{O}_U$
the corresponding quasi-coherent sheaf of ideals.
\begin{enumerate}
\item We say $i$ is a {\it regular immersion} if
$\mathcal{I}$ is regular.
\item We say $i$ is a {\it Koszul-regular immersion} if
$\mathcal{I}$ is Koszul-regular.
\item We say $i$ is a {\it $H_1$-regular immersion} if
$\mathcal{I}$ is $H_1$-regular.
\item We say $i$ is a {\it quasi-regular immersion} if
$\mathcal{I}$ is quasi-regular.
\end{enumerate}
\end{definition}

\noindent
The discussion above shows that this is independent of the choice
of $U$. The conditions are listed in decreasing order of strength, see
Lemma \ref{lemma-regular-quasi-regular-immersion}.
A Koszul-regular closed immersion is smooth locally a regular immersion, see
Lemma \ref{lemma-koszul-regular-smooth-locally-regular}.
In the locally Noetherian case all four notions agree, see
Lemma \ref{lemma-Noetherian-scheme-regular-ideal}.

\begin{lemma}
\label{lemma-regular-quasi-regular-immersion}
Let $i : Z \to X$ be an immersion of schemes.
We have the following implications:
$i$ is regular $\Rightarrow$
$i$ is Koszul-regular $\Rightarrow$
$i$ is $H_1$-regular $\Rightarrow$
$i$ is quasi-regular.
\end{lemma}

\begin{proof}
The lemma immediately reduces to
Lemma \ref{lemma-regular-quasi-regular-scheme}.
\end{proof}

\begin{lemma}
\label{lemma-regular-immersion-noetherian}
Let $i : Z \to X$ be an immersion of schemes.
Assume $X$ is locally Noetherian. Then
$i$ is regular $\Leftrightarrow$
$i$ is Koszul-regular $\Leftrightarrow$
$i$ is $H_1$-regular $\Leftrightarrow$
$i$ is quasi-regular.
\end{lemma}

\begin{proof}
Follows immediately from
Lemma \ref{lemma-regular-quasi-regular-immersion}
and
Lemma \ref{lemma-Noetherian-scheme-regular-ideal}.
\end{proof}

\begin{lemma}
\label{lemma-flat-base-change-regular-immersion}
Let $i : Z \to X$ be a regular (resp.\ Koszul-regular,
$H_1$-regular, quasi-regular) immersion. Let $X' \to X$ be a flat
morphism. Then the base change $i' : Z \times_X X' \to X'$
is a regular (resp.\ Koszul-regular,
$H_1$-regular, quasi-regular) immersion.
\end{lemma}

\begin{proof}
Via
Lemma \ref{lemma-regular-ideal-sheaf-scheme}
this translates into the algebraic statements in
Algebra, Lemmas \ref{algebra-lemma-flat-increases-depth} and
\ref{algebra-lemma-flat-base-change-quasi-regular}
and
More on Algebra,
Lemma \ref{more-algebra-lemma-koszul-regular-flat-base-change}.
\end{proof}

\begin{lemma}
\label{lemma-quasi-regular-immersion}
Let $i : Z \to X$ be an immersion of schemes. Then $i$ is a quasi-regular
immersion if and only if the following conditions are satisfied
\begin{enumerate}
\item $i$ is locally of finite presentation,
\item the conormal sheaf $\mathcal{C}_{Z/X}$ is finite locally free, and
\item the map (\ref{equation-conormal-algebra-quotient}) is an isomorphism.
\end{enumerate}
\end{lemma}

\begin{proof}
An open immersion is locally of finite presentation. Hence we may
replace $X$ by an open subscheme $U \subset X$ such that $i$ identifies
$Z$ with a closed subscheme of $U$, i.e., we may assume that $i$
is a closed immersion. Let $\mathcal{I} \subset \mathcal{O}_X$ be the
corresponding quasi-coherent sheaf of ideals. Recall, see
Morphisms, Lemma \ref{morphisms-lemma-closed-immersion-finite-presentation}
that $\mathcal{I}$ is of finite type if and only if $i$ is locally
of finite presentation. Hence the equivalence follows from
Lemma \ref{lemma-quasi-regular-ideal}
and unwinding the definitions.
\end{proof}

\begin{lemma}
\label{lemma-transitivity-conormal-quasi-regular}
Let $Z \to Y \to X$ be immersions of schemes. Assume that
$Z \to Y$ is $H_1$-regular. Then the canonical sequence of
Morphisms, Lemma \ref{morphisms-lemma-transitivity-conormal}
$$
0 \to i^*\mathcal{C}_{Y/X} \to
\mathcal{C}_{Z/X} \to
\mathcal{C}_{Z/Y} \to 0
$$
is exact and locally split.
\end{lemma}

\begin{proof}
Since $\mathcal{C}_{Z/Y}$ is finite locally free (see
Lemma \ref{lemma-quasi-regular-immersion}
and
Lemma \ref{lemma-regular-quasi-regular-scheme})
it suffices to prove that the sequence is exact. By what was proven in
Morphisms, Lemma \ref{morphisms-lemma-transitivity-conormal}
it suffices to show that the first map is injective.
Working affine locally this reduces to the following question:
Suppose that we have a ring $A$ and ideals $I \subset J \subset A$.
Assume that $J/I \subset A/I$ is generated by an $H_1$-regular sequence.
Does this imply that $I/I^2 \otimes_A A/J \to J/J^2$ is injective?
Note that $I/I^2 \otimes_A A/J = I/IJ$. Hence we are trying to prove
that $I \cap J^2 = IJ$. This is the result of
More on Algebra, Lemma \ref{more-algebra-lemma-conormal-sequence-H1-regular}.
\end{proof}

\noindent
A composition of quasi-regular immersions may not be quasi-regular, see
Algebra, Remark \ref{algebra-remark-join-quasi-regular-sequences}.
The other types of regular immersions are preserved under composition.

\begin{lemma}
\label{lemma-composition-regular-immersion}
Let $i : Z \to Y$ and $j : Y \to X$ be immersions of schemes.
\begin{enumerate}
\item If $i$ and $j$ are regular immersions, so is $j \circ i$.
\item If $i$ and $j$ are Koszul-regular immersions, so is $j \circ i$.
\item If $i$ and $j$ are $H_1$-regular immersions, so is $j \circ i$.
\item If $i$ is an $H_1$-regular immersion and $j$ is a quasi-regular
immersion, then $j \circ i$ is a quasi-regular immersion.
\end{enumerate}
\end{lemma}

\begin{proof}
The algebraic version of (1) is
Algebra, Lemma \ref{algebra-lemma-join-regular-sequences}.
The algebraic version of (2) is
More on Algebra, Lemma \ref{more-algebra-lemma-join-koszul-regular-sequences}.
The algebraic version of (3) is
More on Algebra, Lemma \ref{more-algebra-lemma-join-H1-regular-sequences}.
The algebraic version of (4) is
More on Algebra, Lemma \ref{more-algebra-lemma-join-quasi-regular-H1-regular}.
\end{proof}

\begin{lemma}
\label{lemma-permanence-regular-immersion}
Let $i : Z \to Y$ and $j : Y \to X$ be immersions of schemes. Assume
that the sequence
$$
0 \to i^*\mathcal{C}_{Y/X} \to
\mathcal{C}_{Z/X} \to
\mathcal{C}_{Z/Y} \to 0
$$
of
Morphisms, Lemma \ref{morphisms-lemma-transitivity-conormal}
is exact and locally split.
\begin{enumerate}
\item If $j \circ i$ is a quasi-regular immersion, so is $i$.
\item If $j \circ i$ is a $H_1$-regular immersion, so is $i$.
\item If both $j$ and $j \circ i$ are Koszul-regular immersions, so is $i$.
\end{enumerate}
\end{lemma}

\begin{proof}
After shrinking $Y$ and $X$ we may assume that $i$ and $j$ are closed
immersions. Denote $\mathcal{I} \subset \mathcal{O}_X$ the ideal sheaf
of $Y$ and $\mathcal{J} \subset \mathcal{O}_X$ the ideal sheaf of $Z$.
The conormal sequence is $0 \to \mathcal{I}/\mathcal{I}\mathcal{J}
\to \mathcal{J}/\mathcal{J}^2 \to
\mathcal{J}/(\mathcal{I} + \mathcal{J}^2) \to 0$.
Let $z \in Z$ and set $y = i(z)$, $x = j(y) = j(i(z))$.
Choose $f_1, \ldots, f_n \in \mathcal{I}_x$ which map to a basis of
$\mathcal{I}_x/\mathfrak m_z\mathcal{I}_x$. Extend this to
$f_1, \ldots, f_n, g_1, \ldots, g_m \in \mathcal{J}_x$
which map to a basis of $\mathcal{J}_x/\mathfrak m_z\mathcal{J}_x$.
This is possible as we have assumed that the sequence of conormal
sheaves is split in a neighbourhood of $z$, hence
$\mathcal{I}_x/\mathfrak m_x\mathcal{I}_x \to
\mathcal{J}_x/\mathfrak m_x\mathcal{J}_x$ is injective.

\medskip\noindent
Proof of (1). By
Lemma \ref{lemma-generate-regular-ideal}
we can find an affine open neighbourhood $U$ of $x$ such that
$f_1, \ldots, f_n, g_1, \ldots, g_m$ forms a quasi-regular sequence
generating $\mathcal{J}$. Hence by
Algebra, Lemma \ref{algebra-lemma-truncate-quasi-regular}
we see that $g_1, \ldots, g_m$ induces a quasi-regular sequence on
$Y \cap U$ cutting out $Z$.

\medskip\noindent
Proof of (2). Exactly the same as the proof of (1) except using
More on Algebra, Lemma \ref{more-algebra-lemma-truncate-H1-regular}.

\medskip\noindent
Proof of (3). By
Lemma \ref{lemma-generate-regular-ideal}
(applied twice)
we can find an affine open neighbourhood $U$ of $x$ such that
$f_1, \ldots, f_n$ forms a Koszul-regular sequence generating
$\mathcal{I}$ and $f_1, \ldots, f_n, g_1, \ldots, g_m$ forms a
Koszul-regular sequence generating $\mathcal{J}$. Hence by
More on Algebra, Lemma \ref{more-algebra-lemma-truncate-koszul-regular}
we see that $g_1, \ldots, g_m$ induces a Koszul-regular sequence on
$Y \cap U$ cutting out $Z$.
\end{proof}

\begin{lemma}
\label{lemma-extra-permanence-regular-immersion-noetherian}
Let $i : Z \to Y$ and $j : Y \to X$ be immersions of schemes.
Pick $z \in Z$ and denote $y \in Y$, $x \in X$ the corresponding points.
Assume $X$ is locally Noetherian.
The following are equivalent
\begin{enumerate}
\item $i$ is a regular immersion in a neighbourhood of $z$ and $j$
is a regular immersion in a neighbourhood of $y$,
\item $i$ and $j \circ i$ are regular immersions in a neighbourhood of $z$,
\item $j \circ i$ is a regular immersion in a neighbourhood of $z$ and the
conormal sequence
$$
0 \to i^*\mathcal{C}_{Y/X} \to
\mathcal{C}_{Z/X} \to
\mathcal{C}_{Z/Y} \to 0
$$
is split exact in a neighbourhood of $z$.
\end{enumerate}
\end{lemma}

\begin{proof}
Since $X$ (and hence $Y$) is locally Noetherian all 4 types of regular
immersions agree, and moreover we may check whether a morphism is a
regular immersion on the level of local rings, see
Lemma \ref{lemma-Noetherian-scheme-regular-ideal}.
The implication (1) $\Rightarrow$ (2) is
Lemma \ref{lemma-composition-regular-immersion}.
The implication (2) $\Rightarrow$ (3) is
Lemma \ref{lemma-transitivity-conormal-quasi-regular}.
Thus it suffices to prove that (3) implies (1).

\medskip\noindent
Assume (3). Set $A = \mathcal{O}_{X, x}$. Denote $I \subset A$ the kernel
of the surjective map $\mathcal{O}_{X, x} \to \mathcal{O}_{Y, y}$ and
denote $J \subset A$ the kernel
of the surjective map $\mathcal{O}_{X, x} \to \mathcal{O}_{Z, z}$.
Note that any mimimal sequence of elements generating $J$ in $A$
is a quasi-regular hence regular sequence, see
Lemma \ref{lemma-generate-regular-ideal}.
By assumption the conormal sequence
$$
0 \to I/IJ \to J/J^2 \to J/(I + J^2 \to 0
$$
is split exact as a sequence of $A/J$-modules. Hence we can pick
a minimal system of generators $f_1, \ldots, f_n, g_1, \ldots, g_m$
of $J$ with $f_1, \ldots, f_n \in I$ a minimal system of generators of $I$.
As pointed out above $f_1, \ldots, f_n, g_1, \ldots, g_m$ is a regular
sequence in $A$. It follows directly from the definition of a regular
sequence that $f_1, \ldots, f_n$ is a regular sequence in $A$ and
$\overline{g}_1, \ldots, \overline{g}_m$ is a regular sequence in
$A/I$. Thus $j$ is a regular immersion at $y$ and $i$ is a regular
immersion at $z$.
\end{proof}

\begin{remark}
\label{remark-not-always-extra-permance}
In the situation of
Lemma \ref{lemma-extra-permanence-regular-immersion-noetherian}
parts (1), (2), (3) are {\bf not} equivalent to
``$j \circ i$ and $j$ are regular immersions at $z$ and $y$''.
An example is $X = \mathbf{A}^1_k = \Spec(k[x])$,
$Y = \Spec(k[x]/(x^2))$ and $Z = \Spec(k[x]/(x))$.
\end{remark}

\begin{lemma}
\label{lemma-koszul-regular-smooth-locally-regular}
Let $i : Z \to X$ be a Koszul regular closed immersion.
Then there exists a surjective smooth morphism $X' \to X$ such
that the base change $i' : Z \times_X X' \to X'$ of $i$ is
a regular immersion.
\end{lemma}

\begin{proof}
We may assume that $X$ is affine and the ideal of $Z$ generated by
a Koszul-regular sequence by replacing $X$ by the members of a suitable
affine open covering (affine opens as in
Lemma \ref{lemma-regular-ideal-sheaf-scheme}).
The affine case is
More on Algebra,
Lemma \ref{more-algebra-lemma-Koszul-regular-flat-locally-regular}.
\end{proof}





\section{Relative regular immersions}
\label{section-relative-regular-immersion}

\noindent
In this section we consider the base change property for regular immersions.
The following lemma does not hold for regular immersions
or for Koszul immersions, see
Examples, Lemma \ref{examples-lemma-base-change-regular-sequence}.

\begin{lemma}
\label{lemma-relative-regular-immersion}
Let $f : X \to S$ be a morphism of schemes.
Let $i : Z \subset X$ be an immersion.
Assume
\begin{enumerate}
\item $i$ is an $H_1$-regular (resp.\ quasi-regular) immersion, and
\item $Z \to S$ is a flat morphism.
\end{enumerate}
Then for every morphism of schemes $g : S' \to S$ the base change
$Z' = S' \times_S Z \to X' = S' \times_S X$
is an $H_1$-regular (resp.\ quasi-regular) immersion.
\end{lemma}

\begin{proof}
Unwinding the definitions and using
Lemma \ref{lemma-regular-ideal-sheaf-scheme}
we translate this into algebra as follows.
Let $A \to B$ be a ring map and $f_1, \ldots, f_r \in B$.
Assume $B/(f_1, \ldots, f_r)B$ is flat over $A$. Consider a ring
map $A \to A'$. Set $B' = B \otimes_A A'$ and $J' = JB'$.

\medskip\noindent
Case I: $f_1, \ldots, f_r$ is quasi-regular. Set $J = (f_1, \ldots, f_r)$.
By assumption $J^n/J^{n + 1}$ is isomorphic to a direct sum of copies of
$B/J$ hence flat over $A$. By induction and
Algebra, Lemma \ref{algebra-lemma-flat-ses}
we conclude that $B/J^n$ is flat over $A$. The ideal $(J')^n$ is equal to
$J^n \otimes_A A'$, see
Algebra, Lemma \ref{algebra-lemma-flat-tor-zero}.
Hence $(J')^n/(J')^{n + 1} = J^n/J^{n + 1} \otimes_A A'$ which clearly
implies that $f_1, \ldots, f_r$ is a quasi-regular sequence in $B'$.

\medskip\noindent
Case II: $f_1, \ldots, f_r$ is $H_1$-regular. By
More on Algebra, Lemma \ref{more-algebra-lemma-base-change-H1-regular}
the vanishing of the Koszul homology group
$H_1(K_\bullet(B, f_1, \ldots, f_r))$
implies the vanshing of $H_1(K_\bullet(B', f'_1, \ldots, f'_r))$
and we win.
\end{proof}

\noindent
This lemma is the motivation for the following definition.

\begin{definition}
\label{definition-relative-H1-regular-immersion}
Let $f : X \to S$ be a morphism of schemes.
Let $i : Z \to X$ be an immersion.
\begin{enumerate}
\item We say $i$ is a {\it relative quasi-regular immersion}
if $Z \to S$ is flat and $i$ is a quasi-regular immersion.
\item We say $i$ is a {\it relative $H_1$-regular immersion}
if $Z \to S$ is flat and $i$ is an $H_1$-regular immersion.
\end{enumerate}
\end{definition}

\noindent
We warn the reader that this may be nonstandard notation.
Lemma \ref{lemma-relative-regular-immersion}
guarantees that relative quasi-regular (resp.\ $H_1$-regular)
immersions are preserved under any base change.
A relative $H_1$-regular immersion is a relative quasi-regular immersion, see
Lemma \ref{lemma-regular-quasi-regular-immersion}.
Please take a look at
Lemma \ref{lemma-flat-relative-H1-regular}
(or
Lemma \ref{lemma-relative-regular-immersion-flat-in-neighbourhood})
which shows that if $Z \to X$ is a relative $H_1$-regular
(or quasi-regular) immersion and the ambient scheme is (flat and)
locally of finite presentation over $S$, then $Z \to X$
is actually a regular immersion and the same remains true after
any base change.

\begin{lemma}
\label{lemma-quasi-regular-immersion-flat-at-x}
Let $f : X \to S$ be a morphism of schemes.
Let $Z \to X$ be a relative quasi-regular immersion.
If $x \in Z$ and $\mathcal{O}_{X, x}$ is Noetherian, then $f$ is flat at $x$.
\end{lemma}

\begin{proof}
Let $f_1, \ldots, f_r \in \mathcal{O}_{X, x}$ be a quasi-regular
sequence cutting out the ideal of $Z$ at $x$. By
Algebra, Lemma \ref{algebra-lemma-quasi-regular-regular}
we know that $f_1, \ldots, f_r$ is a regular sequence.
Hence $f_r$ is a nonzerodivisor on
$\mathcal{O}_{X, x}/(f_1, \ldots, f_{r - 1})$ such that the
quotient is a flat $\mathcal{O}_{S, f(x)}$-module.
By
Lemma \ref{lemma-flat-at-x}
we conclude that $\mathcal{O}_{X, x}/(f_1, \ldots, f_{r - 1})$
is a flat $\mathcal{O}_{S, f(x)}$-module.
Continuing by induction we find that $\mathcal{O}_{X, x}$
is a flat $\mathcal{O}_{S, s}$-module.
\end{proof}

\begin{lemma}
\label{lemma-relative-regular-immersion-flat-in-neighbourhood}
Let $X \to S$ be a morphism of schemes.
Let $Z \to X$ be an immersion.
Assume
\begin{enumerate}
\item $X \to S$ is flat and locally of finite presentation,
\item $Z \to X$ is a relative quasi-regular immersion.
\end{enumerate}
Then $Z \to X$ is a regular immersion and
the same remains true after any base change.
\end{lemma}

\begin{proof}
Pick $x \in Z$ with image $s \in S$. To prove this it suffices to
find an affine neighbourhood of $x$ contained in $U$ such that the
result holds on that affine open. Hence we may assume that $X$ is affine
and there exist a quasi-regular sequence
$f_1, \ldots, f_r \in \Gamma(X, \mathcal{O}_X)$
such that $Z = V(f_1, \ldots, f_r)$. By
Lemma \ref{lemma-relative-regular-immersion}
and its proof the sequence $f_1|_{X_s}, \ldots, f_r|_{X_s}$ is a
quasi-regular sequence in $\Gamma(X_s, \mathcal{O}_{X_s})$.
Since $X_s$ is Noetherian, this implies, possibly after shrinking
$X$ a bit, that $f_1|_{X_s}, \ldots, f_r|_{X_s}$ is a regular
sequence, see
Algebra, Lemmas \ref{algebra-lemma-quasi-regular-regular} and
\ref{algebra-lemma-regular-sequence-in-neighbourhood}.
By
Lemma \ref{lemma-fibre-Cartier}
it follows that $Z_1 = V(f_1) \subset X$ is a relative effective
Cartier divisor, again after possibly shrinking $X$ a bit.
Applying the same lemma again, but now to $Z_2 = V(f_1, f_2) \subset Z_1$
we see that $Z_2 \subset Z_1$ is a relative effective Cartier divisor.
And so on until on reaches $Z = Z_n = V(f_1, \ldots, f_n)$.
Since being a relative effective Cartier divisor is preserved under
arbitrary base change, see
Lemma \ref{lemma-relative-Cartier},
we also see that the final statement of the lemma holds.
\end{proof}

\begin{lemma}
\label{lemma-flat-relative-H1-regular}
Let $X \to S$ be a morphism of schemes.
Let $Z \to X$ be a relative $H_1$-regular immersion.
Assume $X \to S$ is locally of finite presentation. Then
\begin{enumerate}
\item there exists an open subscheme $U \subset X$ such that
$Z \subset U$ and such that $U \to S$ is flat, and
\item $Z \to X$ is a regular immersion and the same remains
true after any base change.
\end{enumerate}
\end{lemma}

\begin{proof}
Pick $x \in Z$. To prove (1) suffices to find an open neighbourhood
$U \subset X$ of $x$ such that $U \to S$ is flat. Hence the lemma reduces
to the case that $X = \Spec(B)$ and $S = \Spec(A)$ are affine
and that $Z$ is given by an $H_1$-regular sequence $f_1, \ldots, f_r \in B$.
By assumption $B$ is a finitely presented $A$-algebra and
$B/(f_1, \ldots, f_r)B$ is a flat $A$-algebra. We are going to use
absolute Noetherian approximation.

\medskip\noindent
Write $B = A[x_1, \ldots, x_n]/(g_1, \ldots, g_m)$. Assume
$f_i$ is the image of $f_i' \in A[x_1, \ldots, x_n]$. Choose a finite type
$\mathbf{Z}$-subalgebra $A_0 \subset A$ such that all the coefficients
of the polynomials $f_1', \ldots, f_r', g_1, \ldots, g_m$ are in $A_0$.
We set $B_0 = A_0[x_1, \ldots, x_n]/(g_1, \ldots, g_m)$ and we denote
$f_{i, 0}$ the image of $f_i'$ in $B_0$. Then $B = B_0 \otimes_{A_0} A$
and
$$
B/(f_1, \ldots, f_r) =
B_0/(f_{0, 1}, \ldots, f_{0, r}) \otimes_{A_0} A.
$$
By
Algebra, Lemma \ref{algebra-lemma-flat-finite-presentation-limit-flat}
we may, after enlarging $A_0$, assume that
$B_0/(f_{0, 1}, \ldots, f_{0, r})$ is flat over $A_0$.
It may not be the case at this point that the Koszul cohomology group
$H_1(K_\bullet(B_0, f_{0, 1}, \ldots, f_{0, r}))$ is zero.
On the other hand, as $B_0$ is Noetherian, it is a finitely
generated $B_0$-module. Let
$\xi_1, \ldots, \xi_n \in H_1(K_\bullet(B_0, f_{0, 1}, \ldots, f_{0, r}))$
be generators. Let $A_0 \subset A_1 \subset A$ be a larger finite type
$\mathbf{Z}$-subalgebra of $A$. Denote $f_{1, i}$ the image
of $f_{0, i}$ in $B_1 = B_0 \otimes_{A_0} A_1$. By
More on Algebra, Lemma \ref{more-algebra-lemma-base-change-H1-regular}
the map
$$
H_1(K_\bullet(B_0, f_{0, 1}, \ldots, f_{0, r})) \otimes_{A_0} A_1
\longrightarrow
H_1(K_\bullet(B_1, f_{1, 1}, \ldots, f_{1, r}))
$$
is surjective. Furthermore, it is clear that the colimit (over all
choices of $A_1$ as above) of the
complexes $K_\bullet(B_1, f_{1, 1}, \ldots, f_{1, r})$ is the complex
$K_\bullet(B, f_1, \ldots, f_r)$ which is acyclic in degree $1$. Hence
$$
\colim_{A_0 \subset A_1 \subset A}
H_1(K_\bullet(B_1, f_{1, 1}, \ldots, f_{1, r}))
= 0
$$
by
Algebra, Lemma \ref{algebra-lemma-directed-colimit-exact}.
Thus we can find a choice of $A_1$ such that $\xi_1, \ldots, \xi_n$
all map to zero in $H_1(K_\bullet(B_1, f_{1, 1}, \ldots, f_{1, r}))$.
In other words, the Koszul cohomology group
$H_1(K_\bullet(B_1, f_{1, 1}, \ldots, f_{1, r}))$
is zero.

\medskip\noindent
Consider the morphism of affine schemes
$X_1 \to S_1$ equal to $\Spec$ of the
ring map $A_1 \to B_1$ and
$Z_1 = \Spec(B_1/(f_{1, 1}, \ldots, f_{1, r}))$.
Since $B = B_1 \otimes_{A_1} A$, i.e., $X = X_1 \times_{S_1} S$,
and similarly $Z = Z_1 \times_S S_1$,
it now suffices to prove (1) for $X_1 \to S_1$ and the relative
$H_1$-regular immersion $Z_1 \to X_1$, see
Morphisms, Lemma \ref{morphisms-lemma-base-change-module-flat}.
Hence we have reduced to the case where $X \to S$ is a finite type
morphism of Noetherian schemes.
In this case we know that $X \to S$ is flat at every
point of $Z$ by
Lemma \ref{lemma-quasi-regular-immersion-flat-at-x}.
Combined with the fact that the flat locus is open in this case, see
Algebra, Theorem \ref{algebra-theorem-openess-flatness}
we see that (1) holds. Part (2) then follows from an application of
Lemma \ref{lemma-relative-regular-immersion-flat-in-neighbourhood}.
\end{proof}

\noindent
If the ambient scheme is flat and locally of finite presentation over
the base, then we can characterize a relative
quasi-regular immersion in terms of its fibres.

\begin{lemma}
\label{lemma-fibre-quasi-regular}
Let $\varphi : X \to S$ be a flat morphism which is locally of finite
presentation. Let $T \subset X$ be a closed subscheme.
Let $x \in T$ with image $s \in S$.
\begin{enumerate}
\item If $T_s \subset X_s$ is a quasi-regular immersion
in a neighbourhood of $x$, then there exists an open
$U \subset X$ and a relative quasi-regular immersion
$Z \subset U$ such that $Z_s = T_s \cap U_s$ and $T \cap U \subset Z$.
\item If $T_s \subset X_s$ is a quasi-regular immersion
in a neighbourhood of $x$, the morphism $T \to X$ is of finite
presentation, and $T \to S$ is flat at $x$, then we can choose $U$ and
$Z$ as in (1) such that $T \cap U = Z$.
\item If $T_s \subset X_s$ is a quasi-regular immersion in a neighbourhood
of $x$, and $T$ is cut out by $c$ equations in a neighbourhood of $x$,
where $c = \dim_x(X_s) - \dim_x(T_s)$, then we can choose $U$ and $Z$ as in (1)
such that $T \cap U = Z$.
\end{enumerate}
In each case $Z \to U$ is a regular immersion by
Lemma \ref{lemma-relative-regular-immersion-flat-in-neighbourhood}.
In particular, if $T \to S$ is locally of finite presentation and flat and
all fibres $T_s \subset X_s$ are quasi-regular immersions, then
$T \to X$ is a relative quasi-regular immersion.
\end{lemma}

\begin{proof}
Choose affine open neighbourhoods $\Spec(A)$ of $s$ and
$\Spec(B)$ of $x$ such that
$\varphi(\Spec(B)) \subset \Spec(A)$.
Let $\mathfrak p \subset A$ be the prime ideal corresponding to $s$.
Let $\mathfrak q \subset B$ be the prime ideal corresponding to $x$.
Let $I \subset B$ be the ideal corresponding to $T$.
By the initial assumption of the lemma we know that
$A \to B$ is flat and of finite presentation.
The assumption in (1) means that, after shrinking $\Spec(B)$, we may
assume $I(B \otimes_A \kappa(\mathfrak p))$ is generated by a
quasi-regular sequence of elements. After possibly localizing $B$
at some $g \in B$, $g \not \in \mathfrak q$ we may assume there
exist $f_1, \ldots, f_r \in I$ which map to a quasi-regular
sequence in $B \otimes_A \kappa(\mathfrak p)$ which generates
$I(B \otimes_A \kappa(\mathfrak p))$. By
Algebra, Lemmas \ref{algebra-lemma-quasi-regular-regular} and
\ref{algebra-lemma-regular-sequence-in-neighbourhood}
we may assume after another localization that
$f_1, \ldots, f_r \in I$ form a regular
sequence in $B \otimes_A \kappa(\mathfrak p)$. By
Lemma \ref{lemma-fibre-Cartier}
it follows that $Z_1 = V(f_1) \subset \Spec(B)$
is a relative effective Cartier divisor, again after possibly
localizing $B$. Applying the same lemma again, but now to
$Z_2 = V(f_1, f_2) \subset Z_1$ we see that $Z_2 \subset Z_1$
is a relative effective Cartier divisor. And so on until one
reaches $Z = Z_n = V(f_1, \ldots, f_n)$. Then
$Z \to \Spec(B)$ is a regular immersion and $Z$ is
flat over $S$, in particular $Z \to \Spec(B)$ is
a relative quasi-regular immersion over $\Spec(A)$.
This proves (1).

\medskip\noindent
To see (2) consider the closed immersion $Z \to D$. The surjective
ring map $u : \mathcal{O}_{D, x} \to \mathcal{O}_{Z, x}$
is a map of flat local $\mathcal{O}_{S, s}$-algebras which
are essentially of finite presentation, and which becomes an
isomorphisms after dividing by $\mathfrak m_s$. Hence it is
an isomorphism, see
Algebra, Lemma \ref{algebra-lemma-mod-injective-general}.
It follows that $Z \to D$ is an isomorphism in a neighbourhood
of $x$, see
Algebra, Lemma \ref{algebra-lemma-local-isomorphism}.

\medskip\noindent
To see (3), after possibly shrinking $U$ we may assume that
the ideal of $Z$ is generated by a regular sequence $f_1, \ldots, f_r$
(see our construction of $Z$ above)
and the ideal of $T$ is generated by $g_1, \ldots, g_c$.
We claim that $c = r$. Namely,
\begin{align*}
\dim_x(X_s) & = \dim(\mathcal{O}_{X_s, x}) +
\text{trdeg}_{\kappa(s)}(\kappa(x)), \\
\dim_x(T_s) & = \dim(\mathcal{O}_{T_s, x}) +
\text{trdeg}_{\kappa(s)}(\kappa(x)), \\
\dim(\mathcal{O}_{X_s, x}) & = \dim(\mathcal{O}_{T_s, x}) + r
\end{align*}
the first two equalities by
Algebra, Lemma \ref{algebra-lemma-dimension-at-a-point-finite-type-field}
and the second by $r$ times applying
Algebra, Lemma \ref{algebra-lemma-one-equation}.
As $T \subset Z$ we see that
$f_i = \sum b_{ij} g_j$. But the ideals of $Z$ and $T$ cut out the same
quasi-regular closed subscheme of $X_s$ in a neighbourhood of $x$. Hence
the matrix $(b_{ij}) \bmod \mathfrak m_x$ is invertible (some details
omitted). Hence $(b_{ij})$ is invertible in an
open neighbourhood of $x$. In other words,
$T \cap U = Z$ after shrinking $U$.

\medskip\noindent
The final statements of the lemma follow immediately from
part (2), combined with the fact that $Z \to S$
is locally of finite presentation if and only if $Z \to X$ is
of finite presentation, see
Morphisms, Lemmas \ref{morphisms-lemma-composition-finite-presentation} and
\ref{morphisms-lemma-finite-presentation-permanence}.
\end{proof}

\noindent
The following lemma is an enhancement of
Morphisms, Lemma \ref{morphisms-lemma-section-smooth-morphism}.

\begin{lemma}
\label{lemma-section-smooth-regular-immersion}
Let $f : X \to S$ be a smooth morphism of schemes.
Let $\sigma : S \to X$ be a section of $f$.
Then $\sigma$ is a regular immersion.
\end{lemma}

\begin{proof}
By
Schemes, Lemma \ref{schemes-lemma-semi-diagonal}
the morphism $\sigma$ is an immersion.
After replacing $X$ by an open neighbourhood of $\sigma(S)$
we may assume that $\sigma$ is a closed immersion.
Let $T = \sigma(S)$ be the corresponding closed subscheme of $X$.
Since $T \to S$ is an isomorphism it is flat and of finite presentation.
Also a smooth morphism is flat and locally of finite presentation, see
Morphisms, Lemmas \ref{morphisms-lemma-smooth-flat} and
\ref{morphisms-lemma-smooth-locally-finite-presentation}.
Thus, according to
Lemma \ref{lemma-fibre-quasi-regular},
it suffices to show that $T_s \subset X_s$ is a quasi-regular closed
subscheme. This follows immediately from
Morphisms, Lemma \ref{morphisms-lemma-section-smooth-morphism}
but we can also see it directly as follows.
Let $k$ be a field and let $A$ be a smooth $k$-algebra.
Let $\mathfrak m \subset A$ be a maximal ideal whose residue field is $k$.
Then $\mathfrak m$ is generated by a quasi-regular sequence, possibly
after replacing $A$ by $A_g$ for some $g \in A$, $g \not \in \mathfrak m$.
In
Algebra, Lemma \ref{algebra-lemma-characterize-smooth-over-field}
we proved that $A_{\mathfrak m}$ is a regular local ring,
hence $\mathfrak mA_{\mathfrak m}$ is generated by a regular sequence.
This does indeed imply that $\mathfrak m$ is generated by a
regular sequence (after replacing $A$ by $A_g$ for some $g \in A$,
$g \not \in \mathfrak m$), see
Algebra, Lemma \ref{algebra-lemma-regular-sequence-in-neighbourhood}.
\end{proof}

\noindent
The following lemma has a kind of converse, see
Lemma \ref{lemma-push-regular-immersion-thru-smooth}.

\begin{lemma}
\label{lemma-lift-regular-immersion-to-smooth}
Let
$$
\xymatrix{
Y \ar[rd]_j \ar[rr]_i & & X \ar[ld] \\
& S
}
$$
be a commutative diagram of morphisms of schemes.
Assume $X \to S$ smooth, and $i$, $j$ immersions.
If $j$ is a regular (resp.\ Koszul-regular, $H_1$-regular, quasi-regular)
immersion, then so is $i$.
\end{lemma}

\begin{proof}
We can write $i$ as the composition
$$
Y \to Y \times_S X \to X
$$
By
Lemma \ref{lemma-section-smooth-regular-immersion}
the first arrow is a regular immersion.
The second arrow is a flat base change of $Y \to S$, hence is a
regular (resp.\ Koszul-regular, $H_1$-regular, quasi-regular) immersion, see
Lemma \ref{lemma-flat-base-change-regular-immersion}.
We conclude by an application of
Lemma \ref{lemma-composition-regular-immersion}.
\end{proof}

\begin{lemma}
\label{lemma-immersion-lci-into-smooth-regular-immersion}
Let
$$
\xymatrix{
Y \ar[rd] \ar[rr]_i & & X \ar[ld] \\
& S
}
$$
be a commutative diagram of morphisms of schemes.
Assume that $Y \to S$ is syntomic, $X \to S$ smooth, and
$i$ an immersion. Then $i$ is a regular immersion.
\end{lemma}

\begin{proof}
After replacing $X$ by an open neighbourhood of $i(Y)$
we may assume that $i$ is a closed immersion.
Let $T = i(Y)$ be the corresponding closed subscheme of $X$. Since
$T \cong Y$ the morphism $T \to S$ is flat and of finite presentation
(Morphisms, Lemmas
\ref{morphisms-lemma-syntomic-locally-finite-presentation} and
\ref{morphisms-lemma-syntomic-flat}).
Also a smooth morphism is flat and locally of finite presentation
(Morphisms, Lemmas
\ref{morphisms-lemma-smooth-flat} and
\ref{morphisms-lemma-smooth-locally-finite-presentation}).
Thus, according to
Lemma \ref{lemma-fibre-quasi-regular},
it suffices to show that $T_s \subset X_s$ is a quasi-regular closed
subscheme. As $X_s$ is locally of finite type over a field, it is Noetherian
(Morphisms, Lemma \ref{morphisms-lemma-finite-type-noetherian}).
Thus we can check that $T_s \subset X_s$ is a quasi-regular immersion
at points, see
Lemma \ref{lemma-Noetherian-scheme-regular-ideal}.
Take $t \in T_s$. By
Morphisms, Lemma \ref{morphisms-lemma-local-complete-intersection}
the local ring $\mathcal{O}_{T_s, t}$ is a local complete intersection
over $\kappa(s)$.
The local ring $\mathcal{O}_{X_s, t}$ is regular, see
Algebra, Lemma \ref{algebra-lemma-characterize-smooth-over-field}.
By
Algebra, Lemma \ref{algebra-lemma-lci-local}
we see that the kernel of the surjection
$\mathcal{O}_{X_s, t} \to \mathcal{O}_{T_s, t}$ is generated by a regular
sequence, which is what we had to show.
\end{proof}

\begin{lemma}
\label{lemma-immersion-smooth-into-smooth-regular-immersion}
Let
$$
\xymatrix{
Y \ar[rd] \ar[rr]_i & & X \ar[ld] \\
& S
}
$$
be a commutative diagram of morphisms of schemes.
Assume that $Y \to S$ is smooth, $X \to S$ smooth, and
$i$ an immersion. Then $i$ is a regular immersion.
\end{lemma}

\begin{proof}
This is a special case of
Lemma \ref{lemma-immersion-lci-into-smooth-regular-immersion}
because a smooth morphism is syntomic, see
Morphisms, Lemma \ref{morphisms-lemma-smooth-syntomic}.
\end{proof}

\begin{lemma}
\label{lemma-push-regular-immersion-thru-smooth}
Let
$$
\xymatrix{
Y \ar[rd]_j \ar[rr]_i & & X \ar[ld] \\
& S
}
$$
be a commutative diagram of morphisms of schemes.
Assume $X \to S$ smooth, and $i$, $j$ immersions.
If $i$ is a Koszul-regular (resp.\ $H_1$-regular, quasi-regular)
immersion, then so is $j$.
\end{lemma}

\begin{proof}
Let $y \in Y$ be any point. Set $x = i(y)$ and set $s = j(y)$.
It suffices to prove the result after replacing $X, S$ by open
neighbourhoods $U, V$ of $x, s$ and $Y$ by an open neighbourhood
of $y$ in $i^{-1}(U) \cap j^{-1}(V)$. Hence we may assume that
$Y$, $X$ and $S$ are affine. In this case we can choose a closed
immersion $h : X \to \mathbf{A}^n_S$ over $S$ for some $n$. Note that
$h$ is a regular immersion by
Lemma \ref{lemma-immersion-smooth-into-smooth-regular-immersion}.
Hence $h \circ i$ is a Koszul-regular (resp.\ $H_1$-regular, quasi-regular)
immersion, see
Lemmas \ref{lemma-composition-regular-immersion} and
\ref{lemma-regular-quasi-regular-immersion}.
In this way we reduce to the case $X = \mathbf{A}^n_S$ and $S$ affine.

\medskip\noindent
After replacing $S$ by an affine open $V$ and replacing $Y$ by
$j^{-1}(V)$ we may assume that $i$ is a closed immersion and $S$
affine. Write $S = \Spec(A)$. Then $j : Y \to S$ defines an
isomorphism of $Y$ to the closed subscheme $\Spec(A/I)$ for
some ideal $I \subset A$. The map
$i : Y = \Spec(A/I) \to
\mathbf{A}^n_S = \Spec(A[x_1, \ldots, x_n])$
corresponds to an $A$-algebra homomorphism
$i^\sharp : A[x_1, \ldots, x_n] \to A/I$.
Choose $a_i \in A$ which map to $i^\sharp(x_i)$ in $A/I$.
Observe that the ideal of the closed immersion $i$ is
$$
J = (x_1 - a_1, \ldots, x_n - a_n) + IA[x_1, \ldots, x_n].
$$
Set $K = (x_1 - a_1, \ldots, x_n - a_n)$. We claim the sequence
$$
0 \to K/KJ \to J/J^2 \to J/(K + J^2) \to 0
$$
is split exact. To see this note that $K/K^2$ is free with basis
$x_i - a_i$ over the ring $A[x_1, \ldots, x_n]/K \cong A$.
Hence $K/KJ$ is free with the same basis over the ring
$A[x_1, \ldots, x_n]/J \cong A/I$. On the other hand, taking derivatives
gives a map
$$
\text{d}_{A[x_1, \ldots, x_n]/A} :
J/J^2
\longrightarrow
\Omega_{A[x_1, \ldots, x_n]/A} \otimes_{A[x_1, \ldots, x_n]}
A[x_1, \ldots, x_n]/J
$$
which maps the generators $x_i - a_i$ to the basis elements $\text{d}x_i$
of the free module on the right. The claim follows. Moreover, note that
$x_1 - a_1, \ldots, x_n - a_n$ is a regular sequence in
$A[x_1, \ldots, x_n]$ with quotient ring
$A[x_1, \ldots, x_n]/(x_1 - a_1, \ldots, x_n - a_n) \cong A$.
Thus we have a factorization
$$
Y \to V(x_1 - a_1, \ldots, x_n - a_n) \to \mathbf{A}^n_S
$$
of our closed immersion $i$ where the composition is
Koszul-regular (resp.\ $H_1$-regular, quasi-regular),
the second arrow is a regular immersion, and the associated conormal
sequence is split. Now the result follows from
Lemma \ref{lemma-permanence-regular-immersion}.
\end{proof}











\section{Meromorphic functions and sections}
\label{section-meromorphic-functions}

\noindent
See \cite{misconceptions} for some possible
pitfalls\footnote{Danger, Will Robinson!}.

\medskip\noindent
Let $(X, \mathcal{O}_X)$ be a locally ringed space.
For any open $U \subset X$ we have defined the set
$\mathcal{S}(U) \subset \mathcal{O}_X(U)$
of regular sections of $\mathcal{O}_X$ over $U$, see
Definition \ref{definition-regular-section}. The restriction
of a regular section to a smaller open is regular. Hence
$\mathcal{S} : U \mapsto \mathcal{S}(U)$ is a subsheaf (of sets)
of $\mathcal{O}_X$. We sometimes denote $\mathcal{S} = \mathcal{S}_X$
if we want to indicate the dependence on $X$.
Moreover, $\mathcal{S}(U)$
is a multiplicative subset of the ring $\mathcal{O}_X(U)$ for
each $U$. Hence we may consider
the presheaf of rings
$$
U \longmapsto \mathcal{S}(U)^{-1} \mathcal{O}_X(U),
$$
see Modules, Lemma \ref{modules-lemma-simple-invert}.

\begin{definition}
\label{definition-sheaf-meromorphic-functions}
Let $(X, \mathcal{O}_X)$ be a locally ringed space.
The {\it sheaf of meromorphic functions on $X$} is
the sheaf {\it $\mathcal{K}_X$} associated to the presheaf
displayed above. A {\it meromorphic function} on $X$
is a global section of $\mathcal{K}_X$.
\end{definition}

\noindent
Since each element of each $\mathcal{S}(U)$ is a nonzerodivisor on
$\mathcal{O}_X(U)$ we see that the natural map of sheaves
of rings $\mathcal{O}_X \to \mathcal{K}_X$ is injective.

\begin{example}
\label{example-no-change}
Let $A = \mathbf{C}[x, \{y_\alpha\}_{\alpha \in \mathbf{C}}]/
((x - \alpha)y_\alpha, y_\alpha y_\beta)$. Any element of $A$
can be written uniquely as
$f(x) + \sum \lambda_\alpha y_\alpha$ with $f(x) \in \mathbf{C}[x]$
and $\lambda_\alpha \in \mathbf{C}$.
Let $X = \Spec(A)$.
In this case $\mathcal{O}_X = \mathcal{K}_X$, since on
any affine open $D(f)$ the ring $A_f$ any nonzerodivisor is
a unit (proof omitted).
\end{example}

\begin{definition}
\label{definition-pullback-meromorphic-sections}
Let $f : (X, \mathcal{O}_X) \to (Y, \mathcal{O}_Y)$ be a morphism
of locally ringed spaces. We say that {\it pulbacks of meromorphic
functions are defined for $f$} if for every pair of open
$U \subset X$, $V \subset Y$ such that $f(U) \subset V$, and any
section $s \in \Gamma(V, \mathcal{S}_Y)$ the pullback
$f^\sharp(s) \in \Gamma(U, \mathcal{O}_X)$ is an element
of $\Gamma(U, \mathcal{S}_X)$.
\end{definition}

\noindent
In this case there is an induced map
$f^\sharp : f^{-1}\mathcal{K}_Y \to \mathcal{K}_X$,
in other words we obtain a commutative diagram of morphisms
of ringed spaces
$$
\xymatrix{
(X, \mathcal{K}_X) \ar[r] \ar[d]^f &
(X, \mathcal{O}_X) \ar[d]^f \\
(Y, \mathcal{K}_Y) \ar[r] &
(Y, \mathcal{O}_X)
}
$$
We sometimes denote $f^*(s) = f^\sharp(s)$ for a
section $s \in \Gamma(Y, \mathcal{K}_Y)$.

\begin{lemma}
\label{lemma-pullback-meromorphic-sections-defined}
Let $f : X \to Y$ be a morphism of schemes.
In each of the following cases pullbacks of meromorphic
sections are defined.
\begin{enumerate}
\item $X$, $Y$ are integral and $f$ is dominant,
\item $X$ is integral and the generic point of $X$ maps
to a generic point of an irreducible component of $Y$,
\item $X$ is reduced and every generic point of every irreducible
component of $X$ maps to the generic point of an irreducible component
of $Y$,
\item $X$ is locally Noetherian, and any associated point of
$X$ maps to a generic point of an irreducible component of $Y$, and
\item $X$ is locally Noetherian, has no embedded points and
any generic point of an irreducible component of
$X$ maps to the generic point of an irreducible component of $Y$.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted. Hint: Similar to the proof of
Lemma \ref{lemma-pullback-effective-Cartier-defined}, using
the following fact (on $Y$): if an element $x \in R$ maps to
a nonzerodivisor in $R_{\mathfrak p}$ for a minimal prime
$\mathfrak p$ of $R$, then $x \not \in \mathfrak p$.
See Algebra, Lemma \ref{algebra-lemma-minimal-prime-reduced-ring}.
\end{proof}

\noindent
Let $(X, \mathcal{O}_X)$ be a locally ringed space.
Let $\mathcal{F}$ be a sheaf of $\mathcal{O}_X$-modules.
Consider the presheaf $U \mapsto \mathcal{S}(U)^{-1}\mathcal{F}(U)$.
Its sheafification is the sheaf
$\mathcal{F} \otimes_{\mathcal{O}_X} \mathcal{K}_X$, see
Modules, Lemma \ref{modules-lemma-simple-invert-module}.

\begin{definition}
\label{definition-meromorphic-section}
Let $X$ be a locally ringed space.
Let $\mathcal{F}$ be a sheaf of $\mathcal{O}_X$-modules.
\begin{enumerate}
\item We denote
$\mathcal{K}_X(\mathcal{F})$
the sheaf of $\mathcal{K}_X$-modules which is
the sheafification of the presheaf
$U \mapsto \mathcal{S}(U)^{-1}\mathcal{F}(U)$. Equivalently
$\mathcal{K}_X(\mathcal{F}) =
\mathcal{F} \otimes_{\mathcal{O}_X} \mathcal{K}_X$ (see above).
\item A {\it meromorphic section of $\mathcal{F}$}
is a global section of $\mathcal{K}_X(\mathcal{F})$.
\end{enumerate}
\end{definition}

\noindent
In particular we have
$$
\mathcal{K}_X(\mathcal{F})_x
=
\mathcal{F}_x \otimes_{\mathcal{O}_{X, x}} \mathcal{K}_{X, x}
=
\mathcal{S}_x^{-1}\mathcal{F}_x
$$
for any point $x \in X$. However, one has to be careful since it may
not be the case that $\mathcal{S}_x$ is the set of nonzerodivisors
in the local ring $\mathcal{O}_{X, x}$. Namely, there is always
an injective map
$$
\mathcal{K}_{X, x} \longrightarrow Q(\mathcal{O}_{X, x})
$$
to the total quotient ring. It is also surjective if and only if
$\mathcal{S}_x$ is the set of nonzerodivisors in $\mathcal{O}_{X, x}$.

\begin{lemma}
\label{lemma-locally-Noetherian-K}
Let $X$ be a locally Noetherian scheme.
\begin{enumerate}
\item For any $x \in X$ we have $\mathcal{S}_x \subset \mathcal{O}_{X, x}$
is the set of nonzerodivisors, and $\mathcal{K}_{X, x}$
is the total quotient ring of $\mathcal{O}_{X, x}$.
\item For any affine open $\Spec(A) = U \subset X$ we have
that $\mathcal{K}_X(U)$ equals the total quotient ring of $A$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $A$ be a Noetherian ring.
Let $\mathfrak p \subset A$ be a prime ideal.
Let $f, g \in A$, $g \not \in \mathfrak p$.
Let $I = \{x \in A \mid fx = 0\}$.
Suppose $f/g$ is a nonzerodivisor in $A_{\mathfrak p}$.
Then we see that $I_{\mathfrak p} = 0$ by exactness of
localization. Since $A$ is Noetherian we see that $I$
is finitely generated and hence that $g'I = 0$ for some $g' \in A$,
$g' \not \in \mathfrak p$. Hence $f$ is a nonzerodivisor
in $A_{g'}$, i.e., in a Zariski open neighbourhood of $\mathfrak p$.
This proves (1).

\medskip\noindent
Let $f \in \Gamma(X, \mathcal{K}_{X, x})$ be a meromorphic function
on $X = \Spec(A)$. Set $I = \{x \in A \mid xf \in A\}$.
For every prime $\mathfrak p \subset A$ we can write
the image of $f$ in the stalk at $\mathfrak p$ as
$a/b$, $a, b \in A_{\mathfrak p}$ with $b \in A_{\mathfrak p}$
not a zerodivisor. Hence, clearing denominators, we find there exists
an element $x \in I$ such that $x$ maps to a nonzerodivisor on
$A_{\mathfrak p}$. Let
$\text{Ass}(A) = \{\mathfrak q_1, \ldots, \mathfrak q_t\}$ be the
associated primes of $A$. By looking at $IA_{\mathfrak q_i}$ and
using Algebra, Lemma \ref{algebra-lemma-associated-primes-localize}
the above says that
$I \not \subset \mathfrak q_i$ for each $i$. By
Algebra, Lemma \ref{algebra-lemma-silly}
there exists an element $x \in I$, $x \not \in \bigcup \mathfrak q_i$.
By Algebra, Lemma \ref{algebra-lemma-ass-zero-divisors}
we see that $x$ is not a zerodivisor on $A$.
Hence $f = (xf)/x$ is an element of the total ring of fractions of $A$.
This proves (2).
\end{proof}

\begin{lemma}
\label{lemma-reduced-finite-irreducible}
Let $X$ be a scheme.
Assume $X$ is reduced and any quasi-compact open $U \subset X$
has a finite number of irreducible components.
\begin{enumerate}
\item The sheaf $\mathcal{K}_X$ is a quasi-coherent sheaf of
$\mathcal{O}_X$-algebras.
\item For any $x \in X$ we have $\mathcal{S}_x \subset \mathcal{O}_{X, x}$
is the set of nonzerodivisors. In particular $\mathcal{K}_{X, x}$
is the total quotient ring of $\mathcal{O}_{X, x}$.
\item For any affine open $\Spec(A) = U \subset X$ we have
that $\mathcal{K}_X(U)$ equals the total quotient ring of $A$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $X$ be as in the lemma. Let $X^{(0)} \subset X$ be the
set of generic points of irreducible components of $X$. Let
$$
f :
Y = \coprod\nolimits_{\eta \in X^{(0)}} \Spec(\kappa(\eta))
\longrightarrow
X
$$
be the inclusion of the generic points into $X$ using the
canonical maps of Schemes, Section \ref{schemes-section-points}.
(This morphism was used in
Morphisms, Definition \ref{morphisms-definition-normalization}
to define the normalization of $X$.)
We claim that $\mathcal{K}_X = f_*\mathcal{O}_Y$.
First note that $\mathcal{K}_Y = \mathcal{O}_Y$ as $Y$ is a disjoint
union of spectra of field. Next, note that pullbacks of meromorphic
functions are defined for $f$, by
Lemma \ref{lemma-pullback-meromorphic-sections-defined}.
This gives a map
$$
\mathcal{K}_X \longrightarrow f_*\mathcal{O}_Y.
$$
Let $\Spec(A) = U \subset X$ be an affine open.
Then $A$ is a reduced ring with finitely many minimal
primes $\mathfrak q_1, \ldots, \mathfrak q_t$. Then we have
$Q(A) = \prod A_{\mathfrak q_i} = \prod \kappa(\mathfrak q_i)$
by Algebra, Lemmas \ref{algebra-lemma-total-ring-fractions-no-embedded-points}
and \ref{algebra-lemma-minimal-prime-reduced-ring}.
In other words, already the value of the presheaf
$U \mapsto \mathcal{S}(U)^{-1}\mathcal{O}_X(U)$ agrees with
$f_*\mathcal{O}_Y(U)$ on our affine open $U$. Hence the displayed
map is an isomorphism.

\medskip\noindent
Now we are ready to prove (1), (2) and (3).
The morphism $f$ is quasi-compact by our assumption
that the set of irreducible components of $X$ is locally finite.
Hence $f$ is quasi-compact and quasi-separated (as $Y$ is separated).
By Schemes, Lemma \ref{schemes-lemma-push-forward-quasi-coherent}
$f_*\mathcal{O}_Y$ is quasi-coherent.
This proves (1). Let $x \in X$. Then
$$
(f_*\mathcal{O}_Y)_x
=
\prod\nolimits_{\eta \in X^{(0)}, \ x \in \overline{\{\eta\}}} \kappa(\eta)
$$
On the other hand, $\mathcal{O}_{X, x}$
is reduced and has finitely minimal primes $\mathfrak q_i$ corresponding
exactly to those $\eta \in X^{(0)}$ such that
$x \in \overline{\{\eta\}} \kappa(\eta)$. Hence by
Algebra, Lemmas \ref{algebra-lemma-total-ring-fractions-no-embedded-points}
and \ref{algebra-lemma-minimal-prime-reduced-ring} again
we see that
$Q(\mathcal{O}_{X, x}) = \prod \kappa(\mathfrak q_i)$ is the
same as $(f_*\mathcal{O}_Y)_x$. This proves (2).
Part (3) we saw during the course of the proof that
$\mathcal{K}_X = f_*\mathcal{O}_Y$.
\end{proof}

\begin{lemma}
\label{lemma-reduced-normalization}
Let $X$ be a scheme.
Assume $X$ is reduced and any quasi-compact open $U \subset X$
has a finite number of irreducible components.
Then the normalization morphism $\nu : X^\nu \to X$ is the
morphism
$$
\underline{\Spec}_X(\mathcal{O}') \longrightarrow X
$$
where $\mathcal{O}' \subset \mathcal{K}_X$ is the integral
closure of $\mathcal{O}_X$ in the sheaf of meromorphic functions.
\end{lemma}

\begin{proof}
Compare the definition of the normalization morphism
$\nu : X^\nu \to X$ (see
Morphisms, Definition \ref{morphisms-definition-normalization})
with the result $\mathcal{K}_X = f_*\mathcal{O}_Y$ obtained
in the proof of Lemma \ref{lemma-reduced-finite-irreducible} above.
\end{proof}

\begin{lemma}
\label{lemma-meromorphic-functions-integral-scheme}
Let $X$ be an integral scheme with generic point $\eta$. We have
\begin{enumerate}
\item the sheaf of meromorphic functions is
isomorphic to the constant sheaf with value the
function field (see
Morphisms, Definition \ref{morphisms-definition-function-field})
of $X$.
\item for any quasi-coherent sheaf $\mathcal{F}$ on $X$ the
sheaf $\mathcal{K}_X(\mathcal{F})$ is isomorphic to the
constant sheaf with value $\mathcal{F}_\eta$.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{definition}
\label{definition-regular-meromorphic-section}
Let $X$ be a locally ringed space.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
A meromorphic section $s$ of $\mathcal{L}$ is said to be {\it regular}
if the induced map
$\mathcal{K}_X \to \mathcal{K}_X(\mathcal{L})$
is injective. (In other words, this means that $s$ is a regular
section of the invertible $\mathcal{K}_X$-module
$\mathcal{K}_X(\mathcal{L})$. See
Definition \ref{definition-regular-section}.)
\end{definition}

\noindent
First we spell out when (regular) meromorphic sections can be pulled back.
After that we discuss the existence of regular meromorphic sections
and consequences.

\begin{lemma}
\label{lemma-meromorphic-sections-pullback}
Let $f : X \to Y$ be a morphism of locally ringed spaces.
Assume that pullbacks of meromorphic functions are defined
for $f$ (see
Definition \ref{definition-pullback-meromorphic-sections}).
\begin{enumerate}
\item Let $\mathcal{F}$ be a sheaf of $\mathcal{O}_Y$-modules.
There is a canonical pullback map
$f^* : \Gamma(Y, \mathcal{K}_Y(\mathcal{F})) \to
\Gamma(X, \mathcal{K}_X(f^*\mathcal{F}))$
for meromorphic sections of $\mathcal{F}$.
\item Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
A regular meromorphic section $s$ of $\mathcal{L}$ pulls back
to a regular meromorphic section $f^*s$ of $f^*\mathcal{L}$.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\noindent
In some cases we can show regular meromorphic sections exist.

\begin{lemma}
\label{lemma-regular-meromorphic-section-exists}
Let $X$ be a scheme.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
In each of the following cases $\mathcal{L}$ has a regular meromorphic
section:
\begin{enumerate}
\item $X$ is integral,
\item $X$ is reduced and any quasi-compact open has a finite
number of irreducible components, and
\item $X$ is locally Noetherian and has no embedded points.
\end{enumerate}
\end{lemma}

\begin{proof}
In case (1) we have seen in
Lemma \ref{lemma-meromorphic-functions-integral-scheme}
that $\mathcal{K}_X(\mathcal{L})$ is a constant sheaf
with value $\mathcal{L}_\eta$, and hence the result is clear.

\medskip\noindent
Suppose $X$ is a scheme. Let $G \subset X$ be the set of
generic points of irreducible components of $X$. For each $\eta \in G$
denote $j_\eta : \eta \to X$ the canonical morphism
of $\eta = \Spec(\kappa(\eta))$ into $X$
(see Schemes, Lemma \ref{schemes-lemma-characterize-points}). Consider
the sheaf
$$
\mathcal{G}_X(\mathcal{L})
=
\prod\nolimits_{\eta \in G} j_{\eta, *}(\mathcal{L}_\eta).
$$
There is a canonical map
$$
\varphi :
\mathcal{K}_X(\mathcal{L})
\longrightarrow
\mathcal{G}_X(\mathcal{L})
$$
coming from the maps $\mathcal{K}_X(\mathcal{L})_\eta \to \mathcal{L}_\eta$
and adjunction (see
Sheaves, Lemma \ref{sheaves-lemma-stalk-skyscraper-adjoint}).

\medskip\noindent
We claim that in cases (2) and (3) the map $\varphi$ is an isomorphism
for any invertible sheaf $\mathcal{L}$.
Before proving this let us show that cases (2) and (3) follow from this.
Namely, we can choose $s_\eta \in \mathcal{L}_\eta$ which
generate $\mathcal{L}_\eta$, i.e., such that
$\mathcal{L}_\eta = \mathcal{O}_{X, \eta}s_\eta$.
Since the claim applied to $\mathcal{O}_X$ gives
$\mathcal{K}_X = \mathcal{G}_X(\mathcal{O}_X)$ it is
clear that the global section $s = \prod_{\eta \in G} s_\eta$
is regular as desired.

\medskip\noindent
To prove that $\varphi$ is an isomorphism we may work locally on $X$.
For example it suffices to show that sections of
$\mathcal{K}_X(\mathcal{L})$ and $\mathcal{G}_X(\mathcal{L})$
agree over small affine opens $U$. Say $U = \Spec(A)$ and
$\mathcal{L}|_U \cong \mathcal{O}_U$. By
Lemmas \ref{lemma-locally-Noetherian-K} and
\ref{lemma-reduced-finite-irreducible}
we see that $\Gamma(U, \mathcal{K}_X) = Q(A)$ is
the total ring of fractions of $A$. On the other hand,
$\Gamma(U, \mathcal{G}_X(\mathcal{O}_X)) =
\prod_{\mathfrak q \subset A \text{ minimal}} A_{\mathfrak q}$.
In both cases we see that the set of minimal primes of $A$
is finite, say $\mathfrak q_1, \ldots, \mathfrak q_t$,
and that the set of zerodivisors of $A$ is equal to
$\mathfrak q_1 \cup \ldots \cup \mathfrak q_t$ (see
Algebra, Lemma \ref{algebra-lemma-ass-zero-divisors}).
Hence the result follows from
Algebra, Lemma \ref{algebra-lemma-total-ring-fractions-no-embedded-points}.
\end{proof}

\begin{lemma}
\label{lemma-regular-meromorphic-ideal-denominators}
Let $X$ be a scheme.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
Let $s$ be a regular meromorphic section of $\mathcal{L}$.
Let us denote $\mathcal{I} \subset \mathcal{O}_X$ the
sheaf of ideals defined by the rule
$$
\mathcal{I}(V)
=
\{f \in \mathcal{O}_Z(V) \mid fs \in \mathcal{L}(V)\}.
$$
The formula makes sense since
$\mathcal{L}(V) \subset \mathcal{K}_X(\mathcal{L})(V)$.
Then $\mathcal{I}$ is a quasi-coherent sheaf of ideals and
we have injective maps
$$
1 : \mathcal{I} \longrightarrow \mathcal{O}_X,
\quad
s : \mathcal{I} \longrightarrow \mathcal{L}
$$
whose cokernels are supported on closed nowhere dense subsets of $X$.
\end{lemma}

\begin{proof}
The question is local on $X$.
Hence we may assume that $X = \Spec(A)$,
and $\mathcal{L} = \mathcal{O}_X$. After shrinking furhter
we may assume that $s = x/y$ with $a, b \in A$ {\it both}
nonzerodivisors in $A$. Set $I = \{x \in A \mid x(a/b) \in A\}$.

\medskip\noindent
To show that $\mathcal{I}$ is quasi-coherent we have to show
that $I_f = \{x \in A_f \mid x(a/b) \in A_f\}$ for every
$f \in A$. If $c/f^n \in A_f$, $(c/f^n)(a/b) \in A_f$, then we see
that $f^mc(a/b) \in A$ for some $m$, hence $c/f^n \in I_f$.
Conversely it is easy to see that $I_f$ is contained in
$\{x \in A_f \mid x(a/b) \in A_f\}$. This proves quasi-coherence.

\medskip\noindent
Let us prove the final statement. It is clear that $(b) \subset I$.
Hence $V(I) \subset V(b)$ is a nowhere dense subset as $b$ is
a nonzerodivisor. Thus the cokernel of $1$ is supported in a nowhere
dense closed set. The same argument works for the cokerenel
of $s$ since $s(b) = (a) \subset sI \subset A$.
\end{proof}

\begin{definition}
\label{definition-regular-meromorphic-ideal-denominators}
Let $X$ be a scheme.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
Let $s$ be a regular meromorphic section of $\mathcal{L}$.
The sheaf of ideals $\mathcal{I}$ constructed in
Lemma \ref{lemma-regular-meromorphic-ideal-denominators}
is called the {\it ideal sheaf of denominators of $s$}.
\end{definition}

\noindent
Here is a lemma which will be used later.

\begin{lemma}
\label{lemma-make-maps-regular-section}
Suppose given
\begin{enumerate}
\item $X$ a locally Noetherian scheme,
\item $\mathcal{L}$ an invertible $\mathcal{O}_X$-module,
\item $s$ a regular meromorphic section of $\mathcal{L}$, and
\item $\mathcal{F}$ coherent on $X$
without embedded associated points and $\text{Supp}(\mathcal{F}) = X$.
\end{enumerate}
Let $\mathcal{I} \subset \mathcal{O}_X$ be the ideal of
denominators of $s$. Let $T \subset X$ be the union
of the supports of $\mathcal{O}_X/\mathcal{I}$ and
$\mathcal{L}/s(\mathcal{I})$ which is a nowhere dense closed
subset $T \subset X$ according to
Lemma \ref{lemma-regular-meromorphic-ideal-denominators}.
Then there are canonical injective maps
$$
1 : \mathcal{I}\mathcal{F} \to \mathcal{F}, \quad
s : \mathcal{I}\mathcal{F} \to \mathcal{F} \otimes_{\mathcal{O}_X}\mathcal{L}
$$
whose cokernels are supported on $T$.
\end{lemma}

\begin{proof}
Reduce to the affine case with $\mathcal{L} \cong \mathcal{O}_X$,
and $s = a/b$ with $a, b \in A$ both nonzerodivisors.
Proof of reduction step omitted.
Write $\mathcal{F} = \widetilde{M}$.
Let $I = \{x \in A \mid x(a/b) \in A\}$
so that $\mathcal{I} = \widetilde{I}$ (see
proof of Lemma \ref{lemma-regular-meromorphic-ideal-denominators}).
Note that $T = V(I) \cup V((a/b)I)$.
For any $A$-module $M$ consider the map $1 : IM \to M$; this is the
map that gives rise to the map $1$ of the lemma.
Consider on the other hand the map
$\sigma : IM \to M_b, x \mapsto ax/b$.
Since $b$ is not a zerodivisor in $A$, and since
$M$ has support $\Spec(A)$ and no embedded primes we
see that $b$ is a nonzerodivisor on $M$ also. Hence $M \subset M_b$.
By definition of $I$ we have $\sigma(IM) \subset M$ as submodules
of $M_b$. Hence we get an $A$-module map $s : IM \to M$ (namely the
unique map such that $s(z)/1 = \sigma(z)$ in $M_b$ for all $z \in IM$).
It is injective because $a$ is a nonzerodivisor also (on both $A$ and $M$).
It is clear that $M/IM$ is annihilated by $I$ and that
$M/s(IM)$ is annihilated by $(a/b)I$. Thus the lemma follows.
\end{proof}






\section{Relative Proj}
\label{section-relative-proj}

\noindent
Some results on relative Proj.
First some very basic results. Recall that a relative Proj is always
separated over the base, see
Constructions, Lemma \ref{constructions-lemma-relative-proj-separated}.

\begin{lemma}
\label{lemma-relative-proj-quasi-compact}
Let $S$ be a scheme. Let $\mathcal{A}$ be a quasi-coherent graded
$\mathcal{O}_S$-algebra. Let
$p : X = \underline{\text{Proj}}_S(\mathcal{A}) \to S$ be the relative
Proj of $\mathcal{A}$. If one of the following holds
\begin{enumerate}
\item $\mathcal{A}$ is of finite type as a sheaf of
$\mathcal{A}_0$-algebras,
\item $\mathcal{A}$ is generated by $\mathcal{A}_1$ as an
$\mathcal{A}_0$-algebra and $\mathcal{A}_1$ is a finite type
$\mathcal{A}_0$-module,
\item there exists a finite type quasi-coherent $\mathcal{A}_0$-submodule
$\mathcal{F} \subset \mathcal{A}_{+}$ such that
$\mathcal{A}_{+}/\mathcal{F}\mathcal{A}$ is a locally nilpotent
sheaf of ideals of $\mathcal{A}/\mathcal{F}\mathcal{A}$,
\end{enumerate}
then $p$ is quasi-compact.
\end{lemma}

\begin{proof}
The question is local on the base, see
Schemes, Lemma \ref{schemes-lemma-quasi-compact-affine}.
Thus we may assume $S$ is affine.
Say $S = \Spec(R)$ and $\mathcal{A}$ corresponds to the
graded $R$-algebra $A$. Then $X = \text{Proj}(A)$, see
Constructions, Section \ref{constructions-section-relative-proj-via-glueing}.
In case (1) we may after possibly localizing more
assume that $A$ is generated by homogeneous elements
$f_1, \ldots, f_n \in A_{+}$ over $A_0$. Then
$A_{+} = (f_1, \ldots, f_n)$ by
Algebra, Lemma \ref{algebra-lemma-S-plus-generated}.
In case (3) we see that $\mathcal{F} = \widetilde{M}$
for some finite type $A_0$-module $M \subset A_{+}$. Say
$M = \sum A_0f_i$. Say $f_i = \sum f_{i, j}$ is the decomposition
into homogeneous pieces. The condition in (2) signifies that
$A_{+} \subset \sqrt{(f_{i, j})}$. Thus in both cases we conclude that
$\text{Proj}(A)$ is quasi-compact by
Constructions, Lemma \ref{constructions-lemma-proj-quasi-compact}.
Finally, (2) follows from (1).
\end{proof}

\begin{lemma}
\label{lemma-relative-proj-finite-type}
Let $S$ be a scheme. Let $\mathcal{A}$ be a quasi-coherent graded
$\mathcal{O}_S$-algebra. Let
$p : X = \underline{\text{Proj}}_S(\mathcal{A}) \to S$ be the relative
Proj of $\mathcal{A}$. If $\mathcal{A}$ is of finite type as a sheaf of
$\mathcal{O}_S$-algebras, then $p$ is of finite type.
\end{lemma}

\begin{proof}
The assumption implies that $p$ is quasi-compact, see
Lemma \ref{lemma-relative-proj-quasi-compact}. Hence it suffices
to show that $p$ is locally of finite type.
Thus the question is local on the base and target, see
Morphisms, Lemma \ref{morphisms-lemma-locally-finite-type-characterize}.
Say $S = \Spec(R)$ and $\mathcal{A}$ corresponds to the
graded $R$-algebra $A$. After further localizing on $S$ we may
assume that $A$ is a finite type $R$-algebra. The scheme $X$ is constructed
out of glueing the spectra of the rings $A_{(f)}$ for $f \in A_{+}$
homogeneous. Each of these is of finite type over $R$ by
Algebra, Lemma \ref{algebra-lemma-dehomogenize-finite-type}.
Thus $\text{Proj}(A)$ is of finite type over $R$.
\end{proof}

\begin{lemma}
\label{lemma-relative-proj-universally-closed}
Let $S$ be a scheme. Let $\mathcal{A}$ be a quasi-coherent graded
$\mathcal{O}_S$-algebra. Let
$p : X = \underline{\text{Proj}}_S(\mathcal{A}) \to S$ be the relative
Proj of $\mathcal{A}$. If $\mathcal{O}_S \to \mathcal{A}_0$
is an integral algebra map\footnote{In other words, the integral
closure of $\mathcal{O}_S$ in $\mathcal{A}_0$, see
Morphisms, Definition \ref{morphisms-definition-integral-closure}, equals
$\mathcal{A}_0$.} and $\mathcal{A}$ is of finite type as an
$\mathcal{A}_0$-algebra, then $p$ is universally closed.
\end{lemma}

\begin{proof}
The question is local on the base. Thus we may assume that $X = \Spec(R)$
is affine. Let $\mathcal{A}$ be the quasi-coherent $\mathcal{O}_X$-algebra
associated to the graded $R$-algebra $A$. The assumption is that $R \to A_0$
is integral and $A$ is of finite type over $A_0$.
Write $X \to \Spec(R)$ as the composition $X \to \Spec(A_0) \to \Spec(R)$.
Since $R \to A_0$ is an integral ring map, we see that
$\Spec(A_0) \to \Spec(R)$ is universally closed, see
Morphisms, Lemma \ref{morphisms-lemma-integral-universally-closed}.
The quasi-compact (see
Constructions, Lemma \ref{constructions-lemma-proj-quasi-compact}) morphism
$$
\text{Proj}(A) \to \text{Proj}(A_0)
$$
satisfies the existence part of the valuative criterion by
Constructions, Lemma \ref{constructions-lemma-proj-valuative-criterion}
and hence it is universally closed by
Schemes, Proposition \ref{schemes-proposition-characterize-universally-closed}.
Thus $X \to \Spec(R)$ is universally closed as a composition of
universally closed morphisms.
\end{proof}

\begin{lemma}
\label{lemma-relative-proj-proper}
Let $S$ be a scheme. Let $\mathcal{A}$ be a quasi-coherent graded
$\mathcal{O}_S$-algebra. Let
$p : X = \underline{\text{Proj}}_S(\mathcal{A}) \to S$ be the relative
Proj of $\mathcal{A}$. The following conditions are equivalent
\begin{enumerate}
\item $\mathcal{A}_0$ is a finite type $\mathcal{O}_S$-module
and $\mathcal{A}$ is of finite type as an $\mathcal{A}_0$-algebra,
\item $\mathcal{A}_0$ is a finite type $\mathcal{O}_S$-module 
and $\mathcal{A}$ is of finite type as an $\mathcal{O}_S$-algebra
\end{enumerate}
If these conditions hold, then $p$ is locally projective and in
particular proper.
\end{lemma}

\begin{proof}
Assume that $\mathcal{A}_0$ is a finite type $\mathcal{O}_S$-module.
Choose an affine open $U = \Spec(R) \subset X$ such that $\mathcal{A}$
corresponds to a graded $R$-algebra $A$ with $A_0$ a finite $R$-module.
Condition (1) means that (after possibly localizing further on $S$)
that $A$ is a finite type $A_0$-algebra and condition (2) means that
(after possibly localizing further on $S$) that $A$ is a finite type
$R$-algebra. Thus these conditions imply each other by
Algebra, Lemma \ref{algebra-lemma-compose-finite-type}.

\medskip\noindent
A locally projective morphism is proper, see
Morphisms, Lemma \ref{morphisms-lemma-locally-projective-proper}.
Thus we may now assume that $S = \Spec(R)$ and $X = \text{Proj}(A)$
and that $A_0$ is finite over $R$ and $A$ of finite type over $R$.
We will show that $X = \text{Proj}(A) \to \Spec(R)$ is projective.
We urge the reader to prove this for themselves, by directly constructing
a closed immersion of $X$ into a projective space over $R$, instead
of reading the argument we give below.

\medskip\noindent
By Lemma \ref{lemma-relative-proj-finite-type}
we see that $X$ is of finite type over $\Spec(R)$.
Constructions, Lemma \ref{constructions-lemma-ample-on-proj}
tells us that $\mathcal{O}_X(d)$ is ample on $X$ for some $d \geq 1$
(see Properties, Section \ref{properties-section-ample}).
Hence $X \to \Spec(R)$ is quasi-projective (by
Morphisms, Definition \ref{morphisms-definition-quasi-projective}).
By Morphisms, Lemma \ref{morphisms-lemma-quasi-projective-open-projective}
we conclude that $X$ is isomorphic to an open subscheme of a scheme
projective over $\Spec(R)$. Therefore, to finish the proof, it suffices
to show that $X \to \Spec(R)$ is universally closed (use
Morphisms, Lemma \ref{morphisms-lemma-image-proper-scheme-closed}).
This follows from Lemma \ref{lemma-relative-proj-universally-closed}.
\end{proof}

\begin{lemma}
\label{lemma-closed-subscheme-proj}
Let $S$ be a scheme. Let $\mathcal{A}$ be a quasi-coherent graded
$\mathcal{O}_S$-algebra. Let
$p : X = \underline{\text{Proj}}_S(\mathcal{A}) \to S$ be the relative
Proj of $\mathcal{A}$. Let $i : Z \to X$ be a closed subscheme. Denote
$\mathcal{I} \subset \mathcal{A}$ the kernel of the canonical map
$$
\mathcal{A}
\longrightarrow
\bigoplus\nolimits_{d \geq 0} p_*\left((i_*\mathcal{O}_Z)(d)\right)
$$
If $p$ is quasi-compact, then there is an isomorphism
$Z = \underline{\text{Proj}}_S(\mathcal{A}/\mathcal{I})$.
\end{lemma}

\begin{proof}
The morphism $p$ is separated by
Constructions, Lemma \ref{constructions-lemma-relative-proj-separated}.
If $p$ is quasi-compact, then $p_*$ transforms quasi-coherent modules
into quasi-coherent modules, see
Schemes, Lemma \ref{schemes-lemma-push-forward-quasi-coherent}.
Hence $\mathcal{I}$ is a quasi-coherent $\mathcal{O}_S$-module.
In particular, $\mathcal{B} = \mathcal{A}/\mathcal{I}$ is a
quasi-coherent graded $\mathcal{O}_S$-algebra. The functoriality
morphism $Z' = \underline{\text{Proj}}_S(\mathcal{B}) \to
\underline{\text{Proj}}_S(\mathcal{A})$ is everywhere defined and
a closed immersion, see Constructions, Lemma
\ref{constructions-lemma-surjective-graded-rings-map-relative-proj}.
Hence it suffices to prove $Z = Z'$ as closed subschemes of $X$.

\medskip\noindent
Having said this, the question is local on the base and we may assume
that $S = \Spec(R)$ and that $X = \text{Proj}(A)$ for some
graded $R$-algebra $A$. Assume $\mathcal{I} = \widetilde{I}$
for $I \subset A$ a graded ideal. By
Constructions, Lemma \ref{constructions-lemma-proj-quasi-compact}
there exist $f_0, \ldots, f_n \in A_{+}$ such that
$A_{+} \subset \sqrt{(f_0, \ldots, f_n)}$ in other words
$X = \bigcup D_{+}(f_i)$. Therefore, it suffices to check that
$Z \cap D_{+}(f_i) = Z' \cap D_{+}(f_i)$ for each $i$.
By renumbering we may assume $i = 0$.
Say $Z \cap D_{+}(f_0)$, resp.\ $Z' \cap D_{+}(f_0)$
is cut out by the ideal $J$, resp.\ $J'$ of $A_{(f_0)}$.

\medskip\noindent
The inclusion $J' \subset J$.
Let $d$ be the least common multiple of $\deg(f_0), \ldots, \deg(f_n)$.
Note that each of the twists $\mathcal{O}_X(nd)$ is invertible, trivialized
by $f_i^{nd/\deg(f_i)}$ over $D_{+}(f_i)$, and that for any quasi-coherent
module $\mathcal{F}$ on $X$ the multiplication maps
$\mathcal{O}_X(nd) \otimes_{\mathcal{O}_X} \mathcal{F}(m)
\to \mathcal{F}(nd + m)$ are isomorphisms, see
Constructions, Lemma \ref{constructions-lemma-when-invertible}.
Observe that $J'$ is the ideal generated by the elements $g/f_0^e$ where
$g \in I$ is homogeneous of degree $e\deg(f_0)$ (see proof of
Constructions, Lemma
\ref{constructions-lemma-surjective-graded-rings-map-proj}).
Of course, by replacing $g$ by $f_0^lg$ for suitable $l$
we may always assume that $d | e$. Then, since $g$ vanishes as a section of
$\mathcal{O}_X(e\deg(f_0))$ restricted to $Z$ we see that
$g/f_0^d$ is an element of $J$. Thus $J' \subset J$.

\medskip\noindent
Conversely, suppose that $g/f_0^e \in J$. Again we may assume $d | e$.
Pick $i \in \{1, \ldots, n\}$. Then $Z \cap D_{+}(f_i)$ is
cut out by some ideal $J_i \subset A_{(f_i)}$. Moreover,
$$
J \cdot A_{(f_0f_i)} = J_i \cdot A_{(f_0f_i)}
$$
The right hand side is the localization of $J_i$ with respect to
$f_0^{\deg(f_i)}/f_i^{\deg(f_0)}$. It follows that
$$
f_0^{e_i}g/f_i^{(e_i + e)\deg(f_0)/\deg(f_i)} \in J_i
$$
for some $e_i \gg 0$ sufficiently divisible. This proves that
$f_0^{\max(e_i)}g$ is an element of $I$, because its restriction to each
affine open $D_{+}(f_i)$ vanishes on the closed subscheme
$Z \cap D_{+}(f_i)$. Hence $g \in J'$ and we conclude $J \subset J'$
as desired.
\end{proof}

\noindent
In case the closed subscheme is locally cut out by finitely many
equations we can define it by a finite type ideal sheaf of
$\mathcal{A}$.

\begin{lemma}
\label{lemma-closed-subscheme-proj-finite}
Let $S$ be a quasi-compact and quasi-separated scheme.
Let $\mathcal{A}$ be a quasi-coherent graded $\mathcal{O}_S$-algebra. Let
$p : X = \underline{\text{Proj}}_S(\mathcal{A}) \to S$ be the relative
Proj of $\mathcal{A}$. Let $i : Z \to X$ be a closed subscheme.
If $p$ is quasi-compact and $i$ of finite presentation, then there exists
a $d > 0$ and a quasi-coherent finite type $\mathcal{O}_S$-submodule
$\mathcal{F} \subset \mathcal{A}_d$ such that
$Z = \underline{\text{Proj}}_S(\mathcal{A}/\mathcal{F}\mathcal{A})$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-closed-subscheme-proj} we know there exists a
quasi-coherent graded sheaf of ideals $\mathcal{I} \subset \mathcal{A}$
such that $Z = \underline{\text{Proj}}(\mathcal{A}/\mathcal{I})$.
Since $S$ is quasi-compact we can choose a finite affine open covering
$S = U_1 \cup \ldots \cup U_n$. Say $U_i = \Spec(R_i)$. Let
$\mathcal{A}|_{U_i}$ correspond to the graded $R_i$-algebra $A_i$ and
$\mathcal{I}|_{U_i}$ to the graded ideal $I_i \subset A_i$. Note that
$p^{-1}(U_i) = \text{Proj}(A_i)$ as schemes over $R_i$.
Since $p$ is quasi-compact we can choose finitely many homogeneous
elements $f_{i, j} \in A_{i, +}$ such that $p^{-1}(U_i) = D_{+}(f_{i, j})$.
The condition on $Z \to X$ means that the ideal sheaf of $Z$ in
$\mathcal{O}_X$ is of finite type, see
Morphisms, Lemma \ref{morphisms-lemma-closed-immersion-finite-presentation}.
Hence we can find finitely many homogeneous elements
$h_{i, j, k} \in I_i \cap A_{i, +}$ such that the ideal of
$Z \cap D_{+}(f_{i, j})$ is generated by the elements
$h_{i, j, k}/f_{i, j}^{e_{i, j, k}}$. Choose $d > 0$ to be a common multiple
of all the integers $\deg(f_{i, j})$ and $\deg(h_{i, j, k})$.
By Properties, Lemma \ref{properties-lemma-directed-colimit-finite-type}
there exists a finite type $\mathcal{F} \subset \mathcal{I}_d$
such that all the local sections
$$
h_{i, j, k}f_{i, j}^{(d - \deg(h_{i, j, k}))/\deg(f_{i, j})}
$$
are sections of $\mathcal{F}$. By construction $\mathcal{F}$ is a solution.
\end{proof}

\noindent
The following version of Lemma \ref{lemma-closed-subscheme-proj-finite}
will be used in the proof of
Lemma \ref{lemma-composition-admissible-blowups}.

\begin{lemma}
\label{lemma-closed-subscheme-proj-finite-type}
Let $S$ be a quasi-compact and quasi-separated scheme.
Let $\mathcal{A}$ be a quasi-coherent graded $\mathcal{O}_S$-algebra.
Let $p : X = \underline{\text{Proj}}_S(\mathcal{A}) \to S$ be the relative
Proj of $\mathcal{A}$. Let $i : Z \to X$ be a closed subscheme.
Let $U \subset X$ be an open. Assume that
\begin{enumerate}
\item $p$ is quasi-compact,
\item $i$ of finite presentation,
\item $U \cap p(i(Z)) = \emptyset$,
\item $U$ is quasi-compact,
\item $\mathcal{A}_n$ is a finite type $\mathcal{O}_S$-module for all $n$.
\end{enumerate}
Then there exists a $d > 0$ and a quasi-coherent finite type
$\mathcal{O}_S$-submodule $\mathcal{F} \subset \mathcal{A}_d$ with (a)
$Z = \underline{\text{Proj}}_S(\mathcal{A}/\mathcal{F}\mathcal{A})$
and (b) the support of $\mathcal{A}_d/\mathcal{F}$ is disjoint from $U$.
\end{lemma}

\begin{proof}
Let $\mathcal{I} \subset \mathcal{A}$ be the sheaf of quasi-coherent
graded ideals constructed in Lemma \ref{lemma-closed-subscheme-proj}.
Then since $U \cap p(i(Z)) = \emptyset$ we see that
$\mathcal{I}|_U = \mathcal{A}|_U$.
Let $U_i$, $R_i$, $A_i$, $I_i$, $f_{i, j}$, $h_{i, j, k}$, and $d$
be as constructed in the proof of
Lemma \ref{lemma-closed-subscheme-proj-finite}.
Since $U \cap p(i(Z)) = \emptyset$ we see that
$\mathcal{I}|_U = \mathcal{A}_d|_U$ (by our construction of
$\mathcal{I}$ as a kernel). Since $U$ is quasi-compact we
can choose a finite affine open covering $U = W_1 \cup \ldots \cup W_m$.
Since $\mathcal{A}_d$ is of finite type we can find finitely many sections
$g_{t, s} \in \mathcal{A}_d(W_t)$ which generate
$\mathcal{A}_d|_{W_t} = \mathcal{I}_d|_{W_t}$
as an $\mathcal{O}_{W_t}$-module. To finish the proof, note that by
Properties, Lemma \ref{properties-lemma-directed-colimit-finite-type}
there exists a finite type $\mathcal{F} \subset \mathcal{I}_d$
such that all the local sections
$$
h_{i, j, k}f_{i, j}^{(d - \deg(h_{i, j, k}))/\deg(f_{i, j})}
\quad\text{and}\quad
g_{t, s}
$$
are sections of $\mathcal{F}$. By construction $\mathcal{F}$ is a solution.
\end{proof}






\section{Blowing up}
\label{section-blowing-up}

\noindent
Blowing up is an important tool in algebraic geometry.

\begin{definition}
\label{definition-blow-up}
Let $X$ be a scheme. Let $\mathcal{I} \subset \mathcal{O}_X$ be a
quasi-coherent sheaf of ideals, and let $Z \subset X$ be the closed subscheme
corresponding to $\mathcal{I}$, see
Schemes, Definition \ref{schemes-definition-immersion}.
The {\it blowing up of $X$ along $Z$}, or the
{\it blowing up of $X$ in the ideal sheaf $\mathcal{I}$} is
the morphism
$$
b :
\underline{\text{Proj}}_X
\left(\bigoplus\nolimits_{n \geq 0} \mathcal{I}^n\right)
\longrightarrow
X
$$
The {\it exceptional divisor} of the blow up is the inverse image
$b^{-1}(Z)$. Sometimes $Z$ is called the {\it center} of the blowup.
\end{definition}

\noindent
We will see later that the exceptional divisor is an effective Cartier
divisor. Moreover, the blowing up is characterized as the smallest scheme
over $X$ such that the inverse image of $Z$ is an effective Cartier divisor.

\medskip\noindent
If $b : X' \to X$ is the blow up of $X$ in $Z$, then we often denote
$\mathcal{O}_{X'}(n)$ the twists of the structure sheaf. Note that these
are invertible $\mathcal{O}_{X'}$-modules and that
$\mathcal{O}_{X'}(n) = \mathcal{O}_{X'}(1)^{\otimes n}$
because $X'$ is the relative Proj of a quasi-coherent graded
$\mathcal{O}_X$-algebra which is generated in degree $1$, see
Constructions, Lemma \ref{constructions-lemma-apply-relative}.
Note that $\mathcal{O}_{X'}(1)$ is $b$-relatively very ample, even though
$b$ need not be of finite type or even quasi-compact, because
$X'$ comes equipped with a closed immersion into $\mathbf{P}(\mathcal{I})$,
see Morphisms, Example \ref{morphisms-example-very-ample}.

\begin{lemma}
\label{lemma-blowing-up-affine}
Let $X$ be a scheme. Let $\mathcal{I} \subset \mathcal{O}_X$ be a
quasi-coherent sheaf of ideals. Let $U = \Spec(A)$ be an affine open
subscheme of $X$ and let $I \subset A$ be the ideal corresponding to
$\mathcal{I}|_U$. If $b : X' \to X$ is the blow up of $X$ in $\mathcal{I}$,
then there is a canonical isomorphism
$$
b^{-1}(U) = \text{Proj}(\bigoplus\nolimits_{d \geq 0} I^d)
$$
of $b^{-1}(U)$ with the homogeneous spectrum of the Rees algebra
of $I$ in $A$. Moreover, $b^{-1}(U)$ has an affine open covering by
spectra of the affine blowup algebras $A[\frac{I}{a}]$.
\end{lemma}

\begin{proof}
The first statement is clear from the construction of the relative Proj via
glueing, see Constructions, Section
\ref{constructions-section-relative-proj-via-glueing}.
For $a \in I$ denote $a^{(1)}$ the element $a$ seen as an element of
degree $1$ in the Rees algebra $\bigoplus_{n \geq 0} I^n$.
Since these elements generate the Rees algebra over $A$ we see that
$\text{Proj}(\bigoplus_{d \geq 0} I^d)$ is covered by the affine opens
$D_{+}(a^{(1)})$. The affine scheme $D_{+}(a^{(1)})$ is the spectrum of 
the affine blowup algebra $A' = A[\frac{I}{a}]$, see
Algebra, Definition \ref{algebra-definition-blow-up}.
This finishes the proof.
\end{proof}

\begin{lemma}
\label{lemma-flat-base-change-blowing-up}
Let $X_1 \to X_2$ be a flat morphism of schemes. Let $Z_2 \subset X_2$ be a
closed subscheme. Let $Z_1$ be the inverse image of $Z_2$ in $X_1$.
Let $X'_i$ be the blow up of $Z_i$ in $X_i$. Then there exists a cartesian
diagram
$$
\xymatrix{
X_1' \ar[r] \ar[d] & X_2' \ar[d] \\
X_1 \ar[r] & X_2
}
$$
of schemes.
\end{lemma}

\begin{proof}
Let $\mathcal{I}_2$ be the ideal sheaf of $Z_2$ in $X_2$.
Denote $g : X_1 \to X_2$ the given morphism. Then the ideal sheaf
of $Z_1$ is the image of $g^*\mathcal{I}_2 \to \mathcal{O}_{X_1}$
(by definition of the inverse image, see
Schemes, Definition \ref{schemes-definition-inverse-image-closed-subscheme}).
By Constructions, Lemma \ref{constructions-lemma-relative-proj-base-change}
we see that $X_1 \times_{X_2} X_2'$ is the relative Proj of
$\bigoplus_{n \geq 0} g^*\mathcal{I}_2^n$. Because $g$ is flat the map
$g^*\mathcal{I}_2^n \to \mathcal{O}_{X_1}$ is injective with image
$\mathcal{I}_1^n$. Thus we see that $X_1 \times_{X_2} X_2' = X_1'$.
\end{proof}

\begin{lemma}
\label{lemma-blowing-up-gives-effective-Cartier-divisor}
Let $X$ be a scheme. Let $Z \subset X$ be a closed subscheme.
The blowing up $b : X' \to X$ of $Z$ in $X$
has the following properties:
\begin{enumerate}
\item $b|_{b^{-1}(X \setminus Z)} : b^{-1}(X \setminus Z) \to X \setminus Z$
is an isomorphism,
\item the exceptional divisor $E = b^{-1}(Z)$ is an effective Cartier divisor
on $X'$,
\item there is a canonical isomorphism
$\mathcal{O}_{X'}(-1) = \mathcal{O}_{X'}(E)$
\end{enumerate}
\end{lemma}

\begin{proof}
As blowing up commutes with restrictions to open subschemes
(Lemma \ref{lemma-flat-base-change-blowing-up}) the first statement
just means that $X' = X$ if $Z = \emptyset$. In this case we are blowing
up in the ideal sheaf $\mathcal{I} = \mathcal{O}_X$ and the result follows from
Constructions, Example \ref{constructions-example-trivial-proj}.

\medskip\noindent
The second statement is local on $X$, hence we may assume $X$ affine.
Say $X = \Spec(A)$ and $Z = \Spec(A/I)$. By Lemma \ref{lemma-blowing-up-affine}
we see that $X'$ is covered by the spectra of the affine blowup algebras
$A' = A[\frac{I}{a}]$. Then $IA' = aA'$ and $a$ maps to a nonzerodivisor
in $A'$ according to Algebra, Lemma \ref{algebra-lemma-affine-blowup}.
This proves the lemma as the inverse image of $Z$ in $\Spec(A')$
corresponds to $\Spec(A'/IA') \subset \Spec(A')$.

\medskip\noindent
Consider the canonical map
$\psi_{univ, 1} : b^*\mathcal{I} \to \mathcal{O}_{X'}(1)$, see
discussion following Constructions, Definition
\ref{constructions-definition-relative-proj}.
We claim that this factors through an isomorphism
$\mathcal{I}_E \to \mathcal{O}_{X'}(1)$ (which proves the final assertion).
Namely, on the affine open corresponding to the blowup algebra
$A' = A[\frac{I}{a}]$ mentioned above $\psi_{univ, 1}$ corresponds to
the $A'$-module map
$$
I \otimes_A A'
\longrightarrow
\left(\Big(\bigoplus\nolimits_{d \geq 0} I^d\Big)_{a^{(1)}}\right)_1
$$
where $a^{(1)}$ is as in Algebra, Definition \ref{algebra-definition-blow-up}.
We omit the verification that this is the map
$I \otimes_A A' \to IA' = aA'$.
\end{proof}

\begin{lemma}[Universal property blowing up]
\label{lemma-universal-property-blowing-up}
Let $X$ be a scheme. Let $Z \subset X$ be a closed subscheme.
Let $\mathcal{C}$ be the full subcategory of $(\Sch/X)$ consisting
of $Y \to X$ such that the inverse image of $Z$ is an effective
Cartier divisor on $Y$. Then the blowing up $b : X' \to X$ of $Z$ in $X$
is a final object of $\mathcal{C}$.
\end{lemma}

\begin{proof}
We see that $b : X' \to X$ is an object of $\mathcal{C}$ according to
Lemma \ref{lemma-blowing-up-gives-effective-Cartier-divisor}.
Let $f : Y \to X$ be an object of $\mathcal{C}$. We have to show there exists
a unique morphism $Y \to X'$ over $X$. Let $D = f^{-1}(Z)$.
Let $\mathcal{I} \subset \mathcal{O}_X$ be the ideal sheaf of $Z$
and let $\mathcal{I}_D$ be the ideal sheaf of $D$. Then
$f^*\mathcal{I} \to \mathcal{I}_D$ is a surjection
to an invertible $\mathcal{O}_Y$-module. This extends to a map
$\psi : \bigoplus f^*\mathcal{I}^d \to \bigoplus \mathcal{I}_D^d$
of graded $\mathcal{O}_Y$-algebras. (We observe that
$\mathcal{I}_D^d = \mathcal{I}_D^{\otimes d}$ as $D$ is an
effective Cartier divisor.) By the material in
Constructions, Section \ref{constructions-section-relative-proj}
the triple $(1, f : Y \to X, \psi)$ defines a morphism $Y \to X'$ over $X$.
The restriction
$$
Y \setminus D \longrightarrow X' \setminus b^{-1}(Z) = X \setminus Z
$$
is unique. The open $Y \setminus D$ is scheme theoretically dense in $Y$
according to Lemma \ref{lemma-complement-effective-Cartier-divisor}. 
Thus the morphism $Y \to X'$ is unique by
Morphisms, Lemma \ref{morphisms-lemma-equality-of-morphisms}
(also $b$ is separated by Constructions, Lemma
\ref{constructions-lemma-relative-proj-separated}).
\end{proof}

\begin{lemma}
\label{lemma-blow-up-effective-Cartier-divisor}
Let $X$ be a scheme. Let $Z \subset X$ be an effective Cartier divisor.
The blowup of $X$ in $Z$ is the identity morphism of $X$.
\end{lemma}

\begin{proof}
Immediate from the universal property of blowups
(Lemma \ref{lemma-universal-property-blowing-up}).
\end{proof}

\begin{lemma}
\label{lemma-blow-up-integral-scheme}
Let $X$ be a scheme. Let $\mathcal{I} \subset \mathcal{O}_X$ be a
quasi-coherent sheaf of ideals. If $X$ is integral, then the
blow up $X'$ of $X$ in $\mathcal{I}$ is integral.
\end{lemma}

\begin{proof}
Combine Lemma \ref{lemma-blowing-up-affine}
with Algebra, Lemma \ref{algebra-lemma-blowup-domain}.
\end{proof}

\begin{lemma}
\label{lemma-blow-up-reduced-scheme}
Let $X$ be a scheme. Let $\mathcal{I} \subset \mathcal{O}_X$ be a
quasi-coherent sheaf of ideals. If $X$ is reduced, then the
blow up $X'$ of $X$ in $\mathcal{I}$ is reduced.
\end{lemma}

\begin{proof}
Combine Lemma \ref{lemma-blowing-up-affine}
with Algebra, Lemma \ref{algebra-lemma-blowup-reduced}.
\end{proof}

\begin{lemma}
\label{lemma-blow-up-pullback-effective-Cartier}
Let $X$ be a scheme. Let $b : X' \to X$ be a blow up of $X$ in a closed
subscheme. For any effective Cartier divisor $D$ on $X$ the pullback
$b^{-1}D$ is defined (see Definition
\ref{definition-pullback-effective-Cartier-divisor}).
\end{lemma}

\begin{proof}
By Lemmas \ref{lemma-blowing-up-affine} and
\ref{lemma-characterize-effective-Cartier-divisor}
this reduces to the following algebra fact:
Let $A$ be a ring, $I \subset A$ an ideal, $a \in I$, and $x \in A$
a nonzerodivisor. Then the image of $x$ in $A[\frac{I}{a}]$ is a
nonzerodivisor. Namely, suppose that $x (y/a^n) = 0$ in $A[\frac{I}{a}]$.
Then $a^mxy = 0$ in $A$ for some $m$. Hence $a^my = 0$ as $x$ is a
nonzerodivisor. Whence $y/a^n$ is zero in $A[\frac{I}{a}]$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-blowing-up-two-ideals}
Let $X$ be a scheme. Let $\mathcal{I} \subset \mathcal{O}_X$ and
$\mathcal{J}$ be quasi-coherent sheaves of ideals. Let $b : X' \to X$
be the blowing up of $X$ in $\mathcal{I}$. Let $b' : X'' \to X'$ be the
blowing up of $X'$ in $b^{-1}\mathcal{J} \mathcal{O}_{X'}$. Then $X'' \to X$
is canonically isomorphic to the blowing up of $X$ in $\mathcal{I}\mathcal{J}$.
\end{lemma}

\begin{proof}
Let $E \subset X'$ be the exceptional divisor of $b$ which is an effective
Cartier divisor by
Lemma \ref{lemma-blowing-up-gives-effective-Cartier-divisor}.
Then $(b')^{-1}E$ is an effective Cartier divisor on $X''$ by
Lemma \ref{lemma-blow-up-pullback-effective-Cartier}.
Let $E' \subset X''$ be the exceptional divisor of $b'$ (also an effective
Cartier divisor). Consider the effective Cartier divisor
$E'' = E' + (b')^{-1}E$. By construction the ideal of $E''$ is
$(b \circ b')^{-1}\mathcal{I} (b \circ b')^{-1}\mathcal{J} \mathcal{O}_{X''}$.
Hence according to Lemma \ref{lemma-universal-property-blowing-up}
there is a canonical morphism from $X''$ to the blowup $c : Y \to X$
of $X$ in $\mathcal{I}\mathcal{J}$. Conversely, as $\mathcal{I}\mathcal{J}$
pulls back to an invertible ideal we see that
$c^{-1}\mathcal{I}\mathcal{O}_Y$ defines
an effective Cartier divisor, see
Lemma \ref{lemma-sum-closed-subschemes-effective-Cartier}.
Thus a morphism $c' : Y \to X'$ over $X$ by
Lemma \ref{lemma-universal-property-blowing-up}.
Then $(c')^{-1}b^{-1}\mathcal{J}\mathcal{O}_Y = c^{-1}\mathcal{J}\mathcal{O}_Y$
which also defines an effective Cartier divisor. Thus a morphism
$c'' : Y \to X''$ over $X'$. We omit the verification that this
morphism is inverse to the morphism $X'' \to Y$ constructed earlier.
\end{proof}

\begin{lemma}
\label{lemma-blowing-up-projective}
Let $X$ be a scheme. Let $\mathcal{I} \subset \mathcal{O}_X$ be a
quasi-coherent sheaf of ideals. Let $b : X' \to X$ be the blowing up of $X$
in the ideal sheaf $\mathcal{I}$ If $\mathcal{I}$ is of finite type, then
\begin{enumerate}
\item $b : X' \to X$ is a projective morphism, and
\item $\mathcal{O}_{X'}(1)$ is a $b$-relatively ample invertible sheaf.
\end{enumerate}
\end{lemma}

\begin{proof}
The surjection of graded $\mathcal{O}_X$-algebras
$$
\text{Sym}_{\mathcal{O}_X}^*(\mathcal{I})
\longrightarrow
\bigoplus\nolimits_{d \geq 0} \mathcal{I}^d
$$
defines via Constructions, Lemma
\ref{constructions-lemma-surjective-generated-degree-1-map-relative-proj}
a closed immersion
$$
X' = \underline{\text{Proj}}_X (\bigoplus\nolimits_{d \geq 0} \mathcal{I}^d)
\longrightarrow
\mathbf{P}(\mathcal{I}).
$$
Hence $b$ is projective, see
Morphisms, Definition \ref{morphisms-definition-projective}.
The second statement follows for example from the characterization
of relatively ample invertible sheaves in
Morphisms, Lemma \ref{morphisms-lemma-characterize-relatively-ample}.
Some details omitted.
\end{proof}

\begin{lemma}
\label{lemma-composition-finite-type-blowups}
Let $X$ be a quasi-compact and quasi-separated scheme.
Let $Z \subset X$ be a closed subscheme of finite presentation.
Let $b : X' \to X$ be the blowing up with center $Z$. Let $Z' \subset X'$ be
a closed subscheme of finite presentation.
Let $X'' \to X'$ be the blowing up with center $Z'$.
There exists a closed subscheme $Y \subset X$ of finite presentation,
such that
\begin{enumerate}
\item $Y = Z \cup b(Z')$ set theoretically, and
\item the composition $X'' \to X$ is isomorphic to the blowing up
of $X$ in $Y$.
\end{enumerate}
\end{lemma}

\begin{proof}
The condition that $Z \to X$ is of finite presentation means that
$Z$ is cut out by a finite type quasi-coherent sheaf of ideals
$\mathcal{I} \subset \mathcal{O}_X$, see
Morphisms, Lemma \ref{morphisms-lemma-closed-immersion-finite-presentation}.
Write $\mathcal{A} = \bigoplus_{n \geq 0} \mathcal{I}^n$ so that
$X' = \underline{\text{Proj}}(\mathcal{A})$.
Note that $X \setminus Z$ is a quasi-compact of $X$ by
Properties, Lemma \ref{properties-lemma-quasi-coherent-finite-type-ideals}.
Since $b^{-1}(X \setminus Z) \to X \setminus Z$ is an isomorphism
(Lemma \ref{lemma-blowing-up-gives-effective-Cartier-divisor}) the same
result shows that
$b^{-1}(X \setminus Z) \setminus Z'$ is quasi-compact open in $X'$.
Hence $U = X \setminus (Z \cup b(Z'))$ is quasi-compact open in $X$.
By Lemma \ref{lemma-closed-subscheme-proj-finite-type}
there exist a $d > 0$ and a finite type
$\mathcal{O}_X$-submodule $\mathcal{F} \subset \mathcal{I}^d$ such
that $Z' = \underline{\text{Proj}}(\mathcal{A}/\mathcal{F}\mathcal{A})$
and such that the support of $\mathcal{I}^d/\mathcal{F}$ is contained
in $X \setminus U$.

\medskip\noindent
Since $\mathcal{F} \subset \mathcal{I}^d$ is an $\mathcal{O}_X$-submodule
we may think of $\mathcal{F} \subset \mathcal{I}^d \subset \mathcal{O}_X$
as a finite type quasi-coherent sheaf of ideals on $X$. Let's denote this
$\mathcal{J} \subset \mathcal{O}_X$ to prevent confusion. Since
$\mathcal{I}^d / \mathcal{J}$ and $\mathcal{O}/\mathcal{I}^d$
are supported on $X \setminus U$ we see that $V(\mathcal{J})$ is contained
in $X \setminus U$. Conversely, as $\mathcal{J} \subset \mathcal{I}^d$
we see that $Z \subset V(\mathcal{J})$. Over
$X \setminus Z \cong X' \setminus b^{-1}(Z)$ the sheaf of ideals
$\mathcal{J}$ cuts out $Z'$ (see displayed formula below). Hence
$V(\mathcal{J})$ equals $Z \cup b(Z')$. It follows that also
$V(\mathcal{I}\mathcal{J}) = Z \cup b(Z')$ set theoretically. Moreover,
$\mathcal{I}\mathcal{J}$ is an ideal of finite type as a product of two such.
We claim that $X'' \to X$ is isomorphic to the blowing up of $X$ in
$\mathcal{I}\mathcal{J}$ which finishes the proof of the lemma by setting
$Y = V(\mathcal{I}\mathcal{J})$.

\medskip\noindent
First, recall that the blow up of $X$ in $\mathcal{I}\mathcal{J}$
is the same as the blow up of $X'$ in $b^{-1}\mathcal{J} \mathcal{O}_{X'}$,
see Lemma \ref{lemma-blowing-up-two-ideals}.
Hence it suffices to show that the blow up of $X'$ in
$b^{-1}\mathcal{J} \mathcal{O}_{X'}$ agrees with the blow up of $X'$
in $Z'$. We will show that
$$
b^{-1}\mathcal{J} \mathcal{O}_{X'} = \mathcal{I}_E^d \mathcal{I}_{Z'}
$$
as ideal sheaves on $X''$. This will prove what we want as
$\mathcal{I}_E^d$ cuts out the effective Cartier divisor $dE$
and we can use Lemmas \ref{lemma-blow-up-effective-Cartier-divisor} and
\ref{lemma-blowing-up-two-ideals}.

\medskip\noindent
To see the displayed equality of the ideals we may work locally.
With notation $A$, $I$, $a \in I$ as in Lemma \ref{lemma-blowing-up-affine}
we see that $\mathcal{F}$ corresponds to an $R$-submodule $M \subset I^d$
mapping isomorphically to an ideal $J \subset R$. The condition
$Z' = \underline{\text{Proj}}(\mathcal{A}/\mathcal{F}\mathcal{A})$
means that $Z' \cap \Spec(A[\frac{I}{a}])$ is cut out by the ideal
generated by the elements $m/a^d$, $m \in M$. Say the element $m \in M$
corresponds to the function $f \in J$. Then in the affine blowup algebra
$A' = A[\frac{I}{a}]$ we see that $f = (a^dm)/a^d = a^d (m/a^d)$.
Thus the equality holds.
\end{proof}






\section{Strict transform}
\label{section-strict-transform}

\noindent
In this section we briefly discuss strict transform under blowing up.
Let $S$ be a scheme and let $Z \subset S$ be a closed subscheme.
Let $b : S' \to S$ be the blowing up of $S$ in $Z$ and denote $E \subset S'$
the exceptional divisor $E = b^{-1}Z$. In the following we will often
consider a scheme $X$ over $S$ and form the cartesian diagram
$$
\xymatrix{
\text{pr}_{S'}^{-1}E \ar[r] \ar[d] &
X \times_S S' \ar[r]_-{\text{pr}_X} \ar[d]_{\text{pr}_{S'}} &
X \ar[d]^f \\
E \ar[r] & S' \ar[r] & S
}
$$
Since $E$ is an effective Cartier divisor
(Lemma \ref{lemma-blowing-up-gives-effective-Cartier-divisor})
we see that $\text{pr}_{S'}^{-1}E \subset X \times_S  \times_S S''$
is locally principal
(Lemma \ref{lemma-pullback-locally-principal}).
Thus the complement of $\text{pr}_{S'}^{-1}E$ in $X \times_S S'$
is retrocompact
(Lemma \ref{lemma-complement-locally-principal-closed-subscheme}).
Consequently, for a quasi-coherent $\mathcal{O}_{X \times_S S'}$-module
$\mathcal{G}$ the subsheaf of sections supported on $\text{pr}_{S'}^{-1}E$
is a quasi-coherent submodule, see
Properties, Lemma \ref{properties-lemma-sections-supported-in-closed-subset}.
If $\mathcal{G}$ is a quasi-coherent sheaf of algebras, e.g.,
$\mathcal{G} = \mathcal{O}_{X \times_S S'}$, then this subsheaf is an ideal
of $\mathcal{G}$.

\begin{definition}
\label{definition-strict-transform}
With $Z \subset S$ and $f : X \to S$ as above.
\begin{enumerate}
\item Given a quasi-coherent $\mathcal{O}_X$-module $\mathcal{F}$
the {\it strict transform} of $\mathcal{F}$ with respect to the blowup
of $S$ in $Z$ is the quotient $\mathcal{F}'$ of $\text{pr}_X^*\mathcal{F}$
by the submodule of sections supported on $\text{pr}_{S'}^{-1}E$.
\item The {\it strict transform} of $X$ is the closed subscheme
$X' \subset X \times_S S'$ cut out by the quasi-coherent ideal of
sections of $\mathcal{O}_{X \times_S S'}$ supported on $\text{pr}_{S'}^{-1}E$.
\end{enumerate}
\end{definition}

\noindent
Note that taking the strict transform along a blowup depends on the
closed subscheme used for the blowup
(and not just on the morphism $S' \to S$).
This notion is often used for closed subschemes of $S$.
It turns out that the strict transform of $X$ is a blowup of $X$.

\begin{lemma}
\label{lemma-strict-transform}
In the situation of Definition \ref{definition-strict-transform}.
\begin{enumerate}
\item The strict transform $X'$ of $X$ is the blowup of $X$ in the closed
subscheme $f^{-1}Z$ of $X$.
\item For a quasi-coherent $\mathcal{O}_X$-module $\mathcal{F}$ the
strict transform $\mathcal{F}'$ is canonically isomorphic to
the pushfoward along $X' \to X \times_S S'$ of the strict transform of
$\mathcal{F}$ relative to the blowing up $X' \to X$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $X'' \to X$ be the blowup of $X$ in $f^{-1}Z$. By the universal
property of blowing up (Lemma \ref{lemma-universal-property-blowing-up})
there exists a commutative diagram
$$
\xymatrix{
X'' \ar[r] \ar[d] & X \ar[d] \\
S' \ar[r] & S
}
$$
whence a morphism $X'' \to X \times_S S'$. Thus the first assertion
is that this morphism is a closed immersion with image $X'$.
The question is local on $X$. Thus we may assume $X$
and $S$ are affine. Say that $S = \Spec(A)$, $X = \Spec(B)$, and $Z$
is cut out by the ideal $I \subset A$. Set $J = IB$. The map
$B \otimes_A \bigoplus_{n \geq 0} I^n \to \bigoplus_{n \geq 0} J^n$
defines a closed immersion $X'' \to X \times_S S'$, see
Constructions, Lemmas
\ref{constructions-lemma-base-change-map-proj} and
\ref{constructions-lemma-surjective-graded-rings-generated-degree-1-map-proj}.
We omit the verification that this morphism is the same as the
one constructed above from the universal property.
Pick $a \in I$ corresponding to the affine open
$\Spec(A[\frac{I}{a}]) \subset S'$, see Lemma \ref{lemma-blowing-up-affine}.
The inverse image of $\Spec(A[\frac{I}{a}])$ in the strict transform
$X'$ of $X$ is the spectrum of
$$
B' = (B \otimes_A A[\textstyle{\frac{I}{a}}])/a\text{-power-torsion}
$$
On the other hand, letting $b \in J$ be the image of $a$ we see that
$\Spec(B[\frac{J}{b}])$ is the inverse image of $\Spec(A[\frac{I}{a}])$
in $X''$. The ring map
$$
B \otimes_A A[\textstyle{\frac{I}{a}}]
\longrightarrow
B[\textstyle{\frac{J}{b}}]
$$
see Properties, Lemma
\ref{properties-lemma-sections-supported-in-closed-subset}.
is surjective and annihilates $a$-power torsion as $b$ is a nonzerodivsor
in $B[\frac{J}{b}]$. Hence we obtain a surjective map $B' \to B[\frac{J}{b}]$.
To see that the kernel is trivial, we construct an inverse map. Namely, let
$z = y/b^n$ be an element of $B[\frac{J}{b}]$, i.e., $y \in J^n$.
Write $y = \sum x_ib_i$ with $x_i \in I^n$ and $b_i \in B$.
We map $z$ to the class of $\sum b_i \otimes x_i/a^n$ in
$B'$. This is well defined because an element of the kernel of the map
$B \otimes_A I^n \to J^n$ is annihilated by $a^n$, hence maps to zero in $B'$.
This shows that the open $\Spec(B[\frac{J}{b}])$ maps isomorphically
to the open subscheme $\text{pr}_{S'}^{-1}(\Spec(A[\frac{I}{a}]))$ of $X'$.
Thus $X'' \to X'$ is an isomorphism.

\medskip\noindent
In the notation above, let $\mathcal{F}$ correspond to the $B$-module $N$.
The strict transform of $\mathcal{F}$ corresponds to the
$B \otimes_A A[\frac{I}{a}]$-module
$$
N' = (N \otimes_A A[\textstyle{\frac{I}{a}}])/a\text{-power-torsion}
$$
see Properties, Lemma
\ref{properties-lemma-sections-supported-in-closed-subset}.
The strict transform of $\mathcal{F}$ relative to the blowup of
$X$ in $f^{-1}Z$ corresponds to the $B[\frac{J}{b}]$-module
$N \otimes_B B[\frac{J}{b}]/b\text{-power-torsion}$. In exactly the same
way as above one proves that these two modules are isomorphic.
Details omitted.
\end{proof}

\begin{lemma}
\label{lemma-strict-transform-flat}
In the situation of Definition \ref{definition-strict-transform}.
\begin{enumerate}
\item If $X$ is flat over $S$ at all points lying over $Z$, then
the strict transform of $X$ is equal to the base change $X \times_S S'$.
\item Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module.
If $\mathcal{F}$ is flat over $S$ at all points lying over $Z$, then
the strict transform $\mathcal{F}'$ of $\mathcal{F}$ is equal to the
pullback $\text{pr}_X^*\mathcal{F}$.
\end{enumerate}
\end{lemma}

\begin{proof}
We will prove part (2) as it implies part (1) by the definition of the
strict transform of a scheme over $S$. The question is local on $X$.
Thus we may assume that $S = \Spec(A)$, $X = \Spec(B)$, and that
$\mathcal{F}$ corresponds to the $B$-module $N$. Then $\mathcal{F}'$
over the open $\Spec(B \otimes_A A[\frac{I}{a}])$ of $X \times_S S'$
corresponds to the module
$$
N' = (N \otimes_A A[\textstyle{\frac{I}{a}}])/a\text{-power-torsion}
$$
see Properties, Lemma
\ref{properties-lemma-sections-supported-in-closed-subset}.
Thus we have to show that the $a$-power-torsion of
$N \otimes_A A[\frac{I}{a}]$ is zero. Let $y \in N \otimes_A A[\frac{I}{a}]$
with $a^n y = 0$. If $\mathfrak q \subset B$
is a prime and $a \not \in \mathfrak q$, then $y$ maps to
zero in $(N \otimes_A A[\frac{I}{a}])_\mathfrak q$. on the other hand,
if $a \in \mathfrak q$, then $N_\mathfrak q$ is a flat $A$-module
and we see that
$N_\mathfrak q \otimes_A A[\frac{I}{a}]
=(N \otimes_A A[\frac{I}{a}])_\mathfrak q$
has no $a$-power torsion (as $A[\frac{I}{a}]$ doesn't).
Hence $y$ maps to zero in this localization as well. We conclude that
$y$ is zero by
Algebra, Lemma \ref{algebra-lemma-characterize-zero-local}.
\end{proof}

\begin{lemma}
\label{lemma-strict-transform-affine}
Let $S$ be a scheme. Let $Z \subset S$ be a closed subscheme.
Let $b : S' \to S$ be the blowing up of $Z$ in $S$. Let
$g : X \to Y$ be an affine morphism of schemes over $S$.
Let $\mathcal{F}$ be a quasi-coherent sheaf on $X$.
Let $g' : X \times_S S' \to Y \times_S S'$ be the base change
of $g$. Let $\mathcal{F}'$ be the strict transform of $\mathcal{F}$
relative to $b$. Then $g'_*\mathcal{F}'$ is the strict transform
of $g_*\mathcal{F}$.
\end{lemma}

\begin{proof}
Observe that $g'_*\text{pr}_X^*\mathcal{F} = \text{pr}_Y^*g_*\mathcal{F}$
by Cohomology of Schemes, Lemma \ref{coherent-lemma-affine-base-change}.
Let $\mathcal{K} \subset \text{pr}_X^*\mathcal{F}$ be the subsheaf
of sections supported in the inverse image of $Z$ in $X \times_S S'$.
By Properties, Lemma
\ref{properties-lemma-push-sections-supported-in-closed-subset}
the pushforward $g'_*\mathcal{K}$ is the subsheaf of sections of
$\text{pr}_Y^*g_*\mathcal{F}$ supported in the inverse
image of $Z$ in $Y \times_S S'$. As $g'$ is affine
(Morphisms, Lemma \ref{morphisms-lemma-base-change-affine})
we see that $g'_*$ is exact, hence we conclude.
\end{proof}

\begin{lemma}
\label{lemma-strict-transform-different-centers}
Let $S$ be a scheme. Let $Z \subset S$ be a closed subscheme.
Let $D \subset S$ be an effective Cartier divisor.
Let $Z' \subset S$ be the closed subscheme cut out by the product
of the ideal sheaves of $Z$ and $D$.
Let $S' \to S$ be the blowup of $S$ in $Z$.
\begin{enumerate}
\item The blowup of $S$ in $Z'$ is isomorphic to $S' \to S$.
\item Let $f : X \to S$ be a morphism of schemes and let $\mathcal{F}$
be a quasi-coherent $\mathcal{O}_X$-module. If $\mathcal{F}$ has
no nonzero local sections supported in $f^{-1}D$, then the
strict transform of $\mathcal{F}$ relative to the blowing up
in $Z$ agrees with the strict transform of $\mathcal{F}$ relative
to the blowing up of $S$ in $Z'$.
\end{enumerate}
\end{lemma}

\begin{proof}
The first statement follows on combining
Lemmas \ref{lemma-blowing-up-two-ideals} and
\ref{lemma-blow-up-effective-Cartier-divisor}.
Using Lemma \ref{lemma-blowing-up-affine} this translates into the
following algebra problem. Let $A$ be a ring, $I \subset A$ an ideal,
$x \in A$ a nonzerodivisor, and $a \in I$. Let $M$ be an $A$-module
whose $x$-torsion is zero. To show: the $a$-power torsion in
$M \otimes_A A[\frac{I}{a}]$ is equal to the $xa$-power torsion.
The reason for this is that the kernel and cokernel of the map
$A \to A[\frac{I}{a}]$ is $a$-power torsion, so this map becomes an
isomorphism after inverting $a$. Hence the kernel
and cokernel of $M \to M \otimes_A A[\frac{I}{a}]$ are $a$-power
torsion too. This implies the result.
\end{proof}

\begin{lemma}
\label{lemma-strict-transform-composition-blowups}
Let $S$ be a scheme. Let $Z \subset S$ be a closed subscheme.
Let $b : S' \to S$ be the blowing up with center $Z$. Let $Z' \subset S'$ be
a closed subscheme. Let $S'' \to S'$ be the blowing up with center $Z'$.
Let $Y \subset S$ be a closed subscheme such that
$Y = Z \cup b(Z')$ set theoretically and the composition $S'' \to S$
is isomorphic to the blowing up of $S$ in $Y$.
In this situation, given any scheme $X$ over $S$ and
$\mathcal{F} \in \textit{QCoh}(\mathcal{O}_X)$ we have
\begin{enumerate}
\item the strict transform of $\mathcal{F}$ with respect to the blowing
up of $S$ in $Y$ is equal to the strict transform with respect to the
blowup $S'' \to S'$ in $Z'$ of the strict transform of $\mathcal{F}$
with respect to the blowup $S' \to S$ of $S$ in $Z$, and
\item the strict transform of $X$ with respect to the blowing
up of $S$ in $Y$ is equal to the strict transform with respect to the
blowup $S'' \to S'$ in $Z'$ of the strict transform of $X$
with respect to the blowup $S' \to S$ of $S$ in $Z$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $\mathcal{F}'$ be the strict transform of $\mathcal{F}$ with respect
to the blowup $S' \to S$ of $S$ in $Z$.
Let $\mathcal{F}''$ be the strict transform of $\mathcal{F}'$ with respect
to the blowup $S'' \to S'$ of $S'$ in $Z'$.
Let $\mathcal{G}$ be the strict transform of $\mathcal{F}$ with respect
to the blowup $S'' \to S$ of $S$ in $Y$.
We also label the morphisms
$$
\xymatrix{
X \times_S S'' \ar[r]_q \ar[d]^{f''} &
X \times_S S' \ar[r]_p \ar[d]^{f'} &
X \ar[d]^f \\
S'' \ar[r] & S' \ar[r] & S
}
$$
By definition there is a surjection $p^*\mathcal{F} \to \mathcal{F}'$
and a surjection $q^*\mathcal{F}' \to \mathcal{F}''$ which combine
by right exactness of $q^*$ to a surjection
$(p \circ q)^*\mathcal{F} \to \mathcal{F}''$. Also we have the surjection
$(p \circ q)^*\mathcal{F} \to \mathcal{G}$. Thus it suffices to prove
that these two surjections have the same kernel.

\medskip\noindent
The kernel of the surjection $p^*\mathcal{F} \to \mathcal{F}'$
is supported on $(f \circ p)^{-1}Z$, so this map is an isomorphism at
points in the complement. Hence the kernel of
$q^*p^*\mathcal{F} \to q^*\mathcal{F}'$
is supported on $(f \circ p \circ q)^{-1}Z$. The kernel of
$q^*\mathcal{F}' \to \mathcal{F}''$ is supported on $(f' \circ q)^{-1}Z'$.
Combined we see that the kernel of
$(p \circ q)^*\mathcal{F} \to \mathcal{F}''$ is supported on
$(f \circ p \circ q)^{-1}Z \cup (f' \circ q)^{-1}Z' =
(f \circ p \circ q)^{-1}Y$.
By construction of $\mathcal{G}$ we see that we obtain a factorization
$(p \circ q)^*\mathcal{F} \to \mathcal{F}'' \to \mathcal{G}$.
To finish the proof it suffices to show that $\mathcal{F}''$ has no
nonzero (local) sections supported on
$(f \circ p \circ q)^{-1}(Y) =
(f \circ p \circ q)^{-1}Z \cup (f' \circ q)^{-1}Z'$.
This follows from Lemma \ref{lemma-strict-transform-different-centers}
applied to $\mathcal{F}'$ on $X \times_S S'$ over $S'$, the closed
subscheme $Z'$ and the effective Cartier divisor $b^{-1}Z$.
\end{proof}

\begin{lemma}
\label{lemma-strict-transform-universally-injective}
In the situation of Definition \ref{definition-strict-transform}.
Suppose that
$$
0 \to \mathcal{F}_1 \to \mathcal{F}_2 \to \mathcal{F}_3 \to 0
$$
is an exact sequence of quasi-coherent sheaves on $X$ which remains
exact after any base change $T \to S$. Then the strict transforms of
$\mathcal{F}_i'$ relative to any blowup $S' \to S$
form a short exact sequence
$0 \to \mathcal{F}'_1 \to \mathcal{F}'_2 \to \mathcal{F}'_3 \to 0$ too.
\end{lemma}

\begin{proof}
We may localize on $S$ and $X$ and assume both are affine.
Then we may push $\mathcal{F}_i$ to $S$, see
Lemma \ref{lemma-strict-transform-affine}.
We may assume that our blowup is the morphism $1 : S \to S$
associated to an effective Cartier divisor $D \subset S$.
Then the translation into algebra is the following: Suppose that $A$
is a ring and $0 \to M_1 \to M_2 \to M_3 \to 0$ is a universally
exact sequence of $A$-modules. Let $a\in A$. Then the sequence
$$
0 \to
M_1/a\text{-power torsion} \to
M_2/a\text{-power torsion} \to
M_3/a\text{-power torsion} \to 0
$$
is exact too. Namely, surjectivity of the last map and injectivity of
the first map are immediate. The problem is exactness in the middle.
Suppose that $x \in M_2$ maps to zero in $M_3/a\text{-power torsion}$.
Then $y = a^n x \in M_1$ for some $n$. Then $y$ maps to zero in
$M_2/a^nM_2$. Since $M_1 \to M_2$ is universally injective we see that
$y$ maps to zero in $M_1/a^nM_1$. Thus $y = a^n z$ for some $z \in M_1$.
Thus $a^n(x - y) = 0$. Hence $y$ maps to the class of $x$ in
$M_2/a\text{-power torsion}$ as desired.
\end{proof}








\section{Admissible blowups}
\label{section-admissible-blowups}

\noindent
To have a bit more control over our blowups we introduce the following
standard terminology.

\begin{definition}
\label{definition-admissible-blowup}
Let $X$ be a scheme. Let $U \subset X$ be an open subscheme. A morphism
$X' \to X$ is called a {\it $U$-admissible blowup} if there exists a
closed immersion $Z \to X$ of finite presentation with $Z$ disjoint from
$U$ such that $X'$ is isomorphic to the blow up of $X$ in $Z$.
\end{definition}

\noindent
We recall that $Z \to X$ is of finite presentation if and only if the
ideal sheaf $\mathcal{I}_Z \subset \mathcal{O}_X$ is of finite type, see
Morphisms, Lemma \ref{morphisms-lemma-closed-immersion-finite-presentation}.
In particular, a $U$-admissible blowup is a projective morphism, see
Lemma \ref{lemma-blowing-up-projective}.
Note that there can be multiple centers which give rise to the same morphism.
Hence the requirement is just the existence of some center disjoint from
$U$ which produces $X'$.
Finally, as the morphism $b : X' \to X$ is an isomorphism over $U$ (see
Lemma \ref{lemma-blowing-up-gives-effective-Cartier-divisor}) we will often
abuse notation and think of $U$ as an open subscheme of $X'$ as well.

\begin{lemma}
\label{lemma-composition-admissible-blowups}
Let $X$ be a quasi-compact and quasi-separated scheme.
Let $U \subset X$ be a quasi-compact open subscheme.
Let $b : X' \to X$ be a $U$-admissible blowup.
Let $X'' \to X'$ be a $U$-admissible blowup.
Then the composition $X'' \to X$ is a $U$-admissible blowup.
\end{lemma}

\begin{proof}
Immediate from the more precise
Lemma \ref{lemma-composition-finite-type-blowups}.
\end{proof}

\begin{lemma}
\label{lemma-extend-admissible-blowups}
Let $X$ be a quasi-compact and quasi-separated scheme.
Let $U, V \subset X$ be quasi-compact open subschemes.
Let $b : V' \to V$ be a $U \cap V$-admissible blowup.
Then there exists a $U$-admissible blowup $X' \to X$
whose restriction to $V$ is $V'$.
\end{lemma}

\begin{proof}
Let $\mathcal{I} \subset \mathcal{O}_V$ be the finite type
quasi-coherent sheaf of ideals such that $V(\mathcal{I})$ is
disjoint from $U \cap V$ and such that $V'$ is isomorphic to the
blow up of $V$ in $\mathcal{I}$. Let
$\mathcal{I}' \subset \mathcal{O}_{U \cup V}$ be the quasi-coherent
sheaf of ideals whose restriction to $U$ is $\mathcal{O}_U$ and
whose restriction to $V$ is $\mathcal{I}$ (see Sheaves, Section
\ref{sheaves-section-glueing-sheaves}).
By Properties, Lemma \ref{properties-lemma-extend}
there exists a finite type quasi-coherent sheaf of ideals
$\mathcal{J} \subset \mathcal{O}_X$ whose restriction to $U \cup V$ is
$\mathcal{I}'$. The lemma follows.
\end{proof}

\begin{lemma}
\label{lemma-dominate-admissible-blowups}
Let $X$ be a quasi-compact and quasi-separated scheme.
Let $U \subset X$ be a quasi-compact open subscheme.
Let $b_i : X_i \to X$, $i = 1, \ldots, n$ be $U$-admissible blowups.
There exists a $U$-admissible blowup $b : X' \to X$ such that
(a) $b$ factors as $X' \to X_i \to X$ for $i = 1, \ldots, n$ and
(b) each of the morphismsm $X' \to X_i$ is a $U$-admissible blowup.
\end{lemma}

\begin{proof}
Let $\mathcal{I}_i \subset \mathcal{O}_X$ be the finite type
quasi-coherent sheaf of ideals such that $V(\mathcal{I}_i)$ is
disjoint from $U$ and such that $X_i$ is isomorphic to the
blow up of $X$ in $\mathcal{I}_i$. Set
$\mathcal{I} = \mathcal{I}_1 \cdot \ldots \cdot \mathcal{I}_n$
and let $X'$ be the blowup of $X$ in $\mathcal{I}$. Then
$X' \to X$ factors through $b_i$ by Lemma \ref{lemma-blowing-up-two-ideals}.
\end{proof}

\begin{lemma}
\label{lemma-separate-disjoint-opens-by-blowing-up}
Let $X$ be a quasi-compact and quasi-separated scheme.
Let $U, V$ be quasi-compact disjoint open subschemes of $X$.
Then there exist a $U \cup V$-admissible blowup $b : X' \to X$
such that $X'$ is a disjoint union of open subschemes
$X' = X'_1 \amalg X'_2$ with $b^{-1}(U) \subset X'_1$ and
$b^{-1}(V) \subset X'_2$.
\end{lemma}

\begin{proof}
Choose a finite type quasi-coherent sheaf of ideals $\mathcal{I}$,
resp.\ $\mathcal{J}$ such that $X \setminus U = V(\mathcal{I})$,
resp.\ $X \setminus V = V(\mathcal{J})$, see
Properties, Lemma \ref{properties-lemma-quasi-coherent-finite-type-ideals}.
Then $V(\mathcal{I}\mathcal{J}) = X$ set theoretically, hence
$\mathcal{I}\mathcal{J}$ is a locally nilpotent sheaf of ideals.
Since $\mathcal{I}$ and $\mathcal{J}$ are of finite type and $X$
is quasi-compact there exists an $n > 0$ such that
$\mathcal{I}^n \mathcal{J}^n = 0$. We may and do replace $\mathcal{I}$
by $\mathcal{I}^n$ and $\mathcal{J}$ by $\mathcal{J}^n$. Whence
$\mathcal{I} \mathcal{J} = 0$. Let $b : X' \to X$ be the blowing
up in $\mathcal{I} + \mathcal{J}$. This is $U \cup V$-admissible
as $V(\mathcal{I} + \mathcal{J}) = X \setminus U \cup V$. We will show that
$X'$ is a disjoint union of open subschemes $X' = X'_1 \amalg X'_2$
such that $b^{-1}\mathcal{I}|_{X'_2} = 0$ and $b^{-1}\mathcal{J}|_{X'_1} = 0$
which will prove the lemma.

\medskip\noindent
We will use the description of the blowing up in
Lemma \ref{lemma-blowing-up-affine}. Suppose that $U = \Spec(A) \subset X$
is an affine open such that $\mathcal{I}|_U$, resp.\ $\mathcal{J}|_U$
corresponds to the finitely generated ideal $I \subset A$, resp.\ $J \subset A$.
Then
$$
b^{-1}(U) = \text{Proj}(A \oplus (I + J) \oplus (I + J)^2 \oplus \ldots)
$$
This is covered by the affine open subsets $A[\frac{I + J}{x}]$
and $A[\frac{I + J}{y}]$ with $x \in I$ and $y \in J$. Since $x \in I$ is a
nonzerodivisor in $A[\frac{I + J}{x}]$ and $IJ = 0$ we see that
$J A[\frac{I + J}{x}] = 0$. Since $y \in J$ is a nonzerodivisor
in $A[\frac{I + J}{y}]$ and $IJ = 0$ we see that
$I A[\frac{I + J}{y}] = 0$. Moreover,
$$
\Spec(A[\textstyle{\frac{I + J}{x}}]) \cap
\Spec(A[\textstyle{\frac{I + J}{y}}]) =
\Spec(A[\textstyle{\frac{I + J}{xy}}]) = \emptyset
$$
because $xy$ is both a nonzero divisor and zero. Thus $b^{-1}(U)$
is the disjoint union of the open subscheme $U_1$ defined as the union 
of the standard opens $\Spec(A[\frac{I + J}{x}])$ for $x \in I$ and the open
subscheme $U_2$ which is the union of the affine opens
$\Spec(A[\frac{I + J}{y}])$ for $y \in J$. We have seen that
$b^{-1}\mathcal{I}\mathcal{O}_{X'}$ restricts to zero on $U_2$
and $b^{-1}\mathcal{I}\mathcal{O}_{X'}$ restricts to zero on $U_1$.
We omit the verification that these open subschemes glue to global
open subschemes $X'_1$ and $X'_2$.
\end{proof}












\input{chapters}

\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}
