\input{preamble}

% OK, start here.
%
\begin{document}

\title{Derived Categories of Schemes}


\maketitle

\phantomsection
\label{section-phantom}

\tableofcontents

\section{Introduction}
\label{section-introduction}

\noindent
In this chapter we discuss derived categories of modules on schemes.
Most of the material discussed here can be found in
\cite{TT}, \cite{Bokstedt-Neeman}, \cite{BvdB}, and \cite{LN}.
Of course there are many other references.


\section{Conventions}
\label{section-conventions}

\noindent
If $\mathcal{A}$ is an abelian category and $M$ is an object
of $\mathcal{A}$ then we also denote $M$ the object of $K(\mathcal{A})$
and/or $D(\mathcal{A})$ corresponding to the complex which has
$M$ in degree $0$ and is zero in all other degrees.

\medskip\noindent
If we have a ring $A$, then $K(A)$ denotes the homotopy category
of complexes of $A$-modules and $D(A)$ the associated derived category.
Similarly, if we have a ringed space $(X, \mathcal{O}_X)$ the symbol
$K(\mathcal{O}_X)$ denotes the homotopy category of complexes of
$\mathcal{O}_X$-modules and $D(\mathcal{O}_X)$ the associated derived
category.










\section{Derived category of quasi-coherent modules}
\label{section-derived-quasi-coherent}

\noindent
In this section we discuss the relationship between quasi-coherent
modules and all modules on a scheme $X$. A reference is
\cite[Appendix B]{TT}. By the discussion in
Schemes, Section \ref{schemes-section-quasi-coherent}
the embedding
$\textit{QCoh}(\mathcal{O}_X) \subset \textit{Mod}(\mathcal{O}_X)$
exhibits $\textit{QCoh}(\mathcal{O}_X)$ as a weak Serre subcategory of
the category of $\mathcal{O}_X$-modules. Denote
$$
D_{\textit{QCoh}}(\mathcal{O}_X) \subset D(\mathcal{O}_X)
$$
the subcategory of complexes whose cohomology sheaves are quasi-coherent, see
Derived Categories, Section \ref{derived-section-triangulated-sub}.
Thus we obtain a canonical functor
\begin{equation}
\label{equation-compare}
D(\textit{QCoh}(\mathcal{O}_X))
\longrightarrow
D_{\textit{QCoh}}(\mathcal{O}_X)
\end{equation}
see Derived Categories, Equation (\ref{derived-equation-compare}).

\begin{lemma}
\label{lemma-quasi-coherence-direct-sums}
Let $X$ be a scheme. Then $D_{\textit{QCoh}}(\mathcal{O}_X)$
has direct sums.
\end{lemma}

\begin{proof}
By Injectives, Lemma \ref{injectives-lemma-derived-products}
the derived category $D(\mathcal{O}_X)$ has direct sums and
they are computed by taking termwise direct sums of any representatives.
Thus it is clear that the cohomology sheaf of a direct sum is the
direct sum of the cohomology sheaves as taking direct sums is
an exact functor (in any grothendieck abelian category). The lemma
follows as the direct sum of quasi-coherent sheaves is quasi-coherent, see
Schemes, Section \ref{schemes-section-quasi-coherent}.
\end{proof}

\noindent
The following lemma will help us to ``compute'' a right derived functor
on an object of $D_{\textit{QCoh}}(\mathcal{O}_X)$.

\begin{lemma}
\label{lemma-nice-K-injective}
Let $X$ be a scheme. Let $E$ be an object of
$D_{\textit{QCoh}}(\mathcal{O}_X)$. Then there exists an inverse
system $\mathcal{I}_n^\bullet$ of complexes of $\mathcal{O}_X$-modules
such that
\begin{enumerate}
\item $\mathcal{I}^\bullet = \lim_n \mathcal{I}_n^\bullet$ represents $E$,
\item $\mathcal{I}_n^\bullet$ is a bounded below complex of injectives,
\item $\mathcal{I}^\bullet \to \mathcal{I}_n^\bullet$ induces an identification
$\tau_{\geq -n}E \to \mathcal{I}_n^\bullet$
in $D(\mathcal{O}_X)$,
\item the transition maps
$\mathcal{I}_{n + 1}^\bullet \to \mathcal{I}_n^\bullet$
are termwise split surjections, and
\item $\mathcal{I}^\bullet$ is a K-injective complex of
$\mathcal{O}_X$-modules.
\end{enumerate}
Moreover, $E$ is the derived limit of the inverse system of
its canonical truncations $\tau_{\geq -n}E$.
\end{lemma}

\begin{proof}
Denote $\mathcal{H}^i = H^i(E)$ the $i$th cohomology sheaf of $E$.
Let $\mathcal{B}$ be the set of affine open subsets of $X$. Then
$H^p(U, \mathcal{H}^i) = 0$ for all $p > 0$, all $i \in \mathbf{Z}$,
and all $U \in \mathcal{B}$, see
Cohomology of Schemes, Lemma
\ref{coherent-lemma-quasi-coherent-affine-cohomology-zero}.
Thus the lemma follows from
Cohomology, Lemmas \ref{cohomology-lemma-K-injective} and
\ref{cohomology-lemma-is-limit}.
\end{proof}

\begin{lemma}
\label{lemma-application-nice-K-injective}
Let $X$ be a scheme. Let $F : \textit{Mod}(\mathcal{O}_X) \to \textit{Ab}$
be an additive functor and $N \geq 0$ an integer. Assume that
\begin{enumerate}
\item $F$ commutes with countable direct products,
\item $R^pF(\mathcal{F}) = 0$ for all $p \geq N$ and $\mathcal{F}$
quasi-coherent.
\end{enumerate}
Then for $E \in D_{\textit{QCoh}}(\mathcal{O}_X)$ the maps
$R^pF(E) \to R^pF(\tau_{\geq p - N + 1}E)$ are isomorphisms.
\end{lemma}

\begin{proof}
By shifting the complex we see it suffices to prove the assertion
for $p = 0$. Write $E_n = \tau_{\geq -n}E$. We have $E = R\lim E_n$, see
Lemma \ref{lemma-nice-K-injective}. Thus
$RF(E) = R\lim RF(E_n)$ in $D(\textit{Ab})$ by Injectives, Lemma
\ref{injectives-lemma-RF-commutes-with-Rlim}. Thus we have a short
exact sequence
$$
0 \to R^1\lim R^{-1}F(E_n) \to R^0F(E) \to \lim R^0F(E_n) \to 0
$$
see More on Algebra, Remark
\ref{more-algebra-remark-compare-derived-limit}.
To finish the proof we will show that the term on the left is zero
and that the term on the right equals $R^0F(E_{N - 1})$.

\medskip\noindent
We have a distinguished triangle
$$
H^{-n}(E)[n] \to E_n \to E_{n - 1} \to H^{-n}(E)[n + 1]
$$
(Derived Categories, Remark
\ref{derived-remark-truncation-distinguished-triangle})
in $D(\mathcal{O}_X)$. Since $H^{-n}(E)$ is quasi-coherent we have
$$
R^pF(H^{-n}(E)[n]) = R^{p + n}F(H^{-n}(E)) = 0
$$
for $p + n \geq N$ and
$$
R^pF(H^{-n}(E)[n + 1]) = R^{p + n + 1}F(H^{-n}(E)) = 0
$$
for $p + n + 1 \geq N$. We conclude that
$$
R^pF(E_n) \to R^pF(E_{n - 1})
$$
is an isomorphism for all $n \gg p$ and an isomorphism for
$n \geq N$ for $p = 0$. Thus the systems $R^pF(E_n)$ all
satisfy the ML condition and $R^1\lim$ gives zero (see discussion
in More on Algebra, Section \ref{more-algebra-section-Rlim}).
Moreover, the system $R^0F(\tau_{\geq - n}E)$ is constant starting
with $n = N - 1$ as desired.
\end{proof}

\noindent
The following lemma is the key ingredient to many of the
results in this chapter.

\begin{lemma}
\label{lemma-affine-compare-bounded}
Let $X = \Spec(A)$ be an affine scheme. All the functors in the diagram
$$
\xymatrix{
D(\textit{QCoh}(\mathcal{O}_X)) \ar[rr]_{(\ref{equation-compare})}
& &
D_{\textit{QCoh}}(\mathcal{O}_X) \ar[ld]^{R\Gamma(X, -)} \\
& D(A) \ar[lu]^{\widetilde{\ \ }}
}
$$
are equivalences of triangulated categories. Moreover, for $E$ in
$D_{\textit{QCoh}}(\mathcal{O}_X)$ we have $H^0(X, E) = H^0(X, H^0(E))$.
\end{lemma}

\begin{proof}
The functor $R\Gamma(X, -)$ gives a functor
$D(\mathcal{O}_X) \to D(A)$ and hence by restriction a functor
\begin{equation}
\label{equation-back}
R\Gamma(X, -) : D_{\textit{QCoh}}(\mathcal{O}_X) \longrightarrow D(A).
\end{equation}
We will show this functor is quasi-inverse to (\ref{equation-compare})
via the equivalence between quasi-coherent modules on $X$ and
the category of $A$-modules.

\medskip\noindent
Elucidation. Denote $(Y, \mathcal{O}_Y)$ the one point space with sheaf
of rings given by $A$. Denote
$\pi : (X, \mathcal{O}_X) \to (Y, \mathcal{O}_Y)$
the obvious morphism of ringed spaces.
Then $R\Gamma(X, -)$ can be identified with $R\pi_*$ and the functor
(\ref{equation-compare}) via the equivalence
$\textit{Mod}(\mathcal{O}_Y) = \text{Mod}_A = \textit{QCoh}(\mathcal{O}_X)$
can be identified with $L\pi^* = \pi^* = \widetilde{}$ (see
Modules, Lemma \ref{modules-lemma-construct-quasi-coherent-sheaves} and
Schemes, Lemmas \ref{schemes-lemma-compare-constructions} and
\ref{schemes-lemma-equivalence-quasi-coherent}). Thus the functors
$$
\xymatrix{
D(A) \ar@<1ex>[r] & D_{\textit{QCoh}}(\mathcal{O}_X) \ar@<1ex>[l]
}
$$
are adjoint (by Cohomology, Lemma \ref{cohomology-lemma-adjoint}). In
particular we obtain canonical adjunction mappings
$$
a : \widetilde{R\Gamma(X, E)} \longrightarrow E
$$
for $E$ in $D(\mathcal{O}_X)$ and
$$
b : M^\bullet \longrightarrow R\Gamma(X, \widetilde{M^\bullet})
$$
for $M^\bullet$ a complex of $A$-modules.

\medskip\noindent
Let $E$ be an object of $D_{\textit{QCoh}}(\mathcal{O}_X)$. We may apply
Lemma \ref{lemma-application-nice-K-injective}
to the functor $F(-) = \Gamma(X, -)$
with $N = 1$ by Cohomology of Schemes, Lemma
\ref{coherent-lemma-quasi-coherent-affine-cohomology-zero}.
Hence
$$
R^0\Gamma(X, E) = R^0\Gamma(X, \tau_{\geq 0}E) = \Gamma(X, H^0(E))
$$
(the last equality by definition of the canonical truncation).
Using this we will show that the adjunction mappings $a$ and $b$
induce isomorphisms $H^0(a)$ and $H^0(b)$. Thus $a$ and $b$
are quasi-isomorphisms (as the statement is invariant under shifts)
and the lemma is proved.

\medskip\noindent
In both cases we use that $\widetilde{\ }$ is an exact functor
(Schemes, Lemma \ref{schemes-lemma-spec-sheaves}). Namely, this
implies that
$$
H^0\left(\widetilde{R\Gamma(X, E)}\right) = \widetilde{R^0\Gamma(X, E)}
= \widetilde{\Gamma(X, H^0(E))}
$$
which is equal to $H^0(E)$ because $H^0(E)$ is quasi-coherent. Thus
$H^0(a)$ is an isomorphism. For the other direction we have
$$
H^0(R\Gamma(X, \widetilde{M^\bullet})) =
R^0\Gamma(X, \widetilde{M^\bullet}) =
\Gamma(X, H^0(\widetilde{M^\bullet})) =
\Gamma(X, \widetilde{H^0(M^\bullet)}) = H^0(M^\bullet)
$$
which proves that $H^0(b)$ is an isomorphism.
\end{proof}

\begin{lemma}
\label{lemma-affine-K-flat}
Let $X = \Spec(A)$ be an affine scheme. If $K^\bullet$ is a K-flat
complex of $A$-modules, then $\widetilde{K^\bullet}$ is a K-flat
complex of $\mathcal{O}_X$-modules.
\end{lemma}

\begin{proof}
By More on Algebra, Lemma \ref{more-algebra-lemma-base-change-K-flat}
we see that $K^\bullet \otimes_A A_\mathfrak p$ is a K-flat complex
of $A_\mathfrak p$-modules for every $\mathfrak p \in \Spec(A)$.
Hence we conclude from
Cohomology, Lemma \ref{cohomology-lemma-check-K-flat-stalks}
(and
Schemes, Lemma \ref{schemes-lemma-spec-sheaves})
that $\widetilde{K^\bullet}$ is K-flat.
\end{proof}

\begin{lemma}
\label{lemma-quasi-coherence-pullback}
Let $f : Y \to X$ be a morphism of schemes.
\begin{enumerate}
\item The functor $Lf^*$ sends $D_{\textit{QCoh}}(\mathcal{O}_X)$
into $D_{\textit{QCoh}}(\mathcal{O}_Y)$.
\item If $X$ and $Y$ are affine and $f$ is given by the ring map
$A \to B$, then the diagram
$$
\xymatrix{
D(B) \ar[r] & D_{\textit{QCoh}}(\mathcal{O}_Y) \\
D(A) \ar[r] \ar[u]^{- \otimes_A^\mathbf{L} B} &
D_{\textit{QCoh}}(\mathcal{O}_X) \ar[u]_{Lf^*}
}
$$
commutes.
\end{enumerate}
\end{lemma}

\begin{proof}
We first prove the diagram
$$
\xymatrix{
D(B) \ar[r] & D(\mathcal{O}_Y) \\
D(A) \ar[r] \ar[u]^{- \otimes_A^\mathbf{L} B} &
D(\mathcal{O}_X) \ar[u]_{Lf^*}
}
$$
commutes. This is clear from Lemma \ref{lemma-affine-K-flat} and
the constructions of the functors in question. To see (1) let
$E$ be an object of $D_{\textit{QCoh}}(\mathcal{O}_X)$. To see that
$Lf^*E$ has quasi-coherent cohomology sheaves we may work locally on $X$.
Note that $Lf^*$ is compatible with restricting to open subschemes.
Hence we can assume that $f$ is a morphism of affine schemes as in (2).
Then we can apply Lemma \ref{lemma-affine-compare-bounded} to see that
$E$ comes from a complex of $A$-modules. By the commutativity of the first
diagram of the proof the same holds for $Lf^*E$ and we conclude (1) is true.
\end{proof}

\begin{lemma}
\label{lemma-quasi-coherence-tensor-product}
Let $X$ be a scheme.
\begin{enumerate}
\item For objects $K, L$ of $D_{\textit{QCoh}}(\mathcal{O}_X)$
the derived tensor product $K \otimes^\mathbf{L} L$ is in
$D_{\textit{QCoh}}(\mathcal{O}_X)$.
\item If $X = \Spec(A)$ is affine then
$$
\widetilde{M^\bullet} \otimes_{\mathcal{O}_X}^\mathbf{L} \widetilde{K^\bullet}
=
\widetilde{M^\bullet \otimes_A^\mathbf{L} K^\bullet}
$$
for any pair of complexes of $A$-modules $K^\bullet$, $M^\bullet$.
\end{enumerate}
\end{lemma}

\begin{proof}
The equality of (2) follows immediately from Lemma \ref{lemma-affine-K-flat}
and the construction of the derived tensor product.
To see (1) let $K, L$ be objects of $D_{\textit{QCoh}}(\mathcal{O}_X)$.
To check that $K \otimes^\mathbf{L} L$ is in
$D_{\textit{QCoh}}(\mathcal{O}_X)$ we may work locally on $X$, hence
we may assume $X = \Spec(A)$ is affine. By
Lemma \ref{lemma-affine-compare-bounded} we may represent
$K$ and $L$ by complexes of $A$-modules. Then part (2) implies
the result.
\end{proof}





\section{Total direct image}
\label{section-total-direct-image}

\noindent
The following lemma is the analogue of
Cohomology of Schemes, Lemma
\ref{coherent-lemma-quasi-coherence-higher-direct-images}.

\begin{lemma}
\label{lemma-quasi-coherence-direct-image}
Let $f : X \to S$ be a morphism of schemes.
Assume that $f$ is quasi-separated and quasi-compact.
\begin{enumerate}
\item The functor $Rf_*$ sends $D_{\textit{QCoh}}(\mathcal{O}_X)$
into $D_{\textit{QCoh}}(\mathcal{O}_S)$.
\item If $S$ is quasi-compact, there exists an integer $N = N(X, S, f)$
such that for an object $E$ of $D_{\textit{QCoh}}(\mathcal{O}_X)$
with $H^m(E) = 0$ for $m > 0$ we have
$H^m(Rf_*E) = 0$ for $m > N$.
\item In fact, if $S$ is quasi-compact we can find $N = N(X, S, f)$
such that for every morphism of schemes $S' \to S$
the same conclusion holds for the functor $R(f')_*$
where $f' : X' \to S'$ is the base change of $f$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $E$ be an object of $D_{\textit{QCoh}}(\mathcal{O}_X)$.
To prove (1) we have to show that $Rf_*E$ has quasi-coherent
cohomology sheaves. This question is local on $S$, hence we may
assume $S$ is quasi-compact. Pick $N = N(X, S, f)$ as in
Cohomology of Schemes, Lemma
\ref{coherent-lemma-quasi-coherence-higher-direct-images}.
Thus $R^pf_*\mathcal{F} = 0$ for all quasi-coherent $\mathcal{O}_X$-modules
$\mathcal{F}$ and all $p \geq N$. In particular, for any affine
open $U \subset S$ we have $H^p(f^{-1}(U), \mathcal{F}) = 0$
for $p \geq N$, see
Cohomology of Schemes, Lemma
\ref{coherent-lemma-quasi-coherence-higher-direct-images-application}.

\medskip\noindent
Let $E$ be an object of $D_{\textit{QCoh}}(\mathcal{O}_X)$.
Choose $\mathcal{I}^\bullet = \lim \mathcal{I}_n^\bullet$
as in Lemma \ref{lemma-nice-K-injective}.
As $\mathcal{I}^\bullet$ is K-injective $Rf_*E$ is represented by
$f_*\mathcal{I}^\bullet = \lim f_*\mathcal{I}_n^\bullet$.
Let $U \subset S$ be any affine open. The cohomology
$H^m(f_*\mathcal{I}_n^\bullet(U))$ of
$$
f_*\mathcal{I}_n^{m - 1}(U) \to
f_*\mathcal{I}_n^m(U) \to
f_*\mathcal{I}_n^{m + 1}(U)
$$
is equal to $H^m(f^{-1}(U), \tau_{\geq -n}E)$ because $\mathcal{I}_n^\bullet$
is a bounded below complex of injectives representing $\tau_{\geq -n}E$.
We have a distinguished triangle
$$
H^{-n}(E)[n] \to \tau_{\geq -n}E \to \tau_{\geq - n + 1}E \to H^{-n}(E)[n + 1]
$$
(Derived Categories, Remark
\ref{derived-remark-truncation-distinguished-triangle})
in $D(\mathcal{O}_X)$. Since $H^{-n}(E)$ is quasi-coherent we have
$H^m(f^{-1}(U), H^{-n}(E)[n]) = 0$ for $n + m \geq N$ by
our choice of $N$. Similarly, $H^m(f^{-1}(U), H^{-n}(E)[n + 1]) = 0$
for $n + m + 1 \geq N$. We conclude that
$$
H^m(f_*\mathcal{I}_n^\bullet(U)) \to H^m(f_*\mathcal{I}_{n - 1}^\bullet(U))
$$
is an isomorphism for all $n \geq N - m$. Thus
Cohomology, Lemma \ref{cohomology-lemma-inverse-limit-complexes}
applies to show that the $m$th cohomology sheaf of
$\lim f_*\mathcal{I}_n^\bullet$ agrees with the $m$th cohomology
sheaf of $f_*\mathcal{I}_n^\bullet$ for $n \geq N - m$. Since these
cohomology sheaves are quasi-coherent by
Cohomology of Schemes, Lemma
\ref{coherent-lemma-quasi-coherence-higher-direct-images}
we get (1).

\medskip\noindent
Finally, we show that (2) and (3) hold with our choice of $N$.
Namely, the stabilization proven above gives that $H^m(Rf_*E)$ is equal
to $H^m(Rf_*(\tau_{\geq -n}E))$ for all $n$ large enough which means we
can work with objects in $D^+(\mathcal{O}_X)$ in order to prove (2) and (3).
In this case we can for example use the spectral sequence
$$
R^pf_*H^q(E) \Rightarrow R^{p + q}f_*E
$$
(Derived Categories, Lemma \ref{derived-lemma-two-ss-complex-functor})
and the vanishing of $R^pf_*H^q(E)$ for $p \geq N$ to conclude.
Some details omitted.
\end{proof}

\begin{lemma}
\label{lemma-quasi-coherence-pushforward-direct-sums}
Let $f : X \to S$ be a quasi-separated and quasi-compact morphism of
schemes. Then
$Rf_* : D_{\textit{QCoh}}(\mathcal{O}_X) \to D_{\textit{QCoh}}(\mathcal{O}_S)$
commutes with direct sums.
\end{lemma}

\begin{proof}
Let $E_i$ be a family of objects of $D_{\textit{QCoh}}(\mathcal{O}_X)$
and set $E = \bigoplus E_i$. We want to show that the map
$$
\bigoplus Rf_*E_i \longrightarrow Rf_*E
$$
is an isomomorphism. We will show it induces an isomorphism on
cohomology sheaves in degree $0$ which will imply the lemma.
Choose an integer $N$ as in Lemma \ref{lemma-quasi-coherence-direct-image}.
Then $R^0f_*E = R^0f_*\tau_{\geq -N}E$ and
$R^0f_*E_i = R^0f_*\tau_{\geq -N}E_i$ by the lemma cited. Observe that
$\tau_{\geq -N}E = \bigoplus \tau_{\geq -N}E_i$.
Thus we may assume all of the $E_i$ have vanishing cohomology
sheaves in degrees $< -N$. Next we use the spectral sequences
$$
R^pf_*H^q(E) \Rightarrow R^{p + q}f_*E
\quad\text{and}\quad
R^pf_*H^q(E_i) \Rightarrow R^{p + q}f_*E_i
$$
(Derived Categories, Lemma \ref{derived-lemma-two-ss-complex-functor})
to reduce to the case of a direct sum of quasi-coherent sheaves.
This case is handled by
Cohomology of Schemes, Lemma \ref{coherent-lemma-colimit-cohomology}.
\end{proof}

\begin{lemma}
\label{lemma-affine-morphism}
Let $f : X \to S$ be an affine morphism of schemes.
Then
$Rf_* : D_{\textit{QCoh}}(\mathcal{O}_X) \to D_{\textit{QCoh}}(\mathcal{O}_S)$
reflects isomorphisms.
\end{lemma}

\begin{proof}
The statement means that a morphism $\alpha : E \to F$ of
$D_{\textit{QCoh}}(\mathcal{O}_X)$ is an isomorphism if
$Rf_*\alpha$ is an isomorphism. We may check this on cohomology sheaves.
In particular, the question is local on $S$. Hence we may assume $S$
and therefore $X$ is affine. In this case the statement is clear from
the description of the derived categories
$D_{\textit{QCoh}}(\mathcal{O}_X)$ and
$D_{\textit{QCoh}}(\mathcal{O}_S)$ given in
Lemma \ref{lemma-affine-compare-bounded}.
Some details omitted.
\end{proof}

\begin{lemma}
\label{lemma-affine-morphism-pull-push}
Let $f : X \to S$ be an affine morphism of schemes.
For $E$ in $D_{\textit{QCoh}}(\mathcal{O}_S)$ we have
$Rf_* Lf^* E = E \otimes^\mathbf{L}_{\mathcal{O}_S} f_*\mathcal{O}_X$.
\end{lemma}

\begin{proof}
Since $f$ is affine the map $f_*\mathcal{O}_X \to Rf_*\mathcal{O}_X$
is an isomorphism
(Cohomology of Schemes, Lemma \ref{coherent-lemma-relative-affine-vanishing}).
There is a canonical map $E \otimes^\mathbf{L} f_*\mathcal{O}_X =
E \otimes^\mathbf{L} Rf_*\mathcal{O}_X \to Rf_* Lf^* E$
adjoint to the map
$$
Lf^*(E \otimes^\mathbf{L} Rf_*\mathcal{O}_X) =
Lf^*E \otimes^\mathbf{L} Lf^*Rf_*\mathcal{O}_X \longrightarrow
Lf^* E \otimes^\mathbf{L} \mathcal{O}_X = Lf^* E
$$
coming from $1 : Lf^*E \to Lf^*E$ and the canonical map
$Lf^*Rf_*\mathcal{O}_X \to \mathcal{O}_X$. To check the map so constructed
is an isomorphism we may work locally on $S$. Hence we may assume
$S$ and therefore $X$ is affine. In this case the statement is clear from
the description of the derived categories
$D_{\textit{QCoh}}(\mathcal{O}_X)$ and
$D_{\textit{QCoh}}(\mathcal{O}_S)$ and the functor $Lf^*$ given in
Lemmas \ref{lemma-affine-compare-bounded} and
\ref{lemma-quasi-coherence-pullback}.
Some details omitted.
\end{proof}





\section{Derived category of coherent modules}
\label{section-derived-coherent}

\noindent
Let $X$ be a locally Noetherian scheme. In this case the category
$\textit{Coh}(\mathcal{O}_X) \subset \textit{Mod}(\mathcal{O}_X)$
of coherent $\mathcal{O}_X$-modules is a weak Serre subcategory, see
Homology, Section \ref{homology-section-serre-subcategories}
and
Cohomology of Schemes, Lemma \ref{coherent-lemma-coherent-abelian-Noetherian}.
Denote
$$
D_{\textit{Coh}}(\mathcal{O}_X) \subset D(\mathcal{O}_X)
$$
the subcategory of complexes whose cohomology sheaves are coherent, see
Derived Categories, Section \ref{derived-section-triangulated-sub}.
Thus we obtain a canonical functor
\begin{equation}
\label{equation-compare-coherent}
D(\textit{Coh}(\mathcal{O}_X))
\longrightarrow
D_{\textit{Coh}}(\mathcal{O}_X)
\end{equation}
see Derived Categories, Equation (\ref{derived-equation-compare}).

\begin{lemma}
\label{lemma-direct-image-coherent}
Let $S$ be a Noetherian scheme. Let $f : X \to S$ be a morphism of schemes
which is locally of finite type. Let $E$ be an object of
$D^b_{\textit{Coh}}(\mathcal{O}_X)$ such that the scheme theoretic support
of $H^i(E)$ is proper over $S$ for all $i$.
Then $Rf_*E$ is an object of $D^b_{\textit{Coh}}(\mathcal{O}_S)$.
\end{lemma}

\begin{proof}
Consider the spectral sequence
$$
R^pf_*H^q(E) \Rightarrow R^{p + q}f_*E
$$
see Derived Categories, Lemma \ref{derived-lemma-two-ss-complex-functor}.
By assumption and
Cohomology of Schemes, Remark
\ref{coherent-remark-scheme-theoretic-support-proper}
the sheaves $R^pf_*H^q(E)$ are coherent. Hence
$R^{p + q}f_*E$ is coherent, i.e., $E \in D_{\textit{Coh}}(\mathcal{O}_S)$.
Boundedness from below is trivial. Boundedness from above
follows from
Cohomology of Schemes, Lemma
\ref{coherent-lemma-quasi-coherence-higher-direct-images}
or from
Lemma \ref{lemma-quasi-coherence-direct-image}.
\end{proof}








\section{The coherator}
\label{section-coherator}

\noindent
Let $X$ be a scheme. The {\it coherator} is a functor
$$
Q_X :
\textit{Mod}(\mathcal{O}_X)
\longrightarrow
\textit{QCoh}(\mathcal{O}_X)
$$
which is right adjoint to the inclusion functor
$\textit{QCoh}(\mathcal{O}_X) \to \textit{Mod}(\mathcal{O}_X)$.
It exists for any scheme $X$ and moreover the adjunction mapping
$Q_X(\mathcal{F}) \to \mathcal{F}$ is an isomorphism for every
quasi-coherent module $\mathcal{F}$, see
Properties, Proposition \ref{properties-proposition-coherator}.
Since $Q_X$ is left exact (as a right adjoint) we can consider its
right derived extension
$$
RQ_X :
D(\mathcal{O}_X)
\longrightarrow
D(\textit{QCoh}(\mathcal{O}_X)).
$$
As this functor is constructed by applying $Q_X$ to a K-injective replacement
we see that $RQ_X$ is a right adjoint to the canonical functor
$D(\textit{QCoh}(\mathcal{O}_X)) \to D(\mathcal{O}_X)$.

\begin{lemma}
\label{lemma-affine-pushforward}
Let $f : X \to Y$ be an affine morphism of schemes.
Then $f_*$ defines a derived functor
$f_* : D(\textit{QCoh}(\mathcal{O}_X)) \to D(\textit{QCoh}(\mathcal{O}_Y))$.
This functor has the property that
$$
\xymatrix{
D(\textit{QCoh}(\mathcal{O}_X)) \ar[d]_{f_*} \ar[r] &
D_{\textit{QCoh}}(\mathcal{O}_X) \ar[d]^{Rf_*} \\
D(\textit{QCoh}(\mathcal{O}_Y)) \ar[r] &
D_{\textit{QCoh}}(\mathcal{O}_Y)
}
$$
commutes.
\end{lemma}

\begin{proof}
The functor
$f_* : \textit{QCoh}(\mathcal{O}_X) \to \textit{QCoh}(\mathcal{O}_Y)$
is exact, see
Cohomology of Schemes, Lemma \ref{coherent-lemma-relative-affine-vanishing}.
Hence $f_*$ defines a derived functor
$f_* : D(\textit{QCoh}(\mathcal{O}_X)) \to D(\textit{QCoh}(\mathcal{O}_Y))$
by simply applying $f_*$ to any representative complex, see
Derived Categories, Lemma \ref{derived-lemma-right-derived-exact-functor}.
For any complex of $\mathcal{O}_X$-modules
$\mathcal{F}^\bullet$ there is a canonical map
$f_*\mathcal{F}^\bullet \to Rf_*\mathcal{F}^\bullet$.
To finish the proof we show this is a quasi-isomorphism when
$\mathcal{F}^\bullet$ is a complex with each $\mathcal{F}^n$
quasi-coherent. As the statement is invariant under shifts it
suffices to show that
$H^0(f_*(\mathcal{F}^\bullet)) \to R^0f_*\mathcal{F}^\bullet$
is an isomorphism. The statement is local on $Y$ hence we
may assume $Y$ affine. By
Lemma \ref{lemma-quasi-coherence-direct-image}
we have $R^0f_*\mathcal{F}^\bullet = R^0f_*\tau_{\geq -n}\mathcal{F}^\bullet$
for all sufficiently large $n$. Thus we may assume $\mathcal{F}^\bullet$
bounded below. As each $\mathcal{F}^n$ is $f_*$-acyclic by
Cohomology of Schemes, Lemma \ref{coherent-lemma-relative-affine-vanishing}
we see that
$f_*\mathcal{F}^\bullet \to Rf_*\mathcal{F}^\bullet$
is a quasi-isomorphism by
Leray's acyclicity lemma (Derived Categories, Lemma
\ref{derived-lemma-leray-acyclicity}).
\end{proof}

\begin{lemma}
\label{lemma-affine-flat-coherator}
Let $f : X \to Y$ be an affine flat morphism of schemes.
Then $RQ_Y \circ Rf_* = f_* \circ RQ_X$ where $f_*$ is as
in Lemma \ref{lemma-affine-pushforward}.
\end{lemma}

\begin{proof}
Since $f$ is flat, then functor $f^*$ is exact hence defines
$f^* : D(\mathcal{O}_Y) \to D(\mathcal{O}_X)$ and also
$f^* : D(\textit{QCoh}(\mathcal{O}_Y)) \to D(\textit{QCoh}(\mathcal{O}_X))$.
The functor $f^* = Lf^* : D(\mathcal{O}_Y) \to D(\mathcal{O}_X)$
is left adjoint to
$Rf_* : D(\mathcal{O}_X) \to D(\mathcal{O}_Y)$,
see Cohomology, Lemma \ref{cohomology-lemma-adjoint}.
On the other hand, the functor
$f^* : D(\textit{QCoh}(\mathcal{O}_Y)) \to D(\textit{QCoh}(\mathcal{O}_X))$
is left adjoint to
$f_* : D(\textit{QCoh}(\mathcal{O}_X)) \to D(\textit{QCoh}(\mathcal{O}_Y))$
just because these are constructed from an adjoint pair of exact functors.
Now let $A$ be an object of $D(\textit{QCoh}(\mathcal{O}_Y))$ and
$E$ an object of $D(\mathcal{O}_X)$. Then
\begin{align*}
\Hom_{D(\textit{QCoh}(\mathcal{O}_Y))}(A, RQ_Y(Rf_*E))
& =
\Hom_{D(\mathcal{O}_Y)}(A, Rf_*E) \\
& =
\Hom_{D(\mathcal{O}_X)}(f^*A, E) \\
& =
\Hom_{D(\textit{QCoh}(\mathcal{O}_X))}(f^*A, RQ_X(E)) \\
& =
\Hom_{D(\textit{QCoh}(\mathcal{O}_Y))}(A, f_*RQ_X(E))
\end{align*}
This implies what we want.
\end{proof}

\begin{lemma}
\label{lemma-affine-coherator}
Let $X = \Spec(A)$ be an affine scheme. Then
\begin{enumerate}
\item $Q_X : \textit{Mod}(\mathcal{O}_X) \to \textit{QCoh}(\mathcal{O}_X)$
is the functor
which sends $\mathcal{F}$ to the quasi-coherent $\mathcal{O}_X$-module
associated to the $A$-module $\Gamma(X, \mathcal{F})$,
\item $RQ_X : D(\mathcal{O}_X) \to D(\textit{QCoh}(\mathcal{O}_X))$
is the functor which sends $E$ to the complex of quasi-coherent
$\mathcal{O}_X$-modules associated to the object $R\Gamma(X, E)$ of $D(A)$,
\item restricted to $D_{\textit{QCoh}}(\mathcal{O}_X)$ the functor
$RQ_X$ defines a quasi-inverse to (\ref{equation-compare}).
\end{enumerate}
\end{lemma}

\begin{proof}
The functor $Q_X$ is the functor
$$
\mathcal{F} \mapsto \widetilde{\Gamma(X, \mathcal{F})}
$$
by Schemes, Lemma \ref{schemes-lemma-compare-constructions}.
This immediately implies (1) and (2). The third assertion
follows from (the proof of)
Lemma \ref{lemma-affine-compare-bounded}.
\end{proof}

\begin{definition}
\label{definition-supported-on}
Let $X$ be a scheme. Let $E$ be an object of $D(\mathcal{O}_X)$.
Let $T \subset X$ be a closed subset.
We say $E$ is {\it supported on $T$} if the
cohomology sheaves $H^i(E)$ are supported on $T$.
\end{definition}

\begin{proposition}
\label{proposition-quasi-compact-affine-diagonal}
Let $X$ be a quasi-compact scheme with affine diagonal.
Then the functor (\ref{equation-compare})
$$
D(\textit{QCoh}(\mathcal{O}_X))
\longrightarrow
D_{\textit{QCoh}}(\mathcal{O}_X)
$$
is an equivalence with quasi-inverse given by $RQ_X$.
\end{proposition}

\begin{proof}
Let $E$ be an object of $D_{\textit{QCoh}}(\mathcal{O}_X)$ and
let $A$ be an object of $D(\textit{QCoh}(\mathcal{O}_X))$.
We have to show that the adjunction maps
$$
RQ_X(A) \to A
\quad\text{and}\quad
E \to RQ_X(E)
$$
are isomorphisms. We will prove this by induction on $n$:
the smallest integer $n \geq 0$ such that $E$ and $A$ are supported
on a closed subset of $X$ which
is contained in the union of $n$ affine opens of $X$. If $n = 0$
then $E$ and $A$ are zero; this is the base case of the induction.

\medskip\noindent
Suppose that $E$ and $A$ are supported on a closed subset $T$ of
$U_1 \cup \ldots \cup U_n$ with $U_i \subset X$ affine open.
Set $U = U_n$. The inclusion morphism
$j : U \to X$ is flat and affine
(Morphisms, Lemma \ref{morphisms-lemma-affine-permanence}).
Consider the distinguished triangles
$$
A \to j_*(A|_U) \to A' \to A[1]
\quad\text{and}\quad
E \to Rj_*(E|_U) \to E' \to E[1]
$$
where $j_*$ is as in Lemma \ref{lemma-affine-pushforward}.
Note that $A \to j_*(A|_U)$ and $E \to Rj_*(E|_U)$ are quasi-isomorphisms
over $U = U_n$. Hence $A'$ and $E'$ are supported on the closed
subset $T \setminus U_1$ contained in $U_1 \cup \ldots \cup U_{n - 1}$.
By induction hypothesis the statement is true for $A'$ and $E'$. By
Derived Categories, Lemma \ref{derived-lemma-third-isomorphism-triangle}
it suffices to prove the maps
$$
RQ_X(j_*(A|_U)) \to j_*(A|_U)
\quad\text{and}\quad
Rj_*(E|_U) \to RQ_X(Rj_*E|_U)
$$
are isomorphisms. By Lemma \ref{lemma-affine-flat-coherator} we have
$RQ_X(j_*(A|_U)) = j_*RQ_U(A|_U)$ and
$RQ_X(Rj_*E|_U) = j_*RQ_U(E|_U)$. Finally, the maps
$$
RQ_U(A|_U) \to A|_U
\quad\text{and}\quad
E|_U \to RQ_U(E|_U)
$$
are isomorphisms by Lemma \ref{lemma-affine-coherator}. The result follows.
\end{proof}



\section{Koszul complexes}
\label{section-koszul}

\noindent
Let $A$ be a ring and let $f_1, \ldots, f_r$ be a sequence of elements
of $A$. We have defined the Koszul complex
$K_\bullet(f_1, \ldots, f_r)$ in
More on Algebra, Definition \ref{more-algebra-definition-koszul-complex}.
It is a chain complex sitting in degrees $r, \ldots, 0$.
We turn this into a cochain complex $K^\bullet(f_1, \ldots, f_r)$
by setting $K^{-n}(f_1, \ldots, f_r) = K_n(f_1, \ldots, f_r)$
and using the same differentials. In the rest of this section all
the complexes will be cochain complexes.

\medskip\noindent
We define a complex $I^\bullet(f_1, \ldots, f_r)$
such that we have a distinguished triangle
$$
I^\bullet(f_1, \ldots, f_r) \to
A \to
K^\bullet(f_1, \ldots, f_r) \to
I^\bullet(f_1, \ldots, f_r)[1]
$$
in $K(A)$.
In other words, we set
$$
I^i(f_1, \ldots, f_r) =
\left\{
\begin{matrix}
K^{i - 1}(f_1, \ldots, f_r) & \text{if } i \leq 0 \\
0 & \text{else}
\end{matrix}
\right.
$$
and we use the negative of the differential on $K^\bullet(f_1, \ldots, f_r)$.
The maps in the distinguished triangle are the obvious ones. Note that
$I^0(f_1, \ldots, f_r) = A^{\oplus r} \to A$ is given by
multiplication by $f_i$ on the $i$th factor.
Hence $I^\bullet(f_1, \ldots, f_r) \to A$ factors as
$$
I^\bullet(f_1, \ldots, f_r) \to I \to A
$$
where $I = (f_1, \ldots, f_r)$. In fact, there is a short exact sequence
$$
0 \to H^{-1}(K^\bullet(f_1, \ldots, f_s)) \to
H^0(I^\bullet(f_1, \ldots, f_s)) \to I \to 0
$$
and for every $i < 0$ we have
$H^i(I^\bullet(f_1, \ldots, f_r)) = H^{i - 1}(K^\bullet(f_1, \ldots, f_r)$.
Observe that given a second sequence $g_1, \ldots, g_r$ of elements of $A$
there are canonical maps
$$
I^\bullet(f_1g_1, \ldots, f_rg_r) \to I^\bullet(f_1, \ldots, f_r)
\quad\text{and}\quad
K^\bullet(f_1g_1, \ldots, f_rg_r) \to K^\bullet(f_1, \ldots, f_r)
$$
compatible with the maps described above. The first of these maps is
given by multiplcation by $g_i$ on the $i$th summand of
$I^0(f_1g_1, \ldots, f_rg_r) = A^{\oplus r}$. In particular, given
$f_1, \ldots, f_r$ we obtain an inverse system of complexes
\begin{equation}
\label{equation-system}
I^\bullet(f_1, \ldots, f_r) \leftarrow
I^\bullet(f_1^2, \ldots, f_r^2) \leftarrow
I^\bullet(f_1^3, \ldots, f_r^3) \leftarrow \ldots
\end{equation}
which will play an important role in that which is to follow.
To easily formulate the following lemmas we fix some notation.

\begin{situation}
\label{situation-complex}
Here $A$ is a ring and $f_1, \ldots, f_r$ is a sequence of elements of $A$.
We set $X = \Spec(A)$ and $U = D(f_1) \cup \ldots \cup D(f_r) \subset X$.
We denote $\mathcal{U} : U = \bigcup_{i = 1, \ldots, r} D(f_i)$ the
given open covering of $U$.
\end{situation}

\noindent
Our first lemma is that the complexes above can be used to compute
the cohomology of quasi-coherent sheaves on $U$. Suppose given a
complex $I^\bullet$ of $A$-modules and an $A$-module $M$. Then we
define $\Hom_A(I^\bullet, M)$ to be the complex with $n$th
term $\Hom_A(I^{-n}, M)$ and differentials given as the contragredients
of the differentials on $I^\bullet$.

\begin{lemma}
\label{lemma-alternating-cech-complex}
In Situation \ref{situation-complex}. Let $M$ be an $A$-module and
denote $\mathcal{F}$ the associated $\mathcal{O}_X$-module. Then
there is a canonical isomorphism of complexes
$$
\colim_e \Hom_A(I^\bullet(f_1^e, \ldots, f_r^e), M)
\longrightarrow
\check{\mathcal{C}}_{alt}^\bullet(\mathcal{U}, \mathcal{F})
$$
functorial in $M$.
\end{lemma}

\begin{proof}
Recall that the alternating {\v C}ech complex is the subcomplex
of the usual {\v C}ech complex given by alternating cochains, see
Cohomology, Section \ref{cohomology-section-alternating-cech}.
As usual we view a $p$-cochain in
$\check{\mathcal{C}}_{alt}^\bullet(\mathcal{U}, \mathcal{F})$
as an alternating function $s$ on $\{1, \ldots, r\}^{p + 1}$
whose value $s_{i_0\ldots i_p}$ at $(i_0, \ldots, i_p)$ lies in
$M_{f_{i_0}\ldots f_{i_p}} = \mathcal{F}(U_{i_0\ldots i_p})$.
On the other hand, a $p$-cochain $t$ in
$\Hom_A(I^\bullet(f_1^e, \ldots, f_r^e), M)$
is given by a map $t : \wedge^{p + 1}(A^{\oplus r}) \to M$.
Write $[i] \in A^{\oplus r}$ for the $i$th basis element and
write
$$
[i_0, \ldots, i_p] = [i_0] \wedge \ldots \wedge [i_p]
\in \wedge^{p + 1}(A^{\oplus r})
$$
Then we send $t$ as above to $s$ with
$$
s_{i_0\ldots i_p} = \frac{t([i_0, \ldots, i_p])}{f_{i_0}^e\ldots f_{i_p}^e}
$$
It is clear that $s$ so defined is an alternating cochain.
The construction of this map is compatible with the transition maps
of the system as the transition map
$$
I^\bullet(f_1^e, \ldots, f_r^e) \leftarrow
I^\bullet(f_1^{e + 1}, \ldots, f_r^{e + 1}),
$$
of the (\ref{equation-system}) sends $[i_0, \ldots, i_p]$
to $f_{i_0}\ldots f_{i_p}[i_0, \ldots, i_p]$.
It is clear from the description of the localizations
$M_{f_{i_0}\ldots f_{i_p}}$ in
Algebra, Lemma \ref{algebra-lemma-localization-colimit}
that these maps define an isomorphism of cochain modules in degree $p$
in the limit. To finish the proof we have to show that the map
is compatible with differentials. To see this recall that
\begin{align*}
d(s)_{i_0\ldots i_{p + 1}}
& =
\sum\nolimits_{j = 0}^{p + 1} (-1)^j
s_{i_0\ldots \hat i_j \ldots i_p} \\
& = 
\sum\nolimits_{j = 0}^{p + 1} (-1)^j
\frac{t([i_0, \ldots, \hat i_j, \ldots i_{p + 1}])}
{f_{i_0}^e\ldots \hat f_{i_j}^e \ldots f_{i_{p + 1}}^e}
\end{align*}
On the other hand, we have
\begin{align*}
\frac{d(t)([i_0, \ldots, i_{p + 1}])}{f_{i_0}^e\ldots f_{i_{p + 1}}^e}
& =
\frac{t(d[i_0, \ldots, i_{p + 1}])}{f_{i_0}^e\ldots f_{i_{p + 1}}^e} \\
& =
\frac{\sum_j (-1)^j f_{i_j}^e t([i_0, \ldots, \hat i_j, \ldots i_{p + 1}])}
{f_{i_0}^e \ldots f_{i_{p + 1}}^e}
\end{align*}
The two formulas agree by inspection.
\end{proof}

\medskip\noindent
Suppose given a finite complex $I^\bullet$ of $A$-modules and a
complex of $A$-modules $M^\bullet$. We obtain a double complex
$H^{\bullet, \bullet} = \Hom_A(I^\bullet, M^\bullet)$ where
$H^{p, q} = \Hom_A(I^p, M^q)$. The first differential comes from
the differential on $\Hom_A(I^\bullet, M^q)$ and the second
from the differential on $M^\bullet$. Associated to this double
complex is the total complex with degree $n$ term given by
$$
\bigoplus\nolimits_{p + q = n} \Hom_A(I^p, M^q)
$$
and differential as in
Homology, Definition \ref{homology-definition-associated-simple-complex}.
As our complex $I^\bullet$ has only finitely many nonzero terms, the
direct sum displayed above is finite.
The conventions for taking the total complex associated to a
{\v C}ech complex of a complex are as in
Cohomology, Section \ref{cohomology-section-cech-cohomology-of-complexes}.

\begin{lemma}
\label{lemma-alternating-cech-complex-complex}
In Situation \ref{situation-complex}. Let $M^\bullet$ be a
complex of $A$-modules and
denote $\mathcal{F}^\bullet$ the associated complex of
$\mathcal{O}_X$-modules. Then
there is a canonical isomorphism of complexes
$$
\colim_e \text{Tot}(\Hom_A(I^\bullet(f_1^e, \ldots, f_r^e), M^\bullet))
\longrightarrow
\text{Tot}(\check{\mathcal{C}}_{alt}^\bullet(\mathcal{U}, \mathcal{F}^\bullet))
$$
functorial in $M^\bullet$.
\end{lemma}

\begin{proof}
Immediate from Lemma \ref{lemma-alternating-cech-complex}
and our conventions for taking associated total complexes.
\end{proof}

\begin{lemma}
\label{lemma-alternating-cech-complex-complex-computes-cohomology}
In Situation \ref{situation-complex}. Let $\mathcal{F}^\bullet$
be a complex of quasi-coherent $\mathcal{O}_X$-modules. Then
there is a canonical isomorphism
$$
\text{Tot}(\check{\mathcal{C}}_{alt}^\bullet(\mathcal{U}, \mathcal{F}^\bullet))
\longrightarrow
R\Gamma(U, \mathcal{F}^\bullet)
$$
in $D(A)$ functorial in $\mathcal{F}^\bullet$.
\end{lemma}

\begin{proof}
Let $\mathcal{B}$ be the set of affine opens of $U$. Since the higher
cohomology groups of a quasi-coherent module on an affine scheme are zero
(Cohomology of Schemes, Lemma
\ref{coherent-lemma-quasi-coherent-affine-cohomology-zero})
this is a special case of
Cohomology, Lemma \ref{cohomology-lemma-alternating-cech-complex-complex-ss}.
\end{proof}

\noindent
In Situation \ref{situation-complex} denote $I_e$ the object of
$D(\mathcal{O}_X)$ corresponding to the complex of $A$-modules
$I^\bullet(f_1^e, \ldots, f_r^e)$ via the equivalence of
Lemma \ref{lemma-affine-compare-bounded}. The maps
(\ref{equation-system}) give a system
$$
I_1 \leftarrow
I_2 \leftarrow
I_3 \leftarrow \ldots
$$
Moreover, there is a compatible system of maps $I_e \to \mathcal{O}_X$
which become isomorphisms when restricted to $U$. Thus we see that for
every object $E$ of $D(\mathcal{O}_X)$ there is a canonical map
\begin{equation}
\label{equation-comparison}
\colim_e \Hom_{D(\mathcal{O}_X)}(I_e, E) \longrightarrow H^0(U, E)
\end{equation}
constructed by sending a map $I_e \to E$ to its restriction to $U$
and using that
$\Hom_{D(\mathcal{O}_U)}(\mathcal{O}_U, E|_U) = H^0(U, E)$.

\begin{proposition}
\label{proposition-represent-cohomology-class-on-open}
In Situation \ref{situation-complex}. For every object $E$
of $D_{\textit{QCoh}}(\mathcal{O}_X)$ the map
(\ref{equation-comparison}) is an isomorphism.
\end{proposition}

\begin{proof}
By Lemma \ref{lemma-affine-compare-bounded} we may assume that $E$
is given by a complex of quasi-coherent sheaves $\mathcal{F}^\bullet$.
Let $M^\bullet = \Gamma(X, \mathcal{F}^\bullet)$ be the corresponding
complex of $A$-modules. By
Lemmas \ref{lemma-alternating-cech-complex-complex} and
\ref{lemma-alternating-cech-complex-complex-computes-cohomology}
we have quasi-isomorphisms
$$
\colim_e \text{Tot}(\Hom_A(I^\bullet(f_1^e, \ldots, f_r^e), M^\bullet))
\longrightarrow
\text{Tot}(\check{\mathcal{C}}_{alt}^\bullet(\mathcal{U}, \mathcal{F}^\bullet))
\longrightarrow
R\Gamma(U, \mathcal{F}^\bullet)
$$
Taking $H^0$ on both sides we obtain
$$
\colim_e \Hom_{D(A)}(I^\bullet(f_1^e, \ldots, f_r^e), M^\bullet)
=
H^0(U, E)
$$
Since $\Hom_{D(A)}(I^\bullet(f_1^e, \ldots, f_r^e), M^\bullet) =
\Hom_{D(\mathcal{O}_X)}(I_e, E)$ by
Lemma \ref{lemma-affine-compare-bounded} the lemma follows.
\end{proof}

\noindent
In Situation \ref{situation-complex} denote $K_e$ the object of
$D(\mathcal{O}_X)$ corresponding to the complex of $A$-modules
$K^\bullet(f_1^e, \ldots, f_r^e)$ via the equivalence of
Lemma \ref{lemma-affine-compare-bounded}. Thus we have distinguished
triangles
$$
I_e \to \mathcal{O}_X \to K_e \to I_e[1]
$$
and a system
$$
K_1 \leftarrow
K_2 \leftarrow
K_3 \leftarrow \ldots
$$
compatible with the system $(I_e)$.
Moreover, there is a compatible system of maps
$$
K_e \to H^0(K_e) = \mathcal{O}_X/(f_1^e, \ldots, f_r^e)
$$

\begin{lemma}
\label{lemma-represent-cohomology-class-on-closed}
In Situation \ref{situation-complex}. Let $E$ be an object of
$D_{\textit{QCoh}}(\mathcal{O}_X)$.
Assume that $H^i(E)|_U = 0$ for $i = - r + 1, \ldots, 0$.
Then given $s \in H^0(X, E)$ there exists an $e \geq 0$ and
a morphism $K_e \to E$ such that $s$ is in the image of
$H^0(X, K_e) \to H^0(X, E)$.
\end{lemma}

\begin{proof}
Since $U$ is covered by $r$ affine opens we have $H^j(U, \mathcal{F}) = 0$
for $j \geq r$ and any quasi-coherent module
(Cohomology of Schemes, Lemma \ref{coherent-lemma-vanishing-nr-affines}).
By Lemma \ref{lemma-application-nice-K-injective} we see that $H^0(U, E)$
is equal to $H^0(U, \tau_{\geq -r + 1}E)$. There is
a spectral sequence
$$
H^j(U, H^i(\tau_{\geq -r + 1}E)) \Rightarrow H^{i + j}(U, \tau_{\geq -N}E)
$$
see Derived Categories, Lemma \ref{derived-lemma-two-ss-complex-functor}.
Hence $H^0(U, E) = 0$ by our assumed vanishing of cohomology sheaves of $E$.
We conclude that $s|_U = 0$.
Think of $s$ as a morphism $\mathcal{O}_X \to E$ in $D(\mathcal{O}_X)$.
By Proposition \ref{proposition-represent-cohomology-class-on-open}
the composition $I_e \to \mathcal{O}_X \to E$ is zero for some $e$.
By the distinguished triangle $I_e \to \mathcal{O}_X \to K_e \to I_e[1]$
we obtain a morphism $K_e \to E$ such that $s$ is the composition
$\mathcal{O}_X \to K_e \to E$.
\end{proof}


\section{Pseudo-coherent and perfect complexes}
\label{section-spell-out}

\noindent
In this section we make the connection between the general
notions defined in
Cohomology, Sections \ref{cohomology-section-strictly-perfect},
\ref{cohomology-section-pseudo-coherent},
\ref{cohomology-section-tor}, and
\ref{cohomology-section-perfect}
and the corresponding notions for complexes of modules in
More on Algebra, Sections
\ref{more-algebra-section-pseudo-coherent},
\ref{more-algebra-section-tor}, and
\ref{more-algebra-section-perfect}.

\begin{lemma}
\label{lemma-pseudo-coherent}
Let $X$ be a scheme. If $E$ is an $m$-pseudo-coherent
object of $D(\mathcal{O}_X)$, then $H^i(E)$ is a quasi-coherent
$\mathcal{O}_X$-module for $i > m$.
If $E$ is pseudo-coherent, then $E$ is an object of
$D_{\textit{QCoh}}(\mathcal{O}_X)$.
\end{lemma}

\begin{proof}
Locally $H^i(E)$ is isomorphic to $H^i(\mathcal{E}^\bullet)$
with $\mathcal{E}^\bullet$ strictly perfect. The sheaves
$\mathcal{E}^i$ are direct summands of finite free modules,
hence quasi-coherent. The lemma follows.
\end{proof}

\begin{lemma}
\label{lemma-locally-ringed-space-direct-summand-free}
Let $X$ be a locally ringed space. A direct summand of a free
$\mathcal{O}_X$-module is finite locally free.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-pseudo-coherent-affine}
Let $X = \Spec(A)$ be an affine scheme. Let $M^\bullet$ be a
complex of $A$-modules and let $E$ be the corresponding object
of $D(\mathcal{O}_X)$. Then $E$ is an $m$-pseudo-coherent
(resp.\ pseudo-coherent) as an object of $D(\mathcal{O}_X)$
if and only if $M^\bullet$ is $m$-pseudo-coherent (resp.\ pseudo-coherent)
as a complex of $A$-modules.
\end{lemma}

\begin{proof}
It is immediate from the definitions that if $M^\bullet$ is
$m$-pseudo-coherent, so is $E$. To prove the converse, assume
$E$ is $m$-pseudo-coherent. As $X = \Spec(A)$ is quasi-compact with
a basis for the topology given by standard opens, we can find a standard
open covering $X = D(f_1) \cup \ldots \cup D(f_n)$ and strictly
perfect complexes $\mathcal{E}_i^\bullet$ on $D(f_i)$ and
maps $\alpha_i : \mathcal{E}_i^\bullet \to E|_{U_i}$ inducing
isomorphisms on $H^j$ for $j > m$ and surjections on $H^m$.
By Cohomology, Lemma \ref{cohomology-lemma-local-actual}
after refining the open covering
we may assume $\alpha_i$ is given by a map of complexes
$\mathcal{E}_i^\bullet \to \widetilde{M^\bullet}|_{U_i}$
for each $i$. By Lemma \ref{lemma-locally-ringed-space-direct-summand-free}
the terms $\mathcal{E}_i^n$ are finite locally free modules.
Hence after refining the open covering we may assume each
$\mathcal{E}_i^n$ is a finite free $\mathcal{O}_{U_i}$-module.
From the definition it follows that $M^\bullet_{f_i}$ is
an $m$-pseudo-coherent complex of $A_{f_i}$-modules.
We conclude by applying
More on Algebra, Lemma \ref{more-algebra-lemma-glue-pseudo-coherent}.

\medskip\noindent
The case ``pseudo-coherent'' follows from the fact that $E$ is
pseudo-coherent if and only if $E$ is $m$-pseudo-coherent for
all $m$ (by definition) and the same is true for $M^\bullet$
by More on Algebra, Lemma \ref{more-algebra-lemma-pseudo-coherent}.
\end{proof}

\begin{lemma}
\label{lemma-identify-pseudo-coherent-noetherian}
Let $X$ be a Noetherian scheme. Let $E$ be an object of
$D_{\textit{QCoh}}(\mathcal{O}_X)$. For $m \in \mathbf{Z}$ the
following are equivalent
\begin{enumerate}
\item $H^i(E)$ is coherent for $i \geq m$ and zero for $i \gg 0$, and
\item $E$ is $m$-pseudo-coherent.
\end{enumerate}
In particular, $E$ is pseudo-coherent if and only if $E$ is an object
of $D^-_{\textit{Coh}}(\mathcal{O}_X)$.
\end{lemma}

\begin{proof}
As $X$ is quasi-compact we see that in both (1) and (2) the object $E$
is bounded above. Thus the question is local on $X$ and we may assume
$X$ is affine. Say $X = \Spec(A)$ for some Noetherian ring $A$.
In this case $E$ corresponds to a complex of $A$-modules $M^\bullet$
by Lemma \ref{lemma-affine-compare-bounded}. By
Lemma \ref{lemma-pseudo-coherent-affine}
we see that $E$ is $m$-pseudo-coherent if and only if $M^\bullet$
is $m$-pseudo-coherent. On the other hand, $H^i(E)$ is coherent
if and only if $H^i(M^\bullet)$ is a finite $A$-module
(Properties, Lemma \ref{properties-lemma-finite-type-module}).
Thus the result follows from More on Algebra, Lemma
\ref{more-algebra-lemma-Noetherian-pseudo-coherent}.
\end{proof}

\begin{lemma}
\label{lemma-tor-dimension-affine}
Let $X = \Spec(A)$ be an affine scheme. Let $M^\bullet$ be a
complex of $A$-modules and let $E$ be the corresponding object
of $D(\mathcal{O}_X)$. Then
\begin{enumerate}
\item $E$ has tor amplitude in $[a, b]$ if and only if $M^\bullet$
has tor amplitude in $[a, b]$.
\item $E$ has finite tor dimension if and only if $M^\bullet$
has finite tor dimension.
\end{enumerate}
\end{lemma}

\begin{proof}
Part (2) follows trivially from part (1). In the proof of (1) we will
use the equivalence $D(A) = D_{\textit{QCoh}}(X)$ of
Lemma \ref{lemma-affine-compare-bounded}
without further mention.
Assume $M^\bullet$ has tor amplitude in $[a, b]$. Then $K^\bullet$
is isomorphic in $D(A)$ to a complex $K^\bullet$ of flat $A$-modules
with $K^i = 0$ for $i \not \in [a, b]$, see
More on Algebra, Lemma \ref{more-algebra-lemma-tor-amplitude}.
Then $E$ is isomorphic to $\widetilde{K^\bullet}$. Since each
$\widetilde{K^i}$ is a flat $\mathcal{O}_X$-module, we see
that $E$ has tor amplitude in $[a, b]$ by
Cohomology, Lemma \ref{cohomology-lemma-tor-amplitude}.

\medskip\noindent
Assume that $E$ has tor amplitude in $[a, b]$. Then $E$ is bounded
whence $M^\bullet$ is in $K^-(A)$. Thus we may replace $M^\bullet$
by a bounded above complex of $A$-modules. We may even choose
a projective resolution and assume that $M^\bullet$ is a bounded above
complex of free $A$-modules. Then for any $A$-module $N$ we have
$$
E \otimes_{\mathcal{O}_X}^\mathbf{L} \widetilde{N}
\cong
\widetilde{M^\bullet} \otimes_{\mathcal{O}_X}^\mathbf{L} \widetilde{N}
\cong
\widetilde{M^\bullet \otimes_A N}
$$
in $D(\mathcal{O}_X)$. Thus the vanishing of cohomology sheaves of
the left hand side implies $M^\bullet$ has tor amplitude in $[a, b]$.
\end{proof}

\begin{lemma}
\label{lemma-tor-qc-qs}
Let $X$ be a quasi-separated scheme. Let $E$ be an object
of $D_{\textit{QCoh}}(\mathcal{O}_X)$. Let $a \leq b$. The
following are equivalent
\begin{enumerate}
\item $E$ has tor amplitude in $[a, b]$, and
\item for all $\mathcal{F}$ in $\textit{QCoh}(\mathcal{O}_X)$
we have $H^i(E \otimes_{\mathcal{O}_X}^\mathbf{L} \mathcal{F}) = 0$
for $i \not \in [a, b]$.
\end{enumerate}
\end{lemma}

\begin{proof}
It is clear that (1) implies (2). Assume (2). Let $U \subset X$ be
an affine open. As $X$ is quasi-separated the morphism $j : U \to X$
is quasi-compact and separated, hence $j_*$ transforms quasi-coherent
modules into quasi-coherent modules
(Schemes, Lemma \ref{schemes-lemma-push-forward-quasi-coherent}).
Thus the functor
$\textit{QCoh}(\mathcal{O}_X) \to \textit{QCoh}(\mathcal{O}_U)$
is essentially surjective. It follows that condition (2)
implies the vanishing of
$H^i(E|_U \otimes_{\mathcal{O}_U}^\mathbf{L} \mathcal{G})$
for $i \not \in [a, b]$ for all quasi-coherent $\mathcal{O}_U$-modules
$\mathcal{G}$. Write $U = \Spec(A)$ and let $M^\bullet$ be the
complex of $A$-modules corresponding to $E|_U$ by
Lemma \ref{lemma-affine-compare-bounded}.
We have just shown that $M^\bullet \otimes_A^\mathbf{L} N$
has vanishing cohomology groups outside the range $[a, b]$,
in other words $M^\bullet$ has tor amplitude in $[a, b]$.
By Lemma \ref{lemma-tor-dimension-affine}
we conclude that $E|_U$ has tor amplitude in $[a, b]$.
This proves the lemma.
\end{proof}

\begin{lemma}
\label{lemma-perfect-affine}
Let $X = \Spec(A)$ be an affine scheme. Let $M^\bullet$ be a
complex of $A$-modules and let $E$ be the corresponding object
of $D(\mathcal{O}_X)$. Then $E$ is a perfect object of $D(\mathcal{O}_X)$
if and only if $M^\bullet$ is perfect as an object of $D(A)$.
\end{lemma}

\begin{proof}
This is a logical consequence of
Lemmas \ref{lemma-pseudo-coherent-affine} and
\ref{lemma-tor-dimension-affine},
Cohomology, Lemma \ref{cohomology-lemma-perfect}, and
More on Algebra, Lemma \ref{more-algebra-lemma-perfect}.
\end{proof}





\section{Lifting complexes}
\label{section-lift}

\noindent
Let $U \subset X$ be an open subspace of a ringed space
and denote $j : U \to X$ the inclusion morphism. The functor
$D(\mathcal{O}_X) \to D(\mathcal{O}_U)$ is essentially surjective as
$Rj_*$ is a right inverse to restriction.
In this section we extend this to complexes with quasi-coherent cohomology
sheaves, etc.

\begin{lemma}
\label{lemma-lift-quasi-coherent}
Let $X$ be a scheme and let $j : U \to X$ be a quasi-compact
open immersion. The functors
$$
D_{\textit{QCoh}}(\mathcal{O}_X) \to D_{\textit{QCoh}}(\mathcal{O}_U)
\quad\text{and}\quad
D^+_{\textit{QCoh}}(\mathcal{O}_X) \to D^+_{\textit{QCoh}}(\mathcal{O}_U)
$$
are essentially surjective. If $X$ is quasi-compact, then the functors
$$
D^-_{\textit{QCoh}}(\mathcal{O}_X) \to D^-_{\textit{QCoh}}(\mathcal{O}_U)
\quad\text{and}\quad
D^b_{\textit{QCoh}}(\mathcal{O}_X) \to D^b_{\textit{QCoh}}(\mathcal{O}_U)
$$
are essentially surjective.
\end{lemma}

\begin{proof}
The argument preceding the lemma applies for the first case because $Rj_*$
maps $D_{\textit{QCoh}}(\mathcal{O}_U)$ into $D_{\textit{QCoh}}(\mathcal{O}_X)$
by Lemma \ref{lemma-quasi-coherence-direct-image}.
It is clear that $Rj_*$ maps
$D^+_{\textit{QCoh}}(\mathcal{O}_U)$ into
$D^+_{\textit{QCoh}}(\mathcal{O}_X)$
which implies the statement on bounded below complexes.
Finally, Lemma \ref{lemma-quasi-coherence-direct-image}
guarantees that $Rj_*$ maps
$D^-_{\textit{QCoh}}(\mathcal{O}_U)$ into
$D^-_{\textit{QCoh}}(\mathcal{O}_X)$
if $X$ is quasi-compact. Combining these two we obtain the last statement.
\end{proof}

\begin{lemma}
\label{lemma-lift-pseudo-coherent}
Let $X$ be an affine scheme and let $U \subset X$ be a quasi-compact
open subscheme. For any pseudo-coherent object $E$ of $D(\mathcal{O}_U)$
there exists a bounded above complex of finite free $\mathcal{O}_X$-modules 
whose restriction to $U$ is isomorphic to $E$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-pseudo-coherent} we see that $E$ is an object of
$D_{\textit{QCoh}}(\mathcal{O}_U)$. By
Lemma \ref{lemma-lift-quasi-coherent}
we may assume $E = E'|U$ for some object $E'$ of
$D_{\textit{QCoh}}(\mathcal{O}_X)$.
Write $X = \Spec(A)$. By Lemma \ref{lemma-affine-compare-bounded}
we can find a complex $M^\bullet$ of $A$-modules whose associated
complex of $\mathcal{O}_X$-modules is a representative of $E'$.

\medskip\noindent
Choose $f_1, \ldots, f_r \in A$ such that $U = D(f_1) \cup \ldots \cup D(f_r)$.
By Lemma \ref{lemma-pseudo-coherent-affine} the complexes
$M^\bullet_{f_j}$ are pseudo-coherent complexes of $A_{f_j}$-modules.
Let $n$ be an integer. Assume we have a map of complexes
$\alpha : F^\bullet \to M^\bullet$ where $F^\bullet$ is
bounded above, $F^i = 0$ for $i < n$, each $F^i$ is a finite free
$R$-module, such that
$$
H^i(\alpha_{f_j}) : H^i(F^\bullet_{f_j}) \to H^i(M^\bullet_{f_j})
$$
is an isomorphism for $i > n$ and surjective for $i = n$. Picture
$$
\xymatrix{
& F^n \ar[r] \ar[d]^\alpha & F^{n + 1} \ar[d]^\alpha \ar[r] & \ldots \\
M^{n-1} \ar[r] & M^n \ar[r] & M^{n + 1} \ar[r] & \ldots
}
$$
Since each $M^\bullet_{f_j}$ has vanishing cohomology
in large degrees we can find such a map for $n \gg 0$.
By induction on $n$ we are going to extend this to a map
of complexes $F^\bullet \to M^\bullet$
such that $H^i(\alpha_{f_j})$ is an isomorphism
for all $i$. The lemma will follow by taking $\widetilde{F^\bullet}$.

\medskip\noindent
The induction step will be to extend the diagram
above by adding $F^{n - 1}$. Let $C^\bullet$ be the cone on $\alpha$
(Derived Categories, Definition \ref{derived-definition-cone}).
The long exact sequence of cohomology shows that
$H^i(C^\bullet_{f_j}) = 0$ for $i \geq n$. By
More on Algebra, Lemma \ref{more-algebra-lemma-cone-pseudo-coherent}
we see that $C^\bullet_{f_j}$ is $(n - 1)$-pseudo-coherent. By
More on Algebra, Lemma \ref{more-algebra-lemma-finite-cohomology}
we see that $H^{-1}(C^\bullet_{f_j})$ is a finite $A_{f_j}$-module.
Choose a finite free $A$-module $F^{n - 1}$ and an $A$-module
$\beta : F^{n - 1} \to C^{-1}$ such that the composition
$F^{n - 1} \to C^{n - 1} \to C^n$ is zero and such that
$F^{n - 1}_{f_j}$ surjects onto $H^{n - 1}(C^\bullet_{f_j})$.
(Some details omitted; hint: clear denominators.)
Since $C^{n - 1} = M^{n - 1} \oplus F^n$
we can write $\beta = (\alpha^{n - 1}, -d^{n - 1})$. The vanishing of the
composition $F^{n - 1} \to C^{n - 1} \to C^n$ implies
these maps fit into a morphism of complexes
$$
\xymatrix{
& F^{n - 1} \ar[d]^{\alpha^{n - 1}} \ar[r]_{d^{n - 1}} &
F^n \ar[r] \ar[d]^\alpha &
F^{n + 1} \ar[d]^\alpha \ar[r] & \ldots \\
\ldots \ar[r] &
M^{n - 1} \ar[r] & M^n \ar[r] & M^{n + 1} \ar[r] & \ldots
}
$$
Moreover, these maps define a morphism of distinguished triangles
$$
\xymatrix{
(F^n \to \ldots) \ar[r] \ar[d] &
(F^{n-1} \to \ldots) \ar[r] \ar[d] &
F^{n-1} \ar[r] \ar[d]_\beta &
(F^n \to \ldots)[1] \ar[d] \\
(F^n \to \ldots) \ar[r] &
M^\bullet \ar[r] &
C^\bullet \ar[r] &
(F^n \to \ldots)[1]
}
$$
Hence our choice of $\beta$ implies that the map of complexes
$(F^{-1} \to \ldots) \to M^\bullet$ induces an isomorphism on
cohomology localized at $f_j$ in degrees $\geq n$ and a surjection
in degree $-1$. This finishes the proof of the lemma.
\end{proof}

\begin{lemma}
\label{lemma-vanishing-ext}
Let $X$ be a quasi-compact and quasi-separated scheme.
Let $E \in D^b_{\textit{QCoh}}(\mathcal{O}_X)$.
There exists an integer $n_0 > 0$ such that
$\text{Ext}^n_{D(\mathcal{O}_X)}(\mathcal{E}, E) = 0$
for every finite locally free
$\mathcal{O}_X$-module $\mathcal{E}$ and every $n \geq n_0$.
\end{lemma}

\begin{proof}
Recall that $\text{Ext}^n_{D(\mathcal{O}_X)}(\mathcal{E}, E) =
\Hom_{D(\mathcal{O}_X)}(\mathcal{E}, E[n])$. We have
Mayer-Vietoris for morphisms in the derived category, see
Cohomology, Lemma \ref{cohomology-lemma-mayer-vietoris-hom}.
Thus if $X = U \cup V$ and the result of the lemma holds
for $E|_U$, $E|_V$, and $E|_{U \cap V}$ for some bound $n_0$,
then the result holds for $E$ with bound $n_0 + 1$.
Thus it suffices to prove the lemma when $X$ is affine, see
Cohomology of Schemes, Lemma \ref{coherent-lemma-induction-principle}.

\medskip\noindent
Assume $X = \Spec(A)$ is affine. Choose a complex of $A$-modules
$M^\bullet$ whose associated complex of quasi-coherent modules
represents $E$, see Lemma \ref{lemma-affine-compare-bounded}.
Write $\mathcal{E} = \widetilde{P}$ for some $A$-module $P$.
Since $\mathcal{E}$ is finite locally free, we see that $P$
is a finite projective $A$-module. We have
\begin{align*}
\Hom_{D(\mathcal{O}_X)}(\mathcal{E}, E[n])
& = 
\Hom_{D(A)}(P, M^\bullet[n]) \\
& =
\Hom_{K(A)}(P, M^\bullet[n]) \\
& =
\Hom_A(P, H^n(M^\bullet))
\end{align*}
The first equality by Lemma \ref{lemma-affine-compare-bounded},
the second equality by
Derived Categories, Lemma
\ref{derived-lemma-morphisms-from-projective-complex}, and
the final equality because $\Hom_A(P, -)$ is an exact functor.
As $E$ and hence $M^\bullet$ is bounded
we get zero for all sufficiently large $n$.
\end{proof}

\begin{lemma}
\label{lemma-lift-perfect-complex-plus-locally-free}
Let $X$ be an affine scheme. Let $U \subset X$ be a quasi-compact open.
For every perfect object $E$ of $D(\mathcal{O}_U)$ there exists an integer
$r$ and a finite locally free sheaf $\mathcal{F}$ on $U$ such that
$\mathcal{F}[-r] \oplus E$ is the restriction of a perfect object of
$D(\mathcal{O}_X)$.
\end{lemma}

\begin{proof}
Say $X = \Spec(A)$. Recall that a perfect complex is
pseudo-coherent, see
Cohomology, Lemma \ref{cohomology-lemma-perfect}.
By Lemma \ref{lemma-lift-pseudo-coherent} we can find a bounded above complex
$\mathcal{F}^\bullet$ of finite free $A$-modules such that $E$ is
isomorphic to $\mathcal{F}^\bullet|_U$ in $D(\mathcal{O}_U)$.
By Cohomology, Lemma \ref{cohomology-lemma-perfect} and since
$U$ is quasi-compact, we see that $E$ has finite tor dimension, say
$E$ has tor amplitude in $[a, b]$. Pick $r < a$ and set
$$
\mathcal{F} = \text{Ker}(\mathcal{F}^{r} \to \mathcal{F}^{r + 1})
= \text{Im}(\mathcal{F}^{r - 1} \to \mathcal{F}^r).
$$
Since $E$ has tor amplitude in $[a, b]$ we see that $\mathcal{F}|_U$ is
flat (Cohomology, Lemma \ref{cohomology-lemma-last-one-flat}).
Hence $\mathcal{F}|_U$ is flat and of finite presentation, thus finite
locally free (Properties, Lemma \ref{properties-lemma-finite-locally-free}).
It follows that
$$
(\mathcal{F} \to \mathcal{F}^r \to \mathcal{F}^{r + 1} \to \ldots )|_U
$$
is a strictly perfect complex on $U$ representing $E$.
We obtain a distinguished triangle
$$
\mathcal{F}|_U[- r - 1] \to E \to
(\mathcal{F}^r \to \mathcal{F}^{r + 1} \to \ldots )|_U \to
\mathcal{F}|_U[- r]
$$
Note that $(\mathcal{F}^r \to \mathcal{F}^{r + 1} \to \ldots )$ is
a perfect complex on $X$. To finish the proof it suffices to pick $r$
such that the map
$\mathcal{F}|_U[- r - 1] \to E$ is zero in $D(\mathcal{O}_U)$, see
Derived Categories, Lemma \ref{derived-lemma-split}. By
Lemma \ref{lemma-vanishing-ext} this holds if $r \ll 0$.
\end{proof}

\begin{lemma}
\label{lemma-lift-map}
Let $X$ be an affine scheme. Let $U \subset X$ be a quasi-compact open.
Let $E, E'$ be objects of $D_{\textit{QCoh}}(\mathcal{O}_X)$ with $E$ perfect.
For every map $\alpha : E|_U \to E'|_U$ there exist maps
$$
E \xleftarrow{\beta} E_1 \xrightarrow{\gamma} E'
$$
of perfect complexes on $X$ such that $\beta : E_1 \to E$ restricts to an
isomorphism on $U$ and such that $\alpha = \gamma|_U \circ \beta|_U^{-1}$.
Moreover we can assume $E_1 = E \otimes_{\mathcal{O}_X}^\mathbf{L} I$
for some perfect complex $I$ on $X$.
\end{lemma}

\begin{proof}
Write $X = \Spec(A)$. Write $U = D(f_1) \cup \ldots \cup D(f_r)$. Choose
finite complex of finite projective $A$-modules $M^\bullet$ representing
$E$ (Lemma \ref{lemma-perfect-affine}). Choose a complex of $A$-modules
$(M')^\bullet$ representing $E'$ (Lemma \ref{lemma-affine-compare-bounded}).
In this case the complex $H^\bullet = \Hom_A(M^\bullet, (M')^\bullet)$
is a complex of $A$-modules whose associated complex of quasi-coherent
$\mathcal{O}_X$-modules represents $R\SheafHom(E, E')$, see
Cohomology, Lemma \ref{cohomology-lemma-Rhom-strictly-perfect}.
Then $\alpha$ determines an element $s$ of $H^0(U, R\SheafHom(E, E'))$, see
Cohomology, Lemma \ref{cohomology-lemma-section-RHom-over-U}.
There exists an $e$ and a map
$$
\xi : I^\bullet(f_1^e, \ldots, f_r^e) \to \Hom_A(M^\bullet, (M')^\bullet)
$$
corresponding to $s$, see
Proposition \ref{proposition-represent-cohomology-class-on-open}.
Letting $E_1$ be the object corresponding to
complex of quasi-coherent $\mathcal{O}_X$-modules
associated to
$$
\text{Tot}(I^\bullet(f_1^e, \ldots, f_r^e) \otimes_A M^\bullet)
$$
we obtain $E_1 \to E$ using the canonical map
$I^\bullet(f_1^e, \ldots, f_r^e) \to A$ and $E_1 \to E'$
using $\xi$ and
Cohomology, Lemma \ref{cohomology-lemma-section-RHom-over-U}.
\end{proof}

\begin{lemma}
\label{lemma-lift-perfect-complex-plus-shift}
Let $X$ be an affine scheme. Let $U \subset X$ be a quasi-compact open.
For every perfect object $F$ of $D(\mathcal{O}_U)$
the object $F \oplus F[1]$ is the restriction of
a perfect object of $D(\mathcal{O}_X)$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-lift-perfect-complex-plus-locally-free}
we can find a perfect object $E$ of $D(\mathcal{O}_X)$
such that $E|_U = \mathcal{F}[r] \oplus F$ for some finite locally
free $\mathcal{O}_U$-module $\mathcal{F}$.
By Lemma \ref{lemma-lift-map} we can find a morphism of
perfect complexes $\alpha : E_1 \to E$ such that $(E_1)|_U \cong E|_U$
and such that $\alpha|_U$ is the map
$$
\left(
\begin{matrix}
\text{id}_{\mathcal{F}[r]} & 0 \\
0 & 0
\end{matrix}
\right)
:
\mathcal{F}[r] \oplus F \to \mathcal{F}[r] \oplus F
$$
Then the cone on $\alpha$ is a solution.
\end{proof}

\begin{lemma}
\label{lemma-perfect-into-support-on-T}
Let $X$ be a quasi-compact and quasi-separated scheme.
Let $f \in \Gamma(X, \mathcal{O}_X)$.
For any morphism $\alpha : E \to E'$ in
$D_{\textit{QCoh}}(\mathcal{O}_X)$ such that
\begin{enumerate}
\item $E$ is perfect, and
\item $E'$ is supported on $T = V(f)$
\end{enumerate}
there exists an $n \geq 0$ such that $f^n \alpha  = 0$.
\end{lemma}

\begin{proof}
We have Mayer-Vietoris for morphisms in the derived category, see
Cohomology, Lemma \ref{cohomology-lemma-mayer-vietoris-hom}.
Thus if $X = U \cup V$ and the result of the lemma holds
for $f|_U$, $f|_V$, and $f|_{U \cap V}$, then the result holds for $f$.
Thus it suffices to prove the lemma when $X$ is affine, see
Cohomology of Schemes, Lemma \ref{coherent-lemma-induction-principle}.

\medskip\noindent
Let $X = \Spec(A)$. Then $f \in A$. We will
use the equivalence $D(A) = D_{\textit{QCoh}}(X)$ of
Lemma \ref{lemma-affine-compare-bounded}
without further mention.
Represent $E$ by a finite complex of finite projective $A$-modules
$P^\bullet$. This is possible by Lemma \ref{lemma-perfect-affine}.
Let $t$ be the largest integer such that $P^t$ is nonzero.
The distinguished triangle
$$
P^t[-t] \to P^\bullet \to \sigma_{\leq t - 1}P^\bullet \to P^t[-t + 1]
$$
shows that by induction on the length of the complex $P^\bullet$
we can reduce to the case where $P^\bullet$ has a single nonzero term.
This and the shift functor reduces us to the case where $P^\bullet$
consists of a single finite projective $A$-module $P$ in degree $0$.
Represent $E'$ by a complex $M^\bullet$ of $A$-modules.
Then $\alpha$ corresponds to a map $P \to H^0(M^\bullet)$.
Since the module $H^0(M^\bullet)$ is supported on $V(f)$ by assumption (2)
we see that every element of $H^0(M^\bullet)$ is annihilated by a power
of $f$. Since $P$ is a finite $A$-module the map
$f^n\alpha : P \to H^0(M^\bullet)$ is zero for some $n$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-lift-perfect-complex-plus-shift-support}
Let $X$ be an affine scheme. Let $T \subset X$ be a closed subset
such that $X \setminus T$ is quasi-compact. Let $U \subset X$ be a
quasi-compact open. For every perfect object $F$ of $D(\mathcal{O}_U)$
supported on $T \cap U$ the object $F \oplus F[1]$ is the restriction of
a perfect object $E$ of $D(\mathcal{O}_X)$ supported in $T$.
\end{lemma}

\begin{proof}
Say $T = V(g_1, \ldots, g_s)$. After replacing $g_j$ by a power we
may assume multiplication by $g_j$ is zero on $F$, see
Lemma \ref{lemma-perfect-into-support-on-T}. Choose $E$ as in
Lemma \ref{lemma-lift-perfect-complex-plus-shift}.
Note that $g_j : E \to E$ restricts to zero on $U$.
Choose a distinguished triangle
$$
E \xrightarrow{g_1} E \to C_1 \to E[1]
$$
By Derived Categories, Lemma \ref{derived-lemma-split}
the object $C_1$ restricts to
$F \oplus F[1] \oplus F[1] \oplus F[2]$ on $U$.
Moreover, $g_1 : C_1 \to C_1$ has square zero by
Derived Categories, Lemma \ref{derived-lemma-third-map-square-zero}.
Namely, the diagram
$$
\xymatrix{
E \ar[r] \ar[d]_0 & C_1 \ar[d]_{g_1} \ar[r] & E[1] \ar[d]_0 \\
E \ar[r] & C_1 \ar[r] & E[1]
}
$$
is commutative since the compositions $E \xrightarrow{g_1} E \to C_1$ and
$C_1 \to E[1] \xrightarrow{g_1} E[1]$ are zero. Continuing, setting
$C_{i + 1}$ equal to the cone of the map $g_i : C_i \to C_i$ we obtain
a perfect complex $C_s$ on $X$ supported on $T$
whose restriction to $U$ gives
$$
F \oplus F[1]^{\oplus s} \oplus F[2]^{\oplus {s \choose 2}}
\oplus \ldots \oplus F[s]
$$
Choose a morphisms of perfect complexes $\beta : C' \to C_s$
and $\gamma : C' \to C_s$ as in Lemma \ref{lemma-lift-map}
such that $\beta|_U$ is an isomorphism and such that
$\gamma|_U \circ \beta|_U^{-1}$ is the morphism
$$
F \oplus F[1]^{\oplus s} \oplus F[2]^{\oplus {s \choose 2}}
\oplus \ldots \oplus F[s]
\to
F \oplus F[1]^{\oplus s} \oplus F[2]^{\oplus {s \choose 2}}
\oplus \ldots \oplus F[s]
$$
which is the identity on all summands except for $F$ where it is zero.
By Lemma \ref{lemma-lift-map} we also have
$C' = C_s \otimes^\mathbf{L} I$ for some perfect complex
$I$ on $X$. Hence the nullity of $g_j^2\text{id}_{C_s}$ implies the
same thing for $C'$. Thus $C'$ is supported on $T$ as well.
Then $\text{Cone}(\gamma)$ is a solution.
\end{proof}







\section{Approximation by perfect complexes}
\label{section-approximation}

\noindent
In this section we discuss the observation, due to Neeman and Lipman,
that a pseudo-coherent complex can be ``approximated'' by perfect complexes.

\begin{definition}
\label{definition-approximation-holds}
Let $X$ be a scheme. Consider triples $(T, E, m)$ where
\begin{enumerate}
\item $T \subset X$ is a closed subset,
\item $E$ is an object of $D_{\textit{QCoh}}(\mathcal{O}_X)$, and
\item $m \in \mathbf{Z}$.
\end{enumerate}
We say {\it approximation holds for the triple} $(T, E, m)$ if
there exists a perfect object $P$ of $D(\mathcal{O}_X)$ supported on $T$
and a map $\alpha : P \to E$ which induces isomorphisms $H^i(P) \to H^i(E)$
for $i > m$ and a surjection $H^m(P) \to H^m(E)$.
\end{definition}

\noindent
Approximation cannot hold for every triple. Namely, it is clear that if
approximation holds for the triple $(T, E, m)$, then
\begin{enumerate}
\item $E$ is $m$-pseudo-coherent, see
Cohomology, Definition \ref{cohomology-definition-pseudo-coherent}, and
\item the cohomology sheaves $H^i(E)$ are supported on $T$ for $i \geq m$.
\end{enumerate}
Moreover, the ``support'' of a perfect complex is a closed subscheme
whose complement is retrocompact in $X$ (details omitted). Hence we cannot
expect approximation to hold without this assumption on $T$.
This partly explains the conditions in the following definition.

\begin{definition}
\label{definition-approximation}
Let $X$ be a scheme. We say {\it approximation by perfect complexes holds}
on $X$ if for any closed subset $T \subset X$ with $X \setminus T$
retro-compact in $X$ there exists an integer $r$ such that
for every triple $(T, E, m)$ as in
Definition \ref{definition-approximation-holds} with
\begin{enumerate}
\item $E$ is $(m - r)$-pseudo-coherent, and
\item $H^i(E)$ is supported on $T$ for $i \geq m - r$
\end{enumerate}
approximation holds.
\end{definition}

\noindent
We will prove that approximation by perfect complexes holds for
quasi-compact and quasi-separated schemes. It seems that the second
condition is necessary for our method of proof. It is possible that the
first condition may be weakened to ``$E$ is $m$-pseudo-coherent''
by carefully analyzing the arguments below.

\begin{lemma}
\label{lemma-open}
Let $X$ be a scheme. Let $U \subset X$ be an open subscheme.
Let $(T, E, m)$ be a triple as in
Definition \ref{definition-approximation-holds}.
If
\begin{enumerate}
\item $T \subset U$,
\item approximation holds for $(T, E|_U, m)$, and
\item the sheaves $H^i(E)$ for $i \geq m$ are supported on $T$,
\end{enumerate}
then approximation holds for $(T, E, m)$.
\end{lemma}

\begin{proof}
Let $j : U \to X$ be the inclusion morphism.
If $P \to E|_U$ is an approximation of the triple $(T, E|_U, m)$
over $U$, then $j_!P = Rj_*P \to j_!(E|_U) \to E$ is an approximation
of $(T, E, m)$ over $X$.
See Cohomology, Lemmas \ref{cohomology-lemma-pushforward-restriction} and
\ref{cohomology-lemma-pushforward-perfect}.
\end{proof}

\begin{lemma}
\label{lemma-approximation-affine}
Let $X$ be an affine scheme. Then approximation holds for every
triple $(T, E, m)$ as in Definition \ref{definition-approximation-holds}
such that there exists an integer $r \geq 0$ with
\begin{enumerate}
\item $E$ is $m$-pseudo-coherent,
\item $H^i(E)$ is supported on $T$ for $i \geq m - r + 1$,
\item $X \setminus T$ is the union of $r$ affine opens.
\end{enumerate}
In particular, approximation by perfect complexes holds for affine schemes.
\end{lemma}

\begin{proof}
Say $X = \Spec(A)$. Write $T = V(f_1, \ldots, f_r)$.
(The case $r = 0$, i.e., $T = X$ follows immediately from
Lemma \ref{lemma-pseudo-coherent-affine} and the definitions.)
Let $(T, E, m)$ be a triple as in the lemma.
Let $t$ be the largest integer such that $H^t(E)$ is nonzero.
We will proceed by induction on $t$. The base case is $t < m$; in
this case the result is trivial. Now suppose that $t \geq m$. By
Cohomology, Lemma \ref{cohomology-lemma-finite-cohomology}
the sheaf $H^t(E)$ is of finite type. Since it is quasi-coherent
it is generated by finitely many sections
(Properties, Lemma \ref{properties-lemma-finite-type-module}).
For every $s \in \Gamma(X, H^t(E)) = H^t(X, E)$
(see proof of Lemma \ref{lemma-affine-compare-bounded})
we can find an $e > 0$ and a morphism $K_e[-t] \to E$
such that $s$ is in the image of
$H^0(K_e) = H^t(K_e[-t]) \to H^t(E)$, see
Lemma \ref{lemma-represent-cohomology-class-on-closed}.
Taking a finite direct sum of these maps we obtain a map
$P \to E$ where $P$ is a perfect complex supported on $T$,
where $H^i(P) = 0$ for $i > t$, and where $H^t(P) \to E$ is
surjective. Choose a distinguished triangle
$$
P \to E \to E' \to P[1]
$$
Then $E'$ is $m$-pseudo-coherent
(Cohomology, Lemma \ref{cohomology-lemma-cone-pseudo-coherent}),
$H^i(E') = 0$ for $i \geq t$, and
$H^i(E')$ is supported on $T$ for $i \geq m - r + 1$.
By induction we find an approximation $P' \to E'$
of $(T, E', m)$. Fit the composition $P' \to E' \to P[1]$
into a distringuished triangle $P \to P'' \to P' \to P[1]$
and extend the morphisms $P' \to E'$ and $P[1] \to P[1]$ into
a morphism of distinguished triangles
$$
\xymatrix{
P \ar[r] \ar[d] & P'' \ar[d] \ar[r] & P' \ar[d] \ar[r] & P[1] \ar[d] \\
P \ar[r] &  E \ar[r] & E' \ar[r] & P[1]
}
$$
using TR3. Then $P''$ is a perfect complex
(Cohomology, Lemma \ref{cohomology-lemma-two-out-of-three-perfect})
supported on $T$.
An easy diagram chase shows that $P'' \to E$ is the desired
approximation.
\end{proof}

\begin{lemma}
\label{lemma-induction-step}
Let $X$ be a scheme. Let $X = U \cup V$ be an open covering
with $U$ quasi-compact, $V$ affine, and $U \cap V$ quasi-compact.
If approximation by perfect complexes holds on $U$,
then approximation holds on $X$.
\end{lemma}

\begin{proof}
Let $T \subset X$ be a closed subset with $X \setminus T$ retro-compact
in $X$. Let $r_U$ be the integer of Definition \ref{definition-approximation}
adapted to the pair $(U, T \cap U)$.
Set $T' = T \setminus U$. Note that
$T' \subset V$ and that $V \setminus T' = (X \setminus T) \cap U \cap V$
is quasi-compact by our assumption on $T$.
Let $r'$ be the number of affines needed to cover $V \setminus T'$.
We claim that $r = \max(r_U, r')$ works for the pair $(X, T)$.

\medskip\noindent
To see this choose a triple $(T, E, m)$ such that $E$ is
$(m - r)$-pseudo-coherent and $H^i(E)$ is supported on $T$ for
$i \geq m - r$. Let $t$ be the largest integer such that
$H^t(E)|_U$ is nonzero. (Such an integer exists as $U$ is quasi-compact
and $E|_U$ is $(m - r)$-pseudo-coherent.)
We will prove that $E$ can be approximated by induction on $t$.

\medskip\noindent
Base case: $t \leq m - r'$. This means that $H^i(E)$ is supported
on $T'$ for $i \geq m - r'$. Hence
Lemma \ref{lemma-approximation-affine}
guarantees the existence of an approximation
$P \to E|_V$ of $(T', E|_V, m)$ on $V$.
Applying Lemma \ref{lemma-open} we see that
$(T', E, m)$ can be approximated. Such an approximation
is also an approximation of $(T, E, m)$.

\medskip\noindent
Induction step. Choose an approximation $P \to E|_U$
of $(T \cap U, E|_U, m)$. This in particular gives a surjection
$H^t(P) \to H^t(E|_U)$. By
Lemma \ref{lemma-lift-perfect-complex-plus-shift-support}
we can choose a perfect object $Q$ in $D(\mathcal{O}_V)$
supported on $T \cap V$ and an isomorphism
$Q|_{U \cap V} \to (P \oplus P[1])|_{U \cap V}$.
By Lemma \ref{lemma-lift-map} we can replace $Q$ by
$Q \otimes^\mathbf{L} I$
and assume that the map
$$
Q|_{U \cap V} \to (P \oplus P[1])|_{U \cap V}
\longrightarrow P|_{U \cap V}
\longrightarrow
E|_{U \cap V}
$$
lifts to $Q \to E|_V$. By
Cohomology, Lemma \ref{cohomology-lemma-glue}
we find an morphism $a : R \to E$ of $D(\mathcal{O}_X)$
such that $a|_U$ is isomorphic to $P \oplus P[1] \to E|_U$
and $a|_V$ isomorphic to $Q \to E|_V$.
Thus $R$ is perfect and supported on $T$
and the map $H^t(R) \to H^t(E)$ is surjective on restriction to $U$.
Choose a distinguised triangle
$$
R \to E \to E' \to R[1]
$$
Then $E'$ is $(m - r)$-pseudo-coherent
(Cohomology, Lemma \ref{cohomology-lemma-cone-pseudo-coherent}),
$H^i(E')|_U = 0$ for $i \geq t$, and
$H^i(E')$ is supported on $T$ for $i \geq m - r$.
By induction we find an approximation $R' \to E'$
of $(T, E', m)$. Fit the composition $R' \to E' \to R[1]$
into a distringuished triangle $R \to R'' \to R' \to R[1]$
and extend the morphisms $R' \to E'$ and $R[1] \to R[1]$ into
a morphism of distinguished triangles
$$
\xymatrix{
R \ar[r] \ar[d] & R'' \ar[d] \ar[r] & R' \ar[d] \ar[r] & R[1] \ar[d] \\
R \ar[r] &  E \ar[r] & E' \ar[r] & R[1]
}
$$
using TR3. Then $R''$ is a perfect complex
(Cohomology, Lemma \ref{cohomology-lemma-two-out-of-three-perfect})
supported on $T$.
An easy diagram chase shows that $R'' \to E$ is the desired
approximation.
\end{proof}

\begin{theorem}
\label{theorem-approximation}
Let $X$ be a quasi-compact and quasi-separated scheme.
Then approximation by perfect complexes holds on $X$.
\end{theorem}

\begin{proof}
This follows from the induction principle of
Cohomology of Schemes, Lemma \ref{coherent-lemma-induction-principle}
and Lemmas \ref{lemma-induction-step} and \ref{lemma-approximation-affine}.
\end{proof}






\section{Cohomology and base change, IV}
\label{section-cohomology-and-base-change-perfect}

\noindent
This section continues the discussion of
Cohomology of Schemes, Section
\ref{coherent-section-cohomology-and-base-change-perfect}.

\begin{lemma}
\label{lemma-cohomology-base-change}
Let $f : X \to Y$ be a quasi-compact and quasi-separated morphism
of schemes. For $E$ in $D_{\textit{QCoh}}(\mathcal{O}_X)$ and
$K$ in $D^-_{\textit{QCoh}}(\mathcal{O}_Y)$ we have
$$
Rf_*(E) \otimes_{\mathcal{O}_Y}^\mathbf{L} K =
Rf_*(E \otimes_{\mathcal{O}_X}^\mathbf{L} Lf^*K)
$$
\end{lemma}

\begin{proof}
Without any assumptions there is a map
$Rf_*(E) \otimes_{\mathcal{O}_Y}^\mathbf{L} K \to
Rf_*(E \otimes_{\mathcal{O}_X}^\mathbf{L} Lf^*K)$.
Namely, it is the adjoint to the canonical map
$$
Lf^*(Rf_*(E) \otimes_{\mathcal{O}_Y}^\mathbf{L} K) =
Lf^*(Rf_*(E)) \otimes_{\mathcal{O}_X}^\mathbf{L} Lf^*K
\longrightarrow
E \otimes_{\mathcal{O}_X}^\mathbf{L} Lf^*K
$$
coming from the map $Lf^*Rf_*E \to E$. See
Cohomology, Lemmas \ref{cohomology-lemma-pullback-tensor-product} and
\ref{cohomology-lemma-adjoint}.
To check it is an isomorphism we may work locally on $Y$.
Hence we reduce to the case that $Y$ is affine.

\medskip\noindent
Assume $Y$ affine. In this case we may represent $K$ by a bounded
above complex $\mathcal{K}^\bullet$ of free $\mathcal{O}_Y$-modules
(use Lemma \ref{lemma-affine-compare-bounded}). Denote $K_n$ the object
of $D(\mathcal{O}_Y)$ corresponding to $\sigma_{\geq n}\mathcal{K}^\bullet$.
There is a distinguished triangle
$$
\bigoplus\nolimits_{n \geq 1} K_n \to
\bigoplus\nolimits_{n \geq 1} K_n \to
K \to
\left(\bigoplus\nolimits_{n \geq 1} K_n\right)[1]
$$
in $D(\mathcal{O}_Y)$ as there is a corresponding short exact sequence
of complexes of modules. Thus it suffices to prove the map
is an isomorphism for $\bigoplus K_n$. By
Lemma \ref{lemma-quasi-coherence-pushforward-direct-sums}
it suffices to prove the map is an isomorphism for each $K_n$.
(Here we use that $E$ has quasi-coherent cohomology sheaves;
the functors $Lf^*$ and $\otimes^\mathbf{L}$ commute
with direct sums by construction.)
Note that each $K_n$ can be represented by a finite length complex
of free $\mathcal{O}_Y$-modules. We can argue by induction
on the length of the complex and reduce to the case where
$K = \bigoplus_{i \in I} \mathcal{O}_Y$ for some set $I$
(some details omitted). In this case we have to prove that
$$
\bigoplus\nolimits_{i \in I} Rf_*E
\longrightarrow
Rf_*(\bigoplus\nolimits_{i \in I} E)
$$
is an isomorphism which follows once again from
Lemma \ref{lemma-quasi-coherence-pushforward-direct-sums}.
\end{proof}

\begin{definition}
\label{definition-tor-independent}
Let $S$ be a scheme. Let $X$, $Y$ be schemes over $S$. We say $X$ and
$Y$ are {\it Tor independent over $S$} if for every $x \in X$ and
$y \in Y$ mapping to the same point $s \in S$ the rings
$\mathcal{O}_{X, x}$ and $\mathcal{O}_{Y, y}$ are Tor independent
over $\mathcal{O}_{S, s}$ (see
More on Algebra, Definition \ref{more-algebra-definition-tor-independent}).
\end{definition}

\begin{lemma}
\label{lemma-compare-base-change}
Let $g : S' \to S$ be a morphism of schemes.
Let $f : X \to S$ be quasi-compact and quasi-separated.
Consider the base change diagram
$$
\xymatrix{
X' \ar[r]_h \ar[d]_{f'} &
X \ar[d]^f \\
S' \ar[r]^g &
S
}
$$
If $X$ and $S'$ are Tor independent over $S$, then for all
$E \in D_{\textit{QCoh}}(\mathcal{O}_X)$ we have
$Rf'_*Lh^*E = Lg^*Rf_*E$.
\end{lemma}

\begin{proof}
For any object $E$ of $D(\mathcal{O}_X)$ we can use
Cohomology, Remark \ref{cohomology-remark-base-change} to get a
canonical base change map $Lg^*Rf_*E \to Rf'_*Lh^*E$. To check this
is an isomorphism we may work locally on $S'$. Hence we may assume
$g : S' \to S$ is a morphism of affine schemes. In particular, $g$
is affine and it suffices to show that
$$
Rg_*Lg^*Rf_*E \to Rg_*Rf'_*Lh^*E = Rf_*(Rh_* Lh^* E)
$$
is an isomorphism, see Lemma \ref{lemma-affine-morphism}
(and use Lemmas \ref{lemma-quasi-coherence-pullback},
\ref{lemma-quasi-coherence-tensor-product}, and
\ref{lemma-quasi-coherence-direct-image}
to see that the objects $Rf'_*Lh^*E$ and $Lg^*Rf_*E$
have quasi-coherent cohomology sheaves). Note that $h$ is
affine as well (Morphisms, Lemma \ref{morphisms-lemma-base-change-affine}).
By Lemma \ref{lemma-affine-morphism-pull-push} the map becomes a map
$$
Rf_*E \otimes_{\mathcal{O}_S}^\mathbf{L} g_*\mathcal{O}_{S'}
\longrightarrow
Rf_*(E \otimes_{\mathcal{O}_X}^\mathbf{L} h_*\mathcal{O}_{X'})
$$
Observe that $h_*\mathcal{O}_{X'} = f^*g_*\mathcal{O}_{S'}$. Thus by
Lemma \ref{lemma-cohomology-base-change} it suffices to prove that
$Lf^*g_*\mathcal{O}_{S'} = f^*g_*\mathcal{O}_{S'}$. This follows from our
assumption that $X$ and $S'$ are Tor independent over $S$. Namely, to
check it we may work locally on $X$, hence we may also assume $X$ is affine.
Say $X = \Spec(A)$, $S = \Spec(R)$ and $S' = \Spec(R')$. Our assumption
implies that $A$ and $R'$ are Tor independent over $R$
(More on Algebra, Lemma \ref{more-algebra-lemma-tor-independent}), i.e.,
$\text{Tor}_i^R(A, R') = 0$ for $i > 0$. In other words
$A \otimes_R^\mathbf{L} R' = A \otimes_R R'$ which exactly means
that $Lf^*g_*\mathcal{O}_{S'} = f^*g_*\mathcal{O}_{S'}$
(use Lemma \ref{lemma-quasi-coherence-pullback}).
\end{proof}

\begin{lemma}
\label{lemma-perfect-direct-image}
Let $S$ be a Noetherian scheme. Let $f : X \to S$ be a morphism of schemes
which is locally of finite type. Let $E \in D(\mathcal{O}_X)$ such that
\begin{enumerate}
\item $E \in D^b_{\textit{Coh}}(\mathcal{O}_X)$,
\item the scheme theoretic support of $H^i(E)$ is proper over $S$ for all $i$,
\item $E$ has finite tor dimension as an object of $D(f^{-1}\mathcal{O}_S)$.
\end{enumerate}
Then $Rf_*E$ is a perfect object of $D(\mathcal{O}_S)$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-direct-image-coherent} we see that $Rf_*E$ is an object of
$D^b_{\textit{Coh}}(\mathcal{O}_S)$. Hence $Rf_*E$ is pseudo-coherent
(Lemma \ref{lemma-identify-pseudo-coherent-noetherian}).
Hence it suffices to show that $Rf_*E$ has finite tor dimension, see
Cohomology, Lemma \ref{cohomology-lemma-perfect}.
By Lemma \ref{lemma-tor-qc-qs} it suffices to check that
$Rf_*(E) \otimes_{\mathcal{O}_S}^\mathbf{L} \mathcal{F}$
has universally bounded cohomology for all quasi-coherent
sheaves $\mathcal{F}$ on $S$. Bounded from above is clear as $Rf_*(E)$
is bounded from above. Let $T \subset X$ be the union of the supports
of $H^i(E)$ for all $i$. Then $T$ is proper over $S$ by assumptions (1)
and (2). In particular there exists a quasi-compact open
$X' \subset X$ containing $T$. Setting $f' = f|_{X'}$ we have
$Rf_*(E) = Rf'_*(E|_{X'})$ because $E$ restricts to zero on $X \setminus T$.
Thus we may replace $X$ by $X'$ and assume $f$ is quasi-compact.
Moreover, $f$ is quasi-separated by Morphisms, Lemma
\ref{morphisms-lemma-finite-type-Noetherian-quasi-separated}. Now
$$
Rf_*(E) \otimes_{\mathcal{O}_S}^\mathbf{L} \mathcal{F} =
Rf_*\left(E \otimes_{\mathcal{O}_X}^\mathbf{L} Lf^*\mathcal{F}\right) =
Rf_*\left(E \otimes_{f^{-1}\mathcal{O}_S}^\mathbf{L} f^{-1}\mathcal{F}\right)
$$
by
Lemma \ref{lemma-cohomology-base-change}
and
Cohomology, Lemma \ref{cohomology-lemma-variant-derived-pullback}.
By assumption (3) the complex
$E \otimes_{f^{-1}\mathcal{O}_S}^\mathbf{L} f^{-1}\mathcal{F}$
has cohomology sheaves in a
given finite range, say $[a, b]$. Then $Rf_*$ of it
has cohomology in the range $[a, \infty)$ and we win.
\end{proof}



\section{Computing Ext groups and base change}
\label{section-ext}

\noindent
The results in this section will be used to verify one of Artin's criteria
for Quot functors, Hilbert schemes, and other moduli problems.

\begin{lemma}
\label{lemma-compute-ext-perfect}
Let $S$ be a Noetherian scheme. Let $f : X \to S$ be a morphism of schemes
which is locally of finite type. Let $E \in D(\mathcal{O}_X)$
and $\mathcal{G}$ an $\mathcal{O}_X$-module. Assume
\begin{enumerate}
\item $E$ is perfect, and
\item $\mathcal{G}$ is a coherent $\mathcal{O}_X$-module flat over $S$
with scheme theoretic support proper over $S$.
\end{enumerate}
Then there exists a perfect object $K$
of $D(\mathcal{O}_S)$ and functorial isomorphisms
$$
H^i(S, K \otimes^\mathbf{L}_{\mathcal{O}_S} \mathcal{F})
\longrightarrow
\text{Ext}^i_{\mathcal{O}_X}(E,
\mathcal{G} \otimes_{\mathcal{O}_X} f^*\mathcal{F})
$$
for $\mathcal{F}$ quasi-coherent on $S$
compatible with boundary maps (see proof).
\end{lemma}

\begin{proof}
Since $E$ is a perfect complex there exists a dual perfect complex
$E'$, see
Cohomology, Lemma \ref{cohomology-lemma-dual-perfect-complex}.
Observe that
$$
\text{Ext}^i_{\mathcal{O}_X}(E,
\mathcal{G} \otimes_{\mathcal{O}_X} f^*\mathcal{F})
=
H^i(X, E' \otimes^\mathbf{L}_{\mathcal{O}_X}
(\mathcal{G} \otimes_{\mathcal{O}_X} f^*\mathcal{F}))
$$
by construction of $E'$. We have
$$
\mathcal{G} \otimes_{\mathcal{O}_X}^\mathbf{L} Lf^*\mathcal{F} =
\mathcal{G} \otimes_{f^{-1}\mathcal{O}_S}^\mathbf{L} f^{-1}\mathcal{F} =
\mathcal{G} \otimes_{f^{-1}\mathcal{O}_S} f^{-1}\mathcal{F} =
\mathcal{G} \otimes_{\mathcal{O}_X} f^*\mathcal{F}
$$
the first equality by
Cohomology, Lemma \ref{cohomology-lemma-variant-derived-pullback},
the second as $\mathcal{G}$ is a flat $f^{-1}\mathcal{O}_S$-module, and
the third by definition of pullbacks. Hence we obtain
\begin{align*}
H^i(X, E' \otimes^\mathbf{L}_{\mathcal{O}_X}
(\mathcal{G} \otimes_{\mathcal{O}_X} f^*\mathcal{F}))
& =
H^i(X, E' \otimes^\mathbf{L}_{\mathcal{O}_X} \mathcal{G}
\otimes_{\mathcal{O}_X}^\mathbf{L} Lf^*\mathcal{F}) \\
& =
H^i(S,
Rf_*(E' \otimes^\mathbf{L}_{\mathcal{O}_X} \mathcal{G}
\otimes^\mathbf{L}_{\mathcal{O}_X} Lf^*\mathcal{F})) \\
& =
H^i(S,
Rf_*(E' \otimes^\mathbf{L}_{\mathcal{O}_X} \mathcal{G})
\otimes^\mathbf{L}_{\mathcal{O}_S} \mathcal{F})
\end{align*}
The first equality by the above, the second by Leray
(Cohomology, Lemma \ref{cohomology-lemma-before-Leray}), and
the third equality by Lemma \ref{lemma-cohomology-base-change}.
Finally, the object
$K = Rf_*(E' \otimes^\mathbf{L}_{\mathcal{O}_X} \mathcal{G})$
is perfect by Lemma \ref{lemma-perfect-direct-image}.
(The lemma applies: the hypotheses on the cohomology sheaves
$H^i(E' \otimes^\mathbf{L}_{\mathcal{O}_X} \mathcal{G})$
are clear and the hypothesis on finite tor dimension follows as $\mathcal{G}$
is flat over $f^{-1}\mathcal{O}_S$ and locally $E'$ is isomorphic
to a finite complex of free $\mathcal{O}_X$-modules.)

\medskip\noindent
The statement on boundary maps means the following: Given a short
exact sequence $0 \to \mathcal{F}_1 \to \mathcal{F}_2 \to \mathcal{F}_3 \to 0$
then the isomorphisms fit into commutative diagrams
$$
\xymatrix{
H^i(S, K \otimes^\mathbf{L}_{\mathcal{O}_S} \mathcal{F}_3)
\ar[r] \ar[d]_\delta &
\text{Ext}^i_{\mathcal{O}_X}(E,
\mathcal{G} \otimes_{\mathcal{O}_X} f^*\mathcal{F}_3) \ar[d]^\delta \\
H^{i + 1}(S, K \otimes^\mathbf{L}_{\mathcal{O}_S} \mathcal{F}_1)
\ar[r] &
\text{Ext}^{i + 1}_{\mathcal{O}_X}(E,
\mathcal{G} \otimes_{\mathcal{O}_X} f^*\mathcal{F}_1)
}
$$
where the boundary maps come from the distinguished triangle
$$
K \otimes^\mathbf{L}_{\mathcal{O}_S} \mathcal{F}_1 \to
K \otimes^\mathbf{L}_{\mathcal{O}_S} \mathcal{F}_2 \to
K \otimes^\mathbf{L}_{\mathcal{O}_S} \mathcal{F}_3 \to
K \otimes^\mathbf{L}_{\mathcal{O}_S} \mathcal{F}_1[1]
$$
and the distinguished triangle in $D(\mathcal{O}_X)$ associated to
the short exact sequence
$$
0 \to
\mathcal{G} \otimes_{\mathcal{O}_X} f^*\mathcal{F}_1 \to
\mathcal{G} \otimes_{\mathcal{O}_X} f^*\mathcal{F}_2 \to
\mathcal{G} \otimes_{\mathcal{O}_X} f^*\mathcal{F}_3 \to 0
$$
This sequence is exact because $\mathcal{G}$ is flat over $S$.
We omit the verification of the commutativity of the displayed diagram.
\end{proof}

\begin{lemma}
\label{lemma-base-change-RHom}
Let $f : X \to S$ be a quasi-compact and quasi-separated morphism of
schemes. Let $E \in D(\mathcal{O}_X)$ be pseudo-coherent.
Let $\mathcal{G}$ be a quasi-coherent $\mathcal{O}_X$-module
flat over $S$. Then formation of
$$
Rf_*R\SheafHom(E, \mathcal{G})
$$
commutes with arbitrary base change (see proof for precise statement).
\end{lemma}

\begin{proof}
The statement means the following. Let $g : S' \to S$ be a morphism of
schemes and consider the base change diagram
$$
\xymatrix{
X' \ar[r]_h \ar[d]_{f'} &
X \ar[d]^f \\
S' \ar[r]^g &
S
}
$$
in other words $X' = S' \times_S X$. Set $E' = Lh^*E$ and
$\mathcal{G}' = h^*\mathcal{G}$ (here we do {\bf not} use the derived
pullback). The lemma asserts that we have
$$
Lg^*Rf_*R\SheafHom(E, \mathcal{G}) = Rf'_*R\SheafHom(E', \mathcal{G}')
$$
To prove this, note that in
Cohomology, Remark \ref{cohomology-remark-fancy-base-change}
we have constructed an arrow
$$
Lg^*Rf_*R\SheafHom(E, \mathcal{G})
\longrightarrow
R(f')_*R\SheafHom(Lh^*E, Lh^*\mathcal{G})
$$
which we can compose with the map $Lh^*\mathcal{G} \to h^*\mathcal{G}$
to get a canonical map
$$
Lg^*Rf_*R\SheafHom(E, \mathcal{G}) \to Rf'_*R\SheafHom(E', \mathcal{G}')
$$
To check this map is an isomorphism we may work locally on $S'$.
Hence we may assume $g : S' \to S$ is a morphism of affine schemes.
In this case, we will use the induction principle to prove this map
is always an isomorphism for any quasi-compact and quasi-separated $X$
over $S$
(Cohomology of Schemes, Lemma \ref{coherent-lemma-induction-principle}).

\medskip\noindent
If $X$ is affine, then we can represent $E$ by a bounded above complex
$\mathcal{E}^\bullet$ of finite
free $\mathcal{O}_X$-modules (Lemma \ref{lemma-lift-pseudo-coherent}).
By Cohomology, Lemma
\ref{cohomology-lemma-Rhom-complex-of-direct-summands-finite-free}
we see that $R\SheafHom(E, \mathcal{G})$ is represented by the complex
with terms $\SheafHom_{\mathcal{O}_X}(\mathcal{E}^p, \mathcal{G})$.
Similarly, $R\SheafHom(E', \mathcal{G}')$ is computed
by the complex with terms
$\SheafHom_{\mathcal{O}_{X'}}(h^*\mathcal{E}^p, h^*\mathcal{G})$.
Since $f$ and $f'$ are affine, the values of $Rf_*$ and $Rf'_*$
on complexes of quasi-coherent modules are computed by applying
$f_*$ and $f'_*$ to the given complex (Lemma \ref{lemma-affine-pushforward}).
Moreover, as $\mathcal{G}$ is flat over $S$ and $f$ is affine we see that
$f_*\SheafHom_{\mathcal{O}_X}(\mathcal{E}^p, \mathcal{G})$
is a flat $\mathcal{O}_S$-module. Thus
$Lg^*f_*\SheafHom_{\mathcal{O}_X}(\mathcal{E}^\bullet, \mathcal{G})$
is equal to
$g^*f_*\SheafHom_{\mathcal{O}_X}(\mathcal{E}^\bullet, \mathcal{G})$.
Hence in the affine case we have to check that the canonical map
$$
g^*f_*\SheafHom_{\mathcal{O}_X}(\mathcal{E}, \mathcal{G})
\longrightarrow
f'_*\SheafHom_{\mathcal{O}_{X'}}(h^*\mathcal{E}, h^*\mathcal{G})
$$
is an isomorphism for any finite free $\mathcal{O}_X$-module $\mathcal{E}$.
This reduces to the case $\mathcal{E} = \mathcal{O}_X$. In this case
we are saying that $g^*f_*\mathcal{G} = f'_*h^*\mathcal{G}$ which
is Cohomology of Schemes, Lemma \ref{coherent-lemma-affine-base-change}.

\medskip\noindent
The induction step. Suppose that $X = U \cup V$ is an open covering
with $U$, $V$, $U \cap V$
quasi-compact such that the result holds for the restriction of $E$ and
$\mathcal{G}$ to $U$, $V$, and $U \cap V$. Denote $a = f|_U$,
$b = f|_V$ and $c = f|_{U \cap V}$. Let $a' : U' \to S'$, $b' : V' \to S'$
and $c' : U' \cap V' \to S'$ be the base changes of $a$, $b$, and $c$.
Note that formation of $R\SheafHom$ commutes with restriction to opens
(Cohomology, Lemma \ref{cohomology-lemma-restriction-RHom-to-U}).
Set $H = R\SheafHom(E, \mathcal{G})$ and $H' = R\SheafHom(E', \mathcal{G}')$.
Using the distinguished triangles from relative Mayer-Vietoris
(Cohomology, Lemma \ref{cohomology-lemma-unbounded-relative-mayer-vietoris})
we obtain a commutative diagram
$$
\xymatrix{
Lg^*Rf_* H \ar[r] \ar[d] &
Rf'_* H' \ar[d] \\
Lg^*Ra_* H|_U \oplus
Lg^*Rb_* H|_V \ar[r] \ar[d] &
Ra'_* H'|_{U'} \oplus
Rb'_* H'|_{V'} \ar[d] \\
Lg^*Rc_* H|_{U \cap V} \ar[r] \ar[d] &
Rc'_* H'|_{U' \cap V'} \ar[d] \\
Lg^*Rf_* H[1] \ar[r] &
Rf'_* H'[1]
}
$$
Since the 2nd and 3rd horizontal arrows are isomorphisms so is the first
(Derived Categories, Lemma \ref{derived-lemma-third-isomorphism-triangle})
and the proof of the lemma is finished.
\end{proof}

\begin{lemma}
\label{lemma-compute-ext}
Let $S$ be a Noetherian scheme. Let $f : X \to S$ be a morphism of schemes
which is locally of finite type. Let $E \in D(\mathcal{O}_X)$
and $\mathcal{G}$ an $\mathcal{O}_X$-module. Assume
\begin{enumerate}
\item $E \in D^-_{\textit{Coh}}(\mathcal{O}_X)$, and
\item $\mathcal{G}$ is a coherent $\mathcal{O}_X$-module flat over $S$
with scheme theoretic support is proper over $S$.
\end{enumerate}
Then for every $m \in \mathbf{Z}$ there exists a perfect object $K$
of $D(\mathcal{O}_S)$ and functorial maps
$$
\alpha^i_\mathcal{F} :
\text{Ext}^i_{\mathcal{O}_X}(E,
\mathcal{G} \otimes_{\mathcal{O}_X} f^*\mathcal{F})
\longrightarrow
H^i(S, K \otimes^\mathbf{L}_{\mathcal{O}_S} \mathcal{F})
$$
for $\mathcal{F}$ quasi-coherent on $S$
compatible with boundary maps (see proof)
such that $\alpha^i_\mathcal{F}$ is an isomorphism for $i \leq m$.
\end{lemma}

\begin{proof}
We may replace $X$ by a quasi-compact open neighbourhood of
the support of $\mathcal{G}$, hence we may assume $X$ is Noetherian.
In this case $X$ and $f$ are quasi-compact and quasi-separated.
Choose an approximation $P \to E$ by a perfect complex $P$ of $(X, E, -m - 1)$
(possible by Theorem \ref{theorem-approximation}).
Then the induced map
$$
\text{Ext}^i_{\mathcal{O}_X}(E,
\mathcal{G} \otimes_{\mathcal{O}_X} f^*\mathcal{F})
\longrightarrow
\text{Ext}^i_{\mathcal{O}_X}(P,
\mathcal{G} \otimes_{\mathcal{O}_X} f^*\mathcal{F})
$$
is an isomorphism for $i \leq m$. Namely, the kernel, resp.\ cokernel of this
map is a quotient, resp.\ submodule of
$$
\text{Ext}^i_{\mathcal{O}_X}(C,
\mathcal{G} \otimes_{\mathcal{O}_X} f^*\mathcal{F})
\quad\text{resp.}\quad
\text{Ext}^{i + 1}_{\mathcal{O}_X}(C,
\mathcal{G} \otimes_{\mathcal{O}_X} f^*\mathcal{F})
$$
where $C$ is the cone of $P \to E$. Since $C$ has vanishing cohomology
sheaves in degrees $\geq -m - 1$ these $\text{Ext}$-groups are zero
for $i \leq m + 1$ by
Derived Categories, Lemma \ref{derived-lemma-negative-exts}.
This reduces us to the case that
$E$ is a perfect complex which is Lemma \ref{lemma-compute-ext-perfect}.

\medskip\noindent
The statement on boundaries is explained in the proof of
Lemma \ref{lemma-compute-ext-perfect}.
\end{proof}






















\input{chapters}

\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}

