\input{preamble}

% OK, start here.
%
\begin{document}

\title{Smoothing Ring Maps}


\maketitle

\phantomsection
\label{section-phantom}

\tableofcontents

\section{Introduction}
\label{section-introduction}

\noindent
The main theorem explained in this chapter is due to
Popescu, see \cite{popescu-letter}, \cite{popescu-GND}, \cite{popescu-GNDA}.
A readable exposition of Popescu's proof was given by Richard Swan,
see \cite{swan} who used notes by Andr\'e and a paper of Ogoma, see
\cite{Ogoma}.
We follow Swan's exposition, except that we try to avoid the elaborate
unwinding of residue field extensions by using
Lemma 7.4 of \cite{popescu-GNDA}.

\medskip\noindent
Here is a definition due to Artin.
Let $A$ be a henselian Noetherian local ring. We say $A$ has the
{\it approximation property} if for any
$f_1, \ldots, f_m \in A[x_1, \ldots, x_n]$
the system of equations
$f_1 = 0, \ldots, f_m = 0$ has a solution in the completion
of $A$ if and only if it has a solution in $A$.

\medskip\noindent
Artin first proved the approximation property for analytic systems of
equations, see \cite{Artin-Analytic-Approximation}.
In \cite{Artin-Algebraic-Approximation} Artin proved the
approximation property for local rings
essentially of finite type over an excellent discrete valuation ring.
Artin conjectured (page 26 of \cite{Artin-Algebraic-Approximation})
that every excellent henselian local ring should have the
approximation property.

\medskip\noindent
In \cite{Artin-power-series} it is shown that
$R \to R^\wedge$ is a filtered colimit of smooth algebras for any
local ring $R$ essentially of finite type over a field.
In this paper Artin conjectured (see also \cite{Artin-Denef})
that every regular homomorphism of Noetherian rings is a
filtered colimit of smooth algebras.
In \cite{Rotthaus-Artin} it is shown that $R \to R^\wedge$
is a filtered colimit of smooth algebras for any local ring $R$
essentially of finite type over an excellent discrete valution ring.

\medskip\noindent
Conversely, using some of the results above, in \cite{Rotthaus-excellent}
it was shown that any local ring with the approximation property is excellent.

\medskip\noindent
In the paper \cite{Spivakovsky} there is an alternative proof of the
main theorem due to Spivakovsky. There is also a Bourbaki lecture about
this material, see \cite{Teissier}.





\section{Regular ring maps}
\label{section-regular}

\noindent
Let $k$ be a field. Recall that a Noetherian $k$-algebra $A$ is
said to be {\it geometrically regular} over $k$ if and only if
$A \otimes_k k'$ is regular for all finite purely inseparable
extensions $k'$ of $k$, see
Algebra, Definition \ref{algebra-definition-geometrically-regular}.
Moreover, if this is the case then $A \otimes_k k'$ is regular
for every finitely generated field extension $k \subset k'$, see
Algebra, Lemma \ref{algebra-lemma-geometrically-regular}.
We use this notion in the following definition.

\begin{definition}
\label{definition-regular}
A ring map $R \to \Lambda$ is {\it regular} if it is flat and
for every prime $\mathfrak p \subset R$ the fibre ring
$$
\Lambda \otimes_R \kappa(\mathfrak p) =
\Lambda_\mathfrak p/\mathfrak p\Lambda_\mathfrak p
$$
is Noetherian and geometrically regular over $\kappa(\mathfrak p)$.
\end{definition}

\noindent
If $R \to \Lambda$ is a ring map with $\Lambda$ Noetherian, then the
fibre rings are always Noetherian.

\begin{lemma}[Regular is a local property]
\label{lemma-regular-local}
Let $R \to \Lambda$ be a ring map with $\Lambda$ Noetherian.
Then $R \to \Lambda$ is regular if and only if the local ring maps
$R_\mathfrak p \to \Lambda_\mathfrak q$ are regular for all
$\mathfrak q \subset \Lambda$ lying over $\mathfrak p \subset R$.
\end{lemma}

\begin{proof}
This is true because a Noetherian ring is regular if and only if
all the local rings are regular local rings, see
Algebra, Definition \ref{definition-regular}
and a ring map is flat if and only if all the induced maps of local
rings are flat, see
Algebra, Lemma \ref{algebra-lemma-flat-localization}.
\end{proof}

\begin{lemma}[Regular maps and base change]
\label{lemma-regular-base-change}
Let $R \to \Lambda$ be a regular ring map.
For any finite type ring map $R \to R'$ the base change
$R' \to \Lambda \otimes_R R'$ is regular too.
\end{lemma}

\begin{proof}
Flatness is preserved under any base change, see
Algebra, Lemma \ref{algebra-lemma-flat-base-change}.
Note that $\Lambda \otimes_R R'$ is a finite type
$\Lambda$-algebra hence Noetherian, see
Algebra, Lemma \ref{algebra-lemma-Noetherian-permanence}.
The regularity of the fibres is preserved by
Algebra, Lemma \ref{algebra-lemma-geometrically-regular}
as the residue fields of $R'$ are finitely generated extensions of
the residue fields of $R$.
\end{proof}

\begin{lemma}
\label{lemma-colimit-smooth-regular}
Let $R$ be a ring. Let $(A_i, \varphi_{ii'})$ be a directed system
of smooth $R$-algebras. Set $\Lambda = \colim A_i$. If the fibre
rings $\Lambda \otimes_R \kappa(\mathfrak p)$ are Noetherian for all
$\mathfrak p \subset R$, then $R \to \Lambda$ is regular.
\end{lemma}

\begin{proof}
Note that $\Lambda$ is flat over $R$ by
Algebra, Lemmas \ref{algebra-lemma-colimit-flat} and
\ref{algebra-lemma-smooth-syntomic}.
Let $\kappa(\mathfrak p) \subset k$ be a finite purely inseparable
extension. Note that
$$
\Lambda \otimes_R \kappa(\mathfrak p) \otimes_{\kappa(\mathfrak p)} k =
\Lambda \otimes_R k = \colim A_i \otimes_R k
$$
is a colimit of smooth $k$-algebras, see
Algebra, Lemma \ref{algebra-lemma-base-change-smooth}.
Since each local ring of a smooth $k$-algebra is regular by
Algebra, Lemma \ref{algebra-lemma-characterize-smooth-over-field}
we conclude that all local rings of $\Lambda \otimes_R k$ are
regular by
Algebra, Lemma \ref{algebra-lemma-colimit-regular}.
This proves the lemma.
\end{proof}

\noindent
Let's see when a field extension defines a regular ring map.

\begin{lemma}
\label{lemma-regular-field-extension}
Let $k \subset K$ be a field extension. Then $k \to K$ is a regular
ring map if and only if $K$ is a separable field extension of $k$.
\end{lemma}

\begin{proof}
If $k \to K$ is regular, then $K$ is geometrically reduced over $k$,
hence $K$ is separable over $k$ by
Algebra, Proposition
\ref{algebra-proposition-characterize-separable-field-extensions}.
Conversely, if $K/k$ is separable, then $K$ is a colimit of smooth
$k$-algebras, see
Algebra, Lemma \ref{algebra-lemma-colimit-syntomic}
hence is regular by
Lemma \ref{lemma-colimit-smooth-regular}.
\end{proof}












\section{Colimits}
\label{section-colimits}

\noindent
In Categories, Section \ref{categories-section-directed-colimits}
we discuss filtered colimits. In particular, note that
Categories, Lemma \ref{categories-lemma-directed-category-system}
tells us that colimits over filtered index categories are the same
thing as colimits over directed partially ordered sets.

\begin{lemma}
\label{lemma-when-colimit}
Let $R \to \Lambda$ be a ring map. Let $\mathcal{E}$ be a set of $R$-algebras
such that each $A \in \mathcal{E}$ is of finite presentation over $R$.
Then the following two statements are equivalent
\begin{enumerate}
\item $\Lambda$ is a filtered colimit of elements of $\mathcal{E}$, and
\item for any $R$ algebra map $A \to \Lambda$ with $A$ of finite
presentation over $R$ we can find a factorization $A \to B \to \Lambda$
with $B \in \mathcal{E}$.
\end{enumerate}
\end{lemma}

\begin{proof}
Suppose that $\mathcal{I} \to \mathcal{E}$, $i \mapsto A_i$
is a diagram such that $\Lambda = \colim_i A_i$. Let $A \to \Lambda$
with $A$ of finite presentation over $R$. Pick a presentation
$A = R[x_1, \ldots, x_n]/(f_1, \ldots, f_m)$. Say $A \to \Lambda$
maps $x_s$ to $\lambda_s \in \Lambda$. We can find an $i \in \Ob(\mathcal{I})$
and elements $a_s \in A_i$ whose image in $\Lambda$ is $\lambda_s$.
Increasing $i$ if necessary we may also assume that
$f_t(a_1, \ldots, a_n) = 0$ in $A_i$. Hence we can factor $A \to \Lambda$
through $A_i$ by mapping $x_s$ to $a_s$.

\medskip\noindent
Conversely, suppose that (2) holds. Consider the category $\mathcal{I}$
whose objects are $R$-algebra maps $A \to \Lambda$ with $A \in \mathcal{E}$
and whose morphisms are commutative diagrams
$$
\xymatrix{
A \ar[rr] \ar[rd] & & A' \ar[ld] \\
& \Lambda
}
$$
of $R$-algebras. We claim that $\mathcal{I}$ is a filtered index category
and that $\Lambda = \colim_\mathcal{I} A$. To see that $\mathcal{I}$
is filtered, let $A \to \Lambda$ and $A' \to \Lambda$ be two objects.
Then we can factor $A \otimes_R A' \to \Lambda$ through an object
of $\mathcal{I}$ by assumption (2) and the fact that the elements
of $\mathcal{E}$ are of finite presentation over $R$. Suppose that
$\varphi, \psi : A \to A'$ are two morphisms of $\mathcal{I}$.
Let $x_1, \ldots, x_n$ be generators of $A$ as an $R$-algebra.
By assumption (2)  we can factor the $R$-algebra map
$A'/(\varphi(x_i) - \psi(x_i)) \to \Lambda$ through an object of
$\mathcal{I}$. This proves that $\mathcal{I}$ is filtered.
We omit the proof that $\Lambda = \colim_\mathcal{I} A$.
\end{proof}


\section{Singular ideals}
\label{section-singular-ideal}

\noindent
Let $R \to A$ be a ring map. The singular ideal of $A$ over $R$
is the radical ideal in $A$ cutting out the singular locus of the
morphism $\Spec(A) \to \Spec(R)$. Here is a formal definition.

\begin{definition}
\label{definition-singular-ideal}
Let $R \to A$ be a ring map. The {\it singular ideal of $A$ over $R$},
denoted $H_{A/R}$ is the unique radical ideal $H_{A/R} \subset A$ with
$$
V(H_{A/R}) = \{\mathfrak q \in \Spec(A) \mid R \to A
\text{ not smooth at }\mathfrak q\}
$$
\end{definition}

\noindent
This makes sense because the set of primes where $R \to A$ is smooth
is open, see
Algebra, Definition \ref{algebra-definition-smooth-at-prime}.
In order to find an explicit set
of generators for the singular ideal we first prove the following lemma.

\begin{lemma}
\label{lemma-find-strictly-standard}
Let $R$ be a ring. Let $A = R[x_1, \ldots, x_n]/(f_1, \ldots, f_m)$.
Let $\mathfrak q \subset A$. Assume $R \to A$ is smooth
at $\mathfrak q$. Then there exists an $a \in A$, $a \not \in \mathfrak q$,
an integer $c$, $0 \leq c \leq \min(n, m)$, subsets
$U \subset \{1, \ldots, n\}$, $V \subset \{1, \ldots, m\}$
of cardinality $c$ such that
$$
a = a' \det(\partial f_j/\partial x_i)_{j \in V, i \in U}
$$
for some $a' \in A$ and
$$
a f_\ell \in (f_j, j \in V) + (f_1, \ldots, f_m)^2
$$
for all $\ell \in \{1, \ldots, m\}$.
\end{lemma}

\begin{proof}
The assumption means that there exists an $a \in A$, $a \not \in \mathfrak p$
such that $R \to A_a$ is standard smooth, see
Algebra, Lemma \ref{algebra-lemma-smooth-syntomic}.
Set $I = (f_1, \ldots, f_m)$ so that the the naive cotangent
complex of $A$ over $R$ is given by $I/I^2 \to \bigoplus A\text{d}x_i$.
After renumbering $x_1, \ldots, x_n$ and $f_1, \ldots, f_m$ we may assume
that $f_1, \ldots, f_c$ form a basis for the vector space
$I/I^2 \otimes_A \kappa(\mathfrak q)$ and that
$\text{d}x_{c + 1}, \ldots, \text{d}x_n$ map to a basis of
$\Omega_{A/R} \otimes_A \kappa(\mathfrak q)$. By
Algebra, Lemmas \ref{algebra-lemma-localize-NL} and
\ref{algebra-lemma-standard-smooth}
we see that $(I/I^2)_a \to \bigoplus A_a\text{d}x_i$ is a split injection
whose cokernel is a free $A_a$-module. Hence after replacing $a$ by $aa'$ for
some $a' \in A$, $a' \not \in \mathfrak q$ we may assume
$f_1, \ldots, f_c$ form a basis for $(I/I^2)_a$ and that
$\text{d}x_{c + 1}, \ldots, \text{d}x_n$ map to a basis of
$(\Omega_{A/R})_a$. In this situation $a^N$ for some large integer
$N$ satisfies the conditions of the
lemma (with $U = V = \{1, \ldots, c\}$).
\end{proof}

\noindent
Lemma \ref{lemma-find-strictly-standard}
is the motivation for the following definition.

\begin{definition}
\label{definition-strictly-standard}
Let $R \to A$ be a ring map of finite presentation.
We say $a \in A$ is {\it strictly standard in $A$ over $R$}
if there exists a presentation
$$
A = R[x_1, \ldots, x_n]/(f_1, \ldots, f_m)
$$
and $0 \leq c \leq \min(n, m)$ such that
\begin{equation}
\label{equation-standard-one}
a = a' \det(\partial f_j/\partial x_i)_{j = 1, \ldots, c, \ i = 1, \ldots, c}
\end{equation}
for some $a' \in A$ and
\begin{equation}
\label{equation-standard-two}
a f_{c + j} \in (f_1, \ldots, f_c) + (f_1, \ldots, f_m)^2
\end{equation}
for $j = 1, \ldots, m - c$.
\end{definition}

\noindent
The following lemma says in particular that $A_a$ is smooth
over $R$ if $a$ is strictly standard in $A$ over $R$.

\begin{lemma}
\label{lemma-elkik}
(Elkik) Let $R \to A$ be a ring map of finite presentation.
The singular ideal $H_{A/R}$ is the radical of the ideal
generated by strictly standard elements in $A$ over $R$.
\end{lemma}

\begin{proof}
Assume $a$ is strictly standard in $A$ over $R$. We claim that
$A_a$ is smooth over $R$, which proves that $a \in H_{A/R}$. Namely,
let $A = R[x_1, \ldots, x_n]/(f_1, \ldots, f_m)$, $c$, and $a' \in A$
be as in Definition \ref{definition-strictly-standard}.
Write $I = (f_1, \ldots, f_m)$ so that the naive cotangent
complex of $A$ over $R$ is given by $I/I^2 \to \bigoplus A\text{d}x_i$.
Assumptions (\ref{equation-standard-one}) and (\ref{equation-standard-two})
imply that $(I/I^2)_a$ is free on the classes of $f_1, \ldots, f_c$  
and that the differential $(I/I^2)_a \to \bigoplus A_a\text{d}x_i$
has a left inverse. Hence $R \to A_a$ is smooth by definition and
Algebra, Lemma \ref{algebra-lemma-localize-NL}. The converse
follows immediately from
Lemma \ref{lemma-find-strictly-standard}.
\end{proof}

\begin{example}
\label{example-not-quasi-compact}
The set of points where a finitely presented ring map is smooth
needn't be a quasi-compact open. For example, let
$R = k[x, y_1, y_2, y_3, \ldots]/(xy_i)$ and $A = R/(x)$.
Then the smooth locus of $R \to A$ is
$\bigcup D(y_i)$ which is not quasi-compact.
\end{example}

\begin{lemma}
\label{lemma-strictly-standard-base-change}
Let $R \to A$ be a ring map of finite presentation.
Let $R \to R'$ be a ring map. If $a \in A$ is strictly standard in
$A$ over $R$, then $a \otimes 1$ is strictly standard in $A \otimes_R R'$
over $R'$.
\end{lemma}

\begin{proof}
If $A = R[x_1, \ldots, x_n]/(f_1, \ldots, f_m)$ is a presentation
of $A$ over $R$, then
$A \otimes_R R' = R'[x_1, \ldots, x_n]/(f'_1, \ldots, f'_m)$
is a presentation of $A \otimes_R R'$ over $R'$. Here $f'_j$ is
the image of $f_j$ in $R'[x_1, \ldots, x_n]$.
Hence the result follows from the definitions.
\end{proof}




\section{Presentations of algebras}
\label{section-presentations}

\noindent
Some of the results in this section are due to Elkik. Note that the algebra
$C$ in the following lemma is a symmetric algebra over $A$. Moreover, if
$R$ is Noetherian, then $C$ is of finite presentation over $R$.

\begin{lemma}
\label{lemma-improve-presentation}
Let $R$ be a ring and let $A$ be a finitely presented $R$-algebra.
There exists finite type $R$-algebra map $A \to C$ which has a
restraction with the following two properties
\begin{enumerate}
\item for each $a \in A$ such that $A_a$ is syntomic over $R$
the ring $C_a$ is smooth over $A_a$ and has a presentation
$C_a = R[y_1, \ldots, y_m]/J$ such that $J/J^2$ is free over $C_a$, and
\item for each $a \in A$ such that $A_a$ is smooth over $R$ the
module $\Omega_{C_a/R}$ is free over $C_a$.
\end{enumerate}
\end{lemma}

\begin{proof}
Choose a presentation $A = R[x_1, \ldots, x_n]/I$
and write $I = (f_1, \ldots, f_m)$. Set
$$
C = \text{Sym}^*_A(I/I^2).
$$
The retraction is just the projection onto the degree $0$ part of $C$.
We have a surjection $R[x_1, \ldots, x_n, z_1, \ldots, z_m] \to C$
which maps $z_j$ to the class of $f_j$ in $I/I^2$. Define the $A$-module
$K$ by the short exact sequence
$$
0 \to K \to A^{\oplus m} \to I/I^2 \to 0
$$
where the $j$th basis vector $e_j$ in the middle is mapped to the class of
$f_j$ on the right.

\medskip\noindent
Suppose that $a \in A$ is such that $A_a$ is syntomic over $R$.
Then $(I/I^2)_a$ is finite projective over $A_a$, see
Algebra, Lemma \ref{algebra-lemma-syntomic-presentation-ideal-mod-squares}.
Hence we see $K_a \oplus (I/I^2)_a \cong A_a^{\oplus m}$ is free.
As presentation of $C_a$ we take the map
$$
R[x_1, \ldots, x_n, z_0, z_1, \ldots, z_m] \to C_a
$$
extending the map given above by mapping $z_0$ to $1/a$. The kernel $J$
of this map is generated by the elements $f_1, \ldots, f_m$, the element
$az_0 - 1$, and the elements $\sum a_jz_j \in A^{\oplus m}$ such that
$\sum a_j e_j$ is an element of $K$. Comparing with
the exact sequence above we see that
$$
J/J^2 \cong
(I/I^2)_a \otimes_{A_a} C_a \oplus
C_a \oplus
K_a \otimes_{A_a} C_a \cong
C_a^{\oplus m + 1}
$$
This proves (1). Finally, suppose that in addition $A_a$ is smooth over
$R$. Then the same presentation shows that $\Omega_{C_a/R}$
is the cokernel of the map
$$
J/J^2 \longrightarrow
\bigoplus\nolimits_i C_a\text{d}x_i \oplus \bigoplus\nolimits_j C_a\text{d}z_j
$$
The summand $C_a$ of $J/J^2$ corresponding to $az_0 - 1$ maps isomorphically
to the summand $C_a\text{d}z_0$. The summand $(I/I^2)_a \otimes C_a$
of $J/J^2$ maps into $\bigoplus C_a\text{d}x_i$ with quotient
$\Omega_{A_a/R} \otimes C_a$. The summand $K_a \otimes C_a$ maps into
$\bigoplus_{j \geq 1} C_a\text{d}z_j$ with quotient isomorphic to
$(I/I^2)_a \otimes C_a$. Since $(I/I^2)_a \oplus \Omega_{A_a/R}$ is
free (from the definition of smooth ring maps) we see that (2) holds.
\end{proof}

\begin{lemma}
\label{lemma-huber}
Let $A$ be a finitely presented $R$-algebra which has a presentation
$A = R[x_1, \ldots, x_n]/I$ such that $I/I^2$ is free over $A$. Then
$A$ has a presentation $A = R[y_1, \ldots, y_m]/(f_1, \ldots, f_c)$
such that $(f_1, \ldots, f_c)/(f_1, \ldots, f_c)^2$ is free with
basis given by the classes of $f_1, \ldots, f_c$.
\end{lemma}

\begin{proof}
Let $f_1, \ldots, f_c \in I$ be elements which map to a basis of
$I/I^2$. By Nakayama's lemma there exists a $g \in 1 + I$ such that
$$
g \cdot I \subset (f_1, \ldots, f_c)
$$
Hence we see that
$$
A \cong R[x_1, \ldots, x_n]/(f_1, \ldots, f_c)[1/g]
\cong R[x_1, \ldots, x_n, x_{n + 1}]/(f_1, \ldots, f_c, gx_{n + 1} - 1)
$$
as desired.
\end{proof}

\noindent
We know that any syntomic ring map $R \to A$ is locally a relative global
complete intersection, see
Algebra, Lemma \ref{algebra-lemma-syntomic}.
The next lemma says that a vector bundle over $\Spec(A)$ is
a relative global complete intersection.

\begin{lemma}
\label{lemma-syntomic-complete-intersection}
Let $R \to A$ be a syntomic ring map. Then there exists a smooth $R$-algebra
map $A \to C$ with a retraction such that $C$ is a global relative complete
intersection over $R$, i.e.,
$$
C \cong R[x_1, \ldots, x_n]/(f_1, \ldots, f_c)
$$
flat over $R$ and all fibres of dimension $n - c$.
\end{lemma}

\begin{proof}
Apply Lemma \ref{lemma-improve-presentation} to get $A \to C$.
By Lemma \ref{lemma-huber}
we can write $C = R[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$
with $f_i$ mapping to a basis of $J/J^2$.
The ring map $R \to C$ is syntomic (hence flat)
as it is a composition of a syntomic and a smooth ring map.
The dimension of the fibres is $n - c$ as
the fibres are local complete interesections, so
Algebra, Lemma \ref{algebra-lemma-lci}
applies.
\end{proof}

\begin{lemma}
\label{lemma-smooth-standard-smooth}
Let $R \to A$ be a smooth ring map. Then there exists a smooth $R$-algebra
map $A \to B$ with a retraction such that $B$ is standard smooth over
$R$, i.e.,
$$
B \cong R[x_1, \ldots, x_n]/(f_1, \ldots, f_c)
$$
and $\det(\partial f_j/\partial x_i)_{j = 1, \ldots, c, i = 1, \ldots, c}$
is invertible in $C$.
\end{lemma}

\begin{proof}
Apply Lemma \ref{lemma-syntomic-complete-intersection}
to get a smooth $R$-algebra map $A \to C$ with a retraction such that
$C = R[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$
is a relative global complete intersection over $R$. As $C$ is smooth
over $R$ we have a short exact sequence
$$
0 \to
\bigoplus\nolimits_{j = 1, \ldots, c} C f_j \to
\bigoplus\nolimits_{i = 1, \ldots, n} C\text{d}x_i \to
\Omega_{C/R} \to 0
$$
Since $\Omega_{C/R}$ is a projective $C$-module this sequence is split.
Choose a left inverse $t$ to the first map. Say
$t(\text{d}x_i) = \sum c_{ij} f_j$
so that $\sum_i \frac{\partial f_j}{\partial x_i} c_{i\ell} = \delta_{j\ell}$
(Kronecker delta). Let
$$
B' = C[y_1, \ldots, y_c] =
R[x_1, \ldots, x_n, y_1, \ldots, y_c]/(f_1, \ldots, f_c)
$$
The $R$-algebra map $C \to B'$ has a retraction given by mapping $y_j$ to zero.
We claim that the map
$$
R[z_1, \ldots, z_n] \longrightarrow B',\quad
z_i \longmapsto x_i - \sum\nolimits_j c_{ij} y_j
$$
is \'etale at every point in the image of $\Spec(C) \to \Spec(B')$.
In $\Omega_{B'/R[z_1, \ldots, z_n]}$ we have
$$
\text{d}f_j - \sum\nolimits_i \frac{\partial f_j}{\partial x_i} \text{d}z_i
\equiv
\sum\nolimits_{i, \ell}
\frac{\partial f_j}{\partial x_i} c_{i\ell} \text{d}y_\ell
\equiv
\text{d}y_\ell \bmod (y_1, \ldots, y_c)\Omega_{B'/R[z_1, \ldots, z_n]}
$$
Since $\text{d}z_i = \text{d}x_i$ modulo the submodule generated by
$\text{d}y_j$ we conclude that
$$
\Omega_{B'/R[z_1, \ldots, z_n]}/
(y_1, \ldots, y_c)\Omega_{B'/R[z_1, \ldots, z_n]} = 0
$$
As $\Omega_{B'/R[z_1, \ldots, z_n]}$ is a finite $B'$-module
by Nakayama's lemma there exists a $g \in 1 + (y_1, \ldots, y_c)$
that $(\Omega_{B'/R[z_1, \ldots, z_n]})_g = 0$. This proves that
$R[z_1, \ldots, z_n] \to B'_g$ is unramified, see
Algebra, Definition \ref{algebra-definition-unramified}.
For any ring map $R \to k$ where $k$ is a field we obtain an
unramified ring map $k[z_1, \ldots, z_n] \to (B'_g) \otimes_R k$
between smooth $k$-algebras of dimension $n$. It follows that
$k[z_1, \ldots, z_n] \to (B'_g) \otimes_R k$ is flat by
Algebra, Lemmas \ref{algebra-lemma-CM-over-regular-flat} and
\ref{algebra-lemma-characterize-smooth-kbar}. By the criter\'ere
de platitude par fibre
(Algebra, Lemma \ref{algebra-lemma-criterion-flatness-fibre})
we conclude that $R[z_1, \ldots, z_n] \to B'_g$ is flat.
Finally, Algebra, Lemma \ref{algebra-lemma-characterize-etale}
implies that $R[z_1, \ldots, z_n] \to B'_g$ is \'etale.
Set $B = B'_g$. Note that $C \to B$ is smooth and has a retraction,
so also $A \to B$ is smooth and has a retraction.
Moreover, $R[z_1, \ldots, z_n] \to B$ is \'etale.
By Algebra, Lemma \ref{algebra-lemma-etale-standard-smooth}
we can write
$$
B = R[z_1, \ldots, z_n, w_1, \ldots, w_c]/(g_1, \ldots, g_c)
$$
with $\det(\partial g_j/\partial w_i)$ invertible in $B$.
This proves the lemma.
\end{proof}

\begin{lemma}
\label{lemma-colimit-standard-smooth}
Let $R \to \Lambda$ be a ring map. If $\Lambda$ is a filtered colimit of
smooth $R$-algebras, then $\Lambda$ is a filtered colimit of standard
smooth $R$-algebras.
\end{lemma}

\begin{proof}
Let $A \to \Lambda$ be an $R$-algebra map with $A$
of finite presentation over $R$. According to
Lemma \ref{lemma-when-colimit}
we have to factor this map through a standard smooth algebra, and
we know we can factor it as $A \to B \to \Lambda$ with $B$ smooth
over $R$. Choose an $R$-algebra map $B \to C$ with a retraction
$C \to B$ such that $C$ is standard smooth over $R$, see
Lemma \ref{lemma-smooth-standard-smooth}.
Then the desired factorization is $A \to B \to C \to B \to \Lambda$.
\end{proof}





\section{The lifting problem}
\label{section-lifting}

\noindent
The goal in this section is to prove (Proposition \ref{proposition-lift})
that the collection of algebras which are filtered colimits of smooth algebras
is closed under infinitesimal flat deformations. The proof is elementary
and only uses the results on presentations of smooth algebras from
Section \ref{section-presentations}.

\begin{lemma}
\label{lemma-lift-once}
Let $R \to \Lambda$ be a ring map. Let $I \subset R$ be an ideal.
Assume that
\begin{enumerate}
\item $I^2 = 0$, and
\item $\Lambda/I\Lambda$ is a filtered colimit of smooth $R/I$-algebras.
\end{enumerate}
Let $\varphi : A \to \Lambda$ be an $R$-algebra map with $A$ of finite
presentation over $R$. Then there exists a factorization
$$
A \to B/J \to \Lambda
$$
where $B$ is a smooth $R$-algebra and $J \subset IB$ is a finitely generated
ideal.
\end{lemma}

\begin{proof}
Choose a factorization
$$
A/IA \to \bar B \to \Lambda/I\Lambda
$$
with $\bar B$ standard smooth over $R/I$; this is possible by
assumption and Lemma \ref{lemma-colimit-standard-smooth}. Write
$$
\bar B = A/IA[t_1, \ldots, t_r]/(\bar g_1, \ldots, \bar g_s)
$$
and say $\bar B \to \Lambda/I\Lambda$ maps $t_i$ to the class
of $\lambda_i$ modulo $I\Lambda$. Choose
$g_1, \ldots, g_s \in A[t_1, \ldots, t_r]$ lifting
$\bar g_1, \ldots, \bar g_s$. Write
$\varphi(g_i)(\lambda_1, \ldots, \lambda_r) =
\sum \epsilon_{ij} \mu_{ij}$
for some $\epsilon_{ij} \in I$ and $\mu_{ij} \in \Lambda$. Define
$$
A' = A[t_1, \ldots, t_r, \delta_{i, j}]/
(g_i - \sum \epsilon_{ij} \delta_{ij})
$$
and consider the map
$$
A' \longrightarrow \Lambda,\quad
a \longmapsto \varphi(a),\quad
t_i \longmapsto \lambda_i,\quad
\delta_{ij} \longmapsto \mu_{ij}
$$
We have
$$
A'/IA' = A/IA[t_1, \ldots, t_r]/(\bar g_1, \ldots, \bar g_s)[\delta_{ij}]
\cong \bar B[\delta_{ij}]
$$
This is a standard smooth algebra over $R/I$ as $\bar B$ is standard
smooth. Choose a presentation
$A'/IA' = R/I[x_1, \ldots, x_n]/(\bar f_1, \ldots, \bar f_c)$ with
$\det(\partial \bar f_j/\partial x_i)_{1 \leq i, j \leq c}$ invertible in
$A'/IA'$. Choose lifts $f_1, \ldots, f_c \in R[x_1, \ldots, x_n]$ of
$\bar f_1, \ldots, \bar f_c$. Then
$$
B = R[x_1, \ldots, x_n, x_{n + 1}]/
(f_1, \ldots, f_c,
x_{n + 1}\det(\partial f_j/\partial x_i)_{1 \leq i, j \leq c} - 1)
$$
is smooth over $R$. Since smooth ring maps are formally smooth
(Algebra, Proposition \ref{algebra-proposition-smooth-formally-smooth})
there exists an $R$-algebra map $B \to A'$ which is an isomorphism
modulo $I$. Then $B \to A'$ is surjective by Nakayama's lemma
(Algebra, Lemma \ref{algebra-lemma-NAK}).
Thus $A' = B/J$ with $J \subset IB$ finitely generated (see
Algebra, Lemma \ref{algebra-lemma-finite-presentation-independent}).
\end{proof}

\begin{lemma}
\label{lemma-lift-twice}
Let $R \to \Lambda$ be a ring map. Let $I \subset R$ be an ideal.
Assume that
\begin{enumerate}
\item $I^2 = 0$,
\item $\Lambda/I\Lambda$ is a filtered colimit of smooth $R/I$-algebras, and
\item $R \to \Lambda$ is flat.
\end{enumerate}
Let $\varphi : B \to \Lambda$ be an $R$-algebra map with $B$
smooth over $R$. Let $J \subset IB$ be a finitely generated ideal.
Then there exists $R$-algebra maps
$$
B \xrightarrow{\alpha} B' \xrightarrow{\beta} \Lambda
$$
such that $B'$ is smooth over $R$, such that $\alpha(J) = 0$ and
such that $\beta \circ \alpha = \varphi \bmod I\Lambda$.
\end{lemma}

\begin{proof}
If we can prove the lemma in case $J = (h)$, then we can prove the
lemma by induction on the number of generators of $J$. Namely, suppose
that $J$ can be generated by $n$ elements $h_1, \ldots, h_n$ and the
lemma holds for all cases where $J$ is generated by $n - 1$ elements.
Then we apply the case $n = 1$ to produce $B \to B' \to \Lambda$
where the first map kills of $h_n$. Then we let $J'$ be the
ideal of $B'$ generated by the images of $h_1, \ldots, h_{n - 1}$
and we apply the case for $n - 1$ to produce $B' \to B'' \to \Lambda$.
It is easy to verify that $B \to B'' \to \Lambda$ does the job.

\medskip\noindent
Assume $J = (h)$ and write $h = \sum \epsilon_i b_i$
for some $\epsilon_i \in I$ and $b_i \in B$. Note that
$0 = \varphi(h) = \sum \epsilon_i \varphi(b_i)$.
As $\Lambda$ is flat over $R$, the equational criterion for
flatness (Algebra, Lemma \ref{algebra-lemma-flat-eq})
implies that we can find $\lambda_j \in \Lambda$,
$j = 1, \ldots, m$ and $a_{ij} \in R$ such that
$\varphi(b_i) = \sum_j a_{ij} \lambda_j$ and $\sum_i \epsilon_i a_{ij} = 0$.
Set
$$
C = B[x_1, \ldots, x_m]/(b_i - \sum a_{ij} x_j)
$$
with $C \to \Lambda$ given by $\varphi$ and $x_j \mapsto \lambda_j$.
Choose a factorization
$$
C \to B'/J' \to \Lambda
$$
as in Lemma \ref{lemma-lift-once}. Since $B$ is smooth over $R$ we can
lift the map $B \to C \to B'/J'$ to a map $\psi : B \to B'$. We claim that
$\psi(h) = 0$. Namely, the fact that $\psi$ agrees with
$B \to C \to B'/J'$ mod $I$ implies that
$$
\psi(b_i) = \sum a_{ij} \xi_j + \theta_i
$$
for some $\xi_i \in B'$ and $\theta_i \in IB'$. Hence we see that
$$
\psi(h) = \psi(\sum \epsilon_i b_i) =
\sum \epsilon_i a_{ij} \xi_j + \sum \epsilon_i \theta_i = 0
$$
because of the relations above and the fact that $I^2 = 0$.
\end{proof}

\begin{proposition}
\label{proposition-lift}
Let $R \to \Lambda$ be a ring map. Let $I \subset R$ be an ideal.
Assume that
\begin{enumerate}
\item $I$ is nilpotent,
\item $\Lambda/I\Lambda$ is a filtered colimit of smooth $R/I$-algebras, and
\item $R \to \Lambda$ is flat.
\end{enumerate}
Then $\Lambda$ is a colimit of smooth $R$-algebras.
\end{proposition}

\begin{proof}
Since $I^n = 0$ for some $n$, it follows by induction on $n$ that
it suffices to consider the case where $I^2 = 0$. Let
$\varphi : A \to \Lambda$ be an $R$-algebra map with $A$ of finite
presentation over $R$. We have to find a factorization $A \to B \to \Lambda$
with $B$ smooth over $R$, see Lemma \ref{lemma-when-colimit}.
By Lemma \ref{lemma-lift-once} we may assume that
$A = B/J$ with $B$ smooth over $R$ and $J \subset IB$
a finitely generated ideal. By
Lemma \ref{lemma-lift-twice}
we can find a (possibly noncommutative) diagram
$$
\xymatrix{
B \ar[rr]_\alpha \ar[rd]_\varphi & & B' \ar[ld]^\beta \\
& \Lambda
}
$$
of $R$-algebras which commutes modulo $I$ and such that $\alpha(J) = 0$.
The map
$$
D : B \longrightarrow I\Lambda,\quad
b \longmapsto \varphi(b) - \beta(\alpha(b))
$$
is a derivation over $R$ hence we can write it as
$D = \xi \circ \text{d}_{B/R}$ for some $B$-linear map
$\xi : \Omega_{B/R} \to I\Lambda$. Since $\Omega_{B/R}$ is a
finite projective $B$-module we can write
$\xi = \sum_{i = 1, \ldots, n} \epsilon_i \Xi_i$
for some $\epsilon_i \in I$ and $B$-linear maps
$\Xi_i : \Omega_{B/R} \to \Lambda$.
(Details omitted. Hint: write $\Omega_{B/R}$ as a direct sum of
a finite free module to reduce to the finite free case.)
We define
$$
B'' = \text{Sym}^*_{B'}\left(\bigoplus\nolimits_{i = 1, \ldots, n}
\Omega_{B/R} \otimes_{B, \alpha} B'\right)
$$
and we define $\beta' : B'' \to \Lambda$ by
$\beta$ on $B'$ and by
$$
\beta'|_{i\text{th summand }\Omega_{B/R} \otimes_{B, \alpha} B'} =
\Xi_i \otimes \beta
$$
and $\alpha' : B \to B''$ by
$$
\alpha'(b) =
\alpha(b) \oplus \sum \epsilon_i \text{d}_{B/R}(b) \otimes 1
\oplus 0 \oplus \ldots
$$
At this point the diagram
$$
\xymatrix{
B \ar[rr]_{\alpha'} \ar[rd]_\varphi & & B'' \ar[ld]^{\beta'} \\
& \Lambda
}
$$
does commute. Moreover, it is direct from the definitions that
$\alpha'(J) = 0$ as $I^2 = 0$. Hence the desired factorization.
\end{proof}






\section{The lifting lemma}
\label{section-lifting-lemma}

\noindent
Here is a fiendishly clever lemma.

\begin{lemma}
\label{lemma-lifting}
Let $R \to \Lambda$ be a ring map with $R$ Noetherian.
Let $\pi \in R$ and assume that
$\text{Ann}_R(\pi) = \text{Ann}_R(\pi^2)$ and
$\text{Ann}_\Lambda(\pi) = \text{Ann}_\Lambda(\pi^2)$.
Suppose we have $R/\pi^2R \to \bar C \to \Lambda/\pi^2\Lambda$
with $\bar C$ of finite presentation over $R$. Then there exist ring maps
$R \to D \to \Lambda$ and a commutative diagram
$$
\xymatrix{
R/\pi^2R \ar[r] \ar[d] &
\bar C \ar[r] \ar[d] &
\Lambda/\pi^2\Lambda \ar[d] \\
R/\pi R \ar[r] &
D/\pi D \ar[r] &
\Lambda/\pi \Lambda
}
$$
such that $D$ is of finite presentation over $R$ and such that
$R \to D$ is smooth at any prime $\mathfrak q$ with $\pi \not \in \mathfrak q$
as well as at any $\mathfrak q$ with $\pi \in \mathfrak q$
lying over a prime of $\bar C$ where $R/\pi^2 R \to \bar C$ is smooth.
\end{lemma}

\begin{proof}
We choose a presentation
$$
\bar C = R[x_1, \ldots, x_n]/(f_1, \ldots, f_m)
$$
We also denote $I = (f_1, \ldots, f_m)$ and $\bar I$ the image of
$I$ in $R/\pi^2R[x_1, \ldots, x_n]$. Since $R$ is Noetherian, so is
$\bar C$. Hence the smooth locus of $R/\pi^2 R \to \bar C$
is quasi-compact, see
Topology, Lemma \ref{topology-lemma-Noetherian}.
Applying
Lemma \ref{lemma-find-strictly-standard}
we may choose a finite list of elements
$a_1, \ldots, a_r \in R[x_1, \ldots, x_n]$ such that
\begin{enumerate}
\item the union of the open subspaces
$\Spec(\bar C_{a_k}) \subset \Spec(\bar C)$
cover the smooth locus of $R/\pi^2 R \to \bar C$, and
\item for each $k = 1, \ldots, r$ there exists a finite subset
$E_k \subset \{1, \ldots, m\}$ such that
$(\bar I/\bar I^2)_{a_k}$ is freely generated by the classes of
$f_j$, $j \in E_k$.
\end{enumerate}
Set $I_k = (f_j, j \in E_k) \subset I$ and denote $\bar I_k$ the
image of $I_k$ in $R/\pi^2R[x_1, \ldots, x_n]$.
By (2) and Nakayama's lemma we see that $(\bar I/\bar I_k)_{a_k}$
is annihilated by $1 + b'_k$ for some $b'_k \in \bar I_{a_k}$.
Suppose $b'_k$ is the image of $b_k/(a_k)^N$ for some $b_k \in I$
and some integer $N$. After replacing $a_k$ by $a_kb_k$ we get
\begin{enumerate}
\item[(3)] $(\bar I_k)_{a_k} = (\bar I)_{a_k}$.
\end{enumerate}
Thus, after possibly replacing $a_k$ by a high power, we may write
\begin{enumerate}
\item[(4)]
$a_k f_\ell = \sum\nolimits_{j \in E_k} h_{k, \ell}^jf_j + \pi^2 g_{k, \ell}$
\end{enumerate}
for any $\ell \in \{1, \ldots, m\}$ and some
$h_{i, \ell}^j, g_{i, \ell} \in R[x_1, \ldots, x_n]$.
If $\ell \in E_k$ we choose $h_{k, \ell}^j = a_k\delta_{\ell, j}$
(Kronecker delta) and $g_{k, \ell} = 0$. Set
$$
D = R[x_1, \ldots, x_n, z_1, \ldots, z_m]/
(f_j - \pi z_j, p_{k, \ell}).
$$
Here $j \in \{1, \ldots, m\}$, $k \in \{1, \ldots, r\}$,
$\ell \in \{1, \ldots, m\}$, and
$$
p_{k, \ell} = a_k z_\ell - \sum\nolimits_{j \in E_k} h_{k, \ell}^j z_j
- \pi g_{k, \ell}.
$$
Note that for $\ell \in E_k$ we have $p_{k, \ell} = 0$ by our choices above.

\medskip\noindent
The map $R \to D$ is the given one.
Say $\bar C \to \Lambda/\pi^2\Lambda$ maps $x_i$
to the class of $\lambda_i$ modulo $\pi^2$. For an element
$f \in R[x_1, \ldots, x_n]$ we denote $f(\lambda) \in \Lambda$
the result of subsituting $\lambda_i$ for $x_i$. Then we know that
$f_j(\lambda) = \pi^2 \mu_j$ for some $\mu_j \in \Lambda$.
Define $D \to \Lambda$ by the rules $x_i \mapsto \lambda_i$ and
$z_j \mapsto \pi\mu_j$. This is well defined because
\begin{align*}
p_{k, \ell} & \mapsto
a_k(\lambda) \pi \mu_\ell -
\sum\nolimits_{j \in E_k} h_{k, \ell}^j(\lambda) \pi \mu_j
- \pi g_{k, \ell}(\lambda) \\
& =
\pi\left(a_k(\lambda) \mu_\ell -
\sum\nolimits_{j \in E_k} h_{k, \ell}^j(\lambda) \mu_j
- g_{k, \ell}(\lambda)\right)
\end{align*}
Substituting $x_i = \lambda_i$ in (4) above we see that the expression
inside the brackets is annihilated by $\pi^2$, hence it is annihilated
by $\pi$ as we have assumed
$\text{Ann}_\Lambda(\pi) = \text{Ann}_\Lambda(\pi^2)$.
The map $\bar C \to D/\pi D$ is determined by $x_i \mapsto x_i$
(clearly well defined). Thus we are done if we can prove the statement
about smoothness of $R \to D$.

\medskip\noindent
Using (4) we obtain the following key equality
\begin{align*}
\pi p_{k, \ell} & =
\pi a_k z_\ell - \sum\nolimits_{j \in E_k} \pi h_{k, \ell}^jz_j
- \pi^2 g_{k, \ell} \\
& =
- a_k (f_\ell - \pi z_\ell) + a_k f_\ell +
\sum\nolimits_{j \in E_k} h_{k, \ell}^j (f_j - \pi z_j) -
\sum\nolimits_{j \in E_k} h_{k, \ell}^j f_j - \pi^2 g_{k, \ell} \\
& =
-a_k(f_\ell - \pi z_\ell) +
\sum\nolimits_{j \in E_k} h_{k, \ell}^j(f_j - \pi z_j)
\end{align*}
The end result is an element of the ideal generated by $f_j - \pi z_j$.
In particular, we see that $D[1/\pi]$ is isomorphic to
$R[1/\pi][x_1, \ldots, x_n, z_1, \ldots, z_m]/(f_j - \pi z_j)$
which is isomorphic to $R[1/\pi][x_1, \ldots, x_n]$ hence smooth
over $R$.

\medskip\noindent
For fixed $k \in \{1, \ldots, r\}$ consider the ring
$$
D_k = R[x_1, \ldots, x_n, z_1, \ldots, z_m]/
(f_j - \pi z_j, j \in E_k, p_{k, \ell})
$$
The number of equations is $m = |E_k| + (m - |E_k|)$ as $p_{k, \ell}$
is zero if $\ell \in E_k$. Also, note that
\begin{align*}
(D_k/\pi D_k)_{a_k}
& =
R/\pi R[x_1, \ldots, x_n, 1/a_k, z_1, \ldots, z_m]/
(f_j, j \in E_k, p_{k, \ell}) \\
& =
(\bar C/\pi \bar C)_{a_k}[z_1, \ldots, z_m]/
(a_kz_\ell - \sum\nolimits_{j \in E_k} h_{k, \ell}^j z_j) \\
& \cong
(\bar C/\pi \bar C)_{a_k}[z_j, j \in E_k]
\end{align*}
Note that $(\bar C/\pi \bar C)_{a_k}$ is smooth over $R/\pi R$
of relative dimension $n - |E_k|$, see (2). Hence for a prime
$\mathfrak q_k \subset D_k$ containing $\pi$ and lying over
$\Spec(\bar C_{a_k})$ the fibre ring of $R \to D_k$
is smooth at $\mathfrak q_k$ of dimension $n$. Thus $R \to D_k$ is syntomic
at $\mathfrak q_k$ by our count of the number of equations above, see
Algebra, Lemma \ref{algebra-lemma-localize-relative-complete-intersection}.
Hence $R \to D_k$ is smooth at $\mathfrak q_k$, see
Algebra, Lemma \ref{algebra-lemma-flat-fibre-smooth}.

\medskip\noindent
To finish the proof, let $\mathfrak q \subset D$ be a prime
containing $\pi$ lying over a prime where $R/\pi^2 R \to \bar C$
is smooth. Then $a_k \not \in \mathfrak q$
for some $k$ by (1). We will show that the surjection $D_k \to D$ induces
an isomorphism on local rings at $\mathfrak q$. Since we know that
$R \to D_k$ is smooth at the corresponding prime $\mathfrak q_k$
by the preceding paragraph this will finish the proof.

\medskip\noindent
First, note that for any $\ell$ the equation
$\pi p_{k, \ell} = -a_k(f_\ell - \pi z_\ell) +
\sum_{j \in E_k} h_{k, \ell}^j (f_j - \pi z_j)$ proved above shows that
$f_\ell - \pi z_\ell$ maps to zero in $(D_k)_{a_k}$ and in particular
in $(D_k)_{\mathfrak q_k}$.
The relations (4) imply that $a_k f_\ell =
\sum_{j \in E_k} h_{k, \ell}^j f_j$ in $I/I^2$.
Since $(\bar I_k/\bar I_k^2)_{a_k}$ is free on $f_j$, $j \in E_k$
we see that
$$
a_{k'} h_{k, \ell}^j -
\sum\nolimits_{j' \in E_{k'}} h_{k', \ell}^{j'} h_{k, j'}^j
$$
is zero in $\bar C_{a_k}$ for every $k, k', \ell$ and $j \in E_k$.
Hence we can find a large integer $N$ such that
$$
a_k^N\left(
a_{k'} h_{k, \ell}^j -
\sum\nolimits_{j' \in E_{k'}} h_{k', \ell}^{j'} h_{k, j'}^j
\right)
$$
is in $I_k + \pi^2R[x_1, \ldots, x_n]$. Computing modulo $\pi$ we have
\begin{align*}
&
a_kp_{k', \ell} - a_{k'}p_{k, \ell} + \sum h_{k', \ell}^{j'} p_{k, j'}
\\
&
=
- a_k \sum h_{k', \ell}^{j'} z_{j'}
+ a_{k'} \sum h_{k, \ell}^j z_j
+ \sum h_{k', \ell}^{j'} a_k z_{j'}
- \sum \sum h_{k', \ell}^{j'} h_{k, j'}^j z_j \\
&
=
\sum \left(
a_{k'} h_{k, \ell}^j
- \sum h_{k', \ell}^{j'} h_{k, j'}^j
\right) z_j
\end{align*}
with Einstein summation convention. Combining with the above we see
$a_k^{N + 1} p_{k', \ell}$ is contained in the ideal generated
by $I_k$ and $\pi$ in $R[x_1, \ldots, x_n, z_1, \ldots, z_m]$.
Thus $p_{k', \ell}$ maps into $\pi (D_k)_{a_k}$. On the other hand,
the equation
$$
\pi p_{k', \ell} =
-a_{k'} (f_\ell - \pi z_\ell) +
\sum\nolimits_{j' \in E_{k'}} h_{k', \ell}^{j'}(f_{j'} - \pi z_{j'})
$$
shows that $\pi p_{k', \ell}$ is zero in $(D_k)_{a_k}$.
Since we have assumed that $\text{Ann}_R(\pi) = \text{Ann}_R(\pi^2)$
and since $(D_k)_{\mathfrak q_k}$ is smooth hence flat over $R$
we see that
$\text{Ann}_{(D_k)_{\mathfrak q_k}}(\pi) =
\text{Ann}_{(D_k)_{\mathfrak q_k}}(\pi^2)$.
We conclude that $p_{k', \ell}$ maps to zero as well, hence
$D_{\mathfrak q} = (D_k)_{\mathfrak q_k}$ and we win.
\end{proof}






\section{The desingularization lemma}
\label{section-desingularization-lemma}

\noindent
Here is another fiendishly clever lemma.

\begin{lemma}
\label{lemma-desingularize}
Let $R \to \Lambda$ be a ring map. Assume $R$ Noetherian. Let $\pi \in R$.
Assume that $\text{Ann}_\Lambda(\pi) = \text{Ann}_\Lambda(\pi^2)$. Let
$R \to A \to \Lambda$ be ring maps. Assume $A$ of finite
presentation over $R$. Assume
\begin{enumerate}
\item the image of $\pi$ is strictly standard in $A$ over $R$, and
\item there exists a section $\rho : A/\pi^4 A \to R/\pi^4 R$
which is compatible with the map to $\Lambda/\pi^4 \Lambda$.
\end{enumerate}
Then we can find $A \to B \to \Lambda$ with $B$ of finite presentation
over $R$ such that $\mathfrak a B \subset H_{B/R}$ where
$\mathfrak a = \text{Ann}_R(\text{Ann}_R(\pi^2)/\text{Ann}_R(\pi))$.
\end{lemma}

\begin{proof}
Choose a presentation
$$
A = R[x_1, \ldots, x_n]/(f_1, \ldots, f_m)
$$
and $0 \leq c \leq \min(n, m)$ such that
$$
\pi = a' \det(\partial f_j/\partial x_i)_{j = 1, \ldots, c, \ i = 1, \ldots, c}
$$
in $A$ for some $a' \in A$ and
\begin{equation}
\label{equation-star}
\pi f_{c + j} \in (f_1, \ldots, f_c) + (f_1, \ldots, f_m)^2
\end{equation}
for $j = 1, \ldots, m - c$. Say $\rho$ maps $x_i$ to the class of
$r_i \in R$. Then we can replace $x_i$ by $x_i - r_i$. Hence we may
assume $\rho(x_i) = 0$ in $R/\pi^4 R$. This implies that
$f_j(0) \in \pi^4R$ and that $A \to \Lambda$ maps $x_i$
to $\pi^4\lambda_i$ for some $\lambda_i \in \Lambda$. Write
$$
f_j = f_j(0) + \sum\nolimits_{i = 1, \ldots, n} r_{ji} x_i + \text{h.o.t.}
$$
This implies that the constant term of $\partial f_j/\partial x_i$
is $r_{ji}$. Applying $\rho$ to the identity $\pi = a' \det$ above we get
$$
\pi = \rho(a') \det(r_{ji})_{j = 1, \ldots, c, \ i = 1, \ldots, c}
\bmod \pi^4R
$$
Thus there exists a $c \times c$ matrix $s_{ij}$ with coefficients in
$R$ such that $\sum_{i = 1, \ldots, c} r_{ji} s_{ik} = u \pi  \delta_{jk}$
(Kronecker delta) for $j, k \in \{1, \ldots, c\}$ where $u \in R$ is an
element congruent to $1$ modulo $\pi$. We set
$$
h_i =
\left\{
\begin{matrix}
x_i - \pi^2 \sum\nolimits_{j = 1, \ldots c} s_{ij} v_j - \pi^3 w_i
& \text{for} &
1 \leq i \leq c \\
x_i - \pi^3 w_i
& \text{for} &
i > c
\end{matrix}
\right.
$$
We will use that
$$
R[x_1, \ldots, x_n, v_1, \ldots, v_c, w_1, \ldots, w_n]/
(h_1, \ldots, h_n) = R[v_1, \ldots, v_c, w_1, \ldots, w_n]
$$
without further mention. In
$R[x_1, \ldots, x_n, v_1, \ldots, v_c, w_1, \ldots, w_n]/
(\pi^4, h_1, \ldots, h_n)$ we have
$$
f_j = f_j(x_1 - h_1, \ldots, x_n - h_n) =
\sum\nolimits_i \pi^2 r_{ji} s_{ik} v_k = \pi^3 v_j
$$
for $1 \leq j \leq c$. Hence there exist
$g_j \in R[v_1, \ldots, v_c, w_1, \ldots, w_n]$
such that $g_j = v_j \bmod \pi$ and such that $f_j = \pi^3 g_j$
in $R[x_1, \ldots, x_n, v_1, \ldots, v_c, w_1, \ldots, w_n]/
(h_1, \ldots, h_n)$. We set
$$
B = R[x_1, \ldots, x_n, v_1, \ldots, v_c, w_1, \ldots, w_n]/
(f_1, \ldots, f_n, h_1, \ldots, h_n, g_1, \ldots, g_c).
$$
The map $A \to B$ is clear. We define $B \to \Lambda$ by mapping
$x_i \to \pi^4\lambda_i$, $v_i \mapsto 0$, and $w_i \mapsto \pi \lambda_i$.
Then it is clear that the elements $f_j$ and $h_i$ are mapped to zero
in $\Lambda$. Moreover, it is clear that $g_i$ is mapped to an element
$t$ of $\pi\Lambda$ such that $\pi^3t = 0$ (as $f_i = \pi^3 g_i$ modulo
the ideal generated by the $h$'s). Hence our assumption that
$\text{Ann}_\Lambda(\pi) = \text{Ann}_\Lambda(\pi^2)$ implies that $t = 0$.
Thus we are done if we can prove the statement about smoothness.

\medskip\noindent
Note that $B_\pi \cong A_\pi[v_1, \ldots, v_c]$ because the equations
$g_i = 0$ are implied by $f_i = 0$. Hence $B_\pi$ is smooth over $R$
as $A_\pi$ is smooth over $R$ by the assumption that $\pi$ is strictly
standard in $A$ over $R$, see
Lemma \ref{lemma-elkik}.

\medskip\noindent
Set $B' = R[v_1, \ldots, v_c, w_1, \ldots, w_n]/(g_1, \ldots, g_c)$.
As $g_i = v_i \bmod \pi$ we see that
$B'/\pi B' = R/\pi R[w_1, \ldots, w_n]$. Hence
$R \to B'$ is smooth of relative dimension $n$ at every
point of $V(\pi)$ by
Algebra, Lemmas
\ref{algebra-lemma-localize-relative-complete-intersection} and
\ref{algebra-lemma-flat-fibre-smooth}
(the first lemma shows it is syntomic at those primes, in particular
flat, whereupon the second lemma shows it is smooth).

\medskip\noindent
Let $\mathfrak q \subset B$ be a prime with $\pi \in \mathfrak q$ and
for some $r \in \mathfrak q$, $r \not \in \mathfrak q$.
Denote $\mathfrak q' = B' \cap \mathfrak q$.
We claim the surjection $B' \to B$ induces an isomorphism of local
rings $(B')_{\mathfrak q'} \to B_\mathfrak q$. This will
conclude the proof of the lemma. Note that $B_\mathfrak q$ is the
quotient of $(B')_{\mathfrak q'}$ by the ideal generated by
$f_{c + j}$, $j = 1, \ldots, m - c$. We observe two things:
first the image of $f_{c + j}$ in $(B')_{\mathfrak q'}$ is
divisible by $\pi^2$ and
second the image of $\pi f_{c + j}$ in $(B')_{\mathfrak q'}$
can be written as $\sum b_{j_1 j_2} f_{c + j_1}f_{c + j_2}$ by
(\ref{equation-star}). Thus we see that the image of each $\pi f_{c + j}$
is contained in the ideal generated by the elements $\pi^2 f_{c + j'}$.
Hence $\pi f_{c + j} = 0$ in $(B')_{\mathfrak q'}$ as this is a
Noetherian local ring, see
Algebra, Lemma \ref{algebra-lemma-intersect-powers-ideal-module-zero}.
As $R \to (B')_{\mathfrak q'}$ is flat we see that
$$
\left(\text{Ann}_R(\pi^2)/\text{Ann}_R(\pi)\right)
\otimes_R (B')_{\mathfrak q'}
=
\text{Ann}_{(B')_{\mathfrak q'}}(\pi^2)/\text{Ann}_{(B')_{\mathfrak q'}}(\pi)
$$
Because $r \in \mathfrak a$ is invertible in
$(B')_{\mathfrak q'}$ we see that this module is zero.
Hence we see that the image of $f_{c + j}$ is zero in
$(B')_{\mathfrak q'}$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-desingularize-strictly-standard}
Let $R \to \Lambda$ be a ring map with $R$ Noetherian. Let $\pi \in R$ and
assume that $\text{Ann}_R(\pi) = \text{Ann}_R(\pi^2)$ and
$\text{Ann}_\Lambda(\pi) = \text{Ann}_\Lambda(\pi^2)$.
Let $A \to \Lambda$ and $D \to \Lambda$ be $R$-algebra maps with
$A$ and $D$ of finite presentation over $R$. Assume
\begin{enumerate}
\item $\pi$ is strictly standard in $A$ over $R$, and
\item there exists an $R$-algebra map $A/\pi^4 A \to D/\pi^4 D$ compatible
with the maps to $\Lambda/\pi^4 \Lambda$.
\end{enumerate}
Then we can find an $R$-algebra map $B \to \Lambda$ with $B$ of finite
presentation over $R$ and $R$-algebra maps $A \to B$ and $D \to B$
compatible with maps to $\Lambda$ such that $H_{D/R}B \subset H_{B/R}$.
\end{lemma}

\begin{proof}
We apply Lemma \ref{lemma-desingularize} to
$$
D \longrightarrow A \otimes_R D \longrightarrow \Lambda
$$
and the image of $\pi$ in $D$. By
Lemma \ref{lemma-strictly-standard-base-change}
we see that $\pi$ is strictly standard in $A \otimes_R D$ over $D$.
As our section $\rho : (A \otimes_R D)/\pi^4 (A \otimes_R D) \to D/\pi^4 D$
we take the map induced by the map in (2). Thus
Lemma \ref{lemma-desingularize} applies and we obtain a factorization
$A \otimes_R D \to B \to \Lambda$ with $B$ of finite presentation over $R$
and $\mathfrak a B \subset H_{B/R}$ where
$$
\mathfrak a = \text{Ann}_D(\text{Ann}_D(\pi^2)/\text{Ann}_D(\pi)).
$$
For any prime $\mathfrak q$ of $D$ such that $D_\mathfrak q$ is flat over $R$
we have
$\text{Ann}_{D_\mathfrak q}(\pi^2)/\text{Ann}_{D_\mathfrak q}(\pi) = 0$
because annihilators of elements commutes with flat base change and
we assumed $\text{Ann}_R(\pi) = \text{Ann}_R(\pi^2)$. Because $D$ is
Noetherian we see that $\text{Ann}_D(\pi^2)/\text{Ann}_D(\pi)$ is a finite
$D$-module, hence formation of its annihilator commutes with localization.
Thus we see that $\mathfrak a \not \subset \mathfrak q$. Hence we see
that $R \to B$ is smooth at any prime of $B$ lying over $\mathfrak q$.
Since any prime of $D$ where $R \to D$ is smooth is one where
$D_\mathfrak q$ is flat over $R$ we win.
\end{proof}





\input{chapters}

\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}
