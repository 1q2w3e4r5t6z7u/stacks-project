\input{preamble}

% OK, start here.
%
\begin{document}

\title{Smoothing Ring Maps}


\maketitle

\phantomsection
\label{section-phantom}

\tableofcontents

\section{Introduction}
\label{section-introduction}

\noindent
The main theorem explained in this chapter is due to
Popescu, see \cite{popescu-letter}, \cite{popescu-GND}, \cite{popescu-GNDA}.
A readable exposition of Popescu's proof was given by Richard Swan,
see \cite{swan} whose used notes by Andr\'e and a paper of Ogoma, see
\cite{Ogoma}.
We follow this exposition, except that we try to avoid the elaborate
unwinding of residue field extensions by using
Lemma 7.4 of \cite{popescu-GNDA}.

\medskip\noindent
Here is a definition due to Artin.
Let $A$ be a henselian Noetherian local ring. We say $A$ has the
{\it approximation property} if for any
$f_1, \ldots, f_m \in A[x_1, \ldots, x_n]$
the system of equations
$f_1 = 0, \ldots, f_m = 0$ has a solution in the completion
of $A$ if and only if it has a solution in $A$.

\medskip\noindent
Artin first proved the approximation property for analytic systems of
equations, see \cite{Artin-Analytic-Approximation}.
In \cite{Artin-Algebraic-Approximation} Artin proved the
approximation property for local rings
essentially of finite type over an excellent discrete valuation ring.
Artin conjectured (page 26 of \cite{Artin-Algebraic-Approximation})
that every excellent henselian local ring should have the
approximation property.

\medskip\noindent
In \cite{Artin-power-series} it is shown that
$R \to R^\wedge$ is a filtered colimit of smooth algebras for any
local ring $R$ essentially of finite type over a field.
In this paper Artin conjectured (see also \cite{Artin-Denef})
that every regular homomorphism of Noetherian rings is a
filtered colimit of smooth algebras.
In \cite{Rotthaus-Artin} it is shown that $R \to R^\wedge$
is a filtered colimit of smooth algebras for any local ring $R$
essentially of finite type over an excellent discrete valution ring.

\medskip\noindent
Conversely, using some of the results above, in \cite{Rotthaus-excellent}
it was shown that any local ring with the approximation property is excellent.

\medskip\noindent
In the paper \cite{Spivakovsky} there is an alternative proof of the
main theorem due to Spivakovsky. There is also a Bourbaki lecture about
this material, see \cite{Teissier}.





\section{Singular ideals}
\label{section-singular-ideal}

\noindent
Let $R \to A$ be a ring map. The singular ideal of $A$ over $R$
is the radical ideal in $A$ cutting out the singular locus of the
morphism $\Spec(A) \to \Spec(R)$. Here is a formal definition.

\begin{definition}
\label{definition-singular-ideal}
Let $R \to A$ be a ring map. The {\it singular ideal of $A$ over $R$},
denoted $H_{A/R}$ is the unique radical ideal $H_{A/R} \subset A$ with
$$
V(H_{A/R}) = \{\mathfrak q \in \Spec(A) \mid R \to A
\text{ not smooth at }\mathfrak q\}
$$
\end{definition}

\noindent
This makes sense because the set of primes where $R \to A$ is smooth
is open, see
Algebra, Definition \ref{algebra-definition-smooth-at-prime}.
In order to find an explicit set
of generators for the singular ideal we first prove the following lemma.

\begin{lemma}
\label{lemma-find-strictly-standard}
Let $R$ be a ring. Let $A = R[x_1, \ldots, x_n]/(f_1, \ldots, f_m)$.
Let $\mathfrak q \subset A$. Assume $R \to A$ is smooth
at $\mathfrak q$. Then there exists an $a \in A$, $a \not \in \mathfrak q$,
an integer $c$, $0 \leq c \leq \min(n, m)$, subsets
$U \subset \{1, \ldots, n\}$, $V \subset \{1, \ldots, m\}$
of cardinality $c$ such that
$$
a = a' \det(\partial f_j/\partial x_i)_{j \in V, i \in U}
$$
for some $a' \in A$ and
$$
a f_\ell \in (f_j, j \in j) + (f_1, \ldots, f_m)^2
$$
for all $\ell \in \{1, \ldots, m\}$.
\end{lemma}

\begin{proof}
The assumption means that there exists an $a \in A$, $a \not \in \mathfrak p$
such that $R \to A_a$ is standard smooth, see
Algebra, Lemma \ref{algebra-lemma-smooth-syntomic}.
Set $I = (f_1, \ldots, f_m)$ so that the the naive cotangent
complex of $A$ over $R$ is given by $I/I^2 \to \bigoplus A\text{d}x_i$.
After renumbering $x_1, \ldots, x_n$ and $f_1, \ldots, f_m$ we may assume
that $f_1, \ldots, f_c$ form a basis for the vector space
$I/I^2 \otimes_A \kappa(\mathfrak q)$ and that
$\text{d}x_{c + 1}, \ldots, \text{d}x_n$ map to a basis of
$\Omega^1_{A/R} \otimes_A \kappa(\mathfrak q)$. By
Algebra, Lemmas \ref{algebra-lemma-localize-NL} and
\ref{algebra-lemma-standard-smooth}
we see that $(I/I^2)_a \to \bigoplus A_a\text{d}x_i$ is a split injection
whose cokernel is a free $A_a$-module. Hence after replacing $a$ by $aa'$ for
some $a' \in A$, $a' \not \in \mathfrak q$ we may assume
$f_1, \ldots, f_c$ form a basis for $(I/I^2)_a$ and that
$\text{d}x_{c + 1}, \ldots, \text{d}x_n$ map to a basis of
$(\Omega^1_{A/R})_a$. In this situation $a^N$ for some large integer
$N$ satisfies the conditions of the
lemma (with $U = V = \{1, \ldots, c\}$).
\end{proof}

\noindent
Lemma \ref{lemma-find-strictly-standard}
is the motivation for the following definition.

\begin{definition}
\label{definition-strictly-standard}
Let $R \to A$ be a ring map of finite presentation.
We say $a \in A$ is {\it strictly standard in $A$ over $R$}
if there exists a presentation
$$
A = R[x_1, \ldots, x_n]/(f_1, \ldots, f_m)
$$
and $0 \leq c \leq \min(n, m)$ such that
\begin{equation}
\label{equation-standard-one}
a = a' \det(\partial f_j/\partial x_i)_{j = 1, \ldots, c, \ i = 1, \ldots, c}
\end{equation}
for some $a' \in A$ and
\begin{equation}
\label{equation-standard-two}
a f_{c + j} \in (f_1, \ldots, f_c) + (f_1, \ldots, f_m)^2
\end{equation}
for $j = 1, \ldots, m - c$.
\end{definition}

\noindent
The following lemma says in particular that $A_a$ is smooth
over $R$ if $a$ is strictly standard in $A$ over $R$.

\begin{lemma}
\label{lemma-elkik}
(Elkik) Let $R \to A$ be a ring map of finite presentation.
The singular ideal $H_{A/R}$ is the radical of the ideal
generated by strictly standard elements in $A$ over $R$.
\end{lemma}

\begin{proof}
Assume $a$ is strictly standard in $A$ over $R$. We claim that
$A_a$ is smooth over $R$, which proves that $a \in H_{A/R}$. Namely,
let $A = R[x_1, \ldots, x_n]/(f_1, \ldots, f_m)$, $c$, and $a' \in A$
be as in Definition \ref{definition-strictly-standard}.
Write $I = (f_1, \ldots, f_m)$ so that the naive cotangent
complex of $A$ over $R$ is given by $I/I^2 \to \bigoplus A\text{d}x_i$.
Assumptions (\ref{equation-standard-one}) and (\ref{equation-standard-two})
imply that $(I/I^2)_a$ is free on the classes of $f_1, \ldots, f_c$  
and that the differential $(I/I^2)_a \to \bigoplus A_a\text{d}x_i$
has a left inverse. Hence $R \to A_a$ is smooth by definition and
Algebra, Lemma \ref{algebra-lemma-localize-NL}. The converse
follows immediately from
Lemma \ref{lemma-find-strictly-standard}.
\end{proof}

\begin{example}
\label{example-not-quasi-compact}
The set of points where a finitely presented ring map is smooth
needn't be a quasi-compact open. For example, let
$R = k[x, y_1, y_2, y_3, \ldots]/(xy_i)$ and $A = R/(x)$.
Then the smooth locus of $\Spec(A) \to \Spec(R)$ is
$\bigcup D(y_i)$ which is not quasi-compact.
\end{example}





\section{The lifting lemma}
\label{section-lifting}

\noindent
Here is a fiendishly clever lemma.

\begin{lemma}
\label{lemma-lifting}
Let $R \to \Lambda$ be a ring map with $R$ Noetherian.
Let $\pi \in R$ and assume that
$\text{Ann}_R(\pi) = \text{Ann}_R(\pi^2)$ and
$\text{Ann}_\Lambda(\pi) = \text{Ann}_\Lambda(\pi^2)$.
Suppose we have $R/\pi^2R \to \bar C \to \Lambda/\pi^2\Lambda$
with $\bar C$ of finite presentation over $R$. Then there exist ring maps
$R \to D \to \Lambda$ and a commutative diagram
$$
\xymatrix{
R/\pi^2R \ar[r] \ar[d] &
\bar C \ar[r] \ar[d] &
\Lambda/\pi^2\Lambda \ar[d] \\
R/\pi R \ar[r] &
D/\pi D \ar[r] &
\Lambda/\pi \Lambda
}
$$
such that $D$ is of finite presentation over $R$ and such that
$\Spec(D) \to \Spec(R)$ is smooth over $D(\pi)$ as well
as any point of $\Spec(D/\pi D)$ lying over a point of $\Spec(\bar C)$
where $\Spec(\bar C) \to \Spec(R/\pi^2 R)$ is smooth.
\end{lemma}

\begin{proof}
We choose a presentation
$$
\bar C = R[x_1, \ldots, x_n]/(f_1, \ldots, f_m)
$$
We also denote $I = (f_1, \ldots, f_m)$ and $\bar I$ the image of
$I$ in $R/\pi^2R[x_1, \ldots, x_n]$. Since $R$ is Noetherian, so is
$\bar C$. Hence the smooth locus of $\Spec(\bar C) \to \Spec(R/\pi^2R)$
is quasi-compact, see
Topology, Lemma \ref{topology-lemma-Noetherian}.
Applying
Lemma \ref{lemma-find-strictly-standard}
we may choose a finite list of elements
$a_1, \ldots, a_r \in R[x_1, \ldots, x_n]$ such that
\begin{enumerate}
\item the union of the open subspaces
$\Spec(\bar C_{a_k}) \subset \Spec(\bar C)$
cover the smooth locus of $\Spec(\bar C) \to \Spec(R/\pi^2R)$, and
\item for each $k = 1, \ldots, r$ there exists a finite subset
$E_k \subset \{1, \ldots, m\}$ such that
$(\bar I/\bar I^2)_{a_k}$ is freely generated by the classes of
$f_j$, $j \in E_k$.
\end{enumerate}
Set $I_k = (f_j, j \in E_k) \subset I$ and denote $\bar I_k$ the
image of $I_k$ in $R/\pi^2R[x_1, \ldots, x_n]$.
By (2) and Nakayama's lemma we see that $(\bar I/\bar I_k)_{a_k}$
is annihilated by $1 + b'_k$ for some $b'_k \in \bar I_{a_k}$.
Suppose $b'_k$ is the image of $b_k/(a_k)^N$ for some $b_k \in I$
and some integer $N$. After replacing $a_k$ by $a_kb_k$ we get
\begin{enumerate}
\item[(3)] $(\bar I_k)_{a_k} = (\bar I)_{a_k}$.
\end{enumerate}
Thus, after possibly replacing $a_k$ by a high power, we may write
\begin{enumerate}
\item[(4)]
$a_k f_\ell = \sum\nolimits_{j \in E_k} h_{k, \ell}^jf_j + \pi^2 g_{k, \ell}$
\end{enumerate}
for any $\ell \in \{1, \ldots, m\}$ and some
$h_{i, \ell}^j, g_{i, \ell} \in R[x_1, \ldots, x_n]$.
If $\ell \in E_k$ we choose $h_{k, \ell}^j = a_k\delta_{\ell, j}$
(Kronecker delta) and $g_{k, \ell} = 0$. Set
$$
D = R[x_1, \ldots, x_n, z_1, \ldots, z_m]/
(f_j - \pi z_j, p_{k, \ell}).
$$
Here $j \in \{1, \ldots, m\}$, $k \in \{1, \ldots, r\}$,
$\ell \in \{1, \ldots, m\}$, and
$$
p_{k, \ell} = a_k z_\ell - \sum\nolimits_{j \in E_k} h_{k, \ell}^j z_j
- \pi g_{k, \ell}.
$$
Note that for $\ell \in E_k$ we have $p_{k, \ell} = 0$ by our choices above.

\medskip\noindent
The map $R \to D$ is the given one.
Say $\bar C \to \Lambda/\pi^2\Lambda$ maps $x_i$
to the class of $\lambda_i$ modulo $\pi^2$. For an element
$f \in R[x_1, \ldots, x_n]$ we denote $f(\lambda) \in \Lambda$
the result of subsituting $\lambda_i$ for $x_i$. Then we know that
$f_j(\lambda) = \pi^2 \mu_j$ for some $\mu_j \in \Lambda$.
Define $D \to \Lambda$ by the rules $x_i \mapsto \lambda_i$ and
$z_j \mapsto \pi\mu_j$. This is well defined because
\begin{align*}
p_{k, \ell} & \mapsto
a_k(\lambda) \pi \mu_\ell -
\sum\nolimits_{j \in E_k} h_{k, \ell}^j(\lambda) \pi \mu_j
- \pi g_{k, \ell}(\lambda) \\
& =
\pi\left(a_k(\lambda) \mu_\ell -
\sum\nolimits_{j \in E_k} h_{k, \ell}^j(\lambda) \mu_j
- g_{k, \ell}(\lambda)\right)
\end{align*}
Substituting $x_i = \lambda_i$ in (4) above we see that the expression
inside the brackets is annihilated by $\pi^2$, hence it is annihilated
by $\pi$ as we have assumed
$\text{Ann}_\Lambda(\pi) = \text{Ann}_\Lambda(\pi^2)$.
The map $\bar C \to D/\pi D$ is determined by $x_i \mapsto x_i$
(clearly well defined). Thus we are done if we can prove the statement
about smoothness of $R \to D$.

\medskip\noindent
Using (4) we obtain the following key equality
\begin{align*}
\pi p_{k, \ell} & =
\pi a_k z_\ell - \sum\nolimits_{j \in E_k} \pi h_{k, \ell}^jz_j
- \pi^2 g_{k, \ell} \\
& =
- a_k (f_\ell - \pi z_\ell) + a_k f_\ell +
\sum\nolimits_{j \in E_k} h_{k, \ell}^j (f_j - \pi z_j) -
\sum\nolimits_{j \in E_k} h_{k, \ell}^j f_j - \pi^2 g_{k, \ell} \\
& =
-a_k(f_\ell - \pi z_\ell) +
\sum\nolimits_{j \in E_k} h_{k, \ell}^j(f_j - \pi z_j)
\end{align*}
The end result is an element of the ideal generated by $f_j - \pi z_j$.
In particular, we see that $D[1/\pi]$ is isomorphic to
$R[1/\pi][x_1, \ldots, x_n, z_1, \ldots, z_m]/(f_j - \pi z_j)$
which is isomorphic to $R[1/\pi][x_1, \ldots, x_n]$ hence smooth
over $R$.

\medskip\noindent
For fixed $k \in \{1, \ldots, r\}$ consider the ring
$$
D_k = R[x_1, \ldots, x_n, z_1, \ldots, z_m]/
(f_j - \pi z_j, j \in E_k, p_{k, \ell})
$$
The number of equations is $m = |E_k| + (m - |E_k|)$ as $p_{k, \ell}$
is zero if $\ell \in E_k$. Also, note that
\begin{align*}
(D_k/\pi D_k)_{a_k}
& =
R/\pi R[x_1, \ldots, x_n, 1/a_k, z_1, \ldots, z_m]/
(f_j, j \in E_k, p_{k, \ell}) \\
& =
(\bar C/\pi \bar C)_{a_k}[z_1, \ldots, z_m]/
(a_kz_\ell - \sum\nolimits_{j \in E_k} h_{k, \ell}^j z_j) \\
& \cong
(\bar C/\pi \bar C)_{a_k}[z_j, j \in E_k]
\end{align*}
Note that $(\bar C/\pi \bar C)_{a_k}$ is smooth over $R/\pi R$
of relative dimension $n - |E_k|$, see (2). Hence for a prime
$\mathfrak q_k \subset D_k$ containing $\pi$ and lying over
$\Spec(\bar C_{a_k})$ the morphism $\Spec(D_k) \to \Spec(R)$
has a smooth fibre of dimension $n$. Thus $R \to D_k$ is syntomic
at $\mathfrak q_k$ by our count of the number of equations above, see
Algebra, Lemmas \ref{algebra-lemma-localize-relative-complete-intersection}.
Hence $R \to D_k$ is smooth at $\mathfrak q_k$, see
Algebra, Lemma \ref{algebra-lemma-flat-fibre-smooth}.

\medskip\noindent
To finish the proof, let $\mathfrak q \subset D$ be a prime
containing $\pi$ and mapping to a smooth point of
$\Spec(\bar C) \to \Spec(R/\pi^2 R)$. Then $a_k \not \in \mathfrak q$
for some $k$ by (1). We will show that the surjection $D_k \to D$ induces
an isomorphism on local rings at $\mathfrak q$. Since we know that
$R \to D_k$ is smooth at the corresponding prime $\mathfrak q_k$
by the preceding paragraph this will finish the proof.

\medskip\noindent
First, note that for any $\ell$ the equation
$\pi p_{k, \ell} = -a_k(f_\ell - \pi z_\ell) +
\sum_{j \in E_k} h_{k, \ell}^j (f_j - \pi z_j)$ proved above shows that
$f_\ell - \pi z_\ell$ maps to zero in $(D_k)_{a_k}$ and in particular
in $(D_k)_{\mathfrak q_k}$.
The relations (4) imply that $a_k f_\ell =
\sum_{j \in E_k} h_{k, \ell}^j f_j$ in $I/I^2$.
Since $(\bar I_k/\bar I_k^2)_{a_k}$ is free on $f_j$, $j \in E_k$
we see that
$$
a_{k'} h_{k, \ell}^j -
\sum\nolimits_{j' \in E_{k'}} h_{k', \ell}^{j'} h_{k, j'}^j
$$
is zero in $\bar C_{a_k}$ for every $k, k', \ell$ and $j \in E_k$.
Hence we can find a large integer $N$ such that
$$
a_k^N\left(
a_{k'} h_{k, \ell}^j -
\sum\nolimits_{j' \in E_{k'}} h_{k', \ell}^{j'} h_{k, j'}^j
\right)
$$
is in $I_k + \pi^2R[x_1, \ldots, x_n]$. Computing modulo $\pi$ we have
\begin{align*}
&
a_kp_{k', \ell} - a_{k'}p_{k, \ell} + \sum h_{k', \ell}^{j'} p_{k, j'}
\\
&
=
- a_k \sum h_{k', \ell}^{j'} z_{j'}
+ a_{k'} \sum h_{k, \ell}^j z_j
+ \sum h_{k', \ell}^{j'} a_k z_{j'}
- \sum \sum h_{k', \ell}^{j'} h_{k, j'}^j z_j \\
&
=
\sum \left(
a_{k'} h_{k, \ell}^j
- \sum h_{k', \ell}^{j'} h_{k, j'}^j
\right) z_j
\end{align*}
with Einstein summation convention. Combining with the above we see
$a_k^{N + 1} p_{k', \ell}$ is contained in the ideal generated
by $I_k$ and $\pi$ in $R[x_1, \ldots, x_n, z_1, \ldots, z_m]$.
Thus $p_{k', \ell}$ maps into $\pi (D_k)_{a_k}$. On the other hand,
the equation
$$
\pi p_{k', \ell} =
-a_{k'} (f_\ell - \pi z_\ell) +
\sum\nolimits_{j' \in E_{k'}} h_{k', \ell}^{j'}(f_{j'} - \pi z_{j'})
$$
shows that $\pi p_{k', \ell}$ is zero in $(D_k)_{a_k}$.
Since we have assumed that $\text{Ann}_R(\pi) = \text{Ann}_R(\pi^2)$
and since $(D_k)_{\mathfrak q_k}$ is smooth hence flat over $R$
we see that
$\text{Ann}_{(D_k)_{\mathfrak q_k}}(\pi) =
\text{Ann}_{(D_k)_{\mathfrak q_k}}(\pi^2)$.
We conclude that $p_{k', \ell}$ maps to zero as well, hence
$D_{\mathfrak q} = (D_k)_{\mathfrak q_k}$ and we win.
\end{proof}











\input{chapters}

\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}
