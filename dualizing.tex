\input{preamble}

% OK, start here.
%
\begin{document}

\title{Dualizing Complexes}


\maketitle

\phantomsection
\label{section-phantom}

\tableofcontents

\section{Introduction}
\label{section-introduction}

\noindent
A reference is the book \cite{R+D}.

\medskip\noindent
The goals of this chapter are the following:
\begin{enumerate}
\item Define what it means to have a dualizing complex $\omega_A^\bullet$
over a Noetherian ring $A$, namely
\begin{enumerate}
\item we have $\omega_A^\bullet \in D^{+}(A)$,
\item the cohomology modules $H^i(\omega_A^\bullet)$ are
all finite $A$-modules,
\item $\omega_A^\bullet$ has finite injective dimension, and
\item we have $A \to R\Hom_A(\omega_A^\bullet, \omega_A^\bullet)$
is a quasi-isomorphism.
\end{enumerate}
\item List elementary properties of dualizing complexes.
\item Show a dualizing complex gives rise to a dimension function.
\item Show a dualizing complex gives rise to a good notion of a
reflexive hull.
\item Prove the finiteness theorem when a dualizing complex exists.
\end{enumerate}






\section{Essential surjections and injections}
\label{section-essential}

\noindent
We will mostly work in categories of modules, but we may as well make
the definition in general.

\begin{definition}
\label{definition-essential}
Let $\mathcal{A}$ be an abelian category.
\begin{enumerate}
\item An injection $A \subset B$ of $\mathcal{A}$ is {\it essential},
or we say that $B$ is an {\it essential extension of} $A$,
if every nonzero subobject $B' \subset B$ has nonzero intersection with $A$.
\item A surjection $f : A \to B$ of $\mathcal{A}$ is {\it essential}
if for every proper subobject $A' \subset A$ we have $f(A') \not = B$.
\end{enumerate}
\end{definition}

\noindent
Some lemmas about this notion.

\begin{lemma}
\label{lemma-essential}
Let $\mathcal{A}$ be an abelian category.
\begin{enumerate}
\item If $A \subset B$ and $B \subset C$ are essential extensions, then
$A \subset C$ is an essential extension.
\item If $A \subset B$ is an essential extension and $C \subset B$
is a subobject, then $A \cap C \subset C$ is an essential extension.
\item If $A \to B$ and $B \to C$ are essential surjections, then
$A \to C$ is an essential surjection.
\item Given an essential surjection $f : A \to B$ and a surjection
$A \to C$ with kernel $K$, the morphism $C \to B/f(K)$ is an essential
surjection.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-union-essential-extensions}
Let $R$ be a ring. Let $M$ be an $R$-module. Let $E = \colim E_i$
be a filtered colimit of $R$-modules. Suppose given a compatible
system of essential injections $M \to E_i$ of $R$-modules.
Then $M \to E$ is an essential extension of $M$.
\end{lemma}

\begin{proof}
Immediate from the definitions and the fact that filtered
colimits are exact (Algebra, Lemma \ref{algebra-lemma-directed-colimit-exact}).
\end{proof}

\begin{lemma}
\label{lemma-essential-extension}
Let $R$ be a ring. Let $M \subset N$ be $R$-modules. The following
are equivalent
\begin{enumerate}
\item $M \subset N$ is an essential extension,
\item for all $x \in N$ there exists an $f \in R$ such that $fx \in M$
and $fx \not = 0$.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume (1) and let $x \in N$ be a nonzero element. By (1) we have
$Rx \cap M \not = 0$. This implies (2).

\medskip\noindent
Assume (2). Let $N' \subset N$ be a nonzero submodule. Pick $x \in N'$
nonzero. By (2) we can find $f \in $ with $fx \in N$ and $fx \not = 0$.
Thus $N' \cap M \not = 0$.
\end{proof}




\section{Injective modules}
\label{section-injective-modules}

\noindent
Some results about injective modules over rings.

\begin{lemma}
\label{lemma-product-injectives}
Let $R$ be a ring. Any product of injective $R$-modules is injective.
\end{lemma}

\begin{proof}
Special case of Homology, Lemma \ref{homology-lemma-product-injectives}.
\end{proof}

\begin{lemma}
\label{lemma-injective-flat}
Let $R \to S$ be a flat ring map. If $E$ is an injective $S$-module,
then $E$ is injective as an $R$-module.
\end{lemma}

\begin{proof}
This is true because $\Hom_R(M, E) = \Hom_S(M \otimes_R S, E)$
by Algebra, Lemma \ref{algebra-lemma-adjoint-tensor-restrict}
and the fact that tensoring with $S$ is exact.
\end{proof}

\begin{lemma}
\label{lemma-injective-epimorphism}
Let $R \to S$ be an epimorphism of rings. Let $E$ be an $S$-module.
If $E$ is injective as an $R$-module, then $E$ is an injective $S$-module.
\end{lemma}

\begin{proof}
This is true because $\Hom_R(N, E) = \Hom_S(N, E)$ for any $S$-module $N$,
see Algebra, Lemma \ref{algebra-lemma-epimorphism-modules}.
\end{proof}

\begin{lemma}
\label{lemma-hom-injective}
Let $R \to S$ be a ring map. If $E$ is an injective $R$-module,
then $\Hom_R(S, E)$ is an injective $S$-module.
\end{lemma}

\begin{proof}
This is true because $\Hom_S(N, \Hom_R(S, E)) = \Hom_R(N, E)$ by
Algebra, Lemma \ref{algebra-lemma-adjoint-hom-restrict}.
\end{proof}

\begin{lemma}
\label{lemma-essential-extensions-in-injective}
Let $R$ be a ring. Let $I$ be an injective $R$-module. Let $E \subset I$
be a submodule. The following are equivalent
\begin{enumerate}
\item $E$ is injective, and
\item for all $E \subset E' \subset I$ with $E \subset E'$ essential
we have $E = E'$.
\end{enumerate}
In particular, an $R$-module is injective if and only if every essential
extension is trivial.
\end{lemma}

\begin{proof}
The final assertion follows from the first and the fact that the
category of $R$-modules has enough injectives
(More on Algebra, Section \ref{more-algebra-section-injectives-modules}).

\medskip\noindent
Assume (1). Let $E \subset E' \subset I$ as in (2).
Then the map $\text{id}_E : E \to E$ can be extended
to a map $\alpha : E' \to E$. The kernel of $\alpha$ has to be
zero because it intersects $E$ trivially and $E'$ is an essential
extension. Hence $E = E'$.

\medskip\noindent
Assume (2). Let $M \subset N$ be $R$-modules and let $\varphi : M \to E$
be an $R$-module map. In order to prove (1) we have to show that
$\varphi$ extends to a morphism $N \to E$. Consider the set $\mathcal{S}$
of pairs
$(M', \varphi')$ where $M \subset M' \subset N$ and $\varphi' : M' \to E$
is an $R$-module map agreeing with $\varphi$ on $M$. We define an ordering
on $\mathcal{S}$ by the rule $(M', \varphi') \leq (M'', \varphi'')$
if and only if $M' \subset M''$ and $\varphi''|_{M'} = \varphi'$.
It is clear that we can take the maximum of a totally ordered subset
of $\mathcal{S}$. Hence by Zorn's lemma we may assume $(M, \varphi)$
is a maximal element.

\medskip\noindent
Choose an extension $\psi : N \to I$ of $\varphi$ composed
with the inclusion $E \to I$. This is possible as $I$ is injective.
If $\psi(N) \subset E$, then $\psi$ is the desired extension.
If $\psi(N)$ is not contained in $E$, then by (2) the inclusion
$E \subset E + \psi(N)$ is not essential. hence
we can find a nonzero submodule $K \subset E + \psi(N)$ meeting $E$ in $0$.
This means that $M' = \psi^{-1}(E + K)$ strictly contains $M$.
Thus we can extend $\varphi$ to $M'$ using
$$
M' \xrightarrow{\psi|_{M'}} E + K \to (E + K)/K = E
$$
This contradicts the maximality of $(M, \varphi)$.
\end{proof}

\begin{example}
\label{example-reduced-ring-injective}
Let $R$ be a reduced ring. Let $\mathfrak p \subset R$ be a minimal prime
so that $K = R_\mathfrak p$ is a field
(Algebra, Lemma \ref{algebra-lemma-minimal-prime-reduced-ring}).
Then $K$ is an injective $R$-module. Namely, we have
$\Hom_R(M, K) = \Hom_K(M_\mathfrak p, K)$ for any $R$-module
$M$. Since localization is an exact functor and taking duals is
an exact functor on $K$-vector spaces we conclude $\Hom_R(-, K)$
is an exact functor, i.e., $K$ is an injective $R$-module.
\end{example}

\begin{lemma}
\label{lemma-characterize-injective}
Let $R$ be a ring. Let $E$ be an $R$-module. The following are equivalent
\begin{enumerate}
\item $E$ is an injective $R$-module, and
\item given an ideal $I \subset R$ and a module map $\varphi : I \to E$
there exists an extension of $\varphi$ to and $R$-module map $R \to E$.
\end{enumerate}
\end{lemma}

\begin{proof}
The implication (1) $\Rightarrow$ (2) follows from the definitions.
Thus we assume (2) holds and we prove (1).
First proof: Since $R$ is a generator for the category of $R$-modules,
this follows from
Injectives, Lemma \ref{injectives-lemma-characterize-injective}.

\medskip\noindent
Second proof: We have to show that every essential extension $E \subset E'$
is trivial. Pick $x \in E'$ and set $I = \{f \in R \mid fx \in E\}$.
The map $I \to E$, $f \mapsto fx$ extends to $\psi : R \to E$ by (2).
Then $x' = x - \psi(1)$ is an element of $E'$ whose annihilator in
$E'/E$ is $I$ and which is annihilated by $I$ as an element of $E'$.
Thus $Rx' = (R/I)x'$ does not intersect $E$. Since $E \subset E'$
is an essential extension it follows that $x' \in E$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-sum-injective-modules}
Let $R$ be a Noetherian ring. A direct sum of injective modules
is injective.
\end{lemma}

\begin{proof}
Let $E_i$ be a family of injective modules parametrized by a set $I$.
Set $E = \bigcup E_i$. To show that $E$ is injective we use
Lemma \ref{lemma-characterize-injective}.
Thus let $\varphi : I \to E$ be a module map from an ideal of $R$
into $E$. As $I$ is a finite $R$-module (because $R$ is Noetherian)
we can find finitely many elements $i_1, \ldots, i_r \in I$
such that $\varphi$ maps into $\bigcup_{j = 1, \ldots, r} E_{i_j}$.
Then we can extend $\varphi$ into $\bigcup_{j = 1, \ldots, r} E_{i_j}$
using the injectivity of the modules $E_{i_j}$.
\end{proof}

\begin{lemma}
\label{lemma-localization-injective-modules}
Let $R$ be a Noetherian ring. Let $S \subset R$ be a multiplicative
subset. If $E$ is an injective $R$-module, then $S^{-1}E$ is an
injective $S^{-1}R$-module.
\end{lemma}

\begin{proof}
Since $R \to S^{-1}R$ is an epimorphism of rings, it suffices
to show that $S^{-1}E$ is injective as an $R$-module, see
Lemma \ref{lemma-injective-epimorphism}.
To show this we use Lemma \ref{lemma-characterize-injective}.
Thus let $I \subset R$ be an ideal and let
$\varphi : I \to S^{-1} E$ be an $R$-module map.
As $I$ is a finitely presented $R$-module (because $R$ is Noetherian)
we can find find an $f \in S$ and an $R$-module map $I \to E$
such that $f\varphi$ is the composition $I \to E \to S^{-1}E$
(Algebra, Lemma \ref{algebra-lemma-hom-from-finitely-presented}).
Then we can extend $I \to E$ to a homomorphism $R \to E$.
Then the composition
$$
R \to E \to S^{-1}E \xrightarrow{f^{-1}} S^{-1}E
$$
is the desired extension of $\varphi$ to $R$.
\end{proof}

\begin{lemma}
\label{lemma-injective-module-divide}
Let $R$ be a Noetherian ring. Let $I$ be an injective $R$-module.
\begin{enumerate}
\item Let $f \in R$. Then $E = \bigcup I[f^n] = I[f^\infty]$
is an injective submodule of $I$.
\item Let $J \subset R$ be an ideal. Then the $J$-power torsion
submodule $I[J^\infty]$ is an injective submodule of $I$.
\end{enumerate}
\end{lemma}

\begin{proof}
We will use Lemma \ref{lemma-essential-extensions-in-injective}
to prove (1).
Suppose that $E \subset E' \subset I$ and that $E'$ is an essential
extension of $E$. We will show that $E' = E$. If not, then we can
find $x \in E'$ and $x \not \in E$. Let $J = \{a \in R \mid ax \in E'\}$.
Since $R$ is Noetherian we can choose $x$ with $J$ maximal.
Since $R$ is Noetherian we can write $J = (g_1, \ldots, g_t)$ for some
$g_i \in R$. Say $f^{n_i}$ annihilates $g_ix$. Set $n = \max\{n_i\}$.
Then $x' = f^n x$ is an element of $E'$ not in $E$ and is annihilated
by $J$. By maximality of $J$ we see that $R x' = (R/J)x'  \cap E = (0)$.
Hence $E'$ is not an essential extension of $E$ a contradiction.

\medskip\noindent
To prove (2) write $J = (f_1, \ldots, f_t)$. Then
$I[J^\infty]$ is equal to
$$
(\ldots((I[f_1^\infty])[f_2^\infty])\ldots)[f_t^\infty]
$$
and the result follows from (1) and induction.
\end{proof}

\begin{lemma}
\label{lemma-injective-dimension-over-polynomial-ring}
Let $A$ be a Noetherian ring. Let $E$ be an injective $A$-module.
Then $E \otimes_A A[x]$ has injective-amplitude $[0, 1]$
as an object of $D(A[x])$. In particular, $E \otimes_A A[x]$
has finite injective dimension as an $A[x]$-module.
\end{lemma}

\begin{proof}
Let us write $E[x] = E \otimes_A A[x]$. Consider the short exact
sequence of $A[x]$-modules
$$
0 \to E[x] \to \Hom_A(A[x], E[x]) \to \Hom_A(A[x], E[x]) \to 0
$$
where the first map sends $p \in E[x]$ to $f \mapsto fp$ and the
second map sends $\varphi$ to $f \mapsto \varphi(xf) - x\varphi(f)$.
The second map is surjective because
$\Hom_A(A[x], E[x]) = \prod_{n \geq 0} E[x]$ as an abelian group and
the map sends $(e_n)$ to $(e_{n + 1} - xe_n)$ which is surjective.
As an $A$-module we have $E[x] \cong \bigoplus_{n \geq 0} E$
which is injective by Lemma \ref{lemma-sum-injective-modules}.
Hence the $A[x]$-module $\Hom_A(A[x], I[x])$ is injective by
Lemma \ref{lemma-hom-injective} and the proof is complete.
\end{proof}



\section{Projective covers}
\label{section-projective-cover}

\noindent
In this section we briefly discuss projective covers.

\begin{definition}
\label{definition-projective-cover}
Let $R$ be a ring. A surjection $P \to M$ of $R$-modules is said
to be a {\it projective cover}, or sometimes a {\it projective envelope},
if $P$ is a projective $R$-module and $P \to M$ is an essential
surjection.
\end{definition}

\noindent
Projective covers do not always exist. For example, if $k$ is a field
and $R = k[x]$ is the polynomial ring over $k$, then the module $M = R/(x)$
does not have a projective cover. Namely, for any surjection $f : P \to M$
with $P$ projective over $R$, the proper submodule $(x - 1)P$ surjects
onto $M$. Hence $f$ is not essential.

\begin{lemma}
\label{lemma-projective-cover-unique}
Let $R$ be a ring and let $M$ be an $R$-module. If a projective cover
of $M$ exists, then it is unique up to isomorphism.
\end{lemma}

\begin{proof}
Let $P \to M$ and $P' \to M$ be projective covers. Because $P$ is a
projective $R$-module and $P' \to M$ is surjective, we can find an
$R$-module map $\alpha : P \to P'$ compatible with the maps to $M$.
Since $P' \to M$ is essential, we see that $\alpha$ is surjective.
As $P'$ is a projective $R$-module we can choose a direct sum decomposition
$P = \Ker(\alpha) \oplus P'$. Since $P' \to M$ is surjective
and since $P \to M$ is essential we conclude that $\Ker(\alpha)$
is zero as desired.
\end{proof}

\noindent
Here is an example where projective covers exist.

\begin{lemma}
\label{lemma-projective-covers-local}
Let $(R, \mathfrak m, \kappa)$ be a local ring. Any finite $R$-module has
a projective cover.
\end{lemma}

\begin{proof}
Let $M$ be a finite $R$-module. Let $r = \dim_\kappa(M/\mathfrak m M)$.
Choose $x_1, \ldots, x_r \in M$ mapping to a basis of $M/\mathfrak m M$.
Consider the map $f : R^{\oplus r} \to M$. By Nakayama's lemma this is
a surjection (Algebra, Lemma \ref{algebra-lemma-NAK}). If
$N \subset R^{\oplus R}$ is a proper submodule, then
$N/\mathfrak m N \to \kappa^{\oplus r}$ is not surjective (by
Nakayama's lemma again) hence $N/\mathfrak m N \to M/\mathfrak m M$
is not surjective. Thus $f$ is an essential surjection.
\end{proof}







\section{Injective hulls}
\label{section-injective-hull}

\noindent
In this section we briefly discuss injective hulls.

\begin{definition}
\label{definition-injective-hull}
Let $R$ be a ring. A injection $M \to I$ of $R$-modules is said
to be an {\it injective hull} if $I$ is a injective $R$-module and
$M \to I$ is an essential injection.
\end{definition}

\noindent
Injective hulls always exist.

\begin{lemma}
\label{lemma-injective-hull}
Let $R$ be a ring. Any $R$-module has an injective hull.
\end{lemma}

\begin{proof}
Let $M$ be an $R$-module. By
More on Algebra, Section \ref{more-algebra-section-injectives-modules}
the category of $R$-modules has enough injectives.
Choose an injection $M \to I$ with $I$ an injective $R$-module.
Consider the set $\mathcal{S}$ of submodules $M \subset E \subset I$
such that $E$ is an essential extension of $M$. We order $\mathcal{S}$
by inclusion. If $\{E_\alpha\}$ is a totally ordered subset
of $\mathcal{S}$, then $\bigcup E_\alpha$ is an essential extension of $M$
too (Lemma \ref{lemma-union-essential-extensions}).
Thus we can apply Zorn's lemma and find a maximal element
$E \in \mathcal{S}$. We claim $M \subset E$ is an injective hull, i.e.,
$E$ is an injective $R$-module. This follows from
Lemma \ref{lemma-essential-extensions-in-injective}.
\end{proof}

\begin{lemma}
\label{lemma-injective-hull-unique}
Let $R$ be a ring. Let $M$, $N$ be $R$-modules and let $M \to E$
and $N \to E'$ be injective hulls. Then
\begin{enumerate}
\item for any $R$-module map $\varphi : M \to N$ there exists an
$R$-module map $\psi : E \to E'$ such that
$$
\xymatrix{
M \ar[r] \ar[d]_\varphi & E \ar[d]^\psi \\
N \ar[r] & E'
}
$$
commutes,
\item if $\varphi$ is injective, then $\psi$ is injective,
\item if $\varphi$ is an essential injection, then $\psi$ is an isomorphism,
\item if $\varphi$ is an isomorphism, then $\psi$ is an isomorphism,
\item if $M \to I$ is an embedding of $M$ into an injective $R$-module,
then there is an isomorphism $I \cong E \oplus I'$ compatible with
the embeddings of $M$,
\end{enumerate}
In particular, the injective hull $E$ of $M$ is unique up to isomorphism.
\end{lemma}

\begin{proof}
Part (1) follows from the fact that $E'$ is an injective $R$-module.
Part (2) follows as $\Ker(\psi) \cap M = 0$
and $E$ is an essential extension of $M$.
Assume $\varphi$ is an essential injection. Then
$E \cong \psi(E) \subset E'$ by (2) which implies
$E' = \psi(E) \oplus E''$ because $E$ is injective.
Since $E'$ is an essential extension of
$M$ (Lemma \ref{lemma-essential}) we get $E'' = 0$.
Part (4) is a special case of (3).
Assume $M \to I$ as in (5).
Choose a map $\alpha : E \to I$ extending the map $M \to I$.
Arguing as before we see that $\alpha$ is injective.
Thus as before $\alpha(E)$ splits off from $I$.
This proves (5).
\end{proof}

\begin{example}
\label{example-injective-hull-domain}
Let $R$ be a domain with fraction field $K$. Then $R \subset K$ is an
injective hull of $R$. Namely, by
Example \ref{example-reduced-ring-injective} we see that $K$ is an injective
$R$-module and by Lemma \ref{lemma-essential-extension} we see that
$R \subset K$ is an essential extension.
\end{example}

\begin{definition}
\label{definition-indecomposable}
An object $X$ of an additive category is called {\it indecomposable}
if it is nonzero and if $X = Y \oplus Z$, then either $Y = 0$ or $Z = 0$.
\end{definition}

\begin{lemma}
\label{lemma-indecomposable-injective}
Let $R$ be a ring. Let $E$ be an indecomposable injective $R$-module.
Then
\begin{enumerate}
\item $E$ is the injective hull of any nonzero submodule of $E$,
\item the intersection of any two nonzero submodules of $E$ is nonzero,
\item $\text{End}_R(E, E)$ is a noncommutative local ring with maximal
ideal those $\varphi : E \to E$ whose kernel is nonzero, and
\item the set of zerodivisors on $E$ is a prime ideal $\mathfrak p$ of $R$
and $E$ is an injective $R_\mathfrak p$-module.
\end{enumerate}
\end{lemma}

\begin{proof}
Part (1) follows from Lemma \ref{lemma-injective-hull-unique}.
Part (2) follows from part (1) and the definition of injective hulls.

\medskip\noindent
Proof of (3). Set $A = \text{End}_R(E, E)$ and
$I = \{\varphi \in A \mid \Ker(f) \not = 0\}$.
The statement means that $I$ is a two sided ideal and
that any $\varphi \in A$, $\varphi \not \in I$ is invertible.
Suppose $\varphi$ and $\psi$ are not injective.
Then $\Ker(\varphi) \cap \Ker(\psi)$ is nonzero
by (2). Hence $\varphi + \psi \in I$. It follows that $I$
is a two sided ideal. If $\varphi \in A$, $\varphi \not \in I$,
then $E \cong \varphi(E) \subset E$ is an injective submodule,
hence $E = \varphi(E)$ because $E$ is indecomposable.

\medskip\noindent
Proof of (4). Consider the ring map $R \to A$ and let $\mathfrak p \subset R$
be the inverse image of the maximal ideal $I$. Then it is clear
that $\mathfrak p$ is a prime ideal and that $R \to A$ extends to
$R_\mathfrak p \to A$. Thus $E$ is an $R_\mathfrak p$-module.
It follows from Lemma \ref{lemma-injective-epimorphism} that $E$ is injective
as an $R_\mathfrak p$-module.
\end{proof}

\begin{lemma}
\label{lemma-injective-hull-indecomposable}
Let $\mathfrak p \subset R$ be a prime of a ring $R$.
Let $E$ be the injective hull of $R/\mathfrak p$. Then
\begin{enumerate}
\item $E$ is indecomposable,
\item $E$ is the injective hull of $\kappa(\mathfrak p)$,
\item $E$ is the injective hull of $\kappa(\mathfrak p)$
over the ring $R_\mathfrak p$.
\end{enumerate}
\end{lemma}

\begin{proof}
As $R/\mathfrak p \subset \kappa(\mathfrak p)$ we can extend the embedding
to a map $\kappa(\mathfrak p) \to E$. Hence (2) holds.
For $f \in R$, $f \not \in \mathfrak p$
the map $f : \kappa(\mathfrak p) \to \kappa(\mathfrak p)$ is an isomorphism
hence the map $f : E \to E$ is an isomorphism,
see Lemma \ref{lemma-injective-hull-unique}.
Thus $E$ is an $R_\mathfrak p$-module. It is injective
as an $R_\mathfrak p$-module by Lemma \ref{lemma-injective-epimorphism}.
Finally, let $E' \subset E$ be a nonzero injective $R$-submodule.
Then $J = (R/\mathfrak p) \cap E'$ is nonzero. After shrinking $E'$
we may assume that $E'$ is the injective hull of $J$ (see
Lemma \ref{lemma-injective-hull-unique} for example).
Observe that $R/\mathfrak p$ is an essential extension of $J$ for example by
Lemma \ref{lemma-essential-extension}. Hence $E' \to E$
is an isomorphism by Lemma \ref{lemma-injective-hull-unique} part (3).
Hence $E$ is indecomposable.
\end{proof}

\begin{lemma}
\label{lemma-indecomposable-injective-noetherian}
Let $R$ be a Noetherian ring. Let $E$ be an indecomposable injective
$R$-module. Then there exists a prime ideal $\mathfrak p$ of $R$ such that
$E$ is the injective hull of $\kappa(\mathfrak p)$.
\end{lemma}

\begin{proof}
Let $\mathfrak p$ be the prime ideal found in
Lemma \ref{lemma-indecomposable-injective}.
Say $\mathfrak p = (f_1, \ldots, f_r)$.
Pick a nonzero element $x \in \bigcap \Ker(f_i : E \to E)$,
see Lemma \ref{lemma-indecomposable-injective}.
Then $(R_\mathfrak p)x$ is a module isomorphic to $\kappa(\mathfrak p)$
inside $E$. We conclude by Lemma \ref{lemma-indecomposable-injective}.
\end{proof}

\begin{proposition}[Structure injective modules over Noetherian rings]
\label{proposition-structure-injectives-noetherian}
Let $R$ be a Noetherian ring.
Every injective module is a direct sum of indecomposable injective modules.
Every indecomposable injective module is the injective hull of
the residue field at a prime.
\end{proposition}

\begin{proof}
The second statement is Lemma \ref{lemma-indecomposable-injective-noetherian}.
For the second statement, let $I$ be an injective $R$-module.
We will use transfinite induction to construct $I_\alpha \subset I$
for ordinals $\alpha$ which are direct sums of indecomposable injective
$R$-modules $E_{\beta + 1}$ for $\beta < \alpha$.
For $\alpha = 0$ we let $I_0 = 0$. Suppose given an ordinal $\alpha$
such that $I_\alpha$ has been constructed. Then $I_\alpha$ is an
injective $R$-module by Lemma \ref{lemma-sum-injective-modules}.
Hence $I \cong I_\alpha \oplus I'$. If $I' = 0$ we are done.
If not, then $I'$ has an associated prime by
Algebra, Lemma \ref{algebra-lemma-ass-zero}.
Thus $I'$ contains a copy of $R/\mathfrak p$ for some prime $\mathfrak p$.
Hence $I'$ contains an indecomposable submodule $E$ by
Lemmas \ref{lemma-injective-hull-unique} and
\ref{lemma-injective-hull-indecomposable}. Set
$I_{\alpha + 1} = I_\alpha \oplus E_\alpha$.
If $\alpha$ is a limit ordinal and $I_\beta$ has been constructed
for $\beta < \alpha$, then we set
$I_\alpha = \bigcup_{\beta < \alpha} I_\beta$.
Observe that $I_\alpha = \bigoplus_{\beta < \alpha} E_{\beta + 1}$.
This concludes the proof.
\end{proof}



\section{Duality over Artinian local rings}
\label{section-artinian}

\noindent
Let $(R, \mathfrak m, \kappa)$ be an artinian local ring.
Recall that this implies $R$ is Noetherian and that $R$ has finite
length as an $R$-module. Moreover an $R$-module is finite if and
only if it has finite length. We will use these facts without
further mention in this section. Please see
Algebra, Sections \ref{algebra-section-length} and
\ref{algebra-section-artinian}
and
Algebra, Proposition \ref{algebra-proposition-dimension-zero-ring}
for more details.

\begin{lemma}
\label{lemma-finite}
Let $(R, \mathfrak m, \kappa)$ be an artinian local ring.
Let $E$ be an injective hull of $\kappa$. For every finite
$R$-module $M$ we have
$$
\text{length}_R(M) = \text{length}_R(\Hom_R(M, E))
$$
In particular, the injective hull $E$ of $\kappa$ is a finite $R$-module.
\end{lemma}

\begin{proof}
Because $E$ is an essential extension of $\kappa$ we have
$\kappa = E[\mathfrak m]$ where $E[\mathfrak m]$ is the
$\mathfrak m$-torsion in $E$ (notation as in More on Algebra, Section
\ref{more-algebra-section-formal-glueing}).
Hence $\Hom_R(\kappa, E) \cong \kappa$ and the equality of lengths
holds for $M = \kappa$. We prove the displayed equality of the lemma
by induction on the length of $M$. If $M$ is nonzero there exists a surjection
$M \to \kappa$ with kernel $M'$. Since the functor $M \mapsto \Hom_R(M, E)$
is exact we obtain a short exact sequence
$$
0 \to \Hom_R(\kappa, E) \to \Hom_R(M, E) \to \Hom_R(M', E) \to 0.
$$
Additivity of length for this sequence and the sequence
$0 \to M' \to M \to \kappa \to 0$ and the equality for $M'$ (induction
hypothesis) and $\kappa$ implies the equality for $M$.
The final statement of the lemma follows as $E = \Hom_R(R, E)$.
\end{proof}

\begin{lemma}
\label{lemma-evaluate}
Let $(R, \mathfrak m, \kappa)$ be an artinian local ring.
Let $E$ be an injective hull of $\kappa$.
For any finite $R$-module $M$ the evaluation map
$$
M \longrightarrow \Hom_R(\Hom_R(M, E), E)
$$
is an isomorphism. In particular $R = \Hom_R(E, E)$.
\end{lemma}

\begin{proof}
Observe that the displayed arrow is injective. Namely, if $x \in M$ is
a nonzero element, then there is a nonzero map $Rx \to \kappa$ which
we can extend to a map $\varphi : M \to E$ that doesn't vanish on $x$.
Since the source and target of the arrow have the same length by
Lemma \ref{lemma-finite}
we conclude it is an isomorphism. The final statement follows
on taking $M = R$.
\end{proof}

\noindent
To state the next lemma, denote $\text{Mod}^{fg}_R$ the category of finite
$R$-modules over a ring $R$.

\begin{lemma}
\label{lemma-duality}
Let $(R, \mathfrak m, \kappa)$ be an artinian local ring.
Let $E$ be an injective hull of $\kappa$.
The functor $D(-) = \Hom_R(-, E)$ induces an exact anti-equivalence
$\text{Mod}^{fg}_R \to \text{Mod}^{fg}_R$ and
$D \circ D \cong \text{id}$.
\end{lemma}

\begin{proof}
We have seen that $D \circ D = \text{id}$ on $\text{Mod}^{fg}_R$
in Lemma \ref{lemma-evaluate}. It follows immediately that
$D$ is an anti-equivalence.
\end{proof}

\begin{lemma}
\label{lemma-duality-torsion-cotorsion}
Assumptions and notation as in Lemma \ref{lemma-duality}.
Let $I \subset R$ be an ideal and $M$ a finite $R$-module.
Then
$$
D(M[I]) = D(M)/ID(M) \quad\text{and}\quad D(M/IM) = D(M)[I]
$$
\end{lemma}

\begin{proof}
Say $I = (f_1, \ldots, f_t)$. Consider the map
$$
M^{\oplus t} \xrightarrow{f_1, \ldots, f_t} M
$$
with cokernel $M/IM$. Applying the exact functor $D$ we conclude that
$D(M/IM)$ is $D(M)[I]$. The other case is proved in the same way.
\end{proof}



\section{Injective hull of the residue field}
\label{section-hull-residue-field}

\noindent
Most of our results will be for Noetherian local rings in this section.

\begin{lemma}
\label{lemma-quotient}
Let $R \to S$ be a surjective map of local rings with kernel $I$.
Let $E$ be the injective hull of the residue field of $R$ over $R$.
Then $E[I]$ is the injective hull of the residue field of $S$ over $S$.
\end{lemma}

\begin{proof}
Observe that $E[I] = \Hom_R(S, E)$ as $S = R/I$. Hence $E[I]$ is an injective
$S$-module by Lemma \ref{lemma-hom-injective}. Since $E$ is an essential
extension of $\kappa = R/\mathfrak m_R$ it follows that $E[I]$ is an
essential extension of $\kappa$ as well. The result follows.
\end{proof}

\begin{lemma}
\label{lemma-torsion-submodule-sum-injective-hulls}
Let $(R, \mathfrak m, \kappa)$ be a local ring.
Let $E$ be the injective hull of $\kappa$.
Let $M$ be a $\mathfrak m$-power torsion $R$-module
with $n = \dim_\kappa(M[\mathfrak m]) < \infty$.
Then $M$ is isomorphic to a submodule of $E^{\oplus n}$.
\end{lemma}

\begin{proof}
Observe that $E^{\oplus n}$ is the injective hull of
$\kappa^{\oplus n} = M[\mathfrak m]$. Thus there is an $R$-module map
$M \to E^{\oplus n}$ which is injective on $M[\mathfrak m]$.
Since $M$ is $\mathfrak m$-power torsion the inclusion
$M[\mathfrak m] \subset M$ is an essential extension
(for example by Lemma \ref{lemma-essential-extension})
we conclude that the kernel of $M \to E^{\oplus n}$ is zero.
\end{proof}

\begin{lemma}
\label{lemma-union-artinian}
Let $(R, \mathfrak m, \kappa)$ be a Noetherian local ring.
Let $E$ be an injective hull of $\kappa$ over $R$.
Let $E_n$ be an injective hull of $\kappa$ over $R/\mathfrak m^n$.
Then $E = \bigcup E_n$ and $E_n = E[\mathfrak m^n]$.
\end{lemma}

\begin{proof}
We have $E_n = E[\mathfrak m^n]$ by Lemma \ref{lemma-quotient}.
We have $E = \bigcup E_n$ because $\bigcup E_n = E[\mathfrak m^\infty]$
is an injective $R$-submodule which contains $\kappa$, see
Lemma \ref{lemma-injective-module-divide}.
\end{proof}

\noindent
The following lemma tells us the injective hull of the residue
field of a Noetherian local ring only depends on the completion.

\begin{lemma}
\label{lemma-compare}
Let $R \to S$ be a flat local homomorphism of local Noetherian rings
such that $R/\mathfrak m_R \cong S/\mathfrak m_R S$.
Then the injective hull of the residue field
of $R$ is the injective hull of the residue field of $S$.
\end{lemma}

\begin{proof}
Set $\kappa = R/\mathfrak m_R = S/\mathfrak m_S$.
Let $E_R$ be the injective hull of $\kappa$ over $R$.
Let $E_S$ be the injective hull of $\kappa$ over $S$.
Observe that $E_S$ is an injective $R$-module by
Lemma \ref{lemma-injective-flat}.
Choose an extension $E_R \to E_S$ of the identification of
residue fields. This map is an isomorphism by
Lemma \ref{lemma-union-artinian}
because $R \to S$ induces an isomorphism
$R/\mathfrak m_R^n \to S/\mathfrak m_S^n$ for all $n$.
\end{proof}

\begin{lemma}
\label{lemma-endos}
Let $(R, \mathfrak m, \kappa)$ be a Noetherian local ring.
Let $E$ be an injective hull of $\kappa$ over $R$. Then
$\Hom_R(E, E)$ is canonically isomorphic to the completion of $R$.
\end{lemma}

\begin{proof}
Write $E = \bigcup E_n$ with $E_n = E[\mathfrak m^n]$ as in
Lemma \ref{lemma-union-artinian}. Any endomorphism of $E$
preserves this filtration. Hence
$$
\Hom_R(E, E) = \lim \Hom_R(E_n, E_n)
$$
The lemma follows as
$\Hom_R(E_n, E_n) = \Hom_{R/\mathfrak m^n}(E_n, E_n) = R/\mathfrak m^n$
by Lemma \ref{lemma-evaluate}.
\end{proof}

\begin{lemma}
\label{lemma-injective-hull-has-dcc}
Let $(R, \mathfrak m, \kappa)$ be a Noetherian local ring.
Let $E$ be an injective hull of $\kappa$ over $R$. Then
$E$ satisfies the descending chain condition.
\end{lemma}

\begin{proof}
If $E \subset M_1 \subset M_2 \ldots$ is a sequence of submodules, then
$$
\Hom_R(E, E) \to \Hom_R(M_1, E) \to \Hom_R(M_2, E) \to \ldots
$$
is sequence of surjections. By Lemma \ref{lemma-endos} each of these is a
module over the completion $R^\wedge = \Hom_R(E, E)$.
Since $R^\wedge$ is Noetherian
(Algebra, Lemma \ref{algebra-lemma-completion-Noetherian-Noetherian})
the sequence stabilizes: $\Hom_R(M_n, E) = \Hom_R(M_{n + 1}, E) = \ldots$.
Since $E$ is injective, this can only happen if $\Hom_R(M_n/M_{n + 1}, E)$
is zero. However, if $M_n/M_{n + 1}$ is nonzero, then it contains a
nonzero element annihilated by $\mathfrak m$, because $E$ is
$\mathfrak m$-power torsion by Lemma \ref{lemma-union-artinian}.
In this case $M_n/M_{n + 1}$ has a nonzero map into $E$, contradicting
the assumed vanishing. This finishes the proof.
\end{proof}

\begin{lemma}
\label{lemma-describe-categories}
Let $(R, \mathfrak m, \kappa)$ be a Noetherian local ring.
Let $E$ be an injective hull of $\kappa$.
\begin{enumerate}
\item For an $R$-module $M$ the following are equivalent:
\begin{enumerate}
\item $M$ satisfies the ascending chain condition,
\item $M$ is a finite $R$-module, and
\item there exist $n, m$ and an exact sequence
$R^{\oplus m} \to R^{\oplus n} \to M \to 0$.
\end{enumerate}
\item For an $R$-module $M$ the following are equivalent:
\begin{enumerate}
\item $M$ satisfies the descending chain condition,
\item $M$ is $\mathfrak m$-power torsion and
$\dim_\kappa(M[\mathfrak m]) < \infty$, and
\item there exist $n, m$ and an exact sequence
$0 \to M \to E^{\oplus n} \to E^{\oplus m}$.
\end{enumerate}
\end{enumerate}
\end{lemma}

\begin{proof}
We omit the proof of (1).

\medskip\noindent
Let $M$ be an $R$-module with the descending chain condition. Let $x \in M$.
Then $\mathfrak m^n x$ is a descending chain of submodules, hence stabilizes.
Thus $\mathfrak m^nx = \mathfrak m^{n + 1}x$ for some $n$. By Nakayama's lemma
(Algebra, Lemma \ref{algebra-lemma-NAK}) this implies $\mathfrak m^n x = 0$,
i.e., $x$ is $\mathfrak m$-power torsion. Since $M[\mathfrak m]$ is a vector
space over $\kappa$ it has to be finite dimensional in order to have the
descending chain condition.

\medskip\noindent
Assume that $M$ is $\mathfrak m$-power torsion and has a finite dimensional
$\mathfrak m$-torsion submodule $M[\mathfrak m]$. By
Lemma \ref{lemma-torsion-submodule-sum-injective-hulls}
we see that $M$ is a submodule of $E^{\oplus n}$ for some $n$.
Consider the quotient $N = E^{\oplus n}/M$. By
Lemma \ref{lemma-injective-hull-has-dcc} the module $E$ has the
descending chain condition hence so do $E^{\oplus n}$ and $N$.
Therefore $N$ satisfies (2)(a) which implies $N$ satisfies
(2)(b) by the second paragraph of the proof. Thus by
Lemma \ref{lemma-torsion-submodule-sum-injective-hulls}
again we see that $N$ is a submodule of $E^{\oplus m}$ for some $m$.
Thus we have a short exact sequence
$0 \to M \to E^{\oplus n} \to E^{\oplus m}$.

\medskip\noindent
Assume we have a short exact sequence
$0 \to M \to E^{\oplus n} \to E^{\oplus m}$.
Since $E$ satisfies the descending chain condition by
Lemma \ref{lemma-injective-hull-has-dcc}
so does $M$.
\end{proof}

\begin{proposition}[Matlis duality]
\label{proposition-matlis}
Let $(R, \mathfrak m, \kappa)$ be a complete local Noetherian ring.
Let $E$ be an injective hull of $\kappa$ over $R$. The functor
$D(-) = \Hom_R(-, E)$ induces an anti-equivalence
$$
\left\{
\begin{matrix}
R\text{-modules with the} \\
\text{descending chain condition}
\end{matrix}
\right\}
\longleftrightarrow
\left\{
\begin{matrix}
R\text{-modules with the} \\
\text{ascending chain condition}
\end{matrix}
\right\}
$$
and we have $D \circ D = \text{id}$ on either side of the equivalence.
\end{proposition}

\begin{proof}
By Lemma \ref{lemma-endos} we have $R = \Hom_R(E, E) = D(E)$.
Of course we have $E = \Hom_R(R, E) = D(R)$. Since $E$ is injective
the functor $D$ is exact. The result now follows immediately from the
description of the categories in
Lemma \ref{lemma-describe-categories}.
\end{proof}




















\section{Local cohomology}
\label{section-local-cohomology}

\noindent
Let $A$ be a ring and let $I \subset A$ be a finitely generated ideal
(if $I$ is not finitely generated perhaps a different definition
should be used). Let $Z = V(I) \subset \Spec(A)$. Recall that the
category $I^\infty\text{-torsion}$ of $I$-power torsion modules
only depends on the closed subset $Z$ and not on the choice of the
finitely generated ideal $I$ such that $Z = V(I)$, see
More on Algebra, Lemma \ref{more-algebra-lemma-local-cohomology-closed}.
In this section we will consider the functor
$$
H^0_{I} : \text{Mod}_A \longrightarrow I^\infty\text{-torsion},\quad
M \longmapsto M[I^\infty] = \bigcup M[I^n]
$$
which sends $M$ to the submodule of $I$-power torsion as well as its
relationship with the functors
$$
\mathcal{H}_Z :
\textit{Ab}(X)
\longrightarrow
\textit{Ab}(Z)
$$
and $\Gamma_Z( - ) = \Gamma(Z, \mathcal{H}_Z(-))$ of
Cohomology, Section \ref{cohomology-section-cohomology-support}.

\medskip\noindent
Let $A$ be a ring and let $I$ be a finitely generated ideal.
Note that $I^\infty\text{-torsion}$ is a Grothendieck
abelian category (direct sums exist, filtered colimits are
exact, and $\bigoplus A/I^n$ is a generator by
More on Algebra, Lemma \ref{more-algebra-lemma-I-power-torsion-presentation}).
Hence the derived category $D(I^\infty\text{-torsion})$ exists, see
Injectives, Remark \ref{injectives-remark-existence-D}.
Our functor $H^0_I$ is left exact and has a derived extension
which we will denote
$$
R\Gamma_I : D(A) \longrightarrow D(I^\infty\text{-torsion}).
$$
{\bf Warning:} this functor does not deserve the name
local cohomology unless the ring $A$ is Noetherian.
The functors $H^0_I$, $R\Gamma_I$, and the satellites $H^p_I$
only depend on the closed subset $Z \subset \Spec(A)$ and not
on the choice of the finitely generated ideal $I$ such that
$V(I) = Z$. However, we insist on using the subscript $I$ for
the functors above as the notation $R\Gamma_Z$ is going
to be used for a different functor, see
(\ref{equation-local-cohomology}), which
agrees with the functor $R\Gamma_I$ only (as far as we know)
in case $A$ is Noetherian
(see Lemma \ref{lemma-local-cohomology-noetherian}).

\begin{lemma}
\label{lemma-adjoint}
Let $A$ be a ring and let $I \subset A$ be a finitely generated ideal.
The functor $R\Gamma_I$ is right adjoint to the functor
$D(I^\infty\text{-torsion}) \to D(A)$.
\end{lemma}

\begin{proof}
This follows from the fact that taking $I$-power torsion submodules
is the right adjoint to the inclusion functor
$I^\infty\text{-torsion} \to \text{Mod}_A$. See
Derived Categories, Lemma \ref{derived-lemma-derived-adjoint-functors}.
\end{proof}

\begin{lemma}
\label{lemma-local-cohomology-ext}
Let $A$ be a ring and let $I \subset A$ be a finitely generated ideal.
For any object $K$ of $D(A)$ we have
$$
R\Gamma_I(K) = \text{hocolim}\ R\Hom(A/I^n, K)
$$
in $D(A)$ and
$$
R^q\Gamma_I(K) = \colim_n \text{Ext}_A^q(A/I^n, K)
$$
as modules for all $q \in \mathbf{Z}$.
\end{lemma}

\begin{proof}
Let $J^\bullet$ be a K-injective complex representing $K$.
Then
$$
R\Gamma_I(K) = J^\bullet[I^\infty] = \colim J^\bullet[I^n] =
\colim \Hom_A(A/I^n, J^\bullet)
$$
By Derived Categories, Lemma \ref{derived-lemma-colim-hocolim}
we obtain the first equality. The second equality is clear
because $H^q(\Hom_A(A/I^n, J^\bullet)) = \text{Ext}^q_A(A/I^n, K)$
and because filtered colimits are exact in the category of abelian
groups.
\end{proof}

\begin{lemma}
\label{lemma-bad-local-cohomology-vanishes}
Let $A$ be a ring and let $I \subset A$ be a finitely generated ideal.
Let $K^\bullet$ be a complex of $A$-modules such that
$f : K^\bullet \to K^\bullet$ is an isomorphism for some
$f \in I$, i.e., $K^\bullet$ is a complex of $A_f$-modules. Then
$R\Gamma_I(K^\bullet) = 0$.
\end{lemma}

\begin{proof}
Namely, in this case the cohomology modules of $R\Gamma_I(K^\bullet)$
are both $f$-power torsion and $f$ acts by automorphisms. Hence the
cohomology modules are zero and hence the object is zero.
\end{proof}

\noindent
Let $A$ be a ring and $I \subset A$ a finitely generated ideal.
By More on Algebra, Lemma \ref{more-algebra-lemma-I-power-torsion}
the category of $I$-power torsion modules is a Serre subcategory
of the category of all $A$-modules, hence there is a functor
\begin{equation}
\label{equation-compare-torsion}
D(I^\infty\text{-torsion}) \to D_{I^\infty\text{-torsion}}(A)
\end{equation}
see Derived Categories, Section \ref{derived-section-triangulated-sub}.

\begin{lemma}
\label{lemma-not-equal}
Let $A$ be a ring and let $I$ be a finitely generated ideal.
Let $M$ and $N$ be $I$-power torsion modules.
\begin{enumerate}
\item $\Hom_{D(A)}(M, N) = \Hom_{D({I^\infty\text{-torsion}})}(M, N)$,
\item $\text{Ext}^1_{D(A)}(M, N) =
\text{Ext}^1_{D({I^\infty\text{-torsion}})}(M, N)$,
\item $\text{Ext}^2_{D({I^\infty\text{-torsion}})}(M, N) \to
\text{Ext}^2_{D(A)}(M, N)$ is not surjective in general,
\item (\ref{equation-compare-torsion}) is not an equivalence in general.
\end{enumerate}
\end{lemma}

\begin{proof}
Parts (1) and (2) follow immediately from the fact that $I$-power torsion
forms a Serre subcategory of $\text{Mod}_A$. Part (4) follows from
part (3).

\medskip\noindent
For part (3) let $A$ be a ring with an element $f \in A$ such that
$A[f]$ contains a nonzero element $x$ and $A$ contains elements
$x_n$ with $f^nx_n = x$. Such a ring $A$ exists because we can take
$$
A = \mathbf{Z}[f, x, x_n]/(fx, f^nx_n - x)
$$
Given $A$ set $I = (f)$. Then the exact sequence
$$
0 \to A[f] \to A \xrightarrow{f} A \to A/fA \to 0
$$
defines an element in $\text{Ext}^2_A(A/fA, A[f])$. We claim this
element does not come from an element of
$\text{Ext}^2_{D(f^\infty\text{-torsion})}(A/fA, A[f])$.
Namely, if it did, then there would be an exact sequence
$$
0 \to A[f] \to M \to N \to A/fA \to 0
$$
where $M$ and $N$ are $f$-power torsion modules defining the same
$2$ extension class. Since $A \to A$ is a complex of free modules
and since the $2$ extension classes are the same
we would be able to find a map
$$
\xymatrix{
0 \ar[r] &
A[f] \ar[r] \ar[d] &
A \ar[r] \ar[d]_\varphi &
A \ar[r] \ar[d]_\psi &
A/fA \ar[r] \ar[d] & 0 \\
0 \ar[r] &
A[f] \ar[r] &
M \ar[r] &
N \ar[r] &
A/fA \ar[r] & 0
}
$$
(some details omitted). Then we could replace $M$ by the image of
$\varphi$ and $N$ by the image of $\psi$. Then $M$ would be a cyclic
module, hence $f^n M = 0$ for some $n$. Considering $\varphi(x_{n + 1})$
we get a contradiction with the fact that $f^{n + 1}x_n = x$ is
nonzero in $A[f]$.
\end{proof}

\noindent
Let $A$ be a ring and let $I \subset A$ be a finitely generated ideal.
Set $Z = V(I) \subset \Spec(A)$. We will construct a functor
\begin{equation}
\label{equation-local-cohomology}
R\Gamma_Z : D(A) \longrightarrow D_{I^\infty\text{-torsion}}(A).
\end{equation}
which is right adjoint to the inclusion functor. The cohomology
modules of $R\Gamma_Z(K)$ are the {\it local cohomology groups
of $K$ with respect to $Z$}. In fact, we will show $R\Gamma_Z$
computes cohomology with support in $Z$ for the assocated
complex of quasi-comherent sheaves on $\Spec(A)$. By
Lemma \ref{lemma-not-equal} this functor will in general {\bf not} be
equal to $R\Gamma_I( - )$ even viewed as functors into $D(A)$.

\begin{lemma}
\label{lemma-local-cohomology-adjoint}
Let $A$ be a ring and let $I \subset A$ be a finitely generated ideal.
There exists a right adjoint $R\Gamma_Z$ (\ref{equation-local-cohomology})
to the inclusion functor $D_{I^\infty\text{-torsion}}(A) \to D(A)$.
In fact, if $I$ is generated by $f_1, \ldots, f_r \in A$, then we have
$$
R\Gamma_Z(K) =
(A \to \prod\nolimits_{i_0} A_{f_{i_0}} \to
\prod\nolimits_{i_0 < i_1} A_{f_{i_0}f_{i_1}}
\to \ldots \to A_{f_1\ldots f_r}) \otimes_A^\mathbf{L} K
$$
functorially in $K$.
\end{lemma}

\begin{proof}
Say $I = (f_1, \ldots, f_r)$ be an ideal.
Let $K^\bullet$ be a complex of $A$-modules.
There is a canonical map of complexes
$$
(A \to \prod\nolimits_{i_0} A_{f_{i_0}} \to
\prod\nolimits_{i_0 < i_1} A_{f_{i_0}f_{i_1}} \to
\ldots \to A_{f_1\ldots f_r}) \longrightarrow A.
$$
from the extended {\v C}ech complex to $A$.
Tensoring with $K^\bullet$, taking associated total complex,
we get a map
$$
\text{Tot}\left(
K^\bullet \otimes_A
(A \to \prod\nolimits_{i_0} A_{f_{i_0}} \to
\prod\nolimits_{i_0 < i_1} A_{f_{i_0}f_{i_1}} \to
\ldots \to A_{f_1\ldots f_r})\right)
\longrightarrow
K^\bullet
$$
in $D(A)$. We claim the cohomology modules of the complex on the left are
$I$-power torsion, i.e., the LHS is an object of
$D_{I^\infty\text{-torsion}}(A)$. Namely, we have
$$
(A \to \prod\nolimits_{i_0} A_{f_{i_0}} \to
\prod\nolimits_{i_0 < i_1} A_{f_{i_0}f_{i_1}} \to
\ldots \to A_{f_1\ldots f_r}) = \colim K(A, f_1^n, \ldots, f_r^n)
$$
by More on Algebra, Lemma
\ref{more-algebra-lemma-extended-alternating-Cech-is-colimit-koszul}.
Moreover, multiplication by $f_i^n$ on the complex
$K(A, f_1^n, \ldots, f_r^n)$ is homotopic to zero by
More on Algebra, Lemma \ref{more-algebra-lemma-homotopy-koszul}.
Since
$$
H^q\left( LHS \right) =
\colim H^q(\text{Tot}(K^\bullet \otimes_A K(A, f_1^n, \ldots, f_r^n)))
$$
we obtain our claim. On the other hand, if $K^\bullet$ is an
object of $D_{I^\infty\text{-torsion}}(A)$, then the complexes
$K^\bullet \otimes_A A_{f_{i_0} \ldots f_{i_p}}$ have vanishing
cohomology. Hence in this case the map $LHS \to K^\bullet$
is an isomorphism in $D(A)$. The construction
$$
R\Gamma_Z(K^\bullet) =
\text{Tot}\left(
K^\bullet \otimes_A
(A \to \prod\nolimits_{i_0} A_{f_{i_0}} \to
\prod\nolimits_{i_0 < i_1} A_{f_{i_0}f_{i_1}} \to
\ldots \to A_{f_1\ldots f_r})\right)
$$
is functorial in $K^\bullet$ and defines an exact functor
$D(A) \to D_{I^\infty\text{-torsion}}(A)$ between
triangulated categories. It follows formally from the
existence of the natural transformation $R\Gamma_Z \to \text{id}$
given above and the fact that this evaluates to an isomorphism
on $K^\bullet$ in the subcategory, that $R\Gamma_Z$ is the desired
right adjoint.
\end{proof}

\begin{lemma}
\label{lemma-local-cohomology-vanishes}
Let $A$ be a ring and let $I \subset A$ be a finitely generated ideal.
Let $K^\bullet$ be a complex of $A$-modules such that
$f : K^\bullet \to K^\bullet$ is an isomorphism for some
$f \in I$, i.e., $K^\bullet$ is a complex of $A_f$-modules. Then
$R\Gamma_Z(K^\bullet) = 0$.
\end{lemma}

\begin{proof}
Namely, in this case the cohomology modules of $R\Gamma_Z(K^\bullet)$
are both $f$-power torsion and $f$ acts by automorphisms. Hence the
cohomology modules are zero and hence the object is zero.
\end{proof}

\begin{lemma}
\label{lemma-torsion-tensor-product}
Let $A$ be a ring and let $I \subset A$ be a finitely generated ideal.
For $K, L \in D(A)$ general we have
$$
R\Gamma_Z(K \otimes_A^\mathbf{L} L) =
K \otimes_A^\mathbf{L} R\Gamma_Z(L) =
R\Gamma_Z(K) \otimes_A^\mathbf{L} L =
R\Gamma_Z(K) \otimes_A^\mathbf{L} R\Gamma_Z(L)
$$
If $K$ or $L$ is in $D_{I^\infty\text{-torsion}}(A)$ then so is
$K \otimes_A^\mathbf{L} L$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-local-cohomology-adjoint} we know that
$R\Gamma_Z$ is given by $C \otimes^\mathbf{L} -$ for some $C \in D(A)$.
Hence, for $K, L \in D(A)$ general we have
$$
R\Gamma_Z(K \otimes_A^\mathbf{L} L) =
K \otimes^\mathbf{L} L \otimes_A^\mathbf{L} C =
K \otimes_A^\mathbf{L} R\Gamma_Z(L)
$$
The other equalities follow formally from this one. This also implies
the last statement of the lemma.
\end{proof}

\noindent
The following lemma tells us that the functor $R\Gamma_Z$
is related to local cohomology.

\begin{lemma}
\label{lemma-local-cohomology-is-local-cohomology}
Let $A$ be a ring and let $I$ be a finitely generated ideal.
With $Z = V(I) \subset X = \Spec(A)$ there is a functorial
isomorphism
$$
R\Gamma_Z(K^\bullet) = R\Gamma_Z(\widetilde{K^\bullet})
$$
where on the left we have (\ref{equation-local-cohomology})
and on the right we have the functor of
Cohomology, Section \ref{cohomology-section-cohomology-support}.
\end{lemma}

\begin{proof}
Denote $\mathcal{F}^\bullet = \widetilde{K^\bullet}$ be
the complex of quasi-coherent $\mathcal{O}_X$-modules on $X$
associated to $K^\bullet$.
By Cohomology, Section \ref{cohomology-section-cohomology-support}
there exists a distinguished triangle
$$
R\Gamma_Z(X, \mathcal{F}^\bullet)
\to R\Gamma(X, \mathcal{F}^\bullet)
\to R\Gamma(U, \mathcal{F}^\bullet)
\to R\Gamma_Z(X, \mathcal{F}^\bullet)[1]
$$
where $U = X \setminus Z$. We know that
$R\Gamma(X, \mathcal{F}^\bullet) = K^\bullet$
for example by Derived Categories of Schemes, Lemma
\ref{perfect-lemma-affine-compare-bounded}.
Say $I = (f_1, \ldots, f_r)$. Then we obtain a finite affine
open covering $\mathcal{U} : U = D(f_1) \cup \ldots \cup D(f_r)$.
By Derived Categories of Schemes, Lemma
\ref{perfect-lemma-alternating-cech-complex-complex-computes-cohomology}
the alternating {\v C}ech complex
$$
\text{Tot}(\check{\mathcal{C}}_{alt}^\bullet(\mathcal{U}, \mathcal{F}^\bullet))
$$
computes $R\Gamma(U, \mathcal{F}^\bullet)$. Working through the
definitions we find
$$
R\Gamma(U, \mathcal{F}^\bullet) =
\text{Tot}\left(
K^\bullet \otimes_A
(\prod\nolimits_{i_0} A_{f_{i_0}} \to
\prod\nolimits_{i_0 < i_1} A_{f_{i_0}f_{i_1}} \to
\ldots \to A_{f_1\ldots f_r})\right)
$$
It is clear that
$R\Gamma(X, \mathcal{F}^\bullet) \to R\Gamma(U, \mathcal{F}^\bullet)$
is given by the map from $A$ into $\prod A_{f_i}$. Hence we conclude that
$$
R\Gamma_Z(X, \mathcal{F}^\bullet) =
\text{Tot}\left(
K^\bullet \otimes_A
(A \to \prod\nolimits_{i_0} A_{f_{i_0}} \to
\prod\nolimits_{i_0 < i_1} A_{f_{i_0}f_{i_1}} \to
\ldots \to A_{f_1\ldots f_r})\right)
$$
By Lemma \ref{lemma-local-cohomology-adjoint}
this complex computes $R\Gamma_Z(K^\bullet)$ and we see the lemma holds.
\end{proof}

\noindent
Let $A$ be a ring and let $I \subset A$ be a finitely generated ideal.
Set $Z = V(I) \subset \Spec(A)$. There is a natural transformation of
functors
\begin{equation}
\label{equation-compare-torsion-functors}
(\ref{equation-compare-torsion}) \circ R\Gamma_I(-)
\longrightarrow
R\Gamma_Z(-)
\end{equation}
Namely, given a complex of $A$-modules $K^\bullet$ the canonical map
$R\Gamma_I(K^\bullet) \to K^\bullet$ in $D(A)$ factors (uniquely)
through $R\Gamma_Z(K^\bullet)$ as $R\Gamma_I(K^\bullet)$ has
$I$-power torsion cohomology modules (see Lemma \ref{lemma-adjoint}).
In general this map is not an isomorphism (we've seen this above).

\begin{lemma}
\label{lemma-local-cohomology-noetherian}
Let $A$ be a Noetherian ring and let $I \subset A$ be an ideal.
Denote $j : D(I^\infty\text{-torsion}) \to D_{I^\infty\text{-torsion}}(A)$
the functor (\ref{equation-compare-torsion}).
\begin{enumerate}
\item the adjunction $j(R\Gamma_I(K)) \to K$ is an isomorphism
for $K \in D_{I^\infty\text{-torsion}}(A)$,
\item the functor $j$ is an equivalence,
\item the transformation of functors
(\ref{equation-compare-torsion-functors}) is an isomorphism,
\end{enumerate}
\end{lemma}

\begin{proof}
A formal argument, which we omit, shows that it suffices to prove (1).

\medskip\noindent
Let $M$ be an $I$-power torsion $A$-module. Choose an embedding
$M \to J$ into an injective $A$-module. Then $J[I^\infty]$ is
an injective $A$-module, see Lemma \ref{lemma-injective-module-divide},
and we obtain an embedding $M \to J[I^\infty]$.
Thus every $I$-power torsion module has an injective resolution
$M \to J^\bullet$ with $J^n$ also $I$-power torsion. It follows
that $R\Gamma_I(M) = M$ (this is not a triviality and this is not
true in general if $A$ is not Noetherian). Next, suppose that
$K \in D_{I^\infty\text{-torsion}}^+(A)$. Then the spectral sequence
$$
R^q\Gamma_I(H^p(K)) \Rightarrow R^{p + q}\Gamma_I(K)
$$
(Derived Categories, Lemma \ref{derived-lemma-two-ss-complex-functor})
converges and above we have seen that only the terms with $q = 0$
are nonzero. Thus we see that $R\Gamma_I(K) \to K$ is an isomorphism.

\medskip\noindent
Suppose $K$ is an arbitrary object of $D_{I^\infty\text{-torsion}}(A)$.
We have
$$
R^q\Gamma_I(K) = \colim \text{Ext}^q_A(A/I^n, K)
$$
by Lemma \ref{lemma-local-cohomology-ext}. Choose $f_1, \ldots, f_r \in A$
generating $I$. Let $K_n^\bullet = K(A, f_1^n, \ldots, f_r^n)$ be the
Koszul complex with terms in degrees $-r, \ldots, 0$. Since the
pro-objects $\{A/I^n\}$ and $\{K_n^\bullet\}$ in $D(A)$ are the same by
More on Algebra, Lemma \ref{more-algebra-lemma-sequence-Koszul-complexes},
we see that
$$
R^q\Gamma_I(K) = \colim \text{Ext}^q_A(K_n^\bullet, K)
$$
Pick any complex $K^\bullet$ of $A$-modules representing $K$.
Since $K_n^\bullet$ is a finite complex of finite free modules we see
that
$$
\text{Ext}^q_A(K_n, K) =
H^q(\text{Tot}((K_n^\bullet)^\vee \otimes_A K^\bullet))
$$
where $(K_n^\bullet)^\vee$ is the dual of the complex $K_n^\bullet$.
See More on Algebra, Lemma \ref{more-algebra-lemma-RHom-out-of-projective}.
As $(K_n^\bullet)^\vee$ is a complex of finite free $A$-modules sitting
in degrees $0, \ldots, r$ we see that the terms of the complex
$\text{Tot}((K_n^\bullet)^\vee \otimes_A K^\bullet))$ are the
same as the terms of the complex
$\text{Tot}((K_n^\bullet)^\vee \otimes_A \tau_{\geq q - r - 2} K^\bullet))$
in degrees $q - 1$ and higher. Hence we see that
$$
\text{Ext}^q_A(K_n, K) = \text{Ext}^q_A(K_n, \tau_{\geq q - r - 2}K)
$$
for all $n$. It follows that
$$
R^q\Gamma_I(K) = R^q\Gamma_I(\tau_{\geq q - r - 2}K) =
H^q(\tau_{\geq q - r - 2}K) = H^q(K)
$$
Thus we see that the map $R\Gamma_I(K) \to K$ is an isomorphism.
\end{proof}

\begin{lemma}
\label{lemma-compute-local-cohomology-noetherian}
If $A$ is a Noetherian ring and $I = (f_1, \ldots, f_r)$ an ideal.
There are canonical isomorphisms
$$
R\Gamma_I(A) \to
(A \to \prod\nolimits_{i_0} A_{f_{i_0}} \to
\prod\nolimits_{i_0 < i_1} A_{f_{i_0}f_{i_1}} \to
\ldots \to A_{f_1\ldots f_r}) \to R\Gamma_Z(A)
$$
in $D(A)$.
\end{lemma}

\begin{proof}
This follows from Lemma \ref{lemma-local-cohomology-noetherian}
and the computation of the functor $R\Gamma_Z$ in
Lemma \ref{lemma-local-cohomology-adjoint}.
\end{proof}

\begin{lemma}
\label{lemma-torsion-change-rings}
Let $A \to B$ be a ring map. Let $I \subset A$ be a finitely generated
ideal. Let $Z = V(I) \subset \Spec(A)$ and $Y = V(IB) \subset \Spec(B)$.
For $K$ in $D(A)$ we have
$R\Gamma_Z(K) \otimes_A^\mathbf{L} B = R\Gamma_Y(K \otimes_A^\mathbf{L} B)$.
\end{lemma}

\begin{proof}
This follows from uniquess of adjoint functors
as both $R\Gamma_Z( - ) \otimes_A^\mathbf{L} B$ and
$R\Gamma_Y(- \otimes_A^\mathbf{L} B)$
are right adjoint to the functor
$D_{(IB)^\infty\text{torsion}}(B) \to D(A)$. Alternatively, one can use
the description of $R\Gamma_Z$ and $R\Gamma_Y$ in terms of alternating
{\v C}ech complexes (Lemma \ref{lemma-local-cohomology-adjoint})
and use that formation of the extended {\v C}ech
complex commutes with base change.
\end{proof}

\begin{lemma}
\label{lemma-local-cohomology-change-rings}
If $A \to B$ is a homomorphism of Noetherian rings and $I \subset A$
is an ideal, then in $D(B)$ we have
$$
R\Gamma_I(A) \otimes_A^\mathbf{L} B =
R\Gamma_Z(A) \otimes_A^\mathbf{L} B =
R\Gamma_Y(B) = R\Gamma_{IB}(B)
$$
where $Y = V(IB) \subset \Spec(B)$.
\end{lemma}

\begin{proof}
Combine Lemmas \ref{lemma-compute-local-cohomology-noetherian} and
\ref{lemma-torsion-change-rings}.
\end{proof}

\noindent
The following lemma is the analogue of
More on Algebra, Lemma
\ref{more-algebra-lemma-restriction-derived-complete-equivalence}
for complexes with torsion cohomologies.

\begin{lemma}
\label{lemma-torsion-flat-change-rings}
Let $A \to B$ be a flat ring map and let $I \subset A$ be a finitely
generated ideal such that $A/I = B/IB$. Then base change and
restriction induce quasi-inverse equivalences
$D_{I^\infty\text{-torsion}}(A) = D_{(IB)^\infty\text{-torsion}}(B)$.
\end{lemma}

\begin{proof}
More precisely the functors are $K \mapsto K \otimes_A^\mathbf{L} B$
for $K$ in $D_{I^\infty\text{-torsion}}(A)$ and $M \mapsto M_A$
for $M$ in $D_{(IB)^\infty\text{-torsion}}(B)$. The reason this works
is that $H^i(K \otimes_A^\mathbf{L} B) = H^i(K) \otimes_A B = H^i(K)$.
The first equality holds as $A \to B$ is flat and the second by
More on Algebra, Lemma \ref{more-algebra-lemma-neighbourhood-isomorphism}.
\end{proof}

\noindent
The following lemma was shown for $\Hom$ and $\text{Ext}^1$ of modules in
More on Algebra, Lemmas \ref{more-algebra-lemma-neighbourhood-equivalence} and
\ref{more-algebra-lemma-neighbourhood-extensions}.

\begin{lemma}
\label{lemma-neighbourhood-extensions}
Let $A \to B$ be a flat ring map and let $I \subset A$ be a
finitely generated ideal such that $A/I \to B/IB$ is an isomorphism.
For $K \in D_{I^\infty\text{-torsion}}(A)$ and $L \in D(A)$
the map
$$
R\Hom_A(K, L) \longrightarrow R\Hom_B(K \otimes_A B, L \otimes_A B)
$$
is a quasi-isomorphism. In particular, if $M$, $N$ are $A$-modules and
$M$ is $I$-power torsion, then the canonical map
$$
\text{Ext}^i_A(M, N)
\longrightarrow
\text{Ext}^i_B(M \otimes_A B, N \otimes_A B)
$$
is an isomorphism for all $i$. 
\end{lemma}

\begin{proof}
Let $Z = V(I) \subset \Spec(A)$ and $Y = V(IB) \subset \Spec(B)$.
Since the cohomology modules of $K$ are $I$ power torsion, the
canonical map $R\Gamma_Z(L) \to L$ induces an isomorphism
$$
R\Hom_A(K, R\Gamma_Z(L)) \to R\Hom_A(K, L)
$$
in $D(A)$. Similarly, the cohomology modules of $K \otimes_A B$ are
$IB$ power torsion and we have an isomorphism
$$
R\Hom_B(K \otimes_A B, R\Gamma_Y(L \otimes_A B)) \to 
R\Hom_B(K \otimes_A B, L \otimes_A B)
$$
in $D(B)$.
By Lemma \ref{lemma-torsion-change-rings} we have
$R\Gamma_Z(L) \otimes_A B = R\Gamma_Y(L \otimes_A B)$.
Hence it suffices to show that the map
$$
R\Hom_A(K, R\Gamma_Z(L)) \to R\Hom_B(K \otimes_A B, R\Gamma_Z(L) \otimes_A B)
$$
is a quasi-isommorphism. This follows from
Lemma \ref{lemma-torsion-flat-change-rings}.
\end{proof}




\section{Torsion versus complete modules}
\label{section-torsion-and-complete}

\noindent
Let $A$ be a ring and let $I$ be a finitely generated ideal.
In this case we can consider the derived category
$D_{I^\infty\text{-torsion}}(A)$ of complexes
with $I$-power torsion cohomology modules
(Section \ref{section-local-cohomology})
and the derived category
$D_{comp}(A, I)$ of derived complete complexes
(More on Algebra, Section \ref{more-algebra-section-derived-completion}).
In this section we show these categories are equivalent.
A more general statement can be found in
\cite{Dwyer-Greenlees}.

\begin{lemma}
\label{lemma-complete-and-local}
Let $A$ be a ring and let $I$ be a finitely generated ideal.
Let $R\Gamma_Z$ be as in Lemma \ref{lemma-local-cohomology-adjoint}.
Let ${\ }^\wedge$ denote derived completion as in
More on Algebra, Lemma \ref{more-algebra-lemma-derived-completion}.
For an object $K$ in $D(A)$ we have
$$
R\Gamma_Z(K^\wedge) = R\Gamma_Z(K)
\quad\text{and}\quad
(R\Gamma_Z(K))^\wedge = K^\wedge
$$
in $D(A)$.
\end{lemma}

\begin{proof}
Choose $f_1, \ldots, f_r \in A$ generating $I$. Recall that
$$
K^\wedge = R\Hom\left((A \to \prod A_{f_{i_0}}
\to \prod A_{f_{i_0i_1}} \to \ldots \to A_{f_1 \ldots f_r}), K\right)
$$
by More on Algebra, Lemma \ref{more-algebra-lemma-derived-completion}.
Hence the cone $C = \text{Cone}(K \to K^\wedge)$
is given by
$$
R\Hom\left((\prod A_{f_{i_0}}
\to \prod A_{f_{i_0i_1}} \to \ldots \to A_{f_1 \ldots f_r}), K\right)
$$
which can be represented by a complex endowed with a finite filtration
whose succesive quotients are isomorphic to
$$
R\Hom(A_{f_{i_0} \ldots f_{i_p}}, K), \quad p > 0
$$
These complexes vanish on applying $R\Gamma_Z$, see
Lemma \ref{lemma-local-cohomology-vanishes}. Applying $R\Gamma_Z$
to the distinguished triangle $K \to K^\wedge \to C \to K[1]$
we see that the first formula of the lemma is correct.

\medskip\noindent
Recall that
$$
R\Gamma_Z(K) =
K \otimes^\mathbf{L} (A \to \prod A_{f_{i_0}}
\to \prod A_{f_{i_0i_1}} \to \ldots \to A_{f_1 \ldots f_r})
$$
by Lemma \ref{lemma-local-cohomology-adjoint}.
Hence the cone $C = \text{Cone}(R\Gamma_Z(K) \to K)$
can be represented by a complex endowed with a finite filtration
whose succesive quotients are isomorphic to
$$
K \otimes_A A_{f_{i_0} \ldots f_{i_p}}, \quad p > 0
$$
These complexes vanish on applying ${\ }^\wedge$, see
More on Algebra, Lemma \ref{more-algebra-lemma-derived-completion-vanishes}.
Applying derived completion to the distinguished triangle
$R\Gamma_Z(K) \to K \to C \to R\Gamma_Z(K)[1]$
we see that the second formula of the lemma is correct.
\end{proof}

\noindent
The following result is a special case of a very general phenomenon
concerning admissible subcategories of a triangulated category.

\begin{proposition}
\label{proposition-torsion-complete}
Let $A$ be a ring and let $I \subset A$ be a finitely generated ideal.
The functors $R\Gamma_Z$ and ${\ }^\wedge$
define quasi-inverse equivalences of categories
$$
D_{I^\infty\text{-torsion}}(A) \leftrightarrow D_{comp}(A, I)
$$
\end{proposition}

\begin{proof}
Follows immediately from Lemma \ref{lemma-complete-and-local}.
\end{proof}

\noindent
The following addendum of the proposition above makes the
correspondence on morphisms more precise.

\begin{lemma}
\label{lemma-compare-RHom}
With notation as in Lemma \ref{lemma-complete-and-local}.
For objects $K, L$ in $D(A)$ there is a canonical isomorphism
$$
R\Hom(K^\wedge, L^\wedge) \longrightarrow R\Hom(R\Gamma_Z(K), R\Gamma_Z(L))
$$
in $D(A)$.
\end{lemma}

\begin{proof}
Say $I = (f_1, \ldots, f_r)$. Denote
$C = (A \to \prod A_{f_i} \to \ldots \to A_{f_1 \ldots f_r})$ the
alternating {\v C}ech complex. Then derived completion is given
by $R\Hom(C, -)$ and local cohomology by $C \otimes^\mathbf{L} -$.
Combinging the isomorphism
$$
R\Hom(K \otimes^\mathbf{L} C, L \otimes^\mathbf{L} C) =
R\Hom(K, R\Hom(C,  L \otimes^\mathbf{L} C))
$$
(More on Algebra, Lemma \ref{more-algebra-lemma-internal-hom})
and the map
$$
L \to R\Hom(C,  L \otimes^\mathbf{L} C)
$$
(More on Algebra, Lemma \ref{more-algebra-lemma-internal-hom-diagonal})
we obtain a map
$$
\gamma : R\Hom(K, L) \to R\Hom(K \otimes^\mathbf{L} C, L \otimes^\mathbf{L} C)
$$
On the other hand, the right hand side is derived complete as it is
equal to
$$
R\Hom(C, R\Hom(K, L \otimes^\mathbf{L} C)).
$$
Thus $\gamma$ factors through the derived completion of
$R\Hom(K, L)$ by the universal property of derived completion.
However, the derived completion goes inside the $R\Hom$ by
More on Algebra, Lemma \ref{more-algebra-lemma-completion-RHom}
and we obtain the desired map.

\medskip\noindent
To show that the map of the lemma is an isomorphism
we may assume that $K$ and $L$ are derived complete, i.e.,
$K = K^\wedge$ and $L = L^\wedge$. In this case we are
looking at the map
$$
\gamma : R\Hom(K, L) \longrightarrow R\Hom(R\Gamma_Z(K), R\Gamma_Z(L))
$$
By Proposition \ref{proposition-torsion-complete} we know that
the cohomology groups
of the left and the right hand side coincide. In other words,
we have to check that the map $\gamma$ sends a morphism
$\alpha : K \to L$ in $D(A)$ to the morphism
$R\Gamma_Z(\alpha) : R\Gamma_Z(K) \to R\Gamma_Z(L)$.
We omit the verification (hint: note that $R\Gamma_Z(\alpha)$
is just the map
$\alpha \otimes \text{id}_C :
K \otimes^\mathbf{L} C
\to
L \otimes^\mathbf{L} C$ which is almost the same as the
construction of the map in
More on Algebra, Lemma \ref{more-algebra-lemma-internal-hom-diagonal}).
\end{proof}







\section{Trivial duality for a ring map}
\label{section-trivial}

\noindent
Let $A \to B$ be a ring homomorphism. Consider the functor
$$
\Hom(B, -) : \text{Mod}_A \longrightarrow \text{Mod}_B,\quad
M \longmapsto \Hom_A(B, M)
$$
This functor is left exact and has a derived extension
$R\Hom(B, -) : D(A) \to D(B)$. Note that for every $K \in D(A)$
there is a canonical map $i_*R\Hom(B, K) \to K$ where
$i_* : D(B) \to D(A)$ is the obvious functor.

\begin{lemma}
\label{lemma-right-adjoint}
With notation as above. The functor $R\Hom(B, -)$ is the
right adjoint to the functor $i_* : D(B) \to D(A)$.
\end{lemma}

\begin{proof}
This is a consequence of the fact that $i_*$ and $\Hom_A(B, -)$ are
adjoint functors by Algebra, Lemma \ref{algebra-lemma-adjoint-tensor-restrict}.
See Derived Categories, Lemma \ref{derived-lemma-derived-adjoint-functors}.
\end{proof}

\begin{lemma}
\label{lemma-RHom-ext}
With notation as above. For $K$ in $D(A)$ we have
$R^q\Hom(B, K) = \text{Ext}_A^q(B, K)$
as $A$-modules (the left hand side starts out as a $B$-module).
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\noindent
Let $A$ be a Noetherian ring. We will denote
$$
D_{Coh}(A) \subset D(A)
$$
the full subcategory consisting of those objects $K$ of $D(A)$
whose cohomology modules are all finite $A$-modules. This makes sense
by Derived Categories, Section \ref{derived-section-triangulated-sub}
because as $A$ is Noetherian, the subcategory of finite $A$-modules
is a Serre subcategory of $\text{Mod}_A$.

\begin{lemma}
\label{lemma-exact-support-coherent}
With notation as above, assume $A \to B$ is a finite ring map of
Noetherian rings. Then $R\Hom(B, -)$ maps
$D^+_{\textit{Coh}}(A)$ into $D^+_{\textit{Coh}}(B)$.
\end{lemma}

\begin{proof}
We have to show: if $K \in D^+(A)$ has finite cohomology modules, then the
complex $R\Hom(B, K)$ has finite cohomology modules too.
This follows for example from Lemma \ref{lemma-RHom-ext}
if we can show the ext modules $\text{Ext}^i_A(B, K)$
are finite $A$-modules. Since $K$ is bounded below there is a
convergent spectral sequence
$$
\text{Ext}^p_A(B, H^q(K)) \Rightarrow \text{Ext}^{p + q}_A(B, K)
$$
This finishes the proof as the modules $\text{Ext}^p_A(B, H^q(K))$
are finite by
Algebra, Lemma \ref{algebra-lemma-ext-noetherian}.
\end{proof}

\begin{remark}
\label{remark-exact-support}
Let $A$ be a ring and let $I \subset A$ be an ideal. Set $B = A/I$.
In this case the functor $\Hom_A(B, -)$ is equal to the functor
$$
\text{Mod}_A \longrightarrow \text{Mod}_B,\quad M \longmapsto M[I]
$$
which sends $M$ to the submodule of $I$-torsion.
\end{remark}





\section{Sections with support in a closed subscheme}
\label{section-sections-with-exact-support}

\noindent
Let $i : (Z, \mathcal{O}_Z) \to (X, \mathcal{O}_X)$ be a morphism
of ringed spaces such that $i$ is a homomorphism onto a closed
subset and such that $i^\sharp : \mathcal{O}_X \to i_*\mathcal{O}_Z$
is surjective. (For example a closed immersion of schemes.)
Let $\mathcal{I} = \Ker(i^\sharp)$. For a sheaf
of $\mathcal{O}_X$-modules $\mathcal{F}$ the sheaf
$$
\SheafHom_{\mathcal{O}_X}(i_*\mathcal{O}_Z, \mathcal{F})
$$
a sheaf of $\mathcal{O}_X$-modules annihilated by $\mathcal{I}$.
Hence by Modules, Lemma \ref{modules-lemma-i-star-equivalence}
there is a sheaf of $\mathcal{O}_Z$-modules,
which we will denote $\SheafHom(\mathcal{O}_Z, \mathcal{F})$,
such that
$$
i_*\SheafHom(\mathcal{O}_Z, \mathcal{F}) =
\SheafHom_{\mathcal{O}_X}(i_*\mathcal{O}_Z, \mathcal{F})
$$
as $\mathcal{O}_X$-modules. We spell out what this means.

\begin{lemma}
\label{lemma-compute-sheaf-with-exact-support}
With notation as above. The functor $\SheafHom(\mathcal{O}_Z, -)$ is a
right adjoint to the functor
$i_* : \textit{Mod}(\mathcal{O}_Z) \to \textit{Mod}(\mathcal{O}_X)$.
For $V \subset Z$ open we have
$$
\Gamma(V, \SheafHom(\mathcal{O}_Z, \mathcal{F})) =
\{s \in \Gamma(U, \mathcal{F}) \mid \mathcal{I}s = 0\}
$$
where $U \subset X$ is an open whose intersection with $Z$ is $V$.
\end{lemma}

\begin{proof}
Let $\mathcal{G}$ be a sheaf of $\mathcal{O}_Z$-modules. Then
$$
\Hom_{\mathcal{O}_X}(i_*\mathcal{G}, \mathcal{F}) =
\Hom_{i_*\mathcal{O}_Z}(i_*\mathcal{G},
\SheafHom_{\mathcal{O}_X}(i_*\mathcal{O}_Z, \mathcal{F})) =
\Hom_{\mathcal{O}_Z}(\mathcal{G}, \SheafHom(\mathcal{O}_Z, \mathcal{F}))
$$
The first equality by
Modules, Lemma \ref{modules-lemma-adjoint-tensor-restrict}
and the second by the fully faithfulness of $i_*$, see
Modules, Lemma \ref{modules-lemma-i-star-equivalence}.
The description of sections is left to the reader.
\end{proof}

\noindent
The functor
$$
\textit{Mod}(\mathcal{O}_X)
\longrightarrow
\textit{Mod}(\mathcal{O}_Z),
\quad
\mathcal{F} \longmapsto \SheafHom(\mathcal{O}_Z, \mathcal{F})
$$
is left exact and has a derived extension
$$
R\SheafHom(\mathcal{O}_Z, -) : D(\mathcal{O}_X) \to D(\mathcal{O}_Z).
$$

\begin{lemma}
\label{lemma-sheaf-with-exact-support-adjoint}
With notation as above. The functor $R\SheafHom(\mathcal{O}_Z, -)$
is the right adjoint of the functor
$i_* : D(\mathcal{O}_Z) \to D(\mathcal{O}_X)$.
\end{lemma}

\begin{proof}
This is a consequence of the fact that $i_*$ and
$\SheafHom(\mathcal{O}_Z, -)$ are adjoint functors by
Lemma \ref{lemma-compute-sheaf-with-exact-support}. See
Derived Categories, Lemma \ref{derived-lemma-derived-adjoint-functors}.
\end{proof}

\begin{lemma}
\label{lemma-sheaf-with-exact-support-ext}
With notation as above. For any $\mathcal{O}_X$-module $\mathcal{F}$
we have
$$
i_*R\SheafHom(\mathcal{O}_Z, \mathcal{F}) =
R\SheafHom(i_*\mathcal{O}_Z, \mathcal{F})
$$
in $D(\mathcal{O}_X)$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-sheaf-with-exact-support-quasi-coherent}
In the situation above, assume $i : Z \to X$ is a pseudo-coherent
morphism of schemes (for example if $X$ is locally Noetherian).
Then
\begin{enumerate}
\item $R\SheafHom(\mathcal{O}_Z, -)$ maps $D^+_\QCoh(\mathcal{O}_X)$
into $D^+_\QCoh(\mathcal{O}_Z)$, and
\item if $X = \Spec(A)$ and $Z = \Spec(B)$, then the diagram
$$
\xymatrix{
D^+(B) \ar[r] & D_\QCoh^+(\mathcal{O}_Z) \\
D^+(A) \ar[r] \ar[u]^{R\Hom(B, -)} &
D_\QCoh^+(\mathcal{O}_X) \ar[u]_{R\SheafHom(\mathcal{O}_Z, -)}
}
$$
is commutative.
\end{enumerate}
\end{lemma}

\begin{proof}
To explain the parenthetical remark, if $X$ is locally Noetherian, then
$i$ is pseudo-coherent by
More on Morphisms, Lemma \ref{more-morphisms-lemma-Noetherian-pseudo-coherent}.

\medskip\noindent
Let $K$ be an object of $D^+_\QCoh(\mathcal{O}_X)$. To prove (1), by
Morphisms, Lemma \ref{morphisms-lemma-i-star-equivalence}
it suffices to show that $i_*$ applied to
$H^n(R\SheafHom(\mathcal{O}_Z, K))$ produces a
quasi-coherent module on $X$. By
Lemma \ref{lemma-sheaf-with-exact-support-ext}
this means we have to show that $R\SheafHom(i_*\mathcal{O}_Z, K)$
is in $D_\QCoh(\mathcal{O}_X)$. Since $i$ is pseudo-coherent
the sheaf $\mathcal{O}_Z$ is a pseudo-coherent $\mathcal{O}_X$-module.
Hence the result follows from
Derived Categories of Schemes, Lemma
\ref{perfect-lemma-quasi-coherence-internal-hom}.

\medskip\noindent
Assume $X = \Spec(A)$ and $Z = \Spec(B)$ as in (2).
Let $I^\bullet$ be a bounded below complex of injective $A$-modules
representing an object $K$ of $D^+(A)$.
Then we know that $R\Hom(B, K) = \Hom_A(B, I^\bullet)$ viewed
as a complex of $B$-modules. Choose a quasi-isomorphism
$$
\widetilde{I^\bullet} \longrightarrow \mathcal{I}^\bullet
$$
where $\mathcal{I}^\bullet$ is a bounded below complex of injective
$\mathcal{O}_X$-modules. It follows from the description of
the functor $\SheafHom(\mathcal{O}_Z, -)$ in
Lemma \ref{lemma-compute-sheaf-with-exact-support}
that there is a map
$$
\Hom_A(B, I^\bullet)
\longrightarrow
\Gamma(Z, \SheafHom(\mathcal{O}_Z, \mathcal{I}^\bullet))
$$
Observe that $\SheafHom(\mathcal{O}_Z, \mathcal{I}^\bullet)$
represents $R\SheafHom(\mathcal{O}_Z, \widetilde{K})$.
Applying the universal property of the $\widetilde{\ }$ functor we
obtain a map
$$
\widetilde{\Hom_A(B, I^\bullet)}
\longrightarrow
R\SheafHom(\mathcal{O}_Z, \widetilde{K})
$$
in $D(\mathcal{O}_Z)$. We may check that this map is an isomorphism in
$D(\mathcal{O}_Z)$ after applying $i_*$. However, once we apply
$i_*$ we obtain the isomorphism of Derived Categories of Schemes,
Lemma \ref{perfect-lemma-quasi-coherence-internal-hom}
via the identification of
Lemma \ref{lemma-sheaf-with-exact-support-ext}.
\end{proof}

\begin{lemma}
\label{lemma-sheaf-with-exact-support-coherent}
In this situation above. Assume $X$ is a locally Noetherian scheme.
Then $R\SheafHom(\mathcal{O}_Z, -)$ maps $D^+_{\textit{Coh}}(\mathcal{O}_X)$
into $D^+_{\textit{Coh}}(\mathcal{O}_Z)$.
\end{lemma}

\begin{proof}
The question is local on $X$, hence we may assume that $X$ is affine.
Say $X = \Spec(A)$ and $Z = \Spec(B)$ with $A$ Noetherian and
$A \to B$ surjective. In this case, we can apply
Lemma \ref{lemma-sheaf-with-exact-support-quasi-coherent}
to translate the question into algebra.
The corresponding algebra result is a consequence of
Lemma \ref{lemma-exact-support-coherent}.
\end{proof}

\begin{lemma}
\label{lemma-sheaf-with-exact-support-effective-Cartier}
Let $i : D \to X$ be the inclusion of an effective Cartier divisor.
Denote $\mathcal{N} = i^*\mathcal{O}_X(D)$ the normal sheaf of $i$
(Morphisms, Section \ref{morphisms-section-conormal-sheaf}).
Then for a finite locally free $\mathcal{O}_X$-module $\mathcal{E}$
we have $R\SheafHom(\mathcal{O}_D, \mathcal{E}) =
i^*\mathcal{E} \otimes_{\mathcal{O}_D} \mathcal{N}[-1]$.
\end{lemma}

\begin{proof}
Omitted. This lemma can be significantly generalized.
\end{proof}






\section{Dualizing complexes}
\label{section-dualizing}

\noindent
In this section we define dualizing complexes for Noetherian rings.

\begin{definition}
\label{definition-dualizing}
Let $A$ be a Noetherian ring. A {\it dualizing complex} is a
complex of $A$-modules $\omega_A^\bullet$ such that
\begin{enumerate}
\item $\omega_A^\bullet$ has finite injective dimension,
\item $H^i(\omega_A^\bullet)$ is a finite $A$-module for all $i$, and
\item $A \to R\Hom(\omega_A^\bullet, \omega_A^\bullet)$
is a quasi-isomorphism.
\end{enumerate}
\end{definition}

\noindent
This definition takes some time getting used to. It is perhaps a good
idea to prove some of the following lemmas yourself without reading
the proofs.

\begin{lemma}
\label{lemma-dualizing}
Let $A$ be a Noetherian ring. If $\omega_A^\bullet$ is a dualizing
complex, then the functor
$$
D : K \longmapsto R\Hom(K, \omega_A^\bullet)
$$
is an anti-equivalence $D_{\textit{Coh}}(A) \to D_{\textit{Coh}}(A)$
which exchanges $D^+_{\textit{Coh}}(A)$ and $D^-_{\textit{Coh}}(A)$
and induces an equivalence $D^b_{\textit{Coh}}(A) \to D^b_{\textit{Coh}}(A)$.
Moreover $D \circ D$ is isomorphic to the identity functor.
\end{lemma}

\begin{proof}
Let $K$ be an object of $D_{\textit{Coh}}(A)$. Pick an integer $n$ and
consider the distinguihsed triangle
$$
\tau_{\leq n}K \to K \to \tau_{\geq n + 1}K \to \tau_{\leq n}K[1]
$$
see Derived Categories, Remark
\ref{derived-remark-truncation-distinguished-triangle}.
Since $\omega_A^\bullet$ has finite injective dimension we see
that $R\Hom(\tau_{\geq n + 1}K, \omega_A^\bullet)$ has vanishing
cohomology in degrees $\geq n - c$ for some constant $c$.
On the other hand, we obtain a spectral sequence
$$
\text{Ext}_A^p(H^{-q}(\tau_{\leq n}K, \omega_A^\bullet)
\Rightarrow
\text{Ext}_A^{p + q}(\tau_{\leq n}K, \omega_A^\bullet) =
H^{p + q}(R\Hom(\tau_{\leq n}K, \omega_A^\bullet))
$$
which shows that these cohomology modules are finite. Since for
$n > p + q + c$ this is equal to $H^{p + q}(R\Hom(K, \omega_A^\bullet))$
we see that $R\Hom(K, \omega_A^\bullet)$ is indeed an object
of $D_{\textit{Coh}}(A)$.
By More on Algebra, Lemma
\ref{more-algebra-lemma-internal-hom-evaluate-isomorphism-technical}
and the assumptions on the dualizing complex
we obtain a canonical isomorphism
$$
K = R\Hom(\omega_A^\bullet, \omega_A^\bullet) \otimes_A^\mathbf{L} K
\longrightarrow
R\Hom(R\Hom(K, \omega_A^\bullet), \omega_A^\bullet)
$$
Thus our functor has a quasi-inverse and the proof is complete.
\end{proof}

\begin{lemma}
\label{lemma-detect-cohomology}
Let $A$ be a Noetherian ring. Let $K \in D^b_{\textit{Coh}}(A)$.
Let $\mathfrak m$ be a maximal ideal of $A$.
If $H^i(K)/\mathfrak m H^i(K) \not = 0$, then there exists a finite
$A$-module $E$ annihilated by a power of $\mathfrak m$
and a map $K \to E[-i]$ which is nonzero on $H^i(K)$.
\end{lemma}

\begin{proof}
Let $I$ be the injective hull of the residue field of $\mathfrak m$.
If $H^i(K)/\mathfrak m H^i(K) \not = 0$, then there exists a nonzero
map $H^i(K) \to I$. Since $I$ is injective, we can lift this to a
nonzero map $K \to I[-i]$. Recall that $I = \bigcup I[\mathfrak m^n]$,
see Lemma \ref{lemma-torsion-submodule-sum-injective-hulls}
and that each of the modules $E = I[\mathfrak m^n]$ is of the
desired type. Thus it suffices to prove that
$$
\Hom_{D(A)}(K, I) = \colim \Hom_{D(A)}(K, I[\mathfrak m^n])
$$
This would be immediate if $K$ where a compact object
(or a perfect object) of $D(A)$. This is not the case, but
$K$ is a pseudo-coherent object which is enough here. Namely,
we can represent $K$ by a bounded above complex of finite
free $R$-modules $K^\bullet$. In this case the $\Hom$ groups
above are computed by using $\Hom_{K(A)}(K^\bullet, -)$.
As each $K^n$ is finite free the limit statement holds and the
proof is complete.
\end{proof}

\noindent
Let $R$ be a ring. We will say that an object $L$ of $D(R)$ is
{\it invertible} if there is an open covering $\Spec(R) = \bigcup D(f_i)$
such that $L \otimes_R R_{f_i} \cong R_{f_i}[-n_i]$ for some integers $n_i$.
In this case, the function
$$
\mathfrak p \mapsto n_\mathfrak p,\quad
\text{where }n_\mathfrak p\text{ is the unique integer such that }
H^{n_\mathfrak p}(L \otimes \kappa(\mathfrak p)) \not = 0
$$
is locally constant on $\Spec(R)$. In particular, it follows that
$L = \bigoplus H^n(L)[-n]$ which gives a well defined complex of
$R$-modules (with zero differentials) representing $L$. Since each
$H^n(L)$ is finite projective and nonzero for only a finite number of
$n$ we also see that $L$ is a perfect object of $D(R)$.

\begin{lemma}
\label{lemma-equivalence-comes-from-invertible}
Let $A$ be a Noetherian ring. Let
$F : D^b_{\textit{Coh}}(A) \to D^b_{\textit{Coh}}(A)$ be an $A$-linear
equivalence of categories. Then $F(A)$ is an invertible object of $D(A)$.
\end{lemma}

\begin{proof}
Let $\mathfrak m \subset A$ be a maximal ideal with residue field $\kappa$.
Consider the object $F(\kappa)$. Since
$\kappa = \Hom_{D(A)}(\kappa, \kappa)$ we find that all
cohomology groups of $F(\kappa)$ are annihilated by $\mathfrak m$.
We also see that
$$
\text{Ext}^i_A(\kappa, \kappa) = \text{Ext}^i_A(F(\kappa), F(\kappa))
= \Hom_{D(A)}(F(\kappa), F(\kappa)[-i])
$$
is zero for $i < 0$. Say $H^a(F(\kappa)) \not = 0$ and
$H^b(F(\kappa)) \not = 0$ with $a$ minimal and $b$ maximal
(so in particular $a \leq b$). Then there is a nonzero map
$$
F(\kappa) \to H^b(F(\kappa))[-b] \to H^a(F(\kappa))[-b]
\to F(\kappa)[a - b]
$$
in $D(A)$ (nonzero because it induces a nonzero map on cohomology).
This proves that $b = a$. We conclude that $F(\kappa) = \kappa[-a]$.

\medskip\noindent
Let $G$ be a quasi-inverse to our functor $F$. Arguing as above
we find an integer $b$ such that $G(\kappa) = \kappa[-b]$.
On composing we find $a + b = 0$. Let $E$ be a finite $A$-module
wich is annihilated by a power of $\mathfrak m$. Arguing by
induction on the length of $E$ we find that $G(E) = E'[-b]$
for some finite $A$-module $E'$ annihilated by a power of
$\mathfrak m$. Then $E[-a] = F(E')$.
Next, we consider the groups
$$
\text{Ext}^i_A(A, E') = \text{Ext}^i_A(F(A), F(E')) =
\Hom_{D(A)}(F(A), E[-a + i])
$$
The left hand side is nonzero if and only if $i = 0$ and then
we get $E'$. Applying this with $E = E' = \kappa$ and using Nakayama's
lemma this implies that $H^j(F(A))$ is zero for $j > a$ and
generated by $1$ element for $j = a$. On the other hand, if
$H^j(F(A))_\mathfrak m$ is not zero for some $j < a$, then
there is a map $F(A) \to E[-a + i]$ for some $i < 0$ and some
$E$ (Lemma \ref{lemma-detect-cohomology})
Thus we see that $F(A)_\mathfrak m = M[-a]$
for some $A_\mathfrak m$-module $M$ generated by $1$ element.
However, since
$$
A_\mathfrak m = \Hom_{D(A)}(A, A)_\mathfrak m =
\Hom_{D(A)}(F(A), F(A))_\mathfrak m = \Hom_{A_\mathfrak m}(M, M)
$$
we see that $M \cong A_\mathfrak m$. We conclude that there exists
an element $f \in A$, $f \not \in \mathfrak m$ such that
$F(A)_f$ is isomorphic to $A_f[-a]$. This finishes the proof.
\end{proof}

\begin{lemma}
\label{lemma-dualizing-unique}
Let $A$ be a Noetherian ring. If $\omega_A^\bullet$ and
$(\omega'_A)^\bullet$ are dualizing complexes, then
$(\omega'_A)^\bullet$ is quasi-isomorphic to
$\omega_A^\bullet \otimes_A^\mathbf{L} L$
for some invertible object $L$ of $D(A)$.
\end{lemma}

\begin{proof}
By Lemmas \ref{lemma-dualizing} and
\ref{lemma-equivalence-comes-from-invertible} the functor
$K \mapsto R\Hom(R\Hom(K, \omega_A^\bullet), (\omega_A')^\bullet)$
maps $A$ to an invertible object $L$. In other words, there is
an isomorphism
$$
L \longrightarrow R\Hom(\omega_A^\bullet, (\omega_A')^\bullet)
$$
Since $L$ has finite tor dimension, this means that we can apply
More on Algebra, Lemma
\ref{more-algebra-lemma-internal-hom-evaluate-isomorphism-technical}
to see that
$$
R\Hom(\omega_A^\bullet, (\omega'_A)^\bullet) \otimes_A^\mathbf{L} K
\longrightarrow
R\Hom(R\Hom(K, \omega_A^\bullet), (\omega_A')^\bullet)
$$
is an isomorphism for $K$ in $D^b_{\textit{Coh}}(A)$.
In particular, setting $K = \omega_A^\bullet$ finishes the proof.
\end{proof}

\begin{lemma}
\label{lemma-dualizing-localize}
Let $A$ be a Noetherian ring. Let $B = S^{-1}A$ be a localization.
If $\omega_A^\bullet$ is a dualizing
complex, then $\omega_A^\bullet \otimes_A B$ is a dualizing
complex for $B$.
\end{lemma}

\begin{proof}
Let $\omega_A^\bullet \to I^\bullet$ be a quasi-isomorphism
with $I^\bullet$ a bounded complex of injectives.
Then $S^{-1}I^\bullet$ is a bounded complex of injective
$B = S^{-1}A$-modules (Lemma \ref{lemma-localization-injective-modules})
representing $\omega_A^\bullet \otimes_A B$.
Thus $\omega_A^\bullet \otimes_A B$ has finite injective dimension.
Since $H^i(\omega_A^\bullet \otimes_A B) = H^i(\omega_A^\bullet) \otimes_A B$
by flatness of $A \to B$ we see that $\omega_A^\bullet \otimes_A B$
has finite cohomology modules. Finally, the map
$$
B \longrightarrow
R\Hom(\omega_A^\bullet \otimes_A B, \omega_A^\bullet \otimes_A B)
$$
is a quasi-isomorphism as formation of internal hom commutes with
flat base change in this case, see
More on Algebra, Lemma \ref{more-algebra-lemma-base-change-RHom}.
\end{proof}

\begin{lemma}
\label{lemma-dualizing-glue}
Let $A$ be a Noetherian ring. Let $f_1, \ldots, f_n \in A$
generate the unit ideal. If $\omega_A^\bullet$ is a complex
of $A$-modules such that $(\omega_A^\bullet)_{f_i}$ is a dualizing
complex for $A_{f_i}$ for all $i$, then $\omega_A^\bullet$ is a dualizing
complex for $A$.
\end{lemma}

\begin{proof}
Consider the double complex
$$
\prod\nolimits_{i_0} (\omega_A^\bullet)_{f_{i_0}}
\to
\prod\nolimits_{i_0 < i_1} (\omega_A^\bullet)_{f_{i_0}f_{i_1}}
\to \ldots
$$
The associated total complex is quasi-isomorphic to $\omega_A^\bullet$
for example by Descent, Remark \ref{descent-remark-standard-covering}
or by
Derived Categories of Schemes, Lemma
\ref{perfect-lemma-alternating-cech-complex-complex-computes-cohomology}.
By assumption the complexes $(\omega_A^\bullet)_{f_i}$ have
finite injective dimension as complexes of $A_{f_i}$-modules.
This implies that each of the complexes
$(\omega_A^\bullet)_{f_{i_0} \ldots f_{i_p}}$, $p > 0$ has
finite injective dimension over $A_{f_{i_0} \ldots f_{i_p}}$,
see Lemma \ref{lemma-localization-injective-modules}.
This in turn implies that each of the complexes
$(\omega_A^\bullet)_{f_{i_0} \ldots f_{i_p}}$, $p > 0$ has
finite injective dimension over $A$, see
Lemma \ref{lemma-injective-flat}. Hence $\omega_A^\bullet$
has finite injective dimension as a complex of $A$-modules
(as it can be represented by a complex endowed with
a finite filtration whose graded parts have finite injective
dimension). Since $H^n(\omega_A^\bullet)_{f_i}$ is a finite
$A_{f_i}$ module for each $i$ we see that $H^i(\omega_A^\bullet)$
is a finite $A$-module, see Algebra, Lemma \ref{algebra-lemma-cover}.
Finally, the (derived) base change of the map
$A \to R\Hom(\omega_A^\bullet, \omega_A^\bullet)$ to $A_{f_i}$
is the map
$A_{f_i} \to R\Hom((\omega_A^\bullet)_{f_i}, (\omega_A^\bullet)_{f_i})$ by
More on Algebra, Lemma \ref{more-algebra-lemma-base-change-RHom}.
Hence we deduce that
$A \to R\Hom(\omega_A^\bullet, \omega_A^\bullet)$
is an isomorphism and the proof is complete.
\end{proof}

\begin{lemma}
\label{lemma-dualizing-quotient}
Let $A \to B$ be a surjective homomorphism of Noetherian rings.
Let $\omega_A^\bullet$ be a dualizing complex.
Then $R\Hom(B, \omega_A^\bullet)$ is a dualizing complex for $B$.
\end{lemma}

\begin{proof}
Let $\omega_A^\bullet \to I^\bullet$ be a quasi-isomorphism
with $I^\bullet$ a bounded complex of injectives.
Then $\Hom_A(B, I^\bullet)$ is a bounded complex of injective
$B$-modules (Lemma \ref{lemma-hom-injective}) representing
$R\Hom(B, \omega_A^\bullet)$.
Thus $R\Hom(B, \omega_A^\bullet)$ has finite injective dimension.
By Lemma \ref{lemma-exact-support-coherent} it is an object of
$D_{\textit{Coh}}(B)$. Finally, we compute
$$
\Hom_{D(B)}(R\Hom(B, \omega_A^\bullet), R\Hom(B, \omega_A^\bullet)) =
\Hom_{D(A)}(R\Hom(B, \omega_A^\bullet), \omega_A^\bullet) = B
$$
and for $n \not = 0$ we compute
$$
\Hom_{D(B)}(R\Hom(B, \omega_A^\bullet), R\Hom(B, \omega_A^\bullet)[n]) =
\Hom_{D(A)}(R\Hom(B, \omega_A^\bullet), \omega_A^\bullet[n]) = 0
$$
which proves the last property of a dualizing complex.
In the displayed equations, the first
equality holds by Lemma \ref{lemma-right-adjoint}
and the second equality holds by Lemma \ref{lemma-dualizing}.
\end{proof}

\begin{lemma}
\label{lemma-dualizing-polynomial-ring}
Let $A$ be a Noetherian ring. If $\omega_A^\bullet$ is a dualizing
complex, then $\omega_A^\bullet \otimes_A A[x]$ is a dualizing
complex for $A[x]$.
\end{lemma}

\begin{proof}
Set $B = A[x]$ and $\omega_B^\bullet = \omega_A^\bullet \otimes_A B$.
It follows from Lemma \ref{lemma-injective-dimension-over-polynomial-ring}
and More on Algebra, Lemma \ref{more-algebra-lemma-finite-injective-dimension}
that $\omega_B^\bullet$ has finite injective dimension.
Since $H^i(\omega_B^\bullet) = H^i(\omega_A^\bullet) \otimes_A B$
by flatness of $A \to B$ we see that $\omega_A^\bullet \otimes_A B$
has finite cohomology modules. Finally, the map
$$
B \longrightarrow R\Hom(\omega_B^\bullet, \omega_B^\bullet)
$$
is a quasi-isomorphism as formation of internal hom commutes with
flat base change in this case, see
More on Algebra, Lemma \ref{more-algebra-lemma-base-change-RHom}.
\end{proof}

\begin{proposition}
\label{proposition-dualizing-essentially-finite-type}
Let $A$ be a Noetherian ring which has a dualizing complex.
Then any $A$-algebra essentially of finite type over $A$
has a dualixing complex.
\end{proposition}

\begin{proof}
This follows from a combination of
Lemmas \ref{lemma-dualizing-localize},
\ref{lemma-dualizing-quotient}, and \ref{lemma-dualizing-polynomial-ring}.
\end{proof}

\begin{lemma}
\label{lemma-find-function}
Let $A$ be a Noetherian ring. Let $\omega_A^\bullet$ be a dualizing
complex. Let $\mathfrak m \subset A$ be a maximal ideal and set
$\kappa = A/\mathfrak m$. Then
$R\Hom_A(\kappa, \omega_A^\bullet) \cong \kappa[n]$ for some
$n \in \mathbf{Z}$.
\end{lemma}

\begin{proof}
This is true because $R\Hom_A(\kappa, \omega_A^\bullet)$ is a dualizing
complex over $\kappa$ (Lemma \ref{lemma-dualizing-quotient}),
because dualizing complexes over $\kappa$ are unique up to shifts
(Lemma \ref{lemma-dualizing-unique}), and because $\kappa$ is a
dualizing complex over $\kappa$.
\end{proof}




\section{Dualizing complexes over local rings}
\label{section-dualizing-local}

\noindent
In this section $(A, \mathfrak m, \kappa)$ will be a Noetherian local
ring endowed with a dualizing complex $\omega_A^\bullet$ such that
the integer $n$ of Lemma \ref{lemma-find-function} is zero.
More precisely, we assume that $R\Hom_A(\kappa, \omega_A^\bullet) = \kappa[0]$.
In this case we will say that the dualizing complex is {\it normalized}.
Observe that a normalized dualizing complex is unique up to
isomorphism and that any other dualizing complex for $A$ is isomorphic
to a shift of a normalized one (Lemma \ref{lemma-dualizing-unique}).

\begin{lemma}
\label{lemma-normalized-quotient}
Let $(A, \mathfrak m, \kappa)$ be a Noetherian local
ring with normalized dualizing complex $\omega_A^\bullet$.
Let $A \to B$ be surjective. Then
$\omega_B^\bullet = R\Hom_A(B, \omega_A^\bullet)$ is a
normalized dualizing complex for $B$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-dualizing-quotient} the complex
$\omega_B^\bullet$ is dualizing for $B$. We compute
$$
R\Hom_B(\kappa, R\Hom_A(B, \omega_A^\bullet)) =
R\Hom_A(\kappa, \omega_A^\bullet) \cong \kappa[0]
$$
The first equality by Lemma \ref{lemma-right-adjoint}.
\end{proof}

\begin{lemma}
\label{lemma-equivalence-finite-length}
Let $(A, \mathfrak m, \kappa)$ be a Noetherian local
ring. Let $F$ be an $A$-linear self-equivalence of the category of
finite length $A$-modules. Then $F$ is isomorphic to the identity functor.
\end{lemma}

\begin{proof}
Since $\kappa$ is the unique simple object of the category we have
$F(\kappa) \cong \kappa$. Since our category is abelian, we find that
$F$ is exact. Hence $F(E)$ has the same length as $E$ for all finite
length modules $E$.
Since $\Hom(E, \kappa) = \Hom(F(E), F(\kappa)) \cong \Hom(F(E), \kappa)$
we conclude from Nakayama's lemma that $E$ and $F(E)$ have the same
number of generators. Hence $F(A/\mathfrak m^n)$ is a cyclic $A$-module.
Pick a generator $e \in F(A/\mathfrak m^n)$.
Since $F$ is $A$-linear we conclude that $\mathfrak m^n e = 0$.
The map $A/\mathfrak m^n \to F(A/\mathfrak m^n)$ has to be
an isomorphism as the lengths are equal. Pick an element
$$
e \in \lim F(A/\mathfrak m^n)
$$
which maps to a generator for all $n$ (small argument omitted).
Then we obtain a system of isomorphisms
$A/\mathfrak m^n \to F(A/\mathfrak m^n)$ compatible with all
$A$-module maps $A/\mathfrak m^n \to A/\mathfrak m^{n'}$ (by $A$-linearity
of $F$ again). Since any finite lenghth module is a cokernel
of a map between direct sums of cyclic modules, we obtain the isomorphism
of the lemma.
\end{proof}

\begin{lemma}
\label{lemma-dualizing-finite-length}
Let $(A, \mathfrak m, \kappa)$ be a Noetherian local
ring with normalized dualizing complex $\omega_A^\bullet$.
Let $E$ be an injective hull of $\kappa$. Then there exists
a functorial isomorphism
$$
R\Hom(N, \omega_A^\bullet) = \Hom_A(N, E)[0]
$$
for $N$ running through the finite length $A$-modules.
\end{lemma}

\begin{proof}
By induction on the length of $N$ we see that $R\Hom(N, \omega_A^\bullet)$
is a module of finite length sitting in degree $0$. Thus
$R\Hom_A(-, \omega_A^\bullet)$ induces an anti-equivalence
on the category of finite length modules. Since the same is true
for $\Hom_A(-, E)$ by Proposition \ref{proposition-matlis} we see that
$$
N \longmapsto \Hom_A(R\Hom(N, \omega_A^\bullet), E)
$$
is an equivalence as in Lemma \ref{lemma-equivalence-finite-length}.
Hence it is isommorphic to the identity functor.
Since $\Hom_A(-, E)$ applied twice is the identity
(Proposition \ref{proposition-matlis}) we obtain
the statement of the lemma.
\end{proof}

\begin{lemma}
\label{lemma-dualizing-artinian}
Let $(A, \mathfrak m, \kappa)$ be a Noetherian local
ring with normalized dualizing complex $\omega_A^\bullet$.
If $\dim(A) = 0$, then $\omega_A^\bullet \cong E[0]$
where $E$ is an injective hull of the residue field.
\end{lemma}

\begin{proof}
Immediate from Lemma \ref{lemma-dualizing-finite-length}.
\end{proof}

\begin{lemma}
\label{lemma-divide-by-finite-length-ideal}
Let $(A, \mathfrak m, \kappa)$ be a Noetherian local
ring with normalized dualizing complex. Let $I \subset \mathfrak m$ be an
ideal of finite length. Set $B = A/I$. Then there is a distinguished
triangle
$$
\omega_B^\bullet \to \omega_A^\bullet \to \Hom_A(I, E)[0] \to
\omega_B^\bullet[1]
$$
in $D(A)$ where $E$ is an injective hull of $\kappa$ and
$\omega_B^\bullet$ is a normalized dualizing complex for $B$.
\end{lemma}

\begin{proof}
Use the short exact sequence $0 \to I \to A \to B \to 0$
and Lemmas \ref{lemma-dualizing-finite-length} and
\ref{lemma-normalized-quotient}.
\end{proof}

\begin{lemma}
\label{lemma-divide-by-nonzerodivisor}
Let $(A, \mathfrak m, \kappa)$ be a Noetherian local
ring with normalized dualizing complex $\omega_A^\bullet$.
Let $f \in \mathfrak m$ be a
nonzerodivisor. Set $B = A/(f)$. Then there is a distinguished
triangle
$$
\omega_B^\bullet \to \omega_A^\bullet \to \omega_A^\bullet \to
\omega_B^\bullet[1]
$$
in $D(A)$ where $\omega_B^\bullet$ is a normalized dualizing complex
for $B$.
\end{lemma}

\begin{proof}
Use the short exact sequence $0 \to A \to A \to B \to 0$
and Lemma \ref{lemma-normalized-quotient}.
\end{proof}

\begin{lemma}
\label{lemma-sitting-in-degrees}
Let $(A, \mathfrak m, \kappa)$ be a Noetherian local ring with
normalized dualizing complex $\omega_A^\bullet$. Let $d = \dim(A)$.
Then
\begin{enumerate}
\item if $H^i(\omega_A^\bullet)$ is nonzero, then $i \in \{-d, \ldots, 0\}$,
\item the dimension of the support of $H^i(\omega_A^\bullet)$ is
at most $-i$,
\end{enumerate}
\end{lemma}

\begin{proof}
We prove this by induction on the dimension of $A$.
If $\dim(A) = 0$ this follows immediately from
Lemma \ref{lemma-dualizing-artinian}.

\medskip\noindent
Assume that the result holds for rings of dimension $< d$ and
that $A$ has depth at least $1$. Then we can find a nonzero divisor
$f$ and apply Lemma \ref{lemma-divide-by-nonzerodivisor}
and the induction hypothesis to $B$.
It follows that multiplication by $f$ is surjective on
$H^i(\omega_A^\bullet)$ for $i > 0$ and $i < d$. By Nakayama
we conclude these cohomology modules are zero, i.e., (1) holds.
If the dimension of the support of $H^i(\omega_A^\bullet)$
is $e$, then the dimension of the support of
$H^i(\omega_A^\bullet)/f H^i(\omega_A^\bullet) \subset
H^{i + 1}(\omega_B^\bullet)$ is at least $e - 1$.
Hence our induction assumption gives that $e \leq -i$.

\medskip\noindent
If $A$ has depth $0$, then we let $I = A[\mathfrak m^\infty]$
be the maximal ideal of $A$ having finite length. Then $B = A/I$
has depth $\geq 1$ so we know the result for $B$. Applying
Lemma \ref{lemma-divide-by-finite-length-ideal}
we obtain the result for $A$.
\end{proof}

\begin{lemma}
\label{lemma-nonvanishing-generically-local}
Let $(A, \mathfrak m, \kappa)$ be a Noetherian local ring with
normalized dualizing complex $\omega_A^\bullet$.
Let $\mathfrak p$ be a minimal prime of $A$ with
$\dim(A/\mathfrak p) = e$. Then
$H^i(\omega_A^\bullet)_\mathfrak p$ is nonzero
if and only if $i = -e$.
\end{lemma}

\begin{proof}
Since $A_\mathfrak p$ has dimension zero, there exists an integer
$n > 0$ such that $\mathfrak p^nA_\mathfrak p$ is zero.
Set $B = A/\mathfrak p^n$ and
$\omega_B^\bullet = R\Hom_A(B, \omega_A^\bullet)$.
Since $B_\mathfrak p = A_\mathfrak p$ we see that
$(\omega_B^\bullet)_\mathfrak p \cong (\omega_A^\bullet)_\mathfrak p$
by using More on Algebra, Lemma \ref{more-algebra-lemma-base-change-RHom}.
By Lemma \ref{lemma-normalized-quotient} we may replace $A$ by $B$.
After doing so, we see that $\dim(A) = e$. Then we see that
$H^i(\omega_A^\bullet)_\mathfrak p$ can only be nonzero if $i = -e$
by Lemma \ref{lemma-sitting-in-degrees}.
On the other hand, since $(\omega_A^\bullet)_\mathfrak p$
is a dualizing complex for the nonzero ring $A_\mathfrak p$
(Lemma \ref{lemma-dualizing-localize})
we see that the remaining module has to be nonzero.
\end{proof}







\section{The dimension function of a dualizing complex}
\label{section-dimension-function}

\noindent
Our results in the local setting have the following consequence:
a Noetherian ring with has a dualizing complex is a
universally catenary ring of finite dimension.

\begin{lemma}
\label{lemma-nonvanishing-generically}
Let $A$ be a Noetherian ring. Let $\mathfrak p$ be a minimal prime
of $A$. Then $H^i(\omega_A^\bullet)_\mathfrak p$ is nonzero
for exactly one $i$.
\end{lemma}

\begin{proof}
The complex $\omega_A^\bullet \otimes_A A_\mathfrak p$
is a dualizing complex for $A_\mathfrak p$
(Lemma \ref{lemma-dualizing-localize}).
The dimension of $A_\mathfrak p$ is zero as $\mathfrak p$
is minimal. Hence the result follows from
Lemma \ref{lemma-dualizing-artinian}.
\end{proof}

\noindent
Let $A$ be a Noetherian ring and let $\omega_A^\bullet$ be a dualizing
complex. Lemma \ref{lemma-find-function} allows us to define a function
$$
\delta = \delta_{\omega_A^\bullet} : \Spec(A) \longrightarrow \mathbf{Z}
$$
by mapping $\mathfrak p$ to the integer of Lemma \ref{lemma-find-function}
for the dualizing complex $(\omega_A^\bullet)_\mathfrak p$
over $A_\mathfrak p$ (Lemma \ref{lemma-dualizing-localize})
and the residue field $\kappa(\mathfrak p)$. To be precise, we define
$\delta(\mathfrak p)$ to be the unique integer such that
$$
(\omega_A^\bullet)_\mathfrak p[-\delta(\mathfrak p)]
$$
is a normalized dualizing complex over the Noetherian local ring
$A_\mathfrak p$.

\begin{lemma}
\label{lemma-quotient-function}
Let $A$ be a Noetherian ring and let $\omega_A^\bullet$ be a dualizing
complex. Let $A \to B$ be a surjective ring map and let
$\omega_B^\bullet = R\Hom(B, \omega_A^\bullet)$ be the dualizing
complex for $B$ of Lemma \ref{lemma-dualizing-quotient}. Then we have
$$
\delta_{\omega_B^\bullet} = \delta_{\omega_A^\bullet}|_{\Spec(B)}
$$
\end{lemma}

\begin{proof}
This follows from the definition of the functions and
Lemma \ref{lemma-normalized-quotient}.
\end{proof}

\begin{lemma}
\label{lemma-dimension-function}
Let $A$ be a Noetherian ring and let $\omega_A^\bullet$ be a dualizing
complex. The function $\delta = \delta_{\omega_A^\bullet}$
defined above is a dimension function
(Topology, Definition \ref{topology-definition-dimension-function}).
\end{lemma}

\begin{proof}
Let $\mathfrak p \subset \mathfrak q$ be an immediate specialization.
We have to show that $\delta(\mathfrak p) = \delta(\mathfrak q) + 1$.
We may replace $A$ by $A/\mathfrak p$, the complex $\omega_A^\bullet$ by
$\omega_{A/\mathfrak p}^\bullet = R\Hom(A/\mathfrak p, \omega_A^\bullet)$,
the prime $\mathfrak p$ by $(0)$, and the prime $\mathfrak q$
by $\mathfrak q/\mathfrak p$,
see Lemma \ref{lemma-quotient-function}. Thus we may assume that
$A$ is a domain, $\mathfrak p = (0)$, and $\mathfrak q$ is a prime
ideal of height $1$.

\medskip\noindent
Then $H^i(\omega_A^\bullet)_{(0)}$ is nonzero
for exactly one $i$, say $i_0$, by Lemma \ref{lemma-nonvanishing-generically}.
In fact $i_0 = -\delta((0))$ because
$(\omega_A^\bullet)_{(0)}[-\delta((0))]$
is a normalized dualizing complex over the field $A_{(0)}$.

\medskip\noindent
On the other hand $(\omega_A^\bullet)_\mathfrak q[-\delta(\mathfrak q)]$
is a normalized dualizing complex for $A_\mathfrak q$. By
Lemma \ref{lemma-nonvanishing-generically-local}
we see that
$$
H^e((\omega_A^\bullet)_\mathfrak q[-\delta(\mathfrak q)])_{(0)} =
H^{e - \delta(\mathfrak q)}(\omega_A^\bullet)_{(0)}
$$
is nonzero only for $e = -\dim(A_\mathfrak q) = -1$.
We conclude
$$
-\delta((0)) = -1 - \delta(\mathfrak p)
$$
as desired.
\end{proof}

\begin{lemma}
\label{lemma-universally-catenary}
Let $A$ be a Noetherian ring which has a dualizing
complex. Then $A$ is universally catenary of finite dimension.
\end{lemma}

\begin{proof}
Because $\Spec(A)$ has a dimension function by
Lemma \ref{lemma-dimension-function}
it is catenary, see
Topology, Lemma \ref{topology-lemma-dimension-function-catenary}.
Hence $A$ is catenary, see
Algebra, Lemma \ref{algebra-lemma-catenary}.
It follows from
Proposition \ref{proposition-dualizing-essentially-finite-type}
that $A$ is universally catenary.

\medskip\noindent
Because any dualizing complex $\omega_A^\bullet$ is
in $D^b_{\textit{Coh}}(A)$ the values of the function
$\delta_{\omega_A^\bullet}$ in minimal primes are bounded by
Lemma \ref{lemma-nonvanishing-generically}.
On the other hand, for a maximal ideal $\mathfrak m$ with
residue field $\kappa$ the integer $i = -\delta(\mathfrak m)$
is the unique integer such that
$\text{Ext}_A^i(\kappa, \omega_A^\bullet)$ is nonzero
(Lemma \ref{lemma-find-function}).
Since $\omega_A^\bullet$ has finite injective dimension
these values are bounded too. Since the dimension of
$A$ is the maximal value of $\delta(\mathfrak p) - \delta(\mathfrak m)$
where $\mathfrak p \subset \mathfrak m$ are a pair
consisting of a minimal prime and a maximal prime we find that the
dimension of $\Spec(A)$ is bounded.
\end{proof}





\section{The local duality theorem}
\label{section-local-duality}

\noindent
The main result in this section is due to Grothendieck.

\begin{lemma}
\label{lemma-local-cohomology-of-dualizing}
Let $(A, \mathfrak m, \kappa)$ be a Noetherian local ring.
Let $\omega_A^\bullet$ be a normalized dualizing complex.
Let $Z = V(\mathfrak m) \subset \Spec(A)$.
Then $E = R^0\Gamma_Z(\omega_A^\bullet)$ is an injective hull of
$\kappa$ and $R\Gamma_Z(\omega_A^\bullet) = E[0]$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-local-cohomology-noetherian} we have
$R\Gamma_{\mathfrak m} = R\Gamma_Z$. Thus
$$
R\Gamma_Z(\omega_A^\bullet) =
R\Gamma_{\mathfrak m}(\omega_A^\bullet) =
\text{hocolim}\ R\Hom(A/\mathfrak m^n, \omega_A^\bullet)
$$
by Lemma \ref{lemma-local-cohomology-ext}. Let $E'$ be an injective
hull of the residue field.
By Lemma \ref{lemma-dualizing-finite-length}
we can find isomorphisms
$$
R\Hom(A/\mathfrak m^n, \omega_A^\bullet) \cong \Hom_A(A/I^n, E')[0]
$$
compatible with transition maps. Since
$E' = \bigcup E'[\mathfrak m^n] = \colim \Hom_A(A/I^n, E')$
by Lemma \ref{lemma-union-artinian}
we conclude that $E \cong E'$ and that all other cohomology
groups of the complex $R\Gamma_Z(\omega_A^\bullet)$ are zero.
\end{proof}

\begin{remark}
\label{remark-specific-injective-hull}
Let $(A, \mathfrak m, \kappa)$ be a Noetherian local ring
with a normalized dualizing complex $\omega_A^\bullet$.
By Lemma \ref{lemma-local-cohomology-of-dualizing}
above we see that $R\Gamma_Z(\omega_A^\bullet)$
is an injective hull of the residue field placed in degree $0$.
In fact, this gives a ``construction'' or ``realization''
of the injective hull which is slightly more canonical than
just picking any old injective hull. Namely, a normalized
dualizing complex is unique up to isomorphism, with group
of automorphisms the group of units of $A$, whereas an
injective hull of $\kappa$ is unique up to isomorphism, with
group of automorphisms the group of units of the completion
$A^\wedge$ of $A$ with respect to $\mathfrak m$.
\end{remark}

\noindent
Here is the main result of this section.

\begin{theorem}
\label{theorem-local-duality}
Let $(A, \mathfrak m, \kappa)$ be a Noetherian local ring.
Let $\omega_A^\bullet$ be a normalized dualizing complex.
Let $E$ be an injective hull of the residue field.
Let $Z = V(\mathfrak m) \subset \Spec(A)$.
Denote ${}^\wedge$ derived completion with respect to $\mathfrak m$.
Then
$$
R\Hom(K, \omega_A^\bullet)^\wedge \cong R\Hom(R\Gamma_Z(K), E[0])
$$
for $K$ in $D(A)$.
\end{theorem}

\begin{proof}
Observe that $E[0] \cong R\Gamma_Z(\omega_A^\bullet)$ by
Lemma \ref{lemma-local-cohomology-of-dualizing}.
By More on Algebra, Lemma \ref{more-algebra-lemma-completion-RHom}
completion on the left hand side goes inside.
Thus we have to prove
$$
R\Hom(K^\wedge, (\omega_A^\bullet)^\wedge)
=
R\Hom(R\Gamma_Z(K), R\Gamma_Z(\omega_A^\bullet))
$$
This follows from the equivalence between
$D_{comp}(A, \mathfrak m)$ and $D_{\mathfrak m^\infty\text{-torsion}}(A)$
given in Proposition \ref{proposition-torsion-complete}.
More precisely, it is a special case of Lemma \ref{lemma-compare-RHom}.
\end{proof}

\noindent
Here is a special case of the theorem above.

\begin{lemma}
\label{lemma-special-case-local-duality}
Let $(A, \mathfrak m, \kappa)$ be a Noetherian local ring.
Let $\omega_A^\bullet$ be a normalized dualizing complex.
Let $E$ be an injective hull of the residue field.
Let $K \in D_{\textit{Coh}}(A)$. Then
$$
\text{Ext}^i_A(K, \omega_A^\bullet)^\wedge =
\Hom_A(H^i_{\mathfrak m}(K), E)
$$
where ${}^\wedge$ denotes $\mathfrak m$-adic completion.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-dualizing} we see that $R\Hom(K, \omega_A^\bullet)$
is an object of $D_{\textit{Coh}}(A)$.
It follows that the cohomology modules of the derived completion
of $R\Hom(K, \omega_A^\bullet)$ are equal to the usual completions
$\text{Ext}^i_A(K, \omega_A^\bullet)^\wedge$ by
More on Algebra, Lemma
\ref{more-algebra-lemma-derived-completion-pseudo-coherent}.
On the other hand, we have $R\Gamma_{\mathfrak m} = R\Gamma_Z$
for $Z = V(\mathfrak m)$ by Lemma \ref{lemma-local-cohomology-noetherian}.
Moreover, the functor $\Hom_A(-, E)$ is exact hence
factors through cohomology.
Hence the lemma is consequence of
Theorem \ref{theorem-local-duality}.
\end{proof}





\section{Dualizing complexes on schemes}
\label{section-dualizing-schemes}

\noindent
We define a dualizing complex on a locally Noetherian scheme
to be a complex which affine locally comes from a dualizing
complex on the corresponding ring. This is not completely
standard but agrees with all definitions in the literature
on Noetherian schemes of finite dimension.

\begin{lemma}
\label{lemma-equivalent-definitions}
Let $X$ be a locally Noetherian scheme. Let $K$ be an object of
$D(\mathcal{O}_X)$. The following are equivalent
\begin{enumerate}
\item For every affine open $U = \Spec(A) \subset X$ there exists
a dualizing complex $\omega_A^\bullet$ for $A$ such that
$K|_U$ is isomorphic to the image of $\omega_A^\bullet$ by
the functor $\widetilde{} : D(A) \to D(\mathcal{O}_U)$.
\item There is an affine open covering $X = \bigcup U_i$, $U_i = \Spec(A_i)$
such that for each $i$ there exists a dualizing complex $\omega_i^\bullet$
for $A_i$ such that $K|_U$ is isomorphic to the image of $\omega_i^\bullet$ by
the functor $\widetilde{} : D(A_i) \to D(\mathcal{O}_{U_i})$.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume (2) and let $U = \Spec(A)$ be an affine open of $X$.
Since condition (2) implies that $K$ is in $D_\QCoh(\mathcal{O}_X)$
we find an object $\omega_A^\bullet$ in $D(A)$ whose associated
complex of quasi-coherent sheaves is isomorphic to $K|_U$, see
Derived Categories of Schemes, Lemma
\ref{perfect-lemma-affine-compare-bounded}.
We will show that $\omega_A^\bullet$ is a dualizing complex for $A$
which will finish the proof.

\medskip\noindent
Since $X = \bigcup U_i$ is an open covering, we can find a standard
open covering $U = D(f_1) \cup \ldots \cup D(f_m)$ such that
each $D(f_j)$ is a standard open in one of the affine opens $U_i$, see
Schemes, Lemma \ref{schemes-lemma-standard-open-two-affines}.
Say $D(f_j) = D(g_j)$ for $g_j \in A_{i_j}$.
Then $A_{f_j} \cong (A_{i_j})_{g_j}$ and we have
$$
(\omega_A^\bullet)_{f_j} \cong (\omega_i^\bullet)_{g_j}
$$
in the derived category by
Derived Categories of Schemes, Lemma
\ref{perfect-lemma-affine-compare-bounded}.
By Lemma \ref{lemma-dualizing-localize} we find that
the complex $(\omega_A^\bullet)_{f_j}$ is a dualizing complex over
$A_{f_j}$ for $j = 1, \ldots, m$. This implies that $\omega_A^\bullet$
is dualizing by Lemma \ref{lemma-dualizing-glue}.
\end{proof}

\begin{definition}
\label{definition-dualizing-scheme}
Let $X$ be a locally Noetherian scheme. An object $K$ of
$D(\mathcal{O}_X)$ is called a {\it dualizing complex} if
$K$ satisfies the equivalent conditions of
Lemma \ref{lemma-equivalent-definitions}.
\end{definition}

\noindent
Please see remarks made at the beginning of this section.

\begin{lemma}
\label{lemma-affine-duality}
Let $A$ be a Noetherian ring and let $X = \Spec(A)$. Let $K, L$ be objects
of $D(A)$. If $K \in D_{\textit{Coh}}(A)$ and $L$ has finite injective
dimension, then
$$
R\SheafHom(\widetilde{K}, \widetilde{L})
=
\widetilde{R\Hom(K, L)}
$$
in $D(\mathcal{O}_X)$.
\end{lemma}

\begin{proof}
We may assume that $L$ is given by a finite complex $I^\bullet$
of injective $A$-modules. By induction on the length of $I^\bullet$
and compatibility of the constructions with distinguished triangles,
we reduce to the case that $L = I[0]$ where $I$ is an injective $A$-module.
In this case, Derived Categories of Schemes, Lemma
\ref{perfect-lemma-quasi-coherence-internal-hom}, tells us that
the $n$th cohomology sheaf of $R\SheafHom(\widetilde{K}, \widetilde{L})$
is the sheaf associated to the presheaf
$$
D(f) \longmapsto \text{Ext}^n_{A_f}(K \otimes_A A_f, I \otimes_A A_f)
$$
Since $A$ is Noetherian, the $A_f$-module $I \otimes_A A_f$ is injective
(Lemma \ref{lemma-localization-injective-modules}). Hence we see that
\begin{align*}
\text{Ext}^n_{A_f}(K \otimes_A A_f, I \otimes_A A_f)
& =
\Hom_{A_f}(H^{-n}(K \otimes_A A_f), I \otimes_A A_f) \\
& =
\Hom_{A_f}(H^{-n}(K) \otimes_A A_f, I \otimes_A A_f) \\
& =
\Hom_A(H^{-n}(K), I) \otimes_A A_f
\end{align*}
The last equality because $H^{-n}(K)$ is a finite $A$-module.
This proves that the canonical map
$$
\widetilde{R\Hom(K, L)}
\longrightarrow
R\SheafHom(\widetilde{K}, \widetilde{L})
$$
is a quasi-isomorphism in this case and the proof is done.
\end{proof}

\begin{lemma}
\label{lemma-dualizing-schemes}
Let $K$ be a dualizing complex on a locally Noetherian scheme $X$.
Then $K$ is an object of $D_{\textit{Coh}}(\mathcal{O}_X)$
and $D = R\SheafHom(-, K)$ induces an anti-equivalence
$$
D :
D_{\textit{Coh}}(\mathcal{O}_X)
\longrightarrow
D_{\textit{Coh}}(\mathcal{O}_X)
$$
such that $D \circ D \cong \text{id}$. If $X$ is quasi-compact, then
$D$ exchanges $D^+_{\textit{Coh}}(\mathcal{O}_X)$ and
$D^-_{\textit{Coh}}(\mathcal{O}_X)$ and induces an equivalence
$D^b_{\textit{Coh}}(\mathcal{O}_X) \to D^b_{\textit{Coh}}(\mathcal{O}_X)$.
\end{lemma}

\begin{proof}
Let $U \subset X$ be an affine open. Say $U = \Spec(A)$ and
let $\omega_A^\bullet$ be a dualizing complex for $A$
corresponding to $K|_U$
as in Lemma \ref{lemma-equivalent-definitions}.
By Lemma \ref{lemma-affine-duality} the diagram
$$
\xymatrix{
D_{\textit{Coh}}(A) \ar[r] \ar[d]_{R\Hom(-, \omega_A^\bullet)} &
D_{\textit{Coh}}(\mathcal{O}_U) \ar[d]^{R\SheafHom(-, K|_U)} \\
D_{\textit{Coh}}(A) \ar[r] &
D(\mathcal{O}_U)
}
$$
commutes. We conclude that $D$ sends $D_{\textit{Coh}}(\mathcal{O}_X)$ into
$D_{\textit{Coh}}(\mathcal{O}_X)$. Moreover, the canonical map
$$
L \longrightarrow R\SheafHom(R\SheafHom(L, K), K)
$$
(Cohomology on Sites, Lemma \ref{sites-cohomology-lemma-internal-hom-evaluate})
is an isomorphism for all $L$ because this is true on affines by
Lemma \ref{lemma-dualizing}.
The statement on boundedness properties of the functor $D$
in the quasi-compact case also folow from the corresponding
statements of Lemma \ref{lemma-dualizing}.
\end{proof}





\section{Twisted inverse image}
\label{section-twisted-inverse-image}

\noindent
References for this section are \cite{Neeman-Grothendieck} and \cite{LN}.
Let $f : X \to Y$ be a morphism of schemes.
In some papers, a {\it twisted inverse image} for $f$ is
defined to be a right adjoint to the functor
$Rf_* : D_\QCoh(\mathcal{O}_X) \to D_\QCoh(\mathcal{O}_X)$.
However, this terminology is not universally accepted and we refrain
from giving a formal definition. We also will not use
the notation $f^!$ for such a functor, as this would clash
(for general morphisms $f$) with the notation in \cite{R+D}.

\begin{lemma}
\label{lemma-twisted-inverse-image}
\begin{reference}
This is almost the same as \cite[Example 4.2]{Neeman-Grothendieck}.
\end{reference}
Let $f : X \to Y$ be a morphism between quasi-separated and quasi-compact
schemes. The functor $Rf_* : D_\QCoh(X) \to D_\QCoh(Y)$ has a
right adjoint.
\end{lemma}

\begin{proof}
We will prove a right adjoint exists by verifying the hypotheses of
Derived Categories, Proposition \ref{derived-proposition-brown}.
First off, the category $D_\QCoh(\mathcal{O}_X)$ has direct sums, see
Derived Categories of Schemes, Lemma
\ref{perfect-lemma-quasi-coherence-direct-sums}.
The category $D_\QCoh(\mathcal{O}_X)$ is compactly generated by
Derived Categories of Schemes, Theorem
\ref{perfect-theorem-bondal-van-den-Bergh}.
Since $X$ and $Y$ are quasi-compact and quasi-separated, so is $f$, see
Schemes, Lemmas \ref{schemes-lemma-compose-after-separated} and
\ref{schemes-lemma-quasi-compact-permanence}.
Hence the functor $Rf_*$ commutes with direct sums, see
Derived Categories of Schemes, Lemma
\ref{perfect-lemma-quasi-coherence-pushforward-direct-sums}.
This finishes the proof.
\end{proof}

\begin{example}
\label{example-affine-twisted-inverse-image}
Let $A \to B$ be a ring map. Let $Y = \Spec(A)$ and $X = \Spec(B)$
and $f : X \to Y$ the morphism corresponding to $A \to B$.
Then $Rf_*$ corresponds to restriction $D(B) \to D(A)$ via
the equivalences $D(B) \to D_\QCoh(\mathcal{O}_X)$ and
$D(A) \to D_\QCoh(\mathcal{O}_Y)$. Hence the right adjoint
corresponds to the functor $K \longmapsto R\Hom(B, K)$ of
Section \ref{section-trivial}.
\end{example}

\begin{example}
\label{example-does-not-preserve-coherent}
If $f : X \to Y$ is a separated finite type morphism of Noetherian schemes,
then twisted inverse image does not map $D_{\textit{Coh}}(\mathcal{O}_Y)$ into
$D_{\textit{Coh}}(\mathcal{O}_X)$. Namely, let $k$ be a field and
consider the morphism $f : \mathbf{A}^1_k \to \Spec(k)$. By
Example \ref{example-affine-twisted-inverse-image}
this corresponds to the question of whether
$R\Hom(B, -)$ maps $D_{\textit{Coh}}(A)$ into $D_{\textit{Coh}}(B)$
where $A = k$ and $B = k[x]$. This is not true because
$$
R\Hom(k[x], k) = \left(\prod\nolimits_{n \geq 0} k\right)[0]
$$
which is not a finite $k[x]$-module. Hence $a(\mathcal{O}_Y)$
does not have coherent cohomology sheaves.
\end{example}

\begin{example}
\label{example-does-not-preserve-bounded-above}
If $f : X \to Y$ is a proper or even finite morphism of Noetherian schemes,
then twisted inverse image does not map $D_\QCoh^-(\mathcal{O}_Y)$ into
$D_\QCoh^-(\mathcal{O}_X)$. Namely, let $k$ be a field, let
$k[\epsilon]$ be the dual numbers over $k$, let
$X = \Spec(k)$, and let $Y = \Spec(k[\epsilon])$.
Then $\text{Ext}^i_{k[\epsilon]}(k, k)$ is nonzero for all $i \geq 0$.
Hence $a(\mathcal{O}_Y)$ is not bounded above
by Example \ref{example-affine-twisted-inverse-image}.
\end{example}

\begin{lemma}
\label{lemma-twisted-inverse-image-bounded-below}
Let $f : X \to Y$ be a morphism of quasi-compact and quasi-separated
schemes. Let $a : D_\QCoh(\mathcal{O}_Y) \to D_\QCoh(\mathcal{O}_X)$
be the right adjoint to $Rf_*$ of Lemma \ref{lemma-twisted-inverse-image}.
Then $a$ maps $D^+_\QCoh(\mathcal{O}_Y)$ into $D^+_\QCoh(\mathcal{O}_X)$.
\end{lemma}

\begin{proof}
By Derived Categories of Schemes, Lemma
\ref{perfect-lemma-quasi-coherence-direct-image}
the functor $Rf_*$ has finite cohomological dimension. In other words,
there exist an integer $N$ such that
$H^i(Rf_*L) = 0$ for $i \geq N + c$ if $H^j(L) = 0$ for $j \geq c$.
Say $K \in D^+_\QCoh(\mathcal{O}_Y)$ has $H^k(K) = 0$ for $k \geq c$.
Then
$$
\Hom_{D(\mathcal{O}_X)}(\tau_{\leq c - N}a(K), a(K)) =
\Hom_{D(\mathcal{O}_Y)}(Rf_*\tau_{\leq c - N}a(K), K) = 0
$$
by what we said above. Clearly, this implies that $a(K)$ is bounded below.
\end{proof}

\noindent
We often want to know whether the twisted inverse image commutes
with base change. Thus we consider a cartesian square
\begin{equation}
\label{equation-base-change}
\vcenter{
\xymatrix{
X' \ar[r]_{g'} \ar[d]_{f'} & X \ar[d]^f \\
Y' \ar[r]^g & Y
}
}
\end{equation}
of quasi-compact and quasi-separated schemes.
Denote
\begin{align*}
a  & : D_\QCoh(\mathcal{O}_Y) \to D_\QCoh(\mathcal{O}_X), \\
a' & : D_\QCoh(\mathcal{O}_{Y'}) \to D_\QCoh(\mathcal{O}_{X'}), \\
b  & : D_\QCoh(\mathcal{O}_X) \to D_\QCoh(\mathcal{O}_{X'}), \\
b' & : D_\QCoh(\mathcal{O}_Y) \to D_\QCoh(\mathcal{O}_{Y'})
\end{align*}
the right adjoints to $Rf_*$, $Rf'_*$, $Rg_*$, and $Rg'_*$
(Lemma \ref{lemma-twisted-inverse-image}). Since
$Rf_* \circ Rg'_* = Rg_* \circ Rf'_*$ we get
$$
b' \circ a = a' \circ b.
$$
Another compatibility comes from the base change map of
Cohomology, Remark \ref{cohomology-remark-base-change}.
It induces a transformation of functors
$$
Lg^* \circ Rf_* \longrightarrow Rf'_* \circ L(g')^*
$$
on derived categories of sheaves with quasi-coherent cohomology.
Hence a transformation between the right adjoints in the opposite direction
$$
a \circ Rg_* \longleftarrow Rg'_* \circ a'
$$

\begin{lemma}
\label{lemma-flat-precompose-pus}
In diagram (\ref{equation-base-change}) assume that $g$ is flat or
more generally that $f$ and $g$ are Tor independent. Then
$a \circ Rg_* \longleftarrow Rg'_* \circ a'$ is an isomorphism.
\end{lemma}

\begin{proof}
In this case the base change map
$Lg^* \circ Rf_* K \longrightarrow Rf'_* \circ L(g')^*K$
is an isomorphism for every $K$ in $D_\QCoh(\mathcal{O}_X)$ by
Derived Categories of Schemes, Lemma \ref{perfect-lemma-compare-base-change}.
Thus the corresponding transformation between adjoint functors
is an isomorphism as well.
\end{proof}

\noindent
Let $f : X \to Y$ be a morphism of quasi-compact and quasi-separated
schemes. Let $V \subset Y$ be a quasi-compact open subscheme and set
$U = f^{-1}(V)$. This gives a cartesian square
$$
\xymatrix{
U \ar[r]_{j'} \ar[d]_{f|_U} & X \ar[d]^f \\
V \ar[r]^j & Y
}
$$
as in (\ref{equation-base-change}). By Lemma \ref{lemma-flat-precompose-pus}
we have $a \circ Rj_* = Rj'_* \circ a'$ where $a$ and $a'$ are the
twisted inverse images corresponding to $f$ and $f|_U$.
Let $K \in D_\QCoh(\mathcal{O}_Y)$. Then we get a map
\begin{equation}
\label{equation-sheafy}
a(K)|_U \longrightarrow a(Rj_*K|_V)|_U = (Rj'_*a'(K|_V))|_U = a'(K|_V)
\end{equation}
where the first arrow comes from the adjunction map $K \to Rj_*K|_V$.

\begin{example}
\label{example-not-supported-on-inverse-image}
There is a finite morphsm $f : X \to Y$ of Noetherian schemes
such that (\ref{equation-sheafy}) is not an isomorphism for some
$K \in D_{\textit{Coh}}(\mathcal{O}_Y)$.
Namely, let $X = \Spec(B) \to Y = \Spec(A)$ with
$A = k[x, \epsilon]$ where $k$ is a field and $\epsilon^2 = 0$ and
$B = k[x] = A/(\epsilon)$. For $n \in \mathbf{N}$ set
$M_n = A/(\epsilon, x^n)$. Observe that
$$
\text{Ext}^i_A(B, M_n) = M_n,\quad i \geq 0
$$
because $B$ has the free periodic resolution
$\ldots \to A \to A \to A$ with maps given by multiplication by $\epsilon$.
Consider the object
$K = \bigoplus K_n[n] = \prod K_n[n]$
of $D_{\textit{Coh}}(A)$ (equality in $D(A)$ by
Derived Categories, Lemmas \ref{derived-lemma-direct-sums} and
\ref{derived-lemma-products}). Then we see that $a(K)$ correspnds
to $R\Hom(B, K)$ by Example \ref{example-affine-twisted-inverse-image} and
$$
H^0(R\Hom(B, K)) = \text{Ext}^0_A(B, K) =
\prod\nolimits_{n \geq 1} \text{Ext}^n_A(B. M_n) = 
\prod\nolimits_{n \geq 1} M_n
$$
by the above. But this module has elements which are not
annihilated by any power of $x$, whereas the complex $K$
does have every element of its cohomology annihilated by
a power of $x$. In other words, for the map (\ref{equation-sheafy})
with $V = D(x)$ and $U = D(x)$ and the complex $K$,
the left hand side is nonzero and the right hand side is zero.
\end{example}

\begin{lemma}
\label{lemma-when-sheafy}
Let $f : X \to Y$ be a morphism of quasi-compact and quasi-separated
schemes. Let $V \subset Y$ be quasi-compact open with inverse image
$U \subset X$. If for every $Q \in D_\QCoh^+(\mathcal{O}_Y)$
supported on $Y \setminus V$ the twisted inverse image $a(Q)$
is supported on $X \setminus U$, then (\ref{equation-sheafy})
is an isomorphism for all $K$ in $D_\QCoh^+(\mathcal{O}_Y)$.
\end{lemma}

\begin{proof}
Choose a distinguished triangle
$$
K \to Rj_*K|_V \to Q \to K[1]
$$
Observe that $Q$ is supported on $Y \setminus V$
(Derived Categories of Schemes, Definition
\ref{perfect-definition-supported-on}).
Applying the twisted inverse image $a$ we obtain a distinguished triangle
$$
a(K) \to a(Rj_*K|_V) \to a(Q) \to a(K)[1]
$$
on $X$. If $a(Q)$ is supported on $X \setminus U$, then
restricting to $U$ the map $a(K)|_U \to a(Rj_*K|_V)|_U$ is an
isomorphism, i.e., (\ref{equation-sheafy}) is an isomorphism.
\end{proof}

\begin{lemma}
\label{lemma-proper-noetherian}
Let $f : X \to Y$ be a proper\footnote{This proof works for those
morphisms of quasi-compact and quasi-separated schemes such that
$Rf_*P$ is pseudo-coherent for all $P$ perfect on $X$. It follows
easily from a theorem of Kiehl \cite{Kiehl} that this holds if
$f$ is proper and pseudo-coherent. This is the correct generality
for this lemma and some of the other results in this section.}
morphism of Noetherian schemes.
The assumption and hence the conclusion of
Lemma \ref{lemma-when-sheafy} holds for all opens $V$ of $Y$.
\end{lemma}

\begin{proof}
Let $Q \in D^+_\QCoh(\mathcal{O}_Y)$ be supported on $Y \setminus V$.
To get a contradiction, assume that $a(Q)$ is not supported on
$X \setminus U$. Then we can find a perfect complex $P_U$ on $U$
and a nonzero map $P_U \to a(Q)|_U$ (follows from
Derived Categories of Schemes, Theorem
\ref{perfect-theorem-bondal-van-den-Bergh}). Then using
Derived Categories of Schemes, Lemma
\ref{perfect-lemma-lift-map-from-perfect-complex-with-support}
we may assume there is a perfect complex $P$ on $X$ and a map
$P \to a(Q)$ whose restriction to $U$ is nonzero.
By definition of the twisted inverse image this map
is adjoint to a map $Rf_*P \to Q$.

\medskip\noindent
Because $f$ is proper and $X$ and $Y$ Noetherian, the complex
$Rf_*P$ is pseudo-coherent, see
Derived Categories of Schemes, Lemmas
\ref{perfect-lemma-direct-image-coherent} and
\ref{perfect-lemma-identify-pseudo-coherent-noetherian}.
Thus we may apply
Derived Categories of Schemes, Lemma
\ref{perfect-lemma-map-from-pseudo-coherent-to-complex-with-support}
and get a map $I \to \mathcal{O}_Y$ of perfect complexes
whose restriction to $V$ is an isomorphism such that the composition
$I \otimes^\mathbf{L}_{\mathcal{O}_Y} Rf_*P \to Rf_*P \to K$ is zero.
By Derived Categories of Schemes, Lemma
\ref{perfect-lemma-cohomology-base-change}
we have $I \otimes^\mathbf{L}_{\mathcal{O}_Y} Rf_*P =
Rf_*(Lf^*I \otimes^\mathbf{L}_{\mathcal{O}_X} P)$.
We conclude that the composition
$$
Lf^*I \otimes^\mathbf{L}_{\mathcal{O}_X} P \to P \to a(K)
$$
is zero. However, the restriction to $U$ is the map
$P|_U \to a(K)|_U$ which we assumed to be nonzero.
This contradiction finishes the proof.
\end{proof}

\begin{lemma}
\label{lemma-proper-noetherian-relative}
Let $f : X \to Y$ be a proper morphism of Noetherian schemes.
Let $a$ be the twisted inverse image. Then the canonical map
$$
Rf_*R\SheafHom(L, a(K)) \longrightarrow R\SheafHom(Rf_*L, K)
$$
is an isomorphism for all $L \in D_\QCoh(\mathcal{O}_X)$ and all
$K \in D^+_\QCoh(\mathcal{O}_Y)$.
\end{lemma}

\begin{proof}
Since $a$ is the right adjoint to $Rf_*$ there is a adjunction
map $Rf_*a(K) \to K$. On the other hand, there is a canonical
map
$$
Rf_*R\SheafHom(L, a(K)) \to R\SheafHom(Rf_*L, Rf_*a(K))
$$
which works on the level of complexes. Combining these we obtain
the map of the lemma. Taking $H^0(V, -)$ for an open $V$ of $Y$
with inverse image $U$ in $X$ we get
$$
\Hom_{D(\mathcal{O}_U)}(L|_U, a(K)|_U) \longrightarrow
\Hom_{D(\mathcal{O}_V)}(Rf_*L|_V, K|_V)
$$
Since we've shown above that $a(K)|_U$ is the twisted inverse
image of $K|_V$ (Lemma \ref{lemma-proper-noetherian}) the two
sides of this arrow are isomorphic. We omit the verification that
the two maps agree. A similar argument works for $H^n(V, -)$.
Thus the map defined above is an isomorphism on cohomology
and hence an isomorphism in the derived category.
\end{proof}

\noindent
Let $f : X \to Y$ be a morphism of quasi-compact and quasi-separated
schemes. Let $a$ be the twisted inverse image
(Lemma \ref{lemma-twisted-inverse-image}). There is a canonical
map
\begin{equation}
\label{equation-compare-with-pullback}
Lf^*K \otimes^\mathbf{L}_{\mathcal{O}_X} a(\mathcal{O}_Y) \longrightarrow a(K)
\end{equation}
functorial in $K$ and compatible with distinguished triangles.
Namely, this map is adjoint to a map
$$
Rf_*(Lf^*K \otimes^\mathbf{L}_{\mathcal{O}_X} a(\mathcal{O}_Y)) =
K \otimes^\mathbf{L}_{\mathcal{O}_X} Rf_*(a(\mathcal{O}_Y))
\longrightarrow K
$$
(equality by Derived Categories of Schemes, Lemma
\ref{perfect-lemma-cohomology-base-change})
for which we use the adjunction map $Rf_*a(\mathcal{O}_Y) \to \mathcal{O}_Y$
and the indentity on $K$.

\begin{lemma}
\label{lemma-compare-with-pullback-perfect}
Let $f : X \to Y$ be a morphism of quasi-compact and quasi-separated
schemes. The map (\ref{equation-compare-with-pullback}) is an isomorphism
for every perfect object $K$ of $D(\mathcal{O}_Y)$.
\end{lemma}

\begin{proof}
For a perfect object $K$ on $Y$ and $L \in D_\QCoh(\mathcal{O}_X)$
we have
\begin{align*}
\Hom_{D(\mathcal{O}_Y)}(Rf_*L, K)
& =
\Hom_{D(\mathcal{O}_Y)}(
Rf_*L \otimes^\mathbf{L}_{\mathcal{O}_Y} K^\wedge, \mathcal{O}_Y) \\
& =
\Hom_{D(\mathcal{O}_X)}(
L \otimes^\mathbf{L}_{\mathcal{O}_X} Lf^*K^\wedge, a(\mathcal{O}_Y)) \\
& =
\Hom_{D(\mathcal{O}_X)}(L,
a(\mathcal{O}_Y) \otimes^\mathbf{L}_{\mathcal{O}_X} Lf^*K)
\end{align*}
Hence the result by the Yoneda lemma.
\end{proof}

\begin{lemma}
\label{lemma-twisted-inverse-image-closed}
Let $i : Z \to X$ be a closed immersion of quasi-compact and
quasi-separated schemes. Let $a : D_\QCoh(\mathcal{O}_X) \to
D_\QCoh(\mathcal{O}_Z)$ be the twisted inverse image, i.e.,
the right adjoint to $Ri_*$. Then there is a functorial
isomorphism
$$
a(K) = R\SheafHom(\mathcal{O}_Z, K)
$$
for $K \in D_\QCoh^+(\mathcal{O}_X)$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-sheaf-with-exact-support-adjoint}
the functor $R\SheafHom(\mathcal{O}_Z, -)$ is a right adjoint
to $Ri_* : D(\mathcal{O}_Z) \to D(\mathcal{O}_X)$. Moreover,
by Lemma \ref{lemma-sheaf-with-exact-support-quasi-coherent}
and Lemma \ref{lemma-twisted-inverse-image-bounded-below}
both $R\SheafHom(\mathcal{O}_Z, -)$ and $a$ map
$D_\QCoh^+(\mathcal{O}_X)$ into $D_\QCoh^+(\mathcal{O}_Z)$.
Hence we obtain the isomorphism by uniqueness of adjoint
functors.
\end{proof}

\begin{remark}
\label{remark-base-change-map}
The map (\ref{equation-sheafy}) is a special case of a base change map.
Namely, suppose that we have a diagram (\ref{equation-base-change})
where $f$ and $g$ are Tor independent. Let $K \in D_\QCoh(\mathcal{O}_X)$.
Then we can consider the composition
\begin{equation}
\label{equation-base-change-map}
L(g')^*a(K) \to
L(g')^*a(Rg_* Lg^*K) = L(g')^*Rg'_*a'(Lg^*K) \to a'(Lg^*K)
\end{equation}
We need the assumption on Tor independence to get the equality
sign (the canonical map goes the other way). The two arrows
come from the adjunction maps $\text{id} \to Rg_* Lg^*$ and
$L(g')^*Rg'_* \to \text{id}$. Alternatively, we can think of
(\ref{equation-base-change}) by adjointness of $L(g')^*$ and $R(g')_*$
as the map
$$
a(K) \to a(Rg_* Lg^*K) = Rg'_*a'(Lg^*K)
$$
If $M \in D_\QCoh(\mathcal{O}_X)$ then on
Yoneda functors this map is given by
\begin{align*}
\Hom_X(M, a(K))
& =
\Hom_Y(Rf_*M, K) \\
& \to
\Hom_Y(Rf_*M, Rg_* Lg^*K) \\
& =
\Hom_{Y'}(Lg^*Rf_*M, Lg^*K) \\
& =
\Hom_{Y'}(Rf'_* L(g')^*M, Lg^*K) \\
& =
\Hom_{X'}(L(g')^*M, a'(Lg^*K)) \\
& =
\Hom_X(M, Rg'_*a'(Lg^*K))
\end{align*}
which makes things a little bit more explicit.
\end{remark}

\begin{lemma}
\label{lemma-affine-morphism-and-hom-out-of-perfect}
Let $A \to A'$ be a ring map. Let $X$ be a quasi-compact and
quasi-separated scheme over $A$. Let
$h : X' = X \times_{\Spec(A)} \Spec(A') \to X$ be the projection.
Assume $X$ and $\Spec(B)$ are Tor independent over $\Spec(A)$.
We have
$$
\Hom_X(M, K \otimes^\mathbf{L}_{\mathcal{O}_X} h_*\mathcal{O}_{X'}) =
H^0(R\Gamma(X, R\SheafHom(M, K)) \otimes^\mathbf{L}_A A')
$$
in the following two cases
\begin{enumerate}
\item $M \in D(\mathcal{O}_X)$ is perfect and $K \in D_\QCoh(X)$, or
\item $M \in D(\mathcal{O}_X)$ is pseudo-coherent,
$K \in D_\QCoh^+(X)$, and $A'$ has finite tor dimension over $A$.
\end{enumerate}
\end{lemma}

\begin{proof}
The complex $R\SheafHom(M, K)$ is an object of $D_\QCoh(\mathcal{O}_X)$
and we have
$$
R\SheafHom(M, K \otimes_{\mathcal{O}_X}^\mathbf{L} h_*\mathcal{O}_{X'}) =
R\SheafHom(M, K) \otimes_{\mathcal{O}_X}^\mathbf{L} h_*\mathcal{O}_{X'}
$$
in both cases (details omitted; hints: you can check this
when $X$ is affine and use Derived Categories of Schemes, Lemma
\ref{perfect-lemma-quasi-coherence-internal-hom}
to identify the $R\SheafHom$ complexes).
Hence, by replacing
$K$ by $R\SheafHom(M, K)$ we reduce to proving
$$
H^0(X, K \otimes^\mathbf{L}_{\mathcal{O}_X} h_*\mathcal{O}_{X'})
= H^0(R\Gamma(X, K) \otimes^\mathbf{L}_A A')
$$
Note that the left hand side is equal to $H^0(X', Lh^*K)$
by Derived Categories of Schemes, Lemma
\ref{perfect-lemma-affine-morphism-pull-push}.
Hence the lemma is an example of
by Derived Categories of Schemes, Lemma
\ref{perfect-lemma-compare-base-change}.
\end{proof}

\begin{lemma}
\label{lemma-more-base-change}
In diagram (\ref{equation-base-change}) assume
\begin{enumerate}
\item $g : Y' \to Y$ is a morphism of affine schemes,
\item $f : X \to Y$ is proper,
\item $Y$ Noetherian, and
\item $f$ or $g$ is flat.
\end{enumerate}
Then the base change map (\ref{equation-base-change-map}) is an isomorphism
for all $K \in D_\QCoh(\mathcal{O}_X)$ if $f$ is flat and for
$K \in D_\QCoh^+(\mathcal{O}_X)$ if $g$ is flat.
\end{lemma}

\begin{proof}
Write $Y = \Spec(A)$ and $Y' = \Spec(A')$. As a base change of an affine
morphism, the morphism $g'$ is affine. Hence $Rg'_*$ reflects isomorphisms,
see Derived Categories of Schemes, Lemma \ref{perfect-lemma-affine-morphism}.
Thus (\ref{equation-base-change-map}) is an isomorphism for
$K \in D_\QCoh(\mathcal{O}_X)$ if and only
if the map $a(K) \to a(Rg_*Lg^*K) = Rg'_*a'(Lg^*K)$ induces an isomorphism
$$
a(K) \otimes^\mathbf{L}_{\mathcal{O}_X} g'_*\mathcal{O}_{X'} \to a(Rg_*Lg^*K)
$$
(see Derived Categories of Schemes, Lemma
\ref{perfect-lemma-affine-morphism-pull-push}).
As $D_\QCoh(\mathcal{O}_X)$ is generated by perfect objects
(see Derived Categories of Schemes, Theorem
\ref{perfect-theorem-bondal-van-den-Bergh}), it suffices
to check we obtain an isomorphism after applying the functor
$\Hom_X(M, -)$ where $M$ is perfect on $X$. On the left hand side
we get
\begin{align*}
\Hom_X(M, a(K) \otimes^\mathbf{L}_{\mathcal{O}_X} g'_*\mathcal{O}_{X'})
& =
H^0(R\Gamma(X, R\SheafHom(M, a(K))) \otimes^\mathbf{L}_A A') \\
& =
H^0(R\Gamma(Y, R\SheafHom(Rf_*M, K)) \otimes^\mathbf{L}_A A')
\end{align*}
The first equality by Lemma \ref{lemma-affine-morphism-and-hom-out-of-perfect}.
Observe that $R\Gamma(X, R\SheafHom(M, a(K)))$ is the complex
of $A$-modules whose cohomology groups are $\Hom_X(M, a(K)[n])$
and similary for $R\Gamma(Y, R\SheafHom(Rf_*M, K))$, see
Cohomology, Lemma \ref{cohomology-lemma-section-RHom-over-U}.
Hence the second equality follows from the definition of $a$.
In the case that $f$ is flat the complex $Rf_*M$ is perfect on $Y$
(Derived Categories of Schemes, Lemma \ref{perfect-lemma-perfect-direct-image})
and in general the complex $Rf_*M$ is pseudo-coherent on $Y$
(Derived Categories of Schemes, Lemmas
\ref{perfect-lemma-direct-image-coherent} and
\ref{perfect-lemma-identify-pseudo-coherent-noetherian}).
Thus we get on the right hand side
\begin{align*}
\Hom_X(M, a(Rg_*Lg^*K))
& =
\Hom_Y(Rf_*M, Rg_*Lg^*K) \\
& =
\Hom_Y(Rf_*M, K \otimes^\mathbf{L}_{\mathcal{O}_Y} g_*\mathcal{O}_{Y'}) \\
& =
H^0(R\Gamma(Y, R\SheafHom(Rf_*M, K)) \otimes_A^\mathbf{L} A')
\end{align*}
by the same arguments. Thus we get the same outcome as before. We omit the
verification that our map induces the given identifications.
\end{proof}






\section{Flat and proper morphisms}
\label{section-flat-and-proper}

\noindent
The correct generality for this section would be to consider
proper perfect morphisms of quasi-compact and quasi-separated
schemes, see \cite{LN}.

\begin{lemma}
\label{lemma-proper-flat-noetherian}
Let $f : X \to Y$ be a flat and proper morphism of Noetherian schemes.
Let $a$ be the twisted inverse image. Then
$a$ commutes with direct sums.
\end{lemma}

\begin{proof}
Let $P$ be a perfect object of $D(\mathcal{O}_X)$. By
Derived Categories of Schemes, Lemma \ref{perfect-lemma-perfect-direct-image}
the complex $Rf_*P$ is perfect on $Y$.
Let $K_i$ be a family of objects of $D_\QCoh(\mathcal{O}_Y)$.
Then
\begin{align*}
\Hom_{D(\mathcal{O}_X)}(P, a(\bigoplus K_i))
& =
\Hom_{D(\mathcal{O}_Y)}(Rf_*P, \bigoplus K_i) \\
& =
\bigoplus \Hom_{D(\mathcal{O}_Y)}(Rf_*P, K_i) \\
& =
\bigoplus \Hom_{D(\mathcal{O}_X)}(P, a(K_i))
\end{align*}
because a perfect object is compact (Derived Categories of Schemes,
Proposition \ref{perfect-proposition-compact-is-perfect}).
Since $D_\QCoh(\mathcal{O}_X)$ has a perfect generator
(Derived Categories of Schemes, Theorem
\ref{perfect-theorem-bondal-van-den-Bergh})
we conclude that the map $\bigoplus a(K_i) \to a(\bigoplus K_i)$
is an isomorphism, i.e., $a$ commutes with direct sums.
\end{proof}

\begin{lemma}
\label{lemma-proper-flat-noetherian-relative}
Let $f : X \to Y$ be a flat and proper morphism of Noetherian schemes.
Let $a$ be the twisted inverse image. Let $T \subset Y$ be closed. Then
\begin{enumerate}
\item if $Q \in D_\QCoh(Y)$ is supported on $T$,
then $a(Q)$ is supported on $f^{-1}(T)$,
\item the map (\ref{equation-sheafy}) is an isomorphism for
$K \in D_\QCoh(\mathcal{O}_Y)$, and
\item the canonical map
$$
Rf_*R\SheafHom(L, a(K)) \longrightarrow R\SheafHom(Rf_*L, K)
$$
is an isomorphism for all $L \in D_\QCoh(\mathcal{O}_X)$ and all
$K \in D_\QCoh(\mathcal{O}_Y)$.
\end{enumerate}
\end{lemma}

\begin{proof}
Arguing exactly as in the proof of
Lemma \ref{lemma-proper-noetherian-relative}
we see that (2) implies (3).
Arguing exactly as in the proof of
Lemma \ref{lemma-when-sheafy}
we see that (1) implies (2).

\medskip\noindent
Proof of (1). We will use the notation $D_{\QCoh, T}(\mathcal{O}_Y)$ and
$D_{\QCoh, f^{-1}(T)}(\mathcal{O}_X)$ to denote complexes
whose cohomology sheaves are supported on $T$ and $f^{-1}(T)$.
By Lemma \ref{lemma-proper-flat-noetherian} the functor $a$ commutes
with direct sums. Hence the strictly full, saturated, triangulated
subcategory $\mathcal{D}$ with objects
$$
\{Q \in D_{\QCoh, T}(\mathcal{O}_Y) \mid
a(Q) \in D_{\QCoh, f^{-1}(T)}(\mathcal{O}_X)\}
$$
is preserved by direct sums (and hence derived colimits).
On the other hand, the
category $D_{\QCoh, T}(\mathcal{O}_Y)$ is generated by a perfect
object $E$ (see Derived Categories of Schemes, Lemma
\ref{perfect-lemma-generator-with-support}).
By Lemma \ref{lemma-proper-noetherian} we see that $E \in \mathcal{D}$.
By Derived Categories, Lemma \ref{derived-lemma-write-as-colimit}
every object $Q$ of $D_{\QCoh, T}(\mathcal{O}_Y)$ is a derived
colimit of a system $Q_1 \to Q_2 \to Q_3 \to \ldots$
such that the cones of the transition maps are direct sums
of shifts of $E$. Arguing by induction we see that
$E_n \in \mathcal{D}$ for all $n$ and finally that $Q$ is
in $\mathcal{D}$. Thus (1) is true.
\end{proof}

\begin{lemma}
\label{lemma-compare-with-pullback-flat-proper-noetherian}
Let $f : X \to Y$ be a proper flat morphism of Noetherian
schemes. The map (\ref{equation-compare-with-pullback}) is an isomorphism
for every object $K$ of $D_\QCoh(\mathcal{O}_Y)$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-proper-flat-noetherian} we know that $a$ commutes
with direct sums. Hence the collection of objects of
$D_\QCoh(\mathcal{O}_Y)$ for which (\ref{equation-compare-with-pullback})
is an isomorphism is a strictly full, saturated, triangulated
subcategory of $D_\QCoh(\mathcal{O}_Y)$ which is moreover
preserved under taking direct sums. Since $D_\QCoh(\mathcal{O}_Y)$
is a module category (Derived Categories of Schemes, Theorem
\ref{perfect-theorem-DQCoh-is-Ddga}) generated by a single
perfect object (Derived Categories of Schemes, Theorem
\ref{perfect-theorem-bondal-van-den-Bergh})
we can argue as in
More on Algebra, Remark \ref{more-algebra-remark-P-resolution}
to see that it suffices to prove (\ref{equation-compare-with-pullback})
is an isomorphism for a single perfect object.
However, the result holds for perfect objects, see
Lemma \ref{lemma-compare-with-pullback-perfect}.
\end{proof}

\begin{lemma}
\label{lemma-proper-flat-base-change}
Let $f : X \to Y$ be a proper flat morphism of Noetherian schemes.
Let $g : Y' \to Y$ be a morphism of finite type. Then the base
change map (\ref{equation-base-change-map}) is an isomorphism
for all $K \in D_\QCoh(\mathcal{O}_X)$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-proper-flat-noetherian-relative} formation of the
functors $a$ and $a'$ commutes with restriction to opens of $Y$ and $Y'$.
Hence we may assume $Y' \to Y$ is a morphism of affine schemes. In this
case the statement follows from Lemma \ref{lemma-more-base-change}.
\end{proof}

\begin{lemma}
\label{lemma-upper-shriek-P1}
Let $f : X = \mathbf{P}^1_Y \to Y$ be the projection where $Y$ is
a Noetherian scheme. Let $a$ be the twisted inverse image.
Then $a(\mathcal{O}_Y)$ is isomorphic to $\mathcal{O}_X(-2)[1]$.
\end{lemma}

\begin{proof}
Recall that there is an identification
$Rf_*(\mathcal{O}_X(-2)[1]) = \mathcal{O}_Y$, see
Cohomology of Schemes, Lemma
\ref{coherent-lemma-cohomology-projective-space-over-base} or
\ref{coherent-lemma-cohomology-projective-bundle}.
This determines a map $\mathcal{O}_X(-2)[1] \to a(\mathcal{O}_Y)$.
By Lemma \ref{lemma-proper-noetherian} construction of the twisted
inverse image is local on the base. In particular, to check that
$\mathcal{O}_X(-2)[1] \to a(\mathcal{O}_Y)$ is an isomorphism, we
may work locally on $Y$. In other words, we may assume $Y$ is affine.
In the affine case the sheaves $\mathcal{O}_X$ and $\mathcal{O}_X(-1)$
generate $D_\QCoh(X)$, see
Derived Categories of Schemes, Lemma \ref{perfect-lemma-generator-P1}.
Hence it suffices to show that the maps
\begin{align*}
H^{-n + 1}(X, \mathcal{O}(-2))
& = 
\Hom_{D(\mathcal{O}_X)}(\mathcal{O}_X[n], \mathcal{O}_X(-2)[1]) \\
& \to
\Hom_{D(\mathcal{O}_X)}(\mathcal{O}_X[n], a(\mathcal{O}_Y)) \\
& =
\Hom_{D(\mathcal{O}_Y)}(Rf_*(\mathcal{O}_X)[n], \mathcal{O}_Y) \\
& =
H^{-n}(Y, \mathcal{O}_Y)
\end{align*}
and
\begin{align*}
H^{-n + 1}(X, \mathcal{O}_X(-1))
& = 
\Hom_{D(\mathcal{O}_X)}(\mathcal{O}_X(-1)[n], \mathcal{O}_X(-2)[1]) \\
& \to
\Hom_{D(\mathcal{O}_X)}(\mathcal{O}_X(-1)[n], a(\mathcal{O}_Y)) \\
& =
\Hom_{D(\mathcal{O}_Y)}(Rf_*(\mathcal{O}_X(-1))[n], \mathcal{O}_Y) \\
& = 0
\end{align*}
(where we used Cohomology of Schemes, Lemma
\ref{coherent-lemma-cohomology-projective-space-over-ring})
are isomorphisms for all $n \in \mathbf{Z}$. This is clear from
the explicit computation of cohomology in
Cohomology of Schemes, Lemma
\ref{coherent-lemma-cohomology-projective-space-over-ring}.
\end{proof}

\begin{example}
\label{example-base-change-wrong}
The base change map (\ref{equation-base-change-map}) is not an
isomorphism if $f$ is proper and perfect and $g$ is perfect.
Let $k$ be a field. Let $Y = \mathbf{A}^2_k$ and let $f : X \to Y$
be the blow up of $Y$ in the origin. Denote $E \subset X$ the
exceptional divisor. Then we can factor $f$ as
$$
X \xrightarrow{i} \mathbf{P}^1_Y \xrightarrow{p} Y
$$
This gives a factorization $a = c \circ b$ where $b$ is the
twisted inverse image for $p$ and $c$ is the twisted
inverse image for $i$. Denote $\mathcal{O}(n)$ the
Serre twist of the structure sheaf on $\mathbf{P}^1_Y$ and
denote $\mathcal{O}_X(n)$ its restriction to $X$.
Note that $X \subset \mathbf{P}^1_Y$ is cut out by
a degree one equation, hence $\mathcal{O}(X) = \mathcal{O}(1)$.
By Lemma \ref{lemma-upper-shriek-P1} we have
$b(\mathcal{O}_Y) = \mathcal{O}(-2)[1]$.
By Lemma \ref{lemma-twisted-inverse-image-closed}
we have
$$
a(\mathcal{O}_Y) = c(b(\mathcal{O}_Y)) =
c(\mathcal{O}(-2)[1]) =
R\SheafHom(\mathcal{O}_X, \mathcal{O}(-2)[1]) =
\mathcal{O}_X(-1)
$$
Last equality by Lemma \ref{lemma-sheaf-with-exact-support-effective-Cartier}.
Hence the restriction of $a(\mathcal{O}_Y)$ to $E = \mathbf{P}^1_k$
is an invertible sheaf of degree $-1$ placed in cohomological
degree $0$. But on the other hand,
$a'(\mathcal{O}_{\Spec(k)}) = \mathcal{O}_E(-2)[1]$
which is an invertible sheaf of degree $-2$ placed in
cohomological degree $-1$, so different.
\end{example}













\section{Upper shriek functors}
\label{section-upper-shriek}

\noindent
In this section all schemes are Noetherian (but we will make
sure all the assumptions are mentioned explicitly in the
statements).

\medskip\noindent
Let $S$ be a Noetherian scheme. We will say a scheme $X$ over $S$
{\it has a compactification over $S$} if there exists an open immersion
$X \to \overline{X}$ into a scheme $\overline{X}$ proper over $S$.
If $X$ has a compactification over $S$, then $X \to S$ is separated and of
finite type. It is a theorem of Nagata (see
\cite{Conrad-Nagata}, \cite{Nagata-1}, \cite{Nagata-2}, \cite{Nagata-3}, and
\cite{Nagata-4}) that the converse is true as well (we will give a
precise statement and a proof if we ever need this result).

\begin{lemma}
\label{lemma-compactifyable}
Let $S$ be a Noetherian scheme. Let $X$ be a scheme over $S$ which
has a compactification over $S$.
\begin{enumerate}
\item Any two compactifications of $X/S$ can be dominated by a third.
\item If $X \to Y \to S$ is a factorization with $Y \to S$ of separated
of finite type, then $X$ has a compactification over $Y$.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\noindent
Given a morphism $f : X \to Y$ of compactifyable schemes over a Noetherian
base scheme $S$, we will define an exact functor
$$
f^! : D_\QCoh^+(\mathcal{O}_Y) \to D_\QCoh^+(\mathcal{O}_X)
$$
of triangulated categories.
Namely, we choose a compactification $X \to \overline{X}$ over $Y$
which is possible by Lemma \ref{lemma-compactifyable}.
Denote $\overline{f} : \overline{X} \to Y$ the structure morphism.
We let
$\overline{a} : D_\QCoh(\mathcal{O}_Y) \to D_\QCoh(\mathcal{O}_{\overline{X}})$
be the twisted inverse image, i.e., the right adjoint of $R\overline{f}_*$
constructed in Lemma \ref{lemma-twisted-inverse-image}. Then we set
$$
f^!K  = \overline{a}(K)|_X
$$
for $K \in D_\QCoh^+(\mathcal{O}_Y)$. The result is an object of
$D_\QCoh^+(\mathcal{O}_X)$ by
Lemma \ref{lemma-twisted-inverse-image-bounded-below}.

\begin{lemma}
\label{lemma-shriek-well-defined}
The functor $f^!$ is independent of the choice of the compactification
(up to canonical isomorphism). If $f$ is an open immersion, then
$f^! = f^*$. Moreover, if $f : X \to Y$, $g : Y \to Z$
are morphisms of compactifyable schemes over $S$, then there is a canonical
isomorphism $f^! \circ g^! = (g \circ f)^!$.
\end{lemma}

\begin{proof}
We first prove the last statement.
Choose a compactification $Y \to \overline{Y} \to Z$ over $Z$
and then choose a compactification $X \to \overline{X} \to \overline{Y}$
over $\overline{Y}$ using Lemma \ref{lemma-compactifyable}.
Let $\overline{a}$ be the twisted inverse image for
$\overline{X} \to \overline{Y}$ and let $\overline{b}$ be the
twisted inverse image for $\overline{Y} \to Z$.
Then $\overline{a} \circ \overline{b}$ is the twisted inverse
image for the composition $\overline{X} \to Z$.
Let $\overline{a}'$ be the twisted inverse image for
$\overline{X} \times_{\overline{Y}} Y \to Y$.
Let $K$ be an object of $D_\QCoh^+(\mathcal{O}_Z$.
To prove the statement on compositions
it suffices to find a functorial isomorphism between
$$
\overline{a}'(\overline{b}(K)|_Y)
\quad\text{and}\quad
\overline{a}(\overline{b}(K))|_{\overline{X} \times_{\overline{Y}} Y}
$$
in $D(\mathcal{O}_{\overline{X}})$. The canonical map
(\ref{equation-sheafy}) from left to right is an isomorphism
by Lemma \ref{lemma-proper-noetherian}.

\medskip\noindent
Independence of the choice of the compactification is a special
case of the argument above where $X \to Y$ is an isomorphism.
The statement on open immersions is immediate from the construction
(once it is shown to be independent of choices).
\end{proof}

\begin{lemma}
\label{lemma-shriek-affine-line}
Let $S$ be a Noetherian scheme. Let $Y$ be a compactifyable
scheme over $S$ and let $f : X = \mathbf{A}^1_Y \to Y$ be
the projection. Then there is a (noncanonical) isomorphism
$f^!(-) \cong Lf^*(-) [1]$ of functors.
\end{lemma}

\begin{proof}
Since $X = \mathbf{A}^1_Y \subset \mathbf{P}^1_Y$
and since $\mathcal{O}_{\mathbf{P}^1_Y}(-2)|_X \cong \mathcal{O}_X$
this follows from Lemmas \ref{lemma-upper-shriek-P1} and
\ref{lemma-compare-with-pullback-flat-proper-noetherian}.
\end{proof}

\begin{lemma}
\label{lemma-shriek-closed-immersion}
Let $S$ be a Noetherian scheme. Let $Y$ be a compactifyable
scheme over $S$ and let $i : X \to Y$ be a closed immersion.
Then there is a canonical isomorphism
$i^!(-) = R\SheafHom(\mathcal{O}_X, -)$ of functors.
\end{lemma}

\begin{proof}
This is a restatement of Lemma \ref{lemma-twisted-inverse-image-closed}.
\end{proof}

\begin{lemma}
\label{lemma-shriek-dualizing}
Let $S$ be a Noetherian scheme. Let $f : X \to Y$ be a morphism
of compactifyable schemes over $S$. If $K$ is a dualizing complex
for $Y$, then $f^!K$ is a dualizing complex for $X$.
\end{lemma}

\begin{proof}
The question is local on $X$ hence we may assume that $X$ and $Y$ are
affine schemes mapping into an affine open of $S$. In this case
we can factor $f : X \to Y$ as
$$
X \xrightarrow{i} \mathbf{A}^n_Y \to \mathbf{A}^{n - 1}_Y \to \ldots \to
\mathbf{A}^1_Y \to Y
$$
where $i$ is a closed immersion. By Lemmas \ref{lemma-shriek-affine-line} and
\ref{lemma-dualizing-polynomial-ring} and induction we see that
the $p^!K$ is a dualizing complex on $\mathbf{A}^n_Y$ where
$p : \mathbf{A}^n_Y \to Y$ is the projection. Similarly, by
Lemmas \ref{lemma-dualizing-quotient},
\ref{lemma-sheaf-with-exact-support-quasi-coherent}, and
\ref{lemma-shriek-closed-immersion} we see that $i^!$
transforms dualizing complexes into dualizing complexes.
\end{proof}







\input{chapters}

\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}
