\input{preamble}

% OK, start here.
%
\begin{document}

\title{More on Groupoids in Spaces}


\maketitle

\phantomsection
\label{section-phantom}

\tableofcontents

\section{Introduction}
\label{section-introduction}

\noindent
This chapter is devoted to advanced topics on groupoids
in algebraic spaces.
Even though the results are stated in terms of groupoids in
algebraic spaces, the
reader should keep in mind the $2$-cartesian diagram
\begin{equation}
\label{equation-quotient-stack}
\vcenter{
\xymatrix{
R \ar[r] \ar[d] & U \ar[d] \\
U \ar[r] & [U/R]
}
}
\end{equation}
where $[U/R]$ is the quotient stack, see
Groupoids in Spaces, Remark \ref{spaces-groupoids-remark-fundamental-square}.
Many of the results are motivated by thinking about this diagram.
See for example the beautiful paper \cite{K-M} by Keel and Mori.





\section{Notation}
\label{section-notation}

\noindent
We continue to abide by the conventions and notation introduced in
Groupoids in Spaces, Section \ref{spaces-groupoids-section-notation}.





\section{Useful diagrams}
\label{section-diagrams}

\noindent
We briefly restate the results of
Groupoids in Spaces, Lemmas \ref{spaces-groupoids-lemma-diagram} and
\ref{spaces-groupoids-lemma-diagram-pull}
for easy reference in this chapter.
Let $S$ be a scheme. Let $B$ be an algebraic space over $S$.
Let $(U, R, s, t, c)$ be a groupoid in algebraic spaces over $B$.
In the commutative diagram
\begin{equation}
\label{equation-diagram}
\vcenter{
\xymatrix{
& U & \\
R \ar[d]_s \ar[ru]^t &
R \times_{s, U, t} R
\ar[l]^-{\text{pr}_0} \ar[d]^{\text{pr}_1} \ar[r]_-c &
R \ar[d]^s \ar[lu]_t \\
U & R \ar[l]_t \ar[r]^s & U
}
}
\end{equation}
the two lower squares are fibre product squares.
Moreover, the triangle on top (which is really a square)
is also cartesian.

\medskip\noindent
The diagram
\begin{equation}
\label{equation-pull}
\vcenter{
\xymatrix{
R \times_{t, U, t} R
\ar@<1ex>[r]^-{\text{pr}_1} \ar@<-1ex>[r]_-{\text{pr}_0}
\ar[d]_{\text{pr}_0 \times c \circ (i, 1)} &
R \ar[r]^t \ar[d]^{\text{id}_R} &
U \ar[d]^{\text{id}_U} \\
R \times_{s, U, t} R
\ar@<1ex>[r]^-c \ar@<-1ex>[r]_-{\text{pr}_0} \ar[d]_{\text{pr}_1} &
R \ar[r]^t \ar[d]^s &
U \\
R \ar@<1ex>[r]^s \ar@<-1ex>[r]_t &
U
}
}
\end{equation}
is commutative. The two top rows are isomorphic via the vertical maps given.
The two lower left squares are cartesian.







\section{Properties of groupoids}
\label{section-technical-lemma}

\noindent
This section is the analogue of
More on Groupoids, Section \ref{more-groupoids-section-technical-lemma}.
The reader is strongly encouraged to read that section first.

\medskip\noindent
The following lemma is the analogue of
More on Groupoids, Lemma \ref{more-groupoids-lemma-property-invariant}.

\begin{lemma}
\label{lemma-property-invariant}
Let $B \to S$ be as in Section \ref{section-notation}.
Let $(U, R, s, t, c)$ be a groupoid in algebraic spaces over $B$.
Let $\tau \in \{fppf, \linebreak[0] etale,\linebreak[0] smooth,\linebreak[0]
syntomic\}$. Let $\mathcal{P}$ be a property of morphisms of algebraic spaces
which is $\tau$-local on the target
(Descent on Spaces,
Definition \ref{spaces-descent-definition-property-morphisms-local}).
Assume $\{s : R \to U\}$ and $\{t : R \to U\}$ are coverings for the
$\tau$-topology. Let $W \subset U$ be the maximal open subspace such that
$s^{-1}(W) \to W$ has property $\mathcal{P}$.
Then $W$ is $R$-invariant
(Groupoids in Spaces,
Definition \ref{spaces-groupoids-definition-invariant-open}).
\end{lemma}

\begin{proof}
Consider the union $W_{set}$ of the images $g(|U'|) \subset |U|$ of
morphisms of algebraic spaces $g : U' \to U$ with the properties:
\begin{enumerate}
\item $g$ is flat of finite presentation, etale, smooth, or syntomic, and
\item the base change $s' : U' \times_{g, U, s} R \to U'$ has property
$\mathcal{P}$.
\end{enumerate}
Since each such morphism $g$ is open we see that $W_{set} \subset |U|$
is an open subset of $|U|$. Let $W \subset U$ denote the corresponding
open subspace, see
Properties of Spaces, Lemma \ref{spaces-properties-lemma-open-subspaces}.
Since $\mathcal{P}$ is local in the $\tau$ topology the
restriction of $s$ to $s^{-1}(W)$ has property $\mathcal{P}$.
This means the assertion of the lemma makes sense.
Next, consider the diagram in
Diagram (\ref{equation-diagram}).
Let $W_1 \subset R$ be the maximal open subspace over which the
second projection
$\text{pr}_1 : R \times_{s, U, t} R \to R$ has property $\mathcal{P}$.
(Note that $W_1$ exists by the same argument as above.)
By assumption the morphisms $t$, $s$ are
flat of finite presentation, etale, smooth, or syntomic, so they are
in particular open, see
Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-fppf-open}.
Hence $W' = s(W_1)$ and $W'' = t(W_1)$ are open subspaces of $U$.
Moreover, $\{s|_{W_1} : W_1 \to W'\}$ and $\{t|_{W_1} : W_1 \to W''\}$
are $\tau$-coverings by our assumption that
$\{s : R \to U\}$ and $\{t : R \to U\}$ are $\tau$-coverings.
Since the two lower squares of 
Diagram (\ref{equation-diagram})
are cartesian we now conclude that
\begin{enumerate}
\item $s : R \to U$ has property $\mathcal{P}$ over $W'$,
\item $t : R \to U$ has property $\mathcal{P}$ over $W''$, and also
\item $\text{pr}_1 : R \times_{s, U, t} R \to R$ has property
$\mathcal{P}$ over $t^{-1}(W)$, and
\item $\text{pr}_1 : R \times_{s, U, t} R \to R$ has property
$\mathcal{P}$ over $s^{-1}(W)$.
\end{enumerate}
Clarification: The first two statements come from descending the property
through the coverings mentioned above, the second two by going up along the
coverings $\{s|_{s^{-1}(W)} : s^{-1}(W) \to W\}$ and
$\{t|_{t^{-1}(W)} : t^{-1}(W) \to W\}$.
All in all we conclude that
$W', W'' \subset W$ and $t^{-1}(W), s^{-1}(W) \subset W_1$. In other words
$W_1 = s^{-1}(W) = t^{-1}(W)$ as desired.
\end{proof}




\section{Comparing fibres}
\label{section-fibres}

\noindent
This section is the analogue of
More on Groupoids, Section \ref{more-groupoids-section-fibres}.
The reader is strongly encouraged to read that section first.

\begin{lemma}
\label{lemma-two-fibres}
Let $B \to S$ be as in Section \ref{section-notation}.
Let $(U, R, s, t, c)$ be a groupoid in algebraic spaces over $B$.
Let $K$ be a field and let $r, r' : \text{Spec}(K) \to R$
be morphisms such that $t \circ r = t \circ r' : \text{Spec}(K) \to U$.
Set $u = s \circ r$, $u' = s \circ r'$ and denote
$F_u = \text{Spec}(K) \times_{u, U, s} R$ and
$F_{u'} = \text{Spec}(K) \times_{u', U, s} R$ the fibre products.
Then $F_u \cong F_{u'}$ as algebraic spaces over $K$.
\end{lemma}

\begin{proof}
We use the properties and the existence of
Diagram (\ref{equation-diagram}).
There exists a morphism $\xi : \text{Spec}(K) \to R \times_{s, U, t} R$
with $\text{pr}_0 \circ \xi = r$ and $c \circ \xi = r'$.
Let $\tilde r = \text{pr}_1 \circ \xi : \text{Spec}(K) \to R$.
Then looking at the bottom two squares of
Diagram (\ref{equation-diagram})
we see that both $F_u$ and $F_{u'}$ are identified with the algebraic space
$\text{Spec}(K) \times_{\tilde r, R, \text{pr}_1} (R \times_{s, U, t} R)$.
\end{proof}

\noindent
Actually, in the situation of the lemma the morphisms of pairs
$s : (R, r) \to (U, u)$ and $s : (R, r') \to (U, u')$ are
locally isomorphic in the $\tau$-topology, provided $\{s: R \to U\}$ is a
$\tau$-covering. We will insert a precise statement here if needed.




\section{The finite part of a morphism}
\label{section-finite}

\noindent
Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism of algebraic spaces over $S$.
For an algebraic space or a scheme $T$ over $S$ consider pairs
$(a, Z)$ where
\begin{equation}
\label{equation-finite-conditions}
\begin{matrix}
a : T \to Y\text{ is a morphism over }S,\hfill \\
Z \subset T \times_Y X\text{ is an open subspace such that }
\text{pr}_0|_Z : Z \to T\text{ is finite.}
\end{matrix}
\end{equation}
Suppose $h : T' \to T$ is a morphism of algebraic spaces over $S$
and $(a, Z)$ is a pair over $T$. Set
$a' = a \circ h$ and $Z' = (h \times \text{id}_X)^{-1}(Z) = T' \times_T Z$.
Then the pair $(a', Z')$ satisfies (1), (2) over $T'$.
This follows as finite morphisms are preserved under base change, see
Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-base-change-integral}.
Thus we obtain a functor
\begin{equation}
\label{equation-finite}
\begin{matrix}
(X/Y)_{fin} : &
(\textit{Sch}/S)^{opp} &
\longrightarrow &
\textit{Sets} \\
& T & \longmapsto &
\{(a, Z)\text{ as above}\}
\end{matrix}
\end{equation}
For applications we are mainly interested in this functor $(X/Y)_{fin}$
when $f$ is separated and locally of finite type. To get an idea
of what this is all about, take a look at
Remark \ref{remark-finite-quasi-finite-separated-morphism-schemes}.

\begin{lemma}
\label{lemma-finite-sheaf}
Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism of algebraic spaces over $S$.
Then we have
\begin{enumerate}
\item The presheaf $(X/Y)_{fin}$ satisfies the sheaf condition for
the fppf topology.
\item If $T$ is an algebraic space over $S$, then there is a
canonical bijection
$$
\text{Mor}_{\textit{Sh}((\textit{Sch}/S)_{fppf})}(T, (X/Y)_{fin})
=
\{(a, Z)\text{ satisfying \ref{equation-finite-conditions}}\}
$$
\end{enumerate}
\end{lemma}

\begin{proof}
Let $T$ be an algebraic space over $S$.
Let $\{T_i \to T\}$ be an fppf covering (by algebraic spaces).
Let $s_i = (a_i, Z_i)$ be pairs over $T_i$
satisfying \ref{equation-finite-conditions}
such that we have $s_i|_{T_i \times_T T_j} = s_j|_{T_i \times_T T_j}$.
First, this implies in particular that $a_i$ and $a_j$ define the same
morphism $T_i \times_T T_j \to Y$. By
Descent on Spaces,
Lemma \ref{spaces-descent-lemma-fppf-universal-effective-epimorphisms}
we deduce that there exists a unique morphism $a : T \to Y$
such that $a_i$ equals the composition $T_i \to T \to Y$.
Second, this implies that $Z_i \subset T_i \times_Y X$ are open subspaces
whose inverse images in $(T_i \times_T T_j) \times_Y X$ are equal.
Since $\{T_i \times_Y X \to T \times_Y X\}$ is an fppf covering
we deduce that there exists a unique open subspace $Z \subset T \times_Y X$
which restricts back to $Z_i$ over $T_i$, see
Descent on Spaces, Lemma \ref{spaces-descent-lemma-open-fpqc-covering}.
We claim that the projection $Z \to T$ is finite.
This follows as being finite is local for the fpqc topology, see
Descent on Spaces, Lemma \ref{spaces-descent-lemma-descending-property-finite}.

\medskip\noindent
Note that the result of the preceding paragraph in particular implies (1).

\medskip\noindent
Let $T$ be an algebraic space over $S$. In order to prove (2) we will
construct mutually inverse maps between the displayed sets. In the
following when we say ``pair'' we mean a pair satisfying
conditions \ref{equation-finite-conditions}.

\medskip\noindent
Let $v : T \to (X/Y)_{fin}$ be a natural transformation.
Choose a scheme $U$ and a surjective etale morphism $p : U \to T$.
Then $v(p) \in (X/Y)_{fin}(U)$ corresponds to a pair $(a_U, Z_U)$
over $U$. Let $R = U \times_T U$ with projections $t, s : R \to U$.
As $v$ is a transformation of functors we see that the pullbacks of
$(a_U, Z_U)$ by $s$ and $t$ agree. Hence, since $\{U \to T\}$ is an
fppf covering, we may apply the result of the first paragraph that
deduce that there exists a unique pair $(a, Z)$ over $T$.

\medskip\noindent
Conversely, let $(a, Z)$ be a pair over $T$. 
Let $U \to T$, $R = U \times_T U$, and $t, s : R \to U$ be as
above. Then the restriction $(a, Z)|_U$ gives rise to a
tranformation of functors $v : h_U \to (X/Y)_{fin}$ by the
Yoneda lemma
(Categories, Lemma \ref{categories-lemma-yoneda}).
As the two pullbacks $s^*(a, Z)|_U$ and $t^*(a, Z)|_U$
are equal, we see that $v$ coequalizes the two maps
$h_t, h_s : h_R \to h_U$. Since $T = U/R$ is the fppf quotient sheaf by
Spaces, Lemma \ref{spaces-lemma-space-presentation}
and since $(X/Y)_{fin}$ is an fppf sheaf by (1) we conclude
that $v$ factors through a map $T \to (X/Y)_{fin}$.

\medskip\noindent
We omit the verification that the two constructions above are mutually
inverse.
\end{proof}

\begin{lemma}
\label{lemma-finite-open}
Let $S$ be a scheme. Consider a commutative diagram
$$
\xymatrix{
X' \ar[rr]_j \ar[rd] & & X \ar[ld] \\
& Y
}
$$
of algebraic spaces over $S$. If $j$ is an open immersion, then
there is a canonical injective map of sheaves
$j : (X'/Y)_{fin} \to (X/Y)_{fin}$.
\end{lemma}

\begin{proof}
If $(a, Z)$ is a pair over $T$ for $X'/Y$, then
$(a, j(Z))$ is a pair over $T$ for $X/Y$.
\end{proof}

\begin{lemma}
\label{lemma-finite-lives-on-locally-quasi-finite-part}
Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism of algebraic spaces over $S$ which is
locally of finite type.
Let $X' \subset X$ be the maximal open subspace over which $f$ is
locally quasi-finite, see
Morphisms of Spaces,
Lemma \ref{spaces-morphisms-lemma-locally-finite-type-quasi-finite-part}.
Then $(X/Y)_{fin} = (X'/Y)_{fin}$.
\end{lemma}

\begin{proof}
Lemma \ref{lemma-finite-open}
gives us an injective map $(X'/Y)_{fin} \to (X/Y)_{fin}$.
Morphisms of Spaces,
Lemma \ref{spaces-morphisms-lemma-locally-finite-type-quasi-finite-part}
assures us that formation of $X'$ commutes with base change.
Hence everything comes down to proving that if
$Z \subset X$ is a open subspace such that $f|_Z : Z \to Y$ is finite,
then $Z \subset X'$. This is true because a finite morphism
is locally quasi-finite, see
Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-finite-quasi-finite}.
\end{proof}

\begin{lemma}
\label{lemma-finite-separated}
Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism of algebraic spaces over $S$.
Let $T$ be an algebraic space over $S$, and let $(a, Z)$ be
a pair as in \ref{equation-finite-conditions}.
If $f$ is separated, then $Z$ is closed in $T \times_Y X$.
\end{lemma}

\begin{proof}
A finite morphism of algebraic spaces is universally closed by
Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-finite-proper}.
Since $f$ is separated so is the morphism $T \times_Y X \to T$, see
Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-base-change-separated}.
Thus the closedness of $Z$ follows from
Morphisms of Spaces,
Lemma \ref{spaces-morphisms-lemma-universally-closed-permanence}.
\end{proof}

\begin{remark}
\label{remark-finite-monoid}
Let $f : X \to Y$ be a separated morphism of algebraic spaces.
The sheaf $(X/Y)_{fin}$ comes with a natural map
$(X/Y)_{fin} \to Y$ by mapping the pair $(a, Z) \in (X/Y)_{fin}(T)$
to the element $a \in Y(T)$. We can use
Lemma \ref{lemma-finite-separated}
to define operations
$$
\star_i : (X/Y)_{fin} \times_Y (X/Y)_{fin} \longrightarrow (X/Y)_{fin}
$$
by the rules
\begin{align*}
\star_1 : ((a, Z_1), (a, Z_2)) & \longmapsto (a, Z_1 \cup Z_2) \\
\star_2 : ((a, Z_1), (a, Z_2)) & \longmapsto (a, Z_1 \cap Z_2) \\
\star_3 : ((a, Z_1), (a, Z_2)) & \longmapsto (a, Z_1 \setminus Z_2) \\
\star_4 : ((a, Z_1), (a, Z_2)) & \longmapsto (a, Z_2 \setminus Z_1).
\end{align*}
The reason this works is that $Z_1 \cap Z_2$ is both open and closed
inside $Z_1$ and $Z_2$ (which also implies that $Z_1 \cup Z_2$ is
the disjoint union of the other three pieces).
Thus we can think of $(X/Y)_{fin}$ as an $\mathbf{F}_2$-algebras
(without unit) over $Y$ with multiplication given by
$ss' = \star_2(s, s')$, and addition given by
$$
s + s' = \star_1(\star_3(s, s'), \star_4(s, s'))
$$
which boils down to taking the symmetric difference.
Note that in this sheaf of algebras $0 = (1_Y, \emptyset)$
and that indeed $s + s = 0$ for any local section $s$.
If $f : X \to Y$ is finite, then this algebra has a unit namely
$1 = (1_Y, X)$ and $\star_3(s, s') = s(1 + s')$, and
$\star_4(s, s') = (1 + s)s'$.
\end{remark}

\begin{remark}
\label{remark-finite-quasi-finite-separated-morphism-schemes}
Let $f : X \to Y$ be a separated, locally quasi-finite
morphism of schemes. In this case the sheaf $(X/Y)_{fin}$
is closely related to the sheaf $f_!\mathbf{F}_2$
(insert future reference here) on $Y_{etale}$.
Namely, if $V \to Y$ is etale, and $s \in \Gamma(V, f_!\mathbf{F}_2)$,
then $s \in \Gamma(V \times_Y X, \mathbf{F}_2)$ is a section
with proper support $Z = \text{Supp}(s)$ over $V$. Since $f$ is
als locally quasi-finite we see that the projection $Z \to V$ is actually
finite. Since the support of a section of a constant abelian sheaf is open
we see that the pair $(V \to Y, \text{Supp}(s))$ satisfies
\ref{equation-finite-conditions}.
In fact, $f_!\mathbf{F}_2 \cong (X/Y)_{fin}|_{Y_{etale}}$
in this case which also explains the $\mathbf{F}_2$-algebra structure
introduced in Remark \ref{remark-finite-monoid}.
\end{remark}

\begin{lemma}
\label{lemma-finite-diagonal}
Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism of algebraic spaces over $S$.
The diagonal of $(X/Y)_{fin} \to Y$
$$
(X/Y)_{fin} \longrightarrow (X/Y)_{fin} \times_Y (X/Y)_{fin}
$$
is representable (by schemes) and an open immersion and the ``absolute''
diagonal
$$
(X/Y)_{fin} \longrightarrow (X/Y)_{fin} \times (X/Y)_{fin}
$$
is representable (by schemes).
\end{lemma}

\begin{proof}
The second statement follows from the first as the absolute diagonal
is the composition of the relative diagonal and a base change
of the diagonal of $Y$ (which is representable by schemes), see
Spaces, Section \ref{spaces-section-representable}.
To prove the first assertion we have to show the following:
Given a scheme $T$ and two pairs $(a, Z_1)$ and $(a, Z_2)$ over $T$
with identical first component
satisfying \ref{equation-finite-conditions}
there is an open subscheme $V \subset T$ with the following
property: For any morphism of schemes $h : T' \to T$ we have
$$
h(T') \subset V \Leftrightarrow
\Big(T' \times_T Z_1 = T' \times_T Z_2
\text{ as subspaces of }T' \times_Y X\Big)
$$
Let us construct $V$. Note that $Z_1 \cap Z_2$ is open in $Z_1$
and in $Z_2$. Since $\text{pr}_0|_{Z_i} : Z_i \to T$ is finite,
hence proper (see
Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-finite-proper})
we see that
$$
E =
\text{pr}_0|_{Z_1}\left(Z_1 \setminus Z_1 \cap Z_2)\right)
\cup
\text{pr}_0|_{Z_2}\left(Z_2 \setminus Z_1 \cap Z_2)\right)
$$
is closed in $T$. Now it is clear that $V = T \setminus E$ works.
\end{proof}

\begin{lemma}
\label{lemma-finite-criterion-etale}
Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism of algebraic spaces over $S$.
Suppose that $U$ is a scheme, $U \to Y$ is an etale morphism and
$Z \subset U \times_Y X$ is an open subspace finite over $U$.
Then the induced morphism $U \to (X/Y)_{fin}$ is etale.
\end{lemma}

\begin{proof}
This is formal from the description of the diagonal in
Lemma \ref{lemma-finite-diagonal}
but we write it out since it is an important step in the development
of the theory. We have to check that for any scheme $T$ over $S$ and a morphism
$T \to (X/Y)_{fin}$ the projection map
$$
T \times_{(X/Y)_{fin}} U \longrightarrow T
$$
is etale. Note that
$$
T \times_{(X/Y)_{fin}} U
=
(X/Y)_{fin} \times_{((X/Y)_{fin} \times_Y (X/Y)_{fin})} (T \times_Y U)
$$
Applying the result of
Lemma \ref{lemma-finite-diagonal}
we see that $T \times_{(X/Y)_{fin}} U$ is represented by an open subscheme of
$T \times_Y U$. As the projection $T \times_Y U \to T$ is etale by
Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-base-change-etale}
we conclude.
\end{proof}

\begin{lemma}
\label{lemma-finite-pullback}
Let $S$ be a scheme.
Let
$$
\xymatrix{
X' \ar[d] \ar[r] & X \ar[d] \\
Y' \ar[r] & Y
}
$$
be a fibre product square of algebraic spaces over $S$. Then
$$
\xymatrix{
(X'/Y')_{fin} \ar[d] \ar[r] & (X/Y)_{fin} \ar[d] \\
Y' \ar[r] & Y
}
$$
is a fibre product square of sheaves on $(\textit{Sch}/S)_{fppf}$.
\end{lemma}

\begin{proof}
It follows immediately from the definitions that
the sheaf $(X'/Y')_{fin}$ is equal to the sheaf
$Y' \times_Y (X/Y)_{fin}$.
\end{proof}

\begin{lemma}
\label{lemma-finite-surjective-etale-cover}
Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism of algebraic spaces over $S$.
If $f$ is separated and locally quasi-finite, then there exists a
scheme $U$ etale over $Y$ and a surjective etale morphism
$U \to (X/Y)_{fin}$ over $Y$.
\end{lemma}

\begin{proof}
Note that the assertion makes sense by the result of
Lemma \ref{lemma-finite-diagonal}
on the diagonal of $(X/Y)_{fin}$, see
Spaces, Lemma \ref{spaces-lemma-representable-diagonal}.
Let $V$ be a scheme and let $V \to Y$ be a surjective morphism. By
Lemma \ref{lemma-finite-pullback}
the morphism $(V \times_Y X/V)_{fin} \to (X/Y)_{fin}$ is
a base change of the map $V \to Y$ and hence is surjective and etale, see
Spaces,
Lemma \ref{spaces-lemma-base-change-representable-transformations-property}.
Hence it suffices to prove the lemma for $(V \times_Y X/V)_{fin}$.
(Here we implicitly use that the composition of representable, surjective, and
etale transformations of functors is again representable, surjective, and
etale, see
Spaces, Lemmas \ref{spaces-lemma-composition-representable-transformations} and
\ref{spaces-lemma-composition-representable-transformations-property}, and
Morphisms, Lemmas \ref{morphisms-lemma-composition-surjective} and
\ref{morphisms-lemma-composition-etale}.)
Note that the properties of being separated and locally quasi-finite
are preserved under base change, see
Morphisms of Spaces,
Lemmas \ref{spaces-morphisms-lemma-base-change-separated} and
\ref{spaces-morphisms-lemma-base-change-quasi-finite}.
Hence $V \times_Y X \to V$ is separated and locally quasi-finite as well,
and by
Morphisms of Spaces, Proposition
\ref{spaces-morphisms-proposition-locally-quasi-finite-separated-over-scheme}
we see that $V \times_Y X$ is a scheme as well.
Thus we may assume that $f : X \to Y$ is a separated and locally quasi-finite
morphism of schemes.

\medskip\noindent
Pick a point $y \in Y$. Pick $x_1, \ldots, x_n \in X$ points
lying over $y$. Pick an etale neighbourhood $a : (U, u) \to (Y, y)$ and a
decomposition
$$
U \times_S X =
W \coprod
\ \coprod\nolimits_{i = 1, \ldots, n}
\ \coprod\nolimits_{j = 1, \ldots, m_j}
V_{i, j}
$$
as in
More on Morphisms, Lemma
\ref{more-morphisms-lemma-etale-splits-off-quasi-finite-part-technical-variant}.
Pick any subset
$$
I \subset \{(i, j) \mid 1 \leq i \leq n,\ 1 \leq j \leq m_i\}.
$$
Given these choices we obtain a pair $(a, Z)$ with
$Z = \bigcup_{(i, j) \in I} V_{i, j}$
which satisfies conditions \ref{equation-finite-conditions}. In other words
we obtain a morphism $U \to (X/Y)_{fin}$. The construction of this morphism
depends on all the things we picked above, so we should really write
$$
U(y, n, x_1, \ldots, x_n, a, I) \longrightarrow (X/Y)_{fin}
$$
This morphism is etale by Lemma \ref{lemma-finite-criterion-etale}.

\medskip\noindent
Claim: The disjoint union of all of these is surjective onto $(X/Y)_{fin}$.
It is clear that if the claim holds, then the lemma is true.

\medskip\noindent
To show surjectivity we have to show the following (see
Spaces, Remark \ref{spaces-remark-warning}): Given a scheme $T$ over
$S$, a point $t \in T$, and a map $T \to (X/Y)_{fin}$ we can find a datum
$(y, n, x_1, \ldots, x_n, a, I)$ as above such that
$t$ is in the image of the projection map
$$
U(y, n, x_1, \ldots, x_n, a, I) \times_{(X/Y)_{fin}} T \longrightarrow T.
$$
To prove this we may clearly replace $T$ by
$\text{Spec}(\overline{\kappa(t)})$ and
$T \to (X/Y)_{fin}$ by the composition
$\text{Spec}(\overline{\kappa(t)}) \to T \to (X/Y)_{fin}$.
In other words, we may assume that $T$ is
the spectrum of an algebraically closed field.

\medskip\noindent
Let $T = \text{Spec}(k)$ be the spectrum of an algebraically closed
field $k$. The morphism $T \to (X/Y)_{fin}$ is given by a pair
$(T \to Y, Z)$ satisfying conditions \ref{equation-finite-conditions}.
Here is a picture:
$$
\xymatrix{
& Z \ar[d] \ar[r] & X \ar[d] \\
\text{Spec}(k) \ar@{=}[r] & T \ar[r] & Y
}
$$
Let $y \in Y$ be the image point of $T \to Y$.
Since $Z$ is finite over $k$ it has finitely many points.
Thus there exist finitely many points $x_1, \ldots, x_n \in X$
such that the image of $Z$ in $X$ is contained in $\{x_1, \ldots, x_n\}$.
Choose $a : (U, u) \to (Y, y)$ adapted to $y$ and $x_1, \ldots, x_n$ as
above, which gives the diagram
$$
\xymatrix{
W \coprod
\ \coprod\nolimits_{i = 1, \ldots, n}
\ \coprod\nolimits_{j = 1, \ldots, m_j}
V_{i, j} \ar[d] \ar[r] &
X \ar[d] \\
U \ar[r] & Y.
}
$$
Since $k$ is algebraically closed and
$\kappa(y) \subset \kappa(u)$ is finite separable
we may factor the morphism
$T = \text{Spec}(k) \to Y$ through the morphism
$u = \text{Spec}(\kappa(u)) \to \text{Spec}(\kappa(y)) = y \subset Y$.
With this choice we obtain the commutative diagram:
$$
\xymatrix{
Z \ar[d] \ar[r] &
W \coprod
\ \coprod\nolimits_{i = 1, \ldots, n}
\ \coprod\nolimits_{j = 1, \ldots, m_j}
V_{i, j} \ar[d] \ar[r] &
X \ar[d] \\
\text{Spec}(k) \ar[r] &
U \ar[r] & Y
}
$$
We know that the image of the left upper arrow ends up in
$\coprod V_{i, j}$. Recall also that $Z$ is an open subscheme
of $\text{Spec}(k) \times_Y X$ by definition of $(X/Y)_{fin}$
and that the right hand square is a fibre product square.
Thus we see that
$$
Z \subset
\coprod\nolimits_{i = 1, \ldots, n}\ \coprod\nolimits_{j = 1, \ldots, m_j}
\text{Spec}(k) \times_U V_{i, j}
$$
is an open subscheme. By construction (see
More on Morphisms, Lemma
\ref{more-morphisms-lemma-etale-splits-off-quasi-finite-part-technical-variant})
each $V_{i, j}$ has a unique point $v_{i, j}$ lying over $u$
with purely inseparable residue field extension
$\kappa(u) \subset \kappa(v_{i, j})$. Hence each
scheme $\text{Spec}(k) \times_U V_{i, j}$ has exactly one
point. Thus we see that
$$
Z = \coprod\nolimits_{(i, j) \in I} \text{Spec}(k) \times_U V_{i, j}
$$
for a unique subset
$I \subset \{(i, j) \mid 1 \leq i \leq n,\ 1 \leq j \leq m_i\}$.
Unwinding the definitions this shows that
$$
U(y, n, x_1, \ldots, x_n, a, I) \times_{(X/Y)_{fin}} T
$$
with $I$ as found above is nonempty as desired.
\end{proof}

\begin{proposition}
\label{proposition-finite-algebraic-space}
Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism of algebraic spaces over $S$ which
is separated and locally of finite type. Then $(X/Y)_{fin}$
is an algebraic space. Moreover, the morphism
$(X/Y)_{fin} \to Y$ is etale.
\end{proposition}

\begin{proof}
By
Lemma \ref{lemma-finite-lives-on-locally-quasi-finite-part}
we may replace $X$ by the open subscheme which is locally quasi-finite
over $Y$. Hence we may assume that $f$ is separated and locally quasi-finite.
We will check the three conditions of
Spaces, Definition \ref{spaces-definition-algebraic-space}.
Condition (1) follows from
Lemma \ref{lemma-finite-sheaf}.
Condition (2) follows from
Lemma \ref{lemma-finite-diagonal}.
Finally, condition (3) follows from
Lemma \ref{lemma-finite-surjective-etale-cover}.
Thus $(X/Y)_{fin}$ is an algebraic space.
Moreover, that lemma shows that there exists a commutative
diagram
$$
\xymatrix{
U \ar[rr] \ar[rd] & & (X/Y)_{fin} \ar[ld] \\
& Y
}
$$
with horizontal arrow surjective and etale and south-east arrow
etale. By
Properties of Spaces, Lemma \ref{spaces-properties-lemma-etale-local}
this implies that the south-west arrow is etale as well.
\end{proof}

\begin{remark}
\label{remark-warning}
The condition that $f$ be separated cannot be dropped from
Proposition \ref{proposition-finite-algebraic-space}.
An example is to take $X$ the affine line with zero doubled, see
Schemes, Example \ref{schemes-example-affine-space-zero-doubled},
$Y = \mathbf{A}^1_k$ the affine line, and $X \to Y$ the obvious map.
Recall that over $0 \in Y$ there are two points $0_1$ and $0_2$
in $X$. Thus $(X/Y)_{fin}$ has four points over $0$, namely
$\emptyset, \{0_1\}, \{0_2\}, \{0_1, 0_2\}$.
Of these four points only three can be lifted to an open
subscheme of $U \times_Y X$ finite over $U$ for $U \to Y$ etale,
namely $\emptyset, \{0_1\}, \{0_2\}$. This shows that $(X/Y)_{fin}$
if representable by an algebraic space is not etale over $Y$.
Similar arguments show that $(X/Y)_{fin}$ is really not an algebraic
space. Details omitted.
\end{remark}

\begin{remark}
\label{remark-not-scheme}
Let $Y = \mathbf{A}^1_{\mathbf{R}}$ be the affine line over the real
numbers, and let $X = \text{Spec}(\mathbf{C})$ mapping to the
$\mathbf{R}$-rational point $0$ in $Y$. In this case the morphism
$f : X \to Y$ is finite, but it is not the case that $(X/Y)_{fin}$
is a scheme. Namely, one can show that in this case the algebraic
space $(X/Y)_{fin}$ is isomorphic to the algebraic space of
Spaces, Example \ref{spaces-example-non-representable-descent}
associated to the extension $\mathbf{R} \subset \mathbf{C}$.
Thus it is really necessary to leave the category of schemes
in order to represent the sheaf $(X/Y)_{fin}$, even when $f$
is a finite morphism.
\end{remark}

\begin{lemma}
\label{lemma-finite-separated-flat-locally-finite-presentation}
Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism of algebraic spaces over $S$ which
is separated, flat, and locally of finite presentation.
In this case
\begin{enumerate}
\item $(X/Y)_{fin} \to Y$ is separated, representable, and etale, and
\item if $Y$ is a scheme, then $(X/Y)_{fin}$ is (representable by) a scheme.
\end{enumerate}
\end{lemma}

\begin{proof}
Since $f$ is in particular separated and locally of finite type (see
Morphisms of Spaces,
Lemma \ref{spaces-morphisms-lemma-finite-presentation-finite-type})
we see that $(X/Y)_{fin}$ is an algebraic space by
Proposition \ref{proposition-finite-algebraic-space}.
To prove that $(X/Y)_{fin} \to Y$ is separated we have to show
the following: Given a scheme $T$ and two pairs $(a, Z_1)$ and $(a, Z_2)$
over $T$
with identical first component satisfying \ref{equation-finite-conditions}
there is a closed subscheme $V \subset T$ with the following
property: For any morphism of schemes $h : T' \to T$ we have
$$
h \text{ factors through } V \Leftrightarrow
\Big(T' \times_T Z_1 = T' \times_T Z_2
\text{ as subspaces of }T' \times_Y X\Big)
$$
In the proof of
Lemma \ref{lemma-finite-diagonal}
we have seen that $V = T' \setminus E$ is an open subscheme of $T'$
with closed complement
$$
E =
\text{pr}_0|_{Z_1}\left(Z_1 \setminus Z_1 \cap Z_2)\right)
\cup
\text{pr}_0|_{Z_2}\left(Z_2 \setminus Z_1 \cap Z_2)\right).
$$
Thus everything comes down to showing that $E$ is also open. By
Lemma \ref{lemma-finite-separated}
we see that $Z_1$ and $Z_2$ are closed in $T' \times_Y X$. Hence
$Z_1 \setminus Z_1 \cap Z_2$ is open in $Z_1$. As $f$ is flat and
locally of finite presentation, so is $\text{pr}_0|_{Z_1}$.
This is true as $Z_1$ is an open subspace of the base change
$T' \times_Y X$, and
Morphisms of Spaces,
Lemmas \ref{spaces-morphisms-lemma-base-change-finite-presentation} and
Lemmas \ref{spaces-morphisms-lemma-base-change-flat}.
Hence $\text{pr}_0|_{Z_1}$ is open, see
Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-fppf-open}.
Thus $\text{pr}_0|_{Z_1}\left(Z_1 \setminus Z_1 \cap Z_2)\right)$ is
open and it follows that $E$ is open as desired.

\medskip\noindent
We have already seen that $(X/Y)_{fin} \to Y$ is etale, see
Proposition \ref{proposition-finite-algebraic-space}.
Hence now we know it is locally quasi-finite (see
Morphisms of Spaces,
Lemma \ref{spaces-morphisms-lemma-etale-locally-quasi-finite})
and separated, hence representable by
Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-locally-quasi-finite-separated-representable}.
The final assertion is clear (if you like you can use
Morphisms of Spaces, Proposition
\ref{spaces-morphisms-proposition-locally-quasi-finite-separated-over-scheme}).
\end{proof}

\noindent
Variant: Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism of algebraic spaces over $S$.
Let $\sigma : Y \to X$ be a section of $f$.
For an algebraic space or a scheme $T$ over $S$ consider pairs
$(a, Z)$ where
\begin{equation}
\label{equation-finite-conditions-variant}
\begin{matrix}
a : T \to Y\text{ is a morphism over }S,\hfill \\
Z \subset T \times_Y X\text{ is an open subspace such that }
\text{pr}_0|_Z : Z \to T\text{ is finite, and} \\
(1_T, \sigma \circ a) : T \to T \times_Y X\text{ factors through }Z.\hfill
\end{matrix}
\end{equation}
We will denote $(X/Y, \sigma)_{fin}$ the subfunctor of $(X/Y)_{fin}$
parametrizing these pairs.

\begin{lemma}
\label{lemma-finite-plus-section}
Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism of algebraic spaces over $S$.
Let $\sigma : Y \to X$ be a section of $f$. Then
\begin{enumerate}
\item the transformation of functors
$(X/Y, \sigma)_{fin} \to (X/Y)_{fin}$ is representable by open immersions,
\item if $f$ is separated, then the transformation of functors
$(X/Y, \sigma)_{fin} \to (X/Y)_{fin}$ is representable by open
and closed immersions,
\item if $(X/Y)_{fin}$ is an algebraic space, then $(X/Y, \sigma)_{fin}$
is an open subspace of $(X/Y)_{fin}$, and
\item if $(X/Y)_{fin}$ is a scheme, then $(X/Y, \sigma)_{fin}$ is an
open subscheme of $(X/Y)_{fin}$.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted. Hint: Given a pair $(a, Z)$ over $T$ as in
(\ref{equation-finite-conditions}) the inverse image of
$Z$ by $(1_T, \sigma \circ a) : T \to T \times_Y X$ is the open
subscheme of $T$ we are looking for.
\end{proof}





\section{Finite collections of arrows}
\label{section-finite-set-arrows}

\noindent
Let $\mathcal{C}$ be a groupoid, see
Categories, Definition \ref{categories-definition-groupoid}.
As discussed in
Groupoids, Section \ref{groupoids-section-groupoids}
this corresponds to a septuple $(\text{Ob}, \text{Arrows}, s, t, c, e, i)$.

\medskip\noindent
Using this data we can make another groupoid $\mathcal{C}_{fin}$
as follows:
\begin{enumerate}
\item An object of $\mathcal{C}_{fin}$ consists of a finite subset
$Z \subset \text{Arrows}$ with the following properties:
\begin{enumerate}
\item $s(Z) = \{u\}$ is a singleton, and
\item $e(u) \in Z$.
\end{enumerate}
\item A morphism of $\mathcal{C}_{fin}$ consists of a pair
$(Z, z)$, where $Z$ is an object of $\mathcal{C}_{fin}$ and
$z \in Z$.
\item The source of $(Z, z)$ is $Z$.
\item The target of $(Z, z)$ is $t(Z, z) = \{z' \circ z^{-1}; z' \in Z\}$.
\item Given $(Z_1, z_1)$, $(Z_2, z_2)$ such that $s(Z_1, z_1) = t(Z_2, z_2)$
the composition $(Z_1, z_1) \circ (Z_2, z_2)$ is $(Z_2, z_1 \circ z_2)$.
\end{enumerate}
We omit the verification that this defines a groupoid.
Pictorially an object of $\mathcal{C}_{fin}$ can be viewed
as a diagram
$$
\xymatrix{
& \bullet \\
\bullet \ar@(ul,dl)[]_e \ar[ru] \ar[r] \ar[rd] & \bullet \\
& \bullet
}
$$
To make a morphism of $\mathcal{C}_{fin}$ you pick one of the arrows
and you precompose the other arrows by its inverse. For example if we pick
the middle horizontal arrow then the target is the picture
$$
\xymatrix{
& \bullet \\
\bullet & \bullet \ar[l] \ar[u] \ar@(dr,ur)[]_e \ar[d] \\
& \bullet
}
$$
Note that the cardinalities of $s(Z, z)$ and $t(Z, z)$ are equal.
So $\mathcal{C}_{fin}$ is really a countable disjoint union of
groupoids.




\section{The finite part of a groupoid}
\label{section-finite-part-groupoid}

\noindent
In this section we are going to use the idea explained in
Section \ref{section-finite-set-arrows}
to take the finite part of a groupoid in algebraic spaces.

\medskip\noindent
Let $S$ be a scheme.
Let $B$ be an algebraic space over $S$.
Let $(U, R, s, t, c, e, i)$ be a groupoid in algebraic spaces over $B$.
Assumption: The morphisms $s, t$ are separated and locally of finite type.
This notation and assumption will we be fixed throughout this section.

\medskip\noindent
Denote $R_s$ the algebraic space $R$ seen as an
algebraic space over $U$ via $s$. Let
$U' = (R_s/U, e)_{fin}$. Since $s$ is separated and locally of
finite type, by
Proposition \ref{proposition-finite-algebraic-space} and
Lemma \ref{lemma-finite-plus-section},
we see that $U'$ is an algebraic space endowed with an etale morphism
$g : U' \to U$. Moreover, by
Lemma \ref{lemma-finite-sheaf}
there exists a universal open subspace
$Z_{univ} \subset R \times_{s, U, g} U'$ which is finite over $U'$
and such that $(1_{U'}, e \circ g) : U' \to R \times_{s, U, g} U'$
factors through $Z_{univ}$. Moreover, by
Lemma \ref{lemma-finite-separated}
the open subspace $Z_{univ}$ is also closed in $R \times_{s, U', g} U$.
Picture so far:
$$
\xymatrix{
Z_{univ} \ar[d] \ar[rd] & \\
R \times_{s, U, g} U' \ar[d] \ar[r] & U' \ar[d]^g \\
R \ar[r]^s & U
}
$$
Let $T$ be a scheme over $B$. We see that a $T$-valued point of
$Z_{univ}$ may be viewed as a triple $(u, Z, z)$ where
\begin{enumerate}
\item $u : T \to U$ is a $T$-valued point of $U$,
\item $Z \subset R \times_{s, U, u} T$ is an open and closed subspace
finite over $T$ such that $(e \circ u, 1_T)$ factors through it, and
\item $z : T \to R$ is a $T$-valued point of $R$ with $s \circ z = u$
and such that $(z, 1_T)$ factors through $Z$.
\end{enumerate}
Having said this, it is morally clear from the discussion in
Section \ref{section-finite-set-arrows}
that we can turn $(Z_{univ}, U')$ into a groupoid in algebraic spaces
over $B$. To make sure will define the morphisms $s', t', c', e', i'$
one by one using the functorial point of view. (Please don't read this
before reading and understanding the simple construction in
Section \ref{section-finite-set-arrows}.)

\medskip\noindent
The morphism $s' : Z_{univ} \to U'$ corresponds to the rule
$$
s' : (u, Z, z) \mapsto (u, Z).
$$
The morphism $t' : Z_{univ} \to U'$ is given by the rule
$$
t' : (u, Z, z) \mapsto (t \circ z, c(Z, i \circ z)).
$$
The entry $c(Z, i \circ z)$
makes sense as the map
$c(-, i \circ z) : R \times_{s, U, u} T \to R \times_{s, U, t \circ z} T$
is an isomorphism with inverse $c(-, z)$.
The morphism $e' : U' \to Z_{univ}$ is given by the rule
$$
e' : (u, Z) \mapsto (u, Z, (e \circ u, 1_T)).
$$
Note that this makes sense by the requirement that $(e \circ u, 1_T)$
factors through $Z$.
The morphism $i' : Z_{univ} \to Z_{univ}$ is given by the rule
$$
i' : (u, Z, z) \mapsto (t \circ z, c(Z, i \circ z), i \circ z).
$$
Finally, composition is defined by the rule
$$
c' : ((u_1, Z_1, z_1), (u_2, Z_2, z_2)) \mapsto (u_2, Z_2, z_1 \circ z_2).
$$
We omit the verification that the axioms of a groupoid in algebraic
spaces hold for $(U', Z_{univ}, s', t', c', e', i')$.

\medskip\noindent
A final piece of information is that there is a canonical morphism
of groupoids
$$
(U', Z_{univ}, s', t', c', e', i')
\longrightarrow
(U, R, s, t, c, e, i)
$$
Namely, the morphism $U' \to U$ is the morphism $g : U' \to U$
which is defined by the rule $(u, Z) \mapsto u$. The morphism
$Z_{univ} \to R$ is defined by the rule $(u, Z, z) \mapsto z$.
This finishes the construction. Let us summarize our findings as
follows.

\begin{lemma}
\label{lemma-finite-part-groupoid}
Let $S$ be a scheme.
Let $B$ be an algebraic space over $S$.
Let $(U, R, s, t, c, e, i)$ be a groupoid in algebraic spaces over $B$.
Assume the morphisms $s, t$ are separated and locally of finite type.
There exists a canonical morphism
$$
(U', Z_{univ}, s', t', c', e', i')
\longrightarrow
(U, R, s, t, c, e, i)
$$
of groupoids in algebraic spaces over $B$ where
\begin{enumerate}
\item $g : U' \to U$ is identified with $(R_s/U, e)_{fin} \to U$, and
\item $Z_{univ} \subset R \times_{s, U, g} U'$ is the universal
open (and closed) subspace finite over $U'$ which contains the base
change of the unit $e$.
\end{enumerate}
\end{lemma}

\begin{proof}
See discussion above.
\end{proof}









\section{Etale localization of groupoid schemes}
\label{section-etale-localize}

\noindent
In this section we prove results similar to \cite[Proposition 4.2]{K-M}.
We try to be a bit more general, and we try to avoid using Hilbert schemes
by using the finite part of a morphism instead. 
The goal is to "split" a groupoid in algebraic spaces over a point
after etale localization. Here is the definition (very similar to
\cite[Definition 4.1]{K-M}).

\begin{definition}
\label{definition-split-at-point}
Let $S$ be a scheme. Let $B$ be an algebraic space over $S$
Let $(U, R, s, t, c)$ be a groupoid in algebraic spaces over $B$.
Let $u \in |U|$ be a point.
\begin{enumerate}
\item We say $R$ is {\it split over $u$} if there exists an open
subspace $P \subset R$ such that
\begin{enumerate}
\item $(U, P, s|_P, t|_P, c|_{P \times_{s, U, t} P})$ is a
groupoid in algebraic spaces over $B$,
\item $s|_P$, $t|_P$ are finite, and
\item $\{r \in |R| : s(r) = u, t(r) = u\} \subset P$.
\end{enumerate}
The choice of such a $P$ will be called a {\it splitting of $R$ over $u$}.
\item We say $R$ is {\it quasi-split over $u$} if there exists an open
subspace $P \subset R$ such that
\begin{enumerate}
\item $(U, P, s|_P, t|_P, c|_{P \times_{s, U, t} P})$ is a
groupoid in algebraic spaces over $B$,
\item $s|_P$, $t|_P$ are finite, and
\item $e(u) \in |P|$\footnote{This condition is implied by (a).}.
\end{enumerate}
The choice of such a $P$ will be called a {\it quasi-splitting of $R$ over $u$}.
\end{enumerate}
\end{definition}

\noindent
Note the similarity of the conditions on $P$ to the conditions on
pairs in (\ref{equation-finite-conditions}). In particular, if
$s, t$ are separated, then $P$ is also closed in $R$ (see
Lemma \ref{lemma-finite-separated}).

\medskip\noindent
Suppose we start with a groupoid in algebraic spaces
$(U, R, s, t, c)$ over $B$ and a point $u \in |U|$.
Since the goal is to split the groupoid after etale localization
we may as well replace $U$ by an affine scheme (what we mean
is that this is harmless for any possible application).
Moreover, the additional hypotheses we are going to have
to impose will force $R$ to be a scheme at least in a neighbourhood
of $\{r \in |R| : s(r) = u, t(r) = u\}$ or $e(u)$. This is why
we start with a groupoid scheme as described below.
However, our technique of proof leads us outside of the category of schemes,
which is why we have formulated a splitting for the case of groupoids
in algebraic spaces above.
On the other hand, we know of no applications but
the case where the morphisms $s$, $t$
are also flat and of finite presentation, in which case
we end up back in the category of schemes.

\begin{situation}
\label{situation-etale-localize}
(Assumptions for splitting.)
Let $S$ be a scheme.
Let $(U, R, s, t, c)$ be a groupoid scheme over $S$.
Let $u \in U$ be a point. Assume that
\begin{enumerate}
\item $s, t : R \to U$ are separated,
\item $s$, $t$ are locally of finite type,
\item the set $\{r \in R : s(r) = u, t(r) = u\}$ is finite, and
\item $s$ is quasi-finite at each point of the set in (3).
\end{enumerate}
Note that assumptions (3) and (4) are implied by the assumption
that the fibre $s^{-1}(\{u\})$ is finite, see
Morphisms, Lemma \ref{morphisms-lemma-finite-fibre}.
\end{situation}

\begin{situation}
\label{situation-etale-localize-quasi}
(Assumptions for quasi-splitting.)
Let $S$ be a scheme.
Let $(U, R, s, t, c)$ be a groupoid scheme over $S$.
Let $u \in U$ be a point. Assume that
\begin{enumerate}
\item $s, t : R \to U$ are separated,
\item $s$, $t$ are locally of finite type, and
\item $s$ is quasi-finite at $e(u)$.
\end{enumerate}
\end{situation}

\noindent
It turns out that for applications to the existence theorems for algebraic
spaces the case of quasi-splittings is sufficient. In fact, it is for us
somehow a more natural case to consider, as in the stacks project there
are no finiteness conditions on the diagonal of an algebaic space, hence
the assumption that $\{r \in R : s(r) = u, t(r) = u\}$ is finite need
not hold even for a presentation $X = U/R$ of an algebraic space $X$.

\begin{lemma}
\label{lemma-splitting-general}
Assumptions and notation as in
Situation \ref{situation-etale-localize}.
Then there exists an algebraic space $U'$, an etale morphism
$U' \to U$, and a point $u' : \text{Spec}(\kappa(u)) \to U'$
lying over $u : \text{Spec}(\kappa(u)) \to U$
such that the restriction $R' = R|_{U'}$ of $R$ to $U'$
splits over $u'$.
\end{lemma}

\begin{proof}
Let $f : (U', Z_{univ}, s', t', c') \to (U, R, s, t, c)$ be as constructed in
Lemma \ref{lemma-finite-part-groupoid}.
Recall that $R' = R \times_{(U \times_S U)} (U' \times_S U')$.
Thus we get a morphism $(f, t', s') : Z_{univ} \to R'$ of groupoids
in algebraic spaces
$$
(U', Z_{univ}, s', t', c') \to (U', R', s', t', c')
$$
(by abuse of notation we indicate the morphisms in the two groupoids
by the same symbols). Now, as $Z \subset R \times_{s, U, g} U'$ is open
and $R' \to R \times_{s, U, g} U'$ is etale (as a base change
of $U' \to U$) we see that $Z_{univ} \to R'$ is an open immersion.
By construction the morphisms $s', t' : Z_{univ} \to U'$ are finite.
It remains to find the point $u'$ of $U'$.

\medskip\noindent
We think of $u$ as a morphism $\text{Spec}(\kappa(u)) \to U$ as in
the statement of the lemma. Set $F_u = R \times_{s, U} \text{Spec}(\kappa(u))$.
The set $\{r \in R : s(r) = u, t(r) = u\}$ is finite by assumption
and $F_u \to \text{Spec}(\kappa(u))$ is quasi-finite at each
of its elements. Hence we can find a decomposition into open and closed
subschemes
$$
F_u = Z_u \coprod Rest
$$
for some scheme $Z_u$ finite over $\kappa(u)$ whose support is
$\{r \in R : s(r) = u, t(r) = u\}$. Note that $e(u) \in Z_u$.
Hence by the construction of $U'$ in
Section \ref{section-finite-part-groupoid}
$(u, Z_u)$ defines a $\text{Spec}(\kappa(u))$-valued
point $u'$ of $U'$.

\medskip\noindent
We still have to show that the set
$\{r' \in |R'| : s'(r') = u', t'(r') = u'\}$
is contained in $|Z_{univ}|$.
Pick any point $r'$ in this set and represent it by a morphism
$r' : \text{Spec}(k) \to R'$. Denote $z : \text{Spec}(k) \to R$
the composition of $r'$ with the map $R' \to R$.
Since $\kappa(u) = \kappa(u')$, and since $s'(r') = u'$, $t(r') = u'$
no information is lost by considering the point $z$ rather than the
point $r'$, i.e., we can recover $r'$ from the point $z$.
For example $z$ is an element of the set $\{r \in R : s(r) = u, t(r) = u\}$
by our assumption on $r'$. The composition
$s \circ z : \text{Spec}(k) \to U$ factors through $u$, so we may
think of $s \circ z$ as a morphism $\text{Spec}(k) \to \text{Spec}(\kappa(u))$.
Hence we can consider the triple
$$
(s \circ z, Z_u \times_{\text{Spec}(\kappa(u)), s \circ z} \text{Spec}(k), z)
$$
where $Z_u$ is as above. This defines a $\text{Spec}(k)$-valued point
of $Z_{univ}$ above whose image under the map $Z_{univ} \to R'$
is the point $r'$ by the relationship between $z$ and $r'$ mentioned
above. This finishes the proof.
\end{proof}

\begin{lemma}
\label{lemma-quasi-splitting-general}
Assumptions and notation as in
Situation \ref{situation-etale-localize-quasi}.
Then there exists an algebraic space $U'$, an etale morphism
$U' \to U$, and a point $u' : \text{Spec}(\kappa(u)) \to U'$
lying over $u : \text{Spec}(\kappa(u)) \to U$
such that the restriction $R' = R|_{U'}$ of $R$ to $U'$
is quasi-split over $u'$.
\end{lemma}

\begin{proof}
The proof is almost exactly the same as the proof of
Lemma \ref{lemma-splitting-general}.
Let $f : (U', Z_{univ}, s', t', c') \to (U, R, s, t, c)$ be as constructed in
Lemma \ref{lemma-finite-part-groupoid}.
Recall that $R' = R \times_{(U \times_S U)} (U' \times_S U')$.
Thus we get a morphism $(f, t', s') : Z_{univ} \to R'$ of groupoids
in algebraic spaces
$$
(U', Z_{univ}, s', t', c') \to (U', R', s', t', c')
$$
(by abuse of notation we indicate the morphisms in the two groupoids
by the same symbols). Now, as $Z \subset R \times_{s, U, g} U'$ is open
and $R' \to R \times_{s, U, g} U'$ is etale (as a base change
of $U' \to U$) we see that $Z_{univ} \to R'$ is an open immersion.
By construction the morphisms $s', t' : Z_{univ} \to U'$ are finite.
It remains to find the point $u'$ of $U'$.

\medskip\noindent
We think of $u$ as a morphism $\text{Spec}(\kappa(u)) \to U$ as in
the statement of the lemma. Set $F_u = R \times_{s, U} \text{Spec}(\kappa(u))$.
The morphism $F_u \to \text{Spec}(\kappa(u))$ is quasi-finite at $e(u)$
by assumption. Hence we can find a decomposition into open and closed
subschemes
$$
F_u = Z_u \coprod Rest
$$
for some scheme $Z_u$ finite over $\kappa(u)$ whose support is $e(u)$.
Hence by the construction of $U'$ in
Section \ref{section-finite-part-groupoid}
$(u, Z_u)$ defines a $\text{Spec}(\kappa(u))$-valued
point $u'$ of $U'$. To finish the proof we have to show that
$e'(u') \in Z_{univ}$ which is clear.
\end{proof}

\noindent
Finally, when we add additional assumptions we obtain schemes.

\begin{lemma}
\label{lemma-splitting-scheme}
Assumptions and notation as in
Situation \ref{situation-etale-localize}.
Assume in addition that $s, t$ are flat and locally of finite presentation.
Then there exists a scheme $U'$, a separated etale morphism
$U' \to U$, and a point $u' \in U'$
lying over $u$ with $\kappa(u) = \kappa(u')$
such that the restriction $R' = R|_{U'}$ of $R$ to $U'$
splits over $u'$.
\end{lemma}

\begin{proof}
This follows from the construction of $U'$ in the proof of
Lemma \ref{lemma-splitting-general}
because in this case $U' = (R_s/U, e)_{fin}$ is a scheme separated over
$U$ by
Lemmas \ref{lemma-finite-separated-flat-locally-finite-presentation} and
\ref{lemma-finite-plus-section}.
\end{proof}

\begin{lemma}
\label{lemma-quasi-splitting-scheme}
Assumptions and notation as in
Situation \ref{situation-etale-localize-quasi}.
Assume in addition that $s, t$ are flat and locally of finite presentation.
Then there exists a scheme $U'$, a separated etale morphism
$U' \to U$, and a point $u' \in U'$ lying over $u$ with
$\kappa(u) = \kappa(u')$ such that the restriction $R' = R|_{U'}$ of
$R$ to $U'$ is quasi-split over $u'$.
\end{lemma}

\begin{proof}
This follows from the construction of $U'$ in the proof of
Lemma \ref{lemma-quasi-splitting-general}
because in this case $U' = (R_s/U, e)_{fin}$ is a scheme separated
over $U$ by
Lemmas \ref{lemma-finite-separated-flat-locally-finite-presentation} and
\ref{lemma-finite-plus-section}.
\end{proof}






\input{chapters}

\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}
