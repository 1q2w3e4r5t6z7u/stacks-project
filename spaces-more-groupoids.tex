\input{preamble}

% OK, start here.
%
\begin{document}

\title{More on Groupoids in Spaces}


\maketitle

\phantomsection
\label{section-phantom}

\tableofcontents

\section{Introduction}
\label{section-introduction}

\noindent
This chapter is devoted to advanced topics on groupoids
in algebraic spaces.
Even though the results are stated in terms of groupoids in
algebraic spaces, the
reader should keep in mind the $2$-cartesian diagram
\begin{equation}
\label{equation-quotient-stack}
\vcenter{
\xymatrix{
R \ar[r] \ar[d] & U \ar[d] \\
U \ar[r] & [U/R]
}
}
\end{equation}
where $[U/R]$ is the quotient stack, see
Groupoids in Spaces, Remark \ref{spaces-groupoids-remark-fundamental-square}.
Many of the results are motivated by thinking about this diagram.
See for example the beautiful paper \cite{K-M} by Keel and Mori.





\section{Notation}
\label{section-notation}

\noindent
We continue to abide by the conventions and notation introduced in
Groupoids in Spaces, Section \ref{spaces-groupoids-section-notation}.





\section{Useful diagrams}
\label{section-diagrams}

\noindent
We briefly restate the results of
Groupoids in Spaces, Lemmas \ref{spaces-groupoids-lemma-diagram} and
\ref{spaces-groupoids-lemma-diagram-pull}
for easy reference in this chapter.
Let $S$ be a scheme. Let $B$ be an algebraic space over $S$.
Let $(U, R, s, t, c)$ be a groupoid in algebraic spaces over $B$.
In the commutative diagram
\begin{equation}
\label{equation-diagram}
\vcenter{
\xymatrix{
& U & \\
R \ar[d]_s \ar[ru]^t &
R \times_{s, U, t} R
\ar[l]^-{\text{pr}_0} \ar[d]^{\text{pr}_1} \ar[r]_-c &
R \ar[d]^s \ar[lu]_t \\
U & R \ar[l]_t \ar[r]^s & U
}
}
\end{equation}
the two lower squares are fibre product squares.
Moreover, the triangle on top (which is really a square)
is also cartesian.

\medskip\noindent
The diagram
\begin{equation}
\label{equation-pull}
\vcenter{
\xymatrix{
R \times_{t, U, t} R
\ar@<1ex>[r]^-{\text{pr}_1} \ar@<-1ex>[r]_-{\text{pr}_0}
\ar[d]_{\text{pr}_0 \times c \circ (i, 1)} &
R \ar[r]^t \ar[d]^{\text{id}_R} &
U \ar[d]^{\text{id}_U} \\
R \times_{s, U, t} R
\ar@<1ex>[r]^-c \ar@<-1ex>[r]_-{\text{pr}_0} \ar[d]_{\text{pr}_1} &
R \ar[r]^t \ar[d]^s &
U \\
R \ar@<1ex>[r]^s \ar@<-1ex>[r]_t &
U
}
}
\end{equation}
is commutative. The two top rows are isomorphic via the vertical maps given.
The two lower left squares are cartesian.







\section{Properties of groupoids}
\label{section-technical-lemma}

\noindent
This section is the analogue of
More on Groupoids, Section \ref{more-groupoids-section-technical-lemma}.
The reader is strongly encouraged to read that section first.

\medskip\noindent
The following lemma is the analogue of
More on Groupoids, Lemma \ref{more-groupoids-lemma-property-invariant}.

\begin{lemma}
\label{lemma-property-invariant}
Let $B \to S$ be as in Section \ref{section-notation}.
Let $(U, R, s, t, c)$ be a groupoid in algebraic spaces over $B$.
Let $\tau \in \{fppf, \linebreak[0] etale,\linebreak[0] smooth,\linebreak[0]
syntomic\}$. Let $\mathcal{P}$ be a property of morphisms of algebraic spaces
which is $\tau$-local on the target
(Descent on Spaces,
Definition \ref{spaces-descent-definition-property-morphisms-local}).
Assume $\{s : R \to U\}$ and $\{t : R \to U\}$ are coverings for the
$\tau$-topology. Let $W \subset U$ be the maximal open subspace such that
$s^{-1}(W) \to W$ has property $\mathcal{P}$.
Then $W$ is $R$-invariant
(Groupoids in Spaces,
Definition \ref{spaces-groupoids-definition-invariant-open}).
\end{lemma}

\begin{proof}
Consider the union $W_{set}$ of the images $g(|U'|) \subset |U|$ of
morphisms of algebraic spaces $g : U' \to U$ with the properties:
\begin{enumerate}
\item $g$ is flat of finite presentation, etale, smooth, or syntomic, and
\item the base change $s' : U' \times_{g, U, s} R \to U'$ has property
$\mathcal{P}$.
\end{enumerate}
Since each such morphism $g$ is open we see that $W_{set} \subset |U|$
is an open subset of $|U|$. Let $W \subset U$ denote the corresponding
open subspace, see
Properties of Spaces, Lemma \ref{spaces-properties-lemma-open-subspaces}.
Since $\mathcal{P}$ is local in the $\tau$ topology the
restriction of $s$ to $s^{-1}(W)$ has property $\mathcal{P}$.
This means the assertion of the lemma makes sense.
Next, consider the diagram in
Diagram (\ref{equation-diagram}).
Let $W_1 \subset R$ be the maximal open subspace over which the
second projection
$\text{pr}_1 : R \times_{s, U, t} R \to R$ has property $\mathcal{P}$.
(Note that $W_1$ exists by the same argument as above.)
By assumption the morphisms $t$, $s$ are
flat of finite presentation, etale, smooth, or syntomic, so they are
in particular open, see
Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-fppf-open}.
Hence $W' = s(W_1)$ and $W'' = t(W_1)$ are open subspaces of $U$.
Moreover, $\{s|_{W_1} : W_1 \to W'\}$ and $\{t|_{W_1} : W_1 \to W''\}$
are $\tau$-coverings by our assumption that
$\{s : R \to U\}$ and $\{t : R \to U\}$ are $\tau$-coverings.
Since the two lower squares of 
Diagram (\ref{equation-diagram})
are cartesian we now conclude that
\begin{enumerate}
\item $s : R \to U$ has property $\mathcal{P}$ over $W'$,
\item $t : R \to U$ has property $\mathcal{P}$ over $W''$, and also
\item $\text{pr}_1 : R \times_{s, U, t} R \to R$ has property
$\mathcal{P}$ over $t^{-1}(W)$, and
\item $\text{pr}_1 : R \times_{s, U, t} R \to R$ has property
$\mathcal{P}$ over $s^{-1}(W)$.
\end{enumerate}
Clarification: The first two statements come from descending the property
through the coverings mentioned above, the second two by going up along the
coverings $\{s|_{s^{-1}(W)} : s^{-1}(W) \to W\}$ and
$\{t|_{t^{-1}(W)} : t^{-1}(W) \to W\}$.
All in all we conclude that
$W', W'' \subset W$ and $t^{-1}(W), s^{-1}(W) \subset W_1$. In other words
$W_1 = s^{-1}(W) = t^{-1}(W)$ as desired.
\end{proof}




\section{Comparing fibres}
\label{section-fibres}

\noindent
This section is the analogue of
More on Groupoids, Section \ref{more-groupoids-section-fibres}.
The reader is strongly encouraged to read that section first.

\begin{lemma}
\label{lemma-two-fibres}
Let $B \to S$ be as in Section \ref{section-notation}.
Let $(U, R, s, t, c)$ be a groupoid in algebraic spaces over $B$.
Let $K$ be a field and let $r, r' : \text{Spec}(K) \to R$
be morphisms such that $t \circ r = t \circ r' : \text{Spec}(K) \to U$.
Set $u = s \circ r$, $u' = s \circ r'$ and denote
$F_u = \text{Spec}(K) \times_{u, U, s} R$ and
$F_{u'} = \text{Spec}(K) \times_{u', U, s} R$ the fibre products.
Then $F_u \cong F_{u'}$ as algebraic spaces over $K$.
\end{lemma}

\begin{proof}
We use the properties and the existence of
Diagram (\ref{equation-diagram}).
There exists a morphism $\xi : \text{Spec}(K) \to R \times_{s, U, t} R$
with $\text{pr}_0 \circ \xi = r$ and $c \circ \xi = r'$.
Let $\tilde r = \text{pr}_1 \circ \xi : \text{Spec}(K) \to R$.
Then looking at the bottom two squares of
Diagram (\ref{equation-diagram})
we see that both $F_u$ and $F_{u'}$ are identified with the algebraic space
$\text{Spec}(K) \times_{\tilde r, R, \text{pr}_1} (R \times_{s, U, t} R)$.
\end{proof}

\noindent
Actually, in the situation of the lemma the morphisms of pairs
$s : (R, r) \to (U, u)$ and $s : (R, r') \to (U, u')$ are
locally isomorphic in the $\tau$-topology, provided $\{s: R \to U\}$ is a
$\tau$-covering. We will insert a precise statement here if needed.




\section{The finite part of a morphism}
\label{section-finite}

\noindent
Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism of algebraic spaces over $S$.
For an algebraic space or a scheme $T$ over $S$ consider pairs
$(a, Z)$ where
\begin{equation}
\label{equation-finite-conditions}
\begin{matrix}
a : T \to Y\text{ is a morphism over }S,\hfill \\
Z \subset T \times_Y X\text{ is an open subspace such that }
\text{pr}_0|_Z : Z \to T\text{ is finite.}
\end{matrix}
\end{equation}
Suppose $h : T' \to T$ is a morphism of algebraic spaces over $S$
and $(a, Z)$ is a pair over $T$. Set
$a' = a \circ h$ and $Z' = (h \times \text{id}_X)^{-1}(Z) = T' \times_T Z$.
Then the pair $(a', Z')$ satisfies (1), (2) over $T'$.
This follows as finite morphisms are preserved under base change, see
Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-base-change-integral}.
Thus we obtain a functor
\begin{equation}
\label{equation-finite}
\begin{matrix}
(X/Y)_{fin} : &
(\textit{Sch}/S)^{opp} &
\longrightarrow &
\textit{Sets} \\
& T & \longmapsto &
\{(a, Z)\text{ as above}\}
\end{matrix}
\end{equation}
For applications we are mainly interested in this functor $(X/Y)_{fin}$
when $f$ is separated and locally of finite type. To get an idea
of what this is all about, take a look at
Remark \ref{remark-finite-quasi-finite-separated-morphism-schemes}.

\begin{lemma}
\label{lemma-finite-sheaf}
Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism of algebraic spaces over $S$.
Then we have
\begin{enumerate}
\item The presheaf $(X/Y)_{fin}$ satisfies the sheaf condition for
the fppf topology.
\item If $T$ is an algebraic space over $S$, then there is a
canonical bijection
$$
\text{Mor}_{\textit{Sh}((\textit{Sch}/S)_{fppf})}(T, (X/Y)_{fin})
=
\{(a, Z)\text{ satisfying \ref{equation-finite-conditions}}\}
$$
\end{enumerate}
\end{lemma}

\begin{proof}
Let $T$ be an algebraic space over $S$.
Let $\{T_i \to T\}$ be an fppf covering (by algebraic spaces).
Let $s_i = (a_i, Z_i)$ be pairs over $T_i$
satisfying \ref{equation-finite-conditions}
such that we have $s_i|_{T_i \times_T T_j} = s_j|_{T_i \times_T T_j}$.
First, this implies in particular that $a_i$ and $a_j$ define the same
morphism $T_i \times_T T_j \to Y$. By
Descent on Spaces,
Lemma \ref{spaces-descent-lemma-fppf-universal-effective-epimorphisms}
we deduce that there exists a unique morphism $a : T \to Y$
such that $a_i$ equals the composition $T_i \to T \to Y$.
Second, this implies that $Z_i \subset T_i \times_Y X$ are open subspaces
whose inverse images in $(T_i \times_T T_j) \times_Y X$ are equal.
Since $\{T_i \times_Y X \to T \times_Y X\}$ is an fppf covering
we deduce that there exists a unique open subspace $Z \subset T \times_Y X$
which restricts back to $Z_i$ over $T_i$, see
Descent on Spaces, Lemma \ref{spaces-descent-lemma-open-fpqc-covering}.
We claim that the projection $Z \to T$ is finite.
This follows as being finite is local for the fpqc topology, see
Descent on Spaces, Lemma \ref{spaces-descent-lemma-descending-property-finite}.

\medskip\noindent
Note that the result of the preceding paragraph in particular implies (1).

\medskip\noindent
Let $T$ be an algebraic space over $S$. In order to prove (2) we will
construct mutually inverse maps between the displayed sets. In the
following when we say ``pair'' we mean a pair satisfying
conditions \ref{equation-finite-conditions}.

\medskip\noindent
Let $v : T \to (X/Y)_{fin}$ be a natural transformation.
Choose a scheme $U$ and a surjective etale morphism $p : U \to T$.
Then $v(p) \in (X/Y)_{fin}(U)$ corresponds to a pair $(a_U, Z_U)$
over $U$. Let $R = U \times_T U$ with projections $t, s : R \to U$.
As $v$ is a transformation of functors we see that the pullbacks of
$(a_U, Z_U)$ by $s$ and $t$ agree. Hence, since $\{U \to T\}$ is an
fppf covering, we may apply the result of the first paragraph that
deduce that there exists a unique pair $(a, Z)$ over $T$.

\medskip\noindent
Conversely, let $(a, Z)$ be a pair over $T$. 
Let $U \to T$, $R = U \times_T U$, and $t, s : R \to U$ be as
above. Then the restriction $(a, Z)|_U$ gives rise to a
tranformation of functors $v : h_U \to (X/Y)_{fin}$ by the
Yoneda lemma
(Categories, Lemma \ref{categories-lemma-yoneda}).
As the two pullbacks $s^*(a, Z)|_U$ and $t^*(a, Z)|_U$
are equal, we see that $v$ coequalizes the two maps
$h_t, h_s : h_R \to h_U$. Since $T = U/R$ is the fppf quotient sheaf by
Spaces, Lemma \ref{spaces-lemma-space-presentation}
and since $(X/Y)_{fin}$ is an fppf sheaf by (1) we conclude
that $v$ factors through a map $T \to (X/Y)_{fin}$.

\medskip\noindent
We omit the verification that the two constructions above are mutually
inverse.
\end{proof}

\begin{lemma}
\label{lemma-finite-open}
Let $S$ be a scheme. Consider a commutative diagram
$$
\xymatrix{
X' \ar[rr]_j \ar[rd] & & X \ar[ld] \\
& Y
}
$$
of algebraic spaces over $S$. If $j$ is an open immersion, then
there is a canonical injective map of sheaves
$j : (X'/Y)_{fin} \to (X/Y)_{fin}$.
\end{lemma}

\begin{proof}
If $(a, Z)$ is a pair over $T$ for $X'/Y$, then
$(a, j(Z))$ is a pair over $T$ for $X/Y$.
\end{proof}

\begin{lemma}
\label{lemma-finite-lives-on-locally-quasi-finite-part}
Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism of algebraic spaces over $S$ which is
locally of finite type.
Let $X' \subset X$ be the maximal open subspace over which $f$ is
locally quasi-finite, see
Morphisms of Spaces,
Lemma \ref{spaces-morphisms-lemma-locally-finite-type-quasi-finite-part}.
Then $(X/Y)_{fin} = (X'/Y)_{fin}$.
\end{lemma}

\begin{proof}
Lemma \ref{lemma-finite-open}
gives us an injective map $(X'/Y)_{fin} \to (X/Y)_{fin}$.
Morphisms of Spaces,
Lemma \ref{spaces-morphisms-lemma-locally-finite-type-quasi-finite-part}
assures us that formation of $X'$ commutes with base change.
Hence everything comes down to proving that if
$Z \subset X$ is a open subspace such that $f|_Z : Z \to Y$ is finite,
then $Z \subset X'$. This is true because a finite morphism
is locally quasi-finite, see
Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-finite-quasi-finite}.
\end{proof}

\begin{lemma}
\label{lemma-finite-separated}
Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism of algebraic spaces over $S$.
Let $T$ be an algebraic space over $S$, and let $(a, Z)$ be
a pair as in \ref{equation-finite-conditions}.
If $f$ is separated, then $Z$ is closed in $T \times_Y X$.
\end{lemma}

\begin{proof}
A finite morphism of algebraic spaces is universally closed by
Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-finite-proper}.
Since $f$ is separated so is the morphism $T \times_Y X \to T$, see
Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-base-change-separated}.
Thus the closedness of $Z$ follows from
Morphisms of Spaces,
Lemma \ref{spaces-morphisms-lemma-universally-closed-permanence}.
\end{proof}

\begin{remark}
\label{remark-finite-monoid}
Let $f : X \to Y$ be a separated morphism of algebraic spaces.
The sheaf $(X/Y)_{fin}$ comes with a natural map
$(X/Y)_{fin} \to Y$ by mapping the pair $(a, Z) \in (X/Y)_{fin}(T)$
to the element $a \in Y(T)$. We can use
Lemma \ref{lemma-finite-separated}
to define operations
$$
\star_i : (X/Y)_{fin} \times_Y (X/Y)_{fin} \longrightarrow (X/Y)_{fin}
$$
by the rules
\begin{align*}
\star_1 : ((a, Z_1), (a, Z_2)) & \longmapsto (a, Z_1 \cup Z_2) \\
\star_2 : ((a, Z_1), (a, Z_2)) & \longmapsto (a, Z_1 \cap Z_2) \\
\star_3 : ((a, Z_1), (a, Z_2)) & \longmapsto (a, Z_1 \setminus Z_2) \\
\star_4 : ((a, Z_1), (a, Z_2)) & \longmapsto (a, Z_2 \setminus Z_1).
\end{align*}
The reason this works is that $Z_1 \cap Z_2$ is both open and closed
inside $Z_1$ and $Z_2$ (which also implies that $Z_1 \cup Z_2$ is
the disjoint union of the other three pieces).
Thus we can think of $(X/Y)_{fin}$ as an $\mathbf{F}_2$-algebras
(without unit) over $Y$ with multiplication given by
$ss' = \star_2(s, s')$, and addition given by
$$
s + s' = \star_1(\star_3(s, s'), \star_4(s, s'))
$$
which boils down to taking the symmetric difference.
Note that in this sheaf of algebras $0 = (1_Y, \emptyset)$
and that indeed $s + s = 0$ for any local section $s$.
If $f : X \to Y$ is finite, then this algebra has a unit namely
$1 = (1_Y, X)$ and $\star_3(s, s') = s(1 + s')$, and
$\star_4(s, s') = (1 + s)s'$.
\end{remark}

\begin{remark}
\label{remark-finite-quasi-finite-separated-morphism-schemes}
Let $f : X \to Y$ be a separated, locally quasi-finite
morphism of schemes. In this case the sheaf $(X/Y)_{fin}$
is closely related to the sheaf $f_!\mathbf{F}_2$
(insert future reference here) on $Y_{etale}$.
Namely, if $V \to Y$ is etale, and $s \in \Gamma(V, f_!\mathbf{F}_2)$,
then $s \in \Gamma(V \times_Y X, \mathbf{F}_2)$ is a section
with proper support $Z = \text{Supp}(s)$ over $V$. Since $f$ is
als locally quasi-finite we see that the projection $Z \to V$ is actually
finite. Since the support of a section of a constant abelian sheaf is open
we see that the pair $(V \to Y, \text{Supp}(s))$ satisfies
\ref{equation-finite-conditions}.
In fact, $f_!\mathbf{F}_2 \cong (X/Y)_{fin}|_{Y_{etale}}$
in this case which also explains the $\mathbf{F}_2$-algebra structure
introduced in Remark \ref{remark-finite-monoid}.
\end{remark}

\begin{lemma}
\label{lemma-finite-diagonal}
Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism of algebraic spaces over $S$.
The diagonal of $(X/Y)_{fin} \to Y$
$$
(X/Y)_{fin} \longrightarrow (X/Y)_{fin} \times_Y (X/Y)_{fin}
$$
is representable (by schemes) and an open immersion and the ``absolute''
diagonal
$$
(X/Y)_{fin} \longrightarrow (X/Y)_{fin} \times (X/Y)_{fin}
$$
is representable (by schemes).
\end{lemma}

\begin{proof}
The second statement follows from the first as the absolute diagonal
is the composition of the relative diagonal and a base change
of the diagonal of $Y$ (which is representable by schemes), see
Spaces, Section \ref{spaces-section-representable}.
To prove the first assertion we have to show the following:
Given a scheme $T$ and two pairs $(a, Z_1)$ and $(a, Z_2)$ over $T$
with identical first component
satisfying \ref{equation-finite-conditions}
there is an open subscheme $V \subset T$ with the following
property: For any morphism of schemes $h : T' \to T$ we have
$$
h(T') \subset V \Leftrightarrow
\Big(T' \times_T Z_1 = T' \times_T Z_2
\text{ as subspaces of }T' \times_Y X\Big)
$$
Let us construct $V$. Note that $Z_1 \cap Z_2$ is open in $Z_1$
and in $Z_2$. Since $\text{pr}_0|_{Z_i} : Z_i \to T$ is finite,
hence proper (see
Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-finite-proper})
we see that
$$
E =
\text{pr}_0|_{Z_1}\left(Z_1 \setminus Z_1 \cap Z_2)\right)
\cup
\text{pr}_0|_{Z_2}\left(Z_2 \setminus Z_1 \cap Z_2)\right)
$$
is closed in $T$. Now it is clear that $V = T \setminus E$ works.
\end{proof}

\begin{lemma}
\label{lemma-finite-criterion-etale}
Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism of algebraic spaces over $S$.
Suppose that $U$ is a scheme, $U \to Y$ is an etale morphism and
$Z \subset U \times_Y X$ is an open subspace finite over $U$.
Then the induced morphism $U \to (X/Y)_{fin}$ is etale.
\end{lemma}

\begin{proof}
This is formal from the description of the diagonal in
Lemma \ref{lemma-finite-diagonal}
but we write it out since it is an important step in the development
of the theory. We have to check that for any scheme $T$ over $S$ and a morphism
$T \to (X/Y)_{fin}$ the projection map
$$
T \times_{(X/Y)_{fin}} U \longrightarrow T
$$
is etale. Note that
$$
T \times_{(X/Y)_{fin}} U
=
(X/Y)_{fin} \times_{((X/Y)_{fin} \times_Y (X/Y)_{fin})} (T \times_Y U)
$$
Applying the result of
Lemma \ref{lemma-finite-diagonal}
we see that $T \times_{(X/Y)_{fin}} U$ is represented by an open subscheme of
$T \times_Y U$. As the projection $T \times_Y U \to T$ is etale by
Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-base-change-etale}
we conclude.
\end{proof}

\begin{lemma}
\label{lemma-finite-pullback}
Let $S$ be a scheme.
Let
$$
\xymatrix{
X' \ar[d] \ar[r] & X \ar[d] \\
Y' \ar[r] & Y
}
$$
be a fibre product square of algebraic spaces over $S$. Then
$$
\xymatrix{
(X'/Y')_{fin} \ar[d] \ar[r] & (X/Y)_{fin} \ar[d] \\
Y' \ar[r] & Y
}
$$
is a fibre product square of sheaves on $(\textit{Sch}/S)_{fppf}$.
\end{lemma}

\begin{proof}
It follows immediately from the definitions that
the sheaf $(X'/Y')_{fin}$ is equal to the sheaf
$Y' \times_Y (X/Y)_{fin}$.
\end{proof}

\begin{lemma}
\label{lemma-finite-surjective-etale-cover}
Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism of algebraic spaces over $S$.
If $f$ is separated and locally quasi-finite, then there exists a
scheme $U$ etale over $Y$ and a surjective etale morphism
$U \to (X/Y)_{fin}$ over $Y$.
\end{lemma}

\begin{proof}
Note that the assertion makes sense by the result of
Lemma \ref{lemma-finite-diagonal}
on the diagonal of $(X/Y)_{fin}$, see
Spaces, Lemma \ref{spaces-lemma-representable-diagonal}.
Let $V$ be a scheme and let $V \to Y$ be a surjective morphism. By
Lemma \ref{lemma-finite-pullback}
the morphism $(V \times_Y X/V)_{fin} \to (X/Y)_{fin}$ is
a base change of the map $V \to Y$ and hence is surjective and etale, see
Spaces,
Lemma \ref{spaces-lemma-base-change-representable-transformations-property}.
Hence it suffices to prove the lemma for $(V \times_Y X/V)_{fin}$.
(Here we implicitly use that the composition of representable, surjective, and
etale transformations of functors is again representable, surjective, and
etale, see
Spaces, Lemmas \ref{spaces-lemma-composition-representable-transformations} and
\ref{spaces-lemma-composition-representable-transformations-property}, and
Morphisms, Lemmas \ref{morphisms-lemma-composition-surjective} and
\ref{morphisms-lemma-composition-etale}.)
Note that the properties of being separated and locally quasi-finite
are preserved under base change, see
Morphisms of Spaces,
Lemmas \ref{spaces-morphisms-lemma-base-change-separated} and
\ref{spaces-morphisms-lemma-base-change-quasi-finite}.
Hence $V \times_Y X \to V$ is separated and locally quasi-finite as well,
and by
Morphisms of Spaces, Proposition
\ref{spaces-morphisms-proposition-locally-quasi-finite-separated-over-scheme}
we see that $V \times_Y X$ is a scheme as well.
Thus we may assume that $f : X \to Y$ is a separated and locally quasi-finite
morphism of schemes.

\medskip\noindent
Pick a point $y \in Y$. Pick $x_1, \ldots, x_n \in X$ points
lying over $y$. Pick an etale neighbourhood $a : (U, u) \to (Y, y)$ and a
decomposition
$$
U \times_S X =
W \coprod
\ \coprod\nolimits_{i = 1, \ldots, n}
\ \coprod\nolimits_{j = 1, \ldots, m_j}
V_{i, j}
$$
as in
More on Morphisms, Lemma
\ref{more-morphisms-lemma-etale-splits-off-quasi-finite-part-technical-variant}.
Pick any subset
$$
I \subset \{(i, j) \mid 1 \leq i \leq n,\ 1 \leq j \leq m_i\}.
$$
Given these choices we obtain a pair $(a, Z)$ with
$Z = \bigcup_{(i, j) \in I} V_{i, j}$
which satisfies conditions \ref{equation-finite-conditions}. In other words
we obtain a morphism $U \to (X/Y)_{fin}$. The construction of this morphism
depends on all the things we picked above, so we should really write
$$
U(y, n, x_1, \ldots, x_n, a, I) \longrightarrow (X/Y)_{fin}
$$
This morphism is etale by Lemma \ref{lemma-finite-criterion-etale}.

\medskip\noindent
Claim: The disjoint union of all of these is surjective onto $(X/Y)_{fin}$.
It is clear that if the claim holds, then the lemma is true.

\medskip\noindent
To show surjectivity we have to show the following (see
Spaces, Remark \ref{spaces-remark-warning}): Given a scheme $T$ over
$S$, a point $t \in T$, and a map $T \to (X/Y)_{fin}$ we can find a datum
$(y, n, x_1, \ldots, x_n, a, I)$ as above such that
$t$ is in the image of the projection map
$$
U(y, n, x_1, \ldots, x_n, a, I) \times_{(X/Y)_{fin}} T \longrightarrow T.
$$
To prove this we may clearly replace $T$ by
$\text{Spec}(\overline{\kappa(t)})$ and
$T \to (X/Y)_{fin}$ by the composition
$\text{Spec}(\overline{\kappa(t)}) \to T \to (X/Y)_{fin}$.
In other words, we may assume that $T$ is
the spectrum of an algebraically closed field.

\medskip\noindent
Let $T = \text{Spec}(k)$ be the spectrum of an algebraically closed
field $k$. The morphism $T \to (X/Y)_{fin}$ is given by a pair
$(T \to Y, Z)$ satisfying conditions \ref{equation-finite-conditions}.
Here is a picture:
$$
\xymatrix{
& Z \ar[d] \ar[r] & X \ar[d] \\
\text{Spec}(k) \ar@{=}[r] & T \ar[r] & Y
}
$$
Let $y \in Y$ be the image point of $T \to Y$.
Since $Z$ is finite over $k$ it has finitely many points.
Thus there exist finitely many points $x_1, \ldots, x_n \in X$
such that the image of $Z$ in $X$ is contained in $\{x_1, \ldots, x_n\}$.
Choose $a : (U, u) \to (Y, y)$ adapted to $y$ and $x_1, \ldots, x_n$ as
above, which gives the diagram
$$
\xymatrix{
W \coprod
\ \coprod\nolimits_{i = 1, \ldots, n}
\ \coprod\nolimits_{j = 1, \ldots, m_j}
V_{i, j} \ar[d] \ar[r] &
X \ar[d] \\
U \ar[r] & Y.
}
$$
Since $k$ is algebraically closed and
$\kappa(y) \subset \kappa(u)$ is finite separable
we may factor the morphism
$T = \text{Spec}(k) \to Y$ through the morphism
$u = \text{Spec}(\kappa(u)) \to \text{Spec}(\kappa(y)) = y \subset Y$.
With this choice we obtain the commutative diagram:
$$
\xymatrix{
Z \ar[d] \ar[r] &
W \coprod
\ \coprod\nolimits_{i = 1, \ldots, n}
\ \coprod\nolimits_{j = 1, \ldots, m_j}
V_{i, j} \ar[d] \ar[r] &
X \ar[d] \\
\text{Spec}(k) \ar[r] &
U \ar[r] & Y
}
$$
We know that the image of the left upper arrow ends up in
$\coprod V_{i, j}$. Recall also that $Z$ is an open subscheme
of $\text{Spec}(k) \times_Y X$ by definition of $(X/Y)_{fin}$
and that the right hand square is a fibre product square.
Thus we see that
$$
Z \subset
\coprod\nolimits_{i = 1, \ldots, n}\ \coprod\nolimits_{j = 1, \ldots, m_j}
\text{Spec}(k) \times_U V_{i, j}
$$
is an open subscheme. By construction (see
More on Morphisms, Lemma
\ref{more-morphisms-lemma-etale-splits-off-quasi-finite-part-technical-variant})
each $V_{i, j}$ has a unique point $v_{i, j}$ lying over $u$
with purely inseparable residue field extension
$\kappa(u) \subset \kappa(v_{i, j})$. Hence each
scheme $\text{Spec}(k) \times_U V_{i, j}$ has exactly one
point. Thus we see that
$$
Z = \coprod\nolimits_{(i, j) \in I} \text{Spec}(k) \times_U V_{i, j}
$$
for a unique subset
$I \subset \{(i, j) \mid 1 \leq i \leq n,\ 1 \leq j \leq m_i\}$.
Unwinding the definitions this shows that
$$
U(y, n, x_1, \ldots, x_n, a, I) \times_{(X/Y)_{fin}} T
$$
with $I$ as found above is nonempty as desired.
\end{proof}

\begin{proposition}
\label{proposition-finite-algebraic-space}
Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism of algebraic spaces over $S$ which
is separated and locally of finite type. Then $(X/Y)_{fin}$
is an algebraic space. Moreover, the morphism
$(X/Y)_{fin} \to Y$ is etale.
\end{proposition}

\begin{proof}
By
Lemma \ref{lemma-finite-lives-on-locally-quasi-finite-part}
we may replace $X$ by the open subscheme which is locally quasi-finite
over $Y$. Hence we may assume that $f$ is separated and locally quasi-finite.
We will check the three conditions of
Spaces, Definition \ref{spaces-definition-algebraic-space}.
Condition (1) follows from
Lemma \ref{lemma-finite-sheaf}.
Condition (2) follows from
Lemma \ref{lemma-finite-diagonal}.
Finally, condition (3) follows from
Lemma \ref{lemma-finite-surjective-etale-cover}.
Thus $(X/Y)_{fin}$ is an algebraic space.
Moreover, that lemma shows that there exists a commutative
diagram
$$
\xymatrix{
U \ar[rr] \ar[rd] & & (X/Y)_{fin} \ar[ld] \\
& Y
}
$$
with horizontal arrow surjective and etale and south-east arrow
etale. By
Properties of Spaces, Lemma \ref{spaces-properties-lemma-etale-local}
this implies that the south-west arrow is etale as well.
\end{proof}

\begin{remark}
\label{remark-warning}
The condition that $f$ be separated cannot be dropped from
Proposition \ref{proposition-finite-algebraic-space}.
An example is to take $X$ the affine line with zero doubled, see
Schemes, Example \ref{schemes-example-affine-space-zero-doubled},
$Y = \mathbf{A}^1_k$ the affine line, and $X \to Y$ the obvious map.
Recall that over $0 \in Y$ there are two points $0_1$ and $0_2$
in $X$. Thus $(X/Y)_{fin}$ has four points over $0$, namely
$\emptyset, \{0_1\}, \{0_2\}, \{0_1, 0_2\}$.
Of these four points only three can be lifted to an open
subscheme of $U \times_Y X$ finite over $U$ for $U \to Y$ etale,
namely $\emptyset, \{0_1\}, \{0_2\}$. This shows that $(X/Y)_{fin}$
if representable by an algebraic space is not etale over $Y$.
Similar arguments show that $(X/Y)_{fin}$ is really not an algebraic
space. Details omitted.
\end{remark}

\begin{remark}
\label{remark-not-scheme}
Let $Y = \mathbf{A}^1_{\mathbf{R}}$ be the affine line over the real
numbers, and let $X = \text{Spec}(\mathbf{C})$ mapping to the
$\mathbf{R}$-rational point $0$ in $Y$. In this case the morphism
$f : X \to Y$ is finite, but it is not the case that $(X/Y)_{fin}$
is a scheme. Namely, one can show that in this case the algebraic
space $(X/Y)_{fin}$ is isomorphic to the algebraic space of
Spaces, Example \ref{spaces-example-non-representable-descent}
associated to the extension $\mathbf{R} \subset \mathbf{C}$.
Thus it is really necessary to leave the category of schemes
in order to represent the sheaf $(X/Y)_{fin}$, even when $f$
is a finite morphism.
\end{remark}

\begin{lemma}
\label{lemma-finite-separated-flat-locally-finite-presentation}
Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism of algebraic spaces over $S$ which
is separated, flat, and locally of finite presentation.
In this case
\begin{enumerate}
\item $(X/Y)_{fin} \to Y$ is separated, representable, and etale, and
\item if $Y$ is a scheme, then $(X/Y)_{fin}$ is (representable by) a scheme.
\end{enumerate}
\end{lemma}

\begin{proof}
Since $f$ is in particular separated and locally of finite type (see
Morphisms of Spaces,
Lemma \ref{spaces-morphisms-lemma-finite-presentation-finite-type})
we see that $(X/Y)_{fin}$ is an algebraic space by
Proposition \ref{proposition-finite-algebraic-space}.
To prove that $(X/Y)_{fin} \to Y$ is separated we have to show
the following: Given a scheme $T$ and two pairs $(a, Z_1)$ and $(a, Z_2)$
over $T$
with identical first component satisfying \ref{equation-finite-conditions}
there is a closed subscheme $V \subset T$ with the following
property: For any morphism of schemes $h : T' \to T$ we have
$$
h \text{ factors through } V \Leftrightarrow
\Big(T' \times_T Z_1 = T' \times_T Z_2
\text{ as subspaces of }T' \times_Y X\Big)
$$
In the proof of
Lemma \ref{lemma-finite-diagonal}
we have seen that $V = T' \setminus E$ is an open subscheme of $T'$
with closed complement
$$
E =
\text{pr}_0|_{Z_1}\left(Z_1 \setminus Z_1 \cap Z_2)\right)
\cup
\text{pr}_0|_{Z_2}\left(Z_2 \setminus Z_1 \cap Z_2)\right).
$$
Thus everything comes down to showing that $E$ is also open. By
Lemma \ref{lemma-finite-separated}
we see that $Z_1$ and $Z_2$ are closed in $T' \times_Y X$. Hence
$Z_1 \setminus Z_1 \cap Z_2$ is open in $Z_1$. As $f$ is flat and
locally of finite presentation, so is $\text{pr}_0|_{Z_1}$.
This is true as $Z_1$ is an open subspace of the base change
$T' \times_Y X$, and
Morphisms of Spaces,
Lemmas \ref{spaces-morphisms-lemma-base-change-finite-presentation} and
Lemmas \ref{spaces-morphisms-lemma-base-change-flat}.
Hence $\text{pr}_0|_{Z_1}$ is open, see
Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-fppf-open}.
Thus $\text{pr}_0|_{Z_1}\left(Z_1 \setminus Z_1 \cap Z_2)\right)$ is
open and it follows that $E$ is open as desired.

\medskip\noindent
We have already seen that $(X/Y)_{fin} \to Y$ is etale, see
Proposition \ref{proposition-finite-algebraic-space}.
Hence now we know it is locally quasi-finite (see
Morphisms of Spaces,
Lemma \ref{spaces-morphisms-lemma-etale-locally-quasi-finite})
and separated, hence representable by
Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-locally-quasi-finite-separated-representable}.
The final assertion is clear (if you like you can use
Morphisms of Spaces, Proposition
\ref{spaces-morphisms-proposition-locally-quasi-finite-separated-over-scheme}).
\end{proof}





\section{Etale localization of groupoids}
\label{section-etale-localize}

\noindent
The following lemma is \cite[Proposition 4.2]{K-M}.
The formulation is minimal in the sense that we only state the assumptions
used in the proof; we know of no applications but the case where
the morphisms $s$, $t$ are also flat (and of finite presentation).
And clearly if $s$, $t$ are flat, then so are $s'$ and $t'$, whence
also $s'|_P$, $t'|_P$.
Note that assumptions (3) and (4) are implied by the assumption
that the fibre of $s$ over $u$ is a finite set, see
Morphisms, Lemma \ref{morphisms-lemma-finite-fibre}.

\begin{lemma}
\label{lemma-quasi-finite-groupoid}
Let $S$ be a scheme.
Let $(U, R, s, t, c)$ be a groupoid scheme over $S$.
Let $u \in U$ be a point. Assume that
\begin{enumerate}
\item $s, t : R \to U$ are separated,
\item $s$, $t$ are locally of finite type, and
\item there are finitely many points $r_1, \ldots, r_n \in R$ with
$s(r_i) = t(r_i) = u$, and
\item $s$ is quasi-finite at each $r_i$.
\end{enumerate}
Then\footnote{The proof of this is currently incomplete and the formulation
of this lemma may have to be changed to assuming $s,t$ are flat and locally
of finite presentation. We are working on it.}
there exists an etale neighbourhood $(U', u') \to (U, u)$
with $\kappa(u) = \kappa(u')$
such that the restriction $R' = R|_{U'}$ of $R$ to $U'$ decomposes
into open and closed subschemes
$$
R' = R|_{U'} = P \coprod W
$$
with
\begin{enumerate}
\item $(U', P, s'|_P, t'|_P, c'|_P)$ is a groupoid scheme over $S$,
\item the morphisms $s'|_P : P \to U'$ and $t'|_P : P \to U'$ are
finite,
\item any point $r' \in R'$ with $s'(r') = t'(r') = u'$ is contained
in $P$.
\end{enumerate}
\end{lemma}

\begin{proof}
Since $(U, R, s, t, c)$ is a groupoid scheme, we see that also
$t$ is quasi-finite at each $r_i$. By
More on Morphisms,
Lemma \ref{more-morphisms-lemma-etale-splits-off-quasi-finite-part-technical}
we can find an etale neighbourhood $(U', u') \to (U, u)$ with
$\kappa(u) = \kappa(u')$ such that we have disjoint decompositions
$$
R \times_{s, U} U' = V_1 \coprod W_1,
\quad\text{and}\quad
U' \times_{U, t} R = V_2 \coprod W_2
$$
with the following properties
\begin{enumerate}
\item $V_1 \to U'$ is finite,
\item $V_2 \to U'$ is finite,
\item $(V_1)_{u'} = \{r_1, \ldots, r_n\}$ as sets (via the identification
$(R \times_{s, U} U')_{u'} = R_u$),
\item $(V_2)_{u'} = \{r_1, \ldots, r_n\}$ as sets (via the identification
$(U' \times_{U, t} R)_{u'} = R_u$).
\end{enumerate}
By definition of the restriction
(Groupoids, Definition \ref{groupoids-definition-restrict-groupoid})
we have
$$
R|_{U'} = (V_1 \coprod W_1) \times_R (V_1 \coprod W_1).
$$
Hence if we take $P = V_1 \times_R V_2$, then $P$ is open and closed
in the restriction and the morphisms $s'|_P, t'|_P : P \to U'$ are finite.
FIXME: Actually there seems to be no reason for this to hold.

\medskip\noindent
Since $R'$ is a groupoid we have $(s')^{-1}(\{u'\}) = (t')^{-1}(\{u'\})$
and because $\kappa(u) = \kappa(u')$ this set maps bijectively to
$s^{-1}(\{u\}) = t^{-1}(\{u\})$. Hence the set
$\{p' \in P' \mid s'(p') = t'(p') = u'\}$
maps bijectively to $\{r_1, \ldots, r_n\}$.
By our choice of $V_1$ and $V_2$ we see that the subset
$P \cap (s')^{-1}(\{u'\})$ maps bijectively
to $\{r_1, \ldots, r_n\}$. Thus we conclude that (3) holds.

\medskip\noindent
Finally, we have to show that (1) holds, i.e., that
$(U', P, s'|_P, t'|_P, c'|_P)$ is a groupoid.
Consider the morphism $c' : R' \times_{s', U', t'} R' \to R'$.
We want to show that, after possibly shrinking $U'$, that
$c'(P \times_{s'|_P, U', t'|_P} P) \subset P$. To see this
consider $T = (c')^{-1}(W) \cap P \times_{s'|_P, U', t'|_P} P$.
This is an open and closed subscheme of $P \times_{s'|_P, U', t'|_P} P$.
By the discussion in the preceding paragraph we have
$$
(s'|_P)^{-1}(\{u'\}) = \{r_1, \ldots, r_n\} = (t'|_P)^{-1}(\{u'\})
$$
and hence $c'$ maps this set into itself! Hence, if
$p_0, p_1, p_2: R' \times_{t',U',s'} R' \rightarrow U'$ are
the three projections, then $T \cap p_i^{-1}(\{u'\}) = 0$ for $i = 0, 1, 2$.
Since the restrictions of $p_i$ to $P \times_{s'|_P, U', t'|_P} P$ are finite
(because $s'|_P$ and $t'|_P$ are finite), we see that $p_i(T) \subset U'$
is a closed subscheme which does not contain the point $u'$.
Hence we may replace $U'$ by $U' \setminus p_0(T) \cup p_1(T) \cup p_2(T)$
to get to the case where $T = \emptyset$. At this point
we see that $c'(P \times_{s'|_P, U', t'|_P} P) \subset P$
as desired. We omit the verifications that, possibly after shrinking $S'$,
we may assume that also $e'(U') \subset P$ and $i'(P) \subset P$.
Hence we get a groupoid scheme $(U', P, s'|_P, t'|_P, c'|_P, e'|_P, i'|_P)$
and the lemma follows.
\end{proof}










\input{chapters}

\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}
