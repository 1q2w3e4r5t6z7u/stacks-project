\input{preamble}

% OK, start here.
%
\begin{document}

\title{Moduli Stacks}

\maketitle

\phantomsection
\label{section-phantom}

\tableofcontents




\section{Introduction}
\label{section-introduction}

\noindent
In this chapter we verify basic properties of moduli spaces
and moduli stacks such as
$\mathit{Hom}$, $\mathit{Isom}$, $\Cohstack_{X/B}$,
$\Quotfunctor_{\mathcal{F}/X/B}$, $\Hilbfunctor_{X/B}$,
$\Picardstack_{X/B}$, $\Picardfunctor_{X/B}$, $\mathit{Mor}_B(Z, X)$,
$\Spacesstack'_{fp, flat, proper}$, $\Polarizedstack$, and
$\Complexesstack_{X/B}$.
We have already shown these algebraic spaces or algebraic stacks
under suitable hypotheses, see Quot, Sections
\ref{quot-section-hom},
\ref{quot-section-isom},
\ref{quot-section-stack-coherent-sheaves},
\ref{quot-section-not-flat},
\ref{quot-section-quot},
\ref{quot-section-hilb},
\ref{quot-section-picard-stack},
\ref{quot-section-picard-functor},
\ref{quot-section-relative-morphisms},
\ref{quot-section-stack-of-spaces},
\ref{quot-section-polarized}, and
\ref{quot-section-moduli-complexes}.
The stack of curves, denoted $\textit{Curves}$ and introduced
in Quot, Section \ref{quot-section-curves}, is discussed in the
chapter on moduli of curves, see
Moduli of Curves, Section \ref{moduli-curves-section-stack-curves}.

\medskip\noindent
In some sense this chapter is following the footsteps of
Grothendieck's lectures \cite{Gr-I},
\cite{Gr-II},
\cite{Gr-III},
\cite{Gr-IV},
\cite{Gr-V}, and
\cite{Gr-VI}.







\section{Conventions and abuse of language}
\label{section-conventions}

\noindent
We continue to use the conventions and the abuse of language
introduced in
Properties of Stacks, Section \ref{stacks-properties-section-conventions}.
Unless otherwise mentioned our base scheme will be $\Spec(\mathbf{Z})$.






\section{Properties of Hom and Isom}
\label{section-hom-isom}

\noindent
Let $f : X \to B$ be a morphism of algebraic spaces which is
of finite presentation. Assume $\mathcal{F}$ and $\mathcal{G}$
are quasi-coherent $\mathcal{O}_X$-modules.
If $\mathcal{G}$ is of finite presentation, flat over $B$
with support proper over $B$, then the functor
$\mathit{Hom}(\mathcal{F}, \mathcal{G})$ defined by
$$
T/B \longmapsto \Hom_{\mathcal{O}_{X_T}}(\mathcal{F}_T, \mathcal{G}_T)
$$
is an algebraic space affine over $B$. If $\mathcal{F}$ is of
finite presentation, then
$\mathit{Hom}(\mathcal{F}, \mathcal{G}) \to B$
is of finite presentation. See
Quot, Proposition \ref{quot-proposition-hom}.

\medskip\noindent
If both $\mathcal{F}$ and $\mathcal{G}$ are of finite presentation,
flat over $B$ with support proper over $B$, then the subfunctor
$$
\mathit{Isom}(\mathcal{F}, \mathcal{G}) \subset
\mathit{Hom}(\mathcal{F}, \mathcal{G})
$$
is an algebraic space affine of finite presentation over $B$.
See Quot, Proposition \ref{quot-proposition-isom}.




\section{Properties of the stack of coherent sheaves}
\label{section-stack-coherent-sheaves}

\noindent
Let $f : X \to B$ be a morphism of algebraic spaces which is
separated and of finite presentation. Then the stack
$\Cohstack_{X/B}$ parametrizing flat families of coherent
modules with proper support is algebraic. See
Quot, Theorem \ref{quot-theorem-coherent-algebraic-general}.

\begin{lemma}
\label{lemma-coherent-diagonal-affine-fp}
The diagonal of $\Cohstack_{X/B}$ over $B$ is affine
and of finite presentation.
\end{lemma}

\begin{proof}
The representability of the diagonal (by algebraic spaces)
was shown in Quot, Lemma \ref{quot-lemma-coherent-diagonal}.
From the proof we find that we have to show
$\mathit{Isom}(\mathcal{F}, \mathcal{G}) \to T$
is affine and of finite presentation for a pair of
finitely presented $\mathcal{O}_{X_T}$-modules
$\mathcal{F}$, $\mathcal{G}$ flat over $T$ with support
proper over $T$. This was discussed in Section \ref{section-hom-isom}.
\end{proof}

\begin{lemma}
\label{lemma-coherent-qs-lfp}
The morphism $\Cohstack_{X/B} \to B$ is quasi-separated and
locally of finite presentation.
\end{lemma}

\begin{proof}
To check $\Cohstack_{X/B} \to B$ is quasi-separated we have to
show that its diagonal is quasi-compact and quasi-separated.
This is immediate from Lemma \ref{lemma-coherent-diagonal-affine-fp}.
To prove that $\Cohstack_{X/B} \to B$ is locally of finite
presentation, we have to show that $\Cohstack_{X/B} \to B$
is limit preserving, see
Limits of Stacks, Proposition
\ref{stacks-limits-proposition-characterize-locally-finite-presentation}.
This follows from Quot, Lemma \ref{quot-lemma-coherent-limits}
(small detail omitted).
\end{proof}

\begin{lemma}
\label{lemma-coherent-existence-part}
Assume $X \to B$ is proper as well as of finite presentation.
Then $\Cohstack_{X/B} \to B$ satisfies the existence part
of the valuative criterion (Morphisms of Stacks, Definition
\ref{stacks-morphisms-definition-existence}).
\end{lemma}

\begin{proof}
Taking base change, this immediately reduces to the following
problem: given a valuation ring $R$ with fraction field $K$ and
an algebraic space $X$ proper over $R$ and a coherent
$\mathcal{O}_{X_K}$-module $\mathcal{F}_K$, show there exists
a finitely presented $\mathcal{O}_X$-module $\mathcal{F}$
flat over $R$ whose generic fibre is $\mathcal{F}_K$.
Observe that by Flatness on Spaces, Theorem
\ref{spaces-flat-theorem-finite-type-flat}
any finite type quasi-coherent $\mathcal{O}_X$-module
$\mathcal{F}$ flat over $R$ is of finite presentation.
Denote $j : X_K \to X$ the embedding of the generic fibre.
As a base change of the affine morphism $\Spec(K) \to \Spec(R)$
the morphism $j$ is affine. Thus $j_*\mathcal{F}_K$ is
quasi-coherent. Write
$$
j_*\mathcal{F}_K = \colim \mathcal{F}_i
$$
as a filtered colimit of its finite type quasi-coherent
$\mathcal{O}_X$-submodules, see
Limits of Spaces, Lemma \ref{spaces-limits-lemma-directed-colimit-finite-type}.
Since $j_*\mathcal{F}_K$ is a sheaf of $K$-vector spaces over $X$,
it is flat over $\Spec(R)$. Thus each $\mathcal{F}_i$ is flat
over $R$ as flatness over a valuation ring is the same as being
torsion free
(More on Algebra, Lemma
\ref{more-algebra-lemma-valuation-ring-torsion-free-flat})
and torsion freeness is inherited by submodules.
Finally, we have to show that the map
$j^*\mathcal{F}_i \to \mathcal{F}_K$
is an isomorphism for some $i$.
Since $j^*j_*\mathcal{F}_K = \mathcal{F}_K$ (small detail omitted)
and since $j^*$ is exact, we see that $j^*\mathcal{F}_i \to \mathcal{F}_K$
is injective for all $i$.
Since $j^*$ commutes with colimits, we have
$\mathcal{F}_K = j^*j_*\mathcal{F}_K = \colim j^*\mathcal{F}_i$.
Since $\mathcal{F}_K$ is coherent (i.e., finitely presented),
there is an $i$ such that $j^*\mathcal{F}_i$ contains all the
(finitely many) generators over an affine \'etale cover of $X$.
Thus we get surjectivity of $j^*\mathcal{F}_i \to \mathcal{F}_K$
for $i$ large enough.
\end{proof}





\section{Properties of Quot}
\label{section-quot}

\noindent
Let $f : X \to B$ be a morphism of algebraic spaces which is
separated and of finite presentation. Let $\mathcal{F}$ be a
quasi-coherent $\mathcal{O}_X$-module. Then
$\Quotfunctor_{\mathcal{F}/X/B}$ is an algebraic space.
If $\mathcal{F}$ is of finite presentation, then
$\Quotfunctor_{\mathcal{F}/X/B} \to B$ is locally of finite
presentation. See Quot, Proposition \ref{quot-proposition-quot}.

\begin{lemma}
\label{lemma-quot-diagonal-closed}
The diagonal of $\Quotfunctor_{\mathcal{F}/X/B} \to B$ is a closed immersion.
If $\mathcal{F}$ is of finite type, then the diagonal is a closed
immersion of finite presentation.
\end{lemma}

\begin{proof}
Suppose we have a scheme $T/B$ and two quotients
$\mathcal{F}_T \to \mathcal{Q}_i$, $i = 1, 2$ corresponding
to $T$-valued points of $\Quotfunctor_{\mathcal{F}/X/B}$ over $B$.
Denote $\mathcal{K}_1$ the kernel of the first one and set
$u : \mathcal{K}_1 \to \mathcal{Q}_2$ the composition.
By Flatness on Spaces, Lemma \ref{spaces-flat-lemma-F-zero-closed-proper}
there is a closed subspace of $T$ such that $T' \to T$
factors through it if and only if the pullback $u_{T'}$ is zero.
This proves the diagonal is a closed immersion.
Moreover, if $\mathcal{F}$ is of finite type, then
$\mathcal{K}_1$ is of finite type
(Modules on Sites, Lemma
\ref{sites-modules-lemma-kernel-surjection-finite-onto-finite-presentation})
and we see that the diagonal is of finite presentation by
the same lemma.
\end{proof}

\begin{lemma}
\label{lemma-quot-s-lfp}
The morphism $\Quotfunctor_{\mathcal{F}/X/B} \to B$ is separated.
If $\mathcal{F}$ is of finite presentation, then it is also
locally of finite presentation.
\end{lemma}

\begin{proof}
To check $\Quotfunctor_{\mathcal{F}/X/B} \to B$ is separated we have to
show that its diagonal is a closed immersion. This
is true by Lemma \ref{lemma-quot-diagonal-closed}.
The second statement is part of
Quot, Proposition \ref{quot-proposition-quot}.
\end{proof}

\begin{lemma}
\label{lemma-quot-existence-part}
Assume $X \to B$ is proper as well as of finite presentation
and $\mathcal{F}$ quasi-coherent of finite type.
Then $\Quotfunctor_{\mathcal{F}/X/B} \to B$ satisfies the existence part
of the valuative criterion (Morphisms of Spaces, Definition
\ref{spaces-morphisms-definition-valuative-criterion}).
\end{lemma}

\begin{proof}
Taking base change, this immediately reduces to the following
problem: given a valuation ring $R$ with fraction field $K$,
an algebraic space $X$ proper over $R$, a finite type quasi-coherent
$\mathcal{O}_X$-module $\mathcal{F}$, and a coherent
quotient $\mathcal{F}_K \to \mathcal{Q}_K$, show there exists
a quotient $\mathcal{F} \to \mathcal{Q}$ where $\mathcal{Q}$ is a
finitely presented $\mathcal{O}_X$-module
flat over $R$ whose generic fibre is $\mathcal{Q}_K$.
Observe that by Flatness on Spaces, Theorem
\ref{spaces-flat-theorem-finite-type-flat}
any finite type quasi-coherent $\mathcal{O}_X$-module
$\mathcal{F}$ flat over $R$ is of finite presentation.
We first solve the existence of $\mathcal{Q}$ affine locally.

\medskip\noindent
Affine locally we arrive at the following problem:
let $R \to A$ be a finitely presented ring map,
let $M$ be a finite $A$-module, let $\varphi : M_K \to N_K$ be
an $A_K$-quotient module. Then we may consider
$$
L = \{x \in M \mid \varphi(x \otimes 1) = 0 \}
$$
The $M \to M/L$ is an $A$-module quotient which is
torsion free as an $R$-module. Hence it is flat as an
$R$-module (More on Algebra, Lemma
\ref{more-algebra-lemma-valuation-ring-torsion-free-flat}).
Since $M$ is finite as an $A$-module so is $L$ and we
conclude that $L$ is of finite presentation as an $A$-module
(by the reference above). Clearly $M/L$ is the unqiue such
quotient with $(M/L)_K = N_K$.

\medskip\noindent
The uniqueness in the construction of the previous paragraph
guarantees these quotients glue and give the desired $\mathcal{Q}$.
Here is a bit more detail. Choose a surjective \'etale morphism
$U \to X$ where $U$ is an affine scheme. Use the above construction
to construct a quotient $\mathcal{F}|_U \to \mathcal{Q}_U$
which is quasi-coherent, is flat over $R$, and recovers $\mathcal{Q}_K|U$
on the generic fibre. Since $X$ is separated, we see that
$U \times_X U$ is an affine scheme \'etale over $X$ as well.
Then $\mathcal{F}|_{U \times_X U} \to \text{pr}_1^*\mathcal{Q}_U$ and
$\mathcal{F}|_{U \times_X U} \to \text{pr}_2^*\mathcal{Q}_U$
agree as quotients by the uniquess in the construction. Hence we may descend
$\mathcal{F}|_U \to \mathcal{Q}_U$ to a surjection
$\mathcal{F} \to \mathcal{Q}$ as desired (Properties of Spaces,
Proposition \ref{spaces-properties-proposition-quasi-coherent}).
\end{proof}



\section{Properties of the Hilbert functor}
\label{section-hilb}

\noindent
Let $f : X \to B$ be a morphism of algebraic spaces which is
separated and of finite presentation. Then
$\Hilbfunctor_{X/B}$ is an algebraic space locally of finite
presentation over $B$. See Quot, Proposition \ref{quot-proposition-hilb}.

\begin{lemma}
\label{lemma-hilb-diagonal-closed}
The diagonal of $\Hilbfunctor_{X/B} \to B$ is a closed immersion
of finite presentation.
\end{lemma}

\begin{proof}
In Quot, Lemma \ref{quot-lemma-hilb-is-quot} we have seen that
$\Hilbfunctor_{X/B} = \Quotfunctor_{\mathcal{O}_X/X/B}$.
Hence this follows from Lemma \ref{lemma-quot-diagonal-closed}.
\end{proof}

\begin{lemma}
\label{lemma-hilb-s-lfp}
The morphism $\Hilbfunctor_{X/B} \to B$ is separated
and locally of finite presentation.
\end{lemma}

\begin{proof}
To check $\Hilbfunctor_{X/B} \to B$ is separated we have to
show that its diagonal is a closed immersion. This
is true by Lemma \ref{lemma-hilb-diagonal-closed}.
The second statement is part of
Quot, Proposition \ref{quot-proposition-hilb}.
\end{proof}

\begin{lemma}
\label{lemma-hilb-existence-part}
Assume $X \to B$ is proper as well as of finite presentation.
Then $\Hilbfunctor_{X/B} \to B$ satisfies the existence part
of the valuative criterion (Morphisms of Spaces, Definition
\ref{spaces-morphisms-definition-valuative-criterion}).
\end{lemma}

\begin{proof}
In Quot, Lemma \ref{quot-lemma-hilb-is-quot} we have seen that
$\Hilbfunctor_{X/B} = \Quotfunctor_{\mathcal{O}_X/X/B}$.
Hence this follows from Lemma \ref{lemma-quot-existence-part}.
\end{proof}










\section{Properties of the Picard stack}
\label{section-picard-stack}

\noindent
Let $f : X \to B$ be a morphism of algebraic spaces which is flat,
proper, and of finite presentation. Then the stack
$\Picardstack_{X/B}$ parametrizing invertible sheaves on $X/B$
is algebraic, see Quot, Proposition \ref{quot-proposition-pic}.

\begin{lemma}
\label{lemma-pic-diagonal-affine-fp}
The diagonal of $\Picardstack_{X/B}$ over $B$ is affine
and of finite presentation.
\end{lemma}

\begin{proof}
In Quot, Lemma \ref{quot-lemma-picard-stack-open-in-coh} we have seen that
$\Picardstack_{X/B}$ is an open substack of
$\Cohstack_{X/B}$. Hence this follows from
Lemma \ref{lemma-coherent-diagonal-affine-fp}.
\end{proof}

\begin{lemma}
\label{lemma-pic-qs-lfp}
The morphism $\Picardstack_{X/B} \to B$ is quasi-separated and
locally of finite presentation.
\end{lemma}

\begin{proof}
In Quot, Lemma \ref{quot-lemma-picard-stack-open-in-coh} we have seen that
$\Picardstack_{X/B}$ is an open substack of
$\Cohstack_{X/B}$. Hence this follows from
Lemma \ref{lemma-coherent-qs-lfp}.
\end{proof}

\begin{lemma}
\label{lemma-smooth-over-valuation-ring-effective-Cartier}
Let $R$ be a valuation ring with fraction field $K$.
Let $X$ be an algebraic space over $R$ such that $X \to \Spec(R)$
is smooth. For every effective Cartier divisor $D \subset X_K$
there exists an effective Cartier divisor $D' \subset X$
with $D'_K = D$.
\end{lemma}

\begin{proof}
Let $D' \subset X$ be the scheme theoretic image of $D \to X_K \to X$.
Since this morphism is quasi-compact, formation of $D'$
commutes with flat base change, see
Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-flat-base-change-scheme-theoretic-image}.
In particular we find that $D'_K = D$. Hence, in order to prove (1)
we may assume $X$ is affine. Say $X = \Spec(A)$.
Then $X_K = \Spec(A \otimes_R K)$ and $D$ corresponds to
an idea $I \subset A \otimes_R K$. We have to show that
$J = I \cap A$ cuts out an effective Cartier divisor in $X$.
First, observe that $A/J$ is flat over $R$ (as a torsion
free $R$-modules, by More on Algebra, Lemma
\ref{more-algebra-lemma-valuation-ring-torsion-free-flat}),
hence $J$ is finitely generated by
More on Algebra, Lemma
\ref{more-algebra-lemma-flat-finite-type-valuation-ring-finite-presentation}
and
Algebra, Lemma \ref{algebra-lemma-extension}.
Thus it suffices to show that $J_\mathfrak q \subset A_\mathfrak q$
is generated by a single element for each prime $\mathcal q \subset A$.
Let $\mathfrak p = R \cap \mathfrak q$. Then
$R_\mathfrak p$ is a valuation ring
(Algebra, Lemma \ref{algebra-lemma-make-valuation-rings}).
Observe further that $A_\mathfrak q/\mathfrak p A_\mathfrak q$
is a regular ring by Algebra, Lemma
\ref{algebra-lemma-characterize-smooth-over-field}.
Thus we may apply More on Algebra, Lemma
\ref{more-algebra-lemma-picard-group-generic-fibre-regular}
to see that $I(A_\mathfrak q \otimes_R K)$ is generated by
a single element $f \in A_\mathfrak p \otimes_R K$.
After clearing denominators we may assume $f \in A_\mathfrak q$.
Let $\mathfrak c \subset R_\mathfrak p$ be the content ideal of $f$
(see More on Algebra, Definition \ref{more-algebra-definition-content-ideal}
and More on Flatness, Lemma
\ref{flat-lemma-flat-finite-type-local-valuation-ring-has-content}).
Since $R_\mathfrak p$ is a valuation ring and
since $\mathfrak c$ is finitely generated
(More on Algebra, Lemma \ref{more-algebra-lemma-content-finitely-generated})
we see $\mathfrak c = (\pi)$ for some $\pi \in R_\mathfrak p$.
After relacing $f$ by $\pi^{-1}f$ we see that $f \in A_\mathfrak q$
and $f \not \in \mathfrak pA_\mathfrak q$.
Claim: $I_\mathfrak q = (f)$ which finishes the proof.
The easiest way to argue this is probably to say that
$A_\mathfrak q/fA_\mathfrak q$ is $R_\mathfrak p$-flat and
agrees with $A_\mathfrak q \otimes_R K/I(A_\mathfrak q \otimes_R K)$
after tensoring with $K$.
\end{proof}






\section{Properties of the Picard functor}
\label{section-picard-functor}

\noindent
Let $f : X \to B$ be a morphism of algebraic spaces which is flat,
proper, and of finite presentation such that moreover for every $T/B$
the canonical map
$$
\mathcal{O}_T \longrightarrow f_{T, *}\mathcal{O}_{X_T}
$$
is an isomorphism. Then the Picard functor $\Picardfunctor_{X/B}$ is an
algebraic space, see Quot, Proposition \ref{quot-proposition-pic-functor}.
There is a closed relationship with the Picard stack.

\begin{lemma}
\label{lemma-pic-gerbe-over-pic-functor}
The morphism $\Picardstack_{X/B} \to \Picardfunctor_{X/B}$
turns the Picard stack into a gerbe over the Picard functor.
\end{lemma}

\begin{proof}
To be added soon.
\end{proof}

\begin{lemma}
\label{lemma-pic-functor-diagonal-affine-fp}
The diagonal of $\Picardfunctor_{X/B}$ over $B$ is an immersion.
\end{lemma}

\begin{proof}
This is a reformulation of Quot, Lemma \ref{quot-lemma-diagonal-pic}.
\end{proof}











\input{chapters}

\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}
