\input{preamble}

% OK, start here.
%
\begin{document}

\title{Moduli Stacks}

\maketitle

\phantomsection
\label{section-phantom}

\tableofcontents




\section{Introduction}
\label{section-introduction}

\noindent
In this chapter we verify basic properties of moduli spaces
and moduli stacks such as
$\mathit{Hom}$, $\mathit{Isom}$, $\Cohstack_{X/B}$,
$\Quotfunctor_{\mathcal{F}/X/B}$, $\Hilbfunctor_{X/B}$,
$\Picardstack_{X/B}$, $\Picardfunctor_{X/B}$, $\mathit{Mor}_B(Z, X)$,
$\Spacesstack'_{fp, flat, proper}$, $\Polarizedstack$, and
$\Complexesstack_{X/B}$.
We have already shown these algebraic spaces or algebraic stacks
under suitable hypotheses, see Quot, Sections
\ref{quot-section-hom},
\ref{quot-section-isom},
\ref{quot-section-stack-coherent-sheaves},
\ref{quot-section-not-flat},
\ref{quot-section-quot},
\ref{quot-section-hilb},
\ref{quot-section-picard-stack},
\ref{quot-section-picard-functor},
\ref{quot-section-relative-morphisms},
\ref{quot-section-stack-of-spaces},
\ref{quot-section-polarized}, and
\ref{quot-section-moduli-complexes}.
The stack of curves, denoted $\textit{Curves}$ and introduced
in Quot, Section \ref{quot-section-curves}, is discussed in the
chapter on moduli of curves, see
Moduli of Curves, Section \ref{moduli-curves-section-stack-curves}.

\medskip\noindent
In some sense this chapter is following the footsteps of
Grothendieck's lectures \cite{Gr-I},
\cite{Gr-II},
\cite{Gr-III},
\cite{Gr-IV},
\cite{Gr-V}, and
\cite{Gr-VI}.







\section{Conventions and abuse of language}
\label{section-conventions}

\noindent
We continue to use the conventions and the abuse of language
introduced in
Properties of Stacks, Section \ref{stacks-properties-section-conventions}.
Unless otherwise mentioned our base scheme will be $\Spec(\mathbf{Z})$.






\section{Properties of Hom and Isom}
\label{section-hom-isom}

\noindent
Let $f : X \to B$ be a morphism of algebraic spaces which is
of finite presentation. Assume $\mathcal{F}$ and $\mathcal{G}$
are quasi-coherent $\mathcal{O}_X$-modules.
If $\mathcal{G}$ is of finite presentation, flat over $B$
with support proper over $B$, then the functor
$\mathit{Hom}(\mathcal{F}, \mathcal{G})$ defined by
$$
T/B \longmapsto \Hom_{\mathcal{O}_{X_T}}(\mathcal{F}_T, \mathcal{G}_T)
$$
is an algebraic space affine over $B$. If $\mathcal{F}$ is of
finite presentation, then
$\mathit{Hom}(\mathcal{F}, \mathcal{G}) \to B$
is of finite presentation. See
Quot, Proposition \ref{quot-proposition-hom}.

\medskip\noindent
If both $\mathcal{F}$ and $\mathcal{G}$ are of finite presentation,
flat over $B$ with support proper over $B$, then the subfunctor
$$
\mathit{Isom}(\mathcal{F}, \mathcal{G}) \subset
\mathit{Hom}(\mathcal{F}, \mathcal{G})
$$
is an algebraic space affine of finite presentation over $B$.
See Quot, Proposition \ref{quot-proposition-isom}.




\section{Properties of the stack of coherent sheaves}
\label{section-stack-coherent-sheaves}

\noindent
Let $f : X \to B$ be a morphism of algebraic spaces which is
separated and of finite presentation. Then the stack
$\Cohstack_{X/B}$ parametrizing flat families of coherent
modules with proper support is algebraic. See
Quot, Theorem \ref{quot-theorem-coherent-algebraic-general}.

\begin{lemma}
\label{lemma-coherent-diagonal-affine-fp}
The diagonal of $\Cohstack_{X/B}$ over $B$ is affine
and of finite presentation.
\end{lemma}

\begin{proof}
The representability of the diagonal (by algebraic spaces)
was shown in Quot, Lemma \ref{quot-lemma-coherent-diagonal}.
From the proof we find that we have to show
$\mathit{Isom}(\mathcal{F}, \mathcal{G}) \to T$
is affine and of finite presentation for a pair of
finitely presented $\mathcal{O}_{X_T}$-modules
$\mathcal{F}$, $\mathcal{G}$ flat over $T$ with support
proper over $T$. This was discussed in Section \ref{section-hom-isom}.
\end{proof}

\begin{lemma}
\label{lemma-coherent-qs-lfp}
The morphism $\Cohstack_{X/B} \to B$ is quasi-separated and
locally of finite presentation.
\end{lemma}

\begin{proof}
To check $\Cohstack_{X/B} \to B$ is quasi-separated we have to
show that its diagonal is quasi-compact and quasi-separated.
This is immediate from Lemma \ref{lemma-coherent-diagonal-affine-fp}.
To prove that $\Cohstack_{X/B} \to B$ is locally of finite
presentation, we have to show that $\Cohstack_{X/B} \to B$
is limit preserving, see
Limits of Stacks, Proposition
\ref{stacks-limits-proposition-characterize-locally-finite-presentation}.
This follows from Quot, Lemma \ref{quot-lemma-coherent-limits}
(small detail omitted).
\end{proof}

\begin{lemma}
\label{lemma-coherent-existence-part}
Assume $X \to B$ is proper as well as of finite presentation.
Then $\Cohstack_{X/B} \to B$ satisfies the existence part
of the valuative criterion (Morphisms of Stacks, Definition
\ref{stacks-morphisms-definition-existence}).
\end{lemma}

\begin{proof}
Taking base change, this immediately reduces to the following
problem: given a valuation ring $R$ with fraction field $K$ and
an algebraic space $X$ proper over $R$ and a coherent
$\mathcal{O}_{X_K}$-module $\mathcal{F}_K$, show there exists
a finitely presented $\mathcal{O}_X$-module $\mathcal{F}$
flat over $R$ whose generic fibre is $\mathcal{F}_K$.
Observe that by Flatness on Spaces, Theorem
\ref{spaces-flat-theorem-finite-type-flat}
any finite type quasi-coherent $\mathcal{O}_X$-module
$\mathcal{F}$ flat over $R$ is of finite presentation.
Denote $j : X_K \to X$ the embedding of the generic fibre.
As a base change of the affine morphism $\Spec(K) \to \Spec(R)$
the morphism $j$ is affine. Thus $j_*\mathcal{F}_K$ is
quasi-coherent. Write
$$
j_*\mathcal{F}_K = \colim \mathcal{F}_i
$$
as a filtered colimit of its finite type quasi-coherent
$\mathcal{O}_X$-submodules, see
Limits of Spaces, Lemma \ref{spaces-limits-lemma-directed-colimit-finite-type}.
Since $j_*\mathcal{F}_K$ is a sheaf of $K$-vector spaces over $X$,
it is flat over $\Spec(R)$. Thus each $\mathcal{F}_i$ is flat
over $R$ as flatness over a valuation ring is the same as being
torsion free
(More on Algebra, Lemma
\ref{more-algebra-lemma-valuation-ring-torsion-free-flat})
and torsion freeness is inherited by submodules.
Finally, we have to show that the map
$j^*\mathcal{F}_i \to \mathcal{F}_K$
is an isomorphism for some $i$.
Since $j^*j_*\mathcal{F}_K = \mathcal{F}_K$ (small detail omitted)
and since $j^*$ is exact, we see that $j^*\mathcal{F}_i \to \mathcal{F}_K$
is injective for all $i$.
Since $j^*$ commutes with colimits, we have
$\mathcal{F}_K = j^*j_*\mathcal{F}_K = \colim j^*\mathcal{F}_i$.
Since $\mathcal{F}_K$ is coherent (i.e., finitely presented),
there is an $i$ such that $j^*\mathcal{F}_i$ contains all the
(finitely many) generators over an affine \'etale cover of $X$.
Thus we get surjectivity of $j^*\mathcal{F}_i \to \mathcal{F}_K$
for $i$ large enough.
\end{proof}





\section{Properties of Quot}
\label{section-quot}

\noindent
Let $f : X \to B$ be a morphism of algebraic spaces which is
separated and of finite presentation. Let $\mathcal{F}$ be a
quasi-coherent $\mathcal{O}_X$-module. Then
$\Quotfunctor_{\mathcal{F}/X/B}$ is an algebraic space.
If $\mathcal{F}$ is of finite presentation, then
$\Quotfunctor_{\mathcal{F}/X/B} \to B$ is locally of finite
presentation. See Quot, Proposition \ref{quot-proposition-quot}.

\begin{lemma}
\label{lemma-quot-diagonal-closed}
The diagonal of $\Quotfunctor_{\mathcal{F}/X/B} \to B$ is a closed immersion.
If $\mathcal{F}$ is of finite type, then the diagonal is a closed
immersion of finite presentation.
\end{lemma}

\begin{proof}
Suppose we have a scheme $T/B$ and two quotients
$\mathcal{F}_T \to \mathcal{Q}_i$, $i = 1, 2$ corresponding
to $T$-valued points of $\Quotfunctor_{\mathcal{F}/X/B}$ over $B$.
Denote $\mathcal{K}_1$ the kernel of the first one and set
$u : \mathcal{K}_1 \to \mathcal{Q}_2$ the composition.
By Flatness on Spaces, Lemma \ref{spaces-flat-lemma-F-zero-closed-proper}
there is a closed subspace of $T$ such that $T' \to T$
factors through it if and only if the pullback $u_{T'}$ is zero.
This proves the diagonal is a closed immersion.
Moreover, if $\mathcal{F}$ is of finite type, then
$\mathcal{K}_1$ is of finite type
(Modules on Sites, Lemma
\ref{sites-modules-lemma-kernel-surjection-finite-onto-finite-presentation})
and we see that the diagonal is of finite presentation by
the same lemma.
\end{proof}

\begin{lemma}
\label{lemma-quot-s-lfp}
The morphism $\Quotfunctor_{\mathcal{F}/X/B} \to B$ is separated.
If $\mathcal{F}$ is of finite presentation, then it is also
locally of finite presentation.
\end{lemma}

\begin{proof}
To check $\Quotfunctor_{\mathcal{F}/X/B} \to B$ is separated we have to
show that its diagonal is a closed immersion. This
is true by Lemma \ref{lemma-quot-diagonal-closed}.
The second statement is part of
Quot, Proposition \ref{quot-proposition-quot}.
\end{proof}

\begin{lemma}
\label{lemma-quot-existence-part}
Assume $X \to B$ is proper as well as of finite presentation
and $\mathcal{F}$ quasi-coherent of finite type.
Then $\Quotfunctor_{\mathcal{F}/X/B} \to B$ satisfies the existence part
of the valuative criterion (Morphisms of Spaces, Definition
\ref{spaces-morphisms-definition-valuative-criterion}).
\end{lemma}

\begin{proof}
Taking base change, this immediately reduces to the following
problem: given a valuation ring $R$ with fraction field $K$,
an algebraic space $X$ proper over $R$, a finite type quasi-coherent
$\mathcal{O}_X$-module $\mathcal{F}$, and a coherent
quotient $\mathcal{F}_K \to \mathcal{Q}_K$, show there exists
a quotient $\mathcal{F} \to \mathcal{Q}$ where $\mathcal{Q}$ is a
finitely presented $\mathcal{O}_X$-module
flat over $R$ whose generic fibre is $\mathcal{Q}_K$.
Observe that by Flatness on Spaces, Theorem
\ref{spaces-flat-theorem-finite-type-flat}
any finite type quasi-coherent $\mathcal{O}_X$-module
$\mathcal{F}$ flat over $R$ is of finite presentation.
We first solve the existence of $\mathcal{Q}$ affine locally.

\medskip\noindent
Affine locally we arrive at the following problem:
let $R \to A$ be a finitely presented ring map,
let $M$ be a finite $A$-module, let $\varphi : M_K \to N_K$ be
an $A_K$-quotient module. Then we may consider
$$
L = \{x \in M \mid \varphi(x \otimes 1) = 0 \}
$$
The $M \to M/L$ is an $A$-module quotient which is
torsion free as an $R$-module. Hence it is flat as an
$R$-module (More on Algebra, Lemma
\ref{more-algebra-lemma-valuation-ring-torsion-free-flat}).
Since $M$ is finite as an $A$-module so is $L$ and we
conclude that $L$ is of finite presentation as an $A$-module
(by the reference above). Clearly $M/L$ is the unqiue such
quotient with $(M/L)_K = N_K$.

\medskip\noindent
The uniqueness in the construction of the previous paragraph
guarantees these quotients glue and give the desired $\mathcal{Q}$.
Here is a bit more detail. Choose a surjective \'etale morphism
$U \to X$ where $U$ is an affine scheme. Use the above construction
to construct a quotient $\mathcal{F}|_U \to \mathcal{Q}_U$
which is quasi-coherent, is flat over $R$, and recovers $\mathcal{Q}_K|U$
on the generic fibre. Since $X$ is separated, we see that
$U \times_X U$ is an affine scheme \'etale over $X$ as well.
Then $\mathcal{F}|_{U \times_X U} \to \text{pr}_1^*\mathcal{Q}_U$ and
$\mathcal{F}|_{U \times_X U} \to \text{pr}_2^*\mathcal{Q}_U$
agree as quotients by the uniquess in the construction. Hence we may descend
$\mathcal{F}|_U \to \mathcal{Q}_U$ to a surjection
$\mathcal{F} \to \mathcal{Q}$ as desired (Properties of Spaces,
Proposition \ref{spaces-properties-proposition-quasi-coherent}).
\end{proof}



\section{Properties of the Hilbert functor}
\label{section-hilb}

\noindent
Let $f : X \to B$ be a morphism of algebraic spaces which is
separated and of finite presentation. Then
$\Hilbfunctor_{X/B}$ is an algebraic space locally of finite
presentation over $B$. See Quot, Proposition \ref{quot-proposition-hilb}.

\begin{lemma}
\label{lemma-hilb-diagonal-closed}
The diagonal of $\Hilbfunctor_{X/B} \to B$ is a closed immersion
of finite presentation.
\end{lemma}

\begin{proof}
In Quot, Lemma \ref{quot-lemma-hilb-is-quot} we have seen that
$\Hilbfunctor_{X/B} = \Quotfunctor_{\mathcal{O}_X/X/B}$.
Hence this follows from Lemma \ref{lemma-quot-diagonal-closed}.
\end{proof}

\begin{lemma}
\label{lemma-hilb-s-lfp}
The morphism $\Hilbfunctor_{X/B} \to B$ is separated
and locally of finite presentation.
\end{lemma}

\begin{proof}
To check $\Hilbfunctor_{X/B} \to B$ is separated we have to
show that its diagonal is a closed immersion. This
is true by Lemma \ref{lemma-hilb-diagonal-closed}.
The second statement is part of
Quot, Proposition \ref{quot-proposition-hilb}.
\end{proof}

\begin{lemma}
\label{lemma-hilb-existence-part}
Assume $X \to B$ is proper as well as of finite presentation.
Then $\Hilbfunctor_{X/B} \to B$ satisfies the existence part
of the valuative criterion (Morphisms of Spaces, Definition
\ref{spaces-morphisms-definition-valuative-criterion}).
\end{lemma}

\begin{proof}
In Quot, Lemma \ref{quot-lemma-hilb-is-quot} we have seen that
$\Hilbfunctor_{X/B} = \Quotfunctor_{\mathcal{O}_X/X/B}$.
Hence this follows from Lemma \ref{lemma-quot-existence-part}.
\end{proof}










\section{Properties of the Picard stack}
\label{section-picard-stack}

\noindent
Let $f : X \to B$ be a morphism of algebraic spaces which is flat,
proper, and of finite presentation. Then the stack
$\Picardstack_{X/B}$ parametrizing invertible sheaves on $X/B$
is algebraic, see Quot, Proposition \ref{quot-proposition-pic}.

\begin{lemma}
\label{lemma-pic-diagonal-affine-fp}
The diagonal of $\Picardstack_{X/B}$ over $B$ is affine
and of finite presentation.
\end{lemma}

\begin{proof}
In Quot, Lemma \ref{quot-lemma-picard-stack-open-in-coh} we have seen that
$\Picardstack_{X/B}$ is an open substack of
$\Cohstack_{X/B}$. Hence this follows from
Lemma \ref{lemma-coherent-diagonal-affine-fp}.
\end{proof}

\begin{lemma}
\label{lemma-pic-qs-lfp}
The morphism $\Picardstack_{X/B} \to B$ is quasi-separated and
locally of finite presentation.
\end{lemma}

\begin{proof}
In Quot, Lemma \ref{quot-lemma-picard-stack-open-in-coh} we have seen that
$\Picardstack_{X/B}$ is an open substack of
$\Cohstack_{X/B}$. Hence this follows from
Lemma \ref{lemma-coherent-qs-lfp}.
\end{proof}

\begin{lemma}
\label{lemma-pic-existence-part}
Assume $X \to B$ is smooth in addition to being proper.
Then $\Picardstack_{X/B} \to B$ satisfies the existence part
of the valuative criterion (Morphisms of Stacks, Definition
\ref{stacks-morphisms-definition-existence}).
\end{lemma}

\begin{proof}
Taking base change, this immediately reduces to the following
problem: given a valuation ring $R$ with fraction field $K$ and
an algebraic space $X$ proper and smooth over $R$ and an invertible
$\mathcal{O}_{X_K}$-module $\mathcal{L}_K$, show there exists
an invertible $\mathcal{O}_X$-module $\mathcal{L}$
whose generic fibre is $\mathcal{L}_K$.
Observe that $X_K$ is Noetherian, separated, and regular
(use Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-finite-presentation-noetherian}
and
Spaces over Fields, Lemma \ref{spaces-over-fields-lemma-smooth-regular}).
Thus we can write
$\mathcal{L}_K$ as the difference in the Picard group of
$\mathcal{O}_{X_K}(D_K)$ and $\mathcal{O}_{X_K}(D'_K)$
for two effective Cartier divisors $D_K, D'_K$ in $X_K$, see
Divisors on Spaces, Lemma
\ref{spaces-divisors-lemma-Noetherian-regular-separated-pic-effective-Cartier}.
Finally, we know that $D_K$ and $D'_K$ are restrictions of
effective Cartier divisors $D, D' \subset X$, see
Divisors on Spaces, Lemma
\ref{spaces-divisors-lemma-smooth-over-valuation-ring-effective-Cartier}.
\end{proof}

\begin{lemma}
\label{lemma-pic-inertia}
Assume $f_{T, *}\mathcal{O}_{X_T} \cong \mathcal{O}_T$ for all
schemes $T$ over $B$. Then the inertia stack of $\Picardstack_{X/B}$
is equal to $\mathbf{G}_m \times \Picardstack_{X/B}$.
\end{lemma}

\begin{proof}
This is explained in Examples of Stacks, Example
\ref{examples-stacks-example-inertia-stack-of-picard}.
\end{proof}






\section{Properties of the Picard functor}
\label{section-picard-functor}

\noindent
Let $f : X \to B$ be a morphism of algebraic spaces which is flat,
proper, and of finite presentation such that moreover for every $T/B$
the canonical map
$$
\mathcal{O}_T \longrightarrow f_{T, *}\mathcal{O}_{X_T}
$$
is an isomorphism. Then the Picard functor $\Picardfunctor_{X/B}$ is an
algebraic space, see Quot, Proposition \ref{quot-proposition-pic-functor}.
There is a closed relationship with the Picard stack.

\begin{lemma}
\label{lemma-pic-gerbe-over-pic-functor}
The morphism $\Picardstack_{X/B} \to \Picardfunctor_{X/B}$
turns the Picard stack into a gerbe over the Picard functor.
\end{lemma}

\begin{proof}
The definition of $\Picardstack_{X/B} \to \Picardfunctor_{X/B}$ being
a gerbe is given in Morphisms of Stacks, Definition
\ref{stacks-morphisms-definition-gerbe}, which in turn refers to
Stacks, Definition \ref{stacks-definition-gerbe-over-stack-in-groupoids}.
To prove it, we will check conditions (2)(a) and (2)(b) of
Stacks, Lemma \ref{stacks-lemma-when-gerbe}. This follows immediately from
Quot, Lemma \ref{quot-lemma-pic-over-pic}; here is a detailed explanation.

\medskip\noindent
Condition (2)(a).
Suppose that $\xi \in \Picardfunctor_{X/B}(U)$ for some scheme $U$ over $B$.
Since $\Picardfunctor_{X/B}$ is the fppf sheafification of the rule
$T \mapsto \Pic(X_T)$ on schemes over $B$
(Quot, Situation \ref{quot-situation-pic}), we see that there exists an
fppf covering $\{U_i \to U\}$ such that $\xi|_{U_i}$ corresponds
to some invertible module $\mathcal{L}_i$ on $X_{U_i}$.
Then $(U_i \to B, \mathcal{L}_i)$ is an object of
$\Picardstack_{X/B}$ over $U_i$ mapping to $\xi|_{U_i}$.

\medskip\noindent
Condition (2)(b). Suppose that $U$ is a scheme over $B$ and
$\mathcal{L}, \mathcal{N}$ are invertible modules on $X_U$
which map to the same element of $\Picardfunctor_{X/B}(U)$.
Then there exists an fppf covering $\{U_i \to U\}$
such that $\mathcal{L}|_{X_{U_i}}$ is isomorphic to $\mathcal{N}|_{X_{U_i}}$.
Thus we find isomorphisms between
$(U \to B, \mathcal{L})|_{U_i} \to (U \to B, \mathcal{N})|_{U_i}$
as desired.
\end{proof}

\begin{lemma}
\label{lemma-pic-functor-diagonal-qc-immersion}
The diagonal of $\Picardfunctor_{X/B}$ over $B$ is a quasi-compact immersion.
\end{lemma}

\begin{proof}
The diagonal is an immersion by Quot, Lemma \ref{quot-lemma-diagonal-pic}.
To show that the diagonal is quasi-compact, it suffices to show that
$$
T \times_{\Picardfunctor_{X/B} \times_B \Picardfunctor_{X/B}}
\Picardfunctor_{X/B}
$$
is quasi-compact for any affine scheme $T$ and pair of maps
$a_1, a_2 : T \to \Picardfunctor_{X/B}$, see
Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-quasi-compact-local}.
Now fppf locally on $T$ these morphisms are given by objects
$\xi_1, \xi_2$ of $\Picardstack_{X/B}$ over $T$,
see Lemma \ref{lemma-pic-gerbe-over-pic-functor}.
Thus we reduce to this case (small detail omitted).
Then there is a surjection
$$
T \times_{\Picardstack_{X/B} \times_B \Picardstack_{X/B}}
\Picardstack_{X/B}
\longrightarrow
T \times_{\Picardfunctor_{X/B} \times_B \Picardfunctor_{X/B}}
\Picardfunctor_{X/B}
$$
by Morphisms of Stacks, Lemma \ref{stacks-morphisms-lemma-gerbe-isom-fppf}.
Since the diagonal of $\Picardstack_{X/B}$ is quasi-compact
by Lemma \ref{lemma-pic-diagonal-affine-fp}
we win.
\end{proof}

\begin{lemma}
\label{lemma-pic-functor-qs-lfp}
The morphism $\Picardfunctor_{X/B} \to B$ is quasi-separated and
locally of finite presentation.
\end{lemma}

\begin{proof}
To check $\Picardfunctor_{X/B} \to B$ is quasi-separated we have to
show that its diagonal is quasi-compact. This is immediate from
Lemma \ref{lemma-pic-functor-diagonal-qc-immersion}.
Since the morphism $\Picardstack_{X/B} \to \Picardfunctor_{X/B}$
is surjective, flat, and locally of finite presentation
(by Lemma \ref{lemma-pic-gerbe-over-pic-functor} and
Morphisms of Stacks, Lemma \ref{stacks-morphisms-lemma-gerbe-fppf})
it suffices to prove that $\Picardstack_{X/B} \to B$
is locally of finite presentation, see
Morphisms of Stacks, Lemma
\ref{stacks-morphisms-lemma-flat-finite-presentation-permanence}.
This follows
from Lemma \ref{lemma-pic-qs-lfp}.
\end{proof}

\begin{lemma}
\label{lemma-pic-functor-uniqueness-part}
Assume the geometric fibres of $X \to B$ are integral
in addition to the other assumptions in this section.
Then $\Picardfunctor_{X/B} \to B$ is separated.
\end{lemma}

\begin{proof}
Since $\Picardfunctor_{X/B} \to B$ is quasi-separated, it suffices
to check the uniqueness part of the valuative criterion, see
Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-valuative-criterion-separatedness}.
This immediately reduces to the following problem: given
\begin{enumerate}
\item a valuation ring $R$ with fraction field $K$,
\item an algebraic space $X$ proper and flat over $R$
with integral geometric fibre,
\item an element $a \in \Picardfunctor_{X/R}(R)$ with
$a|_{\Spec(K)} = 0$,
\end{enumerate}
then we have to prove $a = 0$. Applying
Morphisms of Stacks, Lemma
\ref{stacks-morphisms-lemma-lift-valuation-ring-through-flat-morphism}
to the surjective flat morphism
$\Picardstack_{X/R} \to \Picardfunctor_{X/R}$
(surjective and flat by Lemma \ref{lemma-pic-gerbe-over-pic-functor} and
Morphisms of Stacks, Lemma \ref{stacks-morphisms-lemma-gerbe-fppf})
after replacing $R$ by an extension we may assume
$a$ is given by an invertible $\mathcal{O}_X$-module
$\mathcal{L}$. Since $a|_{\Spec(K)} = 0$ we find
$\mathcal{L}_K \cong \mathcal{O}_{X_K}$ by
Quot, Lemma \ref{quot-lemma-flat-geometrically-connected-fibres}.

\medskip\noindent
Denote $f : X \to \Spec(R)$ the structure morphism.
Let $\eta, 0 \in \Spec(R)$ be the generic and closed point.
Consider the perfect complexes
$K = Rf_*\mathcal{L}$ and $M = Rf_*(\mathcal{L}^{\otimes -1})$
on $\Spec(R)$, see Derived Categories of Spaces, Lemma
\ref{spaces-perfect-lemma-flat-proper-perfect-direct-image-general}.
Consider the functions
$\beta_{K, i}, \beta_{M, i} : \Spec(R) \to \mathbf{Z}$
of Derived Categories of Spaces, Lemma
\ref{spaces-perfect-lemma-jump-loci} associated to $K$ and $M$.
Since the formation of $K$ amd $M$ commutes with
base change (see lemma cited above) we find
$\beta_{K, 0}(\eta) = \beta_{M, 0}(\beta) = 1$ by
Spaces over Fields, Lemma
\ref{spaces-over-fields-lemma-proper-geometrically-reduced-global-sections}
and our assumption on the fibres of $f$.
By upper semi-continuity we find
$\beta_{K, 0}(0) \geq 1$ and $\beta_{M, 0} \geq 1$.
By 
Spaces over Fields, Lemma
\ref{spaces-over-fields-lemma-characterize-trivial-pic-integral}
we conclude that the restriction of $\mathcal{L}$
to the special fibre $X_0$ is trivial. In turn this gives
$\beta_{K, 0}(0) = \beta_{M, 0} = 1$ as above.
Then by More on Algebra, Lemma
\ref{more-algebra-lemma-lift-pseudo-coherent-from-residue-field}
we can represent $K$ by a complex of the form
$$
\ldots \to 0 \to R \to R^{\oplus \beta_{K, 1}(0)} \to
R^{\oplus \beta_{K, 2}(0)} \to \ldots
$$
Now $R \to R^{\oplus \beta_{K, 1}(0)}$ is zero
because $\beta_{K, 0}(\eta) = 1$. In other words
$K = R \oplus \tau_{\geq 1}(K)$ in $D(R)$ where $\tau_{\geq 1}(K)$
has tor amplitude in $[1, b]$ for some $b \in \mathbf{Z}$.
Hence there is a global section $s \in H^0(X, \mathcal{L})$
whose restriction $s_0$
to $X_0$ is nonvanishing (again because formation of $K$
commutes with base change). Then $s : \mathcal{O}_X \to \mathcal{L}$
is a map of invertible sheaves whose restriction to $X_0$
is an isomorphism and hence is an isomorphism as desired.
\end{proof}











\input{chapters}

\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}
