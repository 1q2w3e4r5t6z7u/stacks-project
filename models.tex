\input{preamble}

% OK, start here.
%
\begin{document}

\title{Semistable Reduction}


\maketitle

\phantomsection
\label{section-phantom}

\tableofcontents

\section{Introduction}
\label{section-introduction}

\noindent
In this chapter we prove the semistable reduction theorem for curves.
We will use the method of Artin and Winters from their paper
\cite{Artin-Winters}.

\medskip\noindent
It turns out that one can prove the semistable reduction theorem
for curves without any results on desingularization. Namely, there
is a way to esthablish the existence and projectivity of moduli
of semistable curves using Geometric Invariant Theory (GIT)
as developped by Mumford, see \cite{GIT}. This method was
championed by Gieseker who proved the full result in his
lecture notes \cite{Gieseker}. This is quite an amazing
feat: it seems somewhat counter intuitive that one can
prove such a result without ever truly studying families curves over
a positive dimensional base.

\medskip\noindent
Historically the first proof of the semistable reduction theorem
for curves can be found in the paper \cite{DM} by Deligne and Mumford.
It proves the theorem by reducing the problem to the case of
Abelian varieties which was already known at the time thanks
to Grothendieck and others, see \cite{SGA7-I} and \cite{SGA7-II}).
In hindsight the semistable reduction theorem for abelian varieties seems
a lot harder, {\it especially} if one is to prove it without access
to the semistable reduction theorem for curves.

\medskip\noindent
The method in the paper by Artin and Winters consists in analyzing the
possibilities for the special fibre and concluding using an inequality
for torsion in the Picard group of a $1$-dimensional scheme over a field.
A similar argument can be found in a paper \cite{Saito} of Saito who uses
\'etale cohomology directly and who obtains a stronger result in that
he can characterize semistable reduction in terms of the action of
the inertia on $\ell$-adic \'etale cohomology.

\medskip\noindent
A different approach one can use to prove the theorem is to use
rigid analytic geometry techniques. Here we refer the reader to
\cite{vanderPut} and \cite{Arzdorf-Wewers}.

\medskip\noindent
The paper \cite{Temkin} by Temkin uses valuation theoretic techniques
(and proves a lot more besides); also Appendix A of this paper gives
a nice overview of the different proofs and the relationship with
desingularizations of $2$ dimensional schemes.

\medskip\noindent
Another overview paper that the reader may wish to consult is
\cite{Abbes-ssr} written by Ahmed Abbes.






\section{Linear algebra}
\label{section-linear-algebra}

\noindent
A couple of lemmas we will use later on.

\begin{lemma}
\label{lemma-recurring}
\begin{reference}
\cite[Theorem I]{Taussky}
\end{reference}
Let $A = (a_{ij})$ be a complex $n \times n$ matrix.
\begin{enumerate}
\item If $|a_{ii}| > \sum_{j \not = i} |a_{ij}|$ for each $i$, then
$\det(A)$ is nonzero.
\item If there exists a real vector $m = (m_1, \ldots, m_n)$
with $m_i > 0$ such that $|a_{ii} m_i| > \sum_{j \not = i} |a_{ij}m_j|$
for each $i$, then $\det(A)$ is nonzero.
\end{enumerate}
\end{lemma}

\begin{proof}
If $A$ is as in (1) and $\det(A) = 0$, then there is a nonzero vector
$z$ with $Az = 0$. Choose $r$ with $|z_r|$ maximal. Then
$$
|a_{rr} z_r| = |\sum\nolimits_{k \not = r} a_{rk}z_k| \leq
\sum\nolimits_{k \not = r} |a_{rk}||z_k| \leq
|z_r| \sum\nolimits_{k \not = r} |a_{rk}| < |a_{rr}||z_r|
$$
which is a contradiction. To prove (2) apply (1) to the matrix
$(a_{ij}m_j)$ whose determinant is $m_1 \ldots m_n \det(A)$.
\end{proof}

\begin{lemma}
\label{lemma-recurring-real}
Let $A = (a_{ij})$ be a real $n \times n$ matrix with
$a_{ij} \geq 0$ for $i \not = j$. Let $m = (m_1, \ldots, m_n)$ be a real
vector with $m_i > 0$. For $I \subset \{1, \ldots, n\}$ let
$x_I \in \mathbf{R}^n$
be the vector whose $i$th coordinate is $m_i$ if $i \in I$
and $0$ otherwise. If
\begin{equation}
\label{equation-ineq}
-a_{ii}m_i \geq \sum\nolimits_{j \not = i} a_{ij}m_j
\end{equation}
for each $i$, then $\Ker(A)$ is the vector space
spanned by the vectors $x_I$ such that
\begin{enumerate}
\item $a_{ij} = 0$ for $i \in I$, $j \not \in I$, and
\item equality holds in (\ref{equation-ineq}) for $i \in I$.
\end{enumerate}
\end{lemma}

\begin{proof}
After replacing $a_{ij}$ by $a_{ij}m_j$ we may assume $m_i = 1$ for all $i$.
If $I \subset \{1, \ldots, n\}$ such that (1) and (2) are true,
then a simple computation shows that $x_I$ is in the kernel of $A$.
Conversely, let $x = (x_1, \ldots, x_n) \in \mathbf{R}^n$ be a
nonzero vector in the kernel of $A$. We will show by induction
on the number of nonzero coordinates of $x$ that $x$ is in the
span of the vectors $x_I$ satisfying (1) and (2). Let
$I \subset \{1, \ldots, n\}$ be the set of indices $r$ with $|x_r|$ maximal.
For $r \in I$ we have
$$
|a_{rr} x_r| = |\sum\nolimits_{k \not = r} a_{rk}x_k| \leq
\sum\nolimits_{k \not = r} a_{rk}|x_k| \leq
|x_r| \sum\nolimits_{k \not = r} a_{rk} \leq |a_{rr}||x_r|
$$
Thus equality holds everywhere. In particular, we see that
$a_{rk} = 0$ if $r \in I$, $k \not \in I$ and equality holds
in (\ref{equation-ineq}) for $r \in I$. Then we see that we
can substract a suitable multiple of $x_I$ from $x$ to decrease
the number of nonzero coordinates.
\end{proof}

\begin{lemma}
\label{lemma-recurring-symmetric-real}
Let $A = (a_{ij})$ be a symmetric real $n \times n$ matrix with
$a_{ij} \geq 0$ for $i \not = j$.
Let $m = (m_1, \ldots, m_n)$ be a real vector with $m_i > 0$.
Assume
\begin{enumerate}
\item $Am = 0$,
\item there is no proper nonempty subset $I \subset \{1, \ldots, n\}$
such that $a_{ij} = 0$ for $i \in I$ and $j \not \in I$.
\end{enumerate}
Then $x^t A x \leq 0$ with equality if and only if $x = qm$
for some $q \in \mathbf{R}$.
\end{lemma}

\begin{proof}[First proof]
After replacing $a_{ij}$ by $a_{ij}m_im_j$ we may assume $m_i = 1$
for all $i$. Condition (1) means $-a_{ii} = \sum_{j \not = i} a_{ij}$
for all $i$. Recall that $x^tAx = \sum_{i, j} x_ia_{ij}x_j$.
Then
\begin{align*}
\sum\nolimits_{i \not = j} -a_{ij}(x_j - x_i)^2 & =
\sum\nolimits_{i \not = j} -a_{ij}x_j^2 + 2a_{ij}x_ix_i - a_{ij}x_i^2 \\
& =
\sum\nolimits_j a_{jj} x_j^2 +
\sum\nolimits_{i \not = j} 2a_{ij}x_ix_i +
\sum\nolimits_j a_{jj} x_i^2 \\
& = 2x^tAx
\end{align*}
This is clearly $\leq 0$. If equality holds, then let $I$ be the set
of indices $i$ with $x_i \not = x_1$. Then $a_{ij} = 0$ for $i \in I$
and $j \not \in I$. Thus $I = \{1, \ldots, n\}$ by condition (2) and
$x$ is a multiple of $m = (1, \ldots, 1)$.
\end{proof}

\begin{proof}[Second proof]
The matrix $A$ has real eigenvalues by the spectral theorem.
We claim all the eigenvalues are $\leq 0$.
Namely, since property (1) means
$-a_{ii}m_i = \sum_{j \not = i} a_{ij}m_j$ for all $i$,
we find that the matrix $A' = A - \lambda I$ for $\lambda > 0$
satisfies $|a'_{ii}m_i| > \sum a'_{ij}m_j = \sum |a'_{ij}m_j|$ for all $i$.
Hence $A'$ is invertible by Lemma \ref{lemma-recurring}.
This implies that the symmetric bilinear form $x^tAy$
is semi-negative definite, i.e., $x^tAx \leq 0$ for all $x$.
It follows that the kernel of $A$ is equal
to the set of vectors $x$ with $x^tAx = 0$.
The description of the kernel in Lemma \ref{lemma-recurring-real}
gives the final statement of the lemma.
\end{proof}






\section{Numerical types}
\label{section-numerical-types}

\noindent
Part of the arguments will involve the combinatorics of the following
data structures.

\begin{definition}
\label{definition-type}
A {\it numerical type of genus $g$} is given by
$$
n, m_i, a_{ij}, w_i, g_i
$$
where $n \geq 1$ is an integer and $m_i$, $a_{ij}$, $w_i$, $g_i$
are integers for $1 \leq i, j \leq n$ subject to the following conditions
\begin{enumerate}
\item $m_i > 0$, $w_i > 0$, $g_i \geq 0$,
\item the matrix $A = (a_{ij})$ is symmetric and $a_{ij} \geq 0$
for $j \not = i$,
\item there is no proper nonempty subset $I \subset \{1, \ldots, n\}$
such that $a_{ij} = 0$ for $i \in I$, $j \not \in I$,
\item for each $i$ we have $\sum_j a_{ij}m_j = 0$,
\item $w_i | a_{ij}$, and
\item $g = 1 + \sum m_i(w_i(g_i - 1) - \frac{1}{2} a_{ii})$.
\end{enumerate}
\end{definition}

\noindent
This is obviously a somewhat annoying type of structure to work with,
but it is exactly what shows up in special fibres of proper regular
models of smooth geometrically connected curves of genus $g$.
Of course we only care about these types up to reordering the indices.

\begin{definition}
\label{definition-type-equivalent}
We say two numerical types $n, m_i, a_{ij}, w_i, g_i$ and
$n', m'_i, a'_{ij}, w'_i, g'_i$ are {\it equivalent types} if
there exists a permutation $\sigma$ of $\{1, \ldots, n\}$
such that $m_i = m'_{\sigma(i)}$, $a_{ij} = a'_{\sigma(i)\sigma(j)}$,
$w_i = w'_{\sigma(i)}$, and $g_i = g'_{\sigma(i)}$.
\end{definition}

\noindent
Let $n, m_i, a_{ij}, w_i, g_i$ be a numerical type of genus $g$.
The first observation we make is that
\begin{equation}
\label{equation-irreducible}
n = 1 \Rightarrow
\left(a_{11} = 0\text{ and }g = 1 + m_1w_1(g_1 - 1)\right)
\end{equation}
If $g = 0$, then this implies $m_1 = 1$, $w_1 = 1$, $g_1 = 0$;
this is case (1) of Lemma \ref{lemma-genus-zero}.
If $g = 1$, then we conclude $g_1 = 1$ but $m_1, w_1$ can be arbitrary
positive integers; this is case
(\ref{item-one}) of Lemma \ref{lemma-genus-one}.
If $g > 1$, then this implies there are finitely many possible
numerical types of genus $g$ with $n = 1$.

\medskip\noindent
From now on assume $n > 1$. Note that
Lemma \ref{lemma-recurring-symmetric-real}
applies to the matrix $A$. Hence we see that
\begin{equation}
\label{equation-diagonal-negative}
a_{ii} < 0.
\end{equation}
From (\ref{equation-diagonal-negative}) and $w_i > 0$, $g_i \geq 0$,
and $w_i | a_{ii}$ it follows that
\begin{equation}
\label{equation-minus-one}
w_i(g_i - 1) - \frac{1}{2} a_{ii} < 0 \Rightarrow
\left(g_i = 0 \text{ and } a_{ii} = -w_i\right).
\end{equation}
In other words, if there is no index $i$ with $g_i = 0$ and
$a_{ii} = -w_i$, then the contributions
$m_i(w_i(g_i - 1) - \frac{1}{2} a_{ii})$
to the genus $g$ are all $\geq 0$.
This suggests the following definition.

\begin{definition}
\label{definition-type-minimal}
We say the numerical type $n, m_i, a_{ij}, w_i, g_i$ of genus $g$
is {\it minimal} if there does not exist an $i$
with $g_i = 0$ and $a_{ii} = -w_i$.
\end{definition}

\noindent
Thus we can reformulate our discovery above as follows:
If our numerical type is minimal, then the contributions
$m_i(w_i(g_i - 1) - \frac{1}{2} a_{ii})$
to the genus $g$ are all $\geq 0$.
In particular any minimal numerical type of genus $0$
has $n = 1$; this proves Lemma \ref{lemma-genus-zero}.
Using the same argument as above we see that
\begin{equation}
\label{equation-minus-two}
w_i(g_i - 1) - \frac{1}{2} a_{ii} = 0
\Rightarrow
\left(g_i = 0 \text{ and } a_{ii} = -2w_i\right).
\end{equation}
It turns out that the indices satisfying this relation
play an important role in the structure of minimal numerical types.
Hence we give them a name.

\begin{definition}
\label{definition-type-minus-two}
Let $n, m_i, a_{ij}, w_i, g_i$ be a numerical type of genus $g$.
We say $i$ is a {\it $(-2)$-index} if $g_i = 0$ and $a_{ii} = -2w_i$.
\end{definition}

\noindent
Thus in a minimal numerical type of genus $g$, the $(-2)$-indices
are exactly the indices which do not contribute a postive number
to the genus in the formula
$$
g = 1 + \sum m_i(w_i(g_i - 1) - \frac{1}{2} a_{ii})
$$
Thus it will be somewhat tricky to bound the quantities associated
with $(-2)$-indices as we will see later.




\section{Classification of proper subgraphs}
\label{section-classify-proper-subgraphs}

\noindent
In this section we assume given a numerical type
$n, m_i, a_{ij}, w_i, g_i$ of genus $g$. We will find
a complete list of possible ``subgraphs'' consisting entirely
of $(-2)$-indices (as defined in the previous section).
At the same time we classify all possible minimal numerical
types of genus $1$.

\medskip\noindent
Suppose that $i$ and $j$ are $(-2)$-indices with $a_{ij} > 0$.
Since the matrix $A = (a_{ij})$ is semi-negative definite by
Lemma \ref{lemma-recurring-symmetric-real} we see that the matrix
$$
\left(
\begin{matrix}
-2w_i & a_{ij} \\
a_{ij} & -2w_j
\end{matrix}
\right)
$$
is negative definite unless $n = 2$. The case $n = 2$ can happen: then
the determinant $4w_1w_2 - a_{12}^2$ is zero. Using that
$\text{lcm}(w_1, w_2)$ divides $a_{12}$ the reader easily finds
that the only possibilities are
$$
(w_1, w_2, a_{12}) = (w, w, 2w), (w, 4w, 4w), \text{ or }(4w, w, 4w)
$$
Observe that the case $(4w, w, 4w)$ is obtained from the case
$(w, 4w, 4w)$ by switching the indices $i, j$.
In these cases $g = 1$. This leads to cases
(\ref{item-two-cycle}) and (\ref{item-up4}) of Lemma \ref{lemma-genus-one}.
Assuming $n > 2$ we see
that the determinant $4w_iw_j - a_{ij}^2$ of the displayed matrix
is $> 0$ and we conclude that $a_{ij}^2/w_iw_j < 4$.
On the other hand, we know that $\text{lcm}(w_i, w_j) | a_{ij}$
and hence $a_{ij}^2/w_iw_j$ is an integer.
Thus $a_{ij}^2/w_iw_j \in \{1, 2, 3\}$ and $w_i | w_j$ or
vice versa. This leads to the following possibilites
$$
(w_1, w_2, a_{12}) = (w, w, w), (w, 2w, 2w), (w, 3w, 3w),
(2w, w, 2w), \text{ or }(3w, w, 3w)
$$
Observe that the case $(2w, w, 2w)$ is obtained from the case
$(w, 2w, 2w)$ by switching the indices $i, j$ and similarly
for the cases $(3w, w, 3w)$ and $(w, 3w, 3w)$. The first three
solutions lead to cases (\ref{item-A2}), (\ref{item-B2}), and
(\ref{item-G2}) of Lemma \ref{lemma-two-by-two}. In this lemma
we wrote out the consequences for the integers $m_i$ and $m_j$
using that $\sum_l a_{kl}m_l = 0$ for each $k$ in particular implies
$a_{ii}m_i + a_{ij}m_j \leq 0$ for $k = i$ and
$a_{ij}m_i + a_{jj}m_j \leq 0$ for $k = j$.

\begin{lemma}
\label{lemma-two-by-two}
Classification of proper subgraphs of the form
$$
\xymatrix{
\bullet \ar@{-}[r] & \bullet
}
$$
If $n > 2$, then given a pair $i, j$ of $(-2)$-indices with $a_{ij} > 0$,
then up to ordering we have the $m$'s, $a$'s, $w$'s
\begin{enumerate}
\item
\label{item-A2}
are given by
$$
\left(
\begin{matrix}
m_1 \\
m_2
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
-2w & w \\
w & -2w
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
w \\
w
\end{matrix}
\right)
$$
with $w$ arbitrary and $2m_1 \geq m_2$ and $2m_2 \geq m_1$, or
\item
\label{item-B2}
are given by
$$
\left(
\begin{matrix}
m_1 \\
m_2
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
-2w & 2w \\
2w & -4w
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
w \\
2w
\end{matrix}
\right)
$$
with $w$ arbitrary and $m_1 \geq m_2$ and $2m_2 \geq m_1$, or
\item
\label{item-G2}
are given by
$$
\left(
\begin{matrix}
m_1 \\
m_2
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
-2w & 3w \\
3w & -6w
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
w \\
3w
\end{matrix}
\right)
$$
with $w$ arbitrary and $2m_1 \geq 3m_2$ and $2m_2 \geq m_1$.
\end{enumerate}
\end{lemma}

\begin{proof}
See discussion above.
\end{proof}

\noindent
Suppose that $i$, $j$, and $k$ are three $(-2)$-indices with $a_{ij} > 0$
and $a_{jk} > 0$.  In other words, the index $i$ ``meets'' $j$ and
$j$ ``meets'' $k$. We will use without further mention that each pair
$(i, j)$, $(i, k)$, and $(j, k)$ is as listed in Lemma \ref{lemma-two-by-two}.
Since the matrix $A = (a_{ij})$ is semi-negative
definite by Lemma \ref{lemma-recurring-symmetric-real} we see that the matrix
$$
\left(
\begin{matrix}
-2w_i & a_{ij} & a_{ik} \\
a_{ij} & -2w_j & a_{jk} \\
a_{ik} & a_{jk} & -2w_k
\end{matrix}
\right)
$$
is negative definite unless $n = 3$. The case $n = 3$ can happen:
then the determinant\footnote{It is
$-8w_iw_jw_k + 2a_{ij}^2w_k + 2a_{jk}^2w_i + 2a_{ik}^2w_j +
2a_{ij}a_{jk}a_{ik}$.} of the matrix is zero
and we obtain the equation
$$
4 = \frac{a_{ij}^2}{w_iw_j} +
\frac{a_{jk}^2}{w_jw_k} +
\frac{a_{ik}^2}{w_iw_k} +
\frac{a_{ij}a_{ik}a_{jk}}{w_iw_jw_k}
$$
of integers. The last term on the right in this equation is determined
by the others because
$$
\left(\frac{a_{ij}a_{ik}a_{jk}}{w_iw_jw_k}\right)^2 =
\frac{a_{ij}^2}{w_iw_j} \frac{a_{jk}^2}{w_jw_k} \frac{a_{ik}^2}{w_iw_k}
$$
Since we have seen above that
$\frac{a_{ij}^2}{w_iw_j}, \frac{a_{jk}^2}{w_jw_k}$ are in
$\{1, 2, 3\}$ and $\frac{a_{ik}^2}{w_iw_k}$ in $\{0, 1, 2, 3\}$,
we conclude that the only possibilities are
$$
(\frac{a_{ij}^2}{w_iw_j}, \frac{a_{jk}^2}{w_jw_k}, \frac{a_{ik}^2}{w_iw_k}) =
(1, 1, 1), (1, 3, 0), (2, 2, 0),\text{ or } (3, 1, 0)
$$
Observe that the case $(3, 1, 0)$ is obtained from the case $(1, 3, 0)$
by reversing the order the indices $i, j, k$.
In each of these cases $g = 1$; the reader can find these as cases
(\ref{item-three-cycle}), (\ref{item-equal-up3}), (\ref{item-equal-down3}),
(\ref{item-up-up}), (\ref{item-up-down}), (\ref{item-down-up}) of
Lemma \ref{lemma-genus-one}
with one case corresponding to $(1, 1, 1)$,
two cases corresponding to $(1, 3, 0)$, and
three cases corresponding to $(2, 2, 0)$.
Assuming $n > 3$
we obtain the inequality
$$
4 > \frac{a_{ij}^2}{w_iw_j} + \frac{a_{ik}^2}{w_iw_k} +
\frac{a_{jk}^2}{w_jw_k} + \frac{a_{ij}a_{ik}a_{jk}}{w_iw_jw_k}
$$
of integers. Using the restrictions on the numbers given above
we see that the only possibilities are
$$
(\frac{a_{ij}^2}{w_iw_j}, \frac{a_{jk}^2}{w_jw_k}, \frac{a_{ik}^2}{w_iw_k}) =
(1, 1, 0), (1, 2, 0),\text{ or }(2, 1, 0)
$$
in particular $a_{ik} = 0$ (recall we are assuming
$a_{ij} > 0$ and $a_{jk} > 0$). Observe that the case
$(2, 1, 0)$ is obtained from the case $(1, 2, 0)$ by reversing
the ordering of the indices $i, j, k$. The first two solutions lead
to cases (\ref{item-A3}), (\ref{item-C3}), and (\ref{item-B3})
of Lemma \ref{lemma-three-by-three} where we also wrote out the consequences
for the integers $m_i$, $m_j$, and $m_k$.

\begin{lemma}
\label{lemma-three-by-three}
Classification of proper subgraphs of the form
$$
\xymatrix{
\bullet \ar@{-}[r] &
\bullet \ar@{-}[r] &
\bullet
}
$$
If $n > 3$, then given a triple $i, j, k$ of $(-2)$-indices
with at least two $a_{ij}, a_{ik}, a_{jk}$ nonzero, then up
to ordering we have the $m$'s, $a$'s, $w$'s
\begin{enumerate}
\item
\label{item-A3}
are given by
$$
\left(
\begin{matrix}
m_1 \\
m_2 \\
m_3
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
-2w & w & 0 \\
w & -2w & w \\
0 & w & -2w
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
w \\
w \\
w
\end{matrix}
\right)
$$
with $2m_1 \geq m_2$, $2m_2 \geq m_1 + m_3$, $2m_3 \geq m_2$, or
\item
\label{item-C3}
are given by
$$
\left(
\begin{matrix}
m_1 \\
m_2 \\
m_3
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
-2w & w & 0 \\
w & -2w & 2w \\
0 & 2w & -4w
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
w \\
w \\
2w
\end{matrix}
\right)
$$
with $2m_1 \geq m_2$, $2m_2 \geq m_1 + 2m_3$, $2m_3 \geq m_2$, or
\item
\label{item-B3}
are given by
$$
\left(
\begin{matrix}
m_1 \\
m_2 \\
m_3
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
-4w & 2w & 0 \\
2w & -4w & 2w \\
0 & 2w & -2w
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
2w \\
2w \\
w
\end{matrix}
\right)
$$
with $2m_1 \geq m_2$, $2m_2 \geq m_1 + m_3$, $m_3 \geq m_2$.
\end{enumerate}
\end{lemma}

\begin{proof}
See discussion above.
\end{proof}

\noindent
Suppose that $i$, $j$, $k$, and $l$ are four $(-2)$-indices with
$a_{ij} > 0$, $a_{jk} > 0$, and $a_{kl} > 0$. In other words, the
index $i$ ``meets'' $j$, $j$ ``meets'' $k$, and $k$ ``meets'' $l$.
Then we see from Lemma \ref{lemma-three-by-three} that $a_{ik} = a_{jl} = 0$.
Since the matrix $A = (a_{ij})$ is semi-negative definite we see that the
matrix
$$
\left(
\begin{matrix}
-2w_i & a_{ij} & 0 & a_{il} \\
a_{ij} & -2w_j & a_{jk} & 0 \\
0 & a_{jk} & -2w_k & a_{kl} \\
a_{il} & 0 & a_{kl} & -2w_l
\end{matrix}
\right)
$$
is negative definite unless $n = 4$. The case $n = 4$ can happen:
then the determinant\footnote{It is
$16w_iw_jw_kw_l - 4a_{ij}^2w_kw_l - 4a_{jk}^2w_iw_l - 4a_{kl}^2w_iw_j -
4a_{il}^2w_jw_k + a_{ij}^2a_{kl}^2 + a_{jk}^2a_{il}^2 -
2a_{ij}a_{il}a_{jk}a_{kl}$.} of the matrix is zero and we obtain the equation
$$
16 +
\frac{a_{ij}^2}{w_iw_j}\frac{a_{kl}^2}{w_kw_l} +
\frac{a_{jk}^2}{w_jw_k}\frac{a_{il}^2}{w_iw_l} =
4\frac{a_{ij}^2}{w_iw_j} + 4\frac{a_{jk}^2}{w_jw_k} + 4\frac{a_{kl}^2}{w_kw_l}
+ 4\frac{a_{il}^2}{w_iw_l} + 2\frac{a_{ij}a_{il}a_{jk}a_{kl}}{w_iw_jw_kw_l}
$$
of nonnegative integers. The last term on the right in this equation is
determined by the others because
$$
\left(\frac{a_{ij}a_{il}a_{jk}a_{kl}}{w_iw_jw_kw_l}\right)^2 =
\frac{a_{ij}^2}{w_iw_j} \frac{a_{jk}^2}{w_jw_k}
\frac{a_{kl}^2}{w_kw_l} \frac{a_{il}^2}{w_iw_l}
$$
Since we have seen above that
$\frac{a_{ij}^2}{w_iw_j}, \frac{a_{jk}^2}{w_jw_k}, \frac{a_{kl}^2}{w_kw_l}$
are in $\{1, 2\}$ and $\frac{a_{il}^2}{w_iw_l}$ in $\{0, 1, 2\}$,
we conclude that the only possible solutions are
$$
(\frac{a_{ij}^2}{w_iw_j}, \frac{a_{jk}^2}{w_jw_k}, \frac{a_{kl}^2}{w_kw_l},
\frac{a_{il}^2}{w_iw_l}) =
(1, 1, 1, 1) \text{ or } (2, 1, 2, 0)
$$
and case $g = 1$; the reader can find these as cases
(\ref{item-four-cycle}), (\ref{item-up-equal-up}),
(\ref{item-up-equal-down}), and (\ref{item-down-equal-up})
of Lemma \ref{lemma-genus-one}. Assuming $n > 4$
we obtain the inequality
$$
16 +
\frac{a_{ij}^2}{w_iw_j}\frac{a_{kl}^2}{w_kw_l} +
\frac{a_{jk}^2}{w_jw_k}\frac{a_{il}^2}{w_iw_l} >
4\frac{a_{ij}^2}{w_iw_j} + 4\frac{a_{jk}^2}{w_jw_k} + 4\frac{a_{kl}^2}{w_kw_l}
+ 4\frac{a_{il}^2}{w_iw_l} + 2\frac{a_{ij}a_{il}a_{jk}a_{kl}}{w_iw_jw_kw_l}
$$
of nonnegative integers. Using the restrictions on the numbers given above
we see that the only possibilities are
$$
(\frac{a_{ij}^2}{w_iw_j}, \frac{a_{jk}^2}{w_jw_k}, \frac{a_{kl}^2}{w_kw_l},
\frac{a_{il}^2}{w_iw_l}) =
(1, 1, 1, 0), (1, 1, 2, 0), (1, 2, 1, 0), \text{ or }(2, 1, 1, 0)
$$
in particular $a_{il} = 0$ (recall that we assumed the other three
to be nonzero). Observe that the case $(2, 1, 1, 0)$ is obtained
from the case $(1, 1, 2, 0)$ by reversing the ordering
of the indices $i, j, k, l$. The first three solutions lead
to cases (\ref{item-A4}), (\ref{item-C4}), (\ref{item-B4}), and
(\ref{item-F4}) of Lemma \ref{lemma-four-by-four}
where we also wrote out the consequences for the integers $m_i$, $m_j$, $m_k$,
and $m_l$.

\begin{lemma}
\label{lemma-four-by-four}
Classification of proper subgraphs of the form
$$
\xymatrix{
\bullet \ar@{-}[r] &
\bullet \ar@{-}[r] &
\bullet \ar@{-}[r] &
\bullet
}
$$
If $n > 4$, then given four $(-2)$-indices $i, j, k, l$
with $a_{ij}, a_{jk}, a_{kl}$ nonzero, then up
to ordering we have the $m$'s, $a$'s, $w$'s
\begin{enumerate}
\item
\label{item-A4}
are given by
$$
\left(
\begin{matrix}
m_1 \\
m_2 \\
m_3 \\
m_4
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
-2w & w & 0 & 0 \\
w & -2w & w & 0 \\
0 & w & -2w & w \\
0 & 0 & w & -2w 
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
w \\
w \\
w \\
w
\end{matrix}
\right)
$$
with $2m_1 \geq m_2$, $2m_2 \geq m_1 + m_3$, $2m_3 \geq m_2 + m_4$,
and $2m_4 \geq m_3$, or
\item
\label{item-C4}
are given by
$$
\left(
\begin{matrix}
m_1 \\
m_2 \\
m_3 \\
m_4
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
-2w & w & 0 & 0 \\
w & -2w & w & 0 \\
0 & w & -2w & 2w \\
0 & 0 & 2w & -4w 
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
w \\
w \\
w \\
2w
\end{matrix}
\right)
$$
with $2m_1 \geq m_2$, $2m_2 \geq m_1 + m_3$, $2m_3 \geq m_2 + 2m_4$,
and $2m_4 \geq m_3$, or
\item
\label{item-B4}
are given by
$$
\left(
\begin{matrix}
m_1 \\
m_2 \\
m_3 \\
m_4
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
-4w & 2w & 0 & 0 \\
2w & -4w & 2w & 0 \\
0 & 2w & -4w & 2w \\
0 & 0 & 2w & -2w 
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
2w \\
2w \\
2w \\
w
\end{matrix}
\right)
$$
with $2m_1 \geq m_2$, $2m_2 \geq m_1 + m_3$, $2m_3 \geq m_2 + m_4$,
and $m_4 \geq m_3$, or
\item
\label{item-F4}
are given by
$$
\left(
\begin{matrix}
m_1 \\
m_2 \\
m_3 \\
m_4
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
-2w & w & 0 & 0 \\
w & -2w & 2w & 0 \\
0 & 2w & -4w & 2w \\
0 & 0 & 2w & -4w 
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
w \\
w \\
2w \\
2w
\end{matrix}
\right)
$$
with $2m_1 \geq m_2$, $2m_2 \geq m_1 + 2m_3$, $2m_3 \geq m_2 + m_4$,
and $2m_4 \geq m_3$.
\end{enumerate}
\end{lemma}

\begin{proof}
See discussion above.
\end{proof}

\noindent
Suppose that $i$, $j$, $k$,
and $l$ are four $(-2)$-indices with $a_{ij} > 0$, $a_{ij} > 0$, and
$a_{il} > 0$. In other words, the index $i$ ``meets'' the indices
$j$, $k$, $l$. Then we see from Lemma \ref{lemma-three-by-three} that
$a_{jk} = a_{jl} = a_{kl} = 0$. Since the matrix $A = (a_{ij})$ is
semi-negative definite we see that the matrix
$$
\left(
\begin{matrix}
-2w_i & a_{ij} & a_{ik} & a_{il} \\
a_{ij} & -2w_j & 0 & 0 \\
a_{ik} & 0 & -2w_k & 0 \\
a_{il} & 0 & 0 & -2w_l
\end{matrix}
\right)
$$
is negative definite unless $n = 4$. The case $n = 4$ can happen:
then the determinant\footnote{It is
$16w_iw_jw_kw_l - 4a_{ij}^2w_kw_l - 4a_{ik}^2w_jw_l - 4a_{il}^2w_jw_k$.}
of the matrix is zero and we obtain the equation
$$
4 = \frac{a_{ij}^2}{w_iw_j} + \frac{a_{ik}^2}{w_iw_k} + \frac{a_{il}^2}{w_jw_l}
$$
of nonnegative integers. Since we have seen above that
$\frac{a_{ij}^2}{w_iw_j}, \frac{a_{ik}^2}{w_iw_k}, \frac{a_{il}^2}{w_iw_l}$
are in $\{1, 2\}$, we conclude that the only possibilities
are up to reordering: $4 = 1 + 1 + 2$. In each of these
cases $g = 1$; the reader can find these as cases
(\ref{item-triple-with-up}) and (\ref{item-triple-with-down}) of
Lemma \ref{lemma-genus-one}. Assuming $n > 4$
we obtain the inequality
$$
4 > \frac{a_{ij}^2}{w_iw_j} + \frac{a_{ik}^2}{w_iw_k} + \frac{a_{il}^2}{w_jw_l}
$$
of nonnegative integers. This implies that $\frac{a_{ij}^2}{w_iw_j} =
\frac{a_{ik}^2}{w_iw_k} = \frac{a_{il}^2}{w_jw_l} = 1$
and that $w_i = w_j = w_k = w_l$. This leads to case
(\ref{item-D4}) of Lemma \ref{lemma-D4}
where we also wrote out the consequences for the integers $m_i$, $m_j$, $m_k$,
and $m_l$.

\begin{lemma}
\label{lemma-D4}
Classification of proper subgraphs of the form
$$
\xymatrix{
\bullet \ar@{-}[r] & \bullet \ar@{-}[r] \ar@{-}[d] & \bullet \\
& \bullet
}
$$
If $n > 4$, then given four $(-2)$-indices $i, j, k, l$
with $a_{ij}, a_{ik}, a_{il}$ nonzero, then up
to ordering we have the $m$'s, $a$'s, $w$'s
\begin{enumerate}
\item
\label{item-D4}
are given by
$$
\left(
\begin{matrix}
m_1 \\
m_2 \\
m_3 \\
m_4
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
-2w & w & w & w \\
w & -2w & 0 & 0 \\
w & 0 & -2w & 0 \\
w & 0 & 0 & -2w 
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
w \\
w \\
w \\
w
\end{matrix}
\right)
$$
with $2m_1 \geq m_2 + m_3 + m_4$, $2m_2 \geq m_1$, $2m_3 \geq m_1$,
$2m_4 \geq m_1$. Observe that this implies $m_1 \geq \max(m_2, m_3, m_4)$.
\end{enumerate}
\end{lemma}

\begin{proof}
See discussion above.
\end{proof}

\noindent
Suppose that $h$, $i$, $j$, $k$, and $l$ are five $(-2)$-indices
with $a_{hi} > 0$, $a_{ij} > 0$, $a_{jk} > 0$, and $a_{kl} > 0$.
In other words, the index $h$ ``meets'' $i$, $i$ ``meets'' $j$,
$j$ ``meets'' $k$, and $k$ ``meets'' $l$.
Then we can apply Lemmas \ref{lemma-three-by-three} and
\ref{lemma-four-by-four} to see that
$a_{hj} = a_{hk} = a_{ik} = a_{il} = a_{jl} = 0$
and that the fractions
$\frac{a_{hi}^2}{w_hw_i}, \frac{a_{ij}^2}{w_iw_j}, \frac{a_{jk}^2}{w_jw_k},
\frac{a_{kl}^2}{w_kw_l}$ are in $\{1, 2\}$ and the fraction
$\frac{a_{hl}^2}{w_hw_l} \in \{0, 1, 2\}$.
Since the matrix $A = (a_{ij})$ is semi-negative definite we see that the
matrix
$$
\left(
\begin{matrix}
-2w_h & a_{hi} & 0 & 0 & a_{hl} \\
a_{hi} & -2w_i & a_{ij} & 0 & 0 \\
0 & a_{ij} & -2w_j & a_{jk} & 0 \\
0 & 0 & a_{jk} & -2w_k & a_{kl} \\
a_{hl} & 0 & 0 & a_{kl} & -2w_l
\end{matrix}
\right)
$$
is negative definite unless $n = 5$. The case $n = 5$ can happen:
then the determinant\footnote{It is
$-32w_hw_iw_jw_kw_l +
8a_{hi}^2w_jw_kw_l +
8a_{ij}^2w_hw_kw_l +
8a_{jk}^2w_hw_iw_l +
8a_{kl}^2w_hw_iw_j +
8a_{hl}^2w_iw_jw_k -
2a_{hi}^2a_{jk}^2w_l -
2a_{hi}^2a_{kl}^2w_j -
2a_{ij}^2a_{kl}^2w_h -
2a_{hl}^2a_{ij}^2w_k -
2a_{hl}^2a_{jk}^2w_i +
2a_{hi}a_{ij}a_{jk}a_{kl}a_{hl}
$
.}
of the matrix is zero and we obtain the equation
\begin{align*}
16 + 
\frac{a_{hi}^2}{w_hw_i}\frac{a_{jk}^2}{w_jw_k} +
\frac{a_{hi}^2}{w_hw_i}\frac{a_{kl}^2}{w_kw_l} +
\frac{a_{ij}^2}{w_iw_j}\frac{a_{kl}^2}{w_kw_l} +
\frac{a_{hl}^2}{w_hw_l}\frac{a_{ij}^2}{w_iw_j} +
\frac{a_{hl}^2}{w_hw_l}\frac{a_{jk}^2}{w_jw_k} \\
= 4\frac{a_{hi}^2}{w_hw_i} +
4\frac{a_{ij}^2}{w_iw_j} +
4\frac{a_{jk}^2}{w_jw_k} +
4\frac{a_{kl}^2}{w_kw_l} +
4\frac{a_{hl}^2}{w_hw_l} +
\frac{a_{hi}a_{ij}a_{jk}a_{kl}a_{hl}}{w_hw_iw_jw_kw_l}
\end{align*}
of nonnegative integers. The last term on the right in this equation is
determined by the others because
$$
\left(\frac{a_{hi}a_{ij}a_{jk}a_{kl}a_{hl}}{w_hw_iw_jw_kw_l} \right)^2 =
\frac{a_{hi}^2}{w_hw_i} \frac{a_{ij}^2}{w_iw_j}
\frac{a_{jk}^2}{w_jw_k} \frac{a_{kl}^2}{w_kw_l} \frac{a_{hl}^2}{w_hw_l}
$$
We conclude the only possible solutions are
$$
(\frac{a_{hi}^2}{w_hw_i}, \frac{a_{ij}^2}{w_iw_j},
\frac{a_{jk}^2}{w_jw_k}, \frac{a_{kl}^2}{w_kw_l}, \frac{a_{hl}^2}{w_hw_l}) =
(1, 1, 1, 1, 1), (1, 1, 2, 1, 0), (1, 2, 1, 1, 0), \text{ or }(2, 1, 1, 2, 0)
$$
Observe that the case $(1, 2, 1, 1, 0)$ is obtained from the case
$(1, 1, 2, 1, 0)$ by reversing the order of the indices $h, i, j, k, l$.
In these cases $g = 1$; the reader can find these as cases
(\ref{item-five-cycle}),
(\ref{item-equal-equal-up-equal}), (\ref{item-equal-equal-down-equal}),
(\ref{item-up-equal-equal-up}), (\ref{item-up-equal-equal-down}), and
(\ref{item-down-equal-equal-up}) of Lemma \ref{lemma-genus-one}
with one case corresponding to $(1, 1, 1, 1, 1)$,
two cases corresponding to $(1, 1, 2, 1, 0)$, and
three cases corresponding to $(2, 1, 1, 2, 0)$.
Assuming $n > 5$ we obtain the inequality
\begin{align*}
16 + 
\frac{a_{hi}^2}{w_hw_i}\frac{a_{jk}^2}{w_jw_k} +
\frac{a_{hi}^2}{w_hw_i}\frac{a_{kl}^2}{w_kw_l} +
\frac{a_{ij}^2}{w_iw_j}\frac{a_{kl}^2}{w_kw_l} +
\frac{a_{hl}^2}{w_hw_l}\frac{a_{ij}^2}{w_iw_j} +
\frac{a_{hl}^2}{w_hw_l}\frac{a_{jk}^2}{w_jw_k} \\
> 4\frac{a_{hi}^2}{w_hw_i} +
4\frac{a_{ij}^2}{w_iw_j} +
4\frac{a_{jk}^2}{w_jw_k} +
4\frac{a_{kl}^2}{w_kw_l} +
4\frac{a_{hl}^2}{w_hw_l} +
\frac{a_{hi}a_{ij}a_{jk}a_{kl}a_{hl}}{w_hw_iw_jw_kw_l}
\end{align*}
of nonnegative integers.  Using the restrictions on the numbers given above
we see that the only possibilities are
$$
(\frac{a_{hi}^2}{w_hw_i}, \frac{a_{ij}^2}{w_iw_j},
\frac{a_{jk}^2}{w_jw_k}, \frac{a_{kl}^2}{w_kw_l}, \frac{a_{hl}^2}{w_hw_l}) =
(1, 1, 1, 1, 0), (1, 1, 1, 2, 0), \text{ or } (2, 1, 1, 1, 0)
$$
in particular $a_{hl} = 0$ (recall that we assumed the other four
to be nonzero). Observe that the case $(1, 1, 1, 2, 0)$
is obtained from the case $(2, 1, 1, 1, 0)$ by reversing the order
of the indices $h, i, j, k, l$. The first two solutions lead to
cases (\ref{item-A5}), (\ref{item-C5}), and (\ref{item-B5}) of
Lemma \ref{lemma-five-by-five} where we also wrote out the
consequences for the integers $m_h$, $m_i$, $m_j$, $m_k$, and $m_l$.

\begin{lemma}
\label{lemma-five-by-five}
Classification of proper subgraphs of the form
$$
\xymatrix{
\bullet \ar@{-}[r] &
\bullet \ar@{-}[r] &
\bullet \ar@{-}[r] &
\bullet \ar@{-}[r] &
\bullet
}
$$
If $n > 5$, then given five $(-2)$-indices $h, i, j, k, l$
with $a_{hi}, a_{ij}, a_{jk}, a_{kl}$ nonzero, then up
to ordering we have the $m$'s, $a$'s, $w$'s
\begin{enumerate}
\item
\label{item-A5}
are given by
$$
\left(
\begin{matrix}
m_1 \\
m_2 \\
m_3 \\
m_4 \\
m_5
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
-2w & w & 0 & 0 & 0 \\
w & -2w & w & 0 & 0 \\
0 & w & -2w & w & 0 \\
0 & 0 & w & -2w & w \\
0 & 0 & 0 & w & -2w
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
w \\
w \\
w \\
w \\
w
\end{matrix}
\right)
$$
with $2m_1 \geq m_2$, $2m_2 \geq m_1 + m_3$, $2m_3 \geq m_2 + m_4$,
$2m_4 \geq m_3 + m_5$, and $2m_5 \geq m_4$, or
\item
\label{item-C5}
are given by
$$
\left(
\begin{matrix}
m_1 \\
m_2 \\
m_3 \\
m_4 \\
m_5
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
-2w & w & 0 & 0 & 0 \\
w & -2w & w & 0 & 0 \\
0 & w & -2w & w & 0 \\
0 & 0 & w & -2w & 2w \\
0 & 0 & 0 & 2w & -4w
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
w \\
w \\
w \\
w \\
2w
\end{matrix}
\right)
$$
with $2m_1 \geq m_2$, $2m_2 \geq m_1 + m_3$, $2m_3 \geq m_2 + 2m_4$,
$2m_4 \geq m_3 + m_5$, and $2m_5 \geq m_4$, or
\item
\label{item-B5}
are given by
$$
\left(
\begin{matrix}
m_1 \\
m_2 \\
m_3 \\
m_4 \\
m_5
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
-4w & 2w & 0 & 0 & 0 \\
2w & -4w & 2w & 0 & 0 \\
0 & 2w & -4w & 2w & 0 \\
0 & 0 & 2w & -4w & 2w \\
0 & 0 & 0 & 2w & -2w
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
2w \\
2w \\
2w \\
2w \\
w
\end{matrix}
\right)
$$
with $2m_1 \geq m_2$, $2m_2 \geq m_1 + m_3$, $2m_3 \geq m_2 + m_4$,
$2m_4 \geq m_3 + m_5$, and $m_4 \geq m_3$.
\end{enumerate}
\end{lemma}

\begin{proof}
See discussion above.
\end{proof}

\noindent
Suppose that $h$, $i$, $j$, $k$, and $l$ are five $(-2)$-indices
with $a_{hi} > 0$, $a_{hj} > 0$, $a_{hk} > 0$, and $a_{hl} > 0$.
In other words, the index $h$ ``meets'' the indices
$i$, $j$, $k$, $l$. Then we see from Lemma \ref{lemma-three-by-three}
that $a_{ij} = a_{ik} = a_{il} = a_{jk} = a_{jl} = a_{kl} = 0$ and
by Lemma \ref{lemma-D4} that
$w_h = w_i = w_j = w_k = w_l = w$ for some integer $w > 0$ and
$a_{hi} = a_{hj} = a_{hk} = a_{hl} = -2w$.
The corresponding matrix
$$
\left(
\begin{matrix}
-2w & w & w & w & w \\
w & -2w & 0 & 0 & 0 \\
w & 0 & -2w & 0 & 0 \\
w & 0 & 0 & -2w & 0 \\
w & 0 & 0 & 0 & -2w
\end{matrix}
\right)
$$
is singular. Hence this can only happen if $n = 5$ and $g = 1$.
The reader can find this as case
(\ref{item-quadruple}) Lemma \ref{lemma-genus-one}.

\begin{lemma}
\label{lemma-fourfold}
Nonexistence of proper subgraphs of the form
$$
\xymatrix{
\bullet \ar@{-}[r] & \bullet \ar@{-}[ld] \ar@{-}[r] \ar@{-}[d] & \bullet \\
\bullet & \bullet
}
$$
If $n > 5$, there do {\bf not} exist five $(-2)$-indices
$h$, $i$, $j$, $k$ with $a_{hi} > 0$, $a_{hj} > 0$, $a_{hk} > 0$, and
$a_{hl} > 0$.
\end{lemma}

\begin{proof}
See discussion above.
\end{proof}

\noindent
Suppose that $h$, $i$, $j$, $k$, and $l$ are five $(-2)$-indices
with $a_{hi} > 0$, $a_{ij} > 0$, $a_{jk} > 0$, and $a_{jl} > 0$.
In other words, the index $h$ ``meets'' $i$ and the index $j$ ``meets''
the indices $i$, $k$, $l$. Then we see from
Lemma \ref{lemma-D4} that $a_{ik} = a_{il} = a_{kl} = 0$,
$w_i = w_j = w_k = w_l = w$, and $a_{ij} = a_{jk} = a_{jl} = w$
for some integer $w$. Applying Lemma \ref{lemma-four-by-four} to
the four tuples
$h, i, j, k$ and $h, i, j, l$ we see that $a_{hj} = a_{hk} = a_{hl} = 0$,
that $w_h = \frac{1}{2}w$, $w$, or $2w$, and that
correspondingly $a_{hi} = w$, $w$, or $2w$.
Since $A$ is semi-negative definite we see that the matrix
$$
\left(
\begin{matrix}
-2w_h & a_{hi} & 0 & 0 & 0 \\
a_{hi} & -2w & w & 0 & 0 \\
0 & w & -2w & w & w \\
0 & 0 & w & -2w & 0 \\
0 & 0 & w & 0 & -2w
\end{matrix}
\right)
$$
is negative definite unless $n = 5$. The reader computes that the
determinant of the matrix is $0$ when $w_h = \frac{1}{2}w$ or $2w$.
This leads to cases (\ref{item-triple-extended-up}) and
(\ref{item-triple-extended-down}) of Lemma \ref{lemma-genus-one}.
For $w_h = w$ we obtain case (\ref{item-D5}) of
Lemma \ref{lemma-D5}.

\begin{lemma}
\label{lemma-D5}
Classification of proper subgraphs of the form
$$
\xymatrix{
\bullet \ar@{-}[r] & \bullet \ar@{-}[r] &
\bullet \ar@{-}[r] \ar@{-}[d] & \bullet \\
& & \bullet
}
$$
If $n > 5$, then given five $(-2)$-indices $h, i, j, k, l$
with $a_{hi}, a_{ij}, a_{jk}, a_{jl}$ nonzero, then up
to ordering we have the $m$'s, $a$'s, $w$'s
\begin{enumerate}
\item
\label{item-D5}
are given by
$$
\left(
\begin{matrix}
m_1 \\
m_2 \\
m_3 \\
m_4 \\
m_5
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
-2w & w & 0 & 0 & 0 \\
w & -2w & w & 0 & 0 \\
0 & w & -2w & w & w \\
0 & 0 & w & -2w & 0 \\
0 & 0 & w & 0 & -2w
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
w \\
w \\
w \\
w \\
w
\end{matrix}
\right)
$$
with $2m_1 \geq m_2$, $2m_2 \geq m_1 + m_3$, $2m_3 \geq m_2 + m_4 + m_5$,
$2m_4 \geq m_3$, and $2m_5 \geq m_3$.
\end{enumerate}
\end{lemma}

\begin{proof}
See discussion above.
\end{proof}

\noindent
Suppose that $t > 5$ and $i_1, \ldots, i_t$ are $t$ distinct $(-2)$-indices
such that $a_{i_ji_{j + 1}}$ is nonzero for $j = 1, \ldots, t - 1$. We will
prove by induction on $t$ that if $n = t$ this leads to possibilities
(\ref{item-n-cycle}), (\ref{item-up-chain-equal-up}),
(\ref{item-up-chain-equal-down}), (\ref{item-down-chain-equal-up})
of Lemma \ref{lemma-genus-one} and if $n > t$ to cases
(\ref{item-An}), (\ref{item-Cn}), and (\ref{item-Bn}) of
Lemma \ref{lemma-long}.
First, if $a_{i_1i_t}$ is nonzero, then it is clear from
the result of Lemma \ref{lemma-five-by-five} that
$w_{i_1} = \ldots = w_{i_t} = w$ and that
$a_{i_ji_{j + 1}} = w$ for $j = 1, \ldots, t - 1$ and
$a_{i_1i_t} = w$. Then the vector $(1, \ldots, 1)$ is in the kernel
of the corresponding $t \times t$ matrix. Thus we must have $n = t$
and we see that the genus is $1$ and that we are
in case (\ref{item-n-cycle}) of Lemma \ref{lemma-genus-one}.
Thus we may assume $a_{i_1i_t} = 0$.
By induction hypothesis (or Lemma \ref{lemma-five-by-five} if $t = 6$)
we see that $a_{i_ji_k} = 0$ if $k > j + 1$.
Moreover, we have $w_{i_1} = \ldots = w_{i_{t - 1}} = w$
for some integer $w$ and $w_{i_1}, w_{i_t} \in \{\frac{1}{2}w, w, 2w\}$.
Moreover, the value of $w_{i_1}$, resp.\ $w_{i_t}$ being
$\frac{1}{2}w$, $w$, or $2w$ implies that the
the value of $a_{i_1i_2}$, resp.\ $a_{i_{t - 1}i_t}$
is $w$, $w$, or $2w$. This gives $9$ possibilities.
In each case it is easy to decide what happens:
\begin{enumerate}
\item if $(w_{i_1}, w_{i_t}) = (\frac{1}{2}w, \frac{1}{2}w)$, then
we are in case (\ref{item-up-chain-equal-down}) of
Lemma \ref{lemma-genus-one},
\item if $(w_{i_1}, w_{i_t}) = (\frac{1}{2}w, w)$ or $(w, \frac{1}{2}w)$
then we are in case (\ref{item-Bn}) of Lemma \ref{lemma-long},
\item if $(w_{i_1}, w_{i_t}) = (\frac{1}{2}w, 2w)$ or $(2w, \frac{1}{2}w)$
then we are in case (\ref{item-up-chain-equal-up}) of
Lemma \ref{lemma-genus-one},
\item if $(w_{i_1}, w_{i_t}) = (w, w)$ then we are in case
(\ref{item-An}) of Lemma \ref{lemma-long},
\item if $(w_{i_1}, w_{i_t}) = (w, 2w)$ or $(2w, w)$ then we are
in case (\ref{item-Cn}) of Lemma \ref{lemma-long}, and
\item if $(w_{i_1}, w_{i_t}) = (2w, 2w)$ then we are in case
(\ref{item-down-chain-equal-up}) of Lemma \ref{lemma-genus-one}.
\end{enumerate}

\begin{lemma}
\label{lemma-long}
Classification of proper subgraphs of the form
$$
\xymatrix{
\bullet \ar@{-}[r] &
\bullet \ar@{-}[r] &
\bullet \ar@{..}[r] &
\bullet \ar@{-}[r] &
\bullet \ar@{-}[r] &
\bullet
}
$$
Let $t > 5$ and $n > t$. Then given $t$ distinct $(-2)$-indices
$i_1, \ldots, i_t$ such that $a_{i_ji_{j + 1}}$ is nonzero for
$j = 1, \ldots, t - 1$, then up to reversing the order of these indices
we have the $a$'s and $w$'s
\begin{enumerate}
\item
\label{item-An}
are given by $w_{i_1} = w_{i_2} = \ldots = w_{i_t} = w$,
$a_{i_ji_{j + 1}} = w$, and $a_{i_ji_k} = 0$ if $k > j + 1$, or
\item
\label{item-Cn}
are given by $w_{i_1} = w_{i_2} = \ldots = w_{i_{t - 1}} = w$,
$w_{j_t} = 2w$, $a_{i_ji_{j + 1}} = w$ for $j < t - 1$,
$a_{i_{t - 1}i_t} = 2w$, and $a_{i_ji_k} = 0$ if $k > j + 1$, or
\item
\label{item-Bn}
are given by $w_{i_1} = w_{i_2} = \ldots = w_{i_{t - 1}} = 2w$,
$w_{j_t} = w$, $a_{i_ji_{j + 1}} = 2w$, and
$a_{i_{t - 1}i_t} = 2w$, and $a_{i_ji_k} = 0$ if $k > j + 1$.
\end{enumerate}
\end{lemma}

\begin{proof}
See discussion above.
\end{proof}

\noindent
Suppose that $t > 4$ and $i_1, \ldots, i_{t + 1}$ are $t + 1$
distinct $(-2)$-indices such that $a_{i_ji_{j + 1}} > 0$
for $j = 1, \ldots, t - 1$ and such that $a_{j_{t - 1}j_{t + 1}} > 0$.
See picture in Lemma \ref{lemma-Dn}. We will prove by induction on $t$
that if $n = t + 1$ this leads to possibilites
(\ref{item-Dn-extended-up}) and (\ref{item-Dn-extended-down})
of Lemma \ref{lemma-genus-one} and if $n > t + 1$ to
case (\ref{item-Dn}) of Lemma \ref{lemma-Dn}.
By induction hypothesis (or Lemma \ref{lemma-D5} in case $t = 5$)
we see that $a_{i_ji_k}$ is zero outside of the required
nonvanishing ones for $j, k \geq 2$.
Moreover, we see that $w_2 = \ldots = w_{t + 1} = w$ for some integer
$w$ and that the nonvanising $a_{i_ji_k}$ for $j, k \geq 2$ are
equal to $w$. Applying Lemma \ref{lemma-long}
(or Lemma \ref{lemma-five-by-five} if $t = 5$) to the sequence
$i_1, \ldots, i_t$ and to the sequence
$i_1, \ldots, i_{t - 1}, i_{t + 1}$ we conclude that
$a_{i_1 i_j} = 0$ for $j \geq 3$ and that
$w_1$ is equal to $\frac{1}{2}w$, $w$, or $2w$
and that correspondingly $a_{i_1i_2}$ is $w, w, 2w$.
This gives $3$ possibilites. In each case it is easy to
decide what happens:
\begin{enumerate}
\item If $w_1 = \frac{1}{2}w$, then we are in case
(\ref{item-Dn-extended-down}) of Lemma \ref{lemma-genus-one}.
\item If $w_1 = w$, then we are in case
(\ref{item-Dn}) of Lemma \ref{lemma-Dn}.
\item If $w_1 = 2w$, then we are in case
(\ref{item-Dn-extended-up}) of Lemma \ref{lemma-genus-one}.
\end{enumerate}

\begin{lemma}
\label{lemma-Dn}
Classification of proper subgraphs of the form
$$
\xymatrix{
\bullet \ar@{-}[r] & \bullet \ar@{..}[r] & \bullet \ar@{-}[r] &
\bullet \ar@{-}[r] \ar@{-}[d] & \bullet \\
& & & \bullet
}
$$
Let $t > 4$ and $n > t + 1$. Then given $t + 1$ distinct
$(-2)$-indices $i_1, \ldots, i_{t + 1}$ such that $a_{i_ji_{j + 1}}$
is nonzero for $j = 1, \ldots, t - 1$ and $a_{i_{t - 1}i_{t + 1}}$
is nonzero, then we have the $a$'s and $w$'s
\begin{enumerate}
\item
\label{item-Dn}
are given by $w_{i_1} = w_{i_2} = \ldots = w_{i_{t + 1}} = w$,
$a_{i_ji_{j + 1}} = w$ for $j = 1, \ldots, t - 1$,
$a_{i_{t - 1}i_{t + 1}} = w$ and $a_{i_ji_k} = 0$ for other
pairs $(j, k)$ with $j > k$.
\end{enumerate}
\end{lemma}

\begin{proof}
See discussion above.
\end{proof}

\noindent
Suppose we are given $6$ distinct $(-2)$-indices $g, h, i, j, k, l$
such that $a_{gh}, a_{hi}, a_{ij}, a_{jk}, a_{il}$ are nonzero.
See picture in Lemma \ref{lemma-E6}. Then we can apply
Lemma \ref{lemma-D5} to see that we must be in the situation
of Lemma \ref{lemma-E6}. Since the determinant is $3w^6 > 0$
we conclude that in this case it never happens that $n = 6$!

\begin{lemma}
\label{lemma-E6}
Classification of proper subgraphs of the form
$$
\xymatrix{
\bullet \ar@{-}[r] & \bullet \ar@{-}[r] & \bullet \ar@{-}[r] \ar@{-}[d] &
\bullet \ar@{-}[r] & \bullet \\
& & \bullet
}
$$
Let $n > 6$. Then given $6$ distinct $(-2)$-indices $i_1, \ldots, i_6$
such that $a_{12}, a_{23}, a_{34}, a_{45}, a_{36}$ are nonzero, then
we have the $m$'s, $a$'s, and $w$'s
\begin{enumerate}
\item
\label{item-E6}
are given by
$$
\left(
\begin{matrix}
m_1 \\
m_2 \\
m_3 \\
m_4 \\
m_5 \\
m_6
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
-2w & w & 0 & 0 & 0 & 0 \\
w & -2w & w & 0 & 0 & 0 \\
0 & w & -2w & w & 0 & w \\
0 & 0 & w & -2w & w & 0 \\
0 & 0 & 0 & w & -2w & 0 \\
0 & 0 & w & 0 & 0 & -2w
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
w \\
w \\
w \\
w \\
w \\
w
\end{matrix}
\right)
$$
with $2m_1 \geq m_2$, $2m_2 \geq m_1 + m_3$, $2m_3 \geq m_2 + m_4 + m_6$,
$2m_4 \geq m_3 + m_5$, $2m_5 \geq m_3$, and $2m_6 \geq m_3$.
\end{enumerate}
\end{lemma}

\begin{proof}
See discussion above.
\end{proof}

\noindent
Suppose that $t \geq 4$ and $i_0, \ldots, i_{t + 1}$ are
$t + 2$ distinct $(-2)$-indices such that
$a_{i_ji_{j + 1}} > 0$ for $j = 1, \ldots, t - 1$
and $a_{i_0i_2} > 0$ and $a_{i_{t - 1}i_{t + 1}} > 0$.
See picture in Lemma \ref{lemma-double-triple}.
Then we can apply Lemmas \ref{lemma-D5} and \ref{lemma-Dn}
to see that all other $a_{i_ji_k}$ for $j < k$ are zero
and that $w_{i_0} = \ldots = w_{i_{t + 1}} = w$ for some
integer $w$ and that the required nonzero off diagonal
entries of $A$ are equal to $w$.
A computation shows that the determinant of the
corresponding matrix is zero. Hence $n = t + 2$
and we are in case (\ref{item-double-triple}) of
Lemma \ref{lemma-genus-one}.

\begin{lemma}
\label{lemma-double-triple}
Nonexistence of proper subgraphs of the form
$$
\xymatrix{
\bullet \ar@{-}[r] & \bullet \ar@{..}[r] \ar@{-}[d] &
\bullet \ar@{-}[d] \ar@{-}[r] & \bullet \\
& \bullet & \bullet
}
$$
Assume $t \geq 4$ and $n > t + 2$.
There do {\bf not} exist $t + 2$ distinct
$(-2)$-indices $i_0, \ldots, i_{t + 1}$ such that
$a_{i_ji_{j + 1}} > 0$ for $j = 1, \ldots, t - 1$
and $a_{i_0i_2} > 0$ and $a_{i_{t - 1}i_{t + 1}} > 0$.
\end{lemma}

\begin{proof}
See discussion above.
\end{proof}

\noindent
Suppose we are given $7$ distinct $(-2)$-indices $f, g, h, i, j, k, l$
such that the numbers
$a_{fg}, a_{gh}, a_{ij}, a_{jh}, a_{kl}, a_{lh}$ are nonzero.
See picture in Lemma \ref{lemma-E6-completed}. Then we can apply
Lemma \ref{lemma-D5} to see that the corresponding matrix is
$$
\left(
\begin{matrix}
-2w & w & 0 & 0 & 0 & 0 & 0 \\
w & -2w & w & 0 & 0 & 0 & 0 \\
0 & w & -2w & 0 & w & 0 & w \\
0 & 0 & 0 & -2w & w & 0 & 0 \\
0 & 0 & w & w & -2w & 0 & 0 \\
0 & 0 & 0 & 0 & 0 & -2w & w \\
0 & 0 & w & 0 & 0 & w & -2w
\end{matrix}
\right)
$$
Since the determinant is $0$ we conclude that we must have $n = 7$
and $g = 1$ and we get case (\ref{item-E6-completed})
of Lemma \ref{lemma-genus-one}.

\begin{lemma}
\label{lemma-E6-completed}
Nonexistence of proper subgraphs of the form
$$
\xymatrix{
\bullet \ar@{-}[r] & \bullet \ar@{-}[r] & \bullet \ar@{-}[r] \ar@{-}[d] &
\bullet \ar@{-}[r] & \bullet \\
& & \bullet \ar@{-}[d] \\
& & \bullet
}
$$
Assume $n > 7$. There do {\bf not} exist $7$ distinct
$(-2)$-indices $f, g, h, i, j, k, l$
such that $a_{fg}, a_{gh}, a_{ij}, a_{jh}, a_{kl}, a_{lh}$ are nonzero.
\end{lemma}

\begin{proof}
See discussion above.
\end{proof}

\noindent
Suppose we are given $7$ distinct $(-2)$-indices $f, g, h, i, j, k, l$
such that the numbers
$a_{fg}, a_{gh}, a_{hi}, a_{ij}, a_{jk}, a_{il}$ are nonzero.
See picture in Lemma \ref{lemma-E7}. Then we can apply
Lemmas \ref{lemma-D5} and \ref{lemma-Dn}
to see that we must be in the situation
of Lemma \ref{lemma-E7}. Since the determinant is $-8w^7 > 0$
we conclude that in this case it never happens that $n = 7$!

\begin{lemma}
\label{lemma-E7}
Classification of proper subgraphs of the form
$$
\xymatrix{
\bullet \ar@{-}[r] & \bullet \ar@{-}[r] & \bullet \ar@{-}[r] &
\bullet \ar@{-}[r] \ar@{-}[d] & \bullet \ar@{-}[r] & \bullet \\
& & & \bullet
}
$$
Let $n > 7$. Then given $7$ distinct $(-2)$-indices $i_1, \ldots, i_7$
such that $a_{12}, a_{23}, a_{34}, a_{45}, a_{56}, a_{47}$ are nonzero,
then we have the $m$'s, $a$'s, and $w$'s
\begin{enumerate}
\item
\label{item-E7}
are given by
$$
\left(
\begin{matrix}
m_1 \\
m_2 \\
m_3 \\
m_4 \\
m_5 \\
m_6 \\
m_7
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
-2w & w & 0 & 0 & 0 & 0 & 0 \\
w & -2w & w & 0 & 0 & 0 & 0 \\
0 & w & -2w & w & 0 & 0 & 0 \\
0 & 0 & w & -2w & w & 0 & w \\
0 & 0 & 0 & w & -2w & w & 0 \\
0 & 0 & 0 & 0 & w & -2w & 0 \\
0 & 0 & 0 & w & 0 & 0 & -2w
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
w \\
w \\
w \\
w \\
w \\
w \\
w
\end{matrix}
\right)
$$
with $2m_1 \geq m_2$, $2m_2 \geq m_1 + m_3$, $2m_3 \geq m_2 + m_4$,
$2m_4 \geq m_3 + m_5 + m_7$, $2m_5 \geq m_4 + m_6$, $2m_6 \geq m_5$,
and $2m_7 \geq m_4$.
\end{enumerate}
\end{lemma}

\begin{proof}
See discussion above.
\end{proof}

\noindent
Suppose we are given $8$ distinct $(-2)$-indices whose pattern
of nonzero entries $a_{ij}$ of the matrix $A$ looks like
$$
\xymatrix{
\bullet \ar@{-}[r] & \bullet \ar@{-}[r] & \bullet \ar@{-}[r] &
\bullet \ar@{-}[r] & \bullet \ar@{-}[r] \ar@{-}[d] &
\bullet \ar@{-}[r] & \bullet \\
& & & & \bullet
}
$$
or like
$$
\xymatrix{
\bullet \ar@{-}[r] & \bullet \ar@{-}[r] & \bullet \ar@{-}[r] &
\bullet \ar@{-}[r] \ar@{-}[d] & \bullet \ar@{-}[r] &
\bullet \ar@{-}[r] & \bullet \\
& & & \bullet
}
$$
Arguing exactly as in the proof of Lemma \ref{lemma-E7}
we see that the first pattern leads to case
(\ref{item-E8}) in Lemma \ref{lemma-E8}
and does not lead to a new case in Lemma \ref{lemma-genus-one}.
Arguing exactly as in the proof of Lemma \ref{lemma-E6-completed}
we see that the second pattern does not occur if
$n > 8$, but leads to case (\ref{item-E7-completed})
in Lemma \ref{lemma-genus-one}.

\begin{lemma}
\label{lemma-E8}
Classification of proper subgraphs of the form
$$
\xymatrix{
\bullet \ar@{-}[r] & \bullet \ar@{-}[r] & \bullet \ar@{-}[r] &
\bullet \ar@{-}[r] & \bullet \ar@{-}[r] \ar@{-}[d] &
\bullet \ar@{-}[r] & \bullet \\
& & & & \bullet
}
$$
Let $n > 8$. Then given $8$ distinct $(-2)$-indices $i_1, \ldots, i_8$
such that $a_{12}, a_{23}, a_{34}, a_{45}, a_{56}, a_{65}, a_{57}$
are nonzero, then we have the $m$'s, $a$'s, and $w$'s
\begin{enumerate}
\item
\label{item-E8}
are given by
$$
\left(
\begin{matrix}
m_1 \\
m_2 \\
m_3 \\
m_4 \\
m_5 \\
m_6 \\
m_7 \\
m_8
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
-2w & w & 0 & 0 & 0 & 0 & 0 & 0 \\
w & -2w & w & 0 & 0 & 0 & 0 & 0 \\
0 & w & -2w & w & 0 & 0 & 0 & 0 \\
0 & 0 & w & -2w & w & 0 & 0 & 0 \\
0 & 0 & 0 & w & -2w & w & 0 & w \\
0 & 0 & 0 & 0 & w & -2w & w & 0 \\
0 & 0 & 0 & 0 & 0 & w & -2w & 0 \\
0 & 0 & 0 & 0 & w & 0 & 0 & -2w
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
w \\
w \\
w \\
w \\
w \\
w \\
w \\
w
\end{matrix}
\right)
$$
with $2m_1 \geq m_2$, $2m_2 \geq m_1 + m_3$, $2m_3 \geq m_2 + m_4$,
$2m_4 \geq m_3 + m_5$, $2m_5 \geq m_4 + m_6 + m_8$, $2m_6 \geq m_5 + m_7$,
$2m_7 \geq m_6$, and $2m_8 \geq m_5$.
\end{enumerate}
\end{lemma}

\begin{proof}
See discussion above.
\end{proof}

\begin{lemma}
\label{lemma-E7-completed}
Nonexistence of proper subgraphs of the form
$$
\xymatrix{
\bullet \ar@{-}[r] &
\bullet \ar@{-}[r] &
\bullet \ar@{-}[r] & \bullet \ar@{-}[r] \ar@{-}[d] &
\bullet \ar@{-}[r] & \bullet \ar@{-}[r] & \bullet \\
& & & \bullet
}
$$
Assume $n > 8$. There do {\bf not} exist $8$ distinct
$(-2)$-indices $e, f, g, h, i, j, k, l$
such that $a_{ef}, a_{fg}, a_{gh}, a_{hi}, a_{ij}, a_{jk}, a_{lh}$
are nonzero.
\end{lemma}

\begin{proof}
See discussion above.
\end{proof}

\noindent
Suppose we are given $9$ distinct $(-2)$-indices whose pattern
of nonzero entries $a_{ij}$ of the matrix $A$ looks like
$$
\xymatrix{
\bullet \ar@{-}[r] & \bullet \ar@{-}[r] &
\bullet \ar@{-}[r] & \bullet \ar@{-}[r] &
\bullet \ar@{-}[r] & \bullet \ar@{-}[r] \ar@{-}[d] &
\bullet \ar@{-}[r] & \bullet \\
& & & & & \bullet
}
$$
Arguing exactly as in the proof of Lemma \ref{lemma-E6-completed}
we see that this pattern does not occur if
$n > 9$, but leads to case (\ref{item-E8-completed})
in Lemma \ref{lemma-genus-one}.

\begin{lemma}
\label{lemma-E8-completed}
Nonexistence of proper subgraphs of the form
$$
\xymatrix{
\bullet \ar@{-}[r] & \bullet \ar@{-}[r] &
\bullet \ar@{-}[r] & \bullet \ar@{-}[r] &
\bullet \ar@{-}[r] & \bullet \ar@{-}[r] \ar@{-}[d] &
\bullet \ar@{-}[r] & \bullet \\
& & & & & \bullet
}
$$
Assume $n > 9$. There do {\bf not} exist $9$ distinct
$(-2)$-indices $d, e, f, g, h, i, j, k, l$
such that $a_{de}, a_{ef}, a_{fg}, a_{gh}, a_{hi}, a_{ij}, a_{jk}, a_{lh}$
are nonzero.
\end{lemma}

\begin{proof}
See discussion above.
\end{proof}

\noindent
Collecting all the information together we find the following.

\begin{proposition}
\label{proposition-classify-subgraphs}
Let $n, m_i, a_{ij}, w_i, g_i$ be a numerical type of genus $g$.
Let $I \subset \{1, \ldots, n\}$ be a subset of cardinality $\geq 2$
consisting of $(-2)$-indices such that there
does not exist a nonempty proper subset $J \subset I$
with $a_{jj'} = 0$ for $j \in J$, $j' \in I \setminus J$.
Then up to reordering the $m_i$'s, $a_{ii'}$'s, $w_i$'s
for $i, i' \in I$ are as listed in
Lemmas \ref{lemma-two-by-two},
\ref{lemma-three-by-three},
\ref{lemma-four-by-four},
\ref{lemma-D4},
\ref{lemma-five-by-five},
\ref{lemma-D5},
\ref{lemma-long},
\ref{lemma-Dn},
\ref{lemma-E6},
\ref{lemma-E7}, or
\ref{lemma-E8}.
\end{proposition}

\begin{proof}
This follows from the discussion above.
\end{proof}













\section{Classification of minimal type for genus zero and one}
\label{section-classification-genus-one}

\noindent
The title of the section explains it all.

\begin{lemma}[Genus zero]
\label{lemma-genus-zero}
The only minimal numerical type of genus zero is
$n = 1$, $m_1 = 1$, $a_{11} = 0$, $w_1 = 1$, $g_1 = 0$.
\end{lemma}

\begin{proof}
See discussion above.
\end{proof}

\begin{lemma}[Genus one]
\label{lemma-genus-one}
The minimal numerical types of genus one are up to equivalence
\begin{enumerate}
\item
\label{item-one}
$n = 1$, $a_{11} = 0$, $g_1 = 1$, $m_1, w_1 \geq 1$ arbitrary,
\item
\label{item-two-cycle}
$n = 2$, and $m_i, a_{ij}, w_i, g_i$ given by
$$
\left(
\begin{matrix}
m \\
m
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
-2w & 2w \\
2w & -2w
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
w \\
w
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
0 \\
0
\end{matrix}
\right)
$$
with $w$ and $m$ arbitrary,
\item
\label{item-up4}
$n = 2$, and $m_i, a_{ij}, w_i, g_i$ given by
$$
\left(
\begin{matrix}
2m \\
m
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
-2w & 4w \\
4w & -8w
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
w \\
4w
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
0 \\
0
\end{matrix}
\right)
$$
with $w$ and $m$ arbitrary,
\item
\label{item-three-cycle}
$n = 3$, and $m_i, a_{ij}, w_i, g_i$ given by
$$
\left(
\begin{matrix}
m \\
m \\
m
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
-2w & w & w \\
w & -2w & w \\
w & w & -2w
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
w \\
w \\
w
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
0 \\
0 \\
0
\end{matrix}
\right)
$$
with $w$ and $m$ arbitrary,
\item
\label{item-equal-up3}
$n = 3$, and $m_i, a_{ij}, w_i, g_i$ given by
$$
\left(
\begin{matrix}
m \\
2m \\
m
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
-2w & w & 0 \\
w & -2w & 3w \\
0 & 3w & -6w
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
w \\
w \\
3w
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
0 \\
0 \\
0
\end{matrix}
\right)
$$
with $w$ and $m$ arbitrary,
\item
\label{item-equal-down3}
$n = 3$, and $m_i, a_{ij}, w_i, g_i$ given by
$$
\left(
\begin{matrix}
m \\
2m \\
3m
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
-6w & 3w & 0 \\
3w & -6w & 3w \\
0 & 3w & -2w
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
3w \\
3w \\
w
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
0 \\
0 \\
0
\end{matrix}
\right)
$$
with $w$ and $m$ arbitrary,
\item
\label{item-up-up}
$n = 3$, and $m_i, a_{ij}, w_i, g_i$ given by
$$
\left(
\begin{matrix}
2m \\
2m \\
m
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
-2w & 2w & 0 \\
2w & -4w & 4w \\
0 & 4w & -8w
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
w \\
2w \\
4w
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
0 \\
0 \\
0
\end{matrix}
\right)
$$
with $w$ and $m$ arbitrary,
\item
\label{item-up-down}
$n = 3$, and $m_i, a_{ij}, w_i, g_i$ given by
$$
\left(
\begin{matrix}
m \\
m \\
m
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
-2w & 2w & 0 \\
2w & -4w & 2w \\
0 & 2w & -2w
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
w \\
2w \\
w
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
0 \\
0 \\
0
\end{matrix}
\right)
$$
with $w$ and $m$ arbitrary,
\item
\label{item-down-up}
$n = 3$, and $m_i, a_{ij}, w_i, g_i$ given by
$$
\left(
\begin{matrix}
m \\
2m \\
m
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
-4w & 2w & 0 \\
2w & -2w & 2w \\
0 & 2w & -4w
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
2w \\
w \\
2w
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
0 \\
0 \\
0
\end{matrix}
\right)
$$
with $w$ and $m$ arbitrary,
\item
\label{item-four-cycle}
$n = 4$, and $m_i, a_{ij}, w_i, g_i$ given by
$$
\left(
\begin{matrix}
m \\
m \\
m \\
m
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
-2w & w & 0 & w \\
w & -2w & w & 0 \\
0 & w & -2w & w \\
w & 0 & w & -2w
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
w \\
w \\
w \\
w
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
0 \\
0 \\
0 \\
0
\end{matrix}
\right)
$$
with $w$ and $m$ arbitrary,
\item
\label{item-up-equal-up}
$n = 4$, and $m_i, a_{ij}, w_i, g_i$ given by
$$
\left(
\begin{matrix}
2m \\
2m \\
2m \\
m
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
-2w & 2w & 0 & 0 \\
2w & -4w & 2w & 0 \\
0 & 2w & -4w & 4w \\
0 & 0 & 4w & -8w
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
w \\
2w \\
2w \\
4w
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
0 \\
0 \\
0 \\
0
\end{matrix}
\right)
$$
with $w$ and $m$ arbitrary,
\item
\label{item-up-equal-down}
$n = 4$, and $m_i, a_{ij}, w_i, g_i$ given by
$$
\left(
\begin{matrix}
m \\
m \\
m \\
m
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
-2w & 2w & 0 & 0 \\
2w & -4w & 2w & 0 \\
0 & 2w & -4w & 2w \\
0 & 0 & 2w & -2w
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
w \\
2w \\
2w \\
w
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
0 \\
0 \\
0 \\
0
\end{matrix}
\right)
$$
with $w$ and $m$ arbitrary,
\item
\label{item-down-equal-up}
$n = 4$, and $m_i, a_{ij}, w_i, g_i$ given by
$$
\left(
\begin{matrix}
m \\
2m \\
2m \\
m
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
-4w & 2w & 0 & 0 \\
2w & -2w & w & 0 \\
0 & w & -2w & 2w \\
0 & 0 & 2w & -4w
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
2w \\
w \\
w \\
2w
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
0 \\
0 \\
0 \\
0
\end{matrix}
\right)
$$
with $w$ and $m$ arbitrary,
\item
\label{item-triple-with-up}
$n = 4$, and $m_i, a_{ij}, w_i, g_i$ given by
$$
\left(
\begin{matrix}
2m \\
m \\
m \\
m
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
-2w & w & w & 2w \\
w & -2w & 0 & 0 \\
w & 0 & -2w & 0 \\
2w & 0 & 0 & -4w
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
w \\
w \\
w \\
2w
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
0 \\
0 \\
0 \\
0
\end{matrix}
\right)
$$
with $w$ and $m$ arbitrary,
\item
\label{item-triple-with-down}
$n = 4$, and $m_i, a_{ij}, w_i, g_i$ given by
$$
\left(
\begin{matrix}
2m \\
m \\
m \\
2m
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
-4w & 2w & 2w & 2w \\
2w & -4w & 0 & 0 \\
2w & 0 & -4w & 0 \\
2w & 0 & 0 & -2w
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
2w \\
2w \\
2w \\
w
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
0 \\
0 \\
0 \\
0
\end{matrix}
\right)
$$
with $w$ and $m$ arbitrary,
\item
\label{item-five-cycle}
$n = 5$, and $m_i, a_{ij}, w_i, g_i$ given by
$$
\left(
\begin{matrix}
m \\
m \\
m \\
m \\
m
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
-2w & w & 0 & 0 & w \\
w & -2w & w & 0 & 0 \\
0 & w & -2w & w & 0 \\
0 & 0 & w & -2w & w \\
w & 0 & 0 & w & -2w \\
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
w \\
w \\
w \\
w \\
w
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
0 \\
0 \\
0 \\
0 \\
0
\end{matrix}
\right)
$$
with $w$ and $m$ arbitrary,
\item
\label{item-equal-equal-up-equal}
$n = 5$, and $m_i, a_{ij}, w_i, g_i$ given by
$$
\left(
\begin{matrix}
m \\
2m \\
3m \\
2m \\
m
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
-2w & w & 0 & 0 & 0 \\
w & -2w & w & 0 & 0 \\
0 & w & -2w & 2w & 0 \\
0 & 0 & 2w & -4w & 2w \\
0 & 0 & 0 & 2w & -4w \\
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
w \\
w \\
w \\
2w \\
2w
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
0 \\
0 \\
0 \\
0 \\
0
\end{matrix}
\right)
$$
with $w$ and $m$ arbitrary,
\item
\label{item-equal-equal-down-equal}
$n = 5$, and $m_i, a_{ij}, w_i, g_i$ given by
$$
\left(
\begin{matrix}
m \\
2m \\
3m \\
4m \\
2m
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
-4w & 2w & 0 & 0 & 0 \\
2w & -4w & 2w & 0 & 0 \\
0 & 2w & -4w & 2w & 0 \\
0 & 0 & 2w & -2w & w \\
0 & 0 & 0 & w & -2w \\
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
2w \\
2w \\
2w \\
w \\
w
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
0 \\
0 \\
0 \\
0 \\
0
\end{matrix}
\right)
$$
with $w$ and $m$ arbitrary,
\item
\label{item-up-equal-equal-up}
$n = 5$, and $m_i, a_{ij}, w_i, g_i$ given by
$$
\left(
\begin{matrix}
2m \\
2m \\
2m \\
2m \\
m
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
-2w & 2w & 0 & 0 & 0 \\
2w & -4w & 2w & 0 & 0 \\
0 & 2w & -4w & 2w & 0 \\
0 & 0 & 2w & -4w & 4w \\
0 & 0 & 0 & 4w & -8w \\
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
w \\
2w \\
2w \\
2w \\
4w
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
0 \\
0 \\
0 \\
0 \\
0
\end{matrix}
\right)
$$
with $w$ and $m$ arbitrary,
\item
\label{item-up-equal-equal-down}
$n = 5$, and $m_i, a_{ij}, w_i, g_i$ given by
$$
\left(
\begin{matrix}
m \\
m \\
m \\
m \\
m
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
-2w & 2w & 0 & 0 & 0 \\
2w & -4w & 2w & 0 & 0 \\
0 & 2w & -4w & 2w & 0 \\
0 & 0 & 2w & -4w & 2w \\
0 & 0 & 0 & 2w & -2w \\
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
w \\
2w \\
2w \\
2w \\
w
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
0 \\
0 \\
0 \\
0 \\
0
\end{matrix}
\right)
$$
with $w$ and $m$ arbitrary,
\item
\label{item-down-equal-equal-up}
$n = 5$, and $m_i, a_{ij}, w_i, g_i$ given by
$$
\left(
\begin{matrix}
m \\
2m \\
2m \\
2m \\
m
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
-4w & 2w & 0 & 0 & 0 \\
2w & -2w & w & 0 & 0 \\
0 & w & -2w & w & 0 \\
0 & 0 & w & -2w & 2w \\
0 & 0 & 0 & 2w & -4w \\
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
2w \\
w \\
w \\
w \\
2w
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
0 \\
0 \\
0 \\
0 \\
0
\end{matrix}
\right)
$$
with $w$ and $m$ arbitrary,
\item
\label{item-quadruple}
$n = 5$, and $m_i, a_{ij}, w_i, g_i$ given by
$$
\left(
\begin{matrix}
2m \\
m \\
m \\
m \\
m
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
-2w & w & w & w & w \\
w & -2w & 0 & 0 & 0 \\
w & 0 & -2w & 0 & 0 \\
w & 0 & 0 & -2w & 0 \\
w & 0 & 0 & 0 & -2w \\
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
w \\
w \\
w \\
w \\
w
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
0 \\
0 \\
0 \\
0 \\
0
\end{matrix}
\right)
$$
with $w$ and $m$ arbitrary,
\item
\label{item-triple-extended-up}
$n = 5$, and $m_i, a_{ij}, w_i, g_i$ given by
$$
\left(
\begin{matrix}
m \\
2m \\
2m \\
m \\
m
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
-4w & 2w & 0 & 0 & 0 \\
2w & -2w & w & 0 & 0 \\
0 & w & -2w & w & w \\
0 & 0 & w & -2w & 0 \\
0 & 0 & w & 0 & -2w \\
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
2w \\
w \\
w \\
w \\
w
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
0 \\
0 \\
0 \\
0 \\
0
\end{matrix}
\right)
$$
with $w$ and $m$ arbitrary,
\item
\label{item-triple-extended-down}
$n = 5$, and $m_i, a_{ij}, w_i, g_i$ given by
$$
\left(
\begin{matrix}
2m \\
2m \\
2m \\
m \\
m
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
-2w & 2w & 0 & 0 & 0 \\
2w & -4w & 2w & 0 & 0 \\
0 & 2w & -4w & 2w & 2w \\
0 & 0 & 2w & -4w & 0 \\
0 & 0 & 2w & 0 & -4w \\
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
w \\
2w \\
2w \\
2w \\
2w
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
0 \\
0 \\
0 \\
0 \\
0
\end{matrix}
\right)
$$
with $w$ and $m$ arbitrary,
\item
\label{item-n-cycle}
$n \geq 6$ and we have an $n$-cycle generalizing (\ref{item-five-cycle}):
\begin{enumerate}
\item $m_1 = \ldots = m_n = m$,
\item $a_{12} = \ldots = a_{(n - 1) n} = w$, $a_{1n} = w$,
and for other $i < j$ we have $a_{ij} = 0$,
\item $w_1 = \ldots = w_n = w$
\end{enumerate}
with $w$ and $m$ arbitrary,
\item
\label{item-up-chain-equal-up}
$n \geq 6$ and we have a chain generalizing (\ref{item-up-equal-equal-up}):
\begin{enumerate}
\item $m_1 = \ldots = m_{n - 1} = 2m$, $m_n = m$,
\item $a_{12} = \ldots = a_{(n - 2) (n - 1)} = 2w$, $a_{(n - 1) n} = 4w$,
and for other $i < j$ we have $a_{ij} = 0$,
\item $w_1 = w$, $w_2 = \ldots = w_{n - 1} = 2w$, $w_n = 4w$
\end{enumerate}
with $w$ and $m$ arbitrary,
\item
\label{item-up-chain-equal-down}
$n \geq 6$ and we have a chain generalizing (\ref{item-up-equal-equal-down}):
\begin{enumerate}
\item $m_1 = \ldots = m_n = m$,
\item $a_{12} = \ldots = a_{(n - 1) n} = w$,
and for other $i < j$ we have $a_{ij} = 0$,
\item $w_1 = w$, $w_2 = \ldots = w_{n - 1} = 2w$, $w_n = w$
\end{enumerate}
with $w$ and $m$ arbitrary,
\item
\label{item-down-chain-equal-up}
$n \geq 6$ and we have a chain generalizing (\ref{item-down-equal-equal-up}):
\begin{enumerate}
\item $m_1 = w$, $w_2 = \ldots = m_{n - 1} = 2m$, $m_n = m$,
\item $a_{12} = 2w$, $a_{23} = \ldots = a_{(n - 2) (n - 1)} = w$,
$a_{(n - 1) n} = 2w$, and for other $i < j$ we have $a_{ij} = 0$,
\item $w_1 = 2w$, $w_2 = \ldots = w_{n - 1} = w$, $w_n = 2w$
\end{enumerate}
with $w$ and $m$ arbitrary,
\item
\label{item-Dn-extended-up}
$n \geq 6$ and we have a type generalizing (\ref{item-triple-extended-up}):
\begin{enumerate}
\item $m_1 = m$, $m_2 = \ldots = m_{n - 3} = 2m$, $m_{n - 1} = m_n = m$,
\item $a_{12} = 2w$, $a_{23} = \ldots = a_{(n - 2) (n - 1)} = w$,
$a_{(n - 2) n} = w$, and for other $i < j$ we have $a_{ij} = 0$,
\item $w_1 = 2w$, $w_2 = \ldots = w_n = w$
\end{enumerate}
with $w$ and $m$ arbitrary,
\item
\label{item-Dn-extended-down}
$n \geq 6$ and we have a type generalizing (\ref{item-triple-extended-down}):
\begin{enumerate}
\item $m_1 = \ldots = m_{n - 3} = 2m$, $m_{n - 1} = m_n = m$,
\item $a_{12} = \ldots = a_{(n - 2) (n - 1)} = 2w$,
$a_{(n - 2) n} = 2w$, and for other $i < j$ we have $a_{ij} = 0$,
\item $w_1 = w$, $w_2 = \ldots = w_n = 2w$
\end{enumerate}
with $w$ and $m$ arbitrary,
\item
\label{item-double-triple}
$n \geq 6$ and we have a type generalizing (\ref{item-quadruple}):
\begin{enumerate}
\item $m_1 = m_2 = m$, $m_3 = \ldots = m_{n - 2} = 2m$, $m_{n - 1} = m_n = m$,
\item $a_{13} = w$, $a_{23} = \ldots = a_{(n - 2) (n - 1)} = w$,
$a_{(n - 2) n} = w$, and for other $i < j$ we have $a_{ij} = 0$,
\item $w_1 = \ldots = w_n = w$,
\end{enumerate}
with $w$ and $m$ arbitrary,
\item
\label{item-E6-completed}
$n = 7$, and $m_i, a_{ij}, w_i, g_i$ given by
$$
\left(
\begin{matrix}
m \\
2m \\
3m \\
m \\
2m \\
m \\
2m
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
-2w & w & 0 & 0 & 0 & 0 & 0 \\
w & -2w & w & 0 & 0 & 0 & 0 \\
0 & w & -2w & 0 & w & 0 & w \\
0 & 0 & 0 & -2w & w & 0 & 0 \\
0 & 0 & w & w & -2w & 0 & 0 \\
0 & 0 & 0 & 0 & 0 & -2w & w \\
0 & 0 & w & 0 & 0 & w & -2w
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
w \\
w \\
w \\
w \\
w \\
w \\
w
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
0 \\
0 \\
0 \\
0 \\
0 \\
0 \\
0
\end{matrix}
\right)
$$
with $w$ and $m$ arbitrary,
\item
\label{item-E7-completed}
$n = 8$, and $m_i, a_{ij}, w_i, g_i$ given by
$$
\left(
\begin{matrix}
m \\
2m \\
3m \\
4m \\
3m \\
2m \\
m \\
2m
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
-2w & w & 0 & 0 & 0 & 0 & 0 & 0 \\
w & -2w & w & 0 & 0 & 0 & 0 & 0 \\
0 & w & -2w & w & 0 & 0 & 0 & 0 \\
0 & 0 & w & -2w & w & 0 & 0 & w \\
0 & 0 & 0 & w & -2w & w & 0 & 0 \\
0 & 0 & 0 & 0 & w & -2w & w & 0 \\
0 & 0 & 0 & 0 & 0 & w & -2w & 0 \\
0 & 0 & 0 & w & 0 & 0 & 0 & -2w \\
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
w \\
w \\
w \\
w \\
w \\
w \\
w \\
w
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
0 \\
0 \\
0 \\
0 \\
0 \\
0 \\
0 \\
0
\end{matrix}
\right)
$$
with $w$ and $m$ arbitrary,
\item
\label{item-E8-completed}
$n = 9$, and $m_i, a_{ij}, w_i, g_i$ given by
$$
\left(
\begin{matrix}
m \\
2m \\
3m \\
4m \\
5m \\
6m \\
4m \\
2m \\
3m
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
-2w & w & 0 & 0 & 0 & 0 & 0 & 0 & 0 \\
w & -2w & w & 0 & 0 & 0 & 0 & 0 & 0 \\
0 & w & -2w & w & 0 & 0 & 0 & 0 & 0 \\
0 & 0 & w & -2w & w & 0 & 0 & 0 & 0 \\
0 & 0 & 0 & w & -2w & w & 0 & 0 & 0 \\
0 & 0 & 0 & 0 & w & -2w & w & 0 & w \\
0 & 0 & 0 & 0 & 0 & w & -2w & w & 0 \\
0 & 0 & 0 & 0 & 0 & 0 & w & -2w & 0 \\
0 & 0 & 0 & 0 & 0 & w & 0 & 0 & -2w \\
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
w \\
w \\
w \\
w \\
w \\
w \\
w \\
w \\
w
\end{matrix}
\right),
\quad
\left(
\begin{matrix}
0 \\
0 \\
0 \\
0 \\
0 \\
0 \\
0 \\
0 \\
0
\end{matrix}
\right)
$$
with $w$ and $m$ arbitrary.
\end{enumerate}
\end{lemma}

\begin{proof}
This is proved in Section \ref{section-classify-proper-subgraphs}.
\end{proof}






\section{Towards a classification of numerical types}
\label{section-towards-classification}

\noindent
From now on assume $n > 1$ and our numerical type of genus $g$ is minimal.
After replacing our numerical type by an equivalent one we may assume
that for some $0 \leq s \leq n$ we have
$1, \ldots, s$ are not $(-2)$-indices and $s + 1, \ldots, n$
are $(-2)$-indices. Then for $i = 1, \ldots, s$
the contribution $m_i(w_i(g_i - 1) - \frac{1}{2} a_{ii})$
to the genus $g$ are $> 0$. Then $w_i(g_i - 1) - \frac{1}{2}a_{ii}$
is $\geq \frac{1}{2}w_i$ and we conclude (via simple arithmetic)
\begin{equation}
\label{equation-bound-one}
i \leq s \Rightarrow
\left(m_i \leq 2g,
\ w_i \leq 2g,
\ -a_{ii} \leq 6g,
\ g_i \leq g\right)
\end{equation}
and
\begin{equation}
\label{equation-bound-non-minus-two}
s \leq g
\end{equation}
For every index $i$ we have $m_i a_{ii} + \sum_{j \not = i} m_ja_{ij} = 0$.
Thus if we have a bound on $|a_{ii}|$, then we also get a bound the nonzero
(and hence positive) $a_{ij}$ as well as $m_j$. Recalling that $w_j$
divides $a_{ij}$, the reader easily shows that
\begin{equation}
\label{equation-intersections-with-one}
(i \leq s\text{ and }a_{ij} > 0) \Rightarrow
\left(a_{ij} \leq 12 g^2,\ m_j \leq 12g^2,\ w_j \leq 12g^2\right).
\end{equation}
(It should be obvious to the reader that we are not trying to get the
best possible inequalities; we just want to show there is some bound.)

\medskip\noindent
At this point we are ready to make some deductions about the
collection of $(-2)$-indices in a numerical type of genus $g$.
Let $n, m_i, a_{ij}, w_i, g_i$ be a numerical type of genus $g$.
We assume that our type is minimal and that we have ordered the
indices such that for some $0 \leq s \leq n$ we have
$1, \ldots, s$ are not $(-2)$-indices and $s + 1, \ldots, n$
are $(-2)$-indices. Let us say two indices $i, j$ {\it meet}
if $a_{ij} > 0$. Let us call a $(-2)$-index $i$ a
{\it boundary index} if it meets a non-$(-2)$-index.
Let us call a $(-2)$-index an {\it interior index}
if it meets only $(-2)$-indices. Earlier we have proved some
bounds on the $m_i, w_i, g_i, a_{ii}$ of non-$(-2)$-indices
and on $m_i$, $w_i$ for boundary indices as well as on
$a_{ij}$ if $i$ is a non-$(-2)$-index. See
(\ref{equation-bound-one}),
(\ref{equation-bound-non-minus-two}), and
(\ref{equation-intersections-with-one}).
Finally, we would like to bound $m_i, w_i, a_{ij}$
and the shape of the graph for interior indices.

\medskip\noindent
What do we know? We know that an interior index can meet at most
$3$ other indices. If an interior index meets $3$ other indices
then we are in the situation of Lemma \ref{lemma-D4}.
Let us call such an index a {\it triple point}. We will see that
there cannot be too many triple points. Before we prove this,
we consider what happens if we have a sequence
$$
\xymatrix{
\bullet \ar@{-}[r] &
\bullet \ar@{-}[r] &
\bullet \ar@{-}[r] &
\bullet
}
$$
of indices $i, j, k, l$ where the middle two ($j, k$) are
interior indices which are not triple points.
This situation is described in Lemma \ref{lemma-four-by-four}.
However, since $j$ and $k$ are interior, we see that the
inequalities given there for $m_j$ and $m_k$ are equalities.







\section{Models}
\label{section-models}

\noindent
In this chapter $R$ will be a discrete valuation ring and $K$ will
be its fraction field. If needed we will denote $\pi \in R$ a
uniformizer and $k = R/(\pi)$ its residue field.

\medskip\noindent
Let $V$ be an algebraic $K$-scheme
(Varieties, Definition \ref{varieties-definition-algebraic-scheme}).
A {\it model} for $V$ will
mean a flat finite type\footnote{Occasionally it is useful to
allow models to be locally of finite type over $R$, but we'll
cross that bridge when we come to it.}
morphism $X \to \Spec(R)$ endowed with
an isomorphism $V \to X_K = X \times_{\Spec(R)} \Spec(K)$. We often
will identify $V$ and the generic fibre $X_K$ of $X$ and
just write $V = X_K$.
The special fibre is $X_k = X \times_{\Spec(R)} \Spec(k)$.
A {\it morphism of models $X \to X'$ for $V$} is
is a morphism $X \to X'$ of schemes over $R$ which induces
the indentity on $V$.

\medskip\noindent
We will say {\it $X$ is a proper model of $V$} if $X$ is a model
of $V$ and the structure morphism $X \to \Spec(R)$ is proper.
Similarly for separated models, smooth models, and add more here.
We will say {\it $X$ is a regular model of $V$} if $X$ is a model
of $V$ and $X$ is a regular scheme.
Similarly for normal models, reduced models, and add more here.

\medskip\noindent
Let $R \subset R'$ be an extension of discrete valuation rings
(More on Algebra, Definition
\ref{more-algebra-definition-extension-discrete-valuation-rings}).
This induces an extension $K \subset K'$ of fraction fields.
Given an algebraic scheme $V$ over $K$, denote $V'$ the
base change $V \times_{\Spec(K)} \Spec(K')$. Then there is
a functor
$$
\text{models for }V\text{ over }R
\longrightarrow
\text{models for }V'\text{ over }R'
$$
sending $X$ to $X \times_{\Spec(R)} \Spec(R')$.

\begin{lemma}
\label{lemma-closure-is-model}
Let $V_1 \to V_2$ be a closed immersion of algebraic schemes over $K$.
If $X_2$ is a model for $V_2$, then the scheme theoretic image
of $V_1 \to X_2$ is a model for $V_1$.
\end{lemma}

\begin{proof}
Using
Morphisms, Lemma \ref{morphisms-lemma-quasi-compact-scheme-theoretic-image} and
Example \ref{morphisms-example-scheme-theoretic-image}
this boils down to the following algebra statement.
Let $A_1$ be a finite type $R$-algebra flat over $R$.
Let $A_1 \otimes_R K \to B_2$ be a surjection. Then
$A_2 = A_1 / \Ker(A_1 \to B_2)$ is a finite type $R$-algebra
flat over $R$ such that $B_2 = A_2 \otimes_R K$.
We omit the detailed proof; use
More on Algebra, Lemma \ref{more-algebra-lemma-dedekind-torsion-free-flat}
to prove that $A_2$ is flat.
\end{proof}

\begin{lemma}
\label{lemma-normalization}
Let $X$ be a model of a geometrically normal variety $V$ over $K$.
Then the normalization $\nu : X^\nu \to X$ is finite and
the base change of $X^\nu$ to the completion $R^\wedge$
is the normalization of the base change of $X$. Moreover, for
each $x \in X^\nu$ the completion of $\mathcal{O}_{X^\nu, x}$
is normal.
\end{lemma}

\begin{proof}
Observe that $R^\wedge$ is a discrete valuation ring
(More on Algebra, Lemma \ref{more-algebra-lemma-completion-dvr}).
Set $Y = X \times_{\Spec(R)} \Spec(R^\wedge)$.
Since $R^\wedge$ is a discrete valuation ring, we see that
$$
Y \setminus Y_k =
Y \times_{\Spec(R^\wedge)} \Spec(K^\wedge) =
V \times_{\Spec(K)} \Spec(K^\wedge)
$$
where $K^\wedge$ is the fraction field of $R^\wedge$.
Since $V$ is geometrically normal, we find that this is
a normal scheme. Hence the first part of the lemma follows from
Resolution of Surfaces, Lemma \ref{resolve-lemma-normalization-completion}.

\medskip\noindent
To prove the second part we may assume $X$ and $Y$ are normal
(by the first part). If $x$ is in the generic fibre, then
$\mathcal{O}_{X, x} = \mathcal{O}_{V, x}$ is a normal local
ring essentially of finite type over a field. Such a ring is
excellent (More on Algebra, Proposition
\ref{more-algebra-proposition-ubiquity-excellent}).
If $x$ is a point of the special fibre with image $y \in Y$, then
$\mathcal{O}_{X, x}^\wedge = \mathcal{O}_{Y, y}^\wedge$
by Resolution of Surfaces, Lemma \ref{resolve-lemma-iso-completions}.
In this case $\mathcal{O}_{Y, y}$ is a excellent normal local domain
by the same reference as before as $R^\wedge$ is excellent.
If $B$ is a excellent local normal domain, then the completion
$B^\wedge$ is normal (as $B \to B^\wedge$ is regular and
More on Algebra, Lemma \ref{more-algebra-lemma-normal-goes-up} applies).
This finishes the proof.
\end{proof}

\begin{lemma}
\label{lemma-regular}
Let $X$ be a model of a smooth curve $C$ over $K$. Then
there exists a resolution of singularities of $X$
and any resolution is a model of $C$.
\end{lemma}

\begin{proof}
We check condition (4) of Lipman's theorem
(Resolution of Surfaces, Theorem \ref{resolve-theorem-resolve}) hold.
This is clear from Lemma \ref{lemma-normalization}
except for the statement that $X^\nu$ has finitely many
singular points. To see this we can use that $R$ is J-2 by
More on Algebra, Proposition \ref{more-algebra-proposition-ubiquity-J-2}
and hence the nonsingular locus is open in $X^\nu$.
Since $X^\nu$ is normal of dimension $\leq 2$, the singular points
are closed, hence closedness of the singular locus
means there are finitely many of them (as $X$ is quasi-compact).
Observe that any resolution of $X$ is a modification of $X$
(Resolution of Surfaces, Definition \ref{resolve-definition-resolution}).
This will be an isomorphism over the normal locus of $X$ by Varieties, Lemma
\ref{varieties-lemma-modification-normal-iso-over-codimension-1}.
Since the set of normal points includes
$C = X_K$ we conclude any resolution is a model of $C$.
\end{proof}

\begin{definition}
\label{definition-minimal-model}
Let $C$ be a smooth projective curve over $K$ with
$H^0(C, \mathcal{O}_C) = K$. A {\it minimal model}
will be a regular, proper model $X$ for $C$ such that
$X$ does not contain an exceptional curve of the first kind
(Resolution of Surfaces, Section \ref{resolve-section-minus-one}).
\end{definition}

\noindent
Really such a thing should be called a minimal regular proper model
or even a relatively minimal regular projective model. But as long
as we stick to models over discrete valuation rings (as we will
in this chapter), no confusion should arise.

\medskip\noindent
Minimal models always exist
(Proposition \ref{proposition-exists-minimal-model}) and are unique
when the genus is $> 0$ (Lemma \ref{lemma-minimal-model-unique}).

\begin{proposition}
\label{proposition-exists-minimal-model}
Let $C$ be a smooth projective curve over $K$ with
$H^0(C, \mathcal{O}_C) = K$. A minimal model exists.
\end{proposition}

\begin{proof}
Choose a closed immersion $C \to \mathbf{P}^n_K$. Let
$X$ be the scheme theoretic image of $C \to \mathbf{P}^n_R$.
Then $X \to \Spec(R)$ is a projective model of $C$ by
Lemma \ref{lemma-closure-is-model}.
By Lemma \ref{lemma-regular} we may assume that $X$
is regular. Observe that $X$ is projective over $R$:
this can be seen either because the resolution is a sequence
of normalized blowups (details omitted) or by applying
Resolution of Surfaces, Lemma \ref{resolve-lemma-regular-dim-2-projective}.

\medskip\noindent
Let $E \subset X$ be an exceptional curve of the first kind.
See Resolution of Surfaces, Section \ref{resolve-section-minus-one}.
Since $\Spec(R)$ is affine and $E \subset X$ is closed and
$X \to \Spec(R)$ is closed, we see that $E \to \Spec(R)$
maps to the closed point. Hence $E \subset X_k$. By
Resolution of Surfaces, Lemma \ref{resolve-lemma-contract-ample}
we can contract $E$ by a morphism $X \to X'$ such that $X'$ is
regular and is projective over $R$. Clearly, the number of
irreducible components of $X'_k$ is exactly one less than the
number of irreducible components of $X_k$. Thus we can only
perform a finite number of these contractions untill we
obtain a minimal model.
\end{proof}





\section{The geometry of a regular model}
\label{section-special-fibre}

\noindent
In this section we describe the geometry of a proper regular model $X$ of a
smooth projective curve $C$ over $K$ with $H^0(C, \mathcal{O}_C) = K$.

\begin{lemma}
\label{lemma-divisor-special-fiber}
Let $X$ be a regular model of a smooth curve $C$ over $K$.
\begin{enumerate}
\item the special fibre $X_k$ is an effective Cartier divisor on $X$,
\item each irreducible component $C_i$ of $X_k$ is an effective
Cartier divisor on $X$,
\item $X_k = \sum m_i C_i$ (sum of effective Cartier divisors)
where $m_i$ is the multiplicity of $C_i$ in $X_k$,
\item $\mathcal{O}_X(X_k) \cong \mathcal{O}_X$.
\end{enumerate}
\end{lemma}

\begin{proof}
Recall that $R$ is a discrete valuation ring with uniformizer $\pi$
and residue field $k = R/(\pi)$. Because $X \to \Spec(R)$ is flat,
the element $\pi$ is a nonzerodivisor affine locally on $X$
(see More on Algebra, Lemma
\ref{more-algebra-lemma-dedekind-torsion-free-flat}). Thus
if $U = \Spec(A) \subset X$ is an affine open, then
$$
X_K \cap U = U_k = \Spec(A \otimes_R k) = \Spec(A/\pi A)
$$
and $\pi$ is a nonzerodivisor in $A$.
Hence $X_k = V(\pi)$ is an effective Cartier divisor by
Divisors, Lemma \ref{divisors-lemma-characterize-effective-Cartier-divisor}.
Hence (1) is true.

\medskip\noindent
The discussion above shows that the pair $(\mathcal{O}_X(X_k), 1)$
is isomorphic to the pair $(\mathcal{O}_X, \pi)$ which proves (4).

\medskip\noindent
By Divisors, Lemma \ref{divisors-lemma-effective-Cartier-divisor-is-a-sum}
there exist pairwise distinct integral effective Cartier divisors
$D_i \subset X$ and integers $a_i \geq 0$ such that $X_k = \sum a_i D_i$.
We can throw out those divisors $D_i$ such that $a_i = 0$. Then it is
clear (from the definition of addition of effective Cartier
divisors) that $X_k = \bigcup D_i$ set theoretically. Thus $C_i = D_i$
are the irreducible components of $X_k$ which proves (2).
Let $\xi_i$ be the generic point of $C_i$.
Then $\mathcal{O}_{X, \xi_i}$ is a discrete valuation ring
(Divisors, Lemma \ref{divisors-lemma-integral-effective-Cartier-divisor-dvr}).
The uniformizer $\pi_i \in \mathcal{O}_{X, \xi_i}$ is a local equation
for $C_i$ and the image of $\pi$ is a local equation for $X_k$.
Since $X_k = \sum a_i C_i$ we see that $\pi$ and $\pi_i^{a_i}$
generate the same ideal in $\mathcal{O}_{X, \xi_i}$.
On the other hand, the multiplicity of $C_i$ in $X_k$ is
$$
m_i = \text{length}_{\mathcal{O}_{C_i, \xi_i}} \mathcal{O}_{X_k, \xi_i} =
\text{length}_{\mathcal{O}_{C_i, \xi_i}} \mathcal{O}_{X, \xi_i}/(\pi) =
\text{length}_{\mathcal{O}_{C_i, \xi_i}} \mathcal{O}_{X, \xi_i}/(\pi_i^{a_i}) =
a_i
$$
See Chow Homology, Definition
\ref{chow-definition-cycle-associated-to-closed-subscheme}.
Thus $a_i = m_i$ and (3) is proved.
\end{proof}

\begin{lemma}
\label{lemma-gorenstein}
Let $X$ be a regular model of a smooth curve $C$ over $K$. Then
\begin{enumerate}
\item $X \to \Spec(R)$ is a Gorenstein morphism of relative dimension $1$,
\item each of the irreducible components $C_i$ of $X_k$ is Gorenstein.
\end{enumerate}
\end{lemma}

\begin{proof}
Since $X \to \Spec(R)$ is flat, to prove (1)
it suffices to show that the fibres are Gorenstein
(Dualizing Complexes, Lemma \ref{dualizing-lemma-gorenstein-morphism}).
The generic fibre is a smooth curve, which is regular and hence Gorenstein
(Dualizing Complexes, Lemma \ref{dualizing-lemma-regular-gorenstein}).
For the special fibre $X_k$ we use that it is an effective
Cartier divisor on a regular (hence Gorenstein) scheme and hence
Gorenstein for example by Dualizing Complexes, Lemma
\ref{dualizing-lemma-gorenstein-divide-by-nonzerodivisor}.
The curves $C_i$ are Gorenstein by the same argument.
\end{proof}

\begin{situation}
\label{situation-regular-model}
Let $R$ be a discrete valuation ring with fraction field $K$,
residue field $k$, and uniformizer $\pi$.
Let $C$ be a smooth projective curve over $K$ with $H^0(C, \mathcal{O}_C) = K$.
Let $X$ be a regular proper model of $C$.
Let $C_1, \ldots, C_n$ be the irreducible components of the special
fibre $X_k$. Write $X_k = \sum m_i C_i$ as in
Lemma \ref{lemma-divisor-special-fiber}.
\end{situation}

\begin{lemma}
\label{lemma-regular-model-connected}
In Situation \ref{situation-regular-model} the special fibre $X_k$ is connected.
\end{lemma}

\begin{proof}
Consequence of More on Morphisms, Lemma
\ref{more-morphisms-lemma-geometrically-connected-fibres-towards-normal}.
\end{proof}

\begin{lemma}
\label{lemma-regular-model-pic}
In Situation \ref{situation-regular-model} there is an exact sequence
$$
0 \to \mathbf{Z} \to \mathbf{Z}^{\oplus n} \to
\text{Pic}(X) \to \text{Pic}(C) \to 0
$$
where the first map sends $1$ to $(m_1, \ldots, m_n)$ and the second
maps sends the $i$th basis vector to $\mathcal{O}_X(C_i)$.
\end{lemma}

\begin{proof}
Observe that $C \subset X$ is an open subscheme. The restriction
map $\text{Pic}(X) \to \text{Pic}(C)$ is surjective by
Divisors, Lemma \ref{divisors-lemma-extend-invertible-module}.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module
such that there is an isomorphism $s : \mathcal{O}_C \to \mathcal{L}|_C$.
Then $s$ is a regular meromorphic section of $\mathcal{L}$
and we see that $\text{div}_\mathcal{L}(s) = \sum a_i C_i$
for some $a_i \in \mathbf{Z}$
(Divisors, Definition \ref{divisors-definition-divisor-invertible-sheaf}).
By Divisors, Lemma \ref{divisors-lemma-normal-c1-injective}
(and the fact that $X$ is normal)
we conclude that $\mathcal{L} = \mathcal{O}_X(\sum a_iC_i)$.
Finally, suppose that $\mathcal{O}_X(\sum a_i C_i) \cong \mathcal{O}_X$.
Then there exists an element $g$ of the function field of $X$
with $\text{div}_X(g) = \sum a_i C_i$. In particular the rational
function $g$ has no zeros or poles on the generic fibre $C$ of $X$.
Since $C$ is a normal scheme this implies $g \in H^0(C, \mathcal{O}_C) = K$.
Thus $g = \pi^a u$ for some $a \in \mathbf{Z}$ and $u \in R^*$.
We conclude that $\text{div}_X(g) = a \sum m_i C_i$ and the proof
is complete.
\end{proof}

\noindent
In Situation \ref{situation-regular-model} for every invertible
$\mathcal{O}_X$-module $\mathcal{L}$ and every $i$ we get an integer
$$
\deg(\mathcal{L}|_{C_i}) =
\chi(C_i, \mathcal{L}|_{C_i}) - \chi(C_i, \mathcal{O}_{C_i})
$$
by taking the degree of the restriction of $\mathcal{L}$ to $C_i$
relative to the ground field $k$\footnote{Observe that it may happen
that the field $\kappa_i = H^0(C_i, \mathcal{O}_{C_i})$ is strictly bigger
than $k$. In this case every invertible module on $C_i$ has
degree (as defined above) divisible by $[\kappa_i : k]$.}
as in Varieties, Section \ref{varieties-section-divisors-curves}.

\begin{lemma}
\label{lemma-intersection-pairing}
In Situation \ref{situation-regular-model} given $\mathcal{L}$ an invertible
$\mathcal{O}_X$-module and
$a = (a_1, \ldots, a_n) \in \mathbf{Z}^{\oplus n}$ we define
$$
\langle a, \mathcal{L} \rangle = \sum a_i\deg(\mathcal{L}|_{C_i})
$$
Then $\langle , \rangle$ is bilinear and for
$b = (b_1, \ldots, b_n) \in \mathbf{Z}^{\oplus n}$ we have
$$
\left\langle a, \mathcal{O}_X(\sum b_i C_i) \right\rangle =
\left\langle b, \mathcal{O}_X(\sum a_i C_i) \right\rangle
$$
\end{lemma}

\begin{proof}
Bilinearity is immediate from the definition and
Varieties, Lemma \ref{varieties-lemma-degree-tensor-product}.
To prove symmetry it suffices to assume $a$ and $b$ are
standard basis vectors in $\mathbf{Z}^{\oplus n}$.
Hence it suffices to prove that
$$
\deg(\mathcal{O}_X(C_j)|_{C_i}) = \deg(\mathcal{O}_X(C_i)|_{C_j})
$$
for all $1 \leq i, j \leq n$. If $i = j$ there is nothing to prove.
If $i \not = j$, then the canonical section $1$ of $\mathcal{O}_X(C_j)$
restricts to a nonzero (hence regular) section of $\mathcal{O}_X(C_j)|_{C_i}$
whose zero scheme is exactly $C_i \cap C_j$ (scheme theoretic intersection).
In other words, $C_i \cap C_j$ is an effective Cartier divisor on $C_i$
and
$$
\deg(\mathcal{O}_X(C_j)|_{C_i}) = \deg(C_i \cap C_j)
$$
by Varieties, Lemma \ref{varieties-lemma-degree-effective-Cartier-divisor}.
By symmetry we obtain the same (!) formula for the other side
and the proof is complete.
\end{proof}

\noindent
In Situation \ref{situation-regular-model} it is often convenient to think
of $\mathbf{Z}^{\oplus n}$ as the free abelian group on the set
$\{C_1, \ldots, C_n\}$. We will indicate an element of this group
as $\sum a_i C_i$; here we think of this as a formal sum although
equivalently we may (and we sometimes do)
think of such a sum as a Weil divisor on $X$
supported on the special fibre $X_k$. Now
Lemma \ref{lemma-intersection-pairing}
allows us to define a symmetric bilinear form $(\ \cdot\ )$
on this free abelian group by the rule
\begin{equation}
\label{equation-form}
\left(\sum a_i C_i \cdot \sum b_j C_j\right) =
\left\langle a, \mathcal{O}_X(\sum b_j C_j) \right\rangle =
\left\langle b, \mathcal{O}_X(\sum a_i C_i) \right\rangle
\end{equation}
We will prove some properties of this bilinear form.

\begin{lemma}
\label{lemma-properties-form}
In Situation \ref{situation-regular-model} the symmetric bilinear form
(\ref{equation-form}) has the following properties
\begin{enumerate}
\item $(C_i \cdot C_j) \geq 0$ if $i \not = j$ with equality if and only
if $C_i \cap C_j = \emptyset$,
\item $(\sum m_i C_i \cdot C_j) = 0$,
\item there is no nonempty proper subset $I \subset \{1, \ldots, n\}$
such that $(C_i \cdot C_j) = 0$ for $i \in I$, $j \not \in I$.
\item $(\sum a_i C_i \cdot \sum a_i C_i) \leq 0$ with equality if and
only if there exists a $q \in \mathbf{Q}$ such that $a_i = qm_i$
for $i = 1, \ldots, n$,
\end{enumerate}
\end{lemma}

\begin{proof}
In the proof of Lemma \ref{lemma-intersection-pairing} we saw that
$(C_i \cdot C_j) = \deg(C_i \cap C_j)$ if $i \not = j$. This is
$\geq 0$ and $> 0 $ if and only if $C_i \cap C_j \not = \emptyset$.
This proves (1).

\medskip\noindent
Proof of (2). This is true because by Lemma \ref{lemma-divisor-special-fiber}
the invertible sheaf associated to $\sum m_i C_i$
is trivial and the trivial sheaf has degree zero.

\medskip\noindent
Proof of (3). This is expressing the fact that $X_k$ is connected
(Lemma \ref{lemma-regular-model-connected})
via the description of the intersection products given in the proof of (1).

\medskip\noindent
Part (4) follows from (1), (2), and (3) by
Lemma \ref{lemma-recurring-symmetric-real}.
\end{proof}

\begin{lemma}
\label{lemma-multiple-fibre-normal-bundle}
In Situation \ref{situation-regular-model} set $d = \gcd(m_1, \ldots, m_n)$
and let $D = \sum (m_i/d)C_i$ as an effective Cartier divisor.
Then $\mathcal{O}_X(D)$ has order dividing $d$ in $\text{Pic}(X)$
and $\mathcal{C}_{D/X}$ an invertible $\mathcal{O}_D$-module
of order dividing $d$ in $\text{Pic}(D)$.
\end{lemma}

\begin{proof}
We have
$$
\mathcal{O}_X(D)^{\otimes d} = \mathcal{O}_X(dD) =
\mathcal{O}_X(X_k) = \mathcal{O}_X
$$
by Lemma \ref{lemma-divisor-special-fiber}.
We conclude as $\mathcal{C}_{D/X}$ is the pullback of
$\mathcal{O}_X(-D)$.
\end{proof}

\begin{lemma}
\label{lemma-regular-model-field}
\begin{reference}
\cite[Lemma 2.6]{Artin-Winters}
\end{reference}
In Situation \ref{situation-regular-model} let $d = \gcd(m_1, \ldots, m_n)$.
Let $D = \sum (m_i/d) C_i$ as an effective Cartier divisor. Then
$H^0(D, \mathcal{O}_D)$ is a field finite over $k$.
\end{lemma}

\begin{proof}
The reduction $D_{red} = (X_k)_{red} = \sum C_i$ is connected
(Lemma \ref{lemma-regular-model-connected}) and proper over $k$. Hence
$H^0(D_{red}, \mathcal{O})$ is a field and a finite extension of
$k$ by Varieties, Lemma
\ref{varieties-lemma-proper-geometrically-reduced-global-sections}.
Suppose that we have an effective Cartier divisor $Z = \sum a_i C_i$
with $1 \leq a_i \leq m_i/d$ such that the map
$H^0(\mathcal{O}_Z)$ is a field and a finite extension of $k$.
If $a_i < m_i/d$ for some $i$, then $(Z \cdot Z) < 0$
by Lemma \ref{lemma-properties-form}. This means that
$(D - Z \cdot Z) > 0$ because $(D \cdot Z) = 0$ by the lemma.
Thus we can find an $i$ with $a_i < m_i$ such that
$(C_i \cdot Z) > 0$. Set $Z' = Z + C_i$ as effective Cartier divisor on $X$.
Consider the short exact sequence
$$
0 \to \mathcal{O}_X(-Z)|_{C_i} \to \mathcal{O}_{Z'} \to \mathcal{O}_Z \to 0
$$
of Divisors, Lemma \ref{divisors-lemma-ses-add-divisor}.
By our choice of $i$ we see that
$\mathcal{O}_X(-Z)|_{C_i}$ is an invertible sheaf of negative degree
on the proper curve $C_i$, hence it has no nonzero global sections
(Varieties, Lemma \ref{varieties-lemma-check-invertible-sheaf-trivial}).
We conclude that $H^0(\mathcal{O}_{Z'}) \subset H^0(\mathcal{O}_Z)$
is a field (this is clear but also follows from
Algebra, Lemma \ref{algebra-lemma-integral-under-field})
and a finite extension of $k$. Thus by induction on $\sum a_i$
we conclude that the same is true for $D$.
\end{proof}

\begin{lemma}
\label{lemma-regular-model-genus}
\begin{reference}
\cite[Lemma 2.6]{Artin-Winters}
\end{reference}
In Situation \ref{situation-regular-model} let $d = \gcd(m_1, \ldots, m_n)$.
Let $D = \sum (m_i/d) C_i$ as an effective Cartier divisor on $X$. Then
$$
1 - g_C = d [\kappa : k] (1 - g_D)
$$
where $g_C$ is the genus of $C$, $g_D$ is the genus of $D$, and
$\kappa = H^0(D, \mathcal{O}_D)$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-regular-model-field} we see that $\kappa$ is a field
and a finite extension of $k$. Since also $H^0(C, \mathcal{O}_C) = K$
we see that the genus of $C$ and $D$ are defined (see
Algebraic Curves, Definition \ref{curves-definition-genus}) and
we have $g_C = \dim_K H^1(C, \mathcal{O}_C)$ and
$g_D = \dim_\kappa H^1(D, \mathcal{O}_D)$.
By Derived Categories of Schemes, Lemma
\ref{perfect-lemma-chi-locally-constant-geometric}
we have
$$
1 - g_C = \chi(C, \mathcal{O}_C) =
\chi(X_k, \mathcal{O}_{X_k}) = \dim_k H^0(X_k, \mathcal{O}_{X_k})
- \dim_k H^1(X_k, \mathcal{O}_{X_k})
$$
We claim that
$$
\chi(X_k, \mathcal{O}_{X_k}) = d \chi(D, \mathcal{O}_D)
$$
This will prove the lemma because
$$
\chi(D, \mathcal{O}_D) =
\dim_k H^0(D, \mathcal{O}_D) - \dim_k H^1(D, \mathcal{O}_D) =
[\kappa : k](1 - g_D)
$$
Observe that $X_k = dD$ as an effective Cartier divisor.
To prove the claim we prove by induction on $1 \leq r \leq d$ that
$\chi(rD, \mathcal{O}_{rD}) = r \chi(D, \mathcal{O}_D)$.
The base case $r = 1$ is trivial. If $1 \leq r < d$, then we consider
the short exact sequence
$$
0 \to \mathcal{O}_X(rD)|_D \to \mathcal{O}_{(r + 1)D} \to
\mathcal{O}_{rD} \to 0
$$
of Divisors, Lemma \ref{divisors-lemma-ses-add-divisor}. By additivity
of Euler characteristics
(Varieties, Lemma \ref{varieties-lemma-euler-characteristic-additive})
it suffices to prove that
$\chi(D, \mathcal{O}_X(rD)|_D) = \chi(D, \mathcal{O}_D)$.
This is true because $\mathcal{O}_X(rD)|_D$ is a torsion
element of $\text{Pic}(D)$ (Lemma \ref{lemma-multiple-fibre-normal-bundle})
and because the degree of a line bundle is additive
(Varieties, Lemma \ref{varieties-lemma-degree-tensor-product})
hence zero for torsion invertible sheaves.
\end{proof}

\begin{lemma}
\label{lemma-exceptional-curves-dont-meet}
In Situation \ref{situation-regular-model} given a pair of indices $i, j$
such that $C_i$ and $C_j$ are exceptional curves of the first kind
and $C_i \cap C_j \not = \emptyset$, then
$n = 2$, $m_1 = m_2 = 1$, $C_1 \cong \mathbf{P}^1_k$,
$C_2 \cong \mathbf{P}^1_k$, $C_1$ and $C_2$ meet in a $k$-rational point,
and $C$ has genus $0$.
\end{lemma}

\begin{proof}
Choose isomorphisms $C_i = \mathbf{P}^1_{\kappa_i}$ and
$C_j = \mathbf{P}^1_{\kappa_j}$. The scheme $C_i \cap C_j$
is a nonempty effective Cartier divisor in both $C_i$ and $C_j$.
Hence
$$
(C_i \cdot C_j) = \deg(C_i \cap C_j) \geq \max([\kappa_i: k], [\kappa_j : k])
$$
The first equality was shown in the proof of
Lemma \ref{lemma-intersection-pairing}.
On the other hand, the self intersection $(C_i \cdot C_i)$ is equal
to the degree of $\mathcal{O}_X(C_i)$ on $C_i$ which is $-[\kappa_i : k]$
as $C_i$ is an exceptional curve of the first kind. Similarly for
$C_j$. By Lemma \ref{lemma-properties-form}
$$
0 \geq (C_i + C_j)^2 = -[\kappa_i : k] + 2(C_i \cdot C_j) - [\kappa_j : k]
$$
This implies that $[\kappa_i : k] = \deg(C_i \cap C_j) = [\kappa_j : k]$
and that we have $(C_i + C_j)^2 = 0$. Looking at the lemma again
we conclude that $n = 2$, $\{1, 2\} = \{i, j\}$, and $m_1 = m_2$.
Moreover, the scheme theoretic intersection $C_i \cap C_j$ consists of
a single point $p$ with residue field $\kappa$ and
$\kappa_i \to \kappa \leftarrow \kappa_j$ are isomorphisms.
Let $D = C_1 + C_2$ as effective Cartier divisor on $X$.
Observe that $D$ is the scheme theoretic union of $C_1$ and $C_2$
(Divisors, Lemma \ref{divisors-lemma-sum-effective-Cartier-divisors-union})
hence we have a short exact sequence
$$
0 \to \mathcal{O}_D \to \mathcal{O}_{C_1} \oplus \mathcal{O}_{C_2} \to
\mathcal{O}_p \to 0
$$
by Morphisms, Lemma \ref{morphisms-lemma-scheme-theoretic-union}.
Since we know the cohomology of $C_i \cong \mathbf{P}^1_\kappa$
(Cohomology of Schemes, Lemma
\ref{coherent-lemma-cohomology-projective-space-over-ring})
we conclude from the long exact cohomology sequence that
$H^0(D, \mathcal{O}_D) = \kappa$ and
$H^1(D, \mathcal{O}_D) = 0$. By Lemma \ref{lemma-regular-model-genus}
we conclude
$$
1 - g_C = d[\kappa : k](1 - 0)
$$
where $d = m_1 = m_2$. It follows that $g_C = 0$ and $d = m_1 = m_2 = 1$
and $\kappa = k$.
\end{proof}





\section{Uniqueness of the minimal model}
\label{section-uniqueness}

\noindent
If the genus of the generic fibre is positive, then minimal models are unique
(Lemma \ref{lemma-minimal-model-unique}) and consequently have a suitable
mapping property (Lemma \ref{lemma-minimal-model-mapping-property}).

\begin{lemma}
\label{lemma-minimal-model-unique}
Let $C$ be a smooth projective curve over $K$ with
$H^0(C, \mathcal{O}_C) = K$ and genus $> 0$.
There is a unique minimal model for $C$.
\end{lemma}

\begin{proof}
We have already proven the hard part of the lemma which is the existence
of a minimal model (whose proof relies on
resolution of surface singularities), see
Proposition \ref{proposition-exists-minimal-model}.
To prove uniqueness, suppose that $X$ and $Y$ are two
minimal models. By
Resolution of Surfaces, Lemma \ref{resolve-lemma-birational-regular-surfaces}
there exists a diagram of $S$-morphisms
$$
X = X_0 \leftarrow X_1 \leftarrow \ldots \leftarrow X_n = Y_m
\to \ldots \to Y_1 \to Y_0 = Y
$$
where each morphism is a blowup in a closed point. The
exceptional fibre of the morphism $X_n \to X_{n - 1}$ is an
exceptional curve of the first kind $E$. We claim that $E$ is
contracted to a point under the morphsm $X_n = Y_m \to Y$.
If this is true, then $X_n \to Y$ factors through $X_{n - 1}$ by
Resolution of Surfaces, Lemma \ref{resolve-lemma-factor-through-contraction}.
In this case the morphism $X_{n - 1} \to Y$ is still a sequence of
contractions of exceptional curves by
Resolution of Surfaces, Lemma
\ref{resolve-lemma-proper-birational-regular-surfaces}.
Hence by induction on $n$ we conclude. (The base case $n = 0$ means
that there is a sequence of contractions
$X = Y_m \to \ldots \to Y_1 \to Y_0 = Y$
ending with $Y$. However as $X$ is a minimal model it contains
no exceptional curves of the first kind, hence $m = 0$ and $X = Y$.)

\medskip\noindent
Proof of the claim. We will show by induction on $m$ that any exceptional
curve of the first kind $E \subset Y_m$ is mapped to a point
by the morphism $Y_m \to Y$. If $m = 0$ this is clear because
$Y$ is a minimal model. If $m > 0$, then either
$Y_m \to Y_{m - 1}$ contracts $E$ (and we're done) or
the exceptional fibre $E' \subset Y_m$ of $Y_m \to Y_{m - 1}$
is a second exceptional curve of the first kind.
Since both $E$ and $E'$ are irreducible components of the special
fibre and since $g_C > 0$ by assumption, we conclude that
$E \cap E' = \emptyset$ by
Lemma \ref{lemma-exceptional-curves-dont-meet}.
Then the image of $E$ in $Y_{m - 1}$ is an exceptional
curve of the first kind (this is clear because the morphism
$Y_m \to Y_{m - 1}$ is an isomorphism in a neighbourhood of $E$).
By induction we see that $Y_{m - 1} \to Y$ contracts this curve
and the proof is complete.
\end{proof}

\begin{lemma}
\label{lemma-minimal-model-mapping-property}
Let $C$ be a smooth projective curve over $K$ with $H^0(C, \mathcal{O}_C) = K$
and genus $> 0$. Let $X$ be the minimal model for $C$
(Lemma \ref{lemma-minimal-model-unique}).
Let $Y$ be a regular proper model for $C$. Then there is a unique
morphism of models $Y \to X$ which is a sequence of contractions of
exceptional curves of the first kind.
\end{lemma}

\begin{proof}
We prove there is a sequence of contractions of exceptional curves
of the first kind by induction on the number of irreducible components
of $Y_k$. If $Y$ contains no exceptional curves of the first kind,
then $Y$ is a minimal model and hence isomorphic to $X$. If $Y$
does contain an exceptional curve of the first kind, then let
$Y \to Y'$ be its contraction. See
Resolution of Surfaces, Lemma \ref{resolve-lemma-contract-ample}
and note that $Y'$ is regular and is projective over $R$.
Because the number of irreducible components of $Y'_k$ is one
less than the number of irreducible components of $Y_k$, we
find a morphism $Y' \to X$ which is a
sequence of contractions of exceptional curves of the first kind
by induction hypothesis. The morphism $Y \to X$ is unique because
$C \subset Y$ is scheme theoretically dense and $X$ is separated
(see Morphisms, Lemma \ref{morphisms-lemma-equality-of-morphisms}).
\end{proof}

\begin{example}
\label{example-nonunique-in-genus-zero}
If the genus of $C$ is $0$, then minimal models are indeed nonunique.
Namely, consider the closed subscheme
$$
X \subset \mathbf{P}^2_R
$$
defined by $T_1T_2 - \pi T_0^2 = 0$. More precisely $X$ is defined
as $\text{Proj}(R[T_0, T_1, T_2]/(T_1T_2 - \pi T_0^2))$. Then the
special fibre $X_k$ is a union of two exceptional curves $C_1$, $C_2$ both
isomorphic to $\mathbf{P}^1_k$
(exactly as in Lemma \ref{lemma-exceptional-curves-dont-meet}).
Projection from $(0 : 1 : 0)$ defines a morphism $X \to \mathbf{P}^1_R$
contracting $C_2$ and inducing an isomorphism of $C_1$ with the special
fiber of $\mathbf{P}^1_R$. Projection from $(0 : 0 : 1)$ defines a
morphism $X \to \mathbf{P}^1_R$ contracting $C_1$ and inducing an
isomorphism of $C_2$ with the special fiber of $\mathbf{P}^1_R$.
More precisely, these morphisms correspond to the graded $R$-algebra
maps
$$
R[T_0, T_1] \longrightarrow
R[T_0, T_1, T_2]/(T_1T_2 - \pi T_0^2) \longleftarrow
R[T_0, T_2]
$$
\end{example}

\noindent
The following lemma tells us what happens with the intersection
numbers when we blow up a regular proper model.

\begin{lemma}
\label{lemma-blowup-regular-model}
In Situation \ref{situation-regular-model} let $x \in X$ be a closed point.
Let $b : X' \to X$ be the blowup of $X$ at $x$. Let $E \subset X'$
be the exceptional fibre and let $C_i'$ be the strict transform of $C_i$.
Write $X'_k = \sum m'_i C'_i + m_E E$. Then
\begin{enumerate}
\item there exist integers $e_i \geq 0$ such that
$(C_i \cdot C_j) = (C'_i \cdot C'_j) + e_i (E \cdot C'_j)$,
\item $m'_i = m_i$ and $m_E = \sum e_i$ and
$e_i = 0 \Leftrightarrow x \not \in C_i$,
\item $(C_i \cdot C_j) \leq (C'_i \cdot C'_j)$ with equality if and
only if
$x \not \in C_i \cup C_j$.
\end{enumerate}
\end{lemma}

\begin{proof}
Since $b$ defines an isomorphism $X' \setminus E \to X \setminus \{x\}$
it is clear that $m_i = m'_i$.
By Divisors, Lemma \ref{divisors-lemma-blow-up-pullback-effective-Cartier}
the pullback $b^{-1}C_i$ is defined. By
Divisors, Lemma \ref{divisors-lemma-effective-Cartier-divisor-is-a-sum}
we see that $b^{-1}C_i = C'_i + e_i E$ for some $e_i \geq 0$.
It is immediate that $e_i$ is zero if and only if $x \not \in C_i$.
As $b_j = b|_{C'_j} : C'_j \to C_j$ is a
proper birational morphism of proper curves
over $k$, we see that $\deg_{C_j}(\mathcal{O}_X(C_i)|_{C_j})$ is the
same as $\deg_{C'_j}(b_j^*\mathcal{O}_X(C_i)|_{C_j})$
(Varieties, Lemma \ref{varieties-lemma-degree-birational-pullback}).
Looking at the commutative diagram
$$
\xymatrix{
C'_j \ar[r] \ar[d]_{b_j} & X' \ar[d]^b \\
C_j \ar[r] & X
}
$$
and using Divisors, Lemma
\ref{divisors-lemma-pullback-effective-Cartier-divisors}
we see that
$$
(C_i \cdot C_j) = \deg_{C_j}(\mathcal{O}_X(C_i)|_{C_j}) =
\deg_{C'_j}(\mathcal{O}_X(C'_i + e_i E)) = (C'_i + e_i E \cdot C'_j)
$$
in other words (1) holds. Since $X_k$ and $X'_k$ are the
effective Cartier divisors
cut out by a uniformizer $\pi \in R$ we see that $b^{-1}X_k = X'_k$.
Using our formula above we see that
$$
X'_k = b^{-1}X_k = \sum m_i b^{-1}C_i = \sum m_iC'_i + (\sum e_i) E
$$
which proves that $m_E = \sum e_i$. Thus (2) is true. The inequality
in part (3) follows from part (1) as $(E \cdot C'_j) \geq 0$ by
Lemma \ref{lemma-properties-form}. On the other hand, the term
$e_i(E \cdot C'_j) = e_i \deg(E \cap C'_j)$
is zero if and only if $e_i = 0$ or $C'_j$ does not meet $E$.
And of course $C'_j \cap E = \emptyset \Leftrightarrow x \not \in C_j$.
\end{proof}






\section{A formula for the genus}
\label{section-genus-formula}

\noindent
There is one more restriction on the combinatorial structure
coming from a proper regular model.

\begin{lemma}
\label{lemma-add-component}
In Situation \ref{situation-regular-model} suppose we have an
effective Cartier divisors $D, D' \subset X$ such that
$D' = D + C_i$ for some $i \in \{1, \ldots, n\}$ and $D' \subset X_k$.
Then
$$
\chi(X_k, \mathcal{O}_{D'}) - \chi(X_k, \mathcal{O}_D) =
\chi(X_k, \mathcal{O}_X(-D)|_{C_i}) =
-(D \cdot C_i) + \chi(C_i, \mathcal{O}_{C_i})
$$
\end{lemma}

\begin{proof}
The second equality follows from the definition of the bilinear form
$(\ \cdot\ )$ in (\ref{equation-form}) and
Lemma \ref{lemma-intersection-pairing}. To see the first
equality we distinguish two cases.
Namely, if $C_i \not \subset D$, then $D'$ is the scheme
theoretic union of $D$ and $C_i$ (by
Divisors, Lemma \ref{divisors-lemma-sum-effective-Cartier-divisors-union})
and we get a short exact sequence
$$
0 \to \mathcal{O}_{D'} \to
\mathcal{O}_D \times \mathcal{O}_{C_i} \to
\mathcal{O}_{D \cap C_i} \to 0
$$
by Morphisms, Lemma \ref{morphisms-lemma-scheme-theoretic-union}.
Since we also have an exact sequence
$$
0 \to \mathcal{O}_X(-D)|_{C_i} \to
\mathcal{O}_{C_i} \to \mathcal{O}_{D \cap C_i} \to 0
$$
(Divisors, Remark \ref{divisors-remark-ses-regular-section})
we conclude that the claim holds
by additivity of euler characteristics
(Varieties, Lemma \ref{varieties-lemma-euler-characteristic-additive}).
On the other hand, if $C_i \subset D$ then we get an
exact sequence
$$
0 \to \mathcal{O}_X(-D)|_{C_i} \to \mathcal{O}_{D'} \to \mathcal{O}_D \to 0
$$
by Divisors, Lemma \ref{divisors-lemma-ses-add-divisor}
and we immediately see the lemma holds.
\end{proof}

\begin{lemma}
\label{lemma-genus-formula}
In Situation \ref{situation-regular-model} we have
$$
g_C = 1 + \sum\nolimits_{i = 1, \ldots, n}
m_i\left([\kappa_i : k] (g_i - 1) - \frac{1}{2}(C_i \cdot C_i)\right)
$$
where $\kappa_i = H^0(C_i, \mathcal{O}_{C_i})$ and
$g_i$ is the genus of $C_i$.
\end{lemma}

\begin{proof}
Our basic tool will be Derived Categories of Schemes, Lemma
\ref{perfect-lemma-chi-locally-constant-geometric}
which shows that
$$
1 - g_C = \chi(C, \mathcal{O}_C) =
\chi(X_k, \mathcal{O}_{X_k})
$$
Choose a sequence of effective Cartier divisors
$$
X_k = D_m \supset D_{m - 1} \supset \ldots \supset D_1 \supset D_0 = \emptyset
$$
such that $D_{j + 1} = D_j + C_{i_j}$ for each $j$. (It is clear that
we can choose such a sequence by decreasing one nonzero multiplicity
of $D_{j + 1}$ one step at a time.) Applying Lemma \ref{lemma-add-component}
starting with $\chi(\mathcal{O}_{D_0}) = 0$ we get
\begin{align*}
1 - g_C
& =
\chi(X_k, \mathcal{O}_{X_k}) \\
& =
\sum\nolimits_j
\left(-(D_j \cdot C_{i_j}) +  \chi(C_{i_j}, \mathcal{O}_{C_{i_j}})\right) \\
& =
- \sum\nolimits_j
(C_{i_1} + C_{i_2} + \ldots + C_{i_{j - 1}} \cdot C_{i_j}) +
\sum\nolimits_j \chi(C_{i_j}, \mathcal{O}_{C_{i_j}}) \\
& =
-\frac{1}{2}\sum\nolimits_{j \not = j'} (C_{i_{j'}} \cdot C_{i_j}) +
\sum m_i \chi(C_i, \mathcal{O}_{C_i}) \\
& =
\frac{1}{2} \sum m_i(C_i \cdot C_i) + \sum m_i \chi(C_i, \mathcal{O}_{C_i})
\end{align*}
Perhaps the last equality deserves some explanation. Namely, since
$\sum_j C_{i_j} = \sum m_i C_i$ we have
$(\sum_j C_{i_j} \cdot \sum_j C_{i_j}) = 0$ by
Lemma \ref{lemma-properties-form}. Thus we see that
$$
0 = \sum\nolimits_{j \not = j'} (C_{i_{j'}} \cdot C_{i_j}) +
\sum m_i(C_i \cdot C_i)
$$
by splitting this product into ``nondiagonal'' and ``diagonal'' terms.
Note that $\kappa_i$ is a field finite over $k$ by
Varieties, Lemma \ref{varieties-lemma-regular-functions-proper-variety}.
Hence the genus of $C_i$ is defined and we have
$\chi(C_i, \mathcal{O}_{C_i}) = [\kappa_i : k](1 - g_i)$.
Putting everything together and rearranging terms we get
$$
g_C = - \frac{1}{2}\sum m_i(C_i \cdot C_i) +
\sum m_i[\kappa_i : k](g_i - 1) + 1
$$
which is what the lemma says too.
\end{proof}

\begin{lemma}
\label{lemma-inequalities}
In Situation \ref{situation-regular-model} assume $n > 0$. The expression
$[\kappa_i : k](g_i - 1) - \frac{1}{2}(C_i \cdot C_i)$
occuring in Lemma \ref{lemma-genus-formula} is
\begin{enumerate}
\item negative only if equal to $-\frac{1}{2}[\kappa_i : k]$
and in this case $C_i$ is an exceptional curve of the first kind,
\item $\geq 0$ if $X$ is a minimal model,
\item $= 0$ if and only if $g_i = 0$ and $(C_i \cdot C_i) = -2[\kappa_i : k]$.
\end{enumerate}
\end{lemma}

\begin{proof}
Recall that $(C_i \cdot C_i)$ is $\leq 0$ with equality if and only
$X_k = m_1 C_1$ which cannot happen as we assumed $n > 1$.
Hence the expression is $> 0$ if $g_i > 0$. From now on assume $g_i = 0$.
Write $w_i = [\kappa_i : k]$. Since $(C_i \cdot C_i)$ is divisible by $w_i$
we conclude that $w_i(g_i - 1) - \frac{1}{2}(C_i \cdot C_i)$ is
contained in $\frac{1}{2}w_i\mathbf{Z}$ and is $\geq - \frac{1}{2} w_i$.
Thus the value is negative if and only if it is equal to $-\frac{1}{2}w_i$
and in this case $(C_i \cdot C_i) = -w_i$. Then $C_i$ is a proper
Gorenstein curve of genus $0$ over $\kappa_i$ whose normal sheaf
$\mathcal{N}_{C_i/X} = \mathcal{O}_X(C_i)|_{C_i}$ is an
invertible module of degree relative to $\kappa_i$ equal to $-1$.
This implies that $C_i \cong \mathbf{P}^1_{\kappa_i}$ by
Algebraic Curves, Proposition \ref{curves-proposition-projective-line}.
We conclude that $C_i$ is an exceptional curve of the first kind.
This proves (1).

\medskip\noindent
Part (2) follows from the definition of a minimal model.

\medskip\noindent
It is also clear from the discussion above that the value is zero only if
$g_i = 0$ and $(C_i \cdot C_i) = -2w_i$. This proves (3).
\end{proof}






\section{Dualizing modules on regular proper models}
\label{section-dualizing}

\noindent
In Situation \ref{situation-regular-model} we let
$\omega_{X/R}^\bullet = f^!\mathcal{O}_{\Spec(R)}$
be the relative dualizing complex of $f : X \to \Spec(R)$
as introduced in
Dualizing Complexes, Remark \ref{dualizing-remark-relative-dualizing-complex}.
Since $f$ is Gorenstein of relative dimension $1$
by Lemma \ref{lemma-gorenstein} we can use
Dualizing Complexes, Lemmas
\ref{dualizing-lemma-affine-flat-Noetherian-gorenstein},
\ref{dualizing-lemma-CM-shriek}, and
\ref{dualizing-lemma-gorenstein-CM-morphism}
to see that
$$
\omega_{X/R}^\bullet = \omega_X[1]
$$
for some invertible $\mathcal{O}_X$-module $\omega_X$.
This invertible module is often called the
{\it relative dualizing module of $X$ over $R$}.
Since $R$ is regular (hence Gorenstein) of dimension $1$
we see that $\omega_R^\bullet = R[1]$ is a
normalized dualizing complex for $R$. Hence
$\omega_X = H^{-2}(f^!\omega_R^\bullet)$ and we
see that $\omega_X$ is not just a relative dualizing module
but also a dualizing module, see
Dualizing Complexes, Example \ref{dualizing-example-proper-over-local}.
Thus $\omega_X$ represents the functor
$$
\textit{Coh}(\mathcal{O}_X) \to \textit{Sets},\quad
\mathcal{F} \mapsto \Hom_R(H^1(X, \mathcal{F}), R)
$$
by Dualizing Complexes, Lemma
\ref{dualizing-lemma-dualizing-module-proper-over-A}.
This gives an alternative definition of the relative
dualizing module in Situation \ref{situation-regular-model}.
The formation of $\omega_X$ commutes with arbitrary base change
(for any proper Gorenstein morphism of given relative dimension);
this follows from the corresponding fact for the relative dualizing
complex discussed in
Dualizing Complexes, Remark \ref{dualizing-remark-relative-dualizing-complex}
which goes back to
Dualizing Complexes, Lemma \ref{dualizing-lemma-proper-flat-base-change}.
Thus $\omega_X$ pulls back to the dualizing module $\omega_C$ of $C$ over $K$
discussed in Algebraic Curves, Lemma \ref{curves-lemma-duality-dim-1-CM}.
Note that $\omega_C$ is isomorphic to $\Omega_{C/K}$ by
Algebraic Curves, Lemma \ref{curves-lemma-duality-dim-1}.
Similarly $\omega_X|_{X_k}$ is the dualizing module $\omega_{X_k}$
of $X_k$ over $k$.

\begin{lemma}
\label{lemma-dualizing-components}
In Situation \ref{situation-regular-model} the dualizing module of
$C_i$ over $k$ is
$$
\omega_{C_i} = \omega_X(C_i)|_{C_i}
$$
where $\omega_X$ is as above.
\end{lemma}

\begin{proof}
Let $t : C_i \to X$ be the closed immersion. Since $t$ is
the inclusion of an effective Cartier divisor we conclude from
Dualizing Complexes, Lemmas
\ref{dualizing-lemma-twisted-inverse-image-closed} and
\ref{dualizing-lemma-sheaf-with-exact-support-effective-Cartier}
that we have $t^!(\mathcal{L}) = \mathcal{L}(C_i)|_{C_i}$
for every invertible $\mathcal{O}_X$-module $\mathcal{L}$.
Consider the commutative diagram
$$
\xymatrix{
C_i \ar[r]_t \ar[d]_g & X \ar[d]^f \\
\Spec(k) \ar[r]^s & \Spec(R)
}
$$
Observe that $C_i$ is a Gorenstein curve
(Lemma \ref{lemma-gorenstein}) with invertible
dualizing module $\omega_{C_i}$ characterized by the property
$\omega_{C_i}[0] = g^!\mathcal{O}_{\Spec(k)}$. See
Algebraic Curves, Lemma \ref{curves-lemma-duality-dim-1}, its proof, and
Algebraic Curves, Lemmas \ref{curves-lemma-duality-dim-1-CM} and
\ref{curves-lemma-rr}.
On the other hand, $s^!(R[1]) = k$ and hence
$$
\omega_{C_i}[0] =
g^! s^!(R[1]) = t^!f^!(R[1]) = t^!\omega_X
$$
Combining the above we obtain the statement of the lemma.
\end{proof}




\input{chapters}

\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}
