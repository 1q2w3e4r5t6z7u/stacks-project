\input{preamble}

% OK, start here.
%
\begin{document}

\title{Groupoid schemes}


\maketitle

\phantomsection
\label{section-phantom}

\tableofcontents

\section{Introduction}
\label{section-introduction}

\noindent
This chapter is devoted to generalities concering groupoid schemes.
See for example the beautiful paper \cite{K-M} by Keel and Mori.





\section{Notation}
\label{section-notation}

\noindent
Let $S$ be a scheme. If $U$, $T$ are schemes over $S$ we denote
$U(T)$ for the set of $T$-valued points of $U$ {\it over} $S$. In a formula:
$U(T) = \text{Mor}_S(T, U)$. We try to reserve the letter $T$ to denote
a ``test scheme'' over $S$, as in the discussion that follows.
Suppose we are given schemes $X$, $Y$ over
$S$ and a morphism of schemes $f : X \to Y$ over $S$.
For any scheme $T$ over $S$ we get an induced map of sets
$$
f : X(T) \longrightarrow Y(T)
$$
which as indicated we denote by $f$ also. In fact this construction
is functorial in the scheme $T/S$. Yoneda's Lemma, see Categories,
Lemma \ref{categories-lemma-yoneda}, says that $f$ determines and is
determined by this transformation of functors $f : h_X \to h_Y$.
More generally, we use the same notation for maps between fibre
products. For example, if
$X$, $Y$, $Z$ are schemes over $S$, and if
$m : X \times_S Y \to Z \times_S Z$ is
a morphism of schemes over $S$, then we think of $m$ as corresponding
to a collection of maps between $T$-valued points
$$
X(T) \times Y(T) \longrightarrow Z(T) \times Z(T).
$$
And so on and so forth.

\medskip\noindent
We continue our convention to label projection maps starting with
index $0$, so we have $\text{pr}_0 : X \times_S Y \to X$ and
$\text{pr}_1 : X \times_S Y \to Y$.






\section{Equivalence relations}
\label{section-equivalence-relations}

\noindent
Recall that a {\it relation} $R$ on a set $A$ is just a subset
of $R \subset A \times A$.We usually write $a R b$ to indicate
$(a, b) \in R$. We say the relation is {\it transitive} if
$a R b, b R c \Rightarrow a R c$. We say the relation is
{\it reflexive} if $a R a$ for all $a \in A$. We say the relation is
{\it symmetric} if $a R b \Rightarrow b R a$.
A relation is called an {\it equivalence relation} if
it is transitive, reflexive and symmetric.

\medskip\noindent
In the setting of schemes we are going to relax the notion of a
relation a little bit and just require $R \to A \times A$ to
be a map. Here is the definition.

\begin{definition}
\label{definition-equivalence-relation}
Let $S$ be a scheme. Let $U$ be a scheme over $S$.
\begin{enumerate}
\item A {\it pre-relation} on $U$ over $S$ is any morphism
$j : R \to U \times_S U$. In this case we set
$t = \text{pr}_0 \circ j$ and $s = \text{pr}_1 \circ j$, so
that $j = (t, s)$.
\item A {\it relation} on $U$ over $S$ is a monomorphism
$j : R \to U \times_S U$.
\item A {\it pre-equivalence relation} is a pre-relation
$j : R \to U\times_SU$ such that the image of
$j : R(T) \to U(T) \times U(T)$ is an equivalence relation for
all $T/S$.
\item We say a morphism $R \to U \times_S U$ is
an {\it equivalence relation on $U$ over $S$}
if and only if for every $T/S$ the $T$-valued
points of $R$ define an equivalence relation
on the set of $T$-valued points of $U$.
\end{enumerate}
\end{definition}

\noindent
In other words, an equivalence relation is a pre-equivalence relation
such that $j$ is a relation.

\begin{lemma}
\label{lemma-restrict-relation}
Let $S$ be a scheme.
Let $U$ be a scheme over $S$.
Let $j : R \to U \times_S U$ be a pre-relation.
Let $g : U' \to U$ be a morphism of schemes.
Finally, set
$$
R' = (U' \times_S U')\times_{U \times_S U} R
\xrightarrow{j'}
U' \times_S U'
$$
Then $j'$ is a pre-relation on $U'$ over $S$.
If $j$ is a relation, then $j'$ is a relation.
If $j$ is a pre-equivalence relation, then $j'$ is a pre-equivalence relation.
If $j$ is an equivalence relation, then $j'$ is an equivalence relation.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{definition}
\label{definition-restrict-relation}
Let $S$ be a scheme.
Let $U$ be a scheme over $S$.
Let $j : R \to U \times_S U$ be a pre-relation.
Let $g : U' \to U$ be a morphism of schemes.
The pre-relation $j' : R' \to U' \times_S U'$ is called
the {\it restriction}, or {\it pullback} of the pre-relation $j$ to $U'$.
In this situation we sometimes write $R' = R|_{U'}$.
\end{definition}

\begin{lemma}
\label{lemma-pre-equivalence-equivalence-relation-points}
Let $j : R \to U\times_S U$ be a pre-relation.
Consider the relation on points of the scheme $U$ defined by
the rule
$$
x \sim y
\Leftrightarrow
\exists\ r \in R :
t(r) = x,
s(r) = y.
$$
If $j$ is a pre-equivalence relation then this is an
equivalence relation.
\end{lemma}

\begin{proof}
Suppose that $x \sim y$ and $y \sim z$.
Pick $r \in R$ with $t(r) = x$, $s(r) = y$ and
pick $r' \in R$ with $t(r') = y$, $s(r') = z$.
Pick a field $K$ fitting into the following commutative
diagram
$$
\xymatrix{
\kappa(r) \ar[r] & K \\
\kappa(y) \ar[u] \ar[r] & \kappa(r') \ar[u]
}
$$
Denote $x_K, y_K, z_K : \text{Spec}(K) \to U$
the morphisms
$$
\begin{matrix}
\text{Spec}(K) \to \text{Spec}(\kappa(r))
\to
\text{Spec}(\kappa(x)) \to U \\
\text{Spec}(K) \to \text{Spec}(\kappa(r))
\to
\text{Spec}(\kappa(y)) \to U \\
\text{Spec}(K) \to \text{Spec}(\kappa(r'))
\to
\text{Spec}(\kappa(z)) \to U
\end{matrix}
$$
By construction $(x_K, y_K) \in j(R(K))$ and
$(y_K, z_K) \in j(R(K))$. Since $j$ is a pre-equivalence relation
we see that also $(x_K, z_K) \in j(R(K))$.
This clearly implies that $x \sim z$.

\medskip\noindent
The proof that $\sim$ is reflexive and symmetric is omitted.
\end{proof}















\section{Group schemes}
\label{section-group-schemes}

\noindent
Let us recall that a {\it group} is a pair
$(G, m)$ where $G$ is a set, and $m : G \times G \to G$ is
a map of sets with the following properties:
\begin{enumerate}
\item (associativity) $m(g, m(g', g'')) = m(m(g, g'), g'')$
for all $g, g', g'' \in G$,
\item (identity) there exists a unique element $e \in G$
(called the {\it identity}, {\it unit}, or $1$ of $G$) such that
$m(g, e) = m(e, g) = g$ for all $g \in G$, and
\item (inverse) for all $g \in G$ there exists a $i(g) \in G$
such that $m(g, i(g)) = m(i(g), g) = e$, where $e$ is the
identity.
\end{enumerate}
Thus we obtain a map $e : \{*\} \to G$ and a map
$i : G \to G$ so that the quadruple $(G, m, e, i)$
satisfies the axioms listed above.

\medskip\noindent
A {\it homomorphism of groups} $\psi : (G, m) \to (G', m')$
is a map of sets $\psi : G \to G'$ such that
$m'(\psi(g), \psi(g')) = \psi(m(g, g'))$. This automatically
insures that $\psi(e) = e'$ and $i'(\psi(g)) = \psi(i(g))$.
(Obvious notation.) We will use this below.

\begin{definition}
\label{definition-group-scheme}
Let $S$ be a scheme.
\begin{enumerate}
\item A {\it group scheme over $S$} is a pair $(G, m)$, where
$G$ is a scheme over $S$ and $m : G \times_S G \to G$ is
a morphism of schemes over $S$ with the following property:
For every scheme $T$ over $S$ the pair $(G(T), m)$
is a group.
\item A {\it morphism $\psi : (G, m) \to (G', m')$ of group schemes over $S$}
is a morphism $\psi : G \to G'$ of schemes over $S$ such that for
every $T/S$ the induced map $\psi : G(T) \to G'(T)$ is a homomorphism
of groups.
\end{enumerate}
\end{definition}

\noindent
Let $(G, m)$ be a group scheme over the scheme $S$.
By the discussion above (and the discussion in Section \ref{section-notation})
we obtain morphisms of schemes over $S$:
(identity) $e : S \to G$ and (inverse) $i : G \to G$ such that
for every $T$ the quadruple $(G(T), m, e, i)$ satsifies the
axioms of a group listed above.

\medskip\noindent
Let $(G, m)$, $(G', m')$ be group schemes over $S$.
Let $f : G \to G'$ be a morphism of schemes over $S$.
It follows from the definition that $f$ is a morphism
of group schemes over $S$ if and only if the following diagram
is commutative:
$$
\xymatrix{
G \times_S G \ar[r]_-{f \times f} \ar[d]_m &
G' \times_S G' \ar[d]^m \\
G \ar[r]^f & G'
}
$$

\begin{lemma}
\label{lemma-base-change-group-scheme}
Let $(G, m)$ be a group scheme over $S$.
Let $S' \to S$ be a morphism of schemes.
The pullback $(G_{S'}, m_{S'})$ is a group scheme over $S'$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{definition}
\label{definition-closed-subgroup-scheme}
Let $S$ be a scheme. Let $(G, m)$ be a group scheme over $S$.
\begin{enumerate}
\item A {\it closed subgroup scheme} of $G$ is a closed subscheme
$H \subset G$ such that $m|_{H \times_S H}$ factors through $H$ and induces a
group scheme structure on $H$ over $S$.
\item An {\it open subgroup scheme} of $G$ is an open subscheme
$G' \subset G$ such that $m|_{G' \times_S G'}$ factors through $G'$
and induces a group scheme structure on $G'$ over $S$.
\end{enumerate}
\end{definition}

\noindent
Alternatively, we could say that $H$ is a closed subgroup scheme of $G$
if it is a group scheme over $S$ endowed with a morphism of group schemes
$i : H \to G$ over $S$ which identifies $H$ with a closed subscheme of $G$.

\begin{definition}
\label{definition-smooth-group-scheme}
Let $S$ be a scheme. Let $(G, m)$ be a group scheme over $S$.
\begin{enumerate}
\item We say $G$ is a {\it smooth group scheme} if the structure
morphism $G \to S$ is smooth.
\item We say $G$ is a {\it flat group scheme} if the structure
morphism $G \to S$ is flat.
\item We say $G$ is a {\it separated group scheme} if the structure
morphism $G \to S$ is separated.
\end{enumerate}
Add more as needed.
\end{definition}






\section{Examples of group schemes}
\label{section-examples-group-schemes}

\begin{example}
\label{example-multiplicative-group}
(Multiplicative group scheme.)
Consider the functor which associates
to any scheme $T$ the group $\Gamma(T, \mathcal{O}_T^*)$
of units in the global sections of the structure sheaf.
This is representable by the scheme
$$
\mathbf{G}_m = \text{Spec}(\mathbf{Z}[x, x^{-1}])
$$
The morphism giving the group structure is the morphism
\begin{eqnarray*}
\mathbf{G}_m \times \mathbf{G}_m & \to & \mathbf{G}_m \\
\text{Spec}(\mathbf{Z}[x, x^{-1}] \otimes_{\mathbf{Z}} \mathbf{Z}[x, x^{-1}])
& \to &
\text{Spec}(\mathbf{Z}[x, x^{-1}]) \\
\mathbf{Z}[x, x^{-1}] \otimes_{\mathbf{Z}} \mathbf{Z}[x, x^{-1}]
& \leftarrow &
\mathbf{Z}[x, x^{-1}] \\
x \otimes x & \leftarrow & x
\end{eqnarray*}
Hence we see that $\mathbf{G}_m$ is a group scheme over $\mathbf{Z}$.
For any scheme $S$ the base change $\mathbf{G}_{m, S}$ is a
group scheme over $S$ whose functor of points is
$$
T/S
\longmapsto
\mathbf{G}_{m, S}(T) = \mathbf{G}_m(T) = \Gamma(T, \mathcal{O}_T^*)
$$
as before.
\end{example}

\begin{example}
\label{example-roots-of-unity}
(Roots of unity.)
Let $n \in \mathbf{N}$.
Consider the functor which associates
to any scheme $T$ the subgroup of $\Gamma(T, \mathcal{O}_T^*)$
consisting of $n$th roots of unity.
This is representable by the scheme
$$
\mu_n = \text{Spec}(\mathbf{Z}[x]/(x^n - 1)).
$$
The morphism giving the group structure is the morphism
\begin{eqnarray*}
\mu_n \times \mu_n & \to & \mu_n \\
\text{Spec}(
\mathbf{Z}[x]/(x^n - 1)
\otimes_{\mathbf{Z}}
\mathbf{Z}[x]/(x^n - 1))
& \to &
\text{Spec}(\mathbf{Z}[x]/(x^n - 1)) \\
\mathbf{Z}[x]/(x^n - 1) \otimes_{\mathbf{Z}} \mathbf{Z}[x]/(x^n - 1)
& \leftarrow &
\mathbf{Z}[x]/(x^n - 1) \\
x \otimes x & \leftarrow & x
\end{eqnarray*}
Hence we see that $\mu_n$ is a group scheme over $\mathbf{Z}$.
For any scheme $S$ the base change $\mu_{n, S}$ is a
group scheme over $S$ whose functor of points is
$$
T/S
\longmapsto
\mu_{n, S}(T) = \mu_n(T) = \{f \in \Gamma(T, \mathcal{O}_T^*) \mid f^n = 1\}
$$
as before.
\end{example}


\begin{example}
\label{example-additive-group}
(Additive group scheme.)
Consider the functor which associates
to any scheme $T$ the group $\Gamma(T, \mathcal{O}_T)$
of global sections of the structure sheaf.
This is representable by the scheme
$$
\mathbf{G}_a = \text{Spec}(\mathbf{Z}[x])
$$
The morphism giving the group structure is the morphism
\begin{eqnarray*}
\mathbf{G}_a \times \mathbf{G}_a & \to & \mathbf{G}_a \\
\text{Spec}(\mathbf{Z}[x] \otimes_{\mathbf{Z}} \mathbf{Z}[x])
& \to &
\text{Spec}(\mathbf{Z}[x]) \\
\mathbf{Z}[x] \otimes_{\mathbf{Z}} \mathbf{Z}[x]
& \leftarrow &
\mathbf{Z}[x] \\
x \otimes 1 + 1 \otimes x & \leftarrow & x
\end{eqnarray*}
Hence we see that $\mathbf{G}_a$ is a group scheme over $\mathbf{Z}$.
For any scheme $S$ the base change $\mathbf{G}_{a, S}$ is a
group scheme over $S$ whose functor of points is
$$
T/S
\longmapsto
\mathbf{G}_{a, S}(T) = \mathbf{G}_a(T) = \Gamma(T, \mathcal{O}_T)
$$
as before.
\end{example}

\begin{example}
\label{example-general-linear-group}
(General linear group scheme.)
Let $n \geq 1$.
Consider the functor which associates
to any scheme $T$ the group
$$
\text{GL}_n(\Gamma(T, \mathcal{O}_T))
$$
of invertible $n \times n$ matrices over
the global sections of the structure sheaf.
This is representable by the scheme
$$
\text{GL}_n = \text{Spec}(\mathbf{Z}[\{x_{ij}\}_{1 \leq i, j \leq n}][1/d])
$$
where $d = \det((x_{ij}))$ with $(x_{ij})$ the $n \times n$ matrix
with entry $x_{ij}$ in the $(i, j)$-spot.
The morphism giving the group structure is the morphism
\begin{eqnarray*}
\text{GL}_n \times \text{GL}_n & \to & \text{GL}_n \\
\text{Spec}(\mathbf{Z}[x_{ij}, 1/d] \otimes_{\mathbf{Z}}
\mathbf{Z}[x_{ij}, 1/d])
& \to &
\text{Spec}(\mathbf{Z}[x_{ij}, 1/d]) \\
\mathbf{Z}[x_{ij}, 1/d] \otimes_{\mathbf{Z}} \mathbf{Z}[x_{ij}, 1/d]
& \leftarrow &
\mathbf{Z}[x_{ij}, 1/d] \\
\sum x_{ik} \otimes x_{kj} & \leftarrow & x_{ij}
\end{eqnarray*}
Hence we see that $\text{GL}_n$ is a group scheme over $\mathbf{Z}$.
For any scheme $S$ the base change $\text{GL}_{n, S}$ is a
group scheme over $S$ whose functor of points is
$$
T/S
\longmapsto
\text{GL}_{n, S}(T) = \text{GL}_n(T) =\text{GL}_n(\Gamma(T, \mathcal{O}_T))
$$
as before.
\end{example}

\begin{example}
\label{example-determinant}
The determinant defines a morphisms of group schemes
$$
\det : \text{GL}_n \longrightarrow \mathbf{G}_m
$$
over $\mathbf{Z}$. By base change it gives a morphism
of group schemes $\text{GL}_{n, S} \to \mathbf{G}_{m, S}$
over any base scheme $S$.
\end{example}

\begin{example}
\label{example-constant-group}
(Constant group.)
Let $G$ be an abstract group. Consider the functor
which associates to any scheme $T$ the group
of locally constant maps $T \to G$ (where $T$ has the Zariski topology
and $G$ the discrete topology). This is representable by the scheme
$$
G_{\text{Spec}(\mathbf{Z})} =
\coprod\nolimits_{g \in G} \text{Spec}(\mathbf{Z}).
$$
The morphism giving the group structure is the morphism
$$
G_{\text{Spec}(\mathbf{Z})}
\times_{\text{Spec}(\mathbf{Z})}
G_{\text{Spec}(\mathbf{Z})}
\longrightarrow
G_{\text{Spec}(\mathbf{Z})}
$$
which maps the component corresponding to the pair $(g, g')$ to the
component corresponding to $gg'$. For any scheme $S$ the base change
$G_S$ is a group scheme over $S$ whose functor of points is
$$
T/S
\longmapsto
G_S(T) = \{f : T \to G \text{ locally constant}\}
$$
as before.
\end{example}





\section{Properties of group schemes}
\label{section-properties-group-schemes}

\noindent
In this section we collect some simple properties of group schemes which
hold over any base.

\begin{lemma}
\label{lemma-group-scheme-separated}
Let $S$ be a scheme.
Let $G$ be a group scheme over $S$.
Then $G \to S$ is separated (resp.\ quasi-separated) if and only if
the identity morphism $e : S \to G$ is a closed immersion
(resp.\ quasi-compact).
\end{lemma}

\begin{proof}
We recall that by
Schemes, Lemma \ref{schemes-lemma-section-immersion}
we have that $e$ is an immersion which is a closed immersion
(resp.\ quasi-compact) if $G \to S$ is separated (resp.\ quasi-separated).
For the converse, consider the diagram
$$
\xymatrix{
G \ar[r]_-{\Delta_{G/S}} \ar[d] &
G \times_S G \ar[d]^{(g, g') \mapsto m(i(g), g')} \\
S \ar[r]^e & G
}
$$
It is an exercise in the functorial point of view in algebraic geometry
to show that this diagram is cartesian. In other words, we see that
$\Delta_{G/S}$ is a base change of $e$. Hence if $e$ is a
closed immersion (resp.\ quasi-compact) so is $\Delta_{G/S}$, see
Schemes, Lemma \ref{schemes-lemma-base-change-immersion} (resp.\ 
Schemes, Lemma \ref{schemes-lemma-quasi-compact-preserved-base-change}).
\end{proof}

\begin{lemma}
\label{lemma-flat-action-on-group-scheme}
Let $S$ be a scheme.
Let $G$ be a group scheme over $S$.
Let $T$ be a scheme over $S$ and let $\psi : T \to G$ be a morphism over $S$.
If $T$ is flat over $S$, then the morphism
$$
T \times_S G \longrightarrow G,\quad
(t, g) \longmapsto m(\psi(t), g)
$$
is flat. In particular, if $G$ is flat over $S$, then
$m : G \times_S G \to G$ is flat.
\end{lemma}

\begin{proof}
Consider the diagram
$$
\xymatrix{
T \times_S G \ar[rrr]_{(t, g) \mapsto (t, m(\psi(t), g))} & & &
T \times_S G \ar[r]_{\text{pr}} \ar[d] &
G \ar[d] \\
& & &
T \ar[r] &
S
}
$$
The left top horizontal arrow is an isomorphism and the
square is cartesian. Hence the lemma follows from
Morphisms, Lemma \ref{morphisms-lemma-base-change-flat}.
\end{proof}

\begin{lemma}
\label{lemma-group-scheme-module-differentials}
Let $(G, m, e, i)$ be a group scheme over the scheme $S$.
Denote $f : G \to S$ the structure morphism. Assume $f$ is flat.
Then there exist canonical isomorphisms
$$
\Omega_{G/S} \cong f^*\mathcal{C}_{S/G} \cong f^*e^*\Omega_{G/S} 
$$
where $\mathcal{C}_{S/G}$ denotes the conormal sheaf of the
immersion $e$. In particular, if $S$ is the spectrum of a field, then
$\Omega_{G/S}$ is a free $\mathcal{O}_G$-module.
\end{lemma}

\begin{proof}
In
Morphisms, Section \ref{morphisms-section-sheaf-differentials}
we defined $\Omega_{G/S}$ as the conormal sheaf of the
diagonal morphism $\Delta_{G/S}$. In the proof of
Lemma \ref{lemma-group-scheme-separated}
we showed that $\Delta_{G/S}$ is a base change of the immersion $e$
by the morphism $(g, g') \mapsto m(i(g), g')$. This morphism
is isomorphic to the morphism $(g, g') \mapsto m(g, g')$
hence is flat by
Lemma \ref{lemma-flat-action-on-group-scheme}.
Hence we get the first isomorphism by
Morphisms, Lemma \ref{morphisms-lemma-conormal-functorial-flat}.
By
Morphisms, Lemma \ref{morphisms-lemma-differentials-relative-immersion-section}
we have $\mathcal{C}_{S/G} \cong e^*\Omega_{G/S}$.

\medskip\noindent
If $S$ is the spetrum of a field, then $G \to S$ is flat, and
any $\mathcal{O}_S$-module on $S$ is free.
\end{proof}






\section{Properties of group schemes over a field}
\label{section-properties-group-schemes-field}

\noindent
In this section we collect some simple properties of group schemes over a
field.

\begin{lemma}
\label{lemma-group-scheme-over-field-open-multiplication}
If $(G, m)$ is a group scheme over a field $k$, then the
multiplication map $m : G \times_k G \to G$ is open.
\end{lemma}

\begin{proof}
The multiplication map is isomorphic to the projection map
$\text{pr}_0 : G \times_k G \to G$
because the diagram
$$
\xymatrix{
G \times_k G \ar[d]^m \ar[rrr]_{(g, g') \mapsto (m(g, g'), g')} & & &
G \times_k G \ar[d]^{(g, g') \mapsto g} \\
G \ar[rrr]^{\text{id}} & & & G
}
$$
is commutative with isomorphisms as horizontal arrows. The projection
is open by
Morphisms, Lemma \ref{morphisms-lemma-scheme-over-field-universally-open}.
\end{proof}

\begin{lemma}
\label{lemma-group-scheme-over-field-separated}
Let $G$ be a group scheme over a field.
Then $G$ is a separated scheme.
\end{lemma}

\begin{proof}
Say $S = \text{Spec}(k)$ with $k$ a field, and let $G$ be a group scheme
over $S$. By
Lemma \ref{lemma-group-scheme-separated}
we have to show that $e : S \to G$ is a closed immersion. By
Morphisms, Lemma
\ref{morphisms-lemma-algebraic-residue-field-extension-closed-point-fibre}
the image of $e : S \to G$ is a closed point of $G$.
It is clear that $\mathcal{O}_G \to e_*\mathcal{O}_S$ is surjective,
since $e_*\mathcal{O}_S$ is a skyscraper sheaf supported at the neutral
element of $G$ with value $k$. We conclude that $e$ is a closed immersion by
Schemes, Lemma \ref{schemes-lemma-characterize-closed-immersions}.
\end{proof}

\begin{lemma}
\label{lemma-group-scheme-field-geometrically-irreducible}
Let $G$ be a group scheme over a field $k$.
Then
\begin{enumerate}
\item every local ring $\mathcal{O}_{G, g}$ of $G$ has a unique
minimal ideal,
\item there is exactly one irreducible component $Z$ of $G$
passing through $e$, and
\item $Z$ is geometrically irreducible over $k$.
\end{enumerate}
\end{lemma}

\begin{proof}
For any point $g \in G$ there exists a field extension
$k \subset K$ and a $K$-valued point $g' \in G(K)$ mapping to
$g$. If we think of $g'$ as a $K$-rational point of the
group scheme $G_K$, then we see that
$\mathcal{O}_{G, g} \to \mathcal{O}_{G_K, g'}$ is a faithfully flat
local ring map (as $G_K \to G$ is flat, and a local flat ring map
is faithfully flat, see
Algebra, Lemma \ref{algebra-lemma-local-flat-ff}).
The result for $\mathcal{O}_{G_K, g'}$ implies the
result for $\mathcal{O}_{G, g}$, see
Algebra, Lemma \ref{algebra-lemma-injective-minimal-primes-in-image}.
Hence in order to prove (1) it suffices to
prove it for $k$-rational points $g$ of $G$. In this case
translation by $g$ defines an automorphism $G \to G$
which maps $e$ to $g$. Hence $\mathcal{O}_{G, g} \cong \mathcal{O}_{G, e}$.
In this way we see that (2) implies (1), since irreducible components
passing through $e$ correspond one to one with minimal prime ideals
of $\mathcal{O}_{G, e}$.

\medskip\noindent
In order to prove (2) and (3) it suffices to prove (2) when $k$
is algebraically closed. In this case, let $Z_1$, $Z_2$ be two
irreducible components of $G$ passing through $e$.
Since $k$ is algebraically closed the closed subscheme
$Z_1 \times_k Z_2 \subset G \times_k G$ is irreducible too, see
Varieties, Lemma \ref{varieties-lemma-bijection-irreducible-components}.
Hence $m(Z_1 \times_k Z_2)$ is contained in an irreducible
component of $G$. On the other hand it contains
$Z_1$ and $Z_2$ since $m|_{e \times G} = \text{id}_G$ and
$m|_{G \times e} = \text{id}_G$. We conclude $Z_1 = Z_2$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-group-scheme-finite-type-field}
Let $G$ be a group scheme which is locally of finite type over a
field $k$. Then $G$ is equidimensional and
$\dim(G) = \dim_g(G)$ for all $g \in G$.
For any closed point $g \in G$ we have $\dim(G) = \dim(\mathcal{O}_{G, g})$.
\end{lemma}

\begin{proof}
Let us first prove that $\dim_g(G) = \dim_{g'}(G)$ for any
pair of points $g, g' \in G$. By
Morphisms of Schemes,
Lemma \ref{morphisms-lemma-dimension-fibre-after-base-change}
we may extend the ground field at will. Hence we may assume that
both $g$ and $g'$ are defined over $k$. Hence there exists an
automorphism of $G$ mapping $g$ to $g'$, whence the equality.
By
Morphisms, Lemma \ref{morphisms-lemma-dimension-fibre-at-a-point}
we have
$\dim_g(G) = \dim(\mathcal{O}_{G, g}) +
\text{trdeg}_{k}(\kappa(g))$.
On the other hand, the dimension of $G$ (or any open subset of $G$)
is the supremum of the dimensions of the local rings of of $G$,see
Properties of Schemes, Lemma \ref{properties-lemma-codimension-local-ring}.
Clearly this is maximal for closed points $g$ in which case
$\text{trdeg}_{k}(\kappa(g)) = 0$ (by the Hilbert Nullstellensatz, see
Morphisms, Section \ref{morphisms-section-points-finite-type}).
Hence the lemma follows.
\end{proof}

\noindent
The following result is sometimes referred to as Cartier's theorem.

\begin{lemma}
\label{lemma-group-scheme-characteristic-zero-smooth}
Let $G$ be a group scheme which is locally of finite type
over a field $k$ of characteristic zero. Then the structure
morphism $G \to \text{Spec}(k)$ is smooth, i.e., $G$ is a smooth
group scheme.
\end{lemma}

\begin{proof}
By
Lemma \ref{lemma-group-scheme-module-differentials}
the module of differentials of $G$ over $k$ is free.
Hence we see that $G$ is smooth over $k$ by applying
Algebra, Lemma \ref{algebra-lemma-characteristic-zero-local-smooth}.
\end{proof}

\begin{remark}
\label{remark-when-reduced}
It seems to be unkown whether any group scheme over a field
of characteristic $0$ is reduced. This question is raised in
\cite[page 80]{Oort}. Please email
\href{mailto:stacks.project@gmail.com}{stacks.project@gmail.com}
if this is no longer an open question (so we can update this remark). By
Lemma \ref{lemma-group-scheme-characteristic-zero-smooth}
this holds when the group scheme is locally of finite type.
We will later show (insert future reference here) that any
affine group scheme over a field $k$
is a limit of finite type affine group schemes over $k$, which
will imply any affine group scheme over a field of characteristic zero
is reduced.
\end{remark}

\begin{lemma}
\label{lemma-reduced-group-scheme-prefect-field-characteristic-p-smooth}
Let $G$ be a group scheme which is locally of finite type
over a perfect field $k$ of characteristic $p > 0$ (see
Lemma \ref{lemma-group-scheme-characteristic-zero-smooth}
for the characteristic zero case). If $G$ is reduced then the structure
morphism $G \to \text{Spec}(k)$ is smooth, i.e., $G$ is a smooth
group scheme.
\end{lemma}

\begin{proof}
By 
Lemma \ref{lemma-group-scheme-module-differentials}
the sheaf $\Omega_{G/k}$ is free. Let $\eta \in G$ be the generic
point of an irreducible component of $G$. Then
$\mathcal{O}_{G, \eta} = \kappa(\eta)$. Moreover, $\kappa(\eta)$ is
a finitely generated field extension of the perfect field $k$
hence separably generated over $k$ (see
Algebra, Section \ref{algebra-section-separability}).
It follows that $\Omega_{G/k, \eta} = \Omega_{\kappa(\eta)/k}$
is free of rank the transcendence degree of $\kappa(\eta)$ over $k$. By
Morphisms, Lemma \ref{morphisms-lemma-dimension-fibre-at-a-point}
we conclude that $\dim_\eta(G) = \text{rank}(\Omega_{G/S})$. By
Lemma \ref{lemma-group-scheme-finite-type-field}
this is the dimension of $G$ at any point.
It follows that $G \to \text{Spec}(k)$ is smooth for example by
Algebra, Lemma \ref{algebra-lemma-characterize-smooth-over-field}.
\end{proof}

\begin{remark}
\label{remark-reduced-smooth-not-true-general}
Let $k$ be a field of characteristic $p > 0$.
Let $\alpha \in k$ be an element which is not a $p$th power.
The closed subgroup scheme
$$
G = V(x^p + \alpha y^p) \subset \mathbf{G}_{a, k}^2
$$
is reduced and irreducible but not smooth (not even normal).
\end{remark}

\begin{lemma}
\label{lemma-reduced-subgroup-scheme-perfect}
Let $G$ be a group scheme over a perfect field $k$.
Then the reduction $G_{red}$ of $G$ is a closed subgroup scheme of $G$.
\end{lemma}

\begin{proof}
Omitted. Hint: Use that $G_{red} \times_k G_{red}$ is reduced by
Varieties, Lemmas \ref{varieties-lemma-perfect-reduced} and
\ref{varieties-lemma-geometrically-reduced-any-base-change}.
\end{proof}

\begin{lemma}
\label{lemma-open-subgroup-closed-over-field}
Let $G$ be group scheme over a field $k$.
Let $G' \subset G$ be an open subgroup scheme.
Then $G'$ is open and closed in $G$.
\end{lemma}

\begin{proof}
Suppose that $k \subset K$ is a field extension such that
$G'_K \subset G_K$ is closed. Then it follows from
Morphisms, Lemma \ref{morphisms-lemma-fpqc-quotient-topology}
that $G'$ is closed (as $G_K \to G$ is flat, quasi-compact and surjective).
Hence it suffices to prove the lemma after replacing $k$ by some
extension. Choose $K$ to be an algebraically closed field extension of
very large cardinality. Then by
Varieties, Lemma \ref{varieties-lemma-make-Jacobson},
we see that $G_K$ is a Jacobson scheme all of whose closed points have residue
field equal to $K$. In other words we may assume $G$ is a Jacobson
scheme all of whose closed points have residue field $k$.

\medskip\noindent
Let $Z = G \setminus G'$. We have to show that $Z$ is open.
Because $G$ is Jacobson and $Z$ is closed
the closed points of $Z$ are dense in $Z$.
Moreover any closed point $z \in Z$ is a $k$-rational point and hence
we translation by $z$ defines an automorphism $L_z : G \to G$,
$g \mapsto m(z, g)$ with $e \mapsto z$. As $G'$ is a subgroup scheme we
conclude that $L_z(G') \subset Z$. Alltogether we see that
$$
Z = \bigcup\nolimits_{z \in Z(k)} L_z(G')
$$
is a union of open subsets, and hence open as desired.
\end{proof}

\begin{lemma}
\label{lemma-immersion-group-schemes-closed-over-field}
Let $i : G' \to G$ be an immersion of group schemes over a field $k$.
Then $i$ is a closed immersion, i.e., $i(G')$ is a closed subgroup scheme
of $G$.
\end{lemma}

\begin{proof}
To show that $i$ is a closed immersion it suffices to show that
$i(G')$ is a closed subset of $G$. Let $k \subset k'$ be a perfect
extension of $k$. If $i(G'_{k'}) \subset G_{k'}$ is closed, then
$i(G') \subset G$ is closed by
Morphisms, Lemma \ref{morphisms-lemma-fpqc-quotient-topology}
(as $G_{k'} \to G$ is flat, quasi-compact and surjective).
Hence we may and do assume $k$ is perfect. We will use without further
mention that products of reduced schemes over $k$ are reduced.
We may replace $G'$ and $G$ by their reductions, see
Lemma \ref{lemma-reduced-subgroup-scheme-perfect}.
Let $\overline{G'} \subset G$ be the closure of $i(G')$ viewed
as a reduced closed subscheme. By
Varieties, Lemma \ref{varieties-lemma-closure-of-product}
we conclude that $\overline{G'} \times_k \overline{G'}$
is the closure of the image of $G' \times_k G' \to G \times_k G$. Hence
$$
m\Big(\overline{G'} \times_k \overline{G'}\Big)
\subset \overline{G'}
$$
as $m$ is continuous. It follows that $\overline{G'} \subset G$
is a (reduced) closed subgroup scheme. By
Lemma \ref{lemma-open-subgroup-closed-over-field}
we see that $i(G') \subset \overline{G'}$ is also closed
which implies that $i(G') = \overline{G'}$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-group-scheme-field-countable-affine}
Let $G$ be a group scheme over a field.
There exists an open and closed subscheme $G' \subset G$
which is a countable union of affines.
\end{lemma}

\begin{proof}
Let $e \in U(k)$ be a quasi-compact open neighbourhood of the identity
element. By replacing $U$ by $U \cap i(U)$ we may assume that
$U$ is invariant under the inverse map. As $G$ is separated this is
still a quasi-compact set. Set
$$
G' = \bigcup\nolimits_{n \geq 1} m_n(U \times_k \ldots \times_k U)
$$
where $m_n : G \times_k \ldots \times_k G \to G$ is the $n$-slot
multiplication map
$(g_1, \ldots, g_n) \mapsto m(m(\ldots (m(g_1, g_2), g_3),\ldots ), g_n)$.
Each of these maps are open (see
Lemma \ref{lemma-group-scheme-over-field-open-multiplication})
hence $G'$ is an open subgroup scheme. By
Lemma \ref{lemma-open-subgroup-closed-over-field}
it is also a closed subgroup scheme.
\end{proof}

\begin{remark}
\label{remark-easy}
If $G$ is a group scheme over a field, is there always a quasi-compact
open and closed subgroup scheme? Or is there a counter example?
\end{remark}





\section{Actions of group schemes}
\label{section-action-group-scheme}

\noindent
Let $(G, m)$ be a group and let $V$ be a set.
Recall that a {\it (left) action} of $G$ on $V$ is given
by a map $a : G \times V \to V$ such that
\begin{enumerate}
\item (associativity) $a(m(g, g'), v) = a(g, a(g', v))$ for all
$g, g' \in G$ and $v \in V$, and
\item (identity) $a(e, v) = v$ for all $v \in V$.
\end{enumerate}
We also say that $V$ is a {\it $G$-set} (this usually means we
drop the $a$ from the notation -- which is abuse of notation).
A {\it map of $G$-sets} $\psi : V \to V'$ is any set map
such that $\psi(a(g, v)) = a(g, \psi(v))$ for all $v \in V$.

\begin{definition}
\label{definition-action-group-scheme}
Let $S$ be a scheme. Let $(G, m)$ be a group scheme over $S$.
\begin{enumerate}
\item An {\it action of $G$ on the scheme $X/S$} is
a morphism $a : G \times_S X \to X$ over $S$ such that
for every $T/S$ the map $a : G(T) \times X(T) \to X(T)$
defines the structure of a $G(T)$-set on $X(T)$.
\item Suppose that $X$, $Y$ are schemes over $S$ each endowed
with an action of $G$. An {\it equivariant} or more precisely
a {\it $G$-equivariant} morphism $\psi : X \to Y$
is a morphism of schemes over $S$ such
that for every $T/S$ the map $\psi : X(T) \to Y(T)$ is
a morphism of $G(T)$-sets.
\end{enumerate}
\end{definition}

\noindent
In situation (1) this means that the diagrams
\begin{equation}
\label{equation-action}
\xymatrix{
G \times_S G \times_S X \ar[r]_-{1_G \times a} \ar[d]_{m \times 1_X} &
G \times_S X \ar[d]^a \\
G \times_S X \ar[r]^a & X
}
\quad
\xymatrix{
G \times_S X \ar[r]_-a & X \\
X\ar[u]^{e \times 1_X} \ar[ru]_{1_X}
}
\end{equation}
are commutative. In situation (2) this just means that the diagram
$$
\xymatrix{
G \times_S X \ar[r]_-{\text{id} \times f} \ar[d]_a &
G \times_S Y \ar[d]^a \\
X \ar[r]^f & Y
}
$$
commutes.





\section{Principal homogeneous spaces}
\label{section-principal-homogeneous}

\noindent
In
Cohomology of Sites, Section \ref{sites-cohomology-definition-torsor}
we have defined a torsor for a sheaf of groups on a site.
Suppose $\tau \in \{Zariski, etale, smooth, syntomic, fppf\}$ is a topology
and $(G, m)$ is a group scheme over $S$. Since $\tau$ is stronger than
the canonical topology (see
Descent, Lemma \ref{descent-lemma-fpqc-universal-effective-epimorphisms})
we see that $\underline{G}$ (see
Sites, Definition \ref{sites-definition-representable-sheaf})
is a sheaf of groups on $(\textit{Sch}/S)_\tau$.
Hence we already know what it means to have a
torsor for $\underline{G}$ on $(\textit{Sch}/S)_\tau$. A special situation
arises if this sheaf is representable. In the following definitions
we define directly what it means for the representing scheme to be a
$G$-torsor.

\begin{definition}
\label{definition-pseudo-torsor}
Let $S$ be a scheme.
Let $(G, m)$ be a group scheme over $S$.
Let $X$ be a scheme over $S$, and let
$a : G \times_S X \to X$ be an action of $G$ on $X$.
\begin{enumerate}
\item We say $X$ is a {\it pseudo $G$-torsor} or that $X$ is
{\it formally principally homogeneous under $G$} if the induced
morphism of schemes $G \times_S X \to X \times_S X$,
$(g, x) \mapsto (a(g, x), x)$ is an isomorphism of schemes over $S$.
\item A pseudo $G$-torsor $X$ is called {\it trivial} if there exists
an $G$-equivariant isomorphism $G \to X$ over $S$ where $G$ acts on
$G$ by left multiplication.
\end{enumerate}
\end{definition}

\noindent
It is clear that if $S' \to S$ is a morphism of schemes then
the pullback $X_{S'}$ of a pseudo $G$-torsor over $S$ is a
pseudo $G_{S'}$-torsor over $S'$.

\begin{lemma}
\label{lemma-characterize-trivial-pseudo-torsors}
In the situation of
Definition \ref{definition-pseudo-torsor}.
\begin{enumerate}
\item The scheme $X$ is a pseudo $G$-torsor if and only if for every scheme
$T$ over $S$ the set $X(T)$ is either empty or the action of the group $G(T)$
on $X(T)$ is simply transitive.
\item A pseudo $G$-torsor $X$ is trivial if and only if the morphism
$X \to S$ has a section.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{definition}
\label{definition-principal-homogeneous-space}
Let $S$ be a scheme.
Let $(G, m)$ be a group scheme over $S$.
Let $X$ be a scheme over $S$, and let
$a : G \times_S X \to X$ be an action of $G$ on $X$.
\begin{enumerate}
\item We say $X$ is a {\it principal homogeneous space}
or a {\it $G$-torsor} if there exists a fpqc covering\footnote{This means
that the default type of torsor is a pseudo torsors which is trivial on an
fpqc covering. This is the definition in \cite[Expos\'e IV, 6.5]{SGA3}.
It is a little bit inconvenient for us as we most often work in the fppf
topology.}
$\{S_i \to S\}_{i \in I}$ such that each
$X_{S_i} \to S_i$ has a section (i.e., is a trivial pseudo $G_{S_i}$-torsor).
\item Let $\tau \in \{Zariski, etale, smooth, syntomic, fppf\}$.
We say $X$ is a {\it $G$-torsor in the $\tau$ topology}, or a
{\it $\tau$ $G$-torsor}, or simply a {\it $\tau$ torsor}
if there exists a $\tau$ covering $\{S_i \to S\}_{i \in I}$
such that each $X_{S_i} \to S_i$ has a section.
\item If $X$ is a $G$-torsor, then we say that it is
{\it quasi-isotrivial} if it is a torsor for the etale topology.
\item If $X$ is a $G$-torsor, then we say that it is
{\it locally trivial} if it is a torsor for the Zariski topology.
\end{enumerate}
\end{definition}

\noindent
We sometimes say ``let $X$ be a $G$-torsor over $S$'' to indicate that
$X$ is a scheme over $S$ equippend with an action of $G$ which turns it
into a principal homogeneous space over $S$.
Next we show that this agrees with the notation introduced earlier
when both apply.

\begin{lemma}
\label{lemma-torsor}
Let $S$ be a scheme.
Let $(G, m)$ be a group scheme over $S$.
Let $X$ be a scheme over $S$, and let
$a : G \times_S X \to X$ be an action of $G$ on $X$.
Let $\tau \in \{Zariski, etale, smooth, syntomic, fppf\}$.
Then $X$ is a $G$-torsor in the $\tau$-topology if and only if
$\underline{X}$ is a $\underline{G}$-torsor on $(\textit{Sch}/S)_\tau$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{remark}
\label{remark-fun-with-torsors}
Let $(G, m)$ be a group scheme over the scheme $S$.
In this situation we have the following natural types of questions:
\begin{enumerate}
\item If $X \to S$ is a pseudo $G$-torsor and $X \to S$ is surjective,
then is $X$ necessarily a $G$-torsor?
\item Is every $\underline{G}$-torsor on $(\textit{Sch}/S)_{fppf}$
representable? In other words, does every $\underline{G}$-torsor
come from a fppf $G$-torsor?
\item Is every $G$-torsor an
fppf (resp.\ smooth, resp.\ etale, resp.\ Zariski) torsor?
\end{enumerate}
In general the answers to these questions is no. To get a positive answer
we need to impose additional conditions on $G \to S$.
For example:
If $S$ is the spectrum of a field, then the answer to (1) is yes
because then $\{X \to S\}$ is a fpqc covering trivializing $X$.
If $G \to S$ is affine, then the answer to (2) is yes
(insert future reference here).
If $G = \text{GL}_{n, S}$ then the answer to (3) is yes
and in fact any $\text{GL}_{n, S}$-torsor is locally trivial
(insert future reference here).
\end{remark}



\section{Equivariant quasi-coherent sheaves}
\label{section-equivariant}

\noindent
We think of ``functions'' as dual to ``space''. Thus for a morphism of spaces
the map on functions goes the other way. Moreover, we think of the
sections of a sheaf of modules as ``functions''. This leads us naturally
to the direction of the arrows chosen in the following definition.

\begin{definition}
\label{definition-equivariant-module}
Let $S$ be a scheme, let $(G, m)$ be a group scheme over $S$, and
let $a : G \times_S X \to X$ be an action of the group scheme $G$
on $X/S$. An {\it $G$-equivariant quasi-coherent $\mathcal{O}_X$-module},
or simply a {\it equivariant quasi-coherent $\mathcal{O}_X$-module},
is a pair $(\mathcal{F}, \alpha)$, where $\mathcal{F}$ is a quasi-coherent
$\mathcal{O}_X$-module, and $\alpha$ is a $\mathcal{O}_{G \times_S X}$-module
map
$$
\alpha : a^*\mathcal{F} \longrightarrow \text{pr}_1^*\mathcal{F}
$$
where $\text{pr}_1 : G \times_S X \to X$ is the projection
such that
\begin{enumerate}
\item the diagram
$$
\xymatrix{
(1_G \times a)^*\text{pr}_2^*\mathcal{F} \ar[r]_-{\text{pr}_{12}^*\alpha} &
\text{pr}_2^*\mathcal{F} \\
(1_G \times a)^*a^*\mathcal{F} \ar[u]^{(1_G \times a)^*\alpha} \ar@{=}[r] &
(m \times 1_X)^*a^*\mathcal{F} \ar[u]_{(m \times 1_X)^*\alpha}
}
$$
is a commutative in the category of
$\mathcal{O}_{G \times_S G \times_S X}$-modules, and
\item the pullback
$$
(e \times 1_X)^*\alpha : \mathcal{F} \longrightarrow \mathcal{F}
$$
is the identity map.
\end{enumerate}
For explanation compare with the relevant diagrams of
Equation (\ref{equation-action}).
\end{definition}

\noindent
Note that the commutativity of the first diagram garantees that
$(e \times 1_X)^*\alpha$ is an idempotent operator on $\mathcal{F}$,
and hence condition (2) is just the condition that it is an isomorphism.

\begin{lemma}
\label{lemma-pullback-equivariant}
Let $S$ be a scheme. Let $G$ be a group scheme over $S$.
Let $f : X \to Y$ be a $G$-equivariant morphism between $S$-schemes
endowed with $G$-actions. Then pullback $f^*$ given by
$(\mathcal{F}, \alpha) \mapsto (f^*\mathcal{F}, (1_G \times f)^*\alpha)$
defines a functor from the category of $G$-equivariant sheaves on
$X$ to the category of quasi-coherent $G$-equivariant sheaves on $Y$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}





\section{Groupoids}
\label{section-groupoids}

\noindent
Recall that a groupoid is a category in which every morphism
is an isomorphism, see
Categories, Definition \ref{categories-definition-groupoid}.
Hence a groupoid has a set of objects $\text{Ob}$,
a set of arrows $\text{Arrows}$, a {\it source} and {\it target}
map $s, t : \text{Arrows} \to \text{Ob}$, and a {\it composition law}
$c : \text{Arrows} \times_{s, \text{Ob}, t} \text{Arrows}
\to \text{Arrows}$.
These maps satisfy exactly the following axioms
\begin{enumerate}
\item (associativity) $c \circ (1, c) = c \circ (c, 1)$ as maps
$\text{Arrows} \times_{s, \text{Ob}, t}
\text{Arrows} \times_{s, \text{Ob}, t}
\text{Arrows} \to \text{Arrows}$,
\item (identity) there exists a map $e : \text{Ob} \to \text{Arrows}$
such that
\begin{enumerate}
\item $s \circ e = t \circ e = \text{id}$ as maps $\text{Ob} \to \text{Ob}$,
\item $c \circ (1, e \circ s) = c \circ (e \circ t, 1) = 1$
as maps $\text{Arrows} \to \text{Arrows}$,
\end{enumerate}
\item (inverse) there exists a map $i : \text{Arrows} \to \text{Arrows}$
such that
\begin{enumerate}
\item $s \circ i = t$, $t \circ i = s$ as maps $\text{Arrows} \to \text{Ob}$,
and
\item $c \circ (1, i) = e \circ s$ and $c \circ (i, 1) = e \circ t$
as maps $\text{Arrows} \to \text{Arrows}$.
\end{enumerate}
\end{enumerate}
If this is the case the maps $e$ and $i$ are uniquely determined and
$i$ is a bijection. Note that if $(\text{Ob}', \text{Arrows}', s', t', c')$
is a second groupoid category, then a functor
$f : (\text{Ob}, \text{Arrows}, s, t, c) \to
(\text{Ob}', \text{Arrows}', s', t', c')$
is given by a pair of set maps $f : \text{Ob} \to \text{Ob}'$ and
$f : \text{Arrows} \to \text{Arrows}'$ such that
$s' \circ f = f \circ s$, $t' \circ f = f \circ t$, and
$c' \circ (f, f) = f \circ c$. The compatibility with identity and
inverse is automatic. We will use this below.
(Warning: The compatibility with identity
has to be imposed in the case of general categories.)

\begin{definition}
\label{definition-groupoid}
Let $S$ be a scheme.
\begin{enumerate}
\item A {\it groupoid scheme over $S$}, or simply a
{\it groupoid over $S$} is a
quintuple $(U, R, s, t, c)$ where
$U$ and $R$ are schemes over $S$, and
$s, t : R \to U$ and $c : R \times_{s, U, t} R \to R$
are morphisms of schemes over $S$ with the
following property: For any scheme
$T$ over $S$ the quintuple
$$
(U(T), R(T), s, t, c)
$$
is a groupoid category in the sense described above.
\item A {\it morphism
$f : (U, R, s, t, c) \to (U', R', s', t', c')$
of groupoid schemes over $S$} is given by morphisms
of schemes $f : U \to U'$ and $f : R \to R'$ with the
following property:  For any scheme
$T$ over $S$ the maps $f$ define a functor from the
groupoid category $(U(T), R(T), s, t, c)$ to the
groupoid category $(U'(T), R'(T), s', t', c')$.
\end{enumerate}
\end{definition}

\noindent
Let $(U, R, s, t, c)$ be a groupoid over $S$.
Note that, by the remarks preceding the definition and the Yoneda lemma,
there are unique morphisms of schemes
$e : U \to R$ and
$i : R \to R$ over $S$ such that for every scheme $T$ over $S$
the induced map $e : U(T) \to R(T)$ is the identity, and
$i : R(T) \to R(T)$ is the inverse of
the groupoid category. The septuple $(U, R, s, t, c, e, i)$
satisfies commutative diagrams corresponding to each of the
axioms (1), (2)(a), (2)(b), (3)(a) and (3)(b) above, and conversely
given a septuple with this property the quintuple $(U, R, s, t, c)$
is a groupoid scheme. Note that $i$ is an isomorphism,
and $e$ is a section of both $s$ and $t$.
Moreover, given a groupoid scheme over $S$ we denote
$$
j = (t, s) : R \longrightarrow U \times_S U
$$
which is compatible with our conventions in Section
\ref{section-equivalence-relations} above.
We sometimes say ``let $(U, R, s, t, c, e, i)$ be a
groupoid over $S$'' to stress the existence of identity and
inverse.

\begin{lemma}
\label{lemma-groupoid-pre-equivalence}
Given a groupoid scheme $(U, R, s, t, c)$ over $S$
the morphism $j : R \to U\times_S U$ is a pre-equivalence
relation.
\end{lemma}

\begin{proof}
Omitted.
This is a nice exercise in the definitions.
\end{proof}

\begin{lemma}
\label{lemma-equivalence-groupoid}
Given an equivalence relation $j : R \to U$ over $S$
there is a unique way to extend it to a groupoid
$(U, R, s, t, c)$ over $S$.
\end{lemma}

\begin{proof}
Omitted.
This is a nice exercise in the definitions.
\end{proof}

\begin{lemma}
\label{lemma-diagram}
Let $S$ be a scheme.
Let $(U, R, s, t, c)$ be a groupoid over $S$.
In the commutative diagram
$$
\xymatrix{
& U & \\
R \ar[d]_s \ar[ru]^t &
R \times_{s, U, t} R
\ar[l]^-{\text{pr}_0} \ar[d]^{\text{pr}_1} \ar[r]_-c &
R \ar[d]^s \ar[lu]_t \\
U & R \ar[l]_t \ar[r]^s & U
}
$$
the two lower squares are fibre product squares.
Moreover, the triangle on top (which is really a square)
is also cartesian.
\end{lemma}

\begin{proof}
Omitted.
Exercise in the definitions and the functorial point of
view in algebraic geometry.
\end{proof}







\section{Quasi-coherent sheaves on groupoids}
\label{section-groupoids-quasi-coherent}

\noindent
See the introduction of Section \ref{section-equivariant} for our
choices in direction of arrows.

\begin{definition}
\label{definition-groupoid-module}
Let $S$ be a scheme, let $(U, R, s, t, c)$ be a groupoid scheme over $S$.
A {\it quasi-coherent module on $(U, R, s, t, c)$}
is a pair $(\mathcal{F}, \alpha)$, where $\mathcal{F}$ is a quasi-coherent
$\mathcal{O}_U$-module, and $\alpha$ is a $\mathcal{O}_R$-module
map
$$
\alpha : t^*\mathcal{F} \longrightarrow s^*\mathcal{F}
$$
such that
\begin{enumerate}
\item the diagram
$$
\xymatrix{
& \text{pr}_1^*t^*\mathcal{F} \ar[r]_-{\text{pr}_1^*\alpha} &
\text{pr}_1^*s^*\mathcal{F} \ar@{=}[rd] & \\
\text{pr}_0^*s^*\mathcal{F} \ar@{=}[ru] & & & c^*s^*\mathcal{F} \\
& \text{pr}_0^*t^*\mathcal{F} \ar[lu]^{\text{pr}_0^*\alpha} \ar@{=}[r] &
c^*t^*\mathcal{F} \ar[ru]_{c^*\alpha}
}
$$
is a commutative in the category of
$\mathcal{O}_{R \times_{s, U, t} R}$-modules, and
\item the pullback
$$
e^*\alpha : \mathcal{F} \longrightarrow \mathcal{F}
$$
is the identity map.
\end{enumerate}
Compare with the commutative diagrams of Lemma \ref{lemma-diagram}.
\end{definition}

\noindent
The commutativity of the first diagram forces the operator $e^*\alpha$
to be idempotent. Hence the second condition can be reformulated as saying
that $e^*\alpha$ is an isomorphism.

\begin{lemma}
\label{lemma-pullback}
Let $S$ be a scheme. Consider a morphism
$f : (U, R, s, t, c) \to (U', R', s', t', c')$
of groupoid schemes over $S$. Then pullback $f^*$ given by
$$
(\mathcal{F}, \alpha) \mapsto (f^*\mathcal{F}, f^*\alpha)
$$
defines a functor from the category of quasi-coherent sheaves on
$(U', R', s', t', c')$ to the category of quasi-coherent sheaves on
$(U, R, s, t, c)$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}






\section{Groupoids and group schemes}
\label{section-groupoids-group-schemes}

\noindent
There are many ways to construct a groupoid out of an action $a$
of a group $G$ on a set $V$. We choose the one where we think
of an element $g \in G$ as an arrow with source $v$ and target $a(g, v)$.
This leads to the following construction for group actions of
schemes.

\begin{lemma}
\label{lemma-groupoid-from-action}
Let $S$ be a scheme.
Let $Y$ be a scheme over $S$.
Let $(G, m)$ be a group scheme over $Y$ with
identity $e_G$ and inverse $i_G$.
Let $X/Y$ be a scheme over $Y$ and let $a : G \times_Y X \to X$
be an action of $G$ on $X/Y$.
Then we get a groupoid scheme $(U, R, s, t, c, e, i)$ over $S$
in the following manner:
\begin{enumerate}
\item We set $U = X$, and $R = G \times_Y X$.
\item We set $s : R \to U$ equal to $(g, x) \mapsto x$.
\item We set $t : R \to U$ equal to $(g, x) \mapsto a(g, x)$.
\item We set $c : R \times_{s, U, t} R \to R$ equal to
$((g, a(g', x)), (g', x)) \mapsto (m(g, g'), x)$.
\item We set $e : U \to R$ equal to $x \mapsto (e_G(x), x)$.
\item We set $i : R \to R$ equal to $(g, x) \mapsto (i_G(g), a(g, x))$.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted. Hint: It is enough to show that this works on the set
level. For this use the description above the lemma describing
$g$ as an arrow from $v$ to $a(g, v)$.
\end{proof}

\begin{lemma}
\label{lemma-action-groupoid-modules}
Let $S$ be a scheme.
Let $Y$ be a scheme over $S$.
Let $(G, m)$ be a group scheme over $Y$.
Let $X$ be a scheme over $Y$ and let $a : G \times_Y X \to X$
be an action of $G$ on $X$ over $Y$. Let $(U, R, s, t, c)$ be
the groupoid scheme constructed in Lemma \ref{lemma-groupoid-from-action}.
The rule
$(\mathcal{F}, \alpha) \mapsto (\mathcal{F}, \alpha)$ defines
an equivalence of categories between $G$-equivariant
$\mathcal{O}_X$-modules and the category of quasi-coherent
modules on $(U, R, s, t, c)$.
\end{lemma}

\begin{proof}
The assertion makes sense because $t = a$ and $s = \text{pr}_1$
as morphisms $R = G \times_Y X \to X$, see
Definitions \ref{definition-equivariant-module} and
\ref{definition-groupoid-module}.
Using the translation in Lemma \ref{lemma-groupoid-from-action}
the commutativity requirements
of the two definitions match up exactly.
\end{proof}





\section{The stabilizer group scheme}
\label{section-stabilizer}

\noindent
Given a groupoid scheme we get a group scheme as follows.

\begin{lemma}
\label{lemma-groupoid-stabilizer}
Let $S$ be a scheme.
Let $(U, R, s, t, c)$ be a groupoid over $S$.
The scheme $G$ defined by the cartesian square
$$
\xymatrix{
G \ar[r] \ar[d] & R \ar[d]^{j = (t, s)} \\
U \ar[r]^-{\Delta} & U \times_S U
}
$$
is a group scheme over $U$ with compostion law
$m$ induced by the composition law $c$.
\end{lemma}

\begin{proof}
This is true because in a groupoid category the
set of self maps of any object forms a group.
\end{proof}

\noindent
Since $\Delta$ is an immersion we see that $G = j^{-1}(\Delta_{U/S})$
is a locally closed subscheme of $R$. Thinking of it in this way,
the structure morphism $j^{-1}(\Delta_{U/S}) \to U$ is induced by
either $s$ or $t$ (it is the same), and $m$ is induced by $c$.

\begin{definition}
\label{definition-stabilizer-groupoid}
Let $S$ be a scheme.
Let $(U, R, s, t, c)$ be a groupoid over $S$.
The group scheme $j^{-1}(\Delta_{U/S})\to U$
is called the {\it stabilizer of the groupoid scheme
$(U, R, s, t, c)$}.
\end{definition}

\noindent
In the literature the stabilizer group scheme is often denoted $S$
(because the word stabilizer starts with an ``s'' presumably);
we cannot do this since we have already used $S$ for the base scheme.

\begin{lemma}
\label{lemma-groupoid-action-stabilizer}
Let $S$ be a scheme.
Let $(U, R, s, t, c)$ be a groupoid over $S$, and let $G/U$ be its stabilizer.
Denote $R_t/U$ the scheme $R$ seen as a scheme over $U$ via the
morphism $t : R \to U$.
There is a canonical left action
$$
a : G \times_U R_t \longrightarrow R_t
$$
induced by the composition law $c$.
\end{lemma}

\begin{proof}
In terms of points over $T/S$ we define $a(g, r) = c(g, r)$.
\end{proof}








\section{Restricting groupoids}
\label{section-restrict-groupoid}

\noindent
Consider a (usual) groupoid
$\mathcal{C} = (\text{Ob}, \text{Arrows}, s, t, c)$.
Suppose we have a map of sets $g : \text{Ob}' \to \text{Ob}$.
Then we can construct a groupoid
$\mathcal{C}' = (\text{Ob}', \text{Arrows}', s', t', c')$
by thinking of a morphism between elements $x', y'$ of $\text{Ob}'$
as a morphisms in $\mathcal{C}$ between $g(x'), g(y')$.
In other words we set
$$
\text{Arrows}' =
\text{Ob}'
\times_{g, \text{Ob}, t}
\text{Arrows}
\times_{s, \text{Ob}, g}
\text{Ob}'.
$$
with obvious choices for $s'$, $t'$, and $c'$. There is a canonical
functor $\mathcal{C}' \to \mathcal{C}$ which is fully faithful,
but not necessarily essentially surjective. This groupoid $\mathcal{C}'$
endowed with the functor $\mathcal{C}' \to \mathcal{C}$
is called the {\it restriction} of the groupoid
$\mathcal{C}$ to $\text{Ob}'$.

\begin{lemma}
\label{lemma-restrict-groupoid}
Let $S$ be a scheme.
Let $(U, R, s, t, c)$ be a groupoid scheme over $S$.
Let $g : U' \to U$ be a morphism of schemes.
Consider the following diagram
$$
\xymatrix{
R' \ar[d] \ar[r] \ar@/_3pc/[dd]_{t'} \ar@/^1pc/[rr]^{s'}&
R \times_{s, U} U' \ar[r] \ar[d] &
U' \ar[d]^g \\
U' \times_{U, t} R \ar[d] \ar[r] &
R \ar[r]^s \ar[d]_t &
U \\
U' \ar[r]^g &
U
}
$$
where all the squares are fibre product squares. Then there is a
canonical composition law $c' : R' \times_{s', U', t'} R' \to R'$
such that $(U', R', s', t', c')$ is a groupoid scheme over
$S$ and such that $U' \to U$, $R' \to R$ defines a morphism
$(U', R', s', t', c') \to (U, R, s, t, c)$ of groupoid schemes over $S$.
Moreover, for any scheme $T$ over $S$ the functor of groupoids
$$
(U'(T), R'(T), s', t', c') \to (U(T), R(T), s, t, c)
$$
is the restriction (see above) of $(U(T), R(T), s, t, c)$ via the map
$U'(T) \to U(T)$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{definition}
\label{definition-restrict-groupoid}
Let $S$ be a scheme.
Let $(U, R, s, t, c)$ be a groupoid scheme over $S$.
Let $g : U' \to U$ be a morphism of schemes.
The morphism of groupoids
$(U', R', s', t', c') \to (U, R, s, t, c)$
constructed in Lemma \ref{lemma-restrict-groupoid} is called
the {\it restriction of $(U, R, s, t, c)$ to $U'$}.
We sometime use the notation $R' = R|_{U'}$ in this case.
\end{definition}

\begin{lemma}
\label{lemma-restrict-groupoid-relation}
The notions of restricting groupoids and 
(pre-)equivalence relations defined in Definitions
\ref{definition-restrict-groupoid} and \ref{definition-restrict-relation}
agree via the constructions of
Lemmas \ref{lemma-groupoid-pre-equivalence} and
\ref{lemma-equivalence-groupoid}.
\end{lemma}

\begin{proof}
What we are saying here is that $R'$ of
Lemma \ref{lemma-restrict-groupoid} is also
equal to
$$
R' = (U' \times_S U')\times_{U \times_S U} R
\longrightarrow
U' \times_S U'
$$
In fact this might have been a clearer way to state that lemma.
\end{proof}





\section{Invariant subschemes}
\label{section-invariant}

\noindent
In this section we discuss briefly the notion of an invariant subscheme.

\begin{definition}
\label{definition-invariant-open}
Let $(U, R, s, t, c)$ be a groupoid scheme over the base scheme $S$.
\begin{enumerate}
\item We say an open $W \subset U$ is {\it $R$-invariant} if
$t(s^{-1}(W)) \subset W$.
\item A closed subscheme $Z \subset U$ is called $R$-invariant
if $t^{-1}(Z) = s^{-1}(Z)$. Here we use the scheme theoretic inverse image, see
Schemes, Definition \ref{schemes-definition-inverse-image-closed-subscheme}.
\end{enumerate}
\end{definition}

\noindent
For an open subscheme $W \subset U$ the $R$-invariance
is also equivalent to requiring that $s^{-1}(W) = t^{-1}(W)$.
If $W \subset U$ is $R$-equivariant then the restriction of $R$ to
$W$ is just $R_W = s^{-1}(W) = t^{-1}(W)$. Similarly, if $Z \subset U$
is an $R$-invariant closed subscheme, then the restriction of $R$
to $Z$ is just $R_Z = s^{-1}(Z) = t^{-1}(Z)$.

\begin{lemma}
\label{lemma-constructing-invariant-opens}
Let $S$ be a scheme.
Let $(U, R, s, t, c)$ be a groupoid scheme over $S$.
\begin{enumerate}
\item If $s$ and $t$ are open, then for every open $W \subset U$
the open $s(t^{-1}(W))$ is $R$-invariant.
\item If $s$ and $t$ are open and quasi-compact, then $U$ has an open
covering consisting of $R$-invariant quasi-compact open subschemes.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume $s$ and $t$ open and $W \subset U$ open.
Since $s$ is open the set $W' = s(t^{-1}(W))$ is an open subset of $U$.
Now it is quite easy to using the functorial point of view
that this is an $R$-invariant open subset of $U$, but we are going to argue
this directly by some diagrams, since we think it is instructive.
Note that $t^{-1}(W')$ is the image of the morphism
$$
A := t^{-1}(W) \times_{s|_{t^{-1}(W)}, U, t} R
\xrightarrow{\text{pr}_1} R
$$
and that $s^{-1}(W')$ is the image of the morphism
$$
B := R \times_{s, U, s|_{t^{-1}(W)}} t^{-1}(W)
\xrightarrow{\text{pr}_0} R.
$$
The schemes $A$, $B$ on the left of the arrows above are open subschemes of
$R \times_{s, U, t} R$ and $R \times_{s, U, s} R$ respectively.
By Lemma \ref{lemma-diagram} the diagram
$$
\xymatrix{
R \times_{s, U, t} R \ar[rd]_{\text{pr}_1} \ar[rr]_{(\text{pr}_1, c)} & &
R \times_{s, U, s} R \ar[ld]^{\text{pr}_0} \\
& R &
}
$$
is commutative, and the horizontal arrow is an isomorphism. Moreover, it is
clear that $(\text{pr}_1, c)(A) = B$. Hence we conclude
$s^{-1}(W') = t^{-1}(W')$, and $W'$ is $R$-invariant. This proves (1).

\medskip\noindent
Assume now that $s$, $t$ are both open and quasi-compact.
Then, if $W \subset U$ is a quasi-compact open, then also
$W' = s(t^{-1}(W))$ is a quasi-compact open, and invariant by the
discussion above. Letting $W$ range over all affine opens of $U$
we see (2).
\end{proof}





\section{Quotient sheaves}
\label{section-quotient-sheaves}

\noindent
Let $\tau \in \{Zariski, etale, fppf, smooth, syntomic\}$.
Let $S$ be a scheme.
Let $j : R \to U\times_S U$ be a pre-relation over $S$.
Say $U, R, S$ are objects of a $\tau$-site $\textit{Sch}_\tau$
(see Topologies, Section \ref{topologies-section-procedure}).
Then we can consider the functors
$$
h_U, h_R :
(\textit{Sch}/S)_\tau^{opp}
\longrightarrow
\textit{Sets}.
$$
These are sheaves, see
Descent, Lemma \ref{descent-lemma-fpqc-universal-effective-epimorphisms}.
The morphism $j$ induces a map $j : h_R \to h_U \times h_U$.
For each object $T \in \text{Ob}((\textit{Sch}/S)_\tau)$
we can take the equivalence relation $\sim_T$ generated by
$j(T) : R(T) \to U(T) \times U(T)$ and consider the quotient.
Hence we get a presheaf
\begin{equation}
\label{equation-quotient-presheaf}
(\textit{Sch}/S)_\tau^{opp}
\longrightarrow
\textit{Sets},\quad
T \longmapsto U(T)/\sim_T
\end{equation}

\begin{definition}
\label{definition-quotient-sheaf}
Let $\tau$, $S$, and the pre-relation $j : R \to U \times_S U$ be as above.
In this setting the {\it quotient sheaf $U/R$} associated
to $j$ is the sheafification of the presheaf
(\ref{equation-quotient-presheaf}) in the $\tau$-topology.
If $j : R \to U \times_S U$ comes from the action of a group scheme
$G/S$ on $U$ as in Lemma \ref{lemma-groupoid-from-action} then we
sometimes denote the quotient sheaf $U/G$.
\end{definition}

\noindent
This means exactly that the diagram
$$
\xymatrix{
h_R \ar@<1ex>[r] \ar@<-1ex>[r] &
h_U \ar[r] &
U/R
}
$$
is a coequalizer diagram in the category of sheaves of sets
on $(\textit{Sch}/S)_\tau$. Using the Yoneda embedding we
may view $(\textit{Sch}/S)_\tau$ as a full subcategory of
sheaves on $(\textit{Sch}/S)_\tau$ and hence identify schemes
with representable functors. Using this abuse of notation
we will often depict the diagram above simply
$$
\xymatrix{
R \ar@<1ex>[r]^s \ar@<-1ex>[r]_t &
U \ar[r] &
U/R
}
$$
We will mostly work with the fppf topology when considering
quotient sheaves of groupoids/equivalence relations.

\begin{definition}
\label{definition-representable-quotient}
In the situation of Definition \ref{definition-quotient-sheaf}.
We say that the pre-relation $j$ has a
{\it representable quotient} if the sheaf $U/R$ is representable.
We will say a groupoid $(U, R, s, t, c)$ has a
{\it representable quotient}
if the quotient $U/R$ with $j = (t, s)$ is representable.
\end{definition}

\noindent
The following lemma characterizes schemes $M$ representing the quotient.
It applies for example if $\tau = fppf$, $U \to M$ is flat,
of finite presentation and surjective, and $R \cong U \times_M U$.

\begin{lemma}
\label{lemma-criterion-quotient-representable}
In the situation of Definition \ref{definition-quotient-sheaf}.
Assume there is a scheme $M$, and a morphism $U \to M$ such that
\begin{enumerate}
\item the morphism $U \to M$ equalizes $s, t$,
\item the morphism $U \to M$ induces a surjection of sheaves
$h_U \to h_M$ in the $\tau$-topology, and
\item the induced map $(t, s) : R \to U \times_M U$ induces a
surjection of sheaves $h_R \to h_{U \times_M U}$ in the $\tau$-topology.
\end{enumerate}
In this case $M$ represents the quotient sheaf $U/R$.
\end{lemma}

\begin{proof}
Condition (1) says that $h_U \to h_M$ factors through $U/R$.
Condition (2) says that $U/R \to h_M$ is surjective as a map of sheaves.
Condition (3) says that $U/R \to h_M$ is injective as a map of sheaves.
Hence the lemma follows.
\end{proof}

\noindent
The following lemma is wrong if we do not require $j$ to be a
pre-equivalence relation (but just a pre-relation say).

\begin{lemma}
\label{lemma-quotient-pre-equivalence}
Let $\tau \in \{Zariski, etale, fppf, smooth, syntomic\}$.
Let $S$ be a scheme.
Let $j : R \to U \times_S U$ be a pre-equivalence relation over $S$.
Assume $U, R, S$ are objects of a $\tau$-site $\textit{Sch}_\tau$.
For $T \in \text{Ob}((\textit{Sch}/S)_\tau)$ and
$a, b \in U(T)$ the following are equivalent:
\begin{enumerate}
\item $a$ and $b$ map to the same element of $(U/R)(T)$, and
\item there exists a $\tau$-covering $\{f_i : T_i \to T\}$ of $T$
and morphisms $r_i : T_i \to R$ such that
$a \circ f_i = s \circ r_i$ and $b \circ f_i = t \circ r_i$.
\end{enumerate}
In other words, in this case the map of $\tau$-sheaves
$$
h_R \longrightarrow h_U \times_{U/R} h_U
$$
is surjective.
\end{lemma}

\begin{proof}
Omitted. Hint: The reason this works is that the presheaf
(\ref{equation-quotient-presheaf}) in this case is really given
by $T \mapsto U(T)/j(R(T))$ as $j(R(T)) \subset U(T) \times U(T)$
is an equivalence relation, see 
Definition \ref{definition-equivalence-relation}.
\end{proof}

\begin{lemma}
\label{lemma-quotient-pre-equivalence-relation-restrict}
Let $\tau \in \{Zariski, etale, fppf, smooth, syntomic\}$.
Let $S$ be a scheme.
Let $j : R \to U\times_S U$ be a pre-equivalence relation over $S$
and $g : U' \to U$ a morphism of schemes over $S$.
Let $j' : R' \to U' \times_S U'$ be the restriction of $j$ to $U'$. 
Assume  $U, U', R, S$ are objects of a $\tau$-site $\textit{Sch}_\tau$.
The map of quotient sheaves
$$
U'/R' \longrightarrow U/R
$$
is injective. If $g$ defines a surjection $h_{U'} \to h_U$ of sheaves
in the $\tau$-topology (for example if $\{g : U' \to U\}$ is a
$\tau$-covering), then $U'/R' \to U/R$ is an isomorphism.
\end{lemma}

\begin{proof}
Suppose $\xi, \xi' \in (U'/R')(T)$ are sections which
map to the same section of $U/R$.
Then we can find a $\tau$-covering $\mathcal{T} = \{T_i \to T\}$ of $T$
such that $\xi|_{T_i}, \xi'|_{T_i}$ are given by $a_i, a_i' \in U'(T_i)$. By
Lemma \ref{lemma-quotient-pre-equivalence}
and the axioms of a site we may after refining
$\mathcal{T}$ assume there exist morphisms $r_i : T_i \to R$
such that $g \circ a_i = s \circ r_i$, $g \circ a_i' = t \circ r_i$.
Since by construction
$R' = R \times_{U \times_S U} (U' \times_S U')$
we see that $(r_i, (a_i, a_i')) \in R'(T_i)$ and this
shows that $a_i$ and $a_i'$ define the same section
of $U'/R'$ over $T_i$. By the sheaf condition this implies
$\xi = \xi'$.

\medskip\noindent
If $h_{U'} \to h_U$ is a surjection
of sheaves, then of course $U'/R' \to U/R$ is surjective also.
If $\{g : U' \to U\}$ is a $\tau$-covering, then
the map of sheaves $h_{U'} \to h_U$ is surjective, see
Sites, Lemma \ref{sites-lemma-covering-surjective-after-sheafification}.
Hence $U'/R' \to U/R$ is surjective also in this case.
\end{proof}

\begin{lemma}
\label{lemma-quotient-groupoid-restrict}
Let $\tau \in \{Zariski, etale, fppf, smooth, syntomic\}$.
Let $S$ be a scheme.
Let $(U, R, s, t, c)$ be a groupoid scheme over $S$.
Let $g : U' \to U$ a morphism of schemes over $S$.
Let $(U', R', s', t', c')$ be the restriction of $(U, R, s, t, c)$ to $U'$. 
Assume  $U, U', R, S$ are objects of a $\tau$-site $\textit{Sch}_\tau$.
The map of quotient sheaves
$$
U'/R' \longrightarrow U/R
$$
is injective. If the composition
$$
\xymatrix{
U' \times_{g, U, t} R \ar[r]_-{\text{pr}_1} \ar@/^3ex/[rr]^h
& R \ar[r]_s & U
}
$$
defines a surjection of sheaves in the $\tau$-topology  then
the map is bijective. This holds for example if
$\{h : U' \times_{g, U, t} R \to U\}$ is a $\tau$-covering, or
if $U' \to U$ defines a surjection of sheaves in the $\tau$-topology, or if
$\{g : U' \to U\}$ is a covering in the $\tau$-topology.
\end{lemma}

\begin{proof}
Injectivity follows on combining
Lemmas \ref{lemma-groupoid-pre-equivalence} and
\ref{lemma-quotient-pre-equivalence-relation-restrict}.
To see surjectivity (see
Sites, Section \ref{sites-section-sheaves-injective}
for a characterization of surjective maps of sheaves) we argue as follows.
Suppose that $T$ is a scheme and $\sigma \in U/R(T)$.
There exists a covering $\{T_i \to T\}$ such that $\sigma|_{T_i}$
is the image of some element $f_i \in U(T_i)$. Hence we
may assume that $\sigma$ if the image of $f \in U(T)$.
By the assumption that $h$ is a surjection of sheaves, we
can find a $\tau$-covering $\{\varphi_i : T_i \to T\}$ and morphisms
$f_i : T_i \to U' \times_{g, U, t} R$ such that
$f \circ \varphi_i = h \circ f_i$. Denote
$f'_i = \text{pr}_0 \circ f_i : T_i \to U'$. Then we see that
$f'_i \in U'(T_i)$ maps to $g \circ f'_i \in U(T_i)$ and
that $g \circ f'_i \sim_{T_i} h \circ f_i = f \circ \varphi_i$
notation as in (\ref{equation-quotient-presheaf}). Namely, the
element of $R(T_i)$ giving the relation is $\text{pr}_1 \circ f_i$.
This means that the restriction
of $\sigma$ to $T_i$ is in the image of $U'/R'(T_i) \to U/R(T_i)$
as desired.

\medskip\noindent
If $\{h\}$ is a $\tau$-covering, then it induces a surjection of sheaves, see
Sites, Lemma \ref{sites-lemma-covering-surjective-after-sheafification}.
If $U' \to U$ is surjective, then also $h$ is surjective as $s$ has a section
(namely the neutral element $e$ of the groupoid scheme).
\end{proof}












\section{Some technical lemmas}
\label{section-technical-lemma}

\noindent
Lemma \ref{lemma-diagram} gives us a way to compare the fibres of the map
$s : R \to U$ in a groupoid. We work this out in this section.

\begin{lemma}
\label{lemma-property-invariant}
Let $S$ be a scheme.
Let $(U, R, s, t, c)$ be a groupoid over $S$.
Let $\tau \in \{Zariski,\linebreak[0] fppf, \linebreak[0] etale,\linebreak[0]
smooth,\linebreak[0] syntomic\}$\footnote{The fact that $fpqc$ is missing
is not a typo.}. Let $\mathcal{P}$ be a property of morphisms of schemes
which is $\tau$-local on the target
(Descent, Definition \ref{descent-definition-property-morphisms-local}).
Assume $\{s : R \to U\}$ and $\{t : R \to U\}$ are coverings for the
$\tau$-topology. Let $W \subset U$ be the maximal open subscheme such that
$s^{-1}(W) \to W$ has property $\mathcal{P}$.
Then $W$ is $R$-invariant (Definition \ref{definition-invariant-open}).
\end{lemma}

\begin{proof}
Because $\mathcal{P}$ is $\tau$-local on the base, we see that in particular
$\mathcal{P}$ is Zariski local on the base. Hence $W$ is simply the union
of all Zariski open subschemes of $U$ over which the morphism $s$ has property
$\mathcal{P}$, i.e., the assertion of the lemma makes sense.
Next, consider the diagram in Lemma \ref{lemma-diagram}.
Let $W_1 \subset R$ be the maximal open subscheme over which the morphism
$\text{pr}_1 : R \times_{s, U, t} R \to R$ has property $\mathcal{P}$.
By assumption the morphisms $t$, $s$ are open immersions,
flat of finite presentation, etale, smooth, or syntomic, they are
in particular open, see
Morphisms, Lemma \ref{morphisms-lemma-fppf-open}.
Hence $W' = s(W_1)$ and $W'' = t(W_1)$ are open subschemes of $U$.
Moreover, $\{s|_{W_1} : W_1 \to W'\}$ and $\{t|_{W_1} : W_1 \to W''\}$
are $\tau$-coverings by our assumption that
$\{s : R \to U\}$ and $\{t : R \to U\}$ are $\tau$-coverings, see
Topologies, Definitions
\ref{topologies-definition-zariski-covering},
\ref{topologies-definition-fppf-covering},
\ref{topologies-definition-etale-covering},
\ref{topologies-definition-smooth-covering}, and
\ref{topologies-definition-syntomic-covering}.
Since the two lower squares of the diagram in Lemma \ref{lemma-diagram}
are cartesian we now conclude that
\begin{enumerate}
\item $s : R \to U$ has property $\mathcal{P}$ over $W'$,
\item $t : R \to U$ has property $\mathcal{P}$ over $W''$, and also
\item $\text{pr}_1 : R \times_{s, U, t} R \to R$ has property
$\mathcal{P}$ over $t^{-1}(W)$, and
\item $\text{pr}_1 : R \times_{s, U, t} R \to R$ has property
$\mathcal{P}$ over $s^{-1}(W)$.
\end{enumerate}
Clarification: The first two statements come from descending the property
through the coverings mentioned above, the second two by going up along the
coverings $\{s|_{s^{-1}(W)} : s^{-1}(W) \to W\}$ and
$\{t|_{t^{-1}(W)} : t^{-1}(W) \to W\}$.
All in all we conclude that
$W', W'' \subset W$ and $t^{-1}(W), s^{-1}(W) \subset W_1$. In other words
$W_1 = s^{-1}(W) = t^{-1}(W)$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-diagram-pull}
Let $S$ be a scheme.
Let $(U, R, s, t, c, e, i)$ be a groupoid over $S$.
The diagram
\begin{equation}
\label{equation-pull}
\xymatrix{
R \times_{t, U, t} R
\ar@<1ex>[r]^-{\text{pr}_1} \ar@<-1ex>[r]_-{\text{pr}_0}
\ar[d]_{\text{pr}_0 \times c \circ (i, 1)} &
R \ar[r]^t \ar[d]^{\text{id}_R} &
U \ar[d]^{\text{id}_U} \\
R \times_{s, U, t} R
\ar@<1ex>[r]^-c \ar@<-1ex>[r]_-{\text{pr}_0} \ar[d]_{\text{pr}_1} &
R \ar[r]^t \ar[d]^s &
U \\
R \ar@<1ex>[r]^s \ar@<-1ex>[r]_t &
U
}
\end{equation}
is commutative. The two top rows are isomorphic via the vertical maps given.
The two lower left squares are cartesian.
\end{lemma}

\begin{proof}
The commutativity of the diagram follows from the axioms of a groupoid.
Note that, in terms of groupoids, the top left vertical arrow assigns to
a pair of morphisms $(\alpha, \beta)$ with the same target, the pair
of morphisms $(\alpha, \alpha^{-1} \circ \beta)$. In any groupoid
this defines a bijection between
$\text{Arrows} \times_{t, \text{Ob}, t} \text{Arrows}$
and
$\text{Arrows} \times_{s, \text{Ob}, t} \text{Arrows}$. Hence the second
assertion of the lemma.
The last assertion follows from Lemma \ref{lemma-diagram}.
\end{proof}

\noindent
Consider two pairs $(X, x)$, $(S, s)$
where $X$, $S$ are schemes, $x$, $s$ are points.
A {\it morphism of germs} $f : (X, x) \to (S, s)$
is a morphism $f : U \to S$ defined on an open neighbourhood
of $x$ with $f(x) = s$. Two such
$f$, $f'$ are said to give the same morphism of germs
if and only if $f$ and $f'$ agree in some open neighbourhood of $x$.
Let $\tau \in \{Zariski, fpqc, fppf, etale, smooth, syntomic\}$.
We temporarily
introduce the following concept: We say that two morphisms
of germs $f : (X, x) \to (S, s)$ and $f' : (X', x') \to (S', s')$
are {\it isomorphic locally on the base in the $\tau$-topology},
if there exists a pointed scheme $(S'', s'')$ and morphisms of germs
$g : (S'', s'') \to (S, s)$, and $g' : (S'', s'') \to (S', s')$
such that
\begin{enumerate}
\item there exist open neighbourhoods $V$ of $s$
and $V''$ of $s''$ such that $\{g|_{V''} : V'' \to V\}$ is
a $\tau$-covering,
\item there exist open neighbourhoods $V'$ of $s'$
and $V''$ of $s''$ such that $\{g'|_{V''} : V'' \to V'\}$ 
is a $\tau$-covering,
\item there exists an isomorphism
$$
(S'' \times_{g, S, f} X, \tilde x)
\cong
(S'' \times_{g', S', f'} X', \tilde  x')
$$
of germs over the germ $(S'', s'')$ for some choice of points
$\tilde x$ and $\tilde x'$ lying over $(s'', x)$ and $(s'', x')$.
\end{enumerate}
Finally, we simply say that the maps of germs
$f : (X, x) \to (S, s)$ and $f' : (X', x') \to (S', s')$
are {\it flat locally on the base isomorphic} if there exist
$S'', s'', g, g'$ as above but with (1) and (2) simply replaced by
the condition that the local ring maps
$\mathcal{O}_{S, s} \to \mathcal{O}_{S'', s''}$
and $\mathcal{O}_{S', s'} \to \mathcal{O}_{S'', s''}$ are flat.

\begin{lemma}
\label{lemma-two-fibres}
Let $S$ be a scheme.
Let $(U, R, s, t, c)$ be a groupoid over $S$.
Let $r, r' \in R$ with $t(r) = t(r')$ in $U$.
Set $u = s(r)$, $u' = s(r')$.
Denote $F_u = s^{-1}(u)$ and $F_{u'} = s^{-1}(u')$ the scheme
theoretic fibres.
\begin{enumerate}
\item There exists a common field extension
$\kappa(u) \subset k$, $\kappa(u') \subset k$ and
an isomorphism $(F_u)_k \cong (F_{u'})_k$.
\item We may choose the isomorphism above such that a point
lying over $r$ maps to a point lying over $r'$.
\item If the morphisms $s$, $t$ are flat then the morphisms of germs
$s : (R, r) \to (U, u)$ and $s : (R, r') \to (U, u')$ are flat
locally on the base isomorphic.
\item If the morphisms $s$, $t$ are
flat and locally of finite presentation (resp.\ etale, smooth or
syntomic) then the morphisms of germs $s : (R, r) \to (U, u)$
and $s : (R, r') \to (U, u')$ are locally on the base isomorphic
in the fppf (resp.\ etale, smooth, syntomic) topology.
\end{enumerate}
\end{lemma}

\begin{proof}
We repeatedly use the properties and the existence of the diagram of
Lemma \ref{lemma-diagram}.
By the last assertion of that lemma (and
Schemes, Lemma \ref{schemes-lemma-points-fibre-product})
there exists a point $\xi$ of $R \times_{s, U, t} R$
with $\text{pr}_0(\xi) = r$ and $c(\xi) = r'$.
Let $\tilde r = \text{pr}_1(\xi) \in R$.

\medskip\noindent
Proof of (1). Set $k = \kappa(\tilde r)$. Since $t(\tilde r) = u$
and $s(\tilde r) = r'$ we see that $k$ is a common extension
of both $\kappa(u)$ and $\kappa(u')$ and in fact that
both $(F_u)_k$ and $(F_{u'})_k$ are isomorphic to the fibre of
$\text{pr}_1 : R \times_{s, U, t} R \to R$ over $\tilde r$.
Hence (1) is proved.

\medskip\noindent
Part (2) follows since the point $\xi$ maps to $r$, resp.\ $r'$.

\medskip\noindent
Part (3) is clear from the above (using the point $\xi$ for
$\tilde u$ and $\tilde u'$) and the definitions.

\medskip\noindent
If $s$ and $t$ are flat and of finite presentation, then
they are open morphisms (Morphisms, Lemma \ref{morphisms-lemma-fppf-open}).
Hence the image of some affine open neighbourhood $V''$ of $\tilde r$ will
cover an open neighbourhood $V$ of $u$, resp.\ $V'$ of $u'$.
These can be used to show that properties (1) and (2) of the
definition of ``locally on the base isomorphic in the
$\tau$-topology''.
\end{proof}

\noindent
The following lemma means that any groupoid $(U, R, s, t, c)$
with $s, t$ flat and locally of finite presentation is ``equivalent'' to
a groupoid $(U', R', s', t', c')$ such that $s'$ and $t'$ are
Cohen-Macaulay morphisms (and locally of finite presentation). See
More on Morphisms, Section \ref{more-morphisms-section-CM}
for more information on Cohen-Macaulay morphisms.
Here ``equivalent'' can be taken to mean that the quotient stacks
$[U/R]$ and $[U'/R']$ are equivalent stacks, see
Groupoid Spaces, Section \ref{spaces-groupoids-section-stacks}
and Section \ref{spaces-groupoids-section-quotient-stack-restrict}.

\begin{lemma}
\label{lemma-make-CM}
Let $S$ be a scheme.
Let $(U, R, s, t, c)$ be a groupoid over $S$.
Assume $s$ and $t$ are flat and locally of finite presentation.
Then there exists an open $U' \subset U$ such that
\begin{enumerate}
\item $t^{-1}(U') \subset R$ is the largest open subscheme of
$R$ on which the morphism $s$ is Cohen-Macaulay,
\item $s^{-1}(U') \subset R$ is the largest open subscheme of
$R$ on which the morphism $t$ is Cohen-Macaulay,
\item the morphism $t|_{s^{-1}(U')} : s^{-1}(U') \to U$ is
surjective,
\item the morphism $s|_{t^{-1}(U')} : t^{-1}(U') \to U$ is
surjective, and
\item the restriction $R' = s^{-1}(U') \cap t^{-1}(U')$
of $R$ to $U'$ defines a groupoid $(U', R', s', t', c')$ which has the property
that the morphisms $s'$ and $t'$ are Cohen-Macaulay and locally of
finite presentation.
\end{enumerate}
\end{lemma}

\begin{proof}
We will repeatedly use the results of
Varieties, Lemma \ref{varieties-lemma-CM-base-change}
and
More on Morphisms,
Lemma \ref{more-morphisms-lemma-flat-finite-presentation-CM-open}
without further mention. It implies in particular that for a morphism
$X \to Y$ which is flat and locally of finite presentation the locus
where the morphism is Cohen-Macaulay is an open whose formation commutes
with arbitrary base change, equals the set of points of $X$ where
the local ring of the fibre is Cohen-Macaulay, and is dense in every
fibre of $X \to Y$.
Let $W \subset R$ be the largest open subscheme of $R$ on which the morphism
$s$ is Cohen-Macaulay. Pick $r, r' \in R$ with $u_0 = t(r) = t(r') \in U$.
Set $u = s(r)$, $u' = s(r')$, $F_u = s^{-1}(u)$, and $F_{u'} = s^{-1}(u')$.
By
Lemma \ref{lemma-two-fibres} parts (1) and (2)
and the results referenced above we see that
\begin{align*}
s\text{ Cohen-Macaulay at }r
& \Leftrightarrow
\mathcal{O}_{F_u, r}\text{ Cohen-Macaulay} \\
& \Leftrightarrow
\mathcal{O}_{F_{u'}, r'}\text{ Cohen-Macaulay} \\
& \Leftrightarrow
s\text{ Cohen-Macaulay at }r'
\end{align*}
Hence it follows immediately that $W = t^{-1}(U')$ for some subset
$U' \subset U$. Of course $t(W) = U'$ and since $t$ is open
(Morphisms, Lemma \ref{morphisms-lemma-fppf-open})
we conclude that $U'$ is open. Let $i : R \to R$ be the inverse of the
groupoid. Since $s \circ i = t$ and $t \circ i = s$ we see that $s^{-1}(U')$
is also the largest open of $R$ on which $t$ is Cohen-Macaulay.
This proves (1) and (2).
Part (3) follows as the set of points where $t$ is Cohen-Macaulay
is dense in every fibre. Same argument for (4).
Part (5) is a formal consequence of (1) and (2) and the discussion
of restrictions in Section \ref{section-restrict-groupoid}.
\end{proof}

\begin{lemma}
\label{lemma-make-CM-generalize}
Let $S$ be a scheme.
Let $(U, R, s, t, c)$ be a groupoid over $S$.
Assume $s$ and $t$ are flat and locally of finite presentation.
Let $g : U' \to U$ be locally of finite presentation.
Denote $h$ the composition
$$
\xymatrix{
U' \times_{g, U, t} R \ar[r]_-{\text{pr}_1} & R \ar[r]_s & U.
}
$$
Let $\mathcal{P}$ be one of the following properties of morphisms
of schemes: flat, Cohen-Macaulay, syntomic, smooth, etale,
having relative dimension $\leq d$ (add more here as needed).
There exists an open subscheme $U'' \subset U'$ such that
$U'' \times_{g, U, t} R \subset U' \times_{g, U, t} R$ is
the maximal open subscheme on which $h$ is $\mathcal{P}$.
\end{lemma}

\begin{proof}
Consider the diagram
$$
\xymatrix{
U' \times_{g, U, t} (R \times_{t, U, t} R)
\ar[rr]_-{c \circ (i, 1)}
\ar@<1ex>[d]^-{\text{pr}_1} \ar@<-1ex>[d]_-{\text{pr}_0} & &
R
\ar@<1ex>[d]^-{s} \ar@<-1ex>[d]_-{t}
\\
U' \times_{g, U, t} R \ar[rr]^h & & U
}
$$
This diagram is commutative and both squares are cartesian by
Lemma \ref{lemma-diagram-pull}. We first prove this lemma for
$\mathcal{P}=$``flat''. Let $W \subset U' \times_{g, U, t} R$
be the largest open subscheme on which $h$ is flat. By
More on Morphisms, Lemma \ref{more-morphisms-theorem-openess-flatness}
we see that $W$ exists. By
More on Morphisms, Lemma \ref{more-morphisms-lemma-flat-locus-base-change}
the formation of $W$ commutes with arbitrary base change.
Hence we see that $\text{pr}_0^{-1}(W) = \text{pr}_1^{-1}(W)$ is the largest
opem subscheme on which $c \circ (i, 1)$ is flat. Since the projection
$\pi : U' \times_{g, U, t} R \to U'$ is surjective, flat and locally of finite
presentation as a base change of $t$ we conclude that
$W = \pi^{-1}(U'')$ for some open subscheme $U'' \subset U'$, see
Descent, Lemma \ref{descent-lemma-open-fpqc-covering}.

\medskip\noindent
In the case $\mathcal{P}=$``Cohen-Macaulay'' the same argument works
using
More on Morphisms,
Lemmas \ref{more-morphisms-lemma-base-change-CM} and
\ref{more-morphisms-lemma-flat-finite-presentation-CM-open}.
In the case $\mathcal{P}=$``syntomic'' use
Morphisms, Lemma \ref{morphisms-lemma-set-points-where-fibres-lci}
(the locus is automically open).
In the case $\mathcal{P}=$``smooth'' use
Morphisms, Lemma \ref{morphisms-lemma-set-points-where-fibres-smooth}
(the locus is automically open).
In the case $\mathcal{P}=$``etale'' use
Morphisms, Lemma \ref{morphisms-lemma-set-points-where-fibres-etale}
(the locus is automically open).
In the case $\mathcal{P}=$``relative dimension $\leq d$''
the locus is open by
Morphisms, Lemma \ref{morphisms-lemma-openness-bounded-dimension-fibres}
and formation commutes with base change by
Morphisms, Lemma \ref{morphisms-lemma-dimension-fibre-after-base-change}.
\end{proof}

\begin{lemma}
\label{lemma-slice}
Let $S$ be a scheme.
Let $(U, R, s, t, c, e, i)$ be a groupoid scheme over $S$.
Let $G \to U$ be the stabilizer group scheme.
Assume $s$ and $t$ are Cohen-Macaulay and locally of finite presentation.
Let $u \in U$.
Set $r = e(u)$ and $F_u = s^{-1}(u)$. Set
$$
d_1 = \dim(G_u),\quad d_2 = \dim_r(F_u).
$$
If $d_2 > d_1$, then there exist an affine scheme $U'$
and a morphism $g : U' \to U$ such that
\begin{enumerate}
\item $g$ is an immersion and locally of finite presentation,
\item $u \in U'$,
\item the composition
$$
h = s \circ \text{pr}_1 : U' \times_{g, U, t} R \longrightarrow U
$$
is Cohen-Macaulay at $(u, r)$, and
\item letting $R'$ be the restriction of $R$ to $U'$ and setting
$F'_u = (s')^{-1}(u)$ we have $\dim_r(F'_u) = d_2 - 1$.
\end{enumerate}
WARNING: The formulation of this lemma is currently wrong.
If $u$ is a point of finite type over $S$ then it is probably
OK. The error in the proof is that the second displayed equation
is wrong.
\end{lemma}

\begin{proof}
Let $\text{Spec}(A) \subset U$ be an affine neighbourhood of $u$.
Let $\text{Spec}(B) \subset R$ be an affine neighbourhood of $r$
which maps via $j$ into the open
$\text{Spec}(A) \times_S \text{Spec}(A) \subset U \times_S U$.
Let $\mathfrak p \subset A$ be the prime ideal corresponding to $u$.
Let $\mathfrak q \subset B$ be the prime ideal corresponding to $r$.
Pictures:
$$
\vcenter{
\xymatrix{
B & A \ar[l]^s \\
A \ar[u]^t
}
}
\quad\text{and}\quad
\vcenter{
\xymatrix{
B_{\mathfrak q} & A_{\mathfrak p} \ar[l]^s \\
A_{\mathfrak p} \ar[u]^t
}
}
$$
Note that $\kappa(\mathfrak p)$ is identified with $\kappa(\mathfrak q)$
via both arrows as $r = e(u)$. The ring maps $s, t : A \to B$ are
locally of finite type and flat. By assumption the ring
$$
\mathcal{O}_{F_u, r} = B_{\mathfrak q}/s(\mathfrak p)B_{\mathfrak q}
$$
is Cohen-Macaulay of dimension $d_2$ (equality of dimension by
Morphisms, Lemma \ref{morphisms-lemma-dimension-fibre-at-a-point}).
By assumption the ring
$$
\mathcal{O}_{G_u, r}
=
B_{\mathfrak q}/(s(\mathfrak p)B_{\mathfrak q} + t(\mathfrak p)B_{\mathfrak q})
$$
has dimension $d_1$ (equality of dimension by
Lemma \ref{lemma-group-scheme-finite-type-field}).
We claim this implies we can find
an element $f \in \mathfrak p$ such that
$$
\dim(B_{\mathfrak q}/(s(\mathfrak p)B_{\mathfrak q} + fB_{\mathfrak q}) < d_2
$$
Namely, suppose $\mathfrak n_j \supset s(\mathfrak p)B_{\mathfrak q}$,
$j = 1, \ldots, m$ correspond to the minimal primes of the local ring
$B_{\mathfrak q}/s(\mathfrak p)B_{\mathfrak q}$.
There are finitely many as this ring is Noetherian (since it is essentially
of finite type over a field -- but also because a Cohen-Macaulay ring is
Noetherian). By the Cohen-Macaulay condition we have
$\dim(B_{\mathfrak q}/\mathfrak n_j) = d_2$, for example by
Algebra, Lemma \ref{algebra-lemma-CM-dim-formula}.
Then the conditions $d_1 < d_2$ and
$\dim(B_{\mathfrak q}/(\mathfrak n_j + t(\mathfrak p)B_{\mathfrak q})) = d_1$
implies that
$\mathfrak p \not \subset t^{-1}(\mathfrak n_i)$. Since there are only
finitely many minimal primes in the Noetherian ring
$B_{\mathfrak q}/s(\mathfrak p)B_{\mathfrak q}$ we get our desired $f$
by prime avoidence, see
Algebra, Lemma \ref{algebra-lemma-silly}.

\medskip\noindent
Set $A' = A/fA$ and $U' = \text{Spec}(A')$. Then it is clear that
$U' \to U$ is an immersion, locally of finite presentation
and that $u \in U'$. Moreover, the morphism
$$
U' \times_{g, U, t} R \longrightarrow U
$$
factors through $\text{Spec}(A)$ and corresponds to the ring map
$$
\xymatrix{
B/t(f)B \ar@{=}[r] & A/(f) \otimes_{A, t} B & A \ar[l]_-s
}
$$
Now, we see $t(f)$ is not a zero divisor on
$B_{\mathfrak q}/s(\mathfrak p)B_{\mathfrak q}$ as this is a
Cohen-Macaulay ring of positive dimension and $f$ is not contained
in any minimal prime, see for example
Algebra, Lemma \ref{algebra-lemma-reformulate-CM}.
Hence by
Algebra, Lemma \ref{algebra-lemma-grothendieck-general}
we conclude that $s : A_{\mathfrak p} \to B_{\mathfrak q}/t(f)B_{\mathfrak q}$
is flat with fibre ring
$B_{\mathfrak q}/(s(\mathfrak p)B_{\mathfrak q} + t(f)B_{\mathfrak q})$
which is Cohen-Macaulay of $1$ lower dimension by
Algebra, Lemma \ref{algebra-lemma-reformulate-CM}
again. This implies the final assertion of the lemma and we win.
\end{proof}









\section{Separation conditions}
\label{section-separation}

\noindent
This really means conditions on the morphism $j : R \to U \times_S U$
when given a groupoid $(U, R, s, t, c)$ over $S$. As in the previous
section we first formulate the corresponding diagram.

\begin{lemma}
\label{lemma-diagram-diagonal}
Let $S$ be a scheme.
Let $(U, R, s, t, c)$ be a groupoid over $S$.
Let $G \to U$ be the stabilizer group scheme.
The commutative diagram
$$
\xymatrix{
R \ar[d]^{\Delta_{R/U}} \ar[rrr]_{f \mapsto (f, s(f))} & & &
R \times_{s, U} U \ar[d] \ar[r] & U \ar[d] \\
R \times_{(U \times_S U)} R \ar[rrr]^{(f, g) \mapsto (f, f^{-1} \circ g)} & & &
R \times_{s, U} G \ar[r] & G
}
$$
the two left horizontal arrows are isomorphisms
and the right square is a fibre product square.
\end{lemma}

\begin{proof}
Omitted.
Exercise in the definitions and the functorial point of
view in algebraic geometry.
\end{proof}

\begin{lemma}
\label{lemma-diagonal}
Let $S$ be a scheme.
Let $(U, R, s, t, c)$ be a groupoid over $S$.
Let $G \to U$ be the stabilizer group scheme.
\begin{enumerate}
\item The morphism $j : R \to U \times_S U$ is separated if and only if
$G \to U$ is separated.
\item The morphism $j : R \to U \times_S U$ is quasi-separated if and only
if $G \to U$ is quasi-separated.
\end{enumerate}
\end{lemma}

\begin{proof}
The group scheme $G \to U$ is the base change of $R \to U \times_S U$
by the diagonal morphism $U \to U \times_S U$, see
Lemma \ref{lemma-groupoid-stabilizer}. Hence if
$j$ is separated (resp.\ quasi-separated),
then $G \to U$ is separated (resp.\ quasi-separated).
(See Schemes, Lemma
\ref{schemes-lemma-separated-permanence}).

\medskip\noindent
Conversely, if $G \to U$ is separated
(resp.\ quasi-separated), then the morphism $U \to G$, as a section
of the structure morphism $G \to U$ is a closed immersion
(resp.\ quasi-compact), see
Schemes, Lemma \ref{schemes-lemma-section-immersion}.
Hence by the result of Lemma \ref{lemma-diagram-diagonal}
(and Schemes, Lemmas \ref{schemes-lemma-base-change-immersion}
and \ref{schemes-lemma-quasi-compact-preserved-base-change})
we see that $\Delta_{R/U \times_S U}$ is a closed
immersion (resp.\ quasi-compact).
\end{proof}









\section{Finite flat groupoids, affine case}
\label{section-finite-flat}

\noindent
Let $S$ be a scheme.
Let $(U, R, s, t, c)$ be a groupoid scheme over $S$.
Assume $U = \text{Spec}(A)$, and $R = \text{Spec}(B)$ are affine.
In this case we get two ring maps
$s^\sharp, t^\sharp : A \longrightarrow B$.
Let $C$ be the equalizer of $s^\sharp$ and $t^\sharp$. In a formula
\begin{equation}
\label{equation-invariants}
C = \{a \in A \mid t^\sharp(a) = s^\sharp(a) \}.
\end{equation}
We will sometimes call this the {\it ring of $R$-invariant functions on $U$}.
What properties does $M = \text{Spec}(C)$ have? The first observation is
that the diagram
$$
\xymatrix{
R \ar[r]_s \ar[d]_t & U \ar[d] \\
U \ar[r] & M
}
$$
is commutative, i.e., the morphism $U \to M$ equalizes $s, t$.
Moreover, if $T$ is any affine scheme, and if $U \to T$ is
a morphism which equalizes $s, t$, then $U \to T$ factors through $U \to M$.
In other words, $U \to M$ is a coequalizer in the category of affine schemes.

\medskip\noindent
We would like to find conditions that garantee the morphism $U \to M$ is
really a ``quotient'' in the category of schemes. We will discuss this at
length elsewhere (insert future reference here); here we just discuss some
special cases. Namely, we will focus on the case where $s, t$ are finite
locally free.

\begin{example}
\label{example-quotient-projective-line}
Let $k$ be a field. Let $U = \text{GL}_{2, k}$. Let $B \subset \text{GL}_2$
be the closed subgroup scheme of upper triangular matrices. 
Then the quotient sheaf $\text{GL}_{2,k}/B$ (in the Zariski, etale or
fppf topology, see Definition \ref{definition-quotient-sheaf}) is
representable by the projective line: $\mathbf{P}^1 = \text{GL}_{2,k}/B$.
(Details omitted.)
On the other hand, the ring of invariant functions in this case is just $k$.
Note that in this case the morphisms
$s, t : R = \text{GL}_{2, k} \times_k B \to \text{GL}_{2, k} = U$ are smooth
of relative dimension $3$.
\end{example}

\noindent
Recall that in Exercises \ref{exercises-exercise-trace-det}
and \ref{exercises-exercise-trace-det-rings} we have defined the determinant
and the norm for finitely locally free modules and finite locally free ring
extensions. If $\varphi : A \to B$ is a finite locally free ring map, then
we will denote $\text{Norm}_\varphi(b) \in A$ the norm of $b \in B$.

\begin{lemma}
\label{lemma-determinant-trick}
Let $S$ be a scheme. Let $(U, R, s, t, c)$ be a groupoid scheme over $S$.
Assume $U = \text{Spec}(A)$, and $R = \text{Spec}(B)$ are affine, and
$s, t : R \to U$ finite locally free.
Let $C$ be as in (\ref{equation-invariants}).
Let $f \in A$. Then $\text{Norm}_{s^\sharp}(t^\sharp(f)) \in C$.
\end{lemma}

\begin{proof}
Consider the commutative diagram
$$
\xymatrix{
& U & \\
R \ar[d]_s \ar[ru]^t &
R \times_{s, U, t} R
\ar[l]^-{\text{pr}_0} \ar[d]^{\text{pr}_1} \ar[r]_-c &
R \ar[d]^s \ar[lu]_t \\
U & R \ar[l]_t \ar[r]^s & U
}
$$
of Lemma \ref{lemma-diagram}.
Think of $f \in \Gamma(U, \mathcal{O}_U)$. The commutativity of the
top part of the diagram shows that
$pr_0^\sharp(t^\sharp(f)) = c^\sharp(t^\sharp(f))$ as elements of
$\Gamma(R \times_{S, U, t} R, \mathcal{O})$.
Looking at the right lower cartesian square
the compatibility of the norm construction with base change shows that
$s^\sharp(\text{Norm}_{s^\sharp}(t^\sharp(f))) =
\text{Norm}_{\text{pr}_1}(c^\sharp(t^\sharp(f)))$.
Similarly we get
$t^\sharp(\text{Norm}_{s^\sharp}(t^\sharp(f))) =
\text{Norm}_{\text{pr}_1}(\text{pr}_0^\sharp(t^\sharp(f)))$.
Hence by the first equality of this proof we see that
$s^\sharp(\text{Norm}_{s^\sharp}(t^\sharp(f))) =
t^\sharp(\text{Norm}_{s^\sharp}(t^\sharp(f)))$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-finite-locally-free-disjoint-free}
Let $S$ be a scheme. Let $(U, R, s, t, c)$ be a groupoid scheme over $S$.
Assume $s, t : R \to U$ finite locally free.
Then
$$
U = \coprod\nolimits_{r \geq 1} U_r
$$
is a disjoint union of $R$-invariant opens such that the restriction $R_r$ of
$R$ to $U_r$ has the property that $s,t : R_r \to U_r$ are finite locally
free of rank $1$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-integral-over-invariants}
Let $S$ be a scheme. Let $(U, R, s, t, c)$ be a groupoid scheme over $S$.
Assume $U = \text{Spec}(A)$, and $R = \text{Spec}(B)$ are affine, and
$s, t : R \to U$ finite locally free.
Let $C \subset A$ be as in (\ref{equation-invariants}).
Then $A$ is integral over $C$.
\end{lemma}

\begin{proof}
First, by Lemma \ref{lemma-finite-locally-free-disjoint-free}
we know that $(U, R, s, t, c)$ is a disjoint union
of groupoid schemes $(U_r, R_r, s, t, c)$ such that each $s, t : R_r \to U_r$
has constant rank $r$. As $U$ is quasi-compact, we have $U_r = \empty$ for
almost all $r$. It suffices to prove the lemma for each $(U_r, R_r, s, t, c)$
and hence we may assume that $s, t$ are finite locally free of rank $r$.

\medskip\noindent
Assume that $s,t$ are finite locally free of rank $r$.
Let $f \in A$. Consider the element $x - f \in A[x]$, where we think
of $x$ as the coordinate on $\mathbf{A}^1$.
Since
$$
(U \times \mathbf{A}^1, R \times \mathbf{A}^1,
s \times \text{id}_{\mathbf{A}^1},
t \times \text{id}_{\mathbf{A}^1},
c \times \text{id}_{\mathbf{A}^1})
$$
is also a groupoid scheme with finite source and target, we may apply
Lemma \ref{lemma-determinant-trick} to it and we see that
$P(x) = \text{Norm}_{s^\sharp}(t^\sharp(x - f))$
is an element of $C[x]$. Because $s^\sharp : A \to B$ is finite locally
free of rank $r$ we see that $P$ is monic of degree $r$.
Moreover $P(f) = 0$ by Cayley-Hamilton
(Algebra, Lemma \ref{algebra-lemma-charpoly}).
\end{proof}

\begin{lemma}
\label{lemma-invariants-base-change}
Let $S$ be a scheme. Let $(U, R, s, t, c)$ be a groupoid scheme over $S$.
Assume $U = \text{Spec}(A)$, and $R = \text{Spec}(B)$ are affine, and
$s, t : R \to U$ finite locally free. Let $C \subset A$ be as in
(\ref{equation-invariants}). Let $C \to C'$ be a ring map, and set
$U' = \text{Spec}(A \otimes_C C')$,
$R' = \text{Spec}(B \otimes_C C')$.
Then
\begin{enumerate}
\item the maps $s,t,c$ induce maps $s', t', c'$ such that
$(U', R', s', t', c')$ is a groupoid scheme, and
\item there is a canonical map $\varphi : C' \to C^1$ of $C'$ into
the $R'$-invariant functions $C^1$ on $U'$ with the properties
\begin{enumerate}
\item for every $f \in C^1$ there exists an $n > 0$ such that
$f^n$ is in the image of $\varphi$, and
\item for every $f \in \text{Ker}(\varphi)$ there exists
an $n > 0$ such that $f^n = 0$.
\end{enumerate}
\item if $C \to C'$ is flat then $\varphi$ is an isomorphism.
\end{enumerate}
\end{lemma}

\begin{proof}
The proof of part (1) is omitted. Let us denote $A' = A \otimes_C C'$ and
$B' = B \otimes_C C'$. Then we have
$$
C^1
= \{x \in A' \mid (t')^\sharp(x) = (s')^\sharp(x) \}
= \{a \in A \otimes_C C' \mid t^\sharp \otimes 1(x) = s^\sharp \otimes 1(x) \}.
$$
In other words, $C^1$ is the kernel of the difference map
$(t^\sharp - s^\sharp) \otimes 1$ which is just the base change
of the $C$-linear map $t^\sharp - s^\sharp : A \to B$ by $C \to C'$.
Hence (3) follows.

\medskip\noindent
Proof of part (2)(b). Since $C \to A$ is integral
(Lemma \ref{lemma-integral-over-invariants}) and injective we see that
$\text{Spec}(A) \to \text{Spec}(C)$ is surjective, see
Algebra, Lemma \ref{algebra-lemma-integral-overring-surjective}.
Thus also $\text{Spec}(A') \to \text{Spec}(C')$ is surjective
as a base change of a surjective morphism
(Morphisms, Lemma \ref{morphisms-lemma-base-change-surjective}).
Hence $\text{Spec}(C^1) \to \text{Spec}(C')$ is surjective also.
This implies that the kernel of $\varphi$ is contained in the
radical of the ring $C'$, i.e., (2)(b) holds.

\medskip\noindent
Proof of part (2)(a). By Lemma \ref{lemma-finite-locally-free-disjoint-free}
we know that $A$ is a finite
product of rings $A_r$ and $B$ is a finite product of rings $B_r$
such that the groupoid scheme decomposes accordingly (see the proof
of Lemma \ref{lemma-integral-over-invariants}).
Then also $C$ is a product of rings $C_r$ and
correspondingly $C'$ decomposes as a product. Hence we may and do
assume that the ring maps $s^\sharp, t^\sharp : A \to B$ are finite
locally free of a fixed rank $r$. Let $f \in C^1 \subset A' = A \otimes_C C'$.
We may replace $C'$ by a finitely generated $C$-subalgebra of $C'$
and hence we may assume that $C' = C[X_1, \ldots, X_n]/I$ for some
ideal $I$. Choose a lift $\tilde f \in A \otimes_C C[X_i] = A[X_i]$
of the element $f$. Note that
$f^r = \text{Norm}_{(s')^\sharp}((t')^\sharp(f))$ in $A$ as
$t^\sharp(f) = s^\sharp(f)$. Hence we see that
$$
h = \text{Norm}_{s^\sharp \otimes 1}(t^\sharp \otimes 1(f)) \in A[X_i]
$$
is invariant according to Lemma \ref{lemma-determinant-trick}
and maps to $f^r$ in $A'$.
Since $C \to C[X_i]$ is flat we see from (3) that $h \in C[X_i]$.
Hence it follows that $f^r$ is in the image of $\varphi$.
\end{proof}

\begin{lemma}
\label{lemma-points}
Let $S$ be a scheme. Let $(U, R, s, t, c)$ be a groupoid scheme over $S$.
Assume $U = \text{Spec}(A)$, and $R = \text{Spec}(B)$ are affine, and
$s, t : R \to U$ finite locally free. Let $C \subset A$ be as in
(\ref{equation-invariants}). Then $U \to M = \text{Spec}(C)$ has
the following properties:
\begin{enumerate}
\item the map on points $|U| \to |M|$ is surjective and
$u_0, u_1 \in |U|$ map to the same point if and only if 
there exists a $r \in |R|$ with $t(r) = u_0$ and $s(r) = u_1$, in 
a formula
$$
|M| = |U|/|R|
$$
\item for any algebraically closed field $k$ we have
$$
M(k) = U(k)/R(k)
$$
\end{enumerate}
\end{lemma}

\begin{proof}
Let $k$ be an algebraically closed field.
Since $C \to A$ is integral (Lemma \ref{lemma-integral-over-invariants})
and injective we see that
$\text{Spec}(A) \to \text{Spec}(C)$ is surjective, see
Algebra, Lemma \ref{algebra-lemma-integral-overring-surjective}.
Thus $|M| \to |U|$ is surjective.
Let $C \to k$ be a ring map. Since surjective morphisms are
preserved under base change
(Morphisms, Lemma \ref{morphisms-lemma-base-change-surjective}) we see that
$A \otimes_C k$ is not zero. Now $k \subset A \otimes_C k$ is a
nonzero integral extension. Hence any residue field of $A \otimes_C k$
is an algebraic extension of $k$, hence equal to $k$. Thus we see that
$U(k) \to M(k)$ is surjective.

\medskip\noindent
Let $a_0, a_1 : A \to k$ be ring maps. If there exists a ring map
$b : B \to k$ such that $a_0 = b \circ t^\sharp$ and $a_1 = b \circ s^\sharp$
then we see that $a_0|_C = a_1|_C$ by definition.
Conversely, suppose that $a_0|_C = a_1|_C$. Let us name this algebra
map $c : C \to k$. Consider the diagram
$$
\xymatrix{
& &
B \ar@{-->}[lld] \\
k & &
A
\ar@<0.5ex>[ll]^{a_0}
\ar@<-0.5ex>[ll]_{a_1}
\ar@<1ex>[u]
\ar@<-1ex>[u] \\
& &
C \ar[u] \ar[llu]^c
}
$$
We are trying to construct the dotted arrow, and if we do then
part (2) follows, which in turn implies part (1).
Since $A \to B$ is finite and faithfully flat
there exist finitely many ring maps
$b_1, \ldots, b_n : B \to k$ such that $b_i \circ s^\sharp = a_1$.
If the dotted arrow does not exist, then we see that none of the
$a'_i = b_i \circ t^\sharp$, $i = 1, \ldots, n$ is equal to $a_0$.
Hence the maximal ideals
$$
\mathfrak m'_i = \text{Ker}(a_i' \otimes 1 : A \otimes_C k \to k)
$$
of $A \otimes_C k$ are distinct from
$\mathfrak m = \text{Ker}(a_0 \otimes 1 : A \otimes_C k \to k)$.
By Algebra, Lemma \ref{algebra-lemma-silly} we would get an element
$f \in A \otimes_C k$ with $f \in \mathfrak m$, but
$f \not \in \mathfrak m_i'$ for $i = 1, \ldots, n$.
Consider the norm
$$
g = \text{Norm}_{s^\sharp \otimes 1}(t^\sharp \otimes 1(f))
\in
A \otimes_C k
$$
By Lemma \ref{lemma-determinant-trick} this lies in the invariants
$C^1 \subset A \otimes_C k$ of the base change
groupoid (base change via the map $c : C \to k$). On the one hand,
$a_1(g) \in k^*$ since
the value of $t^\sharp(f)$ at all the points (which correspond to
$b_1, \ldots, b_n$) lying over $a_1$ is
invertible (insert future reference on property determinant here).
On the other hand, since $f \in \mathfrak m$, we see that
$f$ is not a unit, hence $t^\sharp(f)$ is not a unit
(as $t^\sharp \otimes 1$ is faithfully flat),
hence its norm is not a unit (insert future reference
on property determinant here). We conclude that $C^1$ contains
an element which is not nilpotent
and not a unit. We will now show that this leads to a contradiction.
Namely, apply Lemma \ref{lemma-invariants-base-change}
to the map $c : C \to C' = k$, then
we see that the map of $k$ into the invariants $C^1$ is injective
and moreover, that for any element $x \in C^1$ there exists an integer
$n > 0$ such that $x^n \in k$. Hence every element of $C^1$ is
either a unit or nilpotent.
\end{proof}

\begin{lemma}
\label{lemma-basis}
Let $S$ be a scheme.
Let $(U, R, s, t, c)$ be a groupoid scheme over $S$.
Assume
\begin{enumerate}
\item $U = \text{Spec}(A)$, and $R = \text{Spec}(B)$ are affine, and
\item there exist elements $x_i \in A$, $i \in I$ such that
$B = \bigoplus_{i \in I} s^\sharp(A)t^\sharp(x_i)$.
\end{enumerate}
Then $A = \bigoplus_{i\in I} Cx_i$, and $B \cong A \otimes_C A$
where $C \subset A$ is the $R$-invariant
functions on $U$ as in (\ref{equation-invariants}).
\end{lemma}

\begin{proof}
During this proof we will write $s, t : A \to B$ instead of
$s^\sharp, t^\sharp$, and similarly $c : B \to B \otimes_{s, A, t} B$.
We write $p_0 : B \to B \otimes_{s, A, t} B$, $b \mapsto b \otimes 1$ and
$p_1 : B \to B \otimes_{s, A, t} B$, $b \mapsto 1 \otimes b$. By
Lemma \ref{lemma-diagram-pull} and the definition of $C$ we have the following
commutative diagram
$$
\xymatrix{
B \otimes_{s, A, t} B &
B \ar@<-1ex>[l]_-c \ar@<1ex>[l]^-{p_0} &
A \ar[l]^t \\
B \ar[u]^{p_1} &
A \ar@<-1ex>[l]_s \ar@<1ex>[l]^t \ar[u]_s &
C \ar[u] \ar[l]
}
$$
Moreover the tow left squares are cocartesian in the category of rings, and
the top row is isomorphic to the diagram
$$
\xymatrix{
B \otimes_{t, A, t} B &
B \ar@<-1ex>[l]_-{p_1} \ar@<1ex>[l]^-{p_0} &
A \ar[l]^t
}
$$
which is an equalizer diagram according to
Descent, Lemma \ref{descent-lemma-ff-exact} because condition (2) implies
in particular that $s$ (and hence also then isomorphic arrow $t$)
is faithfully flat.
The lower row is an equalizer diagram by definition of $C$.
We can use the $x_i$ and get a commutative diagram
$$
\xymatrix{
B \otimes_{s, A, t} B &
B \ar@<-1ex>[l]_-c \ar@<1ex>[l]^-{p_0} &
A \ar[l]^t \\
\bigoplus_{i \in I} B x_i \ar[u]^{p_1} &
\bigoplus_{i \in I} A x_i \ar@<-1ex>[l]_s \ar@<1ex>[l]^t \ar[u]_s &
\bigoplus_{i \in I} C x_i \ar[u] \ar[l]
}
$$
where in the right vertical arrow we map $x_i$ to $x_i$,
in the middle vertical arrow we map $x_i$ to $t(x_i)$ and
in the left vertical arrow we map $x_i$ to
$c(t(x_i)) = t(x_i) \otimes 1 = p_0(t(x_i))$ (equality by the commutativity
of the top part of the diagram in Lemma \ref{lemma-diagram}). Then the diagram
commutes. Moreover the middle vertical arrow is an isomorphism
by assumption. Since the left two squares are cocartesian we
conclude that also the left vertical arrow is an isomorphism.
On the other hand, the horizontal rows are exact (i.e., they are
equalizers). Hence we conclude that also the right vertical arrow
is an isomorphism.
\end{proof}

\begin{proposition}
\label{proposition-finite-flat-equivalence}
Let $S$ be a scheme.
Let $(U, R, s, t, c)$ be a groupoid scheme over $S$.
Assume
\begin{enumerate}
\item $U = \text{Spec}(A)$, and $R = \text{Spec}(B)$ are affine,
\item $s, t : R \to U$ finite locally free, and
\item $j = (t, s)$ is an equivalence.
\end{enumerate}
In this case, let $C \subset A$ be as in
(\ref{equation-invariants}). Then $U \to M = \text{Spec}(C)$
is finite locally free and $R = U \times_M U$.
Moreover, $M$ represents the quotient sheaf $U/R$
in the fppf topology (see Definition \ref{definition-quotient-sheaf}).
\end{proposition}

\begin{proof}
During this proof we use the notation $s, t : A \to B$
instead of the notation $s^\sharp, t^\sharp$.
By Lemma \ref{lemma-criterion-quotient-representable}
it suffices to show that $C \to A$ is finite locally free
and that the map
$$
t \otimes s : A \otimes_C A \longrightarrow B
$$
is an isomorphism. First, note that $j$ is a monomorphism, and
also finite (since already $s$ and $t$ are finite). Hence we see
that $j$ is a closed immersion by
Morphisms, Lemma \ref{morphisms-lemma-finite-monomorphism-closed}.
Hence $A \otimes_C A \to B$ is surjective.

\medskip\noindent
We will perform base change by flat ring maps $C \to C'$ as in
Lemma \ref{lemma-invariants-base-change}, and we will use that
formation of invariants commutes with flat base change, see
part (3) of the lemma cited.
We will show below that for every prime $\mathfrak p \subset C$, there exists
a local flat ring map $C_{\mathfrak p} \to C_{\mathfrak p}'$
such that the result holds after a base change to $C_{\mathfrak p}'$.
This implies immediately
that $A \otimes_C A \to B$ is injective (use
Algebra, Lemma \ref{algebra-lemma-characterize-zero-local}).
It also implies that $C \to A$ is flat, by combining
Algebra, Lemmas \ref{algebra-lemma-local-flat-ff},
\ref{algebra-lemma-flat-localization}, and
\ref{algebra-lemma-flatness-descends}. Then since $U \to \text{Spec}(C)$
is surjective also (Lemma \ref{lemma-points}) we conclude that $C \to A$
is faithfully flat. Then the isomorphism $B \cong A \otimes_C A$
implies that $A$ is a finitely presented $C$-module, see
Algebra, Lemma \ref{algebra-lemma-descend-properties-modules}.
Hence $A$ is finite locally free over $C$, see
Algebra, Lemma \ref{algebra-lemma-finite-projective}.

\medskip\noindent
By Lemma \ref{lemma-finite-locally-free-disjoint-free}
we know that $A$ is a finite
product of rings $A_r$ and $B$ is a finite product of rings $B_r$
such that the groupoid scheme decomposes accordingly (see the proof
of Lemma \ref{lemma-integral-over-invariants}).
Then also $C$ is a product of rings $C_r$ and
correspondingly $C'$ decomposes as a product. Hence we may and do
assume that the ring maps $s, t : A \to B$ are finite
locally free of a fixed rank $r$.

\medskip\noindent
The local ring maps $C_{\mathfrak p} \to C_{\mathfrak p}'$ we are going
to use are any local flat ring maps such that the residue field of
$C_{\mathfrak p}'$ is infinite.
By Algebra, Lemma \ref{algebra-lemma-flat-local-given-residue-field}
such local ring maps exist.

\medskip\noindent
Assume $C$ is a local ring with maximal ideal $\mathfrak m$ and
infinite residue field, and assume that $s, t : A \to B$ is
finite locally free of constant rank $r > 0$.
Since $C \subset A$ is integral (Lemma \ref{lemma-integral-over-invariants})
all primes lying over $\mathfrak m$ are maximal, and all maximal
ideals of $A$ lie over $\mathfrak m$. Similarly for $C \subset B$.
Pick a maximal ideal $\mathfrak m'$
of $A$ lying over $\mathfrak m$ (exists by Lemma \ref{lemma-points}). 
Since $t : A \to B$ is finite locally free there exist at most finitely
many maximal ideals of $B$ lying over $\mathfrak m'$. Hence we conclude
(by Lemma \ref{lemma-points} again)
that $A$ has finitely many maximal ideals, i.e.,
$A$ is semi-local. This in turn implies that $B$ is semi-local as
well. OK, and now, because $t \otimes s : A \otimes_C A \to B$ is surjective,
we can apply
Algebra, Lemma \ref{algebra-lemma-semi-local-module-basis-in-submodule}
to the ring map $C \to A$, the $A$-module $M = B$ (seen as an $A$-module
via $t$) and the $C$-submodule $s(A) \subset B$. This lemma implies that there
exist $x_1, \ldots, x_r \in A$ such that $M$ is free over $A$
on the basis $s(x_1), \ldots, s(x_r)$. Hence we conlude that $C \to A$
is finite free and $B \cong A \otimes_C A$ by applying
Lemma \ref{lemma-basis}.
\end{proof}



\section{Finite flat groupoids}
\label{section-finite-flat-general}

\begin{lemma}
\label{lemma-find-invariant-affine}
Let $S$ be a scheme.
Let $(U, R, s, t, c)$ be a groupoid scheme over $S$.
Assume $s$, $t$ are finite locally free.
Let $u \in U$ be a point such that $t(s^{-1}(\{u\}))$
is contained in an affine open of $U$.
Then there exists an $R$-invariant affine open neighbourhood
of $u$ in $U$.
\end{lemma}

\begin{proof}
Since $s$ is finite locally free it has finite fibres. Hence
$t(s^{-1}(\{u\})) = \{u_1, \ldots, u_n\}$ is a finite set.
Note that $u \in \{u_1, \ldots, u_n\}$.
Let $W \subset U$ be an affine open containing $\{u_1, \ldots, u_n\}$,
in particular $u \in W$. Consider
$Z = R \setminus s^{-1}(W) \cap t^{-1}(W)$. This is a closed subset
of $R$. The image $t(Z)$ is a closed subset of $U$ which can be loosely
described as the set of points of $U$ which are not $R$-equivalent to a
point of $W$. Hence $W' = U \setminus t(Z)$ is an $R$-invariant, open
subscheme of $U$ contained in $W$, and $\{u_1, \ldots, u_n\} \subset W'$.
Picture
$$
\{u_1, \ldots, u_n\} \subset W' \subset W \subset U.
$$
Let $f \in \Gamma(W, \mathcal{O}_W)$ be an element such that
$\{u_1, \ldots, u_n\} \subset D(f) \subset W'$. Such an $f$ exists by
Algebra, Lemma \ref{algebra-lemma-silly}. By our choice of $W'$ we
have $s^{-1}(W') \subset t^{-1}(W)$, and hence we get a diagram
$$
\xymatrix{
s^{-1}(W') \ar[d]_s \ar[r]_-t & W \\
W'
}
$$
The vertical arrow is finite locally free by assumption. Set
$$
g = \text{Norm}_s(t^\sharp f) \in \Gamma(W', \mathcal{O}_{W'})
$$
By construction $g$ is a function on $W'$ which is
nonzero in $u$, as $t^\sharp(f)$ is nonzero in each of the points of
$R$ lying over $u$, since $f$ is nonzero in $u_1, \ldots, u_n$.
Similarly, $D(g) \subset W'$ is equal to the
set of points $w$ such that $f$ is not zero in any of the points
equivalent to $w$. This means that $D(g)$ is an
$R$-invariant affine open of $W'$. The final picture is
$$
\{u_1, \ldots, u_n\} \subset D(g) \subset D(f) \subset W' \subset W \subset U
$$
and hence we win.
\end{proof}


\section{Etale localization of groupoids}
\label{section-etale-localize}

\noindent
Lemma \ref{lemma-quasi-finite-over-base-j-proper}
will be used to prove results on algebraic spaces
separated and quasi-finite over a scheme (insert future reference here).

\begin{lemma}
\label{lemma-quasi-finite-over-base}
Let $S$ be a scheme.
Let $(U, R, s, t, c)$ be a groupoid scheme over $S$.
Let $p \in S$ be a point, and let $u \in U$ be a point lying over $p$.
Assume that
\begin{enumerate}
\item $U \to S$ is locally of finite type,
\item $U \to S$ is quasi-finite at $u$,
\item $U \to S$ is separated,
\item $R \to S$ is separated,
\item $s$, $t$ are flat and locally of finite presentation, and
\item $s^{-1}(\{u\})$ is finite.
\end{enumerate}
Then there exists an etale neighbourhood $(S', p') \to (S, p)$ with
$\kappa(p) = \kappa(p')$ and a base change diagram
$$
\xymatrix{
R' \coprod W'
\ar@{=}[r] &
S' \times_S R
\ar[r] \ar@<2ex>[d]^{s'} \ar@<-2ex>[d]_{t'} &
R \ar@<1ex>[d]^s \ar@<-1ex>[d]_t \\
U' \coprod W
\ar@{=}[r] &
S' \times_S U
\ar[r] \ar[d] &
U \ar[d] \\
 &
S' \ar[r] &
S
}
$$
where the equal signs are decompositions into open and closed
subschemes such that
\begin{enumerate}
\item[(a)] there exists a point $u'$ of $U'$ mapping to $u$ in $U$,
\item[(b)] the fibre $(U')_{p'}$ consists of the points of
$(S' \times_S U)_{p'}$ equivalent to $u'$,
\item[(c)] the fibre $(R')_{p'} = (s')^{-1}(\{u'\})$,
\item[(d)] the schemes $U'$, $R'$ are finite over $S'$,
\item[(e)] we have $s'(R') \subset U'$, $t'(R') \subset U'$,
\item[(f)] we have
$c'(R' \times_{t', U', s'} R') \subset R'$
where $c'$ is the base change of $c$, and
\item[(g)] the morphisms $s', t', c'$ determine a groupoid structure
by taking the system
$(U', R', s'|_{R'}, t'|_{R'}, c'|_{R' \times_{t', U', s'} R'})$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let us denote $f : U \to S$ the structure morphism of $U$.
Note that $s^{-1}(\{u\}) = \{r_1, \ldots, r_n\}$
is finite implies that $s$ is quasi-finite
at each of these finitely many inverse images, see
Morphisms, Lemma \ref{morphisms-lemma-finite-fibre}.
Hence we see that $f \circ s : R \to S$ is quasi-finite at each $r_i$
(Morphisms, Lemma \ref{morphisms-lemma-composition-quasi-finite}).
Since $t$ is flat and locally of finite presentation,
the morphism of fibres $t_p : R_p \to U_p$ is flat and locally of
finite presentation (Morphisms,
Lemmas \ref{morphisms-lemma-base-change-flat} and
\ref{morphisms-lemma-base-change-finite-presentation}),
hence open (Morphisms,
Lemma \ref{morphisms-lemma-fppf-open}). Thus the fact that $r_i$ is isolated
in $R_p$ implies that $u_i = t(r_i)$ is isolated in $U_p$.
In other words, we see that $f$ is quasi-finite at $u_1, \ldots, u_n$.
Note that $t^{-1}(\{u\}) = \{r_1, \ldots, r_n\}$ and that
$s(\{r_1, \ldots, r_n\}) = \{u_1, \ldots, u_n\}$ since $R$ is a
groupoid. We remark that the cardinality of the set
$\{r_1, \ldots, r_n\}$ is in general greater than the cardinality
of the set $\{u_1, \ldots, u_n\}$. Note that $u \in \{u_1, \ldots, u_n\}$.

\medskip\noindent
We may apply
More on Morphisms,
Lemma \ref{more-morphisms-lemma-etale-splits-off-quasi-finite-part-technical}
to the morphisms
$U \to S$, and $R \to S$ to get an etale neighbourhood
$(S', p') \to (S, p)$ which induces a trivial residue field extension
such that $S' \times_S U$ and $S' \times_S R$ decompose as
$$
S' \times_S U = U' \coprod W, \quad
S' \times_S R = R' \coprod W'
$$
with $U' \to S'$ finite and
$U'_{p'}$ mapping bijectively to $\{u_1, \ldots, u_n\}$, and
$R' \to S'$ finite and
$R'_{p'}$ mapping bijectively to $\{r_1, \ldots, r_n\}$.
Moreover, no point of $W_{p'}$ (resp.\ $W'_{p'}$) maps to
any of the points $u_i$ (resp.\ $r_i$). At this point (a), (b), (c), and (d)
of the lemma are satisfied.

\medskip\noindent
Consider the set $(s'|_{R'})^{-1}(W)$. This is open and closed in $R'$
and does not contain any points of $R'$ lying over $p'$. Since
$R' \to S'$ is closed, we may assume, after shrinking $S'$, that
it is empty. In other words $s'$ maps $R'$ into $U'$.
Similarly, we can arrange it so that $t'$ maps $R'$ into $U'$.
In the same manner, consider the set
$(c'|_{R' \times_{s', U', t'} R'})^{-1}(W')$.
It is open and closed in the scheme $R' \times_{s', U', t'} R'$
which is finite over $S'$, does not contain any points lying
over $p'$, and hence after shrinking $S'$ we may assume
that it is empty. We may repeat the argument also with the identity
$e : U \to R$ and the inverse $i : R \to R$ so that we may assume
(after shrinking $S'$ some more) that $(e'|_{U'})^{-1}(W') = \emptyset$
and $(i'|_{R'})^{-1}(W') = \emptyset$.

\medskip\noindent
At this point we see that we may consider the structure
$$
(U', R', s'|_{R'}, t'|_{R'}, c'|_{R' \times_{t', U', s'} R'},
e'|_{U'}, i'|_{R'}).
$$
The axioms of a groupoid scheme over $S'$ hold
because they hold for the groupoid scheme
$(S' \times_S U, S' \times_S R, s', t', c', e', i')$.
\end{proof}

\begin{lemma}
\label{lemma-quasi-finite-over-base-j-proper}
Let $S$ be a scheme.
Let $(U, R, s, t, c)$ be a groupoid scheme over $S$.
Let $p \in S$ be a point, and let $u \in U$ be a point lying over $p$.
Assume assumptions (1) -- (6) of
Lemma \ref{lemma-quasi-finite-over-base}
hold as well as
\begin{enumerate}
\item[(7)] $j : R \to U \times_S U$ is universally closed\footnote{In view of
the other conditions this is equivalent to requiring $j$ to be proper.}.
\end{enumerate}
Then we can choose $(S', p') \to (S, p)$ and decompositions
$S' \times_S U = U' \amalg W$ and $S' \times_S R = R' \amalg W'$
and $u' \in U'$ such that (a) -- (g) of
Lemma \ref{lemma-quasi-finite-over-base}
hold as well as
\begin{enumerate}
\item[(h)] $R'$ is the restriction of $S' \times_S R$ to $U'$.
\end{enumerate}
\end{lemma}

\begin{proof}
We apply Lemma \ref{lemma-quasi-finite-over-base} for the
groupoid $(U, R, s, t, c)$ over the scheme $S$ with points $p$ and $u$.
Hence we get an etale neighbourhood
$(S', p') \to (S, p)$ and disjoint union decompositions
$$
S' \times_S U = U' \amalg W, \quad
S' \times_S R = R' \amalg W'
$$
and $u' \in U'$ satisfying conclusions (a), (b), (c), (d), (e), (f), and (g).
We may shrink $S'$ to a smaller neighbourhood of $p'$ without
affecting the conclusions (a) -- (g). We will show that for a suitable
shrinking conclusion (h) holds as well.
Let us denote $j'$ the base change of $j$ to $S'$.
By conclusion (e) it is clear that
$$
j'^{-1}(U' \times_{S'} U') = R' \amalg Rest
$$
for some open and closed $Rest$ piece. Since $U' \to S'$ is finite
by conclusion (d) we see that $U' \times_{S'} U'$ is finite over $S'$.
Since $j$ is universally closed, also $j'$ is universally closed, and
hence $j'|_{Rest}$ is universally closed too. By conclusions
(b) and (c) we see that the fibre of
$$
(U' \times_{S'} U' \to S') \circ j'|_{Rest} :
Rest
\longrightarrow
S'
$$
over $p'$ is empty. Hence, since $Rest \to S'$ is closed as a composition
of closed morphisms, after shrinking $S'$, we may assume that
$Rest = \emptyset$. And this is exactly the condition that $R'$ is
the restriction of $S' \times_S R$ to the open subscheme
$U' \subset S' \times_S U$, see
Lemma \ref{lemma-restrict-groupoid-relation}
and its proof.
\end{proof}

\noindent
The following lemma is \cite[Proposition 4.2]{K-M}.
The formulation is minimal in the sense that we only state the assumptions
used in the proof; we know of no applications but the case where
the morphisms $s$, $t$ are also flat (and of finite presentation).
And clearly if $s$, $t$ are flat, then so are $s'$ and $t'$, whence
also $s'|_P$, $t'|_P$.
Note that assumptions (3) and (4) are implied by the assumption
that the fibre of $s$ over $u$ is a finite set, see
Morphisms, Lemma \ref{morphisms-lemma-finite-fibre}.

\begin{lemma}
\label{lemma-quasi-finite-groupoid}
Let $S$ be a scheme.
Let $(U, R, s, t, c)$ be a groupoid scheme over $S$.
Let $u \in U$ be a point. Assume that
\begin{enumerate}
\item $s, t : R \to U$ are separated,
\item $s$, $t$ are locally of finite type, and
\item there are finitely many points $r_1, \ldots, r_n \in R$ with
$s(r_i) = t(r_i) = u$, and
\item $s$ is quasi-finite at each $r_i$.
\end{enumerate}
Then\footnote{The proof of this is currently incomplete and the formulation
of this lemma may have to be changed to assuming $s,t$ are flat and locally
of finite presentation. We are working on it.}
there exists an etale neighbourhood $(U', u') \to (U, u)$
with $\kappa(u) = \kappa(u')$
such that the restriction $R' = R|_{U'}$ of $R$ to $U'$ decomposes
into open and closed subschemes
$$
R' = R|_{U'} = P \coprod W
$$
with
\begin{enumerate}
\item $(U', P, s'|_P, t'|_P, c'|_P)$ is a groupoid scheme over $S$,
\item the morphisms $s'|_P : P \to U'$ and $t'|_P : P \to U'$ are
finite,
\item any point $r' \in R'$ with $s'(r') = t'(r') = u'$ is contained
in $P$.
\end{enumerate}
\end{lemma}

\begin{proof}
Since $(U, R, s, t, c)$ is a groupoid scheme, we see that also
$t$ is quasi-finite at each $r_i$. By
More on Morphisms,
Lemma \ref{more-morphisms-lemma-etale-splits-off-quasi-finite-part-technical}
we can find an etale neighbourhood $(U', u') \to (U, u)$ with
$\kappa(u) = \kappa(u')$ such that we have disjoint decompositions
$$
R \times_{s, U} U' = V_1 \coprod W_1,
\quad\text{and}\quad
U' \times_{U, t} R = V_2 \coprod W_2
$$
with the following properties
\begin{enumerate}
\item $V_1 \to U'$ is finite,
\item $V_2 \to U'$ is finite,
\item $(V_1)_{u'} = \{r_1, \ldots, r_n\}$ as sets (via the identification
$(R \times_{s, U} U')_{u'} = R_u$),
\item $(V_2)_{u'} = \{r_1, \ldots, r_n\}$ as sets (via the identification
$(U' \times_{U, t} R)_{u'} = R_u$).
\end{enumerate}
By definition of the restriction
(Definition \ref{definition-restrict-groupoid})
we have
$$
R|_{U'} = (V_1 \coprod W_1) \times_R (V_1 \coprod W_1).
$$
Hence if we take $P = V_1 \times_R V_2$, then $P$ is open and closed
in the restriction and the morphisms $s'|_P, t'|_P : P \to U'$ are finite.
FIXME: Actually there seems to be no reason for this to hold.

\medskip\noindent
Since $R'$ is a groupoid we have $(s')^{-1}(\{u'\}) = (t')^{-1}(\{u'\})$
and because $\kappa(u) = \kappa(u')$ this set maps bijectively to
$s^{-1}(\{u\}) = t^{-1}(\{u\})$. Hence the set
$\{p' \in P' \mid s'(p') = t'(p') = u'\}$
maps bijectively to $\{r_1, \ldots, r_n\}$.
By our choice of $V_1$ and $V_2$ we see that the subset
$P \cap (s')^{-1}(\{u'\})$ maps bijectively
to $\{r_1, \ldots, r_n\}$. Thus we conclude that (3) holds.

\medskip\noindent
Finally, we have to show that (1) holds, i.e., that
$(U', P, s'|_P, t'|_P, c'|_P)$ is a groupoid.
Consider the morphism $c' : R' \times_{s', U', t'} R' \to R'$.
We want to show that, after possibly shrinking $U'$, that
$c'(P \times_{s'|_P, U', t'|_P} P) \subset P$. To see this
consider $T = (c')^{-1}(W) \cap P \times_{s'|_P, U', t'|_P} P$.
This is an open and closed subscheme of $P \times_{s'|_P, U', t'|_P} P$.
By the discussion in the preceding paragraph we have
$$
(s'|_P)^{-1}(\{u'\}) = \{r_1, \ldots, r_n\} = (t'|_P)^{-1}(\{u'\})
$$
and hence $c'$ maps this set into itself! Hence, if
$p_0, p_1, p_2: R' \times_{t',U',s'} R' \rightarrow U'$ are
the three projections, then $T \cap p_i^{-1}(\{u'\}) = 0$ for $i = 0, 1, 2$.
Since the restrictions of $p_i$ to $P \times_{s'|_P, U', t'|_P} P$ are finite
(because $s'|_P$ and $t'|_P$ are finite), we see that $p_i(T) \subset U'$
is a closed subscheme which does not contain the point $u'$.
Hence we may replace $U'$ by $U' \setminus p_0(T) \cup p_1(T) \cup p_2(T)$
to get to the case where $T = \emptyset$. At this point
we see that $c'(P \times_{s'|_P, U', t'|_P} P) \subset P$
as desired. We omit the verifications that, possibly after shrinking $S'$,
we may assume that also $e'(U') \subset P$ and $i'(P) \subset P$.
Hence we get a groupoid scheme $(U', P, s'|_P, t'|_P, c'|_P, e'|_P, i'|_P)$
and the lemma follows.
\end{proof}













\section{Descent data give equivalence relations}
\label{section-equivalence-relation}

\noindent
In Descent, Section \ref{descent-section-simplicial} we saw how descent
data relative to $X \to S$ can be formulated in terms of cartesian simplicial
schemes over $(X/S)_\bullet$. Here we link this to equivalence
relations as follows.

\begin{lemma}
\label{lemma-equivalence-relation}
Let $f : X \to S$ be a morphism of schemes.
Let $\pi : V_\bullet \to (X/S)_\bullet$ be a cartesian morphism,
see Descent, Definition \ref{descent-definition-cartesian-morphism}.
Then the morphism
$$
j = (d^1_1, d^1_0) : V_1 \to V_0 \times_S V_0
$$
defines an equivalence relation on $V_0$ over $S$,
see Definition \ref{definition-equivalence-relation}.
\end{lemma}

\begin{proof}
Note that $j$ is a monomorphism. Namely the
composition $V_1 \to V_0 \times_S V_0 \to V_0 \times_S X$
is an isomorphism as $\pi$ is cartesian.

\medskip\noindent
Consider the morphism
$$
(d^2_2, d^2_0) : V_2 \to V_1 \times_{d^1_0, V_0, d^1_1} V_1.
$$
This works because $d_0 \circ d_2 = d_1 \circ d_0$,
see Simplicial, Remark \ref{simplicial-remark-relations}.
Also, it is a morphism over $(X/S)_2$. It is an isomorphism
because $V_\bullet \to (X/S)_\bullet$ is cartesian.
Note for example that the
right hand side is isomorphic to
$V_0 \times_{\pi_0, X, \text{pr}_1} (X \times_S X \times_S X) =
X \times_S V_0 \times_S X$
because $\pi$ is cartesian. Details omitted.

\medskip\noindent
As usual, see Definition \ref{definition-equivalence-relation}
we denote $t = \text{pr}_0 \circ j = d^1_1$ and
$s = \text{pr}_1 \circ j = d^1_0$.
The isomorphism above, combined with the morphism
$d^2_1 : V_2 \to V_1$ give us a composition morphism
$$
c : V_1 \times_{s, V_0, t} V_1 \longrightarrow V_1
$$
over $V_0 \times_S V_0$. This immediately implies
that for any scheme $T/S$ the relation
$V_1(T) \subset V_0(T) \times V_0(T)$ is transitive.

\medskip\noindent
Reflexivity follows from the fact that the
restriction of the morphism $j$ to the diagonal
$\Delta : X \to X\times_S X$ is an isomorphism
(again use the cartesian property of $\pi$).

\medskip\noindent
To see symmetry we consider the morphism
$$
(d^2_2, d^2_1) : V_2 \to V_1 \times_{d^1_1, V_0, d^1_1} V_1.
$$
This works because $d_1 \circ d_2 = d_1 \circ d_1$,
see Simplicial, Remark \ref{simplicial-remark-relations}.
It is an isomorphism
because $V_\bullet \to (X/S)_\bullet$ is cartesian.
Note for example that the
right hand side is isomorphic to
$V_0 \times_{\pi_0, X, \text{pr}_0} (X \times_S X \times_S X) =
V_0 \times_S X \times_S X$
because $\pi$ is cartesian. Details omitted.

\medskip\noindent
Let $T/S$ be a scheme. Let $a \sim b$ for $a, b \in V_0(T)$
be synonymous with $(a, b) \in V_1(T)$.
The isomorphism $(d^2_2, d^2_1)$ above
implies that if $a \sim b$ and $a \sim c$, then $b \sim c$.
Combined with reflexivity this shows that $\sim$ is
an equivalence relation.
\end{proof}







\section{An example case}
\label{section-example}

\noindent
In this section we show that disjoint unions of spectra
of Artinian rings can be descended along a quasi-compact
surjective flat morphism of schemes.

\begin{lemma}
\label{lemma-equivalence-classes-points}
Let $X \to S$ be a morphism of schemes.
Suppose $V_\bullet \to (X/S)_\bullet$ is cartesian.
For $v \in V_0$ a point define
$$
T_v = \{v' \in V \mid \exists\ v_1 \in V_1:
d^1_1(v_1) = v, d^1_0(v_1) = v'\}
$$
as a subset of $V_0$. Then $v \in T_v$ and
$T_v \cap T_{v'} \not = \emptyset \Rightarrow T_v = T_{v'}$.
\end{lemma}

\begin{proof}
Combine Lemmas \ref{lemma-equivalence-relation} and
\ref{lemma-pre-equivalence-equivalence-relation-points}.
\end{proof}

\begin{lemma}
\label{lemma-quasi-compact}
Let $X \to S$ be a morphism of schemes.
Suppose $V_\bullet \to (X/S)_\bullet$ is cartesian.
Let $v \in V_0$ be a point. If $X \to S$ is quasi-compact, then
$$
T_v = \{v' \in V \mid \exists\ v_1 \in V_1:
d^1_1(v_1) = v, d^1_0(v_1) = v'\}
$$
is a quasi-compact subset of $V_0$.
\end{lemma}

\begin{proof}
Let $F_v$ be the scheme theoretic fibre of $d^1_1 : V_1 \to V_0$
at $v$. Then we see that $T_v$ is the image of the morphism
$$
\xymatrix{
F_v \ar[r] \ar[d] &
V_1 \ar[r]^{d^1_0} \ar[d]^{d^1_1} &
V_0 \\
v \ar[r] &
V_0 &
}
$$
Note that $F_v$ is quasi-compact. This proves the lemma.
\end{proof}

\begin{lemma}
\label{lemma-descent-disjoint-union-Artinian-along-fields}
Let $X \to S$ be a quasi-compact flat surjective morphism.
Let $(V, \varphi)$ be a descent datum relative
to $X \to S$. If $V$ is a disjoint union of
spectra of Artinian rings, then $(V, \varphi)$
is effective.
\end{lemma}

\begin{proof}
We may write $V = \coprod_{i \in I} \text{Spec}(A_i)$
with each $A_i$ local Artinian. Moreover, let
$v_i \in V$ be the unique closed point of $\text{Spec}(A_i)$
for all $i \in I$. Write $i \sim j$ if and only if
$v_i \in T_{v_j}$ with notation as in
Lemma \ref{lemma-equivalence-classes-points} above.
By Lemmas \ref{lemma-equivalence-classes-points} and \ref{lemma-quasi-compact}
this is an equivalence relation with finite equivalence
classes. Let $\overline{I} = I/\sim$. Then we can write
$V = \coprod_{\overline{i} \in \overline{I}} V_{\overline{i}}$
with
$V_{\overline{i}} = \coprod_{i \in \overline{i}} \text{Spec}(A_i)$.
By construction we see that
$\varphi : V \times_S X \to X \times_S V$ maps
the open and closed subspaces $V_{\overline{i}} \times_S X$
into the open and closed subspaces $X \times_S V_{\overline{i}}$.
In other words, we get descent data
$(V_{\overline{i}}, \varphi_{\overline{i}})$, and
$(V, \varphi)$ is the coproduct of them in the category of
descent data.
Since each of the $V_{\overline{i}}$ is a finite union of
spectra of Artinian local rings the morphism $V_{\overline{i}} \to X$
is affine, see Morphisms, Lemma \ref{morphisms-lemma-Artinian-affine}.
Since $\{X \to S\}$ is an fpqc covering we see that all
the descent data $(V_{\overline{i}}, \varphi_{\overline{i}})$ are effective
by Descent, Lemma \ref{descent-lemma-affine}.
Hence we win.
\end{proof}

\noindent
To be sure, the lemma above has very limited applicability!












\input{chapters}

\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}
