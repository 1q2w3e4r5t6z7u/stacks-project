\input{preamble}

% OK, start here.
%
\begin{document}

\title{Groupoid schemes}


\maketitle

\phantomsection
\label{section-phantom}

\tableofcontents

\section{Introduction}
\label{section-introduction}

\noindent
This chapter is devoted to generalities concering groupoid schemes.
See for example the beautiful paper \cite{K-M} by Keel and Mori.





\section{Notation}
\label{section-notation}

\noindent
Let $S$ be a scheme. If $U$, $T$ are schemes over $S$ we denote
$U(T)$ for the set of $T$-valued points of $U$ {\it over} $S$. In a formula:
$U(T) = \text{Mor}_S(T, U)$. We try to reserve the letter $T$ to denote
a ``test scheme'' over $S$, as in the discussion that follows.
Suppose we are given schemes $X$, $Y$ over
$S$ and a morphism of schemes $f : X \to Y$ over $S$.
For any scheme $T$ over $S$ we get an induced map of sets
$$
f : X(T) \longrightarrow Y(T)
$$
which as indicated we denote by $f$ also. In fact this construction
is functorial in the scheme $T/S$. Yoneda's Lemma, see Categories,
Lemma \ref{categories-lemma-yoneda}, says that $f$ determines and is
determined by this transformation of functors $f : h_X \to h_Y$.
More generally, we use the same notation for maps between fibre
products. For example, if
$X$, $Y$, $Z$ are schemes over $S$, and if
$m : X \times_S Y \to Z \times_S Z$ is
a morphism of schemes over $S$, then we think of $m$ as corresponding
to a collection of maps between $T$-valued points
$$
X(T) \times Y(T) \longrightarrow Z(T) \times Z(T).
$$
And so on and so forth.






\section{Equivalence relations}
\label{section-equivalence-relations}

\noindent
Recall that a {\it relation} $R$ on a set $A$ is just a subset
of $R \subset A \times A$.We usually write $a R b$ to indicate
$(a, b) \in R$. We say the relation is {\it transitive} if
$a R b, b R c \Rightarrow a R c$. We say the relation is
{\it reflexive} if $a R a$ for all $a \in A$. We say the relation is
{\it symmetric} if $a R b \Rightarrow b R a$.
A relation is called an {\it equivalence relation} if
it is transitive, reflexive and symmetric.

\medskip\noindent
In the setting of schemes we are going to relax the notion of a
relation a little bit and just require $R \to A \times A$ to
be a map. Here is the definition.

\begin{definition}
\label{definition-equivalence-relation}
Let $S$ be a scheme. Let $U$ be a scheme over $S$.
\begin{enumerate}
\item A {\it pre-relation} on $U$ over $S$ is any morphism
$j : R \to U \times_S U$. In this case we set
$t = \text{pr}_0 \circ j$ and $s = \text{pr}_1 \circ j$, so
that $j = (t, s)$.
\item A {\it relation} on $U$ over $S$ is a monomorphism
$j : R \to U \times_S U$.
\item A {\it pre-equivalence relation} is a pre-relation
$j : R \to U\times_SU$ such that the image of
$j : R(T) \to U(T) \times U(T)$ is an equivalence relation for
all $T/S$.
\item We say a morphism $R \to U \times_S U$ is
an {\it equivalence relation on $U$ over $S$}
if and only if for every $T/S$ the $T$-valued
points of $R$ define an equivalence relation
on the set of $T$-valued points of $U$.
\end{enumerate}
\end{definition}

\noindent
In other words, an equivalence relation is a pre-equivalence relation
such that $j$ is a relation.

\begin{lemma}
\label{lemma-restrict-relation}
Let $S$ be a scheme.
Let $U$ be a scheme over $S$.
Let $j : R \to U \times_S U$ be a pre-relation.
Let $g : U' \to U$ be a morphism of schemes.
Finally, set
$$
R' = (U' \times_S U')\times_{U \times_S U} R
\xrightarrow{j'}
U' \times_S U'
$$
Then $j'$ is a pre-relation on $U'$ over $S$.
If $j$ is a relation, then $j'$ is a relation.
If $j$ is a pre-equivalence relation, then $j'$ is a pre-equivalence relation.
If $j$ is an equivalence relation, then $j'$ is an equivalence relation.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{definition}
\label{definition-restrict-relation}
Let $S$ be a scheme.
Let $U$ be a scheme over $S$.
Let $j : R \to U \times_S U$ be a pre-relation.
Let $g : U' \to U$ be a morphism of schemes.
The pre-relation $j' : R' \to U' \times_S U'$ is called
the {\it restriction}, or {\it pullback} of the pre-relation $j$ to $U'$.
In this situation we sometimes write $R' = R|_{U'}$.
\end{definition}

\begin{lemma}
\label{lemma-pre-equivalence-equivalence-relation-points}
Let $j : R \to U\times_S U$ be a pre-relation.
Consider the relation on points of the scheme $U$ defined by
the rule
$$
x \sim y
\Leftrightarrow
\exists\ r \in R :
t(r) = x,
s(r) = y.
$$
If $j$ is a pre-equivalence relation then this is an
equivalence relation.
\end{lemma}

\begin{proof}
Suppose that $x \sim y$ and $y \sim z$.
Pick $r \in R$ with $t(r) = x$, $s(r) = y$ and
pick $r' \in R$ with $t(r') = y$, $s(r') = z$.
Pick a field $K$ fitting into the following commutative
diagram
$$
\xymatrix{
\kappa(r) \ar[r] & K \\
\kappa(y) \ar[u] \ar[r] & \kappa(r') \ar[u]
}
$$
Denote $x_K, y_K, z_K : \text{Spec}(K) \to U$
the morphisms
$$
\begin{matrix}
\text{Spec}(K) \to \text{Spec}(\kappa(r))
\to
\text{Spec}(\kappa(x)) \to U \\
\text{Spec}(K) \to \text{Spec}(\kappa(r))
\to
\text{Spec}(\kappa(y)) \to U \\
\text{Spec}(K) \to \text{Spec}(\kappa(r'))
\to
\text{Spec}(\kappa(z)) \to U
\end{matrix}
$$
By construction $(x_K, y_K) \in j(R(K))$ and
$(y_K, z_K) \in j(R(K))$. Since $j$ is a pre-equivalence relation
we see that also $(x_K, z_K) \in j(R(K))$.
This clearly implies that $x \sim z$.

\medskip\noindent
The proof that $\sim$ is reflexive and symmetric is omitted.
\end{proof}















\section{Group schemes}
\label{section-group-schemes}

\noindent
Let us recall that a {\it group} is a pair
$(G, m)$ where $G$ is a set, and $m : G \times G \to G$ is
a map of sets with the following properties:
\begin{enumerate}
\item (associativity) $m(g, m(g', g'')) = m(m(g, g'), g'')$
for all $g, g', g'' \in G$,
\item (identity) there exists a unique element $e \in G$
(called the {\it identity}, {\it unit}, or $1$ of $G$) such that
$m(g, e) = m(e, g) = g$ for all $g \in G$, and
\item (inverse) for all $g \in G$ there exists a $i(g) \in G$
such that $m(g, i(g)) = m(i(g), g) = e$, where $e$ is the
identity.
\end{enumerate}
Thus we obtain a map $e : \{*\} \to G$ and a map
$i : G \to G$ so that the quadruple $(G, m, e, i)$
satisfies the axioms listed above.

\medskip\noindent
A {\it homomorphism of groups} $\psi : (G, m) \to (G', m')$
is a map of sets $\psi : G \to G'$ such that
$m'(\psi(g), \psi(g')) = \psi(m(g, g'))$. This automatically
insures that $\psi(e) = e'$ and $i'(\psi(g)) = \psi(i(g))$.
(Obvious notation.) We will use this below.

\begin{definition}
\label{definition-group-scheme}
Let $S$ be a scheme.
\begin{enumerate}
\item A {\it group scheme over $S$} is a pair $(G, m)$, where
$G$ is a scheme over $S$ and $m : G \times_S G \to G$ is
a morphism of schemes over $S$ with the following property:
For every scheme $T$ over $S$ the pair $(G(T), m)$
is a group.
\item A {\it morphism $\psi : (G, m) \to (G', m')$ of group schemes over $S$}
is a morphism $\psi : G \to G'$ of schemes over $S$ such that for
every $T/S$ the induced map $\psi : G(T) \to G'(T)$ is a homomorphism
of groups.
\end{enumerate}
\end{definition}

\noindent
Let $(G, m)$ be a group scheme over the scheme $S$.
By the discussion above (and the discussion in Section \ref{section-notation})
we obtain morphisms of schemes over $S$:
(identity) $e : S \to G$ and (inverse) $i : G \to G$ such that
for every $T$ the quadruple $(G(T), m, e, i)$ satsifies the
axioms of a group listed above.

\medskip\noindent
Let $(G, m)$, $(G', m')$ be group schemes over $S$.
Let $f : G \to G'$ be a morphism of schemes over $S$.
It follows from the definition that $f$ is a morphism
of group schemes over $S$ if and only if the following diagram
is commutative:
$$
\xymatrix{
G \times_S G \ar[r]_-{f \times f} \ar[d]_m &
G' \times_S G' \ar[d]^m \\
G \ar[r]^f & G'
}
$$

\begin{lemma}
\label{lemma-base-change-group-scheme}
Let $(G, m)$ be a group scheme over $S$.
Let $S' \to S$ be a morphism of schemes.
The pullback $(G_{S'}, m_{S'})$ is a group scheme over $S'$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{example}
\label{example-multiplicative-group}
(Multiplicative group scheme.)
Consider the functor which associates
to any scheme $T$ the group $\Gamma(T, \mathcal{O}_T^*)$
of units in the global sections of the structure sheaf.
This is representable by the scheme
$$
\mathbf{G}_m = \text{Spec}(\mathbf{Z}[x, x^{-1}])
$$
The morphism giving the group structure is the morphism
\begin{eqnarray*}
\mathbf{G}_m \times \mathbf{G}_m & \to & \mathbf{G}_m \\
\text{Spec}(\mathbf{Z}[x, x^{-1}] \otimes_{\mathbf{Z}} \mathbf{Z}[x, x^{-1}])
& \to &
\text{Spec}(\mathbf{Z}[x, x^{-1}]) \\
\mathbf{Z}[x, x^{-1}] \otimes_{\mathbf{Z}} \mathbf{Z}[x, x^{-1}]
& \leftarrow &
\mathbf{Z}[x, x^{-1}] \\
x \otimes x & \leftarrow & x
\end{eqnarray*}
Hence we see that $\mathbf{G}_m$ is a group scheme over $\mathbf{Z}$.
For any scheme $S$ the base change $\mathbf{G}_{m, S}$ is a
group scheme over $S$ whose functor of points is
$$
T/S
\longmapsto
\mathbf{G}_{m, S}(T) = \mathbf{G}_m(T) = \Gamma(T, \mathcal{O}_T^*)
$$
as before.
\end{example}

\begin{example}
\label{example-additive-group}
(Additive group scheme.)
Consider the functor which associates
to any scheme $T$ the group $\Gamma(T, \mathcal{O}_T)$
of global sections of the structure sheaf.
This is representable by the scheme
$$
\mathbf{G}_a = \text{Spec}(\mathbf{Z}[x])
$$
The morphism giving the group structure is the morphism
\begin{eqnarray*}
\mathbf{G}_a \times \mathbf{G}_a & \to & \mathbf{G}_a \\
\text{Spec}(\mathbf{Z}[x] \otimes_{\mathbf{Z}} \mathbf{Z}[x])
& \to &
\text{Spec}(\mathbf{Z}[x]) \\
\mathbf{Z}[x] \otimes_{\mathbf{Z}} \mathbf{Z}[x]
& \leftarrow &
\mathbf{Z}[x] \\
x \otimes 1 + 1 \otimes x & \leftarrow & x
\end{eqnarray*}
Hence we see that $\mathbf{G}_a$ is a group scheme over $\mathbf{Z}$.
For any scheme $S$ the base change $\mathbf{G}_{a, S}$ is a
group scheme over $S$ whose functor of points is
$$
T/S
\longmapsto
\mathbf{G}_{a, S}(T) = \mathbf{G}_a(T) = \Gamma(T, \mathcal{O}_T)
$$
as before.
\end{example}

\begin{example}
\label{example-general-linear-group}
(General linear group scheme.)
Let $n \geq 1$.
Consider the functor which associates
to any scheme $T$ the group
$$
\text{GL}_n(\Gamma(T, \mathcal{O}_T))
$$
of invertible $n \times n$ matrices over
the global sections of the structure sheaf.
This is representable by the scheme
$$
\text{GL}_n = \text{Spec}(\mathbf{Z}[\{x_{ij}\}_{1 \leq i, j \leq n}][1/d])
$$
where $d = \det((x_{ij}))$ with $(x_{ij})$ the $n \times n$ matrix
with entry $x_{ij}$ in the $(i, j)$-spot.
The morphism giving the group structure is the morphism
\begin{eqnarray*}
\text{GL}_n \times \text{GL}_n & \to & \text{GL}_n \\
\text{Spec}(\mathbf{Z}[x_{ij}, 1/d] \otimes_{\mathbf{Z}}
\mathbf{Z}[x_{ij}, 1/d])
& \to &
\text{Spec}(\mathbf{Z}[x_{ij}, 1/d]) \\
\mathbf{Z}[x_{ij}, 1/d] \otimes_{\mathbf{Z}} \mathbf{Z}[x_{ij}, 1/d]
& \leftarrow &
\mathbf{Z}[x_{ij}, 1/d] \\
\sum x_{ik} \otimes x_{kj} & \leftarrow & x_{ij}
\end{eqnarray*}
Hence we see that $\text{GL}_n$ is a group scheme over $\mathbf{Z}$.
For any scheme $S$ the base change $\text{GL}_{n, S}$ is a
group scheme over $S$ whose functor of points is
$$
T/S
\longmapsto
\text{GL}_{n, S}(T) = \text{GL}_n(T) =\text{GL}_n(\Gamma(T, \mathcal{O}_T))
$$
as before.
\end{example}

\begin{example}
\label{example-determinant}
The determinant defines a morphisms of group schemes
$$
\det : \text{GL}_n \longrightarrow \mathbf{G}_m
$$
over $\mathbf{Z}$. By base change it gives a morphism
of group schemes $\text{GL}_{n, S} \to \mathbf{G}_{m, S}$
over any base scheme $S$.
\end{example}





\section{Actions of group schemes}
\label{section-action-grou-scheme}

\noindent
Let $(G, m)$ be a group and let $V$ be a set.
Recall that a {\it (left) action} of $G$ on $V$ is given
by a map $a : G \times V \to V$ such that
\begin{enumerate}
\item (associativity) $a(m(g, g'), v) = a(g, a(g', v))$ for all
$g, g' \in G$ and $v \in V$, and
\item (identity) $a(e, v) = v$ for all $v \in V$.
\end{enumerate}
We also say that $V$ is a {\it $G$-set} (this usually means we
drop the $a$ from the notation -- which is abuse of notation).
A {\it map of $G$-sets} $\psi : V \to V'$ is any set map
such that $\psi(a(g, v)) = a(g, \psi(v))$ for all $v \in V$.

\begin{definition}
\label{definition-action-group-scheme}
Let $S$ be a scheme. Let $(G, m)$ be a group scheme over $S$.
\begin{enumerate}
\item An {\it action of $G$ on the scheme $X/S$} is
a morphism $a : G \times_S X \to X$ over $S$ such that
for every $T/S$ the map $a : G(T) \times X(T) \to X(T)$
defines the structure of a $G(T)$-set on $X(T)$.
\item Suppose that $X$, $Y$ are schemes over $S$ each endowed
with an action of $G$. An {\it equivariant} or more precisely
a {\it $G$-equivariant} morphism $\psi : X \to Y$
is a morphism of schemes over $S$ such
that for every $T/S$ the map $\psi : X(T) \to Y(T)$ is
a morphism of $G(T)$-sets.
\end{enumerate}
\end{definition}

\noindent
So in the situation of (2) this just means that the diagram
$$
\xymatrix{
G \times_S X \ar[r]_-{\text{id} \times f} \ar[d]_a &
G \times_S Y \ar[d]^a \\
X \ar[r]^f & Y
}
$$
commutes.




\section{Groupoids}
\label{section-groupoids}

\noindent
Recall that a groupoid is a category in which every morphism
is an isomorphism, see
Categories, Definition \ref{categories-definition-groupoid}.
Hence a groupoid has a set of objects $\text{Ob}$,
a set of arrows $\text{Arrows}$, a {\it source} and {\it target}
map $s, t : \text{Arrows} \to \text{Ob}$, and a {\it composition law}
$c : \text{Arrows} \times_{s, \text{Ob}, t} \text{Arrows}
\to \text{Arrows}$.
These maps satisfy exactly the following axioms
\begin{enumerate}
\item (associativity) $c \circ (1, c) = c \circ (c, 1)$ as maps
$\text{Arrows} \times_{s, \text{Ob}, t}
\text{Arrows} \times_{s, \text{Ob}, t}
\text{Arrows} \to \text{Arrows}$,
\item (identity) there exists a map $e : \text{Ob} \to \text{Arrows}$
such that
\begin{enumerate}
\item $s \circ e = t \circ e = \text{id}$ as maps $\text{Ob} \to \text{Ob}$,
\item $c \circ (1, e \circ s) = c \circ (e \circ t, 1) = 1$
as maps $\text{Arrows} \to \text{Arrows}$,
\end{enumerate}
\item (inverse) there exists a map $i : \text{Arrows} \to \text{Arrows}$
such that
\begin{enumerate}
\item $s \circ i = t$, $t \circ i = s$ as maps $\text{Arrows} \to \text{Ob}$,
and
\item $c \circ (1, i) = e \circ s$ and $c \circ (i, 1) = e \circ t$
as maps $\text{Arrows} \to \text{Arrows}$.
\end{enumerate}
\end{enumerate}
If this is the case the maps $e$ and $i$ are uniquely determined and
$i$ is a bijection. Note that if $(\text{Ob}', \text{Arrows}', s', t', c')$
is a second groupoid category, then a functor
$f : (\text{Ob}, \text{Arrows}, s, t, c) \to
(\text{Ob}', \text{Arrows}', s', t', c')$
is given by a pair of set maps $f : \text{Ob} \to \text{Ob}'$ and
$f : \text{Arrows} \to \text{Arrows}'$ such that
$s' \circ f = f \circ s$, $t' \circ f = f \circ t$, and
$c' \circ (f, f) = f \circ c$. The compatibility with identity and
inverse is automatic. We will use this below.
(Warning: The compatibility with identity
has to be imposed in the case of general categories.)

\begin{definition}
\label{definition-groupoid}
Let $S$ be a scheme.
\begin{enumerate}
\item A {\it groupoid scheme over $S$}, or simply a
{\it groupoid over $S$} is a
quintuple $(U, R, s, t, c)$ where
$U$ and $R$ are schemes over $S$, and
$s, t : R \to U$ and $c : R \times_{s, U, t} R \to R$
are morphisms of schemes over $S$ with the
following property: For any scheme
$T$ over $S$ the quintuple
$$
(U(T), R(T), s, t, c)
$$
is a groupoid category in the sense described above.
\item A {\it morphism
$f : (U, R, s, t, c) \to (U', R', s', t', c')$
of groupoid schemes over $S$} is given by morphisms
of schemes $f : U \to U'$ and $f : R \to R'$ with the
following property:  For any scheme
$T$ over $S$ the maps $f$ define a functor from the
groupoid category $(U(T), R(T), s, t, c)$ to the
groupoid category $(U'(T), R'(T), s', t', c')$.
\end{enumerate}
\end{definition}

\noindent
Let $(U, R, s, t, c)$ be a groupoid over $S$.
Note that, by the remarks preceding the definition and the Yoneda lemma,
there are unique morphisms of schemes
$e : U \to R$ and
$i : R \to R$ over $S$ such that for every scheme $T$ over $S$
the induced map $e : U(T) \to R(T)$ is the identity, and
$i : R(T) \to R(T)$ is the inverse of
the groupoid category. The septuple $(U, R, s, t, c, e, i)$
satisfies commutative diagrams corresponding to each of the
axioms (1), (2)(a), (2)(b), (3)(a) and (3)(b) above, and conversely
given a septuple with this property the quintuple $(U, R, s, t, c)$
is a groupoid scheme. Note that $i$ is an isomorphism,
and $e$ is a section of both $s$ and $t$.
Moreover, given a groupoid scheme over $S$ we denote
$$
j = (t, s) : R \longrightarrow U \times_S U
$$
which is compatible with our conventions in Section
\ref{section-equivalence-relations} above.
We sometimes say ``let $(U, R, s, t, c, e, i)$ be a
groupoid over $S$'' to stress the existence of identity and
inverse.

\begin{lemma}
\label{lemma-groupoid-pre-equivalence}
Given a groupoid scheme $(U, R, s, t, c)$ over $S$
the morphism $j : R \to U\times_S U$ is a pre-equivalence
relation.
\end{lemma}

\begin{proof}
Omitted.
This is a nice exercise in the definitions.
\end{proof}

\begin{lemma}
\label{lemma-equivalence-groupoid}
Given an equivalence relation $j : R \to U$ over $S$
there is a unique way to extend it to a groupoid
$(U, R, s, t, c)$ over $S$.
\end{lemma}

\begin{proof}
Omitted.
This is a nice exercise in the definitions.
\end{proof}

\noindent
There are many ways to construct a groupoid out of an action $a$
of a group $G$ on a set $V$. We choose the one where we think
of an element $g \in G$ as an arrow with source $v$ and target $a(g, v)$.
This leads to the following construction for group actions of
schemes.

\begin{lemma}
\label{lemma-groupoid-from-action}
Let $S$ be a scheme.
Let $Y$ be a scheme over $S$
Let $(G, m)$ be a group scheme over $Y$ with
identity $e_G$ and inverse $i_G$.
Let $X/Y$ be a scheme over $Y$ and let $a : G \times_Y X \to X$
be an action of $G$ on $X/Y$.
Then we get a groupoid scheme $(U, R, s, t, c, e, i)$ over $S$
in the following manner:
\begin{enumerate}
\item We set $U = X$, and $R = G \times_Y X$.
\item We set $s : R \to U$ equal to $(g, x) \mapsto x$.
\item We set $t : R \to U$ equal to $(g, x) \mapsto a(g, x)$.
\item We set $c : R \times_{s, U, t} R \to R$ equal to
$((g, a(g', x)), (g', x)) \mapsto (m(g, g'), x)$.
\item We set $e : U \to R$ equal to $x \mapsto (e_G(x), x)$.
\item We set $i : R \to R$ equal to $(g, x) \mapsto (i_G(g), a(g, x))$.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted. Hint: It is enough to show that this works on the set
level. For this use the description above the lemma describing
$g$ as an arrow from $v$ to $a(g, v)$.
\end{proof}

\noindent
On the other hand, given a groupoid scheme we get a group scheme as
follows.

\begin{lemma}
\label{lemma-groupoid-stabilizer}
Let $S$ be a scheme.
Let $(U, R, s, t, c)$ be a groupoid over $S$.
The scheme $G$ defined by the cartesian square
$$
\xymatrix{
G \ar[r] \ar[d] & R \ar[d]^{j = (t, s)} \\
U \ar[r]^-{\Delta} & U \times_S U
}
$$
is a group scheme over $U$ with compostion law
$m$ induced by the composition law $c$.
\end{lemma}

\begin{proof}
This is true because in a groupoid category the
set of self maps of any object forms a group.
\end{proof}

\noindent
Since $\Delta$ is an immersion we see that $G = j^{-1}(\Delta_{U/S})$
is a locally closed subscheme of $R$. Thinking of it in this way,
the structure morphism $j^{-1}(\Delta_{U/S}) \to U$ is induced by
either $s$ or $t$ (it is the same), and $m$ is induced by $c$.

\begin{definition}
\label{definition-stabilizer-groupoid}
Let $S$ be a scheme.
Let $(U, R, s, t, c)$ be a groupoid over $S$.
The group scheme $j^{-1}(\Delta_{U/S})\to U$
is called the {\it stabilizer of the groupoid scheme
$(U, R, s, t, c)$}.
\end{definition}

\noindent
In the literature the stabilizer group scheme is often denoted $S$
(because the word stabilizer starts with an ``s'' presumably);
we cannot do this since we have already used $S$ for the base scheme.

\begin{lemma}
\label{lemma-groupoid-action-stabilizer}
Let $S$ be a scheme.
Let $(U, R, s, t, c)$ be a groupoid over $S$, and let $G/U$ be its stabilizer.
Denote $R_t/U$ the scheme $R$ seen as a scheme over $U$ via the
morphism $t : R \to U$.
There is a canonical left action
$$
a : G \times_U R_t \longrightarrow R_t
$$
induced by the composition law $c$.
\end{lemma}

\begin{proof}
In terms of points over $T/S$ we define $a(g, r) = c(g, r)$.
\end{proof}








\section{Restricting groupoids}
\label{section-restrict-groupoid}

\noindent
Consider a (usual) groupoid
$\mathcal{C} = (\text{Ob}, \text{Arrows}, s, t, c)$.
Suppose we have a map of sets $g : \text{Ob}' \to \text{Ob}$.
Then we can construct a groupoid
$\mathcal{C}' = (\text{Ob}', \text{Arrows}', s', t', c')$
by thinking of a morphism between elements $x', y'$ of $\text{Ob}'$
as a morphisms in $\mathcal{C}$ between $g(x'), g(y')$.
In other words we set
$$
\text{Arrows}' =
\text{Ob}'
\times_{g, \text{Ob}, t}
\text{Arrows}
\times_{s, \text{Ob}, g}
\text{Ob}'.
$$
with obvious choices for $s'$, $t'$, and $c'$. There is a canonical
functor $\mathcal{C}' \to \mathcal{C}$ which is fully faithful,
but not necessarily essentially surjective. This groupoid $\mathcal{C}'$
endowed with the functor $\mathcal{C}' \to \mathcal{C}$
is called the {\it restriction} of the groupoid
$\mathcal{C}$ to $\text{Ob}'$.

\begin{lemma}
\label{lemma-restrict-groupoid}
Let $S$ be a scheme.
Let $(U, R, s, t, c)$ be a groupoid scheme over $S$.
Let $g : U' \to U$ be a morphism of schemes.
Consider the following diagram
$$
\xymatrix{
R' \ar[d] \ar[r] \ar@/_3pc/[dd]_{t'} \ar@/^1pc/[rr]^{s'}&
R \times_{s, U} U' \ar[r] \ar[d] &
U' \ar[d]^g \\
U' \times_{U, t} R \ar[d] \ar[r] &
R \ar[r]^s \ar[d]_t &
U \\
U' \ar[r]^g &
U
}
$$
where all the squares are fibre product squares. Then there is a
canonical composition law $c' : R' \times_{s', U', t'} R' \to R'$
such that $(U', R', s', t', c')$ is a groupoid scheme over
$S$ and such that $U' \to U$, $R' \to R$ defines a morphism
$(U', R', s', t', c') \to (U, R, s, t, c)$ of groupoid schemes over $S$.
Moreover, for any scheme $T$ over $S$ the functor of groupoids
$$
(U'(T), R'(T), s', t', c') \to (U(T), R(T), s, t, c)
$$
is the restriction (see above) of $(U(T), R(T), s, t, c)$ via the map
$U'(T) \to U(T)$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{definition}
\label{definition-restrict-groupoid}
Let $S$ be a scheme.
Let $(U, R, s, t, c)$ be a groupoid scheme over $S$.
Let $g : U' \to U$ be a morphism of schemes.
The morphism of groupoids
$(U', R', s', t', c') \to (U, R, s, t, c)$
constructed in Lemma \ref{lemma-restrict-groupoid} is called
the {\it restriction of $(U, R, s, t, c)$ to $U'$}.
We sometime use the notation $R' = R|_{U'}$ in this case.
\end{definition}

\begin{lemma}
\label{lemma-restrict-groupoid-relation}
The notions of restricting groupoids and 
(pre-)equivalence relations defined in Definitions
\ref{definition-restrict-groupoid} and \ref{definition-restrict-relation}
agree via the constructions of
Lemmas \ref{lemma-groupoid-pre-equivalence} and
\ref{lemma-equivalence-groupoid}.
\end{lemma}

\begin{proof}
What we are saying here is that $R'$ of
Lemma \ref{lemma-restrict-groupoid} is also
equal to
$$
R' = (U' \times_S U')\times_{U \times_S U} R
\longrightarrow
U' \times_S U'
$$
In fact this might have been a clearer way to state that lemma.
\end{proof}

\begin{definition}
\label{definition-invariant-open}
Let $S$ be a scheme.
Let $(U, R, s, t, c)$ be a groupoid scheme over $S$.
We say an open $W \subset U$ is {\it $R$-invariant} if
$t(s^{-1}(W)) \subset W$.
\end{definition}

\noindent
This is also equivalent to requiring that $s^{-1}(W) = t^{-1}(W)$.
If $W \subset U$ is $R$-equivariant then the restriction of $R$ to
$W$ is just $R_W = s^{-1}(W) = t^{-1}(W)$.










\section{Quotient sheaves}
\label{section-quotient-sheaves}

\noindent
Let $\tau \in \{Zariski, etale, fppf, smooth, syntomic\}$.
Let $S$ be a scheme.
Let $j : R \to U\times_S U$ be a pre-equivalence relation over $S$.
Say $U, R, S$ are objects of a $\tau$-site $\textit{Sch}_\tau$
(see Topologies, Section \ref{topologies-section-procedure}).
Then we can consider the functors
$$
h_U, h_R :
(\textit{Sch}/S)_\tau^{opp}
\longrightarrow
\textit{Sets}.
$$
These are sheaves, see
Descent, Lemma \ref{descent-lemma-fpqc-universal-effective-epimorphisms}.
The morphism $j$ induces a map $j : h_R \to h_U \times h_U$.
For each object $T \in \text{Ob}((\textit{Sch}/S)_\tau)$
we can take the equivalence relation $\sim_T$ generated by
$j(T) : R(T) \to U(T) \times U(T)$ and consider the quotient.
Hence we get a presheaf
\begin{equation}
\label{equation-quotient-presheaf}
(\textit{Sch}/S)_\tau^{opp}
\longrightarrow
\textit{Sets},\quad
T \longmapsto U(T)/\sim_T
\end{equation}

\begin{definition}
\label{definition-quotient-sheaf}
Let $\tau$, $S$, and the pre-relation $j : R \to U \times_S U$ be as above.
In this setting the {\it quotient sheaf $U/R$} associated
to $j$ is the sheafification of the presheaf
(\ref{equation-quotient-presheaf}) in the $\tau$-topology.
If $j : R \to U \times_S U$ comes from the action of a group scheme
$G/S$ on $U$ as in Lemma \ref{lemma-groupoid-from-action} then we
sometimes denote the quotient sheaf $U/G$.
\end{definition}

\noindent
This means exactly that the diagram
$$
\xymatrix{
h_R \ar@<1ex>[r] \ar@<-1ex>[r] &
h_U \ar[r] &
U/R
}
$$
is a coequalizer diagram in the category of sheaves of sets
on $(\textit{Sch}/S)_\tau$. Using the Yoneda embedding we
may view $(\textit{Sch}/S)_\tau$ as a full subcategory of
sheaves on $(\textit{Sch}/S)_\tau$ and hence identify schemes
with representable functors. Using this abuse of notation
we will often depict the diagram above simply
$$
\xymatrix{
R \ar@<1ex>[r]^s \ar@<-1ex>[r]_t &
U \ar[r] &
U/R
}
$$
We will mostly work with the fppf topology when considering
quotient sheaves of groupoids/equivalence relations.

\begin{definition}
\label{definition-representable-quotient}
In the situation of Definition \ref{definition-quotient-sheaf}.
We say that the pre-equivalence relation $j$ has a
{\it representable quotient} if the sheaf $U/R$ is representable.
We will say a groupoid $(U, R, s, t, c)$ has a
{\it representable quotient}
if the quotient $U/R$ with $j = (t, s)$ is representable.
\end{definition}

\begin{lemma}
\label{lemma-quotient-groupoid-restrict}
Let $\tau \in \{Zariski, etale, fppf, smooth, syntomic\}$.
Let $S$ be a scheme.
Let $j : R \to U\times_S U$ be a pre-relation over $S$
and $g : U' \to U$ a morphism of schemes over $S$.
Let $j' : R' \to U' \times_S U'$ be the restriction of $j$ to $U'$. 
Assume  $U, U', R, S$ are objects of a $\tau$-site $\textit{Sch}_\tau$.
The map of quotient sheaves
$$
U'/R' \longrightarrow U/R
$$
is injective. If $\{g : U' \to U\}$ is a $\tau$-covering, then
$U'/R' \to U/R$ is an isomorphism.
\end{lemma}

\begin{proof}
In this proof we will use the abuse of notation introduced
in the paragraphs above the lemma. Consider the commutative
diagram of sheaves
$$
\xymatrix{
R' \ar@<1ex>[r] \ar@<-1ex>[r] \ar[d] &
U' \ar[r] \ar[d] &
U'/R' \ar[d] \\
R \ar@<1ex>[r] \ar@<-1ex>[r] &
U \ar[r] &
U/R
}
$$
By construction $R' = R \times_{U \times U} (U' \times U')$ as
sheaves. It is easy to see this implies formally that
$U'/R' \to U/R$ is injective. If $\{g : U' \to U\}$ is a $\tau$-covering, then
the map of sheaves $U' \to U$ is surjective, see
Sites, Lemma \ref{sites-lemma-covering-surjective-after-sheafification}.
Hence $U'/R' \to U/R$ is surjective also in this case.
\end{proof}














\section{A technical lemma}
\label{section-technical-lemma}

\noindent
Here us a way to compare the fibres of the map $s : R \to U$ in
a groupoid.

\begin{lemma}
\label{lemma-diagram}
Let $S$ be a scheme.
Let $(U, R, s, t, c)$ be a groupoid over $S$.
In the commutative diagram
$$
\xymatrix{
& U & \\
R \ar[d]_s \ar[ru]^t &
R \times_{s, U, t} R
\ar[l]^-{\text{pr}_0} \ar[d]^{\text{pr}_1} \ar[r]_-c &
R \ar[d]^s \ar[lu]_t \\
U & R \ar[l]_t \ar[r]^s & U
}
$$
the two lower squares are fibre product squares.
Moreover, the triangle on top (which is really a square)
is also cartesian.
\end{lemma}

\begin{proof}
Omitted.
Exercise in the definitions and the functorial point of
view in algebraic geometry.
\end{proof}

\noindent
Consider two pairs $(X, x)$, $(S, s)$
where $X$, $S$ are schemes, $x$, $s$ are points.
A {\it morphism of germs} $f : (X, x) \to (S, s)$
is a morphism $f : U \to S$ defined on an open neighbourhood
of $x$ with $f(x) = s$. Two such
$f$, $f'$ are said to give the same morphism of germs
if and only if $f$ and $f'$ agree in some open neighbourhood of $x$.
Let $\tau \in \{Zariski, fpqc, fppf, etale, smooth, syntomic\}$.
We temporarily
introduce the following concept: We say that two morphisms
of germs $f : (X, x) \to (S, s)$ and $f' : (X', x') \to (S', s')$
are {\it isomorphic locally on the base in the $\tau$-topology},
if there exists a pointed scheme $(S'', s'')$ and morphisms of germs
$g : (S'', s'') \to (S, s)$, and $g' : (S'', s'') \to (S', s')$
such that
\begin{enumerate}
\item there exist open neighbourhoods $V$ of $s$
and $V''$ of $s''$ such that $\{g|_{V''} : V'' \to V\}$ is
a $\tau$-covering,
\item there exist open neighbourhoods $V'$ of $s'$
and $V''$ of $s''$ such that $\{g'|_{V''} : V'' \to V'\}$ 
is a $\tau$-covering,
\item there exists an isomorphism
$$
(S'' \times_{g, S, f} X, \tilde x)
\cong
(S'' \times_{g', S', f'} X', \tilde  x')
$$
of germs over the germ $(S'', s'')$ for some choice of points
$\tilde x$ and $\tilde x'$ lying over $(s'', x)$ and $(s'', x')$.
\end{enumerate}
Finally, we simply say that the maps of germs
$f : (X, x) \to (S, s)$ and $f' : (X', x') \to (S', s')$
are {\it flat locally on the base isomorphic} if there exist
$S'', s'', g, g'$ as above but with (1) and (2) simply replaced by
the condition that the local ring maps
$\mathcal{O}_{S, s} \to \mathcal{O}_{S'', s''}$
and $\mathcal{O}_{S', s'} \to \mathcal{O}_{S'', s''}$ are flat.

\begin{lemma}
\label{lemma-two-fibres}
Let $S$ be a scheme.
Let $(U, R, s, t, c)$ be a groupoid over $S$.
Let $r, r' \in R$ with $t(r) = t(r')$ in $U$.
Set $u = s(r)$, $u' = s(r')$.
Denote $F_u = s^{-1}(u)$ and $F_{u'} = s^{-1}(u')$ the scheme
theoretic fibres.
\begin{enumerate}
\item There exists a common field extension
$\kappa(u) \subset k$, $\kappa(u') \subset k$ and
an isomorphism $(F_u)_k \cong (F_{u'})_k$.
\item We may choose the isomorphism above such that a point
lying over $r$ maps to a point lying over $r'$.
\item If the morphisms $s$, $t$ are flat then the morphisms of germs
$s : (R, r) \to (U, u)$ and $s : (R, r') \to (U, u')$ are flat
locally on the base isomorphic.
\item If the morphisms $s$, $t$ are
flat and locally of finite presentation (resp.\ etale, smooth or
syntomic) then the morphisms of germs $s : (R, r) \to (U, u)$
and $s : (R, r') \to (U, u')$ are locally on the base isomorphic
in the fppf (resp.\ etale, smooth, syntomic) topology.
\end{enumerate}
\end{lemma}

\begin{proof}
We repeatedly use the properties and the existence of the diagram of
Lemma \ref{lemma-diagram}.
By the last assertion of that lemma (and
Schemes, Lemma \ref{schemes-lemma-points-fibre-product})
there exists a point $\xi$ of $R \times_{s, U, t} R$
with $\text{pr}_0(\xi) = r$ and $c(\xi) = r'$.
Let $\tilde r = \text{pr}_1(\xi) \in R$.

\medskip\noindent
Proof of (1). Set $k = \kappa(\tilde r)$. Since $t(\tilde r) = u$
and $s(\tilde r) = r'$ we see that $k$ is a common extension
of both $\kappa(u)$ and $\kappa(u')$ and in fact that
both $(F_u)_k$ and $(F_{u'})_k$ are isomorphic to the fibre of
$\text{pr}_1 : R \times_{s, U, t} R \to R$ over $\tilde r$.
Hence (1) is proved.

\medskip\noindent
Part (2) follows since the point $\xi$ maps to $r$, resp.\ $r'$.

\medskip\noindent
Part (3) is clear from the above (using the point $\xi$ for
$\tilde u$ and $\tilde u'$) and the definitions.

\medskip\noindent
If $s$ and $t$ are flat and of finite presentation, then
they are open morphisms (Morphisms, Lemma \ref{morphisms-lemma-fppf-open}).
Hence the image of some affine open neighbourhood $V''$ of $\tilde r$ will
cover an open neighbourhood $V$ of $u$, resp.\ $V'$ of $u'$.
These can be used to show that properties (1) and (2) of the
definition of ``locally on the base isomorphic in the
$\tau$-topology''.
\end{proof}









\section{Separation conditions}
\label{section-separation}

\noindent
This really means conditions on the morphism $j : R \to U \times_S U$
when given a groupoid $(U, R, s, t, c)$ over $S$. As in the previous
section we first formulate the corresponding diagram.

\begin{lemma}
\label{lemma-diagram-diagonal}
Let $S$ be a scheme.
Let $(U, R, s, t, c)$ be a groupoid over $S$.
Let $G \to U$ be the stabilizer group scheme.
The commutative diagram
$$
\xymatrix{
R \ar[d]^{\Delta_{R/U}} \ar[rrr]_{f \mapsto (f, s(f))} & & &
R \times_{s, U} U \ar[d] \ar[r] & U \ar[d] \\
R \times_{(U \times_S U)} R \ar[rrr]^{(f, g) \mapsto (f, f^{-1} \circ g)} & & &
R \times_{s, U} G \ar[r] & G
}
$$
the two left horizontal arrows are isomorphisms
and the right square is a fibre product square.
\end{lemma}

\begin{proof}
Omitted.
Exercise in the definitions and the functorial point of
view in algebraic geometry.
\end{proof}

\begin{lemma}
\label{lemma-diagonal}
Let $S$ be a scheme.
Let $(U, R, s, t, c)$ be a groupoid over $S$.
Let $G \to U$ be the stabilizer group scheme.
\begin{enumerate}
\item The morphism $j : R \to U \times_S U$ is separated if and only if
$G \to U$ is separated.
\item The morphism $j : R \to U \times_S U$ is quasi-separated if and only
if $G \to U$ is quasi-separated.
\end{enumerate}
\end{lemma}

\begin{proof}
The group scheme $G \to U$ is the base change of $R \to U \times_S U$
by the diagonal morphism $U \to U \times_S U$, see
Lemma \ref{lemma-groupoid-stabilizer}. Hence if
$j$ is separated (resp.\ quasi-separated),
then $G \to U$ is separated (resp.\ quasi-separated).
(See Schemes, Lemma
\ref{schemes-lemma-separated-permanence}).

\medskip\noindent
Conversely, if $G \to U$ is separated
(resp.\ quasi-separated), then the morphism $U \to G$, as a section
of the structure morphism $G \to U$ is a closed immersion
(resp.\ quasi-compact), see
Schemes, Lemma \ref{schemes-lemma-section-immersion}.
Hence by the result of Lemma \ref{lemma-diagram-diagonal}
(and Schemes, Lemmas \ref{schemes-lemma-base-change-immersion}
and \ref{schemes-lemma-quasi-compact-preserved-base-change})
we see that $\Delta_{R/U \times_S U}$ is a closed
immersion (resp.\ quasi-compact).
\end{proof}









\section{Finite flat groupoids}
\label{section-finite-flat}

\noindent
Let $S$ be a scheme.
Let $(U, R, s, t, c)$ be a groupoid scheme over $S$.
Assume $U = \text{Spec}(A)$, and $R = \text{Spec}(B)$ are affine.
In this case we get two ring maps
$s^\sharp, t^\sharp : A \longrightarrow B$.
Let $C$ be the equalizer of $s^\sharp$ and $t^\sharp$. In a formula
\begin{equation}
\label{equation-invariants}
C = \{a \in A \mid t^\sharp(a) = s^\sharp(a) \}.
\end{equation}
We will sometimes call this the {\it ring of $R$-invariant functions on $U$}.
What properties does $M = \text{Spec}(C)$ have? The first observation is
that the diagram
$$
\xymatrix{
R \ar[r]_s \ar[d]_t & U \ar[d] \\
U \ar[r] & M
}
$$
is commutative, i.e., the morphism $U \to M$ equalizes $s, t$.
Moreover, if $T$ is any affine scheme, and if $U \to T$ is
a morphism which equalizes $s, t$, then $U \to T$ factors through $U \to M$.
In other words, $U \to M$ is a coequalizer in the category of affine schemes.

\medskip\noindent
We would like to find conditions that garantee the morphism $U \to M$ is
really a ``quotient'' in the category of schemes. We will discuss this at
length elsewhere (insert future reference here); here we just discuss some
special cases. Namely, we will focus on the case where $s, t$ are finite
locally free.

\begin{example}
\label{example-quotient-projective-line}
Let $k$ be a field. Let $U = \text{GL}_{2, k}$. Let $B \subset \text{GL}_2$
be the closed subgroup scheme of upper triangular matrices. 
Then the quotient sheaf $\text{GL}_{2,k}/B$ (in the Zariski, etale or
fppf topology, see Definition \ref{definition-quotient-sheaf}) is
representable by the projective line: $\mathbf{P}^1 = \text{GL}_{2,k}/B$.
(Details omitted.)
On the other hand, the ring of invariant functions in this case is just $k$.
Note that in this case the morphisms
$s, t : R = \text{GL}_{2, k} \times_k B \to \text{GL}_{2, k} = U$ are smooth
of relative dimension $3$.
\end{example}

\noindent
Recall that in Exercises \ref{exercises-exercise-trace-det}
and \ref{exercises-exercise-trace-det-rings} we have defined the determinant
and the norm for finitely locally free modules and finite locally free ring
extensions. If $\varphi : A \to B$ is a finite locally free ring map, then
we will denote $\text{Norm}_\varphi(b) \in A$ the norm of $b \in B$.

\begin{lemma}
\label{lemma-determinant-trick}
Let $S$ be a scheme. Let $(U, R, s, t, c)$ be a groupoid scheme over $S$.
Assume $U = \text{Spec}(A)$, and $R = \text{Spec}(B)$ are affine, and
$s, t : R \to U$ finite locally free.
Let $C$ be as in (\ref{equation-invariants}).
Let $f \in A$. Then $\text{Norm}_{s^\sharp}(t^\sharp(f)) \in C$.
\end{lemma}

\begin{proof}
Consider the commutative diagram
$$
\xymatrix{
& U & \\
R \ar[d]_s \ar[ru]^t &
R \times_{s, U, t} R
\ar[l]^-{\text{pr}_0} \ar[d]^{\text{pr}_1} \ar[r]_-c &
R \ar[d]^s \ar[lu]_t \\
U & R \ar[l]_t \ar[r]^s & U
}
$$
of Lemma \ref{lemma-diagram}.
Think of $f \in \Gamma(U, \mathcal{O}_U)$. The commutativity of the
top part of the diagram shows that
$pr_0^\sharp(t^\sharp(f)) = c^\sharp(t^\sharp(f))$ as elements of
$\Gamma(R \times_{S, U, t} R, \mathcal{O})$.
Looking at the right lower cartesian square
The compatibility of the norm construction with base change shows that
$s^\sharp(\text{Norm}_{s^\sharp}(t^\sharp(f))) =
\text{Norm}_{\text{pr}_1}(c^\sharp(t^\sharp(f)))$.
Similarly we get
$t^\sharp(\text{Norm}_{s^\sharp}(t^\sharp(f))) =
\text{Norm}_{\text{pr}_1}(\text{pr}_0^\sharp(t^\sharp(f)))$.
Hence by the first equality of this proof we see that
$s^\sharp(\text{Norm}_{s^\sharp}(t^\sharp(f))) =
t^\sharp(\text{Norm}_{s^\sharp}(t^\sharp(f)))$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-finite-locally-free-disjoint-free}
Let $S$ be a scheme. Let $(U, R, s, t, c)$ be a groupoid scheme over $S$.
Assume $s, t : R \to U$ finite locally free.
Then
$$
U = \coprod\nolimits_{r \geq 1} U_r
$$
is a disjoint union of $R$-invariant opens such that the restriction $R_r$ of
$R$ to $U_r$ has the property that $s,t : R_r \to U_r$ are finite locally
free of rank $1$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-integral-over-invariants}
Let $S$ be a scheme. Let $(U, R, s, t, c)$ be a groupoid scheme over $S$.
Assume $U = \text{Spec}(A)$, and $R = \text{Spec}(B)$ are affine, and
$s, t : R \to U$ finite locally free.
Let $C \subset A$ be as in (\ref{equation-invariants}).
Then $A$ is integral over $C$.
\end{lemma}

\begin{proof}
First, by Lemma \ref{lemma-finite-locally-free-disjoint-free}
we know that $(U, R, s, t, c)$ is a disjoint union
of groupoid schemes $(U_r, R_r, s, t, c)$ such that each $s, t : R_r \to U_r$
has constant rank $r$. As $U$ is quasi-compact, we have $U_r = \empty$ for
almost all $r$. It suffices to prove the lemma for each $(U_r, R_r, s, t, c)$
and hence we may assume that $s, t$ are finite locally free of rank $r$.

\medskip\noindent
Assume that $s,t$ are finite locally free of rank $r$.
Let $f \in A$. Consider the element $x - f \in A[x]$, where we think
of $x$ as the coordinate on $\mathbf{A}^1$.
Since
$$
(U \times \mathbf{A}^1, R \times \mathbf{A}^1,
s \times \text{id}_{\mathbf{A}^1},
t \times \text{id}_{\mathbf{A}^1},
c \times \text{id}_{\mathbf{A}^1})
$$
is also a groupoid scheme with finite source and target, we may apply
Lemma \ref{lemma-determinant-trick} to it and we see that
$P(x) = \text{Norm}_{s^\sharp}(t^\sharp(x - f))$
is an element of $C[x]$. Because $s^\sharp : A \to B$ is finite locally
free of rank $r$ we see that $P$ is monic of degree $r$.
Moreover $P(f) = 0$ by Cayley-Hamilton
(Algebra, Lemma \ref{algebra-lemma-charpoly}).
\end{proof}

\begin{lemma}
\label{lemma-invariants-base-change}
Let $S$ be a scheme. Let $(U, R, s, t, c)$ be a groupoid scheme over $S$.
Assume $U = \text{Spec}(A)$, and $R = \text{Spec}(B)$ are affine, and
$s, t : R \to U$ finite locally free. Let $C \subset A$ be as in
(\ref{equation-invariants}). Let $C \to C'$ be a ring map, and set
$U' = \text{Spec}(A \otimes_C C')$,
$R' = \text{Spec}(B \otimes_C C')$.
Then
\begin{enumerate}
\item the maps $s,t,c$ induce maps $s', t', c'$ such that
$(U', R', s', t', c')$ is a groupoid scheme, and
\item there is a canonical map $\varphi : C' \to C^1$ of $C'$ into
the $R'$-invariant functions $C^1$ on $U'$ with the properties
\begin{enumerate}
\item for every $f \in C^1$ there exists an $n > 0$ such that
$f^n$ is in the image of $\varphi$, and
\item for every $f \in \text{Ker}(\varphi)$ there exists
an $n > 0$ such that $f^n = 0$.
\end{enumerate}
\item if $C \to C'$ is flat then $\varphi$ is an isomorphism.
\end{enumerate}
\end{lemma}

\begin{proof}
The proof of part (1) is omitted. Let us denote $A' = A \otimes_C C'$ and
$B' = B \otimes_C C'$. Then we have
$$
C^1
= \{x \in A' \mid (t')^\sharp(x) = (s')^\sharp(x) \}
= \{a \in A \otimes_C C' \mid t^\sharp \otimes 1(x) = s^\sharp \otimes 1(x) \}.
$$
In other words, $C^1$ is the kernel of the difference map
$(t^\sharp - s^\sharp) \otimes 1$ which is just the base change
of the $C$-linear map $t^\sharp - s^\sharp : A \to B$ by $C \to C'$.
Hence (3) follows.

\medskip\noindent
Proof of part (2)(b). Since $C \to A$ is integral
(Lemma \ref{lemma-integral-over-invariants}) and injective we see that
$\text{Spec}(A) \to \text{Spec}(C)$ is surjective, see
Algebra, Lemma \ref{algebra-lemma-integral-overring-surjective}.
Thus also $\text{Spec}(A') \to \text{Spec}(C')$ is surjective
as a base change of a surjective morphism
(Morphisms, Lemma \ref{morphisms-lemma-base-change-surjective}).
Hence $\text{Spec}(C^1) \to \text{Spec}(C')$ is surjective also.
This implies that the kernel of $\varphi$ is contained in the
radical of the ring $C'$, i.e., (2)(b) holds.

\medskip\noindent
Proof of part (2)(a). By Lemma \ref{lemma-finite-locally-free-disjoint-free}
we know that $A$ is a finite
product of rings $A_r$ and $B$ is a finite product of rings $B_r$
such that the groupoid scheme decomposes accordingly (see the proof
of Lemma \ref{lemma-integral-over-invariants}).
Then also $C$ is a product of rings $C_r$ and
correspondingly $C'$ decomposes as a product. Hence we may and do
assume that the ring maps $s^\sharp, t^\sharp : A \to B$ are finite
locally free of a fixed rank $r$. Let $f \in C^1 \subset A' = A \otimes_C C'$.
We may replace $C'$ by a finitely generated $C$-subalgebra of $C'$
and hence we may assume that $C' = C[X_1, \ldots, X_n]/I$ for some
ideal $I$. Choose a lift $\tilde f \in A \otimes_C C[X_i] = A[X_i]$
of the element $f$. Note that
$f^r = \text{Norm}_{(s')^\sharp}((t')^\sharp(f))$ in $A$ as
$t^\sharp(f) = s^\sharp(f)$. Hence we see that
$$
h = \text{Norm}_{s^\sharp \otimes 1}(t^\sharp \otimes 1(f)) \in A[X_i]
$$
is invariant according to Lemma \ref{lemma-determinant-trick}
and maps to $f^r$ in $A'$.
Since $C \to C[X_i]$ is flat we see from (3) that $h \in C[X_i]$.
Hence it follows that $f^r$ is in the image of $\varphi$.
\end{proof}

\begin{lemma}
\label{lemma-points}
Let $S$ be a scheme. Let $(U, R, s, t, c)$ be a groupoid scheme over $S$.
Assume $U = \text{Spec}(A)$, and $R = \text{Spec}(B)$ are affine, and
$s, t : R \to U$ finite locally free. Let $C \subset A$ be as in
(\ref{equation-invariants}). Then $U \to M = \text{Spec}(C)$ has
the following properties:
\begin{enumerate}
\item the map on points $|U| \to |M|$ is surjective and
$u_0, u_1 \in |U|$ map to the same point if and only if 
there exists a $r \in |R|$ with $t(r) = u_0$ and $s(r) = u_1$, in 
a formula
$$
|M| = |U|/|R|
$$
\item for any algebraically closed field $k$ we have
$$
M(k) = U(k)/R(k)
$$
\end{enumerate}
\end{lemma}

\begin{proof}
Let $k$ be an algebraically closed field.
Since $C \to A$ is integral (Lemma \ref{lemma-integral-over-invariants})
and injective we see that
$\text{Spec}(A) \to \text{Spec}(C)$ is surjective, see
Algebra, Lemma \ref{algebra-lemma-integral-overring-surjective}.
Thus $|M| \to |U|$ is surjective.
Let $C \to k$ be a ring map. Since surjective morphisms are
preserved under base change
(Morphisms, Lemma \ref{morphisms-lemma-base-change-surjective}) we see that
$A \otimes_C k$ is not zero. Now $k \subset A \otimes_C k$ is a
nonzero integral extension. Hence any residue field of $A \otimes_C k$
is an algebraic extension of $k$, hence equal to $k$. Thus we see that
$U(k) \to M(k)$ is surjective.

\medskip\noindent
Let $a_0, a_1 : A \to k$ be ring maps. If there exists a ring map
$b : B \to k$ such that $a_0 = b \circ t^\sharp$ and $a_1 = b \circ s^\sharp$
then we see that $a_0|_C = a_1|_C$ by definition.
Conversely, suppose that $a_0|_C = a_1|_C$. Let us name this algebra
map $c : C \to k$. Consider the diagram
$$
\xymatrix{
& &
B \ar@{-->}[lld] \\
k & &
A
\ar@<0.5ex>[ll]^{a_0}
\ar@<-0.5ex>[ll]_{a_1}
\ar@<1ex>[u]
\ar@<-1ex>[u] \\
& &
C \ar[u] \ar[llu]^c
}
$$
We are trying to construct the dotted arrow, and if we do then
part (2) follows, which in turn implies part (1).
Since $A \to B$ is finite and faithfully flat
there exist finitely many ring maps
$b_1, \ldots, b_n : B \to k$ such that $b_i \circ s^\sharp = a_1$.
If the dotted arrow does not exist, then we see that none of the
$a'_i = b_i \circ t^\sharp$, $i = 1, \ldots, n$ is equal to $a_0$.
Hence the maximal ideals
$$
\mathfrak m'_i = \text{Ker}(a_i' \otimes 1 : A \otimes_C k \to k)
$$
of $A \otimes_C k$ are distinct from
$\mathfrak m = \text{Ker}(a_0 \otimes 1 : A \otimes_C k \to k)$.
By Algebra, Lemma \ref{algebra-lemma-silly} we would get an element
$f \in A \otimes_C k$ with $f \in \mathfrak m$, but
$f \not \in \mathfrak m_i'$ for $i = 1, \ldots, n$.
Consider the norm
$$
g = \text{Norm}_{s^\sharp \otimes 1}(t^\sharp \otimes 1(f))
\in
A \otimes_C k
$$
By Lemma \ref{lemma-determinant-trick} this lies in the invariants
$C^1 \subset A \otimes_C k$ of the base change
groupoid (base change via the map $c : C \to k$). On the one hand,
$a_1(g) \in k^*$ since
the value of $t^\sharp(f)$ at all the points (which correspond to
$b_1, \ldots, b_n$) lying over $a_1$ is
invertible (insert future reference on property determinant here).
On the other hand, since $f \in \mathfrak m$, we see that
$f$ is not a unit, hence $t^\sharp(f)$ is not a unit
(as $t^\sharp \otimes 1$ is faithfully flat),
hence its norm is not a unit (insert future reference
on property determinant here). We conclude that $C^1$ contains
an element which is not nilpotent
and not a unit. We will now show that this leads to a contradiction.
Namely, apply Lemma \ref{lemma-invariants-base-change}
to the map $c : C \to C' = k$, then
we see that the map of $k$ into the invariants $C^1$ is injective
and moreover, that for any element $x \in C^1$ there exists an integer
$n > 0$ such that $x^n \in k$. Hence every element of $C^1$ is
either a unit or nilpotent.
\end{proof}

\begin{proposition}
\label{proposition-finite-flat-equivalence}
Let $S$ be a scheme.
Let $(U, R, s, t, c)$ be a groupoid scheme over $S$.
Assume
\begin{enumerate}
\item $U = \text{Spec}(A)$, and $R = \text{Spec}(B)$ are affine,
\item $s, t : R \to U$ finite locally free, and
\item $j = (t, s)$ is an equivalence.
\end{enumerate}
In this case, let $C \subset A$ be as in
(\ref{equation-invariants}). Then $U \to M = \text{Spec}(C)$
is finite locally free and $R = U \times_M U$.
Moreover, $M$ represents the quotient sheaf $U/R$
in the fppf topology (see Definition \ref{definition-quotient-sheaf}).
\end{proposition}

\begin{proof}
We have to show that $C \to A$ is finite locally free and that
the map
$$
t \otimes s : A \otimes_C A \longrightarrow B
$$
is an isomorphism. First, note that $j$ is a monomorphism, and
also finite (since already $s$ and $t$ are finite). Hence we see
that $j$ is a closed immersion by
Morphisms, Lemma \ref{morphisms-lemma-finite-monomorphism-closed}.
Hence $A \otimes_C A \to B$ is surjective.

\medskip\noindent
To show that it is injective we may localize on $C$, since formation
of invariants commutes with flat base change, see
Lemma \ref{lemma-invariants-base-change} (3). Thus we may assume
that $C$ is a local ring. To be continued.
\end{proof}















\input{chapters}

\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}
