\input{preamble}

% OK, start here.
%
\begin{document}

\title{Divisors on Algebraic Spaces}


\maketitle

\phantomsection
\label{section-phantom}

\tableofcontents

\section{Introduction}
\label{section-introduction}

\noindent
In this chapter we study divisors on algebraic spaces and related topics.
A basic reference for algebraic spaces is \cite{Kn}.




\section{Effective Cartier divisors}
\label{section-effective-Cartier-divisors}

\noindent
For some reason it seem convenient to define the notion of an effective
Cartier divisor before anything else. Note that in
Morphisms of Spaces, Section \ref{spaces-morphisms-section-closed-immersions}
we discussed the correspondence between closed subspaces and quasi-coherent
sheaves of ideals. Moreover, in
Properties of Spaces, Section
\ref{spaces-properties-section-properties-modules}, we discussed properties
of quasi-coherent modules, in particular ``locally generated by $1$ element''.
These references show that the following definition is
compatible with the definition for schemes.

\begin{definition}
\label{definition-effective-Cartier-divisor}
Let $S$ be a scheme. Let $X$ be an algebraic space over $S$.
\begin{enumerate}
\item A {\it locally principal closed subspace} of $X$ is a closed subspace
whose sheaf of ideals is locally generated by $1$ element.
\item An {\it effective Cartier divisor} on $X$ is a closed subspace
$D \subset X$ such that the ideal sheaf $\mathcal{I}_D \subset \mathcal{O}_X$
is an invertible $\mathcal{O}_X$-module.
\end{enumerate}
\end{definition}

\noindent
Thus an effective Cartier divisor is a locally principal closed subspace,
but the converse is not always true. Effective Cartier divisors are closed
subspaces of pure codimension $1$ in the strongest possible sense. Namely
they are locally cut out by a single element which is not a zerodivisor.
In particular they are nowhere dense.

\begin{lemma}
\label{lemma-characterize-effective-Cartier-divisor}
Let $S$ be a scheme. Let $X$ be an algebraic space over $S$.
Let $D \subset X$ be a closed subspace.
The following are equivalent:
\begin{enumerate}
\item The subspace $D$ is an effective Cartier divisor on $X$.
\item For some scheme $U$ and surjective \'etale morphism $U \to X$
the inverse image $D \times_X U$ is an effective Cartier divisor on $U$.
\item For every scheme $U$ and every \'etale morphism $U \to X$
the inverse image $D \times_X U$ is an effective Cartier divisor on $U$.
\item For every $x \in |D|$ there exists an \'etale morphism
$(U, u) \to (X, x)$ of pointed algebraic spaces such that $U = \Spec(A)$
and $D \times_X U = \Spec(A/(f))$ with $f \in A$ not a zerodivisor.
\end{enumerate}
\end{lemma}

\begin{proof}
The equivalence of (1) -- (3) follows from
Definition \ref{definition-effective-Cartier-divisor}
and the references preceding it.
Assume (1) and let $x \in |D|$. Choose a scheme $W$ and a
surjective \'etale morphism
$W \to X$. Choose $w \in D \times_X W$ mapping to $x$.
By (3) $D \times_X W$ is an effective Cartier
divisor on $W$. Hence we can find affine \'etale neighbourhood $U$
by choosing an affine open neighbourhood of $w$ in $W$ as in
Divisors, Lemma \ref{divisors-lemma-characterize-effective-Cartier-divisor}.

\medskip\noindent
Assume (2). Then we see that $\mathcal{I}_D|_U$ is invertible by
Divisors, Lemma \ref{divisors-lemma-characterize-effective-Cartier-divisor}.
Since we can find an \'etale covering of $X$ by the collection of
all such $U$ and $X \setminus D$, we conclude that
$\mathcal{I}_D$ is an invertible $\mathcal{O}_X$-module.
\end{proof}

\begin{lemma}
\label{lemma-complement-locally-principal-closed-subscheme}
Let $S$ be a scheme. Let $X$ be an algebraic space over $S$.
Let $Z \subset X$ be a locally principal closed
subspace. Let $U = X \setminus Z$. Then $U \to X$ is an affine morphism.
\end{lemma}

\begin{proof}
The question is \'etale local on $X$, see
Morphisms of Spaces, Lemmas \ref{spaces-morphisms-lemma-affine-local}
and
Lemma \ref{lemma-characterize-effective-Cartier-divisor}.
Thus this follows from the case of schemes which is
Divisors, Lemma
\ref{divisors-lemma-complement-locally-principal-closed-subscheme}.
\end{proof}

\begin{lemma}
\label{lemma-complement-effective-Cartier-divisor}
Let $S$ be a scheme. Let $X$ be an algebraic space over $S$.
Let $D \subset X$ be an effective Cartier divisor.
Let $U = X \setminus D$. Then $U \to X$ is an affine morphism and $U$
is scheme theoretically dense in $X$.
\end{lemma}

\begin{proof}
Affineness is Lemma \ref{lemma-complement-locally-principal-closed-subscheme}.
The density question is \'etale local on $X$ by
Morphisms of Spaces, Definition
\ref{spaces-morphisms-definition-scheme-theoretically-dense}.
Thus this follows from the case of schemes which is
Divisors, Lemma
\ref{divisors-lemma-complement-effective-Cartier-divisor}.
\end{proof}

\begin{lemma}
\label{lemma-effective-Cartier-makes-dimension-drop}
Let $S$ be a scheme. Let $X$ be an algebraic space over $S$.
Let $D \subset X$ be an effective Cartier divisor.
Let $x \in |D|$.
If $\dim_x(X) < \infty$, then $\dim_x(D) < \dim_x(X)$.
\end{lemma}

\begin{proof}
Both the definition of an effective Cartier divisor and of the
dimension of an an algebraic space at a point
(Properties of Spaces, Definition
\ref{spaces-properties-definition-dimension-at-point})
are \'etale local. Hence this lemma follws from the case of schemes
which is
Divisors, Lemma \ref{divisors-lemma-effective-Cartier-makes-dimension-drop}.
\end{proof}

\begin{definition}
\label{definition-sum-effective-Cartier-divisors}
Let $S$ be a scheme. Let $X$ be an algebraic space over $S$.
Given effective Cartier divisors
$D_1$, $D_2$ on $X$ we set $D = D_1 + D_2$ equal to the
closed subspace of $X$ corresponding to the quasi-coherent
sheaf of ideals
$\mathcal{I}_{D_1}\mathcal{I}_{D_2} \subset \mathcal{O}_S$.
We call this the {\it sum of the effective Cartier divisors
$D_1$ and $D_2$}.
\end{definition}

\noindent
It is clear that we may define the sum $\sum n_iD_i$ given
finitely many effective Cartier divisors $D_i$ on $X$
and nonnegative integers $n_i$.

\begin{lemma}
\label{lemma-sum-effective-Cartier-divisors}
The sum of two effective Cartier divisors is an effective
Cartier divisor.
\end{lemma}

\begin{proof}
Omitted. \'Etale locally this reduces to the following simple
algebra fact: if $f_1, f_2 \in A$ are nonzerodivisors of a ring $A$, then
$f_1f_2 \in A$ is a nonzerodivisor.
\end{proof}

\begin{lemma}
\label{lemma-sum-closed-subschemes-effective-Cartier}
Let $S$ be a scheme. Let $X$ be an algebraic space over $S$.
Let $Z, Y$ be two closed subspaces of $X$
with ideal sheaves $\mathcal{I}$ and $\mathcal{J}$. If $\mathcal{I}\mathcal{J}$
defines an effective Cartier divisor $D \subset X$, then $Z$ and $Y$
are effective Cartier divisors and $D = Z + Y$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-characterize-effective-Cartier-divisor}
this reduces to the case of schemes which is
Divisors, Lemma \ref{divisors-lemma-sum-closed-subschemes-effective-Cartier}.
\end{proof}

\noindent
Recall that we have defined the inverse image of a closed subspace
under any morphism of algebraic spaces in
Morphisms of Spaces, Definition
\ref{spaces-morphisms-definition-inverse-image-closed-subspace}.

\begin{lemma}
\label{lemma-pullback-locally-principal}
Let $S$ be a scheme.
Let $f : X' \to X$ be a morphism of algebraic spaces over $S$.
Let $Z \subset X$ be a locally principal closed subspace.
Then the inverse image $f^{-1}(Z)$ is a locally principal closed
subspace of $X'$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{definition}
\label{definition-pullback-effective-Cartier-divisor}
Let $S$ be a scheme.
Let $f : X' \to X$ be a morphism of algebraic spaces over $S$.
Let $D \subset X$
be an effective Cartier divisor. We say the {\it pullback of
$D$ by $f$ is defined} if the closed subspace $f^{-1}(D) \subset X'$
is an effective Cartier divisor. In this case we denote it either
$f^*D$ or $f^{-1}(D)$ and we call it the
{\it pullback of the effective Cartier divisor}.
\end{definition}

\noindent
The condition that $f^{-1}(D)$ is an effective Cartier divisor
is often satisfied in practice.

\begin{lemma}
\label{lemma-pullback-effective-Cartier-defined}
Let $S$ be a scheme.
Let $f : X \to Y$ be a morphism of algebraic spaces over $S$.
Let $D \subset Y$ be an effective Cartier divisor.
The pullback of $D$ by $f$ is defined in each of the following cases:
\begin{enumerate}
\item $f$ is flat, and
\item add more here as needed.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-pullback-effective-Cartier-divisors-additive}
Let $S$ be a scheme.
Let $f : X' \to X$ be a morphism of algebraic spaces over $S$.
Let $D_1$, $D_2$ be effective Cartier divisors on $X$.
If the pullbacks of $D_1$ and $D_2$ are defined then the
pullback of $D = D_1 + D_2$ is defined and
$f^*D = f^*D_1 + f^*D_2$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{definition}
\label{definition-invertible-sheaf-effective-Cartier-divisor}
Let $S$ be a scheme. Let $X$ be an algebraic space over $S$
and let $D \subset X$ be an effective Cartier divisor.
The {\it invertible sheaf $\mathcal{O}_X(D)$ associated to $D$}
is given by
$$
\mathcal{O}_X(D) :=
\SheafHom_{\mathcal{O}_X}(\mathcal{I}_D, \mathcal{O}_X) =
\mathcal{I}_D^{\otimes -1}.
$$
The canonical section, usually denoted $1$ or $1_D$, is the
global section of $\mathcal{O}_X(D)$ corresponding to
the inclusion mapping $\mathcal{I}_D \to \mathcal{O}_X$.
\end{definition}

\begin{lemma}
\label{lemma-invertible-sheaf-sum-effective-Cartier-divisors}
Let $S$ be a scheme. Let $X$ be an algebraic space over $S$.
Let $D_1$, $D_2$ be effective Cartier divisors on $X$.
Let $D = D_1 + D_2$.
Then there is a unique isomorphism
$$
\mathcal{O}_X(D_1) \otimes_{\mathcal{O}_X} \mathcal{O}_X(D_2)
\longrightarrow
\mathcal{O}_X(D)
$$
which maps $1_{D_1} \otimes 1_{D_2}$ to $1_D$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{definition}
\label{definition-regular-section}
Let $S$ be a scheme. Let $X$ be an algebraic space over $S$.
Let $\mathcal{L}$ be an invertible sheaf on $X$.
A global section $s \in \Gamma(X, \mathcal{L})$ is called a
{\it regular section} if the map $\mathcal{O}_X \to \mathcal{L}$,
$f \mapsto fs$ is injective.
\end{definition}

\begin{lemma}
\label{lemma-regular-section-structure-sheaf}
Let $S$ be a scheme.
Let $X$ be an algebraic space over $S$.
Let $f \in \Gamma(X, \mathcal{O}_X)$.
The following are equivalent:
\begin{enumerate}
\item $f$ is a regular section, and
\item for any $x \in X$ the image $f \in \mathcal{O}_{X, \overline{x}}$
is not a zerodivisor.
\item for any affine $U = \Spec(A)$ \'etale over $X$
the restriction $f|_U$ is a nonzerodivisor of $A$, and
\item there exists a scheme $U$ and a surjective \'etale morphism
$U \to X$ such that $f|_U$ is a regular section of $\mathcal{O}_U$.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\noindent
Note that a global section $s$ of an invertible $\mathcal{O}_X$-module
$\mathcal{L}$ may be seen as an $\mathcal{O}_X$-module map
$s : \mathcal{O}_X \to \mathcal{L}$. Its dual is therefore a
map $s : \mathcal{L}^{\otimes -1} \to \mathcal{O}_X$.
(See Modules on Sites, Lemma \ref{sites-modules-lemma-constructions-invertible}
for the the dual invertible sheaf.)

\begin{definition}
\label{definition-zero-scheme-s}
Let $S$ be a scheme. Let $X$ be an algebraic space over $S$.
Let $\mathcal{L}$ be an invertible sheaf.
Let $s \in \Gamma(X, \mathcal{L})$.
The {\it zero scheme} of $s$ is the closed subspace $Z(s) \subset X$
defined by the quasi-coherent sheaf of ideals
$\mathcal{I} \subset \mathcal{O}_X$ which is the image of the
map $s : \mathcal{L}^{\otimes -1} \to \mathcal{O}_X$.
\end{definition}

\begin{lemma}
\label{lemma-zero-scheme}
Let $S$ be a scheme. Let $X$ be an algebraic space over $S$.
Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module.
Let $s \in \Gamma(X, \mathcal{L})$.
\begin{enumerate}
\item Consider closed immersions $i : Z \to X$ such that
$i^*s \in \Gamma(Z, i^*\mathcal{L}))$ is zero
ordered by inclusion. The zero scheme $Z(s)$ is the
maximal element of this ordered set.
\item For any morphism of algebraic spaces $f : Y \to X$ over $S$
we have $f^*s = 0$ in $\Gamma(Y, f^*\mathcal{L})$ if and only if
$f$ factors through $Z(s)$.
\item The zero scheme $Z(s)$ is a locally principal closed subspace of $X$.
\item The zero scheme $Z(s)$ is an effective Cartier divisor on $X$
if and only if $s$ is a regular section of $\mathcal{L}$.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-characterize-OD}
Let $S$ be a scheme. Let $X$ be an algebraic space over $S$.
\begin{enumerate}
\item If $D \subset X$ is an effective Cartier divisor, then
the canonical section $1_D$ of $\mathcal{O}_X(D)$ is regular.
\item Conversely, if $s$ is a regular section of the invertible
sheaf $\mathcal{L}$, then there exists a unique effective
Cartier divisor $D = Z(s) \subset X$ and a unique isomorphism
$\mathcal{O}_X(D) \to \mathcal{L}$ which maps $1_D$ to $s$.
\end{enumerate}
The constructions
$D \mapsto (\mathcal{O}_X(D), 1_D)$ and $(\mathcal{L}, s) \mapsto Z(s)$
give mutually inverse maps
$$
\left\{
\begin{matrix}
\text{effective Cartier divisors on }X
\end{matrix}
\right\}
\leftrightarrow
\left\{
\begin{matrix}
\text{pairs }(\mathcal{L}, s)\text{ consisting of an invertible}\\
\mathcal{O}_X\text{-module and a regular global section}
\end{matrix}
\right\}
$$
\end{lemma}

\begin{proof}
Omitted.
\end{proof}










\section{Relative Proj}
\label{section-relative-proj}

\noindent
This section revisits the construction of the relative proj
in the setting of algebraic spaces. The material in this section
corresponds to the material in Constructions, Section
\ref{constructions-section-relative-proj}
and Divisors, Section \ref{divisors-section-relative-proj}
in the case of schemes.

\begin{situation}
\label{situation-relative-proj}
Here $S$ is a scheme, $X$ is an algebraic space over $S$, and
$\mathcal{A}$ is a quasi-coherent graded $\mathcal{O}_X$-algebra.
\end{situation}

\noindent
In Situation \ref{situation-relative-proj} we are going to define
a functor $F : (\Sch/S)_{fppf}^{opp} \to \textit{Sets}$ which will
turn out to be an algebraic space. We will follow (mutatis mutandis)
the procedure of
Constructions, Section \ref{constructions-section-relative-proj}.
First, given a scheme $T$ over $S$ we define a
{\it quadruple over $T$} to be a system
$(d, f : T \to S, \mathcal{L}, \psi)$
\begin{enumerate}
\item $d \geq 1$ is an integer,
\item $f : T \to X$ is a morphism over $S$,
\item $\mathcal{L}$ is an invertible $\mathcal{O}_T$-module, and
\item
$\psi : f^*\mathcal{A}^{(d)} \to \bigoplus_{n \geq 0}\mathcal{L}^{\otimes n}$
is a homomorphism of graded $\mathcal{O}_T$-algebras
such that $f^*\mathcal{A}_d \to \mathcal{L}$ is surjective.
\end{enumerate}
We say two quadruples $(d, f, \mathcal{L}, \psi)$ and
$(d', f', \mathcal{L}', \psi')$ are {\it equivalent}\footnote{This
definition is motivated by
Constructions, Lemma \ref{constructions-lemma-equivalent-relative}.
The advantage of choosing this one is that it clearly defines
an equivalence relation.}
if and only if
we have $f = f'$ and for some positive integer $m = ad = a'd'$
there exists an isomorphism
$\beta : \mathcal{L}^{\otimes a} \to (\mathcal{L}')^{\otimes a'}$
with the property that $\beta \circ \psi|_{f^*\mathcal{A}^{(m)}}$
and $\psi'|_{f^*\mathcal{A}^{(m)}}$ agree
as graded ring maps
$f^*\mathcal{A}^{(m)} \to \bigoplus_{n \geq 0} (\mathcal{L}')^{\otimes mn}$.
Given a quadruple $(d, f, \mathcal{L}, \psi)$
and a morphism $h : T' \to T$ we have the pullback
$(d, f \circ h, h^*\mathcal{L}, h^*\psi)$. Pullback preserves 
the equivalence relation. Finally, for a {\it quasi-compact} scheme $T$
over $S$ we set
$$
F(T) = \text{the set of equivalence classes of quadruples over }T
$$
and for an arbirary scheme $T$ over $S$ we set
$$
F(T)
=
\lim_{V \subset T\text{ quasi-compact open}} F(V).
$$
In other words, an element $\xi$ of $F(T)$ corresponds to a compatible
system of choices of elements $\xi_V \in F(V)$ where $V$ ranges over the
quasi-compact opens of $T$. Thus we have defined our functor
\begin{equation}
\label{equation-proj}
F : \Sch^{opp} \longrightarrow \textit{Sets}
\end{equation}
There is a morphism $F \to X$ of functors sending the quadruple
$(d, f, \mathcal{L}, \psi)$ to $f$.

\begin{lemma}
\label{lemma-relative-proj}
In Situation \ref{situation-relative-proj}. The functor $F$ above is an
algebraic space. For any morphism $g : Z \to X$ where $Z$ is a scheme
there is a canonical isomorphism
$\underline{\text{Proj}}_Z(g^*\mathcal{A}) = Z \times_X F$
compatible with further base change.
\end{lemma}

\begin{proof}
It suffices to prove the second assertion, see
Spaces, Lemma \ref{spaces-lemma-representable-over-space}.
Let $g : Z \to X$ be a morphism where $Z$ is a scheme.
Let $F'$ be the functor of quadruples associated
to the graded quasi-coherent $\mathcal{O}_Z$-algebra $g^*\mathcal{A}$.
Then there is a canonical isomorphism $F' = Z \times_X F$, sending
a quadruple $(d, f : T \to Z, \mathcal{L}, \psi)$ for $F'$
to $(d, g \circ f, \mathcal{L}, \psi)$ (details omitted, see proof of
Constructions, Lemma \ref{constructions-lemma-proj-base-change}).
By Constructions, Lemmas
\ref{constructions-lemma-equivalent-relative},
\ref{constructions-lemma-relative-proj}, and
\ref{constructions-lemma-glueing-gives-functor-proj} and
Definition \ref{constructions-definition-relative-proj}
we see that $F'$ is representable by
$\underline{\text{Proj}}_Z(g^*\mathcal{A})$.
\end{proof}

\noindent
The lemma above tells us the following definition makes sense.

\begin{definition}
\label{definition-relative-proj}
Let $S$ be a scheme. Let $X$ be an algebraic space over $S$.
Let $\mathcal{A}$ be a quasi-coherent sheaf of
graded $\mathcal{O}_X$-algebras. The
{\it relative homogeneous spectrum of $\mathcal{A}$ over $X$},
or the {\it homogeneous spectrum of $\mathcal{A}$ over $X$}, or the
{\it relative Proj of $\mathcal{A}$ over $X$} is the algebraic space
$F$ over $X$ of Lemma \ref{lemma-relative-proj}.
We denote it $\pi : \underline{\text{Proj}}_X(\mathcal{A}) \to X$.
\end{definition}

\noindent
In particular the structure morphism of the relative Proj is representable
by construction. We can also think about the relative Proj via glueing. Let
$\varphi : U \to X$ be a surjective \'etale morphism, where $U$ is a scheme.
Set $R = U \times_X U$ with projection morphisms $s, t : R  \to U$.
By Lemma \ref{lemma-relative-proj} there exists a canonical isomorphism
$$
\gamma : 
\underline{\text{Proj}}_U(\varphi^*\mathcal{A})
\longrightarrow
\underline{\text{Proj}}_X(\mathcal{A}) \times_X U
$$
over $U$. Let $\alpha : t^*\varphi^*\mathcal{A} \to s^*\varphi^*\mathcal{A}$
be the canonical isomorphism of
Properties of Spaces, Proposition
\ref{spaces-properties-proposition-quasi-coherent}.
Then the diagram
$$
\xymatrix{
&
\underline{\text{Proj}}_U(\varphi^*\mathcal{A}) \times_{U, s} R
\ar@{=}[r] &
\underline{\text{Proj}}_R(s^*\varphi^*\mathcal{A})
\ar[dd]_{\text{induced by }\alpha} \\
\underline{\text{Proj}}_X(\mathcal{A}) \times_X R
\ar[ru]_{s^*\gamma} \ar[rd]^{t^*\gamma} \\
&
\underline{\text{Proj}}_U(\varphi^*\mathcal{A}) \times_{U, t} R
\ar@{=}[r] &
\underline{\text{Proj}}_R(t^*\varphi^*\mathcal{A})
}
$$
is commutative (the equal signs come from
Constructions, Lemma \ref{constructions-lemma-relative-proj-base-change}).
Thus, if we denote $\mathcal{A}_U$, $\mathcal{A}_R$
the pullback of $\mathcal{A}$ to $U$, $R$, then
$P = \underline{\text{Proj}}_X(\mathcal{A})$ has an \'etale covering
by the scheme $P_U = \underline{\text{Proj}}_U(\mathcal{A}_U)$ and
$P_U \times_P P_U$ is equal to
$P_R = \underline{\text{Proj}}_R(\mathcal{A}_R)$.
Using these remarks we can argue in the usual fashion using \'etale
localization to transfer results on the relative proj from the case
of schemes to the case of algebraic spaces.

\begin{lemma}
\label{lemma-twists-of-structure-sheaf}
In Situation \ref{situation-relative-proj}. The relative Proj comes
equipped with a quasi-coherent sheaf of $\mathbf{Z}$-graded algebras
$\bigoplus_{n \in \mathbf{Z}}
\mathcal{O}_{\underline{\text{Proj}}_X(\mathcal{A})}(n)$
and a canonical homomorphism of graded algebras
$$
\psi :
\pi^*\mathcal{A}
\longrightarrow
\bigoplus\nolimits_{n \geq 0}
\mathcal{O}_{\underline{\text{Proj}}_X(\mathcal{A})}(n)
$$
whose base change to any scheme over $X$ agrees with
Constructions, Lemma \ref{constructions-lemma-glue-relative-proj-twists}.
\end{lemma}

\begin{proof}
As in the discussion following Definition \ref{definition-relative-proj}
choose a scheme $U$ and a surjective \'etale morphism
$U \to X$, set $R = U \times_X U$ with projections $s, t : R \to U$,
$\mathcal{A}_U = \mathcal{A}|_U$, $\mathcal{A}_R = \mathcal{A}|_R$,
and $\pi : P = \underline{\text{Proj}}_X(\mathcal{A}) \to X$,
$\pi_U : P_U = \underline{\text{Proj}}_U(\mathcal{A}_U)$ and
$\pi_R : P_R = \underline{\text{Proj}}_U(\mathcal{A}_R)$.
By the
Constructions, Lemma \ref{constructions-lemma-glue-relative-proj-twists}
we have a quasi-coherent sheaf of $\mathbf{Z}$-graded
$\mathcal{O}_{P_U}$-algebras
$\bigoplus_{n \in \mathbf{Z}} \mathcal{O}_{P_U}(n)$
and a canonical map
$\psi_U : \pi_U^*\mathcal{A}_U \to \bigoplus_{n \geq 0} \mathcal{O}_{P_U}(n)$
and similarly for $P_R$. By
Constructions, Lemma \ref{constructions-lemma-relative-proj-base-change}
the pullback of $\mathcal{O}_{P_U}(n)$ and $\psi_U$ by either projection
$P_R \to P_U$ is eqal to $\mathcal{O}_{P_R}(n)$ and $\psi_R$.
By Properties of Spaces, Proposition
\ref{spaces-properties-proposition-quasi-coherent}
we obtain $\mathcal{O}_{P}(n)$ and $\psi$.
We omit the verification of compatibility with pullback to
arbitrary schemes over $X$.
\end{proof}

\noindent
Having constructed the relative Proj we turn to some basic
properties.

\begin{lemma}
\label{lemma-relative-proj-base-change}
Let $S$ be a scheme. Let $g : X' \to X$ be a morphism of algebraic spaces
over $S$ and let $\mathcal{A}$ be a quasi-coherent sheaf
of graded $\mathcal{O}_X$-algebras. Then there is a canonical isomorphism
$$
r :
\underline{\text{Proj}}_{X'}(g^*\mathcal{A})
\longrightarrow
X' \times_X \underline{\text{Proj}}_X(\mathcal{A})
$$
as well as a corresponding isomorphism
$$
\theta :
r^*\text{pr}_2^*\left(\bigoplus\nolimits_{d \in \mathbf{Z}}
\mathcal{O}_{\underline{\text{Proj}}_X(\mathcal{A})}(d)\right)
\longrightarrow
\bigoplus\nolimits_{d \in \mathbf{Z}}
\mathcal{O}_{\underline{\text{Proj}}_{X'}(g^*\mathcal{A})}(d)
$$
of $\mathbf{Z}$-graded
$\mathcal{O}_{\underline{\text{Proj}}_{X'}(g^*\mathcal{A})}$-algebras.
\end{lemma}

\begin{proof}
Let $F$ be the functor (\ref{equation-proj}) and let $F'$ be the
corresponding functor defined using $g^*\mathcal{A}$ on $X'$.
We claim there is a canonical isomorphism $r : F' \to X' \times_X F$
of functors (and of course $r$ is the isomorphism of the lemma).
It suffices to construct the bijection
$r : F'(T) \to X'(T) \times_{X(T)} F(T)$ for quasi-compact schemes $T$
over $S$. First, if $\xi = (d', f', \mathcal{L}', \psi')$ is a
quadruple over $T$ for $F'$, then we can set
$r(\xi) = (f', (d', g \circ f', \mathcal{L}', \psi'))$. This makes sense
as $(g \circ f')^*\mathcal{A}^{(d)} = (f')^*(g^*\mathcal{A})^{(d)}$.
The inverse map sends the pair $(f', (d, f, \mathcal{L}, \psi))$
to the quadruple $(d, f', \mathcal{L}, \psi)$. We omit the proof
of the final assertion (hint: reduce to the case of schemes by \'etale
localization and apply Constructions, Lemma
\ref{constructions-lemma-relative-proj-base-change}).
\end{proof}

\begin{lemma}
\label{lemma-relative-proj-separated}
In Situation \ref{situation-relative-proj} the morphism
$\pi : \underline{\text{Proj}}_X(\mathcal{A}) \to X$
is separated.
\end{lemma}

\begin{proof}
By Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-separated-local}
and the construction of the relative Proj this follows from the
case of schemes which is
Constructions, Lemma \ref{constructions-lemma-relative-proj-separated}.
\end{proof}

\begin{lemma}
\label{lemma-relative-proj-quasi-compact}
In Situation \ref{situation-relative-proj}. If one of the following holds
\begin{enumerate}
\item $\mathcal{A}$ is of finite type as a sheaf of
$\mathcal{A}_0$-algebras,
\item $\mathcal{A}$ is generated by $\mathcal{A}_1$ as an
$\mathcal{A}_0$-algebra and $\mathcal{A}_1$ is a finite type
$\mathcal{A}_0$-module,
\item there exists a finite type quasi-coherent $\mathcal{A}_0$-submodule
$\mathcal{F} \subset \mathcal{A}_{+}$ such that
$\mathcal{A}_{+}/\mathcal{F}\mathcal{A}$ is a locally nilpotent
sheaf of ideals of $\mathcal{A}/\mathcal{F}\mathcal{A}$,
\end{enumerate}
then $\pi : \underline{\text{Proj}}_X(\mathcal{A}) \to X$ is quasi-compact.
\end{lemma}

\begin{proof}
By Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-quasi-compact-local}
and the construction of the relative Proj this follows from the
case of schemes which is
Divisors, Lemma \ref{divisors-lemma-relative-proj-quasi-compact}.
\end{proof}

\begin{lemma}
\label{lemma-relative-proj-finite-type}
In Situation \ref{situation-relative-proj}.
If $\mathcal{A}$ is of finite type as a sheaf of
$\mathcal{O}_X$-algebras, then
$\pi : \underline{\text{Proj}}_X(\mathcal{A}) \to X$ is of finite type.
\end{lemma}

\begin{proof}
By Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-finite-type-local}
and the construction of the relative Proj this follows from the
case of schemes which is
Divisors, Lemma \ref{divisors-lemma-relative-proj-finite-type}.
\end{proof}

\begin{lemma}
\label{lemma-relative-proj-universally-closed}
In Situation \ref{situation-relative-proj}. If
$\mathcal{O}_X \to \mathcal{A}_0$
is an integral algebra map\footnote{In other words, the integral
closure of $\mathcal{O}_X$ in $\mathcal{A}_0$, see
Morphisms of Spaces, Definition
\ref{spaces-morphisms-definition-integral-closure}, equals
$\mathcal{A}_0$.} and $\mathcal{A}$ is of finite type as an
$\mathcal{A}_0$-algebra, then
$\pi : \underline{\text{Proj}}_X(\mathcal{A}) \to X$ is universally closed.
\end{lemma}

\begin{proof}
By Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-universally-closed-local}
and the construction of the relative Proj this follows from the
case of schemes which is
Divisors, Lemma \ref{divisors-lemma-relative-proj-universally-closed}.
\end{proof}

\begin{lemma}
\label{lemma-relative-proj-proper}
In Situation \ref{situation-relative-proj}.
The following conditions are equivalent
\begin{enumerate}
\item $\mathcal{A}_0$ is a finite type $\mathcal{O}_X$-module
and $\mathcal{A}$ is of finite type as an $\mathcal{A}_0$-algebra,
\item $\mathcal{A}_0$ is a finite type $\mathcal{O}_X$-module 
and $\mathcal{A}$ is of finite type as an $\mathcal{O}_X$-algebra.
\end{enumerate}
If these conditions hold, then
$\pi : \underline{\text{Proj}}_X(\mathcal{A}) \to X$
is proper.
\end{lemma}

\begin{proof}
By Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-proper-local}
and the construction of the relative Proj this follows from the
case of schemes which is
Divisors, Lemma \ref{divisors-lemma-relative-proj-universally-closed}.
\end{proof}

\begin{lemma}
\label{lemma-relative-proj-generated-in-degree-1}
Let $S$ be a scheme. Let $X$ be an algebraic space over $S$.
Let $\mathcal{A}$ be a quasi-coherent sheaf of graded $\mathcal{O}_X$-modules
generated as an $\mathcal{A}_0$-algebra by $\mathcal{A}_1$.
With $P = \underline{\text{Proj}}_X(\mathcal{A})$ we have
\begin{enumerate}
\item $P$ represents the functor $F_1$ which associates to
$T$ over $S$ the set of isomorphism classes of
triples $(f, \mathcal{L}, \psi)$, where $f : T \to X$ is a morphism
over $S$, $\mathcal{L}$ is an invertible $\mathcal{O}_T$-module, and
$\psi : f^*\mathcal{A} \to \bigoplus_{n \geq 0} \mathcal{L}^{\otimes n}$
is a map of graded $\mathcal{O}_T$-algebras inducing a surjection
$f^*\mathcal{A}_1 \to \mathcal{L}$,
\item the canonical map $\pi^*\mathcal{A}_1 \to \mathcal{O}_P(1)$ is
surjective, and
\item each $\mathcal{O}_P(n)$ is invertible
and the multiplication maps induce isomorphsms
$\mathcal{O}_P(n) \otimes_{\mathcal{O}_P} \mathcal{O}_P(m) =
\mathcal{O}_P(n + m)$.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted.
See Constructions, Lemma \ref{constructions-lemma-apply-relative}
for the case of schemes.
\end{proof}






\section{Blowing up}
\label{section-blowing-up}

\noindent
Blowing up is an important tool in algebraic geometry.

\begin{definition}
\label{definition-blow-up}
Let $S$ be a scheme. Let $X$ be an algebraic space over $S$.
Let $\mathcal{I} \subset \mathcal{O}_X$ be a quasi-coherent sheaf
of ideals, and let $Z \subset X$ be the closed subscheme corresponding
to $\mathcal{I}$
(Morphisms of Spaces, Lemma
\ref{spaces-morphisms-lemma-closed-immersion-ideals}).
The {\it blowing up of $X$ along $Z$}, or the
{\it blowing up of $X$ in the ideal sheaf $\mathcal{I}$} is
the morphism
$$
b :
\underline{\text{Proj}}_X
\left(\bigoplus\nolimits_{n \geq 0} \mathcal{I}^n\right)
\longrightarrow
X
$$
The {\it exceptional divisor} of the blow up is the inverse image
$b^{-1}(Z)$. Sometimes $Z$ is called the {\it center} of the blowup.
\end{definition}

\noindent
We will see later that the exceptional divisor is an effective Cartier
divisor. Moreover, the blowing up is characterized as the ``smallest''
algebraic space over $X$ such that the inverse image of $Z$ is an
effective Cartier divisor.

\medskip\noindent
If $b : X' \to X$ is the blow up of $X$ in $Z$, then we often denote
$\mathcal{O}_{X'}(n)$ the twists of the structure sheaf. Note that these
are invertible $\mathcal{O}_{X'}$-modules and that
$\mathcal{O}_{X'}(n) = \mathcal{O}_{X'}(1)^{\otimes n}$
because $X'$ is the relative Proj of a quasi-coherent graded
$\mathcal{O}_X$-algebra which is generated in degree $1$, see
Lemma \ref{lemma-relative-proj-generated-in-degree-1}.

\begin{lemma}
\label{lemma-blowing-up-affine}
Let $S$ be a scheme. Let $X$ be an algebraic space over $S$.
Let $\mathcal{I} \subset \mathcal{O}_X$ be a
quasi-coherent sheaf of ideals. Let $U = \Spec(A)$ be an affine scheme
\'etale over $X$ and let $I \subset A$ be the ideal corresponding to
$\mathcal{I}|_U$. If $X' \to X$ is the blow up of $X$ in $\mathcal{I}$,
then there is a canonical isomorphism
$$
U \times_X X' = \text{Proj}(\bigoplus\nolimits_{d \geq 0} I^d)
$$
of schemes over $U$, where the right hand side is
the homogeneous spectrum of the Rees algebra of $I$ in $A$.
Moreover, $U \times_X X'$ has an affine open covering by
spectra of the affine blowup algebras $A[\frac{I}{a}]$.
\end{lemma}

\begin{proof}
Note that the restriction $\mathcal{I}|_U$ is equal to the pullback
of $\mathcal{I}$ via the morphism $U \to X$, see
Properties of Spaces, Section \ref{spaces-properties-section-modules}.
Thus the lemma follows on combining Lemma \ref{lemma-relative-proj} with
Divisors, Lemma \ref{divisors-lemma-blowing-up-affine}.
\end{proof}

\begin{lemma}
\label{lemma-flat-base-change-blowing-up}
Let $S$ be a scheme.
Let $X_1 \to X_2$ be a flat morphism of algebraic spaces over $S$.
Let $Z_2 \subset X_2$ be a closed subspace.
Let $Z_1$ be the inverse image of $Z_2$ in $X_1$.
Let $X'_i$ be the blow up of $Z_i$ in $X_i$. Then there exists a cartesian
diagram
$$
\xymatrix{
X_1' \ar[r] \ar[d] & X_2' \ar[d] \\
X_1 \ar[r] & X_2
}
$$
of algebraic spaces over $S$.
\end{lemma}

\begin{proof}
Let $\mathcal{I}_2$ be the ideal sheaf of $Z_2$ in $X_2$.
Denote $g : X_1 \to X_2$ the given morphism. Then the ideal sheaf
$\mathcal{I}_1$ of $Z_1$ is the image of
$g^*\mathcal{I}_2 \to \mathcal{O}_{X_1}$
(see Morphisms of Spaces, Definition
\ref{spaces-morphisms-definition-inverse-image-closed-subspace}
and discussion following the definition).
By Lemma \ref{lemma-relative-proj-base-change}
we see that $X_1 \times_{X_2} X_2'$ is the relative Proj of
$\bigoplus_{n \geq 0} g^*\mathcal{I}_2^n$. Because $g$ is flat the map
$g^*\mathcal{I}_2^n \to \mathcal{O}_{X_1}$ is injective with image
$\mathcal{I}_1^n$. Thus we see that $X_1 \times_{X_2} X_2' = X_1'$.
\end{proof}

\begin{lemma}
\label{lemma-blowing-up-gives-effective-Cartier-divisor}
Let $S$ be a scheme. Let $X$ be an algebraic space over $S$.
Let $Z \subset X$ be a closed subspace.
The blowing up $b : X' \to X$ of $Z$ in $X$
has the following properties:
\begin{enumerate}
\item $b|_{b^{-1}(X \setminus Z)} : b^{-1}(X \setminus Z) \to X \setminus Z$
is an isomorphism,
\item the exceptional divisor $E = b^{-1}(Z)$ is an effective Cartier divisor
on $X'$,
\item there is a canonical isomorphism
$\mathcal{O}_{X'}(-1) = \mathcal{O}_{X'}(E)$
\end{enumerate}
\end{lemma}

\begin{proof}
Let $U$ be a scheme and let $U \to X$ be a surjective \'etale morphism.
As blowing up commutes with flat base change
(Lemma \ref{lemma-flat-base-change-blowing-up})
we can prove each of these statements after base change to $U$.
This reduces us to the case of schemes.
In this case the result is
Divisors, Lemma
\ref{divisors-lemma-blowing-up-gives-effective-Cartier-divisor}.
\end{proof}

\begin{lemma}[Universal property blowing up]
\label{lemma-universal-property-blowing-up}
Let $S$ be a scheme.
Let $X$ be an algebraic space over $S$.
Let $Z \subset X$ be a closed subspace.
Let $\mathcal{C}$ be the full subcategory of $(\textit{Spaces}/X)$ consisting
of $Y \to X$ such that the inverse image of $Z$ is an effective
Cartier divisor on $Y$. Then the blowing up $b : X' \to X$ of $Z$ in $X$
is a final object of $\mathcal{C}$.
\end{lemma}

\begin{proof}
We see that $b : X' \to X$ is an object of $\mathcal{C}$ according to
Lemma \ref{lemma-blowing-up-gives-effective-Cartier-divisor}.
Let $f : Y \to X$ be an object of $\mathcal{C}$. We have to show there exists
a unique morphism $Y \to X'$ over $X$. Let $D = f^{-1}(Z)$.
Let $\mathcal{I} \subset \mathcal{O}_X$ be the ideal sheaf of $Z$
and let $\mathcal{I}_D$ be the ideal sheaf of $D$. Then
$f^*\mathcal{I} \to \mathcal{I}_D$ is a surjection
to an invertible $\mathcal{O}_Y$-module. This extends to a map
$\psi : \bigoplus f^*\mathcal{I}^d \to \bigoplus \mathcal{I}_D^d$
of graded $\mathcal{O}_Y$-algebras. (We observe that
$\mathcal{I}_D^d = \mathcal{I}_D^{\otimes d}$ as $D$ is an
effective Cartier divisor.) By
Lemma \ref{lemma-relative-proj-generated-in-degree-1}.
the triple $(f : Y \to X, \mathcal{I}_D, \psi)$ defines a
morphism $Y \to X'$ over $X$. The restriction
$$
Y \setminus D \longrightarrow X' \setminus b^{-1}(Z) = X \setminus Z
$$
is unique. The open $Y \setminus D$ is scheme theoretically dense in $Y$
according to Lemma \ref{lemma-complement-effective-Cartier-divisor}. 
Thus the morphism $Y \to X'$ is unique by
Morphisms of Spaces, Lemma \ref{spaces-morphisms-lemma-equality-of-morphisms}
(also $b$ is separated by Lemma
\ref{lemma-relative-proj-separated}).
\end{proof}









\input{chapters}

\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}
